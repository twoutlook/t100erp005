<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="aooi110" std_prog="aooi110" erpver="1.0" module="AOO" ver="8" env="s" zone="t10prd" booking="N" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="F" status="u"/>
    <free_style value="Y" status="u"/>
    <start_arg value="" status="u"/>
  </other>
  <point name="main.define_sql" order="0" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[                  LET g_forupd_sql = "SELECT ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,'',ooeb007,ooeb008,ooebstus,ooebmodid,'',ooebmoddt,ooebownid,'',ooebowndp,'',ooebcrtid,'',ooebcrtdp,'',ooebcrtdt FROM ooeb_t WHERE ooebent= ? AND ooeb001=? FOR UPDATE"]]>
  </point>
  <point name="function.aooi110_chk_hasC1" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#檢查是否有下層
PRIVATE FUNCTION aooi110_chk_hasC1(p_ooed002,p_ooed005)
DEFINE p_ooed002     LIKE ooed_t.ooed002
DEFINE p_ooed005     LIKE ooed_t.ooed005
DEFINE li_cnt        INTEGER

   LET g_sql = "SELECT COUNT(*) FROM ooed_tmp ",
               " WHERE ooedent = '" ||g_enterprise|| "'",
               "   AND ooed002 = '",p_ooed002,"' ",
               "   AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
               "   AND ooed004 <> ooed005 ",
               "   AND ooed005 = ? "
   PREPARE aooi110_master_chk2 FROM g_sql
   EXECUTE aooi110_master_chk2 USING p_ooed005 INTO li_cnt
   FREE aooi110_master_chk2
   IF li_cnt > 0 THEN
      RETURN TRUE
   ELSE
      RETURN FALSE
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_init" order="2" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_init()
   #add-point:init段define
   
   #end add-point

   #add-point:畫面資料初始化
   
   CALL cl_set_combo_scc('ooeb004',100)
   CALL cl_set_combo_scc('ooeb003',101)
   
   LET g_flag = 'Y'
   #end add-point

   CALL cl_set_combo_scc_part('ooebstus','13','N,X,Y')

   CALL aooi110_default_search()

END FUNCTION]]>
  </point>
  <point name="function.aooi110_ui_dialog" order="3" ver="7" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_ui_dialog()
   {<Local define>}
   DEFINE li_idx  LIKE type_t.num5
   {</Local define>}
   #add-point:ui_dialog段define
   DEFINE l_id        LIKE type_t.num5
   DEFINE l_status    LIKE type_t.num5
   DEFINE l_value     STRING
   DEFINE arr_left    DYNAMIC ARRAY OF STRING
   DEFINE arr_right   DYNAMIC ARRAY OF STRING
   DEFINE l_dnd       ui.DragDrop
   DEFINE l_source    STRING
   DEFINE l_target    STRING
   DEFINE l_ac1       STRING
   DEFINE l_ac2       STRING
   DEFINE l_ooec004   LIKE ooec_t.ooec004
   DEFINE l_ooec004_1 LIKE ooec_t.ooec004
   DEFINE l_ooec002   LIKE ooec_t.ooec002
   DEFINE l_ooec002_1 LIKE ooec_t.ooec002
   DEFINE l_n         LIKE type_t.num5
   DEFINE l_ooec004_t LIKE ooec_t.ooec004
   DEFINE l_ooec005_t LIKE ooec_t.ooec005
   DEFINE l_n2         LIKE type_t.num5
   DEFINE l_n3         LIKE type_t.num5
   DEFINE l_i          LIKE type_t.num5
   DEFINE l_success    LIKE type_t.num5
   DEFINE l_ooed004          LIKE ooed_t.ooed004
   DEFINE l_ooefl003         LIKE ooefl_t.ooefl003
   DEFINE l_errno            LIKE type_t.chr80
   DEFINE l_ooed003          LIKE ooed_t.ooed003
   DEFINE l_ooed006          LIKE ooed_t.ooed006
   DEFINE l_ooed007          LIKE ooed_t.ooed007
   DEFINE la_param  RECORD
             prog   STRING,
             param  DYNAMIC ARRAY OF STRING
                    END RECORD
   DEFINE ls_js     STRING
   #end add-point

   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件

   CALL cl_set_act_visible("accept,cancel", FALSE)

   #該樣板不需此段落CALL gfrm_curr.setElementImage("logo","logo/applogo.png")
   #該樣板不需此段落CALL gfrm_curr.setElementHidden("mainlayout",1)
   #該樣板不需此段落CALL gfrm_curr.setElementHidden("worksheet",0)
   LET g_main_hidden = 1

   #add-point:ui_dialog段before dialog

   #end add-point

   WHILE TRUE

      CALL aooi110_browser_fill("")
      #該樣板不需此段落CALL lib_cl_dlg.cl_query_bef_disp()
      #該樣板不需此段落CALL lib_cl_dlg.cl_relate_bef_disp()
      #該樣板不需此段落CALL cl_notice()

      #CALL lib_cl_dlg.cl_query_bef_disp()
      #CALL lib_cl_dlg.cl_relate_bef_disp()


      #判斷前一個動作是否為新增, 若是的話切換到新增的筆數
      IF g_state = "Y" THEN
         FOR li_idx = 1 TO g_browser.getLength()
            IF g_browser[li_idx].b_ooeb001 = g_ooeb001_t
      
               THEN
               LET g_current_row = li_idx
               EXIT FOR
            END IF
         END FOR
         LET g_state = ""
      END IF
      
      LET g_flag = 'Y'
      IF g_ooeb_m.ooeb003 = '2' AND (g_ooeb_m.ooeb007 <= g_today AND (g_ooeb_m.ooeb008 > g_today OR g_ooeb_m.ooeb008 IS NULL))THEN
         LET g_flag = 'N'
      END IF
      
      IF g_ooeb_m.ooebstus = 'N' AND (g_ooeb_m.ooeb003 = '1' OR (g_ooeb_m.ooeb003 = '2' AND g_flag = 'Y')) THEN
         
         DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         
            DISPLAY ARRAY g_tree TO s_tree.*
         
               ON DRAG_START(l_dnd)
                  LET l_source="RIGHT"
                  LET l_ac1 = ARR_CURR()
                  LET arr_right[l_ac1] = g_tree[l_ac1].b_ooed004
                  LET l_value = arr_right[l_ac1]
                  LET l_n = 0
                  SELECT COUNT(*) INTO l_n FROM ooec_t
                   WHERE ooecent = g_enterprise
                     AND (ooec004 = g_tree[l_ac1].b_ooed004
                         OR ooec005 = g_tree[l_ac1].b_ooed004)
                     AND ooec002 = g_ooeb_m.ooeb005
                     AND ooec001 = g_ooeb_m.ooeb004
                     AND ooec008 = g_ooeb_m.ooeb001
                  IF l_n = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'aoo-00130'
                     LET g_errparam.extend = l_value
                     LET g_errparam.popup = FALSE
                     CALL cl_err()

                  END IF
                  LET l_ooec004_t = g_tree[l_ac1].b_ooed004
                  LET l_ooec005_t = g_tree[l_ac1].b_ooed005
                  IF cl_null(l_ooec005_t) THEN
                     LET l_ooec005_t = g_ooeb_m.ooeb005
                  END IF
               ON DRAG_FINISHED(l_dnd)
                  INITIALIZE l_source TO NULL
         
               ON DRAG_ENTER(l_dnd)
                   IF l_source IS NULL THEN
                      CALL l_dnd.setOperation(NULL)
                   END IF
               ON DROP(l_dnd)
                   LET l_ac1 = l_dnd.getLocationRow()
                   LET l_n = 0
                   SELECT COUNT(*) INTO l_n
                     FROM ooec_t
                    WHERE ooecent = g_enterprise
                      AND (ooec004 = g_tree[l_ac1].b_ooed004
                          OR ooec005 = g_tree[l_ac1].b_ooed004)
                      AND ooec002 = g_ooeb_m.ooeb005
                      AND ooec001 = g_ooeb_m.ooeb004
                      AND ooec008 = g_ooeb_m.ooeb001
                   IF l_n = 0 AND NOT cl_null(g_tree[l_ac1].b_ooed004) THEN
                      INITIALIZE g_errparam TO NULL
                      LET g_errparam.code = 'aoo-00130'
                      LET g_errparam.extend = g_tree[l_ac1].b_ooed004
                      LET g_errparam.popup = FALSE
                      CALL cl_err()

                   ELSE
                      IF l_source == "RIGHT" THEN
                         #樹中互相拖
                         CALL s_transaction_begin()
                         
                         IF cl_null(l_ooec005_t) THEN
                            LET l_ooec005_t = g_ooeb_m.ooeb005
                         END IF
                         
                         #DELETE FROM ooec_t
                         # WHERE ooecent = g_enterprise
                         #   AND ooec001 = g_ooeb_m.ooeb004
                         #   AND ooec002 = g_ooeb_m.ooeb005
                         #   AND ooec003 = g_ooeb_m.ooeb006
                         #   AND ooec004 = l_ooec004_t
                         #   AND ooec005 = l_ooec005_t
                         #   AND ooec008 = g_ooeb_m.ooeb001
                         #   
                         #IF SQLCA.SQLcode  THEN 
                         #   INITIALIZE g_errparam TO NULL
                         #   LET g_errparam.code = SQLCA.sqlcode
                         #   LET g_errparam.extend = "ooec_t"
                         #   LET g_errparam.popup = TRUE
                         #   CALL cl_err()
                         #
                         #   CALL s_transaction_end('N','0') 
                         #END IF
                         
                         IF cl_null(g_tree[l_ac1].b_ooed005) THEN
                            LET g_tree[l_ac1].b_ooed005 = g_ooeb_m.ooeb005
                         END IF
                          
                         #INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008)
                         #    VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_tree[l_ac1].b_ooed004,g_tree[l_ac1].b_ooed005,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                         #
                         UPDATE ooec_t SET ooec005 = g_tree[l_ac1].b_ooed004
                          WHERE ooecent = g_enterprise
                            AND ooec001 = g_ooeb_m.ooeb004
                            AND ooec002 = g_ooeb_m.ooeb005
                            AND ooec003 = g_ooeb_m.ooeb006
                            AND ooec004 = l_ooec004_t
                            AND ooec005 = l_ooec005_t
                            AND ooec008 = g_ooeb_m.ooeb001
                            
                         IF SQLCA.SQLcode  THEN 
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = SQLCA.sqlcode
                            LET g_errparam.extend = "ooec_t"
                            LET g_errparam.popup = TRUE
                            CALL cl_err()

                            CALL s_transaction_end('N','0') 
                         END IF
                         CALL s_transaction_end('Y','0') 
                         
                         CALL l_dnd.dropInternal()
                         
                         IF cl_null(g_tree[l_ac1].b_show) THEN
                            CALL g_tree.deleteElement(l_ac1)
                         END IF
                         FOR l_n2 = 1 TO g_tree.getLength()
                            LET g_tree[l_n2].b_hasC = aooi110_chk_hasC1(g_tree[l_n2].b_ooed002,g_tree[l_n2].b_ooed004)
                         END FOR
                      ELSE
                         #從備選單身拖到樹中
                         LET l_ac2 = l_dnd.getLocationRow()
                         LET l_ooec004 = g_tree[l_ac2].b_ooed004
                         CALL DIALOG.insertRow("s_tree",l_ac1)
                         CALL DIALOG.setCurrentRow("s_tree",l_ac1)
                         IF cl_null(l_ac1) THEN
                            LET l_ac1 = l_dnd.getLocationRow()
                         END IF
                         
                         FOR li_idx = 1 TO arr_left.getLength()
                            LET arr_right[l_ac1] = arr_left[li_idx]
                  
                            #LET arr_right[l_ac1] = l_value
                            LET g_tree[l_ac1].b_show =  arr_right[l_ac1]
                            LET g_tree[l_ac1].b_ooed004 =  arr_right[l_ac1]
                            LET g_tree[l_ac1].b_ooed005 =  l_ooec004
                            
                            IF cl_null(g_tree[l_ac2+1].b_show) THEN
                               CALL DIALOG.deleteRow("s_tree",l_ac2+1)
                               CALL g_tree.deleteElement(l_ac2+1)
                            END IF
                            
                            IF cl_null(g_tree[l_ac1].b_ooed005) THEN
                               LET g_tree[l_ac1].b_ooed005 = g_ooeb_m.ooeb005
                            END IF
                            
                            CALL s_transaction_begin()
                            
                            INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008)
                                VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_tree[l_ac1].b_ooed004,g_tree[l_ac1].b_ooed005,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                            
                            IF SQLCA.SQLcode  THEN 
                               INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = SQLCA.sqlcode
                            LET g_errparam.extend = "ooec_t"
                            LET g_errparam.popup = TRUE
                            CALL cl_err()

                               CALL s_transaction_end('N','0') 
                            ELSE
                               CALL s_transaction_end('Y','0') 
                            END IF
                            
                            FOR l_n2 = 1 TO g_tree.getLength()
                                LET g_tree[l_n2].b_hasC = aooi110_chk_hasC1(g_tree[l_n2].b_ooed002,g_tree[l_n2].b_ooed004)
                            END FOR
                         END FOR
                      END IF
                      #CALL aooi110_tree_fill()
                      CALL aooi110_tree_refresh()
                      CALL aooi110_ooef_fill()
                   END IF
         
            END DISPLAY
            
            DISPLAY ARRAY g_ooef_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b2) #page1
         
               BEFORE ROW
                  CALL aooi110_idx_chk()
         
               BEFORE DISPLAY
                  CALL FGL_SET_ARR_CURR(g_detail_idx)
                  LET l_ac = DIALOG.getCurrentRow("s_detail1")
                  CALL aooi110_idx_chk()
                  LET g_current_page = 1
                  
               ON DRAG_START(l_dnd)
                  LET l_source="LEFT"
                  LET l_ac = ARR_CURR()
                  LET l_i = 1
                  CALL arr_left.clear()
                  FOR li_idx = 1 TO g_ooef_d.getLength()
                     IF DIALOG.isRowSelected("s_detail1",li_idx) THEN
                        LET arr_left[l_i] = g_ooef_d[li_idx].ooef001
                        LET l_i = l_i + 1
                     END IF
                  END FOR
                  #LET arr_left[l_ac] = g_ooef_d[l_ac].ooef001
                  #LET l_value = arr_left[l_ac]

               ON DRAG_FINISHED(l_dnd)
                  INITIALIZE l_source TO NULL
               
               ON DRAG_ENTER(l_dnd)
                   IF l_source IS NULL THEN
                      CALL l_dnd.setOperation(NULL)
                   END IF
                   
               ON DROP(l_dnd)
                   IF l_source == "LEFT" THEN
                      CALL l_dnd.dropInternal()
                   ELSE
                      #從樹拖單身
                      LET l_ac = l_dnd.getLocationRow()
                      CALL DIALOG.insertRow("s_detail1",l_ac)
                      CALL DIALOG.setCurrentRow("s_detail1",l_ac)
                      IF cl_null(l_ac) THEN
                         LET l_ac = l_dnd.getLocationRow()
                      END IF
                      LET arr_left[l_ac]= l_value
                      LET g_ooef_d[l_ac].ooef001= arr_left[l_ac]
                      #LET g_ooef_d[l_ac].ooec005= l_ooec005_t
                      
                      CALL DIALOG.deleteRow("s_tree",l_ac1)
                      
                      IF cl_null(l_ooec005_t) THEN
                         LET l_ooec005_t = g_ooeb_m.ooeb005
                      END IF
                      
                      CALL s_transaction_begin()
                         
                      DELETE FROM ooec_t
                       WHERE ooecent = g_enterprise
                         AND ooec001 = g_ooeb_m.ooeb004
                         AND ooec002 = g_ooeb_m.ooeb005
                         AND ooec003 = g_ooeb_m.ooeb006
                         AND ooec004 = g_ooef_d[l_ac].ooef001
                         AND ooec005 = l_ooec005_t
                         AND ooec008 = g_ooeb_m.ooeb001
                         
                      IF SQLCA.SQLcode  THEN 
                         INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = SQLCA.sqlcode
                            LET g_errparam.extend = "ooec_t"
                            LET g_errparam.popup = TRUE
                            CALL cl_err()

                         CALL s_transaction_end('N','0') 
                      END IF
                      
                      #判斷當前的節點 是否存在子節點，若存在子節點，則把下面的子節點也全部移除
                      IF NOT aooi110_del_child(g_ooef_d[l_ac].ooef001) THEN
                         CALL s_transaction_end('N','0') 
                      ELSE
                         CALL s_transaction_end('Y','0') 
                      END IF
                      
                      FOR l_n2 = 1 TO g_tree.getLength()
                          LET g_tree[l_n2].b_hasC = aooi110_chk_hasC1(g_tree[l_n2].b_ooed002,g_tree[l_n2].b_ooed004)
                      END FOR
                      #CALL aooi110_tree_fill()
                      CALL aooi110_tree_refresh()
                      CALL aooi110_ooef_fill()
                   END IF
         
            END DISPLAY
         
            #該樣板不需此段落SUBDIALOG lib_cl_dlg.dlg_qryplan
            #該樣板不需此段落SUBDIALOG lib_cl_dlg.dlg_relateapps
         
            BEFORE DIALOG
               #調整
               CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
               LET g_curr_diag = ui.DIALOG.getCurrent()
               LET g_page = "first"
               LET g_current_sw = FALSE
               #回歸舊筆數位置 (回到當時異動的筆數)
               #該樣板不需此段落LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               #該樣板不需此段落IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               #該樣板不需此段落   CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               #該樣板不需此段落   LET g_current_idx = g_current_row
               #該樣板不需此段落END IF
              #IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               IF g_current_row > 1 AND g_current_sw = FALSE THEN
                  LET g_current_idx = g_current_row
               END IF
         
               LET g_current_row = g_current_idx #目前指標
               IF g_current_idx = 0 THEN
                  LET g_current_idx = 1
               END IF
               LET g_current_sw = TRUE
         
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF
         
               #有資料才進行fetch
               IF g_current_idx <> 0 THEN
                  CALL aooi110_fetch('') # reload data
               END IF
#               CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
               LET g_detail_idx = 1
               CALL aooi110_ui_detailshow() #Setting the current row
         
               #筆數顯示
               LET g_current_page = 1
               CALL aooi110_idx_chk()
         
               #add-point:ui_dialog段before_dialog
               
               #單身可多選的關鍵 
               CALL DIALOG.setSelectionMode("s_detail1",1)
               #end add-point
         
         
            ON ACTION statechange
               CALL aooi110_statechange()
               LET g_action_choice = "statechange"
               EXIT DIALOG
         
            #簽核
            ON ACTION signature
               MENU "" ATTRIBUTES( STYLE="popup", IMAGE="tb/authorize/terminate.png" )
                  ON ACTION ef_sign
                  ON ACTION stop_authflow
                  ON ACTION add_auth
                  ON ACTION revoke_auth
                  ON ACTION approve
                  ON ACTION unapprove
                  ON ACTION auth_opinion
                  ON ACTION auth_status
                  ON ACTION auth_attach
                  ON ACTION authflow_designer
               END MENU
         
            #ACTION表單列
            #該樣板不需此段落ON ACTION filter
            #該樣板不需此段落   CALL aooi110_filter()
            #該樣板不需此段落   EXIT DIALOG
         
            ON ACTION first
               CALL aooi110_del_ooed_tmp()
               LET g_rec_b2 = 0
               LET g_flag2 = FALSE
               CALL aooi110_fetch('F')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION previous
               CALL aooi110_del_ooed_tmp()
               LET g_rec_b2 = 0
               LET g_flag2 = FALSE
               CALL aooi110_fetch('P')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION jump
               CALL aooi110_del_ooed_tmp()
               LET g_rec_b2 = 0
               LET g_flag2 = FALSE
               CALL aooi110_fetch('/')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION next
               CALL aooi110_del_ooed_tmp()
               LET g_rec_b2 = 0
               LET g_flag2 = FALSE
               CALL aooi110_fetch('N')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION last
               CALL aooi110_del_ooed_tmp()
               LET g_rec_b2 = 0
               LET g_flag2 = FALSE
               CALL aooi110_fetch('L')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION close
               LET INT_FLAG=FALSE
               LET g_action_choice = "exit"
               EXIT WHILE
         
            ON ACTION exit
               LET g_action_choice = "exit"
               EXIT WHILE
         
            #該樣板不需此段落ON ACTION bw_first               #page first
            #該樣板不需此段落   CALL aooi110_browser_fill("F")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
         
            #該樣板不需此段落ON ACTION bw_prev                #page previous
            #該樣板不需此段落   CALL aooi110_browser_fill("P")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
         
            #該樣板不需此段落ON ACTION bw_next                #page next
            #該樣板不需此段落   CALL aooi110_browser_fill("N")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
         
            #該樣板不需此段落ON ACTION bw_last                #page last
            #該樣板不需此段落   CALL aooi110_browser_fill("L")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
         
            ON ACTION mainhidden       #主頁摺疊
               IF g_main_hidden THEN
                  CALL gfrm_curr.setElementHidden("mainlayout",0)
                  CALL gfrm_curr.setElementHidden("worksheet",1)
                  LET g_main_hidden = 0
               ELSE
                  CALL gfrm_curr.setElementHidden("mainlayout",1)
                  CALL gfrm_curr.setElementHidden("worksheet",0)
                  LET g_main_hidden = 1
               END IF
         
            #該樣板不需此段落ON ACTION worksheethidden   #瀏覽頁折疊
            #該樣板不需此段落   IF g_main_hidden THEN
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",0)
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",1)
            #該樣板不需此段落      LET g_main_hidden = 0
            #該樣板不需此段落   ELSE
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",1)
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",0)
            #該樣板不需此段落      LET g_main_hidden = 1
            #該樣板不需此段落   END IF
         
            ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
               IF g_header_hidden THEN
                  CALL gfrm_curr.setElementHidden("worksheet_detail",0)
                  CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
                  LET g_header_hidden = 0     #visible
               ELSE
                  CALL gfrm_curr.setElementHidden("worksheet_detail",1)
                  CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
                  LET g_header_hidden = 1     #hidden
               END IF
         
         
         
            ON ACTION modify
         
               LET g_action_choice="modify"
               IF cl_auth_chk_act("modify") THEN
                  CALL aooi110_modify()
                  #add-point:ON ACTION modify
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                  #EXIT DIALOG
                   CONTINUE WHILE
               END IF
         
         
         
            ON ACTION insert
         
               LET g_action_choice="insert"
               IF cl_auth_chk_act("insert") THEN
                  CALL aooi110_insert()
                  #add-point:ON ACTION insert
                  
                  #END add-point
                  #EXIT DIALOG
                   CONTINUE WHILE
               END IF
         
         
            ON ACTION query
         
               LET g_action_choice="query"
               IF cl_auth_chk_act("query") THEN
                  CALL aooi110_query()
                  #add-point:ON ACTION query
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
               END IF
         
         
            ON ACTION reproduce
         
               LET g_action_choice="reproduce"
               IF cl_auth_chk_act("reproduce") THEN
                  CALL aooi110_reproduce()
                  #add-point:ON ACTION reproduce
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                   EXIT DIALOG
               END IF
         
         
            ON ACTION produce
         
               LET g_action_choice="produce"
               IF cl_auth_chk_act("produce") THEN
                  
                  CALL s_transaction_begin()

                  IF NOT aooi110_produce() THEN
                     CALL s_transaction_end('N','0')
                  ELSE
                     CALL s_transaction_end('Y','0')
                     INITIALIZE g_errparam TO NULL
                     IF g_flag3 THEN
                        LET g_errparam.code = ""
                     ELSE
                        LET g_errparam.code = "aoo-00362"
                     END IF
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = FALSE
                     CALL cl_err() 
                     LET g_flag3 = FALSE
                  END IF
                  
                  EXIT DIALOG
               END IF
               
            ON ACTION aooi100
         
               LET g_action_choice="aooi100"
               IF cl_auth_chk_act("aooi100") THEN
                  #add-point:ON ACTION produce
                  
                  CALL cl_cmdrun("aooi100")
                  
                  #END add-point
                   EXIT DIALOG
               END IF   
         
         
            ON ACTION output
         
               LET g_action_choice="output"
               IF cl_auth_chk_act("output") THEN
                  #add-point:ON ACTION output
                  
                  
                  #END add-point
                   EXIT DIALOG
               END IF
         
         
            ON ACTION delete
         
               LET g_action_choice="delete"
               IF cl_auth_chk_act("delete") THEN
                  CALL aooi110_delete()
                  #add-point:ON ACTION delete
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                  #EXIT DIALOG
                   CONTINUE WHILE
               END IF
         
            ON ACTION ins_aooi100
               LET g_action_choice="ins_aooi100"
               IF cl_auth_chk_act("ins_aooi100") THEN
                  LET la_param.prog = 'aooi100'
                  LET la_param.param[1] = 'insert'
                  LET ls_js = util.JSON.stringify( la_param )
                  CALL cl_cmdrun(ls_js)
                  #CALL cl_cmdrun("aooi100 'insert' ")
                  LET g_flag2 = TRUE
                  CALL aooi110_ooef_fill()
                  EXIT DIALOG
               END IF
            
            ON ACTION upd_aooi100
               LET g_action_choice="upd_aooi100"
               IF cl_auth_chk_act("upd_aooi100") THEN
                  IF l_ac > 0 THEN
                     LET la_param.prog = 'aooi100'
                     LET la_param.param[1] = g_ooef_d[l_ac].ooef001
                     LET ls_js = util.JSON.stringify( la_param )
                     CALL cl_cmdrun(ls_js)
                     #CALL cl_cmdrun("aooi100 '"||g_ooef_d[l_ac].ooef001||"'")
                  END IF
                  LET g_flag2 = TRUE
                  CALL aooi110_ooef_fill()
                  EXIT DIALOG
               END IF
            
            #1.單身停在某一筆組織資料,按下 '刪除組織'action時, 
            #   開窗詢問是否確定刪除, 'Y'則刪除該筆組織資料, 保存关闭窗口后自动刷新單身組織資料頁面
            #2.本功能應搭配一支共用程式, check該組織是否已有相關的業務單據資料, 
            #    IF yes.則不可進行修改或刪除該組織的動作, 至於該共用程式應檢核哪幾個重要檔案待確認
            ON ACTION del_aooi100
               LET g_action_choice="del_aooi100"
               IF cl_auth_chk_act("del_aooi100") THEN
                  IF l_ac > 0 THEN
                     CALL s_get_orga(g_ooeb_m.ooeb004,g_ooef_d[l_ac].ooef001,g_ooeb_m.ooeb005,g_ooeb_m.ooeb007)
                         RETURNING l_success,l_ooed004,l_ooefl003,l_ooed003,l_ooed006,l_ooed007,l_errno
                     IF l_success THEN   #存在於組織結構調整計劃結存檔或當前組織結構檔 中不可删除
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'aoo-00275'
                        LET g_errparam.extend = g_ooef_d[l_ac].ooef001
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        RETURN
                     END IF
                     IF cl_ask_delete() THEN
                        CALL s_transaction_begin()
                        DELETE FROM ooef_t
                            WHERE ooefent = g_enterprise AND ooef001 = g_ooef_d[l_ac].ooef001
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooef_t"
                           LET g_errparam.popup = FALSE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        DELETE FROM ooab_t WHERE ooabent = g_enterprise AND ooabsite = g_ooef_d[l_ac].ooef001
                        IF SQLCA.SQLcode  THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooab_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        
                        DELETE FROM ooeg_t WHERE ooegent = g_enterprise AND ooeg001 = g_ooef_d[l_ac].ooef001
                        IF SQLCA.SQLcode  THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooeg_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        DELETE FROM ooefl_t WHERE ooeflent = g_enterprise AND ooefl001 = g_ooef_d[l_ac].ooef001
                        IF SQLCA.SQLcode  THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooefl_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                     END IF
                  END IF
                  LET g_flag2 = TRUE
                  CALL aooi110_ooef_fill()
                  EXIT DIALOG
               END IF
               
            ON ACTION exporttoexcel   # xj add
                LET g_action_choice="exporttoexcel"
                IF cl_auth_chk_act("exporttoexcel") THEN
      
                   CALL g_export_node.clear()
                   LET g_main_hidden = 0  #xj add
                   LET g_export_node[1] = base.typeInfo.create(g_ooef_d)
                   LET g_export_id[1]   = "s_detail1"
                
                   #add-point:ON ACTION exporttoexcel
                   #END add-point
                   CALL cl_export_to_excel_getpage()
                   CALL cl_export_to_excel()
                END IF
           
            #主選單用ACTION
            &include "main_menu.4gl"
         
            #交談指令共用ACTION
            &include "common_action.4gl"
              #CONTINUE DIALOG
         
         END DIALOG
      ELSE
      
         DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
       
               DISPLAY ARRAY g_tree TO s_tree.*
               END DISPLAY
               
               DISPLAY ARRAY g_ooef_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b2) #page1
       
                  BEFORE ROW
                     CALL aooi110_idx_chk()
              
                  BEFORE DISPLAY
                     CALL FGL_SET_ARR_CURR(g_detail_idx)
                     LET l_ac = DIALOG.getCurrentRow("s_detail1")
                     CALL aooi110_idx_chk()
                     LET g_current_page = 1
              
               END DISPLAY
       
       
            #該樣板不需此段落SUBDIALOG lib_cl_dlg.dlg_qryplan
            #該樣板不需此段落SUBDIALOG lib_cl_dlg.dlg_relateapps
       
            BEFORE DIALOG
               CALL aooi110_browser_fill("")  
               CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
               LET g_curr_diag = ui.DIALOG.getCurrent()
               LET g_page = "first"
               LET g_current_sw = FALSE
               #回歸舊筆數位置 (回到當時異動的筆數)
               #該樣板不需此段落LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               #該樣板不需此段落IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               #該樣板不需此段落   CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               #該樣板不需此段落   LET g_current_idx = g_current_row
               #該樣板不需此段落END IF
              #IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               IF g_current_row > 1 AND g_current_sw = FALSE THEN
                  LET g_current_idx = g_current_row
               END IF
       
               LET g_current_row = g_current_idx #目前指標
               IF g_current_idx = 0 THEN
                  LET g_current_idx = 1
               END IF
               LET g_current_sw = TRUE
       
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF
       
               #有資料才進行fetch
               IF g_current_idx <> 0 THEN
                  CALL aooi110_fetch('') # reload data
               END IF
#               CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
               LET g_detail_idx = 1
               CALL aooi110_ui_detailshow() #Setting the current row
       
               #筆數顯示
               LET g_current_page = 1
               CALL aooi110_idx_chk()

               #add-point:ui_dialog段before_dialog
               
               #end add-point
       
            ON ACTION statechange
               CALL aooi110_statechange()
               LET g_action_choice = "statechange"
               EXIT DIALOG
       
            #簽核
            ON ACTION signature
               MENU "" ATTRIBUTES( STYLE="popup", IMAGE="tb/authorize/terminate.png" )
                  ON ACTION ef_sign
                  ON ACTION stop_authflow
                  ON ACTION add_auth
                  ON ACTION revoke_auth
                  ON ACTION approve
                  ON ACTION unapprove
                  ON ACTION auth_opinion
                  ON ACTION auth_status
                  ON ACTION auth_attach
                  ON ACTION authflow_designer
               END MENU
       
            #ACTION表單列
            #該樣板不需此段落ON ACTION filter
            #該樣板不需此段落   CALL aooi110_filter()
            #該樣板不需此段落   EXIT DIALOG
       
            ON ACTION first
               CALL aooi110_del_ooed_tmp()
               LET g_flag2 = FALSE
               LET g_rec_b2 = 0
               CALL aooi110_fetch('F')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION previous
               CALL aooi110_del_ooed_tmp()
               LET g_rec_b2 = 0
               LET g_flag2 = FALSE
               CALL aooi110_fetch('P')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION jump
               CALL aooi110_del_ooed_tmp()
               LET g_flag2 = FALSE
               LET g_rec_b2 = 0
               CALL aooi110_fetch('/')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION next
               CALL aooi110_del_ooed_tmp()
               LET g_flag2 = FALSE
               LET g_rec_b2 = 0
               CALL aooi110_fetch('N')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION last
               CALL aooi110_del_ooed_tmp()
               LET g_flag2 = FALSE
               LET g_rec_b2 = 0
               CALL aooi110_fetch('L')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()
               CALL aooi110_idx_chk()
               #調整
               EXIT DIALOG
            ON ACTION close
               LET INT_FLAG=FALSE
               LET g_action_choice = "exit"
               EXIT WHILE
       
            ON ACTION exit
               LET g_action_choice = "exit"
               EXIT WHILE
       
            #該樣板不需此段落ON ACTION bw_first               #page first
            #該樣板不需此段落   CALL aooi110_browser_fill("F")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
       
            #該樣板不需此段落ON ACTION bw_prev                #page previous
            #該樣板不需此段落   CALL aooi110_browser_fill("P")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
       
            #該樣板不需此段落ON ACTION bw_next                #page next
            #該樣板不需此段落   CALL aooi110_browser_fill("N")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')
       
            #該樣板不需此段落ON ACTION bw_last                #page last
            #該樣板不需此段落   CALL aooi110_browser_fill("L")
            #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            #該樣板不需此段落   CALL aooi110_fetch('')

            ON ACTION mainhidden       #主頁摺疊
               IF g_main_hidden THEN
                  CALL gfrm_curr.setElementHidden("mainlayout",0)
                  CALL gfrm_curr.setElementHidden("worksheet",1)
                  LET g_main_hidden = 0
               ELSE
                  CALL gfrm_curr.setElementHidden("mainlayout",1)
                  CALL gfrm_curr.setElementHidden("worksheet",0)
                  LET g_main_hidden = 1
               END IF
       
            #該樣板不需此段落ON ACTION worksheethidden   #瀏覽頁折疊
            #該樣板不需此段落   IF g_main_hidden THEN
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",0)
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",1)
            #該樣板不需此段落      LET g_main_hidden = 0
            #該樣板不需此段落   ELSE
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",1)
            #該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",0)
            #該樣板不需此段落      LET g_main_hidden = 1
            #該樣板不需此段落   END IF
       
            ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
               IF g_header_hidden THEN
                  CALL gfrm_curr.setElementHidden("worksheet_detail",0)
                  CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
                  LET g_header_hidden = 0     #visible
               ELSE
                  CALL gfrm_curr.setElementHidden("worksheet_detail",1)
                  CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
                  LET g_header_hidden = 1     #hidden
               END IF
       
       
       
            ON ACTION modify
       
               LET g_action_choice="modify"
               IF cl_auth_chk_act("modify") THEN
                  CALL aooi110_modify()
                  #add-point:ON ACTION modify
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                  #EXIT DIALOG
                   CONTINUE WHILE
               END IF



            ON ACTION insert
       
               LET g_action_choice="insert"
               IF cl_auth_chk_act("insert") THEN
                  CALL aooi110_insert()
                  #add-point:ON ACTION insert
                  
                  #END add-point
                  #EXIT DIALOG
                   CONTINUE WHILE
               END IF
       
       
            ON ACTION query
       
               LET g_action_choice="query"
               IF cl_auth_chk_act("query") THEN
                  CALL aooi110_query()
                  #add-point:ON ACTION query
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
               END IF
       
       
            ON ACTION reproduce
       
               LET g_action_choice="reproduce"
               IF cl_auth_chk_act("reproduce") THEN
                  CALL aooi110_reproduce()
                  #add-point:ON ACTION reproduce
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                   EXIT DIALOG
               END IF
       
       
            ON ACTION produce
         
               LET g_action_choice="produce"
               IF cl_auth_chk_act("produce") THEN
                   
                  CALL s_transaction_begin()

                  IF NOT aooi110_produce() THEN
                     CALL s_transaction_end('N','0') 
                  ELSE
                     CALL s_transaction_end('Y','0')
                     INITIALIZE g_errparam TO NULL
                     IF g_flag3 THEN
                        LET g_errparam.code = ""
                     ELSE
                        LET g_errparam.code = "aoo-00362"
                     END IF
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = FALSE
                     CALL cl_err() 
                     LET g_flag3 = FALSE
                  END IF
                  
                  EXIT DIALOG
               END IF
               
            ON ACTION aooi100
         
               LET g_action_choice="aooi100"
               IF cl_auth_chk_act("aooi100") THEN
                  #add-point:ON ACTION produce
                  
                  CALL cl_cmdrun("aooi100")
                  
                  #END add-point
                   EXIT DIALOG
               END IF   
       
       
            ON ACTION output
       
               LET g_action_choice="output"
               IF cl_auth_chk_act("output") THEN
                  #add-point:ON ACTION output
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                   EXIT DIALOG
               END IF
       
       
            ON ACTION delete
       
               LET g_action_choice="delete"
               IF cl_auth_chk_act("delete") THEN
                  CALL aooi110_delete()
                  #add-point:ON ACTION delete
                  
                  CALL aooi110_del_ooed_tmp()
                  #END add-point
                  #EXIT DIALOG
                   CONTINUE WHILE
               END IF
               
            ON ACTION exporttoexcel   # xj add
                LET g_action_choice="exporttoexcel"
                IF cl_auth_chk_act("exporttoexcel") THEN
      
                   CALL g_export_node.clear()
                   LET g_main_hidden = 0  #xj add
                   LET g_export_node[1] = base.typeInfo.create(g_ooef_d)
                   LET g_export_id[1]   = "s_detail1"
                
                   #add-point:ON ACTION exporttoexcel
                   #END add-point
                   CALL cl_export_to_excel_getpage()
                   CALL cl_export_to_excel()
                END IF
                
            ON ACTION ins_aooi100
                LET g_action_choice="ins_aooi100"
                IF cl_auth_chk_act("ins_aooi100") THEN
                   LET la_param.prog = 'aooi100'
                   LET la_param.param[1] = 'insert'
                   LET ls_js = util.JSON.stringify( la_param )
                   CALL cl_cmdrun(ls_js)
                   #CALL cl_cmdrun("aooi100 'insert' ")
                   LET g_flag2 = TRUE
                   CALL aooi110_ooef_fill()
                   EXIT DIALOG
                END IF
            
            ON ACTION upd_aooi100
               LET g_action_choice="upd_aooi100"
               IF cl_auth_chk_act("upd_aooi100") THEN
                  IF l_ac > 0 THEN
                     LET la_param.prog = 'aooi100'
                     LET la_param.param[1] = g_ooef_d[l_ac].ooef001
                     LET ls_js = util.JSON.stringify( la_param )
                     CALL cl_cmdrun(ls_js)
                     #CALL cl_cmdrun("aooi100 '"||g_ooef_d[l_ac].ooef001||"'")
                  END IF
                  LET g_flag2 = TRUE
                  CALL aooi110_ooef_fill()
                  EXIT DIALOG
               END IF
            
            #1.單身停在某一筆組織資料,按下 '刪除組織'action時, 
            #   開窗詢問是否確定刪除, 'Y'則刪除該筆組織資料, 保存关闭窗口后自动刷新單身組織資料頁面
            #2.本功能應搭配一支共用程式, check該組織是否已有相關的業務單據資料, 
            #    IF yes.則不可進行修改或刪除該組織的動作, 至於該共用程式應檢核哪幾個重要檔案待確認
            ON ACTION del_aooi100
               LET g_action_choice="del_aooi100"
               IF cl_auth_chk_act("del_aooi100") THEN
                  IF l_ac > 0 THEN
                     CALL s_get_orga(g_ooeb_m.ooeb004,g_ooef_d[l_ac].ooef001,g_ooeb_m.ooeb005,g_ooeb_m.ooeb007)
                         RETURNING l_success,l_ooed004,l_ooefl003,l_ooed003,l_ooed006,l_ooed007,l_errno
                     IF l_success THEN   #存在於組織結構調整計劃結存檔或當前組織結構檔 中不可删除
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'aoo-00275'
                        LET g_errparam.extend = g_ooef_d[l_ac].ooef001
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        RETURN
                     END IF
                     IF cl_ask_delete() THEN
                        CALL s_transaction_begin()
                        DELETE FROM ooef_t
                            WHERE ooefent = g_enterprise AND ooef001 = g_ooef_d[l_ac].ooef001
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooef_t"
                           LET g_errparam.popup = FALSE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        DELETE FROM ooab_t WHERE ooabent = g_enterprise AND ooabsite = g_ooef_d[l_ac].ooef001
                        IF SQLCA.SQLcode  THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooab_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        
                        DELETE FROM ooeg_t WHERE ooegent = g_enterprise AND ooeg001 = g_ooef_d[l_ac].ooef001
                        IF SQLCA.SQLcode  THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooeg_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        DELETE FROM ooefl_t WHERE ooeflent = g_enterprise AND ooefl001 = g_ooef_d[l_ac].ooef001
                        IF SQLCA.SQLcode  THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ooefl_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                     END IF
                  END IF
                  LET g_flag2 = TRUE
                  CALL aooi110_ooef_fill()
                  EXIT DIALOG
               END IF
               
            #主選單用ACTION
            &include "main_menu.4gl"
      
            #交談指令共用ACTION
            &include "common_action.4gl"
              #CONTINUE DIALOG
      
         END DIALOG
      END IF
   END WHILE

   CALL cl_set_act_visible("accept,cancel", TRUE)

END FUNCTION]]>
  </point>
  <point name="function.aooi110_browser_fill" order="4" ver="7" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_browser_fill(ps_page_action)
   {<Local define>}
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   DEFINE l_searchcol       STRING
   {</Local define>}
   #add-point:browser_fill段define
   DEFINE l_ooed003         LIKE ooed_t.ooed003
   #end add-point

   #清除畫面
   CLEAR FORM
   INITIALIZE g_ooeb_m.* TO NULL
   
    
   CALL g_ooef_d.clear()
   LET g_rec_b2 = 0
   
   CALL g_browser.clear()

   #搜尋用
   IF cl_null(g_searchcol) OR g_searchcol = '0' THEN
      LET l_searchcol = "ooeb001"
   ELSE
      LET l_searchcol = g_searchcol
   END IF

   LET l_wc  = g_wc.trim()
   #LET l_wc2 = g_wc2.trim()
   IF cl_null(l_wc) THEN  #p_wc 查詢條件
      RETURN
   END IF

   #IF g_wc2 <> " 1=1" THEN
   #   #單身有輸入搜尋條件
   #   LET l_sub_sql = " SELECT UNIQUE ooeb001 ",
   #
   #                     " FROM ooeb_t ",
   #                           " ",
   #                           " LEFT JOIN ooec_t ON ooecent = ooebent AND ooeb001 = ooec001 ",
   #
   #                           " ",
   #                           " ",
   #                    " WHERE ooebent = '" ||g_enterprise|| "' AND ooecent = '" ||g_enterprise|| "' AND ",l_wc, " AND ", l_wc2
   #
   #ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE ooeb001 ",

                        " FROM ooeb_t ",
                              " ",
                              " ",
                        "WHERE ooebent = '" ||g_enterprise|| "' AND ",l_wc CLIPPED

   #END IF

   LET g_sql = " SELECT COUNT(*) FROM (",l_sub_sql,")"

   PREPARE header_cnt_pre FROM g_sql
   EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
   FREE header_cnt_pre

   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示

   #若超過最大顯示筆數
   #該樣板不需此段落IF g_browser_cnt > g_max_browse THEN
   #該樣板不需此段落   CALL cl_err(g_browser_cnt,'9035',1)
   #該樣板不需此段落END IF

   #LET g_page_action = ps_page_action          # Keep Action

   IF ps_page_action = "F" OR
      ps_page_action = "P" OR
      ps_page_action = "N" OR
      ps_page_action = "L" THEN
      LET g_page_action = ps_page_action
   END IF

   CASE ps_page_action
      WHEN "F"
         LET g_pagestart = 1

      WHEN "P"
         LET g_pagestart = g_pagestart - 1
         IF g_pagestart < 1 THEN
            LET g_pagestart = 1
         END IF

      WHEN "N"
         LET g_pagestart = g_pagestart + 1
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = g_browser_cnt - (g_browser_cnt mod 1) + 1
            WHILE g_pagestart > g_browser_cnt
               LET g_pagestart = g_pagestart - 1
            END WHILE
         END IF

      WHEN "L"
         LET g_pagestart = g_browser_cnt - (g_browser_cnt mod 1) + 1
         WHILE g_pagestart > g_browser_cnt
            LET g_pagestart = g_pagestart - 1
         END WHILE

      WHEN '/'
         LET g_pagestart = g_jump
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = 1
         END IF

   END CASE

   ##單身有輸入查詢條件且非null
   #IF g_wc2 <> " 1=1" AND NOT cl_null(g_wc2) THEN
   #   #依照ooeb001 Browser欄位定義(取代原本bs_sql功能)
   #   LET l_sql_rank = "SELECT DISTINCT ooebstus,ooeb001,DENSE_RANK() OVER(ORDER BY ooeb001 ",g_order,") AS RANK ",
   #                     " FROM ooeb_t ",
   #                           " ",
   #                           " LEFT JOIN ooec_t ON ooecent = ooebent AND ooeb001 = ooec001",
   #
   #                           " ",
   #                           " ",
   #                    " ",
   #                    " WHERE ooebent = '" ||g_enterprise|| "' AND ",g_wc," AND ",g_wc2
   #ELSE
      #單身無輸入資料
      LET l_sql_rank = "SELECT DISTINCT ooebstus,ooeb001,DENSE_RANK() OVER(ORDER BY ooeb001 ",g_order,") AS RANK ",
                       " FROM ooeb_t ",
                            "  ",
                            "  ",
                       " WHERE ooebent = '" ||g_enterprise|| "' AND ", g_wc
   #END IF

   #定義翻頁CURSOR
   LET g_sql= "SELECT ooebstus,ooeb001 FROM (",l_sql_rank,") WHERE ",
              " RANK >= ",g_pagestart," AND RANK<",g_pagestart+500, #調整
              " ORDER BY ",l_searchcol," ",g_order

   PREPARE browse_pre FROM g_sql
   DECLARE browse_cur CURSOR FOR browse_pre

   CALL g_browser.clear()
   LET g_cnt = 1
   FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_ooeb001#,g_browser[g_cnt].rank
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF



      #add-point:browser_fill段reference
      
      SELECT ooebstus,ooeb003,ooeb007,ooeb008 INTO g_ooeb_m.ooebstus,g_ooeb_m.ooeb003,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008
        FROM ooeb_t
       WHERE ooeb001 = g_browser[g_cnt].b_ooeb001
         AND ooebent = g_enterprise
         
      #end add-point

            #此段落由子樣板a24產生
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/open.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/void.png"

         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/valid.png"


      END CASE


      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9035
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT FOREACH
      END IF

   END FOREACH

   CALL g_browser.deleteElement(g_cnt)
   LET g_header_cnt = g_browser.getLength()

   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0

   FREE browse_pre
   

   #add-point:browser_fill段結束前
   #調整 - 此段落刪除
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_ui_headershow" order="5" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_ui_headershow()
   #add-point:ui_headershow段define
   
   #end add-point

   LET g_ooeb_m.ooeb001 = g_browser[g_current_idx].b_ooeb001

    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   CALL aooi110_show()

END FUNCTION]]>
  </point>
  <point name="function.aooi110_ui_detailshow" order="6" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_ui_detailshow()
   #add-point:ui_detailshow段define
   
   #end add-point

   #add-point:ui_detailshow段before
   
   #end add-point

   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)

   END IF

   #add-point:ui_detailshow段after
   
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_ui_browser_refresh" order="7" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_ui_browser_refresh()
   {<Local define>}
   DEFINE l_i  LIKE type_t.num10
   {</Local define>}
   #add-point:ui_browser_refresh段define
   
   #end add-point

   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_ooeb001 = g_ooeb_m.ooeb001

         THEN
         CALL g_browser.deleteElement(l_i)
         LET g_header_cnt = g_header_cnt - 1
      END IF
   END FOR

   LET g_browser_cnt = g_browser_cnt - 1
   IF g_current_row > g_browser_cnt THEN        #確定browse 筆數指在同一筆
      LET g_current_row = g_browser_cnt
   END IF

   #DISPLAY g_browser_cnt TO FORMONLY.b_count    #總筆數的顯示

END FUNCTION]]>
  </point>
  <point name="function.aooi110_construct" order="8" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_construct()
   {<Local define>}
   DEFINE lc_qbe_sn   LIKE type_t.num10
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING
   {</Local define>}
   #add-point:cs段define
   
   #end add-point

   #清除畫面
   CLEAR FORM
   INITIALIZE g_ooeb_m.* TO NULL
   CALL g_ooef_d.clear()
   LET g_rec_b2 = 0

   LET g_current_idx = 1
   LET g_action_choice = ""

   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL

   INITIALIZE g_wc_table1 TO NULL


   LET g_qryparam.state = 'c'

   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭
      CONSTRUCT BY NAME g_wc ON ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt

         BEFORE CONSTRUCT
            #CALL cl_qbe_init()

         #一般欄位開窗相關處理
         #---------------------------<  Master  >---------------------------
         #----<<ooeb001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb001
            #add-point:BEFORE FIELD ooeb001
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb001

            #add-point:AFTER FIELD ooeb001
            
            #END add-point


         #Ctrlp:construct.c.ooeb001
#         ON ACTION controlp INFIELD ooeb001
            #add-point:ON ACTION controlp INFIELD ooeb001
            
            #END add-point

         #----<<ooeb002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb002
            #add-point:BEFORE FIELD ooeb002
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb002

            #add-point:AFTER FIELD ooeb002
            
            #END add-point


         #Ctrlp:construct.c.ooeb002
#         ON ACTION controlp INFIELD ooeb002
            #add-point:ON ACTION controlp INFIELD ooeb002
            
            #END add-point

         #----<<ooeb003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb003
            #add-point:BEFORE FIELD ooeb003
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb003

            #add-point:AFTER FIELD ooeb003
            
            #END add-point


         #Ctrlp:construct.c.ooeb003
#         ON ACTION controlp INFIELD ooeb003
            #add-point:ON ACTION controlp INFIELD ooeb003
            
            #END add-point

         #----<<ooeb004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb004
            #add-point:BEFORE FIELD ooeb004
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb004

            #add-point:AFTER FIELD ooeb004
            
            #END add-point


         #Ctrlp:construct.c.ooeb004
#         ON ACTION controlp INFIELD ooeb004
            #add-point:ON ACTION controlp INFIELD ooeb004
            
            #END add-point

         #----<<ooeb005>>----
         #Ctrlp:construct.c.ooeb005
         ON ACTION controlp INFIELD ooeb005
            #add-point:ON ACTION controlp INFIELD ooeb005
#此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooeb005  #顯示到畫面上

            NEXT FIELD ooeb005                     #返回原欄位


            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD ooeb005
            #add-point:BEFORE FIELD ooeb005
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb005

            #add-point:AFTER FIELD ooeb005
            
            #END add-point


         #----<<ooeb006>>----
         #Ctrlp:construct.c.ooeb006
         ON ACTION controlp INFIELD ooeb006
            #add-point:ON ACTION controlp INFIELD ooeb006
#此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooed003()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooeb006  #顯示到畫面上

            NEXT FIELD ooeb006                     #返回原欄位


            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD ooeb006
            #add-point:BEFORE FIELD ooeb006
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb006

            #add-point:AFTER FIELD ooeb006
            
            #END add-point


         #----<<ooeb007>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb007
            #add-point:BEFORE FIELD ooeb007
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb007

            #add-point:AFTER FIELD ooeb007
            
            #END add-point


         #Ctrlp:construct.c.ooeb007
#         ON ACTION controlp INFIELD ooeb007
            #add-point:ON ACTION controlp INFIELD ooeb007
            
            #END add-point

         #----<<ooeb008>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb008
            #add-point:BEFORE FIELD ooeb008
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb008

            #add-point:AFTER FIELD ooeb008
            
            #END add-point


         #Ctrlp:construct.c.ooeb008
#         ON ACTION controlp INFIELD ooeb008
            #add-point:ON ACTION controlp INFIELD ooeb008
            
            #END add-point

         #----<<ooebstus>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebstus
            #add-point:BEFORE FIELD ooebstus
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebstus

            #add-point:AFTER FIELD ooebstus
            
            #END add-point


         #Ctrlp:construct.c.ooebstus
#         ON ACTION controlp INFIELD ooebstus
            #add-point:ON ACTION controlp INFIELD ooebstus
            
            #END add-point

         #----<<ooebmodid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmodid
            #add-point:BEFORE FIELD ooebmodid
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebmodid

            #add-point:AFTER FIELD ooebmodid
            
            #END add-point


         #Ctrlp:construct.c.ooebmodid
#         ON ACTION controlp INFIELD ooebmodid
            #add-point:ON ACTION controlp INFIELD ooebmodid
            
            #END add-point

         #----<<ooebmoddt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmoddt
         
         AFTER FIELD ooebmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<ooebownid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebownid
            #add-point:BEFORE FIELD ooebownid
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebownid

            #add-point:AFTER FIELD ooebownid
            
            #END add-point


         #Ctrlp:construct.c.ooebownid
#         ON ACTION controlp INFIELD ooebownid
            #add-point:ON ACTION controlp INFIELD ooebownid
            
            #END add-point

         #----<<ooebowndp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebowndp
            #add-point:BEFORE FIELD ooebowndp
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebowndp

            #add-point:AFTER FIELD ooebowndp
            
            #END add-point


         #Ctrlp:construct.c.ooebowndp
#         ON ACTION controlp INFIELD ooebowndp
            #add-point:ON ACTION controlp INFIELD ooebowndp
            
            #END add-point

         #----<<ooebcrtid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtid
            #add-point:BEFORE FIELD ooebcrtid
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtid

            #add-point:AFTER FIELD ooebcrtid
            
            #END add-point


         #Ctrlp:construct.c.ooebcrtid
#         ON ACTION controlp INFIELD ooebcrtid
            #add-point:ON ACTION controlp INFIELD ooebcrtid
            
            #END add-point

         #----<<ooebcrtdp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdp
            #add-point:BEFORE FIELD ooebcrtdp
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtdp

            #add-point:AFTER FIELD ooebcrtdp
            
            #END add-point


         #Ctrlp:construct.c.ooebcrtdp
#         ON ACTION controlp INFIELD ooebcrtdp
            #add-point:ON ACTION controlp INFIELD ooebcrtdp
            
            #END add-point

         #----<<ooebcrtdt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdt
            #add-point:BEFORE FIELD ooebcrtdt
            
            #END add-point
            
         AFTER FIELD ooebcrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)


      END CONSTRUCT

     
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令)
      
      #end add-point

      BEFORE DIALOG
         #add-point:cs段b_dialog
         
         #end add-point

      ON ACTION qbe_select     #條件查詢
         #CALL cl_qbe_list() RETURNING lc_qbe_sn
         #CALL cl_qbe_display_condition(lc_qbe_sn)

      ON ACTION qbe_save       #條件儲存
         #CALL cl_qbe_save()

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG

   #組合g_wc2
   LET g_wc2 = g_wc_table1


   IF INT_FLAG THEN
      RETURN
   END IF

END FUNCTION]]>
  </point>
  <point name="function.aooi110_query" order="9" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_query()
   #add-point:query段define
   
   #end add-point

   #切換畫面
   #該樣板不需此段落IF g_main_hidden THEN
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("mainlayout",0)
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("worksheet",1)
   #該樣板不需此段落   LET g_main_hidden = 0
   #該樣板不需此段落END IF

   LET INT_FLAG = 0
   LET g_detail_cnt = 0
   LET g_current_idx = 0
   LET g_current_row = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""

   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()
   CALL g_ooef_d.clear()
   LET g_flag2 = FALSE
   LET g_rec_b2 = 0

   DISPLAY ' ' TO FORMONLY.idx
   DISPLAY ' ' TO FORMONLY.cnt
   DISPLAY ' ' TO FORMONLY.b_index
   DISPLAY ' ' TO FORMONLY.b_count
   DISPLAY ' ' TO FORMONLY.h_index
   DISPLAY ' ' TO FORMONLY.h_count

   CALL aooi110_construct()

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      INITIALIZE g_ooeb_m.* TO NULL
      LET g_wc = " 1=1"
      LET g_wc2 = " 1=1"
      RETURN
   END IF

   LET g_wc_filter = ""
   #該樣板不需此段落
   CALL aooi110_browser_fill("F")

   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "-100"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()

   ELSE
      CALL aooi110_fetch("F")
   END IF

END FUNCTION]]>
  </point>
  <point name="function.aooi110_fetch" order="10" ver="7" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_fetch(p_flag)
   {<Local define>}
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #調整
   DEFINE l_ooed003         LIKE ooed_t.ooed003
   DEFINE l_pid             LIKE type_t.chr100
   DEFINE l_pid_1           LIKE type_t.chr100
   DEFINE l_n               LIKE type_t.num5
   {</Local define>}
   #add-point:fetch段define
   
   #end add-point

   IF g_browser_cnt = 0 THEN
      RETURN
   END IF

   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt
      WHEN 'P'
         IF g_current_idx > 1 THEN
            LET g_current_idx = g_current_idx - 1
         END IF
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF
      WHEN '/'
         IF (NOT g_no_ask) THEN
            CALL cl_set_act_visible("accept,cancel", TRUE)
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0

            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl"
            END PROMPT

            CALL cl_set_act_visible("accept,cancel", FALSE)
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE
            END IF
         END IF

         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF

         LET g_no_ask = FALSE
   END CASE

   #調整
   #CALL aooi110_browser_fill(p_flag)

   #該樣板不需此段落CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引

   LET g_detail_cnt = g_header_cnt

   #單身總筆數顯示
   LET g_detail_idx = 1
   IF g_detail_cnt > 0 THEN
      LET g_detail_idx = 1
      DISPLAY g_detail_idx TO FORMONLY.idx
   ELSE
      LET g_detail_idx = 0
      DISPLAY ' ' TO FORMONLY.idx
   END IF

   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數

   #該樣板不需此段落CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   #調整
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )

   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF

   #超出範圍
   IF g_current_idx > g_browser.getLength() THEN
      LET g_current_idx = g_browser.getLength()
   END IF

   LET g_ooeb_m.ooeb001 = g_browser[g_current_idx].b_ooeb001

   #調整
   SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
     INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,
          g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
     FROM ooeb_t
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "ooeb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      INITIALIZE g_ooeb_m.* TO NULL
      RETURN
   END IF
   
   CALL aooi110_tree_fill()
   
   #重新顯示
   CALL aooi110_show()
   
   CALL cl_set_act_visible("modify,delete,produce,ins_aooi100,upd_aooi100,del_aooi100", TRUE)

   CALL aooi110_set_act_visible()
   CALL aooi110_set_act_no_visible()
   

END FUNCTION]]>
  </point>
  <point name="function.aooi110_tree_expand" order="11" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_tree_expand(p_id)
DEFINE p_id          LIKE type_t.num10
DEFINE l_id          LIKE type_t.num10
DEFINE l_cnt         LIKE type_t.num10
DEFINE l_keyvalue    LIKE type_t.chr50
DEFINE l_typevalue   LIKE type_t.chr50
DEFINE l_type        LIKE type_t.chr50
DEFINE l_sql         LIKE type_t.chr500
DEFINE ls_source     LIKE type_t.chr500
DEFINE ls_exp_code   LIKE type_t.chr500

   #若已經展開
   IF g_tree[p_id].b_isExp = 1 THEN
      RETURN
   END IF

   LET g_tree[p_id].b_isExp = 1

   LET l_keyvalue = g_tree[p_id].b_ooed004


   LET l_sql = "SELECT UNIQUE ooed004 ",
               "  FROM ooed_tmp ",
               " WHERE ooedent = '",g_enterprise,"' ",
               "   AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
               "   AND ooed002 = '",g_tree[p_id].b_ooed002,"' ",
               "   AND ooed005 = '",l_keyvalue,"' ",
               "   AND ooed004 <> ooed005 ",
               " ORDER BY ooed004"

   PREPARE tree_expand1 FROM l_sql
   DECLARE tree_ex_cur1 CURSOR FOR tree_expand1

   LET l_id = p_id + 1
   CALL g_tree.insertElement(l_id)
   LET l_cnt = 1
   FOREACH tree_ex_cur1 INTO g_tree[l_id].b_ooed004
      IF cl_null(g_tree[l_id].b_ooed004) THEN
         CALL g_tree.deleteElement(l_id)
         EXIT FOREACH
      END IF
      #pid=父節點id
      LET g_tree[l_id].b_pid  = g_tree[p_id].b_id
      #id=本身節點id(採流水號遞增)
      LET g_tree[l_id].b_id  = g_tree[p_id].b_id||"."||l_cnt
      LET g_tree[l_id].b_exp = TRUE
      LET g_tree[l_id].b_ooed005 = g_tree[p_id].b_ooed004
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_tree[l_id].b_ooed004
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_tree[l_id].b_ooed004_desc = g_rtn_fields[1]
      LET g_tree[l_id].b_show =  g_tree[l_id].b_ooed004,' (',g_tree[l_id].b_ooed004_desc,')'
      LET g_tree[l_id].b_ooed002 = g_tree[p_id].b_ooed002
      #hasC=確認該節點是否有子孫
      LET g_tree[l_id].b_hasC = aooi110_chk_hasC(l_id)
      LET l_id = l_id + 1
      CALL g_tree.insertElement(l_id)
      LET l_cnt = l_cnt + 1
   END FOREACH
   LET l_cnt = l_cnt -1
   #刪除空資料
   CALL g_tree.deleteElement(l_id)

END FUNCTION]]>
  </point>
  <point name="function.aooi110_chk_hasC" order="12" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_chk_hasC(pi_id)
DEFINE pi_id    INTEGER
DEFINE li_cnt   INTEGER


   LET g_sql = "SELECT COUNT(*) FROM ooed_tmp ",
               " WHERE ooedent = '" ||g_enterprise|| "'",
               "   AND ooed002 = '",g_tree[pi_id].b_ooed002,"' ",
               "   AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
               "   AND ooed004 <> ooed005 ",
               "   AND ooed005 = ? "
   PREPARE aooi110_master_chk1 FROM g_sql
   EXECUTE aooi110_master_chk1 USING g_tree[pi_id].b_ooed004 INTO li_cnt
   FREE aooi110_master_chk1
   IF li_cnt > 0 THEN
      RETURN TRUE
   ELSE
      RETURN FALSE
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_insert" order="13" ver="8" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_insert()
   #add-point:insert段define
   
   #end add-point

   #清畫面欄位內容
   CLEAR FORM
   CALL g_ooef_d.clear()
   LET g_flag2 = FALSE
   LET g_rec_b2 = 0

   INITIALIZE g_ooeb_m.* LIKE ooeb_t.*             #DEFAULT 設定

   WHILE TRUE

      #append欄位給值


      #一般欄位給值
            


      #add-point:單頭預設值
      INITIALIZE g_ooeb_m.* TO NULL 
      INITIALIZE g_ooeb_m_t.* TO NULL 
      INITIALIZE g_ooeb_m_o.* TO NULL 
      
      LET g_ooeb_m.ooeb003 = "1"
      LET g_ooeb_m.ooeb002 = g_today
      LET g_ooeb_m.ooebstus = "N"
      LET g_ooeb_m.ooebownid = g_user
      LET g_ooeb_m.ooebowndp = g_dept
      LET g_ooeb_m.ooebcrtid = g_user
      LET g_ooeb_m.ooebcrtdp = g_dept
      LET g_ooeb_m.ooebcrtdt = cl_get_current()
      LET g_ooeb_m.ooebmodid = g_user
      LET g_ooeb_m.ooebmoddt = cl_get_current()
      
      CALL aooi110_auto_code() RETURNING g_ooeb_m.ooeb001
      DISPLAY BY NAME g_ooeb_m.ooeb001
      
      LET g_ooeb_m_t.* = g_ooeb_m.*
      LET g_ooeb_m_o.* = g_ooeb_m.*
      #end add-point

      CALL aooi110_input("a")

      #add-point:單頭輸入後
      
      #end add-point

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_ooeb_m.* = g_ooeb_m_t.*
         CALL aooi110_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT WHILE
      END IF



      LET g_rec_b2 = 0
      EXIT WHILE

   END WHILE

   LET g_state = "Y"

   LET g_ooeb001_t = g_ooeb_m.ooeb001


   LET g_wc = g_wc,
              " OR (",
              " ooeb001 = '", g_ooeb_m.ooeb001 CLIPPED, "' "

              , ") "
              
   LET g_flag2 = TRUE       #新增或者修改後，顯示單身資料   
  
END FUNCTION]]>
  </point>
  <point name="function.aooi110_modify" order="14" ver="7" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_modify()
   {<Local define>}
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:modify段define

   #end add-point

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001

   ERROR ""

   LET g_ooeb001_t = g_ooeb_m.ooeb001

   BEGIN WORK

   OPEN aooi110_cl USING g_enterprise,g_ooeb_m.ooeb001

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN aooi110_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE aooi110_cl
      ROLLBACK WORK
      RETURN
   END IF

   #鎖住將被更改或取消的資料
   FETCH aooi110_cl INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt

   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE aooi110_cl
      ROLLBACK WORK
      RETURN
   END IF

   LET g_flag2 = FALSE
   LET g_rec_b2 = 0

   CALL aooi110_show()
   WHILE TRUE
      LET g_ooeb001_t = g_ooeb_m.ooeb001


      #寫入修改者/修改日期資訊(單頭)
      LET g_ooeb_m.ooebmodid = g_user
      LET g_ooeb_m.ooebmoddt = cl_get_current()


      CALL aooi110_input("u")     #欄位更改

      #add-point:modify段修改後
      
      #end add-point

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_ooeb_m.* = g_ooeb_m_t.*
         CALL aooi110_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT WHILE
      END IF

      #若單頭key欄位有變更
      IF g_ooeb_m.ooeb001 != g_ooeb001_t

      THEN
         BEGIN WORK

         #add-point:單身fk修改前
         
         #end add-point


         #add-point:單身fk修改後
         
         #end add-point

         #UPDATE 多語言table key值


         COMMIT WORK
      END IF

      EXIT WHILE
   END WHILE
   
   LET g_flag2 = TRUE       #新增或者修改後，顯示單身資料   
  
   #修改歷程記錄
   IF NOT cl_log_modified_record(g_ooeb_m.ooeb001,g_site) THEN
      ROLLBACK WORK
   END IF

   CLOSE aooi110_cl
   COMMIT WORK

   #流程通知預埋點-U
   CALL cl_flow_notify(g_ooeb_m.ooeb001,'U')

END FUNCTION]]>
  </point>
  <point name="function.aooi110_input" order="15" ver="8" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_input(p_cmd)
   {<Local define>}
   DEFINE  p_cmd           LIKE type_t.chr1
   DEFINE  l_cmd           LIKE type_t.chr1
   DEFINE  l_ac_t          LIKE type_t.num5                #未取消的ARRAY CNT
   DEFINE  l_n             LIKE type_t.num5                #檢查重複用
   DEFINE  l_cnt           LIKE type_t.num5                #檢查重複用
   DEFINE  l_lock_sw       LIKE type_t.chr1                #單身鎖住否
   DEFINE  l_allow_insert  LIKE type_t.num5                #可新增否
   DEFINE  l_allow_delete  LIKE type_t.num5                #可刪除否
   DEFINE  l_count         LIKE type_t.num5
   DEFINE  l_i             LIKE type_t.num5
   DEFINE  l_insert        BOOLEAN
   DEFINE  ls_return       STRING
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:input段define
   
   DEFINE l_ooeb006        LIKE ooeb_t.ooeb006
   DEFINE l_flag           LIKE type_t.num5
   
   #end add-point

   #切換畫面
   #該樣板不需此段落IF g_main_hidden THEN
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("mainlayout",0)
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("worksheet",1)
   #該樣板不需此段落   LET g_main_hidden = 0
   #該樣板不需此段落END IF

   CALL cl_set_head_visible("","YES")

   LET l_insert = FALSE
   LET g_action_choice = ""

   
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'

   #控制key欄位可否輸入
   CALL aooi110_set_entry(p_cmd)
   CALL aooi110_set_no_entry(p_cmd)

   DISPLAY BY NAME g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt

   #add-point:資料輸入前
   
   #end add-point
   LET g_errshow = 1 
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭段
      INPUT BY NAME g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
         ATTRIBUTE(WITHOUT DEFAULTS)

         #自訂ACTION(master_input)


         BEFORE INPUT
            LET l_flag = FALSE

         #---------------------------<  Master  >---------------------------
         #----<<ooeb001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb001
            #add-point:BEFORE FIELD ooeb001
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb001

            #add-point:AFTER FIELD ooeb001
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) THEN
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( p_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t ))) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooeb_t WHERE "||"ooebent = '" ||g_enterprise|| "' AND "||"ooeb001 = '"||g_ooeb_m.ooeb001 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF



            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb001
            #add-point:ON CHANGE ooeb001
            
            #END add-point

         #----<<ooeb002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb002
            #add-point:BEFORE FIELD ooeb002
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb002

            #add-point:AFTER FIELD ooeb002
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb002
            #add-point:ON CHANGE ooeb002
            
            #END add-point

         #----<<ooeb003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb003
            #add-point:BEFORE FIELD ooeb003
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb003

            #add-point:AFTER FIELD ooeb003
            IF NOT cl_null(g_ooeb_m.ooeb003) THEN
               IF g_ooeb_m.ooeb003 <> g_ooeb_m_o.ooeb003 OR cl_null(g_ooeb_m_o.ooeb003) THEN
                  IF NOT aooi110_chk_ooeb005() THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_ooeb_m.ooeb003
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  
                     LET g_ooeb_m.ooeb003= g_ooeb_m_o.ooeb003
                     NEXT FIELD ooeb003
                  END IF
                  CALL aooi110_chk_ooeb006()
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_ooeb_m.ooeb003
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  
                     LET g_ooeb_m.ooeb003= g_ooeb_m_o.ooeb003
                     NEXT FIELD ooeb003
                  END IF
                  CALL aooi110_set_entry('a')
                  CALL aooi110_set_no_entry('a')
                  CALL aooi110_def_ooeb006()
                  CALL aooi110_out_tree()
                  
                  #add by lixiang
                  #變更類型為新增時，若選擇依上一版本带出预设值，则将当前最上层组织的上一版本的组织树预设带出
                  IF g_ooeb_m.ooeb003 = '1' AND (NOT cl_null(g_ooeb_m.ooeb004)) AND (NOT cl_null(g_ooeb_m.ooeb005)) THEN
                     SELECT MAX(ooed003) INTO l_ooeb006 FROM ooed_t
                        WHERE ooedent = g_enterprise AND ooed001 = g_ooeb_m.ooeb004 AND ooed002 = g_ooeb_m.ooeb005
                     IF l_ooeb006 > 0 THEN
                        IF cl_ask_confirm('aoo-00643') THEN
                           CALL aooi110_out_tree1()
                           LET l_flag = TRUE
                        ELSE
                           LET l_flag = FALSE
                        END IF
                     END IF
                  END IF
                  
               END IF
            END IF
            LET g_ooeb_m_o.ooeb003= g_ooeb_m.ooeb003
            #IF p_cmd = 'a' THEN
            #   CALL aooi110_tree_tmp_fill1()
            #END IF
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb003
            #add-point:ON CHANGE ooeb003
            
            #CALL aooi110_set_entry('a')
            #CALL aooi110_set_no_entry('a')
            #CALL aooi110_def_ooeb006()
            #CALL aooi110_out_tree()
            #END add-point

         #----<<ooeb004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb004
            #add-point:BEFORE FIELD ooeb004
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb004

            #add-point:AFTER FIELD ooeb004
            IF NOT cl_null(g_ooeb_m.ooeb004) THEN
               IF g_ooeb_m.ooeb004 <> g_ooeb_m_o.ooeb004 OR cl_null(g_ooeb_m_o.ooeb004) THEN
                  IF NOT aooi110_chk_ooeb005() THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_ooeb_m.ooeb004
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  
                     LET g_ooeb_m.ooeb004= g_ooeb_m_o.ooeb004
                     NEXT FIELD ooeb004
                  END IF
                  CALL aooi110_chk_ooeb006()
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_ooeb_m.ooeb004
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  
                     LET g_ooeb_m.ooeb004= g_ooeb_m_o.ooeb004
                     NEXT FIELD ooeb004
                  END IF
                  CALL aooi110_def_ooeb006()
                  CALL aooi110_out_tree()
                  
                  #add by lixiang
                  #變更類型為新增時，若選擇依上一版本带出预设值，则将当前最上层组织的上一版本的组织树预设带出
                  IF g_ooeb_m.ooeb003 = '1' AND (NOT cl_null(g_ooeb_m.ooeb005)) THEN
                     SELECT MAX(ooed003) INTO l_ooeb006 FROM ooed_t
                        WHERE ooedent = g_enterprise AND ooed001 = g_ooeb_m.ooeb004 AND ooed002 = g_ooeb_m.ooeb005
                     IF l_ooeb006 > 0 THEN
                        IF cl_ask_confirm('aoo-00643') THEN
                           CALL aooi110_out_tree1()
                           LET l_flag = TRUE
                        ELSE
                           LET l_flag = FALSE
                        END IF
                     END IF
                  END IF
                  
               END IF
               #IF p_cmd = 'a' THEN
               #   CALL aooi110_tree_tmp_fill1()
               #END IF
            END IF
            LET g_ooeb_m_o.ooeb004= g_ooeb_m.ooeb004
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb004
            #add-point:ON CHANGE ooeb004
            
            #CALL aooi110_def_ooeb006()
            #CALL aooi110_out_tree()
            #END add-point

         #----<<ooeb005>>----
         #此段落由子樣板a02產生
         AFTER FIELD ooeb005

            #add-point:AFTER FIELD ooeb005
            IF NOT cl_null(g_ooeb_m.ooeb005) THEN
               IF g_ooeb_m.ooeb005 <> g_ooeb_m_o.ooeb005 OR cl_null(g_ooeb_m_o.ooeb005) THEN
                  LET g_ooeb_m.ooeb005_desc = ""
                  DISPLAY BY NAME g_ooeb_m.ooeb005_desc
                  IF NOT cl_null(g_ooeb_m.ooeb005) THEN
                     IF NOT aooi110_chk_ooeb005() THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = g_ooeb_m.ooeb005
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                    
                        LET g_ooeb_m.ooeb005= g_ooeb_m_o.ooeb005
                        CALL aooi110_ooec005_desc()
                        NEXT FIELD ooeb005
                     END IF
                  END IF
                  
                  CALL aooi110_chk_ooeb006()
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_ooeb_m.ooeb005
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  
                     LET g_ooeb_m.ooeb005= g_ooeb_m_o.ooeb005
                     CALL aooi110_ooec005_desc()
                     NEXT FIELD ooeb005
                  END IF
                  CALL aooi110_def_ooeb006()
                  CALL aooi110_ooec005_desc()
                  CALL aooi110_out_tree()
                  #IF p_cmd = 'a' THEN
                  #   CALL aooi110_tree_tmp_fill1()
                  #END IF
                  #add by lixiang
                  #變更類型為新增時，若選擇依上一版本带出预设值，则将当前最上层组织的上一版本的组织树预设带出
                  IF g_ooeb_m.ooeb003 = '1' AND (NOT cl_null(g_ooeb_m.ooeb004)) THEN
                     SELECT MAX(ooed003) INTO l_ooeb006 FROM ooed_t
                        WHERE ooedent = g_enterprise AND ooed001 = g_ooeb_m.ooeb004 AND ooed002 = g_ooeb_m.ooeb005
                     IF l_ooeb006 > 0 THEN
                        IF cl_ask_confirm('aoo-00643') THEN
                           CALL aooi110_out_tree1()
                           LET l_flag = TRUE
                        ELSE
                           LET l_flag = FALSE
                        END IF
                     END IF
                  END IF
               END IF
            END IF
            LET g_ooeb_m_o.ooeb005= g_ooeb_m.ooeb005
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD ooeb005
            #add-point:BEFORE FIELD ooeb005
            
            #CALL aooi110_def_ooeb006()
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE ooeb005
            #add-point:ON CHANGE ooeb005
            
            #CALL aooi110_out_tree()
            #IF p_cmd = 'a' THEN
            #   CALL aooi110_tree_tmp_fill1()
            #END IF
            #END add-point

         #----<<ooeb006>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb006
            #add-point:BEFORE FIELD ooeb006
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb006

            #add-point:AFTER FIELD ooeb006
            IF NOT aooi110_chk_ooeb005() THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb006
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb006= g_ooeb_m_t.ooeb006
               NEXT FIELD ooeb006
            END IF
            CALL aooi110_chk_ooeb006()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb006
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb006= g_ooeb_m_t.ooeb006
               NEXT FIELD ooeb006
            END IF
            CALL aooi110_out_tree()
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb006
            #add-point:ON CHANGE ooeb006
            
            CALL aooi110_out_tree()
            #END add-point

         #----<<ooeb007>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb007
            #add-point:BEFORE FIELD ooeb007
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb007

            #add-point:AFTER FIELD ooeb007
            CALL aooi110_chk_date()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb007
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb007= g_ooeb_m_t.ooeb007
               NEXT FIELD ooeb007
            END IF
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb007
            #add-point:ON CHANGE ooeb007
            
            #END add-point

         #----<<ooeb008>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb008
            #add-point:BEFORE FIELD ooeb008
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb008

            #add-point:AFTER FIELD ooeb008
            CALL aooi110_chk_date()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb008
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb008= g_ooeb_m_t.ooeb008
               NEXT FIELD ooeb008
            END IF
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb008
            #add-point:ON CHANGE ooeb008
            
            #END add-point

         #----<<ooebstus>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebstus
            #add-point:BEFORE FIELD ooebstus
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebstus

            #add-point:AFTER FIELD ooebstus
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebstus
            #add-point:ON CHANGE ooebstus
            
            #END add-point

         #----<<ooebmodid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmodid
            #add-point:BEFORE FIELD ooebmodid
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebmodid

            #add-point:AFTER FIELD ooebmodid
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebmodid
            #add-point:ON CHANGE ooebmodid
            
            #END add-point

         #----<<ooebmoddt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmoddt
            #add-point:BEFORE FIELD ooebmoddt
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebmoddt

            #add-point:AFTER FIELD ooebmoddt
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebmoddt
            #add-point:ON CHANGE ooebmoddt
            
            #END add-point

         #----<<ooebownid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebownid
            #add-point:BEFORE FIELD ooebownid
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebownid

            #add-point:AFTER FIELD ooebownid
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebownid
            #add-point:ON CHANGE ooebownid
            
            #END add-point

         #----<<ooebowndp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebowndp
            #add-point:BEFORE FIELD ooebowndp
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebowndp

            #add-point:AFTER FIELD ooebowndp
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebowndp
            #add-point:ON CHANGE ooebowndp
            
            #END add-point

         #----<<ooebcrtid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtid
            #add-point:BEFORE FIELD ooebcrtid
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtid

            #add-point:AFTER FIELD ooebcrtid
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebcrtid
            #add-point:ON CHANGE ooebcrtid
            
            #END add-point

         #----<<ooebcrtdp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdp
            #add-point:BEFORE FIELD ooebcrtdp
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtdp

            #add-point:AFTER FIELD ooebcrtdp
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebcrtdp
            #add-point:ON CHANGE ooebcrtdp
            
            #END add-point

         #----<<ooebcrtdt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdt
            #add-point:BEFORE FIELD ooebcrtdt
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtdt

            #add-point:AFTER FIELD ooebcrtdt
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebcrtdt
            #add-point:ON CHANGE ooebcrtdt
            
            #END add-point



         #----<<ooeb005>>----
         #Ctrlp:input.c.ooeb005
         ON ACTION controlp INFIELD ooeb005
            #add-point:ON ACTION controlp INFIELD ooeb005
#此段落由子樣板a07產生
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_ooeb_m.ooeb005             #給予default值

            #給予arg
            IF NOT cl_null(g_ooeb_m.ooeb004) THEN
                CASE g_ooeb_m.ooeb004
                   WHEN '1'  LET g_qryparam.where = " ooef203 = 'Y' "
                   WHEN '4'  LET g_qryparam.where = " ooef205 = 'Y' " 
                   WHEN '5'  LET g_qryparam.where = " ooef207 = 'Y' "
                   WHEN '6'  LET g_qryparam.where = " ooef206 = 'Y' "
                   WHEN '7'  LET g_qryparam.where = " ooef206 = 'Y' "
                   WHEN '8'  LET g_qryparam.where = " ooef201 = 'Y' "
                   WHEN '9'  LET g_qryparam.where = " ooef208 = 'Y' "
                   WHEN '10' LET g_qryparam.where = " ooef210 = 'Y' "
                   WHEN '11' LET g_qryparam.where = " ooef211 = 'Y' "
                   WHEN '12' LET g_qryparam.where = " ooef212 = 'Y' "
                END CASE
            END IF
            CALL q_ooef001()                                #呼叫開窗

            LET g_ooeb_m.ooeb005 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_ooeb_m.ooeb005 TO ooeb005              #顯示到畫面上
            LET g_qryparam.where =""
            CALL aooi110_ooec005_desc()
            NEXT FIELD ooeb005                          #返回原欄位


            #END add-point

         #----<<ooeb006>>----
         #Ctrlp:input.c.ooeb006
         ON ACTION controlp INFIELD ooeb006
            #add-point:ON ACTION controlp INFIELD ooeb006
#此段落由子樣板a07產生
            #開窗i段

            #給予arg
            IF NOT (g_ooeb_m.ooeb003 = '1') THEN
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_ooeb_m.ooeb006             #給予default
               IF NOT cl_null(g_ooeb_m.ooeb004) THEN
                  IF g_ooeb_m.ooeb003 = '2' THEN
                     LET g_qryparam.where = "ooed001 = '",g_ooeb_m.ooeb004,"' AND ooed003 IN(SELECT ooed003 FROM ooed_t WHERE ooedent = '",g_enterprise,"' AND  ooed001 = '",g_ooeb_m.ooeb004,"'  AND (ooed007 >= to_date('",g_today,"','YYYY/MM/DD') OR ooed007 IS NULL))"
                  ELSE
                     LET g_qryparam.where = "ooed001 = '",g_ooeb_m.ooeb004,"' AND ooed003 IN(SELECT ooed003 FROM ooed_t WHERE ooedent = '",g_enterprise,"' AND  ooed001 = '",g_ooeb_m.ooeb004,"'  AND ooed006 > to_date('",g_today,"','YYYY/MM/DD'))"
                  END IF
                  IF NOT cl_null(g_ooeb_m.ooeb005) THEN
                     IF g_ooeb_m.ooeb003 = '2' THEN
                        LET g_qryparam.where = "ooed001 = '",g_ooeb_m.ooeb004,"' AND ooed002 = '",g_ooeb_m.ooeb005,"' AND ooed003 IN(SELECT ooed003 FROM ooed_t WHERE ooedent = '",g_enterprise,"' AND  ooed001 = '",g_ooeb_m.ooeb004,"' AND ooed002 = '",g_ooeb_m.ooeb005,"' AND (ooed007 >= to_date('",g_today,"','YYYY/MM/DD') OR ooed007 IS NULL)) "
                     ELSE
                        LET g_qryparam.where = "ooed001 = '",g_ooeb_m.ooeb004,"' AND ooed002 = '",g_ooeb_m.ooeb005,"' AND ooed003 IN(SELECT ooed003 FROM ooed_t WHERE ooedent = '",g_enterprise,"' AND  ooed001 = '",g_ooeb_m.ooeb004,"' AND ooed002 = '",g_ooeb_m.ooeb005,"' AND ooed006 > to_date('",g_today,"','YYYY/MM/DD'))"
                     END IF
                  END IF
               END IF
               
               CALL q_ooed003()                                #呼叫開窗
     
               LET g_ooeb_m.ooeb006 = g_qryparam.return1              #將開窗取得的值回傳到變數
               
               DISPLAY g_ooeb_m.ooeb006 TO ooeb006              #顯示到畫面上
               LET g_qryparam.where = ""
               NEXT FIELD ooeb006                          #返回原欄位

            END IF
            #END add-point


 #欄位開窗

         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF

            CALL cl_showmsg()      #錯誤訊息統整顯示
            DISPLAY BY NAME g_ooeb_m.ooeb001
        
            IF g_ooeb_m.ooeb003 = '1' THEN
               LET l_count = 1
               IF NOT cl_null(g_ooeb_m.ooeb008) THEN
                  SELECT COUNT(*) INTO l_count FROM ooeb_t WHERE ooeb004 = g_ooeb_m.ooeb004 AND ooeb005 = g_ooeb_m.ooeb005 AND ooeb007 = g_ooeb_m.ooeb007 AND ooeb008 = g_ooeb_m.ooeb008 AND g_ooeb_m.ooebstus <> 'X'
               ELSE
                  SELECT COUNT(*) INTO l_count FROM ooeb_t WHERE ooeb004 = g_ooeb_m.ooeb004 AND ooeb005 = g_ooeb_m.ooeb005 AND ooeb007 = g_ooeb_m.ooeb007 AND g_ooeb_m.ooebstus <> 'X'
               END IF               
               IF l_count > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'aoo-00644'
                  LET g_errparam.extend = "g_ooeb_m.ooeb005"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD ooeb007
               END IF
            END IF
               
            BEGIN WORK
            IF p_cmd <> 'u' THEN
               LET l_count = 1

               SELECT COUNT(*) INTO l_count FROM ooeb_t
                WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001

               IF l_count = 0 THEN

                  #add-point:單頭新增前
                  #CALL aooi110_auto_code() RETURNING g_ooeb_m.ooeb001
                  #DISPLAY BY NAME g_ooeb_m.ooeb001
                  #end add-point

                  INSERT INTO ooeb_t (ooebent,ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt)
                  VALUES (g_enterprise,g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt) # DISK WRITE
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "g_ooeb_m"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CONTINUE DIALOG
                  END IF

                  CALL aooi110_ins_ooec()
                  
                  COMMIT WORK

                  #add-point:單頭新增後
                  #IF g_ooeb_m.ooeb003 = '1' THEN
                  #   CALL aooi110_01(g_ooeb_m.ooeb001) RETURNING g_wcb
                  #   CALL aooi110_ins_tmp()
                  #END IF
                  
                  CALL aooi110_tree_tmp_fill()
                  CALL aooi110_tree_fill()
                  #end add-point

                  LET p_cmd = 'u'

               ELSE
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = '!'
                  LET g_errparam.extend =  g_ooeb_m.ooeb001
                  LET g_errparam.popup = FALSE
                  CALL cl_err()

                  ROLLBACK WORK
                  NEXT FIELD ooeb001
               END IF
            ELSE

               #add-point:單頭修改前
               
               #end add-point

               UPDATE ooeb_t SET (ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt) = (g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt)
                WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb001_t

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "g_ooeb_m"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                  ROLLBACK WORK
               END IF

               IF g_ooeb_m.ooeb005 != g_ooeb_m_t.ooeb005 OR g_ooeb_m.ooeb004 != g_ooeb_m_t.ooeb004 THEN
                  IF (g_ooeb_m.ooeb003 ='1' AND NOT l_flag) OR g_ooeb_m.ooeb003 ='2' THEN  #沒有預設上一版本的組織結構
                     DELETE FROM ooec_t WHERE ooecent = g_enterprise AND ooec008 = g_ooeb_m.ooeb001
                     
                     CALL aooi110_ins_ooec()
                  END IF
               END IF
               
               COMMIT WORK

               #add-point:單頭修改後
               #IF g_ooeb_m.ooeb003 = '1' THEN
               #   CALL aooi110_01(g_ooeb_m.ooeb001) RETURNING g_wcb
               #   DELETE FROM ooed_tmp
               #   CALL aooi110_ins_tmp()
               #END IF
               
               CALL aooi110_tree_tmp_fill()
               CALL aooi110_tree_fill()
               #end add-point

            END IF
           #controlp
      END INPUT


      #add-point:自定義input
      CONSTRUCT g_wc_table2 ON ooef001,ooef017
           FROM s_detail1[1].ooef001,s_detail1[1].ooef017

         BEFORE CONSTRUCT
            LET g_flag2 = TRUE   #表示已經走過查詢，需顯示單身資料
         
         ON ACTION controlp INFIELD ooef001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " ooefstus = 'Y' "
            IF NOT cl_null(g_ooeb_m.ooeb004) THEN
                CASE g_ooeb_m.ooeb004
                   WHEN '1'  LET g_qryparam.where = g_qryparam.where, " AND ooef203 = 'Y' " 
                   WHEN '4'  LET g_qryparam.where = g_qryparam.where, " AND ooef205 = 'Y' " 
                   WHEN '5'  LET g_qryparam.where = g_qryparam.where, " AND ooef207 = 'Y' "
                   WHEN '6'  LET g_qryparam.where = g_qryparam.where, " AND ooef206 = 'Y' "
                   WHEN '7'  LET g_qryparam.where = g_qryparam.where, " AND ooef206 = 'Y' "
                   WHEN '8'  LET g_qryparam.where = g_qryparam.where, " AND ooef201 = 'Y' "
                   WHEN '9'  LET g_qryparam.where = g_qryparam.where, " AND ooef208 = 'Y' "
                   WHEN '10' LET g_qryparam.where = g_qryparam.where, " AND ooef210 = 'Y' "
                   WHEN '11' LET g_qryparam.where = g_qryparam.where, " AND ooef211 = 'Y' "
                   WHEN '12' LET g_qryparam.where = g_qryparam.where, " AND ooef212 = 'Y' "
                END CASE
            END IF
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooef001  #顯示到畫面上
            NEXT FIELD ooef001
            
        ON ACTION controlp INFIELD ooef017
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " ooefstus = 'Y' "
            CALL q_ooef017()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooef017  #顯示到畫面上
            NEXT FIELD ooef017
            
            
      END CONSTRUCT
      #end add-point

      BEFORE DIALOG
         #add-point:input段before dialog
         
         #end add-point
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            NEXT FIELD ooeb001
         END IF

      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)

      ON ACTION controlr
         CALL cl_show_req_fields()

      ON ACTION controls
         CALL cl_set_head_visible("","AUTO")

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel      #在dialog button (放棄)
         LET g_action_choice=""
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION close       #在dialog 右上角 (X)
         LET g_action_choice="exit"
         EXIT DIALOG

      ON ACTION exit        #toolbar 離開
         LET g_action_choice="exit"
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG

   END DIALOG

   #add-point:input段after input
   CALL aooi110_ooef_fill()
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_show" order="16" ver="8" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_show()
   {<Local define>}
   DEFINE l_ac_t    LIKE type_t.num5
   DEFINE l_sql     STRING
   {</Local define>}
   #add-point:show段define
   
   #end add-point

   #add-point:show段之前
   
   #end add-point



   LET g_ooeb_m_t.* = g_ooeb_m.*      #保存單頭舊值
   LET g_ooeb_m_o.* = g_ooeb_m.*

   CALL aooi110_ooef_fill()
   
   LET l_ac_t = l_ac

   #讀入ref值(單頭)
   #add-point:show段reference
   CALL aooi110_ooec005_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebmodid
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=?  ","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebmodid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebmodid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebownid
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=?  ","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebownid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebownid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebowndp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebowndp_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebowndp_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebcrtid
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebcrtid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebcrtid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebcrtdp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebcrtdp_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebcrtdp_desc
   #end add-point

   #將資料輸出到畫面上
   DISPLAY BY NAME g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt

   #顯示狀態(stus)圖片
         #此段落由子樣板a21產生
      CASE g_ooeb_m.ooebstus
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/void.png")

         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/valid.png")


      END CASE

   LET l_ac = l_ac_t

   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()

   #add-point:show段之後
   #CALL cl_set_act_visible("ins_aooi100,upd_aooi100,del_aooi100",TRUE)
   #IF g_ooeb_m.ooebstus <> "N" THEN
   #   CALL cl_set_act_visible("ins_aooi100,upd_aooi100,del_aooi100",FALSE)
   #END IF
   # 
   #IF g_rec_b2 > 0 THEN
   #   CALL cl_set_act_visible("upd_aooi100,del_aooi100", TRUE)
   #ELSE
   #   CALL cl_set_act_visible("upd_aooi100,del_aooi100", FALSE)
   #END IF
   
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_reproduce" order="17" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_reproduce()
   {<Local define>}
   DEFINE l_newno     LIKE ooeb_t.ooeb001
   DEFINE l_oldno     LIKE ooeb_t.ooeb001

   DEFINE l_master    RECORD LIKE ooeb_t.*
   DEFINE l_detail    RECORD LIKE ooec_t.*

   DEFINE l_cnt       LIKE type_t.num5
   {</Local define>}
   #add-point:reproduce段define
   
   #end add-point

   #切換畫面
   #該樣板不需此段落IF g_main_hidden THEN
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("mainlayout",0)
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("worksheet",1)
   #該樣板不需此段落   LET g_main_hidden = 0
   #該樣板不需此段落END IF

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   CALL aooi110_set_entry('a')
   CALL aooi110_set_no_entry('a')

   CALL cl_set_head_visible("","YES")



   INPUT l_newno   # FROM

    FROM ooeb001


      #add-point:複製段落開窗/欄位控管/自定義action
      
      #end add-point

      BEFORE INPUT
         #add-point:複製段落Before input
         
         #end add-point

      AFTER FIELD ooeb001
         IF l_newno IS NULL THEN
            NEXT FIELD CURRENT
         END IF
         #add-point:AFTER FIELD ooeb001
         
         #end add-point



      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG = 1 THEN
            LET INT_FLAG = 0
            RETURN
         END IF

         #確定該key值是否有重複定義
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM ooeb_t
          WHERE ooebent = g_enterprise AND ooeb001 = l_newno

         IF l_cnt > 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = "std-00006"
            LET g_errparam.extend = "Reproduce"
            LET g_errparam.popup = TRUE
            CALL cl_err()

            #NEXT FIELD ooeb001
         END IF

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE INPUT

   END INPUT

   IF INT_FLAG OR l_newno IS NULL THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   BEGIN WORK

   SELECT * INTO l_master.* FROM ooeb_t
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001

   LET l_master.ooeb001 = l_newno


   #公用欄位給予預設值(單頭)
   #此段落由子樣板a13產生
      LET l_master.ooebownid = g_user
      LET l_master.ooebowndp = g_dept
      LET l_master.ooebcrtid = g_user
      LET l_master.ooebcrtdp = g_dept
      LET l_master.ooebcrtdt = cl_get_current()
      LET l_master.ooebmodid = ''
      LET l_master.ooebmoddt = ''
      LET l_master.ooebstus = "Y"



   #公用欄位給予預設值(單身)


   #add-point:單頭複製前
   
   #end add-point

   INSERT INTO ooeb_t VALUES (l_master.*) #複製單頭
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "ooeb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      ROLLBACK WORK
      RETURN
   END IF

   #add-point:單頭複製後
   
   #end add-point



   LET g_sql = "SELECT * FROM ooec_t WHERE ooecent = '" ||g_enterprise|| "' AND ",
               " ooec008 = '",g_ooeb_m.ooeb001,"'"

   DECLARE aooi110_reproduce CURSOR FROM g_sql

   FOREACH aooi110_reproduce INTO l_detail.*
      LET l_detail.ooec008 = l_newno


      #add-point:單身複製前1
      
      #end add-point

      INSERT INTO ooec_t VALUES (l_detail.*) #複製單身
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'Insert error!'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF

      #add-point:單身複製後1
      
      #end add-point

   END FOREACH



   COMMIT WORK
   ERROR 'ROW(',l_newno,') O.K'

   CLOSE aooi110_reproduce

   LET g_state = "Y"

   LET g_wc = g_wc,
              " OR (",
              " ooeb001 = '", l_newno CLIPPED, "' "

              , ") "

   #add-point:完成複製段落後
   
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_delete" order="18" ver="6" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_delete()
   {<Local define>}
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:delete段define
   
   #end add-point

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   BEGIN WORK



   OPEN aooi110_cl USING g_enterprise,g_ooeb_m.ooeb001

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN aooi110_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE aooi110_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH aooi110_cl INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt              # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()
          #資料被他人LOCK
      ROLLBACK WORK
      RETURN
   END IF

   CALL aooi110_show()

   #IF NOT cl_ask_delete() THEN             #確認一下
   IF cl_ask_del_master() THEN              #確認一下
      INITIALIZE g_doc.* TO NULL
      LET g_doc.column1 = "ooeb001"
      LET g_doc.value1 = g_ooeb_m.ooeb001
#      CALL cl_del_doc()

      #add-point:單頭刪除前
      
      #end add-point

      #資料備份
      LET g_ooeb001_t = g_ooeb_m.ooeb001


      DELETE FROM ooeb_t
       WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001


      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF

      DELETE FROM ooed_t 
       WHERE ooedent = g_enterprise
         AND ooed001 = g_ooeb_m.ooeb004
         AND ooed002 = g_ooeb_m.ooeb005
         AND ooed003 = g_ooeb_m.ooeb006
         AND ooed008 = g_ooeb_m.ooeb001
         
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "del ooed_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF

      #add-point:單身刪除前
      
      #end add-point

      DELETE FROM ooec_t
       WHERE ooecent = g_enterprise AND ooec008 = g_ooeb_m.ooeb001


      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "ooec_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF





      #add-point:單身刪除後
      
      #end add-point

      CLEAR FORM

      CALL aooi110_ui_browser_refresh()
      #CALL aooi110_ui_headershow()
      #CALL aooi110_ui_detailshow()

      IF g_browser_cnt > 0 THEN
         CALL aooi110_fetch('P')
      ELSE
         LET g_wc = " 1=1"
         CALL aooi110_browser_fill("F")
      END IF

   END IF

   CLOSE aooi110_cl
   COMMIT WORK

   #流程通知預埋點-D
   CALL cl_flow_notify(g_ooeb_m.ooeb001,'D')

END FUNCTION]]>
  </point>
  <point name="function.aooi110_set_entry" order="19" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_set_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1
   {</Local define>}
   #add-point:set_entry段define
   
   #end add-point

   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("ooeb001",TRUE)
      #add-point:set_entry段欄位控制
      CALL cl_set_comp_entry("ooeb001",FALSE)
      #end add-point
   END IF
   CALL cl_set_comp_entry("ooeb007",TRUE)
   CALL cl_set_comp_entry("ooeb006",TRUE)
   CALL cl_set_comp_entry("ooeb008",TRUE)  
   LET g_flag = 'Y'   
END FUNCTION]]>
  </point>
  <point name="function.aooi110_set_no_entry" order="20" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_set_no_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1
   {</Local define>}
   #add-point:set_no_entry段define
   
   #end add-point

   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("ooeb001",FALSE)
      #add-point:set_no_entry段欄位控制
      
      #end add-point
   END IF
   IF g_ooeb_m.ooeb003 = '2' AND (g_ooeb_m.ooeb007 <= g_today AND (g_ooeb_m.ooeb008 > g_today OR g_ooeb_m.ooeb008 IS NULL))THEN
      LET g_flag = 'N'
      CALL cl_set_comp_entry("ooeb007",FALSE)
   END IF
   IF g_ooeb_m.ooeb003 = '3' THEN
      CALL cl_set_comp_entry("ooeb008",FALSE)
   END IF
   IF g_ooeb_m.ooeb003 = '1' THEN 
      CALL cl_set_comp_entry("ooeb006",FALSE)
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_tree_fill" order="21" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#樹顯示
PRIVATE FUNCTION aooi110_tree_fill()
DEFINE l_n        LIKE type_t.num5
DEFINE l_pid      LIKE type_t.chr50   #用於樹的第一層
DEFINE ls_msg     STRING
DEFINE l_n2       LIKE type_t.num5

   DELETE FROM ooed_tmp
   
   IF NOT cl_null(g_ooeb_m.ooeb008) THEN
      LET g_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                  #" SELECT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"',ooec008  ",
                  " SELECT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec007,'",g_ooeb_m.ooeb008,"',ooec008  ",
                  "   FROM ooec_t ",
                  "  WHERE ooecent = '",g_enterprise,"' ",
                  "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                  "    AND ooec003 = '",g_ooeb_m.ooeb006,"' ",
                  "    AND ooec008 = '",g_ooeb_m.ooeb001,"' "
   ELSE
      LET g_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                  #" SELECT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,'",g_ooeb_m.ooeb007,"','',ooec008  ",
                  " SELECT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec007,'',ooec008  ",
                  "   FROM ooec_t ",
                  "  WHERE ooecent = '",g_enterprise,"' ",
                  "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                  "    AND ooec003 = '",g_ooeb_m.ooeb006,"' ",
                  "    AND ooec008 = '",g_ooeb_m.ooeb001,"' "
   END IF
   PREPARE aooi110_ins_ooed_tmp_pre3 FROM g_sql
   EXECUTE aooi110_ins_ooed_tmp_pre3
   CALL g_tree.clear()
   LET g_cnt = 1
   LET l_n = 1
   LET g_sql = " SELECT UNIQUE ooed005,ooed003 FROM ooed_tmp ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
               "    AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
#               "    AND ooed006 <= '",g_today,"' ",
#               "    AND (ooed007 IS NULL OR ooed007 >= '",g_today,"') ",
               "    AND ooed005 = ooed002 ",
               "  ORDER BY ooed005 "          
   PREPARE tree_pre3 FROM g_sql
   DECLARE tree_cur3 CURSOR FOR tree_pre3
   FOREACH tree_cur3 INTO g_tree[g_cnt].b_ooed005,g_tree[g_cnt].b_ooed003
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      LET g_tree[g_cnt].b_ooed004 = g_tree[g_cnt].b_ooed005
      LET g_tree[g_cnt].b_ooed002 = g_tree[g_cnt].b_ooed005
      LET g_tree[g_cnt].b_pid = '0' CLIPPED
      LET g_tree[g_cnt].b_id = g_cnt USING "<<<"
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_tree[g_cnt].b_ooed004
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_tree[g_cnt].b_ooed004_desc = g_rtn_fields[1]
      LET ls_msg = cl_getmsg("aoo-00232",g_dlang)
      LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_ooed005,' (',g_tree[g_cnt].b_ooed004_desc,')','(',ls_msg,g_tree[g_cnt].b_ooed003,')'
      LET g_tree[g_cnt].b_exp = TRUE
      LET g_tree[g_cnt].b_hasC = TRUE
      LET g_tree[g_cnt].b_isExp = TRUE
      LET l_pid = g_tree[g_cnt].b_id CLIPPED
      LET l_n = g_cnt
      LET g_cnt = g_cnt + 1   
      LET g_sql = " SELECT UNIQUE ooed004 FROM ooed_tmp ",
                  "  WHERE ooedent = '" ||g_enterprise|| "' ",
                  "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                  "    AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
#                  "    AND ooed006 <= '",g_today,"' ",
#                  "    AND (ooed007 IS NULL OR ooed007 >= '",g_today,"') ",
                  "    AND ooed005 = '",g_tree[l_n].b_ooed005,"' ",
                  "    AND ooed004 <> ooed005 ",
                  "  ORDER BY ooed004 "           
      PREPARE tree_pre4 FROM g_sql
      DECLARE tree_cur4 CURSOR FOR tree_pre4
      FOREACH tree_cur4 INTO g_tree[g_cnt].b_ooed004
         LET g_tree[g_cnt].b_ooed002 = g_tree[l_n].b_ooed002
         LET g_tree[g_cnt].b_ooed005 = g_tree[l_n].b_ooed002
         LET g_tree[g_cnt].b_pid = l_pid
         LET g_tree[g_cnt].b_id = l_pid,".",g_cnt USING "<<<"
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_tree[g_cnt].b_ooed004
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_tree[g_cnt].b_ooed004_desc = g_rtn_fields[1]
         LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_ooed004,' (',g_tree[g_cnt].b_ooed004_desc,')'
         LET g_tree[g_cnt].b_exp = TRUE
         LET g_tree[g_cnt].b_hasC = aooi110_chk_hasC(g_cnt)
         IF g_tree[g_cnt].b_hasC = 1 THEN
            CALL aooi110_tree_expand(g_cnt)
            LET g_cnt = g_tree.getLength()
         END IF
         LET g_cnt = g_cnt +1
      END FOREACH
      LET l_n = g_tree.getLength() 
   END FOREACH
   CALL g_tree.deleteElement(l_n)
   FREE tree_pre3
   FREE tree_pre4
   FOR l_n2 = 1 TO g_tree.getLength()
      IF g_tree[l_n2].b_isExp is null THEN
         CALL aooi110_tree_expand(l_n2)
      END IF
   END FOR
END FUNCTION]]>
  </point>
  <point name="function.aooi110_default_search" order="22" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_default_search()
   {<Local define>}
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   {</Local define>}
   #add-point:default_search段define
   
   #end add-point

   #add-point:default_search段開始前
   
   #end add-point

   LET g_pagestart = 1

   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF

   IF NOT cl_null(g_argv[1]) THEN
      LET ls_wc = ls_wc, " ooeb001 = '", g_argv[1], "' AND "
   END IF



   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
   ELSE
      IF cl_null(g_wc) THEN
         LET g_wc = " 1=1"
      END IF
   END IF

   #add-point:default_search段結束前
   
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_statechange" order="23" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_statechange()
   {<Local define>}
   DEFINE lc_state LIKE type_t.chr5
   {</Local define>}
   #add-point:statechange段define

   #end add-point

   #add-point:statechange段開始前
   IF g_ooeb_m.ooebstus MATCHES '[XY]' THEN
      RETURN
   END IF
   #end add-point

   ERROR ""     #清空畫面右下側ERROR區塊

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU

         CALL cl_set_act_visible("unconfirmed,invalid,confirmed",TRUE)
         CASE g_ooeb_m.ooebstus
            WHEN "N"
               CALL cl_set_act_visible("unconfirmed",FALSE)

            WHEN "X"
               CALL cl_set_act_visible("unconfirmed,invalid,confirmed",FALSE)

            WHEN "Y"
               CALL cl_set_act_visible("unconfirmed,invalid,confirmed",FALSE)
         END CASE
         
         ON ACTION unconfirmed
            LET lc_state = "N"
            EXIT MENU
            
         ON ACTION invalid
            LET lc_state = "X"
            EXIT MENU
           
         ON ACTION confirmed
            LET lc_state = "Y"
            EXIT MENU 
            
   END MENU

   IF (lc_state <> "N"
      AND lc_state <> "X"

      AND lc_state <> "Y"


      ) OR
      cl_null(lc_state) THEN
      RETURN
   END IF

   #add-point:stus修改前
   
   IF lc_state = 'X' THEN
      DELETE FROM ooed_t 
       WHERE ooedent = g_enterprise
         AND ooed001 = g_ooeb_m.ooeb004
         AND ooed002 = g_ooeb_m.ooeb005
         AND ooed003 = g_ooeb_m.ooeb006
   END IF
   IF lc_state = 'Y' THEN
      IF NOT cl_ask_confirm('aim-00108') THEN
         RETURN
      END IF
      IF NOT aooi110_chk_conf() THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'aoo-00275'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN
      END IF
      CALL aooi110_confirm()
      CALL aooi110_del_ooed_tmp()
      RETURN
   END IF
   
   #end add-point

   UPDATE ooeb_t SET ooebstus = lc_state
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001


   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")

         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")


      END CASE
   END IF

   #add-point:stus修改後

   #end add-point

   #add-point:statechange段結束前
   
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.aooi110_idx_chk" order="24" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_idx_chk()
   #add-point:idx_chk段define
   
   #end add-point

   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_ooef_d.getLength() THEN
         LET g_detail_idx = g_ooef_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_ooef_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_ooef_d.getLength() TO FORMONLY.cnt
   END IF



END FUNCTION]]>
  </point>
  <point name="function.aooi110_del_ooed_tmp" order="25" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_del_ooed_tmp()
#   IF g_action_choice="insert"  THEN
#      DELETE FROM ooed_tmp where ooed009 = '2' AND ooed008 <> g_ooeb_m.ooeb001
#   ELSE
#      DELETE FROM ooed_tmp where ooed009 = '2'
#   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_auto_code" order="26" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 申請單號自動編碼
PRIVATE FUNCTION aooi110_auto_code()
DEFINE l_no           LIKE type_t.num10
   DEFINE ps_slip        STRING
  
   #组成流水号
   SELECT MAX(to_number(ooeb001)) +1 INTO l_no
     FROM ooeb_t
   #如果不存在编号则是第一次编号
   IF cl_null(l_no) THEN
      LET l_no = 1
   END IF
   LET ps_slip=l_no USING "&&&&&&"
   RETURN ps_slip
END FUNCTION]]>
  </point>
  <point name="function.aooi110_chk_date" order="27" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 生失效日期檢查
PRIVATE FUNCTION aooi110_chk_date()
LET g_errno = ''
   
   IF NOT cl_null(g_ooeb_m.ooeb007) AND NOT cl_null(g_ooeb_m.ooeb008) THEN
      IF g_ooeb_m.ooeb007 >= g_ooeb_m.ooeb008 THEN
         LET g_errno = 'aoo-00122'
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_confirm" order="28" ver="8" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[# 确认ACTION
PRIVATE FUNCTION aooi110_confirm()
   DEFINE l_sql          STRING
   DEFINE l_n            LIKE type_t.num5
   DEFINE l_ooed003      LIKE ooed_t.ooed003
   DEFINE l_ooed006      LIKE ooed_t.ooed006
   DEFINE l_ooed007      LIKE ooed_t.ooed007
   DEFINE l_ooed006_min  LIKE ooed_t.ooed006
   DEFINE l_ooed007_max  LIKE ooed_t.ooed007
   DEFINE l_auto         LIKE ooed_t.ooed003
   DEFINE l_no           LIKE type_t.num5
   DEFINE l_n1           LIKE type_t.num5
   DEFINE l_s            LIKE type_t.num5
   DEFINE l_sql1         STRING
   DEFINE l_ooed003_1    LIKE ooed_t.ooed003
   DEFINE l_ooed006_1    LIKE ooed_t.ooed006
   DEFINE l_ooed007_1    LIKE ooed_t.ooed007
   
   LET l_s = 0
   CALL s_transaction_begin()
   LET g_success = 'Y'
   IF g_ooeb_m.ooeb003 = '1' OR g_ooeb_m.ooeb003 = '2' THEN
      IF g_ooeb_m.ooeb003 = '2' THEN
         DELETE FROM ooed_t 
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "del_ooed"
            LET g_errparam.popup = TRUE
            CALL cl_err()

            LET g_success = 'N'
            RETURN
         END IF      
      END IF
      LET l_n = 0
      IF g_ooeb_m.ooeb003 = '2' THEN
         SELECT COUNT(*) INTO l_n FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
      ELSE
         SELECT COUNT(*) INTO l_n FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
      END IF
      IF l_n = 0 THEN
         IF NOT cl_null(g_ooeb_m.ooeb008) THEN
            LET l_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                        " SELECT DISTINCT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                        "   FROM ooec_t ",
                        "  WHERE ooecent = '",g_enterprise,"' ",
                        "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                        "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                        "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                        #" SELECT DISTINCT ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                        #"   FROM ooed_tmp ",
                        #"  WHERE ooedent = '",g_enterprise,"' ",
                        #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                        #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' "
         ELSE
            LET l_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                        " SELECT DISTINCT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                        "   FROM ooec_t ",
                        "  WHERE ooecent = '",g_enterprise,"' ",
                        "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                        "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                        "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                        #" SELECT DISTINCT ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                        #"   FROM ooed_tmp ",
                        #"  WHERE ooedent = '",g_enterprise,"' ",
                        #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                        #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' "
                        
         END IF
         PREPARE ins_ooed_pre FROM l_sql
         EXECUTE ins_ooed_pre
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "ins_ooed"
            LET g_errparam.popup = TRUE
            CALL cl_err()

            LET g_success = 'N'
            RETURN
         END IF
      ELSE
         SELECT MIN(ooed006) INTO l_ooed006_min
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
         
         SELECT MAX(ooed007) INTO l_ooed007_max
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            
         LET l_n1 = 0
         SELECT COUNT(*) INTO l_n1
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005        
            AND ooed007 IS NULL
         IF l_n1 > 0 THEN
            LET l_ooed007_max = ''
         END IF
         IF g_ooeb_m.ooeb008 <= l_ooed006_min AND NOT cl_null(g_ooeb_m.ooeb008) THEN #此资料是历史版本
            IF g_ooeb_m.ooeb008 = l_ooed006_min THEN
               UPDATE ooed_t SET ooed006 = g_ooeb_m.ooeb008 + 1 
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
                  AND ooed006 = g_ooeb_m.ooeb008
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  LET g_success = 'N'
                  RETURN
               END IF
            END IF
            SELECT MAX(to_number(ooed003)) +1 INTO l_no
              FROM ooed_t
             WHERE ooedent = g_enterprise
               AND ooed001 = g_ooeb_m.ooeb004
               AND ooed002 = g_ooeb_m.ooeb005
            #如果不存在编号则是第一次编号
            IF cl_null(l_no) THEN
               LET l_no = 1
            END IF
            LET l_auto = l_no
            LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                        " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                        "   FROM ooec_t ",
                        "  WHERE ooecent = '",g_enterprise,"' ",
                        "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                        "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                        "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                        #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                        #"   FROM ooed_tmp ",
                        #"  WHERE ooedent = '",g_enterprise,"' ",
                        #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                        #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                        #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
            PREPARE ins_ooed_conf_pre_4 FROM g_sql
            EXECUTE ins_ooed_conf_pre_4
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "ins_ooed"
            LET g_errparam.popup = TRUE
            CALL cl_err()

               CALL s_transaction_end('N','0')
               LET g_success = 'N'
               RETURN
            END IF
            UPDATE ooeb_t 
               SET ooebstus = 'Y'
             WHERE ooebent = g_enterprise 
               AND ooeb001 = g_ooeb_m.ooeb001
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "upd_ooebstus"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CALL s_transaction_end('N','0')
               LET g_success = 'N'
               RETURN
            END IF
            CALL s_transaction_end('Y','0')
            RETURN
         END IF
         IF g_ooeb_m.ooeb007 >= l_ooed007_max AND NOT cl_null(l_ooed007_max) THEN #此资料是未来的版本
            IF g_ooeb_m.ooeb007 = l_ooed007_max THEN
               UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 - 1 
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
                  AND ooed007 = g_ooeb_m.ooeb007
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  LET g_success = 'N'
                  RETURN
               END IF
            END IF
            SELECT MAX(to_number(ooed003)) +1 INTO l_no
              FROM ooed_t
             WHERE ooedent = g_enterprise
               AND ooed001 = g_ooeb_m.ooeb004
               AND ooed002 = g_ooeb_m.ooeb005
            #如果不存在编号则是第一次编号
            IF cl_null(l_no) THEN
               LET l_no = 1
            END IF
            LET l_auto =l_no
            IF g_ooeb_m.ooeb008 IS NULL THEN
               LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                           " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                           "   FROM ooec_t ",
                           "  WHERE ooecent = '",g_enterprise,"' ",
                           "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                           "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                           "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                          #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                          #"   FROM ooed_tmp ",
                          #"  WHERE ooedent = '",g_enterprise,"' ",
                          #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                          #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                          #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
            ELSE
               LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                           " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                           "   FROM ooec_t ",
                           "  WHERE ooecent = '",g_enterprise,"' ",
                           "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                           "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                           "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                          #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                          #"   FROM ooed_tmp ",
                          #"  WHERE ooedent = '",g_enterprise,"' ",
                          #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                          #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                          #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
            END IF
            PREPARE ins_ooed_conf_pre_5 FROM g_sql
            EXECUTE ins_ooed_conf_pre_5
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "ins_ooed"
            LET g_errparam.popup = TRUE
            CALL cl_err()

               CALL s_transaction_end('N','0')
               LET g_success = 'N'
               RETURN
            END IF
            UPDATE ooeb_t 
               SET ooebstus = 'Y'
             WHERE ooebent = g_enterprise 
               AND ooeb001 = g_ooeb_m.ooeb001
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "upd_ooebstus"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CALL s_transaction_end('N','0')
               LET g_success = 'N'
               RETURN
            END IF
            CALL s_transaction_end('Y','0')
            RETURN
         END IF
         LET g_sql =  " SELECT DISTINCT ooed003,ooed006,ooed007 FROM ooed_t ",
                      "  WHERE ooedent = '",g_enterprise,"' ",
                      "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                      "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                      "  ORDER BY ooed006,ooed007 "   
         PREPARE aooi110_status_pb FROM g_sql
         DECLARE aooi110_status_cs CURSOR FOR aooi110_status_pb 
         FOREACH aooi110_status_cs INTO l_ooed003,l_ooed006,l_ooed007
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "FOREACH"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CALL s_transaction_end('N','0')
               LET g_success = 'N'
               RETURN
            END IF
            IF g_ooeb_m.ooeb008 IS NOT NULL AND g_ooeb_m.ooeb007 <= l_ooed006 AND g_ooeb_m.ooeb008 >= l_ooed006 THEN
               SELECT MAX(to_number(ooed003)) +1 INTO l_no
                 FROM ooed_t
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
               #如果不存在编号则是第一次编号
               IF cl_null(l_no) THEN
                  LET l_no = 1
               END IF
               LET l_auto =l_no
               LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                           " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                           "   FROM ooec_t ",
                           "  WHERE ooecent = '",g_enterprise,"' ",
                           "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                           "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                           "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                          #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                          #"   FROM ooed_tmp ",
                          #"  WHERE ooedent = '",g_enterprise,"' ",
                          #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                          #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                          #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
               PREPARE ins_ooed_conf_pre_16 FROM g_sql
               EXECUTE ins_ooed_conf_pre_16
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "ins_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  LET g_success = 'N'
                  RETURN
               END IF
               UPDATE ooed_t SET ooed006 = g_ooeb_m.ooeb008 + 1 
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
                  AND ooed003 = l_ooed003
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  LET g_success = 'N'
                  RETURN
               END IF
               EXIT FOREACH
            END IF
            IF g_ooeb_m.ooeb008 IS NULL OR g_ooeb_m.ooeb008 >= l_ooed007_max THEN  #此资料在其他的版本内，但是最大版本（结束日期最大）
               IF g_ooeb_m.ooeb007 = l_ooed007 OR cl_null(l_ooed007) THEN
                  UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 - 1 
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                     AND ooed003 = l_ooed003
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF
                  SELECT MAX(to_number(ooed003)) +1 INTO l_no
                    FROM ooed_t
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                  #如果不存在编号则是第一次编号
                  IF cl_null(l_no) THEN
                     LET l_no = 1
                  END IF
                  LET l_auto =l_no
                  UPDATE ooeb_t SET ooebstus = 'X'
                   WHERE ooebent = g_enterprise
                     AND ooeb001 IN (SELECT ooed008 FROM ooed_t
                                      WHERE ooedent = g_enterprise
                                        AND ooed001 = g_ooeb_m.ooeb004
                                        AND ooed002 = g_ooeb_m.ooeb005
                                        AND ooed006 > g_ooeb_m.ooeb007)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "upd_ooeb"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF  
                  DELETE FROM ooed_t 
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                     AND ooed006 > g_ooeb_m.ooeb007
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "del_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF 
                  IF g_ooeb_m.ooeb008 IS NULL THEN
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  ELSE
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooed001,ooed002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  END IF
                  PREPARE ins_ooed_conf_pre_12 FROM g_sql
                  EXECUTE ins_ooed_conf_pre_12
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "ins_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF
                  EXIT FOREACH
               END IF
               IF g_ooeb_m.ooeb007 >= l_ooed006 AND g_ooeb_m.ooeb007 <= l_ooed007 THEN  #开始日期在此版本范围内
                  SELECT MAX(to_number(ooed003)) +1 INTO l_no
                    FROM ooed_t
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                  #如果不存在编号则是第一次编号
                  IF cl_null(l_no) THEN
                     LET l_no = 1
                  END IF
                  LET l_auto =l_no
                  UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 - 1 
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                     AND ooed003 = l_ooed003
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF
                  UPDATE ooeb_t SET ooebstus = 'X'
                   WHERE ooebent = g_enterprise
                     AND ooeb001 IN (SELECT ooed008 FROM ooed_t
                                      WHERE ooedent = g_enterprise
                                        AND ooed001 = g_ooeb_m.ooeb004
                                        AND ooed002 = g_ooeb_m.ooeb005
                                        AND ooed006 >= g_ooeb_m.ooeb007)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "upd_ooeb"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF  
                  DELETE FROM ooed_t 
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                     AND ooed006 >= g_ooeb_m.ooeb007
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "del_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF  
                  IF g_ooeb_m.ooeb008 IS NULL THEN
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  ELSE
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  END IF
                  PREPARE ins_ooed_conf_pre_1 FROM g_sql
                  EXECUTE ins_ooed_conf_pre_1
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "ins_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF
                  EXIT FOREACH
               END IF
               IF g_ooeb_m.ooeb007 <= l_ooed006 THEN #开始日期不在已有的版本范围内，在此版本之前，在前面的版本之后
                  SELECT MAX(to_number(ooed003)) +1 INTO l_no
                    FROM ooed_t
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                  #如果不存在编号则是第一次编号
                  IF cl_null(l_no) THEN
                     LET l_no = 1
                  END IF
                  LET l_auto =l_no
                  UPDATE ooeb_t SET ooebstus = 'X'
                   WHERE ooebent = g_enterprise
                     AND ooeb001 IN (SELECT ooed008 FROM ooed_t
                                      WHERE ooedent = g_enterprise
                                        AND ooed001 = g_ooeb_m.ooeb004
                                        AND ooed002 = g_ooeb_m.ooeb005
                                        AND ooed006 >= l_ooed006)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "upd_ooeb"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_success = 'N'
                     RETURN
                  END IF  
                  DELETE FROM ooed_t 
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                     AND ooed006 >= l_ooed006
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "del_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF  
                  IF g_ooeb_m.ooeb008 IS NULL THEN
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  ELSE
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  END IF
                  PREPARE ins_ooed_conf_pre_2 FROM g_sql
                  EXECUTE ins_ooed_conf_pre_2
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "ins_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF
                  EXIT FOREACH
               END IF
            END IF
            IF NOT cl_null(g_ooeb_m.ooeb008) AND g_ooeb_m.ooeb008 <= l_ooed007_max AND g_ooeb_m.ooeb007 >= l_ooed006_min THEN #此资料在其他的版本内，但不是最大版本
               IF l_ooed006 = g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008 = l_ooed007 THEN #开始日期结束日期重叠
                  SELECT MAX(to_number(ooed003)) +1 INTO l_no
                    FROM ooed_t
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                  #如果不存在编号则是第一次编号
                  IF cl_null(l_no) THEN
                     LET l_no = 1
                  END IF
                  LET l_auto =l_no
                  UPDATE ooeb_t SET ooebstus = 'X'
                   WHERE ooebent = g_enterprise
                     AND ooeb001 IN (SELECT ooed008 FROM ooed_t
                                      WHERE ooedent = g_enterprise
                                        AND ooed001 = g_ooeb_m.ooeb004
                                        AND ooed002 = g_ooeb_m.ooeb005
                                        AND ooed003 = l_ooed003)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "upd_ooeb"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF                        
                  DELETE FROM ooed_t 
                   WHERE ooedent = g_enterprise
                     AND ooed001 = g_ooeb_m.ooeb004
                     AND ooed002 = g_ooeb_m.ooeb005
                     AND ooed003 = l_ooed003
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "del_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF  
                  IF g_ooeb_m.ooeb008 IS NULL THEN
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  ELSE
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                 "   FROM ooec_t ",
                                 "  WHERE ooecent = '",g_enterprise,"' ",
                                 "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                 "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                 "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                #"   FROM ooed_tmp ",
                                #"  WHERE ooedent = '",g_enterprise,"' ",
                                #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                  END IF
                  PREPARE ins_ooed_conf_pre_7 FROM g_sql
                  EXECUTE ins_ooed_conf_pre_7
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "ins_ooed"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_success = 'N'
                     RETURN
                  END IF
                  EXIT FOREACH
               END IF
               IF g_ooeb_m.ooeb007 > l_ooed006 THEN #此资料开始日期在一个版本日期内
                  IF (g_ooeb_m.ooeb008 <= l_ooed007 AND l_ooed007 IS NOT NULL) OR (l_ooed007 IS NULL ) THEN
                     SELECT MAX(to_number(ooed003)) +1 INTO l_no
                       FROM ooed_t
                      WHERE ooedent = g_enterprise
                        AND ooed001 = g_ooeb_m.ooeb004
                        AND ooed002 = g_ooeb_m.ooeb005
                     #如果不存在编号则是第一次编号
                     IF cl_null(l_no) THEN
                        LET l_no = 1
                     END IF
                     LET l_auto =l_no
                     UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 -1
                      WHERE ooedent = g_enterprise
                        AND ooed001 = g_ooeb_m.ooeb004
                        AND ooed002 = g_ooeb_m.ooeb005
                        AND ooed003 = l_ooed003
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "upd_ooed"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        CALL s_transaction_end('N','0')
                        LET g_success = 'N'
                        RETURN
                     END IF     
                     IF g_ooeb_m.ooeb008 IS NULL THEN
                     LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                 " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                    "   FROM ooec_t ",
                                    "  WHERE ooecent = '",g_enterprise,"' ",
                                    "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                    "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                    "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                #   "   FROM ooed_tmp ",
                                #   "  WHERE ooedent = '",g_enterprise,"' ",
                                #   "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                #   "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                #   "    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                     ELSE
                        LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                     " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                    "   FROM ooec_t ",
                                    "  WHERE ooecent = '",g_enterprise,"' ",
                                    "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                    "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                    "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                   #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                   #"   FROM ooed_tmp ",
                                   #"  WHERE ooedent = '",g_enterprise,"' ",
                                   #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                   #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                   #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                     END IF
                     PREPARE ins_ooed_conf_pre_8 FROM g_sql
                     EXECUTE ins_ooed_conf_pre_8
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "ins_ooed"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        CALL s_transaction_end('N','0')
                        LET g_success = 'N'
                        RETURN
                     END IF
                     SELECT MAX(to_number(ooed003)) +1 INTO l_no
                       FROM ooed_t
                      WHERE ooedent = g_enterprise
                        AND ooed001 = g_ooeb_m.ooeb004
                        AND ooed002 = g_ooeb_m.ooeb005
                     #如果不存在编号则是第一次编号
                     IF cl_null(l_no) THEN
                        LET l_no = 1
                     END IF
                     LET l_auto =l_no
                     IF g_ooeb_m.ooeb008 <= l_ooed007 AND l_ooed007 IS NOT NULL THEN
                        LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                    " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb008+1,"','",l_ooed007,"','",g_ooeb_m.ooeb001,"' ",
                                    "   FROM ooec_t ",
                                    "  WHERE ooecent = '",g_enterprise,"' ",
                                    "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                    "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                    "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                   #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb008+1,"','",l_ooed007,"','",g_ooeb_m.ooeb001,"' ",
                                   #"   FROM ooed_tmp ",
                                   #"  WHERE ooedent = '",g_enterprise,"' ",
                                   #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                   #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                   #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                        PREPARE ins_ooed_conf_pre_9 FROM g_sql
                        EXECUTE ins_ooed_conf_pre_9
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ins_ooed"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                           LET g_success = 'N'
                           RETURN
                        END IF
                     END IF
                     IF l_ooed007 IS NULL THEN
                        LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                    " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb008+1,"','','",g_ooeb_m.ooeb001,"' ",
                                    "   FROM ooec_t ",
                                    "  WHERE ooecent = '",g_enterprise,"' ",
                                    "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                    "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                    "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                   #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb008+1,"','','",g_ooeb_m.ooeb001,"' ",
                                   #"   FROM ooed_tmp ",
                                   #"  WHERE ooedent = '",g_enterprise,"' ",
                                   #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                   #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                   #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                        PREPARE ins_ooed_conf_pre_10 FROM g_sql
                        EXECUTE ins_ooed_conf_pre_10
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "ins_ooed"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                           LET g_success = 'N'
                           RETURN
                        END IF
                     END IF
                     EXIT FOREACH
                  END IF
                  IF g_ooeb_m.ooeb008 >= l_ooed007 AND l_ooed007 IS NOT NULL THEN
                     SELECT MAX(to_number(ooed003)) +1 INTO l_no
                       FROM ooed_t
                      WHERE ooedent = g_enterprise
                        AND ooed001 = g_ooeb_m.ooeb004
                        AND ooed002 = g_ooeb_m.ooeb005
                     #如果不存在编号则是第一次编号
                     IF cl_null(l_no) THEN
                        LET l_no = 1
                     END IF
                     LET l_auto =l_no
                     UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 -1
                      WHERE ooedent = g_enterprise
                        AND ooed001 = g_ooeb_m.ooeb004
                        AND ooed002 = g_ooeb_m.ooeb005
                        AND ooed003 = l_ooed003
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "upd_ooed"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        CALL s_transaction_end('N','0')
                        LET g_success = 'N'
                        RETURN
                     END IF     
                     IF g_ooeb_m.ooeb008 IS NULL THEN
                        LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                    " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                    "   FROM ooec_t ",
                                    "  WHERE ooecent = '",g_enterprise,"' ",
                                    "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                    "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                    "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                   #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"' ",
                                   #"   FROM ooed_tmp ",
                                   #"  WHERE ooedent = '",g_enterprise,"' ",
                                   #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                   #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                   #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                     ELSE
                        LET g_sql = " INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                                    " SELECT DISTINCT ooecent,ooec001,ooec002,'",l_auto,"',ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                    "   FROM ooec_t ",
                                    "  WHERE ooecent = '",g_enterprise,"' ",
                                    "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                                    "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                                    "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
                                   #" SELECT DISTINCT ooedent,ooed001,ooed002,'",l_auto,"',ooed004,ooed005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"' ",
                                   #"   FROM ooed_tmp ",
                                   #"  WHERE ooedent = '",g_enterprise,"' ",
                                   #"    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                   #"    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                   #"    AND ooed003 = '",g_ooeb_m.ooeb006,"' "
                     END IF
                     PREPARE ins_ooed_conf_pre_11 FROM g_sql
                     EXECUTE ins_ooed_conf_pre_11
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "ins_ooed"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        CALL s_transaction_end('N','0')
                        LET g_success = 'N'
                        RETURN
                     END IF
                     LET l_sql1 = " SELECT DISTINCT ooed003,ooed006,ooed007 FROM ooed_t ",
                                  "  WHERE ooedent = '",g_enterprise,"' ",
                                  "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                                  "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                                  "    AND ooed006 > '",l_ooed006,"'",
                                  "  ORDER BY ooed006,ooed007 "
                     PREPARE aooi110_status_pb1 FROM l_sql1
                     DECLARE aooi110_status_cs1 CURSOR FOR aooi110_status_pb1
                     FOREACH aooi110_status_cs1 INTO l_ooed003_1,l_ooed006_1,l_ooed007_1
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "FOREACH"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                           LET g_success = 'N'
                           RETURN
                        END IF  
                        IF g_ooeb_m.ooeb007 <= l_ooed006_1 AND g_ooeb_m.ooeb008 >= l_ooed006_1 AND ((g_ooeb_m.ooeb008 <= l_ooed007_1 AND l_ooed007_1 IS NOT NULL) OR l_ooed007_1 IS NULL) THEN
                           UPDATE ooed_t SET ooed006 = g_ooeb_m.ooeb008 + 1
                            WHERE ooedent = g_enterprise
                              AND ooed001 = g_ooeb_m.ooeb004
                              AND ooed002 = g_ooeb_m.ooeb005
                              AND ooed003 = l_ooed003_1
                           IF SQLCA.sqlcode THEN
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.code = SQLCA.sqlcode
                              LET g_errparam.extend = "upd_ooed"
                              LET g_errparam.popup = TRUE
                              CALL cl_err()

                              CALL s_transaction_end('N','0')
                              LET g_success = 'N'
                              RETURN
                           END IF                  
                           EXIT FOREACH 
                        END IF             
                     END FOREACH                        
                     EXIT FOREACH
                 END IF    
               END IF
            END IF 
         END FOREACH
      END IF
      IF g_ooeb_m.ooeb003 = '2' THEN
         UPDATE ooed_t SET ooed003 = g_ooeb_m.ooeb006
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed006 = g_ooeb_m.ooeb007
            AND ooed007 = g_ooeb_m.ooeb008
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "upd_ooed"
            LET g_errparam.popup = TRUE
            CALL cl_err()

            CALL s_transaction_end('N','0')
            LET g_success = 'N'
            RETURN
         END IF    
      END IF 
   END IF
   IF g_ooeb_m.ooeb003 = '3' THEN
      DELETE FROM ooed_t 
       WHERE ooedent = g_enterprise
         AND ooed001 = g_ooeb_m.ooeb004
         AND ooed002 = g_ooeb_m.ooeb005
         AND ooed003 = g_ooeb_m.ooeb006
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "del_ooebstus"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         CALL s_transaction_end('N','0')
         LET g_success = 'N'
         RETURN
      END IF
   END IF
   UPDATE ooeb_t 
      SET ooebstus = 'Y'
    WHERE ooebent = g_enterprise 
      AND ooeb001 = g_ooeb_m.ooeb001
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "upd_ooebstus"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CALL s_transaction_end('N','0')
      LET g_success = 'N'
      RETURN
   END IF
   
   LET g_ooeb_m.ooebstus = 'Y' 
   
   #如果生效日期是當下（例如，當前日期是2014/08/01,生效日期也剛好是2014/08/01，則產生ooej檔，如果生效日期大於當下，則暫不產生）
   IF g_ooeb_m.ooeb007 <= g_today AND g_ooeb_m.ooeb008 >= g_today THEN
      #產生當前組織架構檔
      IF NOT aooi110_produce() THEN
         CALL s_transaction_end('N','0')
         LET g_success = 'N'
         RETURN
      END IF
   END IF
   
   IF g_success = 'Y' THEN
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_chk_ooeb005" order="29" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 最上層組織編號檢查
PRIVATE FUNCTION aooi110_chk_ooeb005()
DEFINE l_n         LIKE type_t.num10
DEFINE r_success   LIKE type_t.num5

   LET r_success = TRUE
   LET g_errno = ''
   IF NOT cl_null(g_ooeb_m.ooeb005) THEN
      #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
      INITIALIZE g_chkparam.* TO NULL

      #設定g_chkparam.*的參數
      LET g_chkparam.arg1 = g_ooeb_m.ooeb005
      CASE g_ooeb_m.ooeb004
         WHEN '1'  LET g_chkparam.where = " ooef203 = 'Y' "
         WHEN '4'  LET g_chkparam.where = " ooef205 = 'Y' " 
         WHEN '5'  LET g_chkparam.where = " ooef207 = 'Y' "
         WHEN '6'  LET g_chkparam.where = " ooef206 = 'Y' "
         WHEN '7'  LET g_chkparam.where = " ooef206 = 'Y' "
         WHEN '8'  LET g_chkparam.where = " ooef201 = 'Y' "
         WHEN '9'  LET g_chkparam.where = " ooef208 = 'Y' "
         WHEN '10' LET g_chkparam.where = " ooef210 = 'Y' "
         WHEN '11' LET g_chkparam.where = " ooef211 = 'Y' "
         WHEN '12' LET g_chkparam.where = " ooef212 = 'Y' "
      END CASE

      #呼叫檢查存在並帶值的library
      IF NOT cl_chk_exist("v_ooef001") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   IF NOT cl_null(g_ooeb_m.ooeb004) AND NOT cl_null(g_ooeb_m.ooeb005) AND NOT cl_null(g_ooeb_m.ooeb006)  
      AND (g_ooeb_m.ooeb004 <> g_ooeb_m_t.ooeb004 OR g_ooeb_m.ooeb005 <> g_ooeb_m_t.ooeb005 OR g_ooeb_m.ooeb006 <> g_ooeb_m_t.ooeb006) THEN
      LET l_n = 0
      SELECT COUNT(*) INTO l_n
        FROM ooeb_t
       WHERE ooebent = g_enterprise
         AND ooeb004 = g_ooeb_m.ooeb004
         AND ooeb005 = g_ooeb_m.ooeb005
         AND ooeb006 = g_ooeb_m.ooeb006
         AND ooebstus = 'Y'
      IF l_n > 0 THEN           
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'aoo-00121'
         LET g_errparam.extend = g_ooeb_m.ooeb005
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success   
      END IF
   END IF
   RETURN r_success  
   
END FUNCTION]]>
  </point>
  <point name="function.aooi110_ins_tmp" order="30" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 單身資料準備按鈕
PRIVATE FUNCTION aooi110_ins_tmp()
DEFINE l_sql     STRING
   
  
   IF cl_null(g_wcb) THEN
      RETURN
   END IF
   
   IF cl_null(g_ooeb_m.ooeb008) THEN
      #LET l_sql = " MERGE INTO ooed_tmp ",
      #            " USING (SELECT ooef001 ",
      #            "          FROM ooef_t ",
      #            "         WHERE ",g_wcb CLIPPED ,")",
      #            "    ON (ooef001 = ooed004 OR ooef001 = ooed005 OR ooef001 = ooed002 )",
      #            "  WHEN NOT MATCHED THEN ",
      #            " INSERT (ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
      #            " VALUES ('",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
      #            "        ooef001,'",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"') "
      
      #LET l_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
      #            " VALUES ('",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
      #            "        '",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"') "
      
   ELSE
      #LET l_sql = " MERGE INTO ooed_tmp ",
      #            " USING (SELECT ooef001 ",
      #            "          FROM ooef_t ",
      #            "         WHERE ",g_wcb CLIPPED ,")",
      #            "    ON (ooef001 = ooed004 OR ooef001 = ooed005 OR ooef001 = ooed002 )",
      #            "  WHEN NOT MATCHED THEN ",
      #            " INSERT (ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
      #            " VALUES ('",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
      #            "        ooef001,'",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"') "
      
      #LET l_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
      #            " VALUES ('",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
      #            "        '",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"') "
      #
       
   END IF
   PREPARE ins_ooed_tmp_pre FROM l_sql
   EXECUTE ins_ooed_tmp_pre
   
   
END FUNCTION]]>
  </point>
  <point name="function.aooi110_def_ooeb006" order="31" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 新增自動帶出版本號
PRIVATE FUNCTION aooi110_def_ooeb006()
DEFINE l_n            LIKE type_t.num10

   IF g_ooeb_m.ooeb003 = '1' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND NOT cl_null(g_ooeb_m.ooeb005) 
         AND (g_ooeb_m.ooeb004 <> g_ooeb_m_t.ooeb004 OR g_ooeb_m.ooeb005 <> g_ooeb_m_t.ooeb005 OR cl_null(g_ooeb_m_t.ooeb004) OR cl_null(g_ooeb_m_t.ooeb004) ) THEN  
         LET l_n = 0
         SELECT MAX(to_number(ooeb006)) + 1 INTO l_n
           FROM ooeb_t
          WHERE ooebent = g_enterprise
            AND ooeb004 = g_ooeb_m.ooeb004
            AND ooeb005 = g_ooeb_m.ooeb005
        IF cl_null(l_n) OR l_n = 0 THEN
           LET l_n = 1
        END IF
        LET g_ooeb_m.ooeb006 = l_n
        DISPLAY BY NAME g_ooeb_m.ooeb006    
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_ooec005_desc" order="32" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 單頭最上層組織名稱顯示
PRIVATE FUNCTION aooi110_ooec005_desc()
  SELECT ooefl003 INTO g_ooeb_m.ooeb005_desc
    FROM ooefl_t
   WHERE ooefl001 = g_ooeb_m.ooeb005
     AND ooefl002 = g_dlang
     AND ooeflent = g_enterprise
   DISPLAY BY NAME g_ooeb_m.ooeb005_desc
END FUNCTION]]>
  </point>
  <point name="function.aooi110_tree_tmp_fill" order="33" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# 临时表填充树资料
PRIVATE FUNCTION aooi110_tree_tmp_fill()
DEFINE l_n        LIKE type_t.num5
DEFINE l_pid      LIKE type_t.chr50   #用於樹的第一層
DEFINE ls_msg     STRING
DEFINE l_n2       LIKE type_t.num5
   
   IF NOT cl_null(g_ooeb_m.ooeb008) THEN
      LET g_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                  " SELECT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,'",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"',ooec008  ",
                  "   FROM ooec_t ",
                  "  WHERE ooecent = '",g_enterprise,"' ",
                  "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                  "    AND ooec003 = '",g_ooeb_m.ooeb006,"' "
   ELSE
      LET g_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008) ",
                  " SELECT ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,'",g_ooeb_m.ooeb007,"','',ooec008  ",
                  "   FROM ooec_t ",
                  "  WHERE ooecent = '",g_enterprise,"' ",
                  "    AND ooec001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooec002 = '",g_ooeb_m.ooeb005,"' ",
                  "    AND ooec003 = '",g_ooeb_m.ooeb006,"' ",
                  "    AND ooec008 = '",g_ooeb_m.ooeb001,"' "
   END IF
   PREPARE aooi110_ins_ooed_tmp_pre4 FROM g_sql
   EXECUTE aooi110_ins_ooed_tmp_pre4
   CALL g_tree.clear()
   LET g_cnt = 1
   LET l_n = 1
   LET g_sql = " SELECT UNIQUE ooed005,ooed003 FROM ooed_tmp ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
               "    AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
               "    AND ooed005 = ooed002 ",
               "  ORDER BY ooed005 "
   PREPARE tree_pre FROM g_sql
   DECLARE tree_cur CURSOR FOR tree_pre
   FOREACH tree_cur INTO g_tree[g_cnt].b_ooed005,g_tree[g_cnt].b_ooed003
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      LET g_tree[g_cnt].b_ooed004 = g_tree[g_cnt].b_ooed005
      LET g_tree[g_cnt].b_ooed002 = g_tree[g_cnt].b_ooed005
      LET g_tree[g_cnt].b_pid = '0' CLIPPED
      LET g_tree[g_cnt].b_id = g_cnt USING "<<<"
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_tree[g_cnt].b_ooed004
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_tree[g_cnt].b_ooed004_desc = g_rtn_fields[1]
       LET ls_msg = cl_getmsg("aoo-00232",g_dlang)
      LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_ooed005,' (',g_tree[g_cnt].b_ooed004_desc,')','(',ls_msg,g_tree[g_cnt].b_ooed003,')'
      LET g_tree[g_cnt].b_exp = TRUE
      LET g_tree[g_cnt].b_hasC = TRUE
      LET g_tree[g_cnt].b_isExp = TRUE
      LET l_pid = g_tree[g_cnt].b_id CLIPPED
      LET l_n = g_cnt
      LET g_cnt = g_cnt + 1
      LET g_sql = " SELECT UNIQUE ooed004 FROM ooed_tmp ",
                  "  WHERE ooedent = '" ||g_enterprise|| "' ",
                  "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                  "    AND ooed003 = '",g_ooeb_m.ooeb006,"' ",
                  "    AND ooed005 = '",g_tree[l_n].b_ooed005,"' ",
                  "    AND ooed004 <> ooed005 ",
                  "  ORDER BY ooed004 "
      PREPARE tree_pre1 FROM g_sql
      DECLARE tree_cur1 CURSOR FOR tree_pre1
      FOREACH tree_cur1 INTO g_tree[g_cnt].b_ooed004
         LET g_tree[g_cnt].b_ooed002 = g_tree[l_n].b_ooed002
         LET g_tree[g_cnt].b_ooed005 = g_tree[l_n].b_ooed004
         LET g_tree[g_cnt].b_pid = l_pid
         LET g_tree[g_cnt].b_id = l_pid,".",g_cnt USING "<<<"
         LET g_ref_fields[1] = g_tree[g_cnt].b_ooed004
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_tree[g_cnt].b_ooed004_desc = g_rtn_fields[1]
         LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_ooed004,' (',g_tree[g_cnt].b_ooed004_desc,')'
         LET g_tree[g_cnt].b_exp = TRUE
         LET g_tree[g_cnt].b_hasC = aooi110_chk_hasC(g_cnt)
         IF g_tree[g_cnt].b_hasC = 1 THEN
            CALL aooi110_tree_expand(g_cnt)
            LET g_cnt = g_tree.getLength()
         END IF
         LET g_cnt = g_cnt +1
      END FOREACH
      LET l_n = g_tree.getLength() 
   END FOREACH
   CALL g_tree.deleteElement(l_n)
   FREE tree_pre1
   FREE tree_pre
   FOR l_n2 = 1 TO g_tree.getLength()
      IF g_tree[l_n2].b_isExp is null THEN
         CALL aooi110_tree_expand(l_n2)
      END IF
   END FOR
END FUNCTION]]>
  </point>
  <point name="function.aooi110_out_tree" order="34" ver="8" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[#輸入版本之後帶出樹+生失效日期
PRIVATE FUNCTION aooi110_out_tree()
   IF g_ooeb_m.ooeb003 = '2' OR g_ooeb_m.ooeb003 = '3' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND  NOT cl_null(g_ooeb_m.ooeb005) AND NOT cl_null(g_ooeb_m.ooeb006) THEN
         SELECT DISTINCT ooed006,ooed007 INTO g_ooeb_m.ooeb007,g_ooeb_m.ooeb008
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
         IF cl_null(g_ooeb_m.ooeb008) THEN
            LET g_ooeb_m.ooeb008 = ""
         END IF
         LET g_sql = " INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008) ",
                     " SELECT ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,'",g_ooeb_m.ooeb001,"' ",
                     "   FROM ooed_t ",
                     "  WHERE ooedent = '",g_enterprise,"' ",
                     "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                     "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                     "    AND ooed003 = '",g_ooeb_m.ooeb006,"'"
         PREPARE aooi110_ins_ooed_tmp_pre6 FROM g_sql
         EXECUTE aooi110_ins_ooed_tmp_pre6
         CALL aooi110_tree_fill()
         DISPLAY ARRAY g_tree TO s_tree.*
             BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY
      END IF
      CALL aooi110_set_entry('a')
      CALL aooi110_set_no_entry('a')      
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_chk_ooeb006" order="35" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#更改狀態版本檢查
PRIVATE FUNCTION aooi110_chk_ooeb006()
DEFINE l_n       LIKE type_t.num5

   LET l_n = 0
   LET g_errno = ''
   IF g_ooeb_m.ooeb003 = '2' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND  NOT cl_null(g_ooeb_m.ooeb005) AND NOT cl_null(g_ooeb_m.ooeb006)THEN
         SELECT COUNT(*) INTO l_n
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
         IF l_n = 0 THEN
            LET g_errno = 'aoo-00093'
            RETURN
         END IF
         LET l_n = 0
         SELECT COUNT(*) INTO l_n
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
            AND ooed007 < g_today
         IF l_n > 0 THEN
            LET g_errno = 'aoo-00276'
            RETURN
         END IF
      END IF
   END IF
   IF g_ooeb_m.ooeb003 = '3' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND  NOT cl_null(g_ooeb_m.ooeb005) AND NOT cl_null(g_ooeb_m.ooeb006)THEN
         SELECT COUNT(*) INTO l_n
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
         IF l_n = 0 THEN
            LET g_errno = 'aoo-00093'
            RETURN
         END IF
         LET l_n = 0
         SELECT COUNT(*) INTO l_n
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
            AND ooed003 = g_ooeb_m.ooeb006
            AND ooed006 > g_today
         IF l_n = 0 THEN
            LET g_errno = 'aoo-00276'
            RETURN
         END IF
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_tree_tmp_fill1" order="36" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#刷新樹
PRIVATE FUNCTION aooi110_tree_tmp_fill1()
DEFINE l_n        LIKE type_t.num5
DEFINE l_ooed003  LIKE ooed_t.ooed003

   LET l_n = 0
   LET l_ooed003 = 0
   DELETE FROM ooed_tmp
   IF g_ooeb_m.ooeb003 = '1' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND NOT cl_null(g_ooeb_m.ooeb005) THEN
         SELECT MAX(ooed003) INTO l_ooed003
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
         IF l_ooed003 > 0 THEN
            LET g_sql = " INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008) ",
                        " SELECT ooedent,ooed001,ooed002,'",g_ooeb_m.ooeb006,"',ooed004,ooed005,ooed006,ooed007,'",g_ooeb_m.ooeb001,"'  ",
                        "   FROM ooed_t ",
                        "  WHERE ooedent = '",g_enterprise,"' ",
                        "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                        "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                        "    AND ooed003 = '",l_ooed003,"'"
            PREPARE aooi110_ins_ooed_tmp_pre5 FROM g_sql
            EXECUTE aooi110_ins_ooed_tmp_pre5
         ELSE
            IF NOT cl_null(g_ooeb_m.ooeb008) THEN
               INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008)
                             VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005,g_ooeb_m.ooeb005,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
            ELSE
                INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008)
                             VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005,g_ooeb_m.ooeb005,g_ooeb_m.ooeb007,'',g_ooeb_m.ooeb001)  
            END IF
         END IF
         CALL aooi110_tree_tmp_fill()
         DISPLAY ARRAY g_tree TO s_tree.*
             BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aooi110_chk_conf" order="37" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 检查结存档是否已经存在资料
# Memo...........:
# Usage..........: CALL aooi110_chk_conf()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success 狀態
# Date & Author..: 2014/1/7 By xumm
# Modify.........:
################################################################################
PRIVATE FUNCTION aooi110_chk_conf()
DEFINE r_success      LIKE type_t.num5
DEFINE l_n            LIKE type_t.num5
DEFINE l_n2            LIKE type_t.num5

   LET r_success = TRUE
   IF g_ooeb_m.ooeb003 = '1' THEN
      IF cl_null(g_ooeb_m.ooeb008) THEN
         FOR l_n2 = 1 TO g_tree.getLength()
             LET l_n = 0
             SELECT COUNT(*) INTO l_n
               FROM ooed_t
              WHERE ooedent = g_enterprise
                AND ooed001 = g_ooeb_m.ooeb004
                AND ooed002 <> g_ooeb_m.ooeb005
                AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb007)
                AND ooed004 = g_tree[l_n2].b_id
             IF l_n > 0 THEN
                LET r_success = FALSE
                EXIT FOR
             END IF
         END FOR
#         SELECT COUNT(*) INTO l_n
#           FROM ooed_tmp
#          WHERE ooedent = g_enterprise
#            AND ooed001 = g_ooeb_m.ooeb004
#            AND ooed002 = g_ooeb_m.ooeb005
#            AND ooed004 IN (SELECT ooed004 
#                              FROM ooed_t
#                             WHERE ooedent = g_enterprise
#                               AND ooed001 = g_ooeb_m.ooeb004
#                               AND ooed002 <> g_ooeb_m.ooeb005
#                               AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb007)
#                             )             
      ELSE
         FOR l_n2 = 1 TO g_tree.getLength()
             LET l_n = 0
             SELECT COUNT(*) INTO l_n
               FROM ooed_t
              WHERE ooedent = g_enterprise
                AND ooed001 = g_ooeb_m.ooeb004
                AND ooed002 <> g_ooeb_m.ooeb005
                AND (ooed006 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
                     OR ooed007 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
                     OR (ooed006 <= g_ooeb_m.ooeb007 AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb008)))
                AND ooed004 = g_tree[l_n2].b_id
             IF l_n > 0 THEN
                LET r_success = FALSE
                EXIT FOR
             END IF
         END FOR
#         SELECT COUNT(*) INTO l_n
#           FROM ooed_tmp
#          WHERE ooedent = g_enterprise
#            AND ooed001 = g_ooeb_m.ooeb004
#            AND ooed002 = g_ooeb_m.ooeb005
#            AND ooed004 IN (SELECT ooed004 
#                              FROM ooed_t
#                             WHERE ooedent = g_enterprise
#                               AND ooed001 = g_ooeb_m.ooeb004
#                               AND ooed002 <> g_ooeb_m.ooeb005
#                               AND (ooed006 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
#                                    OR ooed007 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
#                                    OR (ooed006 <= g_ooeb_m.ooeb007 AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb008)))
#                             )
#           AND ooed008 = g_ooeb_m.ooeb001  
      END IF
      IF l_n > 0 THEN
         LET r_success = FALSE
      END IF
   END IF
   IF g_ooeb_m.ooeb003 = '2' THEN
      IF cl_null(g_ooeb_m.ooeb008) THEN
         FOR l_n2 = 1 TO g_tree.getLength()
             LET l_n = 0
             SELECT COUNT(*) INTO l_n
               FROM ooed_t
              WHERE ooedent = g_enterprise
                AND ooed001 = g_ooeb_m.ooeb004
                AND ooed002 <> g_ooeb_m.ooeb005
                AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb007)
                AND ooed004 = g_tree[l_n2].b_id
             IF l_n > 0 THEN
                LET r_success = FALSE
                EXIT FOR
             END IF
         END FOR                    
      ELSE
         FOR l_n2 = 1 TO g_tree.getLength()
             LET l_n = 0
             SELECT COUNT(*) INTO l_n
               FROM ooed_t
              WHERE ooedent = g_enterprise
                AND ooed001 = g_ooeb_m.ooeb004
                AND ooed002 <> g_ooeb_m.ooeb005
                AND (ooed006 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
                     OR ooed007 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
                     OR (ooed006 <= g_ooeb_m.ooeb007 AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb008)))
                AND ooed004 = g_tree[l_n2].b_id
             IF l_n > 0 THEN
                LET r_success = FALSE
                EXIT FOR
             END IF
         END FOR
#         SELECT COUNT(*) INTO l_n
#           FROM ooed_tmp
#          WHERE ooedent = g_enterprise
#            AND ooed001 = g_ooeb_m.ooeb004
#            AND ooed002 = g_ooeb_m.ooeb005
#            AND ooed004 IN (SELECT ooed004 
#                              FROM ooed_t
#                             WHERE ooedent = g_enterprise
#                               AND ooed001 = g_ooeb_m.ooeb004
#                               AND ooed002 = g_ooeb_m.ooeb005
#                               AND ooed003 <> g_ooeb_m.ooeb006
#                               AND (ooed006 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
#                                    OR ooed007 BETWEEN g_ooeb_m.ooeb007 AND g_ooeb_m.ooeb008
#                                    OR (ooed006 <= g_ooeb_m.ooeb007 AND (ooed007 IS NULL OR ooed007 >= g_ooeb_m.ooeb008)))
#                             )
#           AND ooed008 <> g_ooeb_m.ooeb001  
      END IF
   END IF
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.aooi110_ooef_fill" order="38" ver="4" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
#依單頭選定的組織職能QBE篩選出組織基本資料檔的組織節點,顯示於本單身中以備拖拉組織樹
PRIVATE FUNCTION aooi110_ooef_fill()
 
    CALL g_ooef_d.clear()
    
    IF g_flag2 = FALSE THEN
       RETURN
    END IF
    
    IF cl_null(g_wc_table2) THEN
       LET g_wc_table2 =  " 1=1"
    END IF
    
    LET g_sql = " SELECT 'N',ooef001,t1.ooefl003,ooef017,t2.ooefl003 FROM ooef_t ",
                " LEFT JOIN ooefl_t t1 ON t1.ooeflent = ooefent AND t1.ooefl001 = ooef001 AND t1.ooefl002 = '"||g_dlang||"' ",
                " LEFT JOIN ooefl_t t2 ON t2.ooeflent = ooefent AND t2.ooefl001 = ooef017 AND t2.ooefl002 = '"||g_dlang||"' ",
                " WHERE ooefent = '",g_enterprise,"' AND ooefstus = 'Y' AND ",g_wc_table2 CLIPPED,
                "  AND ooef001 <> '",g_ooeb_m.ooeb005,"' "

    #组织树维护作业aooi110中，组织树类型财务组需要用到的为：
    #                          .账务中心组织（树中的节点是所有组织即可）
    #                          .预算中心组织（树中的节点是只有预算组织打勾的才可以选）
    #                          .资产中心组织（树中的节点是只有资产组织打勾的才可以选）
    #                          .资金中心组织（树中的节点是只有资金组织打勾的才可以选）
    #                          .资金计划组织（树中的节点是只有资金组织打勾的才可以选）
    CASE g_ooeb_m.ooeb004
       WHEN '1'  LET g_sql = g_sql , " AND ooef203 = 'Y' " 
       WHEN '4'  LET g_sql = g_sql , " AND ooef205 = 'Y' " 
       WHEN '5'  LET g_sql = g_sql , " AND ooef207 = 'Y' "
       WHEN '6'  LET g_sql = g_sql , " AND ooef206 = 'Y' "
       WHEN '7'  LET g_sql = g_sql , " AND ooef206 = 'Y' "
       WHEN '8'  LET g_sql = g_sql , " AND ooef201 = 'Y' "
       WHEN '9'  LET g_sql = g_sql , " AND ooef208 = 'Y' "
       WHEN '10' LET g_sql = g_sql , " AND ooef210 = 'Y' "
       WHEN '11' LET g_sql = g_sql , " AND ooef211 = 'Y' "
       WHEN '12' LET g_sql = g_sql , " AND ooef212 = 'Y' "
    END CASE
    
    #子階與父階關係為一對一,但財務的五個中心除外(帳務中心/預算中心/資金結算中心/資金計劃中心/資產中心)
    #   其同一子階可存在多個父階之下,為一對多觀念
    #IF g_ooeb_m.ooeb004 MATCHES '[128]' THEN
    #營運據點也可以一對多
    IF g_ooeb_m.ooeb004 MATCHES '[129]' OR g_ooeb_m.ooeb004 = '10' OR g_ooeb_m.ooeb004 = '11' OR g_ooeb_m.ooeb004 ='12' THEN
       LET g_sql = g_sql , " AND ooef001 NOT IN (SELECT ooec004 FROM ooec_t WHERE ooecent = '",g_enterprise,"' AND ooec008 = '",g_ooeb_m.ooeb001,"' ) ",
                           " AND ooef001 NOT IN (SELECT ooec005 FROM ooec_t WHERE ooecent = '",g_enterprise,"' AND ooec008 = '",g_ooeb_m.ooeb001,"' ) "
    END IF
    
    LET g_sql = g_sql , " ORDER BY ooef001 "
    
    PREPARE aooi110_pb2 FROM g_sql
    DECLARE b_fill_cs2 CURSOR FOR aooi110_pb2
    
    LET g_cnt = l_ac
    LET l_ac = 1
    
    FOREACH b_fill_cs2 INTO g_ooef_d[l_ac].check,g_ooef_d[l_ac].ooef001,g_ooef_d[l_ac].ooef001_desc,g_ooef_d[l_ac].ooef017,g_ooef_d[l_ac].ooef017_desc
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = "FOREACH:"
          LET g_errparam.popup = TRUE
          CALL cl_err()

          EXIT FOREACH
       END IF
    
       LET l_ac = l_ac + 1
       IF l_ac > g_max_rec THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code =  9035
          LET g_errparam.extend =  ''
          LET g_errparam.popup = FALSE
          CALL cl_err()

          EXIT FOREACH
       END IF
    
    END FOREACH
    
    CALL g_ooef_d.deleteElement(g_ooef_d.getLength())
    
    LET g_rec_b2 = l_ac - 1
    LET l_ac = g_cnt
    LET g_cnt = 0
    
    FREE aooi110_pb2

    #LET g_flag2 = FALSE
    
END FUNCTION]]>
  </point>
  <point name="function.aooi110_crt_tmp" order="39" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
# 創建臨時表
PRIVATE FUNCTION aooi110_crt_tmp()

   DROP TABLE ooed_tmp

   CREATE TEMP TABLE ooed_tmp
   (
       ooedent       INT,
       ooed001       VARCHAR(10),
       ooed002       VARCHAR(10),
       ooed003       VARCHAR(10),
       ooed004       VARCHAR(10),
       ooed005       VARCHAR(10),
       ooed006       DATE,
       ooed007       DATE,
       ooed008       VARCHAR(10)
   );
END FUNCTION]]>
  </point>
  <point name="function.aooi110_ins_ooec" order="40" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
#樹初始化，重新生成根節點
PRIVATE FUNCTION aooi110_ins_ooec()
DEFINE l_sql     STRING

   
   IF cl_null(g_ooeb_m.ooeb008) THEN
      LET l_sql = " INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008) ",
                  " VALUES ('",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
                  "        '",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb007,"','','",g_ooeb_m.ooeb001,"') "
   ELSE
      LET l_sql = " INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008) ",
                  " VALUES ('",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
                  "        '",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb007,"','",g_ooeb_m.ooeb008,"','",g_ooeb_m.ooeb001,"') "
   END IF
   PREPARE ins_ooec_pre FROM l_sql
   EXECUTE ins_ooec_pre
   
   CALL aooi110_tree_tmp_fill()
   DISPLAY ARRAY g_tree TO s_tree.*
       BEFORE DISPLAY
         EXIT DISPLAY
   END DISPLAY
   
   
END FUNCTION]]>
  </point>
  <point name="function.aooi110_tree_refresh" order="41" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
#刷新樹
PRIVATE FUNCTION aooi110_tree_refresh()
     
     CALL aooi110_tree_fill()
     
     DISPLAY ARRAY g_tree TO s_tree.*
         BEFORE DISPLAY
           EXIT DISPLAY
     END DISPLAY
     
END FUNCTION]]>
  </point>
  <point name="function.aooi110_produce" order="42" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
#產生當前組織結構檔
PRIVATE FUNCTION aooi110_produce()
DEFINE l_ooej    RECORD LIKE ooej_t.*
DEFINE l_ooed    RECORD LIKE ooed_t.*
DEFINE r_success LIKE type_t.num5

    LET r_success = TRUE
    
    IF g_ooeb_m.ooeb001 IS NULL THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = "std-00003"
       LET g_errparam.extend = ""
       LET g_errparam.popup = FALSE
       CALL cl_err()

       LET r_success = FALSE
       RETURN r_success
    END IF
    
    IF g_ooeb_m.ooebstus <> 'Y' THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = "sub-00475"
       LET g_errparam.extend = ""
       LET g_errparam.popup = TRUE
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #生效日期不是今天，是否確認產生組織結構檔？
    IF g_ooeb_m.ooeb007 > g_today THEN
       IF NOT cl_ask_confirm('aoo-00367') THEN
          LET g_flag3 = TRUE
          RETURN r_success
      END IF
    END IF
    
    #失效日期已小於今天，是否確認產生組織結構檔？
    IF g_ooeb_m.ooeb008 < g_today THEN
       IF NOT cl_ask_confirm('aoo-00368') THEN
          LET g_flag3 = TRUE
          RETURN r_success
      END IF
    END IF
    
    INITIALIZE l_ooej.* TO NULL
    INITIALIZE l_ooed.* TO NULL
    
    #DELETE FROM ooej_t WHERE ooejent = g_enterprise AND ooej008 = g_ooeb_m.ooeb001
    DELETE FROM ooej_t WHERE ooejent = g_enterprise AND ooej001 = g_ooeb_m.ooeb004
                         AND ooej002 = g_ooeb_m.ooeb005 
                        #AND ooej003 = g_ooeb_m.ooeb006
                         
    DECLARE ooej_cs CURSOR FOR 
       SELECT * FROM ooed_t WHERE ooedent = g_enterprise AND ooed008 = g_ooeb_m.ooeb001
       
    FOREACH ooej_cs INTO l_ooed.*
    
       INSERT INTO ooej_t(ooejent,ooej001,ooej002,ooej003,ooej004,ooej005,ooej006,ooej007)
           VALUES(l_ooed.ooedent,l_ooed.ooed001,l_ooed.ooed002,l_ooed.ooed003,l_ooed.ooed004,l_ooed.ooed005,l_ooed.ooed006,l_ooed.ooed007)
       
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'ooej_t'
          LET g_errparam.popup = TRUE
          CALL cl_err()

          LET r_success = FALSE
          RETURN r_success
       END IF
       
       INITIALIZE l_ooej.* TO NULL
       INITIALIZE l_ooed.* TO NULL
       
    END FOREACH
    
    RETURN r_success

END FUNCTION]]>
  </point>
  <point name="function.aooi110_del_child" order="43" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
#判斷當前的節點 是否存在子節點，若存在子節點，則把下面的子節點也全部移除
PRIVATE FUNCTION aooi110_del_child(p_ooec005)
DEFINE p_ooec005     LIKE ooec_t.ooec005
DEFINE l_i           LIKE type_t.num5
DEFINE l_n           LIKE type_t.num5
DEFINE r_success     LIKE type_t.num5
DEFINE l_sql         STRING
DEFINE l_arr     DYNAMIC ARRAY OF RECORD
            ooec004  LIKE ooec_t.ooec004
                 END RECORD
                     
   LET r_success = TRUE
   
   LET l_n = 1
   
   LET l_sql = "SELECT ooec004 FROM ooec_t ",
               " WHERE ooecent = '" ||g_enterprise|| "'",
               "   AND ooec008 = '",g_ooeb_m.ooeb001,"' ",
               "   AND ooec004 <> ooec005 ",
               "   AND ooec005 = '",p_ooec005,"' "
               
   PREPARE aooi110_del_ooec_pr FROM l_sql
   DECLARE aooi110_del_ooec_cs CURSOR FOR aooi110_del_ooec_pr
   
   FOREACH aooi110_del_ooec_cs INTO l_arr[l_n].ooec004
   
      DELETE FROM ooec_t
       WHERE ooecent = g_enterprise
         AND ooec001 = g_ooeb_m.ooeb004
         AND ooec002 = g_ooeb_m.ooeb005
         AND ooec003 = g_ooeb_m.ooeb006
         AND ooec004 = l_arr[l_n].ooec004
         AND ooec005 = p_ooec005
         AND ooec008 = g_ooeb_m.ooeb001
         
      IF SQLCA.SQLcode  THEN 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "ooec_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success
      END IF
      
      LET l_n = l_n + 1 
   END FOREACH

   CALL l_arr.deleteElement(l_arr.getLength())
   
   FOR l_i = 1 TO l_arr.getLength()
   
     IF NOT aooi110_del_child(l_arr[l_i].ooec004) THEN
        LET r_success = FALSE
        RETURN r_success
     END IF
     
   END FOR
   
   RETURN r_success
   
END FUNCTION]]>
  </point>
  <point name="function.aooi110_set_act_visible" order="44" ver="6" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_set_act_visible()

   CALL cl_set_act_visible("modify,delete,produce,ins_aooi100,upd_aooi100,del_aooi100", TRUE)

END FUNCTION]]>
  </point>
  <point name="function.aooi110_set_act_no_visible" order="45" ver="6" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION aooi110_set_act_no_visible()
   
   CALL cl_set_act_visible("reproduce",FALSE)
   
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("modify,delete", FALSE)
   END IF
   IF g_ooeb_m.ooebstus <> "N" THEN
      CALL cl_set_act_visible("modify,delete",FALSE)
   END IF
   
   IF g_ooeb_m.ooebstus <> "Y" THEN
      CALL cl_set_act_visible("produce",FALSE)
   END IF

   IF g_rec_b2 <= 0 OR cl_null(g_rec_b2) THEN
      CALL cl_set_act_visible("upd_aooi100,del_aooi100", FALSE)
   END IF
   
END FUNCTION]]>
  </point>
  <point name="function.aooi110_out_tree1" order="46" ver="8" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
#變更類型為新增時，若選擇依上一版本带出预设值，则将当前最上层组织的上一版本的组织树预设带出
PRIVATE FUNCTION aooi110_out_tree1()
DEFINE l_ooeb006   LIKE ooeb_t.ooeb006

   IF g_ooeb_m.ooeb003 = '1' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND  NOT cl_null(g_ooeb_m.ooeb005) AND  NOT cl_null(g_ooeb_m.ooeb006) THEN
         
         SELECT MAX(ooed003) INTO l_ooeb006 FROM ooed_t
            WHERE ooedent = g_enterprise AND ooed001 = g_ooeb_m.ooeb004 AND ooed002 = g_ooeb_m.ooeb005
         IF l_ooeb006 > 0 THEN
            DELETE FROM ooec_t WHERE ooecent = g_enterprise AND ooec008 = g_ooeb_m.ooeb001
         
            SELECT DISTINCT ooed006,ooed007 INTO g_ooeb_m.ooeb007,g_ooeb_m.ooeb008
              FROM ooed_t
             WHERE ooedent = g_enterprise
               AND ooed001 = g_ooeb_m.ooeb004
               AND ooed002 = g_ooeb_m.ooeb005
               AND ooed003 = l_ooeb006
            IF cl_null(g_ooeb_m.ooeb008) THEN
               LET g_ooeb_m.ooeb008 = ""
            END IF
            LET g_sql = " INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005,ooec006,ooec007,ooec008) ",
                        " SELECT ooedent,ooed001,ooed002,'",g_ooeb_m.ooeb006,"',ooed004,ooed005,ooed006,ooed007,'",g_ooeb_m.ooeb001,"' ",
                        "   FROM ooed_t ",
                        "  WHERE ooedent = '",g_enterprise,"' ",
                        "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                        "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                        "    AND ooed003 = '",l_ooeb006,"'"
            PREPARE aooi110_ins_ooed_tmp_pre7 FROM g_sql
            EXECUTE aooi110_ins_ooed_tmp_pre7
            CALL aooi110_tree_fill()
            DISPLAY ARRAY g_tree TO s_tree.*
                BEFORE DISPLAY
                  EXIT DISPLAY
            END DISPLAY
          END IF
          
          CALL aooi110_set_entry('u')
          CALL aooi110_set_no_entry('u')  
      
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="b_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="b_fill.fill" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      SELECT ooefl003 INTO g_ooec_d[l_ac].lbl_ooec004_desc
        FROM ooefl_t
       WHERE ooefl001 = g_ooec_d[l_ac].ooec004
         AND ooefl002 = g_dlang
         AND ooeflent = g_enterprise
      SELECT ooefl003 INTO g_ooec_d[l_ac].lbl_ooec005_desc
        FROM ooefl_t
       WHERE ooefl001 = g_ooec_d[l_ac].ooec005
         AND ooefl002 = g_dlang
         AND ooeflent = g_enterprise]]>
  </point>
  <point name="b_fill.sql" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="browser_fill.after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   LET g_ooeb_m.ooeb001 = g_browser[1].b_ooeb001
   SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodu,ooebdate,ooeboriu,ooeborid,ooebuser,ooebdept,ooebbuid
     INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodu,
          g_ooeb_m.ooebdate,g_ooeb_m.ooeboriu,g_ooeb_m.ooeborid,g_ooeb_m.ooebuser,g_ooeb_m.ooebdept,g_ooeb_m.ooebbuid
     FROM ooeb_t
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "ooeb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      INITIALIZE g_ooeb_m.* TO NULL
      RETURN
   END IF
   LET g_cnt = 1
   LET g_sql = " SELECT ooed004,ooed003,ooed005 FROM ooed_t ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed006 <= '",g_today,"' ",
               "    AND ooed007 >= '",g_today,"' ",
               "  ORDER BY ooed004 "
   PREPARE browse_1_pre FROM g_sql
   DECLARE browse_1_cur CURSOR FOR browse_1_pre
   FOREACH browse_1_cur INTO g_tree[g_cnt].b_id,l_ooed003,g_tree[g_cnt].b_pid  
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      IF g_tree[g_cnt].b_id = g_tree[g_cnt].b_pid THEN
         LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id,'(',l_ooed003,')'
      ELSE
         LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id
      END IF
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9035
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT FOREACH
      END IF
   END FOREACH
   FREE browse_1_pre]]>
  </point>
  <point name="browser_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_ooed003         LIKE ooed_t.ooed003]]>
  </point>
  <point name="browser_fill.reference" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="construct.a.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb007" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooeb008" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooebcrtdp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooebcrtid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooebmodid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooebowndp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooebownid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.ooebstus" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.page1.ooec002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.page1.ooec003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.page1.ooec004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.a.page1.ooec005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb007" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooeb008" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebcrtdp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebcrtdt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebcrtid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebmodid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebowndp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebownid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.ooebstus" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.page1.ooec002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.page1.ooec003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.page1.ooec004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.b.page1.ooec005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooeb002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooeb003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooeb004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooeb005  #顯示到畫面上

            NEXT FIELD ooeb005                     #返回原欄位

]]>
  </point>
  <point name="construct.c.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooed003()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooeb006  #顯示到畫面上

            NEXT FIELD ooeb006                     #返回原欄位

]]>
  </point>
  <point name="construct.c.ooeb007" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooeb008" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooebcrtdp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooebcrtid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooebmodid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooebowndp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooebownid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.ooebstus" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.page1.ooec002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.page1.ooec003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.page1.ooec004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="construct.c.page1.ooec005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="cs.add_cs" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="cs.b_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ]]>
  </point>
  <point name="cs.body.before_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="cs.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="default_search.after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="default_search.before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="default_search.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="delete.body.a_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="delete.body.b_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="delete.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="delete.head.b_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="fetch.after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      #此段落由子樣板a20產生
      IF g_ooeb_m.ooebstus = "Y" THEN
         CALL cl_set_act_visible("modify,delete,reproduce",FALSE)
      ELSE
         CALL cl_set_act_visible("statechange",TRUE)
         CALL cl_set_act_visible("modify,delete",TRUE)
      END IF
   END IF]]>
  </point>
  <point name="fetch.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="free_style.variable" order="" ver="8" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[{<Module define>}

#單頭 type 宣告
 type type_g_ooeb_m        RECORD
   ooeb001 LIKE ooeb_t.ooeb001,
   ooeb002 LIKE ooeb_t.ooeb002,
   ooeb003 LIKE ooeb_t.ooeb003,
   ooeb004 LIKE ooeb_t.ooeb004,
   ooeb005 LIKE ooeb_t.ooeb005,
   ooeb006 LIKE ooeb_t.ooeb006,
   ooeb005_desc LIKE type_t.chr80,
   ooeb007 LIKE ooeb_t.ooeb007,
   ooeb008 LIKE ooeb_t.ooeb008,
   ooebstus LIKE ooeb_t.ooebstus,
   ooebmodid LIKE ooeb_t.ooebmodid,
   ooebmodid_desc LIKE type_t.chr80,
   ooebmoddt DATETIME YEAR TO SECOND,
   ooebownid LIKE ooeb_t.ooebownid,
   ooebownid_desc LIKE type_t.chr80,
   ooebowndp LIKE ooeb_t.ooebowndp,
   ooebowndp_desc LIKE type_t.chr80,
   ooebcrtid LIKE ooeb_t.ooebcrtid,
   ooebcrtid_desc LIKE type_t.chr80,
   ooebcrtdp LIKE ooeb_t.ooebcrtdp,
   ooebcrtdp_desc LIKE type_t.chr80,
   ooebcrtdt DATETIME YEAR TO SECOND
       END RECORD

TYPE type_g_ooef_d        RECORD
   check   LIKE type_t.chr1,
   ooef001 LIKE ooef_t.ooef001,
   ooef001_desc LIKE type_t.chr80,
   ooef017 LIKE ooef_t.ooef017,
   ooef017_desc LIKE type_t.chr80
       END RECORD

#模組變數(Module Variables)
DEFINE g_ooeb_m          type_g_ooeb_m
DEFINE g_ooeb_m_t        type_g_ooeb_m
DEFINE g_ooeb_m_o        type_g_ooeb_m

DEFINE g_ooeb001_t     LIKE ooeb_t.ooeb001


DEFINE g_ooef_d          DYNAMIC ARRAY OF type_g_ooef_d
DEFINE g_ooef_d_t        type_g_ooef_d


DEFINE g_browser    DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位
         b_statepic     LIKE type_t.chr50,
            b_ooeb001 LIKE ooeb_t.ooeb001
         #,rank           LIKE type_t.num10
      END RECORD

DEFINE g_browser_f  RECORD    #資料瀏覽之欄位
         b_statepic     LIKE type_t.chr50,
            b_ooeb001 LIKE ooeb_t.ooeb001
         #,rank           LIKE type_t.num10
      END RECORD

#無單頭append欄位定義
#無單身append欄位定義

DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING

DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10
DEFINE g_jump                LIKE type_t.num10
DEFINE g_no_ask              LIKE type_t.num5
DEFINE g_rec_b               LIKE type_t.num5
DEFINE l_ac                  LIKE type_t.num5
DEFINE g_curr_diag           ui.Dialog                     #Current Dialog

DEFINE g_pagestart           LIKE type_t.num5
DEFINE gwin_curr             ui.Window                     #Current Window
DEFINE gfrm_curr             ui.Form                       #Current Form
DEFINE g_page_action         STRING                        #page action
DEFINE g_header_hidden       LIKE type_t.num5              #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5              #隱藏工作Panel
DEFINE g_page                STRING                        #第幾頁
DEFINE g_state               STRING

DEFINE g_detail_cnt          LIKE type_t.num5              #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num5              #單身目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num5              #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num5              #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num5              #Browser目前所在筆數(暫存用)

DEFINE g_searchcol           STRING                        #查詢欄位代碼
DEFINE g_searchstr           STRING                        #查詢欄位字串
DEFINE g_order               STRING                        #查詢排序欄位

DEFINE g_current_row         LIKE type_t.num5              #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                       #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num5              #目前所在頁數

DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列

DEFINE g_wc_table1           STRING             

DEFINE g_wc_table2           STRING 
DEFINE g_flag2               LIKE type_t.num5
DEFINE g_rec_b2              LIKE type_t.num5
DEFINE g_flag3              LIKE type_t.num5
{</Module define>}]]>
  </point>
  <point name="global.import" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[IMPORT util]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[DEFINE g_flag                LIKE type_t.chr1
DEFINE g_wcb                 STRING
DEFINE g_tree      DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位  
       #外顯欄位
       b_show          LIKE type_t.chr100,
       #父節點id
       b_pid           LIKE type_t.chr100,
       #本身節點id
       b_id            LIKE type_t.chr100,
       #是否展開
       b_exp           LIKE type_t.chr100,
       #是否有子節點
       b_hasC          LIKE type_t.num5,
       #是否已展開
       b_isExp         LIKE type_t.num5,
       #展開值
       b_expcode       LIKE type_t.num5,
       #tree自定義欄位
       b_ooed001       LIKE ooed_t.ooed001,
       b_ooed002       LIKE ooed_t.ooed002,
       b_ooed003       LIKE ooed_t.ooed003,
       b_ooed004       LIKE ooed_t.ooed004,
       b_ooed004_desc  LIKE type_t.chr80,
       b_ooed005       LIKE ooed_t.ooed005
       END RECORD ]]>
  </point>
  <point name="idx_chk.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="init.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="init.init" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="input.a.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( p_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t ))) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooeb_t WHERE "||"ooebent = '" ||g_enterprise|| "' AND "||"ooeb001 = '"||g_ooeb_m.ooeb001 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


]]>
  </point>
  <point name="input.a.ooeb002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooeb003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL aooi110_set_entry_ooeb003()]]>
  </point>
  <point name="input.a.ooeb004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL aooi110_chk_ooeb005()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = "ooeb004"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb004= g_ooeb_m_t.ooeb004
               NEXT FIELD ooeb004
            END IF
            CALL aooi110_def_ooeb006()
           ]]>
  </point>
  <point name="input.a.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL aooi110_chk_ooeb005()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = "ooeb005"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb005= g_ooeb_m_t.ooeb005
               NEXT FIELD ooeb005
            END IF
            CALL aooi110_def_ooeb006()
            CALL aooi110_ooec005_desc()]]>
  </point>
  <point name="input.a.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL aooi110_chk_ooeb005()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = "ooeb006"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb006= g_ooeb_m_t.ooeb006
               NEXT FIELD ooeb006
            END IF
            ]]>
  </point>
  <point name="input.a.ooeb007" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL aooi110_chk_date()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = "ooeb007"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb007= g_ooeb_m_t.ooeb007
               NEXT FIELD ooeb007
            END IF]]>
  </point>
  <point name="input.a.ooeb008" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL aooi110_chk_date()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = "ooeb008"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb008= g_ooeb_m_t.ooeb008
               NEXT FIELD ooeb008
            END IF]]>
  </point>
  <point name="input.a.ooebcrtdp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebcrtdt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebcrtid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebmoddt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebmodid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebowndp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebownid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.ooebstus" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.a.page1.ooec002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) AND NOT cl_null(g_ooec_d[l_ac].ooec002) THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND ( l_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t  OR g_ooec_d[l_ac].ooec002 != g_ooec_d_t.ooec002))) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooec_t WHERE "||"ooecent = '" ||g_enterprise|| "' AND "||"ooec001 = '"||g_ooeb_m.ooeb001 ||"' AND "|| "ooec002 = '"||g_ooec_d[l_ac].ooec002 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF



            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) AND NOT cl_null(g_ooec_d[l_ac].ooec002) THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND ( l_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t OR g_ooec_d[l_ac].ooec002 != g_ooec_d_t.ooec002))) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooec_t WHERE "||"ooecent = '" ||g_enterprise|| "' AND "||"ooec001 = '"||g_ooeb_m.ooeb001 ||"' AND "|| "ooec002 = '"||g_ooec_d[l_ac].ooec002 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.ooec004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
]]>
  </point>
  <point name="input.a.page1.ooec005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
]]>
  </point>
  <point name="input.after_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="input.b.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb007" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooeb008" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebcrtdp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebcrtdt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebcrtid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebmoddt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebmodid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebowndp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebownid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.b.ooebstus" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.before_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ]]>
  </point>
  <point name="input.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="input.c.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_ooeb_m.ooeb005             #給予default值

            #給予arg

            CALL q_ooea001()                                #呼叫開窗

            LET g_ooeb_m.ooeb005 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_ooeb_m.ooeb005 TO ooeb005              #顯示到畫面上

            NEXT FIELD ooeb005                          #返回原欄位

]]>
  </point>
  <point name="input.c.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_ooeb_m.ooeb006             #給予default值

            #給予arg

            CALL q_ooed003()                                #呼叫開窗

            LET g_ooeb_m.ooeb006 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_ooeb_m.ooeb006 TO ooeb006              #顯示到畫面上

            NEXT FIELD ooeb006                          #返回原欄位

]]>
  </point>
  <point name="input.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="input.g.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb003" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb004" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb005" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb006" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb007" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooeb008" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebcrtdp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebcrtdt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebcrtid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebmoddt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebmodid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebowndp" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebownid" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.g.ooebstus" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="input.head.a_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[                  IF g_ooeb_m.ooeb003 = '1' THEN
                     CALL s_aooi110_ins() RETURNING g_wcb
                     CALL aooi110_ins_tmp()
                     CALL aooi110_tree_tmp_fill()
                  END IF]]>
  </point>
  <point name="input.head.a_update" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               IF g_ooeb_m.ooeb003 = '1' THEN
                  CALL s_aooi110_ins() RETURNING g_wcb
                  CALL aooi110_ins_tmp()
                  CALL aooi110_tree_tmp_fill()
               END IF]]>
  </point>
  <point name="input.head.b_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[                  CALL aooi110_auto_code() RETURNING g_ooeb_m.ooeb001
                  DISPLAY BY NAME g_ooeb_m.ooeb001]]>
  </point>
  <point name="input.head.b_update" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="input.more_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="insert.after_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="insert.default" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      LET g_ooeb_m.ooeb002 = g_today
      LET g_ooeb_m.ooebstus = "N"
      CALL aooi110_set_entry_ooeb003()]]>
  </point>
  <point name="insert.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="main.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="main.exit" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="main.init" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL aooi110_crt_tmp()
   
   LET g_flag2 = FALSE]]>
  </point>
  <point name="main.servicecall" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[                              ]]>
  </point>
  <point name="menu.confirm" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               CALL aooi110_confirm()]]>
  </point>
  <point name="menu.delete" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="menu.insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="menu.modify" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="menu.output" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="menu.produce" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="menu.query" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="menu.reproduce" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="modify.after_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="modify.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      CALL aooi110_set_entry_ooeb003()]]>
  </point>
  <point name="modify.body.a_fk_update" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ]]>
  </point>
  <point name="modify.body.b_fk_update" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ]]>
  </point>
  <point name="modify.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="query.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="reproduce.a.ooeb001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ]]>
  </point>
  <point name="reproduce.action" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="reproduce.after_reproduce" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="reproduce.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ]]>
  </point>
  <point name="reproduce.body.table1.a_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="reproduce.body.table1.b_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="reproduce.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="reproduce.head.a_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="reproduce.head.b_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="set_entry.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="set_entry.field_control" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      CALL cl_set_comp_entry("ooeb001",FALSE)]]>
  </point>
  <point name="set_no_entry.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="set_no_entry.field_control" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="show.after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="show.before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="show.body.reference" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="show.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="show.head.reference" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL aooi110_ooec005_desc()]]>
  </point>
  <point name="statechange.a_update" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="statechange.after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="statechange.b_update" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="statechange.before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="statechange.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="ui_browser_refresh.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="ui_detailshow.after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="ui_detailshow.before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="ui_detailshow.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="ui_dialog.before_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="ui_dialog.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_id      LIKE type_t.num5
   DEFINE l_status  LIKE type_t.num5
   DEFINE l_value   STRING
   DEFINE arr_left  DYNAMIC ARRAY OF STRING
   DEFINE arr_right DYNAMIC ARRAY OF STRING
   DEFINE l_dnd     ui.DragDrop
   DEFINE l_source  STRING 
   DEFINE l_target  STRING
   DEFINE l_ac1     STRING
   DEFINE l_ac2     STRING
   DEFINE l_ooec004 LIKE ooec_t.ooec004]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
         DISPLAY ARRAY g_tree TO s_tree.*
            ON DRAG_START(l_dnd)
               LET l_source="RIGHT"
               LET l_ac1 = ARR_CURR()
               LET arr_right[l_ac1] = g_tree[l_ac1].b_id
               LET l_value = arr_right[l_ac1]
            ON DRAG_FINISHED(l_dnd)
               INITIALIZE l_source TO NULL

            ON DRAG_ENTER(l_dnd)
                IF l_source IS NULL THEN
                   CALL l_dnd.setOperation(NULL)
                END IF
            ON DROP(l_dnd)
                IF l_source == "RIGHT" THEN
                   LET l_ooec004 = g_tree[l_ac1].b_id
                   LET l_ac1 = l_dnd.getLocationRow()
                   CALL l_dnd.dropInternal()
                ELSE
                   LET l_ac2 = l_dnd.getLocationRow()
                   LET l_ooec004 = g_tree[l_ac2].b_id
                   CALL DIALOG.insertRow("s_tree",l_ac1)
                   CALL DIALOG.setCurrentRow("s_tree",l_ac1)
                   IF cl_null(l_ac1) THEN
                      LET l_ac1 = l_dnd.getLocationRow()
                   END IF
                   LET arr_right[l_ac1] = l_value
                   LET g_tree[l_ac1].b_show =  arr_right[l_ac1]
                   LET g_tree[l_ac1].b_id =  arr_right[l_ac1]
                   LET g_tree[l_ac1].b_pid =  l_ooec004
                   CALL l_dnd.dropInternal()
                   CALL DIALOG.deleteRow("s_tree",l_ac1+1)
                   CALL DIALOG.deleteRow("s_detail1",l_ac)
                END IF

         END DISPLAY]]>
  </point>
  <point name="ui_dialog.page1.action" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            ON DRAG_START(l_dnd)
               LET l_source="LEFT"
               LET l_ac = ARR_CURR()
               LET arr_left[l_ac] = g_ooec_d[l_ac].ooec004
               LET l_value = arr_left[l_ac]
            ON DRAG_FINISHED(l_dnd)
               INITIALIZE l_source TO NULL

            ON DRAG_ENTER(l_dnd)
                IF l_source IS NULL THEN
                   CALL l_dnd.setOperation(NULL)
                END IF
            ON DROP(l_dnd)
                IF l_source == "LEFT" THEN
                   CALL l_dnd.dropInternal()
                ELSE
                   LET l_ac = l_dnd.getLocationRow()
                   CALL DIALOG.insertRow("s_detail1",l_ac)
                   CALL DIALOG.setCurrentRow("s_detail1",l_ac)
                   IF cl_null(l_ac) THEN
                      LET l_ac = l_dnd.getLocationRow()
                   END IF
                   LET arr_left[l_ac]= l_value
                   LET g_ooec_d[l_ac].ooec004= arr_left[l_ac]
                   CALL DIALOG.deleteRow("s_tree",l_ac1)
                END IF]]>
  </point>
  <point name="ui_dialog.page1.before_row" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               ]]>
  </point>
  <point name="ui_headershow.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="whole_program" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
#+ Version..: T6-ERP-1.00.00 Build-000254
#+
#+ Filename...: aooi110
#+ Buildtype..: 應用 t01 樣板自動產生
#+ Memo.......:
#+ 以上段落由子樣板a00產生


{<point name="global.memo" />}

IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point

SCHEMA ds

GLOBALS "../../cfg/top_global.inc"

{<Module define>}

#單頭 type 宣告
PRIVATE type type_g_ooeb_m        RECORD
       ooeb001 LIKE ooeb_t.ooeb001,
   ooeb002 LIKE ooeb_t.ooeb002,
   ooeb003 LIKE ooeb_t.ooeb003,
   ooeb004 LIKE ooeb_t.ooeb004,
   ooeb005 LIKE ooeb_t.ooeb005,
   ooeb006 LIKE ooeb_t.ooeb006,
   ooeb005_desc LIKE type_t.chr80,
   ooeb007 LIKE ooeb_t.ooeb007,
   ooeb008 LIKE ooeb_t.ooeb008,
   ooebstus LIKE ooeb_t.ooebstus,
   ooebmodid LIKE ooeb_t.ooebmodid,
   ooebmodid_desc LIKE type_t.chr80,
   ooebmoddt DATETIME YEAR TO SECOND,
   ooebownid LIKE ooeb_t.ooebownid,
   ooebownid_desc LIKE type_t.chr80,
   ooebowndp LIKE ooeb_t.ooebowndp,
   ooebowndp_desc LIKE type_t.chr80,
   ooebcrtid LIKE ooeb_t.ooebcrtid,
   ooebcrtid_desc LIKE type_t.chr80,
   ooebcrtdp LIKE ooeb_t.ooebcrtdp,
   ooebcrtdp_desc LIKE type_t.chr80,
   ooebcrtdt DATETIME YEAR TO SECOND
       END RECORD

#單身 type 宣告
PRIVATE TYPE type_g_ooec_d        RECORD
       ooec002 LIKE ooec_t.ooec002,
   ooec003 LIKE ooec_t.ooec003,
   ooec004 LIKE ooec_t.ooec004,
   lbl_ooec004_desc LIKE type_t.chr80,
   ooec005 LIKE ooec_t.ooec005,
   lbl_ooec005_desc LIKE type_t.chr80
       END RECORD


#模組變數(Module Variables)
DEFINE g_ooeb_m          type_g_ooeb_m
DEFINE g_ooeb_m_t        type_g_ooeb_m

DEFINE g_ooeb001_t     LIKE ooeb_t.ooeb001


DEFINE g_ooec_d          DYNAMIC ARRAY OF type_g_ooec_d
DEFINE g_ooec_d_t        type_g_ooec_d


DEFINE g_browser    DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位
         b_statepic     LIKE type_t.chr50,
            b_ooeb001 LIKE ooeb_t.ooeb001
         #,rank           LIKE type_t.num10
      END RECORD

DEFINE g_browser_f  RECORD    #資料瀏覽之欄位
         b_statepic     LIKE type_t.chr50,
            b_ooeb001 LIKE ooeb_t.ooeb001
         #,rank           LIKE type_t.num10
      END RECORD

#無單頭append欄位定義
#無單身append欄位定義

DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING

DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10
DEFINE g_jump                LIKE type_t.num10
DEFINE g_no_ask              LIKE type_t.num5
DEFINE g_rec_b               LIKE type_t.num5
DEFINE l_ac                  LIKE type_t.num5
DEFINE g_curr_diag           ui.Dialog                     #Current Dialog

DEFINE g_pagestart           LIKE type_t.num5
DEFINE gwin_curr             ui.Window                     #Current Window
DEFINE gfrm_curr             ui.Form                       #Current Form
DEFINE g_page_action         STRING                        #page action
DEFINE g_header_hidden       LIKE type_t.num5              #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5              #隱藏工作Panel
DEFINE g_page                STRING                        #第幾頁
DEFINE g_state               STRING

DEFINE g_detail_cnt          LIKE type_t.num5              #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num5              #單身目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num5              #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num5              #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num5              #Browser目前所在筆數(暫存用)

DEFINE g_searchcol           STRING                        #查詢欄位代碼
DEFINE g_searchstr           STRING                        #查詢欄位字串
DEFINE g_order               STRING                        #查詢排序欄位

DEFINE g_current_row         LIKE type_t.num5              #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                       #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num5              #目前所在頁數

DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列

DEFINE g_wc_table1           STRING                        #第1個單身table所使用的g_wc


{</Module define>}

#add-point:自定義模組變數(Module Variable)
DEFINE g_wcb                 STRING
DEFINE g_tree      DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位
       #外顯欄位
       b_show          LIKE type_t.chr100,
       #父節點id
       b_pid           LIKE type_t.chr100,
       #本身節點id
       b_id            LIKE type_t.chr100,
       #是否展開
       b_exp           LIKE type_t.chr100,
       #是否有子節點
       b_hasC          LIKE type_t.num5,
       #是否已展開
       b_isExp         LIKE type_t.num5,
       #展開值
       b_expcode       LIKE type_t.num5
       END RECORD
DEFINE g_row_index           LIKE type_t.num5
#end add-point

#+ 作業開始
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point

   #定義在其他link的程式則無效
   WHENEVER ERROR CALL cl_err_msg_log

   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("aoo","")

   #add-point:作業初始化
   CALL aooi110_crt_tmp()
   #end add-point

   #LOCK CURSOR
   LET g_forupd_sql = "SELECT ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,'',ooeb007,ooeb008,ooebstus,ooebmodid,'',ooebmoddt,ooebownid,'',ooebowndp,'',ooebcrtid,'',ooebcrtdp,'',ooebcrtdt FROM ooeb_t WHERE ooebent= ? AND ooeb001=? FOR UPDATE"
   LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
   DECLARE aooi110_cl CURSOR FROM g_forupd_sql   #cursor lock

   IF g_bgjob = "Y" THEN

      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_aooi110 WITH FORM cl_ap_formpath("aoo",g_code)

      #程式初始化
      CALL aooi110_init()

      #瀏覽頁簽資料初始化
      CALL cl_ui_init()

      #進入選單 Menu (='N')
      CALL aooi110_ui_dialog()

      #畫面關閉
      CLOSE WINDOW w_aooi110
   END IF

   CLOSE aooi110_cl

   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point

   #離開作業
   CALL cl_ap_exitprogram("0")

END MAIN


#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION aooi110_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point

   #add-point:畫面資料初始化
   {<point name="init.init"/>}
   #end add-point

   CALL cl_set_combo_scc_part('ooebstus','13','N,X,Y')

   CALL aooi110_default_search()

END FUNCTION


#+ 功能選單
PRIVATE FUNCTION aooi110_ui_dialog()
   {<Local define>}
   DEFINE li_idx  LIKE type_t.num5
   {</Local define>}
   #add-point:ui_dialog段define
   DEFINE l_id        LIKE type_t.num5
   DEFINE l_status    LIKE type_t.num5
   DEFINE l_value     STRING
   DEFINE arr_left    DYNAMIC ARRAY OF STRING
   DEFINE arr_right   DYNAMIC ARRAY OF STRING
   DEFINE l_dnd       ui.DragDrop
   DEFINE l_source    STRING
   DEFINE l_target    STRING
   DEFINE l_ac1       STRING
   DEFINE l_ac2       STRING
   DEFINE l_ooec004   LIKE ooec_t.ooec004
   DEFINE l_ooec002   LIKE ooec_t.ooec002
   DEFINE l_ooec002_1 LIKE ooec_t.ooec002
   DEFINE l_n         LIKE type_t.num5
   DEFINE l_ooec004_t LIKE ooec_t.ooec004
   DEFINE l_ooec005_t LIKE ooec_t.ooec005
   #end add-point

   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件

   CALL cl_set_act_visible("accept,cancel", FALSE)

   #該樣板不需此段落CALL gfrm_curr.setElementImage("logo","logo/applogo.png")
   #該樣板不需此段落CALL gfrm_curr.setElementHidden("mainlayout",1)
   #該樣板不需此段落CALL gfrm_curr.setElementHidden("worksheet",0)
   LET g_main_hidden = 1

   #add-point:ui_dialog段before dialog
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point

   WHILE TRUE

      CALL aooi110_browser_fill("")
      #該樣板不需此段落CALL lib_cl_dlg.cl_query_bef_disp()
      #該樣板不需此段落CALL lib_cl_dlg.cl_relate_bef_disp()
      #該樣板不需此段落CALL cl_notice()

      CALL lib_cl_dlg.cl_query_bef_disp()
      CALL lib_cl_dlg.cl_relate_bef_disp()


      #判斷前一個動作是否為新增, 若是的話切換到新增的筆數
      IF g_state = "Y" THEN
         FOR li_idx = 1 TO g_browser.getLength()
            IF g_browser[li_idx].b_ooeb001 = g_ooeb001_t

               THEN
               LET g_current_row = li_idx
               EXIT FOR
            END IF
         END FOR
         LET g_state = ""
      END IF

      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         ##該樣板不需此段落INPUT g_searchstr,g_searchcol FROM formonly.searchstr,formonly.cbo_searchcol
         ##該樣板不需此段落
         ##該樣板不需此段落   BEFORE INPUT
         ##該樣板不需此段落
         ##該樣板不需此段落END INPUT

         #左側瀏覽頁簽
         #該樣板不需此段落DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)

         #該樣板不需此段落   BEFORE ROW
         #該樣板不需此段落      #回歸舊筆數位置 (回到當時異動的筆數)
         #該樣板不需此段落      LET g_current_idx = DIALOG.getCurrentRow("s_browse")
         #該樣板不需此段落      IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
         #該樣板不需此段落         CALL DIALOG.setCurrentRow("s_browse",g_current_row)
         #該樣板不需此段落         LET g_current_idx = g_current_row
         #該樣板不需此段落      END IF
         #該樣板不需此段落      LET g_current_row = g_current_idx #目前指標
         #該樣板不需此段落      LET g_current_sw = TRUE

         #該樣板不需此段落      IF g_current_idx > g_browser.getLength() THEN
         #該樣板不需此段落         LET g_current_idx = g_browser.getLength()
         #該樣板不需此段落      END IF

         #該樣板不需此段落      CALL aooi110_fetch('') # reload data
         #該樣板不需此段落      CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
         #該樣板不需此段落      LET g_detail_idx = 1
         #該樣板不需此段落      CALL aooi110_ui_detailshow() #Setting the current row

         #該樣板不需此段落      CALL aooi110_idx_chk()
         #該樣板不需此段落      #NEXT FIELD ooec002

         #該樣板不需此段落END DISPLAY

         DISPLAY ARRAY g_ooec_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1

            BEFORE ROW
               CALL aooi110_idx_chk()
               #add-point:page1, before row動作
               {<point name="ui_dialog.page1.before_row"/>}
               #end add-point

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               CALL aooi110_idx_chk()
               LET g_current_page = 1

            #自訂ACTION(detail_show,page_1)


            #add-point:page1自定義行為
            ON DRAG_START(l_dnd)
               LET l_source="LEFT"
               LET l_ac = ARR_CURR()
               LET arr_left[l_ac] = g_ooec_d[l_ac].ooec004
               LET l_value = arr_left[l_ac]
               LET l_ooec002_1 = g_ooec_d[l_ac].ooec002
            ON DRAG_FINISHED(l_dnd)
               INITIALIZE l_source TO NULL

            ON DRAG_ENTER(l_dnd)
                IF l_source IS NULL THEN
                   CALL l_dnd.setOperation(NULL)
                END IF
            ON DROP(l_dnd)
                IF l_source == "LEFT" THEN
                   CALL l_dnd.dropInternal()
                ELSE
                   LET l_ac = l_dnd.getLocationRow()
                   CALL DIALOG.insertRow("s_detail1",l_ac)
                   CALL DIALOG.setCurrentRow("s_detail1",l_ac)
                   IF cl_null(l_ac) THEN
                      LET l_ac = l_dnd.getLocationRow()
                   END IF
                   LET arr_left[l_ac]= l_value
                   LET g_ooec_d[l_ac].ooec004= arr_left[l_ac]
                   LET g_ooec_d[l_ac].ooec005= arr_left[l_ac]
                   CALL DIALOG.deleteRow("s_tree",l_ac1)
                   SELECT MAX(ooec002)+1 INTO l_ooec002
                     FROM ooec_t
                    WHERE ooec001 = g_ooeb_m.ooeb001
                      AND ooecent = g_enterprise
                   IF cl_null(l_ooec002) THEN
                      LET l_ooec002 = 1
                   END IF
                   INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005)
                               VALUES(g_enterprise,g_ooeb_m.ooeb001,l_ooec002,2,g_ooec_d[l_ac].ooec004,g_ooeb_m.ooeb005)
                   CALL aooi110_b_fill()
                END IF
            #end add-point

         END DISPLAY



         #add-point:ui_dialog段自定義display array

         DISPLAY ARRAY g_tree TO s_tree.*

            ON DRAG_START(l_dnd)
               LET l_source="RIGHT"
               LET l_ac1 = ARR_CURR()
               LET arr_right[l_ac1] = g_tree[l_ac1].b_id
               LET l_value = arr_right[l_ac1]
               LET l_n = 0
               SELECT COUNT(*) INTO l_n
                 FROM ooed_tmp
                WHERE ooedent = g_enterprise
                  AND (ooed004 = g_tree[l_ac1].b_id
                      OR ooed005 = g_tree[l_ac1].b_id)
                  AND ooed002 = g_ooeb_m.ooeb005
                  AND ooed001 = g_ooeb_m.ooeb004
               IF l_n = 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'aoo-00130'
                  LET g_errparam.extend = l_value
                  LET g_errparam.popup = FALSE
                  CALL cl_err()

              #ELSE
              #   SELECT MAX(ooec002)+1 INTO l_ooec002
              #     FROM ooec_t
              #    WHERE ooec001 = g_ooeb_m.ooeb001
              #      AND ooecent = g_enterprise
              #   IF cl_null(l_ooec002) THEN
              #      LET l_ooec002 = 1
              #   END IF
              #   IF g_tree[l_ac1].b_pid = "ROOT" THEN
              #      LET g_tree[l_ac1].b_pid = g_tree[l_ac1].b_id
              #   END IF
              #   INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005)
              #               VALUES(g_enterprise,g_ooeb_m.ooeb001,l_ooec002,2,g_tree[l_ac1].b_id,g_tree[l_ac1].b_pid)
               END IF
               IF g_tree[l_ac1].b_pid = "ROOT" THEN
                  LET g_tree[l_ac1].b_pid = g_tree[l_ac1].b_id
               END IF
               LET l_ooec004_t = g_tree[l_ac1].b_id
               LET l_ooec005_t = g_tree[l_ac1].b_pid
            ON DRAG_FINISHED(l_dnd)
               INITIALIZE l_source TO NULL

            ON DRAG_ENTER(l_dnd)
                IF l_source IS NULL THEN
                   CALL l_dnd.setOperation(NULL)
                END IF
            ON DROP(l_dnd)
                LET l_ac1 = l_dnd.getLocationRow()
                LET l_n = 0
                SELECT COUNT(*) INTO l_n
                  FROM ooed_tmp
                 WHERE ooedent = g_enterprise
                   AND (ooed004 = g_tree[l_ac1].b_id
                       OR ooed005 = g_tree[l_ac1].b_id)
                   AND ooed002 = g_ooeb_m.ooeb005
                   AND ooed001 = g_ooeb_m.ooeb004
                IF l_n = 0 AND NOT cl_null(g_tree[l_ac1].b_id) THEN
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.code = 'aoo-00130'
                   LET g_errparam.extend = g_tree[l_ac1].b_id
                   LET g_errparam.popup = FALSE
                   CALL cl_err()

                ELSE
                   IF l_source == "RIGHT" THEN
                      LET l_ac1 = l_dnd.getLocationRow()
                      CALL l_dnd.dropInternal()
                      SELECT MAX(ooec002)+1 INTO l_ooec002
                        FROM ooec_t
                       WHERE ooec001 = g_ooeb_m.ooeb001
                         AND ooecent = g_enterprise
                      IF cl_null(l_ooec002) THEN
                         LET l_ooec002 = 1
                      END IF
                      IF g_tree[l_ac1].b_pid = "ROOT" THEN
                         LET g_tree[l_ac1].b_pid = g_tree[l_ac1].b_id
                      END IF
                      IF cl_null(g_tree[l_ac1].b_id) THEN
                         LET arr_right[l_ac1] = l_value
                         LET g_tree[l_ac1].b_pid = arr_right[l_ac1]
                         LET g_tree[l_ac1].b_id = arr_right[l_ac1]
                      END IF
                      INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005)
                                  VALUES(g_enterprise,g_ooeb_m.ooeb001,l_ooec002,2,l_ooec004_t,l_ooec005_t)
                      INSERT INTO ooec_t(ooecent,ooec001,ooec002,ooec003,ooec004,ooec005)
                                  VALUES(g_enterprise,g_ooeb_m.ooeb001,l_ooec002+1,1,g_tree[l_ac1].b_id,g_tree[l_ac1].b_pid)
                      IF cl_null(g_tree[l_ac1].b_show) THEN
                         CALL g_tree.deleteElement(l_ac1)
                      END IF
                      CALL aooi110_b_fill()
                   ELSE
                      LET l_ac2 = l_dnd.getLocationRow()
                      LET l_ooec004 = g_tree[l_ac2].b_id
                      CALL DIALOG.insertRow("s_tree",l_ac1)
                      CALL DIALOG.setCurrentRow("s_tree",l_ac1)
                      IF cl_null(l_ac1) THEN
                         LET l_ac1 = l_dnd.getLocationRow()
                      END IF
                      LET arr_right[l_ac1] = l_value
                      LET g_tree[l_ac1].b_show =  arr_right[l_ac1]
                      LET g_tree[l_ac1].b_id =  arr_right[l_ac1]
                      LET g_tree[l_ac1].b_pid =  l_ooec004
                      IF cl_null(g_tree[l_ac2+1].b_show) THEN
                         CALL DIALOG.deleteRow("s_tree",l_ac2+1)
                         CALL g_tree.deleteElement(l_ac2+1)
                      END IF
                      CALL DIALOG.deleteRow("s_detail1",l_ac)
                      DELETE FROM ooec_t
                       WHERE ooec001 = g_ooeb_m.ooeb001
                         AND ooecent = g_enterprise
                         AND ooec002 = l_ooec002_1
                      CALL aooi110_b_fill()
                   END IF
                END IF


         END DISPLAY
         #end add-point

         #該樣板不需此段落SUBDIALOG lib_cl_dlg.dlg_qryplan
         #該樣板不需此段落SUBDIALOG lib_cl_dlg.dlg_relateapps

         BEFORE DIALOG
            #調整
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_page = "first"
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            #該樣板不需此段落LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            #該樣板不需此段落IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
            #該樣板不需此段落   CALL DIALOG.setCurrentRow("s_browse",g_current_row)
            #該樣板不需此段落   LET g_current_idx = g_current_row
            #該樣板不需此段落END IF
           #IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
            IF g_current_row > 1 AND g_current_sw = FALSE THEN
               LET g_current_idx = g_current_row
            END IF

            LET g_current_row = g_current_idx #目前指標
            IF g_current_idx = 0 THEN
               LET g_current_idx = 1
            END IF
            LET g_current_sw = TRUE

            IF g_current_idx > g_browser.getLength() THEN
               LET g_current_idx = g_browser.getLength()
            END IF

            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL aooi110_fetch('') # reload data
            END IF
            CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
            LET g_detail_idx = 1
            CALL aooi110_ui_detailshow() #Setting the current row

            #筆數顯示
            LET g_current_page = 1
            CALL aooi110_idx_chk()

            #add-point:ui_dialog段before_dialog
            {<point name="ui_dialog.before_dialog"/>}
            #end add-point

            #NEXT FIELD ooec002

         ON ACTION statechange
            CALL aooi110_statechange()
            LET g_action_choice = "statechange"
            EXIT DIALOG

         #簽核
         ON ACTION signature
            MENU "" ATTRIBUTES( STYLE="popup", IMAGE="tb/authorize/terminate.png" )
               ON ACTION ef_sign
               ON ACTION stop_authflow
               ON ACTION add_auth
               ON ACTION revoke_auth
               ON ACTION approve
               ON ACTION unapprove
               ON ACTION auth_opinion
               ON ACTION auth_status
               ON ACTION auth_attach
               ON ACTION authflow_designer
            END MENU

         #ACTION表單列
         #該樣板不需此段落ON ACTION filter
         #該樣板不需此段落   CALL aooi110_filter()
         #該樣板不需此段落   EXIT DIALOG

         ON ACTION first
            CALL aooi110_del_ooed_tmp()
            CALL aooi110_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aooi110_idx_chk()
            #調整
            EXIT DIALOG
         ON ACTION previous
            CALL aooi110_del_ooed_tmp()
            CALL aooi110_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aooi110_idx_chk()
            #調整
            EXIT DIALOG
         ON ACTION jump
            CALL aooi110_del_ooed_tmp()
            CALL aooi110_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aooi110_idx_chk()
            #調整
            EXIT DIALOG
         ON ACTION next
            CALL aooi110_del_ooed_tmp()
            CALL aooi110_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aooi110_idx_chk()
            #調整
            EXIT DIALOG
         ON ACTION last
            CALL aooi110_del_ooed_tmp()
            CALL aooi110_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aooi110_idx_chk()
            #調整
            EXIT DIALOG
         ON ACTION close
            LET INT_FLAG=FALSE
            LET g_action_choice = "exit"
            EXIT WHILE

         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT WHILE

         #該樣板不需此段落ON ACTION bw_first               #page first
         #該樣板不需此段落   CALL aooi110_browser_fill("F")
         #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
         #該樣板不需此段落   CALL aooi110_fetch('')

         #該樣板不需此段落ON ACTION bw_prev                #page previous
         #該樣板不需此段落   CALL aooi110_browser_fill("P")
         #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
         #該樣板不需此段落   CALL aooi110_fetch('')

         #該樣板不需此段落ON ACTION bw_next                #page next
         #該樣板不需此段落   CALL aooi110_browser_fill("N")
         #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
         #該樣板不需此段落   CALL aooi110_fetch('')

         #該樣板不需此段落ON ACTION bw_last                #page last
         #該樣板不需此段落   CALL aooi110_browser_fill("L")
         #該樣板不需此段落   CALL cl_ui_set_browse_page_button(g_curr_diag,g_page_action,g_pagestart,g_browser_cnt)
         #該樣板不需此段落   CALL aooi110_fetch('')

         ON ACTION mainhidden       #主頁摺疊
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF

         #該樣板不需此段落ON ACTION worksheethidden   #瀏覽頁折疊
         #該樣板不需此段落   IF g_main_hidden THEN
         #該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",0)
         #該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",1)
         #該樣板不需此段落      LET g_main_hidden = 0
         #該樣板不需此段落   ELSE
         #該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",1)
         #該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",0)
         #該樣板不需此段落      LET g_main_hidden = 1
         #該樣板不需此段落   END IF

         ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("worksheet_detail",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("worksheet_detail",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden
            END IF



         ON ACTION modify

            LET g_action_choice="modify"
            IF cl_chk_act_auth() THEN
               CALL aooi110_modify()
               #add-point:ON ACTION modify
               {<point name="menu.modify" />}
               CALL aooi110_del_ooed_tmp()
               #END add-point
               #EXIT DIALOG
                CONTINUE WHILE
            END IF


         ON ACTION confirm

            LET g_action_choice="confirm"
            IF cl_chk_act_auth() THEN
               #add-point:ON ACTION confirm
               CALL aooi110_confirm()
               CALL aooi110_del_ooed_tmp()
               #END add-point
                EXIT DIALOG
            END IF


         ON ACTION insert

            LET g_action_choice="insert"
            IF cl_chk_act_auth() THEN
               CALL aooi110_insert()
               #add-point:ON ACTION insert
               {<point name="menu.insert" />}
               #END add-point
               #EXIT DIALOG
                CONTINUE WHILE
            END IF


         ON ACTION query

            LET g_action_choice="query"
            IF cl_chk_act_auth() THEN
               CALL aooi110_query()
               #add-point:ON ACTION query
               {<point name="menu.query" />}
               CALL aooi110_del_ooed_tmp()
               #END add-point
            END IF


         ON ACTION reproduce

            LET g_action_choice="reproduce"
            IF cl_chk_act_auth() THEN
               CALL aooi110_reproduce()
               #add-point:ON ACTION reproduce
               {<point name="menu.reproduce" />}
               CALL aooi110_del_ooed_tmp()
               #END add-point
                EXIT DIALOG
            END IF


         ON ACTION produce

            LET g_action_choice="produce"
            IF cl_chk_act_auth() THEN
               #add-point:ON ACTION produce
               {<point name="menu.produce" />}
               CALL aooi110_del_ooed_tmp()
               #END add-point
                EXIT DIALOG
            END IF


         ON ACTION output

            LET g_action_choice="output"
            IF cl_chk_act_auth() THEN
               #add-point:ON ACTION output
               {<point name="menu.output" />}
               CALL aooi110_del_ooed_tmp()
               #END add-point
                EXIT DIALOG
            END IF


         ON ACTION delete

            LET g_action_choice="delete"
            IF cl_chk_act_auth() THEN
               CALL aooi110_delete()
               #add-point:ON ACTION delete
               {<point name="menu.delete" />}
               CALL aooi110_del_ooed_tmp()
               #END add-point
               #EXIT DIALOG
                CONTINUE WHILE
            END IF


         #主選單用ACTION
         &include "main_menu.4gl"

         #交談指令共用ACTION
         &include "common_action.4gl"
           #CONTINUE DIALOG

      END DIALOG

   END WHILE

   CALL cl_set_act_visible("accept,cancel", TRUE)

END FUNCTION

#+ 瀏覽頁簽資料搜尋
PRIVATE FUNCTION aooi110_browser_search(p_type)
   {<Local define>}
   DEFINE p_type LIKE type_t.chr10
   {</Local define>}
   #add-point:browser_search段define
   {<point name="browser_search.define"/>}
   #end add-point

   #若無輸入關鍵字則查找出所有資料
   IF NOT cl_null(g_searchstr) AND g_searchcol='0' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00005"
      LET g_errparam.extend = "searchcol"
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN FALSE
   END IF

   IF NOT cl_null(g_searchstr) THEN
      LET g_wc = " lower(", g_searchcol, ") LIKE '%", g_searchstr, "%'"
      LET g_wc = g_wc.toLowerCase()
   ELSE
      LET g_wc = " 1=1 "
   END IF

   #若為排序搜尋則添加以下條件
   IF cl_null(g_searchcol) OR g_searchcol = "0" THEN
      LET g_wc = g_wc, " ORDER BY ooeb001"
   ELSE
      LET g_wc = g_wc, " ORDER BY ", g_searchcol
   END IF

   CALL aooi110_browser_fill("F")
   CALL ui.Interface.refresh()
   RETURN TRUE

END FUNCTION


#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION aooi110_browser_fill(ps_page_action)
   {<Local define>}
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   DEFINE l_searchcol       STRING
   {</Local define>}
   #add-point:browser_fill段define
   DEFINE l_ooed003         LIKE ooed_t.ooed003
   #end add-point

   #清除畫面
   CLEAR FORM
   INITIALIZE g_ooeb_m.* TO NULL
   CALL g_ooec_d.clear()

   CALL g_browser.clear()

   #搜尋用
   IF cl_null(g_searchcol) OR g_searchcol = '0' THEN
      LET l_searchcol = "ooeb001"
   ELSE
      LET l_searchcol = g_searchcol
   END IF

   LET l_wc  = g_wc.trim()
   LET l_wc2 = g_wc2.trim()
   IF cl_null(l_wc) THEN  #p_wc 查詢條件
      RETURN
   END IF

   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE ooeb001 ",

                        " FROM ooeb_t ",
                              " ",
                              " LEFT JOIN ooec_t ON ooecent = ooebent AND ooeb001 = ooec001 ",

                              " ",
                              " ",
                       " WHERE ooebent = '" ||g_enterprise|| "' AND ooecent = '" ||g_enterprise|| "' AND ",l_wc, " AND ", l_wc2

   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE ooeb001 ",

                        " FROM ooeb_t ",
                              " ",
                              " ",
                        "WHERE ooebent = '" ||g_enterprise|| "' AND ",l_wc CLIPPED

   END IF

   LET g_sql = " SELECT COUNT(*) FROM (",l_sub_sql,")"

   PREPARE header_cnt_pre FROM g_sql
   EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
   FREE header_cnt_pre

   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示

   #若超過最大顯示筆數
   #該樣板不需此段落IF g_browser_cnt > g_max_browse THEN
   #該樣板不需此段落   CALL cl_err(g_browser_cnt,'9035',1)
   #該樣板不需此段落END IF

   #LET g_page_action = ps_page_action          # Keep Action

   IF ps_page_action = "F" OR
      ps_page_action = "P" OR
      ps_page_action = "N" OR
      ps_page_action = "L" THEN
      LET g_page_action = ps_page_action
   END IF

   CASE ps_page_action
      WHEN "F"
         LET g_pagestart = 1

      WHEN "P"
         LET g_pagestart = g_pagestart - 1
         IF g_pagestart < 1 THEN
            LET g_pagestart = 1
         END IF

      WHEN "N"
         LET g_pagestart = g_pagestart + 1
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = g_browser_cnt - (g_browser_cnt mod 1) + 1
            WHILE g_pagestart > g_browser_cnt
               LET g_pagestart = g_pagestart - 1
            END WHILE
         END IF

      WHEN "L"
         LET g_pagestart = g_browser_cnt - (g_browser_cnt mod 1) + 1
         WHILE g_pagestart > g_browser_cnt
            LET g_pagestart = g_pagestart - 1
         END WHILE

      WHEN '/'
         LET g_pagestart = g_jump
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = 1
         END IF

   END CASE

   #單身有輸入查詢條件且非null
   IF g_wc2 <> " 1=1" AND NOT cl_null(g_wc2) THEN
      #依照ooeb001 Browser欄位定義(取代原本bs_sql功能)
      LET l_sql_rank = "SELECT DISTINCT ooebstus,ooeb001,DENSE_RANK() OVER(ORDER BY ooeb001 ",g_order,") AS RANK ",
                        " FROM ooeb_t ",
                              " ",
                              " LEFT JOIN ooec_t ON ooecent = ooebent AND ooeb001 = ooec001",

                              " ",
                              " ",
                       " ",
                       " WHERE ooebent = '" ||g_enterprise|| "' AND ",g_wc," AND ",g_wc2
   ELSE
      #單身無輸入資料
      LET l_sql_rank = "SELECT DISTINCT ooebstus,ooeb001,DENSE_RANK() OVER(ORDER BY ooeb001 ",g_order,") AS RANK ",
                       " FROM ooeb_t ",
                            "  ",
                            "  ",
                       " WHERE ooebent = '" ||g_enterprise|| "' AND ", g_wc
   END IF

   #定義翻頁CURSOR
   LET g_sql= "SELECT ooebstus,ooeb001 FROM (",l_sql_rank,") WHERE ",
              " RANK >= ",g_pagestart," AND RANK<",g_pagestart+500, #調整
              " ORDER BY ",l_searchcol," ",g_order

   PREPARE browse_pre FROM g_sql
   DECLARE browse_cur CURSOR FOR browse_pre

   CALL g_browser.clear()
   LET g_cnt = 1
   FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_ooeb001#,g_browser[g_cnt].rank
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF



      #add-point:browser_fill段reference

      #end add-point

            #此段落由子樣板a24產生
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/void.png"

         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirm.png"


      END CASE


      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9035
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT FOREACH
      END IF

   END FOREACH

   CALL g_browser.deleteElement(g_cnt)
   LET g_header_cnt = g_browser.getLength()

   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0

   FREE browse_pre

   #add-point:browser_fill段結束前
   #調整 - 此段落刪除
   #end add-point

END FUNCTION


#+ 單頭資料重新顯示
PRIVATE FUNCTION aooi110_ui_headershow()
   #add-point:ui_headershow段define
   {<point name="ui_headershow.define"/>}
   #end add-point

   LET g_ooeb_m.ooeb001 = g_browser[g_current_idx].b_ooeb001

    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   CALL aooi110_show()

END FUNCTION


#+ 單身資料重新顯示
PRIVATE FUNCTION aooi110_ui_detailshow()
   #add-point:ui_detailshow段define
   {<point name="ui_detailshow.define"/>}
   #end add-point

   #add-point:ui_detailshow段before
   {<point name="ui_detailshow.before"/>}
   #end add-point

   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)

   END IF

   #add-point:ui_detailshow段after
   {<point name="ui_detailshow.after"/>}
   #end add-point

END FUNCTION


#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION aooi110_ui_browser_refresh()
   {<Local define>}
   DEFINE l_i  LIKE type_t.num10
   {</Local define>}
   #add-point:ui_browser_refresh段define
   {<point name="ui_browser_refresh.define"/>}
   #end add-point

   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_ooeb001 = g_ooeb_m.ooeb001

         THEN
         CALL g_browser.deleteElement(l_i)
         LET g_header_cnt = g_header_cnt - 1
      END IF
   END FOR

   LET g_browser_cnt = g_browser_cnt - 1
   IF g_current_row > g_browser_cnt THEN        #確定browse 筆數指在同一筆
      LET g_current_row = g_browser_cnt
   END IF

   #DISPLAY g_browser_cnt TO FORMONLY.b_count    #總筆數的顯示

END FUNCTION


#+ QBE資料查詢
PRIVATE FUNCTION aooi110_construct()

   {<Local define>}
   DEFINE lc_qbe_sn   LIKE type_t.num10
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING
   {</Local define>}
   #add-point:cs段define
   {<point name="cs.define"/>}
   #end add-point

   #清除畫面
   CLEAR FORM
   INITIALIZE g_ooeb_m.* TO NULL
   CALL g_ooec_d.clear()


   LET g_current_idx = 1
   LET g_action_choice = ""

   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL

   INITIALIZE g_wc_table1 TO NULL


   LET g_qryparam.state = 'c'

   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭
      CONSTRUCT BY NAME g_wc ON ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt

         BEFORE CONSTRUCT
            CALL cl_qbe_init()
            #add-point:cs段more_construct
            {<point name="cs.head.before_construct"/>}
            #end add-point

         #公用欄位開窗相關處理
         #此段落由子樣板a11產生---
         ##----<<ooebownid>>----
         #ON ACTION controlp INFIELD ooebownid
         #   CALL q_common('ooeb_t','ooebownid',TRUE,FALSE,g_ooeb_m.ooebownid) RETURNING ls_return
         #   DISPLAY ls_return TO ooebownid
         #   NEXT FIELD ooebownid
         #
         ##----<<ooebowndp>>----
         #ON ACTION controlp INFIELD ooebowndp
         #   CALL q_common('ooeb_t','ooebowndp',TRUE,FALSE,g_ooeb_m.ooebowndp) RETURNING ls_return
         #   DISPLAY ls_return TO ooebowndp
         #   NEXT FIELD ooebowndp
         #
         ##----<<ooebcrtid>>----
         #ON ACTION controlp INFIELD ooebcrtid
         #   CALL q_common('ooeb_t','ooebcrtid',TRUE,FALSE,g_ooeb_m.ooebcrtid) RETURNING ls_return
         #   DISPLAY ls_return TO ooebcrtid
         #   NEXT FIELD ooebcrtid
		 #
         ##----<<ooebcrtdp>>----
         #ON ACTION controlp INFIELD ooebcrtdp
         #   CALL q_common('ooeb_t','ooebcrtdp',TRUE,FALSE,g_ooeb_m.ooebcrtdp) RETURNING ls_return
         #   DISPLAY ls_return TO ooebcrtdp
         #   NEXT FIELD ooebcrtdp
         #
         ##----<<ooebmodid>>----
         #ON ACTION controlp INFIELD ooebmodid
         #   CALL q_common('ooeb_t','ooebmodid',TRUE,FALSE,g_ooeb_m.ooebmodid) RETURNING ls_return
         #   DISPLAY ls_return TO ooebmodid
         #   NEXT FIELD ooebmodid
		 #
         ##----<<ooeb>>----
         ##ON ACTION controlp INFIELD ooeb
         ##   CALL q_common('ooeb_t','ooeb',TRUE,FALSE,g_ooeb_m.ooeb) RETURNING ls_return
         ##   DISPLAY ls_return TO ooeb
         ##   NEXT FIELD ooeb
		 #
         ##----<<ooeb>>----
         ##ON ACTION controlp INFIELD ooeb
         ##   CALL q_common('ooeb_t','ooeb',TRUE,FALSE,g_ooeb_m.ooeb) RETURNING ls_return
         ##   DISPLAY ls_return TO ooeb
         ##   NEXT FIELD ooeb
		
         ##----<<ooebcrtdt>>----
         #AFTER FIELD ooebcrtdt
         #   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         #   IF NOT cl_null(ls_result) THEN
         #      IF NOT cl_chk_date_symbol(ls_result) THEN
         #         LET ls_result = cl_add_date_extra_cond(ls_result)
         #      END IF
         #   END IF
         #   CALL FGL_DIALOG_SETBUFFER(ls_result)
         #
         ##----<<ooebmoddt>>----
         #AFTER FIELD ooebmoddt
         #   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         #   IF NOT cl_null(ls_result) THEN
         #      IF NOT cl_chk_date_symbol(ls_result) THEN
         #         LET ls_result = cl_add_date_extra_cond(ls_result)
         #      END IF
         #   END IF
         #   CALL FGL_DIALOG_SETBUFFER(ls_result)
         #
		 ##----<<ooeb>>----
         ##AFTER FIELD ooeb
         ##   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         ##   IF NOT cl_null(ls_result) THEN
         ##      IF NOT cl_chk_date_symbol(ls_result) THEN
         ##         LET ls_result = cl_add_date_extra_cond(ls_result)
         ##      END IF
         ##   END IF
         ##   CALL FGL_DIALOG_SETBUFFER(ls_result)
		 #
         ##----<<ooeb>>----
         ##AFTER FIELD ooeb
         ##   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         ##   IF NOT cl_null(ls_result) THEN
         ##      IF NOT cl_chk_date_symbol(ls_result) THEN
         ##         LET ls_result = cl_add_date_extra_cond(ls_result)
         ##      END IF
         ##   END IF
         ##   CALL FGL_DIALOG_SETBUFFER(ls_result)



         #一般欄位開窗相關處理
         #---------------------------<  Master  >---------------------------
         #----<<ooeb001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb001
            #add-point:BEFORE FIELD ooeb001
            {<point name="construct.b.ooeb001" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb001

            #add-point:AFTER FIELD ooeb001
            {<point name="construct.a.ooeb001" />}
            #END add-point


         #Ctrlp:construct.c.ooeb001
#         ON ACTION controlp INFIELD ooeb001
            #add-point:ON ACTION controlp INFIELD ooeb001
            {<point name="construct.c.ooeb001" />}
            #END add-point

         #----<<ooeb002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb002
            #add-point:BEFORE FIELD ooeb002
            {<point name="construct.b.ooeb002" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb002

            #add-point:AFTER FIELD ooeb002
            {<point name="construct.a.ooeb002" />}
            #END add-point


         #Ctrlp:construct.c.ooeb002
#         ON ACTION controlp INFIELD ooeb002
            #add-point:ON ACTION controlp INFIELD ooeb002
            {<point name="construct.c.ooeb002" />}
            #END add-point

         #----<<ooeb003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb003
            #add-point:BEFORE FIELD ooeb003
            {<point name="construct.b.ooeb003" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb003

            #add-point:AFTER FIELD ooeb003
            {<point name="construct.a.ooeb003" />}
            #END add-point


         #Ctrlp:construct.c.ooeb003
#         ON ACTION controlp INFIELD ooeb003
            #add-point:ON ACTION controlp INFIELD ooeb003
            {<point name="construct.c.ooeb003" />}
            #END add-point

         #----<<ooeb004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb004
            #add-point:BEFORE FIELD ooeb004
            {<point name="construct.b.ooeb004" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb004

            #add-point:AFTER FIELD ooeb004
            {<point name="construct.a.ooeb004" />}
            #END add-point


         #Ctrlp:construct.c.ooeb004
#         ON ACTION controlp INFIELD ooeb004
            #add-point:ON ACTION controlp INFIELD ooeb004
            {<point name="construct.c.ooeb004" />}
            #END add-point

         #----<<ooeb005>>----
         #Ctrlp:construct.c.ooeb005
         ON ACTION controlp INFIELD ooeb005
            #add-point:ON ACTION controlp INFIELD ooeb005
#此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooeb005  #顯示到畫面上

            NEXT FIELD ooeb005                     #返回原欄位


            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD ooeb005
            #add-point:BEFORE FIELD ooeb005
            {<point name="construct.b.ooeb005" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb005

            #add-point:AFTER FIELD ooeb005
            {<point name="construct.a.ooeb005" />}
            #END add-point


         #----<<ooeb006>>----
         #Ctrlp:construct.c.ooeb006
         ON ACTION controlp INFIELD ooeb006
            #add-point:ON ACTION controlp INFIELD ooeb006
#此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooed003()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO ooeb006  #顯示到畫面上

            NEXT FIELD ooeb006                     #返回原欄位


            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD ooeb006
            #add-point:BEFORE FIELD ooeb006
            {<point name="construct.b.ooeb006" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb006

            #add-point:AFTER FIELD ooeb006
            {<point name="construct.a.ooeb006" />}
            #END add-point


         #----<<ooeb007>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb007
            #add-point:BEFORE FIELD ooeb007
            {<point name="construct.b.ooeb007" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb007

            #add-point:AFTER FIELD ooeb007
            {<point name="construct.a.ooeb007" />}
            #END add-point


         #Ctrlp:construct.c.ooeb007
#         ON ACTION controlp INFIELD ooeb007
            #add-point:ON ACTION controlp INFIELD ooeb007
            {<point name="construct.c.ooeb007" />}
            #END add-point

         #----<<ooeb008>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb008
            #add-point:BEFORE FIELD ooeb008
            {<point name="construct.b.ooeb008" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb008

            #add-point:AFTER FIELD ooeb008
            {<point name="construct.a.ooeb008" />}
            #END add-point


         #Ctrlp:construct.c.ooeb008
#         ON ACTION controlp INFIELD ooeb008
            #add-point:ON ACTION controlp INFIELD ooeb008
            {<point name="construct.c.ooeb008" />}
            #END add-point

         #----<<ooebstus>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebstus
            #add-point:BEFORE FIELD ooebstus
            {<point name="construct.b.ooebstus" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebstus

            #add-point:AFTER FIELD ooebstus
            {<point name="construct.a.ooebstus" />}
            #END add-point


         #Ctrlp:construct.c.ooebstus
#         ON ACTION controlp INFIELD ooebstus
            #add-point:ON ACTION controlp INFIELD ooebstus
            {<point name="construct.c.ooebstus" />}
            #END add-point

         #----<<ooebmodid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmodid
            #add-point:BEFORE FIELD ooebmodid
            {<point name="construct.b.ooebmodid" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebmodid

            #add-point:AFTER FIELD ooebmodid
            {<point name="construct.a.ooebmodid" />}
            #END add-point


         #Ctrlp:construct.c.ooebmodid
#         ON ACTION controlp INFIELD ooebmodid
            #add-point:ON ACTION controlp INFIELD ooebmodid
            {<point name="construct.c.ooebmodid" />}
            #END add-point

         #----<<ooebmoddt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmoddt
            #add-point:BEFORE FIELD ooebmoddt
            {<point name="construct.b.ooebmoddt" />}
            #END add-point

         #----<<ooebownid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebownid
            #add-point:BEFORE FIELD ooebownid
            {<point name="construct.b.ooebownid" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebownid

            #add-point:AFTER FIELD ooebownid
            {<point name="construct.a.ooebownid" />}
            #END add-point


         #Ctrlp:construct.c.ooebownid
#         ON ACTION controlp INFIELD ooebownid
            #add-point:ON ACTION controlp INFIELD ooebownid
            {<point name="construct.c.ooebownid" />}
            #END add-point

         #----<<ooebowndp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebowndp
            #add-point:BEFORE FIELD ooebowndp
            {<point name="construct.b.ooebowndp" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebowndp

            #add-point:AFTER FIELD ooebowndp
            {<point name="construct.a.ooebowndp" />}
            #END add-point


         #Ctrlp:construct.c.ooebowndp
#         ON ACTION controlp INFIELD ooebowndp
            #add-point:ON ACTION controlp INFIELD ooebowndp
            {<point name="construct.c.ooebowndp" />}
            #END add-point

         #----<<ooebcrtid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtid
            #add-point:BEFORE FIELD ooebcrtid
            {<point name="construct.b.ooebcrtid" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtid

            #add-point:AFTER FIELD ooebcrtid
            {<point name="construct.a.ooebcrtid" />}
            #END add-point


         #Ctrlp:construct.c.ooebcrtid
#         ON ACTION controlp INFIELD ooebcrtid
            #add-point:ON ACTION controlp INFIELD ooebcrtid
            {<point name="construct.c.ooebcrtid" />}
            #END add-point

         #----<<ooebcrtdp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdp
            #add-point:BEFORE FIELD ooebcrtdp
            {<point name="construct.b.ooebcrtdp" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtdp

            #add-point:AFTER FIELD ooebcrtdp
            {<point name="construct.a.ooebcrtdp" />}
            #END add-point


         #Ctrlp:construct.c.ooebcrtdp
#         ON ACTION controlp INFIELD ooebcrtdp
            #add-point:ON ACTION controlp INFIELD ooebcrtdp
            {<point name="construct.c.ooebcrtdp" />}
            #END add-point

         #----<<ooebcrtdt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdt
            #add-point:BEFORE FIELD ooebcrtdt
            {<point name="construct.b.ooebcrtdt" />}
            #END add-point



      END CONSTRUCT

      #單身根據table分拆construct
      CONSTRUCT g_wc_table1 ON ooec002,ooec003,ooec004,ooec005
           FROM s_detail1[1].ooec002,s_detail1[1].ooec003,s_detail1[1].ooec004,s_detail1[1].ooec005

         BEFORE CONSTRUCT
            CALL cl_qbe_display_condition(lc_qbe_sn)
            #add-point:cs段more_construct
            {<point name="cs.body.before_construct"/>}
            #end add-point

       #單身公用欄位開窗相關處理


       #單身一般欄位開窗相關處理
       #---------------------<  Detail: page1  >---------------------
         #----<<ooec002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooec002
            #add-point:BEFORE FIELD ooec002
            {<point name="construct.b.page1.ooec002" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooec002

            #add-point:AFTER FIELD ooec002
            {<point name="construct.a.page1.ooec002" />}
            #END add-point


         #Ctrlp:construct.c.ooec002
#         ON ACTION controlp INFIELD ooec002
            #add-point:ON ACTION controlp INFIELD ooec002
            {<point name="construct.c.page1.ooec002" />}
            #END add-point

         #----<<ooec003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooec003
            #add-point:BEFORE FIELD ooec003
            {<point name="construct.b.page1.ooec003" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooec003

            #add-point:AFTER FIELD ooec003
            {<point name="construct.a.page1.ooec003" />}
            #END add-point


         #Ctrlp:construct.c.ooec003
#         ON ACTION controlp INFIELD ooec003
            #add-point:ON ACTION controlp INFIELD ooec003
            {<point name="construct.c.page1.ooec003" />}
            #END add-point

         #----<<ooec004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooec004
            #add-point:BEFORE FIELD ooec004
            {<point name="construct.b.page1.ooec004" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooec004

            #add-point:AFTER FIELD ooec004
            {<point name="construct.a.page1.ooec004" />}
            #END add-point


         #Ctrlp:construct.c.ooec004
#         ON ACTION controlp INFIELD ooec004
            #add-point:ON ACTION controlp INFIELD ooec004
            {<point name="construct.c.page1.ooec004" />}
            #END add-point

         #----<<ooec005>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooec005
            #add-point:BEFORE FIELD ooec005
            {<point name="construct.b.page1.ooec005" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooec005

            #add-point:AFTER FIELD ooec005
            {<point name="construct.a.page1.ooec005" />}
            #END add-point


         #Ctrlp:construct.c.ooec005
#         ON ACTION controlp INFIELD ooec005
            #add-point:ON ACTION controlp INFIELD ooec005
            {<point name="construct.c.page1.ooec005" />}
            #END add-point



      END CONSTRUCT



      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令)
      {<point name="cs.add_cs"/>}
      #end add-point

      BEFORE DIALOG
         #add-point:cs段b_dialog
         {<point name="cs.b_dialog"/>}
         #end add-point

      ON ACTION qbe_select     #條件查詢
         CALL cl_qbe_list() RETURNING lc_qbe_sn
         CALL cl_qbe_display_condition(lc_qbe_sn)

      ON ACTION qbe_save       #條件儲存
         CALL cl_qbe_save()

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG

   #組合g_wc2
   LET g_wc2 = g_wc_table1


   IF INT_FLAG THEN
      RETURN
   END IF

END FUNCTION

#該樣板不需此段落#+ filter過濾功能
PRIVATE FUNCTION aooi110_filter()
#該樣板不需此段落   {<Local define>}
#該樣板不需此段落   {</Local define>}
#該樣板不需此段落   #add-point:filter段define
#該樣板不需此段落   {<point name="filter.define"/>}
#該樣板不需此段落   #end add-point

#該樣板不需此段落   #切換畫面
#該樣板不需此段落   IF NOT g_main_hidden THEN
#該樣板不需此段落      CALL gfrm_curr.setElementHidden("mainlayout",1)
#該樣板不需此段落      CALL gfrm_curr.setElementHidden("worksheet",0)
#該樣板不需此段落      LET g_main_hidden = 1
#該樣板不需此段落   END IF

#該樣板不需此段落   LET INT_FLAG = 0

#該樣板不需此段落   LET g_qryparam.state = 'c'

#該樣板不需此段落   LET g_wc_filter_t = g_wc_filter
#該樣板不需此段落   LET g_wc_t = g_wc

#該樣板不需此段落   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')

#該樣板不需此段落   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
#該樣板不需此段落   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

#該樣板不需此段落      #單頭
#該樣板不需此段落      CONSTRUCT g_wc_filter ON
#該樣板不需此段落                          FROM

#該樣板不需此段落         BEFORE CONSTRUCT
#該樣板不需此段落            CALL cl_qbe_init()
#該樣板不需此段落

#該樣板不需此段落      END CONSTRUCT

      #add-point:filter段add_cs
      {<point name="filter.add_cs"/>}
      #end add-point

#該樣板不需此段落      BEFORE DIALOG
         #add-point:filter段b_dialog
         {<point name="filter.b_dialog"/>}
         #end add-point

#該樣板不需此段落      ON ACTION accept
#該樣板不需此段落         ACCEPT DIALOG

#該樣板不需此段落      ON ACTION cancel
#該樣板不需此段落         LET INT_FLAG = 1
#該樣板不需此段落         EXIT DIALOG

#該樣板不需此段落      #交談指令共用ACTION
#該樣板不需此段落      &include "common_action.4gl"
#該樣板不需此段落         CONTINUE DIALOG

#該樣板不需此段落   END DIALOG

#該樣板不需此段落   IF NOT INT_FLAG THEN
#該樣板不需此段落      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
#該樣板不需此段落      LET g_wc = g_wc , g_wc_filter
#該樣板不需此段落   ELSE
#該樣板不需此段落      LET g_wc_filter = g_wc_filter_t
#該樣板不需此段落      LET g_wc = g_wc_t
#該樣板不需此段落   END IF

#該樣板不需此段落

END FUNCTION


#+ filter過濾功能
PRIVATE FUNCTION aooi110_filter_parser(ps_field)
   {<Local define>}
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   {</Local define>}
#該樣板不需此段落   #add-point:filter段define
#該樣板不需此段落   {<point name="filter_parser.define"/>}
#該樣板不需此段落   #end add-point

#該樣板不需此段落   #一般條件解析
#該樣板不需此段落   LET ls_tmp = ps_field, "='"
#該樣板不需此段落   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
#該樣板不需此段落   IF li_tmp > 0 THEN
#該樣板不需此段落      LET li_tmp = ls_tmp.getLength() + li_tmp
#該樣板不需此段落      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
#該樣板不需此段落      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
#該樣板不需此段落   END IF

#該樣板不需此段落   #模糊條件解析
#該樣板不需此段落   LET ls_tmp = ps_field, " like '"
#該樣板不需此段落   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
#該樣板不需此段落   IF li_tmp > 0 THEN
#該樣板不需此段落      LET li_tmp = ls_tmp.getLength() + li_tmp
#該樣板不需此段落      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
#該樣板不需此段落      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
#該樣板不需此段落      LET ls_var = cl_replace_str(ls_var,'%','*')
#該樣板不需此段落   END IF

#該樣板不需此段落   RETURN ls_var

END FUNCTION


#+ 顯示過濾條件
#該樣板不需此段落PRIVATE FUNCTION aooi110_filter_show(ps_field)
#該樣板不需此段落   DEFINE ps_field         STRING
#該樣板不需此段落   DEFINE lnode_item       om.DomNode
#該樣板不需此段落   DEFINE ls_title         STRING
#該樣板不需此段落   DEFINE ls_name          STRING
#該樣板不需此段落   DEFINE ls_condition     STRING

#該樣板不需此段落   LET ls_name = "formonly.b_", ps_field

#該樣板不需此段落   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
#該樣板不需此段落   LET ls_title = lnode_item.getAttribute("text")
#該樣板不需此段落   IF ls_title.getIndexOf('※',1) > 0 THEN
#該樣板不需此段落      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
#該樣板不需此段落   END IF

#該樣板不需此段落   #顯示資料組合
#該樣板不需此段落   LET ls_condition = aooi110_filter_parser(ps_field)
#該樣板不需此段落   IF NOT cl_null(ls_condition) THEN
#該樣板不需此段落      LET ls_title = ls_title, '※', ls_condition, '※'
#該樣板不需此段落   END IF

#該樣板不需此段落   #將資料顯示回去
#該樣板不需此段落   CALL lnode_item.setAttribute("text",ls_title)

#該樣板不需此段落END FUNCTION

#+ 資料查詢QBE功能準備
PRIVATE FUNCTION aooi110_query()
   #add-point:query段define
   {<point name="query.define"/>}
   #end add-point

   #切換畫面
   #該樣板不需此段落IF g_main_hidden THEN
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("mainlayout",0)
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("worksheet",1)
   #該樣板不需此段落   LET g_main_hidden = 0
   #該樣板不需此段落END IF

   LET INT_FLAG = 0
   LET g_detail_cnt = 0
   LET g_current_idx = 0
   LET g_current_row = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""

   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()
   CALL g_ooec_d.clear()

   DISPLAY ' ' TO FORMONLY.idx
   DISPLAY ' ' TO FORMONLY.cnt
   DISPLAY ' ' TO FORMONLY.b_index
   DISPLAY ' ' TO FORMONLY.b_count
   DISPLAY ' ' TO FORMONLY.h_index
   DISPLAY ' ' TO FORMONLY.h_count

   CALL aooi110_construct()

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      INITIALIZE g_ooeb_m.* TO NULL
      LET g_wc = " 1=1"
      LET g_wc2 = " 1=1"
      RETURN
   END IF

   LET g_wc_filter = ""
   #該樣板不需此段落
   CALL aooi110_browser_fill("F")

   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "-100"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()

   ELSE
      CALL aooi110_fetch("F")
   END IF

END FUNCTION


#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION aooi110_fetch(p_flag)
   {<Local define>}
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #調整
   DEFINE l_ooed003         LIKE ooed_t.ooed003
   DEFINE l_pid             LIKE type_t.chr100
   DEFINE l_pid_1           LIKE type_t.chr100
   DEFINE l_n               LIKE type_t.num5
   {</Local define>}
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point

   IF g_browser_cnt = 0 THEN
      RETURN
   END IF

   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt
      WHEN 'P'
         IF g_current_idx > 1 THEN
            LET g_current_idx = g_current_idx - 1
         END IF
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF
      WHEN '/'
         IF (NOT g_no_ask) THEN
            CALL cl_set_act_visible("accept,cancel", TRUE)
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0

            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl"
            END PROMPT

            CALL cl_set_act_visible("accept,cancel", FALSE)
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE
            END IF
         END IF

         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF

         LET g_no_ask = FALSE
   END CASE

   #調整
   #CALL aooi110_browser_fill(p_flag)

   #該樣板不需此段落CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引

   LET g_detail_cnt = g_header_cnt

   #單身總筆數顯示
   LET g_detail_idx = 1
   IF g_detail_cnt > 0 THEN
      LET g_detail_idx = 1
      DISPLAY g_detail_idx TO FORMONLY.idx
   ELSE
      LET g_detail_idx = 0
      DISPLAY ' ' TO FORMONLY.idx
   END IF

   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數

   #該樣板不需此段落CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   #調整
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )

   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF

   #超出範圍
   IF g_current_idx > g_browser.getLength() THEN
      LET g_current_idx = g_browser.getLength()
   END IF

   LET g_ooeb_m.ooeb001 = g_browser[g_current_idx].b_ooeb001


   #重讀DB,因TEMP有不被更新特性
    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "ooeb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      INITIALIZE g_ooeb_m.* TO NULL
      RETURN
   END IF

   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      #此段落由子樣板a20產生
      IF g_ooeb_m.ooebstus = "Y" THEN
         CALL cl_set_act_visible("statechange,modify,delete,reproduce", TRUE)
      ELSE
         CALL cl_set_act_visible("statechange,reproduce", TRUE)
         CALL cl_set_act_visible("modify,delete", FALSE)
      END IF


   END IF



   #add-point:fetch結束前
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      #此段落由子樣板a20產生
      IF g_ooeb_m.ooebstus = "Y" THEN
         CALL cl_set_act_visible("modify,delete,reproduce",FALSE)
      ELSE
         CALL cl_set_act_visible("statechange",TRUE)
         CALL cl_set_act_visible("modify,delete",TRUE)
      END IF
   END IF

   #調整
   SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
     INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,
          g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
     FROM ooeb_t
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "ooeb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      INITIALIZE g_ooeb_m.* TO NULL
      RETURN
   END IF
   CALL aooi110_tree_tmp_fill()
  #CALL g_tree.clear()
  #LET g_cnt = 1
  #LET g_sql = " SELECT DISTINCT ooed002,ooed003 FROM ooed_t ",
  #            "  WHERE ooedent = '" ||g_enterprise|| "' ",
  #            "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
  #            "    AND ooed006 <= '",g_today,"' ",
  #            "    AND ooed007 >= '",g_today,"' ",
  #            "  ORDER BY ooed002 "
  #PREPARE browse_1_pre FROM g_sql
  #DECLARE browse_1_cur CURSOR FOR browse_1_pre
  #FOREACH browse_1_cur INTO l_pid,l_ooed003
  #   IF SQLCA.sqlcode THEN
  #      INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

  #      EXIT FOREACH
  #   END IF
  #   LET g_tree[g_cnt].b_pid = "ROOT"
  #   LET g_tree[g_cnt].b_id = l_pid
  #   LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id,'(',l_ooed003,')'
  #   LET g_tree[g_cnt].b_hasC = TRUE
  #   LET g_cnt = g_cnt +1
  #   LET g_sql = " SELECT DISTINCT ooed004,ooed005 FROM ooed_t ",
  #               "  WHERE ooedent = '" ||g_enterprise|| "' ",
  #               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
  #               "    AND ooed006 <= '",g_today,"' ",
  #               "    AND ooed007 >= '",g_today,"' ",
  #               "    AND ooed004 <> '",l_pid,"' ",
  #               "    AND ooed002 = '",l_pid,"' ",
  #               "  ORDER BY ooed005,ooed004 "
  #   PREPARE browse_2_pre FROM g_sql
  #   DECLARE browse_2_cur CURSOR FOR browse_2_pre
  #   FOREACH browse_2_cur INTO g_tree[g_cnt].b_id,g_tree[g_cnt].b_pid
  #      IF SQLCA.sqlcode THEN
  #         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

  #         EXIT FOREACH
  #      END IF
  #      LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id
  #      LET g_cnt = g_cnt +1
  #   END FOREACH
  #   FREE browse_2_pre
  #END FOREACH
  #FREE browse_1_pre
  #CALL g_tree.deleteElement(g_cnt)
   #end add-point

   #LET g_data_owner = g_ooeb_m.ooebcrtid
   #LET g_data_group = g_ooeb_m.ooebcrtdp

   #重新顯示
   CALL aooi110_show()

END FUNCTION


#+ Tree子節點展開
PRIVATE FUNCTION aooi110_tree_expand(p_typevalue,p_id)
   {<Local define>}
   DEFINE p_id          LIKE type_t.num10
   DEFINE l_id          LIKE type_t.num10
   DEFINE l_typevalue   LIKE type_t.chr50
   DEFINE l_typevalue1  LIKE type_t.chr50
   DEFINE p_typevalue   LIKE type_t.chr50
   DEFINE l_sql         LIKE type_t.chr500
   DEFINE l_return      LIKE type_t.num5
   {</Local define>}
   #add-point:browser_expand段define
   {<point name="browser_expand.define"/>}
   #end add-point

   #若已經展開
   IF g_tree[p_id].b_isExp = 1 THEN
      RETURN
   END IF

   LET l_return = FALSE

   LET l_typevalue = p_typevalue
   LET l_typevalue1 = g_tree[p_id].b_id
  #LET l_id = p_id + 1
  #CALL g_tree.insertElement(l_id)
   LET g_cnt = p_id + 1
   CALL g_tree.insertElement(g_cnt)
   LET g_sql = " SELECT DISTINCT ooed004,ooed005 FROM ooed_t ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed006 <= '",g_today,"' ",
               "    AND ooed007 >= '",g_today,"' ",
               "    AND ooed004 <> '",l_typevalue,"' ",
               "    AND ooed004 <> '",l_typevalue1,"' ",
               "    AND ooed005 = '",l_typevalue1,"' ",
               "    AND ooed002 = '",l_typevalue,"' ",
               "  ORDER BY ooed005,ooed004 "
   PREPARE browse_3_pre FROM g_sql
   DECLARE browse_3_cur CURSOR FOR browse_3_pre
  #FOREACH browse_3_cur INTO g_tree[l_id].b_id,g_tree[l_id].b_pid
  #   IF SQLCA.sqlcode THEN
  #      INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

  #      EXIT FOREACH
  #   END IF
  #   LET g_tree[l_id].b_show =  g_tree[l_id].b_id
  #   LET g_tree[l_id].b_hasC = aooi110_chk_hasC(l_typevalue,g_tree[l_id].b_id)
  #   IF g_tree[l_id].b_hasC THEN
  #      LET g_tree[l_id].b_exp = TRUE
  #      CALL aooi110_tree_expand(l_typevalue,l_id)
  #   END IF
  #   LET l_id = l_id +1
  #   LET l_return = TRUE
  #END FOREACH
  #FREE browse_3_pre
  #CALL g_tree.deleteElement(l_id)
   FOREACH browse_3_cur INTO g_tree[g_cnt].b_id,g_tree[g_cnt].b_pid
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id
      LET g_tree[g_cnt].b_hasC = aooi110_chk_hasC(l_typevalue,g_tree[g_cnt].b_id)
      IF g_tree[g_cnt].b_hasC THEN
         LET g_tree[g_cnt].b_exp = TRUE
         CALL aooi110_tree_expand(l_typevalue,g_cnt)
      END IF
      LET g_cnt = g_cnt +1
      LET l_return = TRUE
   END FOREACH
   FREE browse_3_pre
   CALL g_tree.deleteElement(g_cnt)
   LET g_cnt = g_cnt - 1

END FUNCTION

PRIVATE FUNCTION aooi110_chk_hasC(l_typevalue,l_typevalue1)
   DEFINE li_cnt        INTEGER
   DEFINE l_typevalue   LIKE type_t.chr50
   DEFINE l_typevalue1  LIKE type_t.chr50

   LET g_sql = " SELECT COUNT(*) FROM ooed_t ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed006 <= '",g_today,"' ",
               "    AND ooed007 >= '",g_today,"' ",
               "    AND ooed004 <> '",l_typevalue,"' ",
               "    AND ooed004 <> '",l_typevalue1,"' ",
               "    AND ooed005 =  '",l_typevalue1,"' ",
               "    AND ooed002 = '",l_typevalue,"' "
   PREPARE aooi110_check_hasc FROM g_sql
   EXECUTE aooi110_check_hasc INTO li_cnt

   IF li_cnt > 0 THEN
      RETURN TRUE
   ELSE
      RETURN FALSE
   END IF

END FUNCTION

#+ 資料新增
PRIVATE FUNCTION aooi110_insert()
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point

   #清畫面欄位內容
   CLEAR FORM
   CALL g_ooec_d.clear()


   INITIALIZE g_ooeb_m.* LIKE ooeb_t.*             #DEFAULT 設定

   WHILE TRUE
      #公用欄位給值(單頭)
      #此段落由子樣板a14產生
      #LET g_ooeb_m.ooebownid = g_user
      #LET g_ooeb_m.ooebowndp = g_dept
      #LET g_ooeb_m.ooebcrtid = g_user
      #LET g_ooeb_m.ooebcrtdp = g_dept
      #LET g_ooeb_m.ooebcrtdt = cl_get_current()
      #LET g_ooeb_m.ooebmodid = g_user
      #LET g_ooeb_m.ooebmoddt = cl_get_current()
      #LET g_ooeb_m.ooebstus = "Y"



      #append欄位給值


      #一般欄位給值
            LET g_ooeb_m.ooeb003 = "1"


      #add-point:單頭預設值
      LET g_ooeb_m.ooeb002 = g_today
      LET g_ooeb_m.ooebstus = "N"
      CALL aooi110_set_entry_ooeb003()
      LET g_ooeb_m.ooebownid = g_user
      LET g_ooeb_m.ooebowndp = g_dept
      LET g_ooeb_m.ooebcrtid = g_user
      LET g_ooeb_m.ooebcrtdp = g_dept
      LET g_ooeb_m.ooebcrtdt = cl_get_current()
      LET g_ooeb_m.ooebmodid = g_user
      LET g_ooeb_m.ooebmoddt = cl_get_current()
      #end add-point

      CALL aooi110_input("a")

      #add-point:單頭輸入後
      {<point name="insert.after_insert"/>}
      #end add-point

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_ooeb_m.* = g_ooeb_m_t.*
         CALL aooi110_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT WHILE
      END IF

      CALL g_ooec_d.clear()


      LET g_rec_b = 0
      EXIT WHILE

   END WHILE

   LET g_state = "Y"

   LET g_ooeb001_t = g_ooeb_m.ooeb001


   LET g_wc = g_wc,
              " OR (",
              " ooeb001 = '", g_ooeb_m.ooeb001 CLIPPED, "' "

              , ") "

END FUNCTION


#+ 資料修改
PRIVATE FUNCTION aooi110_modify()
   {<Local define>}
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:modify段define

   #end add-point

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001

   ERROR ""

   LET g_ooeb001_t = g_ooeb_m.ooeb001

   BEGIN WORK

   OPEN aooi110_cl USING g_enterprise,g_ooeb_m.ooeb001

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN aooi110_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE aooi110_cl
      ROLLBACK WORK
      RETURN
   END IF

   #鎖住將被更改或取消的資料
   FETCH aooi110_cl INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt

   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE aooi110_cl
      ROLLBACK WORK
      RETURN
   END IF



   CALL aooi110_show()
   WHILE TRUE
      LET g_ooeb001_t = g_ooeb_m.ooeb001


      #寫入修改者/修改日期資訊(單頭)
      LET g_ooeb_m.ooebmodid = g_user
LET g_ooeb_m.ooebmoddt = cl_get_current()


      #add-point:modify段修改前
      CALL aooi110_set_entry_ooeb003()
      #end add-point

      CALL aooi110_input("u")     #欄位更改

      #add-point:modify段修改後
      {<point name="modify.after_input"/>}
      #end add-point

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_ooeb_m.* = g_ooeb_m_t.*
         CALL aooi110_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT WHILE
      END IF

      #若單頭key欄位有變更
      IF g_ooeb_m.ooeb001 != g_ooeb001_t

      THEN
         BEGIN WORK

         #add-point:單身fk修改前
         {<point name="modify.body.b_fk_update"/>}
         #end add-point

         #更新單身key值
         UPDATE ooec_t SET ooec001 = g_ooeb_m.ooeb001

          WHERE ooecent = g_enterprise AND ooec001 = g_ooeb001_t

         IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = ""
             LET g_errparam.popup = TRUE
             CALL cl_err()

             ROLLBACK WORK
             CONTINUE WHILE
         END IF



         #add-point:單身fk修改後
         {<point name="modify.body.a_fk_update"/>}
         #end add-point

         #UPDATE 多語言table key值


         COMMIT WORK
      END IF

      EXIT WHILE
   END WHILE

   #修改歷程記錄
   IF NOT cl_used_modified_record(g_ooeb_m.ooeb001,g_site) THEN
      ROLLBACK WORK
   END IF

   CLOSE aooi110_cl
   COMMIT WORK

   #流程通知預埋點-U
   CALL cl_flow_notify(g_ooeb_m.ooeb001,'U')

END FUNCTION


#+ 資料輸入
PRIVATE FUNCTION aooi110_input(p_cmd)
   {<Local define>}
   DEFINE  p_cmd           LIKE type_t.chr1
   DEFINE  l_cmd           LIKE type_t.chr1
   DEFINE  l_ac_t          LIKE type_t.num5                #未取消的ARRAY CNT
   DEFINE  l_n             LIKE type_t.num5                #檢查重複用
   DEFINE  l_cnt           LIKE type_t.num5                #檢查重複用
   DEFINE  l_lock_sw       LIKE type_t.chr1                #單身鎖住否
   DEFINE  l_allow_insert  LIKE type_t.num5                #可新增否
   DEFINE  l_allow_delete  LIKE type_t.num5                #可刪除否
   DEFINE  l_count         LIKE type_t.num5
   DEFINE  l_i             LIKE type_t.num5
   DEFINE  l_insert        BOOLEAN
   DEFINE  ls_return       STRING
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:input段define
   {<point name="input.define"/>}
   #end add-point

   #切換畫面
   #該樣板不需此段落IF g_main_hidden THEN
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("mainlayout",0)
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("worksheet",1)
   #該樣板不需此段落   LET g_main_hidden = 0
   #該樣板不需此段落END IF

   CALL cl_set_head_visible("","YES")

   LET l_insert = FALSE
   LET g_action_choice = ""

   LET g_forupd_sql = "SELECT ooec002,ooec003,ooec004,'',ooec005,'' FROM ooec_t WHERE ooecent=? AND ooec001=? AND ooec002=? FOR UPDATE"
   LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
   DECLARE aooi110_bcl CURSOR FROM g_forupd_sql



   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
   LET g_qryparam.state = 'i'

   #控制key欄位可否輸入
   CALL aooi110_set_entry(p_cmd)
   CALL aooi110_set_no_entry(p_cmd)

   DISPLAY BY NAME g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt

   #add-point:資料輸入前
   {<point name="input.before_input"/>}
   #end add-point

   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭段
      INPUT BY NAME g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
         ATTRIBUTE(WITHOUT DEFAULTS)

         #自訂ACTION(master_input)


         BEFORE INPUT


         #---------------------------<  Master  >---------------------------
         #----<<ooeb001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb001
            #add-point:BEFORE FIELD ooeb001
            {<point name="input.b.ooeb001" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb001

            #add-point:AFTER FIELD ooeb001
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) THEN
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( p_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t ))) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooeb_t WHERE "||"ooebent = '" ||g_enterprise|| "' AND "||"ooeb001 = '"||g_ooeb_m.ooeb001 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF



            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb001
            #add-point:ON CHANGE ooeb001
            {<point name="input.g.ooeb001" />}
            #END add-point

         #----<<ooeb002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb002
            #add-point:BEFORE FIELD ooeb002
            {<point name="input.b.ooeb002" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb002

            #add-point:AFTER FIELD ooeb002
            {<point name="input.a.ooeb002" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb002
            #add-point:ON CHANGE ooeb002
            {<point name="input.g.ooeb002" />}
            #END add-point

         #----<<ooeb003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb003
            #add-point:BEFORE FIELD ooeb003
            {<point name="input.b.ooeb003" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb003

            #add-point:AFTER FIELD ooeb003
            CALL aooi110_set_entry_ooeb003()
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb003
            #add-point:ON CHANGE ooeb003
            {<point name="input.g.ooeb003" />}
            #END add-point

         #----<<ooeb004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb004
            #add-point:BEFORE FIELD ooeb004
            {<point name="input.b.ooeb004" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb004

            #add-point:AFTER FIELD ooeb004
            CALL aooi110_chk_ooeb005()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb004
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb004= g_ooeb_m_t.ooeb004
               NEXT FIELD ooeb004
            END IF
            CALL aooi110_def_ooeb006()

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb004
            #add-point:ON CHANGE ooeb004
            {<point name="input.g.ooeb004" />}
            #END add-point

         #----<<ooeb005>>----
         #此段落由子樣板a02產生
         AFTER FIELD ooeb005

            #add-point:AFTER FIELD ooeb005
            CALL aooi110_chk_ooeb005()
            IF NOT cl_null(g_errno) THEN
               LET g_ooeb_m.ooeb005_desc = ""
               DISPLAY BY NAME g_ooeb_m.ooeb005_desc
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb005
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb005= g_ooeb_m_t.ooeb005
               CALL aooi110_ooec005_desc()
               NEXT FIELD ooeb005
            END IF
            CALL aooi110_def_ooeb006()
            CALL aooi110_ooec005_desc()
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD ooeb005
            #add-point:BEFORE FIELD ooeb005
            {<point name="input.b.ooeb005" />}
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE ooeb005
            #add-point:ON CHANGE ooeb005
            {<point name="input.g.ooeb005" />}
            #END add-point

         #----<<ooeb006>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb006
            #add-point:BEFORE FIELD ooeb006
            {<point name="input.b.ooeb006" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb006

            #add-point:AFTER FIELD ooeb006
            CALL aooi110_chk_ooeb005()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb006
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb006= g_ooeb_m_t.ooeb006
               NEXT FIELD ooeb006
            END IF

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb006
            #add-point:ON CHANGE ooeb006
            {<point name="input.g.ooeb006" />}
            #END add-point

         #----<<ooeb007>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb007
            #add-point:BEFORE FIELD ooeb007
            {<point name="input.b.ooeb007" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb007

            #add-point:AFTER FIELD ooeb007
            CALL aooi110_chk_date()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb007
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb007= g_ooeb_m_t.ooeb007
               NEXT FIELD ooeb007
            END IF
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb007
            #add-point:ON CHANGE ooeb007
            {<point name="input.g.ooeb007" />}
            #END add-point

         #----<<ooeb008>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooeb008
            #add-point:BEFORE FIELD ooeb008
            {<point name="input.b.ooeb008" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooeb008

            #add-point:AFTER FIELD ooeb008
            CALL aooi110_chk_date()
            IF NOT cl_null(g_errno) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = g_ooeb_m.ooeb008
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooeb_m.ooeb008= g_ooeb_m_t.ooeb008
               NEXT FIELD ooeb008
            END IF
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooeb008
            #add-point:ON CHANGE ooeb008
            {<point name="input.g.ooeb008" />}
            #END add-point

         #----<<ooebstus>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebstus
            #add-point:BEFORE FIELD ooebstus
            {<point name="input.b.ooebstus" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebstus

            #add-point:AFTER FIELD ooebstus
            {<point name="input.a.ooebstus" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebstus
            #add-point:ON CHANGE ooebstus
            {<point name="input.g.ooebstus" />}
            #END add-point

         #----<<ooebmodid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmodid
            #add-point:BEFORE FIELD ooebmodid
            {<point name="input.b.ooebmodid" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebmodid

            #add-point:AFTER FIELD ooebmodid
            {<point name="input.a.ooebmodid" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebmodid
            #add-point:ON CHANGE ooebmodid
            {<point name="input.g.ooebmodid" />}
            #END add-point

         #----<<ooebmoddt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebmoddt
            #add-point:BEFORE FIELD ooebmoddt
            {<point name="input.b.ooebmoddt" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebmoddt

            #add-point:AFTER FIELD ooebmoddt
            {<point name="input.a.ooebmoddt" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebmoddt
            #add-point:ON CHANGE ooebmoddt
            {<point name="input.g.ooebmoddt" />}
            #END add-point

         #----<<ooebownid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebownid
            #add-point:BEFORE FIELD ooebownid
            {<point name="input.b.ooebownid" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebownid

            #add-point:AFTER FIELD ooebownid
            {<point name="input.a.ooebownid" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebownid
            #add-point:ON CHANGE ooebownid
            {<point name="input.g.ooebownid" />}
            #END add-point

         #----<<ooebowndp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebowndp
            #add-point:BEFORE FIELD ooebowndp
            {<point name="input.b.ooebowndp" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebowndp

            #add-point:AFTER FIELD ooebowndp
            {<point name="input.a.ooebowndp" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebowndp
            #add-point:ON CHANGE ooebowndp
            {<point name="input.g.ooebowndp" />}
            #END add-point

         #----<<ooebcrtid>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtid
            #add-point:BEFORE FIELD ooebcrtid
            {<point name="input.b.ooebcrtid" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtid

            #add-point:AFTER FIELD ooebcrtid
            {<point name="input.a.ooebcrtid" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebcrtid
            #add-point:ON CHANGE ooebcrtid
            {<point name="input.g.ooebcrtid" />}
            #END add-point

         #----<<ooebcrtdp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdp
            #add-point:BEFORE FIELD ooebcrtdp
            {<point name="input.b.ooebcrtdp" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtdp

            #add-point:AFTER FIELD ooebcrtdp
            {<point name="input.a.ooebcrtdp" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebcrtdp
            #add-point:ON CHANGE ooebcrtdp
            {<point name="input.g.ooebcrtdp" />}
            #END add-point

         #----<<ooebcrtdt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooebcrtdt
            #add-point:BEFORE FIELD ooebcrtdt
            {<point name="input.b.ooebcrtdt" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooebcrtdt

            #add-point:AFTER FIELD ooebcrtdt
            {<point name="input.a.ooebcrtdt" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooebcrtdt
            #add-point:ON CHANGE ooebcrtdt
            {<point name="input.g.ooebcrtdt" />}
            #END add-point

 #欄位檢查
         #---------------------------<  Master  >---------------------------
         #----<<ooeb001>>----
         #Ctrlp:input.c.ooeb001
#         ON ACTION controlp INFIELD ooeb001
            #add-point:ON ACTION controlp INFIELD ooeb001
            {<point name="input.c.ooeb001" />}
            #END add-point

         #----<<ooeb002>>----
         #Ctrlp:input.c.ooeb002
#         ON ACTION controlp INFIELD ooeb002
            #add-point:ON ACTION controlp INFIELD ooeb002
            {<point name="input.c.ooeb002" />}
            #END add-point

         #----<<ooeb003>>----
         #Ctrlp:input.c.ooeb003
#         ON ACTION controlp INFIELD ooeb003
            #add-point:ON ACTION controlp INFIELD ooeb003
            {<point name="input.c.ooeb003" />}
            #END add-point

         #----<<ooeb004>>----
         #Ctrlp:input.c.ooeb004
#         ON ACTION controlp INFIELD ooeb004
            #add-point:ON ACTION controlp INFIELD ooeb004
            {<point name="input.c.ooeb004" />}
            #END add-point

         #----<<ooeb005>>----
         #Ctrlp:input.c.ooeb005
         ON ACTION controlp INFIELD ooeb005
            #add-point:ON ACTION controlp INFIELD ooeb005
#此段落由子樣板a07產生
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_ooeb_m.ooeb005             #給予default值

            #給予arg

            CALL q_ooea001()                                #呼叫開窗

            LET g_ooeb_m.ooeb005 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_ooeb_m.ooeb005 TO ooeb005              #顯示到畫面上

            NEXT FIELD ooeb005                          #返回原欄位


            #END add-point

         #----<<ooeb006>>----
         #Ctrlp:input.c.ooeb006
         ON ACTION controlp INFIELD ooeb006
            #add-point:ON ACTION controlp INFIELD ooeb006
#此段落由子樣板a07產生
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_ooeb_m.ooeb006             #給予default值

            #給予arg

            CALL q_ooed003()                                #呼叫開窗

            LET g_ooeb_m.ooeb006 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_ooeb_m.ooeb006 TO ooeb006              #顯示到畫面上

            NEXT FIELD ooeb006                          #返回原欄位


            #END add-point

         #----<<ooeb007>>----
         #Ctrlp:input.c.ooeb007
#         ON ACTION controlp INFIELD ooeb007
            #add-point:ON ACTION controlp INFIELD ooeb007
            {<point name="input.c.ooeb007" />}
            #END add-point

         #----<<ooeb008>>----
         #Ctrlp:input.c.ooeb008
#         ON ACTION controlp INFIELD ooeb008
            #add-point:ON ACTION controlp INFIELD ooeb008
            {<point name="input.c.ooeb008" />}
            #END add-point

         #----<<ooebstus>>----
         #Ctrlp:input.c.ooebstus
#         ON ACTION controlp INFIELD ooebstus
            #add-point:ON ACTION controlp INFIELD ooebstus
            {<point name="input.c.ooebstus" />}
            #END add-point

         #----<<ooebmodid>>----
         #Ctrlp:input.c.ooebmodid
#         ON ACTION controlp INFIELD ooebmodid
            #add-point:ON ACTION controlp INFIELD ooebmodid
            {<point name="input.c.ooebmodid" />}
            #END add-point

         #----<<ooebmoddt>>----
         #Ctrlp:input.c.ooebmoddt
#         ON ACTION controlp INFIELD ooebmoddt
            #add-point:ON ACTION controlp INFIELD ooebmoddt
            {<point name="input.c.ooebmoddt" />}
            #END add-point

         #----<<ooebownid>>----
         #Ctrlp:input.c.ooebownid
#         ON ACTION controlp INFIELD ooebownid
            #add-point:ON ACTION controlp INFIELD ooebownid
            {<point name="input.c.ooebownid" />}
            #END add-point

         #----<<ooebowndp>>----
         #Ctrlp:input.c.ooebowndp
#         ON ACTION controlp INFIELD ooebowndp
            #add-point:ON ACTION controlp INFIELD ooebowndp
            {<point name="input.c.ooebowndp" />}
            #END add-point

         #----<<ooebcrtid>>----
         #Ctrlp:input.c.ooebcrtid
#         ON ACTION controlp INFIELD ooebcrtid
            #add-point:ON ACTION controlp INFIELD ooebcrtid
            {<point name="input.c.ooebcrtid" />}
            #END add-point

         #----<<ooebcrtdp>>----
         #Ctrlp:input.c.ooebcrtdp
#         ON ACTION controlp INFIELD ooebcrtdp
            #add-point:ON ACTION controlp INFIELD ooebcrtdp
            {<point name="input.c.ooebcrtdp" />}
            #END add-point

         #----<<ooebcrtdt>>----
         #Ctrlp:input.c.ooebcrtdt
#         ON ACTION controlp INFIELD ooebcrtdt
            #add-point:ON ACTION controlp INFIELD ooebcrtdt
            {<point name="input.c.ooebcrtdt" />}
            #END add-point

 #欄位開窗

         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF

            CALL cl_showmsg()      #錯誤訊息統整顯示
            DISPLAY BY NAME g_ooeb_m.ooeb001


            BEGIN WORK
            IF p_cmd <> 'u' THEN
               LET l_count = 1

               SELECT COUNT(*) INTO l_count FROM ooeb_t
                WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001

               IF l_count = 0 THEN

                  #add-point:單頭新增前
                  CALL aooi110_auto_code() RETURNING g_ooeb_m.ooeb001
                  DISPLAY BY NAME g_ooeb_m.ooeb001
                  #end add-point

                  INSERT INTO ooeb_t (ooebent,ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt)
                  VALUES (g_enterprise,g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt) # DISK WRITE
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "g_ooeb_m"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CONTINUE DIALOG
                  END IF


                  COMMIT WORK

                  #add-point:單頭新增後
                  IF g_ooeb_m.ooeb003 = '1' THEN
                     CALL s_aooi110_ins() RETURNING g_wcb
                     CALL aooi110_ins_tmp()
                     CALL aooi110_tree_tmp_fill()
                  END IF
                  #end add-point

                  LET p_cmd = 'u'

               ELSE
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = '!'
                  LET g_errparam.extend =  g_ooeb_m.ooeb001
                  LET g_errparam.popup = FALSE
                  CALL cl_err()

                  ROLLBACK WORK
                  NEXT FIELD ooeb001
               END IF
            ELSE

               #add-point:單頭修改前
               {<point name="input.head.b_update"/>}
               #end add-point

               UPDATE ooeb_t SET (ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt) = (g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt)
                WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb001_t

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "g_ooeb_m"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                  ROLLBACK WORK
               ELSE


                  COMMIT WORK
               END IF

               #add-point:單頭修改後
               IF g_ooeb_m.ooeb003 = '1' THEN
                  CALL s_aooi110_ins() RETURNING g_wcb
                  CALL aooi110_ins_tmp()
                  CALL aooi110_tree_tmp_fill()
               END IF
               #end add-point

            END IF
           #controlp
      END INPUT

      #Page1 預設值產生於此處
      INPUT ARRAY g_ooec_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)

         #自訂ACTION(detail_input,page_1)


         BEFORE INPUT
            CALL aooi110_b_fill()
            LET g_rec_b = g_ooec_d.getLength()

         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_n TO FORMONLY.idx

            BEGIN WORK
            OPEN aooi110_cl USING g_enterprise,g_ooeb_m.ooeb001

            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN aooi110_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

               CLOSE aooi110_cl
               ROLLBACK WORK
               RETURN
            END IF

            #FETCH aooi110_cl INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt # 鎖住將被更改或取消的資料
            #IF SQLCA.sqlcode THEN
            #   INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()

            #   CLOSE aooi110_cl
            #   ROLLBACK WORK
            #   RETURN
            #END IF

            LET g_rec_b = g_ooec_d.getLength()

            IF g_rec_b >= l_ac
               AND NOT cl_null(g_ooec_d[l_ac].ooec002)

            THEN
               LET l_cmd='u'
               LET g_ooec_d_t.* = g_ooec_d[l_ac].*  #BACKUP
               IF NOT aooi110_lock_b("ooec_t") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aooi110_bcl INTO g_ooec_d[l_ac].ooec002,g_ooec_d[l_ac].ooec003,g_ooec_d[l_ac].ooec004,g_ooec_d[l_ac].lbl_ooec004_desc,g_ooec_d[l_ac].ooec005,g_ooec_d[l_ac].lbl_ooec005_desc
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = g_ooec_d_t.ooec002
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET l_lock_sw = "Y"
                  END IF
                  CALL aooi110_show()
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row
            {<point name="input.body.before_row"/>}
            #end add-point
            #其他table資料備份(確定是否更改用)

            #其他table進行lock


         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_ooec_d[l_ac].* TO NULL

            LET g_ooec_d_t.* = g_ooec_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aooi110_set_entry_b()
            CALL aooi110_set_no_entry_b()
            #公用欄位給值(單身)


            #add-point:modify段before insert
            {<point name="input.body.before_insert"/>}
            #end add-point

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            LET l_count = 1
            SELECT COUNT(*) INTO l_count FROM ooec_t
             WHERE ooecent = g_enterprise AND ooec001 = g_ooeb_m.ooeb001

               AND ooec002 = g_ooec_d[l_ac].ooec002


            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               #add-point:單身新增前
               {<point name="input.body.b_insert"/>}
               #end add-point

                              INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_ooeb_m.ooeb001
               LET gs_keys[2] = g_ooec_d[l_ac].ooec002
               CALL aooi110_insert_b('ooec_t',gs_keys,"'1'")

               #add-point:單身新增後
               {<point name="input.body.a_insert"/>}
               #end add-point
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()

               INITIALIZE g_ooec_d[l_ac].* TO NULL
               ROLLBACK WORK
               CANCEL INSERT
            END IF

            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "ooec_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               ROLLBACK WORK
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aooi110_b_fill()
               #資料多語言用-增/改

               COMMIT WORK
               #add-point:input段-after_insert
               {<point name="input.body.a_insert2"/>}
               #end add-point
               ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF

         BEFORE DELETE                            #是否取消單身
            IF NOT cl_null(g_ooec_d[l_ac].ooec002)

               THEN

               #add-point:單身刪除前
               {<point name="input.body.b_delete"/>}
               #end add-point

               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CANCEL DELETE
               END IF
               DELETE FROM ooec_t
                WHERE ooecent = g_enterprise AND ooec001 = g_ooeb_m.ooeb001 AND

                      ooec002 = g_ooec_d_t.ooec002

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "ooec_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

                  ROLLBACK WORK
                  CANCEL DELETE
               ELSE
                  LET g_rec_b = g_rec_b-1

                  COMMIT WORK
               END IF
               CLOSE aooi110_bcl
               LET l_count = g_ooec_d.getLength()
            END IF
            #add-point:單身刪除後
            {<point name="input.body.a_delete"/>}
            #end add-point

                           INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_ooeb_m.ooeb001
               LET gs_keys[2] = g_ooec_d[l_ac].ooec002


         AFTER DELETE
            #add-point:單身刪除後2
            {<point name="input.body.after_delete"/>}
            #end add-point
                           CALL aooi110_delete_b('ooec_t',gs_keys)

         #---------------------<  Detail: page1  >---------------------
         #----<<ooec002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooec002
            #add-point:BEFORE FIELD ooec002
            {<point name="input.b.page1.ooec002" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooec002

            #add-point:AFTER FIELD ooec002
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) AND NOT cl_null(g_ooec_d[l_ac].ooec002) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND ( l_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t  OR g_ooec_d[l_ac].ooec002 != g_ooec_d_t.ooec002))) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooec_t WHERE "||"ooecent = '" ||g_enterprise|| "' AND "||"ooec001 = '"||g_ooeb_m.ooeb001 ||"' AND "|| "ooec002 = '"||g_ooec_d[l_ac].ooec002 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF



            #此段落由子樣板a05產生
            IF  NOT cl_null(g_ooeb_m.ooeb001) AND NOT cl_null(g_ooec_d[l_ac].ooec002) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND ( l_cmd = 'u' AND (g_ooeb_m.ooeb001 != g_ooeb001_t OR g_ooec_d[l_ac].ooec002 != g_ooec_d_t.ooec002))) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM ooec_t WHERE "||"ooecent = '" ||g_enterprise|| "' AND "||"ooec001 = '"||g_ooeb_m.ooeb001 ||"' AND "|| "ooec002 = '"||g_ooec_d[l_ac].ooec002 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooec002
            #add-point:ON CHANGE ooec002
            {<point name="input.g.page1.ooec002" />}
            #END add-point

         #----<<ooec003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD ooec003
            #add-point:BEFORE FIELD ooec003
            {<point name="input.b.page1.ooec003" />}
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD ooec003

            #add-point:AFTER FIELD ooec003
            {<point name="input.a.page1.ooec003" />}
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooec003
            #add-point:ON CHANGE ooec003
            {<point name="input.g.page1.ooec003" />}
            #END add-point

         #----<<ooec004>>----
         #此段落由子樣板a02產生
         AFTER FIELD ooec004

            #add-point:AFTER FIELD ooec004


            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD ooec004
            #add-point:BEFORE FIELD ooec004
            {<point name="input.b.page1.ooec004" />}
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE ooec004
            #add-point:ON CHANGE ooec004
            {<point name="input.g.page1.ooec004" />}
            #END add-point

         #----<<ooec005>>----
         #此段落由子樣板a02產生
         AFTER FIELD ooec005

            #add-point:AFTER FIELD ooec005


            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD ooec005
            #add-point:BEFORE FIELD ooec005
            {<point name="input.b.page1.ooec005" />}
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE ooec005
            #add-point:ON CHANGE ooec005
            {<point name="input.g.page1.ooec005" />}
            #END add-point


         #---------------------<  Detail: page1  >---------------------
         #----<<ooec002>>----
         #Ctrlp:input.c.ooec002
#         ON ACTION controlp INFIELD ooec002
            #add-point:ON ACTION controlp INFIELD ooec002
            {<point name="input.c.page1.ooec002" />}
            #END add-point

         #----<<ooec003>>----
         #Ctrlp:input.c.ooec003
#         ON ACTION controlp INFIELD ooec003
            #add-point:ON ACTION controlp INFIELD ooec003
            {<point name="input.c.page1.ooec003" />}
            #END add-point

         #----<<ooec004>>----
         #Ctrlp:input.c.ooec004
#         ON ACTION controlp INFIELD ooec004
            #add-point:ON ACTION controlp INFIELD ooec004
            {<point name="input.c.page1.ooec004" />}
            #END add-point

         #----<<ooec005>>----
         #Ctrlp:input.c.ooec005
#         ON ACTION controlp INFIELD ooec005
            #add-point:ON ACTION controlp INFIELD ooec005
            {<point name="input.c.page1.ooec005" />}
            #END add-point



         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

               LET INT_FLAG = 0
               LET g_ooec_d[l_ac].* = g_ooec_d_t.*
               CLOSE aooi110_bcl
               ROLLBACK WORK
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = g_ooec_d[l_ac].ooec002
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_ooec_d[l_ac].* = g_ooec_d_t.*
            ELSE

               #add-point:單身修改前
               {<point name="input.body.b_update"/>}
               #end add-point

               #寫入修改者/修改日期資訊(單身)


               UPDATE ooec_t SET (ooec001,ooec002,ooec003,ooec004,ooec005) = (g_ooeb_m.ooeb001,g_ooec_d[l_ac].ooec002,g_ooec_d[l_ac].ooec003,g_ooec_d[l_ac].ooec004,g_ooec_d[l_ac].ooec005)
                WHERE ooecent = g_enterprise AND ooec001 = g_ooeb_m.ooeb001

                  AND ooec002 = g_ooec_d_t.ooec002 #項次

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "ooec_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

                  LET g_ooec_d[l_ac].* = g_ooec_d_t.*
               ELSE
                                 INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_ooeb_m.ooeb001
               LET gs_keys_bak[1] = g_ooeb001_t
               LET gs_keys[2] = g_ooec_d[l_ac].ooec002
               LET gs_keys_bak[2] = g_ooec_d_t.ooec002
               CALL aooi110_update_b('ooec_t',gs_keys,gs_keys_bak)
                  #資料多語言用-增/改

               END IF

               #add-point:單身修改後
               {<point name="input.body.a_update"/>}
               #end add-point

            END IF

         AFTER ROW
            CALL aooi110_unlock_b("ooec_t")
            COMMIT WORK
            #其他table進行unlock


      END INPUT



      #add-point:自定義input
      {<point name="input.more_input"/>}
      #end add-point

      BEFORE DIALOG
         #add-point:input段before dialog
         {<point name="input.before_dialog"/>}
         #end add-point
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            NEXT FIELD ooeb001
         END IF

      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)

      ON ACTION controlr
         CALL cl_show_req_fields()

      ON ACTION controls
         CALL cl_set_head_visible("","AUTO")

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel      #在dialog button (放棄)
         LET g_action_choice=""
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION close       #在dialog 右上角 (X)
         LET g_action_choice="exit"
         EXIT DIALOG

      ON ACTION exit        #toolbar 離開
         LET g_action_choice="exit"
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG

   END DIALOG

   #add-point:input段after input
   {<point name="input.after_input"/>}
   #end add-point

END FUNCTION


#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION aooi110_show()
   {<Local define>}
   DEFINE l_ac_t    LIKE type_t.num5
   DEFINE l_sql     STRING
   {</Local define>}
   #add-point:show段define
   {<point name="show.define"/>}
   #end add-point

   #add-point:show段之前
   {<point name="show.before"/>}
   #end add-point



   LET g_ooeb_m_t.* = g_ooeb_m.*      #保存單頭舊值

   CALL aooi110_b_fill()                 #單身

   #帶出公用欄位reference值
   #此段落由子樣板a12產生
      #LET g_ooeb_m.ooebownid_desc = cl_get_username(g_ooeb_m.ooebownid)
      #LET g_ooeb_m.ooebowndp_desc = cl_get_deptname(g_ooeb_m.ooebowndp)
      #LET g_ooeb_m.ooebcrtid_desc = cl_get_username(g_ooeb_m.ooebcrtid)
      #LET g_ooeb_m.ooebcrtdp_desc = cl_get_deptname(g_ooeb_m.ooebcrtdp)
      #LET g_ooeb_m.ooebmodid_desc = cl_get_username(g_ooeb_m.ooebmodid)
      ##LET g_ooeb_m.ooeb_desc = cl_get_deptname(g_ooeb_m.ooeb)
      ##LET g_ooeb_m.ooeb_desc = cl_get_deptname(g_ooeb_m.ooeb)




   LET l_ac_t = l_ac

   #讀入ref值(單頭)
   #add-point:show段reference
   CALL aooi110_ooec005_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebmodid
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebmodid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebmodid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebownid
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebownid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebownid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebowndp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebowndp_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebowndp_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebcrtid
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebcrtid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebcrtid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_ooeb_m.ooebcrtdp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_ooeb_m.ooebcrtdp_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_ooeb_m.ooebcrtdp_desc
   #end add-point

   #將資料輸出到畫面上
   DISPLAY BY NAME g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt

   #顯示狀態(stus)圖片
         #此段落由子樣板a21產生
      CASE g_ooeb_m.ooebstus
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/void.png")

         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirm.png")


      END CASE



   #讀入ref值(單身)
   FOR l_ac = 1 TO g_ooec_d.getLength()
      #帶出公用欄位reference值

      #add-point:show段單身reference

      #end add-point
   END FOR





   LET l_ac = l_ac_t

   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()

   #add-point:show段之後
   {<point name="show.after"/>}
   #end add-point

END FUNCTION


#+ 資料複製
PRIVATE FUNCTION aooi110_reproduce()
   {<Local define>}
   DEFINE l_newno     LIKE ooeb_t.ooeb001
   DEFINE l_oldno     LIKE ooeb_t.ooeb001

   DEFINE l_master    RECORD LIKE ooeb_t.*
   DEFINE l_detail    RECORD LIKE ooec_t.*

   DEFINE l_cnt       LIKE type_t.num5
   {</Local define>}
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point

   #切換畫面
   #該樣板不需此段落IF g_main_hidden THEN
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("mainlayout",0)
   #該樣板不需此段落   CALL gfrm_curr.setElementHidden("worksheet",1)
   #該樣板不需此段落   LET g_main_hidden = 0
   #該樣板不需此段落END IF

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   CALL aooi110_set_entry('a')
   CALL aooi110_set_no_entry('a')

   CALL cl_set_head_visible("","YES")



   INPUT l_newno   # FROM

    FROM ooeb001


      #add-point:複製段落開窗/欄位控管/自定義action
      {<point name="reproduce.action" />}
      #end add-point

      BEFORE INPUT
         #add-point:複製段落Before input
         {<point name="reproduce.before_input" />}
         #end add-point

      AFTER FIELD ooeb001
         IF l_newno IS NULL THEN
            NEXT FIELD CURRENT
         END IF
         #add-point:AFTER FIELD ooeb001
         {<point name="reproduce.a.ooeb001" />}
         #end add-point



      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG = 1 THEN
            LET INT_FLAG = 0
            RETURN
         END IF

         #確定該key值是否有重複定義
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM ooeb_t
          WHERE ooebent = g_enterprise AND ooeb001 = l_newno

         IF l_cnt > 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = "std-00006"
            LET g_errparam.extend = "Reproduce"
            LET g_errparam.popup = TRUE
            CALL cl_err()

            #NEXT FIELD ooeb001
         END IF

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE INPUT

   END INPUT

   IF INT_FLAG OR l_newno IS NULL THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   BEGIN WORK

   SELECT * INTO l_master.* FROM ooeb_t
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001

   LET l_master.ooeb001 = l_newno


   #公用欄位給予預設值(單頭)
   #此段落由子樣板a13產生
      LET l_master.ooebownid = g_user
      LET l_master.ooebowndp = g_dept
      LET l_master.ooebcrtid = g_user
      LET l_master.ooebcrtdp = g_dept
      LET l_master.ooebcrtdt = cl_get_current()
      LET l_master.ooebmodid = g_user
      LET l_master.ooebmoddt = cl_get_current()
      LET l_master.ooebstus = "Y"



   #公用欄位給予預設值(單身)


   #add-point:單頭複製前
   {<point name="reproduce.head.b_insert"/>}
   #end add-point

   INSERT INTO ooeb_t VALUES (l_master.*) #複製單頭
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "ooeb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      ROLLBACK WORK
      RETURN
   END IF

   #add-point:單頭複製後
   {<point name="reproduce.head.a_insert"/>}
   #end add-point



   LET g_sql = "SELECT * FROM ooec_t WHERE ooecent = '" ||g_enterprise|| "' AND ",
               " ooec001 = '",g_ooeb_m.ooeb001,"'"

   DECLARE aooi110_reproduce CURSOR FROM g_sql

   FOREACH aooi110_reproduce INTO l_detail.*
      LET l_detail.ooec001 = l_newno


      #add-point:單身複製前1
      {<point name="reproduce.body.table1.b_insert"/>}
      #end add-point

      INSERT INTO ooec_t VALUES (l_detail.*) #複製單身
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'Insert error!'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF

      #add-point:單身複製後1
      {<point name="reproduce.body.table1.a_insert"/>}
      #end add-point

   END FOREACH



   COMMIT WORK
   ERROR 'ROW(',l_newno,') O.K'

   CLOSE aooi110_reproduce

   LET g_state = "Y"

   LET g_wc = g_wc,
              " OR (",
              " ooeb001 = '", l_newno CLIPPED, "' "

              , ") "

   #add-point:完成複製段落後
   {<point name="reproduce.after_reproduce" />}
   #end add-point

END FUNCTION

#+ 資料刪除
PRIVATE FUNCTION aooi110_delete()
   {<Local define>}
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

    SELECT UNIQUE ooeb001,ooeb002,ooeb003,ooeb004,ooeb005,ooeb006,ooeb007,ooeb008,ooebstus,ooebmodid,ooebmoddt,ooebownid,ooebowndp,ooebcrtid,ooebcrtdp,ooebcrtdt
 INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebowndp,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdt
 FROM ooeb_t
 WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001
   BEGIN WORK



   OPEN aooi110_cl USING g_enterprise,g_ooeb_m.ooeb001

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN aooi110_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE aooi110_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH aooi110_cl INTO g_ooeb_m.ooeb001,g_ooeb_m.ooeb002,g_ooeb_m.ooeb003,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,g_ooeb_m.ooeb006,g_ooeb_m.ooeb005_desc,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooebstus,g_ooeb_m.ooebmodid,g_ooeb_m.ooebmodid_desc,g_ooeb_m.ooebmoddt,g_ooeb_m.ooebownid,g_ooeb_m.ooebownid_desc,g_ooeb_m.ooebowndp,g_ooeb_m.ooebowndp_desc,g_ooeb_m.ooebcrtid,g_ooeb_m.ooebcrtid_desc,g_ooeb_m.ooebcrtdp,g_ooeb_m.ooebcrtdp_desc,g_ooeb_m.ooebcrtdt              # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()
          #資料被他人LOCK
      ROLLBACK WORK
      RETURN
   END IF

   CALL aooi110_show()

   #IF NOT cl_ask_delete() THEN             #確認一下
   IF cl_ask_del_master() THEN              #確認一下
      INITIALIZE g_doc.* TO NULL
      LET g_doc.column1 = "ooeb001"
      LET g_doc.value1 = g_ooeb_m.ooeb001
      CALL cl_del_doc()

      #add-point:單頭刪除前
      {<point name="delete.head.b_delete"/>}
      #end add-point

      #資料備份
      LET g_ooeb001_t = g_ooeb_m.ooeb001


      DELETE FROM ooeb_t
       WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001


      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_ooeb_m.ooeb001
      LET g_errparam.popup = FALSE
      CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF

      #add-point:單頭刪除後
      {<point name="delete.head.a_delete"/>}
      #end add-point


      #add-point:單身刪除前
      {<point name="delete.body.b_delete"/>}
      #end add-point

      DELETE FROM ooec_t
       WHERE ooecent = g_enterprise AND ooec001 = g_ooeb_m.ooeb001


      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "ooec_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()

         ROLLBACK WORK
         RETURN
      END IF





      #add-point:單身刪除後
      {<point name="delete.body.a_delete"/>}
      #end add-point

      CLEAR FORM
      CALL g_ooec_d.clear()


      CALL aooi110_ui_browser_refresh()
      CALL aooi110_ui_headershow()
      CALL aooi110_ui_detailshow()

      IF g_browser_cnt > 0 THEN
         CALL aooi110_fetch('P')
      ELSE
         LET g_wc = " 1=1"
         CALL aooi110_browser_fill("F")
      END IF

   END IF

   CLOSE aooi110_cl
   COMMIT WORK

   #流程通知預埋點-D
   CALL cl_flow_notify(g_ooeb_m.ooeb001,'D')

END FUNCTION


#+ 單身陣列填充
PRIVATE FUNCTION aooi110_b_fill()
   {<Local define>}
   DEFINE p_wc2      STRING
   {</Local define>}
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point

   CALL g_ooec_d.clear()    #g_ooec_d 單頭及單身


   LET g_sql = "SELECT  UNIQUE ooec002,ooec003,ooec004,'',ooec005,'' FROM ooec_t",
               "",
               " WHERE ooecent=? AND ooec001=?"

   IF NOT cl_null(g_wc_table1) THEN
      LET g_sql = g_sql CLIPPED, " AND ", g_wc_table1 CLIPPED
   END IF

   LET g_sql = g_sql, " ORDER BY ooec_t.ooec002"

   #add-point:單身填充控制
   {<point name="b_fill.sql"/>}
   #end add-point

   PREPARE aooi110_pb FROM g_sql
   DECLARE b_fill_cs CURSOR FOR aooi110_pb

   LET g_cnt = l_ac
   LET l_ac = 1

   OPEN b_fill_cs USING g_enterprise,g_ooeb_m.ooeb001


   FOREACH b_fill_cs INTO g_ooec_d[l_ac].ooec002,g_ooec_d[l_ac].ooec003,g_ooec_d[l_ac].ooec004,g_ooec_d[l_ac].lbl_ooec004_desc,g_ooec_d[l_ac].ooec005,g_ooec_d[l_ac].lbl_ooec005_desc
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      #add-point:b_fill段資料填充
      SELECT ooefl003 INTO g_ooec_d[l_ac].lbl_ooec004_desc
        FROM ooefl_t
       WHERE ooefl001 = g_ooec_d[l_ac].ooec004
         AND ooefl002 = g_dlang
         AND ooeflent = g_enterprise
      SELECT ooefl003 INTO g_ooec_d[l_ac].lbl_ooec005_desc
        FROM ooefl_t
       WHERE ooefl001 = g_ooec_d[l_ac].ooec005
         AND ooefl002 = g_dlang
         AND ooeflent = g_enterprise
      #end add-point

      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT FOREACH
      END IF

   END FOREACH



   CALL g_ooec_d.deleteElement(g_ooec_d.getLength())



   LET l_ac = g_cnt
   LET g_cnt = 0

   FREE aooi110_pb


END FUNCTION


#+ 單身db資料刪除
PRIVATE FUNCTION aooi110_before_delete()
   #add-point:before_delete段define
   {<point name="before_delete.define"/>}
   #end add-point

   DELETE FROM ooec_t
    WHERE ooecent = g_enterprise AND ooec001 = g_ooeb_m.ooeb001 AND

          ooec002 = g_ooec_d_t.ooec002

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "ooec_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

      RETURN FALSE
   END IF

   LET g_rec_b = g_rec_b-1

   RETURN TRUE

END FUNCTION

#+ 刪除單身後其他table連動
PRIVATE FUNCTION aooi110_delete_b(ps_table,ps_keys_bak)
   {<Local define>}
   DEFINE ps_table    STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   {</Local define>}
   #add-point:delete_b段define
   {<point name="delete_b.define"/>}
   #end add-point

   #判斷是否是同一群組的table
   LET ls_group = "ooec_t,"
   IF ls_group.getIndexOf(ps_table,1) > 0 THEN
      DELETE FROM ooec_t
       WHERE ooecent = g_enterprise AND
         ooec001 = ps_keys_bak[1] AND ooec002 = ps_keys_bak[2]

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = FALSE
         CALL cl_err()

      END IF
      RETURN
   END IF



END FUNCTION

#+ 新增單身後其他table連動
PRIVATE FUNCTION aooi110_insert_b(ps_table,ps_keys,ps_page)
   {<Local define>}
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   {</Local define>}
   #add-point:insert_b段define
   {<point name="insert_b.define"/>}
   #end add-point

   #判斷是否是同一群組的table
   LET ls_group = "ooec_t,"
   LET ls_page  = "'1',"
   IF ls_group.getIndexOf(ps_table,1) > 0 AND ls_page.getIndexOf(ps_page,1) > 0 THEN
      INSERT INTO ooec_t
                  (ooecent,
                   ooec001,
                   ooec002
                   ,ooec003,ooec004,ooec005)
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2]
                   ,g_ooec_d[l_ac].ooec003,g_ooec_d[l_ac].ooec004,g_ooec_d[l_ac].ooec005)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "ooec_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()

      END IF
   END IF



END FUNCTION


#+ 修改單身後其他table連動
PRIVATE FUNCTION aooi110_update_b(ps_table,ps_keys,ps_keys_bak)
   {<Local define>}
   DEFINE ps_table         STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num5
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:update_b段define
   {<point name="update_b.define"/>}
   #end add-point

   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR

   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF

   #判斷是否是同一群組的table
   LET ls_group = "ooec_t,"
   IF ls_group.getIndexOf(ps_table,1) > 0 THEN
      UPDATE ooec_t
         SET (ooec001,
              ooec002
              ,ooec003,ooec004,ooec005)
              =
             (ps_keys[1],ps_keys[2]
              ,g_ooec_d[l_ac].ooec003,g_ooec_d[l_ac].ooec004,g_ooec_d[l_ac].ooec005)
         WHERE ooec001 = ps_keys_bak[1] AND ooec002 = ps_keys_bak[2]

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = FALSE
         CALL cl_err()

      ELSE

      END IF
      RETURN
   END IF



END FUNCTION

#+ 連動lock其他單身table資料
PRIVATE FUNCTION aooi110_lock_b(ps_table)

   DEFINE ps_table STRING
   DEFINE ls_group STRING
   #add-point:lock_b段define
   {<point name="lock_b.define"/>}
   #end add-point

   #先刷新資料
   CALL aooi110_b_fill()

   #鎖定整組table
   #LET ls_group = "ooec_t,"
   #僅鎖定自身table
   LET ls_group = "ooec_t"

   IF ls_group.getIndexOf(ps_table,1) THEN

      OPEN aooi110_bcl USING g_enterprise,
                                       g_ooeb_m.ooeb001,g_ooec_d[l_ac].ooec002

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "aooi110_bcl"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN FALSE
      END IF

   END IF



   RETURN TRUE

END FUNCTION

#+ 連動unlock其他單身table資料
PRIVATE FUNCTION aooi110_unlock_b(ps_table)

   DEFINE ps_table STRING
   DEFINE ls_group STRING
   #add-point:unlock_b段define
   {<point name="unlock_b.define"/>}
   #end add-point

   LET ls_group = ""

   IF ls_group.getIndexOf(ps_table,1) THEN
      CLOSE aooi110_bcl
   END IF



END FUNCTION


#+ 單頭欄位開啟設定
PRIVATE FUNCTION aooi110_set_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1
   {</Local define>}
   #add-point:set_entry段define
   {<point name="set_entry.define"/>}
   #end add-point

   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("ooeb001",TRUE)
      #add-point:set_entry段欄位控制
      CALL cl_set_comp_entry("ooeb001",FALSE)
      #end add-point
   END IF


END FUNCTION


#+ 單頭欄位關閉設定
PRIVATE FUNCTION aooi110_set_no_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1
   {</Local define>}
   #add-point:set_no_entry段define
   {<point name="set_no_entry.define"/>}
   #end add-point

   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("ooeb001",FALSE)
      #add-point:set_no_entry段欄位控制
      {<point name="set_no_entry.field_control"/>}
      #end add-point
   END IF

END FUNCTION


#+ 單身欄位開啟設定
PRIVATE FUNCTION aooi110_set_entry_b()
   #add-point:set_entry_b段define
   {<point name="set_entry_b.define"/>}
   #end add-point
   #add-point:set_entry_b段
   {<point name="set_entry_b.define"/>}
   #end add-point
END FUNCTION


#+ 單身欄位關閉設定
PRIVATE FUNCTION aooi110_set_no_entry_b()
   #add-point:set_no_entry_b段define
   {<point name="set_no_entry_b.define"/>}
   #end add-point
   #add-point:set_no_entry_b段
   {<point name="set_no_entry_b.define"/>}
   #end add-point
END FUNCTION


#+ 外部參數搜尋, 施工中
PRIVATE FUNCTION aooi110_default_search()
   {<Local define>}
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   {</Local define>}
   #add-point:default_search段define
   {<point name="default_search.define"/>}
   #end add-point

   #add-point:default_search段開始前
   {<point name="default_search.before"/>}
   #end add-point

   LET g_pagestart = 1

   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF

   IF NOT cl_null(g_argv[1]) THEN
      LET ls_wc = ls_wc, " ooeb001 = '", g_argv[1], "' AND "
   END IF



   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
   ELSE
      IF cl_null(g_wc) THEN
         LET g_wc = " 1=1"
      END IF
   END IF

   #add-point:default_search段結束前
   {<point name="default_search.after"/>}
   #end add-point

END FUNCTION

#+ 此段落由子樣板a09產生
#+ 確認碼變更
PRIVATE FUNCTION aooi110_statechange()
   {<Local define>}
   DEFINE lc_state LIKE type_t.chr5
   {</Local define>}
   #add-point:statechange段define

   #end add-point

   #add-point:statechange段開始前
   {<point name="statechange.before"/>}
   #end add-point

   ERROR ""     #清空畫面右下側ERROR區塊

   IF g_ooeb_m.ooeb001 IS NULL

   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         CASE g_ooeb_m.ooebstus
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "X"
               HIDE OPTION "void"

            WHEN "Y"
               HIDE OPTION "confirm"


         END CASE

      ON ACTION unconfirmed
         LET lc_state = "N"
         EXIT MENU
      ON ACTION void
         LET lc_state = "X"
         EXIT MENU

      ON ACTION confirm
         LET lc_state = "Y"
         EXIT MENU


   END MENU

   IF (lc_state <> "N"
      AND lc_state <> "X"

      AND lc_state <> "Y"


      ) OR
      cl_null(lc_state) THEN
      RETURN
   END IF

   #add-point:stus修改前
   {<point name="statechange.b_update"/>}
   #end add-point

   UPDATE ooeb_t SET ooebstus = lc_state
    WHERE ooebent = g_enterprise AND ooeb001 = g_ooeb_m.ooeb001


   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = FALSE
         CALL cl_err()

   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/void.png")

         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirm.png")


      END CASE
   END IF

   #add-point:stus修改後

   #end add-point

   #add-point:statechange段結束前
   {<point name="statechange.after"/>}
   #end add-point

END FUNCTION



#+ 單身筆數變更
PRIVATE FUNCTION aooi110_idx_chk()
   #add-point:idx_chk段define
   {<point name="idx_chk.define"/>}
   #end add-point

   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_ooec_d.getLength() THEN
         LET g_detail_idx = g_ooec_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_ooec_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_ooec_d.getLength() TO FORMONLY.cnt
   END IF



END FUNCTION

# 申請單號自動編碼
PRIVATE FUNCTION aooi110_auto_code()
DEFINE l_no           LIKE type_t.num10
   DEFINE ps_slip        STRING

   #组成流水号
   SELECT MAX(to_number(ooeb001)) +1 INTO l_no
     FROM ooeb_t
   #如果不存在编号则是第一次编号
   IF cl_null(l_no) THEN
      LET l_no = 1
   END IF
   LET ps_slip=l_no USING "&&&&&&"
   RETURN ps_slip
END FUNCTION
# 生失效日期檢查
PRIVATE FUNCTION aooi110_chk_date()
LET g_errno = ''

   IF NOT cl_null(g_ooeb_m.ooeb007) AND NOT cl_null(g_ooeb_m.ooeb008) THEN
      IF g_ooeb_m.ooeb007 > g_ooeb_m.ooeb008 THEN
         LET g_errno = 'aoo-00122'
      END IF
   END IF
END FUNCTION
# 最上層組織編號檢查
PRIVATE FUNCTION aooi110_chk_ooeb005()
DEFINE l_n         LIKE type_t.num10

   LET g_errno = ''
   IF NOT cl_null(g_ooeb_m.ooeb005) AND g_ooeb_m.ooeb005 <> g_ooeb_m_t.ooeb005 THEN
      LET l_n = 0
      SELECT COUNT(*) INTO l_n
        FROM ooea_t
       WHERE ooea001 = g_ooeb_m.ooeb005
      IF l_n = 0 THEN
         LET g_errno = 'aoo-00094'
      ELSE
         SELECT COUNT(*) INTO l_n
           FROM ooea_t
          WHERE ooea001 = g_ooeb_m.ooeb005
            AND ooeastus = 'Y'
         IF l_n = 0 THEN
            LET g_errno = 'aoo-00095'
         END IF
      END IF
   END IF
   IF NOT cl_null(g_ooeb_m.ooeb004) AND NOT cl_null(g_ooeb_m.ooeb005) AND NOT cl_null(g_ooeb_m.ooeb006)
      AND (g_ooeb_m.ooeb004 <> g_ooeb_m_t.ooeb004 OR g_ooeb_m.ooeb005 <> g_ooeb_m_t.ooeb005 OR g_ooeb_m.ooeb006 <> g_ooeb_m_t.ooeb006) THEN
      LET l_n = 0
      SELECT COUNT(*) INTO l_n
        FROM ooeb_t
       WHERE ooebent = g_enterprise
         AND ooeb004 = g_ooeb_m.ooeb004
         AND ooeb005 = g_ooeb_m.ooeb005
         AND ooeb006 = g_ooeb_m.ooeb006
      IF l_n > 0 THEN
         LET g_errno = 'aoo-00121'
      END IF
   END IF
END FUNCTION
# 确认ACTION
PRIVATE FUNCTION aooi110_confirm()

   DEFINE l_sql          STRING
   DEFINE l_n            LIKE type_t.num5
   DEFINE l_ooed003      LIKE ooed_t.ooed003
   DEFINE l_ooed006      LIKE ooed_t.ooed006
   DEFINE l_ooed007      LIKE ooed_t.ooed007
   DEFINE l_auto         LIKE ooed_t.ooed003
   DEFINE l_no           LIKE type_t.num5

   CALL s_transaction_begin()
   LET g_success = 'Y'
   IF g_ooeb_m.ooeb003 = '1' OR g_ooeb_m.ooeb003 = '2' THEN
      LET l_n = 0
      SELECT COUNT(*) INTO l_n
        FROM ooed_t
       WHERE ooedent = g_enterprise
         AND ooed001 = g_ooeb_m.ooeb004
         AND ooed002 = g_ooeb_m.ooeb005
      IF l_n = 0 THEN    #无结存档
         SELECT MAX(to_number(ooed003)) +1 INTO l_no
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
         #如果不存在编号则是第一次编号
         IF cl_null(l_no) THEN
            LET l_no = 1
         END IF
         LET l_auto =l_no
         FOR l_n = 1 TO g_tree.getLength()
             IF g_tree[l_n].b_pid = "ROOT" THEN
                LET g_tree[l_n].b_pid = g_tree[l_n].b_id
             END IF
             IF cl_null(g_tree[l_n].b_id) THEN
                EXIT FOR
             END IF
             INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                         VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
             IF SQLCA.sqlcode THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET g_success = 'N'
             END IF
         END FOR
      ELSE    #有结存档
         SELECT MAX(to_number(ooed003)) +1 INTO l_no
           FROM ooed_t
          WHERE ooedent = g_enterprise
            AND ooed001 = g_ooeb_m.ooeb004
            AND ooed002 = g_ooeb_m.ooeb005
         #如果不存在编号则是第一次编号
         IF cl_null(l_no) THEN
            LET l_no = 1
         END IF
         LET l_auto =l_no
         LET g_sql =  " SELECT ooed003,ooed006,ooed007 FROM ooed_t ",
                      "  WHERE ooedent = '",g_enterprise,"' ",
                      "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                      "    AND ooed002 = '",g_ooeb_m.ooeb005,"' ",
                      "  ORDER BY ooed006,ooed007 "
         PREPARE aooi110_status_pb1 FROM g_sql
         DECLARE aooi110_status_cs1 CURSOR FOR aooi110_status_pb1
         FOREACH aooi110_status_cs1 INTO l_ooed003,l_ooed006,l_ooed007
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "FOREACH"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_success = 'N'
            END IF
       #    SELECT MAX(to_number(ooed003)) +1 INTO l_no
       #      FROM ooed_t
       #     WHERE ooedent = g_enterprise
       #       AND ooed001 = g_ooeb_m.ooeb004
       #       AND ooed002 = g_ooeb_m.ooeb005
       #    #如果不存在编号则是第一次编号
       #    IF cl_null(l_no) THEN
       #       LET l_no = 1
       #    END IF
       #    LET l_auto =l_no
            #现在日期在原版本日期范围内
            IF g_ooeb_m.ooeb007 <= l_ooed006 AND g_ooeb_m.ooeb008 < l_ooed007 AND g_ooeb_m.ooeb008 > l_ooed006 THEN
               DELETE FROM ooed_t
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "del_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_success = 'N'
               END IF
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   IF cl_null(g_tree[l_n].b_id) THEN
                      EXIT FOR
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
               LET l_no = l_no+1
               LET l_auto = l_no
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   IF cl_null(g_tree[l_n].b_id) THEN
                      EXIT FOR
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb008+1,l_ooed007,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
            END IF
            #现在日期在原版本日期范围内
            IF g_ooeb_m.ooeb007 > l_ooed006 AND g_ooeb_m.ooeb008 < l_ooed007 THEN
               UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 - 1
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_success = 'N'
               END IF
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   IF cl_null(g_tree[l_n].b_id) THEN
                      EXIT FOR
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
               LET l_no = l_no+1
               LET l_auto = l_no
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   IF cl_null(g_tree[l_n].b_id) THEN
                      EXIT FOR
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb008+1,l_ooed007,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
            END IF
            IF g_ooeb_m.ooeb007 > l_ooed006 AND g_ooeb_m.ooeb007 < l_ooed007 AND g_ooeb_m.ooeb008 >= l_ooed007 THEN
               UPDATE ooed_t SET ooed007 = g_ooeb_m.ooeb007 - 1
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "upd_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_success = 'N'
               END IF
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   IF cl_null(g_tree[l_n].b_id) THEN
                      EXIT FOR
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
            END IF
            IF g_ooeb_m.ooeb007 <= l_ooed006 AND g_ooeb_m.ooeb008 > l_ooed007 THEN   #原版本日期在现在日期范围内
               DELETE FROM ooed_t
                WHERE ooedent = g_enterprise
                  AND ooed001 = g_ooeb_m.ooeb004
                  AND ooed002 = g_ooeb_m.ooeb005
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "del_ooed"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_success = 'N'
               END IF
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   IF cl_null(g_tree[l_n].b_id) THEN
                      EXIT FOR
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
            END IF
            IF g_ooeb_m.ooeb007 > l_ooed007 THEN       #當前版本為未來版本
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
            END IF
            IF g_ooeb_m.ooeb008 < l_ooed006 THEN      #當前版本是已有版本之前的版本
               FOR l_n = 1 TO g_tree.getLength()
                   IF g_tree[l_n].b_pid = "ROOT" THEN
                      LET g_tree[l_n].b_pid = g_tree[l_n].b_id
                   END IF
                   INSERT INTO ooed_t(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008)
                               VALUES(g_enterprise,g_ooeb_m.ooeb004,g_ooeb_m.ooeb005,l_auto,g_tree[l_n].b_id,g_tree[l_n].b_pid,g_ooeb_m.ooeb007,g_ooeb_m.ooeb008,g_ooeb_m.ooeb001)
                   IF SQLCA.sqlcode THEN
                      INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = "ins_ooed"
                LET g_errparam.popup = TRUE
                CALL cl_err()

                      LET g_success = 'N'
                   END IF
               END FOR
            END IF
         END FOREACH
      END IF
   END IF
   IF g_ooeb_m.ooeb003 = '3' THEN
      DELETE FROM ooed_t
       WHERE ooedent = g_enterprise
         AND ooed001 = g_ooeb_m.ooeb004
         AND ooed002 = g_ooeb_m.ooeb005
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "upd_ooebstus"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET g_success = 'N'
      END IF
   END IF
   UPDATE ooeb_t
      SET ooebstus = 'Y'
    WHERE ooebent = g_enterprise
      AND ooeb001 = g_ooeb_m.ooeb001
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "upd_ooebstus"
         LET g_errparam.popup = TRUE
         CALL cl_err()

      LET g_success = 'N'
   END IF
   IF g_success = 'Y' THEN
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
END FUNCTION
# 創建臨時表
PRIVATE FUNCTION aooi110_crt_tmp()
DROP TABLE ooed_tmp

   CREATE TEMP TABLE ooed_tmp
   (
       ooedent       INT,
       ooed001       VARCHAR(1),
       ooed002       VARCHAR(10),
       ooed003       VARCHAR(10),
       ooed004       VARCHAR(10),
       ooed005       VARCHAR(10),
       ooed006       DATE,
       ooed007       DATE,
       ooed008       VARCHAR(10),
       ooed009       VARCHAR(1)
   );
END FUNCTION
# 新增自動帶出版本號
PRIVATE FUNCTION aooi110_def_ooeb006()
DEFINE l_n            LIKE type_t.num10

   IF g_ooeb_m.ooeb003 = '1' THEN
      IF NOT cl_null(g_ooeb_m.ooeb004) AND NOT cl_null(g_ooeb_m.ooeb005) THEN
         LET l_n = 0
         SELECT MAX(to_number(ooeb006)) + 1 INTO l_n
           FROM ooeb_t
          WHERE ooebent = g_enterprise
            AND ooeb004 = g_ooeb_m.ooeb004
            AND ooeb005 = g_ooeb_m.ooeb005
         IF cl_null(l_n)THEN
            LET l_n = 1
         END IF
         LET g_ooeb_m.ooeb006 = l_n
         DISPLAY BY NAME g_ooeb_m.ooeb006
      END IF
   END IF
END FUNCTION
# 树資料準備按鈕
PRIVATE FUNCTION aooi110_ins_tmp()
DEFINE l_sql     STRING

   IF cl_null(g_wcb) OR g_wcb = " 1=1" THEN
      RETURN
   END IF

   LET l_sql = " INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008,ooed009) ",
               " SELECT '",g_enterprise,"','",g_ooeb_m.ooeb004,"','",g_ooeb_m.ooeb005,"','",g_ooeb_m.ooeb006,"',",
               "        ooea001,'",g_ooeb_m.ooeb005,"','",g_today,"','",g_today,"','",g_ooeb_m.ooeb001,"','2' ",
               "   FROM ooea_t ",
               "  WHERE ",g_wcb CLIPPED
   PREPARE ins_ooed_tmp_pre FROM l_sql
   EXECUTE ins_ooed_tmp_pre
END FUNCTION
# 單頭最上層組織名稱顯示
PRIVATE FUNCTION aooi110_ooec005_desc()
SELECT ooefl003 INTO g_ooeb_m.ooeb005_desc
    FROM ooefl_t
   WHERE ooefl001 = g_ooeb_m.ooeb005
     AND ooefl002 = g_dlang
     AND ooeflent = g_enterprise
   DISPLAY BY NAME g_ooeb_m.ooeb005_desc
END FUNCTION
# 版本號是否可錄
PRIVATE FUNCTION aooi110_set_entry_ooeb003()
IF NOT cl_null(g_ooeb_m.ooeb003) THEN
      IF g_ooeb_m.ooeb003 = '1' THEN
         CALL cl_set_comp_entry("ooeb006",FALSE)
      ELSE
         CALL cl_set_comp_entry("ooeb006",TRUE)
      END IF
   END IF
END FUNCTION
# 临时表填充树资料
PRIVATE FUNCTION aooi110_tree_tmp_fill()
   DEFINE l_ooed003         LIKE ooed_t.ooed003
   DEFINE l_pid             LIKE type_t.chr100
   DEFINE l_id              LIKE type_t.chr100
   DEFINE l_n               LIKE type_t.num5

   DELETE FROM ooed_tmp WHERE ooed009 = '1'
   INSERT INTO ooed_tmp(ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008,ooed009)
        SELECT ooedent,ooed001,ooed002,ooed003,ooed004,ooed005,ooed006,ooed007,ooed008,'1' FROM ooed_t
   CALL g_tree.clear()
   LET g_cnt = 1
   LET g_sql = " SELECT DISTINCT ooed002,ooed003 FROM ooed_tmp ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed006 <= '",g_today,"' ",
               "    AND ooed007 >= '",g_today,"' ",
               "    AND (ooed009 = '1' OR (ooed009 = '2' AND ooed008 = '",g_ooeb_m.ooeb001,"'))",
               "  ORDER BY ooed002 "
   PREPARE browse_1_pre FROM g_sql
   DECLARE browse_1_cur CURSOR FOR browse_1_pre
   FOREACH browse_1_cur INTO l_pid,l_ooed003
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      LET g_tree[g_cnt].b_pid = "ROOT"
      LET g_tree[g_cnt].b_id = l_pid
      LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id,'(',l_ooed003,')'
      LET g_tree[g_cnt].b_hasC = TRUE
      LET g_tree[g_cnt].b_exp = TRUE
      LET g_cnt = g_cnt +1
      LET g_sql = " SELECT DISTINCT ooed004,ooed005 FROM ooed_tmp ",
                  "  WHERE ooedent = '" ||g_enterprise|| "' ",
                  "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooed006 <= '",g_today,"' ",
                  "    AND ooed007 >= '",g_today,"' ",
                  "    AND (ooed009 = '1' OR (ooed009 = '2' AND ooed008 = '",g_ooeb_m.ooeb001,"'))",
                  "    AND ooed004 <> '",l_pid,"' ",
                  "    AND ooed005 = '",l_pid,"' ",
                  "    AND ooed002 = '",l_pid,"' ",
                  "  ORDER BY ooed005,ooed004 "
      PREPARE browse_2_pre FROM g_sql
      DECLARE browse_2_cur CURSOR FOR browse_2_pre
      FOREACH browse_2_cur INTO g_tree[g_cnt].b_id,g_tree[g_cnt].b_pid
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

            EXIT FOREACH
         END IF
         LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id
         LET g_tree[g_cnt].b_hasC = aooi110_chk_hasC(l_pid,g_tree[g_cnt].b_id)
         IF g_tree[g_cnt].b_hasC THEN
            LET g_tree[g_cnt].b_exp = TRUE
            CALL aooi110_tree_expand(l_pid,g_cnt)
         END IF
         LET g_cnt = g_cnt +1
      END FOREACH
      FREE browse_2_pre
   END FOREACH
   FREE browse_1_pre
   CALL g_tree.deleteElement(g_cnt)
END FUNCTION

#结存档填充树
PRIVATE FUNCTION aooi110_tree_fill()
   DEFINE l_ooed003         LIKE ooed_t.ooed003
   DEFINE l_pid             LIKE type_t.chr100
   DEFINE l_pid_1           LIKE type_t.chr100

   CALL g_tree.clear()
   LET g_cnt = 1
   LET g_sql = " SELECT DISTINCT ooed002,ooed003 FROM ooed_t ",
               "  WHERE ooedent = '" ||g_enterprise|| "' ",
               "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
               "    AND ooed006 <= '",g_today,"' ",
               "    AND ooed007 >= '",g_today,"' ",
               "  ORDER BY ooed002 "
   PREPARE browse_5_pre FROM g_sql
   DECLARE browse_5_cur CURSOR FOR browse_5_pre
   FOREACH browse_5_cur INTO l_pid,l_ooed003
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      LET g_tree[g_cnt].b_pid = "ROOT"
      LET g_tree[g_cnt].b_id = l_pid
      LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id,'(',l_ooed003,')'
      LET g_tree[g_cnt].b_hasC = TRUE
      LET g_tree[g_cnt].b_exp = TRUE
      LET g_cnt = g_cnt +1
      LET g_sql = " SELECT DISTINCT ooed004,ooed005 FROM ooed_t ",
                  "  WHERE ooedent = '" ||g_enterprise|| "' ",
                  "    AND ooed001 = '",g_ooeb_m.ooeb004,"' ",
                  "    AND ooed006 <= '",g_today,"' ",
                  "    AND ooed007 >= '",g_today,"' ",
                  "    AND ooed004 <> '",l_pid,"' ",
                  "    AND ooed002 = '",l_pid,"' ",
                  "  ORDER BY ooed005,ooed004 "
      PREPARE browse_4_pre FROM g_sql
      DECLARE browse_4_cur CURSOR FOR browse_4_pre
      FOREACH browse_4_cur INTO g_tree[g_cnt].b_id,g_tree[g_cnt].b_pid
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

            EXIT FOREACH
         END IF
         LET g_tree[g_cnt].b_show =  g_tree[g_cnt].b_id
         LET g_cnt = g_cnt +1
      END FOREACH
      FREE browse_4_pre
   END FOREACH
   FREE browse_5_pre
   CALL g_tree.deleteElement(g_cnt)
END FUNCTION
#删除临时表资料
PRIVATE FUNCTION aooi110_del_ooed_tmp()
   IF g_action_choice="insert"  THEN
      DELETE FROM ooed_tmp where ooed009 = '2' AND ooed008 <> g_ooeb_m.ooeb001
   ELSE
      DELETE FROM ooed_tmp where ooed009 = '2'
   END IF
END FUNCTION]]>
  </point>
  <section id="aooi110.description" ver="109" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:8,PR版次:8) Build-000796
#+ 
#+ Filename...: aooi110
#+ Description: 組織計劃申請作業
#+ Creator....: 02482(2013-07-01 00:00:00)
#+ Modifier...: 02294(2014-08-22 10:53:35) -SD/PR-
]]>
  </section>
  <section id="aooi110.global" ver="4" status="" src="s" readonly="">
    <![CDATA[#應用 i00 樣板自動產生(Version:3)
{<point name="global.memo" />}
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:free_style模組變數(Module Variable)
{<point name="free_style.variable"/>}
#end add-point
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
]]>
  </section>
  <section id="aooi110.main" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 作業開始
MAIN
   #add-point:main段define (標準程式用)
   {<point name="main.define" edit="s"/>}
   #end add-point    
   #add-point:main段define (客製程式用)
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point
 
   #定義在其他link的程式則無效
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("aoo","")
 
   #add-point:作業初始化
   {<point name="main.init"/>}
   #end add-point
 
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)    #轉換不同資料庫語法
   DECLARE aooi110_cl CURSOR FROM g_forupd_sql 
   
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_aooi110 WITH FORM cl_ap_formpath("aoo",g_code)
 
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
 
      #程式初始化
      CALL aooi110_init()
 
      #進入選單 Menu (='N')
      CALL aooi110_ui_dialog()
   
      #畫面關閉
      CLOSE WINDOW w_aooi110
   END IF
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
 
END MAIN
]]>
  </section>
  <section id="aooi110.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
</add_points>
