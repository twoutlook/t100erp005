<add_points prog="apsp630" std_prog="apsp630" erpver="1.0" module="APS" ver="1" env="s" zone="t10dev" booking="Y">
  <point name="function.apsp630_psos001_chk" cite_std="N" status="" ver="1" src="s" new="Y" order="1" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: APS校驗
# Memo...........:
# Usage..........: CALL apsp630_psos001_chk(p_psos001)
#                  RETURNING r_success
# Input parameter: p_psos001      APS版本
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/23 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_psos001_chk(p_psos001)
DEFINE p_psos001         LIKE psos_t.psos001
DEFINE r_success         LIKE type_t.num5

   LET r_success = TRUE
   
   IF cl_null(p_psos001) THEN
      RETURN r_success
   END IF

   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = p_psos001
   IF NOT cl_chk_exist("v_psca001") THEN
      LET r_success = FALSE
      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_psos001_ref" cite_std="N" status="" ver="1" src="s" new="Y" order="2" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: APS版本說明
# Memo...........:
# Usage..........: CALL apsp630_psos001_ref()
#                  
# Input parameter: 
#                : 
# Return code....: 
#                : 
# Date & Author..: 2014/05/23 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_psos001_ref()
DEFINE l_psos001_desc    LIKE type_t.chr80

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_param.psos001
   CALL ap_ref_array2(g_ref_fields,"SELECT pscal003 FROM pscal_t WHERE pscalent='"||g_enterprise||"' AND pscalsite='"||g_site||"' AND pscal001=? AND pscal002='"||g_lang||"'",
       "") RETURNING g_rtn_fields
   LET l_psos001_desc = '', g_rtn_fields[1] , ''
   DISPLAY l_psos001_desc TO psos001_desc
END FUNCTION]]>
</point>
  <point name="function.apsp630_create_temptable" cite_std="N" status="" ver="1" src="s" new="Y" order="3" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: Create Temp Table
# Memo...........:
# Usage..........: CALL apsp630_create_temptable()
#                       RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/23 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_create_temptable()
DEFINE r_success         LIKE type_t.num5

   LET r_success = TRUE
   
   DROP TABLE apsp630_tmp
   CREATE TEMP TABLE apsp630_tmp(
      docno         LIKE sfaa_t.sfaadocno,
      psos036       LIKE psos_t.psos036
      )
   IF SQLCA.sqlcode THEN
      CALL cl_err('create apsp630_tmp',SQLCA.sqlcode,1)
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   DROP TABLE apsp630_tmp2
   CREATE TEMP TABLE apsp630_tmp2(
      sfaddocno      LIKE sfad_t.sfaddocno,
      sfadseq        LIKE sfad_t.sfadseq,
      sfad001        LIKE sfad_t.sfad001,
      sfad002        LIKE sfad_t.sfad002,
      psos036        LIKE psos_t.psos036)
   IF SQLCA.sqlcode THEN
      CALL cl_err('create apsp630_tmp2',SQLCA.sqlcode,1)
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   DROP TABLE apsp630_tmp3
   CREATE TEMP TABLE apsp630_tmp3(
      sfaedocno      LIKE sfae_t.sfaedocno,
      sfaeseq        LIKE sfae_t.sfaeseq,
      sfae001        LIKE sfae_t.sfae001,
      sfae002        LIKE sfae_t.sfae002,
      psos011        LIKE psos_t.psos011)
   IF SQLCA.sqlcode THEN
      CALL cl_err('create apsp630_tmp3',SQLCA.sqlcode,1)
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_sel_date_into_temptable" cite_std="N" status="" ver="1" src="s" new="Y" order="4" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 抓取psos_t及sfaa_t的所有資料
# Memo...........:
# Usage..........: CALL apsp630_sel_date_into_temptable()
#                  
# Input parameter: 
#                : 
# Return code....: 
#                : 
# Date & Author..: 2014/05/23 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_sel_date_into_temptable()
DEFINE l_temp            RECORD
         docno           LIKE sfaa_t.sfaadocno   #工單
                         END RECORD
DEFINE l_len             LIKE ooaa_t.ooaa002
DEFINE l_sfaa012         LIKE sfaa_t.sfaa012
DEFINE l_psos011         LIKE psos_t.psos011
DEFINE l_psos036         LIKE psos_t.psos036
DEFINE l_cnt             LIKE type_t.num5
DEFINE l_cnt1            LIKE type_t.num5
DEFINE l_cnt2            LIKE type_t.num5
DEFINE l_success         LIKE type_t.num5
DEFINE l_sfad            RECORD LIKE sfad_t.*
DEFINE l_sfae            RECORD LIKE sfae_t.*


   LET l_success = TRUE
   CALL cl_get_para(g_enterprise,g_site,'E-COM-0005')
        RETURNING l_len
        
   LET g_sql = "SELECT sfaadocno,sfaa012 ",
               "  FROM psos_t,",
               "       sfaa_t LEFT JOIN imaa_t ON imaaent = sfaaent AND imaa001 = sfaa010 ",
               "              LEFT JOIN imaf_t ON imafent = sfaaent AND imafsite= sfaasite AND imaf001 = sfaa010 ",
               "              LEFT JOIN imae_t ON imaeent = sfaaent AND imaesite= sfaasite AND imae001 = sfaa010 ",
               " WHERE psosent = ",g_enterprise,
               "   AND sfaaent = psosent ",
               "   AND psossite='",g_site,"'",
               "   AND sfaasite= psossite ",
               "   AND SUBSTR(psos004,1,",l_len,") = sfaadocno ",
               "   AND psos001 = '",g_param.psos001,"'",
               "   AND psos002 = '",g_psos002,"'",
               "   AND psos009 = 0 ",   #建議單據(is_new)
               "   AND sfaastus IN ('F','Y') ",
               "   AND ",g_param.wc CLIPPED
   IF g_param.a1 = 'N' THEN
      LET g_sql = g_sql CLIPPED," AND sfaa045 IS NULL "
   END IF
   IF g_param.b1 = 'N' THEN
      LET g_sql = g_sql CLIPPED," AND sfaa046 IS NULL "
   END IF
   IF g_param.c1 = 'N' THEN
      LET g_sql = g_sql CLIPPED," AND psos057 = 'N' "
   END IF
   LET g_sql = g_sql CLIPPED," GROUP BY sfaadocno,sfaa012 "
   
   PREPARE apsp630_tmp_pre FROM g_sql
   DECLARE apsp630_tmp_cs CURSOR FOR apsp630_tmp_pre
   
   FOREACH apsp630_tmp_cs INTO l_temp.docno,l_sfaa012
     
      LET l_cnt = 0
      LET l_cnt1 = 0
      LET l_cnt2 = 0
      SELECT COUNT(*) INTO l_cnt FROM sfad_t
       WHERE sfadent = g_enterprise
         AND sfaddocno = l_temp.docno
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt = 0 THEN
         #建議生產數量
         LET l_psos036 = 0
         DECLARE psos036_cs CURSOR FOR
          SELECT psos036
            FROM psos_t
           WHERE psosent = g_enterprise
             AND psossite= g_site
             AND psos001 = g_param.psos001
             AND psos002 = g_psos002
             AND SUBSTR(psos004,1,l_len) = l_temp.docno
         FOREACH psos036_cs INTO l_psos036 
            EXIT FOREACH
         END FOREACH
      ELSE
         #生產數量
         SELECT COUNT(*) INTO l_cnt1 FROM sfad_t,psos_t
          WHERE psosent = g_enterprise
            AND sfadent = psosent
            AND psossite= g_site
            AND sfadsite= psossite
            AND SUBSTR(psos004,1,l_len) = l_temp.docno
            AND sfaddocno = l_temp.docno
            AND sfadseq = TO_NUMBER(SUBSTR(psos004,l_len+2,LENGTH(psos004)))
            AND psos055 = sfad001
            AND psos036 <> sfad002
         IF cl_null(l_cnt1) THEN LET l_cnt1 = 0 END IF
      END IF
      
      #完工日
      SELECT COUNT(*) INTO l_cnt2 FROM sfae_t,psos_t
       WHERE psosent = g_enterprise
         AND sfaeent = psosent
         AND psossite= g_site
         AND sfaesite= psossite
         AND SUBSTR(psos004,1,l_len) = l_temp.docno
         AND sfaedocno = l_temp.docno
         AND sfaeseq = TO_NUMBER(SUBSTR(psos004,l_len+2,LENGTH(psos004)))
         AND psos011 <> sfae002
      IF cl_null(l_cnt2) THEN LET l_cnt2 = 0 END IF
         
      #建議生產量<>原生產數量
      IF (l_psos036 <> l_sfaa012 AND l_cnt = 0) OR l_cnt1 > 0 OR l_cnt2 > 0 THEN
         INSERT INTO apsp630_tmp(docno,psos036)
            VALUES(l_temp.docno,l_psos036)
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err('ins apsp630_temp:',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         
         #將產品特徵資料寫入temp table
         DECLARE sfad_cs CURSOR FOR
          SELECT sfaddocno,sfadseq,sfad001,sfad002
            FROM sfad_t
           WHERE sfadent = g_enterprise
             AND sfaddocno = l_temp.docno
           ORDER BY sfadseq
         FOREACH sfad_cs INTO l_sfad.sfaddocno,l_sfad.sfadseq,l_sfad.sfad001,l_sfad.sfad002
         
            LET l_psos036 = 0
            SELECT psos036 INTO l_psos036
              FROM psos_t
             WHERE psosent = g_enterprise
               AND psossite= g_site
               AND psos001 = g_param.psos001
               AND psos002 = g_psos002
               AND SUBSTR(psos004,1,l_len) = l_sfad.sfaddocno
               AND TO_NUMBER(SUBSTR(psos004,l_len+2,LENGTH(psos004))) = l_sfad.sfadseq
            IF cl_null(l_psos036) THEN LET l_psos036 = 0 END IF
            
            INSERT INTO apsp630_tmp2(sfaddocno,sfadseq,sfad001,sfad002,psos036)
               VALUES(l_sfad.sfaddocno,l_sfad.sfadseq,l_sfad.sfad001,l_sfad.sfad002,l_psos036)
            IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
               LET l_success = FALSE
               CALL cl_err('ins apsp630_tmp2',SQLCA.sqlcode,1)
               EXIT FOREACH
            END IF
         END FOREACH
         IF NOT l_success THEN
            EXIT FOREACH
         END IF
         
         #將完工日資料寫入temp table
         DECLARE sfae_cs CURSOR FOR
          SELECT sfaedocno,sfaeseq,sfae001,sfae002
            FROM sfae_t
           WHERE sfaeent = g_enterprise
             AND sfaedocno = l_temp.docno
           ORDER BY sfaeseq
         FOREACH sfae_cs INTO l_sfae.sfaedocno,l_sfae.sfaeseq,l_sfae.sfae001,l_sfae.sfae002
            
            LET l_psos011 = ''
            SELECT psos011 INTO l_psos011
              FROM psos_t
             WHERE psosent = g_enterprise
               AND psossite= g_site
               AND psos001 = g_param.psos001
               AND psos002 = g_psos002
               AND SUBSTR(psos004,1,l_len) = l_sfae.sfaedocno
               AND TO_NUMBER(SUBSTR(psos004,l_len+2,LENGTH(psos004))) = l_sfae.sfaeseq
               
            INSERT INTO apsp630_tmp3(sfaedocno,sfaeseq,sfae001,sfae002,psos011)
               VALUES(l_sfae.sfaedocno,l_sfae.sfaeseq,l_sfae.sfae001,l_sfae.sfae002,l_psos011)
            IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
               LET l_success = FALSE
               CALL cl_err('ins apsp630_tmp3',SQLCA.sqlcode,1)
               EXIT FOREACH
            END IF
         END FOREACH
         IF NOT l_success THEN
            EXIT FOREACH
         END IF
      END IF
   END FOREACH
END FUNCTION]]>
</point>
  <point name="function.apsp630_batch_execute" cite_std="N" status="" ver="1" src="s" new="Y" order="5" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 批次作業
# Memo...........:
# Usage..........: CALL apsp630_batch_execute()
#                  
# Input parameter: 
#                : 
# Return code....: 
#                : 
# Date & Author..: 2014/05/27 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_batch_execute()
DEFINE l_sel_cnt         LIKE type_t.num5
DEFINE l_tot_success     LIKE type_t.num5
DEFINE l_success         LIKE type_t.num5

   LET l_sel_cnt = 0
   LET l_tot_success = TRUE
   LET l_success = TRUE
   CALL s_transaction_begin()
   CALL cl_showmsg_init()
   
   FOR l_ac = 1 TO g_detail_d.getLength()
      IF g_detail_d[l_ac].sel = 'N' THEN
         CONTINUE FOR
      END IF
   
      IF NOT l_success THEN
         LET l_tot_success = FALSE
      END IF
      LET l_success = TRUE
      
      #累計選擇'Y'的筆數
      LET l_sel_cnt = l_sel_cnt + 1
      
      #針對選擇'Y'的資料做處理
      CALL apsp630_asft800_gen()
           RETURNING l_success
      IF NOT l_success THEN
         CONTINUE FOR
      END IF
      
#      #更新已轉單據='Y'、產生工單單號=sfaadocno
#      UPDATE psos_t SET psos057 = 'Y',
#                        psos058 = g_sfaa.sfaadocno
#       WHERE psosent = g_enterprise
#         AND psossite= g_site
#         AND psos001 = g_param.psos001
#         AND psos002 = g_psos002
#         AND psos004 = g_detail_d[l_ac].psos004
#      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
#         LET l_success = FALSE
#         CALL cl_errmsg('psos004',g_detail_d[l_ac].psos004,'upd psos_t',SQLCA.sqlcode,1)
#         CONTINUE FOR
#      END IF
   END FOR
   
   IF cl_null(l_sel_cnt) OR l_sel_cnt = 0 THEN
      CALL cl_err('','afa-00063',1)
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL cl_showmsg()
   LET l_success = l_tot_success
   
   IF l_success THEN
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen" cite_std="N" status="" ver="1" src="s" new="Y" order="6" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/27 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen()
DEFINE r_success         LIKE type_t.num5

   LET r_success = TRUE
 
   #產生工單變更單單頭資料
   CALL apsp630_asft800_gen_sfka()
        RETURNING r_success
   IF NOT r_success THEN 
      RETURN r_success
   END IF
   
   #產生工單變更單工單來源資料
   CALL apsp630_asft800_gen_sfkb()
        RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   #產生工單變更單生產料號明細資料
   CALL apsp630_asft800_gen_sfkc()
        RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   #產生工單變更單特徵資料
   CALL apsp630_asft800_gen_sfkd()
        RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   #產生工單變更單計劃完工日資料
   CALL apsp630_asft800_gen_sfke()
        RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   #產生工單變更單商品序號資料
   CALL apsp630_asft800_gen_sfkf()
        RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   #產生工單變更單備料檔資料
   CALL apsp630_asft800_gen_sfkg()
        RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
     
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfka" cite_std="N" status="" ver="1" src="s" new="Y" order="7" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單單頭資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfka()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/27 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfka()
DEFINE r_success         LIKE type_t.num5
DEFINE l_sfaa            RECORD LIKE sfaa_t.*
DEFINE l_sfka            RECORD LIKE sfka_t.*
DEFINE l_current         DATETIME YEAR TO SECOND  #日期時間

   LET r_success = TRUE

   SELECT * INTO l_sfaa.* FROM sfaa_t 
    WHERE sfaaent = g_enterprise
      AND sfaadocno = g_detail_d[l_ac].sfaadocno
   
   LET l_sfka.sfkaent = g_enterprise
   LET l_sfka.sfkasite = g_site
   LET l_sfka.sfkadocno = l_sfaa.sfaadocno
   LET l_sfka.sfkadocdt = l_sfaa.sfaadocdt
   LET l_sfka.sfka001 = l_sfaa.sfaa001 + 1   #版本 = 目前[T:工單單頭檔].[C:版本]加1
   SELECT MAX(sfka900) INTO l_sfka.sfka900 
     FROM sfka_t
    WHERE sfkaent = g_enterprise
      AND sfkadocno = l_sfka.sfkadocno
   IF cl_null(l_sfka.sfka900) THEN
      LET l_sfka.sfka900 = 1
   END IF
   LET g_sfka900 = l_sfka.sfka900
   LET l_sfka.sfka002 = l_sfaa.sfaa002
   LET l_sfka.sfka003 = l_sfaa.sfaa003
   LET l_sfka.sfka004 = l_sfaa.sfaa004
   LET l_sfka.sfka005 = l_sfaa.sfaa005
   LET l_sfka.sfka006 = l_sfaa.sfaa006
   LET l_sfka.sfka007 = l_sfaa.sfaa007
   LET l_sfka.sfka008 = l_sfaa.sfaa008
   LET l_sfka.sfka009 = l_sfaa.sfaa009
   LET l_sfka.sfka010 = l_sfaa.sfaa010
   LET l_sfka.sfka011 = l_sfaa.sfaa011
   LET l_sfka.sfka012 = g_detail_d[l_ac].psos036
   LET l_sfka.sfka013 = l_sfaa.sfaa013
   LET l_sfka.sfka014 = l_sfaa.sfaa014
   LET l_sfka.sfka015 = l_sfaa.sfaa015
   LET l_sfka.sfka016 = l_sfaa.sfaa016
   LET l_sfka.sfka017 = l_sfaa.sfaa017
   LET l_sfka.sfka018 = l_sfaa.sfaa018
   LET l_sfka.sfka019 = l_sfaa.sfaa019
   LET l_sfka.sfka020 = g_detail_d[l_ac].psos011
   LET l_sfka.sfka021 = l_sfaa.sfaa021
   LET l_sfka.sfka022 = l_sfaa.sfaa022
   LET l_sfka.sfka023 = l_sfaa.sfaa023
   LET l_sfka.sfka024 = l_sfaa.sfaa024
   LET l_sfka.sfka025 = l_sfaa.sfaa025
   LET l_sfka.sfka026 = l_sfaa.sfaa026
   LET l_sfka.sfka027 = l_sfaa.sfaa027
   LET l_sfka.sfka028 = l_sfaa.sfaa028
   LET l_sfka.sfka029 = l_sfaa.sfaa029
   LET l_sfka.sfka030 = l_sfaa.sfaa030
   LET l_sfka.sfka031 = l_sfaa.sfaa031
   LET l_sfka.sfka032 = l_sfaa.sfaa032
   LET l_sfka.sfka033 = l_sfaa.sfaa033
   LET l_sfka.sfka034 = l_sfaa.sfaa034
   LET l_sfka.sfka035 = l_sfaa.sfaa035
   LET l_sfka.sfka036 = l_sfaa.sfaa036
   LET l_sfka.sfka037 = l_sfaa.sfaa037
   LET l_sfka.sfka038 = l_sfaa.sfaa038
   LET l_sfka.sfka039 = l_sfaa.sfaa039
   LET l_sfka.sfka040 = l_sfaa.sfaa040
   LET l_sfka.sfka041 = l_sfaa.sfaa041
   LET l_sfka.sfka042 = l_sfaa.sfaa042
   LET l_sfka.sfka043 = l_sfaa.sfaa043
   LET l_sfka.sfka044 = l_sfaa.sfaa044
   LET l_sfka.sfka045 = l_sfaa.sfaa045
   LET l_sfka.sfka046 = l_sfaa.sfaa046
   LET l_sfka.sfka047 = l_sfaa.sfaa047
   LET l_sfka.sfka048 = l_sfaa.sfaa048
   LET l_sfka.sfka049 = l_sfaa.sfaa049
   LET l_sfka.sfka050 = l_sfaa.sfaa050
   LET l_sfka.sfka051 = l_sfaa.sfaa051
   LET l_sfka.sfka052 = l_sfaa.sfaa052
   LET l_sfka.sfka053 = l_sfaa.sfaa053
   LET l_sfka.sfka054 = l_sfaa.sfaa054
   LET l_sfka.sfka055 = l_sfaa.sfaa055
   LET l_sfka.sfka056 = l_sfaa.sfaa056
   LET l_sfka.sfka057 = l_sfaa.sfaa057
   LET l_sfka.sfka058 = l_sfaa.sfaa058
   LET l_sfka.sfka059 = l_sfaa.sfaa059
   LET l_sfka.sfka060 = l_sfaa.sfaa060
   LET l_sfka.sfka061 = l_sfaa.sfaa061
   LET l_sfka.sfka062 = l_sfaa.sfaa062
   LET l_sfka.sfka063 = l_sfaa.sfaa063
   LET l_sfka.sfka064 = l_sfaa.sfaa064
   LET l_sfka.sfka065 = l_sfaa.sfaa065
   LET l_sfka.sfka901 = 'Y'
   LET l_sfka.sfka902 = g_today
   LET l_sfka.sfkaownid =  g_user
   LET l_sfka.sfkaowndp =  g_dept
   LET l_sfka.sfkacrtid =  g_user
   LET l_sfka.sfkacrtdp =  g_dept 
   LET l_sfka.sfkacrtdt =  ""
   LET l_sfka.sfkamodid =  g_user
   LET l_sfka.sfkamoddt =  ""
   LET l_sfka.sfkacnfid =  ""
   LET l_sfka.sfkacnfdt =  ""
   LET l_sfka.sfkapstid =  ""
   LET l_sfka.sfkapstdt =  ""
   LET l_sfka.sfkastus  =  "N"
   LET l_sfka.sfkaacti  =  "N"
   
   LET l_current = cl_get_current()

   INSERT INTO sfka_t
      (sfkaent,sfkasite,sfkadocno,sfka900,sfka901,sfka902,
       sfka001,sfka002,sfka003,sfka004,sfka005,sfka006,sfka007,sfka008,sfka009,sfka010,
       sfka011,sfka012,sfka013,sfka014,sfka015,sfka016,sfka017,sfka018,sfka019,sfka020,
       sfka021,sfka022,sfka023,sfka024,sfka025,sfka026,sfka027,sfka028,sfka029,sfka030,
       sfka031,sfka032,sfka033,sfka034,sfka035,sfka036,sfka037,sfka038,sfka039,sfka040,
       sfka041,sfka042,sfka043,sfka044,sfka045,sfka046,sfka047,sfka048,sfka049,sfka050,
       sfka051,sfka052,sfka053,sfka054,sfka055,sfka056,sfka057,sfka058,sfka059,sfka060,
       sfka061,sfka062,sfka063,sfka064,sfka065,
       sfkaownid,sfkaowndp,sfkacrtid,sfkacrtdp,sfkacrtdt,sfkamodid,sfkamoddt)
      VALUES
      (l_sfka.sfkaent,l_sfka.sfkasite,l_sfka.sfkadocno,l_sfka.sfka900,l_sfka.sfka901,l_sfka.sfka902,
       l_sfka.sfka001,l_sfka.sfka002,l_sfka.sfka003,l_sfka.sfka004,l_sfka.sfka005,
       l_sfka.sfka006,l_sfka.sfka007,l_sfka.sfka008,l_sfka.sfka009,l_sfka.sfka010,
       l_sfka.sfka011,l_sfka.sfka012,l_sfka.sfka013,l_sfka.sfka014,l_sfka.sfka015,
       l_sfka.sfka016,l_sfka.sfka017,l_sfka.sfka018,l_sfka.sfka009,l_sfka.sfka020,
       l_sfka.sfka021,l_sfka.sfka022,l_sfka.sfka023,l_sfka.sfka024,l_sfka.sfka025,
       l_sfka.sfka026,l_sfka.sfka027,l_sfka.sfka028,l_sfka.sfka009,l_sfka.sfka030,
       l_sfka.sfka031,l_sfka.sfka032,l_sfka.sfka033,l_sfka.sfka034,l_sfka.sfka035,
       l_sfka.sfka036,l_sfka.sfka037,l_sfka.sfka038,l_sfka.sfka009,l_sfka.sfka040,
       l_sfka.sfka041,l_sfka.sfka042,l_sfka.sfka043,l_sfka.sfka044,l_sfka.sfka045,
       l_sfka.sfka046,l_sfka.sfka047,l_sfka.sfka048,l_sfka.sfka009,l_sfka.sfka050,
       l_sfka.sfka051,l_sfka.sfka052,l_sfka.sfka053,l_sfka.sfka054,l_sfka.sfka055,
       l_sfka.sfka056,l_sfka.sfka057,l_sfka.sfka058,l_sfka.sfka009,l_sfka.sfka060,
       l_sfka.sfka061,l_sfka.sfka062,l_sfka.sfka063,l_sfka.sfka064,l_sfka.sfka065,
       l_sfka.sfkaownid,l_sfka.sfkaowndp,l_sfka.sfkacrtid,l_sfka.sfkacrtdp,l_current,
       l_sfka.sfkamodid,l_current)
   IF SQLCA.sqlcode THEN
      CALL cl_errmsg('sfkadocno',l_sfka.sfkadocno,'INSERT sfka_t',SQLCA.sqlcode,1)
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfkb" cite_std="N" status="" ver="1" src="s" new="Y" order="8" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單工單來源資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfkb()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/27 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfkb()
DEFINE r_success              LIKE type_t.num5
DEFINE l_sfab                 RECORD LIKE sfab_t.*
DEFINE l_sfkb                 RECORD LIKE sfkb_t.*
DEFINE l_msg                  LIKE type_t.chr100

   LET r_success = TRUE
   
   DECLARE asft800_gen_sfkb_cs CURSOR FOR 
    SELECT * FROM sfab_t
     WHERE sfabent = g_enterprise 
       AND sfabdocno = g_detail_d[l_ac].sfaadocno
       
   FOREACH asft800_gen_sfkb_cs INTO l_sfab.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_sfkb.sfkbent = g_enterprise 
      LET l_sfkb.sfkbsite = g_site
      LET l_sfkb.sfkbdocno = l_sfab.sfabdocno
      LET l_sfkb.sfkbseq = l_sfab.sfabseq
      LET l_sfkb.sfkb001 = l_sfab.sfab001
      LET l_sfkb.sfkb002 = l_sfab.sfab002
      LET l_sfkb.sfkb003 = l_sfab.sfab003
      LET l_sfkb.sfkb004 = l_sfab.sfab004
      LET l_sfkb.sfkb005 = l_sfab.sfab005
      LET l_sfkb.sfkb006 = l_sfab.sfab006
      LET l_sfkb.sfkb007 = l_sfab.sfab007
      LET l_sfkb.sfkb900 = g_sfka900
      LET l_sfkb.sfkb901 = '1'
      
      INSERT INTO sfkb_t 
         (sfkbent,sfkbsite,sfkbdocno,sfkb900,sfkb901,sfkbseq,
          sfkb001,sfkb002,sfkb003,sfkb004,sfkb005,sfkb006,sfkb007)
         VALUES
         (l_sfkb.sfkbent,l_sfkb.sfkbsite,l_sfkb.sfkbdocno,l_sfkb.sfkb900,l_sfkb.sfkb901,
          l_sfkb.sfkbseq,
          l_sfkb.sfkb001,l_sfkb.sfkb002,l_sfkb.sfkb003,l_sfkb.sfkb004,l_sfkb.sfkb005,
          l_sfkb.sfkb006,l_sfkb.sfkb007)
      IF SQLCA.sqlcode THEN
         LET l_msg = l_sfkb.sfkbdocno,"/",l_sfkb.sfkbseq
         CALL cl_errmsg('sfkbdocno,sfkbseq',l_msg,'INSERT sfkb_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      INITIALIZE l_sfab.* TO NULL   
   END FOREACH
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfkc" cite_std="N" status="" ver="1" src="s" new="Y" order="9" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單生產料號明細資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfkc()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/27 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfkc()
DEFINE r_success         LIKE type_t.num5
DEFINE l_sfac            RECORD LIKE sfac_t.*
DEFINE l_sfkc            RECORD LIKE sfkc_t.*
DEFINE l_msg             LIKE type_t.chr100

   LET r_success = TRUE

   DECLARE asft800_gen_sfkc_cs CURSOR FOR 
    SELECT * FROM sfac_t 
     WHERE sfacent = g_enterprise
       AND sfacdocno = g_detail_d[l_ac].sfaadocno
       
   FOREACH asft800_gen_sfkc_cs INTO l_sfac.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_sfkc.sfkcent = g_enterprise 
      LET l_sfkc.sfkcsite = g_site
      LET l_sfkc.sfkcdocno = l_sfac.sfacdocno
      LET l_sfkc.sfkcseq = l_sfac.sfacseq
      LET l_sfkc.sfkc001 = l_sfac.sfac001
      LET l_sfkc.sfkc002 = l_sfac.sfac002
      LET l_sfkc.sfkc003 = l_sfac.sfac003
      LET l_sfkc.sfkc004 = l_sfac.sfac004
      LET l_sfkc.sfkc005 = l_sfac.sfac005
      LET l_sfkc.sfkc900 = g_sfka900
      LET l_sfkc.sfkc901 = '1'
      
      INSERT INTO sfkc_t
         (sfkcent,sfkcsite,sfkcdocno,sfkc900,sfkc901,sfkcseq,
          sfkc001,sfkc002,sfkc003,sfkc004,sfkc005)
         VALUES
         (l_sfkc.sfkcent,l_sfkc.sfkcsite,l_sfkc.sfkcdocno,l_sfkc.sfkc900,l_sfkc.sfkc901,
          l_sfkc.sfkcseq,
          l_sfkc.sfkc001,l_sfkc.sfkc002,l_sfkc.sfkc003,l_sfkc.sfkc004,l_sfkc.sfkc005)
      IF SQLCA.sqlcode THEN
         LET l_msg = l_sfkc.sfkcdocno,"/",l_sfkc.sfkcseq
         CALL cl_errmsg('sfkcdocno,sfkcseq',l_msg,'INSERT sfkc_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      INITIALIZE l_sfac.* TO NULL 
   END FOREACH

   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfkd" cite_std="N" status="" ver="1" src="s" new="Y" order="10" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單特徵資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfkd()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/27 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfkd()
DEFINE r_success         LIKE type_t.num5
DEFINE l_sfad            RECORD LIKE sfad_t.*
DEFINE l_sfkd            RECORD LIKE sfkd_t.*
DEFINE l_msg             LIKE type_t.chr100

   LET r_success = TRUE

   DECLARE asft800_gen_sfkd_cs CURSOR FOR 
    SELECT * FROM sfad_t 
     WHERE sfadent = g_enterprise
       AND sfaddocno = g_detail_d[l_ac].sfaadocno
       
   FOREACH asft800_gen_sfkd_cs INTO l_sfad.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_sfkd.sfkdent = g_enterprise 
      LET l_sfkd.sfkdsite = g_site
      LET l_sfkd.sfkddocno = l_sfad.sfaddocno
      LET l_sfkd.sfkdseq = l_sfad.sfadseq
      LET l_sfkd.sfkd001 = l_sfad.sfad001
      SELECT psos036 INTO l_sfkd.sfkd002
        FROM apsp630_tmp2
       WHERE sfaddocno = l_sfkd.sfkddocno
         AND sfadseq = l_sfad.sfadseq
      LET l_sfkd.sfkd003 = l_sfad.sfad003
      LET l_sfkd.sfkd900 = g_sfka900
      IF l_sfkd.sfkd002 = l_sfad.sfad002 THEN
         LET l_sfkd.sfkd901 = '1'
      ELSE
         LET l_sfkd.sfkd901 = '2'
      END IF
      
      INSERT INTO sfkd_t 
         (sfkdent,sfkdsite,sfkddocno,sfkd900,sfkd901,sfkdseq,
          sfkd001,sfkd002,sfkd003)
         VALUES
         (l_sfkd.sfkdent,l_sfkd.sfkdsite,l_sfkd.sfkddocno,l_sfkd.sfkd900,l_sfkd.sfkd901,
          l_sfkd.sfkdseq,
          l_sfkd.sfkd001,l_sfkd.sfkd002,l_sfkd.sfkd003)
      IF SQLCA.sqlcode THEN
         LET l_msg = l_sfkd.sfkddocno,"/",l_sfkd.sfkdseq
         CALL cl_errmsg('sfkddocno,sfkdseq',l_msg,'INSERT sfkd_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         EXIT FOREACH
      END IF
          
      INITIALIZE l_sfad.* TO NULL  
   END FOREACH
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfke" cite_std="N" status="" ver="1" src="s" new="Y" order="11" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單計劃完工日資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfke()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/28 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfke()
DEFINE r_success         LIKE type_t.num5
DEFINE l_sfae            RECORD LIKE sfae_t.*
DEFINE l_sfke            RECORD LIKE sfke_t.*
DEFINE l_msg             LIKE type_t.chr100

   LET r_success = TRUE

   DECLARE asft800_gen_sfke_cs CURSOR FOR 
    SELECT * FROM sfae_t 
     WHERE sfaeent = g_enterprise 
       AND sfaedocno = g_detail_d[l_ac].sfaadocno
       
   FOREACH asft800_gen_sfke_cs INTO l_sfae.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_sfke.sfkeent = g_enterprise 
      LET l_sfke.sfkesite = g_site
      LET l_sfke.sfkedocno = l_sfae.sfaedocno
      LET l_sfke.sfkeseq = l_sfae.sfaeseq
      LET l_sfke.sfke001 = l_sfae.sfae001
      SELECT psos011 INTO l_sfke.sfke002
        FROM apsp630_tmp3
       WHERE sfaedocno = l_sfke.sfkedocno  
         AND sfaeseq = l_sfke.sfkeseq
      LET l_sfke.sfke003 = l_sfae.sfae003
      LET l_sfke.sfke004 = l_sfae.sfae004
      LET l_sfke.sfke005 = l_sfae.sfae005
      LET l_sfke.sfke006 = l_sfae.sfae006
      LET l_sfke.sfke900 = g_sfka900
      IF l_sfke.sfke002 = l_sfae.sfae002 THEN
         LET l_sfke.sfke901 = '1'
      ELSE
         LET l_sfke.sfke901 = '2'
      END IF
      
      INSERT INTO sfke_t 
         (sfkeent,sfkesite,sfkedocno,sfke900,sfke901,sfkeseq,
          sfke001,sfke002,sfke003,sfke004,sfke005,sfke006)
         VALUES
         (l_sfke.sfkeent,l_sfke.sfkesite,l_sfke.sfkedocno,l_sfke.sfke900,l_sfke.sfke901,
          l_sfke.sfkeseq,
          l_sfke.sfke001,l_sfke.sfke002,l_sfke.sfke003,l_sfke.sfke004,l_sfke.sfke005,
          l_sfke.sfke006)
      IF SQLCA.sqlcode THEN
         LET l_msg = l_sfke.sfkedocno,"/",l_sfke.sfkeseq
         CALL cl_errmsg('sfkedocno,sfkeseq',l_msg,'INSERT sfke_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         EXIT FOREACH
      END IF
          
      INITIALIZE l_sfae.* TO NULL  
   END FOREACH
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfkf" cite_std="N" status="" ver="1" src="s" new="Y" order="12" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單商品序號資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfkf()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/28 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfkf()
DEFINE r_success         LIKE type_t.num5
DEFINE l_sfaf            RECORD LIKE sfaf_t.*
DEFINE l_sfkf            RECORD LIKE sfkf_t.*
DEFINE l_msg             LIKE type_t.chr100

   LET r_success = TRUE

   DECLARE asft800_gen_sfkf_cs CURSOR FOR 
    SELECT * FROM sfaf_t 
     WHERE sfafent = g_enterprise 
       AND sfafdocno = g_detail_d[l_ac].sfaadocno
       
   FOREACH asft800_gen_sfkf_cs INTO l_sfaf.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_sfkf.sfkfent = g_enterprise 
      LET l_sfkf.sfkfsite = g_site
      LET l_sfkf.sfkfdocno = l_sfaf.sfafdocno
      LET l_sfkf.sfkfseq = l_sfaf.sfafseq
      LET l_sfkf.sfkf001 = l_sfaf.sfaf001
      LET l_sfkf.sfkf900 = g_sfka900
      LET l_sfkf.sfkf901 = '1'
      
      INSERT INTO sfkf_t 
         (sfkfent,sfkfsite,sfkfdocno,sfkf900,sfkf901,sfkfseq,
          sfkf001)
         VALUES
         (l_sfkf.sfkfent,l_sfkf.sfkfsite,l_sfkf.sfkfdocno,l_sfkf.sfkf900,l_sfkf.sfkf901,
          l_sfkf.sfkfseq,
          l_sfkf.sfkf001)
      IF SQLCA.sqlcode THEN
         LET l_msg = l_sfkf.sfkfdocno,"/",l_sfkf.sfkfseq
         CALL cl_errmsg('sfkfdocno,sfkfseq',l_msg,'INSERT sfkf_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      INITIALIZE l_sfaf.* TO NULL   #清空数组
   END FOREACH
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.apsp630_asft800_gen_sfkg" cite_std="N" status="" ver="1" src="s" new="Y" order="13" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 產生工單變更單備料檔資料
# Memo...........:
# Usage..........: CALL apsp630_asft800_gen_sfkg()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: r_success      TRUE/FALSE
#                : 
# Date & Author..: 2014/05/28 By stellar0130
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp630_asft800_gen_sfkg()
DEFINE r_success         LIKE type_t.num5
DEFINE l_sfba            RECORD LIKE sfba_t.*
DEFINE l_sfkg            RECORD LIKE sfkg_t.*
DEFINE l_msg             LIKE type_t.chr100

   LET r_success = TRUE

   DECLARE asft800_gen_sfkg_cs CURSOR FOR 
    SELECT * FROM sfba_t 
     WHERE sfbaent = g_enterprise 
       AND sfbadocno = g_detail_d[l_ac].sfaadocno
       
   FOREACH asft800_gen_sfkg_cs INTO l_sfba.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_sfkg.sfkgent = g_enterprise 
      LET l_sfkg.sfkgsite = g_site
      LET l_sfkg.sfkgdocno = l_sfba.sfbadocno
      LET l_sfkg.sfkgseq = l_sfba.sfbaseq
      LET l_sfkg.sfkgseq1 = l_sfba.sfbaseq1
      LET l_sfkg.sfkg001 = l_sfba.sfba001
      LET l_sfkg.sfkg002 = l_sfba.sfba002
      LET l_sfkg.sfkg003 = l_sfba.sfba003
      LET l_sfkg.sfkg004 = l_sfba.sfba004
      LET l_sfkg.sfkg005 = l_sfba.sfba005
      LET l_sfkg.sfkg006 = l_sfba.sfba006
      LET l_sfkg.sfkg007 = l_sfba.sfba007
      LET l_sfkg.sfkg008 = l_sfba.sfba008
      LET l_sfkg.sfkg009 = l_sfba.sfba009
      LET l_sfkg.sfkg010 = l_sfba.sfba010
      LET l_sfkg.sfkg011 = l_sfba.sfba011
      LET l_sfkg.sfkg012 = l_sfba.sfba012
      LET l_sfkg.sfkg013 = l_sfba.sfba013
      LET l_sfkg.sfkg014 = l_sfba.sfba014
      LET l_sfkg.sfkg015 = l_sfba.sfba015
      LET l_sfkg.sfkg016 = l_sfba.sfba016
      LET l_sfkg.sfkg017 = l_sfba.sfba017
      LET l_sfkg.sfkg018 = l_sfba.sfba018
      LET l_sfkg.sfkg019 = l_sfba.sfba019
      LET l_sfkg.sfkg020 = l_sfba.sfba020
      LET l_sfkg.sfkg021 = l_sfba.sfba021
      LET l_sfkg.sfkg022 = l_sfba.sfba022
      LET l_sfkg.sfkg023 = l_sfba.sfba023
      LET l_sfkg.sfkg024 = l_sfba.sfba024
      LET l_sfkg.sfkg025 = l_sfba.sfba025
      LET l_sfkg.sfkg026 = l_sfba.sfba026
      LET l_sfkg.sfkg027 = l_sfba.sfba027
      LET l_sfkg.sfkg028 = l_sfba.sfba028
      LET l_sfkg.sfkg900 = g_sfka900
      LET l_sfkg.sfkg901 = '1'
      
      INSERT INTO sfkg_t
         (sfkgent,sfkgsite,sfkgdocno,sfkg900,sfkg901,sfkgseq,
          sfkg001,sfkg002,sfkg003,sfkg004,sfkg005,sfkg006,sfkg007,sfkg008,sfkg009,sfkg010,
          sfkg011,sfkg012,sfkg013,sfkg014,sfkg015,sfkg016,sfkg017,sfkg018,sfkg019,sfkg020,
          sfkg021,sfkg022,sfkg023,sfkg024,sfkg025,sfkg026,sfkg027,sfkg028)
         VALUES
         (l_sfkg.sfkgent,l_sfkg.sfkgsite,l_sfkg.sfkgdocno,l_sfkg.sfkg900,l_sfkg.sfkg901,
          l_sfkg.sfkgseq,
          l_sfkg.sfkg001,l_sfkg.sfkg002,l_sfkg.sfkg003,l_sfkg.sfkg004,l_sfkg.sfkg005,
          l_sfkg.sfkg006,l_sfkg.sfkg007,l_sfkg.sfkg008,l_sfkg.sfkg009,l_sfkg.sfkg010,
          l_sfkg.sfkg011,l_sfkg.sfkg012,l_sfkg.sfkg013,l_sfkg.sfkg014,l_sfkg.sfkg015,
          l_sfkg.sfkg016,l_sfkg.sfkg017,l_sfkg.sfkg018,l_sfkg.sfkg019,l_sfkg.sfkg020,
          l_sfkg.sfkg021,l_sfkg.sfkg022,l_sfkg.sfkg023,l_sfkg.sfkg024,l_sfkg.sfkg025,
          l_sfkg.sfkg026,l_sfkg.sfkg027,l_sfkg.sfkg028)
      IF SQLCA.sqlcode THEN
         LET l_msg = l_sfkg.sfkgdocno,"/",l_sfkg.sfkgseq
         CALL cl_errmsg('sfkgdocno,sfkgseq',l_msg,'INSERT sfkg_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      INITIALIZE l_sfba.* TO NULL   #清空数组
   END FOREACH
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="b_fill.clear" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   CALL g_detail2_d.clear()
   CALL g_detail3_d.clear()]]>
</point>
  <point name="b_fill.define" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   DEFINE l_success       LIKE type_t.num5]]>
</point>
  <point name="b_fill.foreach_into" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[      g_detail_d[l_ac].sel,g_detail_d[l_ac].sfaadocno,g_detail_d[l_ac].sfaa057,
      g_detail_d[l_ac].sfaastus,g_detail_d[l_ac].sfaa010,g_detail_d[l_ac].imaal003,
      g_detail_d[l_ac].imaal004,g_detail_d[l_ac].imaf013,g_detail_d[l_ac].imaa009,
      g_detail_d[l_ac].imaa009_desc,g_detail_d[l_ac].imae011,g_detail_d[l_ac].imae011_desc,
      g_detail_d[l_ac].sfaa013,g_detail_d[l_ac].sfaa013_desc,g_detail_d[l_ac].sfaa012,
      g_detail_d[l_ac].psos036,g_detail_d[l_ac].sfaa049,g_detail_d[l_ac].qty1,
      g_detail_d[l_ac].sfaa020,g_detail_d[l_ac].psos011,g_detail_d[l_ac].sfaa002,
      g_detail_d[l_ac].sfaa002_desc,g_detail_d[l_ac].imae012,g_detail_d[l_ac].imae012_desc,
      g_detail_d[l_ac].psos057]]>
</point>
  <point name="b_fill.foreach_iside" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[      SELECT MAX(psos011) INTO g_detail_d[l_ac].psos011
        FROM apsp630_tmp3
       WHERE sfaedocno = g_detail_d[l_ac].sfaadocno
       
      SELECT SUM(psos036) INTO g_detail_d[l_ac].psos036
        FROM apsp630_tmp2
       WHERE sfaddocno = g_detail_d[l_ac].sfaadocno
      IF cl_null(g_detail_d[l_ac].psos036) THEN
         SELECT psos036 INTO g_detail_d[l_ac].psos036
           FROM apsp630_tmp
          WHERE docno = g_detail_d[l_ac].sfaadocno
      END IF]]>
</point>
  <point name="b_fill.other_table" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   CALL g_detail_d.deleteElement(g_detail_d.getLength())]]>
</point>
  <point name="b_fill.sql_before" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   IF cl_null(g_param.wc) THEN
      LET g_param.wc = " 1=1"
   END IF
   
   SELECT MAX(psos002) INTO g_psos002
     FROM psos_t
    WHERE psosent = g_enterprise
      AND psossite= g_site
      AND psos001 = g_param.psos001
      AND psos009 = '0'
      
   #先抓取所有資料新增到temp table
   CALL apsp630_create_temptable()
        RETURNING l_success
   IF NOT l_success THEN
      RETURN
   END IF
   CALL apsp630_sel_date_into_temptable()
   
   #將相同的工單單號合併成一筆顯示
   LET g_sql = "SELECT 'N',sfaadocno,sfaa057,sfaastus,sfaa010,imaal003,imaal004,imaf013,imaa009,'', ",
               "       imae011,'',sfaa013,oocal003,sfaa012,0,sfaa049,sfaa050+sfaa051,sfaa020,'', ",
               "       sfaa002,oofa011,imae012,'','' ",
               "  FROM apsp630_tmp,sfaa_t ",
               "       LEFT JOIN imaal_t ON imaalent = sfaaent AND imaal001 = sfaa010 AND imaal002 = '",g_dlang,"'",
               "       LEFT JOIN imaa_t  ON imaaent = sfaaent AND imaa001 = sfaa010 ",
               "       LEFT JOIN imaf_t  ON imafent = sfaaent AND imafsite = sfaasite AND imaf001 = sfaa010 ",
               "       LEFT JOIN imae_t  ON imaeent = sfaaent AND imaesite = sfaasite AND imae001 = sfaa010 ",
               "       LEFT JOIN oocal_t ON oocalent = sfaaent AND oocal001 = sfaa013 AND oocal002 = '",g_dlang,"'",
               "       LEFT JOIN oofa_t  ON oofaent = sfaaent AND oofa002 = '2' AND oofa003 = sfaa002 ",
               " WHERE docno = sfaadocno ",
               "   AND sfaaent = ? ",
               "   AND sfaasite='",g_site,"'",
               " ORDER BY sfaadocno "]]>
</point>
  <point name="detail_show.detail_show" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   #產品分類說明
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_detail_d[l_ac].imaa009
   CALL ap_ref_array2(g_ref_fields,"SELECT rtaxl003 FROM rtaxl_t WHERE rtaxlent='"||g_enterprise||"' AND rtaxl001=? AND rtaxl002='"||g_lang||"'",
        "") RETURNING g_rtn_fields
   LET g_detail_d[l_ac].imaa009_desc = '', g_rtn_fields[1] , ''
   
   #生管分類說明
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_detail_d[l_ac].imae011
   CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='204' AND oocql002=? AND oocql003='"||g_lang||"'",
        "") RETURNING g_rtn_fields
   LET g_detail_d[l_ac].imae011_desc = '', g_rtn_fields[1] , ''
   
   #計劃員全名
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_detail_d[l_ac].imae012
   CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ",
        "") RETURNING g_rtn_fields
   LET g_detail_d[l_ac].imae012_desc = '', g_rtn_fields[1] , '']]>
</point>
  <point name="fetch.after_fill" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   IF g_detail_idx > g_detail_cnt THEN
      LET g_detail_idx = g_detail_cnt
   END IF
   
   IF cl_null(g_detail_idx) OR g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   DECLARE apsp630_tmp2_cs CURSOR FOR
    SELECT sfadseq,sfad001,sfad002,psos036
      FROM apsp630_tmp2
     WHERE sfaddocno = g_detail_d[g_detail_idx].sfaadocno
     ORDER BY sfadseq
     
   LET l_ac = 1
   CALL g_detail2_d.clear()
   FOREACH apsp630_tmp2_cs INTO g_detail2_d[l_ac].sfadseq,g_detail2_d[l_ac].sfad001,
                                g_detail2_d[l_ac].sfad002,g_detail2_d[l_ac].psos0361
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         CALL cl_err( "", 9035, 1 )
         EXIT FOREACH
      END IF
   END FOREACH
   
   LET g_detail2_cnt = l_ac - 1
   CALL g_detail2_d.deleteElement(g_detail2_d.getLength())
   
   DECLARE apsp630_tmp3_cs CURSOR FOR
    SELECT sfaeseq,sfae002,sfae001,psos011
      FROM apsp630_tmp3
     WHERE sfaedocno = g_detail_d[g_detail_idx].sfaadocno
     ORDER BY sfaeseq
   
   LET l_ac = 1
   CALL g_detail3_d.clear()
   FOREACH apsp630_tmp3_cs INTO g_detail3_d[l_ac].sfaeseq,g_detail3_d[l_ac].sfae002,
                                g_detail3_d[l_ac].sfae001,g_detail3_d[l_ac].psos0111
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         CALL cl_err( "", 9035, 1 )
         EXIT FOREACH
      END IF
   END FOREACH
   
   LET g_detail3_cnt = l_ac - 1
   CALL g_detail3_d.deleteElement(g_detail3_d.getLength())]]>
</point>
  <point name="global.parameter" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[        psos001          LIKE psos_t.psos001,   #APS版本
        a1               LIKE type_t.chr1,      #顯示已發料資料
        b1               LIKE type_t.chr1,      #顯示已完工資料
        c1               LIKE type_t.chr1,      #顯示已變更資料]]>
</point>
  <point name="global.variable" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[        sel              LIKE type_t.chr1,        #選擇
        sfaadocno        LIKE sfaa_t.sfaadocno,   #工單單號
        sfaa057          LIKE sfaa_t.sfaa057,     #委外型態
        sfaastus         LIKE sfaa_t.sfaastus,    #工單狀態
        sfaa010          LIKE sfaa_t.sfaa010,     #料件編號
        imaal003         LIKE imaal_t.imaal003,   #品名
        imaal004         LIKE imaal_t.imaal004,   #規格
        imaf013          LIKE imaf_t.imaf013,     #補給策略
        imaa009          LIKE imaa_t.imaa009,     #產品分類
        imaa009_desc     LIKE type_t.chr80,       #產品分類說明
        imae011          LIKE imae_t.imae011,     #生管分類
        imae011_desc     LIKE type_t.chr80,       #生管分類說明
        sfaa013          LIKE sfaa_t.sfaa013,     #單位
        sfaa013_desc     LIKE type_t.chr80,       #單位說明
        sfaa012          LIKE sfaa_t.sfaa012,     #原生產數量
        psos036          LIKE psos_t.psos036,     #建議生產量
        sfaa049          LIKE sfaa_t.sfaa049,     #已發料套數
        qty1             LIKE sfaa_t.sfaa050,     #已入庫數量
        sfaa020          LIKE sfaa_t.sfaa020,     #原完工日
        psos011          LIKE psos_t.psos011,     #建議完工日
        sfaa002          LIKE sfaa_t.sfaa002,     #生管員
        sfaa002_desc     LIKE type_t.chr80,       #生管員姓名
        imae012          LIKE imae_t.imae012,     #計畫員
        imae012_desc     LIKE type_t.chr80,       #計畫員姓名
        psos057          LIKE psos_t.psos057,     #已產生變更單
        psos058          LIKE psos_t.psos058      #產生更工單變更單
                         END RECORD
                         
TYPE type_g_detail2_d    RECORD
        sfadseq          LIKE sfad_t.sfadseq,     #項次
        sfad001          LIKE sfad_t.sfad001,     #產品特徵
        sfad002          LIKE sfad_t.sfad002,     #原數量
        psos0361         LIKE psos_t.psos036      #建議數量
                         END RECORD
       
TYPE type_g_detail3_d    RECORD
        sfaeseq          LIKE sfae_t.sfaeseq,     #項次
        sfae002          LIKE sfae_t.sfae002,     #計畫完工日
        sfae001          LIKE sfae_t.sfae001,     #數量
        psos0111         LIKE psos_t.psos011      #建議完工日
                         END RECORD
   
DEFINE g_param        type_parameter
DEFINE g_detail_idx   LIKE type_t.num5
DEFINE g_detail2_idx  LIKE type_t.num5
DEFINE g_detail3_idx  LIKE type_t.num5
DEFINE g_detail2_cnt  LIKE type_t.num5
DEFINE g_detail3_cnt  LIKE type_t.num5
DEFINE g_detail2_d    DYNAMIC ARRAY OF type_g_detail2_d 
DEFINE g_detail3_d    DYNAMIC ARRAY OF type_g_detail3_d
DEFINE g_psos002      LIKE psos_t.psos002
DEFINE g_sfka900      LIKE sfka_t.sfka900]]>
</point>
  <point name="init.init" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   LET g_param.a1 = 'N'
   LET g_param.b1 = 'N'
   LET g_param.c1 = 'N'
   CALL cl_set_combo_scc_part('sfaastus','13','F,Y')
   CALL cl_set_combo_scc('b_sfaa057','4010')
   CALL cl_set_combo_scc_part('b_sfaastus','13','F,Y')
   CALL cl_set_combo_scc('b_imaf013','2022')
   LET g_detail_idx = 1]]>
</point>
  <point name="query.after_construct" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   IF cl_null(g_param.psos001) THEN
      CALL cl_err('','aps-00102',1)
      RETURN
   END IF]]>
</point>
  <point name="ui_dialog.more_action" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[         ON ACTION batch_execute
            CALL apsp630_batch_execute()
            CALL apsp630_query()
            CONTINUE DIALOG]]>
</point>
  <point name="ui_dialog.more_construct" cite_std="N" status="u" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[         CONSTRUCT BY NAME g_param.wc ON sfaa002,imae012,psos012,psos011,imaa009,imae011,
                                         sfaastus,psos054
            
            AFTER FIELD psos012
               CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
               IF NOT cl_null(ls_result) THEN
                  IF NOT cl_chk_date_symbol(ls_result) THEN
                     LET ls_result = cl_add_date_extra_cond(ls_result)
                  END IF
               END IF
               CALL FGL_DIALOG_SETBUFFER(ls_result)
            
            AFTER FIELD psos011
               CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
               IF NOT cl_null(ls_result) THEN
                  IF NOT cl_chk_date_symbol(ls_result) THEN
                     LET ls_result = cl_add_date_extra_cond(ls_result)
                  END IF
               END IF
               CALL FGL_DIALOG_SETBUFFER(ls_result)
            
            ON ACTION controlp INFIELD sfaa002
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_ooag001()
               DISPLAY g_qryparam.return1 TO sfaa002
               NEXT FIELD sfaa002
            
            ON ACTION controlp INFIELD imae012
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_ooag001()
               DISPLAY g_qryparam.return1 TO imae012
               NEXT FIELD imae012
         
            ON ACTION controlp INFIELD imaa009
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_rtax001()
               DISPLAY g_qryparam.return1 TO imaa009
               NEXT FIELD imaa009
               
            ON ACTION controlp INFIELD imae011
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_imcf011()
               DISPLAY g_qryparam.return1 TO imae011
               NEXT FIELD imae011
               
            ON ACTION controlp INFIELD psos054
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_imaf001()
               DISPLAY g_qryparam.return1 TO psos054
               NEXT FIELD psos054
         END CONSTRUCT]]>
</point>
  <point name="ui_dialog.more_displayarray" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[         DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTES(COUNT=g_detail2_cnt)
            BEFORE ROW
               LET g_detail2_idx = DIALOG.getCurrentRow("s_detail2")

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail2_idx)
               LET g_detail2_idx = DIALOG.getCurrentRow("s_detail2")
         END DISPLAY
         
         DISPLAY ARRAY g_detail3_d TO s_detail3.* ATTRIBUTES(COUNT=g_detail3_cnt)
            BEFORE ROW
               LET g_detail3_idx = DIALOG.getCurrentRow("s_detail3")

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail3_idx)
               LET g_detail3_idx = DIALOG.getCurrentRow("s_detail3")
         END DISPLAY]]>
</point>
  <point name="ui_dialog.more_input" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[         INPUT BY NAME g_param.psos001 ATTRIBUTE(WITHOUT DEFAULTS)
         
            AFTER FIELD psos001
               DISPLAY '' TO psos001_desc
               IF NOT cl_null(g_param.psos001) THEN
                  IF NOT apsp630_psos001_chk(g_param.psos001) THEN
                     LET g_param.psos001 = ''
                     DISPLAY BY NAME g_param.psos001
                     DISPLAY '' TO psos001_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               CALL apsp630_psos001_ref()
         
            ON ACTION controlp INFIELD psos001
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_param.psos001
               LET g_qryparam.where = " pscasite = '",g_site,"'"
               CALL q_psca001()
               LET g_param.psos001 = g_qryparam.return1
               DISPLAY BY NAME g_param.psos001
               CALL apsp630_psos001_ref()
               NEXT FIELD psos001
         END INPUT
         
         INPUT BY NAME g_param.a1,g_param.b1,g_param.c1 ATTRIBUTE(WITHOUT DEFAULTS)
            BEFORE INPUT
            
         END INPUT
         
         INPUT ARRAY g_detail_d FROM s_detail1.*
            ATTRIBUTE(COUNT = g_detail_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                    INSERT ROW = FALSE,
                    DELETE ROW = FALSE,
                    APPEND ROW = FALSE)
            BEFORE INPUT
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")

            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               CALL apsp630_fetch()
               
            ON CHANGE b_sel
               IF g_detail_d[g_detail_idx].psos057 = 'Y' THEN
                  IF g_detail_d[g_detail_idx].sel = 'Y' THEN
                     CALL cl_err('','aps-00103',0)
                     LET g_detail_d[g_detail_idx].sel = 'N'
                  END IF
               END IF
         END INPUT]]>
</point>
  <point name="ui_dialog.onaction_sel" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  IF g_detail_d[li_idx].psos057 = 'Y' THEN
                     LET g_detail_d[li_idx].sel = "N"
                  END IF
               END IF
            END FOR]]>
</point>
  <point name="ui_dialog.onaction_selall" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[            FOR li_idx = 1 TO g_detail_d.getLength()
               IF g_detail_d[li_idx].psos057 = 'Y' THEN
                   LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR]]>
</point>
  <point name="global.memo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.import" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.argv" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.background" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.servicecall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.before_close" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.exit" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="init.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.define" cite_std="N" status="u" ver="" src="s" new="Y">
<![CDATA[   DEFINE ls_result  STRING]]>
</point>
  <point name="ui_dialog.before_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.before_dialog2" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selnone" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_unsel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.filter" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="query.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.after_b_fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="fetch.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.detail_cnt" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter_parser.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <section id="apsp630.b_fill" ver="1" status="" src="s">
<![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION apsp630_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
 
   PREPARE apsp630_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR apsp630_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   {<point name="b_fill.clear"/>}
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   {<point name="b_fill.foreach_into"/>}
   #end add-point
   
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      {<point name="b_fill.foreach_iside"/>}
      #end add-point
      
      CALL apsp630_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.other_table"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE apsp630_sel
   
   LET l_ac = 1
   CALL apsp630_fetch()
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.after_b_fill"/>}
   #end add-point
 
END FUNCTION
]]>
</section>
  <section id="apsp630.description" ver="1" status="" src="s">
<![CDATA[#+ Version..: T100-ERP-1.00.00(SD版次:1,PD版次:1) Build-000049
#+ 
#+ Filename...: apsp630
#+ Description: APS工單變更整批調整作業
#+ Creator....: 01588(2014/05/21)
#+ Modifier...: 01588(2014/05/27)
#+ Buildtype..: 應用 p02 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
</section>
  <section id="apsp630.detail_show" ver="1" status="" src="s">
<![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION apsp630_detail_show()
   #add-point:show段define
   {<point name="detail_show.define"/>}
   #end add-point
 
   #add-point:detail_show段
   {<point name="detail_show.detail_show"/>}
   #end add-point
 
END FUNCTION
]]>
</section>
  <section id="apsp630.fetch" ver="1" status="" src="s">
<![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION apsp630_fetch()
 
   DEFINE li_ac           LIKE type_t.num5
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
</section>
  <section id="apsp630.filter" ver="1" status="" src="s">
<![CDATA[#+ filter過濾功能
PRIVATE FUNCTION apsp630_filter()
   #add-point:filter段define
   {<point name="filter.define"/>}
   #end add-point    
 
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   {<point name="filter.detail_cnt"/>}
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL apsp630_b_fill()
   CALL apsp630_fetch()
   
END FUNCTION
]]>
</section>
  <section id="apsp630.filter_parser" ver="1" status="" src="s">
<![CDATA[#+ filter欄位解析
PRIVATE FUNCTION apsp630_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   #add-point:filter段define
   {<point name="filter_parser.define"/>}
   #end add-point    
 
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
</section>
  <section id="apsp630.filter_show" ver="1" status="" src="s">
<![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION apsp630_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = apsp630_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
</section>
  <section id="apsp630.global" ver="1" status="" src="s">
<![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num5              
DEFINE l_ac_d               LIKE type_t.num5              #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num5              #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num5
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
DEFINE g_detail_cnt         LIKE type_t.num5              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
</section>
  <section id="apsp630.init" ver="1" status="" src="s">
<![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION apsp630_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point   
 
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
</section>
  <section id="apsp630.main" ver="1" status="" src="s">
<![CDATA[#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point   
 
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("aps","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apsp630 WITH FORM cl_ap_formpath("aps",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apsp630_init()   
 
      #進入選單 Menu (="N")
      CALL apsp630_ui_dialog() 
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_apsp630
   END IF 
   
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
</section>
  <section id="apsp630.other_function" ver="1" status="" src="s">
<![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
</section>
  <section id="apsp630.query" ver="1" status="" src="s">
<![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION apsp630_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   {<point name="query.define" />}
   #end add-point 
   
   #add-point:cs段after_construct
   {<point name="query.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL apsp630_b_fill()
   LET l_ac = g_master_idx
   CALL apsp630_fetch()
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      CALL cl_err("",-100,1)
   END IF
   
END FUNCTION
]]>
</section>
  <section id="apsp630.ui_dialog" ver="1" status="" src="s">
<![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION apsp630_ui_dialog()
   DEFINE li_idx   LIKE type_t.num5
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define"/>}
   #end add-point 
 
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
 
      CALL cl_dlg_query_bef_disp()  #相關查詢
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
            END FOR
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
            END FOR
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL apsp630_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            CALL apsp630_query()
 
         # 條件清除
         ON ACTION qbeclear
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            CALL apsp630_b_fill()
            CALL apsp630_fetch()
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
</section>
</add_points>