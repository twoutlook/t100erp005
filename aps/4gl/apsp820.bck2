#該程式未解開Section, 採用最新樣板產出!
{<section id="apsp820.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0006(2016-10-14 09:15:47), PR版次:0006(2016-10-26 18:54:50)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000052
#+ Filename...: apsp820
#+ Description: 集團MRP產生工單作業
#+ Creator....: 03079(2015-01-09 17:11:18)
#+ Modifier...: 07024 -SD/PR- 07024
 
{</section>}
 
{<section id="apsp820.global" >}
#應用 p02 樣板自動產生(Version:19)
#add-point:填寫註解說明
#160318-00025#47 2016/04/29 By 07959    將重複內容的錯誤訊息置換為公用錯誤訊息(r.v) 
#160512-00016#12 2016/05/25 By ming     增加欄位 psgb029 保稅否
#160824-00034#2  2016/10/14 By dorislai 拿掉#160512-00016#12加的欄位(psgb029)
#161024-00057#18 2016/10/26 By Whitney  刪除insert into sfae_t相關程式
#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT util
#add-point:增加匯入項目

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
 
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)  #注意要在add-point內寫入END RECORD
                        sel               LIKE type_t.chr1,          #選擇 
                        psgb002           LIKE psgb_t.psgb002,       #料件編號  
                        psgb002_desc      LIKE imaal_t.imaal003,     #品名  
                        psgb002_desc_desc LIKE imaal_t.imaal004,     #規格  
                        psgb003           LIKE psgb_t.psgb003,       #產品特徵 
                        psgb003_desc      LIKE type_t.chr500,        #產品特徵說明 
                        #160824-00034#2-s-mark
                        ##160512-00016#12 20160525 add by ming -----(S) 
                        #psgb029           LIKE psgb_t.psgb029,       #保稅否 
                        ##160512-00016#12 20160525 add by ming -----(E) 
                        #160824-00034#2-e-mark
                        imaf013           LIKE imaf_t.imaf013,       #補給策略 
                        imaa009           LIKE imaa_t.imaa009,       #產品分類 
                        imaa009_desc      LIKE type_t.chr500,        #產品分類說明 
                        imae011           LIKE imae_t.imae011,       #生管分類 
                        imae011_desc      LIKE type_t.chr500,        #生管分類說明 
                        psgb022           LIKE psgb_t.psgb022,       #建議生產數量 
                        imae016           LIKE imae_t.imae016,       #單位 
                        imae016_desc      LIKE type_t.chr500,        #單位說明 
                        sfaa012           LIKE sfaa_t.sfaa012,       #轉工單量 
                        sfaa019           LIKE sfaa_t.sfaa019,       #預計開工日 
                        psgb004           LIKE psgb_t.psgb004,       #預計完工日 
                        imae012           LIKE imae_t.imae012,       #計畫員  
                        imae012_desc      LIKE type_t.chr500,        #計畫員說明 
                        psgb028           LIKE psgb_t.psgb028        #已轉工單 
                     END RECORD
DEFINE g_detail_d_t  type_g_detail_d 

TYPE type_tm         RECORD
                        wc                STRING,                    #QBE 
                        psfa001           LIKE psfa_t.psfa001,       #集團MRP版本 
                        psfa001_desc      LIKE type_t.chr500,
                        psfb003           LIKE psfb_t.psfb003,       #營運據點 
                        psfb003_desc      LIKE type_t.chr500,
                        ooba002           LIKE ooba_t.ooba002,       #工單單別 
                        sfaa057           LIKE sfaa_t.sfaa057,       #委外 
                        sfaa017           LIKE sfaa_t.sfaa017,       #部門/廠商 
                        check01           LIKE type_t.chr1           #顯示已轉單資料 
                     END RECORD
DEFINE tm            type_tm
DEFINE tm_o          type_tm
DEFINE g_detail_idx  LIKE type_t.num5
DEFINE g_oobb007     LIKE oobb_t.oobb007
DEFINE g_sfaa        RECORD LIKE sfaa_t.*
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)

#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明

#end add-point
 
{</section>}
 
{<section id="apsp820.main" >}
#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   
   #end add-point   
   #add-point:main段define
   
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("aps","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apsp820 WITH FORM cl_ap_formpath("aps",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apsp820_init()   
 
      #進入選單 Menu (="N")
      CALL apsp820_ui_dialog() 
 
      #add-point:畫面關閉前
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_apsp820
   END IF 
   
   #add-point:作業離開前
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="apsp820.init" >}
#+ 畫面資料初始化
PRIVATE FUNCTION apsp820_init()
   #add-point:init段define
   
   #end add-point   
   #add-point:init段define
   
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   LET tm.check01 = 'N'     #顯示已轉單資料  

   CALL cl_set_combo_scc('imaf013','2022')
   CALL cl_set_combo_scc('b_imaf013','2022')
   CALL cl_set_combo_scc('sfaa057','4010')

   LET tm.sfaa057 = '1'
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apsp820.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION apsp820_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE l_site    LIKE type_t.chr10
   DEFINE l_success LIKE type_t.num5
   DEFINE l_flag    LIKE type_t.num5
   DEFINE l_ooef004 LIKE ooef_t.ooef004
   #end add-point 
   #add-point:ui_dialog段define
   
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL apsp820_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         CONSTRUCT BY NAME tm.wc ON imae012,psgb004,imaa009,
                                    imae011,psgb002,imaf013
            BEFORE CONSTRUCT

            ON ACTION controlp INFIELD imae012     #計畫員   
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_ooag001()
               DISPLAY g_qryparam.return1 TO imae012
               NEXT FIELD imae012

            ON ACTION controlp INFIELD imaa009     #產品分類  
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_rtax001()
               DISPLAY g_qryparam.return1 TO imaa009
               NEXT FIELD imaa009

            ON ACTION controlp INFIELD imae011     #生管分類  
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_imcf011()
               DISPLAY g_qryparam.return1 TO imae011
               NEXT FIELD imae011

            ON ACTION controlp INFIELD psgb002     #料件編號  
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_imaf001()
               DISPLAY g_qryparam.return1 TO psgb002 
               NEXT FIELD psgb002

         END CONSTRUCT
         #end add-point
         #add-point:ui_dialog段input
         INPUT BY NAME tm.psfa001,tm.psfb003 ATTRIBUTE(WITHOUT DEFAULTS)
            BEFORE INPUT

            AFTER FIELD psfa001
               LET tm.psfa001_desc = ''
               DISPLAY BY NAME tm.psfa001_desc

               IF cl_null(tm.psfa001) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'aps-00129'     #請先輸入集團MRP版本  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD CURRENT
               END IF

               IF NOT cl_null(tm.psfa001) THEN
                  IF tm.psfa001 != tm_o.psfa001 OR cl_null(tm_o.psfa001) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = tm.psfa001
                     #160318-00025#47  2016/04/29  by pengxin  add(S)
                     LET g_errshow = TRUE #是否開窗 
                     LET g_chkparam.err_str[1] = "aps-00092:sub-01302|apsi800|",cl_get_progname("apsi800",g_lang,"2"),"|:EXEPROGapsi800"
                     #160318-00025#47  2016/04/29  by pengxin  add(E)
                     IF NOT cl_chk_exist("v_psfa001") THEN
                        LET tm.psfa001 = tm_o.psfa001
                        CALL apsp820_psfa001_ref(tm.psfa001)
                             RETURNING tm.psfa001_desc
                        DISPLAY BY NAME tm.psfa001_desc
                        NEXT FIELD CURRENT
                     END IF 
                     
                     LET tm.psfb003 = ''
                     LET tm.ooba002 = ''
                     LET tm_o.psfb003 = ''
                     LET tm_o.ooba002 = ''
                     LET tm.psfb003_desc = ''
                     DISPLAY BY NAME tm.psfb003,tm.ooba002,tm.psfb003_desc
                  END IF
               END IF

               LET tm_o.psfa001 = tm.psfa001

               CALL apsp820_psfa001_ref(tm.psfa001) RETURNING tm.psfa001_desc
               DISPLAY BY NAME tm.psfa001_desc

            AFTER FIELD psfb003
               LET tm.psfb003_desc = ''
               DISPLAY BY NAME tm.psfb003_desc
               IF NOT cl_null(tm.psfb003) THEN
                  IF tm.psfb003 != tm_o.psfb003 OR cl_null(tm_o.psfb003) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = tm.psfa001     #集團MRP版本 
                     LET g_chkparam.arg2 = tm.psfb003     #營運據點 
                     IF NOT cl_chk_exist("v_psfb003") THEN
                        LET tm.psfb003 = tm_o.psfb003
                        CALL apsp820_psfb003_ref(tm.psfb003)
                             RETURNING tm.psfb003_desc
                        DISPLAY BY NAME tm.psfb003_desc 
                        NEXT FIELD CURRENT
                     END IF

                     LET tm.ooba002 = ''
                     DISPLAY BY NAME tm.ooba002
                  END IF
               END IF

               LET tm_o.psfb003 = tm.psfb003
               CALL apsp820_psfb003_ref(tm.psfb003) RETURNING tm.psfb003_desc
               DISPLAY BY NAME tm.psfb003_desc

            ON ACTION controlp INFIELD psfa001
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.psfa001
               CALL q_psfa001()
               LET tm.psfa001 = g_qryparam.return1
               DISPLAY BY NAME tm.psfa001
               CALL apsp820_psfa001_ref(tm.psfa001) RETURNING tm.psfa001_desc
               DISPLAY BY NAME tm.psfa001_desc
               NEXT FIELD psfa001

            ON ACTION controlp INFIELD psfb003
               IF cl_null(tm.psfa001) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'aps-00129'      #請先輸入集團MRP版本  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD psfa001
               END IF
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.psfb003
               LET g_qryparam.arg1 = tm.psfa001
               CALL q_psfb003()
               LET tm.psfb003 = g_qryparam.return1
               DISPLAY BY NAME tm.psfb003
               CALL apsp820_psfb003_ref(tm.psfb003) RETURNING tm.psfb003_desc
               DISPLAY BY NAME tm.psfb003_desc
               NEXT FIELD psfb003

            AFTER INPUT
               IF INT_FLAG THEN
                  EXIT DIALOG
               END IF
         END INPUT

         INPUT BY NAME tm.ooba002,tm.sfaa057,tm.sfaa017,tm.check01 ATTRIBUTE(WITHOUT DEFAULTS)
            BEFORE INPUT

            AFTER FIELD ooba002
               IF NOT cl_null(tm.ooba002) THEN
                  LET l_site = g_site 
                  LET g_site = tm.psfb003

                  IF NOT s_aooi200_chk_slip(tm.psfb003,'',tm.ooba002,'asft300') THEN
                     LET g_site = l_site
                     NEXT FIELD CURRENT
                  END IF
                  LET g_site = l_site

                  LET l_ooef004 = ''
                  SELECT ooef004 INTO l_ooef004
                    FROM ooef_t
                   WHERE ooefent = g_enterprise
                     AND ooef001 = tm.psfb003
                  #預設委外類型、可否修改 
                  LET g_oobb007 = ''
                  SELECT oobb005,oobb007 INTO tm.sfaa057,g_oobb007
                    FROM oobb_t
                   WHERE oobbent = g_enterprise
                     AND oobb001 = l_ooef004
                     AND oobb002 = tm.ooba002
                     AND oobb004 = 'sfaa057'
                  IF cl_null(tm.sfaa057) THEN
                     LET tm.sfaa057 = '1'
                  END IF

                  IF tm.sfaa057 <> tm_o.sfaa057 THEN
                     LET tm.sfaa017 = '' 
                     DISPLAY BY NAME tm.sfaa017
                  END IF
                  LET tm_o.sfaa057 = tm.sfaa057
               END IF

               CALL apsp820_set_entry()
               CALL apsp820_set_no_entry()

            ON CHANGE sfaa057
               IF tm.sfaa057 <> tm_o.sfaa057 THEN
                  LET tm.sfaa017 = ''
                  DISPLAY BY NAME tm.sfaa017
               END IF
               LET tm_o.sfaa057 = tm.sfaa057

            AFTER FIELD sfaa017
               IF NOT cl_null(tm.sfaa017) THEN
                  IF NOT apsp820_sfaa017_chk(tm.sfaa017) THEN
                     LET tm.sfaa017 = ''
                     DISPLAY BY NAME tm.sfaa017
                     NEXT FIELD CURRENT
                  END IF
               END IF

            ON ACTION controlp INFIELD ooba002
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE 
               LET g_qryparam.default1 = tm.ooba002

               LET l_site = g_site
               LET g_site = tm.psfb003
               LET l_ooef004 = ''
               SELECT ooef004 INTO l_ooef004
                 FROM ooef_t
                WHERE ooefent = g_enterprise
                  AND ooef001 = tm.psfb003

               LET g_qryparam.arg1 = l_ooef004
               LET g_qryparam.arg2 = 'asft300'
               CALL q_ooba002_1()
               LET g_site = l_site
               LET tm.ooba002 = g_qryparam.return1
               DISPLAY BY NAME tm.ooba002
               NEXT FIELD ooba002

            ON ACTION controlp INFIELD sfaa017
               #先選擇是否委外，再決定開部門或廠商 
               IF cl_null(tm.sfaa057) THEN
                  NEXT FIELD sfaa057
               END IF
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.sfaa017 
               CASE tm.sfaa057
                  WHEN '1'
                     LET g_qryparam.arg1 = g_today
                     CALL q_ooeg001()
                  WHEN '2'
                     CALL q_pmaa001_3()
               END CASE
               LET tm.sfaa017 = g_qryparam.return1
               DISPLAY BY NAME tm.sfaa017
               NEXT FIELD sfaa017

            AFTER INPUT
               IF INT_FLAG THEN
                  EXIT DIALOG
               END IF
         END INPUT

         INPUT ARRAY g_detail_d FROM s_detail1.*
               ATTRIBUTE(COUNT=g_detail_cnt,MAXCOUNT=g_max_rec,WITHOUT DEFAULTS,
                         INSERT ROW = FALSE,
                         DELETE ROW = FALSE,
                         APPEND ROW = FALSE)
            BEFORE INPUT
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")

            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1") 
               
               CALL apsp820_set_entry_b('',g_detail_idx)
               CALL apsp820_set_no_entry_b('',g_detail_idx)

            ON CHANGE b_sel
               IF g_detail_d[g_detail_idx].sel = 'Y' AND (g_detail_d[g_detail_idx].psgb028 = 'Y') THEN
                  CALL cl_ask_pressanykey('aps-00109')     #已產生對應的單據，無法重複執行！  
                  LET g_detail_d[g_detail_idx].sel = 'N'
               END IF

            AFTER FIELD sfaa012
               IF NOT cl_null(g_detail_d[g_detail_idx].sfaa012) THEN
                  IF g_detail_d[g_detail_idx].sfaa012 <= 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = ''
                     LET g_errparam.code   = 'ade-00016'     #數量不可小於等於0   
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()

                     NEXT FIELD CURRENT
                  END IF

                  #計畫預計開工日 
                  CALL apsp820_get_sfaa019(g_detail_d[g_detail_idx].psgb002,
                                           g_detail_d[g_detail_idx].sfaa012, 
                                           g_detail_d[g_detail_idx].psgb004)
                       RETURNING g_detail_d[g_detail_idx].sfaa019
               END IF

            AFTER ROW

            AFTER INPUT
         END INPUT 
         #end add-point
         #add-point:ui_dialog段自定義display array
         
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               IF g_detail_d[li_idx].psgb028 = 'Y' THEN
                  LET g_detail_d[li_idx].sel = 'N'
               END IF
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1",li_idx) THEN
                  IF g_detail_d[li_idx].psgb028 = 'Y' THEN
                     LET g_detail_d[li_idx].sel = 'N'
                  END IF
               END IF
            END FOR
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL apsp820_filter()
            #add-point:ON ACTION filter
            
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            IF cl_null(tm.psfa001) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = 'aps-00129'     #請先輸入集團MRP版本 
               LET g_errparam.popup  = TRUE
               CALL cl_err()

               NEXT FIELD psfa001
            END IF

            IF cl_null(tm.psfb003) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = 'agl-00291'     #營運據點不可為空  
               LET g_errparam.popup  = TRUE
               CALL cl_err()

               NEXT FIELD psfb003
            END IF

            IF cl_null(tm.ooba002) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = 'agl-00122'     #傳入單別為空 
               LET g_errparam.popup  = TRUE
               CALL cl_err()

               NEXT FIELD ooba002
            END IF
            #end add-point
            CALL apsp820_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            LET g_wc_filter   = " 1=1"
            LET g_wc_filter_t = " 1=1"
            CALL apsp820_b_fill()

            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            
            #end add-point
            CALL apsp820_b_fill()
 
         #add-point:ui_dialog段action
         ON ACTION batch_execute
            IF cl_null(tm.psfa001) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = 'aps-00129'     #請先輸入集團MRP版本   
               LET g_errparam.popup  = TRUE
               CALL cl_err()

               NEXT FIELD psfa001
            END IF
            IF cl_null(tm.psfb003) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = 'agl-00291'     #營運據點不可為空  
               LET g_errparam.popup  = TRUE
               CALL cl_err()

               NEXT FIELD psfb003
            END IF
            IF cl_null(tm.ooba002) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code   = 'agl-00122'     #傳入單別為空  
               LET g_errparam.popup  = TRUE
               CALL cl_err()

               NEXT FIELD ooba002
            END IF

            CALL apsp820_batch_execute() 
            CALL apsp820_b_fill()
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
{</section>}
 
{<section id="apsp820.query" >}
#+ QBE資料查詢
PRIVATE FUNCTION apsp820_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   
   #end add-point 
   #add-point:query段define
   
   #end add-point 
    
   #add-point:cs段after_construct
   
   #end add-point
        
   LET g_error_show = 1
   CALL apsp820_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apsp820.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION apsp820_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_flag          LIKE type_t.num5
   #end add-point
   #add-point:b_fill段define
   
   #end add-point
 
   #add-point:b_fill段sql_before
   IF cl_null(tm.wc) THEN LET tm.wc = " 1=1 " END IF
   IF cl_null(g_wc_filter) THEN LET g_wc_filter = " 1=1 " END IF  #151209-00022#9 by whitney add

   LET ls_wc = ''
   IF tm.check01 = 'N' THEN
      LET ls_wc = " (psgb028 = 'N' OR psgb028 IS NULL) "
   ELSE
      LET ls_wc = " 1=1 "
   END IF
   
   #160824-00034#2-s-mod
   ##160512-00016#12 20160525 modify by ming -----(S) 
   ##LET g_sql = "SELECT 'N',psgb002,'','',psgb003,'',imaf013,imaa009,'', ", 
   #LET g_sql = "SELECT 'N',psgb002,'','',psgb003,'',psgb029,imaf013,imaa009,'', ", 
   ##160512-00016#12 20160525 modify by ming -----(E) 
   LET g_sql = "SELECT 'N',psgb002,'','',psgb003,'',imaf013,imaa009,'', ", 
   #160824-00034#2-e-mod
               "       imae011,'',psgb022,imae016,'','','',psgb004,imae012,'',psgb028 ",
               "  FROM psgb_t LEFT OUTER JOIN imae_t ON imaeent  = '",g_enterprise,"' ",
               "                                    AND imaesite = '",tm.psfb003,"' ",
               "                                    AND imae001  = psgb002 ",
               "              LEFT OUTER JOIN imaf_t ON imafent  = '",g_enterprise,"' ",
               "                                    AND imafsite = '",tm.psfb003,"' ",
               "                                    AND imaf001  = psgb002 ",
               "              LEFT OUTER JOIN imaa_t ON imaaent  = '",g_enterprise,"' ",
               "                                    AND imaa001  = psgb002 ",
               " WHERE psgbent  = ? ",
               "   AND psgb001  = '",tm.psfa001,"' ",    #MRP版本 
               "   AND psgbsite = '",tm.psfb003,"' ",    #營運據點  
               "   AND psgb022  > 0 ",
               "   AND ",tm.wc CLIPPED,
               "   AND ",ls_wc CLIPPED,
               "   AND ",g_wc_filter CLIPPED,  #151209-00022#9 by whitney add
               " ORDER BY psgb002 "
   #end add-point
 
   PREPARE apsp820_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR apsp820_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
      g_detail_d[l_ac].sel,g_detail_d[l_ac].psgb002,g_detail_d[l_ac].psgb002_desc,
      g_detail_d[l_ac].psgb002_desc_desc,g_detail_d[l_ac].psgb003,g_detail_d[l_ac].psgb003_desc,
      #160824-00034#2-s-mark
      ##160512-00016#12 20160525 add by ming -----(S) 
      #g_detail_d[l_ac].psgb029, 
      ##160512-00016#12 20160525 add by ming -----(E) 
      #160824-00034#2-e-mark
      g_detail_d[l_ac].imaf013,g_detail_d[l_ac].imaa009,g_detail_d[l_ac].imaa009_desc,
      g_detail_d[l_ac].imae011,g_detail_d[l_ac].imae011_desc,g_detail_d[l_ac].psgb022,
      g_detail_d[l_ac].imae016,g_detail_d[l_ac].imae016_desc,g_detail_d[l_ac].sfaa012,
      g_detail_d[l_ac].sfaa019,g_detail_d[l_ac].psgb004,g_detail_d[l_ac].imae012,
      g_detail_d[l_ac].imae012_desc,g_detail_d[l_ac].psgb028
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      #在這裡的錯誤訊息都不要出現 
      CALL cl_err_collect_init()

      #控制組的檢查 
      CALL s_control_check_item(g_detail_d[l_ac].psgb002,'3',tm.psfb003,g_user,g_dept,tm.ooba002)
           RETURNING l_success
      IF NOT l_success THEN
         CALL cl_err_collect_init()
         CALL cl_err_collect_show()
         CONTINUE FOREACH
      END IF

      CALL cl_err_collect_init()
      CALL cl_err_collect_show()

      #轉工單量預設為建議生產數量 
      LET g_detail_d[l_ac].sfaa012 = g_detail_d[l_ac].psgb022

      CALL apsp820_get_sfaa019(g_detail_d[l_ac].psgb002,
                               g_detail_d[l_ac].sfaa012,
                               g_detail_d[l_ac].psgb004)
           RETURNING g_detail_d[l_ac].sfaa019
      #end add-point
      
      CALL apsp820_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   CALL g_detail_d.deleteElement(g_detail_d.getLength())
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE apsp820_sel
   
   LET l_ac = 1
   CALL apsp820_fetch()
   #add-point:b_fill段資料填充(其他單身)
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="apsp820.fetch" >}
#+ 單身陣列填充2
PRIVATE FUNCTION apsp820_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   
   #end add-point
   #add-point:fetch段define
   
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
 
{</section>}
 
{<section id="apsp820.detail_show" >}
#+ 顯示相關資料
PRIVATE FUNCTION apsp820_detail_show()
   #add-point:show段define
   DEFINE l_success     LIKE type_t.num5
   #end add-point
   #add-point:show段define
   
   #end add-point
   
   #add-point:detail_show段
   #取品名 規格 
   CALL s_desc_get_item_desc(g_detail_d[l_ac].psgb002)
        RETURNING g_detail_d[l_ac].psgb002_desc,
                  g_detail_d[l_ac].psgb002_desc_desc

   #取得產品特徵說明 
   CALL s_feature_description(g_detail_d[l_ac].psgb002,g_detail_d[l_ac].psgb003)
        RETURNING l_success,g_detail_d[l_ac].psgb003_desc

   #取得產品分類說明 
   CALL s_desc_get_rtaxl003_desc(g_detail_d[l_ac].imaa009)
        RETURNING g_detail_d[l_ac].imaa009_desc

   #取得生管分類說明 
   CALL s_desc_get_acc_desc('204',g_detail_d[l_ac].imae011)
        RETURNING g_detail_d[l_ac].imae011_desc

   #取得單位說明 
   CALL s_desc_get_unit_desc(g_detail_d[l_ac].imae016)
        RETURNING g_detail_d[l_ac].imae016_desc

   #取得計畫員說明 
   CALL s_desc_get_person_desc(g_detail_d[l_ac].imae012)
        RETURNING g_detail_d[l_ac].imae012_desc
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="apsp820.filter" >}
#+ filter過濾功能
PRIVATE FUNCTION apsp820_filter()
   #add-point:filter段define
{
   #end add-point    
   #add-point:filter段define
   
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   }
   LET l_ac = 1
   LET g_detail_cnt = 1
   
   #160824-00034#2-s-mod
   ##160512-00016#12 20160525 modify by ming -----(S) 
   ##CONSTRUCT g_wc_filter ON psgb002,psgb003,imaf013,imaa009,imae011,psgb022, 
   #CONSTRUCT g_wc_filter ON psgb002,psgb003,psgb029,imaf013,imaa009,imae011,psgb022, 
   ##160512-00016#12 20160525 modify by ming -----(E) 
   #                         imae016,sfaa012,sfaa019,psgb004,imae012,psgb028
   #     #160512-00016#12 20160525 modify by ming -----(S) 
   #     #FROM s_detail1[1].b_psgb002,s_detail1[1].b_psgb003,s_detail1[1].b_imaf013,s_detail1[1].b_imaa009, 
   #     FROM s_detail1[1].b_psgb002,s_detail1[1].b_psgb003,s_detail1[1].b_psgb029, 
   #          s_detail1[1].b_imaf013,s_detail1[1].b_imaa009, 
   #     #160512-00016#12 20160525 modify by ming -----(E) 
   #          s_detail1[1].b_imae011,s_detail1[1].b_psgb022,s_detail1[1].b_imae016,s_detail1[1].b_sfaa012,
   #          s_detail1[1].b_sfaa019,s_detail1[1].b_psgb004,s_detail1[1].b_imae012,s_detail1[1].b_psgb028
   CONSTRUCT g_wc_filter ON psgb002,psgb003,imaf013,imaa009,imae011,psgb022, 
                            imae016,sfaa012,sfaa019,psgb004,imae012,psgb028
        FROM s_detail1[1].b_psgb002,s_detail1[1].b_psgb003,s_detail1[1].b_imaf013,s_detail1[1].b_imaa009,
             s_detail1[1].b_imae011,s_detail1[1].b_psgb022,s_detail1[1].b_imae016,s_detail1[1].b_sfaa012,
             s_detail1[1].b_sfaa019,s_detail1[1].b_psgb004,s_detail1[1].b_imae012,s_detail1[1].b_psgb028
   #160824-00034#2-e-mod
   
      BEFORE CONSTRUCT
      
      ON ACTION controlp INFIELD b_psgb002        #料件編號
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'c'
         LET g_qryparam.reqry = FALSE
         CALL q_imaf001()                         #呼叫開窗
         DISPLAY g_qryparam.return1 TO b_psgb002  #顯示到畫面上
         NEXT FIELD b_psgb002                     #返回原欄位    
         
      ON ACTION controlp INFIELD b_imaa009        #產品分類
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'c'
         LET g_qryparam.reqry = FALSE
         CALL q_rtax001()                         #呼叫開窗
         DISPLAY g_qryparam.return1 TO b_imaa009  #顯示到畫面上
         NEXT FIELD b_imaa009                     #返回原欄位
         
      ON ACTION controlp INFIELD b_imae011        #生管分類
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'c'
         LET g_qryparam.reqry = FALSE
         CALL q_imcf011()                         #呼叫開窗
         DISPLAY g_qryparam.return1 TO b_imae011  #顯示到畫面上
         NEXT FIELD b_imae011                     #返回原欄位
       
      ON ACTION controlp INFIELD b_imae016        #單位
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'c'
         LET g_qryparam.reqry = FALSE
         CALL q_ooca001_1()                       #呼叫開窗
         DISPLAY g_qryparam.return1 TO b_imae016  #顯示到畫面上
         NEXT FIELD b_imae016                     #返回原欄位
          
      ON ACTION controlp INFIELD b_imae012        #計畫員
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'c'
         LET g_qryparam.reqry = FALSE
         CALL q_ooag001()                         #呼叫開窗
         DISPLAY g_qryparam.return1 TO b_imae012  #顯示到畫面上
         NEXT FIELD b_imae012                     #返回原欄位
       
   END CONSTRUCT
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL apsp820_b_fill()
   
END FUNCTION
 
{</section>}
 
{<section id="apsp820.filter_parser" >}
#+ filter欄位解析
PRIVATE FUNCTION apsp820_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   
   #end add-point    
   #add-point:filter段define
   
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="apsp820.filter_show" >}
#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION apsp820_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = apsp820_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="apsp820.other_function" readonly="Y" >}
#add-point:自定義元件(Function)

PRIVATE FUNCTION apsp820_psfa001_ref(p_psfal001)
   DEFINE p_psfal001     LIKE psfal_t.psfal001
   DEFINE r_psfal003     LIKE psfal_t.psfal003

   LET r_psfal003 = ''
   SELECT psfal003 INTO r_psfal003
     FROM psfal_t
    WHERE psfalent = g_enterprise
      AND psfal001 = p_psfal001
      AND psfal002 = g_dlang

   RETURN r_psfal003
END FUNCTION

PRIVATE FUNCTION apsp820_psfb003_ref(p_psfb003)
   DEFINE p_psfb003     LIKE psfb_t.psfb003
   DEFINE r_ooefl003    LIKE ooefl_t.ooefl003

   LET r_ooefl003 = ''
   SELECT ooefl003 INTO r_ooefl003
     FROM ooefl_t
    WHERE ooeflent = g_enterprise
      AND ooefl001 = p_psfb003
      AND ooefl002 = g_dlang

   RETURN r_ooefl003
END FUNCTION

PRIVATE FUNCTION apsp820_set_entry()
   CALL cl_set_comp_entry("sfaa057",TRUE)
END FUNCTION

PRIVATE FUNCTION apsp820_set_no_entry()
   IF g_oobb007 = 'N' THEN
      CALL cl_set_comp_entry("sfaa057",FALSE)
   END IF
END FUNCTION

PRIVATE FUNCTION apsp820_set_entry_b(p_cmd,p_ac)
   DEFINE p_cmd     LIKE type_t.chr1
   DEFINE p_ac      LIKE type_t.num5

   CALL cl_set_comp_entry("b_sfaa012",TRUE)
END FUNCTION

PRIVATE FUNCTION apsp820_set_no_entry_b(p_cmd,p_ac)
   DEFINE p_cmd     LIKE type_t.chr1
   DEFINE p_ac      LIKE type_t.num5

   IF g_detail_d[p_ac].psgb028 = 'Y' THEN
      CALL cl_set_comp_entry("b_sfaa012",FALSE)
   END IF
END FUNCTION

################################################################################
# Descriptions...: 檢查部門或是廠商
# Memo...........:
# Usage..........: CALL apsp820_sfaa017_chk(p_sfaa017)
#                  RETURNING r_success
# Input parameter: p_sfaa017
# Return code....: r_success
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_sfaa017_chk(p_sfaa017)
   DEFINE p_sfaa017      LIKE sfaa_t.sfaa017
   DEFINE r_success      LIKE type_t.num5

   LET r_success = TRUE

   IF cl_null(p_sfaa017) THEN
      RETURN r_success
   END IF

   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = p_sfaa017
   CASE tm.sfaa057
      WHEN '1'
         LET g_chkparam.arg2 = g_today
         #160318-00025#47  2016/04/29  by pengxin  add(S)
         LET g_errshow = TRUE #是否開窗 
         LET g_chkparam.err_str[1] = "aoo-00029:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
         #160318-00025#47  2016/04/29  by pengxin  add(E)
         IF NOT cl_chk_exist("v_ooeg001") THEN
            LET r_success = FALSE
            RETURN r_success
         END IF
      WHEN '2'
         IF NOT cl_chk_exist("v_pmaa001_1") THEN
            LET r_success = FALSE
            RETURN r_success
         END IF
   END CASE

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 計算預計開工日
# Memo...........:
# Usage..........: CALL apsp820_get_sfaa019(p_sfaa010,p_sfaa012,p_sfaa020)
#                  RETURNING r_sfaa019
# Input parameter: p_sfaa010：生產料號 
#                : p_sfaa012：生產數量 
#                : p_sfaa020：預計完工日 
# Return code....: r_sfaa019：預計開工日 
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_get_sfaa019(p_sfaa010,p_sfaa012,p_sfaa020)
   DEFINE p_sfaa010     LIKE sfaa_t.sfaa010     #生產料號  
   DEFINE p_sfaa012     LIKE sfaa_t.sfaa012     #生產數量 
   DEFINE p_sfaa020     LIKE sfaa_t.sfaa020     #預計完工日 
   DEFINE r_sfaa019     LIKE sfaa_t.sfaa019     #預計開工日 
   DEFINE l_success     LIKE type_t.num5

   LET r_sfaa019 = ''

   IF cl_null(p_sfaa010) OR cl_null(p_sfaa012) OR cl_null(p_sfaa020) THEN
      RETURN r_sfaa019
   END IF

   CALL s_asft300_06('2',p_sfaa010,p_sfaa012,p_sfaa020)
        RETURNING l_success,r_sfaa019

   RETURN r_sfaa019
END FUNCTION

################################################################################
# Descriptions...: 將選取的資料轉成工單 
# Memo...........:
# Usage..........: CALL apsp820_batch_execute()
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_batch_execute()
   DEFINE l_sel_cnt       LIKE type_t.num5
   DEFINE l_tot_success   LIKE type_t.num5
   DEFINE l_success       LIKE type_t.num5
   DEFINE ls_js           STRING
   DEFINE lc_param        type_parameter
   DEFINE la_param        RECORD
                             prog     STRING,
                             param    DYNAMIC ARRAY OF STRING
                          END RECORD
   DEFINE l_str           STRING
   DEFINE l_site          LIKE gzxa_t.gzxa007

   LET l_sel_cnt = 0
   LET l_success = TRUE
   LET l_tot_success = TRUE
   LET l_str = ''

   CALL s_transaction_begin()
   CALL cl_err_collect_init()

   FOR l_ac = 1 TO g_detail_d.getLength()
      IF g_detail_d[l_ac].sel = 'N' THEN
         CONTINUE FOR
      END IF

      IF NOT l_success THEN
         LET l_tot_success = FALSE
      END IF
      LET l_success = TRUE 
      
      #累計選擇的筆數 
      LET l_sel_cnt = l_sel_cnt + 1

      #產生工單 
      CALL apsp820_asft300_gen()
           RETURNING l_success
      IF NOT l_success THEN
         CONTINUE FOR
      END IF

      #更新為已轉單資料 
      UPDATE psgb_t SET psgb028 = 'Y'
       WHERE psgbent = g_enterprise
         AND psgb001 = tm.psfa001
         AND psgb002 = g_detail_d[l_ac].psgb002
         AND psgb003 = g_detail_d[l_ac].psgb003
         AND psgb004 = g_detail_d[l_ac].psgb004
         AND psgbsite = tm.psfb003 
         #AND psgb029  = g_detail_d[l_ac].psgb029     #160512-00016#12 20160525 add by ming #160824-00034#2-mark
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         LET l_success = FALSE

         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = 'upd psgb_t'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         CONTINUE FOR
      END IF
      
      IF cl_null(l_str) THEN
         LET l_str = " '",g_sfaa.sfaadocno,"' "
      ELSE
         LET l_str = l_str,","," '",g_sfaa.sfaadocno,"' "
      END IF
   END FOR

   CALL cl_err_collect_show()
   IF NOT l_tot_success THEN
      LET l_success = FALSE
   END IF

   IF cl_null(l_sel_cnt) OR l_sel_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 'afa-00063'
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      CALL s_transaction_end('N','0')
      RETURN
   END IF 
   
   IF l_success THEN
      CALL s_transaction_end('Y','0')
      IF NOT cl_null(l_str) THEN
         ##記錄azzi800的預設營運據點編號 
         #SELECT gzxa007 INTO l_site
         #  FROM gzxa_t
         # WHERE gzxaent = g_enterprise
         #   AND gzxa001 = g_account
         #
         ##更換營運據點 
         #UPDATE gzxa_t SET gzxa007 = tm.psfb003
         # WHERE gzxaent = g_enterprise
         #   AND gzxa001 = g_account 
         
         #切換營運據點 
         CALL FGL_SETENV("T100CROSSSITEBYPROG",tm.psfb003)

         LET la_param.prog = 'asft300'
         LET la_param.param[1] = ''
         LET la_param.param[2] = ''
         LET la_param.param[3] = "sfaadocno IN (",l_str,") "
         LET ls_js= util.JSON.stringify(la_param)
         CALL cl_cmdrun_wait(ls_js)

         ##還原預設營運據點 
         #UPDATE gzxa_t SET gzxa007 = l_site
         # WHERE gzxaent = g_enterprise
         #   AND gzxa001 = g_account 
         
         #還原營運據點  
         CALL FGL_SETENV("T100CROSSSITEBYPROG","")
      END IF
   ELSE
      CALL s_transaction_end('N','0')
   END IF
END FUNCTION

################################################################################
# Descriptions...: 工單產生
# Memo...........:
# Usage..........: CALL apsp820_asft300_gen()
#                  RETURNING r_success
# Return code....: r_success
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_asft300_gen()
   DEFINE r_success     LIKE type_t.num5
   DEFINE l_num         LIKE type_t.num5
   DEFINE l_site        LIKE type_t.chr10

   LET r_success = TRUE

   #產生工單單頭 
   CALL apsp820_sfaa_ins() RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF

   #產生生產料號明細  
   CALL apsp820_sfac_ins() RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   #產生備料前要修改g_site 
   LET l_site = g_site
   LET g_site = tm.psfb003
   
   #產生備料 
   CALL s_asft300_02(g_sfaa.sfaadocno,g_sfaa.sfaa003,g_sfaa.sfaa010,
                     g_sfaa.sfaa011,g_sfaa.sfaa015,g_sfaa.sfaa012,'N')
        RETURNING r_success,l_num
   
   #還原g_site 
   LET g_site = l_site   
   
   IF NOT r_success THEN
      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 工單單頭預設欄位
# Memo...........:
# Usage..........: CALL apsp820_sfaa_init()
#                  RETURNING r_success
# Return code....: r_success
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_sfaa_init()
   DEFINE r_success     LIKE type_t.num5

   LET r_success = TRUE

   LET g_sfaa.sfaaent   = g_enterprise
   LET g_sfaa.sfaasite  = tm.psfb003
   LET g_sfaa.sfaaownid = g_user
   LET g_sfaa.sfaaowndp = g_dept
   LET g_sfaa.sfaacrtid = g_user
   LET g_sfaa.sfaacrtdp = g_dept
   LET g_sfaa.sfaacrtdt = cl_get_current()
   LET g_sfaa.sfaamodid = ''
   LET g_sfaa.sfaamoddt = ''
   LET g_sfaa.sfaastus  = 'N'
   LET g_sfaa.sfaadocno = tm.ooba002
   LET g_sfaa.sfaadocdt = g_today
   LET g_sfaa.sfaa001   = '0'
   LET g_sfaa.sfaa002   = g_user 
   #160512-00016#12 20160525 add by ming -----(S) 
   LET g_sfaa.sfaa003   = '1'                         #工單類型：1.一般工單
   #160512-00016#12 20160525 add by ming -----(E) 
   LET g_sfaa.sfaa005   = '3'                         #3.計畫 
   LET g_sfaa.sfaa006   = ''                          #來源單號 
   LET g_sfaa.sfaa010   = g_detail_d[l_ac].psgb002    #生產料號 
   LET g_sfaa.sfaa011   = ' '
   LET g_sfaa.sfaa012   = g_detail_d[l_ac].sfaa012
   LET g_sfaa.sfaa013   = g_detail_d[l_ac].imae016    #生產單位  
   LET g_sfaa.sfaa017   = tm.sfaa017
   LET g_sfaa.sfaa019   = g_detail_d[l_ac].sfaa019    #預計開工日 
   LET g_sfaa.sfaa020   = g_detail_d[l_ac].psgb004    #預計完工日  
   LET g_sfaa.sfaa022   = ''                          #參考原始單據 
   LET g_sfaa.sfaa038   = 'N'
   LET g_sfaa.sfaa039   = 'N' 
   LET g_sfaa.sfaa040   = 'N'
   LET g_sfaa.sfaa041   = 'N'
   LET g_sfaa.sfaa042   = 'N'
   LET g_sfaa.sfaa043   = 'N'
   LET g_sfaa.sfaa044   = 'N'
   LET g_sfaa.sfaa049   = '0'
   LET g_sfaa.sfaa050   = '0'
   LET g_sfaa.sfaa051   = '0'
   LET g_sfaa.sfaa055   = '0'
   LET g_sfaa.sfaa056   = '0'
   LET g_sfaa.sfaa057   = tm.sfaa057
   LET g_sfaa.sfaa062   = 'Y'
   LET g_sfaa.sfaa004   = '1'
   LET g_sfaa.sfaa071   = 0                           #160425-00019 by whitney add 齊料套數 
   
   #160824-00034#2-s-mod
   ##160512-00016#12 20160525 add by ming -----(S) 
   #LET g_sfaa.sfaa072   = g_detail_d[l_ac].psgb029    #保稅否 
   #IF cl_null(g_sfaa.sfaa072) THEN 
   #   LET g_sfaa.sfaa072 = 'N' 
   #END IF 
   ##160512-00016#12 20160525 add by ming -----(E) 
   LET g_sfaa.sfaa072 = 'N'
   #160824-00034#2-e-mod

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 新增工單單頭
# Memo...........:
# Usage..........: CALL apsp820_sfaa_ins()
#                  RETURNING r_success
# Return code....: r_success
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_sfaa_ins()
   DEFINE r_success     LIKE type_t.num5

   LET r_success = TRUE

   INITIALIZE g_sfaa.* TO NULL

   #給予初始值 
   CALL apsp820_sfaa_init() RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF

   #單別預設欄位 
   CALL apsp820_sfaa_docno_default() RETURNING r_success
   IF NOT r_success THEN
      RETURN r_success
   END IF

   #自動編號 
   CALL s_aooi200_gen_docno(tm.psfb003,g_sfaa.sfaadocno,g_sfaa.sfaadocdt,'asft300')
        RETURNING r_success,g_sfaa.sfaadocno
   IF NOT r_success THEN
      RETURN r_success
   END IF

   #參考單位、參考數量  
   SELECT imaf015 INTO g_sfaa.sfaa060
     FROM imaf_t
    WHERE imafent  = g_enterprise
      AND imafsite = tm.psfb003
      AND imaf001  = g_sfaa.sfaa010
   IF NOT cl_null(g_sfaa.sfaa060) THEN
      CALL s_aooi250_convert_qty(g_sfaa.sfaa010,g_sfaa.sfaa013,g_sfaa.sfaa060,g_sfaa.sfaa012)
           RETURNING r_success,g_sfaa.sfaa058
      IF NOT r_success THEN
         RETURN r_success
      END IF
   END IF

   #完工超入容差率  
   SELECT imae020 INTO g_sfaa.sfaa027
     FROM imae_t
    WHERE imaeent  = g_enterprise
      AND imaesite = tm.psfb003
      AND imae001  = g_sfaa.sfaa010
   IF cl_null(g_sfaa.sfaa027) THEN
      LET g_sfaa.sfaa027 = 0
   END IF

   #若有使用製程，則預設料件據點資料的製程編號  
   IF g_sfaa.sfaa061 = 'Y' THEN
      SELECT imae033 INTO g_sfaa.sfaa016
        FROM imae_t
       WHERE imaeent  = g_enterprise
         AND imaesite = tm.psfb003 
         AND imae001  = g_sfaa.sfaa010
   END IF

   INSERT INTO sfaa_t VALUES(g_sfaa.*)

   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
      LET r_success = FALSE

      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = 'ins sfaa_t'
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 單別預設欄位
# Memo...........:
# Usage..........: CALL apsp820_sfaa_docno_default()
#                  RETURNING r_success
# Return code....: r_success
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_sfaa_docno_default()
   DEFINE r_success     LIKE type_t.num5

   LET r_success = TRUE

   #參考asft300，修改成取單別預設值的方式 
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaadocdt',g_sfaa.sfaadocdt)
        RETURNING g_sfaa.sfaadocdt

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa001',g_sfaa.sfaa001)
        RETURNING g_sfaa.sfaa001

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa002',g_sfaa.sfaa002)
        RETURNING g_sfaa.sfaa002

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa003',g_sfaa.sfaa003)
        RETURNING g_sfaa.sfaa003

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa004',g_sfaa.sfaa004)
        RETURNING g_sfaa.sfaa004

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa005',g_sfaa.sfaa005)
        RETURNING g_sfaa.sfaa005

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa006',g_sfaa.sfaa006)
        RETURNING g_sfaa.sfaa006

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa007',g_sfaa.sfaa007)
        RETURNING g_sfaa.sfaa007

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa008',g_sfaa.sfaa008)
        RETURNING g_sfaa.sfaa008

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa009',g_sfaa.sfaa009)
        RETURNING g_sfaa.sfaa009 
        
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa010',g_sfaa.sfaa010)
        RETURNING g_sfaa.sfaa010

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa011',g_sfaa.sfaa011)
        RETURNING g_sfaa.sfaa011

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa012',g_sfaa.sfaa012)
        RETURNING g_sfaa.sfaa012

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa013',g_sfaa.sfaa013)
        RETURNING g_sfaa.sfaa013

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa014',g_sfaa.sfaa014)
        RETURNING g_sfaa.sfaa014

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa015',g_sfaa.sfaa015)
        RETURNING g_sfaa.sfaa015

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa016',g_sfaa.sfaa016)
        RETURNING g_sfaa.sfaa016

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa017',g_sfaa.sfaa017)
        RETURNING g_sfaa.sfaa017

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa018',g_sfaa.sfaa018)
        RETURNING g_sfaa.sfaa018

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa019',g_sfaa.sfaa019)
        RETURNING g_sfaa.sfaa019 
        
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa020',g_sfaa.sfaa020)
        RETURNING g_sfaa.sfaa020

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa021',g_sfaa.sfaa021)
        RETURNING g_sfaa.sfaa021

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa022',g_sfaa.sfaa022)
        RETURNING g_sfaa.sfaa022

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa023',g_sfaa.sfaa023)
        RETURNING g_sfaa.sfaa023

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa024',g_sfaa.sfaa024)
        RETURNING g_sfaa.sfaa024

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa025',g_sfaa.sfaa025)
        RETURNING g_sfaa.sfaa025

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa026',g_sfaa.sfaa026)
        RETURNING g_sfaa.sfaa026

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa028',g_sfaa.sfaa028)
        RETURNING g_sfaa.sfaa028

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa029',g_sfaa.sfaa029)
        RETURNING g_sfaa.sfaa029

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa030',g_sfaa.sfaa030)
        RETURNING g_sfaa.sfaa030 
        
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa031',g_sfaa.sfaa031)
        RETURNING g_sfaa.sfaa031

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa032',g_sfaa.sfaa032)
        RETURNING g_sfaa.sfaa032

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa033',g_sfaa.sfaa033)
        RETURNING g_sfaa.sfaa033

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa034',g_sfaa.sfaa034)
        RETURNING g_sfaa.sfaa034

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa035',g_sfaa.sfaa035)
        RETURNING g_sfaa.sfaa035

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa036',g_sfaa.sfaa036)
        RETURNING g_sfaa.sfaa036

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa037',g_sfaa.sfaa037)
        RETURNING g_sfaa.sfaa037

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa038',g_sfaa.sfaa038)
        RETURNING g_sfaa.sfaa038

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa039',g_sfaa.sfaa039)
        RETURNING g_sfaa.sfaa039

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa040',g_sfaa.sfaa040)
        RETURNING g_sfaa.sfaa040 
        
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa041',g_sfaa.sfaa041)
        RETURNING g_sfaa.sfaa041

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa042',g_sfaa.sfaa042)
        RETURNING g_sfaa.sfaa042

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa043',g_sfaa.sfaa043)
        RETURNING g_sfaa.sfaa043

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa044',g_sfaa.sfaa044)
        RETURNING g_sfaa.sfaa044

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa045',g_sfaa.sfaa045)
        RETURNING g_sfaa.sfaa045

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa046',g_sfaa.sfaa046)
        RETURNING g_sfaa.sfaa046

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa047',g_sfaa.sfaa047)
        RETURNING g_sfaa.sfaa047

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa048',g_sfaa.sfaa048)
        RETURNING g_sfaa.sfaa048

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa049',g_sfaa.sfaa049)
        RETURNING g_sfaa.sfaa049

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa050',g_sfaa.sfaa050)
        RETURNING g_sfaa.sfaa050 
        
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa051',g_sfaa.sfaa051)
        RETURNING g_sfaa.sfaa051

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa055',g_sfaa.sfaa055)
        RETURNING g_sfaa.sfaa055

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa056',g_sfaa.sfaa056)
        RETURNING g_sfaa.sfaa056

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa057',g_sfaa.sfaa057)
        RETURNING g_sfaa.sfaa057

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa058',g_sfaa.sfaa058)
        RETURNING g_sfaa.sfaa058

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa059',g_sfaa.sfaa059)
        RETURNING g_sfaa.sfaa059

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa060',g_sfaa.sfaa060)
        RETURNING g_sfaa.sfaa060

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa061',g_sfaa.sfaa061)
        RETURNING g_sfaa.sfaa061

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa062',g_sfaa.sfaa062)
        RETURNING g_sfaa.sfaa062

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa063',g_sfaa.sfaa063)
        RETURNING g_sfaa.sfaa063 
        
   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa064',g_sfaa.sfaa064)
        RETURNING g_sfaa.sfaa064

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa065',g_sfaa.sfaa065)
        RETURNING g_sfaa.sfaa065

   #產生的工單生管結案狀態(sfaa065)請預設為0  
   LET g_sfaa.sfaa065 = '0'

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa068',g_sfaa.sfaa068)
        RETURNING g_sfaa.sfaa068

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa069',g_sfaa.sfaa069)
        RETURNING g_sfaa.sfaa069

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaa070',g_sfaa.sfaa070)
        RETURNING g_sfaa.sfaa070

   CALL s_aooi200_get_doc_default(tm.psfb003,'1',g_sfaa.sfaadocno,'sfaastus',g_sfaa.sfaastus)
        RETURNING g_sfaa.sfaastus

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 產生生產料號明細
# Memo...........:
# Usage..........: CALL apsp820_sfac_ins()
#                  RETURNING r_success
# Return code....: r_success
# Date & Author..: 2015/01/15 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apsp820_sfac_ins()
   DEFINE r_success     LIKE type_t.num5
   DEFINE l_sql         STRING
   DEFINE l_sql1        STRING
   DEFINE l_sql2        STRING
   DEFINE l_sql3        STRING
   DEFINE l_sfac        RECORD LIKE sfac_t.*
   DEFINE l_n           LIKE type_t.num5

   LET r_success = TRUE

   #聯產品 
   LET l_sql1 = "SELECT UNIQUE bmab003,'2',bmab004*",g_sfaa.sfaa012/100,",'',0,' ' ",
                "  FROM bmab_t ",
                " WHERE bmabent  = '",g_enterprise,"' ",
                "   AND bmabsite = '",tm.psfb003,"' ",
                "   AND bmab001  = '",g_sfaa.sfaa010,"' ",
                "   AND bmab002  = '",g_sfaa.sfaa011,"' "

   #多產出主件 
   LET l_sql2 = "SELECT UNIQUE bmad003,'3',bmad004*",g_sfaa.sfaa012,",bmad005,0,' ' ",
                "  FROM bmad_t ",
                " WHERE bmadent  = '",g_enterprise,"' ",
                "   AND bmadsite = '",tm.psfb003,"' ",
                "   AND bmad001  = '",g_sfaa.sfaa010,"' ",
                "   AND bmad002  = '",g_sfaa.sfaa011,"' "

   #副產品  
   LET l_sql3 = "SELECT UNIQUE bmac003,'5',bmac005/bmac006*",g_sfaa.sfaa012,",bmac004,0,' ' ",
                "  FROM bmac_t ",
                " WHERE bmacent  = '",g_enterprise,"' ",
                "   AND bmacsite = '",tm.psfb003,"' ",
                "   AND bmac001  = '",g_sfaa.sfaa010,"' ",
                "   AND bmac002  = '",g_sfaa.sfaa011,"' "

   LET l_sql = l_sql1," UNION ",l_sql2," UNION ",l_sql3
   PREPARE apsp820_sfac_prep FROM l_sql
   DECLARE apsp820_sfac_curs CURSOR FOR apsp820_sfac_prep

   LET l_n = 0
   SELECT COUNT(*) INTO l_n
     FROM bmad_t
    WHERE bmadent  = g_enterprise
      AND bmadsite = tm.psfb003
      AND bmad001  = g_sfaa.sfaa010
      AND bmad002  = g_sfaa.sfaa011
   IF cl_null(l_n) OR l_n = 0 THEN
      INITIALIZE l_sfac.* TO NULL

      LET l_sfac.sfacent   = g_sfaa.sfaaent
      LET l_sfac.sfacsite  = g_sfaa.sfaasite
      LET l_sfac.sfacdocno = g_sfaa.sfaadocno 
      
      SELECT MAX(sfacseq) + 1 INTO l_sfac.sfacseq
        FROM sfac_t
       WHERE sfacent   = g_sfaa.sfaaent
         AND sfacsite  = g_sfaa.sfaasite
         AND sfacdocno = g_sfaa.sfaadocno
      IF cl_null(l_sfac.sfacseq) THEN
         LET l_sfac.sfacseq = 1
      END IF

      LET l_sfac.sfac001 = g_sfaa.sfaa010
      LET l_sfac.sfac002 = '1'
      LET l_sfac.sfac003 = g_sfaa.sfaa012
      LET l_sfac.sfac004 = g_sfaa.sfaa013
      LET l_sfac.sfac005 = 0
      LET l_sfac.sfac006 = g_detail_d[l_ac].psgb003 
      
      #160824-00034#2-s-mod
      ##160512-00016#12 20160525 add by ming -----(S) 
      #LET l_sfac.sfac007 = g_detail_d[l_ac].psgb029 
      #IF cl_null(l_sfac.sfac007) THEN 
      #   LET l_sfac.sfac007 = 'N' 
      #END IF 
      ##160512-00016#12 20160525 add by ming -----(E) 
      LET l_sfac.sfac007 = 'N' 
      #160824-00034#2-e-mod
      
      INSERT INTO sfac_t VALUES(l_sfac.*)

      IF SQLCA.sqlcode THEN
         LET r_success = FALSE

         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = 'ins sfac_t'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
   END IF 
   
   INITIALIZE l_sfac.* TO NULL

   FOREACH apsp820_sfac_curs INTO l_sfac.sfac001,l_sfac.sfac002,l_sfac.sfac003,
                                  l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfac006
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE

         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = 'FOREACH apsp820_sfac_curs'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      IF cl_null(l_sfac.sfac001) THEN
         CONTINUE FOREACH
      END IF

      LET l_sfac.sfacent   = g_sfaa.sfaaent
      LET l_sfac.sfacsite  = g_sfaa.sfaasite
      LET l_sfac.sfacdocno = g_sfaa.sfaadocno

      SELECT MAX(sfacseq) + 1 INTO l_sfac.sfacseq
        FROM sfac_t
       WHERE sfacent   = g_sfaa.sfaaent
         AND sfacsite  = g_sfaa.sfaasite 
         AND sfacdocno = g_sfaa.sfaadocno
      IF cl_null(l_sfac.sfacseq) THEN
         LET l_sfac.sfacseq = 1
      END IF

      IF cl_null(l_sfac.sfac004) THEN
         SELECT bmaa004 INTO l_sfac.sfac004
           FROM bmaa_t
          WHERE bmaaent  = g_enterprise
            AND bmaasite = tm.psfb003
            AND bmaa001  = g_sfaa.sfaa010
            AND bmaa002  = g_sfaa.sfaa011
      END IF

      #聯產品 
      IF l_sfac.sfac002 = '2' THEN
         LET l_sfac.sfac006 = g_detail_d[l_ac].psgb003
      END IF
      
      #160512-00016#12 20160525 add by ming -----(S) 
      LET l_sfac.sfac007 = 'N' 
      #160512-00016#12 20160525 add by ming -----(E) 

      INSERT INTO sfac_t VALUES(l_sfac.*)

      IF SQLCA.sqlcode THEN
         LET r_success = FALSE

         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = 'ins sfac_t'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE 
         CALL cl_err()

         EXIT FOREACH
      END IF

      INITIALIZE l_sfac.* TO NULL
   END FOREACH

   RETURN r_success 
   
END FUNCTION

#end add-point
 
{</section>}
 
