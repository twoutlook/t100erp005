<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="apmm826" std_prog="apmm826" erpver="1.0" module="APM" ver="2" env="s" zone="t10dev" booking="N" type="M" identity="s">
  <other>
    <code_template value="F" status=""/>
    <free_style value="N" status=""/>
  </other>
  <point name="construct.c.pmai001" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "('1','3')"
            CALL q_pmaa001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmai001  #顯示到畫面上

            NEXT FIELD pmai001                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmai003" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_8()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmai003  #顯示到畫面上

            NEXT FIELD pmai003                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmai006" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = '2048'
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmai006  #顯示到畫面上

            NEXT FIELD pmai006                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmai012" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_8()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmai012  #顯示到畫面上

            NEXT FIELD pmai012                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmaicnfid" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmaicnfid  #顯示到畫面上

            NEXT FIELD pmaicnfid                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmaicrtdp" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmaicrtdp  #顯示到畫面上

            NEXT FIELD pmaicrtdp                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmaicrtid" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmaicrtid  #顯示到畫面上

            NEXT FIELD pmaicrtid                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmaimodid" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmaimodid  #顯示到畫面上

            NEXT FIELD pmaimodid                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmaiowndp" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmaiowndp  #顯示到畫面上

            NEXT FIELD pmaiowndp                     #返回原欄位

]]>
  </point>
  <point name="construct.c.pmaiownid" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmaiownid  #顯示到畫面上

            NEXT FIELD pmaiownid                     #返回原欄位

]]>
  </point>
  <point name="desc_show.show" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   SELECT pmaastus,pmaa083 INTO g_browser[l_ac].b_pmaastus,g_browser[l_ac].b_pmaa083
     FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_browser[l_ac].b_pmai001
   DISPLAY BY NAME g_browser[l_ac].b_pmaastus,g_browser[l_ac].b_pmaa083
   
   IF cl_null(g_browser[l_ac].b_pmai004) THEN
      LET g_browser[l_ac].b_show = g_browser[l_ac].b_pmai001,"  ",g_browser[l_ac].b_pmai001_desc
      LET g_browser[l_ac].b_pmai001=NULL
      LET g_browser[l_ac].b_pmai001_desc = null
   ELSE
      LET g_browser[l_ac].b_show = g_browser[l_ac].b_pmai005
   END IF
]]>
  </point>
  <point name="input.a.pmaa083" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="input.a.pmai001" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[#            IF g_pmai_m.pmai001 <> g_pmai_m.pmai005 THEN 
#               IF NOT ap_chk_isExist(g_pmai_m.pmai001,"SELECT COUNT(*) FROM pmai_t WHERE pmai005 = ? ",'tree-002',1)  THEN
#                  NEXT FIELD pmai001
#               END IF
#            END IF
             IF NOT cl_null(g_pmai_m.pmai001) THEN
                IF p_cmd = 'a' OR (p_cmd = 'u' AND g_pmai_m.pmai001 != g_pmai001_t) THEN
                   SELECT MAX(pmai002)+1 INTO g_pmai_m.pmai002 FROM pmai_t
                    WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
                   IF cl_null(g_pmai_m.pmai002) THEN LET  g_pmai_m.pmai002 =1 END IF
                   
                   IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmai_t WHERE pmaient = '"||g_enterprise||"' AND pmai001 ='"||g_pmai_m.pmai001||"' AND pmai002 = "||g_pmai_m.pmai002,'std-00004',1) THEN 
                      LET g_pmai_m.pmai001 = g_pmai001_t
                      NEXT FIELD CURRENT
                   END IF
                   IF NOT ap_chk_isExist(g_pmai_m.pmai001,"SELECT COUNT(*) FROM pmaa_t WHERE pmaaent='"||g_enterprise||"' AND pmaa001=? ",'apm-00016',1) THEN
                      LET g_pmai_m.pmai001 = g_pmai001_t
                      NEXT FIELD CURRENT
                   END IF
                   IF NOT ap_chk_isExist(g_pmai_m.pmai001,"SELECT COUNT(*) FROM pmaa_t WHERE pmaaent='"||g_enterprise||"' AND pmaa001=? AND pmaastus='Y'",'apm-00017',1) THEN
                      LET g_pmai_m.pmai001 = g_pmai001_t
                      NEXT FIELD CURRENT
                   END IF
                END IF
                CALL apmm826_pmaa001_desc()
             END IF

]]>
  </point>
  <point name="input.a.pmai002" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
#            IF  NOT cl_null(g_pmai_m.pmai001) AND NOT cl_null(g_pmai_m.pmai002) THEN 
#               IF p_cmd = 'a' OR ( p_cmd = 'u' AND ( p_cmd = 'u' AND (g_pmai_m.pmai001 != g_pmai001_t  OR g_pmai_m.pmai002 != g_pmai002_t ))) THEN 
#                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmai_t WHERE "||"pmaient = '" ||g_enterprise|| "' AND "||"pmai001 = '"||g_pmai_m.pmai001 ||"' AND "|| "pmai002 = '"||g_pmai_m.pmai002 ||"'",'std-00004',0) THEN 
#                     NEXT FIELD CURRENT
#                  END IF
#               END IF
#            END IF


]]>
  </point>
  <point name="input.c.pmai001" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmai_m.pmai001             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "('1','3')"
            CALL q_pmaa001_1()                                #呼叫開窗

            LET g_pmai_m.pmai001 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmai_m.pmai001 TO pmai001              #顯示到畫面上

            NEXT FIELD pmai001                          #返回原欄位

]]>
  </point>
  <point name="input.c.pmai003" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmai_m.pmai003             #給予default值

            #給予arg

            CALL q_ooea001_8()                                #呼叫開窗

            LET g_pmai_m.pmai003 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmai_m.pmai003 TO pmai003              #顯示到畫面上
            CALL apmm826_pmai003_desc()
            NEXT FIELD pmai003                          #返回原欄位

]]>
  </point>
  <point name="input.c.pmai006" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmai_m.pmai006             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "2048" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmai_m.pmai006 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmai_m.pmai006 TO pmai006              #顯示到畫面上
            CALL apmm826_pmai006_desc()
            NEXT FIELD pmai006                          #返回原欄位

]]>
  </point>
  <point name="input.c.pmai012" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmai_m.pmai012             #給予default值

            #給予arg

            CALL q_ooea001_8()                                #呼叫開窗

            LET g_pmai_m.pmai012 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmai_m.pmai012 TO pmai012              #顯示到畫面上
            CALL apmm826_pmai012_desc()
            NEXT FIELD pmai012                          #返回原欄位

]]>
  </point>
  <point name="function.apmm826_create_tree" order="1" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[#+ 手工寫樹
PRIVATE FUNCTION apmm826_create_tree()
DEFINE l_pid    LIKE type_t.chr50   #用於樹的第一層
DEFINE l_pid2    LIKE type_t.chr50  #用於樹的第二層  
   IF cl_null(g_wc_def) THEN
      LET g_wc_def = " 1=1"
   END IF
   LET g_sql = " SELECT UNIQUE pmai001 FROM pmai_t WHERE ",g_wc_def, 
               " ORDER BY pmai001"
   PREPARE master_type_0 FROM g_sql
   DECLARE master_typecur_0 CURSOR FOR master_type_0
   
   INITIALIZE g_browser_root TO NULL
   
   LET l_ac = 1
   FOREACH master_typecur_0 INTO g_browser[l_ac].b_pmai001
      #確定root節點所在
      LET g_browser_root[g_browser_root.getLength()+1] = l_ac
      #此處為帳別部分(LV-1)
      LET g_browser[l_ac].b_pmai001 = g_browser[l_ac].b_pmai001
      LET g_browser[l_ac].b_pid = '0' CLIPPED
      LET g_browser[l_ac].b_id = l_ac USING "<<<"
      LET g_browser[l_ac].b_exp = TRUE
      LET g_browser[l_ac].b_hasC = TRUE
      #第一層節點編號
      LET l_pid = g_browser[l_ac].b_id CLIPPED
      LET l_ac = l_ac + 1
      LET g_cnt = l_ac
      
      #抓出LV2的所有資料
      LET g_sql = " SELECT UNIQUE pmai001,pmai002,pmai005,pmai003,pmai004,pmai006,pmai007,pmai009,pmai010,pmaistus FROM pmai_t ",
                  " WHERE ",g_wc_def,
                  " AND pmai001 = '",g_browser[g_cnt-1].b_pmai001,"'",
                  " ORDER BY pmai005 DESC"
      PREPARE master_getLV2_1 FROM g_sql
      DECLARE master_getLV2cur_1 CURSOR FOR master_getLV2_1
      
      #以下為一般資料root(LV-2)
      OPEN master_getLV2cur_1
      
      FOREACH master_getLV2cur_1 INTO g_browser[g_cnt].b_pmai001,g_browser[g_cnt].b_pmai002,g_browser[g_cnt].b_pmai005,g_browser[g_cnt].b_pmai003,g_browser[g_cnt].b_pmai004,
                                     g_browser[g_cnt].b_pmai006,g_browser[g_cnt].b_pmai007,g_browser[g_cnt].b_pmai009,g_browser[g_cnt].b_pmai010,g_browser[g_cnt].b_pmaistus #,g_browser[g_cnt].b_expcode
         #去除多餘空白
         LET g_browser[g_cnt].b_pid = l_pid
               LET g_browser[g_cnt].b_id = l_pid,".",g_cnt USING "<<<"
               LET g_browser[g_cnt].b_exp = FALSE
               LET g_browser[g_cnt].b_expcode = 2
               LET g_browser[g_cnt].b_hasC = FALSE
               LET g_cnt = g_cnt + 1
      END FOREACH
      LET l_ac = g_browser.getLength()
      
   END FOREACH
   
   #組合描述欄位&刪除多於資料
   FOR l_ac = 1 TO g_browser.getLength()
      IF cl_null(g_browser[l_ac].b_pmai001) THEN
         CALL g_browser.deleteElement(l_ac)
         LET l_ac = l_ac - 1
      ELSE
         CALL apmm826_desc_show(l_ac)
      END IF
   END FOR
   CALL g_browser.deleteElement(l_ac)   
   LET g_browser_cnt = g_browser.getLength() - g_browser_root.getLength()
   DISPLAY g_browser_cnt TO FORMONLY.b_count
   FREE tree_expand
   FREE master_getLV2_1
END FUNCTION]]>
  </point>
  <point name="function.apmm826_pmaa001_desc" order="2" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[#+
PRIVATE FUNCTION apmm826_pmaa001_desc()
   SELECT pmaal004,pmaastus,pmaa083 INTO g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083
     FROM pmaa_t LEFT OUTER JOIN pmaal_t ON pmaal001 = pmaa001 AND pmaal002 = g_dlang AND pmaalent = g_enterprise
    WHERE pmaaent = g_enterprise AND pmaa001 = g_pmai_m.pmai001
   DISPLAY BY NAME g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083
END FUNCTION]]>
  </point>
  <point name="function.apmm826_pmai003_desc" order="3" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION apmm826_pmai003_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmai003
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmai003_desc =  g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmai003_desc
END FUNCTION]]>
  </point>
  <point name="function.apmm826_pmai006_desc" order="4" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION apmm826_pmai006_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmai006
   CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='2048' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmai006_desc =  g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmai006_desc

END FUNCTION]]>
  </point>
  <point name="function.apmm826_pmai012_desc" order="5" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION apmm826_pmai012_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmai012
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmai012_desc =  g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmai012_desc
END FUNCTION]]>
  </point>
  <point name="browser_create.define" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="browser_fill.before_fill" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   LET g_wc_def = p_wc
   CALL g_browser.clear()
   CLEAR FORM
   CALL apmm826_create_tree()
   RETURN ]]>
  </point>
  <point name="fetch.after_fetch" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="fetch.before_refresh" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF (cl_null(g_current_idx) OR g_current_idx=0) THEN
      LET g_current_idx = 1
   END IF
   IF cl_null(g_browser[g_current_idx].b_pmai002) or g_browser[g_current_idx].b_pmai002=0 THEN
      RETURN
   END IF
   LET g_pmai_m.pmai002 = g_browser[g_current_idx].b_pmai002
   CALL apmm826_pmaa001_desc()]]>
  </point>
  <point name="fetch.befroe_fetch" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF (cl_null(g_current_idx) OR g_current_idx=0) THEN
      LET g_current_idx = 1
   END IF
   IF cl_null(g_browser[g_current_idx].b_pmai002) or g_browser[g_current_idx].b_pmai002=0 THEN
      RETURN
   END IF
   LET g_pmai_m.pmai002 = g_browser[g_current_idx].b_pmai002          {#ADP版次:1#}]]>
  </point>
  <point name="fetch.define" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[DEFINE g_wc_def           STRING
DEFINE g_act_flag         LIKE type_t.num5]]>
  </point>
  <point name="init.init" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL cl_set_comp_visible("pmai002,lbl_pmai002,b_pmai002",FALSE)
   CALL cl_set_combo_scc_part('b_pmaistus','50','N,X,Y')
   CALL cl_set_combo_scc_part('b_pmaastus','50','N,X,Y')]]>
  </point>
  <point name="input.a.pmai003" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            LET g_pmai_m.pmai003_desc =  ''
            DISPLAY BY NAME g_pmai_m.pmai003_desc
            IF NOT cl_null(g_pmai_m.pmai003) THEN
               IF NOT ap_chk_isExist(g_pmai_m.pmai003,"SELECT COUNT(*) FROM ooea_t WHERE ooeaent='"||g_enterprise||"' AND ooea001=? AND ooea014='Y'" ,'aim-00058',1) THEN
                  LET g_pmai_m.pmai003 = g_pmai_m_t.pmai003
                  NEXT FIELD CURRENT
               END IF
               IF NOT ap_chk_isExist(g_pmai_m.pmai003,"SELECT COUNT(*) FROM ooea_t WHERE ooeaent='"||g_enterprise||"' AND ooea001=? AND ooea014='Y' AND ooeastus='Y'" ,'aim-00059',1) THEN
                  LET g_pmai_m.pmai003 = g_pmai_m_t.pmai003
                  NEXT FIELD CURRENT
               END IF
            END IF
            CALL apmm826_pmai003_desc()]]>
  </point>
  <point name="input.a.pmai005" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_pmai_m.pmai005) THEN
               IF g_pmai_m.pmai005 > g_today THEN
                  CALL cl_err(g_pmai_m.pmai005,'apm-00153',1)
                  LET g_pmai_m.pmai005 = g_pmai_m_t.pmai005
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.a.pmai006" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            LET g_pmai_m.pmai006_desc =  ''
            DISPLAY BY NAME g_pmai_m.pmai006_desc
            IF NOT cl_null(g_pmai_m.pmai006) THEN
               IF NOT ap_chk_isExist(g_pmai_m.pmai006,"SELECT COUNT(*) FROM oocq_t WHERE oocqent ='"||g_enterprise||"' AND oocq001 ='2048' AND oocq002=?",'apm-00154',1) THEN
                  LET g_pmai_m.pmai006 = g_pmai_m_t.pmai006
                  NEXT FIELD CURRENT
               END IF
               IF NOT ap_chk_isExist(g_pmai_m.pmai006,"SELECT COUNT(*) FROM oocq_t WHERE oocqent ='"||g_enterprise||"' AND oocq001 ='2048' AND oocq002=? AND oocqstus='Y'",'apm-00155',1) THEN
                  LET g_pmai_m.pmai006 = g_pmai_m_t.pmai006
                  NEXT FIELD CURRENT
               END IF
            END IF
            CALL apmm826_pmai006_desc()]]>
  </point>
  <point name="input.a.pmai010" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_pmai_m.pmai010) THEN
               IF g_pmai_m.pmai010 > g_today THEN
                  CALL cl_err(g_pmai_m.pmai010,'apm-00153',1)
                  LET g_pmai_m.pmai010 = g_pmai_m_t.pmai010
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.a.pmai012" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            LET g_pmai_m.pmai012_desc =  ''
            DISPLAY BY NAME g_pmai_m.pmai012_desc
            IF NOT cl_null(g_pmai_m.pmai012) THEN
               IF NOT ap_chk_isExist(g_pmai_m.pmai012,"SELECT COUNT(*) FROM ooea_t WHERE ooeaent='"||g_enterprise||"' AND ooea001=? AND ooea014='Y'" ,'aim-00058',1) THEN
                  LET g_pmai_m.pmai012 = g_pmai_m_t.pmai012
                  NEXT FIELD CURRENT
               END IF
               IF NOT ap_chk_isExist(g_pmai_m.pmai012,"SELECT COUNT(*) FROM ooea_t WHERE ooeaent='"||g_enterprise||"' AND ooea001=? AND ooea014='Y' AND ooeastus='Y'" ,'aim-00059',1) THEN
                  LET g_pmai_m.pmai012 = g_pmai_m_t.pmai012
                  NEXT FIELD CURRENT
               END IF
            END IF
            CALL apmm826_pmai012_desc()]]>
  </point>
  <point name="input.after_set_no_entry" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   DISPLAY BY NAME g_pmai_m.pmai006_desc]]>
  </point>
  <point name="input.head.b_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[                  SELECT MAX(pmai002)+1 INTO g_pmai_m.pmai002 FROM pmai_t
                   WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
                  IF cl_null(g_pmai_m.pmai002) THEN LET  g_pmai_m.pmai002 =1 END IF]]>
  </point>
  <point name="insert.before_insert" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="insert.default" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[       IF NOT cl_null(g_browser[g_current_idx].b_pmai001) THEN
         LET g_pmai_m.pmai001 =g_browser[g_current_idx].b_pmai001
         CALL apmm826_pmaa001_desc()
       ELSE
         LET g_pmai_m.pmai001 =null
       END IF
       SELECT MAX(pmai002)+1 INTO g_pmai_m.pmai002 FROM pmai_t
        WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
       IF cl_null(g_pmai_m.pmai002) THEN LET  g_pmai_m.pmai002 =1 END IF
       LET g_pmai_m.pmai003 = g_site
       CALL apmm826_pmai003_desc()
       SELECT oofa011 INTO g_pmai_m.pmai004 FROM oofa_t
        WHERE oofaent = g_enterprise AND oofa003 = g_user
       LET g_pmai_m.pmai005 = g_today
       LET g_pmai_m.pmai012 = g_site
       CALL apmm826_pmai012_desc()
       LET g_pmai_m_t.* = g_pmai_m.*
       LET g_pmai001_t = g_pmai_m.pmai001]]>
  </point>
  <point name="menu.delete" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[               CALL apmm826_browser_fill(g_wc,g_searchtype)]]>
  </point>
  <point name="menu.follow_up" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[               LET g_act_flag = TRUE
               CALL apmm826_modify()]]>
  </point>
  <point name="menu2.delete" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[               CALL apmm826_browser_fill(g_wc,g_searchtype)]]>
  </point>
  <point name="modify.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[      IF g_act_flag THEN
         IF cl_null(g_pmai_m.pmai009) THEN
            SELECT oofa011 INTO g_pmai_m.pmai009 FROM oofa_t
             WHERE oofaent = g_enterprise AND oofa003 = g_user
         END IF
         LET g_pmai_m.pmai010 = g_today
         LET g_pmai_m_t.pmai009 = g_pmai_m.pmai009
         LET g_pmai_m_t.pmai010 = g_pmai_m.pmai010
      END IF]]>
  </point>
  <point name="reproduce.a.pmai001" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[         SELECT MAX(pmai002)+1 INTO l_newno02 FROM pmai_t
                    WHERE pmaient = g_enterprise AND pmai001 = l_newno
                   IF cl_null(l_newno02) THEN LET  l_newno02 =1 END IF
         IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmai_t WHERE pmaient = '"||g_enterprise||"' AND pmai001 ='"||l_newno||"' AND pmai002 = "||l_newno02,'std-00004',1) THEN 
            LET l_newno = ''
            DISPLAY l_newno TO pmai001
            NEXT FIELD CURRENT
         END IF
         IF NOT ap_chk_isExist(l_newno,"SELECT COUNT(*) FROM pmaa_t WHERE pmaaent='"||g_enterprise||"' AND pmaa001=? ",'apm-00016',1) THEN
            LET l_newno = ''
            DISPLAY l_newno TO pmai001
            NEXT FIELD CURRENT
         END IF
         IF NOT ap_chk_isExist(l_newno,"SELECT COUNT(*) FROM pmaa_t WHERE pmaaent='"||g_enterprise||"' AND pmaa001=? AND pmaastus='Y'",'apm-00017',1) THEN
            LET l_newno = ''
            DISPLAY l_newno TO pmai001
            NEXT FIELD CURRENT
         END IF
    ON ACTION controlp INFIELD pmai001
            #add-point:ON ACTION controlp INFIELD pmai001
#此段落由子樣板a07產生            
            #開窗i段
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
      
            LET g_qryparam.default1 = l_newno             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "('1','3')"
            CALL q_pmaa001_1()                                #呼叫開窗
     
            LET l_newno = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY l_newno TO pmai001              #顯示到畫面上
            SELECT pmaal004,pmaastus,pmaa083 INTO g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083
              FROM pmaa_t LEFT OUTER JOIN pmaal_t ON pmaal001 = pmaa001 AND pmaal002 = g_dlang AND pmaalent = g_enterprise
             WHERE pmaaent = g_enterprise AND pmaa001 = l_newno
             DISPLAY BY NAME g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083
            NEXT FIELD pmai001                          #返回原欄位
]]>
  </point>
  <point name="reproduce.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            ]]>
  </point>
  <point name="set_entry.after_control" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL cl_set_comp_entry("pmai003,pmai004,pmai005,pmai006,pmai007",TRUE)
   CALL cl_set_comp_entry("pmai008,pmai009,pmai010,pmai011,pmai012",TRUE)]]>
  </point>
  <point name="set_no_entry.after_control" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF g_act_flag THEN        #click 維護後續處理內容
      LET g_act_flag = FALSE
      CALL cl_set_comp_entry("pmai003,pmai004,pmai005,pmai006,pmai007",FALSE)
      CALL cl_set_comp_entry("pmai008,pmai012",FALSE)
   ELSE
      CALL cl_set_comp_entry("pmai009,pmai010,pmai011",FALSE)
   END IF]]>
  </point>
  <point name="show.after" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF g_pmai_m.pmaistus = 'Y' OR g_pmai_m.pmaistus = 'X' THEN
      CALL cl_set_act_visible("modify,delete",FALSE)
   ELSE
      CALL cl_set_act_visible("modify,delete",TRUE)
   END IF]]>
  </point>
  <point name="show.head.reference" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL apmm826_pmaa001_desc()
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmaiownid
   CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
   LET g_pmai_m.pmaiownid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmaiownid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmaiowndp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmaiowndp_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmaiowndp_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmaicrtid
   CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
   LET g_pmai_m.pmaicrtid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmaicrtid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmaicrtdp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmaicrtdp_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmaicrtdp_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmaimodid
   CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
   LET g_pmai_m.pmaimodid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmaimodid_desc

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmaicnfid
   CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
   LET g_pmai_m.pmaicnfid_desc = g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmaicnfid_desc
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmai003
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmai003_desc =  g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmai003_desc
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmai006
   CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='2048' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmai006_desc =  g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmai006_desc
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmai_m.pmai012
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmai_m.pmai012_desc =  g_rtn_fields[1]
   DISPLAY BY NAME g_pmai_m.pmai012_desc]]>
  </point>
  <point name="statechange.a_update" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF lc_state = 'Y' THEN
      LET l_date = cl_get_current()
      UPDATE pmai_t SET pmaicnfid = g_user,
                        pmaicnfdt = l_date      
    WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
      AND pmai002 = g_pmai_m.pmai002 
   ELSE
      UPDATE pmai_t SET pmaicnfid = '',
                        pmaicnfdt = ''      
    WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
      AND pmai002 = g_pmai_m.pmai002     
   END IF
   IF SQLCA.sqlcode THEN
      CALL cl_err("",SQLCA.sqlcode,0)
   END IF]]>
  </point>
  <point name="statechange.b_update" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CASE WHEN lc_state = 'Y'
           IF NOT cl_ask_confirm('aim-00108') THEN
              RETURN
           END IF
        WHEN lc_state = 'N'
           IF NOT cl_ask_confirm('aim-00110') THEN
              RETURN
           END IF
        WHEN lc_state = 'X' 
           IF NOT cl_ask_confirm('aim-00109') THEN
              RETURN
           END IF
   END CASE]]>
  </point>
  <point name="statechange.before" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF g_pmai_m.pmaistus = 'X' THEN
      RETURN
   END IF
]]>
  </point>
  <point name="statechange.before_menu" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[         IF g_pmai_m.pmaistus = 'Y' THEN
            CALL cl_set_act_visible("void",FALSE)
         ELSE
            CALL cl_set_act_visible("void",TRUE)
         END IF]]>
  </point>
  <point name="statechange.define" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   DEFINE l_date  DATETIME YEAR TO SECOND]]>
  </point>
  <section id="apmm826.browser_create" ver="4" status="" src="s">
    <![CDATA[PRIVATE FUNCTION apmm826_browser_create(p_type)
   DEFINE p_type   LIKE type_t.chr50
   DEFINE l_pid    LIKE type_t.chr50
   #add-point:browser_create
   {<point name="browser_create.define"/>}
   #end add-point
   
   #先找出所有的帳別資料
   
   
   LET l_ac = 1
      #確定root節點所在
      #此處為帳別部分(LV-1)
      
      #抓出LV2的所有資料
      #LET g_sql = " SELECT UNIQUE pmai001,'','','',pmai002,pmai005,pmai003,pmai004,pmai006,'',pmai007, 
      #    pmai009,pmai010,pmaistus,exp_code FROM apmm826_tmp a ",
      LET g_sql = " SELECT UNIQUE pmai001,'','','',pmai002,pmai005,pmai003,pmai004,pmai006,'',pmai007, 
          pmai009,pmai010,pmaistus,t1.pmaal004 ,t2.oocql004 FROM apmm826_tmp a ",
                                 " LEFT JOIN pmaal_t t1 ON t1.pmaalent='"||g_enterprise||"' AND t1.pmaal001=pmai001 AND t1.pmaal002='"||g_lang||"' ",
               " LEFT JOIN oocql_t t2 ON t2.oocqlent='"||g_enterprise||"' AND t2.oocql001='2048' AND t2.oocql002=pmai006 AND t2.oocql003='"||g_lang||"' ",
 
                  " WHERE ",
                  " (( SELECT COUNT(*) FROM apmm826_tmp b WHERE a.pmai001 = b.pmai005 ", 
                  ") = 0 OR ", 
                  " a.pmai005 = a.pmai001 )", 
                  " ORDER BY a.pmai005"
      #add-point:browser_create.before_pre
      {<point name="browser_create.before_pre"/>}
      #end add-point
      PREPARE master_getLV2 FROM g_sql
      DECLARE master_getLV2cur CURSOR FOR master_getLV2
      
      #以下為一般資料root(LV-2)
      
      LET g_cnt = l_ac
      
      FOREACH master_getLV2cur INTO g_browser[g_cnt].b_pmai001,g_browser[g_cnt].b_pmai001_desc,g_browser[g_cnt].b_pmaastus, 
          g_browser[g_cnt].b_pmaa083,g_browser[g_cnt].b_pmai002,g_browser[g_cnt].b_pmai005,g_browser[g_cnt].b_pmai003, 
          g_browser[g_cnt].b_pmai004,g_browser[g_cnt].b_pmai006,g_browser[g_cnt].b_pmai006_desc,g_browser[g_cnt].b_pmai007, 
          g_browser[g_cnt].b_pmai009,g_browser[g_cnt].b_pmai010,g_browser[g_cnt].b_pmaistus,g_browser[g_cnt].b_pmai001_desc, 
          g_browser[g_cnt].b_pmai006_desc 
         #去除多餘空白
         #LET g_browser[g_cnt].b_pmai005 = g_browser[g_cnt].b_pmai005 CLIPPED
         LET g_browser[g_cnt].b_pid = l_pid
         LET g_browser[g_cnt].b_id = l_pid,".",g_cnt USING "<<<"
         LET g_browser[g_cnt].b_exp = FALSE
         LET g_browser[g_cnt].b_expcode = 2
         #CASE g_browser[g_cnt].b_expcode
         #   WHEN 2
         #      LET g_browser[g_cnt].b_hasC = apmm826_chk_hasC(g_cnt)
         #   WHEN 1
         #      LET g_browser[g_cnt].b_hasC = apmm826_chk_hasC(g_cnt)
         #   WHEN 0
         #      LET g_browser[g_cnt].b_hasC = FALSE
         #   WHEN -1
         #      #向下查找到展開值不等於-1得節點(temp table中查找)
         #      LET g_cnt = apmm826_find_node(g_cnt)
         #END CASE
         IF cl_null("pmai001") THEN
            LET g_browser[g_cnt].b_hasC = FALSE
         ELSE
            LET g_browser[g_cnt].b_hasC = TRUE
         END IF
 
         LET g_cnt = g_cnt + 1
      END FOREACH
      LET l_ac = g_browser.getLength()
 
   
   #組合描述欄位&刪除多於資料
   FOR l_ac = 1 TO g_browser.getLength()
      IF cl_null(g_browser[l_ac].b_pmai005) THEN
         CALL g_browser.deleteElement(l_ac)
         LET l_ac = l_ac - 1
      ELSE
         CALL apmm826_desc_show(l_ac)
      END IF
   END FOR
   CALL g_browser.deleteElement(l_ac)
 
   LET g_browser_cnt = g_browser.getLength() - g_browser_root.getLength()
 
   FREE tree_expand
   FREE master_getLV2
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.browser_expand" ver="3" status="" src="s">
    <![CDATA[#+ Tree子節點展開
PRIVATE FUNCTION apmm826_browser_expand(p_id)
   DEFINE p_id          LIKE type_t.num10
   DEFINE l_id          LIKE type_t.num10
   DEFINE l_cnt         LIKE type_t.num10
   DEFINE l_keyvalue    LIKE type_t.chr50
   DEFINE l_typevalue   LIKE type_t.chr50
   DEFINE l_type        LIKE type_t.chr50
   DEFINE l_sql         LIKE type_t.chr500
   DEFINE ls_source     LIKE type_t.chr500
   DEFINE ls_exp_code   LIKE type_t.chr500
   DEFINE l_return      LIKE type_t.num5
   #add-point:browser_expand段define
   {<point name="browser_expand.define"/>}
   #end add-point
 
   
   #若已經展開
   IF g_browser[p_id].b_isExp = 1 THEN
      RETURN
   END IF
   
   LET l_return = FALSE
 
   LET l_keyvalue = g_browser[p_id].b_pmai005
   
   CASE g_browser[p_id].b_expcode
      WHEN -1
         CALL g_browser.deleteElement(p_id)
      WHEN 0
         RETURN
      WHEN 1
         LET ls_source = "apmm826_tmp"
         LET ls_exp_code = "exp_code"
      WHEN 2
         LET ls_source = "pmai_t"
         LET ls_exp_code = "'2'"
   END CASE
   
   LET l_sql = " SELECT UNIQUE '','','','FALSE','','',",ls_exp_code,",pmai001,'','','',pmai002,pmai005, 
       pmai003,pmai004,pmai006,'',pmai007,pmai009,pmai010,pmaistus,t1.pmaal004 ,t2.oocql004",
               " FROM ",ls_source,
                              " LEFT JOIN pmaal_t t1 ON t1.pmaalent='"||g_enterprise||"' AND t1.pmaal001=pmai001 AND t1.pmaal002='"||g_lang||"' ",
               " LEFT JOIN oocql_t t2 ON t2.oocqlent='"||g_enterprise||"' AND t2.oocql001='2048' AND t2.oocql002=pmai006 AND t2.oocql003='"||g_lang||"' ",
 
               " WHERE pmai001 = '", l_keyvalue,
               "' AND pmai005 <> pmai001",
                " ORDER BY pmai005"
   
   #add-point:browser_expand段before_pre
   {<point name="browser_expand.before_pre"/>}
   #end add-point
   
   PREPARE tree_expand FROM l_sql
   DECLARE tree_ex_cur CURSOR FOR tree_expand
  
   LET l_id = p_id + 1
   LET g_cnt = p_id + 1
   CALL g_browser.insertElement(l_id)
   LET l_cnt = 1
   FOREACH tree_ex_cur INTO g_browser[l_id].*,g_browser[g_cnt].b_pmai001_desc,g_browser[g_cnt].b_pmai006_desc  

      #pid=父節點id
      LET g_browser[l_id].b_pid = g_browser[p_id].b_id
      #id=本身節點id(採流水號遞增)
      LET g_browser[l_id].b_id = g_browser[p_id].b_id||"."||l_cnt
      #hasC=確認該節點是否有子孫
      #LET g_browser[l_id].b_pmai005 = g_browser[l_id].b_pmai005 CLIPPED
      CALL apmm826_desc_show(l_id)
      LET g_browser[l_id].b_hasC = apmm826_chk_hasC(l_id)
      LET l_id = l_id + 1
      LET g_cnt = l_id
      CALL g_browser.insertElement(l_id)
      LET l_cnt = l_cnt + 1
      
      LET l_return = TRUE
   END FOREACH
   
   #刪除空資料
   CALL g_browser.deleteElement(l_id)
   
   DISPLAY g_browser.getLength() TO FORMONLY.h_count 
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.browser_fill" ver="4" status="" src="s">
    <![CDATA[#+ 瀏覽頁簽where條件組成
PRIVATE FUNCTION apmm826_browser_fill(p_wc,p_type)
   DEFINE p_wc       STRING 
   DEFINE p_type     LIKE type_t.chr10
   DEFINE l_cnt      LIKE type_t.num10
   DEFINE l_cnt2     LIKE type_t.num10   
   #add-point:browser_fill段define
   {<point name="browser_fill.define"/>}
   #end add-point
   
   #add-point:browser_fill段fill資料前
   {<point name="browser_fill.before_fill"/>}
   #end add-point
 
   CALL g_browser.clear()
   CLEAR FORM
   LET l_cnt = 0
   LET l_cnt2 = 0
   
   DROP TABLE apmm826_tmp
   
   #Create temp table
   CREATE TEMP TABLE apmm826_tmp
   (
         pmai001 VARCHAR(500),
   pmai001_desc VARCHAR(500),
   pmaastus VARCHAR(500),
   pmaa083 VARCHAR(500),
   pmai002 VARCHAR(500),
   pmai005 VARCHAR(500),
   pmai003 VARCHAR(500),
   pmai004 VARCHAR(500),
   pmai006 VARCHAR(500),
   pmai006_desc VARCHAR(500),
   pmai007 VARCHAR(500),
   pmai009 VARCHAR(500),
   pmai010 VARCHAR(500),
   pmaistus VARCHAR(500),
      #僅含browser的欄位
      exp_code  VARCHAR(5)
   );
 
   #先確定搜尋範圍(若無條件搜尋則只找root出來)
   SELECT COUNT(*) INTO l_cnt FROM pmai_t 
   
   #取得符合p_wc的所有資料
   LET g_sql = "SELECT COUNT(*)",
               " FROM pmai_t ",
               " WHERE pmaient = '" ||g_enterprise|| "' AND ",p_wc ,cl_sql_add_filter("pmai_t")
              
   PREPARE master_cnt FROM g_sql
   DECLARE master_cntcur CURSOR FOR master_cnt
   OPEN master_cntcur
   FETCH master_cntcur INTO l_cnt2
   LET g_root_search = FALSE
   
   IF l_cnt2 = 0 THEN
      CALL cl_err("","-100",1)
      RETURN
   END IF
   
   IF l_cnt = l_cnt2 THEN
      #未輸入條件時則只查找root節點
      LET p_wc = " pmai005 = pmai001 "
      LET g_root_search = TRUE
   END IF
 
   #取得符合p_wc的所有資料
   LET g_sql = "SELECT pmai001,'','','',pmai002,pmai005,pmai003,pmai004,pmai006,'',pmai007,pmai009,pmai010, 
       pmaistus ",
               " FROM pmai_t ",
               " WHERE pmaient = '" ||g_enterprise|| "' AND ",p_wc ,cl_sql_add_filter("pmai_t")
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料           
   PREPARE master_ext FROM g_sql
   DECLARE master_extcur CURSOR FOR master_ext
 
   #搜尋建構樹所需的節點
   CASE p_type
      WHEN "1" #上推
         CALL apmm826_match_node(p_wc,p_type) 
      WHEN "2" #下展
         #CALL apmm826_find_speed_tbl(p_wc,p_type) 
         CALL apmm826_match_node(p_wc,p_type) 
      WHEN "3" #全部
         CALL apmm826_match_node(p_wc,p_type) 
   END CASE
 
   CALL apmm826_browser_create(p_type)
     
END FUNCTION
]]>
  </section>
  <section id="apmm826.check" ver="3" status="" src="s">
    <![CDATA[#+ 避免資料錯誤
PRIVATE FUNCTION apmm826_check(ps_id,ps_pid)
   DEFINE ps_id       STRING
   DEFINE ps_pid      STRING
   DEFINE ps_type     STRING
   DEFINE ls_pid      LIKE type_t.chr100
   DEFINE ls_id       LIKE type_t.chr100
   DEFINE ls_type     LIKE type_t.chr100
   DEFINE ls_return   LIKE type_t.num5
   #add-point:check段define
   {<point name="check.define"/>}
   #end add-point
   
   LET ls_return = FALSE
   LET ls_pid = ps_pid
   LET ls_type = ps_type
   
   #比對所有祖先節點
   WHILE TRUE
      
      SELECT pmai001,pmai005 INTO ls_pid,ls_id FROM pmai_t
         WHERE pmai005 = ls_pid
 
      IF SQLCA.sqlcode OR ls_pid = ls_id THEN
         EXIT WHILE
      END IF
      
      IF ls_pid = ps_id THEN
         LET ls_return = TRUE
         EXIT WHILE
      END IF
      
   END WHILE
   
   RETURN ls_return
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.chk_hasC" ver="4" status="" src="s">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION apmm826_chk_hasC(pi_id)
   DEFINE pi_id    LIKE type_t.num10
   DEFINE li_cnt   LIKE type_t.num10
   #add-point:chk_hasC段define
   {<point name="chk_hasC.define"/>}
   #end add-point
   
   LET g_sql = "SELECT COUNT(pmai001) FROM apmm826_tmp ",
               " WHERE ",
                "pmai001 = ? AND ",
                "exp_code <> '-1' AND pmai005 <> pmai001 "
 
   PREPARE apmm826_temp_chk FROM g_sql
 
   LET g_sql = "SELECT COUNT(*) FROM pmai_t ",
               " WHERE pmaient = '" ||g_enterprise|| "' AND ", 
               "pmai005 <> pmai001 AND ",
               "pmai001 = ? ",
               cl_sql_add_filter("pmai_t")
   
   PREPARE apmm826_master_chk FROM g_sql
   
   CASE g_browser[pi_id].b_expcode 
      WHEN -1
         RETURN FALSE
      WHEN 0
         RETURN FALSE
      WHEN 1
         EXECUTE apmm826_temp_chk 
           USING g_browser[pi_id].b_pmai005
            INTO li_cnt
         FREE apmm826_temp_chk
      WHEN 2 
         EXECUTE apmm826_master_chk 
           USING g_browser[pi_id].b_pmai005
            INTO li_cnt
         FREE apmm826_master_chk
   END CASE
    
   IF li_cnt > 0 THEN
      RETURN TRUE
   ELSE
      RETURN FALSE
   END IF
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.construct" ver="4" status="" src="s">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION apmm826_construct()
   DEFINE ls_wc       STRING
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   #add-point:cs段define
   {<point name="cs.define"/>}
   #end add-point
    
   #清除畫面
   CLEAR FORM
   INITIALIZE g_pmai_m.* TO NULL
   INITIALIZE g_wc TO NULL
   LET g_qryparam.state = "c"
    
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      CONSTRUCT BY NAME g_wc ON pmai001,pmai002,pmaal004,pmaastus,pmaa083,pmai003,pmai004,pmai005,pmai006, 
          pmai012,pmaistus,pmai007,pmai008,pmai009,pmai010,pmai011,pmaiownid,pmaiowndp,pmaicrtid,pmaicrtdp, 
          pmaicrtdt,pmaimodid,pmaimoddt,pmaicnfid,pmaicnfdt 
      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
            {<point name="cs.before_construct"/>}
            #end add-point 
            
         #此段落由子樣板a11產生
         ##----<<pmaicrtdt>>----
         AFTER FIELD pmaicrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmaimoddt>>----
         AFTER FIELD pmaimoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmaicnfdt>>----
         AFTER FIELD pmaicnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmaipstdt>>----
 
 
 
                  #Ctrlp:construct.c.pmai001
         ON ACTION controlp INFIELD pmai001
            #add-point:ON ACTION controlp INFIELD pmai001
            {<point name="construct.c.pmai001" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai001
            #add-point:BEFORE FIELD pmai001
            {<point name="construct.b.pmai001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai001
            
            #add-point:AFTER FIELD pmai001
            {<point name="construct.a.pmai001" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai002
            #add-point:BEFORE FIELD pmai002
            {<point name="construct.b.pmai002" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai002
            
            #add-point:AFTER FIELD pmai002
            {<point name="construct.a.pmai002" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai002
         ON ACTION controlp INFIELD pmai002
            #add-point:ON ACTION controlp INFIELD pmai002
            {<point name="construct.c.pmai002" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaal004
            #add-point:BEFORE FIELD pmaal004
            {<point name="construct.b.pmaal004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaal004
            
            #add-point:AFTER FIELD pmaal004
            {<point name="construct.a.pmaal004" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaal004
         ON ACTION controlp INFIELD pmaal004
            #add-point:ON ACTION controlp INFIELD pmaal004
            {<point name="construct.c.pmaal004" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaastus
            #add-point:BEFORE FIELD pmaastus
            {<point name="construct.b.pmaastus" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaastus
            
            #add-point:AFTER FIELD pmaastus
            {<point name="construct.a.pmaastus" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaastus
         ON ACTION controlp INFIELD pmaastus
            #add-point:ON ACTION controlp INFIELD pmaastus
            {<point name="construct.c.pmaastus" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaa083
            #add-point:BEFORE FIELD pmaa083
            {<point name="construct.b.pmaa083" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaa083
            
            #add-point:AFTER FIELD pmaa083
            {<point name="construct.a.pmaa083" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaa083
         ON ACTION controlp INFIELD pmaa083
            #add-point:ON ACTION controlp INFIELD pmaa083
            {<point name="construct.c.pmaa083" />}
            #END add-point
 
         #Ctrlp:construct.c.pmai003
         ON ACTION controlp INFIELD pmai003
            #add-point:ON ACTION controlp INFIELD pmai003
            {<point name="construct.c.pmai003" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai003
            #add-point:BEFORE FIELD pmai003
            {<point name="construct.b.pmai003" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai003
            
            #add-point:AFTER FIELD pmai003
            {<point name="construct.a.pmai003" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai004
            #add-point:BEFORE FIELD pmai004
            {<point name="construct.b.pmai004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai004
            
            #add-point:AFTER FIELD pmai004
            {<point name="construct.a.pmai004" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai004
         ON ACTION controlp INFIELD pmai004
            #add-point:ON ACTION controlp INFIELD pmai004
            {<point name="construct.c.pmai004" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai005
            #add-point:BEFORE FIELD pmai005
            {<point name="construct.b.pmai005" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai005
            
            #add-point:AFTER FIELD pmai005
            {<point name="construct.a.pmai005" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai005
         ON ACTION controlp INFIELD pmai005
            #add-point:ON ACTION controlp INFIELD pmai005
            {<point name="construct.c.pmai005" />}
            #END add-point
 
         #Ctrlp:construct.c.pmai006
         ON ACTION controlp INFIELD pmai006
            #add-point:ON ACTION controlp INFIELD pmai006
            {<point name="construct.c.pmai006" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai006
            #add-point:BEFORE FIELD pmai006
            {<point name="construct.b.pmai006" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai006
            
            #add-point:AFTER FIELD pmai006
            {<point name="construct.a.pmai006" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai012
         ON ACTION controlp INFIELD pmai012
            #add-point:ON ACTION controlp INFIELD pmai012
            {<point name="construct.c.pmai012" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai012
            #add-point:BEFORE FIELD pmai012
            {<point name="construct.b.pmai012" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai012
            
            #add-point:AFTER FIELD pmai012
            {<point name="construct.a.pmai012" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaistus
            #add-point:BEFORE FIELD pmaistus
            {<point name="construct.b.pmaistus" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaistus
            
            #add-point:AFTER FIELD pmaistus
            {<point name="construct.a.pmaistus" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaistus
         ON ACTION controlp INFIELD pmaistus
            #add-point:ON ACTION controlp INFIELD pmaistus
            {<point name="construct.c.pmaistus" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai007
            #add-point:BEFORE FIELD pmai007
            {<point name="construct.b.pmai007" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai007
            
            #add-point:AFTER FIELD pmai007
            {<point name="construct.a.pmai007" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai007
         ON ACTION controlp INFIELD pmai007
            #add-point:ON ACTION controlp INFIELD pmai007
            {<point name="construct.c.pmai007" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai008
            #add-point:BEFORE FIELD pmai008
            {<point name="construct.b.pmai008" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai008
            
            #add-point:AFTER FIELD pmai008
            {<point name="construct.a.pmai008" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai008
         ON ACTION controlp INFIELD pmai008
            #add-point:ON ACTION controlp INFIELD pmai008
            {<point name="construct.c.pmai008" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai009
            #add-point:BEFORE FIELD pmai009
            {<point name="construct.b.pmai009" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai009
            
            #add-point:AFTER FIELD pmai009
            {<point name="construct.a.pmai009" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai009
         ON ACTION controlp INFIELD pmai009
            #add-point:ON ACTION controlp INFIELD pmai009
            {<point name="construct.c.pmai009" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai010
            #add-point:BEFORE FIELD pmai010
            {<point name="construct.b.pmai010" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai010
            
            #add-point:AFTER FIELD pmai010
            {<point name="construct.a.pmai010" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai010
         ON ACTION controlp INFIELD pmai010
            #add-point:ON ACTION controlp INFIELD pmai010
            {<point name="construct.c.pmai010" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai011
            #add-point:BEFORE FIELD pmai011
            {<point name="construct.b.pmai011" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai011
            
            #add-point:AFTER FIELD pmai011
            {<point name="construct.a.pmai011" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmai011
         ON ACTION controlp INFIELD pmai011
            #add-point:ON ACTION controlp INFIELD pmai011
            {<point name="construct.c.pmai011" />}
            #END add-point
 
         #Ctrlp:construct.c.pmaiownid
         ON ACTION controlp INFIELD pmaiownid
            #add-point:ON ACTION controlp INFIELD pmaiownid
            {<point name="construct.c.pmaiownid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaiownid
            #add-point:BEFORE FIELD pmaiownid
            {<point name="construct.b.pmaiownid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaiownid
            
            #add-point:AFTER FIELD pmaiownid
            {<point name="construct.a.pmaiownid" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaiowndp
         ON ACTION controlp INFIELD pmaiowndp
            #add-point:ON ACTION controlp INFIELD pmaiowndp
            {<point name="construct.c.pmaiowndp" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaiowndp
            #add-point:BEFORE FIELD pmaiowndp
            {<point name="construct.b.pmaiowndp" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaiowndp
            
            #add-point:AFTER FIELD pmaiowndp
            {<point name="construct.a.pmaiowndp" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaicrtid
         ON ACTION controlp INFIELD pmaicrtid
            #add-point:ON ACTION controlp INFIELD pmaicrtid
            {<point name="construct.c.pmaicrtid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaicrtid
            #add-point:BEFORE FIELD pmaicrtid
            {<point name="construct.b.pmaicrtid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaicrtid
            
            #add-point:AFTER FIELD pmaicrtid
            {<point name="construct.a.pmaicrtid" />}
            #END add-point
            
 
         #Ctrlp:construct.c.pmaicrtdp
         ON ACTION controlp INFIELD pmaicrtdp
            #add-point:ON ACTION controlp INFIELD pmaicrtdp
            {<point name="construct.c.pmaicrtdp" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaicrtdp
            #add-point:BEFORE FIELD pmaicrtdp
            {<point name="construct.b.pmaicrtdp" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaicrtdp
            
            #add-point:AFTER FIELD pmaicrtdp
            {<point name="construct.a.pmaicrtdp" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaicrtdt
            #add-point:BEFORE FIELD pmaicrtdt
            {<point name="construct.b.pmaicrtdt" />}
            #END add-point
 
         #Ctrlp:construct.c.pmaimodid
         ON ACTION controlp INFIELD pmaimodid
            #add-point:ON ACTION controlp INFIELD pmaimodid
            {<point name="construct.c.pmaimodid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaimodid
            #add-point:BEFORE FIELD pmaimodid
            {<point name="construct.b.pmaimodid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaimodid
            
            #add-point:AFTER FIELD pmaimodid
            {<point name="construct.a.pmaimodid" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaimoddt
            #add-point:BEFORE FIELD pmaimoddt
            {<point name="construct.b.pmaimoddt" />}
            #END add-point
 
         #Ctrlp:construct.c.pmaicnfid
         ON ACTION controlp INFIELD pmaicnfid
            #add-point:ON ACTION controlp INFIELD pmaicnfid
            {<point name="construct.c.pmaicnfid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaicnfid
            #add-point:BEFORE FIELD pmaicnfid
            {<point name="construct.b.pmaicnfid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaicnfid
            
            #add-point:AFTER FIELD pmaicnfid
            {<point name="construct.a.pmaicnfid" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaicnfdt
            #add-point:BEFORE FIELD pmaicnfdt
            {<point name="construct.b.pmaicnfdt" />}
            #END add-point
 
 
       
      END CONSTRUCT
  
      #add-point:cs段more_construct
      {<point name="cs.more_construct"/>}
      #end add-point
         
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段before dialog
         {<point name="cs.before_dialog"/>}
         #end add-point
      
      ON ACTION qbe_select     #條件查詢
         CALL cl_qbe_list('m') RETURNING ls_wc
      
      ON ACTION qbe_save       #條件儲存
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl"
      CONTINUE DIALOG
 
   END DIALOG
 
   #add-point:cs段after_construct
   {<point name="cs.after_construct"/>}
   #end add-point
   
   IF INT_FLAG THEN
      RETURN
   END IF
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.default_search" ver="4" status="" src="s">
    <![CDATA[#+ 外部參數預設搜尋
PRIVATE FUNCTION apmm826_default_search()
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   #add-point:default_search段define
   {<point name="default_search.define"/>}
   #end add-point
   
   #add-point:default_search段開始前
   {<point name="default_search.before"/>}
   #end add-point  
   
   IF g_searchtype = 0 OR cl_null(g_searchtype) THEN
      LET g_searchtype = 3
   END IF 
   
   IF NOT cl_null(g_argv[01]) THEN
      LET ls_wc = ls_wc, " pmai001 = '", g_argv[01], "' AND "
   END IF
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " pmai002 = '", g_argv[02], "' AND "
   END IF
 
   
   IF NOT cl_null(ls_wc) THEN
      LET ls_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_wc = ls_wc
   ELSE
      IF cl_null(g_wc) THEN
         LET g_wc = " 1=1"
      END IF
   END IF
   
   #CALL apmm826_browser_fill(g_wc,g_searchtype)
 
   #add-point:default_search段結束前
   {<point name="default_search.after"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.delete" ver="5" status="" src="s">
    <![CDATA[#+ 資料刪除
PRIVATE FUNCTION apmm826_delete(l_dialog)
   DEFINE l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE l_vars          DYNAMIC ARRAY OF STRING
   DEFINE l_fields        DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak  DYNAMIC ARRAY OF STRING
   DEFINE l_dialog        ui.DIALOG
   DEFINE li_status       LIKE type_t.num5  #SQL實體資料刪除狀態
   DEFINE li_cnt          LIKE type_t.num5  #查看本階是否有兄弟資料
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point
   
   IF g_pmai_m.pmai001 IS NULL
 
   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF
   
   #add-point:delete段before_delete
   {<point name="delete.before_delete"/>}
   #end add-point
 
   EXECUTE apmm826_master_referesh USING g_pmai_m.pmai001,g_pmai_m.pmai002 INTO g_pmai_m.pmai001,g_pmai_m.pmai002, 
       g_pmai_m.pmai003,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
       g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid, 
       g_pmai_m.pmaiowndp,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid, 
       g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid,g_pmai_m.pmaicnfdt,g_pmai_m.pmai003_desc,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012_desc,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid_desc, 
       g_pmai_m.pmaicrtdp_desc,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaicnfid_desc
    
   CALL apmm826_show()
   
   #Transaction開始
   CALL s_transaction_begin()
   
   
 
   OPEN apmm826_cl USING g_enterprise,g_pmai_m.pmai001,g_pmai_m.pmai002
   IF STATUS THEN
      CALL cl_err("OPEN apmm826_cl:", STATUS, 1)
      CLOSE apmm826_cl
      CALL s_transaction_end("N","0")
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH apmm826_cl INTO g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083, 
       g_pmai_m.pmai003,g_pmai_m.pmai003_desc,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012,g_pmai_m.pmai012_desc,g_pmai_m.pmaistus,g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009, 
       g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp, 
       g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtid_desc,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdp_desc, 
       g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid, 
       g_pmai_m.pmaicnfid_desc,g_pmai_m.pmaicnfdt
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_pmai_m.pmai005,SQLCA.sqlcode,0)
      CALL s_transaction_end("N","0")
      RETURN
   END IF
 
   #先判斷是否有子節點(hasC) 詢問是否砍除全部
   IF g_browser[g_current_idx].b_hasC THEN
      IF cl_ask_delete_all_node() THEN
         LET li_status = apmm826_sql_delete(TRUE)
      ELSE
         LET li_status = FALSE
      END IF
   ELSE
      #如果沒有子節點,詢問是否刪除本筆資料
      IF cl_ask_delete() THEN
         LET li_status = apmm826_sql_delete(FALSE)
      ELSE
         LET li_status = FALSE
      END IF
   END IF
 
   #檢查實體砍除是否發生意外中止
   IF NOT li_status THEN
      CALL s_transaction_end("N","0")
      CLOSE apmm826_cl
      RETURN
   END IF
 
   #刪除節點與資料內容
   CALL l_dialog.deleteNode("s_browse",g_current_idx)  #deleteNode會順便幫忙做deleteElement
 
   #確認這一階還有沒有兄弟 (有:不異動上階屬性/否:上階hasC及exp設定成0)
   SELECT COUNT(*) INTO li_cnt
     FROM gzwe_t
    WHERE gzwe001 = g_gzwe_m.gzwe001
   IF li_cnt = 0 THEN
      LET g_browser[g_current_idx - 1].b_hasC = 0
      LET g_browser[g_current_idx - 1].b_exp = 0
   END IF
 
   #取得CurrentRow後,將CurrentRow放入右側MainLayout
   CALL apmm826_desc_show(g_current_idx -1)
 
   #add-point:單頭刪除後
   {<point name="delete.head.a_delete"/>}
   #end add-point
 
   CLOSE apmm826_cl
   CALL s_transaction_end("Y","0")
 
   #流程通知預埋點-D
   CALL cl_flow_notify(g_pmai_m.pmai005,"D")
    
END FUNCTION
]]>
  </section>
  <section id="apmm826.desc_show" ver="3" status="" src="s">
    <![CDATA[#+ 組合顯示在畫面上的資訊
PRIVATE FUNCTION apmm826_desc_show(pi_ac)
   DEFINE pi_ac   LIKE type_t.num5
   DEFINE li_tmp  LIKE type_t.num5   
   #add-point:desc_show段define
   {<point name="desc_show.define"/>}
   #end add-point
 
   LET li_tmp = l_ac
   LET l_ac = pi_ac
   
   
   #add-point:browser_create段desc處理
   {<point name="desc_show.show"/>} 
   #end add-point
 
   LET l_ac = li_tmp
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.description" ver="11" status="" src="s">
    <![CDATA[#+ Version..: T100-ERP-1.00.00(SD版次:2,PR版次:2) Build-000177
#+ 
#+ Filename...: apmm826
#+ Description: 供應商不良記錄維護作業
#+ Creator....: 01996(2013/09/18)
#+ Modifier...: 01996(2014/06/28)
#+ Buildtype..: 應用 i05 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
  </section>
  <section id="apmm826.fetch" ver="5" status="" src="s">
    <![CDATA[#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION apmm826_fetch(p_flag)
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   DEFINE ls_chk     STRING
   DEFINE li_idx     LIKE type_t.num5
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point
   
   #add-point:fetch前
   {<point name="fetch.befroe_fetch"/>}
   #end add-point 
 
 
   #瀏覽頁筆數顯示
   LET li_idx = 1
   FOR li_idx = 1 TO g_browser_root.getLength()
      IF g_browser_root[li_idx] > g_current_idx THEN
       EXIT FOR
      END IF
   END FOR
   LET li_idx = g_current_idx - li_idx + 1
   #DISPLAY li_idx TO FORMONLY.h_index   #當下筆數
 
   IF p_flag = "/" THEN
      IF (NOT g_no_ask) THEN      
         CALL cl_getmsg("fetch",g_lang) RETURNING ls_msg
         LET INT_FLAG = 0
 
         PROMPT ls_msg CLIPPED,": " FOR g_jump
            #交談指令共用ACTION
            &include "common_action.4gl" 
         END PROMPT
 
         IF INT_FLAG THEN
            LET INT_FLAG = 0
         ELSE
            IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
               LET g_current_idx = g_jump
            END IF
            LET g_no_ask = FALSE  
         END IF           
      END IF
   END IF    
   
   #若無資料則離開
   IF g_current_idx = 0 THEN
      RETURN
   END IF
 
   LET g_pmai_m.pmai005 = g_browser[g_current_idx].b_pmai005
   LET g_pmai_m.pmai001 = g_browser[g_current_idx].b_pmai001
    
   #add-point:fetch段refresh前
   {<point name="fetch.before_refresh"/>}
   #end add-point
    
   #重讀DB,因TEMP有不被更新特性
   EXECUTE apmm826_master_referesh USING g_pmai_m.pmai001,g_pmai_m.pmai002 INTO g_pmai_m.pmai001,g_pmai_m.pmai002, 
       g_pmai_m.pmai003,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
       g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid, 
       g_pmai_m.pmaiowndp,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid, 
       g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid,g_pmai_m.pmaicnfdt,g_pmai_m.pmai003_desc,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012_desc,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid_desc, 
       g_pmai_m.pmaicrtdp_desc,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaicnfid_desc 
   
   IF SQLCA.sqlcode THEN
       CALL cl_err("pmai_t",SQLCA.sqlcode,1)
       INITIALIZE g_pmai_m.* TO NULL
       RETURN
   END IF
   
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", TRUE)
   END IF
   
   #add-point:fetch段after_fetch
   {<point name="fetch.after_fetch"/>}
   #end add-point
 
   
   #重新顯示
   CALL apmm826_show()
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   DISPLAY g_browser.getLength() TO FORMONLY.h_count 
 
   
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.find_node" ver="2" status="" src="s">
    <![CDATA[#+ 尋找符合條件的節點
PRIVATE FUNCTION apmm826_find_node(pi_ac)
   DEFINE pi_ac   LIKE type_t.num5
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_tmp  LIKE type_t.num5
   DEFINE ls_pid  STRING
   #add-point:find_node段define
   {<point name="find_node.define"/>}
   #end add-point
   
   LET ls_pid = g_browser[pi_ac].b_pid
   
   LET g_sql = " SELECT UNIQUE '','','','FALSE','','',exp_code,pmai001,'','','',pmai002,pmai005,pmai003, 
       pmai004,pmai006,'',pmai007,pmai009,pmai010,pmaistus ",
               " FROM apmm826_tmp ",
               " WHERE pmai001 = ? AND pmai001 <> pmai005",
               " ORDER BY pmai005"
   PREPARE master_getNode FROM g_sql
   DECLARE master_getNodecur CURSOR FOR master_getNode
   
   LET li_idx = pi_ac
   WHILE li_idx <= g_browser.getLength()
      IF g_browser[li_idx].b_expcode = -1 THEN
         OPEN master_getNodecur USING g_browser[li_idx].b_pmai005
         FOREACH master_getNodecur INTO g_browser[g_browser.getLength()+1].*
            CALL apmm826_desc_show(g_browser.getLength())
            LET g_browser[g_browser.getLength()].b_pid = ls_pid
            LET g_browser[g_browser.getLength()].b_id = g_browser.getLength()
            LET g_browser[g_browser.getLength()].b_hasC = apmm826_chk_hasC(g_browser.getLength())
         END FOREACH
         CALL g_browser.deleteElement(li_idx)
         CALL g_browser.deleteElement(g_browser.getLength())
      ELSE
         LET li_idx = li_idx + 1
      END IF
   
   END WHILE
   
   FREE master_getNode
   
   RETURN g_browser.getLength()
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.global" ver="5" status="" src="s">
    <![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds 
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_pmai_m RECORD
   pmai001 LIKE pmai_t.pmai001, 
   pmai002 LIKE pmai_t.pmai002, 
   pmaal004 LIKE pmaal_t.pmaal004, 
   pmaastus LIKE pmaa_t.pmaastus, 
   pmaa083 LIKE pmaa_t.pmaa083, 
   pmai003 LIKE pmai_t.pmai003, 
   pmai003_desc LIKE type_t.chr80, 
   pmai004 LIKE pmai_t.pmai004, 
   pmai005 LIKE pmai_t.pmai005, 
   pmai006 LIKE pmai_t.pmai006, 
   pmai006_desc LIKE type_t.chr80, 
   pmai012 LIKE pmai_t.pmai012, 
   pmai012_desc LIKE type_t.chr80, 
   pmaistus LIKE pmai_t.pmaistus, 
   pmai007 LIKE pmai_t.pmai007, 
   pmai008 LIKE pmai_t.pmai008, 
   pmai009 LIKE pmai_t.pmai009, 
   pmai010 LIKE pmai_t.pmai010, 
   pmai011 LIKE pmai_t.pmai011, 
   pmaiownid LIKE pmai_t.pmaiownid, 
   pmaiownid_desc LIKE type_t.chr80, 
   pmaiowndp LIKE pmai_t.pmaiowndp, 
   pmaiowndp_desc LIKE type_t.chr80, 
   pmaicrtid LIKE pmai_t.pmaicrtid, 
   pmaicrtid_desc LIKE type_t.chr80, 
   pmaicrtdp LIKE pmai_t.pmaicrtdp, 
   pmaicrtdp_desc LIKE type_t.chr80, 
   pmaicrtdt DATETIME YEAR TO SECOND, 
   pmaimodid LIKE pmai_t.pmaimodid, 
   pmaimodid_desc LIKE type_t.chr80, 
   pmaimoddt DATETIME YEAR TO SECOND, 
   pmaicnfid LIKE pmai_t.pmaicnfid, 
   pmaicnfid_desc LIKE type_t.chr80, 
   pmaicnfdt DATETIME YEAR TO SECOND
                                  END RECORD
 
#模組變數(Module Variables)
DEFINE g_pmai_m          type_g_pmai_m
DEFINE g_pmai_m_t        type_g_pmai_m
 
   DEFINE g_pmai001_t LIKE pmai_t.pmai001
DEFINE g_pmai002_t LIKE pmai_t.pmai002
 
 
DEFINE g_pmai005_t        LIKE pmai_t.pmai005
#DEFINE g_pmai001_t        LIKE pmai_t.pmai001
 
DEFINE g_browser    DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位
       b_show          LIKE type_t.chr100,    #外顯欄位
       b_pid           LIKE type_t.chr100,    #父節點id
       b_id            LIKE type_t.chr100,    #本身節點id
       b_exp           LIKE type_t.chr100,    #是否展開
       b_hasC          LIKE type_t.num5,      #是否有子節點
       b_isExp         LIKE type_t.num5,      #是否已展開
       b_expcode       LIKE type_t.num5,      #展開值
       #tree自定義欄位
          b_pmai001 LIKE pmai_t.pmai001,
   b_pmai001_desc LIKE type_t.chr80,
   b_pmaastus LIKE type_t.chr80,
   b_pmaa083 LIKE type_t.chr80,
      b_pmai002 LIKE pmai_t.pmai002,
      b_pmai005 LIKE pmai_t.pmai005,
      b_pmai003 LIKE pmai_t.pmai003,
      b_pmai004 LIKE pmai_t.pmai004,
      b_pmai006 LIKE pmai_t.pmai006,
   b_pmai006_desc LIKE type_t.chr80,
      b_pmai007 LIKE pmai_t.pmai007,
      b_pmai009 LIKE pmai_t.pmai009,
      b_pmai010 LIKE pmai_t.pmai010,
      b_pmaistus LIKE pmai_t.pmaistus
                   END RECORD
 
DEFINE g_browser_root  DYNAMIC ARRAY OF INTEGER    #root資料所在
       
#多table用變數
 
DEFINE g_wc                  STRING
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10
DEFINE g_jump                LIKE type_t.num10
DEFINE g_no_ask              LIKE type_t.num5
DEFINE g_rec_b               LIKE type_t.num5
DEFINE l_ac                  LIKE type_t.num5
DEFINE g_curr_diag           ui.Dialog                #Current Dialog
 
DEFINE g_pagestart           LIKE type_t.num5         
DEFINE gwin_curr             ui.Window                #Current Window
DEFINE gfrm_curr             ui.Form                  #Current Form
DEFINE g_page_action         STRING                   #page action
DEFINE g_header_hidden       LIKE type_t.num5         #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5         #隱藏工作Panel
DEFINE g_browser_cnt         LIKE type_t.num5         #total count
DEFINE g_page                STRING                   #第幾頁
DEFINE g_current_row         LIKE type_t.num5         #Browser所在筆數
DEFINE g_current_sw          LIKE type_t.num5         #Browser所在筆數用開關
 
DEFINE g_searchcol           LIKE type_t.chr200
DEFINE g_searchstr           LIKE type_t.chr200
DEFINE g_searchtype          LIKE type_t.chr200
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_row_index           LIKE type_t.num5
DEFINE g_root_search         BOOLEAN
DEFINE g_first               LIKE type_t.num5  #標示是否要啟動s_browse重查
DEFINE g_aw                  STRING            #確定當下點擊的單身
DEFINE g_log1                STRING            #log用
DEFINE g_log2                STRING            #log用
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明(global.argv)
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="apmm826.init" ver="1" status="" src="s">
    <![CDATA[#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION apmm826_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point 
   
      CALL cl_set_combo_scc_part('pmaastus','50','N,X,Y')
   CALL cl_set_combo_scc_part('pmaistus','50','N,X,Y')
 
   
   
   #add-point:畫面資料初始化
   {<point name="init.init"/>}
   #end add-point
   
   CALL apmm826_default_search()
    
END FUNCTION
]]>
  </section>
  <section id="apmm826.input" ver="6" status="" src="s">
    <![CDATA[#+ 資料輸入
PRIVATE FUNCTION apmm826_input(p_cmd)
   DEFINE p_cmd           LIKE type_t.chr1
   DEFINE l_cmd_t         LIKE type_t.chr1
   DEFINE l_ac_t          LIKE type_t.num5        #未取消的ARRAY CNT 
   DEFINE l_n             LIKE type_t.num5        #檢查重複用
   DEFINE l_cnt           LIKE type_t.num5        #檢查重複用
   DEFINE l_lock_sw       LIKE type_t.chr1        #單身鎖住否
   DEFINE l_allow_insert  LIKE type_t.num5        #可新增否 
   DEFINE l_allow_delete  LIKE type_t.num5        #可刪除否
   DEFINE l_count         LIKE type_t.num5
   DEFINE l_i             LIKE type_t.num5
   DEFINE l_insert        LIKE type_t.num5
   DEFINE ls_return       STRING
   DEFINE l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak  DYNAMIC ARRAY OF STRING
   DEFINE l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE l_vars          DYNAMIC ARRAY OF STRING
   DEFINE l_fields        DYNAMIC ARRAY OF STRING
   #add-point:input段define
   {<point name="input.define"/>}
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
 
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r' 
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF  
   
   CALL cl_set_head_visible("","YES")
 
   LET l_insert = FALSE
   LET g_action_choice = ""
   LET g_qryparam.state = "i"
   
   #控制key欄位可否輸入
   CALL apmm826_set_entry(p_cmd)
   #add-point:set_entry後
   {<point name="input.after_set_entry"/>}
   #end add-point
   CALL apmm826_set_no_entry(p_cmd)
   #add-point:set_no_entry後
   {<point name="input.after_set_no_entry"/>}
   #end add-point
 
   DISPLAY BY NAME g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083, 
       g_pmai_m.pmai003,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
       g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      #單頭段
      INPUT BY NAME g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083, 
          g_pmai_m.pmai003,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
          g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂單頭ACTION
         
         
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            #其他table資料備份(確定是否更改用)
            
            
            #add-point:input段define
            {<point name="input.action"/>}
            #end add-point
          
                  #此段落由子樣板a01產生
         BEFORE FIELD pmai001
            #add-point:BEFORE FIELD pmai001
            {<point name="input.b.pmai001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai001
            
            #add-point:AFTER FIELD pmai001
            {<point name="input.a.pmai001" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai001
            #add-point:ON CHANGE pmai001
            {<point name="input.g.pmai001" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai002
            #add-point:BEFORE FIELD pmai002
            {<point name="input.b.pmai002" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai002
            
            #add-point:AFTER FIELD pmai002
            {<point name="input.a.pmai002" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai002
            #add-point:ON CHANGE pmai002
            {<point name="input.g.pmai002" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaal004
            #add-point:BEFORE FIELD pmaal004
            {<point name="input.b.pmaal004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaal004
            
            #add-point:AFTER FIELD pmaal004
            {<point name="input.a.pmaal004" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmaal004
            #add-point:ON CHANGE pmaal004
            {<point name="input.g.pmaal004" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaastus
            #add-point:BEFORE FIELD pmaastus
            {<point name="input.b.pmaastus" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaastus
            
            #add-point:AFTER FIELD pmaastus
            {<point name="input.a.pmaastus" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmaastus
            #add-point:ON CHANGE pmaastus
            {<point name="input.g.pmaastus" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaa083
            #add-point:BEFORE FIELD pmaa083
            {<point name="input.b.pmaa083" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaa083
            
            #add-point:AFTER FIELD pmaa083
            {<point name="input.a.pmaa083" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmaa083
            #add-point:ON CHANGE pmaa083
            {<point name="input.g.pmaa083" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai003
            
            #add-point:AFTER FIELD pmai003
            {<point name="input.a.pmai003" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai003
            #add-point:BEFORE FIELD pmai003
            {<point name="input.b.pmai003" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE pmai003
            #add-point:ON CHANGE pmai003
            {<point name="input.g.pmai003" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai004
            #add-point:BEFORE FIELD pmai004
            {<point name="input.b.pmai004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai004
            
            #add-point:AFTER FIELD pmai004
            {<point name="input.a.pmai004" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai004
            #add-point:ON CHANGE pmai004
            {<point name="input.g.pmai004" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai005
            #add-point:BEFORE FIELD pmai005
            {<point name="input.b.pmai005" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai005
            
            #add-point:AFTER FIELD pmai005
            {<point name="input.a.pmai005" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai005
            #add-point:ON CHANGE pmai005
            {<point name="input.g.pmai005" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai006
            
            #add-point:AFTER FIELD pmai006
            {<point name="input.a.pmai006" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai006
            #add-point:BEFORE FIELD pmai006
            {<point name="input.b.pmai006" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE pmai006
            #add-point:ON CHANGE pmai006
            {<point name="input.g.pmai006" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai012
            
            #add-point:AFTER FIELD pmai012
            {<point name="input.a.pmai012" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai012
            #add-point:BEFORE FIELD pmai012
            {<point name="input.b.pmai012" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE pmai012
            #add-point:ON CHANGE pmai012
            {<point name="input.g.pmai012" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmaistus
            #add-point:BEFORE FIELD pmaistus
            {<point name="input.b.pmaistus" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmaistus
            
            #add-point:AFTER FIELD pmaistus
            {<point name="input.a.pmaistus" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmaistus
            #add-point:ON CHANGE pmaistus
            {<point name="input.g.pmaistus" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai007
            #add-point:BEFORE FIELD pmai007
            {<point name="input.b.pmai007" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai007
            
            #add-point:AFTER FIELD pmai007
            {<point name="input.a.pmai007" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai007
            #add-point:ON CHANGE pmai007
            {<point name="input.g.pmai007" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai008
            #add-point:BEFORE FIELD pmai008
            {<point name="input.b.pmai008" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai008
            
            #add-point:AFTER FIELD pmai008
            {<point name="input.a.pmai008" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai008
            #add-point:ON CHANGE pmai008
            {<point name="input.g.pmai008" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai009
            #add-point:BEFORE FIELD pmai009
            {<point name="input.b.pmai009" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai009
            
            #add-point:AFTER FIELD pmai009
            {<point name="input.a.pmai009" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai009
            #add-point:ON CHANGE pmai009
            {<point name="input.g.pmai009" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai010
            #add-point:BEFORE FIELD pmai010
            {<point name="input.b.pmai010" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai010
            
            #add-point:AFTER FIELD pmai010
            {<point name="input.a.pmai010" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai010
            #add-point:ON CHANGE pmai010
            {<point name="input.g.pmai010" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmai011
            #add-point:BEFORE FIELD pmai011
            {<point name="input.b.pmai011" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmai011
            
            #add-point:AFTER FIELD pmai011
            {<point name="input.a.pmai011" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmai011
            #add-point:ON CHANGE pmai011
            {<point name="input.g.pmai011" />}
            #END add-point
 
 #欄位檢查
                  #Ctrlp:input.c.pmai001
         ON ACTION controlp INFIELD pmai001
            #add-point:ON ACTION controlp INFIELD pmai001
            {<point name="input.c.pmai001" />}
            #END add-point
 
         #Ctrlp:input.c.pmai002
         ON ACTION controlp INFIELD pmai002
            #add-point:ON ACTION controlp INFIELD pmai002
            {<point name="input.c.pmai002" />}
            #END add-point
 
         #Ctrlp:input.c.pmaal004
         ON ACTION controlp INFIELD pmaal004
            #add-point:ON ACTION controlp INFIELD pmaal004
            {<point name="input.c.pmaal004" />}
            #END add-point
 
         #Ctrlp:input.c.pmaastus
         ON ACTION controlp INFIELD pmaastus
            #add-point:ON ACTION controlp INFIELD pmaastus
            {<point name="input.c.pmaastus" />}
            #END add-point
 
         #Ctrlp:input.c.pmaa083
         ON ACTION controlp INFIELD pmaa083
            #add-point:ON ACTION controlp INFIELD pmaa083
            {<point name="input.c.pmaa083" />}
            #END add-point
 
         #Ctrlp:input.c.pmai003
         ON ACTION controlp INFIELD pmai003
            #add-point:ON ACTION controlp INFIELD pmai003
            {<point name="input.c.pmai003" />}
            #END add-point
 
         #Ctrlp:input.c.pmai004
         ON ACTION controlp INFIELD pmai004
            #add-point:ON ACTION controlp INFIELD pmai004
            {<point name="input.c.pmai004" />}
            #END add-point
 
         #Ctrlp:input.c.pmai005
         ON ACTION controlp INFIELD pmai005
            #add-point:ON ACTION controlp INFIELD pmai005
            {<point name="input.c.pmai005" />}
            #END add-point
 
         #Ctrlp:input.c.pmai006
         ON ACTION controlp INFIELD pmai006
            #add-point:ON ACTION controlp INFIELD pmai006
            {<point name="input.c.pmai006" />}
            #END add-point
 
         #Ctrlp:input.c.pmai012
         ON ACTION controlp INFIELD pmai012
            #add-point:ON ACTION controlp INFIELD pmai012
            {<point name="input.c.pmai012" />}
            #END add-point
 
         #Ctrlp:input.c.pmaistus
         ON ACTION controlp INFIELD pmaistus
            #add-point:ON ACTION controlp INFIELD pmaistus
            {<point name="input.c.pmaistus" />}
            #END add-point
 
         #Ctrlp:input.c.pmai007
         ON ACTION controlp INFIELD pmai007
            #add-point:ON ACTION controlp INFIELD pmai007
            {<point name="input.c.pmai007" />}
            #END add-point
 
         #Ctrlp:input.c.pmai008
         ON ACTION controlp INFIELD pmai008
            #add-point:ON ACTION controlp INFIELD pmai008
            {<point name="input.c.pmai008" />}
            #END add-point
 
         #Ctrlp:input.c.pmai009
         ON ACTION controlp INFIELD pmai009
            #add-point:ON ACTION controlp INFIELD pmai009
            {<point name="input.c.pmai009" />}
            #END add-point
 
         #Ctrlp:input.c.pmai010
         ON ACTION controlp INFIELD pmai010
            #add-point:ON ACTION controlp INFIELD pmai010
            {<point name="input.c.pmai010" />}
            #END add-point
 
         #Ctrlp:input.c.pmai011
         ON ACTION controlp INFIELD pmai011
            #add-point:ON ACTION controlp INFIELD pmai011
            {<point name="input.c.pmai011" />}
            #END add-point
 
 #欄位開窗
 
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
 
           #避免資料錯誤的檢查
           IF apmm826_check(g_pmai_m.pmai005,g_pmai_m.pmai001
              ) THEN
              CALL cl_err("","tree-001",1)
              NEXT FIELD CURRENT
           END IF
 
            CALL cl_showmsg()   #錯誤訊息統整顯示
            DISPLAY BY NAME g_pmai_m.pmai005
 
            #實體新增/修改/複製段落的處理
            CASE
               WHEN p_cmd = "a" OR p_cmd = "r"
                  LET l_count = 1
 
                  SELECT COUNT(*) INTO l_count FROM pmai_t
                   WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
                     AND pmai002 = g_pmai_m.pmai002
 
                         #
                  IF l_count = 0 THEN
                     #add-point:單頭新增前
                     {<point name="input.head.b_insert" mark="Y"/>}
                     #end add-point
 
                     INSERT INTO pmai_t (pmaient,pmai001,pmai002,pmai003,pmai004,pmai005,pmai006,pmai012, 
                         pmaistus,pmai007,pmai008,pmai009,pmai010,pmai011,pmaiownid,pmaiowndp,pmaicrtid, 
                         pmaicrtdp,pmaicrtdt,pmaicnfid,pmaicnfdt)
                     VALUES (g_enterprise,g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmai003,g_pmai_m.pmai004, 
                         g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus,g_pmai_m.pmai007, 
                         g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid, 
                         g_pmai_m.pmaiowndp,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdt, 
                         g_pmai_m.pmaicnfid,g_pmai_m.pmaicnfdt) 
 
                     #add-point:單頭新增中
                     {<point name="input.head.m_insert"/>}
                     #end add-point
 
                     IF SQLCA.sqlcode THEN
                        CALL cl_err("g_pmai_m",SQLCA.sqlcode,1)  
                        CONTINUE DIALOG
                     END IF
                  
                     #提速檔資料建置
                     IF g_pmai_m.pmai005 <> g_pmai_m.pmai001 THEN
                        #CALL n_pmais_generate_child(g_pmai_m.pmai005,g_pmai_m.pmai001)
                     END IF
                     
                     #add-point:單頭新增後
                     {<point name="input.head.a_insert"/>}
                     #end add-point
                     
                     #資料多語言用-增/改
                     
                     CALL s_transaction_end("Y","0")
                  ELSE
                     CALL cl_err( g_pmai_m.pmai005, "std-00006", 0 )
                     CALL s_transaction_end("N","0")
                  END IF 
 
               #修改段落
               WHEN p_cmd = "u"  
                  #add-point:單頭修改前
                  {<point name="input.head.b_update" mark="Y"/>}
                  #end add-point
                  UPDATE pmai_t SET (pmai001,pmai002,pmai003,pmai004,pmai005,pmai006,pmai012,pmaistus, 
                      pmai007,pmai008,pmai009,pmai010,pmai011,pmaiownid,pmaiowndp,pmaicrtid,pmaicrtdp, 
                      pmaicrtdt,pmaicnfid,pmaicnfdt) = (g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmai003, 
                      g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
                      g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011, 
                      g_pmai_m.pmaiownid,g_pmai_m.pmaiowndp,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdt, 
                      g_pmai_m.pmaicnfid,g_pmai_m.pmaicnfdt)
                   WHERE pmaient = g_enterprise AND pmai001 = g_pmai001_t #
                     AND pmai002 = g_pmai002_t
 
                  #add-point:單頭修改中
                  {<point name="input.head.m_update"/>}
                  #end add-point
                  CASE
                     WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                        CALL cl_err("pmai_t","std-00009",1)
                        CALL s_transaction_end('N','0')
                     WHEN SQLCA.sqlcode #其他錯誤
                        CALL cl_err("pmai_t",SQLCA.sqlcode,1)  
                        CALL s_transaction_end('N','0')
                     OTHERWISE
                        #add-point:單頭修改後
                        {<point name="input.head.a_update"/>}
                        #end add-point
    
                        #資料多語言用-增/改
                        
                        LET g_log1 = util.JSON.stringify(g_pmai_m_t)
                        LET g_log2 = util.JSON.stringify(g_pmai_m)
                        IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                           CALL s_transaction_end('N','0')
                        ELSE
                           CALL s_transaction_end('Y','0')
                        END IF
                  END CASE
 
               OTHERWISE 
            END CASE
 
           #controlp
      END INPUT
          
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name, g_fld_name, g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden
         END IF
 
      ON ACTION accept
         ACCEPT DIALOG
        
      #在dialog button (放棄)
      ON ACTION cancel
         LET g_action_choice=""
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #在dialog 右上角 (X)
      ON ACTION close       
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #toolbar 離開
      ON ACTION exit
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
           
   END DIALOG
   
   #add-point:input段after input 
   {<point name="input.after_input"/>}
   #end add-point
    
END FUNCTION
]]>
  </section>
  <section id="apmm826.insert" ver="5" status="" src="s">
    <![CDATA[#+ 資料新增
PRIVATE FUNCTION apmm826_insert(l_dialog)
   DEFINE l_dialog   ui.DIALOG
   DEFINE li_addpos  LIKE type_t.num5 #新增節點時產出的畫面實際位置
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point
   
   LET g_pmai001_t = g_pmai_m.pmai001
   LET g_pmai002_t = g_pmai_m.pmai002
 
   LET g_pmai005_t = g_pmai_m.pmai005
 
   #清畫面欄位內容
   CLEAR g_pmai_m.*
 
   #add-point:單頭預設值
   {<point name="insert.before_insert"/>}
   #end add-point 
 
   INITIALIZE g_pmai_m.* LIKE pmai_t.*
   DISPLAY BY NAME g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083, 
       g_pmai_m.pmai003,g_pmai_m.pmai003_desc,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012,g_pmai_m.pmai012_desc,g_pmai_m.pmaistus,g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009, 
       g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp, 
       g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtid_desc,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdp_desc, 
       g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid, 
       g_pmai_m.pmaicnfid_desc,g_pmai_m.pmaicnfdt
   CALL s_transaction_begin()
 
   WHILE TRUE
      #給予pid,type預設值
      LET g_pmai_m.pmai001 = g_pmai005_t
      #此段落由子樣板a14產生    
      LET g_pmai_m.pmaiownid = g_user
      LET g_pmai_m.pmaiowndp = g_dept
      LET g_pmai_m.pmaicrtid = g_user
      LET g_pmai_m.pmaicrtdp = g_dept 
      LET g_pmai_m.pmaicrtdt = cl_get_current()
      LET g_pmai_m.pmaimodid = ""
      LET g_pmai_m.pmaimoddt = ""
      LET g_pmai_m.pmaistus = "N"
 
 
      
      CALL gfrm_curr.setElementImage("statechange", "authstatus/valid.png")
  
      
      
      #單頭預設值
            LET g_pmai_m.pmaistus = "N"
 
     
      #add-point:單頭預設值
      {<point name="insert.default"/>}
      #end add-point 
 
      CALL apmm826_input("a")
      
      #add-point:單頭輸入後
      {<point name="insert.after_insert"/>}
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_pmai_m.* = g_pmai_m_t.*
         CALL apmm826_show()
         CALL cl_err("",9001,0)
         EXIT WHILE
      ELSE
         #檢查是否還有子節點,若有則做插入節點
         IF g_browser[g_current_idx].b_hasC THEN
            IF g_browser[g_current_idx].b_exp THEN
               LET li_addpos = l_dialog.appendNode("s_browse",g_current_idx)
               LET g_browser[li_addpos].b_pmai001 = g_pmai_m.pmai001
               LET g_browser[li_addpos].b_pmai005 = g_pmai_m.pmai005
               CALL apmm826_desc_show(li_addpos)
            END IF
         ELSE
            IF g_browser[g_current_idx].b_exp THEN
               #此處要改成已展開
               LET g_browser[g_current_idx].b_hasC = 1
               LET g_browser[g_current_idx].b_exp = 1
               LET li_addpos = l_dialog.appendNode("s_browse",g_current_idx)
               LET g_browser[li_addpos].b_pmai001 = g_pmai_m.pmai001
               LET g_browser[li_addpos].b_pmai005 = g_pmai_m.pmai005
               CALL apmm826_desc_show(li_addpos)
            END IF
         END IF
      END IF
      
      LET g_rec_b = 0
      EXIT WHILE
   END WHILE
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.main" ver="6" status="" src="s">
    <![CDATA[#+ 此段落由子樣板a26產生
#OPTIONS SHORT CIRCUIT
#+ 作業開始 
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point   
 
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("apm","")
 
   #add-point:作業初始化
   {<point name="main.init" />}
   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = " SELECT pmai001,pmai002,'','','',pmai003,'',pmai004,pmai005,pmai006,'',pmai012, 
       '',pmaistus,pmai007,pmai008,pmai009,pmai010,pmai011,pmaiownid,'',pmaiowndp,'',pmaicrtid,'',pmaicrtdp, 
       '',pmaicrtdt,pmaimodid,'',pmaimoddt,pmaicnfid,'',pmaicnfdt", 
                      " FROM pmai_t",
                      " WHERE pmaient= ? AND pmai001=? AND pmai002=? FOR UPDATE"
   #add-point:SQL_define
   {<point name="main.after_define_sql"/>}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmm826_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT UNIQUE pmai001,pmai002,pmai003,pmai004,pmai005,pmai006,pmai012,pmaistus,pmai007, 
       pmai008,pmai009,pmai010,pmai011,pmaiownid,pmaiowndp,pmaicrtid,pmaicrtdp,pmaicrtdt,pmaimodid,pmaimoddt, 
       pmaicnfid,pmaicnfdt,t1.ooefl004 ,t2.oocql004 ,t3.ooefl004 ,t4.oofa011 ,t5.ooefl003 ,t6.oofa011 , 
       t7.ooefl003 ,t8.oofa011 ,t9.oofa011",
               " FROM pmai_t",
                              " LEFT JOIN ooefl_t t1 ON t1.ooeflent='"||g_enterprise||"' AND t1.ooefl001=pmai003 AND t1.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t2 ON t2.oocqlent='"||g_enterprise||"' AND t2.oocql001='2048' AND t2.oocql002=pmai006 AND t2.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t3 ON t3.ooeflent='"||g_enterprise||"' AND t3.ooefl001=pmai012 AND t3.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN oofa_t t4 ON t4.oofaent='"||g_enterprise||"' AND t4.oofa002='2' AND t4.oofa003=pmaiownid  ",
               " LEFT JOIN ooefl_t t5 ON t5.ooeflent='"||g_enterprise||"' AND t5.ooefl001=pmaiowndp AND t5.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN oofa_t t6 ON t6.oofaent='"||g_enterprise||"' AND t6.oofa002='2' AND t6.oofa003=pmaicrtid  ",
               " LEFT JOIN ooefl_t t7 ON t7.ooeflent='"||g_enterprise||"' AND t7.ooefl001=pmaicrtdp AND t7.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN oofa_t t8 ON t8.oofaent='"||g_enterprise||"' AND t8.oofa002='2' AND t8.oofa003=pmaimodid  ",
               " LEFT JOIN oofa_t t9 ON t9.oofaent='"||g_enterprise||"' AND t9.oofa002='2' AND t9.oofa003=pmaicnfid  ",
 
               " WHERE pmaient = '" ||g_enterprise|| "' AND pmai001 = ? AND pmai002 = ?"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define
   {<point name="main.after_refresh_sql"/>}
   #end add-point
   PREPARE apmm826_master_referesh FROM g_sql
 
 
 
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apmm826 WITH FORM cl_ap_formpath("apm",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apmm826_init()   
 
      #進入選單 Menu (="N")
      CALL apmm826_ui_dialog() 
      
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_apmm826
      
   END IF 
   
   CLOSE apmm826_cl
   
   
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
   
END MAIN
 
 
]]>
  </section>
  <section id="apmm826.match_node" ver="4" status="" src="s">
    <![CDATA[PRIVATE FUNCTION apmm826_match_node(p_wc,p_type)
   DEFINE p_wc         LIKE type_t.chr200
   DEFINE p_type       LIKE type_t.chr10
   DEFINE ls_code      LIKE type_t.chr50
   DEFINE ls_code2     LIKE type_t.chr50
   DEFINE l_bstmp      RECORD    #body欄位
             pmai001 VARCHAR(500),
   pmai001_desc VARCHAR(500),
   pmaastus VARCHAR(500),
   pmaa083 VARCHAR(500),
   pmai002 VARCHAR(500),
   pmai005 VARCHAR(500),
   pmai003 VARCHAR(500),
   pmai004 VARCHAR(500),
   pmai006 VARCHAR(500),
   pmai006_desc VARCHAR(500),
   pmai007 VARCHAR(500),
   pmai009 VARCHAR(500),
   pmai010 VARCHAR(500),
   pmaistus VARCHAR(500)
          #僅含單身table的欄位
   END RECORD 
   DEFINE l_child_list DYNAMIC ARRAY OF RECORD    #body欄位
             pmai001 VARCHAR(500),
   pmai001_desc VARCHAR(500),
   pmaastus VARCHAR(500),
   pmaa083 VARCHAR(500),
   pmai002 VARCHAR(500),
   pmai005 VARCHAR(500),
   pmai003 VARCHAR(500),
   pmai004 VARCHAR(500),
   pmai006 VARCHAR(500),
   pmai006_desc VARCHAR(500),
   pmai007 VARCHAR(500),
   pmai009 VARCHAR(500),
   pmai010 VARCHAR(500),
   pmaistus VARCHAR(500)
          #僅含單身table的欄位
   END RECORD    
   #add-point:match_node段define
   {<point name="match_node.define"/>}
   #end add-point
 
   #先找出符合條件的節點並給予展開值
   CASE p_type
      WHEN 1
         LET ls_code = "0" #展開值0則無法展開
      WHEN 2
         LET ls_code = "2"
      WHEN 3
         LET ls_code = "2"
   END CASE
   
   IF cl_null("pmai001") THEN
      LET ls_code = "0"
   END IF 
   
   CALL s_transaction_begin()
 
   LET g_sql = " INSERT INTO apmm826_tmp (pmai001,pmai001_desc,pmaastus,pmaa083,pmai002,pmai005,pmai003, 
       pmai004,pmai006,pmai006_desc,pmai007,pmai009,pmai010,pmaistus,exp_code) VALUES (?,?,?,?,?,?,?, 
       ?,?,?,?,?,?,?,?)"
   PREPARE master_tmp FROM g_sql
   
   IF g_root_search THEN
      #DECLARE master_tmp_cur CURSOR FOR master_tmp
      #OPEN master_tmp_cur
      FOREACH master_extcur INTO l_bstmp.*
         EXECUTE master_tmp USING l_bstmp.*,ls_code
         #PUT master_tmp_cur FROM l_bstmp.*,ls_code
      END FOREACH
      #FLUSH master_tmp_cur
      CALL s_transaction_end("Y","0")
      RETURN
   END IF
 
   FOREACH master_extcur INTO l_bstmp.*
      EXECUTE master_tmp USING l_bstmp.*,ls_code
      LET l_child_list[l_child_list.getLength()+1].* = l_bstmp.*
       
      #找出符合條件的節點的所有祖先並給予展開值
      CASE p_type
         WHEN 1
            LET ls_code2 = "1"
         WHEN 2
            LET ls_code2 = "-1"
         WHEN 3
            LET ls_code2 = "1"
      END CASE
      
      #若pid欄位存在才進行後續處理
      #擷取該節點的父節點到temp table中
      LET g_sql = " SELECT pmai001,'','','',pmai002,pmai005,pmai003,pmai004,pmai006,'',pmai007,pmai009, 
          pmai010,pmaistus ",
                  " FROM pmai_t ",
                  " WHERE pmaient = '" ||g_enterprise|| "' AND pmai005 = ? ",
                  cl_sql_add_filter("pmai_t")
      PREPARE master_getparent_up FROM g_sql
      
      #擷取該節點的所有父節點
      WHILE TRUE
         IF cl_null(l_child_list[1].pmai005) THEN
            IF l_child_list.getLength() = 1 THEN
               EXIT WHILE
            ELSE
               CALL l_child_list.deleteElement(1)
               CONTINUE WHILE
            END IF
         END IF
      
         EXECUTE master_getparent_up USING l_child_list[1].pmai001
                                           INTO l_bstmp.*
         IF SQLCA.sqlcode THEN
            FREE master_getparent_up
            EXIT WHILE
         END IF
         FREE master_getparent_up
      #確定該節點是否存在於temp table中
         
         IF STATUS = 0 AND apmm826_tmp_tbl_chk(l_bstmp.pmai005,ls_code2
                     ) THEN
            EXECUTE master_tmp USING l_bstmp.*,ls_code2
            LET l_child_list[l_child_list.getLength()+1].* = l_bstmp.*
         END IF
         CALL l_child_list.deleteElement(1)
      
      END WHILE
   
   END FOREACH
   
   CLOSE master_tmp
   
   CALL s_transaction_end("Y","0")
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.modify" ver="6" status="" src="s">
    <![CDATA[#+ 資料修改
PRIVATE FUNCTION apmm826_modify()
   #add-point:modify段define
   {<point name="modify.define"/>}
   #end add-point
   
   IF g_pmai_m.pmai001 IS NULL
 
   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF 
   
   EXECUTE apmm826_master_referesh USING g_pmai_m.pmai001,g_pmai_m.pmai002 INTO g_pmai_m.pmai001,g_pmai_m.pmai002, 
       g_pmai_m.pmai003,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
       g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid, 
       g_pmai_m.pmaiowndp,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid, 
       g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid,g_pmai_m.pmaicnfdt,g_pmai_m.pmai003_desc,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012_desc,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid_desc, 
       g_pmai_m.pmaicrtdp_desc,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaicnfid_desc
 
   ERROR ""
  
   LET g_pmai001_t = g_pmai_m.pmai001
   LET g_pmai002_t = g_pmai_m.pmai002
 
   
   CALL s_transaction_begin()
   
   OPEN apmm826_cl USING g_enterprise,g_pmai_m.pmai001,g_pmai_m.pmai002
   IF STATUS THEN
      CALL cl_err("OPEN apmm826_cl:", STATUS, 1)
      CLOSE apmm826_cl
      CALL s_transaction_end("N","0")
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH apmm826_cl INTO g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083, 
       g_pmai_m.pmai003,g_pmai_m.pmai003_desc,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012,g_pmai_m.pmai012_desc,g_pmai_m.pmaistus,g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009, 
       g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp, 
       g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtid_desc,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdp_desc, 
       g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid, 
       g_pmai_m.pmaicnfid_desc,g_pmai_m.pmaicnfdt
 
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_pmai_m.pmai005,SQLCA.sqlcode,0)
      CLOSE apmm826_cl
      CALL s_transaction_end("N","0")
      RETURN
   END IF
 
   CALL apmm826_show()
   WHILE TRUE
      LET g_pmai_m.pmai001 = g_pmai001_t
      LET g_pmai_m.pmai002 = g_pmai002_t
 
      
      #寫入修改者/修改日期資訊
      LET g_pmai_m.pmaimodid = g_user 
LET g_pmai_m.pmaimoddt = cl_get_current()
 
 
      #add-point:modify段修改前
      {<point name="modify.before_input"/>}
      #end add-point
      
      CALL apmm826_input("u")     #欄位更改
 
      #add-point:modify段修改後
      {<point name="modify.after_input"/>}
      #end add-point
      
      IF INT_FLAG THEN
          LET INT_FLAG = 0
          LET g_pmai_m.* = g_pmai_m_t.*
          CALL apmm826_show()
          CALL cl_err("",9001,0)
          EXIT WHILE
      END IF
 
      #若有modid跟moddt則進行update
      UPDATE pmai_t SET (pmaimodid,pmaimoddt) = (g_pmai_m.pmaimodid,g_pmai_m.pmaimoddt)
       WHERE pmaient = g_enterprise AND pmai001 = g_pmai001_t
         AND pmai002 = g_pmai002_t
 
      
      EXIT WHILE
  
   END WHILE
 
   #修改歷程記錄
   #IF NOT cl_log_modified_record(g_pmai_m.pmai005,g_site) THEN 
   #   CALL s_transaction_end("N","0")
   #END IF
 
   CLOSE apmm826_cl
   CALL s_transaction_end("Y","0")
 
   #流程通知預埋點-U
   CALL cl_flow_notify(g_pmai_m.pmai005,"U")
   
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.other_function" ver="1" status="" src="s">
    <![CDATA[{<point name="other.function"/>}
]]>
  </section>
  <section id="apmm826.query" ver="3" status="" src="s">
    <![CDATA[#+ 資料查詢QBE功能準備
PRIVATE FUNCTION apmm826_query()
   DEFINE ls_wc STRING
   #add-point:query段define
   {<point name="query.define"/>}
   #end add-point
   
   #add-point:query段查詢前
   {<point name="query.before_query"/>}
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET INT_FLAG = 0
   LET ls_wc = g_wc
 
   #CLEAR FORM
   #CALL g_browser.clear()
 
   DISPLAY " " TO FORMONLY.h_count
 
   CALL apmm826_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      LET g_wc = ls_wc
      #add-point:query段取消
      {<point name="query.cancel"/>}
      #end add-point
      #CALL apmm826_browser_fill(g_wc,g_searchtype)
      CALL apmm826_fetch("")
      RETURN
   ELSE
      LET g_current_row = 1
      LET g_browser_cnt = 0
      LET g_current_idx = 1
      CALL g_browser.clear()
      LET g_first = 0  #設定重新查詢資料後顯示
   END IF
 
   LET g_searchtype = "3"
   LET g_searchcol = "0"
   CALL apmm826_browser_fill(g_wc,g_searchtype)
   
   #第一層模糊搜尋
   IF g_browser_cnt = 0 THEN
      LET g_wc = cl_wc_parser(g_wc)
      CALL apmm826_browser_fill(g_wc,g_searchtype)
   END IF
   
   #第二層速記碼搜尋
   #IF g_browser_cnt = 0 THEN
   #   CALL cl_err("","-100",1)
   #END IF
 
   IF g_browser_cnt = 0 THEN
      CALL cl_err("","-100",1)
   END IF
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.reproduce" ver="7" status="" src="s">
    <![CDATA[#+ 資料複製
PRIVATE FUNCTION apmm826_reproduce(l_dialog)
   DEFINE l_dialog      ui.DIALOG
   DEFINE li_addpos     LIKE type_t.num5
   DEFINE l_newno           LIKE pmai_t.pmai001 
   DEFINE l_oldno           LIKE pmai_t.pmai001 
   DEFINE l_newno02     LIKE pmai_t.pmai002 
   DEFINE l_oldno02     LIKE pmai_t.pmai002 
 
   DEFINE l_master          RECORD LIKE pmai_t.*
   DEFINE l_cnt             LIKE type_t.num5  
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point   
 
   #add-point:複製段開始前
   {<point name="reproduce.before_reproduce"/>}
   #end add-point
 
   #檢查PK欄位是否均有值,若全部為NULL時退出
   IF g_pmai_m.pmai001 IS NULL
 
   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF 
 
   EXECUTE apmm826_master_referesh USING g_pmai_m.pmai001,g_pmai_m.pmai002 INTO g_pmai_m.pmai001,g_pmai_m.pmai002, 
       g_pmai_m.pmai003,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai012,g_pmai_m.pmaistus, 
       g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009,g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid, 
       g_pmai_m.pmaiowndp,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid, 
       g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid,g_pmai_m.pmaicnfdt,g_pmai_m.pmai003_desc,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012_desc,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid_desc, 
       g_pmai_m.pmaicrtdp_desc,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaicnfid_desc
 
   #檢查如果有子節點(hasC=1)則顯示錯誤訊息後退出
 
   ERROR ""
 
   CALL cl_set_head_visible("","YES")
 
   
   LET g_pmai_m.pmai001 = ""
   #此段落由子樣板a14產生    
      LET g_pmai_m.pmaiownid = g_user
      LET g_pmai_m.pmaiowndp = g_dept
      LET g_pmai_m.pmaicrtid = g_user
      LET g_pmai_m.pmaicrtdp = g_dept 
      LET g_pmai_m.pmaicrtdt = cl_get_current()
      LET g_pmai_m.pmaimodid = ""
      LET g_pmai_m.pmaimoddt = ""
      LET g_pmai_m.pmaistus = "N"
 
 
   
   CALL s_transaction_begin()
 
   #add-point:複製輸入前
   {<point name="reproduce.head.b_input"/>}
   #end add-point
   
   #直接呼叫輸入
   CALL apmm826_input("r")
 
   #add-point:完成複製段落後
   {<point name="reproduce.after_reproduce" />}
   #end add-point
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      LET g_pmai_m.* = g_pmai_m_t.*
      CALL apmm826_show()
      CALL cl_err("",9001,0)
   ELSE
      #檢查是否還有子節點,若有則做插入節點
      IF g_browser[g_current_idx].b_hasC THEN
         IF g_browser[g_current_idx].b_exp THEN
            LET li_addpos = l_dialog.appendNode("s_browse",g_current_idx)
            CALL apmm826_desc_show(li_addpos)
         END IF
      ELSE
         IF g_browser[g_current_idx].b_exp THEN
            #此處要改成已展開
            LET g_browser[g_current_idx].b_hasC = 1
            LET g_browser[g_current_idx].b_exp = 1
            LET li_addpos = l_dialog.appendNode("s_browse",g_current_idx)
            CALL apmm826_desc_show(li_addpos)
         END IF
      END IF
   END IF
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.set_entry" ver="2" status="" src="s">
    <![CDATA[#+ 單頭欄位開啟設定
PRIVATE FUNCTION apmm826_set_entry(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1 
   #add-point:set_entry段define
   {<point name="set_entry.define"/>}
   #end add-point
   
   IF p_cmd = "a" THEN
      CALL cl_set_comp_entry("pmai001,pmai002",TRUE)
      #add-point:set_entry段欄位控制
      {<point name="set_entry.field_control"/>}
      #end add-point 
   END IF
   
   #add-point:set_entry段欄位控制後
   {<point name="set_entry.after_control"/>}
   #end add-point 
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.set_no_entry" ver="3" status="" src="s">
    <![CDATA[#+ 單頭欄位關閉設定
PRIVATE FUNCTION apmm826_set_no_entry(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_no_entry段define
   {<point name="set_no_entry.define"/>}
   #end add-point
    
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("pmai001,pmai002",FALSE)
      #add-point:set_no_entry段欄位控制
      {<point name="set_no_entry.field_control"/>}
      #end add-point 
   END IF
   
   #add-point:set_no_entry段欄位控制後
   {<point name="set_no_entry.after_control"/>}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.set_pk_array" ver="1" status="" src="s">
    <![CDATA[   #+ 此段落由子樣板a51產生
#+ 給予pk_array內容
PRIVATE FUNCTION apmm826_set_pk_array()
   #add-point:set_pk_array段define
   {<point name="set_pk_array.define"/>}
   #end add-point
   
   #add-point:set_pk_array段之前
   {<point name="set_pk_array.before"/>}
   #end add-point  
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_pmai_m.pmai001
   LET g_pk_array[1].column = 'pmai001'
   LET g_pk_array[2].values = g_pmai_m.pmai002
   LET g_pk_array[2].column = 'pmai002'
   
   #add-point:set_pk_array段之後
   {<point name="set_pk_array.after"/>}
   #end add-point  
   
END FUNCTION
 
 
]]>
  </section>
  <section id="apmm826.show" ver="4" status="" src="s">
    <![CDATA[#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION apmm826_show()
   #add-point:show段define
   {<point name="show.define"/>}
   #end add-point
   
   #add-point:show段之前
   {<point name="show.before"/>}
   #end add-point
   
   
   
   LET g_pmai_m_t.* = g_pmai_m.*      #保存單頭舊值
 
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()       
   
   #帶出公用欄位reference值
   #此段落由子樣板a12產生
      #LET g_pmai_m.pmaiownid_desc = cl_get_username(g_pmai_m.pmaiownid)
      #LET g_pmai_m.pmaiowndp_desc = cl_get_deptname(g_pmai_m.pmaiowndp)
      #LET g_pmai_m.pmaicrtid_desc = cl_get_username(g_pmai_m.pmaicrtid)
      #LET g_pmai_m.pmaicrtdp_desc = cl_get_deptname(g_pmai_m.pmaicrtdp)
      #LET g_pmai_m.pmaimodid_desc = cl_get_username(g_pmai_m.pmaimodid)
      #LET g_pmai_m.pmaicnfid_desc = cl_get_deptname(g_pmai_m.pmaicnfid)
      
 
 
 
   #顯示followup圖示
   #+ 此段落由子樣板a48產生
   CALL apmm826_set_pk_array()
   #add-point:ON ACTION agendum
   {<point name="show.follow_pic"/>}
   #END add-point
   CALL cl_user_overview_set_follow_pic()
 
 
   
   #讀入ref值(單頭)
   #add-point:reference段之後
   {<point name="show.head.reference"/>}
   #end add-point
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmai_m.pmai001,g_pmai_m.pmai002,g_pmai_m.pmaal004,g_pmai_m.pmaastus,g_pmai_m.pmaa083, 
       g_pmai_m.pmai003,g_pmai_m.pmai003_desc,g_pmai_m.pmai004,g_pmai_m.pmai005,g_pmai_m.pmai006,g_pmai_m.pmai006_desc, 
       g_pmai_m.pmai012,g_pmai_m.pmai012_desc,g_pmai_m.pmaistus,g_pmai_m.pmai007,g_pmai_m.pmai008,g_pmai_m.pmai009, 
       g_pmai_m.pmai010,g_pmai_m.pmai011,g_pmai_m.pmaiownid,g_pmai_m.pmaiownid_desc,g_pmai_m.pmaiowndp, 
       g_pmai_m.pmaiowndp_desc,g_pmai_m.pmaicrtid,g_pmai_m.pmaicrtid_desc,g_pmai_m.pmaicrtdp,g_pmai_m.pmaicrtdp_desc, 
       g_pmai_m.pmaicrtdt,g_pmai_m.pmaimodid,g_pmai_m.pmaimodid_desc,g_pmai_m.pmaimoddt,g_pmai_m.pmaicnfid, 
       g_pmai_m.pmaicnfid_desc,g_pmai_m.pmaicnfdt
 
   #顯示狀態(stus)圖片
         #此段落由子樣板a21產生
      CASE g_pmai_m.pmaistus
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/void.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/valid.png")
         
      END CASE
 
 
 
   #add-point:show段之後
   {<point name="show.after"/>}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="apmm826.sql_delete" ver="5" status="" src="s">
    <![CDATA[#+ 實體刪除FUNCTION 
PRIVATE FUNCTION apmm826_sql_delete(li_node)
   DEFINE li_node   LIKE type_t.num5  #TRUE:砍除Node Tree/FALSE:砍除Single Node
   DEFINE li_return LIKE type_t.num5
   DEFINE l_var_keys_bak  DYNAMIC ARRAY OF STRING
   DEFINE l_field_keys    DYNAMIC ARRAY OF STRING
 
   LET li_return = TRUE
 
   #+ 此段落由子樣板a47產生
      #刪除相關文件
      CALL apmm826_set_pk_array()
      #add-point:相關文件刪除前
      {<point name="delete.befroe.related_document_remove"/>}
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
   #add-point:單頭刪除前
   {<point name="delete.head.b_delete" mark="Y"/>}
   #end add-point
 
   DELETE FROM pmai_t
    WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
      AND pmai002 = g_pmai_m.pmai002
 
 
   #add-point:單頭刪除中
   {<point name="delete.head.m_delete"/>}
   #end add-point
 
   IF SQLCA.sqlcode THEN
      CALL cl_err("pmai_t",SQLCA.sqlcode,0)
      CALL s_transaction_end("N","0")
   END IF
 
   
 
   RETURN li_return
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.state_change" ver="3" status="" src="s">
    <![CDATA[   #+ 此段落由子樣板a09產生
#+ 確認碼變更
PRIVATE FUNCTION apmm826_statechange()
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define
   {<point name="statechange.define"/>}
   #end add-point  
   
   #add-point:statechange段開始前
   {<point name="statechange.before"/>}
   #end add-point  
   
   ERROR ""     #清空畫面右下側ERROR區塊
 
   IF g_pmai_m.pmai001 IS NULL
      OR g_pmai_m.pmai002 IS NULL
   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF
 
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_pmai_m.pmaistus
            WHEN "N"
               HIDE OPTION "open"
            WHEN "X"
               HIDE OPTION "void"
            WHEN "Y"
               HIDE OPTION "valid"
            
         END CASE
     
      #add-point:menu前
      {<point name="statechange.before_menu"/>}
      #end add-point
      
      ON ACTION open
         LET lc_state = "N"
         #add-point:action控制
         {<point name="statechange.open"/>}
         #end add-point
         EXIT MENU
      ON ACTION void
         LET lc_state = "X"
         #add-point:action控制
         {<point name="statechange.void"/>}
         #end add-point
         EXIT MENU
      ON ACTION valid
         LET lc_state = "Y"
         #add-point:action控制
         {<point name="statechange.valid"/>}
         #end add-point
         EXIT MENU
      
      
      
      #add-point:stus控制
      {<point name="statechange.more_control"/>}
      #end add-point
      
   END MENU
   
   IF (lc_state <> "N" 
      AND lc_state <> "X"
      AND lc_state <> "Y"
      ) OR 
      cl_null(lc_state) THEN
      RETURN
   END IF
   
   #add-point:stus修改前
   {<point name="statechange.b_update"/>}
   #end add-point
      
   UPDATE pmai_t SET pmaistus = lc_state 
    WHERE pmaient = g_enterprise AND pmai001 = g_pmai_m.pmai001
      AND pmai002 = g_pmai_m.pmai002
  
   IF SQLCA.sqlcode THEN
      CALL cl_err("",SQLCA.sqlcode,0)
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/void.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/valid.png")
         
      END CASE
      LET g_pmai_m.pmaistus = lc_state
      DISPLAY BY NAME g_pmai_m.pmaistus
   END IF
 
   #add-point:stus修改後
   {<point name="statechange.a_update"/>}
   #end add-point
 
   #add-point:statechange段結束前
   {<point name="statechange.after"/>}
   #end add-point  
 
END FUNCTION
 
 
]]>
  </section>
  <section id="apmm826.tmp_tbl_chk" ver="3" status="" src="s">
    <![CDATA[#+ TEMP TABLE CHK
PRIVATE FUNCTION apmm826_tmp_tbl_chk(ps_id,pi_code)
   DEFINE ps_id       STRING
   DEFINE pi_code     LIKE type_t.num10
   DEFINE ps_type     STRING
   DEFINE ls_id       LIKE type_t.chr500
   DEFINE ls_search   LIKE type_t.chr500
   DEFINE ls_type     LIKE type_t.chr500
   DEFINE li_cnt      LIKE type_t.num10
   DEFINE li_code     LIKE type_t.num10   
   #add-point:tmp_tbl_chk段define
   {<point name="tmp_tbl_chk.define"/>}
   #end add-point
   
   LET ls_id = ps_id
  
   IF cl_null(ls_id) THEN
      RETURN TRUE
   END IF
   
   LET g_sql = " SELECT COUNT(*) FROM apmm826_tmp ", 
               " WHERE pmai005 = ? "
 
   PREPARE apmm826_get_cnt FROM g_sql
   EXECUTE apmm826_get_cnt USING ls_id 
                                     INTO li_cnt
   FREE apmm826_get_cnt
 
   IF li_cnt = 0 OR SQLCA.sqlcode THEN
      RETURN TRUE
   ELSE
    
      #資料已存在, 確定是否需要更新展開值
      LET g_sql = " SELECT exp_code FROM apmm826_tmp ",
                  " WHERE pmai005 = ? " 
 
      PREPARE apmm826_chk_exp FROM g_sql
      
      EXECUTE apmm826_chk_exp USING ls_id 
                                        INTO li_code
      FREE apmm826_chk_exp
      
      #若新展開值>原展開值則做更新
      IF pi_code > li_code THEN
         LET g_sql = " UPDATE apmm826_tmp SET (exp_code) = ('",pi_code,"') ",
                      " WHERE pmai005 = ? "
         PREPARE apmm826_upd_exp FROM g_sql
         EXECUTE apmm826_upd_exp USING ls_id 
         FREE apmm826_upd_exp
      END IF
      
      RETURN FALSE
   END IF
 
END FUNCTION
]]>
  </section>
  <section id="apmm826.ui_dialog" ver="10" status="" src="s">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION apmm826_ui_dialog()
   DEFINE li_exit      LIKE type_t.num5    #判別是否為離開作業
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define"/>}
   #end add-point
   
   LET li_exit = FALSE
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm() 
   
   #CALL gfrm_curr.setElementImage("logo","logo/applogo.png") 
   #CALL gfrm_curr.setElementHidden("mainlayout",1)
   #CALL gfrm_curr.setElementHidden("worksheet",0)
   #LET g_main_hidden = 1
   
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE li_exit = FALSE
 
      #當瀏覽頁簽被設定關閉時,使用MENU (開啟時使用DIALOG)
      IF g_worksheet_hidden = 1 THEN
 
         LET g_current_sw = FALSE
 
         #回歸舊筆數位置 (回到當時異動的筆數)
         LET g_current_idx = g_current_row
         LET g_current_sw = TRUE
         CALL cl_show_fld_cont() 
         CALL apmm826_fetch("")    #當每次點任一筆資料都會需要用到
 
         MENU
            #add-point:ui_dialog段其他頁簽的 display array(in menu)
            {<point name="ui_dialog.more_displayarray_in_menu"/>}
            #end add-point
            
            ON ACTION statechange
               LET g_action_choice = "statechange"
               CALL apmm826_statechange()
            
            #ACTION表單列
            ON ACTION first
               LET g_current_idx = 1
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
            
            ON ACTION next
               LET g_current_idx = g_current_idx + 1
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
 
            ON ACTION jump
               CALL apmm826_fetch("/")
               LET g_current_row = g_current_idx
 
            ON ACTION previous
               LET g_current_idx = g_current_idx - 1
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
 
            ON ACTION last 
               LET g_current_idx = g_browser_cnt
               CALL apmm826_fetch("") 
               LET g_current_row = g_current_idx
 
            ON ACTION exit
               LET g_action_choice="exit"
               LET INT_FLAG = FALSE
               LET li_exit = TRUE
               EXIT MENU 
 
            ON ACTION close
               LET li_exit = TRUE
               EXIT MENU
 
            ON ACTION mainhidden       #主頁摺疊
               IF g_main_hidden THEN
                  CALL gfrm_curr.setElementHidden("mainlayout",0)
                  CALL gfrm_curr.setElementImage("mainhidden","16/worksheethidden.png")
                  LET g_main_hidden = 0
               ELSE
                  CALL gfrm_curr.setElementHidden("mainlayout",1)
                  CALL gfrm_curr.setElementImage("mainhidden","16/worksheethidden.png")
                  LET g_main_hidden = 1
               END IF
               EXIT MENU
         
            ON ACTION worksheethidden   #瀏覽頁折疊
               IF g_worksheet_hidden THEN
                  CALL gfrm_curr.setElementHidden("worksheet",0)
                  CALL gfrm_curr.setElementImage("worksheethidden","16/mainhidden.png")
                  LET g_worksheet_hidden = 0
               ELSE
                  CALL gfrm_curr.setElementHidden("worksheet",1)
                  CALL gfrm_curr.setElementImage("worksheethidden","16/mainhidden.png")
                  LET g_worksheet_hidden = 1
               END IF
               EXIT MENU
         
            ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
               IF g_header_hidden THEN
                  CALL gfrm_curr.setElementHidden("vb_master",0)
                  CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
                  LET g_header_hidden = 0     #visible
               ELSE
                  CALL gfrm_curr.setElementHidden("vb_master",1)
                  CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
                  LET g_header_hidden = 1     #hidden
               END IF
 
            
         #+ 此段落由子樣板a43產生
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL apmm826_modify()
               #add-point:ON ACTION modify
               {<point name="menu2.modify" />}
               #END add-point
               EXIT MENU
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL apmm826_delete(DIALOG)
               #add-point:ON ACTION delete
               {<point name="menu2.delete" />}
               #END add-point
               
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL apmm826_insert(DIALOG)
               #add-point:ON ACTION insert
               {<point name="menu2.insert" />}
               #END add-point
               EXIT MENU
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output
               {<point name="menu2.output" />}
               #END add-point
               EXIT MENU
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL apmm826_reproduce(DIALOG)
               #add-point:ON ACTION reproduce
               {<point name="menu2.reproduce" />}
               #END add-point
               EXIT MENU
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL apmm826_query()
               #add-point:ON ACTION query
               {<point name="menu2.query" />}
               #END add-point
               
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION follow_up
            LET g_action_choice="follow_up"
            IF cl_auth_chk_act("follow_up") THEN
               
               #add-point:ON ACTION follow_up
               {<point name="menu2.follow_up" />}
               #END add-point
               EXIT MENU
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION prog_pmai001
            LET g_action_choice="prog_pmai001"
            IF cl_auth_chk_act("prog_pmai001") THEN
               
               #add-point:ON ACTION prog_pmai001
               {<point name="menu2.prog_pmai001" />}
               #END add-point
               EXIT MENU
            END IF
 
 
 
            
 
            #+ 此段落由子樣板a46產生
         #新增相關文件
         ON ACTION related_document
            CALL apmm826_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document
               {<point name="ui_dialog.menu.related_document"/>}
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL apmm826_set_pk_array()
            #add-point:ON ACTION agendum
            {<point name="ui_dialog.menu.agendum"/>}
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL apmm826_set_pk_array()
            #add-point:ON ACTION followup
            {<point name="ui_dialog.menu.followup"/>}
            #END add-point
            CALL cl_user_overview_follow('')
 
 
            
            &include "main_menu.4gl"
            &include "relating_action.4gl"
            #交談指令共用ACTION
            &include "common_action.4gl"
 
         END MENU
 
      ELSE
         #第一次進入程式, 或啟動重新查詢
         IF g_first = 0 THEN 
            CALL apmm826_browser_fill(g_wc,g_searchtype)
            LET g_first = 1
         END IF
      
         DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         
            INPUT g_searchstr,g_searchcol,g_searchtype FROM formonly.searchstr,formonly.cbo_searchcol, 
                formonly.rdo_searchtype
               BEFORE INPUT
            END INPUT
            
            #左側瀏覽頁簽
            DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTE(COUNT=g_rec_b)
 
               BEFORE DISPLAY
                  CALL DIALOG.setSelectionMode("s_browse",1) #設定為單選
 
               BEFORE ROW
                  #回歸舊筆數位置 (回到當時異動的筆數)
                  LET g_current_idx = DIALOG.getCurrentRow("s_browse")
                  IF g_current_row > 1 AND g_current_sw = FALSE THEN
                     CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                     LET g_current_idx = g_current_row
                  END IF
                  LET g_current_row = g_current_idx #目前指標
                  LET g_current_sw = TRUE
                  CALL cl_show_fld_cont() 
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
 
                  CALL apmm826_fetch("")  #當每次點任一筆資料都會需要用到
 
               ON EXPAND (g_row_index)
                  #樹展開
                  CALL apmm826_browser_expand(g_row_index)
                  LET g_browser[g_row_index].b_isExp = 1
 
               ON COLLAPSE (g_row_index)
                  #樹關閉
 
            END DISPLAY
 
            #add-point:ui_dialog段其他頁簽的 display array
            {<point name="ui_dialog.more_displayarray"/>}
            #end add-point
 
            BEFORE DIALOG
               #action default動作(判定是否要先執行特定動作)
               #+ 此段落由子樣板a42產生
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL apmm826_insert(DIALOG)
            #add-point:ON ACTION insert
            {<point name="menu.default.insert" />}
            #END add-point
         END IF
 
      #add-point:action default自訂
      {<point name="ui_dialog.action_default"/>}
      #end add-point
      OTHERWISE
         
   END CASE
 
 
               LET g_curr_diag = ui.DIALOG.getCurrent()
               LET g_current_sw = FALSE
 
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_sw = FALSE THEN
                  IF g_current_row > g_browser.getLength() THEN
                     LET g_current_row = g_browser.getLength()
                  END IF 
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE
               CALL cl_show_fld_cont() 
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               CALL apmm826_fetch("")            #當每次點任一筆資料都會需要用到
               #add-point:ui_dialog,before dialog
               {<point name="ui_dialog.b_dialog"/>}
               #end add-point
 
            AFTER DIALOG 
               #add-point:ui_dialog,after dialog
               {<point name="ui_dialog.a_dialog"/>}
               #end add-point
 
            ON ACTION statechange
               LET g_action_choice = "statechange"
               CALL apmm826_statechange()
               EXIT DIALOG
 
            #一般搜尋
            ON ACTION searchdata
               LET g_searchstr = GET_FLDBUF(searchstr)
               LET g_searchcol = GET_FLDBUF(cbo_searchcol)
               #若無輸入關鍵字則查找出所有資料
               IF g_searchcol="0" AND NOT cl_null(g_searchstr) THEN
                  CALL cl_err("searchcol:","std-00001",0)
                  CONTINUE DIALOG
               END IF 
               IF NOT cl_null(g_searchstr) THEN
                  LET g_wc = " lower(", g_searchcol, ") LIKE '%", g_searchstr, "%'"
                  LET g_wc = g_wc.toLowerCase()
               ELSE
                  LET g_wc = " 1=1 "
               END IF
               LET g_first = 0 #啟動重查
               EXIT DIALOG
 
            #進階搜尋
            #ON ACTION advancesearch
 
            #ACTION表單列
            ON ACTION first
               LET g_current_idx = 1
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
 
            ON ACTION next
               LET g_current_idx = g_current_idx + 1
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
 
            ON ACTION jump
               CALL apmm826_fetch("/")
               LET g_current_row = g_current_idx
 
            ON ACTION previous
               LET g_current_idx = g_current_idx - 1
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
 
            ON ACTION last 
               LET g_current_idx = g_browser_cnt
               CALL apmm826_fetch("")
               LET g_current_row = g_current_idx
            
            ON ACTION exit
               LET g_action_choice="exit"
               LET INT_FLAG = FALSE
               LET li_exit = TRUE
               EXIT DIALOG 
            
            ON ACTION close
               LET li_exit = TRUE
               EXIT DIALOG
            
            ON ACTION mainhidden       #主頁摺疊
               IF g_main_hidden THEN
                  CALL gfrm_curr.setElementHidden("mainlayout",0)
                  CALL gfrm_curr.setElementImage("mainhidden","16/worksheethidden.png")
                  LET g_main_hidden = 0
               ELSE
                  CALL gfrm_curr.setElementHidden("mainlayout",1)
                  CALL gfrm_curr.setElementImage("mainhidden","16/mainhidden.png")
                  LET g_main_hidden = 1
               END IF
               EXIT DIALOG
 
            ON ACTION worksheethidden   #瀏覽頁折疊
               IF g_worksheet_hidden THEN
                  CALL gfrm_curr.setElementHidden("worksheet",0)
                  CALL gfrm_curr.setElementImage("worksheethidden","16/worksheethidden.png")
                  LET g_worksheet_hidden = 0
               ELSE
                  CALL gfrm_curr.setElementHidden("worksheet",1)
                  CALL gfrm_curr.setElementImage("worksheethidden","16/worksheethidden.png")
                  LET g_worksheet_hidden = 1
               END IF
               EXIT DIALOG
 
            ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
               IF g_header_hidden THEN
                  CALL gfrm_curr.setElementHidden("vb_master",0)
                  CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
                  LET g_header_hidden = 0     #visible
               ELSE
                  CALL gfrm_curr.setElementHidden("vb_master",1)
                  CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
                  LET g_header_hidden = 1     #hidden
               END IF
 
            
         #+ 此段落由子樣板a43產生
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL apmm826_modify()
               #add-point:ON ACTION modify
               {<point name="menu.modify" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL apmm826_delete(DIALOG)
               #add-point:ON ACTION delete
               {<point name="menu.delete" />}
               #END add-point
               
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL apmm826_insert(DIALOG)
               #add-point:ON ACTION insert
               {<point name="menu.insert" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output
               {<point name="menu.output" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL apmm826_reproduce(DIALOG)
               #add-point:ON ACTION reproduce
               {<point name="menu.reproduce" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL apmm826_query()
               #add-point:ON ACTION query
               {<point name="menu.query" />}
               #END add-point
               
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION follow_up
            LET g_action_choice="follow_up"
            IF cl_auth_chk_act("follow_up") THEN
               
               #add-point:ON ACTION follow_up
               {<point name="menu.follow_up" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION prog_pmai001
            LET g_action_choice="prog_pmai001"
            IF cl_auth_chk_act("prog_pmai001") THEN
               
               #add-point:ON ACTION prog_pmai001
               {<point name="menu.prog_pmai001" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
 
            
            
            #+ 此段落由子樣板a46產生
         #新增相關文件
         ON ACTION related_document
            CALL apmm826_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document
               {<point name="ui_dialog.dialog.related_document"/>}
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL apmm826_set_pk_array()
            #add-point:ON ACTION agendum
            {<point name="ui_dialog.dialog.agendum"/>}
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL apmm826_set_pk_array()
            #add-point:ON ACTION followup
            {<point name="ui_dialog.dialog.followup"/>}
            #END add-point
            CALL cl_user_overview_follow('')
 
 
            
            &include "main_menu.4gl"
            #交談指令共用ACTION
            &include "common_action.4gl"
            
         END DIALOG 
      
      END IF
      
   END WHILE
 
END FUNCTION 
]]>
  </section>
</add_points>
