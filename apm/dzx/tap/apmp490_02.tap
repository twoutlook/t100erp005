<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="apmp490_02" std_prog="apmp490_02" erpver="1.0" module="APM" ver="6" env="s" zone="t10prd" booking="Y" type="S" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="F" status="u"/>
    <free_style value="Y" status="u"/>
    <start_arg value="" status="u"/>
  </other>
  <point name="dialog.apmp490_02_input01" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
DIALOG apmp490_02_input01()
   DEFINE l_sql     STRING
   DEFINE l_sql1    STRING
   DEFINE l_sql2    STRING
   DEFINE l_success LIKE type_t.num5
   DEFINE l_wc      STRING

   INPUT BY NAME g_apmp490_02_input.scb01,g_apmp490_02_input.scb02,
                 g_apmp490_02_input.bt01,g_apmp490_02_input.ed01,
                 g_apmp490_02_input.scb03
                 ATTRIBUTE(WITHOUT DEFAULTS)

      BEFORE INPUT
         CALL apmp490_02_set_entry('a')
         CALL apmp490_02_set_no_entry('a')

      AFTER INPUT

      ON CHANGE scb01
         CALL apmp490_02_set_entry('a')
         CALL apmp490_02_set_no_entry('a')

      AFTER FIELD bt01
        CALL apmp490_02_bt01_ref(g_apmp490_02_input.bt01) RETURNING g_apmp490_02_input.bt01_desc
        DISPLAY BY NAME g_apmp490_02_input.bt01_desc

        IF NOT cl_null(g_apmp490_02_input.bt01) THEN
           IF NOT apmp490_02_pmdl004_chk(g_apmp490_02_input.bt01) THEN
              
              NEXT FIELD CURRENT 
           END IF

        END IF

      AFTER FIELD ed01
         IF NOT cl_null(g_apmp490_02_input.ed01) THEN
            IF g_apmp490_02_input.ed01 <= 0 THEN    #必輸不可空白，數量需>0  
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'ade-00016'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
        #數量不可小於等於0   
               NEXT FIELD CURRENT
            END IF
         END IF

      ON CHANGE scb03
         #當「參考資料期間」改變的時候 要重新找符合期間的資料  
         CASE g_apmp490_02_input.scb03
            WHEN '0'            #1個月   
               LET g_mm = 1
            WHEN '1'            #2個月  
               LET g_mm = 2
            WHEN '2'            #3個月  
               LET g_mm = 3
            WHEN '3'            #6個月  
               LET g_mm = 6
            WHEN '4'            #1年  
               LET g_mm = 12
         END CASE

         #利用sql計算要查找資料的起始點 
         #SELECT ADD_MONTHS(LAST_DAY(g_today)+1,-g_mm) INTO g_date FROM DUAL  
         #假設今天是 2014/05/15 而我要找的是1個月前到今日的資料  
         #是要找2014/04/15 ~ 2014/05/15的資料 所以不用算到月初  
         SELECT ADD_MONTHS(g_today,-g_mm) INTO g_date FROM DUAL

         LET l_wc = "pmdldocdt BETWEEN '",g_date,"' AND '",g_today,"' "
         CALL apmp490_02_b_fill_02(l_wc)
         LET l_wc = "pmdsdocdt BETWEEN '",g_date,"' AND '",g_today,"' "
         CALL apmp490_02_b_fill_03(l_wc)
         LET l_wc = "qcbadocdt BETWEEN '",g_date,"' AND '",g_today,"' "
         CALL apmp490_02_b_fill_04(l_wc)

      ON ACTION controlp INFIELD bt01
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'i'
         LET g_qryparam.reqry = FALSE

         LET g_qryparam.default1 = g_apmp490_02_input.bt01

         LET g_qryparam.where = "1=1 "

         #統一使用s_control_get_supplier_sql()回傳的sql丟入where條件即可 
         CALL s_control_get_supplier_sql('4',g_site,g_user,g_dept,g_apmp490_01_input.pmdldocno)
              RETURNING l_success,l_sql
         IF l_success THEN
            LET g_qryparam.where = l_sql
         END IF

         CALL q_pmaa001_3()

         LET g_apmp490_02_input.bt01 = g_qryparam.return1
         DISPLAY g_apmp490_02_input.bt01 TO bt01

         NEXT FIELD bt01

   END INPUT
END DIALOG]]>
  </point>
  <point name="function.apmp490_02" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PUBLIC FUNCTION apmp490_02(--)
   #add-point:input段變數傳入

   #end add-point
   )
   {
   DEFINE l_ac_t          LIKE type_t.num5        #未取消的ARRAY CNT
   DEFINE l_allow_insert  LIKE type_t.num5        #可新增否
   DEFINE l_allow_delete  LIKE type_t.num5        #可刪除否
   DEFINE l_count         LIKE type_t.num5
   DEFINE l_insert        LIKE type_t.num5
   DEFINE p_cmd           LIKE type_t.chr5
   #add-point:input段define

   #end add-point

   #畫面開啟 (identifier)
   OPEN WINDOW w_apmp490_02 WITH FORM cl_ap_formpath("apm","apmp490_02")

   #瀏覽頁簽資料初始化
   CALL cl_ui_init()

   LET g_qryparam.state = "i"
   LET p_cmd = 'a'

   #輸入前處理
   #add-point:單頭前置處理

   #end add-point

   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #輸入開始
      INPUT BY NAME g_apaa_m.apaa001,g_apaa_m.apaa002 ATTRIBUTE(WITHOUT DEFAULTS)

         #自訂ACTION
         #add-point:單頭前置處理

         #end add-point

         #自訂ACTION(master_input)


         BEFORE INPUT
            #add-point:單頭輸入前處理

            #end add-point

         #---------------------------<  Master  >---------------------------
         #----<<apaa001>>----
         #此段落由子樣板a02產生
         AFTER FIELD apaa001

            #add-point:AFTER FIELD apaa001
            IF NOT cl_null(g_apaa_m.apaa001) THEN
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL

               #設定g_chkparam.*的參數
               LET g_chkparam.arg2 = '參數2'

               #呼叫檢查存在並帶值的library
               IF cl_chk_exist_and_ref_val("v_apaa001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME
               ELSE
                  #檢查失敗時後續處理
                  NEXT FIELD CURRENT
               END IF


            END IF
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_apaa_m.apaa_t.apaa001
            CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_apaa_m.apaa001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_apaa_m.apaa001_desc

            #此段落由子樣板a05產生
            IF  NOT cl_null(g_apaa_m.apaa001) AND NOT cl_null(g_apaa_m.apaa002) THEN
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_apaa_m.apaa001 != g_apaa001_t  OR g_apaa_m.apaa002 != g_apaa002_t )) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apaa_t WHERE "||"apaaent = '" ||g_enterprise|| "' AND apaasite = '" ||g_site|| "' AND "||"apaa001 = '"||g_apaa_m.apaa001 ||"' AND "|| "apaa002 = '"||g_apaa_m.apaa002 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD apaa001
            #add-point:BEFORE FIELD apaa001

            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE apaa001
            #add-point:ON CHANGE apaa001

            #END add-point

         #----<<apaa001_desc>>----
         #----<<apaa002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD apaa002
            #add-point:BEFORE FIELD apaa002

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD apaa002

            #add-point:AFTER FIELD apaa002
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_apaa_m.apaa001) AND NOT cl_null(g_apaa_m.apaa002) THEN
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_apaa_m.apaa001 != g_apaa001_t  OR g_apaa_m.apaa002 != g_apaa002_t )) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apaa_t WHERE "||"apaaent = '" ||g_enterprise|| "' AND apaasite = '" ||g_site|| "' AND "||"apaa001 = '"||g_apaa_m.apaa001 ||"' AND "|| "apaa002 = '"||g_apaa_m.apaa002 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF



            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE apaa002
            #add-point:ON CHANGE apaa002

            #END add-point

 #欄位檢查
         #---------------------------<  Master  >---------------------------
         #----<<apaa001>>----
         #Ctrlp:input.c.apaa001
         ON ACTION controlp INFIELD apaa001
            #add-point:ON ACTION controlp INFIELD apaa001
            #此段落由子樣板a07產生
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_apaa_m.apaa001             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #


            CALL q_pmaa001_1()                                #呼叫開窗

            LET g_apaa_m.apaa001 = g_qryparam.return1

            DISPLAY g_apaa_m.apaa001 TO apaa001              #

            NEXT FIELD apaa001                          #返回原欄位


            #END add-point

         #----<<apaa001_desc>>----
         #----<<apaa002>>----
         #Ctrlp:input.c.apaa002
#         ON ACTION controlp INFIELD apaa002
            #add-point:ON ACTION controlp INFIELD apaa002

            #END add-point

 #欄位開窗

         AFTER INPUT
            #add-point:單頭輸入後處理

            #end add-point

      END INPUT

      #add-point:自定義input

      #end add-point

      #公用action
      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION close
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION exit
         LET INT_FLAG = TRUE
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG

   #add-point:畫面關閉前

   #end add-point

   #畫面關閉
   CLOSE WINDOW w_apmp490_02

   #add-point:input段after input

   #end add-point
}
END FUNCTION]]>
  </point>
  <point name="dialog.apmp490_02_display01" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
DIALOG apmp490_02_display01()
   DEFINE l_wc     STRING

   DISPLAY ARRAY g_pmdn_d TO s_apmp490_02_detail1.* ATTRIBUTE(COUNT=g_d_cnt_p49002_01)
      BEFORE DISPLAY
         CALL FGL_SET_ARR_CURR(g_d_idx_p49002_01)
         #ming 欄位變色 參考apmt410 
         CALL DIALOG.setCellAttributes(g_apmp490_02_pmdn_color_d)
         #單身不連動, 所以進入單身時, 要重新顯示單身筆數
         #DISPLAY g_d_idx_i35001, g_d_cnt_i35001 TO FORMONLY.idx, FORMONLY.cnt 

      BEFORE ROW
         LET g_d_idx_p49002_01 = DIALOG.getCurrentRow("s_apmp490_02_detail1")
         #DISPLAY g_d_idx_p49001 TO FORMONLY.idx
         # 點的當筆放入g_appoint_idx中, 可讓雙擊直接進入指定筆
         LET g_appoint_idx = g_d_idx_p49002_01

         SELECT ADD_MONTHS(g_today,-g_mm) INTO g_date FROM DUAL

         LET l_wc = "pmdldocdt BETWEEN '",g_date,"' AND '",g_today,"' "
         CALL apmp490_02_b_fill_02(l_wc)
         LET l_wc = "pmdsdocdt BETWEEN '",g_date,"' AND '",g_today,"' "
         CALL apmp490_02_b_fill_03(l_wc)
         LET l_wc = "qcbadocdt BETWEEN '",g_date,"' AND '",g_today,"' "
         CALL apmp490_02_b_fill_04(l_wc)


   END DISPLAY
END DIALOG]]>
  </point>
  <point name="function.apmp490_02_init" order="2" ver="5" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 資料初炲設定
# Memo...........:
# Usage..........: CALL apmp490_02_init()
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_init()
   DEFINE l_msg     STRING 
 
   WHENEVER ERROR CONTINUE 

   #設定ComboBox的選項 
   LET l_msg = cl_getmsg("apm-00469",g_lang),",",         #1.依料件主檔設定   
               cl_getmsg("apm-00470",g_lang),",",         #2.主要供應商，無限量  
               cl_getmsg("apm-00471",g_lang),",",         #3.依廠商分配  
               cl_getmsg("apm-00472",g_lang),",",         #4.主要供應商分配優先，餘量分配  
               cl_getmsg("apm-00473",g_lang)              #5.指定單一供應商  
   CALL cl_set_combo_items("scb01","1,2,3,4,5",l_msg)

   LET l_msg = cl_getmsg("apm-00474",g_lang),",",         #1.依料件進行匯總  
               cl_getmsg("apm-00475",g_lang)              #2.依料件+需求日期進行匯總  
   CALL cl_set_combo_items("scb02","1,2",l_msg)

   LET l_msg = cl_getmsg("apm-00476",g_lang),",",         #一個月  
               cl_getmsg("apm-00477",g_lang),",",         #二個月  
               cl_getmsg("apm-00478",g_lang),",",         #三個月  
               cl_getmsg("apm-00479",g_lang),",",         #六個月  
               cl_getmsg("apm-00480",g_lang)              #一年  
   CALL cl_set_combo_items("scb03","0,1,2,3,4",l_msg)

   CALL cl_set_combo_scc("pmdb014_02_01","2037")          #供應商選擇 
   CALL cl_set_combo_scc("pmdn040_02_02","2016")          #取價來源    
   
   CALL cl_set_combo_scc("imae116_02_04","5052")          #檢驗水準  
   CALL cl_set_combo_scc("qcba018_02_04","5051")          #程度  
   CALL cl_set_combo_scc("qcba019_02_04","5053")          #級數   
   CALL cl_set_combo_scc("qcba022_02_04","5072")          #判定結果  
   
   #設定ComboBox預設值  
   LET g_apmp490_02_input.scb01 = 1
   LET g_apmp490_02_input.scb02 = 1
   LET g_apmp490_02_input.scb03 = 3

   CASE g_apmp490_02_input.scb03
      WHEN '0'           #一個月   
         LET g_mm = 1
      WHEN '1'           #兩個月  
         LET g_mm = 2
      WHEN '2'           #三個月  
         LET g_mm = 3
      WHEN '3'           #六個月   
         LET g_mm = 6
      WHEN '4'           #一年  
         LET g_mm = 12
   END CASE 
   
   #不使用產品特徵，則將產品特徵及說明隱藏 
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'N' THEN
      CALL cl_set_comp_visible("pmdb005_02_01,pmdb005_02_01_desc",FALSE)
      CALL cl_set_comp_visible("pmdn002_02_01,pmdn002_02_01_desc",FALSE)
   END IF 
   
   #取得據點參數，若不使用參考單位時，則參考單位、數量需隱藏，不可維護  
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'N' THEN
      CALL cl_set_comp_visible("pmdn008_02_01,pmdn008_02_01_desc,pmdn009_02_01",FALSE)
   END IF

   #取得據點參數，若不使用計價單位時，則計價單位、數量需隱藏，不可維護 
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = 'N' THEN
      CALL cl_set_comp_visible("pmdn010_02_01,pmdn010_02_01_desc,pmdn011_02_01",FALSE)
   END IF 
   
   CALL g_pmdn_d.clear()      #上方單身清空  
   CALL g_apmp490_02_pmdn_d.clear()
   CALL g_apmp490_02_pmds_d.clear()
   CALL g_apmp490_02_qcba_d.clear()
END FUNCTION]]>
  </point>
  <point name="dialog.apmp490_02_display02" order="3" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
DIALOG apmp490_02_display02()
   DISPLAY ARRAY g_apmp490_02_pmdn_d TO s_apmp490_02_detail2.* ATTRIBUTE(COUNT=g_d_cnt_p49002_02)
      BEFORE DISPLAY
         CALL FGL_SET_ARR_CURR(g_d_idx_p49002_02)
         #單身不連動, 所以進入單身時, 要重新顯示單身筆數
         #DISPLAY g_d_idx_i35001, g_d_cnt_i35001 TO FORMONLY.idx, FORMONLY.cnt 

      BEFORE ROW
         LET g_d_idx_p49002_02 = DIALOG.getCurrentRow("s_apmp490_02_detail2")
         #DISPLAY g_d_idx_p49001 TO FORMONLY.idx
         # 點的當筆放入g_appoint_idx中, 可讓雙擊直接進入指定筆
         LET g_appoint_idx = g_d_idx_p49002_02
   END DISPLAY
END DIALOG]]>
  </point>
  <point name="function.apmp490_02_set_entry" order="3" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 畫面欄位開關設定
# Memo...........:
# Usage..........: CALL apmp490_02_set_entry(p_cmd)
# Input parameter: p_cmd:模式
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_set_entry(p_cmd)
   DEFINE p_cmd LIKE type_t.chr1

   WHENEVER ERROR CONTINUE 

   CALL cl_set_comp_entry("ed01",TRUE) 
   CALL cl_set_comp_entry("bt01",TRUE)
   
END FUNCTION]]>
  </point>
  <point name="dialog.apmp490_02_display03" order="4" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
DIALOG apmp490_02_display03()
   DISPLAY ARRAY g_apmp490_02_pmds_d TO s_apmp490_02_detail3.* ATTRIBUTE(COUNT=g_d_cnt_p49002_03)
      BEFORE DISPLAY
         CALL FGL_SET_ARR_CURR(g_d_idx_p49002_03)
         #單身不連動, 所以進入單身時, 要重新顯示單身筆數
         #DISPLAY g_d_idx_i35001, g_d_cnt_i35001 TO FORMONLY.idx, FORMONLY.cnt 

      BEFORE ROW
         LET g_d_idx_p49002_03 = DIALOG.getCurrentRow("s_apmp490_02_detail3")
         #DISPLAY g_d_idx_p49001 TO FORMONLY.idx
         # 點的當筆放入g_appoint_idx中, 可讓雙擊直接進入指定筆
         LET g_appoint_idx = g_d_idx_p49002_03
   END DISPLAY
END DIALOG]]>
  </point>
  <point name="function.apmp490_02_set_no_entry" order="4" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 畫面欄位開關設定
# Memo...........:
# Usage..........: CALL apmp490_02_set_no_entry(p_cmd)
# Input parameter: p_cmd:模式
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_set_no_entry(p_cmd)
   DEFINE p_cmd LIKE type_t.chr1

   WHENEVER ERROR CONTINUE 

   IF g_apmp490_02_input.scb01 <> 4 THEN
      CALL cl_set_comp_entry("ed01",FALSE)
   END IF 
   
   IF g_apmp490_02_input.scb01 <> '1' AND g_apmp490_02_input.scb01 <> '5' THEN
      CALL cl_set_comp_entry("bt01",FALSE)
   END IF
END FUNCTION]]>
  </point>
  <point name="dialog.apmp490_02_display04" order="5" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
DIALOG apmp490_02_display04()
   DISPLAY ARRAY g_apmp490_02_qcba_d TO s_apmp490_02_detail4.* ATTRIBUTE(COUNT=g_d_cnt_p49002_04)
      BEFORE DISPLAY
         CALL FGL_SET_ARR_CURR(g_d_idx_p49002_04)
         #單身不連動, 所以進入單身時, 要重新顯示單身筆數
         #DISPLAY g_d_idx_i35001, g_d_cnt_i35001 TO FORMONLY.idx, FORMONLY.cnt 

      BEFORE ROW
         LET g_d_idx_p49002_04 = DIALOG.getCurrentRow("s_apmp490_02_detail4")
         #DISPLAY g_d_idx_p49001 TO FORMONLY.idx
         # 點的當筆放入g_appoint_idx中, 可讓雙擊直接進入指定筆
         LET g_appoint_idx = g_d_idx_p49002_04
   END DISPLAY
END DIALOG]]>
  </point>
  <point name="function.apmp490_02_b_fill_01" order="5" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 上方單身資料填充
# Memo...........:
# Usage..........: CALL apmp490_02_b_fill_01(p_wc)
# Input parameter: p_wc
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_b_fill_01(p_wc)
   DEFINE p_wc     STRING
   DEFINE l_sql    STRING
   DEFINE l_ac1    LIKE type_t.num5
   DEFINE l_success LIKE type_t.num5
   DEFINE l_rate    LIKE inaj_t.inaj014
   DEFINE l_pmdn_d  type_g_pmdn_d
   DEFINE l_imaf152 LIKE imaf_t.imaf152
   DEFINE l_wc      STRING 

   WHENEVER ERROR CONTINUE 

   IF g_apmp490_02_input.scb01 = '4' THEN        #主要供應商分配優先，餘量分配  
      IF cl_null(g_apmp490_02_input.ed01) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = ''
         LET g_errparam.code   = 'apm-00695'     #主要供應商分配優先，餘量分配時，主供應商分配限量不可為空！   
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         RETURN
      END IF

      IF g_apmp490_02_input.ed01 <= 0 THEN    #必輸不可空白，數量需>0  
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = ''
         LET g_errparam.code   = 'ade-00016' #數量不可小於等於0   
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         RETURN
      END IF
   END IF 
   
   IF g_apmp490_02_input.scb01 = '5' THEN        #指定單一供應商  
      IF cl_null(g_apmp490_02_input.bt01) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = ''
         LET g_errparam.code   = 'art-00282'     #供應商欄位不可為空！  
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         RETURN
      END IF

      #檢查供應商 
      IF NOT apmp490_02_pmdl004_chk(g_apmp490_02_input.bt01) THEN
         RETURN
      END IF

      #顯示供應商名稱說明 
      CALL apmp490_02_bt01_ref(g_apmp490_02_input.bt01) RETURNING g_apmp490_02_input.bt01_desc
      DISPLAY BY NAME g_apmp490_02_input.bt01_desc
   END IF

   DELETE FROM p490_02_pmdn_t;
   DELETE FROM p490_02_pmdb_t;

   UPDATE p490_01_pmdb_t SET applied_qty = '0'

   CALL g_pmdn_d.clear()

   IF g_apmp490_02_input.scb02 = '1' THEN        #依料件進行匯總  
      LET l_sql = "SELECT pmdb014,pmdb015,'',pmdb004,'','',pmdb005,'',pmdb007,'',SUM(qty),",
                  "       '','','','','','','','','','','','','','','',pmdb050,pmdbent,pmdbsite",
                  "  FROM p490_01_pmdb_t,imaf_t ",
                  " WHERE imafent = pmdbent ",
                  "   AND imafsite = pmdbsite ",
                  "   AND imaf001 = pmdb004 ",
                  " GROUP BY pmdb014,pmdb015,pmdb004,pmdb005,pmdb007,pmdb050,pmdbent,pmdbsite",
                  " ORDER BY pmdb004,pmdb005 "
   ELSE                                    
      LET l_sql = "SELECT pmdb014,pmdb015,'',pmdb004,'','',pmdb005,'',pmdb007,'',SUM(qty),",
                  "       pmdb030,'','','','','','','','','','','','','','',pmdb050,pmdbent,pmdbsite ",
                  "  FROM p490_01_pmdb_t,imaf_t ",
                  " WHERE imafent = pmdbent ",
                  "   AND imafsite = pmdbsite ",
                  "   AND imaf001 = pmdb004 ",
                  " GROUP BY pmdb014,pmdb015,pmdb004,pmdb005,pmdb007,pmdb030,pmdb050,pmdbent,pmdbsite",
                  " ORDER BY pmdb004,pmdb005 "
   END IF
   PREPARE apmp490_02_group_prep FROM l_sql
   DECLARE apmp490_02_group_curs CURSOR FOR apmp490_02_group_prep

   LET l_ac1 = 1 
   
   #ming 20150707 add ------------------------(S) 
   #錯誤訊息收集 
   CALL cl_err_collect_init()
   #ming 20150707 add ------------------------(E)

   FOREACH apmp490_02_group_curs INTO l_pmdn_d.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      IF g_apmp490_02_input.scb02 = '1' THEN               #依料件進行匯總的話  
         SELECT MIN(pmdb030) INTO l_pmdn_d.pmdn014_02_01   #如果需求日有不同的話  
           FROM p490_01_pmdb_t                             #就以最小的為主  
          WHERE pmdb004 = l_pmdn_d.pmdb004_02_01
      END IF

      LET l_pmdn_d.pmdn001_02_01 = l_pmdn_d.pmdb004_02_01  #料件編號  
      LET l_pmdn_d.pmdn002_02_01 = l_pmdn_d.pmdb005_02_01  #產品特徵    
      
      #取得產品特徵說明 
      CALL s_feature_description(l_pmdn_d.pmdb004_02_01,l_pmdn_d.pmdb005_02_01)
           RETURNING l_success,l_pmdn_d.pmdb005_02_01_desc
      CALL s_feature_description(l_pmdn_d.pmdn001_02_01,l_pmdn_d.pmdn002_02_01)
           RETURNING l_success,l_pmdn_d.pmdn002_02_01_desc

      #取得料件的採購單位 
      SELECT imaf143 INTO l_pmdn_d.pmdn006_02_01
        FROM imaf_t
       WHERE imafent = l_pmdn_d.pmdbent_02_01
         AND imafsite = l_pmdn_d.pmdbsite_02_01
         AND imaf001 = l_pmdn_d.pmdn001_02_01

      IF cl_null(l_pmdn_d.pmdn006_02_01) THEN
         LET l_pmdn_d.pmdn006_02_01 = l_pmdn_d.pmdb007_02_01
      END IF

      LET l_pmdn_d.pmdn007_02_01 = l_pmdn_d.qty_02_01
      IF l_pmdn_d.pmdb007_02_01 != l_pmdn_d.pmdn006_02_01 THEN
         #單位轉換 
         CALL apmp490_02_convert_qty(l_pmdn_d.pmdb004_02_01,     #料號  
                                     l_pmdn_d.pmdb007_02_01,     #來源單位  
                                     l_pmdn_d.pmdn006_02_01,     #目的單位  
                                     l_pmdn_d.pmdn007_02_01)     #數量  
              RETURNING l_pmdn_d.pmdn007_02_01
      END IF
      
      #參考單位 
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'Y' THEN
         SELECT imaf015 INTO l_pmdn_d.pmdn008_02_01
           FROM imaf_t
          WHERE imafent  = g_enterprise
            AND imafsite = g_site
            AND imaf001  = l_pmdn_d.pmdb004_02_01
         IF (NOT cl_null(l_pmdn_d.pmdn008_02_01)) AND
            (NOT cl_null(l_pmdn_d.pmdn001_02_01)) AND
            (NOT cl_null(l_pmdn_d.pmdn006_02_01)) THEN
            CALL apmp490_02_convert_qty(l_pmdn_d.pmdn001_02_01,l_pmdn_d.pmdn006_02_01,
                                        l_pmdn_d.pmdn008_02_01,l_pmdn_d.pmdn007_02_01)
                 RETURNING l_pmdn_d.pmdn009_02_01
            IF NOT cl_null(l_pmdn_d.pmdn009_02_01) THEN
               CALL apmp490_02_unit_round(l_pmdn_d.pmdn008_02_01,l_pmdn_d.pmdn009_02_01)
                    RETURNING l_pmdn_d.pmdn009_02_01
            END IF
         END IF
      END IF

      #如果aoos020中，設定使用採購計價單位 
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN
         #取料件的預設採購計價單位 
         SELECT imaf144 INTO l_pmdn_d.pmdn010_02_01
           FROM imaf_t
          WHERE imafent = g_enterprise
            AND imafsite = g_site
            AND imaf001 = l_pmdn_d.pmdb004_02_01 

         IF cl_null(l_pmdn_d.pmdn010_02_01) THEN
            LET l_pmdn_d.pmdn010_02_01 = l_pmdn_d.pmdn006_02_01
         END IF

         CALL apmp490_02_convert_qty(l_pmdn_d.pmdb004_02_01,l_pmdn_d.pmdn006_02_01,
                                     l_pmdn_d.pmdn010_02_01,l_pmdn_d.pmdn007_02_01)
              RETURNING l_pmdn_d.pmdn011_02_01
      ELSE
         #[C:計價單位] = 採購料號主檔的預設採購計價單位，若不使用採購計價單位時則此欄位=採購單位
         #[C:計價數量] = 採購數量*(採購單位與計價單位換算率)，若不使用採購計價單位時則此欄位=採購數量
         LET l_pmdn_d.pmdn010_02_01 = l_pmdn_d.pmdn006_02_01
         LET l_pmdn_d.pmdn011_02_01 = l_pmdn_d.pmdn007_02_01
      END IF

      CALL apmp490_02_get_imaal(l_pmdn_d.pmdb004_02_01)
           RETURNING l_pmdn_d.imaal003_02_01_1,l_pmdn_d.imaal004_02_01_1

      CALL apmp490_02_get_imaal(l_pmdn_d.pmdn001_02_01)
           RETURNING l_pmdn_d.imaal003_02_01_2,l_pmdn_d.imaal004_02_01_2 
           
      #取得請購單位說明 
      CALL s_desc_get_unit_desc(l_pmdn_d.pmdb007_02_01)
           RETURNING l_pmdn_d.pmdb007_02_01_desc

      #取得採購單位說明 
      CALL s_desc_get_unit_desc(l_pmdn_d.pmdn006_02_01)
           RETURNING l_pmdn_d.pmdn006_02_01_desc

      #取得參考單位說明 
      CALL s_desc_get_unit_desc(l_pmdn_d.pmdn008_02_01)
           RETURNING l_pmdn_d.pmdn008_02_01_desc

      #取得計價單位說明 
      CALL s_desc_get_unit_desc(l_pmdn_d.pmdn010_02_01)
           RETURNING l_pmdn_d.pmdn010_02_01_desc

      SELECT pmaal004 INTO l_pmdn_d.pmaal004_02_01
        FROM pmaal_t
       WHERE pmaalent = g_enterprise
         AND pmaal001 = l_pmdn_d.pmdl004_02_01
         AND pmaal002 = g_lang 

      #資料已經做完基本的分群了 
      #接下來要處理分配 
      #ming 應該要收集訊息 showmsg 
      CASE g_apmp490_02_input.scb01
         WHEN '1'     #依料件主檔設定  
            LET l_imaf152 = ''
            SELECT imaf152 INTO l_imaf152
              FROM imaf_t
             WHERE imafent = l_pmdn_d.pmdbent_02_01
               AND imafsite = l_pmdn_d.pmdbsite_02_01
               AND imaf001 = l_pmdn_d.pmdb004_02_01

            #因為imaf152有可能為空 所以如果無資料的話就預設為0.主要供應商，無限量 
            IF cl_null(l_imaf152) THEN
               LET l_imaf152 = '0'
            END IF

            CASE l_imaf152
               WHEN '0'    #主要供應商，無限量  
                  CALL apmp490_02_allot_0(l_pmdn_d.*)
               WHEN '1'    #依廠商分配  
                  CALL apmp490_02_allot_1(l_pmdn_d.*)
               WHEN '2'    #主要供應商分配優先，餘量分配  
                  CALL apmp490_02_allot_2(l_pmdn_d.*)
               WHEN '3'    #指定單一供應商  
                  CALL apmp490_02_allot_3(l_pmdn_d.*)

            END CASE
         WHEN '2'     #主要供應商，無限量  
            CALL apmp490_02_allot_0(l_pmdn_d.*) 
         WHEN '3'     #依廠商分配  
            CALL apmp490_02_allot_1(l_pmdn_d.*)
         WHEN '4'     #主要供應商分配優先，餘量分配  
            CALL apmp490_02_allot_2(l_pmdn_d.*)
         WHEN '5'     #指定單一供應商  
            CALL apmp490_02_allot_3(l_pmdn_d.*)
      END CASE

   END FOREACH 
   
   #ming 20150707 add ----------------------------(S)  
   CALL cl_err_collect_show() 
   #ming 20150707 add ----------------------------(E) 

   SELECT ADD_MONTHS(g_today,-g_mm) INTO g_date FROM DUAL

   LET l_wc = "pmdldocdt BETWEEN '",g_date,"' AND '",g_today,"' "
   CALL apmp490_02_b_fill_02(l_wc)
   LET l_wc = "pmdsdocdt BETWEEN '",g_date,"' AND '",g_today,"' "
   CALL apmp490_02_b_fill_03(l_wc)
   LET l_wc = "qcbadocdt BETWEEN '",g_date,"' AND '",g_today,"' "
   CALL apmp490_02_b_fill_04(l_wc)
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_b_fill_02" order="6" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 最近採購資料填充
# Memo...........:
# Usage..........: apmp490_02_b_fill_02(p_wc)
# Input parameter: p_wc
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_b_fill_02(p_wc)
   DEFINE p_wc     STRING
   DEFINE l_sql    STRING
   DEFINE l_ac1    LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   IF g_d_idx_p49002_01 = 0 THEN
      LET g_d_idx_p49002_01 = 1
   END IF

   CALL g_apmp490_02_pmdn_d.clear()

   LET l_sql = "SELECT pmdl004,'',pmdldocno,pmdldocdt,pmdl009, ",
               "       pmdl010,pmdl011,pmdl012,pmdl013,pmdl015, ",
               "       pmdl016,pmdn007,pmdn015,pmdn040 ",
               "  FROM pmdl_t,pmdn_t ",
               " WHERE pmdlent = pmdnent ",
               "   AND pmdlsite = pmdnsite ",
               "   AND pmdldocno = pmdndocno ",
               "   AND pmdlent = '",g_enterprise,"' ",
               "   AND pmdlsite = '",g_site,"' ",
               "   AND pmdn001 = '",g_pmdn_d[g_d_idx_p49002_01].pmdb004_02_01,"' ",
               "   AND ",p_wc

   PREPARE apmp490_02_b_fill_prep01 FROM l_sql
   DECLARE apmp490_02_b_fill_curs01 CURSOR FOR apmp490_02_b_fill_prep01 

   LET l_ac1 = 1
   FOREACH apmp490_02_b_fill_curs01 INTO g_apmp490_02_pmdn_d[l_ac1].*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      #取得供應商名稱 
      CALL apmp490_02_get_pmaal004(g_apmp490_02_pmdn_d[l_ac1].pmdl004_02_02)
           RETURNING g_apmp490_02_pmdn_d[l_ac1].pmaal004_02_02

      LET l_ac1 = l_ac1 + 1

      IF l_ac1 > g_max_rec THEN
         EXIT FOREACH
      END IF

   END FOREACH

   CALL g_apmp490_02_pmdn_d.deleteElement(l_ac1)
   LET l_ac1 = l_ac1 - 1
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_b_fill_03" order="7" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 最近收貨資料填充
# Memo...........:
# Usage..........: CALL apmp490_02_b_fill_03(p_wc)
# Input parameter: p_wc
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_b_fill_03(p_wc)
   DEFINE p_wc     STRING
   DEFINE l_sql    STRING
   DEFINE l_ac1    LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   IF g_d_idx_p49002_01 = 0 THEN
      LET g_d_idx_p49002_01 = 1
   END IF

   CALL g_apmp490_02_pmds_d.clear()

   LET l_sql = "SELECT pmds009,'',pmdsdocno,pmdo013,pmdsdocdt,'','' ",
               "  FROM pmds_t,pmdt_t,pmdo_t ",
               " WHERE pmdsent   = pmdtent ",
               "   AND pmdssite  = pmdtsite ",
               "   AND pmdsdocno = pmdtdocno ",
               "   AND pmdoent   = pmdtent ",
               "   AND pmdosite  = pmdtsite ",
               "   AND pmdodocno = pmdt001 ",       #採購單號  
               "   AND pmdoseq   = pmdt002 ",       #採購項次  
               "   AND pmdoseq1  = pmdt003 ",       #採購項序 
               "   AND pmdoseq2  = pmdt004 ",       #分批序  
               "   AND pmdsent   = '",g_enterprise,"' ",
               "   AND pmdssite  = '",g_site,"' ",
               "   AND pmdt006   = '",g_pmdn_d[g_d_idx_p49002_01].pmdb004_02_01,"' ",
               "   AND ",p_wc

   PREPARE apmp490_02_b_fill_prep02 FROM l_sql
   DECLARE apmp490_02_b_fill_curs02 CURSOR FOR apmp490_02_b_fill_prep02

   LET l_ac1 = 1 
   FOREACH apmp490_02_b_fill_curs02 INTO g_apmp490_02_pmds_d[l_ac1].*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      #取得供應商名稱 
      CALL apmp490_02_get_pmaal004(g_apmp490_02_pmds_d[l_ac1].pmds009_02_03)
           RETURNING g_apmp490_02_pmds_d[l_ac1].pmaal004_02_03 
           
      LET g_apmp490_02_pmds_d[l_ac1].diff_day_02_03 = g_apmp490_02_pmds_d[l_ac1].pmdsdocdt_02_03 -
                                                      g_apmp490_02_pmds_d[l_ac1].pmdo013_02_03

      CASE
         #採購交貨日期 > 收貨日期 
         WHEN g_apmp490_02_pmds_d[l_ac1].pmdo013_02_03 > g_apmp490_02_pmds_d[l_ac1].pmdsdocdt_02_03
            LET g_apmp490_02_pmds_d[l_ac1].stus_02_03 = cl_getmsg("apm-00696",g_lang)     #提前交貨 

         #採購交貨日期 = 收貨日期 
         WHEN g_apmp490_02_pmds_d[l_ac1].pmdo013_02_03 = g_apmp490_02_pmds_d[l_ac1].pmdsdocdt_02_03
            LET g_apmp490_02_pmds_d[l_ac1].stus_02_03 = cl_getmsg("apm-00697",g_lang)     #正常交貨 

         #採購交貨日期 < 收貨日期 
         WHEN g_apmp490_02_pmds_d[l_ac1].pmdo013_02_03 < g_apmp490_02_pmds_d[l_ac1].pmdsdocdt_02_03
            LET g_apmp490_02_pmds_d[l_ac1].stus_02_03 = cl_getmsg("apm-00698",g_lang)     #延誤交貨 

         OTHERWISE
            EXIT CASE
      END CASE

      LET l_ac1 = l_ac1 + 1

      IF l_ac1 > g_max_rec THEN
         EXIT FOREACH
      END IF

   END FOREACH

   CALL g_apmp490_02_pmds_d.deleteElement(l_ac1)
   LET l_ac1 = l_ac1 - 1
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_b_fill_04" order="8" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 最近檢驗資料填充
# Memo...........:
# Usage..........: CALL apmp490_02_b_fill_04(p_wc)
# Input parameter: p_wc
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_b_fill_04(p_wc)
   DEFINE p_wc     STRING
   DEFINE l_sql    STRING
   DEFINE l_ac1    LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   IF g_d_idx_p49002_01 = 0 THEN
      LET g_d_idx_p49002_01 = 1
   END IF

   CALL g_apmp490_02_qcba_d.clear()

   LET l_sql = "SELECT qcba005,'',qcbadocno,qcba014,'',qcba018,qcba019, ",
               "       qcba017,qcba022,qcba023 ",
               "  FROM qcba_t ",
               " WHERE qcbaent = '",g_enterprise,"' ",
               "   AND qcbasite = '",g_site,"' ",
               "   AND qcba010 = '",g_pmdn_d[g_d_idx_p49002_01].pmdb004_02_01,"' ",
               "   AND ",p_wc

   PREPARE apmp490_02_b_fill_prep03 FROM l_sql
   DECLARE apmp490_02_b_fill_curs03 CURSOR FOR apmp490_02_b_fill_prep03

   LET l_ac1 = 1
   FOREACH apmp490_02_b_fill_curs03 INTO g_apmp490_02_qcba_d[l_ac1].*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      #取得供應商名稱 
      CALL apmp490_02_get_pmaal004(g_apmp490_02_qcba_d[l_ac1].qcba005_02_04)
           RETURNING g_apmp490_02_qcba_d[l_ac1].pmaal004_02_04 
           
      #取得檢驗水準 
      SELECT imae116 INTO g_apmp490_02_qcba_d[l_ac1].imae116_02_04
        FROM imaa_t LEFT OUTER JOIN imae_t ON imaeent  = imaaent
                                          AND imaesite = g_site
                                          AND imae001  = imaa001
       WHERE imaaent = g_enterprise
         AND imaa001 = g_pmdn_d[g_d_idx_p49002_01].pmdb004_02_01

      LET l_ac1 = l_ac1 + 1

      IF l_ac1 > g_max_rec THEN
         EXIT FOREACH
      END IF

   END FOREACH

   CALL g_apmp490_02_qcba_d.deleteElement(l_ac1)
   LET l_ac1 = l_ac1 - 1
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_allot_0" order="9" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 主要供應商，無限量
# Memo...........:
# Usage..........: CALL apmp490_02_allot_0(p_pmdn_d)
# Input parameter: p_pmdn_d:整個pmdn_file 
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_allot_0(p_pmdn_d)
   DEFINE p_pmdn_d         type_g_pmdn_d
   DEFINE l_ac1            LIKE type_t.num5 
   DEFINE l_success        LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   LET l_ac1 = g_pmdn_d.getLength() + 1

   LET g_pmdn_d[l_ac1].* = p_pmdn_d.*

   #如果沒有主要供應商的話  整列顏色變紅色 並且要有錯誤訊息  

   IF cl_null(g_pmdn_d[l_ac1].pmdl004_02_01) THEN
      SELECT imaf153 INTO g_pmdn_d[l_ac1].pmdl004_02_01
        FROM imaf_t
       WHERE imafent = p_pmdn_d.pmdbent_02_01
         AND imafsite = p_pmdn_d.pmdbsite_02_01
         AND imaf001 = p_pmdn_d.pmdb004_02_01

      #取得供應商簡稱 
      CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
           RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
   END IF 
   
   #ming --(S) 
   #整列變紅的部分先拿掉好了  感覺有些奇怪   
   #IF cl_null(g_pmdn_d[l_ac1].pmdl004_02_01) THEN 
   #   CALL apmp490_02_pmdn_set_color(l_ac1) 
   #END IF 
   #ming --(E) 

   CALL apmp490_02_ins_pmdb(l_ac1,g_pmdn_d[l_ac1].pmdb004_02_01,
                            g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdn050_02_01,
                            g_pmdn_d[l_ac1].qty_02_01)
        RETURNING l_success

   IF l_success THEN
      INSERT INTO p490_02_pmdn_t(pmdl004,pmdb004,pmdb005,pmdb007,qty,
                                 pmdn014,pmdn001,pmdn002,pmdn006,pmdn007,
                                 pmdn008,pmdn009,pmdn010,
                                 pmdn011,pmdn050,pmdbent,pmdbsite,link_no)
                          VALUES(g_pmdn_d[l_ac1].pmdl004_02_01,g_pmdn_d[l_ac1].pmdb004_02_01,
                                 g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdb007_02_01,
                                 g_pmdn_d[l_ac1].qty_02_01    ,g_pmdn_d[l_ac1].pmdn014_02_01,
                                 g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01,
                                 g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01,
                                 g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01,
                                 g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01, 
                                 g_pmdn_d[l_ac1].pmdn050_02_01,
                                 g_pmdn_d[l_ac1].pmdbent_02_01,g_pmdn_d[l_ac1].pmdbsite_02_01,
                                 l_ac1)
   END IF
   
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_allot_1" order="10" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 依廠商分配
# Memo...........:
# Usage..........: CALL apmp490_02_allot_1(p_pmdn_d)
# Input parameter: p_pmdn_d:整個pmdn_file 
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_allot_1(p_pmdn_d)
   DEFINE p_pmdn_d         type_g_pmdn_d
   DEFINE l_ac1            LIKE type_t.num5
   DEFINE l_pmao008_sum    LIKE pmao_t.pmao008
   DEFINE l_pmao008        LIKE pmao_t.pmao008
   DEFINE l_sql            STRING
   DEFINE l_pmao001        LIKE pmao_t.pmao001 
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_rate           LIKE inaj_t.inaj014

   WHENEVER ERROR CONTINUE 

   #pmao008:分配比率 
   #先算出此料的總比率 
   LET l_pmao008_sum = 0
   SELECT SUM(pmao008) INTO l_pmao008_sum
     FROM pmao_t
    WHERE pmaoent = p_pmdn_d.pmdbent_02_01
      AND pmao002 = p_pmdn_d.pmdb004_02_01                    #料件編號  
      AND NVL(pmao003,' ') = NVL(p_pmdn_d.pmdb005_02_01,' ')  #產品特徵 

   IF cl_null(l_pmao008_sum) THEN
      LET l_pmao008_sum = 0
   END IF

   #ming l_pamo008_sum有沒有可能真的會是0 是0的話應該要算錯   
   IF l_pmao008_sum = 0 THEN 
      #ming 20150707 add ------------------------------------(S) 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 'apm-00969'     #料件編號%1之分配比率總合不可為0！ 
      LET g_errparam.popup  = TRUE
      LET g_errparam.replace[1] = p_pmdn_d.pmdb004_02_01
      CALL cl_err()
      #ming 20150707 add ------------------------------------(E) 
      RETURN 
   END IF 

   #再看供應商可分配多少比率 
   LET l_sql = "SELECT pmao001,pmao008 ",
               "  FROM pmao_t ",
               " WHERE pmaoent = '",p_pmdn_d.pmdbent_02_01,"' ",
               "   AND pmao002 = '",p_pmdn_d.pmdb004_02_01,"' ",
               "   AND NVL(pmao003,' ') = NVL('",p_pmdn_d.pmdb005_02_01,"',' ') " 
   PREPARE apmp490_02_pmao_prep_1 FROM l_sql
   DECLARE apmp490_02_pmao_curs_1 CURSOR FOR apmp490_02_pmao_prep_1

   LET l_ac1 = g_pmdn_d.getLength() + 1

   FOREACH apmp490_02_pmao_curs_1 INTO l_pmao001,l_pmao008
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      LET g_pmdn_d[l_ac1].* = p_pmdn_d.*
      
      LET g_pmdn_d[l_ac1].pmdl004_02_01 = l_pmao001 
      #取得供應商簡稱 
      CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
           RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
      LET g_pmdn_d[l_ac1].pmdn007_02_01 = p_pmdn_d.pmdn007_02_01 * l_pmao008 / l_pmao008_sum 
      
      #參考單位與數量 
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'Y' THEN
         SELECT imaf015 INTO g_pmdn_d[l_ac1].pmdn008_02_01
           FROM imaf_t
          WHERE imafent  = g_enterprise
            AND imafsite = g_site
            AND imaf001  = g_pmdn_d[l_ac1].pmdb004_02_01
         IF (NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01)) AND
            (NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01)) AND
            (NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01)) THEN
            CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                        g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
               CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                    RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
            END IF
         END IF
      END IF
      
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = 'Y' THEN
         #取料件的預設採購計價單位 
         SELECT imaf144 INTO g_pmdn_d[l_ac1].pmdn010_02_01
           FROM imaf_t
          WHERE imafent  = g_enterprise
            AND imafsite = g_site
            AND imaf001  = g_pmdn_d[l_ac1].pmdb004_02_01

         IF cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
            LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_pmdn_d[l_ac1].pmdn006_02_01
         END IF

         CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                     g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
              RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
      ELSE
         #[C:計價單位] = 採購料號主檔的預設採購計價單位，若不使用採購計價單位時則此欄位=採購單位
         #[C:計價數量] = 採購數量*(採購單位與計價單位換算率)，若不使用採購計價單位時則此欄位=採購數量
         LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_pmdn_d[l_ac1].pmdn006_02_01
         LET g_pmdn_d[l_ac1].pmdn011_02_01 = g_pmdn_d[l_ac1].pmdn007_02_01
      END IF

      CALL apmp490_02_ins_pmdb(l_ac1,g_pmdn_d[l_ac1].pmdb004_02_01,
                               g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdn050_02_01, 
                               g_pmdn_d[l_ac1].pmdn007_02_01)
           RETURNING l_success
      IF l_success THEN
         INSERT INTO p490_02_pmdn_t(pmdl004,pmdb004,pmdb005,pmdb007,qty,
                                    pmdn014,pmdn001,pmdn002,pmdn006,pmdn007,
                                    pmdn008,pmdn009,pmdn010,
                                    pmdn011,pmdn050,pmdbent,pmdbsite,link_no)
                             VALUES(g_pmdn_d[l_ac1].pmdl004_02_01,g_pmdn_d[l_ac1].pmdb004_02_01,
                                    g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdb007_02_01,
                                    g_pmdn_d[l_ac1].qty_02_01    ,g_pmdn_d[l_ac1].pmdn014_02_01,
                                    g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01,
                                    g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01,
                                    g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01,
                                    g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01, 
                                    g_pmdn_d[l_ac1].pmdn050_02_01,
                                    g_pmdn_d[l_ac1].pmdbent_02_01,g_pmdn_d[l_ac1].pmdbsite_02_01,
                                    l_ac1)
         LET l_ac1 = l_ac1 + 1 
      END IF      

   END FOREACH

   #ming 是否要考慮尾差的部分？ 
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_allot_2" order="11" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 主要供應商分配優先，餘量分配
# Memo...........:
# Usage..........: CALLapmp490_02_allot_2(p_pmdn_d)
# Input parameter: p_pmdn_d:整個pmdn_file 
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_allot_2(p_pmdn_d)
   DEFINE p_pmdn_d         type_g_pmdn_d
   DEFINE l_ac1            LIKE type_t.num5
   DEFINE l_max_qty        LIKE imaf_t.imaf154
   DEFINE l_imaf153        LIKE imaf_t.imaf153
   DEFINE l_imaf154        LIKE imaf_t.imaf154
   DEFINE l_pmao008_sum    LIKE pmao_t.pmao008
   DEFINE l_pmao008        LIKE pmao_t.pmao008
   DEFINE l_pmao001        LIKE pmao_t.pmao001
   DEFINE l_sql            STRING 
   DEFINE l_rate           LIKE inaj_t.inaj014
   DEFINE l_success        LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   #l_max_qty:主要供應商可分配數量的最大限度 
   #imaf153  :主要供應商 
   #imaf154  :主供應商分配限量 
   LET l_max_qty = 0
   SELECT imaf153,imaf154 INTO l_imaf153,l_imaf154
     FROM imaf_t
    WHERE imafent = p_pmdn_d.pmdbent_02_01
      AND imafsite = p_pmdn_d.pmdbsite_02_01
      AND imaf001 = p_pmdn_d.pmdb004_02_01
   
   #分配限量的值從何而來 如果不是依料件主檔而來的話 則從畫面上設定
   IF g_apmp490_02_input.scb02 = '1' THEN    #依料件主檔設定   
      LET l_max_qty = l_imaf154
   ELSE
      LET l_max_qty = g_apmp490_02_input.ed01
   END IF

   LET l_ac1 = g_pmdn_d.getLength() + 1
   LET g_pmdn_d[l_ac1].* = p_pmdn_d.* 
   
   IF NOT cl_null(g_pmdn_d[l_ac1].pmdl004_02_01) THEN
      LET l_imaf153 = g_pmdn_d[l_ac1].pmdl004_02_01
   END IF 
   
   #第一筆資料的供應商應該是料件的主要供應商 
   LET g_pmdn_d[l_ac1].pmdl004_02_01 = l_imaf153
   #取得供應商簡稱 
   CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
        RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
   
   #如果採購數量是200 分配限量是120 則把採購數量修改為120 
   #否則則不改變 
   IF g_pmdn_d[l_ac1].pmdn007_02_01 > l_max_qty THEN
      LET g_pmdn_d[l_ac1].pmdn007_02_01 = l_max_qty
      LET p_pmdn_d.pmdn007_02_01 = p_pmdn_d.pmdn007_02_01 - l_max_qty
   END IF 
   
   #重新計算參考單位與數量 
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'Y' THEN
      SELECT imaf015 INTO g_pmdn_d[l_ac1].pmdn008_02_01
        FROM imaf_t
       WHERE imafent  = g_enterprise
         AND imafsite = g_site
         AND imaf001 = g_pmdn_d[l_ac1].pmdb004_02_01
      IF (NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01)) AND
         (NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01)) AND
         (NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01)) THEN
         CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                     g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
              RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
         IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
            CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
         END IF
      END IF
   END IF
   
   #需要重新計算計價數量 
   #如果aoos020中，設定使用採購計價單位 
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN
      #取料件的預設採購計價單位 
      SELECT imaf144 INTO g_pmdn_d[l_ac1].pmdn010_02_01
        FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite = g_site
         AND imaf001 = g_pmdn_d[l_ac1].pmdb004_02_01

      IF cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
         LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_pmdn_d[l_ac1].pmdn006_02_01
      END IF

      CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                  g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
           RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
   ELSE
      #[C:計價單位] = 採購料號主檔的預設採購計價單位，若不使用採購計價單位時則此欄位=採購單位
      #[C:計價數量] = 採購數量*(採購單位與計價單位換算率)，若不使用採購計價單位時則此欄位=採購數量
      LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_pmdn_d[l_ac1].pmdn006_02_01
      LET g_pmdn_d[l_ac1].pmdn011_02_01 = g_pmdn_d[l_ac1].pmdn007_02_01
   END IF 
     
   CALL apmp490_02_ins_pmdb(l_ac1,g_pmdn_d[l_ac1].pmdb004_02_01,
                            g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdn050_02_01,
                            g_pmdn_d[l_ac1].qty_02_01)
        RETURNING l_success

   IF l_success THEN
      INSERT INTO p490_02_pmdn_t(pmdl004,pmdb004,pmdb005,pmdb007,qty,
                                    pmdn014,pmdn001,pmdn002,pmdn006,pmdn007,
                                    pmdn008,pmdn009,pmdn010,
                                    pmdn011,pmdn050,pmdbent,pmdbsite,link_no)
                             VALUES(g_pmdn_d[l_ac1].pmdl004_02_01,g_pmdn_d[l_ac1].pmdb004_02_01,
                                    g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdb007_02_01,
                                    g_pmdn_d[l_ac1].qty_02_01    ,g_pmdn_d[l_ac1].pmdn014_02_01,
                                    g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01,
                                    g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01,
                                    g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01,
                                    g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01, 
                                    g_pmdn_d[l_ac1].pmdn050_02_01,
                                    g_pmdn_d[l_ac1].pmdbent_02_01,g_pmdn_d[l_ac1].pmdbsite_02_01,
                                    l_ac1)
      LET l_ac1 = l_ac1 + 1
   END IF

   LET l_pmao008_sum = 0
   SELECT SUM(pmao008) INTO l_pmao008_sum
     FROM pmao_t
    WHERE pmaoent = p_pmdn_d.pmdbent_02_01
      AND pmao002 = p_pmdn_d.pmdb004_02_01
      AND NVL(pmao003,' ') = NVL(p_pmdn_d.pmdb005_02_01,' ')
      AND pmao001 <> l_imaf153

   IF cl_null(l_pmao008_sum) THEN
      LET l_pmao008_sum = 0
   END IF

   #ming l_pamo008_sum有沒有可能真的會是0 是0的話應該要算錯? 
   IF l_pmao008_sum = 0 THEN  
      #分配比率總合不可為0    #ming 
      RETURN 
   END IF 

   LET l_sql = "SELECT pmao001,pmao008 ",
               "  FROM pmao_t ",
               " WHERE pmaoent = '",p_pmdn_d.pmdbent_02_01,"' ",
               "   AND pmao002 = '",p_pmdn_d.pmdb004_02_01,"' ",
               "   AND NVL(pmao003,' ') = NVL('",p_pmdn_d.pmdb005_02_01,"',' ') ",
               "   AND pmao001 <> '",l_imaf153,"' "
   PREPARE apmp490_02_pmao_prep_2 FROM l_sql
   DECLARE apmp490_02_pmao_curs_2 CURSOR FOR apmp490_02_pmao_prep_2 
   
   FOREACH apmp490_02_pmao_curs_2 INTO l_pmao001,l_pmao008
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      LET g_pmdn_d[l_ac1].* = p_pmdn_d.*
      LET g_pmdn_d[l_ac1].pmdl004_02_01 = l_pmao001 
      #取得供應商簡稱 
      CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
           RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
      LET g_pmdn_d[l_ac1].pmdn007_02_01 = p_pmdn_d.pmdn007_02_01 * l_pmao008 / l_pmao008_sum  
      
      #重新計算參考單位與數量 
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'Y' THEN
         SELECT imaf015 INTO g_pmdn_d[l_ac1].pmdn008_02_01
           FROM imaf_t
          WHERE imafent  = g_enterprise
            AND imafsite = g_site
            AND imaf001  = g_pmdn_d[l_ac1].pmdb004_02_01
         IF (NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01)) AND
            (NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01)) AND
            (NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01)) THEN
            CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                        g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
               CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                    RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
            END IF
         END IF
      END IF
      
      #需要重新計算計價數量 
      #如果aoos020中，設定使用採購計價單位 
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN
         #取料件的預設採購計價單位 
         SELECT imaf144 INTO g_pmdn_d[l_ac1].pmdn010_02_01
           FROM imaf_t
          WHERE imafent = g_enterprise
            AND imafsite = g_site
            AND imaf001 = g_pmdn_d[l_ac1].pmdb004_02_01

         IF cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
            LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_pmdn_d[l_ac1].pmdn006_02_01
         END IF

         CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                     g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
              RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
      ELSE
         #[C:計價單位] = 採購料號主檔的預設採購計價單位，若不使用採購計價單位時則此欄位=採購單位
         #[C:計價數量] = 採購數量*(採購單位與計價單位換算率)，若不使用採購計價單位時則此欄位=採購數量
         LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_pmdn_d[l_ac1].pmdn006_02_01
         LET g_pmdn_d[l_ac1].pmdn011_02_01 = g_pmdn_d[l_ac1].pmdn007_02_01
      END IF

      CALL apmp490_02_ins_pmdb(l_ac1,g_pmdn_d[l_ac1].pmdb004_02_01,
                               g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdn050_02_01,
                               g_pmdn_d[l_ac1].qty_02_01)
           RETURNING l_success

      IF l_success THEN
         INSERT INTO p490_02_pmdn_t(pmdl004,pmdb004,pmdb005,pmdb007,qty,
                                    pmdn014,pmdn001,pmdn002,pmdn006,pmdn007,
                                    pmdn008,pmdn009,pmdn010,
                                    pmdn011,pmdn050,pmdbent,pmdbsite,link_no)
                             VALUES(g_pmdn_d[l_ac1].pmdl004_02_01,g_pmdn_d[l_ac1].pmdb004_02_01,
                                    g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdb007_02_01,
                                    g_pmdn_d[l_ac1].qty_02_01    ,g_pmdn_d[l_ac1].pmdn014_02_01,
                                    g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01,
                                    g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01,
                                    g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01,
                                    g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01, 
                                    g_pmdn_d[l_ac1].pmdn050_02_01,
                                    g_pmdn_d[l_ac1].pmdbent_02_01,g_pmdn_d[l_ac1].pmdbsite_02_01,
                                    l_ac1)
         LET l_ac1 = l_ac1 + 1
      END IF
      
   END FOREACH

   #ming 是否要考慮尾差的部分？ 
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_allot_3" order="12" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 指定單一供應商
# Memo...........:
# Usage..........: CALL apmp490_02_allot_3(p_pmdn_d)
# Input parameter: p_pmdn_d:整個pmdn_file
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_allot_3(p_pmdn_d)
   DEFINE p_pmdn_d         type_g_pmdn_d
   DEFINE l_ac1            LIKE type_t.num5 
   DEFINE l_success        LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   LET l_ac1 = g_pmdn_d.getLength() + 1
   LET g_pmdn_d[l_ac1].* = p_pmdn_d.*

   LET g_pmdn_d[l_ac1].pmdl004_02_01 = g_apmp490_02_input.bt01 
   
   #取得供應商簡稱 
   CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
        RETURNING g_pmdn_d[l_ac1].pmaal004_02_01

   CALL apmp490_02_ins_pmdb(l_ac1,g_pmdn_d[l_ac1].pmdb004_02_01,
                            g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdn050_02_01,
                            g_pmdn_d[l_ac1].qty_02_01)
        RETURNING l_success

   IF l_success THEN
      INSERT INTO p490_02_pmdn_t(pmdl004,pmdb004,pmdb005,pmdb007,qty,
                                 pmdn014,pmdn001,pmdn002,pmdn006,pmdn007,
                                 pmdn008,pmdn009,pmdn010,
                                 pmdn011,pmdn050,pmdbent,pmdbsite,link_no) 
                          VALUES(g_pmdn_d[l_ac1].pmdl004_02_01,g_pmdn_d[l_ac1].pmdb004_02_01,
                                 g_pmdn_d[l_ac1].pmdb005_02_01,g_pmdn_d[l_ac1].pmdb007_02_01,
                                 g_pmdn_d[l_ac1].qty_02_01    ,g_pmdn_d[l_ac1].pmdn014_02_01,
                                 g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01,
                                 g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01,
                                 g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01,
                                 g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01, 
                                 g_pmdn_d[l_ac1].pmdn050_02_01,
                                 g_pmdn_d[l_ac1].pmdbent_02_01,g_pmdn_d[l_ac1].pmdbsite_02_01,
                                 l_ac1)
   END IF

END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_pmdn_set_color" order="13" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 設定欄位變色
# Memo...........:
# Usage..........: CALL apmp490_02_pmdn_set_color(p_ac)
# Input parameter: p_ac
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_pmdn_set_color(p_ac)
   DEFINE p_ac     LIKE type_t.num5

   WHENEVER ERROR CONTINUE 

   LET g_apmp490_02_pmdn_color_d[p_ac].pmdl004 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdb004 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdb005 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdb007 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].qty     = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn014 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn001 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn002 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn006 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn007 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn010 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdn011 = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdbent = 'red'
   LET g_apmp490_02_pmdn_color_d[p_ac].pmdbsite = 'red'
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_create_temp_table" order="14" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 建立temp table 
# Memo...........:
# Usage..........: CALL apmp490_02_create_temp_table()
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_create_temp_table()

   WHENEVER ERROR CONTINUE 

   CREATE TEMP TABLE p490_02_pmdn_t(
      pmdl004        LIKE pmdl_t.pmdl004,      #供應商  
      pmdb004        LIKE pmdb_t.pmdb004,      #請購料號  
      pmdb005        LIKE pmdb_t.pmdb005,      #請購產品特徵  
      pmdb007        LIKE pmdb_t.pmdb007,      #請購單位  
      qty            LIKE pmdb_t.pmdb006,      #未轉採購量  
      pmdn014        LIKE pmdn_t.pmdn014,      #到庫日期  
      pmdn001        LIKE pmdn_t.pmdn001,      #採購料號  
      pmdn002        LIKE pmdn_t.pmdn002,      #採購產品特徵  
      pmdn006        LIKE pmdn_t.pmdn006,      #採購單位  
      pmdn007        LIKE pmdn_t.pmdn007,      #採購數量  
      pmdn008        LIKE pmdn_t.pmdn008,      #參考單位 
      pmdn009        LIKE pmdn_t.pmdn009,      #參考數量 
      pmdn010        LIKE pmdn_t.pmdn010,      #計價單位  
      pmdn011        LIKE pmdn_t.pmdn011,      #計價數量  
      pmdn050        LIKE pmdn_t.pmdn050,      #備註   
      pmdbent        LIKE pmdb_t.pmdbent,
      pmdbsite       LIKE pmdb_t.pmdbsite,
      link_no        LIKE type_t.num10         #序號   
   ) 
   
   #新請購底稿資料  
   CREATE TEMP TABLE p490_02_pmdb_t(
      link_no        LIKE type_t.num10,        #序號 用來與採購底稿關聯的 
      pmdbdocno      LIKE pmdb_t.pmdbdocno,    #請購單號 
      pmdbseq        LIKE pmdb_t.pmdbseq,      #項次 
      pmdb004        LIKE pmdb_t.pmdb004,      #請購料號 
      pmdb005        LIKE pmdb_t.pmdb005,      #產品特徵 
      pmdb007        LIKE pmdb_t.pmdb007,      #單位  
      pmdb006        LIKE pmdb_t.pmdb006,      #需求數量   
      qty            LIKE pmdb_t.pmdb006,      #未轉採購量  #也代表 被分配的數量  
      pmdb030        LIKE pmdb_t.pmdb030,      #需求日期 
      pmdb033        LIKE pmdb_t.pmdb033,      #緊急度 
      pmdb014        LIKE pmdb_t.pmdb014,      #供應商選擇 
      pmdb015        LIKE pmdb_t.pmdb015,      #供應商編號  
      pmdb050        LIKE pmdb_t.pmdb050       #備註        
   )
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_drop_temp_table" order="15" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 刪除temp table 
# Memo...........:
# Usage..........: CALL apmp490_02_drop_temp_table()
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_drop_temp_table()
   
   WHENEVER ERROR CONTINUE 
   
   DROP TABLE p490_02_pmdn_t;
   DROP TABLE p490_02_pmdb_t;
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_ins_pmdl_t" order="16" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 建立第三頁所需的單頭資料
# Memo...........:
# Usage..........: CALL apmp490_02_ins_pmdl_t()
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_ins_pmdl_t()
   DEFINE l_sql       STRING
   DEFINE l_pmdl004   LIKE pmdl_t.pmdl004
   DEFINE l_flag      LIKE type_t.num5
   DEFINE l_pmal002   LIKE pmal_t.pmal002    #控制組編號   

   DEFINE l_pmdl009   LIKE pmdl_t.pmdl009    #付款條件  
   DEFINE l_pmdl010   LIKE pmdl_t.pmdl010    #交易條件  
   DEFINE l_pmdl011   LIKE pmdl_t.pmdl011    #稅別  
   DEFINE l_pmdl012   LIKE pmdl_t.pmdl012    #稅率  
   DEFINE l_pmdl013   LIKE pmdl_t.pmdl013    #單價含稅否  
   DEFINE l_pmdl015   LIKE pmdl_t.pmdl015    #幣別  
   DEFINE l_pmdl016   LIKE pmdl_t.pmdl016    #匯率  
   DEFINE l_pmdl017   LIKE pmdl_t.pmdl017    #取價方式  
   DEFINE l_pmdl023   LIKE pmdl_t.pmdl023    #採購通路 
   DEFINE l_pmdl054   LIKE pmdl_t.pmdl054    #內外購  
   DEFINE l_pmdl033   LIKE pmdl_t.pmdl033    #發票類型 
   DEFINE l_pmdl055   LIKE pmdl_t.pmdl055    #匯率計算基礎 

   DEFINE l_ooef016   LIKE ooef_t.ooef016
   
   WHENEVER ERROR CONTINUE 

   #將第三步的temp table清空 以免資料不斷的寫入 
   DELETE FROM p490_03_pmdl_t;

   #第二步到第三步的過程 要以供應商做分群，每個供應商都是一個採購單的單頭 相同供應商的資料則為單身資料  
   LET l_sql = "SELECT pmdl004 ",
               "  FROM p490_02_pmdn_t ",
               " GROUP BY pmdl004 "
   PREPARE apmp490_02_ins_pmdl_prep FROM l_sql
   DECLARE apmp490_02_ins_pmdl_curs CURSOR FOR apmp490_02_ins_pmdl_prep 
   
   #pmal_t:採購控制組供應商預設條件檔 
   #pmal002:控制組編號 
   #pmal003:慣用交易幣別 
   #pmal004:慣用稅務規則 
   #pmal006:慣用付款條件  
   #pmal020:慣用交易條件  
   #pmal021:慣用取價方式  
   #pmal008:慣用採購通路 
   #pmal023:慣用內外購 
   #pmal022:慣用發票類型 
   #pmal024:慣用匯率計算基準
   LET l_sql = "SELECT pmal002,pmal003,pmal004,pmal006,pmal020,pmal021, ",
               "       pmal008,pmal023,pmal022,pmal024  ",
               "  FROM pmal_t ",
               " WHERE pmalent = '",g_enterprise,"' ",
               "   AND pmalstus = 'Y' ",
               "   AND pmal001 = ? ",  
               "   AND pmal002 = '",g_controlno,"' "     #控制組編號  
   PREPARE apmp490_02_get_pmal_prep FROM l_sql
   DECLARE apmp490_02_get_pmal_curs CURSOR FOR apmp490_02_get_pmal_prep

   FOREACH apmp490_02_ins_pmdl_curs INTO l_pmdl004
      IF STATUS THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = STATUS
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      #用供應商找是否有控制組的資料 apmi110  
      LET l_pmal002 = ''         #控制組編號 
      LET l_pmdl009 = ''         #付款條件  
      LET l_pmdl010 = ''         #交易條件  
      LET l_pmdl011 = ''         #稅別  
      LET l_pmdl012 = ''         #稅率 
      LET l_pmdl013 = ''         #單價含稅否  
      LET l_pmdl015 = ''         #幣別  
      LET l_pmdl017 = ''         #取價方式    
      LET l_pmdl023 = ''         #採購通路  
      LET l_pmdl054 = ''         #內外購  
      LET l_pmdl033 = ''         #發票類型  
      LET l_pmdl055 = ''         #匯率計算基礎 
      LET l_flag = TRUE

      FOREACH apmp490_02_get_pmal_curs USING l_pmdl004
                                        INTO l_pmal002,l_pmdl015,l_pmdl011,
                                             l_pmdl009,l_pmdl010,l_pmdl017, 
                                             l_pmdl023,l_pmdl054,l_pmdl033,l_pmdl055
         IF STATUS THEN
            INITIALIZE g_errparam TO NULL
         LET g_errparam.code = STATUS
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

            EXIT FOREACH
         END IF

         #有進入foreach抓到資料 就改變flag 這樣就不用去apmm202抓資料了  
         LET l_flag = FALSE
         EXIT FOREACH
      END FOREACH

      #如果在控制組中找不到資料的話 改找apmm202的資料來預設  
      IF l_flag THEN
         LET l_pmdl009 = ''      #付款條件  
         LET l_pmdl010 = ''      #交易條件  
         LET l_pmdl011 = ''      #稅別  
         LET l_pmdl015 = ''      #幣別  
         LET l_pmdl017 = ''      #取價方式   
         LET l_pmdl023 = ''      #採購通路  
         LET l_pmdl054 = ''      #內外購  
         LET l_pmdl033 = ''      #發票類型 
         LET l_pmdl055 = ''      #匯率計算基礎
         SELECT pmab034,pmab033,pmab037,pmab053,pmab054,pmab038,pmab057,pmab056,pmab058
           INTO l_pmdl011,l_pmdl015,l_pmdl009,l_pmdl010,l_pmdl017,
                l_pmdl023,l_pmdl054,l_pmdl033,l_pmdl055
           FROM pmab_t
          WHERE pmabent = g_enterprise
            AND pmabsite = g_site
            AND pmab001 = l_pmdl004
      END IF 

      #取得稅率、單價含稅否 
      IF NOT cl_null(l_pmdl011) THEN
         SELECT oodb006,oodb005 INTO l_pmdl012,l_pmdl013
           FROM oodb_t,ooef_t
          WHERE ooefent = oodbent
            AND ooef001 = g_site
            AND ooef019 = oodb001
            AND oodbent = g_enterprise
            AND oodb002 = l_pmdl011       #稅別  
      END IF

      #取得匯率 
      IF NOT cl_null(l_pmdl015) THEN
         LET l_ooef016 = ''               #主幣別編號 
         SELECT ooef016 INTO l_ooef016
           FROM ooef_t
          WHERE ooefent = g_enterprise
            AND ooef001 = g_site

         CALL s_aooi160_get_exrate('1',g_site,g_today,l_pmdl015,l_ooef016,0,'11')
              RETURNING l_pmdl016
      END IF 
      
      #將資料寫入第三步的上方單身  
      INSERT INTO p490_03_pmdl_t(pmdl004,pmdl009,pmdl010,pmdl011,pmdl012,
                                 pmdl013,pmdl015,pmdl016,pmdl017,pmdl023,
                                 pmdl054,pmdl033,pmdl055,pmal002)
                          VALUES(l_pmdl004,l_pmdl009,l_pmdl010,l_pmdl011,
                                 l_pmdl012,l_pmdl013,l_pmdl015,l_pmdl016,
                                 l_pmdl017,l_pmdl023,l_pmdl054,l_pmdl033,
                                 l_pmdl055,g_controlno)
   END FOREACH
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_basic_chk" order="17" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 第二步進入第三步前的基本檢查
# Memo...........:
# Usage..........: CALL apmp490_02_basic_chk()
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_basic_chk()
   DEFINE l_sql     STRING
   DEFINE l_pmdl004 LIKE pmdl_t.pmdl004   #供應商   
   DEFINE l_pmdb004 LIKE pmdb_t.pmdb004   #請購料號   
   DEFINE l_pmdn014 LIKE pmdn_t.pmdn014   #到庫日期   
   DEFINE l_pmdn001 LIKE pmdn_t.pmdn001   #採購料號  
   DEFINE l_pmdn002 LIKE pmdn_t.pmdn002   #採購產品特徵  
   DEFINE l_pmdn006 LIKE pmdn_t.pmdn006   #採購單位  
   DEFINE l_pmdn007 LIKE pmdn_t.pmdn007   #採購數量  
   DEFINE l_pmdn008 LIKE pmdn_t.pmdn008   #參考單位 
   DEFINE l_pmdn009 LIKE pmdn_t.pmdn009   #參考數量 
   DEFINE l_pmdn010 LIKE pmdn_t.pmdn010   #計價單位  
   DEFINE l_pmdn011 LIKE pmdn_t.pmdn011   #計價數量   
   DEFINE l_pmdn050 LIKE pmdn_t.pmdn050   #備註 
   DEFINE r_success LIKE type_t.chr1
   DEFINE l_msg     STRING 
   
   WHENEVER ERROR CONTINUE 

   LET l_sql = "SELECT pmdl004,pmdb004,pmdn014,pmdn001,pmdn002, ",
               "       pmdn006,pmdn007,pmdn008,pmdn009,pmdn010, ",
               "       pmdn011,pmdn050 ",
               "  FROM p490_02_pmdn_t "
   PREPARE apmp490_02_basic_chk_prep FROM l_sql
   DECLARE apmp490_02_basic_chk_curs CURSOR FOR apmp490_02_basic_chk_prep

   LET r_success = 'Y'
   CALL cl_showmsg_init()

   LET l_msg = '' 
   
   FOREACH apmp490_02_basic_chk_curs INTO l_pmdl004,l_pmdb004,l_pmdn014,l_pmdn001,l_pmdn002,
                                          l_pmdn006,l_pmdn007,l_pmdn008,l_pmdn009,l_pmdn010,
                                          l_pmdn011,l_pmdn050
      IF STATUS THEN
         CALL cl_errmsg('','','foreach',STATUS,1)
         LET r_success = 'N'
         EXIT FOREACH
      END IF

      LET l_msg = l_pmdb004,";",l_pmdn014

      IF cl_null(l_pmdl004) THEN
         CALL cl_errmsg('pmdb004,pmdn014',l_msg,'','art-00282',1)    #供應商欄位不可為空！  
         LET r_success = 'N'
      END IF
      IF cl_null(l_pmdn001) THEN
         CALL cl_errmsg('pmdb004,pmdn014',l_msg,'','apm-00287',1)    #採購底稿中的採購料號欄位不可為空！  
         LET r_success = 'N'
      END IF
      IF cl_null(l_pmdn006) THEN
         CALL cl_errmsg('pmdb004,pmdn014',l_msg,'','apm-00288',1)    #採購底稿中的採購單位欄位不可為空！  
         LET r_success = 'N'
      END IF
      IF cl_null(l_pmdn007) THEN
         CALL cl_errmsg('pmdb004,pmdn014',l_msg,'','apm-00289',1)    #採購底稿中的採購數量欄位不可為空且不能為零！  
         LET r_success = 'N'
      END IF

   END FOREACH

   CALL cl_showmsg() 
   
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_pmdl004_chk" order="18" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 供應商基本檢查
# Memo...........:
# Usage..........: CALL apmp490_02_pmdl004_chk(p_pmdl004)
#                  RETURNING r_success
# Input parameter: p_pmdl004：供應商編號
# Return code....: r_success：true/false
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_pmdl004_chk(p_pmdl004)
   DEFINE p_pmdl004     LIKE pmdl_t.pmdl004

   DEFINE l_success    LIKE type_t.num5
   DEFINE l_flag       LIKE type_t.num5
   DEFINE r_success    LIKE type_t.num5

   DEFINE l_pmaastus   LIKE pmaa_t.pmaastus 
   
   WHENEVER ERROR CONTINUE 

   LET r_success = TRUE
   LET g_errno = ''

   IF NOT cl_null(p_pmdl004) THEN
      LET l_pmaastus = ''
      SELECT pmaastus INTO l_pmaastus
        FROM pmaa_t
       WHERE pmaa001 = p_pmdl004
         AND pmaaent = g_enterprise
         AND (pmaa002 = '1' OR pmaa002 = '3')

      CASE
         WHEN SQLCA.sqlcode = 100    LET g_errno = 'apm-00024'      #輸入的資料不存在於交易  
         WHEN l_pmaastus <> 'Y'      LET g_errno = 'apm-00200'      #輸入的資料未確認或已無效！ 
         OTHERWISE                   LET g_errno = SQLCA.sqlcode USING '------'
      END CASE

      IF NOT cl_null(g_errno) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = g_errno
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success
      END IF 
      
      #呼叫s_control_check_supplier做整合檢查 
      CALL s_control_check_supplier(p_pmdl004,'4',g_site,g_user,g_dept,g_apmp490_01_input.pmdldocno)
           RETURNING l_success
      IF NOT l_success THEN
         LET r_success = l_success
      END IF
      
   END IF
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_pmdn001_chk" order="19" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: apmp490_02_pmdn001_chk(p_pmdn001,p_pmdb004,p_pmdl004,p_pmdn002,p_pmdb005)
#                  RETURNING r_success
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: r_success
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_pmdn001_chk(p_pmdn001,p_pmdb004,p_pmdl004,p_pmdn002,p_pmdb005)
   DEFINE p_pmdn001     LIKE pmdn_t.pmdn001
   DEFINE p_pmdb004     LIKE pmdb_t.pmdb004
   DEFINE p_pmdl004     LIKE pmdl_t.pmdl004 
   DEFINE p_pmdn002     LIKE pmdn_t.pmdn002
   DEFINE p_pmdb005     LIKE pmdn_t.pmdn005

   DEFINE l_flag        LIKE type_t.num5
   DEFINE l_success     LIKE type_t.num5
   DEFINE l_ooba002     LIKE ooba_t.ooba002
   DEFINE l_pmdp007     LIKE pmdp_t.pmdp007
   DEFINE r_success     LIKE type_t.num5

   DEFINE l_imaastus    LIKE imaa_t.imaastus 
   
   WHENEVER ERROR CONTINUE 

   LET r_success = TRUE

   LET g_errno = ''
   LET l_imaastus = ''

   IF NOT cl_null(p_pmdn001) THEN
      #改用r.v檢查 
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = p_pmdn001      
      IF NOT cl_chk_exist("v_imaf001_14") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF

      #呼叫s_control_check_item做整合檢查 
      CALL s_control_check_item(p_pmdn001,'4',g_site,g_user,g_dept,g_apmp490_01_input.pmdldocno)
           RETURNING l_success
      IF NOT l_success THEN
         LET r_success = l_success
         RETURN r_success
      END IF

      #若單據別設置是要作請採勾稽時，則修改料號時必須檢核是否與"關聯單據明細"中的來源料號有替代關係
      IF cl_get_doc_para(g_enterprise,g_site,g_apmp490_01_input.pmdldocno,'D-BAS-0061') = "Y" THEN
         IF p_pmdb004 <> p_pmdn001 THEN
            IF NOT s_pmaq_chk_replacement(p_pmdl004,p_pmdb004,p_pmdn001,'2',p_pmdb005,p_pmdn002) THEN
               LET r_success = FALSE
               RETURN r_success
            END IF
            
         END IF
      END IF

   END IF
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_pmdn001_desc" order="20" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_pmdn001_desc(p_pmdn001)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_pmdn001_desc(p_pmdn001)
   DEFINE p_pmdn001     LIKE pmdn_t.pmdn001

   DEFINE l_n         LIKE type_t.num5
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_controlno LIKE ooha_t.ooha001
   DEFINE l_imaf158   LIKE imaf_t.imaf158 
   
   WHENEVER ERROR CONTINUE 

   #ming 在選完料號之後選控制組，然後帶出控制組的資料 應該可以移到之後處理 

  #LET l_n = 0
  #LET g_pmdn_d[l_ac].pmdn006 = ''
  #LET g_pmdn_d[l_ac].pmdn010 = ''

  ##先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
  #LET l_controlno = ''
  #CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,l_controlno

  #IF NOT cl_null(l_controlno) THEN
  #   SELECT COUNT(*) INTO l_n  
  #     FROM pmap_t
  #    WHERE pmapent = g_enterprise  
  #      AND pmapsite = g_site  
  #      AND pmap001 = g_pmdl_m.pmdl004
  #      AND pmap002 = l_controlno  
  #      AND pmap003 = g_pmdn_d[l_ac].pmdn001 
  #      AND pmap004 = g_pmdn_d[l_ac].pmdn002

  #   #若採購料件有設置'供應商控制組料件預設條件'(apmi121)時，則需將設置的預設條件值預設到採購單對應欄位
  #   IF l_n > 0 THEN
  #      SELECT pmap006,pmap008,pmap009,pmap010,pmap011,pmap012,pmap014,pmap005 
  #        INTO g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdnunit,  
  #             g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn025, 
  #             g_pmdn2_d[l_ac].pmdn031,g_pmdn2_d[l_ac].pmdn003
  #        FROM pmdp_t
  #       WHERE pmdpent = g_enterprise  
  #         AND pmapsite = g_site  
  #         AND pmap001 = g_pmdl_m.pmdl004
  #         AND pmap002 = l_controlno   
  #         AND pmap003 = g_pmdn_d[l_ac].pmdn001 
  #         AND pmap004 = g_pmdn_d[l_ac].pmdn002

  #   END IF
  #END IF

  #IF cl_null(l_controlno) OR l_n = 0 THEN
  #   #沒有設置'供應商控制組料件預設條件'(apmi121)才改抓料件進銷存檔預設的條件
  #   SELECT imaf143,imaf144,imaf091,imaf092,imaf157
  #     INTO g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn003
  #     FROM imaf_t
  #    WHERE imafent = g_enterprise  
  #      AND imafsite = g_site  
  #      AND imaf001 = g_pmdn_d[l_ac].pmdn001
  #END IF

  ##整體參數使用採購計價單位時:
  ##[C:計價單位]=[T:料件據點進銷存檔].[C:採購計價單位] 
  #IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN
  #   SELECT imaf144 INTO g_pmdn_d[l_ac].pmdn010  
  #     FROM imaf_t
  #    WHERE imafent = g_enterprise  
  #      AND imafsite = g_site   
  #      AND imaf001 = g_pmdn_d[l_ac].pmdn001
  #END IF  
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_set_entry_b" order="21" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_set_entry_b(p_ac)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_set_entry_b(p_ac)
   DEFINE p_ac     LIKE type_t.num5   
   
   WHENEVER ERROR CONTINUE 
  #CALL cl_set_comp_entry("pmdm001,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006",TRUE)
  #CALL cl_set_comp_entry("pmdn002,pmdn008,pmdn012,pmdn013,pmdn014",TRUE)  
  
  CALL cl_set_comp_entry("pmdn002_02_01",TRUE)
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_set_no_entry_b" order="22" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_set_no_entry_b(p_ac)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_set_no_entry_b(p_ac)
   DEFINE p_ac          LIKE type_t.num5
   DEFINE l_imaa005     LIKE imaa_t.imaa005 
   
   WHENEVER ERROR CONTINUE 
   
  #DEFINE l_imaa005   LIKE imaa_t.imaa005
  #DEFINE l_imaf015   LIKE imaf_t.imaf015

  #IF (NOT cl_null(g_pmdn6_d_t.pmdm007)) AND (g_pmdn6_d_t.pmdm008> 0 OR g_pmdn6_d_t.pmdm009 > 0) THEN
  #   CALL cl_set_comp_entry("pmdm001,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006",FALSE)
  #END IF

  ##料件不使用產品特徵時，產品特徵欄位不可錄入
  #LET l_imaa005 = ''
  #SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_pmdn_d[l_ac].pmdn001
  #IF cl_null(l_imaa005) THEN
  #   CALL cl_set_comp_entry("pmdn002",FALSE)
  #   LET g_pmdn_d[l_ac].pmdn002 = ' '
  #ELSE
  #   IF cl_null(g_pmdn_d[l_ac].pmdn002) THEN
  #      LET g_pmdn_d[l_ac].pmdn002 = ''
  #   END IF
  #END IF

  ##當料件主檔設置要做參考單位管理時，則參考單位允許輸入，不允許空白
  #LET l_imaf015 = ''
  #SELECT imaf015 INTO l_imaf015 FROM imaf_t WHERE imafent = g_enterprise AND imaf001 = g_pmdn_d[l_ac].pmdn001 AND imafsite = g_site
  #IF cl_null(l_imaf015) THEN
  #   CALL cl_set_comp_entry("pmdn008",FALSE)
  #   LET g_pmdn_d[l_ac].pmdn008 = ''
  #   LET g_pmdn_d[l_ac].pmdn008_desc = ''
  #   LET g_pmdn_d[l_ac].pmdn009 = ''
  #END IF

  #IF g_pmdn_d[l_ac].pmdn024 = 'Y' THEN 
  #   CALL cl_set_comp_entry("pmdn012,pmdn013,pmdn014",FALSE)
  #   LET g_pmdn_d[l_ac].pmdn012 = ''
  #   LET g_pmdn_d[l_ac].pmdn013 = ''
  #   LET g_pmdn_d[l_ac].pmdn014 = '' 
  
  #料件不使用產品特徵時，產品特徵欄位不可錄入
   LET l_imaa005 = ''
   SELECT imaa005 INTO l_imaa005
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdn_d[p_ac].pmdn001_02_01
   IF cl_null(l_imaa005) THEN
      CALL cl_set_comp_entry("pmdn002_02_01",FALSE)
      LET g_pmdn_d[p_ac].pmdn002_02_01 = ' '
   ELSE
      IF cl_null(g_pmdn_d[p_ac].pmdn002_02_01) THEN
         LET g_pmdn_d[p_ac].pmdn002_02_01 = ''
      END IF
   END IF
  #END IF 
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_unit_chk" order="23" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_unit_chk(p_pmdn006)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_unit_chk(p_pmdn006)
   DEFINE p_pmdn006     LIKE pmdn_t.pmdn006
   DEFINE l_oocastus    LIKE ooca_t.oocastus 
   
   WHENEVER ERROR CONTINUE 

   LET g_errno = ''
   LET l_oocastus = ''

   SELECT oocastus INTO l_oocastus
     FROM ooca_t
    WHERE ooca001 = p_pmdn006
      AND oocaent = g_enterprise

   CASE
      WHEN SQLCA.sqlcode = 100    LET g_errno = 'aim-00004'
      WHEN l_oocastus <> 'Y'      LET g_errno = 'aim-00005'
      OTHERWISE                   LET g_errno = SQLCA.sqlcode USING '------'
   END CASE
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_unit_round" order="24" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: #根據單位取位類型對數量進行取位
# Memo...........:
# Usage..........: CALL apmp490_02_unit_round(p_unit,p_qty)
#                  RETURNING 回传参数
# Input parameter: p_unit：單位
#                : p_qty ：數量
# Return code....: r_qty ：數量
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_unit_round(p_unit,p_qty)
   DEFINE p_unit     LIKE pmdn_t.pmdn006
   DEFINE p_qty      LIKE pmdn_t.pmdn007
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_ooca002   LIKE ooca_t.ooca002      #小数位数
   DEFINE l_ooca004   LIKE ooca_t.ooca004      #舍入类型 
   DEFINE r_qty       LIKE pmdn_t.pmdn007      #數量 
   
   WHENEVER ERROR CONTINUE 

   LET l_success = NULL
   LET l_ooca002 = 0
   LET l_ooca004 = NULL
   LET r_qty     = 0

   #抓取單位檔中的小數位數和捨入類型  
   IF NOT cl_null(p_unit) THEN
      CALL s_aooi250_get_msg(p_unit) RETURNING l_success,l_ooca002,l_ooca004
      IF l_success THEN
         IF NOT cl_null(p_qty) THEN
            CALL s_num_round(l_ooca004,p_qty,l_ooca002) RETURNING r_qty
            RETURN r_qty
         END IF
      END IF
   END IF
   RETURN r_qty
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_default" order="25" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_default()
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_default()
   
   WHENEVER ERROR CONTINUE 
   
   LET g_apmp490_02_input.scb01 = 1
   LET g_apmp490_02_input.bt01 = ''
   LET g_apmp490_02_input.ed01 = ''
   LET g_apmp490_02_input.scb02 = 1
   LET g_apmp490_02_input.scb03 = 3

   CASE g_apmp490_02_input.scb03
      WHEN '0'           #一個月   
         LET g_mm = 1
      WHEN '1'           #兩個月  
         LET g_mm = 2
      WHEN '2'           #三個月  
         LET g_mm = 3
      WHEN '3'           #六個月   
         LET g_mm = 6
      WHEN '4'           #一年  
         LET g_mm = 12
   END CASE

   CALL g_pmdn_d.clear()
   CALL g_apmp490_02_pmdn_d.clear()
   CALL g_apmp490_02_pmds_d.clear()
   CALL g_apmp490_02_qcba_d.clear()
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_bt01_ref" order="26" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
PUBLIC FUNCTION apmp490_02_bt01_ref(p_pmdl004)
   DEFINE p_pmdl004    LIKE pmdl_t.pmdl004
   DEFINE r_pmaal004   LIKE pmaal_t.pmaal004 
   
   WHENEVER ERROR CONTINUE 

   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = p_pmdl004
   CALL ap_ref_array2(g_ref_fields,
                      "SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002= '"||g_dlang||"'",
                      "")
        RETURNING g_rtn_fields
   LET r_pmaal004 = '', g_rtn_fields[1] , ''
   RETURN r_pmaal004
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_get_imaal" order="27" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_get_imaal(p_imaal001)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_get_imaal(p_imaal001)
   DEFINE p_imaal001     LIKE imaal_t.imaal001
   DEFINE r_imaal003     LIKE imaal_t.imaal003
   DEFINE r_imaal004     LIKE imaal_t.imaal004 
   
   WHENEVER ERROR CONTINUE 

   LET r_imaal003 = ''
   LET r_imaal004 = ''

   SELECT imaal003,imaal004 INTO r_imaal003,r_imaal004
     FROM imaal_t
    WHERE imaalent = g_enterprise
      AND imaal001 = p_imaal001
      AND imaal002 = g_lang

   RETURN r_imaal003,r_imaal004
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_get_pmaal004" order="28" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_get_pmaal004(p_pmaal001)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_get_pmaal004(p_pmaal001)
   DEFINE p_pmaal001     LIKE pmaal_t.pmaal001
   DEFINE r_pmaal004     LIKE pmaal_t.pmaal004 
   
   WHENEVER ERROR CONTINUE 

   LET r_pmaal004 = ''

   SELECT pmaal004 INTO r_pmaal004
     FROM pmaal_t
    WHERE pmaalent = g_enterprise
      AND pmaal001 = p_pmaal001
      AND pmaal002 = g_lang

   RETURN r_pmaal004
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_ins_pmdb" order="29" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL apmp490_02_ins_pmdb(p_link_no,p_pmdb004,p_pmdb005,p_pmdb050,p_qty)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_ins_pmdb(p_link_no,p_pmdb004,p_pmdb005,p_pmdb050,p_qty)
   DEFINE p_link_no     LIKE type_t.num10
   DEFINE p_pmdb004     LIKE pmdb_t.pmdb004
   DEFINE p_pmdb005     LIKE pmdb_t.pmdb005 
   DEFINE p_pmdb050     LIKE pmdb_t.pmdb050
   DEFINE p_qty         LIKE pmdb_t.pmdb006
   DEFINE l_sql         STRING
   DEFINE l_pmdbdocno   LIKE pmdb_t.pmdbdocno
   DEFINE l_pmdbseq     LIKE pmdb_t.pmdbseq
   DEFINE l_pmdb004     LIKE pmdb_t.pmdb004
   DEFINE l_pmdb005     LIKE pmdb_t.pmdb005
   DEFINE l_pmdb007     LIKE pmdb_t.pmdb007
   DEFINE l_pmdb006     LIKE pmdb_t.pmdb006
   DEFINE l_qty         LIKE pmdb_t.pmdb006
   DEFINE l_pmdb030     LIKE pmdb_t.pmdb030
   DEFINE l_pmdb033     LIKE pmdb_t.pmdb033
   DEFINE l_pmdb014     LIKE pmdb_t.pmdb014
   DEFINE l_pmdb015     LIKE pmdb_t.pmdb015 
   DEFINE l_pmdb050     LIKE pmdb_t.pmdb050
   DEFINE l_applied_qty LIKE type_t.num10
   DEFINE l_qty_w       LIKE pmdb_t.pmdb006 
   DEFINE r_success     LIKE type_t.num5      #回傳結果  
   
   WHENEVER ERROR CONTINUE 
   
   #由此function做分配的檢查 
   #如果已分配完畢 就不可產生分配的資料 
   LET r_success = FALSE

   LET l_sql = "SELECT pmdbdocno,pmdbseq,pmdb004,pmdb005,pmdb007,",
               "       pmdb006,qty,pmdb030,pmdb033,pmdb014,pmdb015,",
               "       pmdb050, applied_qty ",
               "  FROM p490_01_pmdb_t ",
               " WHERE pmdb004 = '",p_pmdb004,"' ",
               "   AND pmdb005 = '",p_pmdb005,"' ",
               "   AND NVL(pmdb050,' ') = NVL('",p_pmdb050,"',' ') ",
               " ORDER BY pmdb030 "
   PREPARE p490_02_ins_02_pmdb_prep FROM l_sql
   DECLARE p490_02_ins_02_pmdb_curs CURSOR WITH HOLD FOR p490_02_ins_02_pmdb_prep 
   
   FOREACH p490_02_ins_02_pmdb_curs INTO l_pmdbdocno,l_pmdbseq,l_pmdb004,l_pmdb005,
                                         l_pmdb007,l_pmdb006,l_qty,l_pmdb030,
                                         l_pmdb033,l_pmdb014,l_pmdb015,l_pmdb050,l_applied_qty
      IF STATUS THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = STATUS
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF

      #如果未轉採購量等於已分配的數量 就代表此請購資料已經被分配完畢 
      IF l_qty = l_applied_qty THEN
         CONTINUE FOREACH
      END IF

      LET l_qty = l_qty - l_applied_qty   #取得未分配的數量總數   

      IF p_qty > l_qty THEN
         LET l_qty_w = l_qty              #取得真正要寫入的數量  
         LET p_qty = p_qty - l_qty        #計算剩餘需分配的數量  
      ELSE
         LET l_qty_w = p_qty
         LET p_qty = 0
      END IF

      #有寫入新底稿的情況 就是有資料可以分配  
      LET r_success = TRUE

      INSERT INTO p490_02_pmdb_t(link_no,pmdbdocno,pmdbseq,pmdb004,pmdb005,
                                 pmdb007,pmdb006,qty,pmdb030,pmdb033,pmdb014,
                                 pmdb015,pmdb050)
                          VALUES(p_link_no,l_pmdbdocno,l_pmdbseq,l_pmdb004,
                                 l_pmdb005,l_pmdb007,l_pmdb006,l_qty_w,l_pmdb030,
                                 l_pmdb033,l_pmdb014,l_pmdb015,l_pmdb050)

      #更新已分配的數量 
      UPDATE p490_01_pmdb_t SET applied_qty = applied_qty + l_qty_w
       WHERE pmdbdocno = l_pmdbdocno
         AND pmdbseq = l_pmdbseq

      IF p_qty <=0 THEN
         EXIT FOREACH
      END IF
   END FOREACH 
   
   RETURN r_success
   
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_convert_qty" order="30" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 單位轉換，統一寫在一個function之中，以後如果再有aimi190改aooi250的這種情況就不必改很多地方 
# Memo...........:
# Usage..........: CALL apmp490_02_convert_qty(p_imaa001,p_from_unit,p_to_unit,p_qty)
#                  RETURNING r_qty
# Input parameter: p_imaa001  ：料號 
#                : p_from_unit：來源單位 
#                : p_to_unit  ：目的單位 
#                : p_qty      ：數量 
# Return code....: r_qty      ：要回傳的結果 
# Date & Author..: 2015/01/05 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_convert_qty(p_imaa001,p_from_unit,p_to_unit,p_qty)
   DEFINE p_imaa001     LIKE imaa_t.imaa001     #料號 
   DEFINE p_from_unit   LIKE inag_t.inag007     #來源單位 
   DEFINE p_to_unit     LIKE inag_t.inag007     #目的單位
   DEFINE p_qty         LIKE inag_t.inag008     #數量 
   DEFINE l_success     LIKE type_t.num5
   DEFINE r_qty         LIKE inag_t.inag008     #要回傳的結果  
   
   WHENEVER ERROR CONTINUE 

   LET r_qty = 0

   CALL s_aooi250_convert_qty(p_imaa001,p_from_unit,p_to_unit,p_qty)
        RETURNING l_success,r_qty

   IF (NOT l_success) OR cl_null(r_qty) THEN
      LET r_qty = 0
   END IF 
   
   #沒有單位轉換率的話,要報錯
   IF NOT l_success THEN
      LET g_errparam.code = 'sub-00015'
      LET g_errparam.extend = p_imaa001
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = p_from_unit
      LET g_errparam.replace[2] = p_to_unit
      CALL cl_err()
   END IF


   RETURN r_qty
END FUNCTION]]>
  </point>
  <point name="function.apmp490_02_b" order="31" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 輸入上方單身資料
# Memo...........:
# Usage..........: CALL apmp490_02_b()
# Date & Author..: 2014/06/18 By ming
# Modify.........:
################################################################################
PUBLIC FUNCTION apmp490_02_b()
   DEFINE l_ac1     LIKE type_t.num5
   DEFINE l_sql     STRING
   DEFINE l_success LIKE type_t.num5
   DEFINE l_pmdn_t  type_g_pmdn_d
   DEFINE l_rate    LIKE inaj_t.inaj014 
   DEFINE l_qty     LIKE pmdn_t.pmdn007       #用來記錄單位換算後的數量  

   WHENEVER ERROR CONTINUE 

   DIALOG ATTRIBUTES(UNBUFFERED)
      INPUT ARRAY g_pmdn_d FROM s_apmp490_02_detail1.*
            ATTRIBUTE(COUNT = g_d_cnt_p49002_01,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                      INSERT ROW = FALSE,
                      DELETE ROW = FALSE,
                      APPEND ROW = FALSE)
         BEFORE INPUT

         BEFORE ROW
            LET l_ac1 = ARR_CURR()
            LET l_pmdn_t.* = g_pmdn_d[l_ac1].*

            CALL apmp490_02_set_entry_b(l_ac1)
            CALL apmp490_02_set_no_entry_b(l_ac1)

         AFTER FIELD pmdl004_02_01   #供應商編號   
            CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
            DISPLAY BY NAME g_pmdn_d[l_ac1].pmaal004_02_01 

            IF NOT cl_null(g_pmdn_d[l_ac1].pmdl004_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdl004_02_01 != l_pmdn_t.pmdl004_02_01 OR
                  l_pmdn_t.pmdl004_02_01 IS NULL THEN
                  IF g_pmdn_d[l_ac1].pmdb014_02_01 = '3' THEN
                     LET g_pmdn_d[l_ac1].pmdl004_02_01 = l_pmdn_t.pmdl004_02_01
                     CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
                     DISPLAY BY NAME g_pmdn_d[l_ac1].pmaal004_02_01
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00537'     #請購單已指定供應商，不可修改！ 
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
      
                     NEXT FIELD CURRENT
                  END IF

                  IF NOT apmp490_02_pmdl004_chk(g_pmdn_d[l_ac1].pmdl004_02_01) THEN

                     NEXT FIELD CURRENT
                  END IF

               END IF
            END IF 

         AFTER FIELD pmdn001_02_01   #採購料件編號  
            CALL apmp490_02_get_imaal(g_pmdn_d[l_ac1].pmdn001_02_01)
                 RETURNING g_pmdn_d[l_ac1].imaal003_02_01_2,g_pmdn_d[l_ac1].imaal004_02_01_2
            DISPLAY BY NAME g_pmdn_d[l_ac1].imaal003_02_01_2,g_pmdn_d[l_ac1].imaal004_02_01_2

            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn001_02_01 != l_pmdn_t.pmdn001_02_01 OR
                  l_pmdn_t.pmdn001_02_01 IS NULL THEN
                  IF NOT apmp490_02_pmdn001_chk(g_pmdn_d[l_ac1].pmdn001_02_01,
                                                g_pmdn_d[l_ac1].pmdb004_02_01,
                                                g_pmdn_d[l_ac1].pmdl004_02_01,
                                                g_pmdn_d[l_ac1].pmdn002_02_01,
                                                g_pmdn_d[l_ac1].pmdb004_02_01) THEN

                     NEXT FIELD CURRENT
                  END IF

                  #CALL apmp490_02_pmdn001_desc(g_pmdn_d[l_ac1].pmdn001_02_01)
               END IF
            END IF

            CALL apmp490_02_set_entry_b(l_ac1)
            CALL apmp490_02_set_no_entry_b(l_ac1)

         AFTER FIELD pmdn002_02_01   #產品特徵  
            #如果產品特徵沒有輸入的話，要設定為一個空白 
            IF cl_null(g_pmdn_d[l_ac1].pmdn002_02_01) THEN
               LET g_pmdn_d[l_ac1].pmdn002_02_01 = ' '
            END IF
            
            #取得產品特徵說明 
            CALL s_feature_description(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01)
                 RETURNING l_success,g_pmdn_d[l_ac1].pmdn002_02_01_desc
            #產品特徵的基本檢查  
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn002_02_01) THEN
               IF NOT s_feature_check(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01) THEN
                  LET g_pmdn_d[l_ac1].pmdn002_02_01 = l_pmdn_t.pmdn002_02_01
                  CALL s_feature_description(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01)
                       RETURNING l_success,g_pmdn_d[l_ac1].pmdn002_02_01_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
         
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn002_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn002_02_01 != l_pmdn_t.pmdn002_02_01 OR
                  l_pmdn_t.pmdn002_02_01 IS NULL THEN
                  #2.呼叫產品特徵檢核應用元件，檢核輸入的產品特徵值是否合理
                  #3.當請採勾稽時，採購料號+採購產品特徵與請購料號+請購產品特徵不一樣時，必須檢核是否與請購料號+
                  #  請購產品特徵有替代關係，若沒有則不允許修改

                  #CALL apmp490_02_pmdn001_desc(g_pmdn_d[l_ac1].pmdn001_02_01)
               END IF
            END IF 

         AFTER FIELD pmdn006_02_01   #採購單位  
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn006_02_01 != l_pmdn_t.pmdn006_02_01 OR
                  l_pmdn_t.pmdn006_02_01 IS NULL THEN
                  CALL apmp490_02_unit_chk(g_pmdn_d[l_ac1].pmdn006_02_01)

                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     NEXT FIELD CURRENT
                  END IF 
                  
                  #單位改變後,數量要重新推算 
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,     #料號  
                                              g_pmdn_d[l_ac1].pmdb007_02_01,     #來源單位  
                                              g_pmdn_d[l_ac1].pmdn006_02_01,     #目的單位  
                                              g_pmdn_d[l_ac1].pmdn007_02_01)     #數量  
                       RETURNING g_pmdn_d[l_ac1].pmdn007_02_01


                  IF NOT cl_null(g_pmdn_d[l_ac1].pmdn007_02_01) THEN
                     CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmdn007_02_01
                     DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn007_02_01

                     #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                     #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  #體參數使用採購計價單位
                        CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,
                                                    g_pmdn_d[l_ac1].pmdn006_02_01,
                                                    g_pmdn_d[l_ac1].pmdn010_02_01,
                                                    g_pmdn_d[l_ac1].pmdn007_02_01)
                             RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                        IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
                           CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                                RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                           DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
                        END IF
                     END IF
                  END IF 
               END IF
            END IF 
            
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn006_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn006_02_01_desc

         AFTER FIELD pmdn007_02_01   #採購數量  
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn007_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn007_02_01 <= 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ade-00016'   #數量不可小於等於0  
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
   
                  NEXT FIELD CURRENT
               END IF 
               
               LET l_qty = g_pmdn_d[l_ac1].pmdn007_02_01
               IF g_pmdn_d[l_ac1].pmdb007_02_01 != g_pmdn_d[l_ac1].pmdn006_02_01 THEN
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                              g_pmdn_d[l_ac1].pmdb007_02_01,l_qty)
                       RETURNING l_qty
               END IF

               #如果採購數量乘上轉換率後，超過未轉採購量的數量，就算錯 
               IF l_qty > g_pmdn_d[l_ac1].qty_02_01 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'apm-00699'     #數量不可大於未轉採購量！  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD CURRENT
               END IF

               CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                    RETURNING g_pmdn_d[l_ac1].pmdn007_02_01
               DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn007_02_01

               IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'Y' THEN
                  IF NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01) AND
                     NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01) AND
                     NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01) THEN
                     CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                                 g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
                     IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
                        CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                             RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
                        DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn009_02_01
                     END IF

                  END IF
               END IF

               #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
               #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率 
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  #體參數使用採購計價單位
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                              g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                  IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
                     CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                     DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
                  END IF
               END IF

            END IF 
            
         AFTER FIELD pmdn008_02_01   #參考單位 
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01) THEN
               CALL apmp490_02_unit_chk(g_pmdn_d[l_ac1].pmdn008_02_01)
               IF NOT cl_null(g_errno) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = g_errno
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD CURRENT
               END IF

               #計算參考數量 
               IF (NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01)) AND 
                  (NOT cl_null(g_pmdn_d[l_ac1].pmdn007_02_01)) THEN
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                              g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
               END IF

               IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
                  CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
               END IF
            END IF  
            
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn008_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn008_02_01_desc
            
         AFTER FIELD pmdn009_02_01   #參考數量 
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn009_02_01 <= 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'ade-00016' #數量不可小於等於0  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD CURRENT
               END IF

               #檢查數量是否有超過採購數量 
               LET l_qty = g_pmdn_d[l_ac1].pmdn009_02_01
               IF g_pmdn_d[l_ac1].pmdb007_02_01 != g_pmdn_d[l_ac1].pmdn008_02_01 THEN
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn008_02_01,
                                              g_pmdn_d[l_ac1].pmdb007_02_01,l_qty)
                       RETURNING l_qty
               END IF

               #如果數量乘上轉換率後，超過未轉採購量，就算錯 
               IF l_qty > g_pmdn_d[l_ac1].qty_02_01 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'apm-00699'    #數量不可大於未轉採購量！  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD CURRENT
               END IF

               IF NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01) THEN
                  CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
                  DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn009_02_01
               END IF
            END IF

         AFTER FIELD pmdn010_02_01   #計價單位  
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
                CALL apmp490_02_unit_chk(g_pmdn_d[l_ac1].pmdn010_02_01)
                IF NOT cl_null(g_errno) THEN
                   INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                   NEXT FIELD CURRENT
                END IF 
                
                #單位改變後,數量要重新推算 
                CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,     #料號  
                                            g_pmdn_d[l_ac1].pmdb007_02_01,     #來源單位  
                                            g_pmdn_d[l_ac1].pmdn010_02_01,     #目的單位  
                                            g_pmdn_d[l_ac1].pmdn007_02_01)     #數量  
                     RETURNING g_pmdn_d[l_ac1].pmdn011_02_01


                IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
                   CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                        RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                   DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
                END IF
            END IF 
            
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn010_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn010_02_01_desc

         AFTER FIELD pmdn011_02_01   #計價數量   
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn011_02_01 <= 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ade-00016'   #數量不可小於等於0  
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
     
                  NEXT FIELD CURRENT
               END IF 
               
               LET l_qty = g_pmdn_d[l_ac1].pmdn011_02_01
               IF g_pmdn_d[l_ac1].pmdb007_02_01 != g_pmdn_d[l_ac1].pmdn010_02_01 THEN
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn010_02_01,
                                              g_pmdn_d[l_ac1].pmdb007_02_01,l_qty)
                       RETURNING l_qty
               END IF

               #如果採購數量乘上轉換率後，超過未轉採購量的數量，就算錯 
               IF l_qty > g_pmdn_d[l_ac1].qty_02_01 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'apm-00699'     #數量不可大於未轉採購量！  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD CURRENT
               END IF

               IF NOT cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
                  CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                  DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
               END IF
            END IF 

         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               LET g_pmdn_d[l_ac1].* = l_pmdn_t.*
               EXIT DIALOG
            END IF
            UPDATE p490_02_pmdn_t SET pmdl004 = g_pmdn_d[l_ac1].pmdl004_02_01,
                                      pmdn001 = g_pmdn_d[l_ac1].pmdn001_02_01,
                                      pmdn002 = g_pmdn_d[l_ac1].pmdn002_02_01,
                                      pmdn006 = g_pmdn_d[l_ac1].pmdn006_02_01,
                                      pmdn007 = g_pmdn_d[l_ac1].pmdn007_02_01,  
                                      pmdn008 = g_pmdn_d[l_ac1].pmdn008_02_01,
                                      pmdn009 = g_pmdn_d[l_ac1].pmdn009_02_01,
                                      pmdn010 = g_pmdn_d[l_ac1].pmdn010_02_01,
                                      pmdn011 = g_pmdn_d[l_ac1].pmdn011_02_01
             WHERE NVL(pmdl004,' ') = NVL(l_pmdn_t.pmdl004_02_01,' ')
               AND pmdb004 = g_pmdn_d[l_ac1].pmdb004_02_01
               AND pmdb005 = g_pmdn_d[l_ac1].pmdb005_02_01 
               AND pmdn014 = g_pmdn_d[l_ac1].pmdn014_02_01                   #因為會有費用料件的問題 
               AND NVL(pmdn050,' ') = NVL(g_pmdn_d[l_ac1].pmdn050_02_01,' ') #所以要多考慮備註

         ON ACTION controlp INFIELD pmdl004_02_01       #供應商編號 
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac1].pmdl004_02_01

            LET g_qryparam.where = "1=1 "

            #統一使用s_control_get_supplier_sql()回傳的sql丟入where條件即可 
            CALL s_control_get_supplier_sql('4',g_site,g_user,g_dept,g_apmp490_01_input.pmdldocno)
                 RETURNING l_success,l_sql
            IF l_success THEN
               LET g_qryparam.where = l_sql
            END IF

            CALL q_pmaa001_3()

            LET g_pmdn_d[l_ac1].pmdl004_02_01 = g_qryparam.return1 
            DISPLAY g_pmdn_d[l_ac1].pmdl004_02_01 TO pmdl004_02_01

            NEXT FIELD pmdl004_02_01

         ON ACTION controlp INFIELD pmdn001_02_01         #採購料號
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac1].pmdn001_02_01

            LET g_qryparam.WHERE = "1=1 "

            #呼叫s_control_get_item_sql取得where  
            CALL s_control_get_item_sql('4',g_site,g_user,g_dept,g_apmp490_01_input.pmdldocno)
                 RETURNING l_success,l_sql
            IF l_success THEN
               LET g_qryparam.where = l_sql
            END IF 
            
            CALL q_imaf001_15()                                #呼叫開窗  
            LET g_pmdn_d[l_ac1].pmdn001_02_01 = g_qryparam.return1

            DISPLAY g_pmdn_d[l_ac1].pmdn001_02_01 TO pmdn001_02_01

            NEXT FIELD pmdn001_02_01

         ON ACTION controlp INFIELD pmdn006_02_01
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac1].pmdn006_02_01             #給予default值
            CALL q_ooca001_1()                                                  #呼叫開窗
            LET g_pmdn_d[l_ac1].pmdn006_02_01 = g_qryparam.return1              #將開窗取得的值回傳到變數
            DISPLAY g_pmdn_d[l_ac1].pmdn006_02_01 TO pmdn006_02_01              #顯示到畫面上 
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn006_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn006_02_01_desc
            DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn006_02_01_desc
            NEXT FIELD pmdn006_02_01                                            #返回原欄位
            
         ON ACTION controlp INFIELD pmdn008_02_01
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac1].pmdn008_02_01             #給予default值  
            CALL q_ooca001_1()                                                  #呼叫開窗 
            LET g_pmdn_d[l_ac1].pmdn008_02_01 = g_qryparam.return1              #將開窗取得的值回傳到變數上 
            DISPLAY g_pmdn_d[l_ac1].pmdn008_02_01 TO pmdn008_02_01              #顯示到畫面上 
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn008_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn008_02_01_desc
            DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn008_02_01_desc
            NEXT FIELD pmdn008_02_01                                            #返回原欄位 

         ON ACTION controlp INFIELD pmdn010_02_01
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac1].pmdn010_02_01             #給予default值
            CALL q_ooca001_1()                                                  #呼叫開窗
            LET g_pmdn_d[l_ac1].pmdn010_02_01 = g_qryparam.return1              #將開窗取得的值回傳到變數
            DISPLAY g_pmdn_d[l_ac1].pmdn010_02_01 TO pmdn010_02_01              #顯示到畫面上 
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn010_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn010_02_01_desc
            DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn010_02_01_desc
            NEXT FIELD pmdn010_02_01                                            #返回原欄位  
            
         ON ACTION accept 
            #供應商檢查 
            CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
            DISPLAY BY NAME g_pmdn_d[l_ac1].pmaal004_02_01
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdl004_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdl004_02_01 != l_pmdn_t.pmdl004_02_01 OR
                  l_pmdn_t.pmdl004_02_01 IS NULL THEN
                  IF g_pmdn_d[l_ac1].pmdb014_02_01 = '3' THEN
                     LET g_pmdn_d[l_ac1].pmdl004_02_01 = l_pmdn_t.pmdl004_02_01
                     CALL apmp490_02_get_pmaal004(g_pmdn_d[l_ac1].pmdl004_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmaal004_02_01
                     DISPLAY BY NAME g_pmdn_d[l_ac1].pmaal004_02_01
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00537'     #請購單已指定供應商，不可修改！ 
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     NEXT FIELD xmdl004_02_01
                  END IF

                  IF NOT apmp490_02_pmdl004_chk(g_pmdn_d[l_ac1].pmdl004_02_01) THEN

                     NEXT FIELD xmdl004_02_01
                  END IF

               END IF
            END IF
            
            #採購料號檢查 
            CALL apmp490_02_get_imaal(g_pmdn_d[l_ac1].pmdn001_02_01)
                 RETURNING g_pmdn_d[l_ac1].imaal003_02_01_2,g_pmdn_d[l_ac1].imaal004_02_01_2
            DISPLAY BY NAME g_pmdn_d[l_ac1].imaal003_02_01_2,g_pmdn_d[l_ac1].imaal004_02_01_2
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn001_02_01 != l_pmdn_t.pmdn001_02_01 OR
                  l_pmdn_t.pmdn001_02_01 IS NULL THEN
                  IF NOT apmp490_02_pmdn001_chk(g_pmdn_d[l_ac1].pmdn001_02_01,
                                                g_pmdn_d[l_ac1].pmdb004_02_01,
                                                g_pmdn_d[l_ac1].pmdl004_02_01,
                                                g_pmdn_d[l_ac1].pmdn002_02_01,
                                                g_pmdn_d[l_ac1].pmdb004_02_01) THEN

                     NEXT FIELD pmdn001_02_01
                  END IF

                  #CALL apmp490_02_pmdn001_desc(g_pmdn_d[l_ac1].pmdn001_02_01)
               END IF
            END IF

            CALL apmp490_02_set_entry_b(l_ac1)
            CALL apmp490_02_set_no_entry_b(l_ac1) 
            
            #產品特徵檢查 
            #如果產品特徵沒有輸入的話，要設定為一個空白 
            IF cl_null(g_pmdn_d[l_ac1].pmdn002_02_01) THEN
               LET g_pmdn_d[l_ac1].pmdn002_02_01 = ' '
            ELSE
               #取得產品特徵說明 
               CALL s_feature_description(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01)
                    RETURNING l_success,g_pmdn_d[l_ac1].pmdn002_02_01_desc
               #產品特徵的基本檢查  
               IF g_pmdn_d[l_ac1].pmdn002_02_01 IS NOT NULL THEN
                  IF NOT s_feature_check(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01) THEN
                     LET g_pmdn_d[l_ac1].pmdn002_02_01 = l_pmdn_t.pmdn002_02_01
                     CALL s_feature_description(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn002_02_01)
                          RETURNING l_success,g_pmdn_d[l_ac1].pmdn002_02_01_desc
                     NEXT FIELD pmdn002_02_01
                  END IF
               END IF
               IF NOT cl_null(g_pmdn_d[l_ac1].pmdn002_02_01) THEN
                  IF g_pmdn_d[l_ac1].pmdn002_02_01 != l_pmdn_t.pmdn002_02_01 OR
                     l_pmdn_t.pmdn002_02_01 IS NULL THEN
                     #2.呼叫產品特徵檢核應用元件，檢核輸入的產品特徵值是否合理
                     #3.當請採勾稽時，採購料號+採購產品特徵與請購料號+請購產品特徵不一樣時，必須檢核是否與請購料號+
                     #  請購產品特徵有替代關係，若沒有則不允許修改

                     #CALL apmp490_02_pmdn001_desc(g_pmdn_d[l_ac1].pmdn001_02_01)
                  END IF
               END IF
            END IF 
            
            #採購單位檢查 
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn006_02_01 != l_pmdn_t.pmdn006_02_01 OR
                  l_pmdn_t.pmdn006_02_01 IS NULL THEN
                  CALL apmp490_02_unit_chk(g_pmdn_d[l_ac1].pmdn006_02_01)

                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     NEXT FIELD pmdn006_02_01
                  END IF

                  IF NOT cl_null(g_pmdn_d[l_ac1].pmdn007_02_01) THEN
                     CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmdn007_02_01
                     DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn007_02_01

                     #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                     #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率 
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  #體參數使用採購計價單位
                        CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,
                                                    g_pmdn_d[l_ac1].pmdn006_02_01,
                                                    g_pmdn_d[l_ac1].pmdn010_02_01,
                                                    g_pmdn_d[l_ac1].pmdn007_02_01)
                             RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                        IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
                           CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                                RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                           DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
                        END IF
                     END IF
                  END IF
               END IF
            END IF

            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn006_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn006_02_01_desc

            #採購數量的檢查 
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn007_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn007_02_01 <= 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ade-00016'   #數量不可小於等於0  
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  NEXT FIELD pmdn007_02_01
               END IF

               LET l_qty = g_pmdn_d[l_ac1].pmdn007_02_01
               IF g_pmdn_d[l_ac1].pmdb007_02_01 != g_pmdn_d[l_ac1].pmdn006_02_01 THEN
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                              g_pmdn_d[l_ac1].pmdb007_02_01,l_qty)
                       RETURNING l_qty
               END IF

               #如果採購數量乘上轉換率後，超過未轉採購量的數量，就算錯 
               IF l_qty > g_pmdn_d[l_ac1].qty_02_01 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'apm-00699'     #數量不可大於未轉採購量！  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD pmdn007_02_01
               END IF

               CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn006_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                    RETURNING g_pmdn_d[l_ac1].pmdn007_02_01
               DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn007_02_01 
               
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'Y' THEN
                  IF NOT cl_null(g_pmdn_d[l_ac1].pmdn001_02_01) AND
                     NOT cl_null(g_pmdn_d[l_ac1].pmdn006_02_01) AND
                     NOT cl_null(g_pmdn_d[l_ac1].pmdn008_02_01) THEN
                     CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                                 g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
                     IF NOT cl_null(g_pmdn_d[l_ac1].pmdn009_02_01) THEN
                        CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn008_02_01,g_pmdn_d[l_ac1].pmdn009_02_01)
                             RETURNING g_pmdn_d[l_ac1].pmdn009_02_01
                        DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn009_02_01
                     END IF

                  END IF
               END IF

               #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
               #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率 
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  #體參數使用採購計價單位
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdn001_02_01,g_pmdn_d[l_ac1].pmdn006_02_01,
                                              g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn007_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                  IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
                     CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                          RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                     DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
                  END IF
               END IF

            END IF 
            #參考單位不可輸入 所以這裡不寫入檢查 
            #參考數量不可輸入 所以這裡不寫入檢查 

            #計價單位的檢查 
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
                CALL apmp490_02_unit_chk(g_pmdn_d[l_ac1].pmdn010_02_01)
                IF NOT cl_null(g_errno) THEN
                   INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                   NEXT FIELD pmdn010_02_01
                END IF

                IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
                   CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                        RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                   DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
                END IF
            END IF 
            
            CALL s_desc_get_unit_desc(g_pmdn_d[l_ac1].pmdn010_02_01)
                 RETURNING g_pmdn_d[l_ac1].pmdn010_02_01_desc

            #計價數量的檢查 
            IF NOT cl_null(g_pmdn_d[l_ac1].pmdn011_02_01) THEN
               IF g_pmdn_d[l_ac1].pmdn011_02_01 <= 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'ade-00016'   #數量不可小於等於0  
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  NEXT FIELD pmdn011_02_01
               END IF

               LET l_qty = g_pmdn_d[l_ac1].pmdn011_02_01
               IF g_pmdn_d[l_ac1].pmdb007_02_01 != g_pmdn_d[l_ac1].pmdn010_02_01 THEN
                  CALL apmp490_02_convert_qty(g_pmdn_d[l_ac1].pmdb004_02_01,g_pmdn_d[l_ac1].pmdn010_02_01,
                                              g_pmdn_d[l_ac1].pmdb007_02_01,l_qty)
                       RETURNING l_qty
               END IF 
               
               #如果採購數量乘上轉換率後，超過未轉採購量的數量，就算錯 
               IF l_qty > g_pmdn_d[l_ac1].qty_02_01 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = 'apm-00699'     #數量不可大於未轉採購量！  
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  NEXT FIELD pmdn011_02_01
               END IF

               IF NOT cl_null(g_pmdn_d[l_ac1].pmdn010_02_01) THEN
                  CALL apmp490_02_unit_round(g_pmdn_d[l_ac1].pmdn010_02_01,g_pmdn_d[l_ac1].pmdn011_02_01)
                       RETURNING g_pmdn_d[l_ac1].pmdn011_02_01
                  DISPLAY BY NAME g_pmdn_d[l_ac1].pmdn011_02_01
               END IF
            END IF
            
            UPDATE p490_02_pmdn_t SET pmdl004 = g_pmdn_d[l_ac1].pmdl004_02_01,
                                      pmdn001 = g_pmdn_d[l_ac1].pmdn001_02_01,
                                      pmdn002 = g_pmdn_d[l_ac1].pmdn002_02_01,
                                      pmdn006 = g_pmdn_d[l_ac1].pmdn006_02_01,
                                      pmdn007 = g_pmdn_d[l_ac1].pmdn007_02_01, 
                                      pmdn008 = g_pmdn_d[l_ac1].pmdn008_02_01,
                                      pmdn009 = g_pmdn_d[l_ac1].pmdn009_02_01,                                      
                                      pmdn010 = g_pmdn_d[l_ac1].pmdn010_02_01,
                                      pmdn011 = g_pmdn_d[l_ac1].pmdn011_02_01
             WHERE NVL(pmdl004,' ') = NVL(l_pmdn_t.pmdl004_02_01,' ')
               AND pmdb004 = g_pmdn_d[l_ac1].pmdb004_02_01
               AND pmdb005 = g_pmdn_d[l_ac1].pmdb005_02_01 
               AND pmdn014 = g_pmdn_d[l_ac1].pmdn014_02_01                    #因為有費用料件
               AND NVL(pmdn050,' ') = NVL(g_pmdn_d[l_ac1].pmdn050_02_01,' ')  #所以要多考慮備註 

            EXIT DIALOG

      END INPUT

      ON ACTION EXIT
         LET g_pmdn_d[l_ac1].* = l_pmdn_t.*
         EXIT DIALOG

      ON ACTION close
         EXIT DIALOG
   END DIALOG
END FUNCTION]]>
  </point>
  <point name="free_style.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[ TYPE type_g_pmdn_d RECORD
                              pmdb014_02_01      LIKE pmdb_t.pmdb014,     #供應商選擇 
                              pmdl004_02_01      LIKE pmdl_t.pmdl004,     #供應商編號  
                              pmaal004_02_01     LIKE pmaal_t.pmaal004,   #供應商名稱 
                              pmdb004_02_01      LIKE pmdb_t.pmdb004,     #料件編號  
                              imaal003_02_01_1   LIKE imaal_t.imaal003,   #品名  
                              imaal004_02_01_1   LIKE imaal_t.imaal004,   #規格  
                              pmdb005_02_01      LIKE pmdb_t.pmdb005,     #產品特徵   
                              pmdb005_02_01_desc LIKE type_t.chr80,       #產品特徵說明  
                              pmdb007_02_01      LIKE pmdb_t.pmdb007,     #單位  
                              pmdb007_02_01_desc LIKE type_t.chr80,       #單位說明 
                              qty_02_01          LIKE pmdb_t.pmdb006,     #未轉採購量  
                              pmdn014_02_01      LIKE pmdn_t.pmdn014,     #到庫日期  
                              pmdn001_02_01      LIKE pmdn_t.pmdn001,     #料件編號  
                              imaal003_02_01_2   LIKE imaal_t.imaal003,   #品名  
                              imaal004_02_01_2   LIKE imaal_t.imaal004,   #規格  
                              pmdn002_02_01      LIKE pmdn_t.pmdn002,     #產品特徵   
                              pmdn002_02_01_desc LIKE type_t.chr80,       #產品特徵說明 
                              pmdn006_02_01      LIKE pmdn_t.pmdn006,     #採購單位  
                              pmdn006_02_01_desc LIKE type_t.chr80,       #單位說明 
                              pmdn007_02_01      LIKE pmdn_t.pmdn007,     #採購數量   
                              pmdn008_02_01      LIKE pmdn_t.pmdn008,     #參考單位  
                              pmdn008_02_01_desc LIKE type_t.chr80,       #單位說明 
                              pmdn009_02_01      LIKE pmdn_t.pmdn009,     #參考數量 
                              pmdn010_02_01      LIKE pmdn_t.pmdn010,     #計價單位  
                              pmdn010_02_01_desc LIKE type_t.chr80,       #單位說明           
                              pmdn011_02_01      LIKE pmdn_t.pmdn011,     #計價數量   
                              pmdn050_02_01      LIKE pmdn_t.pmdn050,     #備註 
                              pmdbent_02_01      LIKE pmdb_t.pmdbent,
                              pmdbsite_02_01     LIKE pmdb_t.pmdbsite
                           END RECORD
DEFINE g_pmdn_d            DYNAMIC ARRAY OF type_g_pmdn_d
DEFINE g_pmdn_d_t          type_g_pmdn_d
DEFINE l_ac                LIKE type_t.num5 

DEFINE g_ref_fields        DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields        DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列  

DEFINE g_rec_b             LIKE type_t.num5
DEFINE g_detail_idx        LIKE type_t.num5
DEFINE g_apmp490_02_pmdn_d DYNAMIC ARRAY OF RECORD
                              pmdl004_02_02       LIKE pmdl_t.pmdl004,      #供應商編號  
                              pmaal004_02_02      LIKE pmaal_t.pmaal004,    #供應商名稱 
                              pmdldocno_02_02     LIKE pmdl_t.pmdldocno,    #採購單號  
                              pmdldocdt_02_02     LIKE pmdl_t.pmdldocdt,    #採購日期   
                              pmdl009_02_02       LIKE pmdl_t.pmdl009,      #付款條件   
                              pmdl010_02_02       LIKE pmdl_t.pmdl010,      #交易條件   
                              pmdl011_02_02       LIKE pmdl_t.pmdl011,      #稅別   
                              pmdl012_02_02       LIKE pmdl_t.pmdl012,      #稅率   
                              pmdl013_02_02       LIKE pmdl_t.pmdl013,      #單價含稅否    
                              pmdl015_02_02       LIKE pmdl_t.pmdl015,      #幣別   
                              pmdl016_02_02       LIKE pmdl_t.pmdl016,      #匯率   
                              pmdn007_02_02       LIKE pmdn_t.pmdn007,      #數量   
                              pmdn015_02_02       LIKE pmdn_t.pmdn015,      #單價   
                              pmdn040_02_02       LIKE pmdn_t.pmdn040       #取價來源  
                           END RECORD 
DEFINE g_apmp490_02_pmds_d DYNAMIC ARRAY OF RECORD
                              pmds009_02_03       LIKE pmds_t.pmds009,      #送貨供應商  
                              pmaal004_02_03      LIKE pmaal_t.pmaal004,    #供應商名稱 
                              pmdsdocno_02_03     LIKE pmds_t.pmdsdocno,    #單據單號  
                              pmdo013_02_03       LIKE pmdo_t.pmdo013,      #到庫日期  
                              pmdsdocdt_02_03     LIKE pmds_t.pmdsdocdt,    #單據日期  
                              stus_02_03          LIKE type_t.chr20,        #狀態  
                              diff_day_02_03      LIKE type_t.num10         #差異天數  
                           END RECORD 
DEFINE g_apmp490_02_qcba_d DYNAMIC ARRAY OF RECORD
                              qcba005_02_04       LIKE qcba_t.qcba005,      #供應商 
                              pmaal004_02_04      LIKE pmaal_t.pmaal004,    #供應商名稱 
                              qcbadocno_02_04     LIKE qcba_t.qcbadocno,    #單號  
                              qcba014_02_04       LIKE qcba_t.qcba014,      #檢驗日期  
                              imae116_02_04       LIKE imae_t.imae116,      #檢驗水準  
                              qcba018_02_04       LIKE qcba_t.qcba018,      #檢驗程度  
                              qcba019_02_04       LIKE qcba_t.qcba019,      #檢驗級數  
                              qcba017_02_04       LIKE qcba_t.qcba017,      #送驗量  
                              qcba022_02_04       LIKE qcba_t.qcba022,      #判定結果  
                              qcba023_02_04       LIKE qcba_t.qcba023       #合格量  
                           END RECORD 
DEFINE g_apmp490_02_pmdn_color_d DYNAMIC ARRAY OF RECORD
                                    pmdl004    LIKE type_t.chr80,
                                    pmdb004    LIKE type_t.chr80,
                                    pmdb005    LIKE type_t.chr80,
                                    pmdb007    LIKE type_t.chr80,
                                    qty        LIKE type_t.chr80,
                                    pmdn014    LIKE type_t.chr80,
                                    pmdn001    LIKE type_t.chr80,
                                    pmdn002    LIKE type_t.chr80,
                                    pmdn006    LIKE type_t.chr80,
                                    pmdn007    LIKE type_t.chr80,
                                    pmdn010    LIKE type_t.chr80,
                                    pmdn011    LIKE type_t.chr80,
                                    pmdbent    LIKE type_t.chr80,
                                    pmdbsite   LIKE type_t.chr80
                                 END RECORD
DEFINE g_date                    LIKE pmdl_t.pmdldocdt
DEFINE g_mm                      LIKE type_t.num5]]>
  </point>
  <point name="global.inc" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[GLOBALS "../../apm/4gl/apmp490_01.inc"
GLOBALS "../../apm/4gl/apmp490_02.inc"]]>
  </point>
  <point name="input.a.apaa001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_apaa_m.apaa001) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg2 = '參數2'
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist_and_ref_val("v_apaa001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 
               ELSE
                  #檢查失敗時後續處理
                  NEXT FIELD CURRENT
               END IF
            

            END IF 
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_apaa_m.apaa_t.apaa001
            CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_apaa_m.apaa001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_apaa_m.apaa001_desc

            #此段落由子樣板a05產生
            IF  NOT cl_null(g_apaa_m.apaa001) AND NOT cl_null(g_apaa_m.apaa002) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_apaa_m.apaa001 != g_apaa001_t  OR g_apaa_m.apaa002 != g_apaa002_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apaa_t WHERE "||"apaaent = '" ||g_enterprise|| "' AND apaasite = '" ||g_site|| "' AND "||"apaa001 = '"||g_apaa_m.apaa001 ||"' AND "|| "apaa002 = '"||g_apaa_m.apaa002 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.apaa002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  NOT cl_null(g_apaa_m.apaa001) AND NOT cl_null(g_apaa_m.apaa002) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_apaa_m.apaa001 != g_apaa001_t  OR g_apaa_m.apaa002 != g_apaa002_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apaa_t WHERE "||"apaaent = '" ||g_enterprise|| "' AND apaasite = '" ||g_site|| "' AND "||"apaa001 = '"||g_apaa_m.apaa001 ||"' AND "|| "apaa002 = '"||g_apaa_m.apaa002 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


]]>
  </point>
  <point name="input.c.apaa001" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_apaa_m.apaa001             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #

            
            CALL q_pmaa001_1()                                #呼叫開窗

            LET g_apaa_m.apaa001 = g_qryparam.return1              

            DISPLAY g_apaa_m.apaa001 TO apaa001              #

            NEXT FIELD apaa001                          #返回原欄位

]]>
  </point>
  <point name="show.head.reference" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_apaa_m.apaa_t.apaa001
            CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_apaa_m.apaa001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_apaa_m.apaa001_desc
]]>
  </point>
  <section id="apmp490_02.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:6,PR版次:6) Build-000141
#+ 
#+ Filename...: apmp490_02
#+ Description: 
#+ Creator....: 03079(2014-04-11 17:16:05)
#+ Modifier...: 03079(2015-01-20 17:06:38) -SD/PR-
]]>
  </section>
  <section id="apmp490_02.free_style_variable" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:free_style模組變數(Module Variable)
{<point name="free_style.variable"/>}
#end add-point
]]>
  </section>
  <section id="apmp490_02.global" ver="3" status="" src="s" readonly="">
    <![CDATA[#應用 p00 樣板自動產生(Version:2)
#add-point:註解編寫項目
{<point name="main.memo" />}
#end add-point
 
IMPORT os
#add-point:增加匯入項目
{<point name="main.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
]]>
  </section>
  <section id="apmp490_02.global_variable" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
]]>
  </section>
  <section id="apmp490_02.other_dialog" ver="1" status="" src="s" readonly="">
    <![CDATA[{<point name="other.dialog"/>}
]]>
  </section>
  <section id="apmp490_02.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[{<point name="other.function"/>}
]]>
  </section>
</add_points>
