<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="apmt510_01" std_prog="apmt510_01" erpver="1.0" module="APM" ver="1" env="s" zone="t10dev" booking="Y">
  <point name="function.apmt510_01_pmej006_ref" order="1" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION apmt510_01_pmej006_ref(p_pmej006)
DEFINE p_pmej006      LIKE pmej_t.pmej006
DEFINE r_pmej006_desc LIKE oocql_t.oocql004

   LET r_pmej006_desc = ''

   IF cl_null(p_pmej006) THEN
      RETURN r_pmej006_desc
   END IF
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = p_pmej006
   CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='274' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET r_pmej006_desc = '', g_rtn_fields[1] , ''
   
   RETURN r_pmej006_desc
   
END FUNCTION]]>
  </point>
  <point name="function.apmt510_01_pmej_ins_pmek" order="2" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
#將pmej_t有修改的欄位新增到變更歷程檔內
PRIVATE FUNCTION apmt510_01_pmej_ins_pmek(p_pmej_d)
DEFINE p_pmej_d          type_g_pmej_d
DEFINE r_success         LIKE type_t.num5
DEFINE l_pmdq            RECORD LIKE pmdq_t.*
DEFINE l_ooef019         LIKE ooef_t.ooef019
DEFINE l_pmekseq         LIKE pmek_t.pmekseq
DEFINE l_flag            LIKE type_t.num5      #單身是否有修改

   LET r_success = TRUE

   IF p_pmej_d.pmej901 = '1' THEN
      RETURN r_success
   END IF

   INITIALIZE l_pmdq.* TO NULL
   LET l_flag = FALSE

   IF p_pmej_d.pmej901 = '2' THEN
      SELECT pmdqseq,pmdqseq2,pmdq002,pmdq003,
             pmdq004,pmdq005,pmdq006,pmdq007
        INTO l_pmdq.pmdqseq,l_pmdq.pmdqseq2,l_pmdq.pmdq002,l_pmdq.pmdq003,
             l_pmdq.pmdq004,l_pmdq.pmdq005, l_pmdq.pmdq006,l_pmdq.pmdq007
        FROM pmdq_t
       WHERE pmdqent = g_enterprise
         AND pmdqdocno = p_pmej_d.pmejdocno
         AND pmdqseq = p_pmej_d.pmejseq
         AND pmdqseq2 = p_pmej_d.pmej001
       IF SQLCA.sqlcode THEN
          CALL cl_err('sel pmdq_t',SQLCA.sqlcode,1)
          LET r_success = FALSE
          RETURN r_success
       END IF
   END IF       
   
   #採購項次
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmejseq <> l_pmdq.pmdqseq) OR
     (p_pmej_d.pmejseq IS NULL AND l_pmdq.pmdqseq IS NOT NULL) OR 
     (p_pmej_d.pmejseq IS NOT NULL AND l_pmdq.pmdqseq IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdqseq",p_pmej_d.pmej901,l_pmdq.pmdqseq,p_pmej_d.pmejseq,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdqseq",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF      
   
   #分批序
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej001 <> l_pmdq.pmdqseq2) OR
     (p_pmej_d.pmej001 IS NULL AND l_pmdq.pmdqseq2 IS NOT NULL) OR 
     (p_pmej_d.pmej001 IS NOT NULL AND l_pmdq.pmdqseq2 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdqseq2",p_pmej_d.pmej901,l_pmdq.pmdqseq2,p_pmej_d.pmej001,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdqseq2",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #分批數量
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej002 <> l_pmdq.pmdq002) OR
     (p_pmej_d.pmej002 IS NULL AND l_pmdq.pmdq002 IS NOT NULL) OR 
     (p_pmej_d.pmej002 IS NOT NULL AND l_pmdq.pmdq002 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq002",p_pmej_d.pmej901,l_pmdq.pmdq002,p_pmej_d.pmej002,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq002",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #交貨日期
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej003 <> l_pmdq.pmdq003) OR
     (p_pmej_d.pmej003 IS NULL AND l_pmdq.pmdq003 IS NOT NULL) OR 
     (p_pmej_d.pmej003 IS NOT NULL AND l_pmdq.pmdq003 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq003",p_pmej_d.pmej901,l_pmdq.pmdq003,p_pmej_d.pmej003,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq003",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #到廠日期
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej004 <> l_pmdq.pmdq004) OR
     (p_pmej_d.pmej004 IS NULL AND l_pmdq.pmdq004 IS NOT NULL) OR 
     (p_pmej_d.pmej004 IS NOT NULL AND l_pmdq.pmdq004 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq004",p_pmej_d.pmej901,l_pmdq.pmdq004,p_pmej_d.pmej004,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq004",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #到庫日期
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej005 <> l_pmdq.pmdq005) OR
     (p_pmej_d.pmej005 IS NULL AND l_pmdq.pmdq005 IS NOT NULL) OR 
     (p_pmej_d.pmej005 IS NOT NULL AND l_pmdq.pmdq005 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq005",p_pmej_d.pmej901,l_pmdq.pmdq005,p_pmej_d.pmej005,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq005",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #收貨時段
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej006 <> l_pmdq.pmdq006) OR
     (p_pmej_d.pmej006 IS NULL AND l_pmdq.pmdq006 IS NOT NULL) OR 
     (p_pmej_d.pmej006 IS NOT NULL AND l_pmdq.pmdq006 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq006",p_pmej_d.pmej901,l_pmdq.pmdq006,p_pmej_d.pmej006,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq006",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #MRP凍結否
   IF p_pmej_d.pmej901 ='3' OR (p_pmej_d.pmej901 ='2' AND
     ((p_pmej_d.pmej007 <> l_pmdq.pmdq007) OR
     (p_pmej_d.pmej007 IS NULL AND l_pmdq.pmdq007 IS NOT NULL) OR 
     (p_pmej_d.pmej007 IS NOT NULL AND l_pmdq.pmdq007 IS NULL))) THEN
      #其說明的SQL
      LET g_pmek007 = ''
      #新增資料到變更歷程檔
      IF NOT s_apmt510_ins_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq007",p_pmej_d.pmej901,l_pmdq.pmdq007,p_pmej_d.pmej007,p_pmej_d.pmejdocno,p_pmej_d.pmej900,g_pmek007) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      LET l_flag = TRUE
   ELSE
      #資料一樣，表示無變更，將變更歷程檔刪除
      IF NOT s_apmt510_del_pmek(p_pmej_d.pmejseq,0,p_pmej_d.pmej001,"pmdq007",p_pmej_d.pmejdocno,p_pmej_d.pmej900) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF   
   
   
   #表示此筆單身與採購合約單該筆單身一致
   IF l_flag = FALSE THEN
      UPDATE pmej_t SET pmej901 = '1'
       WHERE pmejent = g_enterprise
         AND pmejdocno = p_pmej_d.pmejdocno
         AND pmejseq = p_pmej_d.pmejseq
         AND pmej001 = p_pmej_d.pmej001
         AND pmej900 = p_pmej_d.pmej900
         
      IF SQLCA.sqlcode THEN
         CALL cl_err('pmej_t',SQLCA.sqlcode,1)
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF

   RETURN r_success   

END FUNCTION]]>
  </point>
  <point name="function.apmt510_01_b_fill" order="3" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION apmt510_01_b_fill()
DEFINE l_sql       STRING
DEFINE l_ac1       LIKE type_t.num5
	
   LET l_sql = "SELECT pmejsite,pmejdocno,pmej900,pmej901,pmejseq,pmej001,pmej002,pmej003, ",
               "       pmej004,pmej005,pmej006,'',pmej007 ",
               "  FROM pmej_t ",	   
               " WHERE pmejent = '",g_enterprise,"' ",
               "   AND pmejdocno = '",g_pmejdocno,"' AND pmejseq = '",g_pmejseq,"' AND pmej900 = '",g_pmej900,"'  "

   PREPARE apmt510_01_pb FROM l_sql
   DECLARE b_fill_curs CURSOR FOR apmt510_01_pb

       CALL g_pmej_d.clear()
       LET l_ac1 = 1
       FOREACH b_fill_curs INTO g_pmej_d[l_ac1].*
          IF SQLCA.sqlcode THEN
             CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
             EXIT FOREACH
          END IF
          
          CALL apmt510_01_pmej006_ref(g_pmej_d[l_ac1].pmej006) RETURNING g_pmej_d[l_ac1].pmej006_desc
          DISPLAY BY NAME g_pmej_d[l_ac1].pmej006_desc
          LET l_ac1 = l_ac1 + 1
          
          IF l_ac1 > g_max_rec THEN
             #CALL cl_err( "", 9035, 0 )
             EXIT FOREACH
          END IF          

       END FOREACH
       CALL g_pmej_d.deleteElement(g_pmej_d.getLength())
       LET g_rec_b = l_ac1 - 1
       DISPLAY g_rec_b TO FORMONLY.cnt
       CLOSE b_fill_curs
       FREE apmt510_01_pb
                      
END FUNCTION]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[DEFINE g_pmejdocno    LIKE pmej_t.pmejdocno   
DEFINE g_pmejseq      LIKE pmej_t.pmejseq     
DEFINE g_pmej900      LIKE pmej_t.pmej900  
DEFINE g_acc          LIKE oocq_t.oocq001
DEFINE g_pmek007      LIKE pmek_t.pmek007
]]>
  </point>
  <point name="input.a.page1.pmej001" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_pmej_d[g_detail_idx].pmejdocno IS NOT NULL AND g_pmej_d[g_detail_idx].pmejseq IS NOT NULL AND g_pmej_d[g_detail_idx].pmej001 IS NOT NULL AND g_pmej_d[g_detail_idx].pmej900 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[g_detail_idx].pmejdocno != g_pmej_d_t.pmejdocno OR g_pmej_d[g_detail_idx].pmejseq != g_pmej_d_t.pmejseq OR g_pmej_d[g_detail_idx].pmej001 != g_pmej_d_t.pmej001 OR g_pmej_d[g_detail_idx].pmej900 != g_pmej_d_t.pmej900)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmej_t WHERE "||"pmejent = '" ||g_enterprise|| "' AND "||"pmejdocno = '"||g_pmej_d[g_detail_idx].pmejdocno ||"' AND "|| "pmejseq = '"||g_pmej_d[g_detail_idx].pmejseq ||"' AND "|| "pmej001 = '"||g_pmej_d[g_detail_idx].pmej001 ||"' AND "|| "pmej900 = '"||g_pmej_d[g_detail_idx].pmej900 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.pmej002" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_pmej_d[l_ac].pmej002) THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[l_ac].pmej002 != g_pmej_d_t.pmej002 OR cl_null(g_pmej_d_t.pmej002))) THEN
               
                  #已維護的分批數量
                  LET l_pmej002=0
                  SELECT SUM(pmej002) INTO l_pmej002 FROM pmej_t 
                   WHERE pmejent = g_enterprise 
                     AND pmejdocno = g_pmejdocno 
                     AND pmejseq = g_pmejseq
                     AND pmej900 = g_pmej900
                  IF cl_null(l_pmej002) THEN LET l_pmej002 = 0 END IF
                  #分批數量總合+本分批數量不可以大於採購數量
                  IF l_pmej002 + g_pmej_d[l_ac].pmej002 > p_pmeg007 THEN
                     CALL cl_err('','apm-00275',1)
                     LET g_pmej_d[l_ac].pmej002 = g_pmej_d_t.pmej002
                     NEXT FIELD CURRENT
                  END IF
               END IF            
            END IF 

]]>
  </point>
  <point name="input.a.page1.pmej003" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_pmej_d[l_ac].pmej003) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[l_ac].pmej003 != g_pmej_d_t.pmej003 OR cl_null(g_pmej_d_t.pmej003))) THEN
                  #1.輸入交貨日期後需自動計算到廠日期，公式為交貨日期+[T:料件據點進銷存檔].[C:到廠前置時間]
                  #2.輸入交貨日期後需自動計算到庫日期，公式為到廠日期+[T:料件據點進銷存檔].[C:到庫前置時間]
                  IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                     CALL s_date_get_date(g_pmej_d[l_ac].pmej003,0,l_imaf173) RETURNING g_pmej_d[l_ac].pmej004
                  ELSE
                     LET g_pmej_d[l_ac].pmej004 = g_pmej_d[l_ac].pmej003
                  END IF
                  IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                     CALL s_date_get_date(g_pmej_d[l_ac].pmej004,0,l_imaf174) RETURNING g_pmej_d[l_ac].pmej005
                  ELSE
                     LET g_pmej_d[l_ac].pmej005 = g_pmej_d[l_ac].pmej004
                  END IF
               END IF
            END IF
            ]]>
  </point>
  <point name="input.a.page1.pmej004" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_pmej_d[l_ac].pmej004) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[l_ac].pmej004 != g_pmej_d_t.pmej004 OR cl_null(g_pmej_d_t.pmej004))) THEN
                  IF NOT cl_null(g_pmej_d[l_ac].pmej003) THEN
                     IF g_pmej_d[l_ac].pmej004 < g_pmej_d[l_ac].pmej003 THEN
                        CALL cl_err(g_pmej_d[l_ac].pmej004,'apm-00267',1)
                        LET g_pmej_d[l_ac].pmej004 = g_pmej_d_t.pmej004
                        NEXT FIELD CURRENT
                      END IF
                  ELSE
                  #若交貨日期為NULL時，輸入到廠日期後需自動計算交貨日期，公式為到廠日期-[T:料件據點進銷存檔].[C:到廠前置時間]
                     IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                        CALL s_date_get_date(g_pmej_d[l_ac].pmej004,0,(l_imaf173*(-1))) RETURNING g_pmej_d[l_ac].pmej003
                     ELSE
                        LET g_pmej_d[l_ac].pmej003 = g_pmej_d[l_ac].pmej004
                     END IF
                  END IF
                  #2.輸入到廠日期後需自動計算到庫日期，公式為到廠日期+[T:料件據點進銷存檔].[C:到庫前置時間]
                  IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                     CALL s_date_get_date(g_pmej_d[l_ac].pmej004,0,l_imaf174) RETURNING g_pmej_d[l_ac].pmej005
                  ELSE
                     LET g_pmej_d[l_ac].pmej005 = g_pmej_d[l_ac].pmej004
                  END IF
               END IF
            END IF     
            ]]>
  </point>
  <point name="input.a.page1.pmej005" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[             IF NOT cl_null(g_pmej_d[l_ac].pmej005) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[l_ac].pmej005 != g_pmej_d_t.pmej005 OR cl_null(g_pmej_d_t.pmej005))) THEN
                  IF NOT cl_null(g_pmej_d[l_ac].pmej004) THEN
                     IF g_pmej_d[l_ac].pmej005 < g_pmej_d[l_ac].pmej004 THEN
                        CALL cl_err(g_pmej_d[l_ac].pmej005,'apm-00271',1)
                        LET g_pmej_d[l_ac].pmej005 = g_pmej_d_t.pmej005
                        NEXT FIELD CURRENT
                     END IF
                  ELSE
                     #若到廠日期為NULL時，輸入到庫日期後需自動計算到廠日期，公式為到庫日期-[T:料件據點進銷存檔].[C:到庫前置時間]
                     IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                        CALL s_date_get_date(g_pmej_d[l_ac].pmej005,0,(l_imaf174*(-1))) RETURNING g_pmej_d[l_ac].pmej004
                     ELSE
                        LET g_pmej_d[l_ac].pmej004 = g_pmej_d[l_ac].pmej005
                     END IF
                  END IF
                  
                  IF NOT cl_null(g_pmej_d[l_ac].pmej003) THEN
                     IF g_pmej_d[l_ac].pmej005 < g_pmej_d[l_ac].pmej003 THEN
                        CALL cl_err(g_pmej_d[l_ac].pmej005,'apm-00272',1)
                        LET g_pmej_d[l_ac].pmej005 = g_pmej_d_t.pmej005
                        NEXT FIELD CURRENT
                     END IF
                  ELSE
                  #若交貨日期為NULL時，輸入到庫日期後需自動計算交貨日期，公式為到廠日期-[T:料件據點進銷存檔].[C:到廠前置時間]
                     IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                        CALL s_date_get_date(g_pmej_d[l_ac].pmej004,0,(l_imaf173*(-1))) RETURNING g_pmej_d[l_ac].pmej003
                     ELSE
                        LET g_pmej_d[l_ac].pmej003 = g_pmej_d[l_ac].pmej004
                     END IF
                  END IF
               END IF
            END IF      
            ]]>
  </point>
  <point name="input.a.page1.pmej006" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            CALL apmt510_01_pmej006_ref(g_pmej_d[l_ac].pmej006) RETURNING g_pmej_d[l_ac].pmej006_desc
            DISPLAY BY NAME g_pmej_d[l_ac].pmej006_desc
            
            IF NOT cl_null(g_pmej_d[l_ac].pmej006) THEN 
               #此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmej_d[l_ac].pmej006
               
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_274") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmej_d[l_ac].pmej006 = g_pmej_d_t.pmej006
                  CALL apmt510_01_pmej006_ref(g_pmej_d[l_ac].pmej006) RETURNING g_pmej_d[l_ac].pmej006_desc
                  DISPLAY BY NAME g_pmej_d[l_ac].pmej006_desc
                  NEXT FIELD CURRENT
               END IF            
            END IF 
]]>
  </point>
  <point name="input.a.page1.pmej900" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_pmej_d[g_detail_idx].pmejdocno IS NOT NULL AND g_pmej_d[g_detail_idx].pmejseq IS NOT NULL AND g_pmej_d[g_detail_idx].pmej001 IS NOT NULL AND g_pmej_d[g_detail_idx].pmej900 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[g_detail_idx].pmejdocno != g_pmej_d_t.pmejdocno OR g_pmej_d[g_detail_idx].pmejseq != g_pmej_d_t.pmejseq OR g_pmej_d[g_detail_idx].pmej001 != g_pmej_d_t.pmej001 OR g_pmej_d[g_detail_idx].pmej900 != g_pmej_d_t.pmej900)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmej_t WHERE "||"pmejent = '" ||g_enterprise|| "' AND "||"pmejdocno = '"||g_pmej_d[g_detail_idx].pmejdocno ||"' AND "|| "pmejseq = '"||g_pmej_d[g_detail_idx].pmejseq ||"' AND "|| "pmej001 = '"||g_pmej_d[g_detail_idx].pmej001 ||"' AND "|| "pmej900 = '"||g_pmej_d[g_detail_idx].pmej900 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.pmej902" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            CALL apmt510_01_pmej902_ref()
            
            IF NOT cl_null(g_pmej_d[l_ac].pmej902) THEN
               IF l_cmd = 'a' OR
               (l_cmd = 'u' AND (g_pmej_d[l_ac].pmej902 <> g_pmej_d_t.pmej902 OR g_pmej_d_t.pmej902 IS NULL)) THEN
                  IF NOT apmt510_01_reason_chk(g_acc,g_pmej_d[l_ac].pmej902) THEN
                     LET g_pmej_d[l_ac].pmej902 = g_pmej_d_t.pmej902
                     DISPLAY BY NAME g_pmej_d[l_ac].pmej902
                     CALL apmt510_01_pmej902_ref()
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.pmejdocno" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_pmej_d[g_detail_idx].pmejdocno IS NOT NULL AND g_pmej_d[g_detail_idx].pmejseq IS NOT NULL AND g_pmej_d[g_detail_idx].pmej001 IS NOT NULL AND g_pmej_d[g_detail_idx].pmej900 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[g_detail_idx].pmejdocno != g_pmej_d_t.pmejdocno OR g_pmej_d[g_detail_idx].pmejseq != g_pmej_d_t.pmejseq OR g_pmej_d[g_detail_idx].pmej001 != g_pmej_d_t.pmej001 OR g_pmej_d[g_detail_idx].pmej900 != g_pmej_d_t.pmej900)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmej_t WHERE "||"pmejent = '" ||g_enterprise|| "' AND "||"pmejdocno = '"||g_pmej_d[g_detail_idx].pmejdocno ||"' AND "|| "pmejseq = '"||g_pmej_d[g_detail_idx].pmejseq ||"' AND "|| "pmej001 = '"||g_pmej_d[g_detail_idx].pmej001 ||"' AND "|| "pmej900 = '"||g_pmej_d[g_detail_idx].pmej900 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.pmejseq" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_pmej_d[g_detail_idx].pmejdocno IS NOT NULL AND g_pmej_d[g_detail_idx].pmejseq IS NOT NULL AND g_pmej_d[g_detail_idx].pmej001 IS NOT NULL AND g_pmej_d[g_detail_idx].pmej900 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmej_d[g_detail_idx].pmejdocno != g_pmej_d_t.pmejdocno OR g_pmej_d[g_detail_idx].pmejseq != g_pmej_d_t.pmejseq OR g_pmej_d[g_detail_idx].pmej001 != g_pmej_d_t.pmej001 OR g_pmej_d[g_detail_idx].pmej900 != g_pmej_d_t.pmej900)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmej_t WHERE "||"pmejent = '" ||g_enterprise|| "' AND "||"pmejdocno = '"||g_pmej_d[g_detail_idx].pmejdocno ||"' AND "|| "pmejseq = '"||g_pmej_d[g_detail_idx].pmejseq ||"' AND "|| "pmej001 = '"||g_pmej_d[g_detail_idx].pmej001 ||"' AND "|| "pmej900 = '"||g_pmej_d[g_detail_idx].pmej900 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.before_close" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   LET INT_FLAG = FALSE
]]>
  </point>
  <point name="input.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            CALL apmt510_01_b_fill()
            LET g_rec_b = g_pmej_d.getLength()
            
         BEFORE ROW 
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            
            CALL s_transaction_begin()
   
            LET g_rec_b = g_pmej_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND NOT cl_null(g_pmej_d[l_ac].pmejdocno)
               AND NOT cl_null(g_pmej_d[l_ac].pmejseq) 
               AND NOT cl_null(g_pmej_d[l_ac].pmej001) 
            THEN
               LET l_cmd='u'
			   LET g_pmej_d_t.* = g_pmej_d[l_ac].*  #BACKUP			   
			   OPEN apmt510_01_bcl USING g_enterprise,g_pmej_d[l_ac].pmejdocno,g_pmej_d[l_ac].pmejseq,
			                             g_pmej_d[l_ac].pmej001,g_pmej_d[l_ac].pmej900
               IF SQLCA.sqlcode THEN
                  CALL cl_err("apmt510_01_bcl",SQLCA.sqlcode,1)
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt510_01_bcl INTO g_pmej_d[l_ac].*         
                  IF SQLCA.sqlcode THEN
                     CALL cl_err(g_pmej_d[l_ac].pmejdocno,SQLCA.sqlcode,1)
                     LET l_lock_sw = "Y"
                  END IF  
                  CALL apmt510_01_pmej006_ref(g_pmej_d[l_ac].pmej006) RETURNING g_pmej_d[l_ac].pmej006_desc
                  DISPLAY BY NAME g_pmej_d[l_ac].pmej006_desc
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF                  

         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmej_d[l_ac].* TO NULL          
            
            LET g_pmej_d[l_ac].pmejsite = g_site
            LET g_pmej_d[l_ac].pmejdocno = g_pmejdocno
            LET g_pmej_d[l_ac].pmejseq = g_pmejseq
            LET g_pmej_d[l_ac].pmej900 = g_pmej900
            LET g_pmej_d[l_ac].pmej006 = l_imaf176

            CALL apmt510_01_pmej006_ref(g_pmej_d[l_ac].pmej006) RETURNING g_pmej_d[l_ac].pmej006_desc
            DISPLAY BY NAME g_pmej_d[l_ac].pmej006_desc

            LET g_pmej_d[l_ac].pmej007 = 'N'
            LET g_pmej_d[l_ac].pmej901 = '3'  #單身新增

            SELECT MAX(pmej001)+1 INTO g_pmej_d[l_ac].pmej001
              FROM pmej_t 
             WHERE pmejent = g_enterprise 
               AND pmejdocno = g_pmejdocno AND pmejseq = g_pmejseq 
               AND pmej900 = g_pmej900                             
            IF cl_null(g_pmej_d[l_ac].pmej001) OR g_pmej_d[l_ac].pmej001 = 0 THEN
               LET g_pmej_d[l_ac].pmej001 = 1
            END IF
            
            LET g_pmej_d_t.* = g_pmej_d[l_ac].*     #新輸入資料

            CALL cl_show_fld_cont()
            
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
          
            LET l_count = 1
            SELECT COUNT(*) INTO l_count FROM pmej_t
             WHERE pmejent = g_enterprise 
               AND pmejdocno = g_pmej_d[l_ac].pmejdocno
               AND pmejseq = g_pmej_d[l_ac].pmejseq               
               AND pmej001 = g_pmej_d[l_ac].pmej001   
               AND pmej900 = g_pmej_d[l_ac].pmej900               
       
            IF l_count = 0 THEN     #資料未重複，插入新增資料
               INSERT INTO pmej_t 
                          (pmejent,pmejsite,pmejdocno,pmejseq,pmej001,pmej900,
                           pmej002,pmej003,
                           pmej004,pmej005,pmej006,pmej007,pmej901)
                   VALUES (g_enterprise,g_site,g_pmej_d[l_ac].pmejdocno,g_pmej_d[l_ac].pmejseq,g_pmej_d[l_ac].pmej001,
                           g_pmej_d[l_ac].pmej900,
                           g_pmej_d[l_ac].pmej002,g_pmej_d[l_ac].pmej003,g_pmej_d[l_ac].pmej004,g_pmej_d[l_ac].pmej005,
                           g_pmej_d[l_ac].pmej006,g_pmej_d[l_ac].pmej007,g_pmej_d[l_ac].pmej901)     
               IF SQLCA.SQLcode  THEN
                  CALL cl_err("pmej_t",SQLCA.sqlcode,1)  
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               ELSE
                  #新增變更歷程檔
                  IF NOT apmt510_01_pmej_ins_pmek(g_pmej_d[l_ac].*) THEN
                     LET g_pmej_d[l_ac].* = g_pmej_d_t.*
                     CALL s_transaction_end('N','0')                    
                     CANCEL INSERT                     
                  END IF
                  
                  CALL s_transaction_end('Y','0')
                  ERROR 'INSERT O.K'
                  LET g_rec_b = g_rec_b + 1
               END IF                           
            ELSE    
               CALL cl_err('INSERT',"std-00006",1)
               INITIALIZE g_pmej_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF                           


            
         BEFORE DELETE                            #是否取消單身
            IF NOT cl_null(g_pmej_d[l_ac].pmejdocno)
               AND NOT cl_null(g_pmej_d[l_ac].pmejseq) 
               AND NOT cl_null(g_pmej_d[l_ac].pmej001) THEN 

               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  CALL cl_err("", -263, 1)
                  CANCEL DELETE
               END IF
               
               DELETE FROM pmej_t
                WHERE pmejent = g_enterprise 
                  AND pmejdocno = g_pmej_d_t.pmejdocno
                  AND pmejseq = g_pmej_d_t.pmejseq
                  AND pmej001 = g_pmej_d_t.pmej001
                  AND pmej900 = g_pmej_d_t.pmej900

               IF SQLCA.sqlcode THEN
                  CALL cl_err("pmej_t",SQLCA.sqlcode,1)
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE   
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF 
               CLOSE apmt510_01_bcl
               LET l_count = g_pmej_d.getLength()
            END IF 
            
        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_pmej_d[l_ac].* = g_pmej_d_t.*
               CLOSE apmt510_01_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_pmej_d[l_ac].pmej002,-263,1)
               LET g_pmej_d[l_ac].* = g_pmej_d_t.*
            ELSE
               IF g_pmej_d[l_ac].pmej901 ='1' THEN
                  LET g_pmej_d[l_ac].pmej901 ='2'
               END IF
               
               UPDATE pmej_t SET (pmejseq,
                                  pmej001,pmej002,pmej003,pmej004,pmej005,pmej006,pmej007,
                                  pmej900,pmej901) 
                               = (g_pmej_d[l_ac].pmejseq,
                                  g_pmej_d[l_ac].pmej001,g_pmej_d[l_ac].pmej002,g_pmej_d[l_ac].pmej003,g_pmej_d[l_ac].pmej004,
                                  g_pmej_d[l_ac].pmej005,g_pmej_d[l_ac].pmej006,g_pmej_d[l_ac].pmej007,
                                  g_pmej_d[l_ac].pmej900,g_pmej_d[l_ac].pmej901)
                WHERE pmejent   = g_enterprise 
                  AND pmejdocno = g_pmej_d_t.pmejdocno
                  AND pmejseq   = g_pmej_d_t.pmejseq
                  AND pmej001   = g_pmej_d_t.pmej001
                  AND pmej900   = g_pmej_d_t.pmej900

               IF SQLCA.sqlcode THEN
                  CALL cl_err("pmej_t",SQLCA.sqlcode,1)
                  LET g_pmej_d[l_ac].* = g_pmej_d_t.*
                  CALL s_transaction_end('N','0')
               ELSE
                  #新增變更歷程檔
                  IF NOT apmt510_01_pmej_ins_pmek(g_pmej_d[l_ac].*) THEN
                     LET g_pmej_d[l_ac].* = g_pmej_d_t.*
                     CALL s_transaction_end('N','0')            
                  END IF
                  
                  CALL s_transaction_end('Y','0')
               END IF               
            END IF
            
         AFTER ROW
            CLOSE apmt510_01_bcl
            CALL s_transaction_end('Y','0')]]>
  </point>
  <point name="input.c.page1.pmej006" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmej_d[l_ac].pmej006             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "274"
            
            CALL q_oocq002()                                #呼叫開窗

            LET g_pmej_d[l_ac].pmej006 = g_qryparam.return1              

            DISPLAY g_pmej_d[l_ac].pmej006 TO pmej006              #

            CALL apmt510_01_pmej006_ref(g_pmej_d[l_ac].pmej006) RETURNING g_pmej_d[l_ac].pmej006_desc
            DISPLAY BY NAME g_pmej_d[l_ac].pmej006_desc
            NEXT FIELD pmej006                          #返回原欄位

]]>
  </point>
  <point name="input.c.page1.pmej901" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmej_d[l_ac].pmej901             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #

            
            CALL q_oocq002()                                #呼叫開窗

            LET g_pmej_d[l_ac].pmej901 = g_qryparam.return1              

            DISPLAY g_pmej_d[l_ac].pmej901 TO pmej901              #

            NEXT FIELD pmej901                          #返回原欄位

]]>
  </point>
  <point name="input.c.page1.pmej902" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmej_d[l_ac].pmej902             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_acc
            
            CALL q_oocq002()                                #呼叫開窗

            LET g_pmej_d[l_ac].pmej902 = g_qryparam.return1              

            DISPLAY g_pmej_d[l_ac].pmej902 TO pmej902              #

            CALL apmt510_01_pmej902_ref()
            NEXT FIELD pmej902                          #返回原欄位
]]>
  </point>
  <point name="input.define" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   DEFINE p_pmejdocno     LIKE pmej_t.pmejdocno
   DEFINE p_pmejseq       LIKE pmej_t.pmejseq
   DEFINE p_pmej900       LIKE pmej_t.pmej900
   DEFINE p_pmeg007       LIKE pmeg_t.pmeg007
   DEFINE r_pmej003       LIKE pmej_t.pmej003
   DEFINE r_pmej004       LIKE pmej_t.pmej004
   DEFINE r_pmej005       LIKE pmej_t.pmej005
   DEFINE l_lock_sw       LIKE type_t.chr1
   DEFINE l_forupd_sql    STRING
   DEFINE l_n             LIKE type_t.num5                #檢查重複用  
   DEFINE l_cnt           LIKE type_t.num5
   DEFINE l_pmeg007       LIKE pmeg_t.pmeg007
   DEFINE l_pmej002       LIKE pmej_t.pmej002
   DEFINE l_imaf173       LIKE imaf_t.imaf173
   DEFINE l_imaf174       LIKE imaf_t.imaf174
   DEFINE l_imaf176       LIKE imaf_t.imaf176
   DEFINE l_pmeg001       LIKE pmeg_t.pmeg001
   DEFINE l_pmej003       LIKE pmej_t.pmej003
   ]]>
  </point>
  <point name="input.get_var" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   p_pmejdocno,p_pmejseq,p_pmej900,p_pmeg007]]>
  </point>
  <point name="input.post_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   
   #離開時回傳交貨日期最早的那一分批序的交貨日期、到廠日期、到庫日期
   LET l_pmej003 = ''
   LET r_pmej003 = ''
   LET r_pmej004 = ''
   LET r_pmej005 = ''
   
   SELECT MIN(pmej003) INTO l_pmej003 FROM pmej_t 
    WHERE pmejent   = g_enterprise 
      AND pmejdocno = g_pmejdocno 
      AND pmejseq = g_pmejseq
      AND pmej900 = g_pmej900      
    
   IF NOT cl_null(l_pmej003) THEN
      SELECT pmej003,pmej004,pmej005 
        INTO r_pmej003,r_pmej004,r_pmej005 
        FROM pmej_t
       WHERE pmejent = g_enterprise 
         AND pmejdocno = g_pmejdocno AND pmejseq = g_pmejseq AND pmej900 = g_pmej900 
         AND pmej003 = l_pmej003 AND rownum = 1
   END IF
   RETURN r_pmej003,r_pmej004,r_pmej005
   ]]>
  </point>
  <point name="input.pre_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   
   WHENEVER ERROR CONTINUE
   
   LET g_pmejdocno = p_pmejdocno
   LET g_pmejseq   = p_pmejseq
   LET g_pmej900   = p_pmej900
   
   SELECT gzcb008 INTO g_acc
     FROM gzcb_t
    WHERE gzcb001 = '24'
      AND gzcb002 = 'apmt500'
      
   CALL apmt510_01_b_fill()
   
   LET l_forupd_sql = "SELECT pmejsite,pmejdocno,pmej900,pmej901,pmejseq,pmej001,pmej002,pmej003, ",
                      "       pmej004,pmej005,pmej006,'',pmej007 ",
                      "  FROM pmej_t ",
                      " WHERE pmejent = ? ",
                      "   AND pmejdocno = ? AND pmejseq = ? AND pmej001 = ?  AND pmej900 = ? FOR UPDATE"
   LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)
   DECLARE apmt510_01_bcl CURSOR FROM l_forupd_sql

   LET l_pmeg001 = ''
   #獲得採購料件編號
   SELECT pmeg001 INTO l_pmeg001 FROM pmeg_t 
    WHERE pmegent = g_enterprise AND pmegdocno = g_pmejdocno AND pmegseq = g_pmejseq
      AND pmeg900 = g_pmej900
   
   LET l_imaf173 = 0
   LET l_imaf174 = 0
   LET l_imaf176 = ''   
   #獲得到廠前置時間、到庫前置時間、收穫時段
   SELECT imaf173,imaf174,imaf176 
     INTO l_imaf173,l_imaf174,l_imaf176 
     FROM imaf_t 
    WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmeg001
    ]]>
  </point>
  <point name="show.body.reference" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmej_d[l_ac].pmej006
            CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='274' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmej_d[l_ac].pmej006_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmej_d[l_ac].pmej006_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmej_d[l_ac].pmej902
            CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='267' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmej_d[l_ac].pmej902_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmej_d[l_ac].pmej902_desc
]]>
  </point>
  <section id="apmt510_01.description" ver="56" status="" src="s">
    <![CDATA[#+ Version..: T100-ERP-1.00.00(SD版次:1,PD版次:1) Build-000055
#+ 
#+ Filename...: apmt510_01
#+ Description: ...
#+ Creator....: 02750(2014/03/31)
#+ Modifier...: 02750(2014/04/09)
#+ Buildtype..: 應用 c02b 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
  </section>
  <section id="apmt510_01.global" ver="7" status="" src="s">
    <![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單身 type 宣告
PRIVATE TYPE type_g_pmej_d        RECORD
       pmejsite LIKE pmej_t.pmejsite, 
   pmejdocno LIKE pmej_t.pmejdocno, 
   pmej900 LIKE pmej_t.pmej900, 
   pmej901 LIKE pmej_t.pmej901, 
   pmejseq LIKE pmej_t.pmejseq, 
   pmej001 LIKE pmej_t.pmej001, 
   pmej002 LIKE pmej_t.pmej002, 
   pmej003 LIKE pmej_t.pmej003, 
   pmej004 LIKE pmej_t.pmej004, 
   pmej005 LIKE pmej_t.pmej005, 
   pmej006 LIKE pmej_t.pmej006, 
   pmej006_desc LIKE type_t.chr500, 
   pmej007 LIKE pmej_t.pmej007
       END RECORD
 
 
DEFINE g_pmej_d          DYNAMIC ARRAY OF type_g_pmej_d
DEFINE g_pmej_d_t        type_g_pmej_d
 
 
DEFINE g_pmejdocno_t   LIKE pmej_t.pmejdocno    #Key值備份
DEFINE g_pmejseq_t      LIKE pmej_t.pmejseq    #Key值備份
DEFINE g_pmej001_t      LIKE pmej_t.pmej001    #Key值備份
DEFINE g_pmej900_t      LIKE pmej_t.pmej900    #Key值備份
 
 
DEFINE l_ac                  LIKE type_t.num5
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rec_b               LIKE type_t.num5  
DEFINE g_detail_idx          LIKE type_t.num5  
 
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
    
#add-point:傳入參數說明(global.argv)
{<point name="global.argv"/>}
#end add-point	
]]>
  </section>
  <section id="apmt510_01.input" ver="4" status="" src="s">
    <![CDATA[#+ 資料輸入
PUBLIC FUNCTION apmt510_01(--)
   #add-point:input段變數傳入
   {<point name="input.get_var"/>}
   #end add-point
   )
   DEFINE l_ac_t          LIKE type_t.num5        #未取消的ARRAY CNT 
   DEFINE l_allow_insert  LIKE type_t.num5        #可新增否 
   DEFINE l_allow_delete  LIKE type_t.num5        #可刪除否  
   DEFINE l_count         LIKE type_t.num5
   DEFINE l_insert        LIKE type_t.num5
   DEFINE l_cmd           LIKE type_t.chr5
   #add-point:input段define
   {<point name="input.define"/>}
   #end add-point
 
   #畫面開啟 (identifier)
   OPEN WINDOW w_apmt510_01 WITH FORM cl_ap_formpath("apm","apmt510_01")
 
   #瀏覽頁簽資料初始化
   CALL cl_ui_init()
   
   LET g_qryparam.state = "i"
   
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   
   #輸入前處理
   #add-point:單身前置處理
   {<point name="input.pre_input"/>}
   #end add-point
  
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      #輸入開始
      INPUT ARRAY g_pmej_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
         
         #自訂ACTION
         #add-point:單身前置處理
         {<point name="input.action"/>}
         #end add-point
         
         #自訂ACTION(detail_input)
         
         
         BEFORE INPUT
            #add-point:單身輸入前處理
            {<point name="input.before_input"/>}
            #end add-point
          
         #---------------------<  Detail: page1  >---------------------
         #----<<pmejsite>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmejsite
            #add-point:BEFORE FIELD pmejsite
            {<point name="input.b.page1.pmejsite" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmejsite
            
            #add-point:AFTER FIELD pmejsite
            {<point name="input.a.page1.pmejsite" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmejsite
            #add-point:ON CHANGE pmejsite
            {<point name="input.g.page1.pmejsite" />}
            #END add-point
 
         #----<<pmejdocno>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmejdocno
            #add-point:BEFORE FIELD pmejdocno
            {<point name="input.b.page1.pmejdocno" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmejdocno
            
            #add-point:AFTER FIELD pmejdocno
            {<point name="input.a.page1.pmejdocno" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmejdocno
            #add-point:ON CHANGE pmejdocno
            {<point name="input.g.page1.pmejdocno" />}
            #END add-point
 
         #----<<pmej900>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej900
            #add-point:BEFORE FIELD pmej900
            {<point name="input.b.page1.pmej900" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej900
            
            #add-point:AFTER FIELD pmej900
            {<point name="input.a.page1.pmej900" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej900
            #add-point:ON CHANGE pmej900
            {<point name="input.g.page1.pmej900" />}
            #END add-point
 
         #----<<pmej901>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej901
            #add-point:BEFORE FIELD pmej901
            {<point name="input.b.page1.pmej901" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej901
            
            #add-point:AFTER FIELD pmej901
            {<point name="input.a.page1.pmej901" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej901
            #add-point:ON CHANGE pmej901
            {<point name="input.g.page1.pmej901" />}
            #END add-point
 
         #----<<pmejseq>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmejseq
            #add-point:BEFORE FIELD pmejseq
            {<point name="input.b.page1.pmejseq" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmejseq
            
            #add-point:AFTER FIELD pmejseq
            {<point name="input.a.page1.pmejseq" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmejseq
            #add-point:ON CHANGE pmejseq
            {<point name="input.g.page1.pmejseq" />}
            #END add-point
 
         #----<<pmej001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej001
            #add-point:BEFORE FIELD pmej001
            {<point name="input.b.page1.pmej001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej001
            
            #add-point:AFTER FIELD pmej001
            {<point name="input.a.page1.pmej001" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej001
            #add-point:ON CHANGE pmej001
            {<point name="input.g.page1.pmej001" />}
            #END add-point
 
         #----<<pmej002>>----
         #此段落由子樣板a02產生
         AFTER FIELD pmej002
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_pmej_d[l_ac].pmej002,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmej002
            END IF
 
 
            #add-point:AFTER FIELD pmej002
            {<point name="input.a.page1.pmej002" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmej002
            #add-point:BEFORE FIELD pmej002
            {<point name="input.b.page1.pmej002" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE pmej002
            #add-point:ON CHANGE pmej002
            {<point name="input.g.page1.pmej002" />}
            #END add-point
 
         #----<<pmej003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej003
            #add-point:BEFORE FIELD pmej003
            {<point name="input.b.page1.pmej003" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej003
            
            #add-point:AFTER FIELD pmej003
            {<point name="input.a.page1.pmej003" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej003
            #add-point:ON CHANGE pmej003
            {<point name="input.g.page1.pmej003" />}
            #END add-point
 
         #----<<pmej004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej004
            #add-point:BEFORE FIELD pmej004
            {<point name="input.b.page1.pmej004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej004
            
            #add-point:AFTER FIELD pmej004
            {<point name="input.a.page1.pmej004" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej004
            #add-point:ON CHANGE pmej004
            {<point name="input.g.page1.pmej004" />}
            #END add-point
 
         #----<<pmej005>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej005
            #add-point:BEFORE FIELD pmej005
            {<point name="input.b.page1.pmej005" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej005
            
            #add-point:AFTER FIELD pmej005
            {<point name="input.a.page1.pmej005" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej005
            #add-point:ON CHANGE pmej005
            {<point name="input.g.page1.pmej005" />}
            #END add-point
 
         #----<<pmej006>>----
         #此段落由子樣板a02產生
         AFTER FIELD pmej006
            
            #add-point:AFTER FIELD pmej006
            {<point name="input.a.page1.pmej006" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD pmej006
            #add-point:BEFORE FIELD pmej006
            {<point name="input.b.page1.pmej006" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE pmej006
            #add-point:ON CHANGE pmej006
            {<point name="input.g.page1.pmej006" />}
            #END add-point
 
         #----<<pmej006_desc>>----
         #----<<pmej007>>----
         #此段落由子樣板a01產生
         BEFORE FIELD pmej007
            #add-point:BEFORE FIELD pmej007
            {<point name="input.b.page1.pmej007" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD pmej007
            
            #add-point:AFTER FIELD pmej007
            {<point name="input.a.page1.pmej007" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE pmej007
            #add-point:ON CHANGE pmej007
            {<point name="input.g.page1.pmej007" />}
            #END add-point
 
 
         #---------------------<  Detail: page1  >---------------------
         #----<<pmejsite>>----
         #Ctrlp:input.c.page1.pmejsite
         ON ACTION controlp INFIELD pmejsite
            #add-point:ON ACTION controlp INFIELD pmejsite
            {<point name="input.c.page1.pmejsite" />}
            #END add-point
 
         #----<<pmejdocno>>----
         #Ctrlp:input.c.page1.pmejdocno
         ON ACTION controlp INFIELD pmejdocno
            #add-point:ON ACTION controlp INFIELD pmejdocno
            {<point name="input.c.page1.pmejdocno" />}
            #END add-point
 
         #----<<pmej900>>----
         #Ctrlp:input.c.page1.pmej900
         ON ACTION controlp INFIELD pmej900
            #add-point:ON ACTION controlp INFIELD pmej900
            {<point name="input.c.page1.pmej900" />}
            #END add-point
 
         #----<<pmej901>>----
         #Ctrlp:input.c.page1.pmej901
         ON ACTION controlp INFIELD pmej901
            #add-point:ON ACTION controlp INFIELD pmej901
            {<point name="input.c.page1.pmej901" />}
            #END add-point
 
         #----<<pmejseq>>----
         #Ctrlp:input.c.page1.pmejseq
         ON ACTION controlp INFIELD pmejseq
            #add-point:ON ACTION controlp INFIELD pmejseq
            {<point name="input.c.page1.pmejseq" />}
            #END add-point
 
         #----<<pmej001>>----
         #Ctrlp:input.c.page1.pmej001
         ON ACTION controlp INFIELD pmej001
            #add-point:ON ACTION controlp INFIELD pmej001
            {<point name="input.c.page1.pmej001" />}
            #END add-point
 
         #----<<pmej002>>----
         #Ctrlp:input.c.page1.pmej002
         ON ACTION controlp INFIELD pmej002
            #add-point:ON ACTION controlp INFIELD pmej002
            {<point name="input.c.page1.pmej002" />}
            #END add-point
 
         #----<<pmej003>>----
         #Ctrlp:input.c.page1.pmej003
         ON ACTION controlp INFIELD pmej003
            #add-point:ON ACTION controlp INFIELD pmej003
            {<point name="input.c.page1.pmej003" />}
            #END add-point
 
         #----<<pmej004>>----
         #Ctrlp:input.c.page1.pmej004
         ON ACTION controlp INFIELD pmej004
            #add-point:ON ACTION controlp INFIELD pmej004
            {<point name="input.c.page1.pmej004" />}
            #END add-point
 
         #----<<pmej005>>----
         #Ctrlp:input.c.page1.pmej005
         ON ACTION controlp INFIELD pmej005
            #add-point:ON ACTION controlp INFIELD pmej005
            {<point name="input.c.page1.pmej005" />}
            #END add-point
 
         #----<<pmej006>>----
         #Ctrlp:input.c.page1.pmej006
         ON ACTION controlp INFIELD pmej006
            #add-point:ON ACTION controlp INFIELD pmej006
            {<point name="input.c.page1.pmej006" />}
            #END add-point
 
         #----<<pmej006_desc>>----
         #----<<pmej007>>----
         #Ctrlp:input.c.page1.pmej007
         ON ACTION controlp INFIELD pmej007
            #add-point:ON ACTION controlp INFIELD pmej007
            {<point name="input.c.page1.pmej007" />}
            #END add-point
 
 
 
         AFTER INPUT
            #add-point:單身輸入後處理
            {<point name="input.after_input"/>}
            #end add-point
            
      END INPUT
      
 
      
      #add-point:自定義input
      {<point name="input.more_input"/>}
      #end add-point
    
      #公用action
      ON ACTION accept
         ACCEPT DIALOG
        
      ON ACTION cancel
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
 
   #add-point:畫面關閉前
   {<point name="input.before_close"/>}
   #end add-point
   
   #畫面關閉
   CLOSE WINDOW w_apmt510_01 
   
   #add-point:input段after input 
   {<point name="input.post_input"/>}
   #end add-point    
   
END FUNCTION
]]>
  </section>
  <section id="apmt510_01.other_dialog" ver="1" status="" src="s">
    <![CDATA[{<point name="other.dialog"/>}
]]>
  </section>
  <section id="apmt510_01.other_function" ver="1" status="" src="s">
    <![CDATA[{<point name="other.function"/>}
]]>
  </section>
</add_points>
