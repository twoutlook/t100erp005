<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="apmp110" std_prog="apmp110" erpver="1.0" module="APM" ver="2" env="s" zone="t10prd" booking="N" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="W" status=""/>
    <free_style value="N" status=""/>
    <start_arg value="" status=""/>
  </other>
  <point name="function.apmp110_count" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 異動匯總數量及單據性質
# Memo...........:
# Usage..........: CALL apmp110_count()
# Input parameter: no
# Return code....: no
# Date & Author..: 140825 By whiteny
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_count()
DEFINE l_success  LIKE type_t.num5
DEFINE l_pmdt  RECORD
    pmdt020  LIKE pmdt_t.pmdt020,
    pmdt021  LIKE pmdt_t.pmdt021,
    pmdt022  LIKE pmdt_t.pmdt022,
    pmdt023  LIKE pmdt_t.pmdt023,
    pmdt024  LIKE pmdt_t.pmdt024
            END RECORD

   INITIALIZE l_pmdt.* TO NULL
   #數量是已經是針對相同料件編號、產品特徵、庫存管理特徵、單位、庫位、儲位、批號進行加總後的值
   SELECT SUM(inaj011) INTO l_pmdt.pmdt020 FROM apmp110_tmp3
    WHERE inaj005 = g_detail_d[g_master_idx].inaj005
      AND inaj006 = g_detail_d[g_master_idx].inaj006
      AND inaj007 = g_detail_d[g_master_idx].pmds007
      AND inaj008 = g_detail_d[g_master_idx].inaj008
      AND inaj009 = g_detail_d[g_master_idx].inaj009
      AND inaj010 = g_detail_d[g_master_idx].inaj010
      AND inaj012 = g_detail_d[g_master_idx].inaj012
   IF cl_null(l_pmdt.pmdt020) THEN LET l_pmdt.pmdt020 = 0 END IF
   IF l_pmdt.pmdt020 < 0 THEN
      LET l_pmdt.pmdt020 = l_pmdt.pmdt020 * (-1)
   END IF
   #料件據點進銷存檔設置的參考單位、採購計價單位
   SELECT imaf015,imaf144 INTO l_pmdt.pmdt021,l_pmdt.pmdt023 FROM imaf_t
    WHERE imafent = g_enterprise AND imafsite = g_site
      AND imaf001 = g_detail_d[g_master_idx].inaj005
   #參考數量由交易數量乘上交易單位與參考單位的換算率做預設
   IF NOT cl_null(l_pmdt.pmdt021) THEN
      CALL s_aooi250_convert_qty(g_detail_d[g_master_idx].inaj005,g_detail_d[g_master_idx].inaj012,
                                 l_pmdt.pmdt021,l_pmdt.pmdt020)
           RETURNING l_success,l_pmdt.pmdt022
   END IF
   #計價數量由交易數量乘上交易單位與計價單位的換算率做預設
   IF NOT cl_null(l_pmdt.pmdt023) THEN
      CALL s_aooi250_convert_qty(g_detail_d[g_master_idx].inaj005,g_detail_d[g_master_idx].inaj012,
                                 l_pmdt.pmdt023,l_pmdt.pmdt020)
           RETURNING l_success,l_pmdt.pmdt024
   END IF

   UPDATE apmp110_tmp2 SET pmdt020 = l_pmdt.pmdt020,
                           pmdt021 = l_pmdt.pmdt021,
                           pmdt022 = l_pmdt.pmdt022,
                           pmdt023 = l_pmdt.pmdt023,
                           pmdt024 = l_pmdt.pmdt024
    WHERE pmdt006 = g_detail_d[g_master_idx].inaj005
      AND pmdt007 = g_detail_d[g_master_idx].inaj006
      AND pmdt063 = g_detail_d[g_master_idx].pmds007
      AND pmdt016 = g_detail_d[g_master_idx].inaj008
      AND pmdt017 = g_detail_d[g_master_idx].inaj009
      AND pmdt018 = g_detail_d[g_master_idx].inaj010
      AND pmdt019 = g_detail_d[g_master_idx].inaj012
   
   LET l_pmdt.pmdt020 = ''
   SELECT SUM(inaj011) INTO l_pmdt.pmdt020 FROM apmp110_tmp3
    WHERE inaj007 = g_detail_d[g_master_idx].pmds007
   #匯總後的數量若是小於0則代表要產生對應的收貨入庫單
   IF l_pmdt.pmdt020 < 0 THEN
      UPDATE apmp110_tmp1 SET pmds000 = '4'
       WHERE pmds007 = g_detail_d[g_master_idx].pmds007
   #反之若匯總後數量為正時則要產生採購倉退單
   ELSE
      UPDATE apmp110_tmp1 SET pmds000 = '7'
       WHERE pmds007 = g_detail_d[g_master_idx].pmds007
   END IF

END FUNCTION]]>
  </point>
  <point name="function.apmp110_get_exrate" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 取匯率
# Memo...........:
# Usage..........: CALL apmp110_get_exrate(p_pmds037,p_pmds048)
#                  RETURNING r_pmds038
# Input parameter: p_pmds037   幣別
#                : p_pmds048   內外購
# Return code....: r_pmds038   匯率
# Date & Author..: 140825 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_get_exrate(p_pmds037,p_pmds048)
DEFINE p_pmds037  LIKE pmds_t.pmds037
DEFINE p_pmds048  LIKE pmds_t.pmds048
DEFINE r_pmds038  LIKE pmds_t.pmds038
DEFINE l_scc40    LIKE type_t.chr2

   IF NOT cl_null(p_pmds037) THEN
      #根據內外購獲取當前營運據點參數設置的汇率类型
      LET l_scc40 = ''
      CASE p_pmds048
         WHEN '1'    #內購
            LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
         WHEN '2'    #外購
            LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
         OTHERWISE EXIT CASE
      END CASE
      IF NOT cl_null(l_scc40) THEN
         CALL s_aooi160_get_exrate('1',g_site,g_today,p_pmds037,g_ooef016,0,l_scc40) RETURNING r_pmds038
      END IF
   END IF

   RETURN r_pmds038

END FUNCTION]]>
  </point>
  <point name="function.apmp110_fetch_1" order="3" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 收貨/倉退明細
# Memo...........:
# Usage..........: CALL apmp110_fetch_1()
# Input parameter: no
# Return code....: no
# Date & Author..: 140825 By whiteny
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_fetch_1()
 
   DEFINE li_ac           LIKE type_t.num5
   
   LET li_ac = l_ac 
   
   IF cl_null(g_detail2_idx) OR g_detail2_idx = 0 THEN
      RETURN
   END IF

   LET g_sql = " SELECT pmdtseq,pmdt006,'','',pmdt007,pmdt063,pmdt019,'',pmdt020,pmdt021, ",
               "        '',pmdt022,pmdt016,'',pmdt017,'',pmdt018,pmdt046,'',pmdt037, ",
               "        pmdt023,'',pmdt024,pmdt036,pmdt038,pmdt039,pmdt047,pmdt042,pmdt043,pmdt044 ",
               "   FROM apmp110_tmp2 ",
               "  WHERE pmdt063 = ? ",
               "  ORDER BY pmdtseq "

   PREPARE apmp110_tmp2 FROM g_sql
   DECLARE tmp2_curs CURSOR FOR apmp110_tmp2
   
   CALL g_detail3_d.clear()
 
   LET l_ac = 1
 
   FOREACH tmp2_curs USING g_detail2_d[g_detail2_idx].pmds007 INTO 
      g_detail3_d[l_ac].pmdtseq,g_detail3_d[l_ac].pmdt006,g_detail3_d[l_ac].pmdt006_desc,g_detail3_d[l_ac].pmdt006_desc_desc,
      g_detail3_d[l_ac].pmdt007,g_detail3_d[l_ac].pmdt063,g_detail3_d[l_ac].pmdt019,g_detail3_d[l_ac].pmdt019_desc,
      g_detail3_d[l_ac].pmdt020,g_detail3_d[l_ac].pmdt021,g_detail3_d[l_ac].pmdt021_desc,g_detail3_d[l_ac].pmdt022,
      g_detail3_d[l_ac].pmdt016,g_detail3_d[l_ac].pmdt016_desc,g_detail3_d[l_ac].pmdt017,g_detail3_d[l_ac].pmdt017_desc,
      g_detail3_d[l_ac].pmdt018,g_detail3_d[l_ac].pmdt046,g_detail3_d[l_ac].pmdt046_desc,
      g_detail3_d[l_ac].pmdt037,g_detail3_d[l_ac].pmdt023,g_detail3_d[l_ac].pmdt023_desc,
      g_detail3_d[l_ac].pmdt024,g_detail3_d[l_ac].pmdt036,g_detail3_d[l_ac].pmdt038,g_detail3_d[l_ac].pmdt039,
      g_detail3_d[l_ac].pmdt047,g_detail3_d[l_ac].pmdt042,g_detail3_d[l_ac].pmdt043,g_detail3_d[l_ac].pmdt044
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      CALL s_desc_get_item_desc(g_detail3_d[l_ac].pmdt006) RETURNING g_detail3_d[l_ac].pmdt006_desc,g_detail3_d[l_ac].pmdt006_desc_desc
      
      CALL s_desc_get_unit_desc(g_detail3_d[l_ac].pmdt019) RETURNING g_detail3_d[l_ac].pmdt019_desc
      
      CALL s_desc_get_unit_desc(g_detail3_d[l_ac].pmdt021) RETURNING g_detail3_d[l_ac].pmdt021_desc
      
      CALL s_desc_get_stock_desc(g_site,g_detail3_d[l_ac].pmdt016) RETURNING g_detail3_d[l_ac].pmdt016_desc
      
      CALL s_desc_get_locator_desc(g_site,g_detail3_d[l_ac].pmdt016,g_detail3_d[l_ac].pmdt017) RETURNING g_detail3_d[l_ac].pmdt017_desc
      
      CALL s_desc_get_tax_desc1(g_site,g_detail3_d[l_ac].pmdt046) RETURNING g_detail3_d[l_ac].pmdt046_desc
      
      CALL s_desc_get_unit_desc(g_detail3_d[l_ac].pmdt023) RETURNING g_detail3_d[l_ac].pmdt023_desc

      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
          END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   
   CALL g_detail3_d.deleteElement(g_detail3_d.getLength())
   IF (l_ac - 1) > 0 THEN
      LET g_detail3_idx = 1
   END IF
    
   LET g_detail3_cnt = l_ac - 1 
   
   CLOSE tmp2_curs
   FREE apmp110_tmp2

   CALL apmp110_fetch_2()

   LET l_ac = li_ac
   
END FUNCTION]]>
  </point>
  <point name="function.apmp110_fetch_2" order="4" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 對應結算資料清單
# Memo...........:
# Usage..........: CALL apmp110_fetch_2()
# Input parameter: no
# Return code....: no
# Date & Author..: 140825 By whiteny
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_fetch_2()
 
   DEFINE li_ac           LIKE type_t.num5
   
   LET li_ac = l_ac 
   
   IF cl_null(g_detail3_idx) OR g_detail3_idx = 0 THEN
      RETURN
   END IF

   LET g_sql = " SELECT inaj015,inaj022,inaj001,inaj002,inaj003,inaj005,'','',inaj006, ",
               "        inaj007,inaj011,inaj012,'',inaj008,'',inaj009,'',inaj010 ",
               "   FROM apmp110_tmp3 ",
               "  WHERE inaj005 = ? AND inaj006 = ? AND inaj007 = ? AND inaj008 = ? AND inaj009 = ? AND inaj010 = ? AND inaj012 = ? ",
               "  ORDER BY inaj001,inaj002,inaj003 "

   PREPARE apmp110_tmp3 FROM g_sql
   DECLARE tmp3_curs CURSOR FOR apmp110_tmp3
   
   CALL g_detail4_d.clear()
 
   LET l_ac = 1

   FOREACH tmp3_curs USING g_detail3_d[g_detail3_idx].pmdt006,g_detail3_d[g_detail3_idx].pmdt007,
                           g_detail3_d[g_detail3_idx].pmdt063,g_detail3_d[g_detail3_idx].pmdt016,
                           g_detail3_d[g_detail3_idx].pmdt017,g_detail3_d[g_detail3_idx].pmdt018,
                           g_detail3_d[g_detail3_idx].pmdt019 INTO 
      g_detail4_d[l_ac].inaj015,g_detail4_d[l_ac].inaj022,g_detail4_d[l_ac].inaj001,g_detail4_d[l_ac].inaj002,
      g_detail4_d[l_ac].inaj003,g_detail4_d[l_ac].inaj005,g_detail4_d[l_ac].inaj005_desc,g_detail4_d[l_ac].inaj005_desc_desc,
      g_detail4_d[l_ac].inaj006,g_detail4_d[l_ac].inaj007,g_detail4_d[l_ac].inaj011,
      g_detail4_d[l_ac].inaj012,g_detail4_d[l_ac].inaj012_desc,g_detail4_d[l_ac].inaj008,g_detail4_d[l_ac].inaj008_desc,
      g_detail4_d[l_ac].inaj009,g_detail4_d[l_ac].inaj009_desc,g_detail4_d[l_ac].inaj010

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      CALL s_desc_get_item_desc(g_detail4_d[l_ac].inaj005) RETURNING g_detail4_d[l_ac].inaj005_desc,g_detail4_d[l_ac].inaj005_desc_desc
      
      CALL s_desc_get_unit_desc(g_detail4_d[l_ac].inaj012) RETURNING g_detail4_d[l_ac].inaj012_desc
      
      CALL s_desc_get_stock_desc(g_site,g_detail4_d[l_ac].inaj008) RETURNING g_detail4_d[l_ac].inaj008_desc
      
      CALL s_desc_get_locator_desc(g_site,g_detail4_d[l_ac].inaj008,g_detail4_d[l_ac].inaj009) RETURNING g_detail4_d[l_ac].inaj009_desc

      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
          END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   
   CALL g_detail4_d.deleteElement(g_detail4_d.getLength())
   IF (l_ac - 1) > 0 THEN
      LET g_detail4_idx = 1
   END IF
    
   LET g_detail4_cnt = l_ac - 1 
   
   CLOSE tmp3_curs
   FREE apmp110_tmp3

   LET l_ac = li_ac
   
END FUNCTION]]>
  </point>
  <point name="function.apmp110_get_price" order="5" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 取單價
# Memo...........:
# Usage..........: CALL apmp110_get_price()
# Input parameter: no
# Return code....: no
# Date & Author..: 140825 By whiteny
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_get_price()
DEFINE l_docno     LIKE pmdn_t.pmdndocno
DEFINE l_seq       LIKE pmdn_t.pmdnseq
DEFINE l_xrcd113   LIKE xrcd_t.xrcd113
DEFINE l_xrcd114   LIKE xrcd_t.xrcd114
DEFINE l_xrcd115   LIKE xrcd_t.xrcd115

   IF cl_null(g_detail2_d[g_detail2_idx].pmds039) OR
      cl_null(g_detail2_d[g_detail2_idx].pmds007) OR
      cl_null(g_detail3_d[g_detail3_idx].pmdt006) OR
      cl_null(g_detail2_d[g_detail2_idx].pmds037) OR
      cl_null(g_detail3_d[g_detail3_idx].pmdt046) OR
      cl_null(g_detail2_d[g_detail2_idx].pmds031) OR
      cl_null(g_detail2_d[g_detail2_idx].pmds032) OR
      cl_null(g_detail2_d[g_detail2_idx].pmds012) OR
      cl_null(g_detail3_d[g_detail3_idx].pmdt023) OR
      cl_null(g_detail3_d[g_detail3_idx].pmdt024) OR
      cl_null(g_detail2_d[g_detail2_idx].pmds048) THEN
      RETURN
   END IF

   IF g_detail3_d[g_detail3_idx].pmdt007 IS NULL THEN
      LET g_detail3_d[g_detail3_idx].pmdt007 = ' '
   END IF

   CASE g_detail2_d[g_detail2_idx].pmds000
      WHEN '4'  #無採購收貨入庫
         LET l_docno = tm.pmdtdocno1
      WHEN '7'  #採購倉退單
         LET l_docno = tm.pmdtdocno2
      OTHERWISE EXIT CASE
   END CASE

   CALL s_purchase_price_get(g_detail2_d[g_detail2_idx].pmds039,g_detail2_d[g_detail2_idx].pmds007,
                             g_detail3_d[g_detail3_idx].pmdt006,g_detail3_d[g_detail3_idx].pmdt007,
                             g_detail2_d[g_detail2_idx].pmds037,g_detail3_d[g_detail3_idx].pmdt046,
                             g_detail2_d[g_detail2_idx].pmds031,g_detail2_d[g_detail2_idx].pmds032,
                             g_detail2_d[g_detail2_idx].pmds012,l_docno,g_today,
                             g_detail3_d[g_detail3_idx].pmdt023,g_detail3_d[g_detail3_idx].pmdt024,g_site,
                             g_detail2_d[g_detail2_idx].pmds048,'1','','')
        RETURNING g_detail3_d[g_detail3_idx].pmdt042,g_detail3_d[g_detail3_idx].pmdt036,g_detail3_d[g_detail3_idx].pmdt043,l_seq
   LET g_detail3_d[g_detail3_idx].pmdt044 = g_detail3_d[g_detail3_idx].pmdt036

   IF NOT cl_null(g_detail3_d[g_detail3_idx].pmdt046) AND
      NOT cl_null(g_detail3_d[g_detail3_idx].pmdt020) AND
      NOT cl_null(g_detail2_d[g_detail2_idx].pmds037) AND
      NOT cl_null(g_detail2_d[g_detail2_idx].pmds038) THEN
      CALL s_tax_count(g_site,g_detail3_d[g_detail3_idx].pmdt046,
                       g_detail3_d[g_detail3_idx].pmdt020*g_detail3_d[g_detail3_idx].pmdt036,
                       g_detail3_d[g_detail3_idx].pmdt020,g_detail2_d[g_detail2_idx].pmds037,
                       g_detail2_d[g_detail2_idx].pmds038)
           RETURNING g_detail3_d[g_detail3_idx].pmdt038,g_detail3_d[g_detail3_idx].pmdt047,
                     g_detail3_d[g_detail3_idx].pmdt039,l_xrcd113,l_xrcd114,l_xrcd115
   END IF

   UPDATE apmp110_tmp2 SET pmdt038 = g_detail3_d[g_detail3_idx].pmdt038,
                           pmdt039 = g_detail3_d[g_detail3_idx].pmdt039,
                           pmdt047 = g_detail3_d[g_detail3_idx].pmdt047,
                           pmdt036 = g_detail3_d[g_detail3_idx].pmdt036,
                           pmdt042 = g_detail3_d[g_detail3_idx].pmdt042,
                           pmdt043 = g_detail3_d[g_detail3_idx].pmdt043,
                           pmdt044 = g_detail3_d[g_detail3_idx].pmdt044
    WHERE pmdt006 = g_detail3_d[g_detail3_idx].pmdt006
      AND pmdt007 = g_detail3_d[g_detail3_idx].pmdt007
      AND pmdt063 = g_detail3_d[g_detail3_idx].pmdt063
      AND pmdt016 = g_detail3_d[g_detail3_idx].pmdt016
      AND pmdt017 = g_detail3_d[g_detail3_idx].pmdt017
      AND pmdt018 = g_detail3_d[g_detail3_idx].pmdt018
      AND pmdt019 = g_detail3_d[g_detail3_idx].pmdt019

END FUNCTION]]>
  </point>
  <point name="function.apmp110_data_chk" order="6" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 執行前檢核欄位值合理性
# Memo...........:
# Usage..........: CALL apmp110_data_chk()
# Input parameter: no
# Return code....: TRUE OR FALSE
# Date & Author..: 140826 By whiteny
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_data_chk()
DEFINE r_success  LIKE type_t.num5
DEFINE l_pmdt  RECORD
    pmdtseq  LIKE pmdt_t.pmdtseq,   #項次
    pmdt063  LIKE pmdt_t.pmdt063,   #庫存管理特徵
    pmdt022  LIKE pmdt_t.pmdt022,   #參考數量
    pmdt046  LIKE pmdt_t.pmdt046,   #稅別
    pmdt024  LIKE pmdt_t.pmdt024,   #計價數量
    pmdt036  LIKE pmdt_t.pmdt036    #單價
              END RECORD

   LET r_success = TRUE
   CALL cl_err_collect_init()
   LET g_coll_title[1] = cl_getmsg('apm-00050',g_lang)  #供應商編號
   LET g_coll_title[2] = cl_getmsg('axm-00008',g_lang)  #項次

   LET g_cnt = l_ac
   FOR l_ac = 1 TO g_detail2_d.getLength()
      IF cl_null(g_detail2_d[l_ac].pmds031) THEN
         #付款條件不可為空！
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'apm-00530'
         LET g_errparam.extend = 'pmds031'
         LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF cl_null(g_detail2_d[l_ac].pmds032) THEN
         #交易條件不可為空！
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'apm-00531'
         LET g_errparam.extend = 'pmds032'
         LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF cl_null(g_detail2_d[l_ac].pmds033) THEN
         #稅別不可為空!
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'asf-00228'
         LET g_errparam.extend = 'pmds033'
         LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF cl_null(g_detail2_d[l_ac].pmds037) THEN
         #幣別不可為空!
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'asf-00227'
         LET g_errparam.extend = 'pmds037'
         LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF cl_null(g_detail2_d[l_ac].pmds039) THEN
         #取價方式不可為空!
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'asf-00226'
         LET g_errparam.extend = 'pmds039'
         LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
         CALL cl_err()
         LET r_success = FALSE
      END IF
   END FOR

   DECLARE apmp110_cur CURSOR FOR
      SELECT pmdtseq,pmdt063,pmdt022,pmdt046,pmdt024,pmdt036 FROM apmp110_tmp2 ORDER BY pmdt063
   FOREACH apmp110_cur INTO l_pmdt.pmdtseq,l_pmdt.pmdt063,l_pmdt.pmdt022,
                            l_pmdt.pmdt046,l_pmdt.pmdt024,l_pmdt.pmdt036
      IF l_pmdt.pmdt022 < 0 THEN
         #數量不可小於0
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'agl-00041'
         LET g_errparam.extend = 'pmdt022'
         LET g_errparam.coll_vals[1] = l_pmdt.pmdt063
         LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF cl_null(l_pmdt.pmdt046) THEN
         #稅別不可為空!
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'asf-00228'
         LET g_errparam.extend = 'pmdt046'
         LET g_errparam.coll_vals[1] = l_pmdt.pmdt063
         LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF l_pmdt.pmdt024 < 0 THEN
         #數量不可小於0
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'agl-00041'
         LET g_errparam.extend = 'pmdt024'
         LET g_errparam.coll_vals[1] = l_pmdt.pmdt063
         LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
         CALL cl_err()
         LET r_success = FALSE
      END IF
      IF cl_null(l_pmdt.pmdt036) OR l_pmdt.pmdt036 < 0 THEN
         #單價不可以空白或小於0
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'axc-00013'
         LET g_errparam.extend = 'pmdt046'
         LET g_errparam.coll_vals[1] = l_pmdt.pmdt063
         LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
         CALL cl_err()
         LET r_success = FALSE
      END IF
   END FOREACH
   
   CALL cl_err_collect_show()

   LET l_ac = g_cnt
   LET g_cnt = 0
   RETURN r_success

END FUNCTION]]>
  </point>
  <point name="function.apmp110_process" order="7" ver="2" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 依據匯總的結果產生相關單據，單身'單據資訊'頁籤資料每一筆代表一張單據，
#                  而對應的'入庫/倉退明細'頁籤的資料則代表是該單據的單身相關資料
# Memo...........:
# Usage..........: CALL apmp110_process()
# Input parameter: no
# Return code....: no
# Date & Author..: 140826 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_process()
DEFINE tot_success  LIKE type_t.num5
DEFINE l_success    LIKE type_t.num5
DEFINE l_pmds  RECORD
    pmdsdocno  LIKE pmds_t.pmdsdocno,  #單據單號		
    pmds008	   LIKE pmds_t.pmds008,	   #帳款供應商	
    pmds009	   LIKE pmds_t.pmds009,	   #送貨供應商	
    pmds011	   LIKE pmds_t.pmds011,	   #採購性質		
    pmds021	   LIKE pmds_t.pmds021,	   #LC進口			
    pmds036	   LIKE pmds_t.pmds036,	   #交易類型		
    pmds047	   LIKE pmds_t.pmds047,	   #多角貿易中斷點
    pmds100	   LIKE pmds_t.pmds100,	   #倉退方式		
    pmds101	   LIKE pmds_t.pmds101,	   #折讓日期		
    pmds043	   LIKE pmds_t.pmds043,	   #採購總未稅金額
    pmds044	   LIKE pmds_t.pmds044,	   #採購總含稅金額
    pmds046	   LIKE pmds_t.pmds046,	   #採購總稅額	
    pmdsownid  LIKE pmds_t.pmdsownid,  #資料所有者	
    pmdsowndp  LIKE pmds_t.pmdsowndp,  #資料所屬部門	
    pmdscrtid  LIKE pmds_t.pmdscrtid,  #資料建立者	
    pmdscrtdp  LIKE pmds_t.pmdscrtdp,  #資料建立部門	
    pmdscrtdt  LIKE pmds_t.pmdscrtdt,  #資料創建日	
    pmdsstus   LIKE pmds_t.pmdsstus    #狀態碼			
             END RECORD
DEFINE l_pmdt  RECORD
	 pmdtseq    LIKE pmdt_t.pmdtseq,	   #項次			
	 pmdt005    LIKE pmdt_t.pmdt005,	   #子件特性		
	 pmdt006    LIKE pmdt_t.pmdt006,	   #料件編號		
	 pmdt007    LIKE pmdt_t.pmdt007,	   #產品特徵		
	 pmdt016    LIKE pmdt_t.pmdt016,	   #庫位			
	 pmdt017    LIKE pmdt_t.pmdt017,	   #儲位			
	 pmdt018    LIKE pmdt_t.pmdt018,	   #批號			
	 pmdt019    LIKE pmdt_t.pmdt019,	   #收貨/入庫單位	
	 pmdt020    LIKE pmdt_t.pmdt020,	   #收貨/入庫數量	
	 pmdt021    LIKE pmdt_t.pmdt021,	   #參考單位		
	 pmdt022    LIKE pmdt_t.pmdt022,	   #參考數量		
	 pmdt023    LIKE pmdt_t.pmdt023,	   #計價單位		
	 pmdt024    LIKE pmdt_t.pmdt024,	   #計價數量		
	 pmdt025    LIKE pmdt_t.pmdt025,	   #緊急度			
	 pmdt026    LIKE pmdt_t.pmdt026,	   #檢驗否			
	 pmdt036    LIKE pmdt_t.pmdt036,	   #單價			
	 pmdt037    LIKE pmdt_t.pmdt037,	   #稅率			
	 pmdt038    LIKE pmdt_t.pmdt038,	   #未稅金額		
	 pmdt039    LIKE pmdt_t.pmdt039,	   #含稅金額		
	 pmdt041    LIKE pmdt_t.pmdt041,	   #保稅否			
	 pmdt042    LIKE pmdt_t.pmdt042,	   #取價來源		
	 pmdt043    LIKE pmdt_t.pmdt043,	   #價格參考單號	
	 pmdt044    LIKE pmdt_t.pmdt044,	   #取出單價		
	 pmdt046    LIKE pmdt_t.pmdt046,	   #稅別			
	 pmdt047    LIKE pmdt_t.pmdt047,	   #稅額			
	 pmdt051    LIKE pmdt_t.pmdt051,	   #理由碼			
	 pmdt052    LIKE pmdt_t.pmdt052,	   #狀態碼			
	 pmdt053    LIKE pmdt_t.pmdt053,	   #允收數量		
	 pmdt054    LIKE pmdt_t.pmdt054,	   #已入庫量		
	 pmdt055    LIKE pmdt_t.pmdt055,	   #驗退量			
	 pmdt062    LIKE pmdt_t.pmdt062,	   #多庫儲批收貨入庫
	 pmdt063    LIKE pmdt_t.pmdt063 	   #庫存管理特徵	
             END RECORD
DEFINE l_inaj  RECORD
    inaj001    LIKE inaj_t.inaj001,
    inaj002    LIKE inaj_t.inaj002,
    inaj003    LIKE inaj_t.inaj003,
    inaj004    LIKE inaj_t.inaj004,
    inaj011    LIKE inaj_t.inaj011
             END RECORD
DEFINE l_pmdt011    LIKE pmdt_t.pmdt011
DEFINE l_money      LIKE pmdt_t.pmdt036
DEFINE l_xrcd113    LIKE xrcd_t.xrcd113
DEFINE l_xrcd114    LIKE xrcd_t.xrcd114
DEFINE l_xrcd115    LIKE xrcd_t.xrcd115
DEFINE l_xrcd123    LIKE xrcd_t.xrcd123
DEFINE l_xrcd124    LIKE xrcd_t.xrcd124
DEFINE l_xrcd125    LIKE xrcd_t.xrcd125
DEFINE l_xrcd133    LIKE xrcd_t.xrcd133
DEFINE l_xrcd134    LIKE xrcd_t.xrcd134
DEFINE l_xrcd135    LIKE xrcd_t.xrcd135

   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   LET g_coll_title[1] = cl_getmsg('apm-00050',g_lang)  #供應商編號
   LET g_coll_title[2] = cl_getmsg('axm-00008',g_lang)  #項次
   LET tot_success = TRUE
   LET l_success = TRUE

   LET g_sql = " SELECT pmdtseq,pmdt006,pmdt007,pmdt016,pmdt017,pmdt018,pmdt019,pmdt020,pmdt021,pmdt022, ",
               "        pmdt023,pmdt024,pmdt036,pmdt037,pmdt042,pmdt043,pmdt044,pmdt046,pmdt063 ",
               "   FROM apmp110_tmp2 WHERE pmdt063 = ? ORDER BY pmdtseq "
   PREPARE apmp110_pr1 FROM g_sql
   DECLARE apmp110_cs1 CURSOR FOR apmp110_pr1

   LET g_sql = " SELECT inaj001,inaj002,inaj003,inaj011 FROM apmp110_tmp3 ",
               "  WHERE inaj005 = ? AND inaj006 = ? AND inaj007 = ? AND inaj008 = ? ",
               "    AND inaj009 = ? AND inaj010 = ? AND inaj012 = ? "
   PREPARE apmp110_pr2 FROM g_sql
   DECLARE apmp110_cs2 CURSOR FOR apmp110_pr2

   LET g_cnt = l_ac
   FOR l_ac = 1 TO g_detail2_d.getLength()

      IF NOT l_success THEN
         LET tot_success = FALSE
         LET l_success = TRUE
      END IF

      INITIALIZE l_pmds.* TO NULL

      CASE g_detail2_d[l_ac].pmds000
         WHEN '4'  #無採購收貨入庫
            CALL s_aooi200_gen_docno(g_site,tm.pmdtdocno1,g_today,'apmt532')
                 RETURNING l_success,l_pmds.pmdsdocno
            LET g_prog = 'apmt532'
         WHEN '7'  #採購倉退單
            CALL s_aooi200_gen_docno(g_site,tm.pmdtdocno2,g_today,'apmt580')
                 RETURNING l_success,l_pmds.pmdsdocno
            LET l_pmds.pmds101 = g_today
            LET g_prog = 'apmt580'
         OTHERWISE EXIT CASE
      END CASE

      #抓取交易對象夥伴關係檔且交易類型為"1:收/付款對象"的交易對象
      #若有設置多筆收/付款交易對象時，則取有勾選主要的交易對象那一個
      #若沒有設時，則[帳款供應商]預設採購供應商
      LET l_pmds.pmds008 = ''
      SELECT pmac002 INTO l_pmds.pmds008 FROM pmac_t
       WHERE pmacent = g_enterprise AND pmac001 = g_detail2_d[l_ac].pmds007
         AND pmac003 = '1' AND pmacstus = 'Y' AND pmac004 = 'Y'
      IF cl_null(l_pmds.pmds008) THEN
         SELECT pmac002 INTO l_pmds.pmds008 FROM pmac_t
          WHERE pmacent = g_enterprise AND pmac001 = g_detail2_d[l_ac].pmds007
            AND pmac003 = '1' AND pmacstus = 'Y' AND rownum = 1
         IF cl_null(l_pmds.pmds008) THEN
            LET l_pmds.pmds008 = g_detail2_d[l_ac].pmds007
         END IF
      END IF
      
      #抓取交易對象夥伴關係檔且交易類型為"2:出貨對象"的交易對象
      #若有設置多筆出貨交易對象時，則取有勾選主要的交易對象那一個
      #若沒有設時，則[送貨供應商]預設採購供應商
      LET l_pmds.pmds009 = ''
      SELECT pmac002 INTO l_pmds.pmds009 FROM pmac_t
       WHERE pmacent = g_enterprise AND pmac001 = g_detail2_d[l_ac].pmds007
         AND pmac003 = '2' AND pmacstus = 'Y' AND pmac004 = 'Y'
      IF cl_null(l_pmds.pmds009) THEN
         SELECT pmac002 INTO l_pmds.pmds009 FROM pmac_t
          WHERE pmacent = g_enterprise AND pmac001 = g_detail2_d[l_ac].pmds007
            AND pmac003 = '2' AND pmacstus = 'Y' AND rownum = 1
         IF cl_null(l_pmds.pmds009) THEN
            LET l_pmds.pmds009 = g_detail2_d[l_ac].pmds007
         END IF
      END IF

      #採購性質='1.一般採購'
      LET l_pmds.pmds011 = '1'
      LET l_pmds.pmds021 = 'N'
      LET l_pmds.pmds036 = '1'
      LET l_pmds.pmds047 = 'N'
      #倉退方式='1:倉退退回'
      LET l_pmds.pmds100 = '1'
      LET l_pmds.pmdsstus = 'N'
      LET l_pmds.pmdsownid = g_user
      LET l_pmds.pmdsowndp = g_dept
      LET l_pmds.pmdscrtid = g_user
      LET l_pmds.pmdscrtdp = g_dept 
      LET l_pmds.pmdscrtdt = cl_get_current()

      INSERT INTO pmds_t (pmdsent,pmdssite,pmdsdocno,pmdsdocdt,pmds000,pmds001,
                          pmds002,pmds003,pmds007,pmds008,pmds009,pmds011,pmds012,
                          pmds021,pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,
                          pmds037,pmds038,pmds039,pmds047,pmds048,pmds049,pmds100,
                          pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsstus)
      VALUES (g_enterprise,g_site,l_pmds.pmdsdocno,g_today,g_detail2_d[l_ac].pmds000,g_today,
              g_user,g_dept,g_detail2_d[l_ac].pmds007,l_pmds.pmds008,l_pmds.pmds009,
              l_pmds.pmds011,g_detail2_d[l_ac].pmds012,l_pmds.pmds021,g_detail2_d[l_ac].pmds031,
              g_detail2_d[l_ac].pmds032,g_detail2_d[l_ac].pmds033,g_detail2_d[l_ac].pmds034,
              g_detail2_d[l_ac].pmds035,l_pmds.pmds036,g_detail2_d[l_ac].pmds037,
              g_detail2_d[l_ac].pmds038,g_detail2_d[l_ac].pmds039,l_pmds.pmds047,
              g_detail2_d[l_ac].pmds048,g_detail2_d[l_ac].pmds049,l_pmds.pmds100,l_pmds.pmdsownid, 
              l_pmds.pmdsowndp,l_pmds.pmdscrtid,l_pmds.pmdscrtdp,l_pmds.pmdscrtdt,l_pmds.pmdsstus) 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'ins pmds_t'
         LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
         CALL cl_err()
         LET l_success = FALSE
      ELSE
      
         INITIALIZE l_pmdt.* TO NULL
         LET l_pmdt011 = '1'
         
         FOREACH apmp110_cs1 USING g_detail2_d[l_ac].pmds007
            INTO l_pmdt.pmdtseq,l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt016,l_pmdt.pmdt017,
                 l_pmdt.pmdt018,l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021,l_pmdt.pmdt022,
                 l_pmdt.pmdt023,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt037,l_pmdt.pmdt042,
                 l_pmdt.pmdt043,l_pmdt.pmdt044,l_pmdt.pmdt046,l_pmdt.pmdt063
            #子件特性='1.一般'
            LET l_pmdt.pmdt005 = '1'
            LET l_pmdt.pmdt025 = '1'
            LET l_pmdt.pmdt026 = 'N'
            LET l_pmdt.pmdt041 = 'N'
            #狀態碼='1:一般'
            LET l_pmdt.pmdt052 = '1'
            LET l_pmdt.pmdt053 = 0
            LET l_pmdt.pmdt054 = 0
            LET l_pmdt.pmdt055 = 0
            LET l_pmdt.pmdt062 = 'N'
            CASE g_detail2_d[l_ac].pmds000
               WHEN '4'  #無採購收貨入庫
                  LET l_pmdt.pmdt051 = tm.pmdt0511
               WHEN '7'  #採購倉退單
                  LET l_pmdt.pmdt051 = tm.pmdt0512
               OTHERWISE EXIT CASE
            END CASE
            LET l_money = l_pmdt.pmdt036 * l_pmdt.pmdt024
            CALL s_tax_ins(l_pmds.pmdsdocno,l_pmdt.pmdtseq,'0',g_site,l_money,l_pmdt.pmdt046,l_pmdt.pmdt024,
                           g_detail2_d[l_ac].pmds037,g_detail2_d[l_ac].pmds038,'','','')
                 RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039,l_xrcd113,l_xrcd114,l_xrcd115,
                           l_xrcd123,l_xrcd124,l_xrcd125,l_xrcd133,l_xrcd134,l_xrcd135

            INSERT INTO pmdt_t(pmdtent,pmdtsite,pmdtdocno,pmdtseq,pmdt005,pmdt006,
                  pmdt007,pmdt011,pmdt016,pmdt017,pmdt018,pmdt019,pmdt020,pmdt021,pmdt022,pmdt023,
                  pmdt024,pmdt025,pmdt026,pmdt036,pmdt037,pmdt038,pmdt039,pmdt041,pmdt042,pmdt043,
                  pmdt044,pmdt046,pmdt047,pmdt051,pmdt052,pmdt053,pmdt054,pmdt055,pmdt062,pmdt063)
            VALUES(g_enterprise,g_site,l_pmds.pmdsdocno,l_pmdt.pmdtseq,l_pmdt.pmdt005,l_pmdt.pmdt006,
                   l_pmdt.pmdt007,l_pmdt011,l_pmdt.pmdt016,l_pmdt.pmdt017,l_pmdt.pmdt018,
                   l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021,l_pmdt.pmdt022,l_pmdt.pmdt023,
                   l_pmdt.pmdt024,l_pmdt.pmdt025,l_pmdt.pmdt026,l_pmdt.pmdt036,l_pmdt.pmdt037,
                   l_pmdt.pmdt038,l_pmdt.pmdt039,l_pmdt.pmdt041,l_pmdt.pmdt042,l_pmdt.pmdt043,
                   l_pmdt.pmdt044,l_pmdt.pmdt046,l_pmdt.pmdt047,l_pmdt.pmdt051,l_pmdt.pmdt052,
                   l_pmdt.pmdt053,l_pmdt.pmdt054,l_pmdt.pmdt055,l_pmdt.pmdt062,l_pmdt.pmdt063)
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'ins pmdt_t'
               LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
               LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
               CALL cl_err()
               LET l_success = FALSE
            END IF

            #多庫儲批不勾選時，則也新增一筆資料到收貨/驗退/入庫/倉退單多庫儲批收貨明細檔
            INSERT INTO pmdu_t(pmduent,pmdusite,pmdudocno,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu005,pmdu006,
                               pmdu007,pmdu008,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015)
                       VALUES (g_enterprise,g_site,l_pmds.pmdsdocno,l_pmdt.pmdtseq,'1',l_pmdt.pmdt006,
                               l_pmdt.pmdt007,l_pmdt.pmdt063,l_pmdt.pmdt016,l_pmdt.pmdt017,
                               l_pmdt.pmdt018,l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021,
                               l_pmdt.pmdt022,l_pmdt.pmdt053,l_pmdt.pmdt054,l_pmdt.pmdt055)
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'ins pmdu_t'
               LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
               LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
               CALL cl_err()
               LET l_success = FALSE
            END IF

            #將本次產生的收貨入庫單、倉退單所產生的'VMI結算否'欄位更新成'2:已結算'
            IF l_success THEN
               INITIALIZE l_inaj.* TO NULL
               FOREACH apmp110_cs2 USING l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt063,l_pmdt.pmdt016,
                                         l_pmdt.pmdt017,l_pmdt.pmdt018,l_pmdt.pmdt019
                                    INTO l_inaj.inaj001,l_inaj.inaj002,l_inaj.inaj003,l_inaj.inaj011
                  IF l_inaj.inaj011 < 0 THEN
                     LET l_inaj.inaj004 = '-1'
                  ELSE
                     LET l_inaj.inaj004 = '1'
                  END IF
                  UPDATE inaj_t SET inaj030 = '2',               #VMI交易結算否
                                    inaj031 = l_pmds.pmdsdocno,  #VMI對應入庫/倉退單號
                                    inaj032 = l_pmdt.pmdtseq     #VMI對應入庫/倉退項次
                   WHERE inajent = g_enterprise
                     AND inajsite = g_site
                     AND inaj001 = l_inaj.inaj001
                     AND inaj002 = l_inaj.inaj002
                     AND inaj003 = l_inaj.inaj003
                     AND inaj004 = l_inaj.inaj004
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = 'upd inaj_t'
                     LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
                     LET g_errparam.coll_vals[2] = l_pmdt.pmdtseq
                     CALL cl_err()
                     LET l_success = FALSE
                  END IF
                  INITIALIZE l_inaj.* TO NULL
               END FOREACH
            END IF
            
            INITIALIZE l_pmdt.* TO NULL
            LET l_pmdt011 = l_pmdt011 + 1
            
         END FOREACH
      END IF
      
      IF l_success THEN
         CALL s_tax_recount(l_pmds.pmdsdocno)
              RETURNING l_pmds.pmds043,l_pmds.pmds046,l_pmds.pmds044,l_xrcd113,l_xrcd114,l_xrcd115
         UPDATE pmds_t SET pmds043 = l_pmds.pmds043,
                           pmds046 = l_pmds.pmds046,
                           pmds044 = l_pmds.pmds044
          WHERE pmdsdocno = l_pmds.pmdsdocno
            AND pmdsent = g_enterprise
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam.* TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'upd pmds_t'
            LET g_errparam.coll_vals[1] = g_detail2_d[l_ac].pmds007
            CALL cl_err()
            LET l_success = FALSE
         END IF
      END IF

      IF l_success THEN
         #產生完相關單據後需呼叫各單據作業的確認與過帳流程進行單據確認與過帳
         IF s_apmt520_conf_chk(l_pmds.pmdsdocno) THEN
            IF s_apmt520_conf_upd(l_pmds.pmdsdocno) THEN
               IF s_apmt520_posted_chk(l_pmds.pmdsdocno) THEN
                  IF NOT s_apmt520_posted_upd(l_pmds.pmdsdocno) THEN
                     LET l_success = FALSE
                  END IF
               ELSE
                  LET l_success = FALSE
               END IF
            ELSE
               LET l_success = FALSE
            END IF
         ELSE
            LET l_success = FALSE
         END IF
      END IF

   END FOR

   LET l_ac = g_cnt
   LET g_cnt = 0
   CALL cl_err_collect_show() 
   
   #ming 20150616 add -----------------------(S) 
   #如果是最後一筆才出錯的話，是不會回到foreach的最前面去改變tot_success 
   #所以在離開foreach後，還要再一次的檢查l_success的狀態 
   IF NOT l_success THEN
      LET tot_success = FALSE
   END IF
   #ming 20150616 add -----------------------(E) 
   
   IF tot_success THEN
      CALL s_transaction_end('Y','0')
      LET g_flag = '1'
   ELSE
      CALL s_transaction_end('N','0')
   END IF
 
   IF g_bgjob = "N" THEN
      #前景作業完成處理
      CALL cl_ask_pressanykey("std-00012")
   ELSE
      #背景作業完成處理
   END IF

END FUNCTION]]>
  </point>
  <point name="function.apmp110_set_required" order="8" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 控制蘭未必輸否
# Memo...........:
# Usage..........: CALL apmp110_set_required()
#                  RETURNING r_flag
# Input parameter: no
# Return code....: r_flag
# Date & Author..: 141007 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION apmp110_set_required()
DEFINE r_flag    LIKE type_t.chr1
DEFINE l_cnt1    LIKE type_t.num5
DEFINE l_cnt2    LIKE type_t.num5

   CALL cl_set_comp_required("pmdtdocno1,pmdtdocno2,pmdt0512",FALSE)
   LET r_flag = '0'
   LET l_cnt1 = 0
   LET l_cnt2 = 0
   SELECT COUNT(*) INTO l_cnt1 FROM apmp110_tmp1
    WHERE pmds000 = '4'  #收貨入庫單
   SELECT COUNT(*) INTO l_cnt2 FROM apmp110_tmp1
    WHERE pmds000 = '7'  #採購倉退單
   IF l_cnt1 > 0 THEN
      CALL cl_set_comp_required("pmdtdocno1",TRUE)
      LET r_flag = '1'
   END IF
   IF l_cnt2 > 0 THEN
      CALL cl_set_comp_required("pmdtdocno2,pmdt0512",TRUE)
      LET r_flag = '2'
   END IF
   IF l_cnt1 > 0 AND l_cnt2 > 0 THEN
      LET r_flag = '3'
   END IF
   
   RETURN r_flag

END FUNCTION]]>
  </point>
  <point name="b_fill.foreach_into" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[    g_detail_d[l_ac].sel,g_detail_d[l_ac].sel2,g_detail_d[l_ac].inaj015,g_detail_d[l_ac].inaj022,
    g_detail_d[l_ac].inaj001,g_detail_d[l_ac].inaj002,g_detail_d[l_ac].inaj003,
    g_detail_d[l_ac].inaj005,g_detail_d[l_ac].inaj005_desc,g_detail_d[l_ac].inaj005_desc_desc,
    g_detail_d[l_ac].inaj006,g_detail_d[l_ac].inaj007,g_detail_d[l_ac].pmds007,
    g_detail_d[l_ac].inaj011,g_detail_d[l_ac].inaj012,g_detail_d[l_ac].inaj012_desc,
    g_detail_d[l_ac].inaj008,g_detail_d[l_ac].inaj008_desc,
    g_detail_d[l_ac].inaj009,g_detail_d[l_ac].inaj009_desc,g_detail_d[l_ac].inaj010
]]>
  </point>
  <point name="b_fill.foreach_iside" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      LET g_detail_d[l_ac].pmds007 = g_detail_d[l_ac].inaj007]]>
  </point>
  <point name="b_fill.other_table" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL g_detail_d.deleteElement(g_detail_d.getLength())
   IF (l_ac - 1) > 0 THEN
      LET g_master_idx = 1
   END IF
]]>
  </point>
  <point name="b_fill.sql_before" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
   #未結算的VMI交易資料
   LET g_sql = " SELECT 'N','N',gzzal003,inaj022,inaj001,inaj002,inaj003,inaj005,imaal003,imaal004,inaj006, ",
               "        inaj007,'',(inaj011*inaj004),inaj012,oocal003,inaj008,inayl003,inaj009,inab003,inaj010 ",
               "   FROM inaj_t ",
               "        LEFT OUTER JOIN gzzal_t ON gzzal001 = inaj015 AND gzzal002 = '",g_dlang,"' ",
               "        LEFT OUTER JOIN imaal_t ON imaalent = inajent AND imaal001 = inaj005 AND imaal002 = '",g_dlang,"' ",
               "        LEFT OUTER JOIN oocal_t ON oocalent = inajent AND oocal001 = inaj012 AND oocal002 = '",g_dlang,"' ",
               "        LEFT OUTER JOIN inayl_t ON inaylent = inajent AND inayl001 = inaj008 AND inayl002 = '",g_dlang,"' ",
               "        LEFT OUTER JOIN inab_t ON inabent = inajent AND inabsite = inajsite AND inab001 = inaj008 AND inab002 = inaj009 ",
               "  WHERE inajent = ? AND inajsite = '",g_site,"' AND inaj030 = '1' AND TRIM(inaj007) IS NOT NULL ",
               "    AND ",g_wc CLIPPED,  
               "  ORDER BY inaj001,inaj002,inaj003 "
]]>
  </point>
  <point name="fetch.after_fill" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   IF cl_null(g_master_idx) OR g_master_idx = 0 THEN
      RETURN
   END IF

   LET g_sql = " SELECT pmds000,pmds007,'',pmds031,'',pmds032,'',pmds033,'',pmds034, ",
               "        pmds035,pmds037,'',pmds038,pmds039,'',pmds048,pmds049,pmds012 ",
               "   FROM apmp110_tmp1 ",
               "  ORDER BY pmds000 "

   PREPARE apmp110_tmp1 FROM g_sql
   DECLARE tmp1_curs CURSOR FOR apmp110_tmp1
   
   CALL g_detail2_d.clear()
 
   LET l_ac = 1 
 
   FOREACH tmp1_curs INTO 
      g_detail2_d[l_ac].pmds000,g_detail2_d[l_ac].pmds007,g_detail2_d[l_ac].pmds007_desc,
      g_detail2_d[l_ac].pmds031,g_detail2_d[l_ac].pmds031_desc,
      g_detail2_d[l_ac].pmds032,g_detail2_d[l_ac].pmds032_desc,
      g_detail2_d[l_ac].pmds033,g_detail2_d[l_ac].pmds033_desc,
      g_detail2_d[l_ac].pmds034,g_detail2_d[l_ac].pmds035,
      g_detail2_d[l_ac].pmds037,g_detail2_d[l_ac].pmds037_desc,
      g_detail2_d[l_ac].pmds038,g_detail2_d[l_ac].pmds039,g_detail2_d[l_ac].pmds039_desc,
      g_detail2_d[l_ac].pmds048,g_detail2_d[l_ac].pmds049,g_detail2_d[l_ac].pmds012
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      CALL s_desc_get_trading_partner_abbr_desc(g_detail2_d[l_ac].pmds007) RETURNING g_detail2_d[l_ac].pmds007_desc
      
      CALL s_desc_get_ooib002_desc(g_detail2_d[l_ac].pmds031) RETURNING g_detail2_d[l_ac].pmds031_desc
      
      CALL s_desc_get_acc_desc('238',g_detail2_d[l_ac].pmds032) RETURNING g_detail2_d[l_ac].pmds032_desc
      
      CALL s_desc_get_tax_desc1(g_site,g_detail2_d[l_ac].pmds033) RETURNING g_detail2_d[l_ac].pmds033_desc
      
      CALL s_desc_get_currency_desc(g_detail2_d[l_ac].pmds037) RETURNING g_detail2_d[l_ac].pmds037_desc
      
      CALL s_desc_get_price_type_desc(g_detail2_d[l_ac].pmds039) RETURNING g_detail2_d[l_ac].pmds039_desc

      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
          END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   
   CALL g_detail2_d.deleteElement(g_detail2_d.getLength())
   IF (l_ac - 1) > 0 THEN
      LET g_detail2_idx = 1
   END IF
    
   LET g_detail2_cnt = l_ac - 1

   CLOSE tmp1_curs
   FREE apmp110_tmp1

   CALL apmp110_fetch_1()
]]>
  </point>
  <point name="fetch.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="global.variable" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[    sel               LIKE type_t.chr1,      #選擇 
    #ming 20150616 add --------------------------------(S) 
    sel2              LIKE type_t.chr1,      #是否已經先被寫入temp table了 
    #ming 20150616 add --------------------------------(E)  
    inaj015           LIKE type_t.chr80,     #單據性質
    inaj022           LIKE inaj_t.inaj022,   #扣帳日期
    inaj001           LIKE inaj_t.inaj001,   #單據編號
    inaj002           LIKE inaj_t.inaj002,   #項次
    inaj003           LIKE inaj_t.inaj003,   #項序
    inaj005           LIKE inaj_t.inaj005,   #料件編號
    inaj005_desc      LIKE type_t.chr80,     #品名
    inaj005_desc_desc LIKE type_t.chr80,     #規格
    inaj006           LIKE inaj_t.inaj006,   #產品特徵
    inaj007           LIKE inaj_t.inaj007,   #庫存管理特徵
    pmds007           LIKE pmds_t.pmds007,   #庫存管理特徵
    inaj011           LIKE inaj_t.inaj011,   #數量
    inaj012           LIKE inaj_t.inaj012,   #單位
    inaj012_desc      LIKE type_t.chr80,     #說明
    inaj008           LIKE inaj_t.inaj008,   #庫
    inaj008_desc      LIKE type_t.chr80,     #說明
    inaj009           LIKE inaj_t.inaj009,   #儲
    inaj009_desc      LIKE type_t.chr80,     #說明
    inaj010           LIKE inaj_t.inaj010    #批
                     END RECORD

TYPE type_g_detail2_d RECORD
    pmds000           LIKE pmds_t.pmds000,   #單據性質
    pmds007           LIKE pmds_t.pmds007,   #供應商
    pmds007_desc      LIKE type_t.chr80,     #說明
    pmds031           LIKE pmds_t.pmds031,   #付款條件
    pmds031_desc      LIKE type_t.chr80,     #說明
    pmds032           LIKE pmds_t.pmds032,   #交易條件
    pmds032_desc      LIKE type_t.chr80,     #說明
    pmds033           LIKE pmds_t.pmds033,   #稅別
    pmds033_desc      LIKE type_t.chr80,     #說明
    pmds034           LIKE pmds_t.pmds034,   #稅率
    pmds035           LIKE pmds_t.pmds035,   #含稅否
    pmds037           LIKE pmds_t.pmds037,   #幣別
    pmds037_desc      LIKE type_t.chr80,     #說明
    pmds038           LIKE pmds_t.pmds038,   #匯率
    pmds039           LIKE pmds_t.pmds039,   #取價方式
    pmds039_desc      LIKE type_t.chr80,     #說明
    pmds048           LIKE pmds_t.pmds048,   #內外購
    pmds049           LIKE pmds_t.pmds049,   #匯率計算基準
    pmds012           LIKE pmds_t.pmds012    #採購通路
                     END RECORD

TYPE type_g_detail3_d RECORD
    pmdtseq           LIKE pmdt_t.pmdtseq,   #項次
    pmdt006           LIKE pmdt_t.pmdt006,   #料件編號
    pmdt006_desc      LIKE type_t.chr80,     #品名
    pmdt006_desc_desc LIKE type_t.chr80,     #規格
    pmdt007           LIKE pmdt_t.pmdt007,   #產品特徵
    pmdt063           LIKE pmdt_t.pmdt063,   #庫存管理特徵
    pmdt019           LIKE pmdt_t.pmdt019,   #單位
    pmdt019_desc      LIKE type_t.chr80,     #說明
    pmdt020           LIKE pmdt_t.pmdt020,   #數量
    pmdt021           LIKE pmdt_t.pmdt021,   #參考單位
    pmdt021_desc      LIKE type_t.chr80,     #說明
    pmdt022           LIKE pmdt_t.pmdt022,   #參考數量
    pmdt016           LIKE pmdt_t.pmdt016,   #庫
    pmdt016_desc      LIKE type_t.chr80,     #說明
    pmdt017           LIKE pmdt_t.pmdt017,   #儲
    pmdt017_desc      LIKE type_t.chr80,     #說明
    pmdt018           LIKE pmdt_t.pmdt018,   #批
    pmdt046           LIKE pmdt_t.pmdt046,   #稅別
    pmdt046_desc      LIKE type_t.chr80,     #說明
    pmdt037           LIKE pmdt_t.pmdt037,   #稅率
    pmdt023           LIKE pmdt_t.pmdt023,   #計價單位
    pmdt023_desc      LIKE type_t.chr80,     #說明
    pmdt024           LIKE pmdt_t.pmdt024,   #計價數量
    pmdt036           LIKE pmdt_t.pmdt036,   #單價
    pmdt038           LIKE pmdt_t.pmdt038,   #未稅金額
    pmdt039           LIKE pmdt_t.pmdt039,   #含稅金額
    pmdt047           LIKE pmdt_t.pmdt047,   #金額
    pmdt042           LIKE pmdt_t.pmdt042,   #取價來源
    pmdt043           LIKE pmdt_t.pmdt043,   #參考單號
    pmdt044           LIKE pmdt_t.pmdt044    #取出單價
                     END RECORD

TYPE type_g_detail4_d RECORD
    inaj015           LIKE type_t.chr80,     #單據性質
    inaj022           LIKE inaj_t.inaj022,   #扣帳日期
    inaj001           LIKE inaj_t.inaj001,   #單據編號
    inaj002           LIKE inaj_t.inaj002,   #項次
    inaj003           LIKE inaj_t.inaj003,   #項序
    inaj005           LIKE inaj_t.inaj005,   #料件編號
    inaj005_desc      LIKE type_t.chr80,     #品名
    inaj005_desc_desc LIKE type_t.chr80,     #規格
    inaj006           LIKE inaj_t.inaj006,   #產品特徵
    inaj007           LIKE inaj_t.inaj007,   #庫存管理特徵
    inaj011           LIKE inaj_t.inaj011,   #數量
    inaj012           LIKE inaj_t.inaj012,   #單位
    inaj012_desc      LIKE type_t.chr80,     #說明
    inaj008           LIKE inaj_t.inaj008,   #庫
    inaj008_desc      LIKE type_t.chr80,     #說明
    inaj009           LIKE inaj_t.inaj009,   #儲
    inaj009_desc      LIKE type_t.chr80,     #說明
    inaj010           LIKE inaj_t.inaj010    #批
                     END RECORD

DEFINE tm             RECORD
    pmdtdocno1        LIKE ooba_t.ooba002,   #收貨入庫單別
    pmdtdocno1_desc   LIKE type_t.chr80,     #說明
    pmdt0511          LIKE pmdt_t.pmdt051,   #收貨理由
    pmdt0511_desc     LIKE type_t.chr80,     #說明
    pmdtdocno2        LIKE ooba_t.ooba002,   #倉退單別
    pmdtdocno2_desc   LIKE type_t.chr80,     #說明
    pmdt0512          LIKE pmdt_t.pmdt051,   #倉退理由
    pmdt0512_desc     LIKE type_t.chr80      #說明
                     END RECORD

DEFINE g_detail2_d  DYNAMIC ARRAY OF type_g_detail2_d
DEFINE g_detail3_d  DYNAMIC ARRAY OF type_g_detail3_d
DEFINE g_detail4_d  DYNAMIC ARRAY OF type_g_detail4_d
DEFINE g_detail2_cnt        LIKE type_t.num5
DEFINE g_detail3_cnt        LIKE type_t.num5
DEFINE g_detail4_cnt        LIKE type_t.num5
DEFINE g_detail2_idx        LIKE type_t.num5
DEFINE g_detail3_idx        LIKE type_t.num5
DEFINE g_detail4_idx        LIKE type_t.num5

DEFINE g_detail2_d_o  RECORD
    pmds031           LIKE pmds_t.pmds031,
    pmds032           LIKE pmds_t.pmds032,
    pmds033           LIKE pmds_t.pmds033,
    pmds037           LIKE pmds_t.pmds037,
    pmds039           LIKE pmds_t.pmds039
                     END RECORD

DEFINE g_detail3_d_o  RECORD
    pmdt022           LIKE pmdt_t.pmdt022,
    pmdt046           LIKE pmdt_t.pmdt046,
    pmdt024           LIKE pmdt_t.pmdt024,
    pmdt036           LIKE pmdt_t.pmdt036 
                     END RECORD

DEFINE g_ooef004            LIKE ooef_t.ooef004           #單據別參照表號
DEFINE g_ooef016            LIKE ooef_t.ooef016           #主幣別編號
DEFINE g_acc1               LIKE type_t.chr10             #收貨應用分類碼
DEFINE g_acc2               LIKE type_t.chr10             #倉退應用分類碼
DEFINE g_flag               LIKE type_t.chr1]]>
  </point>
  <point name="init.init" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   LET g_wc = "1=1"

   CALL cl_set_combo_scc('pmds000','2060')
   CALL cl_set_combo_scc('pmdt042','2016')

   LET g_ooef004 = ''
   LET g_ooef016 = ''
   SELECT ooef004,ooef016 INTO g_ooef004,g_ooef016 FROM ooef_t
    WHERE ooefent = g_enterprise AND ooef001 = g_site
   LET g_acc1 = ''
   SELECT gzcb004 INTO g_acc1 FROM gzcb_t WHERE gzcb001 = '24' AND gzcb002 = 'apmt570'
   LET g_acc2 = ''
   SELECT gzcb004 INTO g_acc2 FROM gzcb_t WHERE gzcb001 = '24' AND gzcb002 = 'apmt580'
   LET g_flag = '1'

   #判斷據點參數若不使用參考單位時，則參考單位、數量需隱藏不可以維護
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'N' THEN
      CALL cl_set_comp_visible("pmdt021,pmdt021_desc,pmdt022",FALSE)
   END IF

   #整體參數未使用採購計價單位
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" THEN
      CALL cl_set_comp_visible("pmdt023,pmdt023_desc,pmdt024",FALSE)
   END IF

   CREATE TEMP TABLE apmp110_tmp1( 
    pmds000           LIKE pmds_t.pmds000,   #單據性質
    pmds007           LIKE pmds_t.pmds007,   #供應商
    pmds031           LIKE pmds_t.pmds031,   #付款條件
    pmds032           LIKE pmds_t.pmds032,   #交易條件
    pmds033           LIKE pmds_t.pmds033,   #稅別
    pmds034           LIKE pmds_t.pmds034,   #稅率
    pmds035           LIKE pmds_t.pmds035,   #含稅否
    pmds037           LIKE pmds_t.pmds037,   #幣別
    pmds038           LIKE pmds_t.pmds038,   #匯率
    pmds039           LIKE pmds_t.pmds039,   #取價方式
    pmds048           LIKE pmds_t.pmds048,   #內外購
    pmds049           LIKE pmds_t.pmds049,   #匯率計算基準
    pmds012           LIKE pmds_t.pmds012    #採購通路
)

   CREATE TEMP TABLE apmp110_tmp2( 
    pmdtseq           LIKE pmdt_t.pmdtseq,   #項次
    pmdt006           LIKE pmdt_t.pmdt006,   #料件編號
    pmdt007           LIKE pmdt_t.pmdt007,   #產品特徵
    pmdt063           LIKE pmdt_t.pmdt063,   #庫存管理特徵
    pmdt019           LIKE pmdt_t.pmdt019,   #單位
    pmdt020           LIKE pmdt_t.pmdt020,   #數量
    pmdt021           LIKE pmdt_t.pmdt021,   #參考單位
    pmdt022           LIKE pmdt_t.pmdt022,   #參考數量
    pmdt016           LIKE pmdt_t.pmdt016,   #庫
    pmdt017           LIKE pmdt_t.pmdt017,   #儲
    pmdt018           LIKE pmdt_t.pmdt018,   #批
    pmdt046           LIKE pmdt_t.pmdt046,   #稅別
    pmdt037           LIKE pmdt_t.pmdt037,   #稅率
    pmdt023           LIKE pmdt_t.pmdt023,   #計價單位
    pmdt024           LIKE pmdt_t.pmdt024,   #計價數量
    pmdt036           LIKE pmdt_t.pmdt036,   #單價
    pmdt038           LIKE pmdt_t.pmdt038,   #未稅金額
    pmdt039           LIKE pmdt_t.pmdt039,   #含稅金額
    pmdt047           LIKE pmdt_t.pmdt047,   #金額
    pmdt042           LIKE pmdt_t.pmdt042,   #取價來源
    pmdt043           LIKE pmdt_t.pmdt043,   #參考單號
    pmdt044           LIKE pmdt_t.pmdt044    #取出單價
)

   CREATE TEMP TABLE apmp110_tmp3( 
    inaj015           LIKE type_t.chr80,     #單據性質
    inaj022           LIKE inaj_t.inaj022,   #扣帳日期
    inaj001           LIKE inaj_t.inaj001,   #單據編號
    inaj002           LIKE inaj_t.inaj002,   #項次
    inaj003           LIKE inaj_t.inaj003,   #項序
    inaj005           LIKE inaj_t.inaj005,   #料件編號
    inaj006           LIKE inaj_t.inaj006,   #產品特徵
    inaj007           LIKE inaj_t.inaj007,   #庫存管理特徵
    inaj011           LIKE inaj_t.inaj011,   #數量
    inaj012           LIKE inaj_t.inaj012,   #單位
    inaj008           LIKE inaj_t.inaj008,   #庫
    inaj009           LIKE inaj_t.inaj009,   #儲
    inaj010           LIKE inaj_t.inaj010    #批
)

   CALL s_tax_recount_tmp()]]>
  </point>
  <point name="main.exit" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DROP TABLE apmp110_tmp1
   DROP TABLE apmp110_tmp2
   DROP TABLE apmp110_tmp3
   DROP TABLE tax_tmp]]>
  </point>
  <point name="query.after_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   IF g_flag = '0' THEN
      IF NOT cl_ask_confirm('apm-00610') THEN
         RETURN
      END IF   
   END IF   

   LET g_flag = '1'
   DELETE FROM apmp110_tmp1
   DELETE FROM apmp110_tmp2
   DELETE FROM apmp110_tmp3
   ]]>
  </point>
  <point name="ui_dialog.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success   LIKE type_t.num5
   DEFINE l_where     STRING
   DEFINE l_cnt       LIKE type_t.num5
   DEFINE l_imaf015   LIKE imaf_t.imaf015
   DEFINE l_imaf017   LIKE imaf_t.imaf017
   DEFINE l_imaf144   LIKE imaf_t.imaf144
   DEFINE l_oodbl004  LIKE oodbl_t.oodbl004
   DEFINE l_oodb005   LIKE oodb_t.oodb005
   DEFINE l_oodb006   LIKE oodb_t.oodb006
   DEFINE l_oodb011   LIKE oodb_t.oodb011
   DEFINE l_xrcd113   LIKE xrcd_t.xrcd113
   DEFINE l_xrcd114   LIKE xrcd_t.xrcd114
   DEFINE l_xrcd115   LIKE xrcd_t.xrcd115
   DEFINE l_controlno LIKE ooha_t.ooha001
   DEFINE l_dept      LIKE ooag_t.ooag003
   DEFINE l_pmds  RECORD
      pmds012  LIKE pmds_t.pmds012,
      pmds031  LIKE pmds_t.pmds031,
      pmds032  LIKE pmds_t.pmds032,
      pmds033  LIKE pmds_t.pmds033,
      pmds034  LIKE pmds_t.pmds034,
      pmds035  LIKE pmds_t.pmds035,
      pmds037  LIKE pmds_t.pmds037,
      pmds038  LIKE pmds_t.pmds038,
      pmds039  LIKE pmds_t.pmds039,
      pmds048  LIKE pmds_t.pmds048,
      pmds049  LIKE pmds_t.pmds049
               END RECORD
   DEFINE l_flag      LIKE type_t.chr1]]>
  </point>
  <point name="ui_dialog.for.onaction_selall" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[               #ming 20150616 add ----------------------------------(S)  
               #還沒有被寫入temp table的才能處理，否則會有資料重覆寫入的問題 
               IF g_detail_d[li_idx].sel2 = 'N' THEN
                  LET g_detail_d[li_idx].sel2 = 'Y'

                  INSERT INTO apmp110_tmp3
                         VALUES(g_detail_d[g_master_idx].inaj015,g_detail_d[g_master_idx].inaj022,
                                g_detail_d[g_master_idx].inaj001,g_detail_d[g_master_idx].inaj002,
                                g_detail_d[g_master_idx].inaj003,g_detail_d[g_master_idx].inaj005,
                                g_detail_d[g_master_idx].inaj006,g_detail_d[g_master_idx].pmds007,
                                g_detail_d[g_master_idx].inaj011,g_detail_d[g_master_idx].inaj012,
                                g_detail_d[g_master_idx].inaj008,g_detail_d[g_master_idx].inaj009,
                                g_detail_d[g_master_idx].inaj010)

                  LET l_cnt = ''
                  SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp2
                   WHERE pmdt006 = g_detail_d[li_idx].inaj005
                     AND pmdt007 = g_detail_d[li_idx].inaj006
                     AND pmdt063 = g_detail_d[li_idx].pmds007
                     AND pmdt016 = g_detail_d[li_idx].inaj008
                     AND pmdt017 = g_detail_d[li_idx].inaj009
                     AND pmdt018 = g_detail_d[li_idx].inaj010
                     AND pmdt019 = g_detail_d[li_idx].inaj012
                  IF cl_null(l_cnt) OR l_cnt = 0 THEN
                     #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
                     INITIALIZE l_pmds.* TO NULL
                     LET l_dept = cl_get_sitename(g_detail_d[li_idx].pmds007) 
                     CALL s_control_get_group('4',g_detail_d[li_idx].pmds007,l_dept)
                          RETURNING l_success,l_controlno
                     IF l_success AND NOT cl_null(l_controlno) THEN
                        SELECT pmal003,pmal004,pmal006,pmal008,pmal020,pmal021,pmal023,pmal024
                          INTO l_pmds.pmds037,l_pmds.pmds033,l_pmds.pmds031,l_pmds.pmds012,
                               l_pmds.pmds032,l_pmds.pmds039,l_pmds.pmds048,l_pmds.pmds049
                          FROM pmal_t
                         WHERE pmalent = g_enterprise
                           AND pmal001 = g_detail_d[li_idx].pmds007
                           AND pmal002 = l_controlno
                           AND pmalstus = 'Y'
                     ELSE
                        SELECT pmab033,pmab034,pmab037,pmab038,pmab053,pmab054,pmab057,pmab058
                          INTO l_pmds.pmds037,l_pmds.pmds033,l_pmds.pmds031,l_pmds.pmds012,
                               l_pmds.pmds032,l_pmds.pmds039,l_pmds.pmds048,l_pmds.pmds049
                          FROM pmab_t
                         WHERE pmabent = g_enterprise
                           AND pmabsite = g_site
                           AND pmab001 = g_detail_d[li_idx].pmds007
                     END IF
                     #稅率、含稅否 
                     IF NOT cl_null(l_pmds.pmds033) THEN
                        CALL s_tax_chk(g_site,l_pmds.pmds033)
                             RETURNING l_success,l_oodbl004,l_pmds.pmds035,l_pmds.pmds034,l_oodb011
                        IF l_oodb011 = '1' THEN     #正常稅率  
                           LET l_imaf017 = l_pmds.pmds033
                           LET l_oodb005 = l_pmds.pmds035
                           LET l_oodb006 = l_pmds.pmds034
                        ELSE                        #依料件設定  
                           LET l_imaf017 = '' 
                           SELECT imaf017 INTO l_imaf017
                             FROM imaf_t
                            WHERE imafent  = g_enterprise
                              AND imafsite = g_site
                              AND imaf001 = g_detail_d[li_idx].inaj005
                           IF NOT cl_null(l_imaf017) THEN
                              CALL s_tax_chk(g_site,l_imaf017)
                                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                           END IF
                        END IF
                     END IF

                     #項次 
                     SELECT MAX(pmdtseq) + 1 INTO l_cnt
                       FROM apmp110_tmp2
                      WHERE pmdt063 = g_detail_d[li_idx].pmds007
                     IF cl_null(l_cnt) THEN
                        LET l_cnt = 1
                     END IF

                     #入庫/倉退明細 
                     INSERT INTO apmp110_tmp2 VALUES(l_cnt,g_detail_d[li_idx].inaj005,
                          g_detail_d[li_idx].inaj006,g_detail_d[li_idx].pmds007,
                          g_detail_d[li_idx].inaj012,'0','','0',
                          g_detail_d[li_idx].inaj008,g_detail_d[li_idx].inaj009,
                          g_detail_d[li_idx].inaj010,l_imaf017,l_oodb006,
                          '','0','0','0','0','0','','','')
                     LET l_cnt = '' 
                     SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp1
                      WHERE pmds007 = g_detail_d[li_idx].pmds007
                     IF cl_null(l_cnt) OR l_cnt = 0 THEN
                        #匯率 
                        CALL apmp110_get_exrate(l_pmds.pmds037,l_pmds.pmds048)
                             RETURNING l_pmds.pmds038
                        #入庫/倉退單據 
                        INSERT INTO apmp110_tmp1(pmds007,pmds031,pmds032,pmds033,pmds034,pmds035,
                                                 pmds037,pmds038,pmds039,pmds048,pmds049,pmds012)
                                          VALUES(g_detail_d[g_master_idx].pmds007,l_pmds.pmds031,
                                                 l_pmds.pmds032,l_pmds.pmds033,l_pmds.pmds034,l_pmds.pmds035,
                                                 l_pmds.pmds037,l_pmds.pmds038,l_pmds.pmds039,l_pmds.pmds048,
                                                 l_pmds.pmds049,l_pmds.pmds012)
                     END IF
                  END IF
                  CALL apmp110_count()
               END IF  
               #ming 20150616 add ----------------------------------(E)  ]]>
  </point>
  <point name="ui_dialog.for.onaction_selnone" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[               #ming 20150616 add -----------------------------(S) 
               #已經被寫入temp table才需要花時間、效能去處理 
               IF g_detail_d[li_idx].sel2 = 'Y' THEN
                  LET g_detail_d[li_idx].sel2 = 'N'

                  #結算資料清單 
                  DELETE FROM apmp110_tmp3
                   WHERE inaj001 = g_detail_d[li_idx].inaj001     #單據編號  
                     AND inaj002 = g_detail_d[li_idx].inaj002     #項次  
                     AND inaj003 = g_detail_d[li_idx].inaj003     #項序  
                     AND inaj001 = g_detail_d[li_idx].inaj011     #交易數量  

                  LET l_cnt = ''
                  SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp
                   WHERE inaj005 = g_detail_d[li_idx].inaj005     #料件編號  
                     AND inaj006 = g_detail_d[li_idx].inaj006     #產品特徵  
                     AND inaj007 = g_detail_d[li_idx].pmds007     #庫存管理特徵  
                     AND inaj008 = g_detail_d[li_idx].inaj008     #庫位編號   
                     AND inaj009 = g_detail_d[li_idx].inaj009     #儲位編號  
                     AND inaj010 = g_detail_d[li_idx].inaj010     #批號  
                     AND inaj012 = g_detail_d[li_idx].inaj012     #交易單位  
                  IF cl_null(l_cnt) OR l_cnt = 0 THEN
                     #如果在apmp110_tmp3已無資料的話，就應該把apmp110_tmp2的項目移除 
                     #入庫/倉退明細 
                     DELETE FROM apmp110_tmp2
                      WHERE pmdt006 = g_detail_d[li_idx].inaj005
                        AND pmdt007 = g_detail_d[li_idx].inaj006
                        AND pmdt063 = g_detail_d[li_idx].pmds007
                        AND pmdt016 = g_detail_d[li_idx].inaj008 
                        AND pmdt017 = g_detail_d[li_idx].inaj009
                        AND pmdt018 = g_detail_d[li_idx].inaj010
                        AND pmdt019 = g_detail_d[li_idx].inaj012

                     SELECT COUNT(*) INTO l_cnt
                       FROM apmp110_tmp2
                      WHERE pmdt063 = g_detail_d[li_idx].pmds007
                     IF cl_null(l_cnt) OR l_cnt = 0 THEN
                        #入庫/倉退單據 
                        DELETE FROM apmp110_tmp1
                         WHERE pmds007 = g_detail_d[li_idx].pmds007
                     ELSE
                        CALL apmp110_count()
                     END IF
                  ELSE
                     CALL apmp110_count()
                  END IF
               END IF
               #ming 20150616 add -----------------------------(E)  ]]>
  </point>
  <point name="ui_dialog.more_action" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
         ON ACTION batch_execute
            #在產生單據前需檢核畫面左邊查詢條件區塊的入庫單別、入庫理由碼、倉退單別、倉退理由碼是否有維護，
            #若沒有則顯示訊息告知需維護
            IF cl_null(tm.pmdtdocno1) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'apm-00603'
               LET g_errparam.extend = 'pmdtdocno'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD pmdtdocno1
            END IF
            IF cl_null(tm.pmdtdocno2) THEN
               INITIALIZE g_errparam TO NULL
               #ming 20150617 modify ----------------(S) 
               #LET g_errparam.code = 'apm-00603'
               LET g_errparam.code = 'apm-00957'     #倉退單別未輸入 
               #ming 20150617 modify ----------------(E) 
               LET g_errparam.extend = 'pmdtdocno'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD pmdtdocno2
            END IF
            LET l_cnt = ''
            SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp3
            IF cl_null(l_cnt) OR l_cnt = 0 THEN
               CALL cl_ask_pressanykey('-400')
               NEXT FIELD b_sel
            END IF
            IF apmp110_data_chk() THEN
               CALL apmp110_process()
            END IF
]]>
  </point>
  <point name="ui_dialog.more_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         CONSTRUCT BY NAME g_wc ON inaj005,imaa009,inaj025,inaj007,oocq002,inaj008,inaj022
	   
            BEFORE CONSTRUCT

            ON ACTION controlp INFIELD inaj005  #料件編號
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_imaf001_15()
               DISPLAY g_qryparam.return1 TO inaj005
               NEXT FIELD inaj005

            ON ACTION controlp INFIELD imaa009  #產品分類
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_rtax001()
               DISPLAY g_qryparam.return1 TO imaa009
               NEXT FIELD imaa009

            ON ACTION controlp INFIELD inaj025  #主要採購員
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_ooag001()
               DISPLAY g_qryparam.return1 TO inaj025
               NEXT FIELD inaj025

            ON ACTION controlp INFIELD inaj007  #供應商編號
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_pmaa001_3()
               DISPLAY g_qryparam.return1 TO inaj007
               NEXT FIELD inaj007

            ON ACTION controlp INFIELD oocq002  #供應商分類
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.arg1 = '251'
               CALL q_oocq002()
               DISPLAY g_qryparam.return1 TO oocq002
               NEXT FIELD oocq002

            ON ACTION controlp INFIELD inaj008  #VMI結算庫位
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               CALL q_inaa001()
               DISPLAY g_qryparam.return1 TO inaj008
               NEXT FIELD inaj008

#            ON ACTION controlp INFIELD inaj009  #VMI結算儲位
#               INITIALIZE g_qryparam.* TO NULL
#               LET g_qryparam.state = 'c'
#               LET g_qryparam.reqry = FALSE
#               CALL q_inab002()
#               DISPLAY g_qryparam.return1 TO inaj009
#               NEXT FIELD inaj009

         END CONSTRUCT
]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         DISPLAY ARRAY g_detail4_d TO s_detail4.* ATTRIBUTES(COUNT=g_detail4_cnt)

            BEFORE ROW
               LET g_detail4_idx = DIALOG.getCurrentRow("s_detail4")

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail4_idx)
               LET g_detail4_idx = DIALOG.getCurrentRow("s_detail4")

         END DISPLAY
]]>
  </point>
  <point name="ui_dialog.more_input" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[         INPUT BY NAME tm.pmdtdocno1,tm.pmdt0511,tm.pmdtdocno2,tm.pmdt0512
            ATTRIBUTE(WITHOUT DEFAULTS)
         
            BEFORE INPUT
               CALL apmp110_set_required() RETURNING l_flag

            AFTER FIELD pmdtdocno1
               CALL s_aooi200_get_slip_desc(tm.pmdtdocno1) RETURNING tm.pmdtdocno1_desc
               DISPLAY BY NAME tm.pmdtdocno1_desc 
               
               #ming 20150617 add ------------(S) 
               IF NOT cl_null(tm.pmdtdocno1) THEN
                  IF NOT s_aooi200_chk_slip(g_site,'',tm.pmdtdocno1,'apmt532') THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
               #ming 20150617 add ------------(E)  
            
            BEFORE FIELD pmdt0511
               IF cl_null(tm.pmdtdocno1) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00603'
                  LET g_errparam.extend = 'pmdtdocno'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD pmdtdocno1
               END IF

            AFTER FIELD pmdt0511
               IF NOT cl_null(tm.pmdt0511) THEN
                  IF NOT s_azzi650_chk_exist(g_acc1,tm.pmdt0511) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
               CALL s_desc_get_acc_desc(g_acc1,tm.pmdt0511) RETURNING tm.pmdt0511_desc
               DISPLAY BY NAME tm.pmdt0511_desc

            AFTER FIELD pmdtdocno2
               CALL s_aooi200_get_slip_desc(tm.pmdtdocno2) RETURNING tm.pmdtdocno2_desc
               DISPLAY BY NAME tm.pmdtdocno2_desc

            BEFORE FIELD pmdt0512
               IF cl_null(tm.pmdtdocno2) THEN
                  INITIALIZE g_errparam TO NULL
                  #ming 20150617 modify ----------------(S) 
                  #LET g_errparam.code = 'apm-00603'
                  LET g_errparam.code = 'apm-00957'     #倉退單別未輸入 
                  #ming 20150617 modify ----------------(E) 
                  LET g_errparam.extend = 'pmdtdocno'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD pmdtdocno2
               END IF

            AFTER FIELD pmdt0512
               IF NOT cl_null(tm.pmdt0512) THEN
                  IF NOT s_azzi650_chk_exist(g_acc2,tm.pmdt0512) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
               CALL s_desc_get_acc_desc(g_acc2,tm.pmdt0512) RETURNING tm.pmdt0512_desc
               DISPLAY BY NAME tm.pmdt0512_desc

            ON ACTION controlp INFIELD pmdtdocno1  #收貨入庫單別
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.pmdtdocno1
               LET g_qryparam.arg1 = g_ooef004
               LET g_qryparam.arg2 = 'apmt532'
               CALL q_ooba002_1()
               LET tm.pmdtdocno1 = g_qryparam.return1
               DISPLAY tm.pmdtdocno1 TO pmdtdocno1
               CALL s_aooi200_get_slip_desc(tm.pmdtdocno1) RETURNING tm.pmdtdocno1_desc
               DISPLAY BY NAME tm.pmdtdocno1_desc
               NEXT FIELD pmdtdocno1

            ON ACTION controlp INFIELD pmdt0511  #收貨理由
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.pmdt0511
               LET g_qryparam.where = "1=1 "
               LET l_where = ''
               CALL s_control_get_doc_sql("oocq002",tm.pmdtdocno1,'8') RETURNING l_success,l_where
               IF l_success AND NOT cl_null(l_where) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND ",l_where
               END IF
               LET g_qryparam.arg1 = g_acc1
               CALL q_oocq002()
               LET tm.pmdt0511 = g_qryparam.return1
               DISPLAY tm.pmdt0511 TO pmdt0511
               CALL s_desc_get_acc_desc(g_acc1,tm.pmdt0511) RETURNING tm.pmdt0511_desc
               DISPLAY BY NAME tm.pmdt0511_desc
               NEXT FIELD pmdt0511

            ON ACTION controlp INFIELD pmdtdocno2  #倉退單別
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.pmdtdocno2
               LET g_qryparam.arg1 = g_ooef004
               LET g_qryparam.arg2 = 'apmt580'
               CALL q_ooba002_1()
               LET tm.pmdtdocno2 = g_qryparam.return1
               DISPLAY tm.pmdtdocno2 TO pmdtdocno2
               CALL s_aooi200_get_slip_desc(tm.pmdtdocno2) RETURNING tm.pmdtdocno2_desc
               DISPLAY BY NAME tm.pmdtdocno2_desc
               NEXT FIELD pmdtdocno2

            ON ACTION controlp INFIELD pmdt0512  #倉退理由
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = tm.pmdt0512
               LET g_qryparam.where = "1=1 "
               LET l_where = ''
               CALL s_control_get_doc_sql("oocq002",tm.pmdtdocno2,'8') RETURNING l_success,l_where
               IF l_success AND NOT cl_null(l_where) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND ",l_where
               END IF
               LET g_qryparam.arg1 = g_acc2
               CALL q_oocq002()
               LET tm.pmdt0512 = g_qryparam.return1
               DISPLAY tm.pmdt0512 TO pmdt0512
               CALL s_desc_get_acc_desc(g_acc2,tm.pmdt0512) RETURNING tm.pmdt0512_desc
               DISPLAY BY NAME tm.pmdt0512_desc
               NEXT FIELD pmdt0512

            AFTER INPUT
               IF INT_FLAG THEN
                  EXIT DIALOG
               END IF

         END INPUT

         INPUT ARRAY g_detail_d FROM s_detail1.*
            ATTRIBUTE(COUNT = g_detail_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                      INSERT ROW = FALSE,
                      DELETE ROW = FALSE,
                      APPEND ROW = FALSE)

            BEFORE INPUT
               LET g_detail_cnt = g_detail_d.getLength()

            BEFORE ROW
               LET g_master_idx = ARR_CURR()
               DISPLAY g_master_idx TO FORMONLY.h_index
               LET g_detail_cnt = g_detail_d.getLength()
               CALL apmp110_fetch()

            ON CHANGE b_sel 
               #ming 20150616 add -----------------------(S) 
               #手動的情況，直接改變sel2即可 
               LET g_detail_d[g_master_idx].sel2 = g_detail_d[g_master_idx].sel
               #ming 20150616 add -----------------------(E)  
               
               IF g_detail_d[g_master_idx].sel = 'N' THEN  #取消勾選
                  #結算資料清單
                  DELETE FROM apmp110_tmp3
                   WHERE inaj001 = g_detail_d[g_master_idx].inaj001
                     AND inaj002 = g_detail_d[g_master_idx].inaj002
                     AND inaj003 = g_detail_d[g_master_idx].inaj003
                     AND inaj011 = g_detail_d[g_master_idx].inaj011
                  LET l_cnt = ''
                  SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp3
                   WHERE inaj005 = g_detail_d[g_master_idx].inaj005
                     AND inaj006 = g_detail_d[g_master_idx].inaj006
                     AND inaj007 = g_detail_d[g_master_idx].pmds007
                     AND inaj008 = g_detail_d[g_master_idx].inaj008
                     AND inaj009 = g_detail_d[g_master_idx].inaj009
                     AND inaj010 = g_detail_d[g_master_idx].inaj010
                     AND inaj012 = g_detail_d[g_master_idx].inaj012
                  IF cl_null(l_cnt) OR l_cnt = 0 THEN
                     #入庫/倉退明細
                     DELETE FROM apmp110_tmp2
                      WHERE pmdt006 = g_detail_d[g_master_idx].inaj005
                        AND pmdt007 = g_detail_d[g_master_idx].inaj006
                        AND pmdt063 = g_detail_d[g_master_idx].pmds007
                        AND pmdt016 = g_detail_d[g_master_idx].inaj008
                        AND pmdt017 = g_detail_d[g_master_idx].inaj009
                        AND pmdt018 = g_detail_d[g_master_idx].inaj010
                        AND pmdt019 = g_detail_d[g_master_idx].inaj012
                     SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp2
                      WHERE pmdt063 = g_detail_d[g_master_idx].pmds007
                     IF cl_null(l_cnt) OR l_cnt = 0 THEN
                        #入庫/倉退單據
                        DELETE FROM apmp110_tmp1
                         WHERE pmds007 = g_detail_d[g_master_idx].pmds007
                     ELSE
                        CALL apmp110_count()
                     END IF
                  ELSE
                     CALL apmp110_count()
                  END IF
               ELSE  #勾選結算資料清單
                  INSERT INTO apmp110_tmp3 VALUES(g_detail_d[g_master_idx].inaj015,
                 g_detail_d[g_master_idx].inaj022,g_detail_d[g_master_idx].inaj001,
                 g_detail_d[g_master_idx].inaj002,g_detail_d[g_master_idx].inaj003,
                 g_detail_d[g_master_idx].inaj005,g_detail_d[g_master_idx].inaj006,
                 g_detail_d[g_master_idx].pmds007,g_detail_d[g_master_idx].inaj011,
                 g_detail_d[g_master_idx].inaj012,g_detail_d[g_master_idx].inaj008,
                 g_detail_d[g_master_idx].inaj009,g_detail_d[g_master_idx].inaj010)
                  LET l_cnt = ''
                  SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp2
                   WHERE pmdt006 = g_detail_d[g_master_idx].inaj005
                     AND pmdt007 = g_detail_d[g_master_idx].inaj006
                     AND pmdt063 = g_detail_d[g_master_idx].pmds007
                     AND pmdt016 = g_detail_d[g_master_idx].inaj008
                     AND pmdt017 = g_detail_d[g_master_idx].inaj009
                     AND pmdt018 = g_detail_d[g_master_idx].inaj010
                     AND pmdt019 = g_detail_d[g_master_idx].inaj012
                  IF cl_null(l_cnt) OR l_cnt = 0 THEN
                     #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
                     INITIALIZE l_pmds.* TO NULL
                     LET l_dept = cl_get_sitename(g_detail_d[g_master_idx].pmds007)
                     CALL s_control_get_group('4',g_detail_d[g_master_idx].pmds007,l_dept) RETURNING l_success,l_controlno
                     IF l_success AND NOT cl_null(l_controlno) THEN
                        SELECT pmal003,pmal004,pmal006,pmal008,pmal020,pmal021,pmal023,pmal024
                          INTO l_pmds.pmds037,l_pmds.pmds033,l_pmds.pmds031,l_pmds.pmds012,
                               l_pmds.pmds032,l_pmds.pmds039,l_pmds.pmds048,l_pmds.pmds049
                          FROM pmal_t 
                         WHERE pmalent = g_enterprise AND pmal001 = g_detail_d[g_master_idx].pmds007
                           AND pmal002 = l_controlno AND pmalstus = 'Y'
                     ELSE
                        SELECT pmab033,pmab034,pmab037,pmab038,pmab053,pmab054,pmab057,pmab058
                          INTO l_pmds.pmds037,l_pmds.pmds033,l_pmds.pmds031,l_pmds.pmds012,
                               l_pmds.pmds032,l_pmds.pmds039,l_pmds.pmds048,l_pmds.pmds049
                          FROM pmab_t
                         WHERE pmabent = g_enterprise AND pmabsite = g_site
                           AND pmab001 = g_detail_d[g_master_idx].pmds007
                     END IF
                     #稅率、含稅否
                     IF NOT cl_null(l_pmds.pmds033) THEN
                        CALL s_tax_chk(g_site,l_pmds.pmds033)
                             RETURNING l_success,l_oodbl004,l_pmds.pmds035,l_pmds.pmds034,l_oodb011
                        IF l_oodb011 = '1' THEN  #正常稅率
                           LET l_imaf017 = l_pmds.pmds033
                           LET l_oodb005 = l_pmds.pmds035
                           LET l_oodb006 = l_pmds.pmds034
                        ELSE                     #依料件設定
                           LET l_imaf017 = ''
                           SELECT imaf017 INTO l_imaf017 FROM imaf_t
                            WHERE imafent = g_enterprise AND imafsite = g_site
                              AND imaf001 = g_detail_d[g_master_idx].inaj005
                           IF NOT cl_null(l_imaf017) THEN
                              CALL s_tax_chk(g_site,l_imaf017)
                                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                           END IF
                        END IF
                     END IF
                     #項次
                     SELECT MAX(pmdtseq)+1 INTO l_cnt FROM apmp110_tmp2
                      WHERE pmdt063 = g_detail_d[g_master_idx].pmds007
                     IF cl_null(l_cnt) THEN LET l_cnt = 1 END IF
                     #入庫/倉退明細
                     INSERT INTO apmp110_tmp2 VALUES(l_cnt,g_detail_d[g_master_idx].inaj005,
                          g_detail_d[g_master_idx].inaj006,g_detail_d[g_master_idx].pmds007,
                          g_detail_d[g_master_idx].inaj012,'0','','0',
                          g_detail_d[g_master_idx].inaj008,g_detail_d[g_master_idx].inaj009,
                          g_detail_d[g_master_idx].inaj010,l_imaf017,l_oodb006,
                          '','0','0','0','0','0','','','')
                     LET l_cnt = ''
                     SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp1
                      WHERE pmds007 = g_detail_d[g_master_idx].pmds007
                     IF cl_null(l_cnt) OR l_cnt = 0 THEN
                        #匯率
                        CALL apmp110_get_exrate(l_pmds.pmds037,l_pmds.pmds048) RETURNING l_pmds.pmds038
                        #入庫/倉退單據
                        INSERT INTO apmp110_tmp1(pmds007,pmds031,pmds032,pmds033,pmds034,pmds035,
                                                 pmds037,pmds038,pmds039,pmds048,pmds049,pmds012)
                                          VALUES(g_detail_d[g_master_idx].pmds007,l_pmds.pmds031,
                                                 l_pmds.pmds032,l_pmds.pmds033,l_pmds.pmds034,l_pmds.pmds035,
                                                 l_pmds.pmds037,l_pmds.pmds038,l_pmds.pmds039,l_pmds.pmds048,
                                                 l_pmds.pmds049,l_pmds.pmds012)
                     END IF
                  END IF
                  CALL apmp110_count()
               END IF
               CALL apmp110_fetch()
               CALL apmp110_get_price()

         END INPUT

         INPUT ARRAY g_detail2_d FROM s_detail2.* 
              ATTRIBUTE(COUNT = g_detail2_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)

            BEFORE INPUT
               CALL apmp110_set_required() RETURNING l_flag
               CASE 
                  WHEN l_flag = '1' OR l_flag = '3'
                     IF cl_null(tm.pmdtdocno1) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'apm-00603'
                        LET g_errparam.extend = 'pmdtdocno'
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD pmdtdocno1
                     END IF
                  WHEN l_flag = '2' OR l_flag = '3'
                     IF cl_null(tm.pmdtdocno2) THEN
                        INITIALIZE g_errparam TO NULL
                        #ming 20150617 modify ----------------(S) 
                        #LET g_errparam.code = 'apm-00603'
                        LET g_errparam.code = 'apm-00957'     #倉退單別未輸入 
                        #ming 20150617 modify ----------------(E) 
                        LET g_errparam.extend = 'pmdtdocno'
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD pmdtdocno2
                     ELSE
                        IF cl_null(tm.pmdt0512) THEN
                           NEXT FIELD pmdt0512
                        END IF
                     END IF
                  OTHERWISE EXIT CASE
               END CASE
               LET g_detail2_cnt = g_detail2_d.getLength()
               LET g_flag = '0'

            BEFORE ROW
               LET g_detail2_idx = ARR_CURR()
               LET g_detail2_cnt = g_detail2_d.getLength()
               LET g_detail2_d_o.pmds031 = g_detail2_d[g_detail2_idx].pmds031
               LET g_detail2_d_o.pmds032 = g_detail2_d[g_detail2_idx].pmds032
               LET g_detail2_d_o.pmds033 = g_detail2_d[g_detail2_idx].pmds033
               LET g_detail2_d_o.pmds037 = g_detail2_d[g_detail2_idx].pmds037
               LET g_detail2_d_o.pmds039 = g_detail2_d[g_detail2_idx].pmds039
               CALL apmp110_fetch_1()

            AFTER FIELD pmds031
               LET g_detail2_d[g_detail2_idx].pmds031_desc = ''
               IF NOT cl_null(g_detail2_d[g_detail2_idx].pmds031) THEN
                  IF g_detail2_d[g_detail2_idx].pmds031 <> g_detail2_d_o.pmds031 OR cl_null(g_detail2_d_o.pmds031) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_detail2_d[g_detail2_idx].pmds007
                     LET g_chkparam.arg2 = g_detail2_d[g_detail2_idx].pmds031
                     IF NOT cl_chk_exist("v_pmad002_1") THEN
                        LET g_detail2_d[g_detail2_idx].pmds031 = g_detail2_d_o.pmds031
                        CALL s_desc_get_ooib002_desc(g_detail2_d[g_detail2_idx].pmds031) RETURNING g_detail2_d[g_detail2_idx].pmds031_desc
                        NEXT FIELD CURRENT
                     END IF
                     CALL apmp110_get_price()
                  END IF
               END IF
               CALL s_desc_get_ooib002_desc(g_detail2_d[g_detail2_idx].pmds031) RETURNING g_detail2_d[g_detail2_idx].pmds031_desc
               LET g_detail2_d_o.pmds031 = g_detail2_d[g_detail2_idx].pmds031

            AFTER FIELD pmds032
               LET g_detail2_d[g_detail2_idx].pmds032_desc = ''
               IF NOT cl_null(g_detail2_d[g_detail2_idx].pmds032) THEN
                  IF g_detail2_d[g_detail2_idx].pmds032 <> g_detail2_d_o.pmds032 OR cl_null(g_detail2_d_o.pmds032) THEN
                     IF NOT s_azzi650_chk_exist('238',g_detail2_d[g_detail2_idx].pmds032) THEN
                        LET g_detail2_d[g_detail2_idx].pmds032 = g_detail2_d_o.pmds032
                        CALL s_desc_get_acc_desc('238',g_detail2_d[g_detail2_idx].pmds032) RETURNING g_detail2_d[g_detail2_idx].pmds032_desc
                        NEXT FIELD CURRENT
                     END IF
                     CALL apmp110_get_price()
                  END IF
               END IF
               CALL s_desc_get_acc_desc('238',g_detail2_d[g_detail2_idx].pmds032) RETURNING g_detail2_d[g_detail2_idx].pmds032_desc
               LET g_detail2_d_o.pmds032 = g_detail2_d[g_detail2_idx].pmds032

            AFTER FIELD pmds033
               LET g_detail2_d[g_detail2_idx].pmds033_desc = ''
               IF NOT cl_null(g_detail2_d[g_detail2_idx].pmds033) THEN
                  IF g_detail2_d[g_detail2_idx].pmds033 <> g_detail2_d_o.pmds033 OR cl_null(g_detail2_d_o.pmds033) THEN
                     CALL s_tax_chk(g_site,g_detail2_d[g_detail2_idx].pmds033)
                          RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                     IF NOT l_success THEN
                        LET g_detail2_d[g_detail2_idx].pmds033 = g_detail2_d_o.pmds033
                        CALL s_desc_get_tax_desc1(g_site,g_detail2_d[g_detail2_idx].pmds033) RETURNING g_detail2_d[g_detail2_idx].pmds033_desc
                        NEXT FIELD CURRENT
                     ELSE
                        LET g_detail2_d[g_detail2_idx].pmds033_desc = l_oodbl004
                        LET g_detail2_d[g_detail2_idx].pmds034 = l_oodb006
                        LET g_detail2_d[g_detail2_idx].pmds035 = l_oodb005
                     END IF
                  END IF
               END IF
               CALL s_desc_get_tax_desc1(g_site,g_detail2_d[g_detail2_idx].pmds033) RETURNING g_detail2_d[g_detail2_idx].pmds033_desc
               LET g_detail2_d_o.pmds033 = g_detail2_d[g_detail2_idx].pmds033

            AFTER FIELD pmds037
               LET g_detail2_d[g_detail2_idx].pmds037_desc = ''
               IF NOT cl_null(g_detail2_d[g_detail2_idx].pmds037) THEN
                  IF g_detail2_d[g_detail2_idx].pmds037 <> g_detail2_d_o.pmds037 OR cl_null(g_detail2_d_o.pmds037) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_site
                     LET g_chkparam.arg2 = g_detail2_d[g_detail2_idx].pmds037
                     IF NOT cl_chk_exist("v_ooaj002") THEN
                        LET g_detail2_d[g_detail2_idx].pmds037 = g_detail2_d_o.pmds037
                        CALL s_desc_get_currency_desc(g_detail2_d[g_detail2_idx].pmds037) RETURNING g_detail2_d[g_detail2_idx].pmds037_desc
                        NEXT FIELD CURRENT
                     END IF
                     CALL apmp110_get_exrate(g_detail2_d[g_detail2_idx].pmds037,g_detail2_d[g_detail2_idx].pmds048)
                          RETURNING g_detail2_d[g_detail2_idx].pmds038
                     CALL apmp110_get_price()
                  END IF
               END IF
               CALL s_desc_get_currency_desc(g_detail2_d[g_detail2_idx].pmds037) RETURNING g_detail2_d[g_detail2_idx].pmds037_desc
               LET g_detail2_d_o.pmds037 = g_detail2_d[g_detail2_idx].pmds037

            AFTER FIELD pmds039
               LET g_detail2_d[g_detail2_idx].pmds039_desc = ''
               IF NOT cl_null(g_detail2_d[g_detail2_idx].pmds039) THEN
                  IF g_detail2_d[g_detail2_idx].pmds039 <> g_detail2_d_o.pmds039 OR cl_null(g_detail2_d_o.pmds039) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_detail2_d[g_detail2_idx].pmds039
                     IF NOT cl_chk_exist("v_pmam001") THEN
                        LET g_detail2_d[g_detail2_idx].pmds039 = g_detail2_d_o.pmds039
                        CALL s_desc_get_price_type_desc(g_detail2_d[g_detail2_idx].pmds039) RETURNING g_detail2_d[g_detail2_idx].pmds039_desc
                        NEXT FIELD CURRENT
                     END IF
                     CALL apmp110_get_price()
                  END IF
               END IF
               CALL s_desc_get_price_type_desc(g_detail2_d[g_detail2_idx].pmds039) RETURNING g_detail2_d[g_detail2_idx].pmds039_desc
               LET g_detail2_d_o.pmds039 = g_detail2_d[g_detail2_idx].pmds039

            ON ACTION controlp INFIELD pmds031  #付款條件
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail2_d[g_detail2_idx].pmds031
               LET g_qryparam.arg1 = g_detail2_d[g_detail2_idx].pmds007
               CALL q_pmad002_2()
               LET g_detail2_d[g_detail2_idx].pmds031 = g_qryparam.return1
               DISPLAY g_detail2_d[g_detail2_idx].pmds031 TO pmds031
               CALL s_desc_get_ooib002_desc(g_detail2_d[g_detail2_idx].pmds031) RETURNING g_detail2_d[g_detail2_idx].pmds031_desc
               NEXT FIELD pmds031

            ON ACTION controlp INFIELD pmds032  #交易條件
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail2_d[g_detail2_idx].pmds032
               LET g_qryparam.arg1 = '238'
               CALL q_oocq002()
               LET g_detail2_d[g_detail2_idx].pmds032 = g_qryparam.return1
               DISPLAY g_detail2_d[g_detail2_idx].pmds032 TO pmds032
               CALL s_desc_get_acc_desc('238',g_detail2_d[g_detail2_idx].pmds032) RETURNING g_detail2_d[g_detail2_idx].pmds032_desc
               NEXT FIELD pmds032

            ON ACTION controlp INFIELD pmds033  #稅別
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail2_d[g_detail2_idx].pmds033
               CALL q_oodb002_2()
               LET g_detail2_d[g_detail2_idx].pmds033 = g_qryparam.return1
               DISPLAY g_detail2_d[g_detail2_idx].pmds033 TO pmds033
               CALL s_desc_get_tax_desc1(g_site,g_detail2_d[g_detail2_idx].pmds033) RETURNING g_detail2_d[g_detail2_idx].pmds033_desc
               NEXT FIELD pmds033

            ON ACTION controlp INFIELD pmds037  #幣別
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail2_d[g_detail2_idx].pmds037
               LET g_qryparam.arg1 = g_site
               CALL q_ooaj002_1()
               LET g_detail2_d[g_detail2_idx].pmds037 = g_qryparam.return1
               DISPLAY g_detail2_d[g_detail2_idx].pmds037 TO pmds037
               CALL s_desc_get_currency_desc(g_detail2_d[g_detail2_idx].pmds037) RETURNING g_detail2_d[g_detail2_idx].pmds037_desc
               NEXT FIELD pmds037

            ON ACTION controlp INFIELD pmds039  #取價方式
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail2_d[g_detail2_idx].pmds039
               CALL q_pmam001()
               LET g_detail2_d[g_detail2_idx].pmds039 = g_qryparam.return1
               DISPLAY g_detail2_d[g_detail2_idx].pmds039 TO pmds039
               CALL s_desc_get_price_type_desc(g_detail2_d[g_detail2_idx].pmds039) RETURNING g_detail2_d[g_detail2_idx].pmds039_desc
               NEXT FIELD pmds039

            ON ROW CHANGE
               IF INT_FLAG THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = '' 
                  LET g_errparam.code   = 9001 
                  LET g_errparam.popup  = FALSE 
                  CALL cl_err()
                  LET INT_FLAG = 0
                  EXIT DIALOG 
               END IF
               INITIALIZE g_errparam TO NULL 
               UPDATE apmp110_tmp1 SET pmds031 = g_detail2_d[g_detail2_idx].pmds031,
                                       pmds032 = g_detail2_d[g_detail2_idx].pmds032,
                                       pmds033 = g_detail2_d[g_detail2_idx].pmds033,
                                       pmds034 = g_detail2_d[g_detail2_idx].pmds034,
                                       pmds035 = g_detail2_d[g_detail2_idx].pmds035,
                                       pmds037 = g_detail2_d[g_detail2_idx].pmds037,
                                       pmds038 = g_detail2_d[g_detail2_idx].pmds038,
                                       pmds039 = g_detail2_d[g_detail2_idx].pmds039
                WHERE pmds007 = g_detail2_d[g_detail2_idx].pmds007
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_errparam.code   = "std-00009" 
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_errparam.code   = SQLCA.sqlcode 
                  OTHERWISE EXIT CASE
               END CASE
               IF NOT cl_null(g_errparam.code) THEN
                  LET g_errparam.extend = "axmp501_tmp" 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               END IF

         END INPUT

         INPUT ARRAY g_detail3_d FROM s_detail3.* 
              ATTRIBUTE(COUNT = g_detail3_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)

            BEFORE INPUT
               CALL apmp110_set_required() RETURNING l_flag
               CASE 
                  WHEN l_flag = '1' OR l_flag = '3'
                     IF cl_null(tm.pmdtdocno1) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'apm-00603'
                        LET g_errparam.extend = 'pmdtdocno'
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD pmdtdocno1
                     END IF
                  WHEN l_flag = '2' OR l_flag = '3'
                     IF cl_null(tm.pmdtdocno2) THEN
                        INITIALIZE g_errparam TO NULL
                        #ming 20150617 modify ----------------(S) 
                        #LET g_errparam.code = 'apm-00603'
                        LET g_errparam.code = 'apm-00957'     #倉退單別未輸入 
                        #ming 20150617 modify ----------------(E) 
                        LET g_errparam.extend = 'pmdtdocno'
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD pmdtdocno2
                     ELSE
                        IF cl_null(tm.pmdt0512) THEN
                           NEXT FIELD pmdt0512
                        END IF
                     END IF
                  OTHERWISE EXIT CASE
               END CASE
               LET g_detail3_cnt = g_detail3_d.getLength()
               LET g_flag = '0'

            BEFORE ROW
               LET g_detail3_idx = ARR_CURR()
               LET g_detail3_cnt = g_detail3_d.getLength()
               LET g_detail3_d_o.pmdt022 = g_detail3_d[g_detail3_idx].pmdt022
               LET g_detail3_d_o.pmdt046 = g_detail3_d[g_detail3_idx].pmdt046
               LET g_detail3_d_o.pmdt024 = g_detail3_d[g_detail3_idx].pmdt024
               LET g_detail3_d_o.pmdt036 = g_detail3_d[g_detail3_idx].pmdt036
               CALL apmp110_fetch_2()
               LET l_imaf015 = ''
               LET l_imaf144 = ''
               SELECT imaf015,imaf144 INTO l_imaf015,l_imaf144 FROM imaf_t
                WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_detail3_d[g_detail3_idx].pmdt006
               #[T:料件據點進銷存檔]未設參考單位，參考數量不允許輸入
               IF cl_null(l_imaf015) THEN
                  CALL cl_set_comp_entry("pmdt021,pmdt021_desc,pmdt022",FALSE)
               END IF
               #[T:料件據點進銷存檔]未設計價單位，計價數量不允許輸入
               IF cl_null(l_imaf144) THEN
                  CALL cl_set_comp_entry("pmdt023,pmdt023_desc,pmdt024",FALSE)
               END IF

            AFTER FIELD pmdt022
               IF NOT cl_null(g_detail3_d[g_detail3_idx].pmdt022) THEN
                  IF g_detail3_d[g_detail3_idx].pmdt022 <> g_detail3_d_o.pmdt022 OR cl_null(g_detail3_d_o.pmdt022) THEN
                     IF NOT cl_ap_chk_range(g_detail3_d[g_detail3_idx].pmdt022,"0.000","0","","","azz-00079",1) THEN
                        LET g_detail3_d[g_detail3_idx].pmdt022 = g_detail3_d_o.pmdt022
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               LET g_detail3_d_o.pmdt022 = g_detail3_d[g_detail3_idx].pmdt022

            AFTER FIELD pmdt046
               IF NOT cl_null(g_detail3_d[g_detail3_idx].pmdt046) THEN
                  IF g_detail3_d[g_detail3_idx].pmdt046 <> g_detail3_d_o.pmdt046 OR cl_null(g_detail3_d_o.pmdt046) THEN
                     CALL s_tax_chk(g_site,g_detail3_d[g_detail3_idx].pmdt046)
                          RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                     IF NOT l_success THEN
                        LET g_detail3_d[g_detail3_idx].pmdt046 = g_detail3_d_o.pmdt046
                        NEXT FIELD CURRENT
                     ELSE
                        LET g_detail3_d[g_detail3_idx].pmdt046_desc = l_oodbl004
                        LET g_detail3_d[g_detail3_idx].pmdt037 = l_oodb006
                     END IF
                     CALL apmp110_get_price()
                  END IF
               END IF
               LET g_detail3_d_o.pmdt046 = g_detail3_d[g_detail3_idx].pmdt046

            AFTER FIELD pmdt024
               IF NOT cl_null(g_detail3_d[g_detail3_idx].pmdt024) THEN
                  IF g_detail3_d[g_detail3_idx].pmdt024 <> g_detail3_d_o.pmdt024 OR cl_null(g_detail3_d_o.pmdt024) THEN
                     IF NOT cl_ap_chk_range(g_detail3_d[g_detail3_idx].pmdt024,"0.000","0","","","azz-00079",1) THEN
                        LET g_detail3_d[g_detail3_idx].pmdt024 = g_detail3_d_o.pmdt024
                        NEXT FIELD CURRENT
                     END IF
                     CALL apmp110_get_price()
                  END IF
               END IF
               LET g_detail3_d_o.pmdt024 = g_detail3_d[g_detail3_idx].pmdt024

            AFTER FIELD pmdt036
               IF NOT cl_null(g_detail3_d[g_detail3_idx].pmdt036) THEN
                  IF g_detail3_d[g_detail3_idx].pmdt036 <> g_detail3_d_o.pmdt036 OR cl_null(g_detail3_d_o.pmdt036) THEN
                     IF NOT cl_ap_chk_range(g_detail3_d[g_detail3_idx].pmdt036,"0.000","0","","","azz-00079",1) THEN
                        LET g_detail3_d[g_detail3_idx].pmdt036 = g_detail3_d_o.pmdt036
                        NEXT FIELD CURRENT
                     END IF
                     IF NOT cl_null(g_detail2_d[g_detail2_idx].pmds039) AND
                        NOT cl_null(g_detail3_d[g_detail3_idx].pmdt042) AND
                        NOT cl_null(g_detail2_d[g_detail2_idx].pmds037) AND
                        NOT cl_null(g_detail3_d[g_detail3_idx].pmdt006) AND
                        NOT cl_null(g_detail3_d[g_detail3_idx].pmdt007) AND
                        NOT cl_null(g_detail3_d[g_detail3_idx].pmdt019) THEN
                        CALL s_purchase_price_check(g_detail2_d[g_detail2_idx].pmds039,g_detail3_d[g_detail3_idx].pmdt036,
                                                    g_detail3_d_o.pmdt036,g_detail3_d[g_detail3_idx].pmdt042,
                                                    g_detail2_d[g_detail2_idx].pmds037,g_detail3_d[g_detail3_idx].pmdt006,
                                                    g_detail3_d[g_detail3_idx].pmdt007,g_detail3_d[g_detail3_idx].pmdt019)
                             RETURNING l_success,g_errno
                        IF NOT l_success THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = '' 
                           LET g_errparam.code   = g_errno
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()
                           LET g_detail3_d[g_detail3_idx].pmdt036 = g_detail3_d_o.pmdt036
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                     IF NOT cl_null(g_detail3_d[g_detail3_idx].pmdt046) AND
                        NOT cl_null(g_detail3_d[g_detail3_idx].pmdt020) AND
                        NOT cl_null(g_detail2_d[g_detail2_idx].pmds037) AND
                        NOT cl_null(g_detail2_d[g_detail2_idx].pmds038) THEN
                        CALL s_tax_count(g_site,g_detail3_d[g_detail3_idx].pmdt046,
                                         g_detail3_d[g_detail3_idx].pmdt020*g_detail3_d[g_detail3_idx].pmdt036,
                                         g_detail3_d[g_detail3_idx].pmdt020,g_detail2_d[g_detail2_idx].pmds037,
                                         g_detail2_d[g_detail2_idx].pmds038)
                             RETURNING g_detail3_d[g_detail3_idx].pmdt038,g_detail3_d[g_detail3_idx].pmdt047,
                                       g_detail3_d[g_detail3_idx].pmdt039,l_xrcd113,l_xrcd114,l_xrcd115
                     END IF
                  END IF
               END IF
               LET g_detail3_d_o.pmdt036 = g_detail3_d[g_detail3_idx].pmdt036

            ON ACTION controlp INFIELD pmdt046  #倉退單別
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_detail3_d[g_detail3_idx].pmdt046
               CALL q_oodb002_2()
               LET g_detail3_d[g_detail3_idx].pmdt046 = g_qryparam.return1
               DISPLAY g_detail3_d[g_detail3_idx].pmdt046 TO pmdt046
               NEXT FIELD pmdt046

            ON ROW CHANGE
               IF INT_FLAG THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = '' 
                  LET g_errparam.code   = 9001 
                  LET g_errparam.popup  = FALSE 
                  CALL cl_err()
                  LET INT_FLAG = 0
                  EXIT DIALOG 
               END IF
               INITIALIZE g_errparam TO NULL 
               UPDATE apmp110_tmp2 SET pmdt022 = g_detail3_d[g_detail3_idx].pmdt022,
                                       pmdt046 = g_detail3_d[g_detail3_idx].pmdt046,
                                       pmdt037 = g_detail3_d[g_detail3_idx].pmdt037,
                                       pmdt024 = g_detail3_d[g_detail3_idx].pmdt024,
                                       pmdt036 = g_detail3_d[g_detail3_idx].pmdt036,
                                       pmdt038 = g_detail3_d[g_detail3_idx].pmdt038,
                                       pmdt039 = g_detail3_d[g_detail3_idx].pmdt039,
                                       pmdt047 = g_detail3_d[g_detail3_idx].pmdt047,
                                       pmdt042 = g_detail3_d[g_detail3_idx].pmdt042,
                                       pmdt043 = g_detail3_d[g_detail3_idx].pmdt043,
                                       pmdt044 = g_detail3_d[g_detail3_idx].pmdt044
                WHERE pmdt006 = g_detail3_d[g_detail3_idx].pmdt006
                  AND pmdt007 = g_detail3_d[g_detail3_idx].pmdt007
                  AND pmdt063 = g_detail3_d[g_detail3_idx].pmdt063
                  AND pmdt016 = g_detail3_d[g_detail3_idx].pmdt016
                  AND pmdt017 = g_detail3_d[g_detail3_idx].pmdt017
                  AND pmdt018 = g_detail3_d[g_detail3_idx].pmdt018
                  AND pmdt019 = g_detail3_d[g_detail3_idx].pmdt019
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_errparam.code   = "std-00009" 
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_errparam.code   = SQLCA.sqlcode 
                  OTHERWISE EXIT CASE
               END CASE
               IF NOT cl_null(g_errparam.code) THEN
                  LET g_errparam.extend = "axmp501_tmp" 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               END IF
               
            AFTER INPUT

         END INPUT
]]>
  </point>
  <point name="ui_dialog.onaction_sel" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[            #ming 20150616 add ---------------------------(S)             
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  #還沒有被寫入temp table的才能處理，否則會有資料重覆寫入的問題 
                  IF g_detail_d[li_idx].sel2 = 'N' THEN
                     LET g_detail_d[li_idx].sel2 = 'Y'

                     INSERT INTO apmp110_tmp3
                            VALUES(g_detail_d[g_master_idx].inaj015,g_detail_d[g_master_idx].inaj022,
                                   g_detail_d[g_master_idx].inaj001,g_detail_d[g_master_idx].inaj002,
                                   g_detail_d[g_master_idx].inaj003,g_detail_d[g_master_idx].inaj005,
                                   g_detail_d[g_master_idx].inaj006,g_detail_d[g_master_idx].pmds007,
                                   g_detail_d[g_master_idx].inaj011,g_detail_d[g_master_idx].inaj012,
                                   g_detail_d[g_master_idx].inaj008,g_detail_d[g_master_idx].inaj009,
                                   g_detail_d[g_master_idx].inaj010)

                     LET l_cnt = ''
                     SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp2
                      WHERE pmdt006 = g_detail_d[li_idx].inaj005
                        AND pmdt007 = g_detail_d[li_idx].inaj006
                        AND pmdt063 = g_detail_d[li_idx].pmds007
                        AND pmdt016 = g_detail_d[li_idx].inaj008
                        AND pmdt017 = g_detail_d[li_idx].inaj009
                        AND pmdt018 = g_detail_d[li_idx].inaj010
                        AND pmdt019 = g_detail_d[li_idx].inaj012
                     IF cl_null(l_cnt) OR l_cnt = 0 THEN
                        #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
                        INITIALIZE l_pmds.* TO NULL
                        LET l_dept = cl_get_sitename(g_detail_d[li_idx].pmds007) 
                        CALL s_control_get_group('4',g_detail_d[li_idx].pmds007,l_dept)
                             RETURNING l_success,l_controlno
                        IF l_success AND NOT cl_null(l_controlno) THEN
                           SELECT pmal003,pmal004,pmal006,pmal008,pmal020,pmal021,pmal023,pmal024
                             INTO l_pmds.pmds037,l_pmds.pmds033,l_pmds.pmds031,l_pmds.pmds012,
                                  l_pmds.pmds032,l_pmds.pmds039,l_pmds.pmds048,l_pmds.pmds049
                             FROM pmal_t
                            WHERE pmalent = g_enterprise
                              AND pmal001 = g_detail_d[li_idx].pmds007
                              AND pmal002 = l_controlno
                              AND pmalstus = 'Y'
                        ELSE
                           SELECT pmab033,pmab034,pmab037,pmab038,pmab053,pmab054,pmab057,pmab058
                             INTO l_pmds.pmds037,l_pmds.pmds033,l_pmds.pmds031,l_pmds.pmds012,
                                  l_pmds.pmds032,l_pmds.pmds039,l_pmds.pmds048,l_pmds.pmds049
                             FROM pmab_t
                            WHERE pmabent = g_enterprise
                              AND pmabsite = g_site
                              AND pmab001 = g_detail_d[li_idx].pmds007
                        END IF
                        #稅率、含稅否 
                        IF NOT cl_null(l_pmds.pmds033) THEN
                           CALL s_tax_chk(g_site,l_pmds.pmds033)
                                RETURNING l_success,l_oodbl004,l_pmds.pmds035,l_pmds.pmds034,l_oodb011
                           IF l_oodb011 = '1' THEN     #正常稅率  
                              LET l_imaf017 = l_pmds.pmds033
                              LET l_oodb005 = l_pmds.pmds035 
                              LET l_oodb006 = l_pmds.pmds034
                           ELSE                        #依料件設定  
                              LET l_imaf017 = ''
                              SELECT imaf017 INTO l_imaf017
                                FROM imaf_t
                               WHERE imafent  = g_enterprise
                                 AND imafsite = g_site
                                 AND imaf001 = g_detail_d[li_idx].inaj005
                              IF NOT cl_null(l_imaf017) THEN
                                 CALL s_tax_chk(g_site,l_imaf017)
                                      RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                              END IF
                           END IF
                        END IF

                        #項次 
                        SELECT MAX(pmdtseq) + 1 INTO l_cnt
                          FROM apmp110_tmp2
                         WHERE pmdt063 = g_detail_d[li_idx].pmds007
                        IF cl_null(l_cnt) THEN
                           LET l_cnt = 1
                        END IF

                        #入庫/倉退明細 
                        INSERT INTO apmp110_tmp2 VALUES(l_cnt,g_detail_d[li_idx].inaj005,
                             g_detail_d[li_idx].inaj006,g_detail_d[li_idx].pmds007,
                             g_detail_d[li_idx].inaj012,'0','','0',
                             g_detail_d[li_idx].inaj008,g_detail_d[li_idx].inaj009,
                             g_detail_d[li_idx].inaj010,l_imaf017,l_oodb006, 
                             '','0','0','0','0','0','','','')
                        LET l_cnt = ''
                        SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp1
                         WHERE pmds007 = g_detail_d[li_idx].pmds007
                        IF cl_null(l_cnt) OR l_cnt = 0 THEN
                           #匯率 
                           CALL apmp110_get_exrate(l_pmds.pmds037,l_pmds.pmds048)
                                RETURNING l_pmds.pmds038
                           #入庫/倉退單據 
                           INSERT INTO apmp110_tmp1(pmds007,pmds031,pmds032,pmds033,pmds034,pmds035,
                                                    pmds037,pmds038,pmds039,pmds048,pmds049,pmds012)
                                             VALUES(g_detail_d[g_master_idx].pmds007,l_pmds.pmds031,
                                                    l_pmds.pmds032,l_pmds.pmds033,l_pmds.pmds034,l_pmds.pmds035,
                                                    l_pmds.pmds037,l_pmds.pmds038,l_pmds.pmds039,l_pmds.pmds048,
                                                    l_pmds.pmds049,l_pmds.pmds012)
                        END IF
                     END IF
                     CALL apmp110_count()
                  END IF
               END IF
            END FOR

            CALL apmp110_fetch()
            CALL apmp110_get_price()
            #ming 20150616 add ---------------------------(E)   
            ]]>
  </point>
  <point name="ui_dialog.onaction_selall" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[            #ming 20150616 add ------------------(S)  
            CALL apmp110_fetch()
            CALL apmp110_get_price()
            #ming 20150616 add ------------------(E)  ]]>
  </point>
  <point name="ui_dialog.onaction_selnone" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[            #ming 20150616 add ------------------------------(S)  
            #重新顯示下方的資訊 
            CALL apmp110_fetch()
            CALL apmp110_get_price()
            #ming 20150616 add ------------------------------(E)  ]]>
  </point>
  <point name="ui_dialog.onaction_unsel" order="" ver="2" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[            #ming 20150616 add ----------------------------(S)  
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  #如果是已經被寫入temp table的，才花時間、效能去處理 
                  IF g_detail_d[li_idx].sel2 = 'Y' THEN
                     LET g_detail_d[li_idx].sel2 = 'N'

                     #結算資料清單 
                     DELETE FROM apmp110_tmp3
                      WHERE inaj001 = g_detail_d[li_idx].inaj001     #單據編號  
                        AND inaj002 = g_detail_d[li_idx].inaj002     #項次  
                        AND inaj003 = g_detail_d[li_idx].inaj003     #項序  
                        AND inaj001 = g_detail_d[li_idx].inaj011     #交易數量  

                     LET l_cnt = ''
                     SELECT COUNT(*) INTO l_cnt FROM apmp110_tmp
                      WHERE inaj005 = g_detail_d[li_idx].inaj005     #料件編號  
                        AND inaj006 = g_detail_d[li_idx].inaj006     #產品特徵  
                        AND inaj007 = g_detail_d[li_idx].pmds007     #庫存管理特徵  
                        AND inaj008 = g_detail_d[li_idx].inaj008     #庫位編號   
                        AND inaj009 = g_detail_d[li_idx].inaj009     #儲位編號  
                        AND inaj010 = g_detail_d[li_idx].inaj010     #批號  
                        AND inaj012 = g_detail_d[li_idx].inaj012     #交易單位  
                     IF cl_null(l_cnt) OR l_cnt = 0 THEN
                        #如果在apmp110_tmp3已無資料的話，就應該把apmp110_tmp2的項目移除 
                        #入庫/倉退明細 
                        DELETE FROM apmp110_tmp2
                         WHERE pmdt006 = g_detail_d[li_idx].inaj005
                           AND pmdt007 = g_detail_d[li_idx].inaj006 
                           AND pmdt063 = g_detail_d[li_idx].pmds007
                           AND pmdt016 = g_detail_d[li_idx].inaj008
                           AND pmdt017 = g_detail_d[li_idx].inaj009
                           AND pmdt018 = g_detail_d[li_idx].inaj010
                           AND pmdt019 = g_detail_d[li_idx].inaj012

                        SELECT COUNT(*) INTO l_cnt
                          FROM apmp110_tmp2
                         WHERE pmdt063 = g_detail_d[li_idx].pmds007
                        IF cl_null(l_cnt) OR l_cnt = 0 THEN
                           #入庫/倉退單據 
                           DELETE FROM apmp110_tmp1
                            WHERE pmds007 = g_detail_d[li_idx].pmds007
                        ELSE
                           CALL apmp110_count()
                        END IF
                     ELSE
                        CALL apmp110_count()
                     END IF
                  END IF
               END IF
            END FOR

            CALL apmp110_fetch()
            CALL apmp110_get_price()
            #ming 20150616 add ----------------------------(E)  ]]>
  </point>
  <section id="apmp110.b_fill" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION apmp110_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   {<point name="b_fill.define" edit="s"/>}
   #end add-point
   #add-point:b_fill段define
   {<point name="b_fill.define_customerization" edit="c"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
 
   PREPARE apmp110_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR apmp110_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   {<point name="b_fill.clear"/>}
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   {<point name="b_fill.foreach_into"/>}
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      {<point name="b_fill.foreach_iside"/>}
      #end add-point
      
      CALL apmp110_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.other_table"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE apmp110_sel
   
   LET l_ac = 1
   CALL apmp110_fetch()
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.after_b_fill"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="apmp110.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:2,PR版次:2) Build-000060
#+ 
#+ Filename...: apmp110
#+ Description: VMI結算作業
#+ Creator....: 04441(2014-08-15 16:26:41)
#+ Modifier...: 03079(2015-06-17 09:14:44) -SD/PR-
]]>
  </section>
  <section id="apmp110.detail_show" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION apmp110_detail_show()
   #add-point:show段define
   {<point name="detail_show.define" edit="s"/>}
   #end add-point
   #add-point:show段define
   {<point name="detail_show.define_customerization" edit="c"/>}
   #end add-point
   
   #add-point:detail_show段
   {<point name="detail_show.detail_show"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="apmp110.fetch" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION apmp110_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   {<point name="fetch.define" edit="s"/>}
   #end add-point
   #add-point:fetch段define
   {<point name="fetch.define_customerization" edit="c"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="apmp110.filter" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION apmp110_filter()
   #add-point:filter段define
   {<point name="filter.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter.define_customerization" edit="c"/>}
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   {<point name="filter.detail_cnt"/>}
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL apmp110_b_fill()
   
END FUNCTION
]]>
  </section>
  <section id="apmp110.filter_parser" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter欄位解析
PRIVATE FUNCTION apmp110_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   {<point name="filter_parser.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter_parser.define_customerization" edit="c"/>}
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
  </section>
  <section id="apmp110.filter_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION apmp110_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = apmp110_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
  </section>
  <section id="apmp110.global" ver="5" status="" src="s" readonly="">
    <![CDATA[#應用 p02 樣板自動產生(Version:13)
{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#{<point name="global.inc" />}
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="apmp110.init" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION apmp110_init()
   #add-point:init段define
   {<point name="init.define" edit="s"/>}
   #end add-point   
   #add-point:init段define
   {<point name="init.define_customerization" edit="c"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="apmp110.main" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   {<point name="main.define" edit="s"/>}
   #end add-point   
   #add-point:main段define
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("apm","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apmp110 WITH FORM cl_ap_formpath("apm",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apmp110_init()   
 
      #進入選單 Menu (="N")
      CALL apmp110_ui_dialog() 
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_apmp110
   END IF 
   
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
  </section>
  <section id="apmp110.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="apmp110.query" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION apmp110_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   {<point name="query.define" edit="s" />}
   #end add-point 
   #add-point:query段define
   {<point name="query.define_customerization" edit="c" />}
   #end add-point 
    
   #add-point:cs段after_construct
   {<point name="query.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL apmp110_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   {<point name="query.cs段after_query" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="apmp110.ui_dialog" ver="4" status="" src="s" readonly="">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION apmp110_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define" edit="s"/>}
   #end add-point 
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define_customerization" edit="c"/>}
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL apmp110_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.selall.befroe"/>}
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               {<point name="ui_dialog.for.onaction_selall"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               {<point name="ui_dialog.for.onaction_selnone"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL apmp110_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            {<point name="ui_dialog.before_accept"/>}
            #end add-point
            CALL apmp110_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            {<point name="ui_dialog.datarefresh"/>}
            #end add-point
            CALL apmp110_b_fill()
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
  </section>
</add_points>
