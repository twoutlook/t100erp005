#該程式未解開Section, 採用最新樣板產出!
{<section id="apmt500.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0079(2017-02-16 16:28:39), PR版次:0079(2017-03-17 16:57:16)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000777
#+ Filename...: apmt500
#+ Description: 採購單維護作業
#+ Creator....: 02294(2013-12-23 11:23:25)
#+ Modifier...: 02294 -SD/PR- TOPSTD
 
{</section>}
 
{<section id="apmt500.global" >}
#應用 t01 樣板自動產生(Version:79)
#add-point:填寫註解說明 name="global.memo" 
#151224-00025#3   2015/12/24  By fionchen  產品特徵欄位若無開窗輸入反而自行手動輸入時,則無法新增至inam_t
#151210-00009#1   2015/12/30  By earl      多角流水號一致時，開窗、校驗調整
#160104-00017#1...2016/01/08  By ming      1.vmi採購時，單頭修改供應商，需更新單身的庫存管理特徵 
#                                          2.單身的庫位須為VMI倉，否則清空 
#                                          3.非vmi採購時，清空單身的庫存管理特徵 
#160125-00011#1   2016/01/25  By lixiang   改用s_control_get_supplier_sql取厂商分类与厂商的并集。
#160127-00022#1   2016/02/01  By lixiang   修改单价超过容差率时，设置警告，要弹出提示框提示
#160112-00012#1   2016/02/02  By lixiang   新增单据时，【多角性质】不应该给8，应该预设为1
#160222-00020#1   2016/02/24  By lixiang   #若是料件未設置預設前置時間，則抓取aoo020上設置的資料
#160222-00018#1   2016/03/03  By lixiang   修正採購單發送mail 異常的問題
#160225-00021#1   2016/03/14  By lixiang   單據複製時，單頭的物流結案、帳流結案、金流結案預設為N，多交期明細單身的倉退量欄位預設為0
#151208-00004#2   2016/03/14  By lixiang   稅別依料件設置時，改調用s_tax_by_item元件
#160112-00016#1   2016/03/15  By lixiang   來源工單單號檢核時，從製程檔抓取資料判斷
#160316-00006#1   2016/03/16  By lixiang   回寫工單的委外加工量時，需加上作業編號、作業序條件
#160314-00009#4   2016/03/16  By zhujing   各程式增加产品特征是否需要自动开窗的程式段处理
#160204-00006#1   2016/03/21  By Polly     當稅別應用為1正常稅率時，當改單頭稅別時，不需詢問是否要改單身稅別，直接變更，確保單頭單身稅別一致；
#160321-00037#1   2016/03/22  By lixiang   請采勾稽時，修改關聯單據明細頁簽的需求數量欄位同步更新採購數量，詢問後更新，並彈出多交期窗口供維護
#160318-00025#15  2016/04/05  BY 07900     重复错误讯息的修改
#160411-00013#1   2016/04/14  By Ann_Huang 1.料號pmdn001開窗時維護控制組資料s_control_get_item_sql參數改為4.採購控制組
#                                          2.料號pmdn001欄位控卡,需檢核存在料號控制組所設定的產品範圍內產品分類之料號 (s_control_chk_group)
#151217-00014#1   2016/04/14  By Charles4m 檢查供應商是否存在apmm202(供應商據點資料)中
#160418-00004#1   2016/04/20  By catmoon   將供應商編號(pmdl004)由一次性交易對象改為其他類型時，需將一次性交易對象識別碼(pmdl028)清空
#160602-00002#1   2016/06/02  By lixiang   重复性生产委外采购功能完善
#160606-00013#1   2016/06/07  By lixiang   子件特性增加12.联产品、13.副产品/回收料
#160520-00026#2   2016/07/04  By dorislai  多期帳款維護頁簽: 1.預收款發票開立方式="1.不開發票"時
#                                                           1-1. 帳款類型= '2.訂金'，則未稅金額與含稅金額直接相同  如:未稅金額輸入100，則含稅金額也為100，不需計算稅額
#                                                           1-2. 帳款類型<>'2.訂金'，需計算未稅金額or含稅金額      如:未稅金額輸入100，稅額5%，含稅金額為105
#                                                           2.移動原本控卡:整張單含稅金額/未稅金額 = 訂單總含稅金額/訂單總未稅金額，一定要完全相同
#                                                             移至DIALOG後，不管按"確認"或"取消"，都要卡住
#160510-00043#2   2016/07/25  By 02097     T類作業在browser_fill()組SQL前,呼叫s_aooi200_filter_slip將回傳條件組進去g_wc中
#160728-00008#1   2016/07/29  By lixiang   审核段出错时，资料会被锁住没有及时释放出来
#160725-00019#1   2016/08/03  By lixiang   单身维护三个项次，第三个项次如果料件是产品特征的话，自动弹窗，且项次3的料件名称会显示到项次1的名称上去
#160801-00028#1   2016/08/04  By lixiang   手动输入来源单号请购单，若请购单有维护对应的税种、币种资料，则带出请购单的设定值
#160804-00055#1   2016/08/05  By lixiang   新增修改，保存后都要停留在当前页签
#160804-00022#1   2016/08/05  By lixiang   根据供应商带出运送方式时，说明同步带出
#160808-00043#1   2016/08/09  By dorislai  因有作單號過濾，asft300產生委外採購單時，在apmt501查不到asft300的單號，修正這個問題
#160815-00031#2   2016/08/16  By lixiang   料件類別為"E"的，卡備註要必輸 
#160816-00001#8   2016/08/19  By 08734     抓取理由碼改CALL sub
#160816-00068#15  2016/08/22  By earl      調整transaction
#160824-00014#1   2016/08/26  By lixiang   在画面进行一些操作后，会调到其他页签
#160719-00001#1   2016/08/26  By lixiang   供应商的一次交易对象或内部员工时，单头新增后，需更新pmak中的参考单号为单头完整单号
#160818-00017#27  2016/08/29  By lixiang   单据类作业修改，删除时需重新检查状态
#160831-00047#1   2016/08/29  By lixiang   單頭來源請購單相關欄位有維護的，從請購單帶入資料到對應欄位上
#160727-00025#9   2016/09/01  By lixiang   工單轉採購時，須檢核不可超過工單總應發數量
#160905-00007#11  2016/09/05  By 01727     调整系统中无ENT的SQL条件增加ent
#160907-00053#1   2016/09/09  By wuxja     防止数组最后莫名多出来空白行
#160905-00006#1   2016/09/12  By lixiang   根据关联单据页签的来源单号带出相关资料，并更新请购单的已转采购量；请采勾稽时，采购数量不可大于请购单的可采购数量
#160908-00014#1   2016/09/28  By lixiang   對應的特徵群組有 勾選'需求來源可以不指定產品特徵'時，可以不指定產品特徵
#160913-00009#1   2016/09/30  By ywtsai    調整若參數設定採購與請購勾稽，則整批產生完單身後，若為單張請購單轉採購，單頭資料來源類型與單號需更新來源資料
#160908-00010#1   2016/10/11  By lixiang   计算单据总金额以后，若与单身合计存在尾差，需将差额补在单身，并更新单身的数据，使得数据保持一致
#161012-00055#1   2016/10/18  By 02040     多期帳款維護頁簽，輸入第二筆時，能自動算出剩下金額
#161019-00017#3   2016/10/20  By lixh      据点组织开窗资料整批调整
#160920-00035#2   2016/10/24  By lixiang   請購單、採購單若是由APS轉入，在修改請/採購單時，要更新回APS的表
#161109-00015#1   2016/11/09  By zhujing   新增单号时，未根据单别进行检查单号是否重复。
#161107-00001#1   2016/11/11  By wuxja     来源单号为工单、订单时串查参数调整
#161114-00006#1   2016/11/14  By ouhz      调整维护一笔单身数据后点击确定提示apm-01011问题
#161114-00031#1   2016/11/14  By ouhz      调整若参数设定采购与请购勾稽，单头来源单号不为空，且整批产生单身时选择了多笔不同请购单，则清空单头来源单号
#161006-00018#7   2016/11/18  By lixiang   根据判断判断有来源单据有维护库储时，当前库储栏位是否可以维护
#160805-00071#1   2016/11/21  By lixiang   單頭"資料來源類型"、"來源單號"欄位處理調整
#161128-00011#1   2016/11/28  By lixiang   将apmt500中的function apmt500_adjust_pmdn搬到元件中
#161027-00035#1   2016/11/28  By Whitney   參數設定多角單據自動拋轉時，如拋轉未成功，彈出錯誤訊息，並將單據資料一併還原
#161212-00022#1   2016/12/13  By wuxja     应把s_tax_recount_tmp()创建临时表的放到事务外面，防止打破事务
#161124-00048#9   2016/12/19  By zhujing   .*整批调整
#161205-00025#2   2016/12/22  By lixiang   效能优化
#161207-00033#27  2016/12/22  By lixh      一次性交易對象顯示說明，所有的客戶/供應商欄位都應該處理
#161226-00035#1   2017/01/05  By Ann_Huang 修正採購單與請購單勾稽時,若遇到單位轉換,也需更新來源單據已轉採購量(pmdp049),否則ainq100請購數量會計算錯誤
#160824-00007#346 2017/01/09  By 06137     修正舊值備份寫法
#161221-00064##5  2017/01/10  By zhujing   增加pmao000(1-采购，2-销售),用于区分axmi120和apmi120数据显示
#170111-00065#1   2017/01/12  By Whitney   多帳期預付款金額檢核
#161031-00025#1   2017/01/16  By lixiang   1.將aooi360_01以嵌入的方式，用頁籤放在apmt500單頭多帳期頁籤與異動資訊頁籤中間
#                                            要可修改
#                                            控制類型 =3:內部資訊傳遞 取消不要了
#                                            項次固定寫入0
#                                          2.原apmt500的備註action，改為確認後可執行，直接修改單頭新的"備註"頁籤
#                                          3.apmt500單身最後面增加顯示"長備註"欄位，一樣抓取aooi360的備註顯示
#                                            項次 = 單身項次
#                                            控制類型 = 列印在後
#161213-00041#1   2017/01/19  By xujing    輸入預算細項後要再檢核可用預算額度 
#170113-00021#1   2017/01/20  By lixiang   以下規則將不在呼叫 s_tax_recount 此函式重新計算金額
#                                          1.單身有不同稅別時
#                                          2.稅別有運用公式時(aooi610 公式編號不為空)
#                                          3.sql条件中增加ent条件
#161031-00024#6   2017/01/25  By 06137     报表作业增加传入参数
#170207-00046#1   2017/02/09  By wuxja     AVL检查时项次应传入旧值，防止用户修改了项次
#170208-00026#1   2017/02/09  By wuxja     单据删除、作废、单身删除、修改时，工单委外对应料号是一般或者联产品时才会去回写制程档
#161031-00025#5   2017/02/16  By lixiang   1.單身備註也要提供開窗;2.有來源時，同原單身備註，依單別參數帶入來源單據長備註
#160711-00040#24  2017/02/20  By xujing   T類作業的單別開窗的where條件(找CALL q_ooba002_開頭的)增加如下程式段
#                                          CALL s_control_get_docno_sql(g_user,g_dept) RETURNING l_success,l_sql1
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"
IMPORT FGL aoo_aooi360_01   #161031-00025#1
#end add-point 
 
SCHEMA ds 
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔 name="global.inc"
GLOBALS "../../cfg/top_report.inc"               #T100report的環境變數
GLOBALS "../../cfg/top_schedule.inc"

#GLOBALS
#   DEFINE g_schedule_d DYNAMIC ARRAY OF RECORD
#           gzpe011      LIKE gzpe_t.gzpe011,
#           gzpe003      LIKE gzpe_t.gzpe003,
#           gzpe007      LIKE gzpe_t.gzpe007,
#           gzpe004      LIKE gzpe_t.gzpe004,
#           gzpe008      LIKE gzpe_t.gzpe008,
#           gzpe009      LIKE gzpe_t.gzpe009,
#           gzpe005      LIKE gzpe_t.gzpe005,
#           gzpe006      LIKE gzpe_t.gzpe006,
#           gzpe010      LIKE gzpe_t.gzpe010
#      END RECORD
#END GLOBALS

#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_pmdl_m        RECORD
       pmdldocno LIKE pmdl_t.pmdldocno, 
   pmdl001 LIKE pmdl_t.pmdl001, 
   pmdldocno_desc LIKE type_t.chr80, 
   pmdldocdt LIKE pmdl_t.pmdldocdt, 
   pmdl004 LIKE pmdl_t.pmdl004, 
   pmdl004_desc LIKE type_t.chr80, 
   pmdl002 LIKE pmdl_t.pmdl002, 
   pmdl002_desc LIKE type_t.chr80, 
   pmdl003 LIKE pmdl_t.pmdl003, 
   pmdl003_desc LIKE type_t.chr80, 
   pmdlsite LIKE pmdl_t.pmdlsite, 
   pmdlstus LIKE pmdl_t.pmdlstus, 
   pmdl005 LIKE pmdl_t.pmdl005, 
   pmdl006 LIKE pmdl_t.pmdl006, 
   pmdl007 LIKE pmdl_t.pmdl007, 
   pmdl008 LIKE pmdl_t.pmdl008, 
   pmdl027 LIKE pmdl_t.pmdl027, 
   pmdl027_desc LIKE type_t.chr80, 
   pmdl052 LIKE pmdl_t.pmdl052, 
   pmdl052_desc LIKE type_t.chr80, 
   pmdl053 LIKE pmdl_t.pmdl053, 
   pmdl009 LIKE pmdl_t.pmdl009, 
   pmdl009_desc LIKE type_t.chr80, 
   pmdl010 LIKE pmdl_t.pmdl010, 
   pmdl010_desc LIKE type_t.chr80, 
   pmdl011 LIKE pmdl_t.pmdl011, 
   pmdl011_desc LIKE type_t.chr80, 
   pmdl012 LIKE pmdl_t.pmdl012, 
   pmdl013 LIKE pmdl_t.pmdl013, 
   pmdl033 LIKE pmdl_t.pmdl033, 
   pmdl033_desc LIKE type_t.chr80, 
   pmdl015 LIKE pmdl_t.pmdl015, 
   pmdl015_desc LIKE type_t.chr80, 
   pmdl016 LIKE pmdl_t.pmdl016, 
   pmdl017 LIKE pmdl_t.pmdl017, 
   pmdl017_desc LIKE type_t.chr80, 
   pmdl018 LIKE pmdl_t.pmdl018, 
   pmdl018_desc LIKE type_t.chr80, 
   pmdl019 LIKE pmdl_t.pmdl019, 
   pmdl023 LIKE pmdl_t.pmdl023, 
   pmdl023_desc LIKE type_t.chr80, 
   pmdl043 LIKE pmdl_t.pmdl043, 
   pmdl043_desc LIKE type_t.chr80, 
   pmdl044 LIKE pmdl_t.pmdl044, 
   pmdl051 LIKE pmdl_t.pmdl051, 
   pmdl051_desc LIKE type_t.chr80, 
   pmdl020 LIKE pmdl_t.pmdl020, 
   pmdl020_desc LIKE type_t.chr80, 
   pmdl025 LIKE pmdl_t.pmdl025, 
   pmdl025_desc LIKE type_t.chr80, 
   oofb017 LIKE type_t.chr500, 
   pmdl026 LIKE pmdl_t.pmdl026, 
   pmdl026_desc LIKE type_t.chr80, 
   oofb017_1 LIKE type_t.chr500, 
   pmdl029 LIKE pmdl_t.pmdl029, 
   pmdl029_desc LIKE type_t.chr80, 
   pmdl021 LIKE pmdl_t.pmdl021, 
   pmdl021_desc LIKE type_t.chr80, 
   pmdl022 LIKE pmdl_t.pmdl022, 
   pmdl022_desc LIKE type_t.chr80, 
   pmdl032 LIKE pmdl_t.pmdl032, 
   pmdl032_desc LIKE type_t.chr80, 
   pmdl024 LIKE pmdl_t.pmdl024, 
   pmdl024_desc LIKE type_t.chr80, 
   pmdl054 LIKE pmdl_t.pmdl054, 
   pmdl055 LIKE pmdl_t.pmdl055, 
   pmdl030 LIKE pmdl_t.pmdl030, 
   pmdl031 LIKE pmdl_t.pmdl031, 
   pmdl028 LIKE pmdl_t.pmdl028, 
   pmdl042 LIKE pmdl_t.pmdl042, 
   pmdl047 LIKE pmdl_t.pmdl047, 
   pmdl048 LIKE pmdl_t.pmdl048, 
   pmdl049 LIKE pmdl_t.pmdl049, 
   pmdl208 LIKE pmdl_t.pmdl208, 
   pmdl046 LIKE pmdl_t.pmdl046, 
   fflabel_1 LIKE type_t.chr80, 
   pmdl040 LIKE pmdl_t.pmdl040, 
   fflabel_2 LIKE type_t.chr80, 
   pmdl041 LIKE pmdl_t.pmdl041, 
   pmdlownid LIKE pmdl_t.pmdlownid, 
   pmdlownid_desc LIKE type_t.chr80, 
   pmdlowndp LIKE pmdl_t.pmdlowndp, 
   pmdlowndp_desc LIKE type_t.chr80, 
   pmdlcrtid LIKE pmdl_t.pmdlcrtid, 
   pmdlcrtid_desc LIKE type_t.chr80, 
   pmdlcrtdp LIKE pmdl_t.pmdlcrtdp, 
   pmdlcrtdp_desc LIKE type_t.chr80, 
   pmdlcrtdt LIKE pmdl_t.pmdlcrtdt, 
   pmdlmodid LIKE pmdl_t.pmdlmodid, 
   pmdlmodid_desc LIKE type_t.chr80, 
   pmdlmoddt LIKE pmdl_t.pmdlmoddt, 
   pmdlcnfid LIKE pmdl_t.pmdlcnfid, 
   pmdlcnfid_desc LIKE type_t.chr80, 
   pmdlcnfdt LIKE pmdl_t.pmdlcnfdt
       END RECORD
 
#單身 type 宣告
PRIVATE TYPE type_g_pmdn_d        RECORD
       pmdnsite LIKE pmdn_t.pmdnsite, 
   pmdnseq LIKE pmdn_t.pmdnseq, 
   pmdn001 LIKE pmdn_t.pmdn001, 
   pmdn001_desc LIKE type_t.chr500, 
   imaal004 LIKE type_t.chr500, 
   pmdn002 LIKE pmdn_t.pmdn002, 
   pmdn002_desc LIKE type_t.chr500, 
   pmdn004 LIKE pmdn_t.pmdn004, 
   pmdn004_desc LIKE type_t.chr500, 
   pmdn005 LIKE pmdn_t.pmdn005, 
   pmdn006 LIKE pmdn_t.pmdn006, 
   pmdn006_desc LIKE type_t.chr500, 
   pmdn007 LIKE pmdn_t.pmdn007, 
   pmdn008 LIKE pmdn_t.pmdn008, 
   pmdn008_desc LIKE type_t.chr500, 
   pmdn009 LIKE pmdn_t.pmdn009, 
   pmdn024 LIKE pmdn_t.pmdn024, 
   pmdn012 LIKE pmdn_t.pmdn012, 
   pmdn013 LIKE pmdn_t.pmdn013, 
   pmdn014 LIKE pmdn_t.pmdn014, 
   pmdn045 LIKE pmdn_t.pmdn045, 
   pmdn010 LIKE pmdn_t.pmdn010, 
   pmdn010_desc LIKE type_t.chr500, 
   pmdn011 LIKE pmdn_t.pmdn011, 
   pmdn015 LIKE pmdn_t.pmdn015, 
   pmdn016 LIKE pmdn_t.pmdn016, 
   pmdn016_desc LIKE type_t.chr500, 
   pmdn017 LIKE pmdn_t.pmdn017, 
   pmdn046 LIKE pmdn_t.pmdn046, 
   pmdn047 LIKE pmdn_t.pmdn047, 
   pmdn048 LIKE pmdn_t.pmdn048, 
   pmdn023 LIKE pmdn_t.pmdn023, 
   pmdn023_desc LIKE type_t.chr500, 
   pmdn019 LIKE pmdn_t.pmdn019, 
   pmdn020 LIKE pmdn_t.pmdn020, 
   pmdn052 LIKE pmdn_t.pmdn052, 
   pmdn021 LIKE pmdn_t.pmdn021, 
   pmdn022 LIKE pmdn_t.pmdn022, 
   pmdnunit LIKE pmdn_t.pmdnunit, 
   pmdnunit_desc LIKE type_t.chr500, 
   pmdnorga LIKE pmdn_t.pmdnorga, 
   pmdnorga_desc LIKE type_t.chr500, 
   pmdn049 LIKE pmdn_t.pmdn049, 
   pmdn049_desc LIKE type_t.chr500, 
   pmdn051 LIKE pmdn_t.pmdn051, 
   pmdn051_desc LIKE type_t.chr500, 
   pmdn054 LIKE pmdn_t.pmdn054, 
   pmdn055 LIKE pmdn_t.pmdn055, 
   pmdn056 LIKE pmdn_t.pmdn056, 
   pmdn057 LIKE pmdn_t.pmdn057, 
   pmdn050 LIKE pmdn_t.pmdn050, 
   ooff013 LIKE type_t.chr500
       END RECORD
PRIVATE TYPE type_g_pmdn2_d RECORD
       pmdnseq LIKE pmdn_t.pmdnseq, 
   imaa001 LIKE type_t.chr500, 
   imaal003 LIKE imaal_t.imaal003, 
   imaal004 LIKE imaal_t.imaal004, 
   imaa005 LIKE imaa_t.imaa005, 
   imaa005_1_desc LIKE type_t.chr500, 
   pmdn027 LIKE pmdn_t.pmdn027, 
   l_pmao009 LIKE type_t.chr500, 
   l_pmao010 LIKE type_t.chr500, 
   pmdn028 LIKE pmdn_t.pmdn028, 
   pmdn028_desc LIKE type_t.chr500, 
   pmdn029 LIKE pmdn_t.pmdn029, 
   pmdn029_desc LIKE type_t.chr500, 
   pmdn030 LIKE pmdn_t.pmdn030, 
   pmdn053 LIKE pmdn_t.pmdn053, 
   pmdn025 LIKE pmdn_t.pmdn025, 
   pmdn025_desc LIKE type_t.chr500, 
   pmdn026 LIKE pmdn_t.pmdn026, 
   pmdn026_desc LIKE type_t.chr500, 
   pmdn031 LIKE pmdn_t.pmdn031, 
   pmdn031_desc LIKE type_t.chr500, 
   pmdn032 LIKE pmdn_t.pmdn032, 
   pmdn033 LIKE pmdn_t.pmdn033, 
   pmdn003 LIKE pmdn_t.pmdn003, 
   pmdn003_desc LIKE type_t.chr500, 
   pmdn036 LIKE pmdn_t.pmdn036, 
   pmdn036_desc LIKE type_t.chr500, 
   pmdn037 LIKE pmdn_t.pmdn037, 
   pmdn037_desc LIKE type_t.chr500, 
   pmdn038 LIKE pmdn_t.pmdn038, 
   pmdn038_desc LIKE type_t.chr500, 
   pmdn058 LIKE pmdn_t.pmdn058, 
   pmdn058_desc LIKE type_t.chr500, 
   pmdn039 LIKE pmdn_t.pmdn039, 
   pmdn035 LIKE pmdn_t.pmdn035, 
   pmdn040 LIKE pmdn_t.pmdn040, 
   pmdn041 LIKE pmdn_t.pmdn041, 
   pmdn042 LIKE pmdn_t.pmdn042, 
   pmdn043 LIKE pmdn_t.pmdn043, 
   pmdn044 LIKE pmdn_t.pmdn044
       END RECORD
PRIVATE TYPE type_g_pmdn3_d RECORD
       pmdosite LIKE pmdo_t.pmdosite, 
   pmdoseq LIKE pmdo_t.pmdoseq, 
   pmdoseq1 LIKE pmdo_t.pmdoseq1, 
   pmdo003 LIKE pmdo_t.pmdo003, 
   pmdo001 LIKE pmdo_t.pmdo001, 
   pmdo001_desc LIKE type_t.chr500, 
   imaal004 LIKE imaal_t.imaal004, 
   pmdo002 LIKE pmdo_t.pmdo002, 
   pmdo004 LIKE pmdo_t.pmdo004, 
   pmdo004_desc LIKE type_t.chr500, 
   pmdo005 LIKE pmdo_t.pmdo005, 
   pmdoseq2 LIKE pmdo_t.pmdoseq2, 
   pmdo006 LIKE pmdo_t.pmdo006, 
   pmdo028 LIKE pmdo_t.pmdo028, 
   pmdo028_desc LIKE type_t.chr500, 
   pmdo029 LIKE pmdo_t.pmdo029, 
   pmdo011 LIKE pmdo_t.pmdo011, 
   pmdo012 LIKE pmdo_t.pmdo012, 
   pmdo013 LIKE pmdo_t.pmdo013, 
   pmdo010 LIKE pmdo_t.pmdo010, 
   pmdo010_desc LIKE type_t.chr500, 
   pmdo014 LIKE pmdo_t.pmdo014, 
   pmdo009 LIKE pmdo_t.pmdo009, 
   pmdo015 LIKE pmdo_t.pmdo015, 
   pmdo016 LIKE pmdo_t.pmdo016, 
   pmdo017 LIKE pmdo_t.pmdo017, 
   pmdo040 LIKE pmdo_t.pmdo040, 
   pmdo019 LIKE pmdo_t.pmdo019, 
   pmdo020 LIKE pmdo_t.pmdo020, 
   pmdo021 LIKE pmdo_t.pmdo021, 
   pmdo030 LIKE pmdo_t.pmdo030, 
   pmdo030_desc LIKE type_t.chr500, 
   pmdo031 LIKE pmdo_t.pmdo031, 
   pmdo022 LIKE pmdo_t.pmdo022, 
   pmdo023 LIKE pmdo_t.pmdo023, 
   pmdo023_desc LIKE type_t.chr500, 
   pmdo024 LIKE pmdo_t.pmdo024, 
   pmdo032 LIKE pmdo_t.pmdo032, 
   pmdo033 LIKE pmdo_t.pmdo033, 
   pmdo034 LIKE pmdo_t.pmdo034, 
   pmdo025 LIKE pmdo_t.pmdo025, 
   pmdo026 LIKE pmdo_t.pmdo026, 
   pmdo026_desc LIKE type_t.chr500, 
   pmdo027 LIKE pmdo_t.pmdo027, 
   pmdo041 LIKE pmdo_t.pmdo041, 
   pmdo042 LIKE pmdo_t.pmdo042, 
   pmdo043 LIKE pmdo_t.pmdo043, 
   pmdo044 LIKE pmdo_t.pmdo044
       END RECORD
PRIVATE TYPE type_g_pmdn4_d RECORD
       pmdpsite LIKE pmdp_t.pmdpsite, 
   pmdpseq LIKE pmdp_t.pmdpseq, 
   pmdpseq1 LIKE pmdp_t.pmdpseq1, 
   pmdp001 LIKE pmdp_t.pmdp001, 
   pmdp001_desc LIKE type_t.chr500, 
   imaal004 LIKE imaal_t.imaal004, 
   pmdp002 LIKE pmdp_t.pmdp002, 
   pmdp003 LIKE pmdp_t.pmdp003, 
   pmdp004 LIKE pmdp_t.pmdp004, 
   pmdp005 LIKE pmdp_t.pmdp005, 
   pmdp006 LIKE pmdp_t.pmdp006, 
   pmdp007 LIKE pmdp_t.pmdp007, 
   pmdp008 LIKE pmdp_t.pmdp008, 
   pmdp009 LIKE pmdp_t.pmdp009, 
   pmdp010 LIKE pmdp_t.pmdp010, 
   pmdp011 LIKE pmdp_t.pmdp011, 
   pmdp012 LIKE pmdp_t.pmdp012, 
   pmdp021 LIKE pmdp_t.pmdp021, 
   pmdp022 LIKE pmdp_t.pmdp022, 
   pmdp022_desc LIKE type_t.chr500, 
   pmdp023 LIKE pmdp_t.pmdp023, 
   pmdp024 LIKE pmdp_t.pmdp024, 
   pmdp025 LIKE pmdp_t.pmdp025, 
   pmdp026 LIKE pmdp_t.pmdp026
       END RECORD
PRIVATE TYPE type_g_pmdn6_d RECORD
       pmdmsite LIKE pmdm_t.pmdmsite, 
   pmdm001 LIKE pmdm_t.pmdm001, 
   pmdm014 LIKE pmdm_t.pmdm014, 
   pmdm002 LIKE pmdm_t.pmdm002, 
   pmdm002_desc LIKE type_t.chr500, 
   pmdm003 LIKE pmdm_t.pmdm003, 
   pmdm004 LIKE pmdm_t.pmdm004, 
   pmdm005 LIKE pmdm_t.pmdm005, 
   pmdm006 LIKE pmdm_t.pmdm006, 
   pmdm007 LIKE pmdm_t.pmdm007, 
   pmdm008 LIKE pmdm_t.pmdm008, 
   pmdm009 LIKE pmdm_t.pmdm009
       END RECORD
 
 
PRIVATE TYPE type_browser RECORD
         b_statepic     LIKE type_t.chr50,
            b_pmdldocno LIKE pmdl_t.pmdldocno,
      b_pmdldocdt LIKE pmdl_t.pmdldocdt,
      b_pmdl001 LIKE pmdl_t.pmdl001,
      b_pmdl002 LIKE pmdl_t.pmdl002,
   b_pmdl002_desc LIKE type_t.chr80,
      b_pmdl003 LIKE pmdl_t.pmdl003,
   b_pmdl003_desc LIKE type_t.chr80,
      b_pmdl004 LIKE pmdl_t.pmdl004,
   b_pmdl004_desc LIKE type_t.chr80
       END RECORD
       
#add-point:自定義模組變數(Module Variable) (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="global.variable"
DEFINE g_flag         LIKE type_t.num5
DEFINE g_flag1        LIKE type_t.num5
DEFINE g_flag2        LIKE type_t.num5
DEFINE g_oofa001      LIKE oofa_t.oofa001
DEFINE g_acc          LIKE gzcb_t.gzcb007
DEFINE g_bgjob        LIKE type_t.chr1
DEFINE g_ooef019      LIKE ooef_t.ooef019
DEFINE g_type         LIKE type_t.chr1
DEFINE g_pmab039      LIKE pmab_t.pmab039  
DEFINE g_tax_app      LIKE oodb_t.oodb011      #取得稅別類型1:正常稅率2:依料件設定
DEFINE g_pmam003      LIKE pmam_t.pmam003      #價格是否允許修改
DEFINE g_pmam006      LIKE pmam_t.pmam006      #允許價格為0
DEFINE g_pmam002      LIKE pmam_t.pmam002      #未取到價格可以人工輸入
DEFINE g_field        STRING
DEFINE g_controlno    LIKE ooha_t.ooha001
DEFINE g_pmao_flag    LIKE type_t.chr1         #INSERT pmao_t flag
DEFINE g_aic_doc      LIKE type_t.num5    #151210-00009#1  2015/12/30 By earl add
DEFINE g_slip_wc         STRING     #160510-00043#2

#161031-00025#1---s
GLOBALS
TYPE type_g_ooff_d        RECORD
       ooff001 LIKE ooff_t.ooff001, 
   ooff002 LIKE ooff_t.ooff002, 
   ooff004 LIKE ooff_t.ooff004, 
   ooff005 LIKE ooff_t.ooff005, 
   ooff006 LIKE ooff_t.ooff006, 
   ooff007 LIKE ooff_t.ooff007, 
   ooff008 LIKE ooff_t.ooff008, 
   ooff009 LIKE ooff_t.ooff009, 
   ooff010 LIKE ooff_t.ooff010, 
   ooff011 LIKE ooff_t.ooff011, 
   ooff003 LIKE ooff_t.ooff003, 
   ooff012 LIKE ooff_t.ooff012, 
   ooff013 LIKE ooff_t.ooff013, 
   ooff014 LIKE ooff_t.ooff014
       END RECORD
 
DEFINE g_ooff_d4          DYNAMIC ARRAY OF type_g_ooff_d

DEFINE g_detail_insert   LIKE type_t.num5   #單身的新增權限
DEFINE g_detail_delete   LIKE type_t.num5   #單身的刪除權限
DEFINE g_wc2_i36001      STRING             #备注单身QBE條件
DEFINE g_d_idx_i36001    LIKE type_t.num5   #备注单身所在筆數
DEFINE g_d_cnt_i36001    LIKE type_t.num5   #备注单身總筆數
DEFINE g_appoint_idx     LIKE type_t.num5   #指定進入單身行數
DEFINE g_ooff001_d       LIKE ooff_t.ooff001
DEFINE g_ooff002_d       LIKE ooff_t.ooff002
DEFINE g_ooff003_d       LIKE ooff_t.ooff003
DEFINE g_ooff004_d       LIKE ooff_t.ooff004
DEFINE g_ooff005_d       LIKE ooff_t.ooff005
DEFINE g_ooff006_d       LIKE ooff_t.ooff006
DEFINE g_ooff007_d       LIKE ooff_t.ooff007
DEFINE g_ooff008_d       LIKE ooff_t.ooff008
DEFINE g_ooff009_d       LIKE ooff_t.ooff009
DEFINE g_ooff010_d       LIKE ooff_t.ooff010
DEFINE g_ooff011_d       LIKE ooff_t.ooff011
END GLOBALS
DEFINE g_detail_id          STRING           #紀錄停留在哪個Page
#161031-00025#1---e
#end add-point
       
#模組變數(Module Variables)
DEFINE g_pmdl_m          type_g_pmdl_m
DEFINE g_pmdl_m_t        type_g_pmdl_m
DEFINE g_pmdl_m_o        type_g_pmdl_m
DEFINE g_pmdl_m_mask_o   type_g_pmdl_m #轉換遮罩前資料
DEFINE g_pmdl_m_mask_n   type_g_pmdl_m #轉換遮罩後資料
 
   DEFINE g_pmdldocno_t LIKE pmdl_t.pmdldocno
 
 
DEFINE g_pmdn_d          DYNAMIC ARRAY OF type_g_pmdn_d
DEFINE g_pmdn_d_t        type_g_pmdn_d
DEFINE g_pmdn_d_o        type_g_pmdn_d
DEFINE g_pmdn_d_mask_o   DYNAMIC ARRAY OF type_g_pmdn_d #轉換遮罩前資料
DEFINE g_pmdn_d_mask_n   DYNAMIC ARRAY OF type_g_pmdn_d #轉換遮罩後資料
DEFINE g_pmdn2_d          DYNAMIC ARRAY OF type_g_pmdn2_d
DEFINE g_pmdn2_d_t        type_g_pmdn2_d
DEFINE g_pmdn2_d_o        type_g_pmdn2_d
DEFINE g_pmdn2_d_mask_o   DYNAMIC ARRAY OF type_g_pmdn2_d #轉換遮罩前資料
DEFINE g_pmdn2_d_mask_n   DYNAMIC ARRAY OF type_g_pmdn2_d #轉換遮罩後資料
DEFINE g_pmdn3_d          DYNAMIC ARRAY OF type_g_pmdn3_d
DEFINE g_pmdn3_d_t        type_g_pmdn3_d
DEFINE g_pmdn3_d_o        type_g_pmdn3_d
DEFINE g_pmdn3_d_mask_o   DYNAMIC ARRAY OF type_g_pmdn3_d #轉換遮罩前資料
DEFINE g_pmdn3_d_mask_n   DYNAMIC ARRAY OF type_g_pmdn3_d #轉換遮罩後資料
DEFINE g_pmdn4_d          DYNAMIC ARRAY OF type_g_pmdn4_d
DEFINE g_pmdn4_d_t        type_g_pmdn4_d
DEFINE g_pmdn4_d_o        type_g_pmdn4_d
DEFINE g_pmdn4_d_mask_o   DYNAMIC ARRAY OF type_g_pmdn4_d #轉換遮罩前資料
DEFINE g_pmdn4_d_mask_n   DYNAMIC ARRAY OF type_g_pmdn4_d #轉換遮罩後資料
DEFINE g_pmdn6_d          DYNAMIC ARRAY OF type_g_pmdn6_d
DEFINE g_pmdn6_d_t        type_g_pmdn6_d
DEFINE g_pmdn6_d_o        type_g_pmdn6_d
DEFINE g_pmdn6_d_mask_o   DYNAMIC ARRAY OF type_g_pmdn6_d #轉換遮罩前資料
DEFINE g_pmdn6_d_mask_n   DYNAMIC ARRAY OF type_g_pmdn6_d #轉換遮罩後資料
 
 
DEFINE g_browser         DYNAMIC ARRAY OF type_browser
DEFINE g_browser_f       DYNAMIC ARRAY OF type_browser
 
 
DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc2_table2   STRING
 
DEFINE g_wc2_table3   STRING
 
DEFINE g_wc2_table4   STRING
 
 
 
DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING
 
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog
                                                               
DEFINE g_pagestart           LIKE type_t.num10                 
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)
DEFINE g_order               STRING                             #查詢排序欄位
                                                        
DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入
 
DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明(global.argv) name="global.argv"

#end add-point
 
{</section>}
 
{<section id="apmt500.main" >}
#應用 a26 樣板自動產生(Version:7)
#+ 作業開始(主程式類型)
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"
      
   #end add-point   
   
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("apm","")
 
   #add-point:作業初始化 name="main.init"
   CALL apmt500_01_create_temp_table()   #151224-00025#3 add
   #獲取當前營運據點的聯絡對象識別碼
   LET g_oofa001 = ''
   SELECT oofa001 INTO g_oofa001 FROM oofa_t WHERE oofaent = g_enterprise AND oofa002 = '1' AND oofa003 = g_site
   
   #獲得當前營運據點的所屬稅區
   LET g_ooef019 = ''
   SELECT ooef019 INTO g_ooef019 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
   
   LET g_acc = ''
   #抓取[T:系統分類值檔].[C:系統分類碼]=24且[T:系統分類值檔].[C:系統分類碼]=g_prog 的[T:系統分類值檔].[C:參考欄位>
  # SELECT gzcb004 INTO g_acc FROM gzcb_t WHERE gzcb001 = '24' AND gzcb002 = g_prog  #160816-00001#8  2016/08/19  By 08734 Mark
   LET g_acc = s_fin_get_scc_value('24',g_prog,'2')  #160816-00001#8  2016/08/19  By 08734 add

   LET g_flag1 = FALSE
   LET g_flag2 = FALSE
   
   IF g_argv[1] = '1' THEN   #委外
      LET g_type = '2'    #取價時類型 ，2.委外
   ELSE
      LET g_type = '1'    #取價時類型 ，1.一般
   END IF
   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define name="main.define_sql"
      
   #end add-point
   LET g_forupd_sql = " SELECT pmdldocno,pmdl001,'',pmdldocdt,pmdl004,'',pmdl002,'',pmdl003,'',pmdlsite, 
       pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,'',pmdl052,'',pmdl053,pmdl009,'',pmdl010,'', 
       pmdl011,'',pmdl012,pmdl013,pmdl033,'',pmdl015,'',pmdl016,pmdl017,'',pmdl018,'',pmdl019,pmdl023, 
       '',pmdl043,'',pmdl044,pmdl051,'',pmdl020,'',pmdl025,'','',pmdl026,'','',pmdl029,'',pmdl021,'', 
       pmdl022,'',pmdl032,'',pmdl024,'',pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl042,pmdl047,pmdl048, 
       pmdl049,pmdl208,pmdl046,'',pmdl040,'',pmdl041,pmdlownid,'',pmdlowndp,'',pmdlcrtid,'',pmdlcrtdp, 
       '',pmdlcrtdt,pmdlmodid,'',pmdlmoddt,pmdlcnfid,'',pmdlcnfdt", 
                      " FROM pmdl_t",
                      " WHERE pmdlent= ? AND pmdldocno=? FOR UPDATE"
   #add-point:SQL_define name="main.after_define_sql"
      
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt500_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT DISTINCT t0.pmdldocno,t0.pmdl001,t0.pmdldocdt,t0.pmdl004,t0.pmdl002,t0.pmdl003, 
       t0.pmdlsite,t0.pmdlstus,t0.pmdl005,t0.pmdl006,t0.pmdl007,t0.pmdl008,t0.pmdl027,t0.pmdl052,t0.pmdl053, 
       t0.pmdl009,t0.pmdl010,t0.pmdl011,t0.pmdl012,t0.pmdl013,t0.pmdl033,t0.pmdl015,t0.pmdl016,t0.pmdl017, 
       t0.pmdl018,t0.pmdl019,t0.pmdl023,t0.pmdl043,t0.pmdl044,t0.pmdl051,t0.pmdl020,t0.pmdl025,t0.pmdl026, 
       t0.pmdl029,t0.pmdl021,t0.pmdl022,t0.pmdl032,t0.pmdl024,t0.pmdl054,t0.pmdl055,t0.pmdl030,t0.pmdl031, 
       t0.pmdl028,t0.pmdl042,t0.pmdl047,t0.pmdl048,t0.pmdl049,t0.pmdl208,t0.pmdl046,t0.pmdl040,t0.pmdl041, 
       t0.pmdlownid,t0.pmdlowndp,t0.pmdlcrtid,t0.pmdlcrtdp,t0.pmdlcrtdt,t0.pmdlmodid,t0.pmdlmoddt,t0.pmdlcnfid, 
       t0.pmdlcnfdt,t1.ooag011 ,t2.ooefl003 ,t3.pmaal004 ,t4.ooibl004 ,t5.oocql004 ,t6.ooail003 ,t7.pmaml003 , 
       t8.ooidl003 ,t9.oojdl003 ,t10.oocql004 ,t11.icaal003 ,t12.oocql004 ,t13.ooefl003 ,t14.pmaal004 , 
       t15.pmaal004 ,t16.pmaal004 ,t17.oocql004 ,t18.ooag011 ,t19.ooefl003 ,t20.ooag011 ,t21.ooefl003 , 
       t22.ooag011 ,t23.ooag011",
               " FROM pmdl_t t0",
                              " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmdl002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmdl003 AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t3 ON t3.pmaalent="||g_enterprise||" AND t3.pmaal001=t0.pmdl052 AND t3.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN ooibl_t t4 ON t4.ooiblent="||g_enterprise||" AND t4.ooibl002=t0.pmdl009 AND t4.ooibl003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t5 ON t5.oocqlent="||g_enterprise||" AND t5.oocql001='238' AND t5.oocql002=t0.pmdl010 AND t5.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooail_t t6 ON t6.ooailent="||g_enterprise||" AND t6.ooail001=t0.pmdl015 AND t6.ooail002='"||g_dlang||"' ",
               " LEFT JOIN pmaml_t t7 ON t7.pmamlent="||g_enterprise||" AND t7.pmaml001=t0.pmdl017 AND t7.pmaml002='"||g_dlang||"' ",
               " LEFT JOIN ooidl_t t8 ON t8.ooidlent="||g_enterprise||" AND t8.ooidl001=t0.pmdl018 AND t8.ooidl002='"||g_dlang||"' ",
               " LEFT JOIN oojdl_t t9 ON t9.oojdlent="||g_enterprise||" AND t9.oojdl001=t0.pmdl023 AND t9.oojdl002='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t10 ON t10.oocqlent="||g_enterprise||" AND t10.oocql001='317' AND t10.oocql002=t0.pmdl043 AND t10.oocql003='"||g_dlang||"' ",
               " LEFT JOIN icaal_t t11 ON t11.icaalent="||g_enterprise||" AND t11.icaal001=t0.pmdl051 AND t11.icaal002='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t12 ON t12.oocqlent="||g_enterprise||" AND t12.oocql001='263' AND t12.oocql002=t0.pmdl020 AND t12.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t13 ON t13.ooeflent="||g_enterprise||" AND t13.ooefl001=t0.pmdl029 AND t13.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t14 ON t14.pmaalent="||g_enterprise||" AND t14.pmaal001=t0.pmdl021 AND t14.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t15 ON t15.pmaalent="||g_enterprise||" AND t15.pmaal001=t0.pmdl022 AND t15.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t16 ON t16.pmaalent="||g_enterprise||" AND t16.pmaal001=t0.pmdl032 AND t16.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t17 ON t17.oocqlent="||g_enterprise||" AND t17.oocql001='264' AND t17.oocql002=t0.pmdl024 AND t17.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t18 ON t18.ooagent="||g_enterprise||" AND t18.ooag001=t0.pmdlownid  ",
               " LEFT JOIN ooefl_t t19 ON t19.ooeflent="||g_enterprise||" AND t19.ooefl001=t0.pmdlowndp AND t19.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t20 ON t20.ooagent="||g_enterprise||" AND t20.ooag001=t0.pmdlcrtid  ",
               " LEFT JOIN ooefl_t t21 ON t21.ooeflent="||g_enterprise||" AND t21.ooefl001=t0.pmdlcrtdp AND t21.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t22 ON t22.ooagent="||g_enterprise||" AND t22.ooag001=t0.pmdlmodid  ",
               " LEFT JOIN ooag_t t23 ON t23.ooagent="||g_enterprise||" AND t23.ooag001=t0.pmdlcnfid  ",
 
               " WHERE t0.pmdlent = " ||g_enterprise|| " AND t0.pmdldocno = ?"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define name="main.after_refresh_sql"
   
   #end add-point
   PREPARE apmt500_master_referesh FROM g_sql
 
    
 
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
            
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apmt500 WITH FORM cl_ap_formpath("apm",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apmt500_init()   
 
      #進入選單 Menu (="N")
      CALL apmt500_ui_dialog() 
      
      #add-point:畫面關閉前 name="main.before_close"
            
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_apmt500
      
   END IF 
   
   CLOSE apmt500_cl
   
   
 
   #add-point:作業離開前 name="main.exit"
   CALL apmt500_01_drop_temp_table()  #151224-00025#3  
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
 
 
 
{</section>}
 
{<section id="apmt500.init" >}
#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION apmt500_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point    
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
   DEFINE l_gzze003  LIKE gzze_t.gzze003        
   DEFINE l_prog     STRING   #160808-00043#1-add
   DEFINE l_slip_wc  STRING   #160727-00025#9
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"
   
   #end add-point
   
   LET g_bfill       = "Y"
   LET g_detail_idx  = 1 #第一層單身指標
   LET g_detail_idx2 = 1 #第二層單身指標
   
   #各個page指標
   LET g_detail_idx_list[1] = 1 
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
   LET g_detail_idx_list[5] = 1
 
   LET g_error_show  = 1
   LET l_ac = 1 #單身指標
      CALL cl_set_combo_scc_part('pmdlstus','13','N,Y,H,C,A,D,R,W,UH,X')
 
      CALL cl_set_combo_scc('pmdl005','2052') 
   CALL cl_set_combo_scc('pmdl006','2053') 
   CALL cl_set_combo_scc('pmdl007','2054') 
   CALL cl_set_combo_scc('pmdl054','2087') 
   CALL cl_set_combo_scc('pmdl055','2086') 
   CALL cl_set_combo_scc('pmdl046','8321') 
   CALL cl_set_combo_scc('pmdn045','2035') 
   CALL cl_set_combo_scc('pmdn019','2055') 
   CALL cl_set_combo_scc('pmdn020','2036') 
   CALL cl_set_combo_scc('pmdn032','2056') 
   CALL cl_set_combo_scc('pmdn035','2039') 
   CALL cl_set_combo_scc('pmdn040','2016') 
   CALL cl_set_combo_scc('pmdo003','2055') 
   CALL cl_set_combo_scc('pmdo009','2057') 
   CALL cl_set_combo_scc('pmdo021','2058') 
   CALL cl_set_combo_scc('pmdm014','3015') 
 
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #page群組
   LET g_idx_group = om.SaxAttributes.create()
   CALL g_idx_group.addAttribute("'1','2',","1")
   CALL g_idx_group.addAttribute("'3',","1")
   CALL g_idx_group.addAttribute("'4',","1")
   CALL g_idx_group.addAttribute("'5',","1")
   CALL g_idx_group.addAttribute("","1")
 
 
   #add-point:畫面資料初始化 name="init.init"
   #161031-00025#1----s
   #子程式畫面取代主程式元件
   CALL cl_ui_replace_sub_window(cl_ap_formpath("aoo", "aooi360_01"), "grid_remarks", "Table", "s_detail1_aooi360_01")
   CALL cl_set_combo_scc_part('ooff012','11','1,2,4')
   CALL cl_set_comp_visible("ooff003",FALSE)
   #161031-00025#1---e
   
   IF g_argv[1] = '3' THEN
      CALL cl_set_combo_scc_part('pmdl005','2052','1,3,4')    
   END IF
   IF g_argv[1] = '1' THEN  #委外時
      CALL cl_set_combo_scc_part('pmdl005','2052','2')      
   END IF
   
   IF g_argv[1] = '2' THEN  #重覆性生產時
      CALL cl_set_combo_scc_part('pmdl005','2052','5')      
   END IF
   IF g_argv[1] = '4' THEN  #重覆性生產時
      CALL cl_set_combo_scc_part('pmdl005','2052','6')      
   END IF
   
   CALL cl_set_combo_scc_part('pmdl006','2053','1,2,3,4,5,6,8')  #多角點對點功能未完善，選項先隱藏
   
   #CALL cl_set_combo_scc_part('pmdn019','2055','1,2,3,8,9,10,11')  #160606-00013#1
   CALL cl_set_combo_scc_part('pmdn019','2055','1,2,3,8,9,10,11,12,13') #160606-00013#1
   CALL cl_set_combo_scc('pmdo003','2055')
   CALL cl_set_combo_scc('pmdo009','2057')
   CALL cl_set_combo_scc('pmdo021','2058')
   
   #IF g_argv[1] = '1' THEN  #委外時，才顯示作業編號和製程序  #160602-00002#1
   IF g_argv[1] MATCHES '[12]' THEN #160602-00002#1
      CALL cl_set_comp_visible("pmdn004,pmdn004_desc,pmdn005,pmdp009,pmdp010",TRUE)
   ELSE
       CALL cl_set_comp_visible("pmdn004,pmdn004_desc,pmdn005,pmdp009,pmdp010",FALSE)
   END IF
   
   IF g_argv[1] = '3' THEN  #一般採購單下，才顯示產生單身ACTION
      CALL cl_set_toolbaritem_visible("open_apmt500_01",TRUE)
   ELSE
      CALL cl_set_toolbaritem_visible("open_apmt500_01",FALSE)
   END IF
   
   #判斷據點參數若不使用參考單位時，則參考單位、數量需隱藏不可以維護(據點參數:S-BAS-0028)
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'N' THEN
      CALL cl_set_comp_visible("pmdn008,pmdn008_desc,pmdn009,pmdo028,pmdo028_desc,pmdo029",FALSE)
   END IF
   
   #判斷據點參數若不使用產品特徵時，則產品特徵需隱藏不可以維護(據點參數:S-BAS-0036)
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'N' THEN
      CALL cl_set_comp_visible("pmdn002,pmdn002_desc,imaa005_1,imaa005_1_desc,pmdo002,pmdo002_desc,pmdp002,pmdp002_desc,pmdp008,pmdp008_desc",FALSE)
   END IF
   
   #整體參數未使用採購計價單位
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" THEN  
      CALL cl_set_comp_visible("pmdn010,pmdn010_desc,pmdn011",FALSE)
   END IF
   
   CALL cl_set_comp_visible("pmdn003,pmdn003_desc",FALSE)
   
   IF g_argv[1] = '4' THEN  #借貨採購單上顯示還料信息等欄位
      CALL cl_set_comp_visible("pmdn054,pmdn055,pmdn056,pmdn057,pmdo041,pmdo042,pmdo043,pmdo044",TRUE)
   ELSE
       CALL cl_set_comp_visible("pmdn054,pmdn055,pmdn056,pmdn057,pmdo041,pmdo042,pmdo043,pmdo044",FALSE)
   END IF
   
   #借貨採購單上欄位說明的顯示
   IF g_argv[1] = '4' THEN
      #借貨採購單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00853' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdldocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdldocno',l_gzze003)
      
      #借貨日期
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00854' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdldocdt',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdldocdt',l_gzze003)
      
      #借入料號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00855' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdn001',l_gzze003)
      CALL cl_set_comp_att_text('imaa001',l_gzze003)
      CALL cl_set_comp_att_text('pmdo001',l_gzze003)
      CALL cl_set_comp_att_text('pmdp001',l_gzze003)
      
      #借入單位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00857' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdn006',l_gzze003)
      CALL cl_set_comp_att_text('pmdo004',l_gzze003)
      
      #借入數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00856' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdn007',l_gzze003)
      
      #借入總數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00858' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdo005',l_gzze003)
      
      #分批借入數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00859' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdo006',l_gzze003)
      
   END IF
   
   #151210-00009#1  2015/12/30 By earl s
   IF cl_get_para(g_enterprise,'','E-BAS-0018') = 'Y' THEN
      LET g_aic_doc = TRUE
   ELSE
      LET g_aic_doc = FALSE
   END IF
   #151210-00009#1  2015/12/30 By earl e
   #160808-00043#1-mod-(S)  先將程式代號變成asft300取得單號後，再變回原本的程式代號，取相對應的單號
#   CALL s_aooi200_filter_slip('pmdldocno') RETURNING g_slip_wc    #160510-00043#2
   LET l_prog = g_prog
   LET g_prog = "asft300"
   #CALL s_aooi200_filter_slip('pmdldocno') RETURNING g_slip_wc  #160727-00025#9
   CALL s_aooi200_filter_slip('pmdldocno') RETURNING l_slip_wc   #160727-00025#9
   LET g_prog = l_prog
   #LET g_slip_wc = " (",g_slip_wc CLIPPED," OR ",s_aooi200_filter_slip('pmdldocno'),") "  #160727-00025#9
   #160808-00043#1-mod-(E)
   
   #160727-00025#9--s
   #模具工单的处理
   LET l_prog = g_prog
   LET g_prog = "asft304"
   CALL s_aooi200_filter_slip('pmdldocno') RETURNING g_slip_wc
   LET g_prog = l_prog
   IF NOT cl_null(g_slip_wc) THEN
      LET g_slip_wc = " (",g_slip_wc CLIPPED," OR ",l_slip_wc CLIPPED," OR ",s_aooi200_filter_slip('pmdldocno'),") "
   ELSE
      LET g_slip_wc = " (",l_slip_wc CLIPPED," OR ",s_aooi200_filter_slip('pmdldocno'),") "  
   END IF
   #160727-00025#9--e
   #end add-point
   
   #初始化搜尋條件
   CALL apmt500_default_search()
    
END FUNCTION
 
{</section>}
 
{<section id="apmt500.ui_dialog" >}
#+ 功能選單
PRIVATE FUNCTION apmt500_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_idx     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE lb_first   BOOLEAN
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE la_output  DYNAMIC ARRAY OF STRING   #報表元件鬆耦合使用
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   DEFINE l_pmaa004   LIKE pmaa_t.pmaa004
   DEFINE l_n         LIKE type_t.num5
   DEFINE l_pmdn024   LIKE pmdn_t.pmdn024   
   DEFINE l_slip      LIKE oobal_t.oobal002
   DEFINE l_prog      LIKE oobx_t.oobx004
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_str       STRING
   #end add-point
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"
   
   #end add-point
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   #因應查詢方案進行處理
   IF g_default THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   ELSE
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF
   
   #action default動作
   #應用 a42 樣板自動產生(Version:3)
   #進入程式時預設執行的動作
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL apmt500_insert()
            #add-point:ON ACTION insert name="menu.default.insert"
                        
            #END add-point
         END IF
 
      #add-point:action default自訂 name="ui_dialog.action_default"
            
      #end add-point
      OTHERWISE
   END CASE
 
 
 
   
   LET lb_first = TRUE
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"
      
   #end add-point
   
   WHILE TRUE 
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_pmdl_m.* TO NULL
         CALL g_pmdn_d.clear()
         CALL g_pmdn2_d.clear()
         CALL g_pmdn3_d.clear()
         CALL g_pmdn4_d.clear()
         CALL g_pmdn6_d.clear()
 
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL apmt500_init()
      END IF
   
      CALL lib_cl_dlg.cl_dlg_before_display()
            
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
         #左側瀏覽頁簽
         DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)
            BEFORE ROW
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE
         
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF 
               
               CALL apmt500_fetch('') # reload data
               LET l_ac = 1
               CALL apmt500_ui_detailshow() #Setting the current row 
         
               CALL apmt500_idx_chk()
               #NEXT FIELD pmdnseq
         
               ON ACTION qbefield_user   #欄位隱藏設定 
                  LET g_action_choice="qbefield_user"
                  CALL cl_ui_qbefield_user()
         END DISPLAY
    
         DISPLAY ARRAY g_pmdn_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt500_idx_chk()
               #確定當下選擇的筆數
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[1] = l_ac
               CALL g_idx_group.addAttribute("'1','2',",l_ac)
               
               #add-point:page1, before row動作 name="ui_dialog.page1.before_row"
                              
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1','2',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_current_page = 1
               #顯示單身筆數
               CALL apmt500_idx_chk()
               #add-point:page1自定義行為 name="ui_dialog.page1.before_display"
                              
               #end add-point
               
            #自訂ACTION(detail_show,page_1)
            
               
            #add-point:page1自定義行為 name="ui_dialog.page1.action"
                        
            #end add-point
               
         END DISPLAY
        
         #第一階單身段落
         DISPLAY ARRAY g_pmdn2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt500_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[2] = l_ac
               CALL g_idx_group.addAttribute("'3',",l_ac)
               
               #add-point:page2, before row動作 name="ui_dialog.body2.before_row"
                              
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_current_page = 2
               #顯示單身筆數
               CALL apmt500_idx_chk()
               #add-point:page2自定義行為 name="ui_dialog.body2.before_display"
                              
               #end add-point
      
            #自訂ACTION(detail_show,page_2)
            
         
            #add-point:page2自定義行為 name="ui_dialog.body2.action"
                        
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdn3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt500_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[3] = l_ac
               CALL g_idx_group.addAttribute("'4',",l_ac)
               
               #add-point:page3, before row動作 name="ui_dialog.body3.before_row"
                                             #IF l_ac > 1 THEN
               #   IF g_pmdn3_d[l_ac].pmdoseq = g_pmdn3_d[l_ac-1].pmdoseq 
               #     AND g_pmdn3_d[l_ac].pmdoseq1 = g_pmdn3_d[l_ac-1].pmdoseq1
               #     AND g_pmdn3_d[l_ac].pmdo003 = g_pmdn3_d[l_ac-1].pmdo003
               #     AND g_pmdn3_d[l_ac].pmdo001 = g_pmdn3_d[l_ac-1].pmdo001
               #     AND g_pmdn3_d[l_ac].pmdo002 = g_pmdn3_d[l_ac-1].pmdo002
               #     AND g_pmdn3_d[l_ac].pmdo004 = g_pmdn3_d[l_ac-1].pmdo004
               #     AND g_pmdn3_d[l_ac].pmdo005 = g_pmdn3_d[l_ac-1].pmdo005 THEN
               #     DISPLAY '' TO s_detail3[l_ac].pmdoseq
               #     DISPLAY '' TO s_detail3[l_ac].pmdoseq1
               #     DISPLAY '' TO s_detail3[l_ac].pmdo003
               #     DISPLAY '' TO s_detail3[l_ac].pmdo002
               #     DISPLAY '' TO s_detail3[l_ac].pmdo004
               #     DISPLAY '' TO s_detail3[l_ac].pmdo005
               #   END IF
               #END IF
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'4',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 3
               #顯示單身筆數
               CALL apmt500_idx_chk()
               #add-point:page3自定義行為 name="ui_dialog.body3.before_display"
                              
               #end add-point
      
            #自訂ACTION(detail_show,page_3)
            
         
            #add-point:page3自定義行為 name="ui_dialog.body3.action"
                        
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdn4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt500_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[4] = l_ac
               CALL g_idx_group.addAttribute("'5',",l_ac)
               
               #add-point:page4, before row動作 name="ui_dialog.body4.before_row"
                              
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'5',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_current_page = 4
               #顯示單身筆數
               CALL apmt500_idx_chk()
               #add-point:page4自定義行為 name="ui_dialog.body4.before_display"
                              
               #end add-point
      
            #自訂ACTION(detail_show,page_4)
            
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION detail_qrystr
               MENU "" ATTRIBUTE(STYLE="popup")
                  #add-point:ON ACTION detail_qrystr相關動作 name="menu.detail_show.page4_sub.detail_qrystr"
                  
                  #END add-point
                                 #應用 a43 樣板自動產生(Version:4)
               ON ACTION prog_apmt400
                  LET g_action_choice="prog_apmt400"
                  IF cl_auth_chk_act("prog_apmt400") THEN
                     
                     #add-point:ON ACTION prog_apmt400 name="menu.detail_show.page4_sub.prog_apmt400"
                     #應用 a41 樣板自動產生(Version:2)
                     #使用JSON格式組合參數與作業編號(串查)
                     #抓取單據別
                     LET l_slip = ''
                     LET l_prog = ''
                     IF NOT cl_null(g_pmdn4_d[l_ac].pmdp003) THEN
                        CALL s_aooi200_get_slip(g_pmdn4_d[l_ac].pmdp003) RETURNING l_success,l_slip
                        IF NOT cl_null(l_slip) THEN
                           SELECT oobx004 INTO l_prog
                             FROM oobx_t
                            WHERE oobxent = g_enterprise
                              AND oobx001 = l_slip
                        END IF
                        IF NOT cl_null(l_prog) THEN
                           INITIALIZE la_param.* TO NULL
                           LET la_param.prog     = l_prog
                           LET la_param.param[1] = g_pmdn4_d[l_ac].pmdp003
                          
                           LET ls_js = util.JSON.stringify(la_param)
                           CALL cl_cmdrun(ls_js)
                        END IF
                     END IF


                     #END add-point
                     
                  END IF
 
 
 
 
               END MENU
 
 
 
               #add-point:ON ACTION detail_qrystr name="menu.detail_show.page4.detail_qrystr"
               
               #END add-point
 
 
 
 
         
            #add-point:page4自定義行為 name="ui_dialog.body4.action"
                        
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdn6_d TO s_detail6.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt500_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail6")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[5] = l_ac
               CALL g_idx_group.addAttribute("",l_ac)
               
               #add-point:page5, before row動作 name="ui_dialog.body6.before_row"
                              
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue(""))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail6")
               LET g_current_page = 5
               #顯示單身筆數
               CALL apmt500_idx_chk()
               #add-point:page5自定義行為 name="ui_dialog.body6.before_display"
                              
               #end add-point
      
            #自訂ACTION(detail_show,page_5)
            
         
            #add-point:page5自定義行為 name="ui_dialog.body6.action"
                        
            #end add-point
         
         END DISPLAY
 
         
 
         
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         #单头备注显示
         SUBDIALOG aoo_aooi360_01.aooi360_01_display     #161031-00025#1 add     
         #end add-point
         
         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
         SUBDIALOG lib_cl_dlg.cl_dlg_relateapps
      
         BEFORE DIALOG
            #先填充browser資料
            CALL apmt500_browser_fill("")
            CALL cl_notice()
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               LET g_current_idx = g_current_row
            END IF
            
            #確保g_current_idx位於正常區間內
            #小於,等於0則指到第1筆
            IF g_current_idx <= 0 THEN
               LET g_current_idx = 1
            END IF
            #超過最大筆數則指到最後1筆
            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF 
            
            LET g_current_sw = TRUE
            LET g_current_row = g_current_idx #目前指標
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL apmt500_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL apmt500_ui_detailshow() #Setting the current row 
            
            #筆數顯示
            LET g_current_page = 1
            CALL apmt500_idx_chk()
            CALL cl_ap_performance_cal()
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")           
            #end add-point
 
         #add-point:ui_dialog段more_action name="ui_dialog.more_action"
         #161031-00025#1---s
         ON ACTION remarks_page
            LET g_detail_id = "remarks_page"
            NEXT FIELD ooff012
         #161031-00025#1---e
         #end add-point
 
         #狀態碼切換
         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL apmt500_statechange()
            #根據資料狀態切換action狀態
            CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
            CALL apmt500_set_act_visible()   
            CALL apmt500_set_act_no_visible()
            IF NOT (g_pmdl_m.pmdldocno IS NULL
 
              ) THEN
               #組合條件
               LET g_add_browse = " pmdlent = " ||g_enterprise|| " AND",
                                  " pmdldocno = '", g_pmdl_m.pmdldocno, "' "
 
               #填到對應位置
               CALL apmt500_browser_fill("")
            END IF
         #應用 a32 樣板自動產生(Version:3)
         #簽核狀況
         ON ACTION bpm_status
            #查詢簽核狀況, 統一建立HyperLink
            CALL cl_bpm_status()
            #add-point:ON ACTION bpm_status name="menu.bpm_status"
            #画面应该停留在第一个页签上
            CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")   #160824-00014#1 
            #END add-point
 
 
 
          
         #查詢方案選擇 
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
               INITIALIZE g_wc2_table4 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "pmdl_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdn_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdo_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdp_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdm_t" 
                        LET g_wc2_table4 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
                  OR NOT cl_null(g_wc2_table4)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
                  IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
 
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               CALL apmt500_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF
         
         #查詢方案選擇
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
               INITIALIZE g_wc2_table4 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "pmdl_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdn_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdo_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdp_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdm_t" 
                        LET g_wc2_table4 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
                  OR NOT cl_null(g_wc2_table4)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
                  IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL apmt500_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "" 
                     LET g_errparam.code = "-100" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL apmt500_fetch("F")
                  END IF
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()
          
         #應用 a49 樣板自動產生(Version:4)
            #過濾瀏覽頁資料
            ON ACTION filter
               LET g_action_choice = "fetch"
               #add-point:filter action name="ui_dialog.action.filter"
               
               #end add-point
               CALL apmt500_filter()
               EXIT DIALOG
 
 
 
         
         ON ACTION first
            LET g_action_choice = "fetch"
            CALL apmt500_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt500_idx_chk()
            
         ON ACTION previous
            LET g_action_choice = "fetch"
            CALL apmt500_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt500_idx_chk()
            
         ON ACTION jump
            LET g_action_choice = "fetch"
            CALL apmt500_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt500_idx_chk()
            
         ON ACTION next
            LET g_action_choice = "fetch"
            CALL apmt500_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt500_idx_chk()
            
         ON ACTION last
            LET g_action_choice = "fetch"
            CALL apmt500_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt500_idx_chk()
          
         #excel匯出功能          
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               #browser
               CALL g_export_node.clear()
               IF g_main_hidden = 1 THEN
                  LET g_export_node[1] = base.typeInfo.create(g_browser)
                  LET g_export_id[1]   = "s_browse"
                  CALL cl_export_to_excel()
               #非browser
               ELSE
                  LET g_export_node[1] = base.typeInfo.create(g_pmdn_d)
                  LET g_export_id[1]   = "s_detail1"
                  LET g_export_node[2] = base.typeInfo.create(g_pmdn2_d)
                  LET g_export_id[2]   = "s_detail2"
                  LET g_export_node[3] = base.typeInfo.create(g_pmdn3_d)
                  LET g_export_id[3]   = "s_detail3"
                  LET g_export_node[4] = base.typeInfo.create(g_pmdn4_d)
                  LET g_export_id[4]   = "s_detail4"
                  LET g_export_node[5] = base.typeInfo.create(g_pmdn6_d)
                  LET g_export_id[5]   = "s_detail6"
 
                  #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
                  #161031-00025#1---s
                  LET g_export_node[6] = base.typeInfo.create(g_ooff_d4)
                  LET g_export_id[6]   = "s_detail1_aooi360_01"
                  #161031-00025#1---e
                  #END add-point
                  CALL cl_export_to_excel_getpage()
                  CALL cl_export_to_excel()
               END IF
            END IF
        
         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
    
         #主頁摺疊
         ON ACTION mainhidden       
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
               CALL cl_notice()
            END IF
            
         #瀏覽頁折疊
         ON ACTION worksheethidden   
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF
            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD pmdnseq
            END IF
       
         #單頭摺疊，可利用hot key "Alt-s"開啟/關閉單頭
         ON ACTION controls     
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF
    
         
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL apmt500_modify()
               #add-point:ON ACTION modify name="menu.modify"
               CALL gfrm_curr.ensureFieldVisible(g_field)               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL apmt500_modify()
               #add-point:ON ACTION modify_detail name="menu.modify_detail"
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION demo
            LET g_action_choice="demo"
            IF cl_auth_chk_act("demo") THEN
               
               #add-point:ON ACTION demo name="menu.demo"
               #161031-00025#1---s
               #CALL aooi360_02('6',g_prog,g_pmdl_m.pmdldocno,'','','','','','','','','')
               IF NOT cl_null(g_pmdl_m.pmdldocno) THEN
                  CALL apmt500_remaks()
               END IF
               #161031-00025#1---e
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmi004_01
            LET g_action_choice="open_apmi004_01"
            IF cl_auth_chk_act("open_apmi004_01") THEN
               
               #add-point:ON ACTION open_apmi004_01 name="menu.open_apmi004_01"
               #若輸入供應商的法人類型為'2:一次性交易'或是'4:內部員工'時，則自動串apmi004_01
               #維護一次性交易對項基本資料，維護完基本資料後會回傳一個一次性交易對象識別碼，
               #將識別碼值預設給pmdl028欄位
               IF NOT cl_null(g_pmdl_m.pmdl004) THEN
                  LET l_pmaa004 = ''
                  LET g_pmdl_m.pmdl028 = NULL #160418-00004#1 add
                  SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmdl_m.pmdl004
                  IF l_pmaa004 = '2' THEN   #一次性交易對象
                     #20150505 modify by lixiang 150504-00013#5
                     #CALL apmi004_01('1','',g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                     CALL apmi004_01('1',g_pmdl_m.pmdl028,g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                  END IF
                  IF l_pmaa004 = '4' THEN   #內部員工
                     #20150505 modify by lixiang 150504-00013#5
                     #CALL apmi004_01('2','',g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                     CALL apmi004_01('2',g_pmdl_m.pmdl028,g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                  END IF
                  #20150505 modify by lixiang 150504-00013#5--add---
                  CALL s_transaction_begin()
                  UPDATE pmdl_t SET pmdl028 = g_pmdl_m.pmdl028 WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdl_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                  ELSE
                     CALL s_transaction_end('Y','0')
                  END IF
                  
                  CALL apmt500_show()
                  #20150505 modify by lixiang 150504-00013#5---end---
                  
                  CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL apmt500_delete()
               #add-point:ON ACTION delete name="menu.delete"
               #画面应该停留在第一个页签上
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")   #160824-00014#1                
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL apmt500_insert()
               #add-point:ON ACTION insert name="menu.insert"
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")                
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output name="menu.output"
                #140530 mark gr
                #CALL apmr500_g01("pmdlent = "|| g_enterprise ||" AND pmdldocno = '"||g_pmdl_m.pmdldocno||"'",'') 
                LET g_rep_wc = "pmdlent = "|| g_enterprise ||" AND pmdldocno = '"||g_pmdl_m.pmdldocno||"'"                
                #140530 add xg
                #CALL apmr500_x01("pmdment = "|| g_enterprise )              
               #END add-point
               &include "erp/apm/apmt500_rep.4gl"
               #add-point:ON ACTION output.after name="menu.after_output"
               #画面应该停留在第一个页签上
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")   #160824-00014#1     
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION quickprint
            LET g_action_choice="quickprint"
            IF cl_auth_chk_act("quickprint") THEN
               
               #add-point:ON ACTION quickprint name="menu.quickprint"
                #140530 mark gr
                #CALL apmr500_g01("pmdlent = "|| g_enterprise ||" AND pmdldocno = '"||g_pmdl_m.pmdldocno||"'",'') 
                LET g_rep_wc = "pmdlent = "|| g_enterprise ||" AND pmdldocno = '"||g_pmdl_m.pmdldocno||"'"                
                #140530 add xg
                #CALL apmr500_x01("pmdment = "|| g_enterprise )              
               #END add-point
               &include "erp/apm/apmt500_rep.4gl"
               #add-point:ON ACTION quickprint.after name="menu.after_quickprint"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL apmt500_reproduce()
               #add-point:ON ACTION reproduce name="menu.reproduce"
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION get_detail_price
            LET g_action_choice="get_detail_price"
            IF cl_auth_chk_act("get_detail_price") THEN
               
               #add-point:ON ACTION get_detail_price name="menu.get_detail_price"
               IF cl_ask_promp('apm-00801') THEN
                  CALL apmt500_get_detail_price()
               END IF
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_pmdm
            LET g_action_choice="open_pmdm"
            IF cl_auth_chk_act("open_pmdm") THEN
               
               #add-point:ON ACTION open_pmdm name="menu.open_pmdm"
               CALL apmt500_open_pmdm()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL apmt500_query()
               #add-point:ON ACTION query name="menu.query"
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")                
               #END add-point
               #應用 a59 樣板自動產生(Version:3)  
               CALL g_curr_diag.setCurrentRow("s_detail1",1)
               CALL g_curr_diag.setCurrentRow("s_detail2",1)
               CALL g_curr_diag.setCurrentRow("s_detail3",1)
               CALL g_curr_diag.setCurrentRow("s_detail4",1)
               CALL g_curr_diag.setCurrentRow("s_detail6",1)
 
 
 
 
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmt500_01
            LET g_action_choice="open_apmt500_01"
            IF cl_auth_chk_act("open_apmt500_01") THEN
               
               #add-point:ON ACTION open_apmt500_01 name="menu.open_apmt500_01"
               IF NOT cl_null(g_pmdl_m.pmdldocno) THEN
                  CALL s_transaction_begin()
                  IF NOT apmt500_01(g_pmdl_m.pmdldocno) THEN
                     CALL s_transaction_end('N','0')
                  ELSE
                     CALL s_transaction_end('Y','0')
                  END IF
                  CALL apmt500_b_fill()
               END IF
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmt500_03
            LET g_action_choice="open_apmt500_03"
            IF cl_auth_chk_act("open_apmt500_03") THEN
               
               #add-point:ON ACTION open_apmt500_03 name="menu.open_apmt500_03"
               IF l_ac > 0 THEN
                  #維護多交期
                  CALL s_transaction_begin()
                  CALL apmt500_03(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn007) 
                    RETURNING g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014
                  #如果當前筆資料有多筆交期，則更像採購單單身的多交期欄位為'Y'
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmdq_t 
                     WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn_d[l_ac].pmdnseq
                  IF l_n > 1 THEN
                     LET l_pmdn024 = 'Y'
                  ELSE
                     LET l_pmdn024 = 'N'
                  END IF
                  UPDATE pmdn_t SET pmdn012 = g_pmdn_d[l_ac].pmdn012,
                                    pmdn013 = g_pmdn_d[l_ac].pmdn013,
                                    pmdn014 = g_pmdn_d[l_ac].pmdn014,
                                    pmdn024 = l_pmdn024
                     WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
                       AND pmdnseq = g_pmdn_d[l_ac].pmdnseq

                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdn_t" 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     
                     CALL s_transaction_end('N','0')
                  ELSE
                     #呼叫"產生採購交期明細資料"的Function產生交期明細資料
                     IF NOT s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "pmdo_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()                   
                        CALL s_transaction_end('N','0')
                     ELSE
                        CALL s_transaction_end('Y','0')
                     END IF
                  END IF
                  CALL apmt500_b_fill()
               END IF
               CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_pmdl002
            LET g_action_choice="prog_pmdl002"
            IF cl_auth_chk_act("prog_pmdl002") THEN
               
               #add-point:ON ACTION prog_pmdl002 name="menu.prog_pmdl002"
               CALL cl_user_contact("aooi130", "ooag_t", "ooag002", "ooag001",g_pmdl_m.pmdl002)
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_pmdl008
            LET g_action_choice="prog_pmdl008"
            IF cl_auth_chk_act("prog_pmdl008") THEN
               
               #add-point:ON ACTION prog_pmdl008 name="menu.prog_pmdl008"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               #抓取單據別
               LET l_slip = ''
               LET l_prog = ''
               IF NOT cl_null(g_pmdl_m.pmdl008) THEN
                  CALL s_aooi200_get_slip(g_pmdl_m.pmdl008) RETURNING l_success,l_slip
                  IF NOT cl_null(l_slip) THEN
                     SELECT oobx004 INTO l_prog
                       FROM oobx_t
                      WHERE oobxent = g_enterprise
                        AND oobx001 = l_slip
                  END IF
                  IF NOT cl_null(l_prog) THEN
                     INITIALIZE la_param.* TO NULL
                     LET la_param.prog     = l_prog
                    #161107-00001#1  --begin--
                    #LET la_param.param[1] = g_pmdl_m.pmdl008
                     IF g_pmdl_m.pmdl007 MATCHES '[34]' THEN
                        IF l_prog = 'asft304' THEN   #asft304通过参数‘4’调用的asft300，需要和标准的asft300区分开来
                           LET la_param.param[1] = g_pmdl_m.pmdl008
                        ELSE
                           LET la_param.param[2] = g_pmdl_m.pmdl008
                        END IF
                     ELSE
                        LET la_param.param[1] = g_pmdl_m.pmdl008
                     END IF
                    #161107-00001#1  --end--
              
                     LET ls_js = util.JSON.stringify(la_param)
                     CALL cl_cmdrun(ls_js)
                  END IF
               END IF


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_pmdl027
            LET g_action_choice="prog_pmdl027"
            IF cl_auth_chk_act("prog_pmdl027") THEN
               
               #add-point:ON ACTION prog_pmdl027 name="menu.prog_pmdl027"
               CALL cl_user_contact("apmi005", "pmaj_t", "pmaj002", "pmaj001",'')                
               #END add-point
               
            END IF
 
 
 
 
         
         #應用 a46 樣板自動產生(Version:3)
         #新增相關文件
         ON ACTION related_document
            CALL apmt500_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"
               
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL apmt500_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"
            
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL apmt500_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"
            
            #END add-point
            CALL cl_user_overview_follow(g_pmdl_m.pmdldocdt)
 
 
 
         
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
    
         #交談指令共用ACTION
         &include "common_action.4gl" 
            CONTINUE DIALOG
      END DIALOG
 
      #(ver:79) ---add start---
      #add-point:ui_dialog段 after dialog name="ui_dialog.exit_dialog"
      
      #end add-point
      #(ver:79) --- add end ---
    
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         EXIT WHILE
      END IF
    
   END WHILE    
      
   CALL cl_set_act_visible("accept,cancel", TRUE)
    
END FUNCTION
 
{</section>}
 
{<section id="apmt500.browser_fill" >}
#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION apmt500_browser_fill(ps_page_action)
   #add-point:browser_fill段define(客製用) name="browser_fill.define_customerization"
   
   #end add-point  
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   #add-point:browser_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="browser_fill.define"
   
   #end add-point    
   
   #add-point:Function前置處理 name="browser_fill.before_browser_fill"
   #161031-00025#1---s
   IF cl_null(g_add_browse) THEN
      CALL aooi360_01_clear_detail()   #清除备注单身
   END IF
   #161031-00025#1---e
   #end add-point
   
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
 
   #add-point:browser_fill,foreach前 name="browser_fill.before_foreach"
   IF cl_null(g_wc) THEN
      LET g_wc = " pmdlsite = '",g_site,"' "
   ELSE
      LET g_wc = g_wc," AND pmdlsite = '",g_site,"' "
   END IF
   
   #IF g_argv[1] = '1' THEN  #委外採購
   #   LET g_wc = g_wc," AND pmdl005 = '2'"
   #ELSE
   #   IF g_argv[1] = '2' THEN  #重覆性生產委外採購
   #      LET g_wc = g_wc," AND pmdl005 = '5'"
   #   ELSE
   #      LET g_wc = g_wc," AND pmdl005 NOT IN ('2','5') "
   #   END IF
   #END IF
   CASE g_argv[01]
      WHEN "1"   #委外採購
         LET g_wc = g_wc," AND pmdl005 = '2'"
      WHEN "2"   #重覆性生產委外採購
         LET g_wc = g_wc," AND pmdl005 = '5'"
      WHEN "3"   #一般採購
         LET g_wc = g_wc," AND pmdl005 NOT IN ('2','5','6') "
      WHEN "4"   #借貨採購
         LET g_wc = g_wc," AND pmdl005 = '6'"
     
   END CASE
   #160510-00043#2--(S)   
   IF NOT cl_null(g_slip_wc) THEN
      LET g_wc = g_wc," AND ",g_slip_wc
   END IF
   #160510-00043#2--(E)
   LET l_wc  = g_wc.trim() 
   
   #end add-point
   
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT DISTINCT pmdldocno ",
                      " FROM pmdl_t ",
                      " ",
                      " LEFT JOIN pmdn_t ON pmdnent = pmdlent AND pmdldocno = pmdndocno ", "  ",
                      #add-point:browser_fill段sql(pmdn_t1) name="browser_fill.cnt.join.}"
                      
                      #end add-point
                      " LEFT JOIN pmdo_t ON pmdoent = pmdlent AND pmdldocno = pmdodocno", "  ",
                      #add-point:browser_fill段sql(pmdo_t1) name="browser_fill.cnt.join.pmdo_t1"
                      
                      #end add-point
 
                      " LEFT JOIN pmdp_t ON pmdpent = pmdlent AND pmdldocno = pmdpdocno", "  ",
                      #add-point:browser_fill段sql(pmdp_t1) name="browser_fill.cnt.join.pmdp_t1"
                      
                      #end add-point
 
                      " LEFT JOIN pmdm_t ON pmdment = pmdlent AND pmdldocno = pmdmdocno", "  ",
                      #add-point:browser_fill段sql(pmdm_t1) name="browser_fill.cnt.join.pmdm_t1"
                      
                      #end add-point
 
 
 
                      " ", 
                      " ", 
                      " ",                      
 
                      " ",                      
 
                      " ",                      
 
 
 
                      " WHERE pmdlent = " ||g_enterprise|| " AND pmdnent = " ||g_enterprise|| " AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("pmdl_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT DISTINCT pmdldocno ",
                      " FROM pmdl_t ", 
                      "  ",
                      "  ",
                      " WHERE pmdlent = " ||g_enterprise|| " AND ",l_wc CLIPPED, cl_sql_add_filter("pmdl_t")
   END IF
   
   #add-point:browser_fill,cnt wc name="browser_fill.cnt_sqlwc"
   #161031-00025#1---s
   IF NOT cl_null(g_wc2_i36001) AND g_wc2_i36001 <> " 1=1" THEN
      LET l_sub_sql = l_sub_sql CLIPPED, " AND pmdldocno IN ( SELECT ooff003 FROM ooff_t WHERE ooffent = ",g_enterprise," AND ooff001 = '6' AND ooff004= 0 AND ",g_wc2_i36001 CLIPPED ,")"
   END IF
   #161031-00025#1---e
   #end add-point
   
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   
   #add-point:browser_fill,count前 name="browser_fill.before_count"
      
   #end add-point
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE header_cnt_pre FROM g_sql
      EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
      FREE header_cnt_pre
   END IF
    
   IF g_browser_cnt > g_max_browse THEN
      IF g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_browser_cnt
         LET g_errparam.code = 9035 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
      END IF
      LET g_browser_cnt = g_max_browse
   END IF
   
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN
      #清除畫面
      CLEAR FORM                
      INITIALIZE g_pmdl_m.* TO NULL
      CALL g_pmdn_d.clear()        
      CALL g_pmdn2_d.clear() 
      CALL g_pmdn3_d.clear() 
      CALL g_pmdn4_d.clear() 
      CALL g_pmdn6_d.clear() 
 
      #add-point:browser_fill g_add_browse段額外處理 name="browser_fill.add_browse.other"
      
      #end add-point   
      CALL g_browser.clear()
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1" 
      LET g_cnt = g_current_idx
   END IF
 
   #依照t0.pmdldocno,t0.pmdldocdt,t0.pmdl001,t0.pmdl002,t0.pmdl003,t0.pmdl004 Browser欄位定義(取代原本bs_sql功能)
   #考量到單身可能下條件, 所以此處需join單身所有table
   #DISTINCT是為了避免在join時出現重複的資料(如果不加DISTINCT則須在程式中過濾)
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.pmdlstus,t0.pmdldocno,t0.pmdldocdt,t0.pmdl001,t0.pmdl002,t0.pmdl003, 
          t0.pmdl004,t1.ooag011 ,t2.ooefl003 ,t3.pmaal004 ",
                  " FROM pmdl_t t0",
                  "  ",
                  "  LEFT JOIN pmdn_t ON pmdnent = pmdlent AND pmdldocno = pmdndocno ", "  ", 
                  #add-point:browser_fill段sql(pmdn_t1) name="browser_fill.join.pmdn_t1"
                  
                  #end add-point
                  "  LEFT JOIN pmdo_t ON pmdoent = pmdlent AND pmdldocno = pmdodocno", "  ", 
                  #add-point:browser_fill段sql(pmdo_t1) name="browser_fill.join.pmdo_t1"
               "          AND pmdnseq = pmdoseq ",
                  #end add-point
 
                  "  LEFT JOIN pmdp_t ON pmdpent = pmdlent AND pmdldocno = pmdpdocno", "  ", 
                  #add-point:browser_fill段sql(pmdp_t1) name="browser_fill.join.pmdp_t1"
               "          AND pmdnseq = pmdpseq ",
                  #end add-point
 
                  "  LEFT JOIN pmdm_t ON pmdment = pmdlent AND pmdldocno = pmdmdocno", "  ", 
                  #add-point:browser_fill段sql(pmdm_t1) name="browser_fill.join.pmdm_t1"
                  
                  #end add-point
 
 
 
                  " ", 
                  " ",                      
 
                  " ",                      
 
                  " ",                      
 
 
 
                                 " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmdl002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmdl003 AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t3 ON t3.pmaalent="||g_enterprise||" AND t3.pmaal001=t0.pmdl004 AND t3.pmaal002='"||g_dlang||"' ",
 
                  " WHERE t0.pmdlent = " ||g_enterprise|| " AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("pmdl_t")
   ELSE
      #單身無輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.pmdlstus,t0.pmdldocno,t0.pmdldocdt,t0.pmdl001,t0.pmdl002,t0.pmdl003, 
          t0.pmdl004,t1.ooag011 ,t2.ooefl003 ,t3.pmaal004 ",
                  " FROM pmdl_t t0",
                  "  ",
                                 " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmdl002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmdl003 AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t3 ON t3.pmaalent="||g_enterprise||" AND t3.pmaal001=t0.pmdl004 AND t3.pmaal002='"||g_dlang||"' ",
 
                  " WHERE t0.pmdlent = " ||g_enterprise|| " AND ",l_wc, cl_sql_add_filter("pmdl_t")
   END IF
   #add-point:browser_fill,sql wc name="browser_fill.fill_sqlwc"
   
   #end add-point
   LET g_sql = g_sql, " ORDER BY pmdldocno ",g_order
 
   #add-point:browser_fill,before_prepare name="browser_fill.before_prepare"
      
   #end add-point
        
   #LET g_sql = cl_sql_add_tabid(g_sql,"pmdl_t") #WC重組
   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE browse_pre FROM g_sql
      DECLARE browse_cur CURSOR FOR browse_pre
      
      #add-point:browser_fill段open cursor name="browser_fill.open"
      
      #end add-point
      
      FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_pmdldocno,g_browser[g_cnt].b_pmdldocdt, 
          g_browser[g_cnt].b_pmdl001,g_browser[g_cnt].b_pmdl002,g_browser[g_cnt].b_pmdl003,g_browser[g_cnt].b_pmdl004, 
          g_browser[g_cnt].b_pmdl002_desc,g_browser[g_cnt].b_pmdl003_desc,g_browser[g_cnt].b_pmdl004_desc 
 
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "Foreach:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         #add-point:browser_fill段reference name="browser_fill.reference"
            
         #end add-point
      
         #遮罩相關處理
         CALL apmt500_browser_mask()
      
               #應用 a24 樣板自動產生(Version:3)
      #browser顯示圖片
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         WHEN "H"
            LET g_browser[g_cnt].b_statepic = "stus/16/hold.png"
         WHEN "C"
            LET g_browser[g_cnt].b_statepic = "stus/16/closed.png"
         WHEN "A"
            LET g_browser[g_cnt].b_statepic = "stus/16/approved.png"
         WHEN "D"
            LET g_browser[g_cnt].b_statepic = "stus/16/withdraw.png"
         WHEN "R"
            LET g_browser[g_cnt].b_statepic = "stus/16/rejection.png"
         WHEN "W"
            LET g_browser[g_cnt].b_statepic = "stus/16/signing.png"
         WHEN "UH"
            LET g_browser[g_cnt].b_statepic = "stus/16/unhold.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/invalid.png"
         
      END CASE
 
 
 
         LET g_cnt = g_cnt + 1
         IF g_cnt > g_max_browse THEN
            EXIT FOREACH
         END IF
         
      END FOREACH
      FREE browse_pre
   END IF
   
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   
   IF cl_null(g_browser[g_cnt].b_pmdldocno) THEN
      CALL g_browser.deleteElement(g_cnt)
   END IF
   
   LET g_header_cnt  = g_browser.getLength()
   LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
 
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
 
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
                  
   
   #add-point:browser_fill段結束前 name="browser_fill.after"
      
   #end add-point   
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.ui_headershow" >}
#+ 單頭資料重新顯示
PRIVATE FUNCTION apmt500_ui_headershow()
   #add-point:ui_headershow段define(客製用) name="ui_headershow.define_customerization"
   
   #end add-point  
   #add-point:ui_headershow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_headershow.define"
      
   #end add-point      
   
   #add-point:Function前置處理  name="ui_headershow.pre_function"
   
   #end add-point
   
   LET g_pmdl_m.pmdldocno = g_browser[g_current_idx].b_pmdldocno   
 
   EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
       g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
       g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
       g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
       g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
       g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
       g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
       g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
       g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
       g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
       g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid_desc, 
       g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc
   
   CALL apmt500_pmdl_t_mask()
   CALL apmt500_show()
      
END FUNCTION
 
{</section>}
 
{<section id="apmt500.ui_detailshow" >}
#+ 單身資料重新顯示
PRIVATE FUNCTION apmt500_ui_detailshow()
   #add-point:ui_detailshow段define(客製用) name="ui_detailshow.define_customerization"
   
   #end add-point    
   #add-point:ui_detailshow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_detailshow.define"
      
   #end add-point    
 
   #add-point:Function前置處理 name="ui_detailshow.before"
      
   #end add-point    
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail3",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail4",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail6",g_detail_idx)
 
   END IF
   
   #add-point:ui_detailshow段after name="ui_detailshow.after"
      
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.ui_browser_refresh" >}
#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION apmt500_ui_browser_refresh()
   #add-point:ui_browser_refresh段define(客製用) name="ui_browser_refresh.define_customerization"
   
   #end add-point    
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_browser_refresh.define"
      
   #end add-point    
   
   #add-point:Function前置處理  name="ui_browser_refresh.pre_function"
   
   #end add-point
   
   LET g_browser_cnt = g_browser.getLength()
   LET g_header_cnt  = g_browser.getLength()
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_pmdldocno = g_pmdl_m.pmdldocno 
 
         THEN
         CALL g_browser.deleteElement(l_i)
         EXIT FOR
      END IF
   END FOR
   LET g_browser_cnt = g_browser_cnt - 1
   LET g_header_cnt = g_header_cnt - 1
    
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
      CLEAR FORM
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
   
   #add-point:ui_browser_refresh段after name="ui_browser_refresh.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.construct" >}
#+ QBE資料查詢
PRIVATE FUNCTION apmt500_construct()
   #add-point:cs段define(客製用) name="cs.define_customerization"
   
   #end add-point    
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   DEFINE la_wc       DYNAMIC ARRAY OF RECORD
          tableid     STRING,
          wc          STRING
          END RECORD
   DEFINE li_idx      LIKE type_t.num10
   #add-point:cs段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="cs.define"
         DEFINE l_sql       STRING
   DEFINE l_success   LIKE type_t.num5
   #end add-point    
   
   #add-point:Function前置處理  name="cs.pre_function"

   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#1

   #end add-point
    
   #清除畫面
   CLEAR FORM                
   INITIALIZE g_pmdl_m.* TO NULL
   CALL g_pmdn_d.clear()        
   CALL g_pmdn2_d.clear() 
   CALL g_pmdn3_d.clear() 
   CALL g_pmdn4_d.clear() 
   CALL g_pmdn6_d.clear() 
 
   
   LET g_action_choice = ""
    
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc2_table2 TO NULL
 
   INITIALIZE g_wc2_table3 TO NULL
 
   INITIALIZE g_wc2_table4 TO NULL
 
 
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段開始前 name="cs.before_construct"
      
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON pmdldocno,pmdl001,pmdldocdt,pmdl004,pmdl002,pmdl003,pmdlsite,pmdlstus, 
          pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009,pmdl010,pmdl011,pmdl012,pmdl013, 
          pmdl033,pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl023,pmdl043,pmdl044,pmdl051,pmdl020,pmdl025, 
          pmdl026,pmdl029,pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl042, 
          pmdl047,pmdl048,pmdl049,pmdl208,pmdl046,pmdl040,pmdl041,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp, 
          pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt
 
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.head.before_construct"
                        
            #end add-point 
            
         #公用欄位開窗相關處理
         #應用 a11 樣板自動產生(Version:3)
         #共用欄位查詢處理  
         ##----<<pmdlcrtdt>>----
         AFTER FIELD pmdlcrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
         #----<<pmdlmoddt>>----
         AFTER FIELD pmdlmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmdlcnfdt>>----
         AFTER FIELD pmdlcnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmdlpstdt>>----
 
 
 
            
         #一般欄位開窗相關處理    
                  #Ctrlp:construct.c.pmdldocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdldocno
            #add-point:ON ACTION controlp INFIELD pmdldocno name="construct.c.pmdldocno"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   CASE g_argv[01]
               WHEN "1"   #委外採購
                  LET g_qryparam.where = " pmdl005 = '2'"
               WHEN "2"   #重覆性生產委外採購
                  LET g_qryparam.where = " pmdl005 = '5'"
               WHEN "3"   #一般採購
                  LET g_qryparam.where = " pmdl005 NOT IN ('2','5','6') "
               WHEN "4"   #借貨採購
                  LET g_qryparam.where = " pmdl005 = '6'"
               OTHERWISE
                  LET g_qryparam.where = " 1=1"  #160510-00043#2
            END CASE
            #160510-00043#2--(S)   
            IF NOT cl_null(g_slip_wc) THEN
               LET g_qryparam.where = g_qryparam.where," AND ",g_slip_wc
            END IF
            #160510-00043#2--(E)
            CALL q_pmdldocno()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdldocno  #顯示到畫面上

            NEXT FIELD pmdldocno                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdldocno
            #add-point:BEFORE FIELD pmdldocno name="construct.b.pmdldocno"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdldocno
            
            #add-point:AFTER FIELD pmdldocno name="construct.a.pmdldocno"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl001
            #add-point:BEFORE FIELD pmdl001 name="construct.b.pmdl001"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl001
            
            #add-point:AFTER FIELD pmdl001 name="construct.a.pmdl001"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl001
            #add-point:ON ACTION controlp INFIELD pmdl001 name="construct.c.pmdl001"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdldocdt
            #add-point:BEFORE FIELD pmdldocdt name="construct.b.pmdldocdt"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdldocdt
            
            #add-point:AFTER FIELD pmdldocdt name="construct.a.pmdldocdt"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdldocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdldocdt
            #add-point:ON ACTION controlp INFIELD pmdldocdt name="construct.c.pmdldocdt"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdl004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl004
            #add-point:ON ACTION controlp INFIELD pmdl004 name="construct.c.pmdl004"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmaa001_3()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl004  #顯示到畫面上

            NEXT FIELD pmdl004                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl004
            #add-point:BEFORE FIELD pmdl004 name="construct.b.pmdl004"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl004
            
            #add-point:AFTER FIELD pmdl004 name="construct.a.pmdl004"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl002
            #add-point:ON ACTION controlp INFIELD pmdl002 name="construct.c.pmdl002"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl002  #顯示到畫面上

            NEXT FIELD pmdl002                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl002
            #add-point:BEFORE FIELD pmdl002 name="construct.b.pmdl002"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl002
            
            #add-point:AFTER FIELD pmdl002 name="construct.a.pmdl002"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl003
            #add-point:ON ACTION controlp INFIELD pmdl003 name="construct.c.pmdl003"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl003  #顯示到畫面上

            NEXT FIELD pmdl003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl003
            #add-point:BEFORE FIELD pmdl003 name="construct.b.pmdl003"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl003
            
            #add-point:AFTER FIELD pmdl003 name="construct.a.pmdl003"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlsite
            #add-point:BEFORE FIELD pmdlsite name="construct.b.pmdlsite"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlsite
            
            #add-point:AFTER FIELD pmdlsite name="construct.a.pmdlsite"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdlsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlsite
            #add-point:ON ACTION controlp INFIELD pmdlsite name="construct.c.pmdlsite"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlstus
            #add-point:BEFORE FIELD pmdlstus name="construct.b.pmdlstus"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlstus
            
            #add-point:AFTER FIELD pmdlstus name="construct.a.pmdlstus"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdlstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlstus
            #add-point:ON ACTION controlp INFIELD pmdlstus name="construct.c.pmdlstus"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl005
            #add-point:BEFORE FIELD pmdl005 name="construct.b.pmdl005"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl005
            
            #add-point:AFTER FIELD pmdl005 name="construct.a.pmdl005"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl005
            #add-point:ON ACTION controlp INFIELD pmdl005 name="construct.c.pmdl005"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl006
            #add-point:BEFORE FIELD pmdl006 name="construct.b.pmdl006"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl006
            
            #add-point:AFTER FIELD pmdl006 name="construct.a.pmdl006"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl006
            #add-point:ON ACTION controlp INFIELD pmdl006 name="construct.c.pmdl006"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl007
            #add-point:BEFORE FIELD pmdl007 name="construct.b.pmdl007"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl007
            
            #add-point:AFTER FIELD pmdl007 name="construct.a.pmdl007"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl007
            #add-point:ON ACTION controlp INFIELD pmdl007 name="construct.c.pmdl007"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdl008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl008
            #add-point:ON ACTION controlp INFIELD pmdl008 name="construct.c.pmdl008"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmdl008()    #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl008  #顯示到畫面上

            NEXT FIELD pmdl008                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl008
            #add-point:BEFORE FIELD pmdl008 name="construct.b.pmdl008"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl008
            
            #add-point:AFTER FIELD pmdl008 name="construct.a.pmdl008"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl027
            #add-point:ON ACTION controlp INFIELD pmdl027 name="construct.c.pmdl027"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = g_pmdl_m.pmdl004
            CALL q_pmaj002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl027  #顯示到畫面上
            
            NEXT FIELD pmdl027                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl027
            #add-point:BEFORE FIELD pmdl027 name="construct.b.pmdl027"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl027
            
            #add-point:AFTER FIELD pmdl027 name="construct.a.pmdl027"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl052
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl052
            #add-point:ON ACTION controlp INFIELD pmdl052 name="construct.c.pmdl052"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001_3()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl052  #顯示到畫面上
            NEXT FIELD pmdl052                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl052
            #add-point:BEFORE FIELD pmdl052 name="construct.b.pmdl052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl052
            
            #add-point:AFTER FIELD pmdl052 name="construct.a.pmdl052"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl053
            #add-point:BEFORE FIELD pmdl053 name="construct.b.pmdl053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl053
            
            #add-point:AFTER FIELD pmdl053 name="construct.a.pmdl053"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl053
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl053
            #add-point:ON ACTION controlp INFIELD pmdl053 name="construct.c.pmdl053"
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_pmdl053()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl053  #顯示到畫面上
            NEXT FIELD pmdl053                     #返回原欄位

            #END add-point
 
 
         #Ctrlp:construct.c.pmdl009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl009
            #add-point:ON ACTION controlp INFIELD pmdl009 name="construct.c.pmdl009"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = g_pmdl_m.pmdl004
            CALL q_pmad002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl009  #顯示到畫面上
            
            NEXT FIELD pmdl009                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl009
            #add-point:BEFORE FIELD pmdl009 name="construct.b.pmdl009"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl009
            
            #add-point:AFTER FIELD pmdl009 name="construct.a.pmdl009"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl010
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl010
            #add-point:ON ACTION controlp INFIELD pmdl010 name="construct.c.pmdl010"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = '238'
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl010  #顯示到畫面上
              

            NEXT FIELD pmdl010                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl010
            #add-point:BEFORE FIELD pmdl010 name="construct.b.pmdl010"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl010
            
            #add-point:AFTER FIELD pmdl010 name="construct.a.pmdl010"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl011
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl011
            #add-point:ON ACTION controlp INFIELD pmdl011 name="construct.c.pmdl011"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            #CALL q_oodb002_2()                           #呼叫開窗
            CALL q_oodb002_11()
            DISPLAY g_qryparam.return1 TO pmdl011  #顯示到畫面上

            NEXT FIELD pmdl011                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl011
            #add-point:BEFORE FIELD pmdl011 name="construct.b.pmdl011"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl011
            
            #add-point:AFTER FIELD pmdl011 name="construct.a.pmdl011"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl012
            #add-point:BEFORE FIELD pmdl012 name="construct.b.pmdl012"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl012
            
            #add-point:AFTER FIELD pmdl012 name="construct.a.pmdl012"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl012
            #add-point:ON ACTION controlp INFIELD pmdl012 name="construct.c.pmdl012"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl013
            #add-point:BEFORE FIELD pmdl013 name="construct.b.pmdl013"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl013
            
            #add-point:AFTER FIELD pmdl013 name="construct.a.pmdl013"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl013
            #add-point:ON ACTION controlp INFIELD pmdl013 name="construct.c.pmdl013"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdl033
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl033
            #add-point:ON ACTION controlp INFIELD pmdl033 name="construct.c.pmdl033"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = g_ooef019 #
            LET g_qryparam.arg2 = "1" #
            CALL q_isac002_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl033  #顯示到畫面上

            NEXT FIELD pmdl033                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl033
            #add-point:BEFORE FIELD pmdl033 name="construct.b.pmdl033"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl033
            
            #add-point:AFTER FIELD pmdl033 name="construct.a.pmdl033"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl015
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl015
            #add-point:ON ACTION controlp INFIELD pmdl015 name="construct.c.pmdl015"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = g_site
            CALL q_ooaj002_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl015  #顯示到畫面上

            NEXT FIELD pmdl015                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl015
            #add-point:BEFORE FIELD pmdl015 name="construct.b.pmdl015"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl015
            
            #add-point:AFTER FIELD pmdl015 name="construct.a.pmdl015"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl016
            #add-point:BEFORE FIELD pmdl016 name="construct.b.pmdl016"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl016
            
            #add-point:AFTER FIELD pmdl016 name="construct.a.pmdl016"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl016
            #add-point:ON ACTION controlp INFIELD pmdl016 name="construct.c.pmdl016"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdl017
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl017
            #add-point:ON ACTION controlp INFIELD pmdl017 name="construct.c.pmdl017"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmam001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl017  #顯示到畫面上

            NEXT FIELD pmdl017                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl017
            #add-point:BEFORE FIELD pmdl017 name="construct.b.pmdl017"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl017
            
            #add-point:AFTER FIELD pmdl017 name="construct.a.pmdl017"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl018
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl018
            #add-point:ON ACTION controlp INFIELD pmdl018 name="construct.c.pmdl018"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooid001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl018  #顯示到畫面上

            NEXT FIELD pmdl018                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl018
            #add-point:BEFORE FIELD pmdl018 name="construct.b.pmdl018"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl018
            
            #add-point:AFTER FIELD pmdl018 name="construct.a.pmdl018"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl019
            #add-point:BEFORE FIELD pmdl019 name="construct.b.pmdl019"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl019
            
            #add-point:AFTER FIELD pmdl019 name="construct.a.pmdl019"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl019
            #add-point:ON ACTION controlp INFIELD pmdl019 name="construct.c.pmdl019"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdl023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl023
            #add-point:ON ACTION controlp INFIELD pmdl023 name="construct.c.pmdl023"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			   #160621-00003#3 20160627 modify by beckxie---S
			   #LET g_qryparam.arg1 = "275"
            #CALL q_oocq002()                           #呼叫開窗
            LET g_qryparam.arg1 = '2'
            CALL q_oojd001_1()
            #160621-00003#3 20160627 modify by beckxie---E
            DISPLAY g_qryparam.return1 TO pmdl023  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdl023                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl023
            #add-point:BEFORE FIELD pmdl023 name="construct.b.pmdl023"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl023
            
            #add-point:AFTER FIELD pmdl023 name="construct.a.pmdl023"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl043
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl043
            #add-point:ON ACTION controlp INFIELD pmdl043 name="construct.c.pmdl043"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = "317"
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl043  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdl043                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl043
            #add-point:BEFORE FIELD pmdl043 name="construct.b.pmdl043"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl043
            
            #add-point:AFTER FIELD pmdl043 name="construct.a.pmdl043"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl044
            #add-point:BEFORE FIELD pmdl044 name="construct.b.pmdl044"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl044
            
            #add-point:AFTER FIELD pmdl044 name="construct.a.pmdl044"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl044
            #add-point:ON ACTION controlp INFIELD pmdl044 name="construct.c.pmdl044"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl051
            #add-point:BEFORE FIELD pmdl051 name="construct.b.pmdl051"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl051
            
            #add-point:AFTER FIELD pmdl051 name="construct.a.pmdl051"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl051
            #add-point:ON ACTION controlp INFIELD pmdl051 name="construct.c.pmdl051"
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "2','3"
            CALL q_icaa001_1()                             #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl051  #顯示到畫面上
            NEXT FIELD pmdl051                     #返回原欄位

            #END add-point
 
 
         #Ctrlp:construct.c.pmdl020
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl020
            #add-point:ON ACTION controlp INFIELD pmdl020 name="construct.c.pmdl020"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = "263"
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl020  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdl020                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl020
            #add-point:BEFORE FIELD pmdl020 name="construct.b.pmdl020"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl020
            
            #add-point:AFTER FIELD pmdl020 name="construct.a.pmdl020"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl025
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl025
            #add-point:ON ACTION controlp INFIELD pmdl025 name="construct.c.pmdl025"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   #LET g_qryparam.arg1 = g_oofa001
			   LET g_qryparam.where = " oofb008 = '3' "  #出貨地址
            CALL q_oofb019_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl025  #顯示到畫面上

            NEXT FIELD pmdl025                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl025
            #add-point:BEFORE FIELD pmdl025 name="construct.b.pmdl025"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl025
            
            #add-point:AFTER FIELD pmdl025 name="construct.a.pmdl025"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl026
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl026
            #add-point:ON ACTION controlp INFIELD pmdl026 name="construct.c.pmdl026"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			#LET g_qryparam.arg1 = g_oofa001
			LET g_qryparam.where = " oofb008 = '5' "  #發票地址
            CALL q_oofb019_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl026  #顯示到畫面上

            NEXT FIELD pmdl026                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl026
            #add-point:BEFORE FIELD pmdl026 name="construct.b.pmdl026"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl026
            
            #add-point:AFTER FIELD pmdl026 name="construct.a.pmdl026"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl029
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl029
            #add-point:ON ACTION controlp INFIELD pmdl029 name="construct.c.pmdl029"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl029  #顯示到畫面上

            NEXT FIELD pmdl029                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl029
            #add-point:BEFORE FIELD pmdl029 name="construct.b.pmdl029"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl029
            
            #add-point:AFTER FIELD pmdl029 name="construct.a.pmdl029"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl021
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl021
            #add-point:ON ACTION controlp INFIELD pmdl021 name="construct.c.pmdl021"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = " pmac003 = '1' "
            CALL q_pmac002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl021  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO pmaal004 #交易對象簡稱 

            NEXT FIELD pmdl021                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl021
            #add-point:BEFORE FIELD pmdl021 name="construct.b.pmdl021"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl021
            
            #add-point:AFTER FIELD pmdl021 name="construct.a.pmdl021"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl022
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl022
            #add-point:ON ACTION controlp INFIELD pmdl022 name="construct.c.pmdl022"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = " pmac003 = '2' "
            CALL q_pmac002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl022  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO pmaal004 #交易對象簡稱 

            NEXT FIELD pmdl022                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl022
            #add-point:BEFORE FIELD pmdl022 name="construct.b.pmdl022"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl022
            
            #add-point:AFTER FIELD pmdl022 name="construct.a.pmdl022"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl032
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl032
            #add-point:ON ACTION controlp INFIELD pmdl032 name="construct.c.pmdl032"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_site
            CALL q_pmaa001_6()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl032  #顯示到畫面上

            NEXT FIELD pmdl032                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl032
            #add-point:BEFORE FIELD pmdl032 name="construct.b.pmdl032"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl032
            
            #add-point:AFTER FIELD pmdl032 name="construct.a.pmdl032"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl024
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl024
            #add-point:ON ACTION controlp INFIELD pmdl024 name="construct.c.pmdl024"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = "264"
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl024  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdl024                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl024
            #add-point:BEFORE FIELD pmdl024 name="construct.b.pmdl024"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl024
            
            #add-point:AFTER FIELD pmdl024 name="construct.a.pmdl024"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl054
            #add-point:BEFORE FIELD pmdl054 name="construct.b.pmdl054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl054
            
            #add-point:AFTER FIELD pmdl054 name="construct.a.pmdl054"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl054
            #add-point:ON ACTION controlp INFIELD pmdl054 name="construct.c.pmdl054"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl055
            #add-point:BEFORE FIELD pmdl055 name="construct.b.pmdl055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl055
            
            #add-point:AFTER FIELD pmdl055 name="construct.a.pmdl055"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl055
            #add-point:ON ACTION controlp INFIELD pmdl055 name="construct.c.pmdl055"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl030
            #add-point:BEFORE FIELD pmdl030 name="construct.b.pmdl030"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl030
            
            #add-point:AFTER FIELD pmdl030 name="construct.a.pmdl030"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl030
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl030
            #add-point:ON ACTION controlp INFIELD pmdl030 name="construct.c.pmdl030"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl031
            #add-point:BEFORE FIELD pmdl031 name="construct.b.pmdl031"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl031
            
            #add-point:AFTER FIELD pmdl031 name="construct.a.pmdl031"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl031
            #add-point:ON ACTION controlp INFIELD pmdl031 name="construct.c.pmdl031"
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_pmdl031()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl031  #顯示到畫面上
            NEXT FIELD pmdl031                     #返回原欄位
                   
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl028
            #add-point:BEFORE FIELD pmdl028 name="construct.b.pmdl028"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl028
            
            #add-point:AFTER FIELD pmdl028 name="construct.a.pmdl028"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl028
            #add-point:ON ACTION controlp INFIELD pmdl028 name="construct.c.pmdl028"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl042
            #add-point:BEFORE FIELD pmdl042 name="construct.b.pmdl042"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl042
            
            #add-point:AFTER FIELD pmdl042 name="construct.a.pmdl042"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl042
            #add-point:ON ACTION controlp INFIELD pmdl042 name="construct.c.pmdl042"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl047
            #add-point:BEFORE FIELD pmdl047 name="construct.b.pmdl047"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl047
            
            #add-point:AFTER FIELD pmdl047 name="construct.a.pmdl047"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl047
            #add-point:ON ACTION controlp INFIELD pmdl047 name="construct.c.pmdl047"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl048
            #add-point:BEFORE FIELD pmdl048 name="construct.b.pmdl048"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl048
            
            #add-point:AFTER FIELD pmdl048 name="construct.a.pmdl048"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl048
            #add-point:ON ACTION controlp INFIELD pmdl048 name="construct.c.pmdl048"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl049
            #add-point:BEFORE FIELD pmdl049 name="construct.b.pmdl049"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl049
            
            #add-point:AFTER FIELD pmdl049 name="construct.a.pmdl049"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl049
            #add-point:ON ACTION controlp INFIELD pmdl049 name="construct.c.pmdl049"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdl208
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl208
            #add-point:ON ACTION controlp INFIELD pmdl208 name="construct.c.pmdl208"
            #20160222--add--begin by ouhz 
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_pmdl208()    #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdl208  #顯示到畫面上
            NEXT FIELD pmdl208 
            #20160222--add--end by ouhz             
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl208
            #add-point:BEFORE FIELD pmdl208 name="construct.b.pmdl208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl208
            
            #add-point:AFTER FIELD pmdl208 name="construct.a.pmdl208"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl046
            #add-point:BEFORE FIELD pmdl046 name="construct.b.pmdl046"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl046
            
            #add-point:AFTER FIELD pmdl046 name="construct.a.pmdl046"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl046
            #add-point:ON ACTION controlp INFIELD pmdl046 name="construct.c.pmdl046"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl040
            #add-point:BEFORE FIELD pmdl040 name="construct.b.pmdl040"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl040
            
            #add-point:AFTER FIELD pmdl040 name="construct.a.pmdl040"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl040
            #add-point:ON ACTION controlp INFIELD pmdl040 name="construct.c.pmdl040"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl041
            #add-point:BEFORE FIELD pmdl041 name="construct.b.pmdl041"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl041
            
            #add-point:AFTER FIELD pmdl041 name="construct.a.pmdl041"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdl041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl041
            #add-point:ON ACTION controlp INFIELD pmdl041 name="construct.c.pmdl041"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdlownid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlownid
            #add-point:ON ACTION controlp INFIELD pmdlownid name="construct.c.pmdlownid"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdlownid  #顯示到畫面上

            NEXT FIELD pmdlownid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlownid
            #add-point:BEFORE FIELD pmdlownid name="construct.b.pmdlownid"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlownid
            
            #add-point:AFTER FIELD pmdlownid name="construct.a.pmdlownid"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdlowndp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlowndp
            #add-point:ON ACTION controlp INFIELD pmdlowndp name="construct.c.pmdlowndp"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdlowndp  #顯示到畫面上

            NEXT FIELD pmdlowndp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlowndp
            #add-point:BEFORE FIELD pmdlowndp name="construct.b.pmdlowndp"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlowndp
            
            #add-point:AFTER FIELD pmdlowndp name="construct.a.pmdlowndp"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdlcrtid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlcrtid
            #add-point:ON ACTION controlp INFIELD pmdlcrtid name="construct.c.pmdlcrtid"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdlcrtid  #顯示到畫面上

            NEXT FIELD pmdlcrtid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlcrtid
            #add-point:BEFORE FIELD pmdlcrtid name="construct.b.pmdlcrtid"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlcrtid
            
            #add-point:AFTER FIELD pmdlcrtid name="construct.a.pmdlcrtid"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdlcrtdp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlcrtdp
            #add-point:ON ACTION controlp INFIELD pmdlcrtdp name="construct.c.pmdlcrtdp"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdlcrtdp  #顯示到畫面上

            NEXT FIELD pmdlcrtdp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlcrtdp
            #add-point:BEFORE FIELD pmdlcrtdp name="construct.b.pmdlcrtdp"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlcrtdp
            
            #add-point:AFTER FIELD pmdlcrtdp name="construct.a.pmdlcrtdp"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlcrtdt
            #add-point:BEFORE FIELD pmdlcrtdt name="construct.b.pmdlcrtdt"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdlmodid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlmodid
            #add-point:ON ACTION controlp INFIELD pmdlmodid name="construct.c.pmdlmodid"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdlmodid  #顯示到畫面上

            NEXT FIELD pmdlmodid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlmodid
            #add-point:BEFORE FIELD pmdlmodid name="construct.b.pmdlmodid"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlmodid
            
            #add-point:AFTER FIELD pmdlmodid name="construct.a.pmdlmodid"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlmoddt
            #add-point:BEFORE FIELD pmdlmoddt name="construct.b.pmdlmoddt"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.pmdlcnfid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlcnfid
            #add-point:ON ACTION controlp INFIELD pmdlcnfid name="construct.c.pmdlcnfid"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdlcnfid  #顯示到畫面上

            NEXT FIELD pmdlcnfid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlcnfid
            #add-point:BEFORE FIELD pmdlcnfid name="construct.b.pmdlcnfid"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlcnfid
            
            #add-point:AFTER FIELD pmdlcnfid name="construct.a.pmdlcnfid"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlcnfdt
            #add-point:BEFORE FIELD pmdlcnfdt name="construct.b.pmdlcnfdt"
                        
            #END add-point
 
 
 
         
      END CONSTRUCT
 
      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON pmdnsite,pmdnseq,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006,pmdn007,pmdn008, 
          pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015,pmdn016,pmdn017,pmdn046, 
          pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022,pmdnunit,pmdnorga,pmdn049, 
          pmdn051,pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,ooff013,pmdn027,l_pmao009,l_pmao010,pmdn028, 
          pmdn029,pmdn030,pmdn053,pmdn025,pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036,pmdn037,pmdn038, 
          pmdn058,pmdn058_desc,pmdn039,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044
           FROM s_detail1[1].pmdnsite,s_detail1[1].pmdnseq,s_detail1[1].pmdn001,s_detail1[1].pmdn002, 
               s_detail1[1].pmdn004,s_detail1[1].pmdn005,s_detail1[1].pmdn006,s_detail1[1].pmdn007,s_detail1[1].pmdn008, 
               s_detail1[1].pmdn009,s_detail1[1].pmdn024,s_detail1[1].pmdn012,s_detail1[1].pmdn013,s_detail1[1].pmdn014, 
               s_detail1[1].pmdn045,s_detail1[1].pmdn010,s_detail1[1].pmdn011,s_detail1[1].pmdn015,s_detail1[1].pmdn016, 
               s_detail1[1].pmdn017,s_detail1[1].pmdn046,s_detail1[1].pmdn047,s_detail1[1].pmdn048,s_detail1[1].pmdn023, 
               s_detail1[1].pmdn019,s_detail1[1].pmdn020,s_detail1[1].pmdn052,s_detail1[1].pmdn021,s_detail1[1].pmdn022, 
               s_detail1[1].pmdnunit,s_detail1[1].pmdnorga,s_detail1[1].pmdn049,s_detail1[1].pmdn051, 
               s_detail1[1].pmdn054,s_detail1[1].pmdn055,s_detail1[1].pmdn056,s_detail1[1].pmdn057,s_detail1[1].pmdn050, 
               s_detail1[1].ooff013,s_detail2[1].pmdn027,s_detail2[1].l_pmao009,s_detail2[1].l_pmao010, 
               s_detail2[1].pmdn028,s_detail2[1].pmdn029,s_detail2[1].pmdn030,s_detail2[1].pmdn053,s_detail2[1].pmdn025, 
               s_detail2[1].pmdn026,s_detail2[1].pmdn031,s_detail2[1].pmdn032,s_detail2[1].pmdn033,s_detail2[1].pmdn003, 
               s_detail2[1].pmdn036,s_detail2[1].pmdn037,s_detail2[1].pmdn038,s_detail2[1].pmdn058,s_detail2[1].pmdn058_desc, 
               s_detail2[1].pmdn039,s_detail2[1].pmdn035,s_detail2[1].pmdn040,s_detail2[1].pmdn041,s_detail2[1].pmdn042, 
               s_detail2[1].pmdn043,s_detail2[1].pmdn044
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body.before_construct"
                        
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnsite
            #add-point:BEFORE FIELD pmdnsite name="construct.b.page1.pmdnsite"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnsite
            
            #add-point:AFTER FIELD pmdnsite name="construct.a.page1.pmdnsite"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdnsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnsite
            #add-point:ON ACTION controlp INFIELD pmdnsite name="construct.c.page1.pmdnsite"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnseq
            #add-point:BEFORE FIELD pmdnseq name="construct.b.page1.pmdnseq"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnseq
            
            #add-point:AFTER FIELD pmdnseq name="construct.a.page1.pmdnseq"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdnseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnseq
            #add-point:ON ACTION controlp INFIELD pmdnseq name="construct.c.page1.pmdnseq"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn001
            #add-point:ON ACTION controlp INFIELD pmdn001 name="construct.c.page1.pmdn001"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = "1=1 "
			
			LET l_sql = " 1=1"
            CALL s_control_get_sql("imaa001",'6','4',g_user,g_dept) RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            END IF
            
            CALL q_imaf001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn001  #顯示到畫面上

            NEXT FIELD pmdn001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn001
            #add-point:BEFORE FIELD pmdn001 name="construct.b.page1.pmdn001"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn001
            
            #add-point:AFTER FIELD pmdn001 name="construct.a.page1.pmdn001"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn002
            #add-point:BEFORE FIELD pmdn002 name="construct.b.page1.pmdn002"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn002
            
            #add-point:AFTER FIELD pmdn002 name="construct.a.page1.pmdn002"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn002
            #add-point:ON ACTION controlp INFIELD pmdn002 name="construct.c.page1.pmdn002"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn004
            #add-point:ON ACTION controlp INFIELD pmdn004 name="construct.c.page1.pmdn004"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn004  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdn004                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn004
            #add-point:BEFORE FIELD pmdn004 name="construct.b.page1.pmdn004"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn004
            
            #add-point:AFTER FIELD pmdn004 name="construct.a.page1.pmdn004"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn005
            #add-point:BEFORE FIELD pmdn005 name="construct.b.page1.pmdn005"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn005
            
            #add-point:AFTER FIELD pmdn005 name="construct.a.page1.pmdn005"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn005
            #add-point:ON ACTION controlp INFIELD pmdn005 name="construct.c.page1.pmdn005"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn006
            #add-point:ON ACTION controlp INFIELD pmdn006 name="construct.c.page1.pmdn006"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn006  #顯示到畫面上

            NEXT FIELD pmdn006                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn006
            #add-point:BEFORE FIELD pmdn006 name="construct.b.page1.pmdn006"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn006
            
            #add-point:AFTER FIELD pmdn006 name="construct.a.page1.pmdn006"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn007
            #add-point:BEFORE FIELD pmdn007 name="construct.b.page1.pmdn007"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn007
            
            #add-point:AFTER FIELD pmdn007 name="construct.a.page1.pmdn007"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn007
            #add-point:ON ACTION controlp INFIELD pmdn007 name="construct.c.page1.pmdn007"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn008
            #add-point:ON ACTION controlp INFIELD pmdn008 name="construct.c.page1.pmdn008"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn008  #顯示到畫面上

            NEXT FIELD pmdn008                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn008
            #add-point:BEFORE FIELD pmdn008 name="construct.b.page1.pmdn008"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn008
            
            #add-point:AFTER FIELD pmdn008 name="construct.a.page1.pmdn008"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn009
            #add-point:BEFORE FIELD pmdn009 name="construct.b.page1.pmdn009"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn009
            
            #add-point:AFTER FIELD pmdn009 name="construct.a.page1.pmdn009"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn009
            #add-point:ON ACTION controlp INFIELD pmdn009 name="construct.c.page1.pmdn009"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn024
            #add-point:BEFORE FIELD pmdn024 name="construct.b.page1.pmdn024"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn024
            
            #add-point:AFTER FIELD pmdn024 name="construct.a.page1.pmdn024"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn024
            #add-point:ON ACTION controlp INFIELD pmdn024 name="construct.c.page1.pmdn024"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn012
            #add-point:BEFORE FIELD pmdn012 name="construct.b.page1.pmdn012"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn012
            
            #add-point:AFTER FIELD pmdn012 name="construct.a.page1.pmdn012"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn012
            #add-point:ON ACTION controlp INFIELD pmdn012 name="construct.c.page1.pmdn012"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn013
            #add-point:BEFORE FIELD pmdn013 name="construct.b.page1.pmdn013"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn013
            
            #add-point:AFTER FIELD pmdn013 name="construct.a.page1.pmdn013"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn013
            #add-point:ON ACTION controlp INFIELD pmdn013 name="construct.c.page1.pmdn013"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn014
            #add-point:BEFORE FIELD pmdn014 name="construct.b.page1.pmdn014"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn014
            
            #add-point:AFTER FIELD pmdn014 name="construct.a.page1.pmdn014"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn014
            #add-point:ON ACTION controlp INFIELD pmdn014 name="construct.c.page1.pmdn014"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn045
            #add-point:BEFORE FIELD pmdn045 name="construct.b.page1.pmdn045"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn045
            
            #add-point:AFTER FIELD pmdn045 name="construct.a.page1.pmdn045"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn045
            #add-point:ON ACTION controlp INFIELD pmdn045 name="construct.c.page1.pmdn045"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn010
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn010
            #add-point:ON ACTION controlp INFIELD pmdn010 name="construct.c.page1.pmdn010"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn010  #顯示到畫面上

            NEXT FIELD pmdn010                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn010
            #add-point:BEFORE FIELD pmdn010 name="construct.b.page1.pmdn010"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn010
            
            #add-point:AFTER FIELD pmdn010 name="construct.a.page1.pmdn010"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn011
            #add-point:BEFORE FIELD pmdn011 name="construct.b.page1.pmdn011"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn011
            
            #add-point:AFTER FIELD pmdn011 name="construct.a.page1.pmdn011"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn011
            #add-point:ON ACTION controlp INFIELD pmdn011 name="construct.c.page1.pmdn011"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn015
            #add-point:BEFORE FIELD pmdn015 name="construct.b.page1.pmdn015"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn015
            
            #add-point:AFTER FIELD pmdn015 name="construct.a.page1.pmdn015"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn015
            #add-point:ON ACTION controlp INFIELD pmdn015 name="construct.c.page1.pmdn015"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn016
            #add-point:ON ACTION controlp INFIELD pmdn016 name="construct.c.page1.pmdn016"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            #CALL q_oodb002_2()                           #呼叫開窗
            CALL q_oodb002_11()
            DISPLAY g_qryparam.return1 TO pmdn016  #顯示到畫面上

            NEXT FIELD pmdn016                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn016
            #add-point:BEFORE FIELD pmdn016 name="construct.b.page1.pmdn016"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn016
            
            #add-point:AFTER FIELD pmdn016 name="construct.a.page1.pmdn016"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn017
            #add-point:BEFORE FIELD pmdn017 name="construct.b.page1.pmdn017"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn017
            
            #add-point:AFTER FIELD pmdn017 name="construct.a.page1.pmdn017"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn017
            #add-point:ON ACTION controlp INFIELD pmdn017 name="construct.c.page1.pmdn017"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn046
            #add-point:BEFORE FIELD pmdn046 name="construct.b.page1.pmdn046"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn046
            
            #add-point:AFTER FIELD pmdn046 name="construct.a.page1.pmdn046"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn046
            #add-point:ON ACTION controlp INFIELD pmdn046 name="construct.c.page1.pmdn046"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn047
            #add-point:BEFORE FIELD pmdn047 name="construct.b.page1.pmdn047"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn047
            
            #add-point:AFTER FIELD pmdn047 name="construct.a.page1.pmdn047"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn047
            #add-point:ON ACTION controlp INFIELD pmdn047 name="construct.c.page1.pmdn047"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn048
            #add-point:BEFORE FIELD pmdn048 name="construct.b.page1.pmdn048"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn048
            
            #add-point:AFTER FIELD pmdn048 name="construct.a.page1.pmdn048"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn048
            #add-point:ON ACTION controlp INFIELD pmdn048 name="construct.c.page1.pmdn048"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdn023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn023
            #add-point:ON ACTION controlp INFIELD pmdn023 name="construct.c.page1.pmdn023"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = " pmac003 = '2' "
            CALL q_pmac002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn023  #顯示到畫面上

            NEXT FIELD pmdn023                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn023
            #add-point:BEFORE FIELD pmdn023 name="construct.b.page1.pmdn023"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn023
            
            #add-point:AFTER FIELD pmdn023 name="construct.a.page1.pmdn023"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn019
            #add-point:BEFORE FIELD pmdn019 name="construct.b.page1.pmdn019"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn019
            
            #add-point:AFTER FIELD pmdn019 name="construct.a.page1.pmdn019"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn019
            #add-point:ON ACTION controlp INFIELD pmdn019 name="construct.c.page1.pmdn019"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn020
            #add-point:BEFORE FIELD pmdn020 name="construct.b.page1.pmdn020"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn020
            
            #add-point:AFTER FIELD pmdn020 name="construct.a.page1.pmdn020"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn020
            #add-point:ON ACTION controlp INFIELD pmdn020 name="construct.c.page1.pmdn020"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn052
            #add-point:BEFORE FIELD pmdn052 name="construct.b.page1.pmdn052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn052
            
            #add-point:AFTER FIELD pmdn052 name="construct.a.page1.pmdn052"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn052
            #add-point:ON ACTION controlp INFIELD pmdn052 name="construct.c.page1.pmdn052"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn021
            #add-point:BEFORE FIELD pmdn021 name="construct.b.page1.pmdn021"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn021
            
            #add-point:AFTER FIELD pmdn021 name="construct.a.page1.pmdn021"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn021
            #add-point:ON ACTION controlp INFIELD pmdn021 name="construct.c.page1.pmdn021"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn022
            #add-point:BEFORE FIELD pmdn022 name="construct.b.page1.pmdn022"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn022
            
            #add-point:AFTER FIELD pmdn022 name="construct.a.page1.pmdn022"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn022
            #add-point:ON ACTION controlp INFIELD pmdn022 name="construct.c.page1.pmdn022"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdnunit
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnunit
            #add-point:ON ACTION controlp INFIELD pmdnunit name="construct.c.page1.pmdnunit"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            #CALL q_ooef001()     #161019-00017#3
            CALL q_ooef001_1()   #161019-00017#3
            DISPLAY g_qryparam.return1 TO pmdnunit  #顯示到畫面上

            NEXT FIELD pmdnunit                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnunit
            #add-point:BEFORE FIELD pmdnunit name="construct.b.page1.pmdnunit"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnunit
            
            #add-point:AFTER FIELD pmdnunit name="construct.a.page1.pmdnunit"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdnorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnorga
            #add-point:ON ACTION controlp INFIELD pmdnorga name="construct.c.page1.pmdnorga"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
		   	LET g_qryparam.reqry = FALSE
            #CALL q_ooef001()     #161019-00017#3
            CALL q_ooef001_1()   #161019-00017#3
            DISPLAY g_qryparam.return1 TO pmdnorga  #顯示到畫面上

            NEXT FIELD pmdnorga                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnorga
            #add-point:BEFORE FIELD pmdnorga name="construct.b.page1.pmdnorga"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnorga
            
            #add-point:AFTER FIELD pmdnorga name="construct.a.page1.pmdnorga"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn049
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn049
            #add-point:ON ACTION controlp INFIELD pmdn049 name="construct.c.page1.pmdn049"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_acc
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn049  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdn049                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn049
            #add-point:BEFORE FIELD pmdn049 name="construct.b.page1.pmdn049"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn049
            
            #add-point:AFTER FIELD pmdn049 name="construct.a.page1.pmdn049"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn051
            #add-point:ON ACTION controlp INFIELD pmdn051 name="construct.c.page1.pmdn051"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "('258','317')"
            CALL q_oocq002_23()                       #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn051  #顯示到畫面上

            NEXT FIELD pmdn051                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn051
            #add-point:BEFORE FIELD pmdn051 name="construct.b.page1.pmdn051"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn051
            
            #add-point:AFTER FIELD pmdn051 name="construct.a.page1.pmdn051"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn054
            #add-point:BEFORE FIELD pmdn054 name="construct.b.page1.pmdn054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn054
            
            #add-point:AFTER FIELD pmdn054 name="construct.a.page1.pmdn054"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn054
            #add-point:ON ACTION controlp INFIELD pmdn054 name="construct.c.page1.pmdn054"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn055
            #add-point:BEFORE FIELD pmdn055 name="construct.b.page1.pmdn055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn055
            
            #add-point:AFTER FIELD pmdn055 name="construct.a.page1.pmdn055"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn055
            #add-point:ON ACTION controlp INFIELD pmdn055 name="construct.c.page1.pmdn055"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn056
            #add-point:BEFORE FIELD pmdn056 name="construct.b.page1.pmdn056"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn056
            
            #add-point:AFTER FIELD pmdn056 name="construct.a.page1.pmdn056"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn056
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn056
            #add-point:ON ACTION controlp INFIELD pmdn056 name="construct.c.page1.pmdn056"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn057
            #add-point:BEFORE FIELD pmdn057 name="construct.b.page1.pmdn057"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn057
            
            #add-point:AFTER FIELD pmdn057 name="construct.a.page1.pmdn057"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn057
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn057
            #add-point:ON ACTION controlp INFIELD pmdn057 name="construct.c.page1.pmdn057"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn050
            #add-point:BEFORE FIELD pmdn050 name="construct.b.page1.pmdn050"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn050
            
            #add-point:AFTER FIELD pmdn050 name="construct.a.page1.pmdn050"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdn050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn050
            #add-point:ON ACTION controlp INFIELD pmdn050 name="construct.c.page1.pmdn050"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD ooff013
            #add-point:BEFORE FIELD ooff013 name="construct.b.page1.ooff013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD ooff013
            
            #add-point:AFTER FIELD ooff013 name="construct.a.page1.ooff013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.ooff013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD ooff013
            #add-point:ON ACTION controlp INFIELD ooff013 name="construct.c.page1.ooff013"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdn027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn027
            #add-point:ON ACTION controlp INFIELD pmdn027 name="construct.c.page2.pmdn027"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmao004_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn027  #顯示到畫面上

            NEXT FIELD pmdn027                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn027
            #add-point:BEFORE FIELD pmdn027 name="construct.b.page2.pmdn027"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn027
            
            #add-point:AFTER FIELD pmdn027 name="construct.a.page2.pmdn027"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_pmao009
            #add-point:BEFORE FIELD l_pmao009 name="construct.b.page2.l_pmao009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_pmao009
            
            #add-point:AFTER FIELD l_pmao009 name="construct.a.page2.l_pmao009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.l_pmao009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_pmao009
            #add-point:ON ACTION controlp INFIELD l_pmao009 name="construct.c.page2.l_pmao009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_pmao010
            #add-point:BEFORE FIELD l_pmao010 name="construct.b.page2.l_pmao010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_pmao010
            
            #add-point:AFTER FIELD l_pmao010 name="construct.a.page2.l_pmao010"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.l_pmao010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_pmao010
            #add-point:ON ACTION controlp INFIELD l_pmao010 name="construct.c.page2.l_pmao010"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdn028
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn028
            #add-point:ON ACTION controlp INFIELD pmdn028 name="construct.c.page2.pmdn028"
                                    #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			
            CALL q_inaa001_6()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn028  #顯示到畫面上

            NEXT FIELD pmdn028                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn028
            #add-point:BEFORE FIELD pmdn028 name="construct.b.page2.pmdn028"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn028
            
            #add-point:AFTER FIELD pmdn028 name="construct.a.page2.pmdn028"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn029
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn029
            #add-point:ON ACTION controlp INFIELD pmdn029 name="construct.c.page2.pmdn029"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_inab002_6()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn029  #顯示到畫面上

            NEXT FIELD pmdn029                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn029
            #add-point:BEFORE FIELD pmdn029 name="construct.b.page2.pmdn029"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn029
            
            #add-point:AFTER FIELD pmdn029 name="construct.a.page2.pmdn029"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn030
            #add-point:BEFORE FIELD pmdn030 name="construct.b.page2.pmdn030"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn030
            
            #add-point:AFTER FIELD pmdn030 name="construct.a.page2.pmdn030"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn030
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn030
            #add-point:ON ACTION controlp INFIELD pmdn030 name="construct.c.page2.pmdn030"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn053
            #add-point:BEFORE FIELD pmdn053 name="construct.b.page2.pmdn053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn053
            
            #add-point:AFTER FIELD pmdn053 name="construct.a.page2.pmdn053"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn053
            #add-point:ON ACTION controlp INFIELD pmdn053 name="construct.c.page2.pmdn053"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdn025
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn025
            #add-point:ON ACTION controlp INFIELD pmdn025 name="construct.c.page2.pmdn025"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			#LET g_qryparam.arg1 = g_oofa001
			LET g_qryparam.where = " oofb008 = '3' "  #出貨地址
            CALL q_oofb019_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn025  #顯示到畫面上

            NEXT FIELD pmdn025                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn025
            #add-point:BEFORE FIELD pmdn025 name="construct.b.page2.pmdn025"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn025
            
            #add-point:AFTER FIELD pmdn025 name="construct.a.page2.pmdn025"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn026
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn026
            #add-point:ON ACTION controlp INFIELD pmdn026 name="construct.c.page2.pmdn026"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			#LET g_qryparam.arg1 = g_oofa001
			LET g_qryparam.where = " oofb008 = '5' "  #發票地址
            CALL q_oofb019_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn026  #顯示到畫面上

            NEXT FIELD pmdn026                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn026
            #add-point:BEFORE FIELD pmdn026 name="construct.b.page2.pmdn026"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn026
            
            #add-point:AFTER FIELD pmdn026 name="construct.a.page2.pmdn026"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn031
            #add-point:ON ACTION controlp INFIELD pmdn031 name="construct.c.page2.pmdn031"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = "263"
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn031  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oocq010 #參考欄位七 

            NEXT FIELD pmdn031                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn031
            #add-point:BEFORE FIELD pmdn031 name="construct.b.page2.pmdn031"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn031
            
            #add-point:AFTER FIELD pmdn031 name="construct.a.page2.pmdn031"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn032
            #add-point:BEFORE FIELD pmdn032 name="construct.b.page2.pmdn032"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn032
            
            #add-point:AFTER FIELD pmdn032 name="construct.a.page2.pmdn032"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn032
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn032
            #add-point:ON ACTION controlp INFIELD pmdn032 name="construct.c.page2.pmdn032"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn033
            #add-point:BEFORE FIELD pmdn033 name="construct.b.page2.pmdn033"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn033
            
            #add-point:AFTER FIELD pmdn033 name="construct.a.page2.pmdn033"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn033
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn033
            #add-point:ON ACTION controlp INFIELD pmdn033 name="construct.c.page2.pmdn033"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdn003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn003
            #add-point:ON ACTION controlp INFIELD pmdn003 name="construct.c.page2.pmdn003"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_imaf001_5()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn003  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO imaal003 #品名 

            NEXT FIELD pmdn003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn003
            #add-point:BEFORE FIELD pmdn003 name="construct.b.page2.pmdn003"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn003
            
            #add-point:AFTER FIELD pmdn003 name="construct.a.page2.pmdn003"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn036
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn036
            #add-point:ON ACTION controlp INFIELD pmdn036 name="construct.c.page2.pmdn036"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pjba001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn036  #顯示到畫面上
            NEXT FIELD pmdn036                     #返回原欄位
    
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn036
            #add-point:BEFORE FIELD pmdn036 name="construct.b.page2.pmdn036"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn036
            
            #add-point:AFTER FIELD pmdn036 name="construct.a.page2.pmdn036"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn037
            #add-point:ON ACTION controlp INFIELD pmdn037 name="construct.c.page2.pmdn037"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pjbb002_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn037  #顯示到畫面上
            NEXT FIELD pmdn037                     #返回原欄位
                          
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn037
            #add-point:BEFORE FIELD pmdn037 name="construct.b.page2.pmdn037"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn037
            
            #add-point:AFTER FIELD pmdn037 name="construct.a.page2.pmdn037"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn038
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn038
            #add-point:ON ACTION controlp INFIELD pmdn038 name="construct.c.page2.pmdn038"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pjbm002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdn038  #顯示到畫面上
            NEXT FIELD pmdn038                     #返回原欄位
    

            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn038
            #add-point:BEFORE FIELD pmdn038 name="construct.b.page2.pmdn038"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn038
            
            #add-point:AFTER FIELD pmdn038 name="construct.a.page2.pmdn038"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn058
            #add-point:BEFORE FIELD pmdn058 name="construct.b.page2.pmdn058"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn058
            
            #add-point:AFTER FIELD pmdn058 name="construct.a.page2.pmdn058"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn058
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn058
            #add-point:ON ACTION controlp INFIELD pmdn058 name="construct.c.page2.pmdn058"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn058_desc
            #add-point:BEFORE FIELD pmdn058_desc name="construct.b.page2.pmdn058_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn058_desc
            
            #add-point:AFTER FIELD pmdn058_desc name="construct.a.page2.pmdn058_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn058_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn058_desc
            #add-point:ON ACTION controlp INFIELD pmdn058_desc name="construct.c.page2.pmdn058_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn039
            #add-point:BEFORE FIELD pmdn039 name="construct.b.page2.pmdn039"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn039
            
            #add-point:AFTER FIELD pmdn039 name="construct.a.page2.pmdn039"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn039
            #add-point:ON ACTION controlp INFIELD pmdn039 name="construct.c.page2.pmdn039"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn035
            #add-point:BEFORE FIELD pmdn035 name="construct.b.page2.pmdn035"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn035
            
            #add-point:AFTER FIELD pmdn035 name="construct.a.page2.pmdn035"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn035
            #add-point:ON ACTION controlp INFIELD pmdn035 name="construct.c.page2.pmdn035"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn040
            #add-point:BEFORE FIELD pmdn040 name="construct.b.page2.pmdn040"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn040
            
            #add-point:AFTER FIELD pmdn040 name="construct.a.page2.pmdn040"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn040
            #add-point:ON ACTION controlp INFIELD pmdn040 name="construct.c.page2.pmdn040"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn041
            #add-point:BEFORE FIELD pmdn041 name="construct.b.page2.pmdn041"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn041
            
            #add-point:AFTER FIELD pmdn041 name="construct.a.page2.pmdn041"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn041
            #add-point:ON ACTION controlp INFIELD pmdn041 name="construct.c.page2.pmdn041"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn042
            #add-point:BEFORE FIELD pmdn042 name="construct.b.page2.pmdn042"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn042
            
            #add-point:AFTER FIELD pmdn042 name="construct.a.page2.pmdn042"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn042
            #add-point:ON ACTION controlp INFIELD pmdn042 name="construct.c.page2.pmdn042"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn043
            #add-point:BEFORE FIELD pmdn043 name="construct.b.page2.pmdn043"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn043
            
            #add-point:AFTER FIELD pmdn043 name="construct.a.page2.pmdn043"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn043
            #add-point:ON ACTION controlp INFIELD pmdn043 name="construct.c.page2.pmdn043"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn044
            #add-point:BEFORE FIELD pmdn044 name="construct.b.page2.pmdn044"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn044
            
            #add-point:AFTER FIELD pmdn044 name="construct.a.page2.pmdn044"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdn044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn044
            #add-point:ON ACTION controlp INFIELD pmdn044 name="construct.c.page2.pmdn044"
                        
            #END add-point
 
 
   
       
      END CONSTRUCT
      
      CONSTRUCT g_wc2_table2 ON pmdosite,pmdoseq,pmdoseq1,pmdo003,pmdo001,pmdo002,pmdo004,pmdo005,pmdoseq2, 
          pmdo006,pmdo028,pmdo029,pmdo011,pmdo012,pmdo013,pmdo010,pmdo014,pmdo009,pmdo015,pmdo016,pmdo017, 
          pmdo040,pmdo019,pmdo020,pmdo021,pmdo030,pmdo031,pmdo022,pmdo023,pmdo024,pmdo032,pmdo033,pmdo034, 
          pmdo025,pmdo026,pmdo027,pmdo041,pmdo042,pmdo043,pmdo044
           FROM s_detail3[1].pmdosite,s_detail3[1].pmdoseq,s_detail3[1].pmdoseq1,s_detail3[1].pmdo003, 
               s_detail3[1].pmdo001,s_detail3[1].pmdo002,s_detail3[1].pmdo004,s_detail3[1].pmdo005,s_detail3[1].pmdoseq2, 
               s_detail3[1].pmdo006,s_detail3[1].pmdo028,s_detail3[1].pmdo029,s_detail3[1].pmdo011,s_detail3[1].pmdo012, 
               s_detail3[1].pmdo013,s_detail3[1].pmdo010,s_detail3[1].pmdo014,s_detail3[1].pmdo009,s_detail3[1].pmdo015, 
               s_detail3[1].pmdo016,s_detail3[1].pmdo017,s_detail3[1].pmdo040,s_detail3[1].pmdo019,s_detail3[1].pmdo020, 
               s_detail3[1].pmdo021,s_detail3[1].pmdo030,s_detail3[1].pmdo031,s_detail3[1].pmdo022,s_detail3[1].pmdo023, 
               s_detail3[1].pmdo024,s_detail3[1].pmdo032,s_detail3[1].pmdo033,s_detail3[1].pmdo034,s_detail3[1].pmdo025, 
               s_detail3[1].pmdo026,s_detail3[1].pmdo027,s_detail3[1].pmdo041,s_detail3[1].pmdo042,s_detail3[1].pmdo043, 
               s_detail3[1].pmdo044
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body2.before_construct"
 
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 2)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdosite
            #add-point:BEFORE FIELD pmdosite name="construct.b.page3.pmdosite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdosite
            
            #add-point:AFTER FIELD pmdosite name="construct.a.page3.pmdosite"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdosite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdosite
            #add-point:ON ACTION controlp INFIELD pmdosite name="construct.c.page3.pmdosite"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdoseq
            #add-point:BEFORE FIELD pmdoseq name="construct.b.page3.pmdoseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdoseq
            
            #add-point:AFTER FIELD pmdoseq name="construct.a.page3.pmdoseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdoseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdoseq
            #add-point:ON ACTION controlp INFIELD pmdoseq name="construct.c.page3.pmdoseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdoseq1
            #add-point:BEFORE FIELD pmdoseq1 name="construct.b.page3.pmdoseq1"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdoseq1
            
            #add-point:AFTER FIELD pmdoseq1 name="construct.a.page3.pmdoseq1"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdoseq1
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdoseq1
            #add-point:ON ACTION controlp INFIELD pmdoseq1 name="construct.c.page3.pmdoseq1"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo003
            #add-point:BEFORE FIELD pmdo003 name="construct.b.page3.pmdo003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo003
            
            #add-point:AFTER FIELD pmdo003 name="construct.a.page3.pmdo003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo003
            #add-point:ON ACTION controlp INFIELD pmdo003 name="construct.c.page3.pmdo003"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo001
            #add-point:ON ACTION controlp INFIELD pmdo001 name="construct.c.page3.pmdo001"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmdo001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdo001  #顯示到畫面上

            NEXT FIELD pmdo001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo001
            #add-point:BEFORE FIELD pmdo001 name="construct.b.page3.pmdo001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo001
            
            #add-point:AFTER FIELD pmdo001 name="construct.a.page3.pmdo001"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo002
            #add-point:BEFORE FIELD pmdo002 name="construct.b.page3.pmdo002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo002
            
            #add-point:AFTER FIELD pmdo002 name="construct.a.page3.pmdo002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo002
            #add-point:ON ACTION controlp INFIELD pmdo002 name="construct.c.page3.pmdo002"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo004
            #add-point:ON ACTION controlp INFIELD pmdo004 name="construct.c.page3.pmdo004"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdo004  #顯示到畫面上

            NEXT FIELD pmdo004                     #返回原欄位



            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo004
            #add-point:BEFORE FIELD pmdo004 name="construct.b.page3.pmdo004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo004
            
            #add-point:AFTER FIELD pmdo004 name="construct.a.page3.pmdo004"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo005
            #add-point:BEFORE FIELD pmdo005 name="construct.b.page3.pmdo005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo005
            
            #add-point:AFTER FIELD pmdo005 name="construct.a.page3.pmdo005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo005
            #add-point:ON ACTION controlp INFIELD pmdo005 name="construct.c.page3.pmdo005"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdoseq2
            #add-point:BEFORE FIELD pmdoseq2 name="construct.b.page3.pmdoseq2"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdoseq2
            
            #add-point:AFTER FIELD pmdoseq2 name="construct.a.page3.pmdoseq2"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdoseq2
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdoseq2
            #add-point:ON ACTION controlp INFIELD pmdoseq2 name="construct.c.page3.pmdoseq2"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo006
            #add-point:BEFORE FIELD pmdo006 name="construct.b.page3.pmdo006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo006
            
            #add-point:AFTER FIELD pmdo006 name="construct.a.page3.pmdo006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo006
            #add-point:ON ACTION controlp INFIELD pmdo006 name="construct.c.page3.pmdo006"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo028
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo028
            #add-point:ON ACTION controlp INFIELD pmdo028 name="construct.c.page3.pmdo028"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdo028  #顯示到畫面上

            NEXT FIELD pmdo028

            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo028
            #add-point:BEFORE FIELD pmdo028 name="construct.b.page3.pmdo028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo028
            
            #add-point:AFTER FIELD pmdo028 name="construct.a.page3.pmdo028"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo029
            #add-point:BEFORE FIELD pmdo029 name="construct.b.page3.pmdo029"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo029
            
            #add-point:AFTER FIELD pmdo029 name="construct.a.page3.pmdo029"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo029
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo029
            #add-point:ON ACTION controlp INFIELD pmdo029 name="construct.c.page3.pmdo029"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo011
            #add-point:BEFORE FIELD pmdo011 name="construct.b.page3.pmdo011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo011
            
            #add-point:AFTER FIELD pmdo011 name="construct.a.page3.pmdo011"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo011
            #add-point:ON ACTION controlp INFIELD pmdo011 name="construct.c.page3.pmdo011"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo012
            #add-point:BEFORE FIELD pmdo012 name="construct.b.page3.pmdo012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo012
            
            #add-point:AFTER FIELD pmdo012 name="construct.a.page3.pmdo012"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo012
            #add-point:ON ACTION controlp INFIELD pmdo012 name="construct.c.page3.pmdo012"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo013
            #add-point:BEFORE FIELD pmdo013 name="construct.b.page3.pmdo013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo013
            
            #add-point:AFTER FIELD pmdo013 name="construct.a.page3.pmdo013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo013
            #add-point:ON ACTION controlp INFIELD pmdo013 name="construct.c.page3.pmdo013"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo010
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo010
            #add-point:ON ACTION controlp INFIELD pmdo010 name="construct.c.page3.pmdo010"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "274"
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdo010  #顯示到畫面上

            NEXT FIELD pmdo010                     #返回原欄位
            


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo010
            #add-point:BEFORE FIELD pmdo010 name="construct.b.page3.pmdo010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo010
            
            #add-point:AFTER FIELD pmdo010 name="construct.a.page3.pmdo010"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo014
            #add-point:BEFORE FIELD pmdo014 name="construct.b.page3.pmdo014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo014
            
            #add-point:AFTER FIELD pmdo014 name="construct.a.page3.pmdo014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo014
            #add-point:ON ACTION controlp INFIELD pmdo014 name="construct.c.page3.pmdo014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo009
            #add-point:BEFORE FIELD pmdo009 name="construct.b.page3.pmdo009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo009
            
            #add-point:AFTER FIELD pmdo009 name="construct.a.page3.pmdo009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo009
            #add-point:ON ACTION controlp INFIELD pmdo009 name="construct.c.page3.pmdo009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo015
            #add-point:BEFORE FIELD pmdo015 name="construct.b.page3.pmdo015"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo015
            
            #add-point:AFTER FIELD pmdo015 name="construct.a.page3.pmdo015"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo015
            #add-point:ON ACTION controlp INFIELD pmdo015 name="construct.c.page3.pmdo015"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo016
            #add-point:BEFORE FIELD pmdo016 name="construct.b.page3.pmdo016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo016
            
            #add-point:AFTER FIELD pmdo016 name="construct.a.page3.pmdo016"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo016
            #add-point:ON ACTION controlp INFIELD pmdo016 name="construct.c.page3.pmdo016"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo017
            #add-point:BEFORE FIELD pmdo017 name="construct.b.page3.pmdo017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo017
            
            #add-point:AFTER FIELD pmdo017 name="construct.a.page3.pmdo017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo017
            #add-point:ON ACTION controlp INFIELD pmdo017 name="construct.c.page3.pmdo017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo040
            #add-point:BEFORE FIELD pmdo040 name="construct.b.page3.pmdo040"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo040
            
            #add-point:AFTER FIELD pmdo040 name="construct.a.page3.pmdo040"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo040
            #add-point:ON ACTION controlp INFIELD pmdo040 name="construct.c.page3.pmdo040"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo019
            #add-point:BEFORE FIELD pmdo019 name="construct.b.page3.pmdo019"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo019
            
            #add-point:AFTER FIELD pmdo019 name="construct.a.page3.pmdo019"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo019
            #add-point:ON ACTION controlp INFIELD pmdo019 name="construct.c.page3.pmdo019"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo020
            #add-point:BEFORE FIELD pmdo020 name="construct.b.page3.pmdo020"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo020
            
            #add-point:AFTER FIELD pmdo020 name="construct.a.page3.pmdo020"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo020
            #add-point:ON ACTION controlp INFIELD pmdo020 name="construct.c.page3.pmdo020"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo021
            #add-point:BEFORE FIELD pmdo021 name="construct.b.page3.pmdo021"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo021
            
            #add-point:AFTER FIELD pmdo021 name="construct.a.page3.pmdo021"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo021
            #add-point:ON ACTION controlp INFIELD pmdo021 name="construct.c.page3.pmdo021"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo030
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo030
            #add-point:ON ACTION controlp INFIELD pmdo030 name="construct.c.page3.pmdo030"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdo030  #顯示到畫面上
            NEXT FIELD pmdo030                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo030
            #add-point:BEFORE FIELD pmdo030 name="construct.b.page3.pmdo030"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo030
            
            #add-point:AFTER FIELD pmdo030 name="construct.a.page3.pmdo030"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo031
            #add-point:BEFORE FIELD pmdo031 name="construct.b.page3.pmdo031"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo031
            
            #add-point:AFTER FIELD pmdo031 name="construct.a.page3.pmdo031"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo031
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo031
            #add-point:ON ACTION controlp INFIELD pmdo031 name="construct.c.page3.pmdo031"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo022
            #add-point:BEFORE FIELD pmdo022 name="construct.b.page3.pmdo022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo022
            
            #add-point:AFTER FIELD pmdo022 name="construct.a.page3.pmdo022"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo022
            #add-point:ON ACTION controlp INFIELD pmdo022 name="construct.c.page3.pmdo022"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo023
            #add-point:ON ACTION controlp INFIELD pmdo023 name="construct.c.page3.pmdo023"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #CALL q_oodb002_2()                           #呼叫開窗
            CALL q_oodb002_11()
            DISPLAY g_qryparam.return1 TO pmdo023  #顯示到畫面上
            NEXT FIELD pmdo023                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo023
            #add-point:BEFORE FIELD pmdo023 name="construct.b.page3.pmdo023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo023
            
            #add-point:AFTER FIELD pmdo023 name="construct.a.page3.pmdo023"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo024
            #add-point:BEFORE FIELD pmdo024 name="construct.b.page3.pmdo024"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo024
            
            #add-point:AFTER FIELD pmdo024 name="construct.a.page3.pmdo024"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo024
            #add-point:ON ACTION controlp INFIELD pmdo024 name="construct.c.page3.pmdo024"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo032
            #add-point:BEFORE FIELD pmdo032 name="construct.b.page3.pmdo032"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo032
            
            #add-point:AFTER FIELD pmdo032 name="construct.a.page3.pmdo032"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo032
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo032
            #add-point:ON ACTION controlp INFIELD pmdo032 name="construct.c.page3.pmdo032"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo033
            #add-point:BEFORE FIELD pmdo033 name="construct.b.page3.pmdo033"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo033
            
            #add-point:AFTER FIELD pmdo033 name="construct.a.page3.pmdo033"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo033
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo033
            #add-point:ON ACTION controlp INFIELD pmdo033 name="construct.c.page3.pmdo033"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo034
            #add-point:BEFORE FIELD pmdo034 name="construct.b.page3.pmdo034"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo034
            
            #add-point:AFTER FIELD pmdo034 name="construct.a.page3.pmdo034"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo034
            #add-point:ON ACTION controlp INFIELD pmdo034 name="construct.c.page3.pmdo034"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo025
            #add-point:BEFORE FIELD pmdo025 name="construct.b.page3.pmdo025"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo025
            
            #add-point:AFTER FIELD pmdo025 name="construct.a.page3.pmdo025"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo025
            #add-point:ON ACTION controlp INFIELD pmdo025 name="construct.c.page3.pmdo025"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdo026
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo026
            #add-point:ON ACTION controlp INFIELD pmdo026 name="construct.c.page3.pmdo026"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdo026  #顯示到畫面上
            NEXT FIELD pmdo026                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo026
            #add-point:BEFORE FIELD pmdo026 name="construct.b.page3.pmdo026"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo026
            
            #add-point:AFTER FIELD pmdo026 name="construct.a.page3.pmdo026"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo027
            #add-point:BEFORE FIELD pmdo027 name="construct.b.page3.pmdo027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo027
            
            #add-point:AFTER FIELD pmdo027 name="construct.a.page3.pmdo027"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo027
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo027
            #add-point:ON ACTION controlp INFIELD pmdo027 name="construct.c.page3.pmdo027"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo041
            #add-point:BEFORE FIELD pmdo041 name="construct.b.page3.pmdo041"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo041
            
            #add-point:AFTER FIELD pmdo041 name="construct.a.page3.pmdo041"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo041
            #add-point:ON ACTION controlp INFIELD pmdo041 name="construct.c.page3.pmdo041"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo042
            #add-point:BEFORE FIELD pmdo042 name="construct.b.page3.pmdo042"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo042
            
            #add-point:AFTER FIELD pmdo042 name="construct.a.page3.pmdo042"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo042
            #add-point:ON ACTION controlp INFIELD pmdo042 name="construct.c.page3.pmdo042"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo043
            #add-point:BEFORE FIELD pmdo043 name="construct.b.page3.pmdo043"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo043
            
            #add-point:AFTER FIELD pmdo043 name="construct.a.page3.pmdo043"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo043
            #add-point:ON ACTION controlp INFIELD pmdo043 name="construct.c.page3.pmdo043"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo044
            #add-point:BEFORE FIELD pmdo044 name="construct.b.page3.pmdo044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo044
            
            #add-point:AFTER FIELD pmdo044 name="construct.a.page3.pmdo044"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdo044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo044
            #add-point:ON ACTION controlp INFIELD pmdo044 name="construct.c.page3.pmdo044"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table3 ON pmdpsite,pmdpseq1,pmdp001,pmdp002,pmdp003,pmdp004,pmdp005,pmdp006,pmdp007, 
          pmdp008,pmdp009,pmdp021,pmdp022,pmdp023,pmdp024,pmdp025,pmdp026
           FROM s_detail4[1].pmdpsite,s_detail4[1].pmdpseq1,s_detail4[1].pmdp001,s_detail4[1].pmdp002, 
               s_detail4[1].pmdp003,s_detail4[1].pmdp004,s_detail4[1].pmdp005,s_detail4[1].pmdp006,s_detail4[1].pmdp007, 
               s_detail4[1].pmdp008,s_detail4[1].pmdp009,s_detail4[1].pmdp021,s_detail4[1].pmdp022,s_detail4[1].pmdp023, 
               s_detail4[1].pmdp024,s_detail4[1].pmdp025,s_detail4[1].pmdp026
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body3.before_construct"
                        
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 3)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdpsite
            #add-point:BEFORE FIELD pmdpsite name="construct.b.page4.pmdpsite"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdpsite
            
            #add-point:AFTER FIELD pmdpsite name="construct.a.page4.pmdpsite"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdpsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdpsite
            #add-point:ON ACTION controlp INFIELD pmdpsite name="construct.c.page4.pmdpsite"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdpseq
            #add-point:BEFORE FIELD pmdpseq name="construct.b.page4.pmdpseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdpseq
            
            #add-point:AFTER FIELD pmdpseq name="construct.a.page4.pmdpseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdpseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdpseq
            #add-point:ON ACTION controlp INFIELD pmdpseq name="construct.c.page4.pmdpseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdpseq1
            #add-point:BEFORE FIELD pmdpseq1 name="construct.b.page4.pmdpseq1"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdpseq1
            
            #add-point:AFTER FIELD pmdpseq1 name="construct.a.page4.pmdpseq1"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdpseq1
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdpseq1
            #add-point:ON ACTION controlp INFIELD pmdpseq1 name="construct.c.page4.pmdpseq1"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp001
            #add-point:BEFORE FIELD pmdp001 name="construct.b.page4.pmdp001"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp001
            
            #add-point:AFTER FIELD pmdp001 name="construct.a.page4.pmdp001"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp001
            #add-point:ON ACTION controlp INFIELD pmdp001 name="construct.c.page4.pmdp001"
                                    INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE

            CALL q_imaf001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdp001  #顯示到畫面上

            NEXT FIELD pmdp001
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp002
            #add-point:BEFORE FIELD pmdp002 name="construct.b.page4.pmdp002"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp002
            
            #add-point:AFTER FIELD pmdp002 name="construct.a.page4.pmdp002"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp002
            #add-point:ON ACTION controlp INFIELD pmdp002 name="construct.c.page4.pmdp002"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page4.pmdp003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp003
            #add-point:ON ACTION controlp INFIELD pmdp003 name="construct.c.page4.pmdp003"
                                    #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmdp003()     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdp003  #顯示到畫面上

            NEXT FIELD pmdp003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp003
            #add-point:BEFORE FIELD pmdp003 name="construct.b.page4.pmdp003"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp003
            
            #add-point:AFTER FIELD pmdp003 name="construct.a.page4.pmdp003"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp004
            #add-point:BEFORE FIELD pmdp004 name="construct.b.page4.pmdp004"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp004
            
            #add-point:AFTER FIELD pmdp004 name="construct.a.page4.pmdp004"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp004
            #add-point:ON ACTION controlp INFIELD pmdp004 name="construct.c.page4.pmdp004"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp005
            #add-point:BEFORE FIELD pmdp005 name="construct.b.page4.pmdp005"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp005
            
            #add-point:AFTER FIELD pmdp005 name="construct.a.page4.pmdp005"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp005
            #add-point:ON ACTION controlp INFIELD pmdp005 name="construct.c.page4.pmdp005"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp006
            #add-point:BEFORE FIELD pmdp006 name="construct.b.page4.pmdp006"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp006
            
            #add-point:AFTER FIELD pmdp006 name="construct.a.page4.pmdp006"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp006
            #add-point:ON ACTION controlp INFIELD pmdp006 name="construct.c.page4.pmdp006"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page4.pmdp007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp007
            #add-point:ON ACTION controlp INFIELD pmdp007 name="construct.c.page4.pmdp007"
                                    INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE

            CALL q_imaf001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdp007  #顯示到畫面上

            NEXT FIELD pmdp007
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp007
            #add-point:BEFORE FIELD pmdp007 name="construct.b.page4.pmdp007"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp007
            
            #add-point:AFTER FIELD pmdp007 name="construct.a.page4.pmdp007"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp008
            #add-point:BEFORE FIELD pmdp008 name="construct.b.page4.pmdp008"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp008
            
            #add-point:AFTER FIELD pmdp008 name="construct.a.page4.pmdp008"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp008
            #add-point:ON ACTION controlp INFIELD pmdp008 name="construct.c.page4.pmdp008"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp009
            #add-point:BEFORE FIELD pmdp009 name="construct.b.page4.pmdp009"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp009
            
            #add-point:AFTER FIELD pmdp009 name="construct.a.page4.pmdp009"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp009
            #add-point:ON ACTION controlp INFIELD pmdp009 name="construct.c.page4.pmdp009"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp021
            #add-point:BEFORE FIELD pmdp021 name="construct.b.page4.pmdp021"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp021
            
            #add-point:AFTER FIELD pmdp021 name="construct.a.page4.pmdp021"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp021
            #add-point:ON ACTION controlp INFIELD pmdp021 name="construct.c.page4.pmdp021"
                        
            #END add-point
 
 
         #Ctrlp:construct.c.page4.pmdp022
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp022
            #add-point:ON ACTION controlp INFIELD pmdp022 name="construct.c.page4.pmdp022"
                                    INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdp022  #顯示到畫面上

            NEXT FIELD pmdp022
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp022
            #add-point:BEFORE FIELD pmdp022 name="construct.b.page4.pmdp022"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp022
            
            #add-point:AFTER FIELD pmdp022 name="construct.a.page4.pmdp022"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp023
            #add-point:BEFORE FIELD pmdp023 name="construct.b.page4.pmdp023"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp023
            
            #add-point:AFTER FIELD pmdp023 name="construct.a.page4.pmdp023"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp023
            #add-point:ON ACTION controlp INFIELD pmdp023 name="construct.c.page4.pmdp023"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp024
            #add-point:BEFORE FIELD pmdp024 name="construct.b.page4.pmdp024"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp024
            
            #add-point:AFTER FIELD pmdp024 name="construct.a.page4.pmdp024"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp024
            #add-point:ON ACTION controlp INFIELD pmdp024 name="construct.c.page4.pmdp024"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp025
            #add-point:BEFORE FIELD pmdp025 name="construct.b.page4.pmdp025"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp025
            
            #add-point:AFTER FIELD pmdp025 name="construct.a.page4.pmdp025"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp025
            #add-point:ON ACTION controlp INFIELD pmdp025 name="construct.c.page4.pmdp025"
                        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp026
            #add-point:BEFORE FIELD pmdp026 name="construct.b.page4.pmdp026"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp026
            
            #add-point:AFTER FIELD pmdp026 name="construct.a.page4.pmdp026"
                        
            #END add-point
            
 
 
         #Ctrlp:construct.c.page4.pmdp026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp026
            #add-point:ON ACTION controlp INFIELD pmdp026 name="construct.c.page4.pmdp026"
                        
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table4 ON pmdmsite,pmdm001,pmdm014,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007, 
          pmdm008,pmdm009
           FROM s_detail6[1].pmdmsite,s_detail6[1].pmdm001,s_detail6[1].pmdm014,s_detail6[1].pmdm002, 
               s_detail6[1].pmdm003,s_detail6[1].pmdm004,s_detail6[1].pmdm005,s_detail6[1].pmdm006,s_detail6[1].pmdm007, 
               s_detail6[1].pmdm008,s_detail6[1].pmdm009
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body4.before_construct"
                        
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 4)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdmsite
            #add-point:BEFORE FIELD pmdmsite name="construct.b.page6.pmdmsite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdmsite
            
            #add-point:AFTER FIELD pmdmsite name="construct.a.page6.pmdmsite"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdmsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdmsite
            #add-point:ON ACTION controlp INFIELD pmdmsite name="construct.c.page6.pmdmsite"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm001
            #add-point:BEFORE FIELD pmdm001 name="construct.b.page6.pmdm001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm001
            
            #add-point:AFTER FIELD pmdm001 name="construct.a.page6.pmdm001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm001
            #add-point:ON ACTION controlp INFIELD pmdm001 name="construct.c.page6.pmdm001"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm014
            #add-point:BEFORE FIELD pmdm014 name="construct.b.page6.pmdm014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm014
            
            #add-point:AFTER FIELD pmdm014 name="construct.a.page6.pmdm014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm014
            #add-point:ON ACTION controlp INFIELD pmdm014 name="construct.c.page6.pmdm014"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page6.pmdm002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm002
            #add-point:ON ACTION controlp INFIELD pmdm002 name="construct.c.page6.pmdm002"
            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmad002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdm002  #顯示到畫面上

            NEXT FIELD pmdm002                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm002
            #add-point:BEFORE FIELD pmdm002 name="construct.b.page6.pmdm002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm002
            
            #add-point:AFTER FIELD pmdm002 name="construct.a.page6.pmdm002"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm003
            #add-point:BEFORE FIELD pmdm003 name="construct.b.page6.pmdm003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm003
            
            #add-point:AFTER FIELD pmdm003 name="construct.a.page6.pmdm003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm003
            #add-point:ON ACTION controlp INFIELD pmdm003 name="construct.c.page6.pmdm003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm004
            #add-point:BEFORE FIELD pmdm004 name="construct.b.page6.pmdm004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm004
            
            #add-point:AFTER FIELD pmdm004 name="construct.a.page6.pmdm004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm004
            #add-point:ON ACTION controlp INFIELD pmdm004 name="construct.c.page6.pmdm004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm005
            #add-point:BEFORE FIELD pmdm005 name="construct.b.page6.pmdm005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm005
            
            #add-point:AFTER FIELD pmdm005 name="construct.a.page6.pmdm005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm005
            #add-point:ON ACTION controlp INFIELD pmdm005 name="construct.c.page6.pmdm005"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm006
            #add-point:BEFORE FIELD pmdm006 name="construct.b.page6.pmdm006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm006
            
            #add-point:AFTER FIELD pmdm006 name="construct.a.page6.pmdm006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm006
            #add-point:ON ACTION controlp INFIELD pmdm006 name="construct.c.page6.pmdm006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm007
            #add-point:BEFORE FIELD pmdm007 name="construct.b.page6.pmdm007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm007
            
            #add-point:AFTER FIELD pmdm007 name="construct.a.page6.pmdm007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm007
            #add-point:ON ACTION controlp INFIELD pmdm007 name="construct.c.page6.pmdm007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm008
            #add-point:BEFORE FIELD pmdm008 name="construct.b.page6.pmdm008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm008
            
            #add-point:AFTER FIELD pmdm008 name="construct.a.page6.pmdm008"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm008
            #add-point:ON ACTION controlp INFIELD pmdm008 name="construct.c.page6.pmdm008"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdm009
            #add-point:BEFORE FIELD pmdm009 name="construct.b.page6.pmdm009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdm009
            
            #add-point:AFTER FIELD pmdm009 name="construct.a.page6.pmdm009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page6.pmdm009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdm009
            #add-point:ON ACTION controlp INFIELD pmdm009 name="construct.c.page6.pmdm009"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
 
      
 
      
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令) name="cs.add_cs"
      SUBDIALOG aoo_aooi360_01.aooi360_01_construct   #备注单身  #161031-00025#1      
      #end add-point
 
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段b_dialog name="cs.b_dialog"
         LET g_pmdn_d[1].pmdnseq = ""
         DISPLAY ARRAY g_pmdn_d TO s_detail1.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY
         LET g_pmdn3_d[1].pmdoseq1 = ""
         DISPLAY ARRAY g_pmdn3_d TO s_detail3.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY
         LET g_pmdn4_d[1].pmdpseq = ""
         DISPLAY ARRAY g_pmdn4_d TO s_detail4.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY         
         LET g_pmdn6_d[1].pmdm001 = ""
         DISPLAY ARRAY g_pmdn6_d TO s_detail6.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY         
         #end add-point  
 
      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
         IF NOT cl_null(ls_wc) THEN
            CALL util.JSON.parse(ls_wc, la_wc)
            INITIALIZE g_wc, g_wc2, g_wc2_table1, g_wc2_extend TO NULL
            INITIALIZE g_wc2_table2 TO NULL
 
            INITIALIZE g_wc2_table3 TO NULL
 
            INITIALIZE g_wc2_table4 TO NULL
 
 
            FOR li_idx = 1 TO la_wc.getLength()
               CASE
                  WHEN la_wc[li_idx].tableid = "pmdl_t" 
                     LET g_wc = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "pmdn_t" 
                     LET g_wc2_table1 = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "pmdo_t" 
                     LET g_wc2_table2 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "pmdp_t" 
                     LET g_wc2_table3 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "pmdm_t" 
                     LET g_wc2_table4 = la_wc[li_idx].wc
 
 
               END CASE
            END FOR
         END IF
    
      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   IF g_wc2_table2 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
   END IF
 
   IF g_wc2_table3 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
   END IF
 
   IF g_wc2_table4 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
   END IF
 
 
 
 
   
   #add-point:cs段結束前 name="cs.after_construct"
      
   #end add-point    
 
   IF INT_FLAG THEN
      RETURN
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.filter" >}
#應用 a50 樣板自動產生(Version:8)
#+ filter過濾功能
PRIVATE FUNCTION apmt500_filter()
   #add-point:filter段define name="filter.define_customerization"
   
   #end add-point   
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter.define"
      
   #end add-point   
   
   #add-point:Function前置處理  name="filter.pre_function"
   
   #end add-point
   
   #切換畫面
   IF NOT g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF   
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter.trim()
   LET g_wc_t = g_wc
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter_t, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON pmdldocno,pmdldocdt,pmdl001,pmdl002,pmdl003,pmdl004
                          FROM s_browse[1].b_pmdldocno,s_browse[1].b_pmdldocdt,s_browse[1].b_pmdl001, 
                              s_browse[1].b_pmdl002,s_browse[1].b_pmdl003,s_browse[1].b_pmdl004
 
         BEFORE CONSTRUCT
               DISPLAY apmt500_filter_parser('pmdldocno') TO s_browse[1].b_pmdldocno
            DISPLAY apmt500_filter_parser('pmdldocdt') TO s_browse[1].b_pmdldocdt
            DISPLAY apmt500_filter_parser('pmdl001') TO s_browse[1].b_pmdl001
            DISPLAY apmt500_filter_parser('pmdl002') TO s_browse[1].b_pmdl002
            DISPLAY apmt500_filter_parser('pmdl003') TO s_browse[1].b_pmdl003
            DISPLAY apmt500_filter_parser('pmdl004') TO s_browse[1].b_pmdl004
      
         #add-point:filter段cs_ctrl name="filter.cs_ctrl"
         
         #end add-point
      
      END CONSTRUCT
 
      #add-point:filter段add_cs name="filter.add_cs"
            
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog name="filter.b_dialog"
                  
         #end add-point  
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
      LET g_wc = g_wc , g_wc_filter
   ELSE
      LET g_wc_filter = g_wc_filter_t
      LET g_wc = g_wc_t
   END IF
 
      CALL apmt500_filter_show('pmdldocno')
   CALL apmt500_filter_show('pmdldocdt')
   CALL apmt500_filter_show('pmdl001')
   CALL apmt500_filter_show('pmdl002')
   CALL apmt500_filter_show('pmdl003')
   CALL apmt500_filter_show('pmdl004')
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.filter_parser" >}
#+ filter過濾功能
PRIVATE FUNCTION apmt500_filter_parser(ps_field)
   #add-point:filter段define name="filter_parser.define_customerization"
   
   #end add-point    
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter_parser.define"
      
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.filter_show" >}
#+ 顯示過濾條件
PRIVATE FUNCTION apmt500_filter_show(ps_field)
   DEFINE ps_field         STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.b_", ps_field
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = apmt500_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.query" >}
#+ 資料查詢QBE功能準備
PRIVATE FUNCTION apmt500_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point   
   DEFINE ls_wc STRING
   #add-point:query段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
      
   #end add-point   
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF   
   
   LET ls_wc = g_wc
   
   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()       
   CALL g_pmdn_d.clear()
   CALL g_pmdn2_d.clear()
   CALL g_pmdn3_d.clear()
   CALL g_pmdn4_d.clear()
   CALL g_pmdn6_d.clear()
 
   
   #add-point:query段other name="query.other"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#1   
   #end add-point   
   
   DISPLAY '' TO FORMONLY.idx
   DISPLAY '' TO FORMONLY.cnt
   DISPLAY '' TO FORMONLY.b_index
   DISPLAY '' TO FORMONLY.b_count
   DISPLAY '' TO FORMONLY.h_index
   DISPLAY '' TO FORMONLY.h_count
   
   CALL apmt500_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      #LET g_wc = ls_wc
      LET g_wc = " 1=2"
      CALL apmt500_browser_fill("")
      CALL apmt500_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化 
   LET g_detail_cnt  = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   LET g_detail_idx_list[1] = 1
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
   LET g_detail_idx_list[5] = 1
 
   LET g_error_show  = 1
   LET g_wc_filter   = ""
   LET l_ac = 1
   CALL FGL_SET_ARR_CURR(1)
      CALL apmt500_filter_show('pmdldocno')
   CALL apmt500_filter_show('pmdldocdt')
   CALL apmt500_filter_show('pmdl001')
   CALL apmt500_filter_show('pmdl002')
   CALL apmt500_filter_show('pmdl003')
   CALL apmt500_filter_show('pmdl004')
   CALL apmt500_browser_fill("F")
         
   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "-100" 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
   ELSE
      CALL apmt500_fetch("F") 
      #顯示單身筆數
      CALL apmt500_idx_chk()
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.fetch" >}
#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION apmt500_fetch(p_flag)
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point    
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fetch.define"
 
   #end add-point    
   
   #add-point:Function前置處理  name="fetch.pre_function"
   
   #end add-point
   
   IF g_browser_cnt = 0 THEN
      RETURN
   END IF
 
   #清空第二階單身
 
   
   CALL cl_ap_performance_next_start()
   CASE p_flag
      WHEN 'F' 
         LET g_current_idx = 1
      WHEN 'L'  
         LET g_current_idx = g_browser.getLength()              
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         LET g_no_ask = FALSE  
   END CASE 
 
   CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引
   
   LET g_current_row = g_current_idx
   LET g_detail_cnt = g_header_cnt                  
   
   #單身總筆數顯示
   IF g_detail_cnt > 0 THEN
      #若單身有資料時, idx至少為1
      IF g_detail_idx <= 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx  
   ELSE
      LET g_detail_idx = 0
      DISPLAY '' TO FORMONLY.idx    
   END IF
   
   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )
 
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #避免超出browser資料筆數上限
   IF g_current_idx > g_browser.getLength() THEN
      LET g_browser_idx = g_browser.getLength()
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_pmdl_m.pmdldocno = g_browser[g_current_idx].b_pmdldocno
 
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
       g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
       g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
       g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
       g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
       g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
       g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
       g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
       g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
       g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
       g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid_desc, 
       g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc
   
   #遮罩相關處理
   LET g_pmdl_m_mask_o.* =  g_pmdl_m.*
   CALL apmt500_pmdl_t_mask()
   LET g_pmdl_m_mask_n.* =  g_pmdl_m.*
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt500_set_act_visible()   
   CALL apmt500_set_act_no_visible()
   
   #add-point:fetch段action控制 name="fetch.action_control"
 
   #end add-point  
   
   
   
   #add-point:fetch結束前 name="fetch.after"
      
   #end add-point
   
   #保存單頭舊值
   LET g_pmdl_m_t.* = g_pmdl_m.*
   LET g_pmdl_m_o.* = g_pmdl_m.*
   
   LET g_data_owner = g_pmdl_m.pmdlownid      
   LET g_data_dept  = g_pmdl_m.pmdlowndp
   
   #重新顯示   
   CALL apmt500_show()
 
   #應用 a56 樣板自動產生(Version:3)
   #檢查此單據是否需顯示BPM簽核狀況按鈕 
   IF cl_bpm_chk() THEN
      CALL cl_set_act_visible("bpm_status",TRUE)
   ELSE
      CALL cl_set_act_visible("bpm_status",FALSE)
   END IF
 
 
 
 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.insert" >}
#+ 資料新增
PRIVATE FUNCTION apmt500_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"
   
   #end add-point    
   #add-point:insert段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"
DEFINE l_success  LIKE type_t.num5
   #end add-point    
   
   #add-point:Function前置處理  name="insert.pre_function"
   
   #end add-point
   
   #清畫面欄位內容
   CLEAR FORM                    
   CALL g_pmdn_d.clear()   
   CALL g_pmdn2_d.clear()  
   CALL g_pmdn3_d.clear()  
   CALL g_pmdn4_d.clear()  
   CALL g_pmdn6_d.clear()  
 
 
   INITIALIZE g_pmdl_m.* TO NULL             #DEFAULT 設定
   
   LET g_pmdldocno_t = NULL
 
   
   LET g_master_insert = FALSE
   
   #add-point:insert段before name="insert.before"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#1
   #end add-point    
   
   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_pmdl_m.pmdlownid = g_user
      LET g_pmdl_m.pmdlowndp = g_dept
      LET g_pmdl_m.pmdlcrtid = g_user
      LET g_pmdl_m.pmdlcrtdp = g_dept 
      LET g_pmdl_m.pmdlcrtdt = cl_get_current()
      LET g_pmdl_m.pmdlmodid = g_user
      LET g_pmdl_m.pmdlmoddt = cl_get_current()
      LET g_pmdl_m.pmdlstus = 'N'
 
 
 
 
      #append欄位給值
      
     
      #一般欄位給值
            LET g_pmdl_m.pmdl001 = "0"
      LET g_pmdl_m.pmdlstus = "N"
      LET g_pmdl_m.pmdl005 = "1"
      LET g_pmdl_m.pmdl006 = "1"
      LET g_pmdl_m.pmdl007 = "1"
      LET g_pmdl_m.pmdl013 = "N"
      LET g_pmdl_m.pmdl019 = "Y"
      LET g_pmdl_m.pmdl054 = "1"
      LET g_pmdl_m.pmdl055 = "1"
      LET g_pmdl_m.pmdl030 = "N"
      LET g_pmdl_m.pmdl042 = "0"
      LET g_pmdl_m.pmdl047 = "N"
      LET g_pmdl_m.pmdl048 = "N"
      LET g_pmdl_m.pmdl049 = "N"
      LET g_pmdl_m.pmdl046 = "1"
      LET g_pmdl_m.pmdl040 = "0"
      LET g_pmdl_m.pmdl041 = "0"
 
  
      #add-point:單頭預設值 name="insert.default"
      LET g_pmdl_m.pmdlsite = g_site
      LET g_pmdl_m.pmdldocdt = g_today
      LET g_pmdl_m.pmdl002 = g_user
      CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
      DISPLAY BY NAME g_pmdl_m.pmdl002_desc
      
      LET g_pmdl_m.pmdl003 = g_dept
      CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
      DISPLAY BY NAME g_pmdl_m.pmdl003_desc
      
      #獲取當前營運據點的出貨地址、帳款地址
      CALL apmt500_get_oofb019(g_site) RETURNING g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc
      CALL apmt500_get_oofb019_5(g_site) RETURNING g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc
      DISPLAY BY NAME g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc
      #呼叫地址組合應用元件
      IF NOT cl_null(g_pmdl_m.pmdl025) THEN
         CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl025,g_lang) RETURNING l_success,g_pmdl_m.oofb017
      END IF
      IF NOT cl_null(g_pmdl_m.pmdl026) THEN
         CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl026,g_lang) RETURNING l_success,g_pmdl_m.oofb017_1
      END IF
      
      DISPLAY BY NAME g_pmdl_m.oofb017,g_pmdl_m.oofb017_1
      
      IF g_argv[1] = '1' THEN  #委外採購單
         LET g_pmdl_m.pmdl005 = '2'  #委外採購
         #LET g_pmdl_m.pmdl006 = '8'  #協作採購單 #160112-00012#1 mark
         LET g_pmdl_m.pmdl007 = '4'  #工單
      END IF
      
      IF g_argv[1] = '2' THEN  #重覆性生產委外採購單維護作業
         LET g_pmdl_m.pmdl005 = '5'  #重覆性生產委外採購
         LET g_pmdl_m.pmdl007 = '6'  #重覆性生產委外採購
      END IF
      
      IF g_argv[1] = '4' THEN  #借貨採購單維護作業
         LET g_pmdl_m.pmdl005 = '6'  #借貨採購
      END IF
      
      
      INITIALIZE g_pmdl_m_t.* TO NULL
      LET g_pmdl_m_t.* = g_pmdl_m.*
      
      LET g_pmdl_m_o.* = g_pmdl_m.*  #舊值備份
      
      #161031-00025#1---s
      LET g_ooff001_d = '6'   #6.單據單頭備註
      LET g_ooff002_d = g_prog
      LET g_ooff003_d = ''    #单号
      LET g_ooff004_d = 0     #项次
      LET g_ooff005_d = ' '
      LET g_ooff006_d = ' '
      LET g_ooff007_d = ' '
      LET g_ooff008_d = ' '
      LET g_ooff009_d = ' '
      LET g_ooff010_d = ' '
      LET g_ooff011_d = ' '
      #161031-00025#1---e
      #end add-point 
      
      #保存單頭舊值(用於資料輸入錯誤還原預設值時使用)
      LET g_pmdl_m_t.* = g_pmdl_m.*
      LET g_pmdl_m_o.* = g_pmdl_m.*
      
      #顯示狀態(stus)圖片
            #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmdl_m.pmdlstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "H"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/hold.png")
         WHEN "C"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/closed.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "UH"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unhold.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
 
 
 
    
      CALL apmt500_input("a")
      
      #add-point:單頭輸入後 name="insert.after_insert"
      #160719-00001#1--s
      #供应商的一次交易对象或内部员工时，单头新增后，需更新pmak中的参考单号为单头完整单号
      UPDATE pmak_t SET pmak006 = g_pmdl_m.pmdldocno WHERE pmakent = g_enterprise AND pmak001 = g_pmdl_m.pmdl028
      IF INT_FLAG  AND (NOT cl_null(g_pmdl_m.pmdl028)) THEN
         DELETE FROM pmak_t WHERE pmakent = g_enterprise AND pmak001 = g_pmdl_m.pmdl028
      END IF
      #160719-00001#1--e      
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
      END IF
      
      IF NOT g_master_insert THEN
         DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
         DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
         INITIALIZE g_pmdl_m.* TO NULL
         INITIALIZE g_pmdn_d TO NULL
         INITIALIZE g_pmdn2_d TO NULL
         INITIALIZE g_pmdn3_d TO NULL
         INITIALIZE g_pmdn4_d TO NULL
         INITIALIZE g_pmdn6_d TO NULL
 
         #add-point:取消新增後 name="insert.cancel"
         
         #end add-point 
         CALL apmt500_show()
         RETURN
      END IF
      
      LET INT_FLAG = 0
      #CALL g_pmdn_d.clear()
      #CALL g_pmdn2_d.clear()
      #CALL g_pmdn3_d.clear()
      #CALL g_pmdn4_d.clear()
      #CALL g_pmdn6_d.clear()
 
 
      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE
        
   END WHILE
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt500_set_act_visible()   
   CALL apmt500_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " pmdlent = " ||g_enterprise|| " AND",
                      " pmdldocno = '", g_pmdl_m.pmdldocno, "' "
 
                      
   #add-point:組合新增資料的條件後 name="insert.after.add_browse"
   
   #end add-point
      
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL apmt500_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   CLOSE apmt500_cl
   
   CALL apmt500_idx_chk()
   
   #撈取異動後的資料(主要是帶出reference)
   EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
       g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
       g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
       g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
       g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
       g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
       g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
       g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
       g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
       g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
       g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid_desc, 
       g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc
   
   
   #遮罩相關處理
   LET g_pmdl_m_mask_o.* =  g_pmdl_m.*
   CALL apmt500_pmdl_t_mask()
   LET g_pmdl_m_mask_n.* =  g_pmdl_m.*
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004, 
       g_pmdl_m.pmdl004_desc,g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc, 
       g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008, 
       g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc,g_pmdl_m.pmdl052,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl053, 
       g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010,g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011, 
       g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc, 
       g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl017_desc, 
       g_pmdl_m.pmdl018,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc, 
       g_pmdl_m.pmdl043,g_pmdl_m.pmdl043_desc,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl051_desc, 
       g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.oofb017, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.oofb017_1,g_pmdl_m.pmdl029,g_pmdl_m.pmdl029_desc, 
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022,g_pmdl_m.pmdl022_desc,g_pmdl_m.pmdl032, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048, 
       g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.fflabel_1,g_pmdl_m.pmdl040,g_pmdl_m.fflabel_2, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlowndp_desc, 
       g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlcrtdt, 
       g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfid_desc, 
       g_pmdl_m.pmdlcnfdt
   
   #add-point:新增結束後 name="insert.after"
   CALL apmt500_show()   #161207-00033#27
   #end add-point 
   
   LET g_data_owner = g_pmdl_m.pmdlownid      
   LET g_data_dept  = g_pmdl_m.pmdlowndp
   
   #功能已完成,通報訊息中心
   CALL apmt500_msgcentre_notify('insert')
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.modify" >}
#+ 資料修改
PRIVATE FUNCTION apmt500_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"
   
   #end add-point    
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   DEFINE l_wc2_table1          STRING
   DEFINE l_wc2_table2   STRING
 
   DEFINE l_wc2_table3   STRING
 
   DEFINE l_wc2_table4   STRING
 
 
 
   #add-point:modify段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"
      
   #end add-point    
   
   #add-point:Function前置處理  name="modify.pre_function"
   
   #end add-point
   
   #保存單頭舊值
   LET g_pmdl_m_t.* = g_pmdl_m.*
   LET g_pmdl_m_o.* = g_pmdl_m.*
   
   IF g_pmdl_m.pmdldocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   ERROR ""
  
   LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
   CALL s_transaction_begin()
   
   OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt500_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE apmt500_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
       g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
       g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
       g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
       g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
       g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
       g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
       g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
       g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
       g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
       g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid_desc, 
       g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc
   
   #檢查是否允許此動作
   IF NOT apmt500_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_pmdl_m_mask_o.* =  g_pmdl_m.*
   CALL apmt500_pmdl_t_mask()
   LET g_pmdl_m_mask_n.* =  g_pmdl_m.*
   
   
   
   #add-point:modify段show之前 name="modify.before_show"
   
   #end add-point  
   
   #LET l_wc2_table1 = g_wc2_table1
   #LET g_wc2_table1 = " 1=1"
   #LET l_wc2_table2 = g_wc2_table2
   #LET l_wc2_table2 = " 1=1"
 
   #LET l_wc2_table3 = g_wc2_table3
   #LET l_wc2_table3 = " 1=1"
 
   #LET l_wc2_table4 = g_wc2_table4
   #LET l_wc2_table4 = " 1=1"
 
 
 
   
   CALL apmt500_show()
   #add-point:modify段show之後 name="modify.after_show"
   
   #end add-point
   
   #LET g_wc2_table1 = l_wc2_table1
   #LET  g_wc2_table2 = l_wc2_table2 
 
   #LET  g_wc2_table3 = l_wc2_table3 
 
   #LET  g_wc2_table4 = l_wc2_table4 
 
 
 
    
   WHILE TRUE
      LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
      
      #寫入修改者/修改日期資訊(單頭)
      LET g_pmdl_m.pmdlmodid = g_user 
LET g_pmdl_m.pmdlmoddt = cl_get_current()
LET g_pmdl_m.pmdlmodid_desc = cl_get_username(g_pmdl_m.pmdlmodid)
      
      #add-point:modify段修改前 name="modify.before_input"
      IF g_pmdl_m.pmdlstus MATCHES '[DR]' THEN 
         LET g_pmdl_m.pmdlstus = "N"
      END IF

      
      LET g_pmdl_m_o.* = g_pmdl_m.*  #舊值備份
      #end add-point
      
      #欄位更改
      LET g_loc = 'n'
      LET g_update = FALSE
      LET g_master_commit = "N"
      CALL apmt500_input("u")
      LET g_loc = 'n'
 
      #add-point:modify段修改後 name="modify.after_input"
            
      #end add-point
      
      IF g_update OR NOT INT_FLAG THEN
         #若有modid跟moddt則進行update
         UPDATE pmdl_t SET (pmdlmodid,pmdlmoddt) = (g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt)
          WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdldocno_t
 
      END IF
    
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         #若單頭無commit則還原
         IF g_master_commit = "N" THEN
            LET g_pmdl_m.* = g_pmdl_m_t.*
            CALL apmt500_show()
         END IF
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN
      END IF 
                  
      #若單頭key欄位有變更
      IF g_pmdl_m.pmdldocno != g_pmdl_m_t.pmdldocno
 
      THEN
         CALL s_transaction_begin()
         
         #add-point:單身fk修改前 name="modify.body.b_fk_update"
                  
         #end add-point
         
         #更新單身key值
         UPDATE pmdn_t SET pmdndocno = g_pmdl_m.pmdldocno
 
          WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m_t.pmdldocno
 
            
         #add-point:單身fk修改中 name="modify.body.m_fk_update"
                  
         #end add-point
 
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdn_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #add-point:單身fk修改後 name="modify.body.a_fk_update"
                  
         #end add-point
         
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update2"
                  
         #end add-point
         
         UPDATE pmdo_t
            SET pmdodocno = g_pmdl_m.pmdldocno
 
          WHERE pmdoent = g_enterprise AND
                pmdodocno = g_pmdldocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update2"
                  
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdo_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdo_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update2"
                  
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update3"
                  
         #end add-point
         
         UPDATE pmdp_t
            SET pmdpdocno = g_pmdl_m.pmdldocno
 
          WHERE pmdpent = g_enterprise AND
                pmdpdocno = g_pmdldocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update3"
                  
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdp_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update3"
                  
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update4"
                  
         #end add-point
         
         UPDATE pmdm_t
            SET pmdmdocno = g_pmdl_m.pmdldocno
 
          WHERE pmdment = g_enterprise AND
                pmdmdocno = g_pmdldocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update4"
                  
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdm_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdm_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update4"
                  
         #end add-point
 
 
         
 
         
         #UPDATE 多語言table key值
         
         
         
         
         
 
         CALL s_transaction_end('Y','0')
      END IF
    
      EXIT WHILE
   END WHILE
 
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt500_set_act_visible()   
   CALL apmt500_set_act_no_visible()
 
   #組合新增資料的條件
   LET g_add_browse = " pmdlent = " ||g_enterprise|| " AND",
                      " pmdldocno = '", g_pmdl_m.pmdldocno, "' "
 
   #填到對應位置
   CALL apmt500_browser_fill("")
 
   CLOSE apmt500_cl
   
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL apmt500_msgcentre_notify('modify')
 
END FUNCTION 
 
{</section>}
 
{<section id="apmt500.input" >}
#+ 資料輸入
PRIVATE FUNCTION apmt500_input(p_cmd)
   #add-point:input段define(客製用) name="input.define_customerization"
   
   #end add-point  
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num10                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num10                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num10
   DEFINE  l_i                   LIKE type_t.num10
   DEFINE  l_ac_t                LIKE type_t.num10
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num10
   DEFINE  li_reproduce_target   LIKE type_t.num10
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   #add-point:input段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="input.define"
   DEFINE  l_success    LIKE type_t.num5
   DEFINE  l_flag       LIKE type_t.num5
   DEFINE  l_errno      LIKE type_t.chr10
   DEFINE  l_pmaa004    LIKE pmaa_t.pmaa004
   DEFINE  l_ooef016    LIKE ooef_t.ooef016
   DEFINE  l_ooef004    LIKE ooef_t.ooef004
   DEFINE  l_rate       LIKE inaj_t.inaj014
   DEFINE  l_imaf173    LIKE imaf_t.imaf173
   DEFINE  l_imaf174    LIKE imaf_t.imaf174
   DEFINE  l_oofb002    LIKE oofb_t.oofb002
   DEFINE  l_ooef012    LIKE ooef_t.ooef012
   DEFINE  l_ooba002    LIKE ooba_t.ooba002
   DEFINE  l_sql        STRING
   DEFINE  l_sql1       STRING
   DEFINE  l_sql2       STRING
   DEFINE  l_xrcd113    LIKE xrcd_t.xrcd113
   DEFINE  l_xrcd114    LIKE xrcd_t.xrcd114
   DEFINE  l_xrcd115    LIKE xrcd_t.xrcd115
    DEFINE  l_inam          DYNAMIC ARRAY OF RECORD   #記錄產品特徵
              inam001      LIKE inam_t.inam001,
              inam002      LIKE inam_t.inam002,
              inam004      LIKE inam_t.inam004
                        END RECORD
   DEFINE l_imaa005        LIKE imaa_t.imaa005
   #161124-00048#9 mod-S
#   DEFINE l_pmdn           RECORD LIKE pmdn_t.*
   DEFINE l_pmdn RECORD  #採購單身明細檔
          pmdnent LIKE pmdn_t.pmdnent, #企业编号
          pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
          pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
          pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
          pmdnseq LIKE pmdn_t.pmdnseq, #项次
          pmdn001 LIKE pmdn_t.pmdn001, #料件编号
          pmdn002 LIKE pmdn_t.pmdn002, #产品特征
          pmdn003 LIKE pmdn_t.pmdn003, #包装容器
          pmdn004 LIKE pmdn_t.pmdn004, #作业编号
          pmdn005 LIKE pmdn_t.pmdn005, #作业序
          pmdn006 LIKE pmdn_t.pmdn006, #采购单位
          pmdn007 LIKE pmdn_t.pmdn007, #采购数量
          pmdn008 LIKE pmdn_t.pmdn008, #参考单位
          pmdn009 LIKE pmdn_t.pmdn009, #参考数量
          pmdn010 LIKE pmdn_t.pmdn010, #计价单位
          pmdn011 LIKE pmdn_t.pmdn011, #计价数量
          pmdn012 LIKE pmdn_t.pmdn012, #出货日期
          pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
          pmdn014 LIKE pmdn_t.pmdn014, #到库日期
          pmdn015 LIKE pmdn_t.pmdn015, #单价
          pmdn016 LIKE pmdn_t.pmdn016, #税种
          pmdn017 LIKE pmdn_t.pmdn017, #税率
          pmdn019 LIKE pmdn_t.pmdn019, #子件特性
          pmdn020 LIKE pmdn_t.pmdn020, #紧急度
          pmdn021 LIKE pmdn_t.pmdn021, #保税
          pmdn022 LIKE pmdn_t.pmdn022, #部分交货
          pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
          pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
          pmdn024 LIKE pmdn_t.pmdn024, #多交期
          pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
          pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
          pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
          pmdn028 LIKE pmdn_t.pmdn028, #收货库位
          pmdn029 LIKE pmdn_t.pmdn029, #收货储位
          pmdn030 LIKE pmdn_t.pmdn030, #收货批号
          pmdn031 LIKE pmdn_t.pmdn031, #运输方式
          pmdn032 LIKE pmdn_t.pmdn032, #取货模式
          pmdn033 LIKE pmdn_t.pmdn033, #备品率
          pmdn034 LIKE pmdn_t.pmdn034, #no use
          pmdn035 LIKE pmdn_t.pmdn035, #价格核决
          pmdn036 LIKE pmdn_t.pmdn036, #项目编号
          pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
          pmdn038 LIKE pmdn_t.pmdn038, #活动编号
          pmdn039 LIKE pmdn_t.pmdn039, #费用原因
          pmdn040 LIKE pmdn_t.pmdn040, #取价来源
          pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
          pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
          pmdn043 LIKE pmdn_t.pmdn043, #取出价格
          pmdn044 LIKE pmdn_t.pmdn044, #价差比
          pmdn045 LIKE pmdn_t.pmdn045, #行状态
          pmdn046 LIKE pmdn_t.pmdn046, #税前金额
          pmdn047 LIKE pmdn_t.pmdn047, #含税金额
          pmdn048 LIKE pmdn_t.pmdn048, #税额
          pmdn049 LIKE pmdn_t.pmdn049, #理由码
          pmdn050 LIKE pmdn_t.pmdn050, #备注
          pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
          pmdn052 LIKE pmdn_t.pmdn052, #检验否
          pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
          pmdn200 LIKE pmdn_t.pmdn200, #商品条码
          pmdn201 LIKE pmdn_t.pmdn201, #包装单位
          pmdn202 LIKE pmdn_t.pmdn202, #包装数量
          pmdn203 LIKE pmdn_t.pmdn203, #收货部门
          pmdn204 LIKE pmdn_t.pmdn204, #No Use
          pmdn205 LIKE pmdn_t.pmdn205, #要货组织
          pmdn206 LIKE pmdn_t.pmdn206, #库存量
          pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
          pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
          pmdn209 LIKE pmdn_t.pmdn209, #上月销量
          pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
          pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
          pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
          pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
          pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
          pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
          pmdn216 LIKE pmdn_t.pmdn216, #经营方式
          pmdn217 LIKE pmdn_t.pmdn217, #结算方式
          pmdn218 LIKE pmdn_t.pmdn218, #合同编号
          pmdn219 LIKE pmdn_t.pmdn219, #协议编号
          pmdn220 LIKE pmdn_t.pmdn220, #采购人员
          pmdn221 LIKE pmdn_t.pmdn221, #采购部门
          pmdn222 LIKE pmdn_t.pmdn222, #采购中心
          pmdn223 LIKE pmdn_t.pmdn223, #配送中心
          pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
          pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
          pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
          pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
          pmdn054 LIKE pmdn_t.pmdn054, #还料数量
          pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
          pmdn056 LIKE pmdn_t.pmdn056, #还价数量
          pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
          pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
          pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
          pmdn058 LIKE pmdn_t.pmdn058, #预算科目
          pmdn228 LIKE pmdn_t.pmdn228  #商品品类
   END RECORD
   #161124-00048#9 mod-E
   DEFINE l_pmdnseq        LIKE pmdn_t.pmdnseq
   DEFINE l_scc40          LIKE type_t.chr2
   DEFINE l_pmdp003        LIKE pmdp_t.pmdp003
   DEFINE l_pmdp004        LIKE pmdp_t.pmdp004
   DEFINE l_pmdp023        LIKE pmdp_t.pmdp023
   DEFINE l_pmdp009        LIKE pmdp_t.pmdp009
   DEFINE l_pmdp010        LIKE pmdp_t.pmdp010
   DEFINE l_pmdp022        LIKE pmdp_t.pmdp022
   DEFINE l_pmdp023_1      LIKE pmdp_t.pmdp023
   DEFINE l_oodb003        LIKE oodb_t.oodb003
   DEFINE l_oodb004        LIKE oodb_t.oodb004
   DEFINE l_ooef008        LIKE ooef_t.ooef008
   DEFINE l_ooef009        LIKE ooef_t.ooef009
   DEFINE l_oodbl004       LIKE oodbl_t.oodbl004  #稅別名稱
   DEFINE l_oodb005        LIKE oodb_t.oodb005    #含稅否
   DEFINE l_oodb006        LIKE oodb_t.oodb006    #稅率 
   DEFINE l_oodb011        LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定   
   DEFINE l_pmdn007        LIKE pmdn_t.pmdn007
   DEFINE l_seq            LIKE pmdn_t.pmdnseq
   DEFINE l_pmdpseq1       LIKE pmdp_t.pmdpseq1
   DEFINE l_amount         LIKE pmdn_t.pmdn007
   DEFINE l_pmdn006        LIKE pmdn_t.pmdn006
   DEFINE l_gzcbl004       LIKE gzcbl_t.gzcbl004 
   
   #ming 20150903 add ----------------------------------(S) 
   #科目預算 
   DEFINE l_slip           LIKE pmdl_t.pmdldocno
   DEFINE l_insert1        LIKE type_t.num5
   DEFINE l_errno_abg      LIKE gzze_t.gzze001
   DEFINE l_bgaf016        LIKE bgaf_t.bgaf016
   DEFINE l_pmdn058        LIKE pmdn_t.pmdn058
   DEFINE l_pmdn058_desc   LIKE type_t.chr500
   DEFINE l_pmdn058_desc_sql STRING
   #ming 20150903 add ----------------------------------(E) 
   #ming 20150906 add ----------------------------------(S) 
   DEFINE l_pmdldocno        LIKE pmdl_t.pmdldocno 
   #ming 20150906 add ----------------------------------(S) 
   DEFINE l_where          STRING #150909 earl add
   #160104-00017#1 20160108 add by ming -----(S) 
   DEFINE l_code_s_bas_0043  LIKE inac_t.inac003
   #160104-00017#1 20160108 add by ming -----(E) 
   
   DEFINE  l_ooba015       LIKE ooba_t.ooba015
   
   #160321-00037#1--add--begin----
   DEFINE l_pmdn008        LIKE pmdn_t.pmdn008
   DEFINE l_pmdn009        LIKE pmdn_t.pmdn009
   DEFINE l_pmdn010        LIKE pmdn_t.pmdn010
   DEFINE l_pmdn011        LIKE pmdn_t.pmdn011
   DEFINE l_pmdp023_o      LIKE pmdp_t.pmdp023
   DEFINE l_pmdn043        LIKE pmdn_t.pmdn043
   DEFINE l_pmdn040        LIKE pmdn_t.pmdn040
   DEFINE l_pmdn041        LIKE pmdn_t.pmdn041
   DEFINE l_pmdn042        LIKE pmdn_t.pmdn042
   DEFINE l_pmdn044        LIKE pmdn_t.pmdn044
   DEFINE l_pmdn046        LIKE pmdn_t.pmdn046
   DEFINE l_pmdn048        LIKE pmdn_t.pmdn048
   DEFINE l_pmdn047        LIKE pmdn_t.pmdn047
   DEFINE l_pmdn016        LIKE pmdn_t.pmdn016
   DEFINE l_pmdn004        LIKE pmdn_t.pmdn004
   DEFINE l_pmdn005        LIKE pmdn_t.pmdn005
   DEFINE l_pmdn024        LIKE pmdn_t.pmdn024
   DEFINE l_pmdn012        LIKE pmdn_t.pmdn012
   DEFINE l_pmdn013        LIKE pmdn_t.pmdn013
   DEFINE l_pmdn014        LIKE pmdn_t.pmdn014   
   #160321-00037#1--add--end----             
   DEFINE l_pmdn001        LIKE pmdn_t.pmdn001   #160905-00006#1
   DEFINE l_pmdn002        LIKE pmdn_t.pmdn002   #160905-00006#1   
   DEFINE l_pmdp024        LIKE pmdp_t.pmdp024   #160905-00006#1    
   DEFINE l_pmdb004        LIKE pmdb_t.pmdb004   #160905-00006#1
   DEFINE l_pmdb005        LIKE pmdb_t.pmdb005   #160905-00006#1
   DEFINE l_imea003        LIKE imea_t.imea003   #160908-00014#1
   DEFINE l_count_1        LIKE type_t.num5      #160913-00009#1 add
   DEFINE l_pmdl007        LIKE pmdl_t.pmdl007   #160913-00009#1 add
   DEFINE l_pmdl008        LIKE pmdl_t.pmdl008   #160913-00009#1 add
   #160920-00035#1---s
   #161114-00031#1--add--begin
   DEFINE l_count_2        LIKE type_t.num5 
   #161114-00031#1--add--end
   DEFINE l_pspcsite       LIKE pspc_t.pspcsite
   DEFINE l_pspc001        LIKE pspc_t.pspc001
   DEFINE l_pspc002        LIKE pspc_t.pspc002
   DEFINE l_pspc004        LIKE pspc_t.pspc004
   DEFINE l_pspc061        LIKE pspc_t.pspc061
   #160920-00035#1--e
   DEFINE l_length         LIKE type_t.num5
   DEFINE l_pmdp001        LIKE pmdp_t.pmdp001  #170208-00026#1 add
   DEFINE l_n1             LIKE type_t.num5     #170208-00026#1 add
   #end add-point  
   
   #add-point:Function前置處理  name="input.pre_function"
   
   #end add-point
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004, 
       g_pmdl_m.pmdl004_desc,g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc, 
       g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008, 
       g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc,g_pmdl_m.pmdl052,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl053, 
       g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010,g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011, 
       g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc, 
       g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl017_desc, 
       g_pmdl_m.pmdl018,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc, 
       g_pmdl_m.pmdl043,g_pmdl_m.pmdl043_desc,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl051_desc, 
       g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.oofb017, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.oofb017_1,g_pmdl_m.pmdl029,g_pmdl_m.pmdl029_desc, 
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022,g_pmdl_m.pmdl022_desc,g_pmdl_m.pmdl032, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048, 
       g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.fflabel_1,g_pmdl_m.pmdl040,g_pmdl_m.fflabel_2, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlowndp_desc, 
       g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlcrtdt, 
       g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfid_desc, 
       g_pmdl_m.pmdlcnfdt
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql name="input.define_sql"
      
   #end add-point 
   LET g_forupd_sql = "SELECT pmdnsite,pmdnseq,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006,pmdn007,pmdn008, 
       pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015,pmdn016,pmdn017,pmdn046, 
       pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022,pmdnunit,pmdnorga,pmdn049,pmdn051, 
       pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,pmdnseq,pmdn027,pmdn028,pmdn029,pmdn030,pmdn053,pmdn025, 
       pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036,pmdn037,pmdn038,pmdn058,pmdn039,pmdn035,pmdn040, 
       pmdn041,pmdn042,pmdn043,pmdn044 FROM pmdn_t WHERE pmdnent=? AND pmdndocno=? AND pmdnseq=? FOR  
       UPDATE"
   #add-point:input段define_sql name="input.after_define_sql"
      
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt500_bcl CURSOR FROM g_forupd_sql
   
   #add-point:input段define_sql name="input.define_sql2"
      
   #end add-point    
   LET g_forupd_sql = "SELECT pmdosite,pmdoseq,pmdoseq1,pmdo003,pmdo001,pmdo002,pmdo004,pmdo005,pmdoseq2, 
       pmdo006,pmdo028,pmdo029,pmdo011,pmdo012,pmdo013,pmdo010,pmdo014,pmdo009,pmdo015,pmdo016,pmdo017, 
       pmdo040,pmdo019,pmdo020,pmdo021,pmdo030,pmdo031,pmdo022,pmdo023,pmdo024,pmdo032,pmdo033,pmdo034, 
       pmdo025,pmdo026,pmdo027,pmdo041,pmdo042,pmdo043,pmdo044 FROM pmdo_t WHERE pmdoent=? AND pmdodocno=?  
       AND pmdoseq=? AND pmdoseq1=? AND pmdoseq2=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql2"
      
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt500_bcl2 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql3"
      
   #end add-point    
   LET g_forupd_sql = "SELECT pmdpsite,pmdpseq,pmdpseq1,pmdp001,pmdp002,pmdp003,pmdp004,pmdp005,pmdp006, 
       pmdp007,pmdp008,pmdp009,pmdp010,pmdp011,pmdp012,pmdp021,pmdp022,pmdp023,pmdp024,pmdp025,pmdp026  
       FROM pmdp_t WHERE pmdpent=? AND pmdpdocno=? AND pmdpseq=? AND pmdpseq1=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql3"
      
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt500_bcl3 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql4"
      
   #end add-point    
   LET g_forupd_sql = "SELECT pmdmsite,pmdm001,pmdm014,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007, 
       pmdm008,pmdm009 FROM pmdm_t WHERE pmdment=? AND pmdmdocno=? AND pmdm001=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql4"
      
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt500_bcl4 CURSOR FROM g_forupd_sql
 
 
   
 
 
   #add-point:input段define_sql name="input.other_sql"
      
   #end add-point 
 
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL apmt500_set_entry(p_cmd)
   #add-point:set_entry後 name="input.after_set_entry"
   
   #將單身輸入權限放入共用變數給嵌入的子程式用, 若子程式要自己控管, 還是可以從子程式中覆蓋掉值
   #161031-00025#1---s
   LET g_detail_insert = l_allow_insert
   LET g_detail_delete = l_allow_delete
   #161031-00025#1---e
   
   LET g_controlno = ''
   
   IF p_cmd = 'u' THEN   
      #取得銷售分類
      LET g_pmab039 = g_pmdl_m.pmdl024
      #取得稅別類型
      CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
        RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
      IF l_success THEN
         LET g_tax_app = l_oodb011
      END IF     
      #取得價格是否允許修改,修改容差率,價格超過容差率的處理方式,允許單價為0
       LET g_pmam003 = ''
       LET g_pmam006 = ''
       LET g_pmam002 = ''
       SELECT pmam003,pmam006,pmam002
         INTO g_pmam003,g_pmam006,g_pmam002
         FROM pmam_t       
        WHERE pmament = g_enterprise
          AND pmam001 = g_pmdl_m.pmdl017             
   END IF 

   CALL apmt500_set_no_required()
   CALL apmt500_set_required()

   #end add-point
   CALL apmt500_set_no_entry(p_cmd)
 
   DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002, 
       g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007, 
       g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010, 
       g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016, 
       g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044, 
       g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021, 
       g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030, 
       g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049, 
       g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041
   
   LET lb_reproduce = FALSE
   LET l_ac_t = 1
   
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
   
   #add-point:資料輸入前 name="input.before_input"
         #LET g_flag = FALSE
   #CALL apmt500_set_entry(p_cmd)
   #CALL apmt500_set_no_entry(p_cmd)
   LET g_errshow = 1
   
   LET l_ooef004 = ''
   SELECT ooef004 INTO l_ooef004 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
   
   
   #160805-00071#1--s
   #資料來源類型：新增時，僅顯示"1.無","8.預先採購單"二個選項，查詢、顯示時，才全部顯示
   IF p_cmd = 'a' OR g_pmdl_m.pmdl007 MATCHES '[18]' THEN
      CALL cl_set_combo_scc_part('pmdl007','2054','1,8')
   END IF
   #160805-00071#1--e
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
{</section>}
 
{<section id="apmt500.input.head" >}
      #單頭段
      INPUT BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002, 
          g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007, 
          g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010, 
          g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016, 
          g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044, 
          g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021, 
          g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030, 
          g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049, 
          g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION(master_input)
         
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmi004_01
            LET g_action_choice="open_apmi004_01"
            IF cl_auth_chk_act("open_apmi004_01") THEN
               
               #add-point:ON ACTION open_apmi004_01 name="input.master_input.open_apmi004_01"
               #20150505 modify by lixiang 150504-00013#5--add---
               #若輸入供應商的法人類型為'2:一次性交易'或是'4:內部員工'時，則自動串apmi004_01
               #維護一次性交易對項基本資料，維護完基本資料後會回傳一個一次性交易對象識別碼，
               #將識別碼值預設給pmdl028欄位
               IF NOT cl_null(g_pmdl_m.pmdl004) THEN
                  LET l_pmaa004 = ''
                  LET g_pmdl_m.pmdl028 = NULL #160418-00004#1 add
                  SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmdl_m.pmdl004
                  IF l_pmaa004 = '2' THEN   #一次性交易對象
                     CALL apmi004_01('1',g_pmdl_m.pmdl028,g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                  END IF
                  IF l_pmaa004 = '4' THEN   #內部員工
                     CALL apmi004_01('2',g_pmdl_m.pmdl028,g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                  END IF
               END IF
               #20150505 modify by lixiang 150504-00013#5---end---
               #END add-point
            END IF
 
 
 
 
     
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt500_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt500_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            CALL apmt500_set_entry(p_cmd)
            #add-point:資料輸入前 name="input.m.before_input"
            IF l_cmd_t = 'r' THEN
               CALL apmt500_reproduce_init()
            END IF            
            #end add-point
            CALL apmt500_set_no_entry(p_cmd)
    
                  #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdldocno
            
            #add-point:AFTER FIELD pmdldocno name="input.a.pmdldocno"
                                    #此段落由子樣板a05產生
            #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
            CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
            DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
            
            IF NOT cl_null(g_pmdl_m.pmdldocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmdl_m.pmdldocno != g_pmdldocno_t )) THEN 
                  #161109-00015#1 mod-S
                  IF NOT s_aooi200_chk_docno(g_site,g_pmdl_m.pmdldocno,g_pmdl_m.pmdldocdt,g_prog) THEN
                     LET g_pmdl_m.pmdldocno = g_pmdldocno_t
                     #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                     CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                     DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
                     NEXT FIELD CURRENT   
                  END IF
                  #161109-00015#1 mod-E
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdl_t WHERE "||"pmdlent = '" ||g_enterprise|| "' AND "||"pmdldocno = '"||g_pmdl_m.pmdldocno ||"'",'std-00004',0) THEN 
                     LET g_pmdl_m.pmdldocno = g_pmdldocno_t
                     #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                     CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc                   
                     DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #檢核輸入的單據別是否可以被key人員對應的控制組使用,'4' 為採購控制組類型
                  CALL s_control_chk_doc('1',g_pmdl_m.pmdldocno,'4',g_user,g_dept,'','') RETURNING l_success,l_flag
                  IF l_success THEN
                     IF NOT l_flag THEN
                        #INITIALIZE g_errparam TO NULL
                        #LET g_errparam.code = 'apm-00266'
                        #LET g_errparam.extend = g_pmdl_m.pmdldocno
                        #LET g_errparam.popup = TRUE
                        #CALL cl_err()

                        LET g_pmdl_m.pmdldocno = g_pmdldocno_t
                        #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                        CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                        DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
                        NEXT FIELD CURRENT
                     END IF
                  ELSE
                     LET g_pmdl_m.pmdldocno = g_pmdldocno_t
                     #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                     CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                     DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #161109-00015#1 marked-S
                  #IF NOT s_aooi200_chk_slip(g_site,'',g_pmdl_m.pmdldocno,g_prog) THEN
#                  IF NOT s_aooi200_chk_docno(g_site,g_pmdl_m.pmdldocno,g_pmdl_m.pmdldocdt,g_prog) THEN
#                     LET g_pmdl_m.pmdldocno = g_pmdldocno_t
#                     #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
#                     CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
#                     DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
#                     NEXT FIELD CURRENT   
#                  END IF
                  #161109-00015#1 marked-E
                  
                  #150909 earl add s
                  #檢核前後置單別的合理性
                  IF NOT cl_null(g_pmdl_m.pmdl008) THEN
                     IF NOT s_aooi210_check_doc(g_site,'',g_pmdl_m.pmdl008,g_pmdl_m.pmdldocno,'3','') THEN
                        LET g_pmdl_m.pmdldocno = g_pmdldocno_t
                        CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
                        DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
                        NEXT FIELD CURRENT 
                     END IF
                  END IF
                  #150909 earl add e
                  
               END IF
               CALL apmt500_get_col_default()   #取得欄位預設值
               
               #151210-00009#1  2015/12/30 By earl s
               IF apmt500_icac010_control() THEN
                  LET g_pmdl_m.pmdl006 = '2'  #代採購
                  LET g_pmdl_m_o.pmdl006 = g_pmdl_m.pmdl006
                  DISPLAY BY NAME g_pmdl_m.pmdl006
               END IF
               #151210-00009#1  2015/12/30 By earl e
               
            END IF
            CALL apmt500_set_entry(p_cmd)
            CALL apmt500_set_no_required()
            CALL apmt500_set_required()
            CALL apmt500_set_no_entry(p_cmd)


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdldocno
            #add-point:BEFORE FIELD pmdldocno name="input.b.pmdldocno"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdldocno
            #add-point:ON CHANGE pmdldocno name="input.g.pmdldocno"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl001
            #add-point:BEFORE FIELD pmdl001 name="input.b.pmdl001"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl001
            
            #add-point:AFTER FIELD pmdl001 name="input.a.pmdl001"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl001
            #add-point:ON CHANGE pmdl001 name="input.g.pmdl001"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdldocdt
            #add-point:BEFORE FIELD pmdldocdt name="input.b.pmdldocdt"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdldocdt
            
            #add-point:AFTER FIELD pmdldocdt name="input.a.pmdldocdt"
                                    #IF NOT cl_null(g_pmdl_m.pmdldocdt) THEN
            #   CALL s_aooi200_gen_docno(g_site,g_pmdl_m.pmdldocno,g_pmdl_m.pmdldocdt,g_prog) RETURNING l_success,g_pmdl_m.pmdldocno
            #   IF NOT l_success THEN
            #      CALL cl_err(g_pmdl_m.pmdldocno,'apm-00003',1)
            #      LET g_pmdl_m.pmdldocdt = g_pmdl_m_t.pmdldocdt
            #      DISPLAY g_pmdl_m.pmdldocdt TO pmdldocdt
            #      NEXT FIELD pmdldocno           
            #   END IF
            #ELSE
            #   NEXT FIELD pmdldocdt
            #END IF
            #LET g_flag = TRUE  #成功自动编号，关闭单据编号，日期栏位
            #CALL apmt500_set_entry(p_cmd)
            #CALL apmt500_set_no_entry(p_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdldocdt
            #add-point:ON CHANGE pmdldocdt name="input.g.pmdldocdt"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl004
            
            #add-point:AFTER FIELD pmdl004 name="input.a.pmdl004"
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl004) RETURNING g_pmdl_m.pmdl004_desc
            DISPLAY BY NAME g_pmdl_m.pmdl004_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl004) THEN 
               #IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmdl_m.pmdl004 != g_pmdl_m_o.pmdl004 OR cl_null(g_pmdl_m_o.pmdl004))) THEN 
               IF g_pmdl_m.pmdl004 != g_pmdl_m_o.pmdl004 OR cl_null(g_pmdl_m_o.pmdl004) THEN 
                  IF NOT apmt500_pmdl004_chk(g_pmdl_m.pmdl004) THEN
                     LET g_pmdl_m.pmdl004 = g_pmdl_m_o.pmdl004
                     CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl004) RETURNING g_pmdl_m.pmdl004_desc
                     DISPLAY BY NAME g_pmdl_m.pmdl004_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #如果供應商有修改，根據供應商帶值
                  CALL apmt500_pmdl004_desc()
                  
                  #若輸入供應商的法人類型為'2:一次性交易'或是'4:內部員工'時，則自動串apmi004_01
                  #維護一次性交易對項基本資料，維護完基本資料後會回傳一個一次性交易對象識別碼，
                  #將識別碼值預設給pmdl028欄位
                  LET l_pmaa004 = ''
                  LET g_pmdl_m.pmdl028 = NULL #160418-00004#1 add
                  SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmdl_m.pmdl004
                  IF l_pmaa004 = '2' THEN   #一次性交易對象
                     #20150505 modify by lixiang 150504-00013#5
                     #CALL apmi004_01('1','',g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                     CALL apmi004_01('1',g_pmdl_m.pmdl028,g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                  END IF
                  IF l_pmaa004 = '4' THEN   #內部員工
                     #20150505 modify by lixiang 150504-00013#5
                     #CALL apmi004_01('2','',g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                     CALL apmi004_01('2',g_pmdl_m.pmdl028,g_pmdl_m.pmdl004,g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdl028
                  END IF                    
               END IF
            END IF
            LET g_pmdl_m_o.pmdl004 = g_pmdl_m.pmdl004
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl004) RETURNING g_pmdl_m.pmdl004_desc
            DISPLAY BY NAME g_pmdl_m.pmdl004_desc
            #161207-00033#27-S
            IF g_pmdl_m.pmdl021 = g_pmdl_m.pmdl004 THEN
               LET g_pmdl_m.pmdl021_desc = g_pmdl_m.pmdl004_desc
            END IF  
            IF g_pmdl_m.pmdl022 = g_pmdl_m.pmdl004 THEN
               LET g_pmdl_m.pmdl022_desc = g_pmdl_m.pmdl004_desc
            END IF   
            IF g_pmdl_m.pmdl032 = g_pmdl_m.pmdl004 THEN
               LET g_pmdl_m.pmdl032_desc = g_pmdl_m.pmdl004_desc
            END IF   
            IF g_pmdl_m.pmdl052 = g_pmdl_m.pmdl004 THEN
               LET g_pmdl_m.pmdl052_desc = g_pmdl_m.pmdl004_desc
            END IF   
            DISPLAY BY NAME g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc,
                            g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl052_desc                
            #161207-00033#27-E            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl004
            #add-point:BEFORE FIELD pmdl004 name="input.b.pmdl004"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl004
            #add-point:ON CHANGE pmdl004 name="input.g.pmdl004"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl002
            
            #add-point:AFTER FIELD pmdl002 name="input.a.pmdl002"
                                    CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
            DISPLAY BY NAME g_pmdl_m.pmdl002_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl002) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmdl_m.pmdl002 != g_pmdl_m.pmdl002 OR cl_null(g_pmdl_m.pmdl002))) THEN
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmdl_m.pmdl002
   
                  #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"
                  #160318-00025#15 by 07900 --add-end
                  
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_ooag001") THEN
                     #檢查成功時後續處理
                     SELECT ooag003 INTO g_pmdl_m.pmdl003 FROM ooag_t WHERE ooagent = g_enterprise AND ooag001 = g_pmdl_m.pmdl002
                     CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
                     DISPLAY BY NAME g_pmdl_m.pmdl003_desc   
                  ELSE
                     #檢查失敗時後續處理
                     LET g_pmdl_m.pmdl002 = g_pmdl_m_t.pmdl002
                     CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
                     DISPLAY BY NAME g_pmdl_m.pmdl002_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl002
            #add-point:BEFORE FIELD pmdl002 name="input.b.pmdl002"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl002
            #add-point:ON CHANGE pmdl002 name="input.g.pmdl002"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl003
            
            #add-point:AFTER FIELD pmdl003 name="input.a.pmdl003"
                                    CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
            DISPLAY BY NAME g_pmdl_m.pmdl003_desc 
            
            IF NOT cl_null(g_pmdl_m.pmdl003) THEN 
               IF NOT apmt500_pmdl003_chk(g_pmdl_m.pmdl003) THEN
                  LET g_pmdl_m.pmdl003 = g_pmdl_m_t.pmdl003
                  CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl003_desc 
                  NEXT FIELD CURRENT
               END IF    
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl003
            #add-point:BEFORE FIELD pmdl003 name="input.b.pmdl003"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl003
            #add-point:ON CHANGE pmdl003 name="input.g.pmdl003"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlsite
            #add-point:BEFORE FIELD pmdlsite name="input.b.pmdlsite"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlsite
            
            #add-point:AFTER FIELD pmdlsite name="input.a.pmdlsite"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdlsite
            #add-point:ON CHANGE pmdlsite name="input.g.pmdlsite"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdlstus
            #add-point:BEFORE FIELD pmdlstus name="input.b.pmdlstus"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdlstus
            
            #add-point:AFTER FIELD pmdlstus name="input.a.pmdlstus"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdlstus
            #add-point:ON CHANGE pmdlstus name="input.g.pmdlstus"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl005
            #add-point:BEFORE FIELD pmdl005 name="input.b.pmdl005"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl005
            
            #add-point:AFTER FIELD pmdl005 name="input.a.pmdl005"
          
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl005
            #add-point:ON CHANGE pmdl005 name="input.g.pmdl005"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl006
            #add-point:BEFORE FIELD pmdl006 name="input.b.pmdl006"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl006
            
            #add-point:AFTER FIELD pmdl006 name="input.a.pmdl006"
            IF NOT cl_null(g_pmdl_m.pmdl006) THEN
               IF g_pmdl_m.pmdl006 <> g_pmdl_m_o.pmdl006 OR cl_null(g_pmdl_m_o.pmdl006) THEN
                  
                  #151210-00009#1  2015/12/30 By earl s
                  IF apmt500_icac010_control() THEN
                     IF g_pmdl_m.pmdl006 <> '2' AND g_pmdl_m.pmdl006 <> '3' AND g_pmdl_m.pmdl006 <> '4' THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code =  'axm-00742'  #多角單據流水號保持一致時，單別只能走對應的多角流程！
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        
                        LET g_pmdl_m.pmdl006 = g_pmdl_m_o.pmdl006
                        NEXT FIELD CURRENT
                     END IF
                     
                  END IF
                  #151210-00009#1  2015/12/30 By earl e
                  
                  LET g_pmdl_m.pmdl051 = ''
                  LET g_pmdl_m_o.pmdl051 = ''
                  LET g_pmdl_m.pmdl051_desc = ''
                  DISPLAY BY NAME g_pmdl_m.pmdl051
                  DISPLAY BY NAME g_pmdl_m.pmdl051_desc
               END IF
            ELSE
               LET g_pmdl_m.pmdl051 = ''
               LET g_pmdl_m_o.pmdl051 = ''
               LET g_pmdl_m.pmdl051_desc = ''
               DISPLAY BY NAME g_pmdl_m.pmdl051
               DISPLAY BY NAME g_pmdl_m.pmdl051_desc
            END IF
            
            LET g_pmdl_m_o.pmdl006 = g_pmdl_m.pmdl006
            
            CALL apmt500_set_entry(p_cmd)
            CALL apmt500_set_no_required()
            CALL apmt500_set_required()
            CALL apmt500_set_no_entry(p_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl006
            #add-point:ON CHANGE pmdl006 name="input.g.pmdl006"
                         
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl007
            #add-point:BEFORE FIELD pmdl007 name="input.b.pmdl007"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl007
            
            #add-point:AFTER FIELD pmdl007 name="input.a.pmdl007"
            IF g_pmdl_m.pmdl007 = '1' THEN
               LET g_pmdl_m.pmdl008 = ''
               DISPLAY BY NAME g_pmdl_m.pmdl008
            END IF
            
            #160831-00047#1--S
            IF g_pmdl_m.pmdl007 != g_pmdl_m_o.pmdl007 OR cl_null(g_pmdl_m_o.pmdl007) THEN 
               LET g_pmdl_m.pmdl008 = ''
               DISPLAY BY NAME g_pmdl_m.pmdl008
            END IF
            
            #160831-00047#1--E
            CALL apmt500_set_entry(p_cmd)
            CALL apmt500_set_no_required()
            CALL apmt500_set_required()
            CALL apmt500_set_no_entry(p_cmd)   

            LET g_pmdl_m_o.pmdl007 = g_pmdl_m.pmdl007   #160831-00047#1
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl007
            #add-point:ON CHANGE pmdl007 name="input.g.pmdl007"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl008
            #add-point:BEFORE FIELD pmdl008 name="input.b.pmdl008"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl008
            
            #add-point:AFTER FIELD pmdl008 name="input.a.pmdl008"
            IF NOT cl_null(g_pmdl_m.pmdl008) THEN 
               IF g_pmdl_m.pmdl008 != g_pmdl_m_o.pmdl008 OR cl_null(g_pmdl_m_o.pmdl008) THEN 
                  IF NOT apmt500_pmdl008_chk() THEN
                     LET g_pmdl_m.pmdl008 = g_pmdl_m_t.pmdl008
                     NEXT FIELD CURRENT
                  END IF
                  CALL apmt500_pmdl008_desc()
               END IF
            END IF
            #工单转入,带出工单的多角流程代碼，多角流程序號
            IF g_pmdl_m.pmdl007 = '4' THEN
               SELECT sfaa066,sfaa067 INTO g_pmdl_m.pmdl051,g_pmdl_m.pmdl031 FROM sfaa_t WHERE sfaaent = g_enterprise AND sfaadocno = g_pmdl_m.pmdl008
               DISPLAY BY NAME g_pmdl_m.pmdl051,g_pmdl_m.pmdl031
            END IF
            CALL apmt500_set_entry(p_cmd)
            CALL apmt500_set_no_required()
            CALL apmt500_set_required()
            CALL apmt500_set_no_entry(p_cmd)
            LET g_pmdl_m_o.pmdl008 = g_pmdl_m.pmdl008
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl008
            #add-point:ON CHANGE pmdl008 name="input.g.pmdl008"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl027
            
            #add-point:AFTER FIELD pmdl027 name="input.a.pmdl027"
            CALL apmt500_pmdl027_ref(g_pmdl_m.pmdl004,g_pmdl_m.pmdl027) RETURNING g_pmdl_m.pmdl027_desc
            DISPLAY BY NAME g_pmdl_m.pmdl027_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl027) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl004
               LET g_chkparam.arg2 = g_pmdl_m.pmdl027
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="apm-00257:sub-01302|apmi005|",cl_get_progname("apmi005",g_lang,"2"),"|:EXEPROGapmi005"
               #160318-00025#15 by 07900 --add-end 
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmaj002") THEN
                  #檢查成功時後續處理
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl027 = g_pmdl_m_t.pmdl027
                  CALL apmt500_pmdl027_ref(g_pmdl_m.pmdl004,g_pmdl_m.pmdl027) RETURNING g_pmdl_m.pmdl027_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl027_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl027
            #add-point:BEFORE FIELD pmdl027 name="input.b.pmdl027"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl027
            #add-point:ON CHANGE pmdl027 name="input.g.pmdl027"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl052
            
            #add-point:AFTER FIELD pmdl052 name="input.a.pmdl052"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdl052
            CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdl052_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdl052_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl052
            #add-point:BEFORE FIELD pmdl052 name="input.b.pmdl052"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl052
            #add-point:ON CHANGE pmdl052 name="input.g.pmdl052"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl053
            #add-point:BEFORE FIELD pmdl053 name="input.b.pmdl053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl053
            
            #add-point:AFTER FIELD pmdl053 name="input.a.pmdl053"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl053
            #add-point:ON CHANGE pmdl053 name="input.g.pmdl053"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl009
            
            #add-point:AFTER FIELD pmdl009 name="input.a.pmdl009"
            CALL apmt500_pmdl009_ref(g_pmdl_m.pmdl009) RETURNING g_pmdl_m.pmdl009_desc
            DISPLAY BY NAME g_pmdl_m.pmdl009_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl009) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl004
               LET g_chkparam.arg2 = g_pmdl_m.pmdl009

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmad002_1") THEN
                  #檢查成功時後續處理
                 
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl009 = g_pmdl_m_t.pmdl009
                  CALL apmt500_pmdl009_ref(g_pmdl_m.pmdl009) RETURNING g_pmdl_m.pmdl009_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl009_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            
            LET g_pmdl_m_o.pmdl009 = g_pmdl_m.pmdl009

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl009
            #add-point:BEFORE FIELD pmdl009 name="input.b.pmdl009"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl009
            #add-point:ON CHANGE pmdl009 name="input.g.pmdl009"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl010
            
            #add-point:AFTER FIELD pmdl010 name="input.a.pmdl010"
            CALL apmt500_pmdl010_ref(g_pmdl_m.pmdl010) RETURNING g_pmdl_m.pmdl010_desc
            DISPLAY BY NAME g_pmdl_m.pmdl010_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl010) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl010
               
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="apm-00070:sub-01302|apmi012|",cl_get_progname("apmi012",g_lang,"2"),"|:EXEPROGapmi012"
               LET g_chkparam.err_str[2] ="apm-00069:sub-01303|apmi012|",cl_get_progname("apmi012",g_lang,"2"),"|:EXEPROGapmi012"
               #160318-00025#15 by 07900 --add-end     
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_238") THEN
                  #檢查成功時後續處理F
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl010 = g_pmdl_m_t.pmdl010
                  CALL apmt500_pmdl010_ref(g_pmdl_m.pmdl010) RETURNING g_pmdl_m.pmdl010_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl010_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            
            LET g_pmdl_m_o.pmdl010 = g_pmdl_m.pmdl010

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl010
            #add-point:BEFORE FIELD pmdl010 name="input.b.pmdl010"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl010
            #add-point:ON CHANGE pmdl010 name="input.g.pmdl010"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl011
            
            #add-point:AFTER FIELD pmdl011 name="input.a.pmdl011"
            CALL apmt500_pmdl011_ref(g_pmdl_m.pmdl011) RETURNING g_pmdl_m.pmdl011_desc
            DISPLAY BY NAME g_pmdl_m.pmdl011_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl011) THEN
               IF g_pmdl_m.pmdl011 <> g_pmdl_m_o.pmdl011 OR cl_null(g_pmdl_m_o.pmdl011) THEN 
                  CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
                    RETURNING l_success,g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl013,g_pmdl_m.pmdl012,l_oodb011                         
                  IF NOT l_success THEN
                     LET g_pmdl_m.pmdl011 = g_pmdl_m_o.pmdl011
                     LET g_pmdl_m.pmdl012 = g_pmdl_m_o.pmdl012
                     LET g_pmdl_m.pmdl013 = g_pmdl_m_o.pmdl013
                     NEXT FIELD CURRENT                     
                  ELSE                    
                     LET g_tax_app = l_oodb011   
                  END IF
                  DISPLAY BY NAME g_pmdl_m.pmdl012,g_pmdl_m.pmdl013
               
               END IF

               LET g_pmdl_m_o.pmdl011 = g_pmdl_m.pmdl011
               LET g_pmdl_m_o.pmdl012 = g_pmdl_m.pmdl012
               LET g_pmdl_m_o.pmdl013 = g_pmdl_m.pmdl013
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl011
            #add-point:BEFORE FIELD pmdl011 name="input.b.pmdl011"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl011
            #add-point:ON CHANGE pmdl011 name="input.g.pmdl011"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl012
            #add-point:BEFORE FIELD pmdl012 name="input.b.pmdl012"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl012
            
            #add-point:AFTER FIELD pmdl012 name="input.a.pmdl012"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl012
            #add-point:ON CHANGE pmdl012 name="input.g.pmdl012"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl013
            #add-point:BEFORE FIELD pmdl013 name="input.b.pmdl013"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl013
            
            #add-point:AFTER FIELD pmdl013 name="input.a.pmdl013"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl013
            #add-point:ON CHANGE pmdl013 name="input.g.pmdl013"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl033
            
            #add-point:AFTER FIELD pmdl033 name="input.a.pmdl033"
                                    CALL apmt500_pmdl033_ref(g_pmdl_m.pmdl033) RETURNING g_pmdl_m.pmdl033_desc
            DISPLAY BY NAME g_pmdl_m.pmdl033_desc
            IF NOT cl_null(g_pmdl_m.pmdl033) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_ooef019
               LET g_chkparam.arg2 = g_pmdl_m.pmdl033

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_isac002_1") THEN
                  #檢查成功時後續處理
                  
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl033 = g_pmdl_m_t.pmdl033
                  CALL apmt500_pmdl033_ref(g_pmdl_m.pmdl033) RETURNING g_pmdl_m.pmdl033_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl033_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl033
            #add-point:BEFORE FIELD pmdl033 name="input.b.pmdl033"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl033
            #add-point:ON CHANGE pmdl033 name="input.g.pmdl033"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl015
            
            #add-point:AFTER FIELD pmdl015 name="input.a.pmdl015"
            CALL apmt500_pmdl015_ref(g_pmdl_m.pmdl015) RETURNING g_pmdl_m.pmdl015_desc
            DISPLAY BY NAME g_pmdl_m.pmdl015_desc
            IF NOT cl_null(g_pmdl_m.pmdl015) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_site
               LET g_chkparam.arg2 = g_pmdl_m.pmdl015
                
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00176:sub-01302|aooi150|",cl_get_progname("aooi150",g_lang,"2"),"|:EXEPROGaooi150"
               #160318-00025#15 by 07900 --add-end
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooaj002") THEN
                  #檢查成功時後續處理
                  LET l_ooef016 = ''
                  SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
                  #根據內外購獲取當前營運據點參數設置的汇率类型
                  LET l_scc40 = ''
                  IF g_pmdl_m.pmdl054 = '1' THEN   #內購
                     LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
                  END IF
                  IF g_pmdl_m.pmdl054 = '2' THEN   #外購
                     LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
                  END IF
                  IF NOT cl_null(l_scc40) THEN
                     CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmdl_m.pmdl015,l_ooef016,0,l_scc40) RETURNING g_pmdl_m.pmdl016
                     DISPLAY BY NAME g_pmdl_m.pmdl016
                  END IF
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl015 = g_pmdl_m_t.pmdl015
                  CALL apmt500_pmdl015_ref(g_pmdl_m.pmdl015) RETURNING g_pmdl_m.pmdl015_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl015_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            
            LET g_pmdl_m_o.pmdl015 = g_pmdl_m.pmdl015

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl015
            #add-point:BEFORE FIELD pmdl015 name="input.b.pmdl015"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl015
            #add-point:ON CHANGE pmdl015 name="input.g.pmdl015"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl016
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdl_m.pmdl016,"0","0","","","azz-00079",1) THEN
               NEXT FIELD pmdl016
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdl016 name="input.a.pmdl016"
                        
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl016
            #add-point:BEFORE FIELD pmdl016 name="input.b.pmdl016"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl016
            #add-point:ON CHANGE pmdl016 name="input.g.pmdl016"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl017
            
            #add-point:AFTER FIELD pmdl017 name="input.a.pmdl017"
            CALL apmt500_pmdl017_ref(g_pmdl_m.pmdl017) RETURNING g_pmdl_m.pmdl017_desc
            DISPLAY BY NAME g_pmdl_m.pmdl017_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl017) THEN 
               IF g_pmdl_m.pmdl017 != g_pmdl_m_o.pmdl017 OR g_pmdl_m_o.pmdl017 IS NULL THEN            
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmdl_m.pmdl017
                    #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="apm-00210:sub-01302|apmi130|",cl_get_progname("apmi130",g_lang,"2"),"|:EXEPROGapmi130"
                  #160318-00025#15 by 07900 --add-end   
                  
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_pmam001") THEN
                     #檢查成功時後續處理
                     #重新抓取價格是否允許修改,修改容差率,價格超過容差率的處理方式,允許單價為0
                     LET g_pmam003 = ''
                     LET g_pmam006 = ''
                     LET g_pmam002 = ''
                     SELECT pmam003,pmam006,pmam002
                       INTO g_pmam003,g_pmam006,g_pmam002
                       FROM pmam_t       
                      WHERE pmament = g_enterprise
                        AND pmam001 = g_pmdl_m.pmdl017 
                   
                  ELSE
                     #檢查失敗時後續處理
                     LET g_pmdl_m.pmdl017 = g_pmdl_m_t.pmdl017
                     CALL apmt500_pmdl017_ref(g_pmdl_m.pmdl017) RETURNING g_pmdl_m.pmdl017_desc
                     DISPLAY BY NAME g_pmdl_m.pmdl017_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            
            LET g_pmdl_m_o.pmdl017 = g_pmdl_m.pmdl017
            
            CALL apmt500_set_entry(p_cmd)
            CALL apmt500_set_no_required()
            CALL apmt500_set_required()
            CALL apmt500_set_no_entry(p_cmd)

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl017
            #add-point:BEFORE FIELD pmdl017 name="input.b.pmdl017"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl017
            #add-point:ON CHANGE pmdl017 name="input.g.pmdl017"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl018
            
            #add-point:AFTER FIELD pmdl018 name="input.a.pmdl018"
                                    CALL apmt500_pmdl018_ref(g_pmdl_m.pmdl018) RETURNING g_pmdl_m.pmdl018_desc
            DISPLAY BY NAME g_pmdl_m.pmdl018_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl018) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl018
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00194:sub-01302|aooi717|",cl_get_progname("aooi717",g_lang,"2"),"|:EXEPROGaooi717"
               #160318-00025#15 by 07900 --add-end    
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooid001") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl018 = g_pmdl_m_t.pmdl018
                  CALL apmt500_pmdl018_ref(g_pmdl_m.pmdl018) RETURNING g_pmdl_m.pmdl018_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl018_desc
                  NEXT FIELD CURRENT
               END IF   
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl018
            #add-point:BEFORE FIELD pmdl018 name="input.b.pmdl018"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl018
            #add-point:ON CHANGE pmdl018 name="input.g.pmdl018"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl019
            #add-point:BEFORE FIELD pmdl019 name="input.b.pmdl019"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl019
            
            #add-point:AFTER FIELD pmdl019 name="input.a.pmdl019"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl019
            #add-point:ON CHANGE pmdl019 name="input.g.pmdl019"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl023
            
            #add-point:AFTER FIELD pmdl023 name="input.a.pmdl023"
            CALL apmt500_pmdl023_ref(g_pmdl_m.pmdl023) RETURNING g_pmdl_m.pmdl023_desc
            DISPLAY BY NAME g_pmdl_m.pmdl023_desc
                  
            IF NOT cl_null(g_pmdl_m.pmdl023) THEN
               IF NOT apmt500_pmdl023_chk(g_pmdl_m.pmdl023) THEN
                  LET g_pmdl_m.pmdl023 = g_pmdl_m_t.pmdl023
                  CALL apmt500_pmdl023_ref(g_pmdl_m.pmdl023) RETURNING g_pmdl_m.pmdl023_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl023_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl023
            #add-point:BEFORE FIELD pmdl023 name="input.b.pmdl023"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl023
            #add-point:ON CHANGE pmdl023 name="input.g.pmdl023"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl043
            
            #add-point:AFTER FIELD pmdl043 name="input.a.pmdl043"
 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl043
            #add-point:BEFORE FIELD pmdl043 name="input.b.pmdl043"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl043
            #add-point:ON CHANGE pmdl043 name="input.g.pmdl043"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl044
            #add-point:BEFORE FIELD pmdl044 name="input.b.pmdl044"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl044
            
            #add-point:AFTER FIELD pmdl044 name="input.a.pmdl044"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl044
            #add-point:ON CHANGE pmdl044 name="input.g.pmdl044"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl051
            
            #add-point:AFTER FIELD pmdl051 name="input.a.pmdl051"
            CALL s_desc_get_icaa001_desc(g_pmdl_m.pmdl051) RETURNING g_pmdl_m.pmdl051_desc
            DISPLAY BY NAME g_pmdl_m.pmdl051_desc
            
            IF NOT cl_null(g_pmdl_m.pmdl051) THEN
               IF g_pmdl_m.pmdl051 <> g_pmdl_m_o.pmdl051 OR cl_null(g_pmdl_m_o.pmdl051) THEN
                  #此段落由子樣板a19產生
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  #呼叫檢查存在並帶值的library
                  #2:代採購
                  IF g_pmdl_m.pmdl006 = '2' THEN
                     #設定g_chkparam.*的參數
                     LET g_chkparam.arg1 = g_pmdl_m.pmdl051
                     LET g_chkparam.arg2 = '2'
                     LET g_chkparam.arg3 = '0'
                     LET g_chkparam.arg4 = g_site
                     
                     #替換錯誤訊息
                     LET l_gzcbl004 = ''
                     SELECT gzcbl004 INTO l_gzcbl004
                       FROM gzcbl_t
                      WHERE gzcbl001 = '2501'
                        AND gzcbl002 = '2'
                        AND gzcbl003 = g_dlang
                     LET l_gzcbl004 = g_chkparam.arg2,".",l_gzcbl004
                     LET g_chkparam.err_str[1] = "aic-00084|",l_gzcbl004
                     LET g_chkparam.err_str[2] = "aic-00085|",g_chkparam.arg3
                   
                  END IF
                  #3:代採購指定供應商
                  IF g_pmdl_m.pmdl006 = '3' THEN
                     #設定g_chkparam.*的參數
                     LET g_chkparam.arg1 = g_pmdl_m.pmdl051
                     LET g_chkparam.arg2 = '3'
                     LET g_chkparam.arg3 = '0'
                     LET g_chkparam.arg4 = g_site
                     
                     #替換錯誤訊息
                     LET l_gzcbl004 = ''
                     SELECT gzcbl004 INTO l_gzcbl004
                       FROM gzcbl_t
                      WHERE gzcbl001 = '2501'
                        AND gzcbl002 = '3'
                        AND gzcbl003 = g_dlang
                     LET l_gzcbl004 = g_chkparam.arg2,".",l_gzcbl004
                     LET g_chkparam.err_str[1] = "aic-00084|",l_gzcbl004
                     LET g_chkparam.err_str[2] = "aic-00085|",g_chkparam.arg3
                     
                  END IF
                  #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[3] ="aic-00012:sub-01302|aici100|",cl_get_progname("aici100",g_lang,"2"),"|:EXEPROGaici100"
                  #160318-00025#15 by 07900 --add-end
                                    
                  IF NOT cl_chk_exist("v_icaa001_1") THEN
                     LET g_pmdl_m.pmdl051 = g_pmdl_m_o.pmdl051
                     CALL s_desc_get_icaa001_desc(g_pmdl_m.pmdl051) RETURNING g_pmdl_m.pmdl051_desc
                     DISPLAY BY NAME g_pmdl_m.pmdl051_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #151229 earl add s
                  #多角製造批序號檢查
                  IF NOT s_apmt500_inao_chk(g_pmdl_m.pmdldocno,g_pmdl_m.pmdl051,'') THEN
                     LET g_pmdl_m.pmdl051 = g_pmdl_m_o.pmdl051
                     CALL s_desc_get_icaa001_desc(g_pmdl_m.pmdl051) RETURNING g_pmdl_m.pmdl051_desc
                     DISPLAY BY NAME g_pmdl_m.pmdl051_desc
                     
                     NEXT FIELD CURRENT
                  END IF
                  #151229 earl add e

               END IF
            END IF
            
            LET g_pmdl_m_o.pmdl051 = g_pmdl_m.pmdl051
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl051
            #add-point:BEFORE FIELD pmdl051 name="input.b.pmdl051"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl051
            #add-point:ON CHANGE pmdl051 name="input.g.pmdl051"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl020
            
            #add-point:AFTER FIELD pmdl020 name="input.a.pmdl020"
                                    CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc
            DISPLAY BY NAME g_pmdl_m.pmdl020_desc
            IF NOT cl_null(g_pmdl_m.pmdl020) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl020
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_263") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl020 = g_pmdl_m_t.pmdl020
                  CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl020_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl020
            #add-point:BEFORE FIELD pmdl020 name="input.b.pmdl020"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl020
            #add-point:ON CHANGE pmdl020 name="input.g.pmdl020"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl025
            
            #add-point:AFTER FIELD pmdl025 name="input.a.pmdl025"
            CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
            DISPLAY BY NAME g_pmdl_m.pmdl025_desc
            IF NOT cl_null(g_pmdl_m.pmdl025) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_oofa001
               LET g_chkparam.arg2 = g_pmdl_m.pmdl025
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="anm-00025:sub-01302|aooi350|",cl_get_progname("aooi350",g_lang,"2"),"|:EXEPROGaooi350"
               #160318-00025#15 by 07900 --add-end    
               
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oofb019_1") THEN
                  #檢查成功時後續處理
                  #呼叫地址組合應用元件，將組合好的聯絡地址顯示在下方

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl025 = g_pmdl_m_t.pmdl025
                  CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl025_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            #呼叫地址組合應用元件
            IF NOT cl_null(g_pmdl_m.pmdl025) THEN
               CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl025,g_lang) RETURNING l_success,g_pmdl_m.oofb017
            END IF
            DISPLAY BY NAME g_pmdl_m.oofb017
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl025
            #add-point:BEFORE FIELD pmdl025 name="input.b.pmdl025"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl025
            #add-point:ON CHANGE pmdl025 name="input.g.pmdl025"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl026
            
            #add-point:AFTER FIELD pmdl026 name="input.a.pmdl026"
            CALL apmt500_pmdl026_ref(g_pmdl_m.pmdl026) RETURNING g_pmdl_m.pmdl026_desc
            DISPLAY BY NAME g_pmdl_m.pmdl026_desc
            IF NOT cl_null(g_pmdl_m.pmdl026) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_oofa001
               LET g_chkparam.arg2 = g_pmdl_m.pmdl026
                 #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="anm-00025:sub-01302|aooi350|",cl_get_progname("aooi350",g_lang,"2"),"|:EXEPROGaooi350"
               #160318-00025#15 by 07900 --add-end   
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oofb019_2") THEN
                  #檢查成功時後續處理
                  #呼叫地址組合應用元件，將組合好的聯絡地址顯示在下方

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl026 = g_pmdl_m_t.pmdl026
                  CALL apmt500_pmdl026_ref(g_pmdl_m.pmdl026) RETURNING g_pmdl_m.pmdl026_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl026_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            #呼叫地址組合應用元件
            IF NOT cl_null(g_pmdl_m.pmdl026) THEN
               CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl026,g_lang) RETURNING l_success,g_pmdl_m.oofb017_1
            END IF
            DISPLAY BY NAME g_pmdl_m.oofb017_1
      
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl026
            #add-point:BEFORE FIELD pmdl026 name="input.b.pmdl026"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl026
            #add-point:ON CHANGE pmdl026 name="input.g.pmdl026"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl029
            
            #add-point:AFTER FIELD pmdl029 name="input.a.pmdl029"
                                    CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl029) RETURNING g_pmdl_m.pmdl029_desc
            DISPLAY BY NAME g_pmdl_m.pmdl029_desc 
            
            IF NOT cl_null(g_pmdl_m.pmdl029) THEN 
               IF NOT apmt500_pmdl003_chk(g_pmdl_m.pmdl029) THEN
                  LET g_pmdl_m.pmdl029 = g_pmdl_m_t.pmdl029
                  CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl029) RETURNING g_pmdl_m.pmdl029_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl029_desc 
                  NEXT FIELD CURRENT
               END IF    
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl029
            #add-point:BEFORE FIELD pmdl029 name="input.b.pmdl029"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl029
            #add-point:ON CHANGE pmdl029 name="input.g.pmdl029"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl021
            
            #add-point:AFTER FIELD pmdl021 name="input.a.pmdl021"
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
            DISPLAY BY NAME g_pmdl_m.pmdl021_desc 
            
            IF NOT cl_null(g_pmdl_m.pmdl021) AND (g_pmdl_m.pmdl021 != g_pmdl_m.pmdl004) THEN 
               IF NOT apmt500_pmdl004_chk(g_pmdl_m.pmdl021) THEN
                  LET g_pmdl_m.pmdl021 = g_pmdl_m_t.pmdl021
                  CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl021_desc
                  NEXT FIELD CURRENT
               END IF
               
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
                #160318-00025#15 by 07900 --add-str 
                LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl004
               LET g_chkparam.arg2 = g_pmdl_m.pmdl021
               LET g_chkparam.arg3 = g_site

               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="axr-00049:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmac002") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl021 = g_pmdl_m_t.pmdl021
                  CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl021_desc 
                  NEXT FIELD CURRENT
               END IF  
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl021
            #add-point:BEFORE FIELD pmdl021 name="input.b.pmdl021"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl021
            #add-point:ON CHANGE pmdl021 name="input.g.pmdl021"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl022
            
            #add-point:AFTER FIELD pmdl022 name="input.a.pmdl022"
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
            DISPLAY BY NAME g_pmdl_m.pmdl022_desc 
            
            IF NOT cl_null(g_pmdl_m.pmdl022) AND (g_pmdl_m.pmdl022 != g_pmdl_m.pmdl004) THEN 
               IF NOT apmt500_pmdl004_chk(g_pmdl_m.pmdl022) THEN
                  LET g_pmdl_m.pmdl022 = g_pmdl_m_t.pmdl022
                  CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl022_desc
                  NEXT FIELD CURRENT
               END IF
               
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
                #160318-00025#15 by 07900 --add-str 
                LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl004
               LET g_chkparam.arg2 = g_pmdl_m.pmdl022
               LET g_chkparam.arg3 = g_site
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="axr-00049:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmac002_2") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl022 = g_pmdl_m_t.pmdl022
                  CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl022_desc 
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl022
            #add-point:BEFORE FIELD pmdl022 name="input.b.pmdl022"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl022
            #add-point:ON CHANGE pmdl022 name="input.g.pmdl022"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl032
            
            #add-point:AFTER FIELD pmdl032 name="input.a.pmdl032"
                                    CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl032) RETURNING g_pmdl_m.pmdl032_desc
            DISPLAY BY NAME g_pmdl_m.pmdl032_desc 
            
            IF NOT cl_null(g_pmdl_m.pmdl032) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
                LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl032
               LET g_chkparam.arg2 = g_site
               #160318-00025#15 by 07900 --add-str 
                LET g_chkparam.err_str[1] ="apm-00201:sub-01302|axmm200|",cl_get_progname("axmm200",g_lang,"2"),"|:EXEPROGaxmm200"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmaa001_3") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdl_m.pmdl032 = g_pmdl_m_t.pmdl032
                  CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl032) RETURNING g_pmdl_m.pmdl032_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl032_desc 
                  NEXT FIELD CURRENT
               END IF
            END IF 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl032
            #add-point:BEFORE FIELD pmdl032 name="input.b.pmdl032"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl032
            #add-point:ON CHANGE pmdl032 name="input.g.pmdl032"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl024
            
            #add-point:AFTER FIELD pmdl024 name="input.a.pmdl024"
                                    CALL apmt500_pmdl024_ref(g_pmdl_m.pmdl024) RETURNING g_pmdl_m.pmdl024_desc
            DISPLAY BY NAME g_pmdl_m.pmdl024_desc
                  
            IF NOT cl_null(g_pmdl_m.pmdl024) THEN
               IF NOT apmt500_pmdl024_chk(g_pmdl_m.pmdl024) THEN
                  LET g_pmdl_m.pmdl024 = g_pmdl_m_t.pmdl024
                  CALL apmt500_pmdl024_ref(g_pmdl_m.pmdl024) RETURNING g_pmdl_m.pmdl024_desc
                  DISPLAY BY NAME g_pmdl_m.pmdl024_desc
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl024
            #add-point:BEFORE FIELD pmdl024 name="input.b.pmdl024"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl024
            #add-point:ON CHANGE pmdl024 name="input.g.pmdl024"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl054
            #add-point:BEFORE FIELD pmdl054 name="input.b.pmdl054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl054
            
            #add-point:AFTER FIELD pmdl054 name="input.a.pmdl054"
            #取匯率
            IF NOT cl_null(g_pmdl_m.pmdl015) THEN
               #根據內外購獲取當前營運據點參數設置的汇率类型
               LET l_scc40 = ''
               IF g_pmdl_m.pmdl054 = '1' THEN   #內購
                  LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
               END IF
               IF g_pmdl_m.pmdl054 = '2' THEN   #外購
                  LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
               END IF
               LET l_ooef016 = ''
               SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
               IF NOT cl_null(g_pmdl_m.pmdl015) THEN
                  CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmdl_m.pmdl015,l_ooef016,0,l_scc40) RETURNING g_pmdl_m.pmdl016
                  DISPLAY BY NAME g_pmdl_m.pmdl016
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl054
            #add-point:ON CHANGE pmdl054 name="input.g.pmdl054"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl055
            #add-point:BEFORE FIELD pmdl055 name="input.b.pmdl055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl055
            
            #add-point:AFTER FIELD pmdl055 name="input.a.pmdl055"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl055
            #add-point:ON CHANGE pmdl055 name="input.g.pmdl055"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl030
            #add-point:BEFORE FIELD pmdl030 name="input.b.pmdl030"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl030
            
            #add-point:AFTER FIELD pmdl030 name="input.a.pmdl030"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl030
            #add-point:ON CHANGE pmdl030 name="input.g.pmdl030"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl031
            #add-point:BEFORE FIELD pmdl031 name="input.b.pmdl031"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl031
            
            #add-point:AFTER FIELD pmdl031 name="input.a.pmdl031"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl031
            #add-point:ON CHANGE pmdl031 name="input.g.pmdl031"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl028
            #add-point:BEFORE FIELD pmdl028 name="input.b.pmdl028"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl028
            
            #add-point:AFTER FIELD pmdl028 name="input.a.pmdl028"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl028
            #add-point:ON CHANGE pmdl028 name="input.g.pmdl028"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl042
            #add-point:BEFORE FIELD pmdl042 name="input.b.pmdl042"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl042
            
            #add-point:AFTER FIELD pmdl042 name="input.a.pmdl042"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl042
            #add-point:ON CHANGE pmdl042 name="input.g.pmdl042"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl047
            #add-point:BEFORE FIELD pmdl047 name="input.b.pmdl047"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl047
            
            #add-point:AFTER FIELD pmdl047 name="input.a.pmdl047"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl047
            #add-point:ON CHANGE pmdl047 name="input.g.pmdl047"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl048
            #add-point:BEFORE FIELD pmdl048 name="input.b.pmdl048"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl048
            
            #add-point:AFTER FIELD pmdl048 name="input.a.pmdl048"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl048
            #add-point:ON CHANGE pmdl048 name="input.g.pmdl048"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl049
            #add-point:BEFORE FIELD pmdl049 name="input.b.pmdl049"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl049
            
            #add-point:AFTER FIELD pmdl049 name="input.a.pmdl049"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl049
            #add-point:ON CHANGE pmdl049 name="input.g.pmdl049"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl208
            #add-point:BEFORE FIELD pmdl208 name="input.b.pmdl208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl208
            
            #add-point:AFTER FIELD pmdl208 name="input.a.pmdl208"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl208
            #add-point:ON CHANGE pmdl208 name="input.g.pmdl208"
           
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl046
            #add-point:BEFORE FIELD pmdl046 name="input.b.pmdl046"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl046
            
            #add-point:AFTER FIELD pmdl046 name="input.a.pmdl046"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl046
            #add-point:ON CHANGE pmdl046 name="input.g.pmdl046"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl040
            #add-point:BEFORE FIELD pmdl040 name="input.b.pmdl040"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl040
            
            #add-point:AFTER FIELD pmdl040 name="input.a.pmdl040"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl040
            #add-point:ON CHANGE pmdl040 name="input.g.pmdl040"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdl041
            #add-point:BEFORE FIELD pmdl041 name="input.b.pmdl041"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdl041
            
            #add-point:AFTER FIELD pmdl041 name="input.a.pmdl041"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdl041
            #add-point:ON CHANGE pmdl041 name="input.g.pmdl041"
                        
            #END add-point 
 
 
 #欄位檢查
                  #Ctrlp:input.c.pmdldocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdldocno
            #add-point:ON ACTION controlp INFIELD pmdldocno name="input.c.pmdldocno"
                        #此段落由子樣板a07產生            
            #開窗i段
		   	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		   	LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdldocno             #給予default值

            #給予arg
            LET g_qryparam.arg1 = l_ooef004
            LET g_qryparam.arg2 = g_prog

            #150909 earl mod s
            IF NOT cl_null(g_pmdl_m.pmdl008) THEN
               CALL s_aooi210_get_search_sql(g_site,'',g_pmdl_m.pmdl008,g_prog) RETURNING l_success,l_where
               
            ELSE
               LET l_success = TRUE
               LET l_where = "1=1"
            END IF
            
            IF l_success THEN
               #151210-00009#1  2015/12/30 By earl s
               IF g_aic_doc THEN
                  LET l_where = l_where,
                                " AND NOT EXISTS (SELECT 1 FROM icaa_t,icab_t a,icac_t ",
                                "                  WHERE icaaent = a.icabent AND a.icabent = icacent AND icacent = ",g_enterprise,
                                "                    AND icaa001 = a.icab001 AND a.icab001 = icac001",
                                "                    AND a.icab002 = icac002",
                                "                    AND a.icab003 = '",g_site,"'",
                                "                    AND ooba002 = icac010",
                                #排除採購初始站
                                "                    AND NOT ((icaa003 = '2' OR icaa003 = '3') AND a.icab002 = '0')",
                                "                )"
               END IF
               #151210-00009#1  2015/12/30 By earl e
               
               LET g_qryparam.where = l_where
               #160711-00040#24 add(s)
               CALL s_control_get_docno_sql(g_user,g_dept)
                   RETURNING l_success,l_sql1
               IF NOT cl_null(l_sql1) THEN
                  IF cl_null(g_qryparam.where) THEN
                     LET g_qryparam.where = l_sql1
                  ELSE
                     LET g_qryparam.where = g_qryparam.where," AND ",l_sql1
                  END IF
               END IF
               #160711-00040#24 add(e)
               CALL q_ooba002_1()                                #呼叫開窗
               LET g_pmdl_m.pmdldocno = g_qryparam.return1              #將開窗取得的值回傳到變數
               DISPLAY g_pmdl_m.pmdldocno TO pmdldocno              #顯示到畫面上
               #CALL s_aooi200_get_slip_desc(g_site,'',g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
               CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
               DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
            END IF
            #150909 earl mod e

            NEXT FIELD pmdldocno                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl001
            #add-point:ON ACTION controlp INFIELD pmdl001 name="input.c.pmdl001"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdldocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdldocdt
            #add-point:ON ACTION controlp INFIELD pmdldocdt name="input.c.pmdldocdt"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl004
            #add-point:ON ACTION controlp INFIELD pmdl004 name="input.c.pmdl004"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = "pmaa001 IN (SELECT pmab001 FROM pmab_t ",                                             #151217-00014#1 add
                                   "             WHERE pmabsite = '",g_site,"' AND pmabent = '",g_enterprise,"' AND 1=1)" #151217-00014#1 add
            LET g_qryparam.default1 = g_pmdl_m.pmdl004             #給予default值

            #LET g_qryparam.where = "1=1 " #151217-00014#1 mark
            
            LET l_sql = " 1=1"
            
            #160125-00011#1 mark by lixiang --begin---
            #CALL s_control_get_sql("pmaa080",'3','4',g_user,g_dept) RETURNING l_success,l_sql
            #IF l_success THEN
            #   IF cl_null(l_sql) THEN
            #      LET l_sql = " 1=1"
            #   END IF
            #   LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            #END IF
            #
            #LET l_sql = " 1=1"
            #CALL s_control_get_sql("pmaa001",'4','4',g_user,g_dept) RETURNING l_success,l_sql
            #IF l_success THEN
            #   IF cl_null(l_sql) THEN
            #      LET l_sql = " 1=1"
            #   END IF
            #   LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            #END IF
            #
            #LET l_sql = " 1=1"
            #CALL s_control_get_doc_sql("pmaa083",g_pmdl_m.pmdldocno,'2') RETURNING l_success,l_sql
            #IF l_success THEN
            #   IF cl_null(l_sql) THEN
            #      LET l_sql = " 1=1"
            #   END IF
            #   LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            #END IF
            #160125-00011#1 mark by lixiang --end---
            #160125-00011#1 add by lixiang --begin---
            CALL s_control_get_supplier_sql('4',g_site,g_user,g_dept,g_pmdl_m.pmdldocno) RETURNING l_success,l_sql
            IF cl_null(l_sql) THEN
               LET l_sql = " 1=1"
            END IF
            LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            #160125-00011#1 add by lixiang --end---
            
            CALL q_pmaa001_3()                                #呼叫開窗

            LET g_pmdl_m.pmdl004 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl004 TO pmdl004              #顯示到畫面上
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl004) RETURNING g_pmdl_m.pmdl004_desc
            DISPLAY BY NAME g_pmdl_m.pmdl004_desc

            NEXT FIELD pmdl004                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl002
            #add-point:ON ACTION controlp INFIELD pmdl002 name="input.c.pmdl002"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl002             #給予default值

            #給予arg

            CALL q_ooag001()                                #呼叫開窗

            LET g_pmdl_m.pmdl002 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl002 TO pmdl002              #顯示到畫面上
            CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
            DISPLAY BY NAME g_pmdl_m.pmdl002_desc

            NEXT FIELD pmdl002                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl003
            #add-point:ON ACTION controlp INFIELD pmdl003 name="input.c.pmdl003"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl003             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdldocdt #

            CALL q_ooeg001()                                #呼叫開窗

            LET g_pmdl_m.pmdl003 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl003 TO pmdl003              #顯示到畫面上
            CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
            DISPLAY BY NAME g_pmdl_m.pmdl003_desc 

            NEXT FIELD pmdl003                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdlsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlsite
            #add-point:ON ACTION controlp INFIELD pmdlsite name="input.c.pmdlsite"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdlstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdlstus
            #add-point:ON ACTION controlp INFIELD pmdlstus name="input.c.pmdlstus"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl005
            #add-point:ON ACTION controlp INFIELD pmdl005 name="input.c.pmdl005"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl006
            #add-point:ON ACTION controlp INFIELD pmdl006 name="input.c.pmdl006"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl007
            #add-point:ON ACTION controlp INFIELD pmdl007 name="input.c.pmdl007"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl008
            #add-point:ON ACTION controlp INFIELD pmdl008 name="input.c.pmdl008"
            #開窗i段
            LET l_success = TRUE
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl008             #給予default值
            LET g_qryparam.where = " 1=1 "
            
            CASE g_pmdl_m.pmdl007
              WHEN '2'  
                 #ming 20150823 add --------------------------------------------(S) 
                 LET g_qryparam.where = "pmdastus = 'Y' ",
                                        " AND pmdadocno IN (SELECT DISTINCT pmdbdocno ",
                                        "                     FROM pmdb_t ",
                                        "                    WHERE pmdbent = '",g_enterprise,"' ",
                                        "                      AND pmdbsite = '",g_site,"' ",
                                        "                      AND pmdb032 = '1' ",     
                                        "                      AND pmdb049 < pmdb006) "
                 #ming 20150823 add --------------------------------------------(E) 
                 
                 #150909 earl mod s
                 #組合過濾前後置單據資料SQL
                 CALL s_aooi210_get_check_sql(g_site,'',g_pmdl_m.pmdldocno,'4','','pmdadocno') RETURNING l_success,l_where
                 IF l_success THEN
                    LET g_qryparam.where = g_qryparam.where," AND ",l_where
                    CALL q_pmdadocno()      #請購
                 END IF
                 #150909 earl mod e
                 
              WHEN '4'      #工單
                 IF g_pmdl_m.pmdl006 = '8' THEN  #協作工單
                    LET g_qryparam.where = " sfaa003 = '6' "
                 END IF
                 
                 #150909 earl mod s
                 #組合過濾前後置單據資料SQL
                 CALL s_aooi210_get_check_sql(g_site,'',g_pmdl_m.pmdldocno,'4','','sfcbdocno') RETURNING l_success,l_where
                 IF l_success THEN
                    LET g_qryparam.where = g_qryparam.where," AND ",l_where
                    CALL q_sfcbdocno_3()
                 END IF
                 #150909 earl mod e
                 
              WHEN '7'  
                 LET g_qryparam.arg1 = " ('7') "
                 
                 #150909 earl mod s
                 #組合過濾前後置單據資料SQL
                 CALL s_aooi210_get_check_sql(g_site,'',g_pmdl_m.pmdldocno,'4','','pmdsdocno') RETURNING l_success,l_where
                 IF l_success THEN
                    LET g_qryparam.where = g_qryparam.where," AND ",l_where
                    CALL q_pmdsdocno_4()      #倉退
                 END IF
                 #150909 earl mod e
                 
              WHEN '8'  
                  LET g_qryparam.where = " pmdl005 = '4' AND pmdldocno IN (SELECT DISTINCT pmdodocno FROM pmdo_t WHERE pmdoent = '",g_enterprise,"' AND (pmdo006-pmdo015)>0 )"
                  
                 #150909 earl mod s
                 #組合過濾前後置單據資料SQL
                 CALL s_aooi210_get_check_sql(g_site,'',g_pmdl_m.pmdldocno,'4','','pmdldocno') RETURNING l_success,l_where
                 IF l_success THEN
                    LET g_qryparam.where = g_qryparam.where," AND ",l_where
                    CALL q_pmdldocno()      #預先採購
                 END IF
                 #150909 earl mod e
                 
            END CASE
            
            #150909 earl mod s
            IF l_success THEN
               LET g_pmdl_m.pmdl008 = g_qryparam.return1              #將開窗取得的值回傳到變數
               DISPLAY g_pmdl_m.pmdl008 TO pmdl008              #顯示到畫面上
            END IF
            #150909 earl mod e

            NEXT FIELD pmdl008                          #返回原欄位            
            #END add-point
 
 
         #Ctrlp:input.c.pmdl027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl027
            #add-point:ON ACTION controlp INFIELD pmdl027 name="input.c.pmdl027"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl027             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004 #

            CALL q_pmaj002()                                #呼叫開窗

            LET g_pmdl_m.pmdl027 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl027 TO pmdl027              #顯示到畫面上
            CALL apmt500_pmdl027_ref(g_pmdl_m.pmdl004,g_pmdl_m.pmdl027) RETURNING g_pmdl_m.pmdl027_desc
            DISPLAY BY NAME g_pmdl_m.pmdl027_desc

            NEXT FIELD pmdl027                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl052
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl052
            #add-point:ON ACTION controlp INFIELD pmdl052 name="input.c.pmdl052"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl052             #給予default值

            #給予arg
            
            
            CALL q_pmaa001_3()                                #呼叫開窗

            LET g_pmdl_m.pmdl052 = g_qryparam.return1              

            DISPLAY g_pmdl_m.pmdl052 TO pmdl052              #

            NEXT FIELD pmdl052                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl053
            #add-point:ON ACTION controlp INFIELD pmdl053 name="input.c.pmdl053"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmdl009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl009
            #add-point:ON ACTION controlp INFIELD pmdl009 name="input.c.pmdl009"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl009             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004 #

            CALL q_pmad002_2()                                #呼叫開窗

            LET g_pmdl_m.pmdl009 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl009 TO pmdl009              #顯示到畫面上
            CALL apmt500_pmdl009_ref(g_pmdl_m.pmdl009) RETURNING g_pmdl_m.pmdl009_desc
            DISPLAY BY NAME g_pmdl_m.pmdl009_desc

            NEXT FIELD pmdl009                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl010
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl010
            #add-point:ON ACTION controlp INFIELD pmdl010 name="input.c.pmdl010"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl010             #給予default值
            LET g_qryparam.default2 = "" #g_pmdl_m.oocq010 #參考欄位七

            #給予arg
            LET g_qryparam.arg1 = "238" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdl_m.pmdl010 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl010 TO pmdl010              #顯示到畫面上
            CALL apmt500_pmdl010_ref(g_pmdl_m.pmdl010) RETURNING g_pmdl_m.pmdl010_desc
            DISPLAY BY NAME g_pmdl_m.pmdl010_desc

            NEXT FIELD pmdl010                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl011
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl011
            #add-point:ON ACTION controlp INFIELD pmdl011 name="input.c.pmdl011"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl011             #給予default值

            #給予arg

            #CALL q_oodb002_2()                                #呼叫開窗
            CALL q_oodb002_11()
            LET g_pmdl_m.pmdl011 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl011 TO pmdl011              #顯示到畫面上
            CALL apmt500_pmdl011_ref(g_pmdl_m.pmdl011) RETURNING g_pmdl_m.pmdl011_desc
            DISPLAY BY NAME g_pmdl_m.pmdl011_desc

            NEXT FIELD pmdl011                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl012
            #add-point:ON ACTION controlp INFIELD pmdl012 name="input.c.pmdl012"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl013
            #add-point:ON ACTION controlp INFIELD pmdl013 name="input.c.pmdl013"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl033
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl033
            #add-point:ON ACTION controlp INFIELD pmdl033 name="input.c.pmdl033"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl033             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_ooef019 #
            LET g_qryparam.arg2 = "1" #

            CALL q_isac002_1()                                #呼叫開窗

            LET g_pmdl_m.pmdl033 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl033 TO pmdl033              #顯示到畫面上
            CALL apmt500_pmdl033_ref(g_pmdl_m.pmdl033) RETURNING g_pmdl_m.pmdl033_desc
            DISPLAY BY NAME g_pmdl_m.pmdl033_desc
            NEXT FIELD pmdl033                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl015
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl015
            #add-point:ON ACTION controlp INFIELD pmdl015 name="input.c.pmdl015"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl015             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_site #

            CALL q_ooaj002_1()                                #呼叫開窗

            LET g_pmdl_m.pmdl015 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl015 TO pmdl015              #顯示到畫面上
            CALL apmt500_pmdl015_ref(g_pmdl_m.pmdl015) RETURNING g_pmdl_m.pmdl015_desc
            DISPLAY BY NAME g_pmdl_m.pmdl015_desc

            NEXT FIELD pmdl015                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl016
            #add-point:ON ACTION controlp INFIELD pmdl016 name="input.c.pmdl016"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl017
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl017
            #add-point:ON ACTION controlp INFIELD pmdl017 name="input.c.pmdl017"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl017             #給予default值

            #給予arg

            CALL q_pmam001()                                #呼叫開窗

            LET g_pmdl_m.pmdl017 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl017 TO pmdl017              #顯示到畫面上
            CALL apmt500_pmdl017_ref(g_pmdl_m.pmdl017) RETURNING g_pmdl_m.pmdl017_desc
            DISPLAY BY NAME g_pmdl_m.pmdl017_desc

            NEXT FIELD pmdl017                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl018
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl018
            #add-point:ON ACTION controlp INFIELD pmdl018 name="input.c.pmdl018"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl018             #給予default值

            #給予arg

            CALL q_ooid001_2()                                #呼叫開窗

            LET g_pmdl_m.pmdl018 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl018 TO pmdl018              #顯示到畫面上
            CALL apmt500_pmdl018_ref(g_pmdl_m.pmdl018) RETURNING g_pmdl_m.pmdl018_desc
            DISPLAY BY NAME g_pmdl_m.pmdl018_desc

            NEXT FIELD pmdl018                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl019
            #add-point:ON ACTION controlp INFIELD pmdl019 name="input.c.pmdl019"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl023
            #add-point:ON ACTION controlp INFIELD pmdl023 name="input.c.pmdl023"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl023             #給予default值

            #給予arg
            #160621-00003#3 20160627 modify by beckxie---S
			   #LET g_qryparam.arg1 = "275"
            #CALL q_oocq002()                           #呼叫開窗
            LET g_qryparam.arg1 = '2'
            CALL q_oojd001_1()
            #160621-00003#3 20160627 modify by beckxie---E

            LET g_pmdl_m.pmdl023 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl023 TO pmdl023              #顯示到畫面上
            CALL apmt500_pmdl023_ref(g_pmdl_m.pmdl023) RETURNING g_pmdl_m.pmdl023_desc
            DISPLAY BY NAME g_pmdl_m.pmdl023_desc

            NEXT FIELD pmdl023                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl043
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl043
            #add-point:ON ACTION controlp INFIELD pmdl043 name="input.c.pmdl043"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl043             #給予default值
            LET g_qryparam.default2 = "" #g_pmdl_m.oocq010 #參考欄位七

            #給予arg
            LET g_qryparam.arg1 = "317" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdl_m.pmdl043 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl043 TO pmdl043              #顯示到畫面上
            NEXT FIELD pmdl043                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl044
            #add-point:ON ACTION controlp INFIELD pmdl044 name="input.c.pmdl044"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl051
            #add-point:ON ACTION controlp INFIELD pmdl051 name="input.c.pmdl051"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl051             #給予default值

            #給予arg
            IF g_pmdl_m.pmdl006 = '2' THEN
               LET g_qryparam.arg1 = '2'
            END IF
            IF g_pmdl_m.pmdl006 = '3' THEN
               LET g_qryparam.arg1 = '3'
            END IF
            
            LET g_qryparam.arg2 = '0'
            
            CALL q_icaa001_1()                                #呼叫開窗

            LET g_pmdl_m.pmdl051 = g_qryparam.return1

            DISPLAY g_pmdl_m.pmdl051 TO pmdl051              #
            CALL s_desc_get_icaa001_desc(g_pmdl_m.pmdl051) RETURNING g_pmdl_m.pmdl051_desc
            DISPLAY BY NAME g_pmdl_m.pmdl051_desc


            NEXT FIELD pmdl051                          #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.pmdl020
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl020
            #add-point:ON ACTION controlp INFIELD pmdl020 name="input.c.pmdl020"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl020             #給予default值
            LET g_qryparam.default2 = "" #g_pmdl_m.oocq010 #參考欄位七

            #給予arg
            LET g_qryparam.arg1 = "263" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdl_m.pmdl020 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl020 TO pmdl020              #顯示到畫面上
            CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc
            DISPLAY BY NAME g_pmdl_m.pmdl020_desc

            NEXT FIELD pmdl020                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl025
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl025
            #add-point:ON ACTION controlp INFIELD pmdl025 name="input.c.pmdl025"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl025             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_oofa001 #
            LET g_qryparam.where = " oofb008 = '3' "  #出貨地址

            CALL q_oofb019_1()                                #呼叫開窗

            LET g_pmdl_m.pmdl025 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl025 TO pmdl025              #顯示到畫面上
            CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
            DISPLAY BY NAME g_pmdl_m.pmdl025_desc
            #呼叫地址組合應用元件
            IF NOT cl_null(g_pmdl_m.pmdl025) THEN
               CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl025,g_lang) RETURNING l_success,g_pmdl_m.oofb017
            END IF
            DISPLAY BY NAME g_pmdl_m.oofb017
      

            NEXT FIELD pmdl025                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl026
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl026
            #add-point:ON ACTION controlp INFIELD pmdl026 name="input.c.pmdl026"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl026             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_oofa001 #
            LET g_qryparam.where = " oofb008 = '5' "  #發票地址
            CALL q_oofb019_1()                                #呼叫開窗

            LET g_pmdl_m.pmdl026 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl026 TO pmdl026              #顯示到畫面上
            CALL apmt500_pmdl026_ref(g_pmdl_m.pmdl026) RETURNING g_pmdl_m.pmdl026_desc
            DISPLAY BY NAME g_pmdl_m.pmdl026_desc
            #呼叫地址組合應用元件
            IF NOT cl_null(g_pmdl_m.pmdl026) THEN
               CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl026,g_lang) RETURNING l_success,g_pmdl_m.oofb017_1
            END IF
            DISPLAY BY NAME g_pmdl_m.oofb017_1
      

            NEXT FIELD pmdl026                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl029
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl029
            #add-point:ON ACTION controlp INFIELD pmdl029 name="input.c.pmdl029"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl029             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdldocdt

            CALL q_ooeg001()                                #呼叫開窗

            LET g_pmdl_m.pmdl029 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl029 TO pmdl029              #顯示到畫面上
            CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl029) RETURNING g_pmdl_m.pmdl029_desc
            DISPLAY BY NAME g_pmdl_m.pmdl029_desc 

            NEXT FIELD pmdl029                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl021
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl021
            #add-point:ON ACTION controlp INFIELD pmdl021 name="input.c.pmdl021"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl021             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004
            LET g_qryparam.where = " pmac003 = '1' "
            LET l_sql = " 1=1"
            CALL s_control_get_doc_sql("pmaa083",g_pmdl_m.pmdldocno,'2') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND pmac002 IN ( SELECT pmaa001 FROM pmaa_t WHERE pmaaent = '",g_enterprise,"' AND ",l_sql,")"
            END IF

            CALL q_pmac002_2()                                #呼叫開窗

            LET g_pmdl_m.pmdl021 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl021 TO pmdl021              #顯示到畫面上
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
            DISPLAY BY NAME g_pmdl_m.pmdl021_desc 

            NEXT FIELD pmdl021                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl022
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl022
            #add-point:ON ACTION controlp INFIELD pmdl022 name="input.c.pmdl022"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl022             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004
            LET g_qryparam.where = " pmac003 = '2' "
            LET l_sql = " 1=1"
            CALL s_control_get_doc_sql("pmaa083",g_pmdl_m.pmdldocno,'2') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND pmac002 IN ( SELECT pmaa001 FROM pmaa_t WHERE pmaaent = '",g_enterprise,"' AND ",l_sql,")"
            END IF

            CALL q_pmac002_2()                                #呼叫開窗

            LET g_pmdl_m.pmdl022 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl022 TO pmdl022              #顯示到畫面上
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
            DISPLAY BY NAME g_pmdl_m.pmdl022_desc 

            NEXT FIELD pmdl022                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl032
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl032
            #add-point:ON ACTION controlp INFIELD pmdl032 name="input.c.pmdl032"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl032             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_site
            CALL q_pmaa001_6()                                #呼叫開窗

            LET g_pmdl_m.pmdl032 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl032 TO pmdl032              #顯示到畫面上

            NEXT FIELD pmdl032                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl024
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl024
            #add-point:ON ACTION controlp INFIELD pmdl024 name="input.c.pmdl024"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdl_m.pmdl024             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "264" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdl_m.pmdl024 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdl_m.pmdl024 TO pmdl024              #顯示到畫面上
            CALL apmt500_pmdl024_ref(g_pmdl_m.pmdl024) RETURNING g_pmdl_m.pmdl024_desc
            DISPLAY BY NAME g_pmdl_m.pmdl024_desc

            NEXT FIELD pmdl024                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdl054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl054
            #add-point:ON ACTION controlp INFIELD pmdl054 name="input.c.pmdl054"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmdl055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl055
            #add-point:ON ACTION controlp INFIELD pmdl055 name="input.c.pmdl055"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmdl030
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl030
            #add-point:ON ACTION controlp INFIELD pmdl030 name="input.c.pmdl030"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl031
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl031
            #add-point:ON ACTION controlp INFIELD pmdl031 name="input.c.pmdl031"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl028
            #add-point:ON ACTION controlp INFIELD pmdl028 name="input.c.pmdl028"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl042
            #add-point:ON ACTION controlp INFIELD pmdl042 name="input.c.pmdl042"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl047
            #add-point:ON ACTION controlp INFIELD pmdl047 name="input.c.pmdl047"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl048
            #add-point:ON ACTION controlp INFIELD pmdl048 name="input.c.pmdl048"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl049
            #add-point:ON ACTION controlp INFIELD pmdl049 name="input.c.pmdl049"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl208
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl208
            #add-point:ON ACTION controlp INFIELD pmdl208 name="input.c.pmdl208"
              
            #END add-point
 
 
         #Ctrlp:input.c.pmdl046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl046
            #add-point:ON ACTION controlp INFIELD pmdl046 name="input.c.pmdl046"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl040
            #add-point:ON ACTION controlp INFIELD pmdl040 name="input.c.pmdl040"
                        
            #END add-point
 
 
         #Ctrlp:input.c.pmdl041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdl041
            #add-point:ON ACTION controlp INFIELD pmdl041 name="input.c.pmdl041"
                        
            #END add-point
 
 
 #欄位開窗
            
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
 
            #CALL cl_err_collect_show()      #錯誤訊息統整顯示
            #CALL cl_showmsg()
            DISPLAY BY NAME g_pmdl_m.pmdldocno
                        
            #add-point:單頭INPUT後 name="input.head.after_input"
            
            #end add-point
                        
            IF p_cmd <> 'u' THEN
    
               CALL s_transaction_begin()
               
               #add-point:單頭新增前 name="input.head.b_insert"
               #取稅率、單價含稅否
               IF NOT cl_null(g_pmdl_m.pmdl011) THEN
                  LET l_oodb005 = ''
                  LET l_oodb006 = ''
                  LET l_oodb011 = ''
                  CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
                    RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                    
                  IF NOT l_success THEN
                     CALL s_transaction_end('N','0')
                     NEXT FIELD pmdl011
                  END IF           
               END IF
               CALL s_aooi200_gen_docno(g_site,g_pmdl_m.pmdldocno,g_pmdl_m.pmdldocdt,g_prog) RETURNING l_success,g_pmdl_m.pmdldocno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00003'
                  LET g_errparam.extend = g_pmdl_m.pmdldocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  NEXT FIELD pmdldocno           
               END IF
               #end add-point
               
               INSERT INTO pmdl_t (pmdlent,pmdldocno,pmdl001,pmdldocdt,pmdl004,pmdl002,pmdl003,pmdlsite, 
                   pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009,pmdl010, 
                   pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl023,pmdl043, 
                   pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029,pmdl021,pmdl022,pmdl032,pmdl024,pmdl054, 
                   pmdl055,pmdl030,pmdl031,pmdl028,pmdl042,pmdl047,pmdl048,pmdl049,pmdl208,pmdl046,pmdl040, 
                   pmdl041,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp,pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid, 
                   pmdlcnfdt)
               VALUES (g_enterprise,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004, 
                   g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005, 
                   g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
                   g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012, 
                   g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017, 
                   g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044, 
                   g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029, 
                   g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054, 
                   g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
                   g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046, 
                   g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid, 
                   g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid, 
                   g_pmdl_m.pmdlcnfdt) 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "g_pmdl_m:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭新增中 name="input.head.m_insert"
               #160719-00001#1--s
               #供应商的一次交易对象或内部员工时，单头新增后，需更新pmak中的参考单号为单头完整单号
               UPDATE pmak_t SET pmak006 = g_pmdl_m.pmdldocno WHERE pmakent = g_enterprise AND pmak001 = g_pmdl_m.pmdl028
               #160719-00001#1--e
               
               LET g_ooff003_d = g_pmdl_m.pmdldocno   #161031-00025#1
               
               IF g_pmdl_m.pmdl007 = '8' AND (NOT cl_null(g_pmdl_m.pmdl008)) THEN
                  IF NOT apmt500_gen_purchase_pmdn() THEN
                     CALL s_transaction_end('N','0')
                     CONTINUE DIALOG
                  END IF
                  CALL apmt500_b_fill()
                  CALL s_transaction_end('Y','0')
                  
                  LET g_master_insert = TRUE
               
                  LET p_cmd = 'u'
               
                  EXIT DIALOG
               END IF
               #end add-point
               
               
               
               
               #add-point:單頭新增後 name="input.head.a_insert"
                              
               #end add-point
               CALL s_transaction_end('Y','0') 
               
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL apmt500_detail_reproduce()
                  #因應特定程式需求, 重新刷新單身資料
                  CALL apmt500_b_fill()
                  CALL apmt500_b_fill2('0')
               END IF
               
               #add-point:單頭新增後 name="input.head.a_insert2"
               
               #end add-point
               
               LET g_master_insert = TRUE
               
               LET p_cmd = 'u'
            ELSE
               CALL s_transaction_begin()
            
               #add-point:單頭修改前 name="input.head.b_update"
               #取稅率、單價含稅否
               IF NOT cl_null(g_pmdl_m.pmdl011) THEN
                  LET l_oodb005 = ''
                  LET l_oodb006 = ''
                  LET l_oodb011 = ''
                  CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
                    RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                    
                  IF NOT l_success THEN
                     NEXT FIELD pmdl011
                  ELSE                             #160204-00006#1 add
                     LET g_tax_app = l_oodb011     #160204-00006#1 add                      
                  END IF           
               END IF
               
               #單身有資料時，才詢問是否重設单身税别及税率？            
               #IF g_pmdn_d.getLength() > 0 AND g_pmdl_m.pmdl011 <> g_pmdl_m_t.pmdl011 THEN  #160727-00025#9
               IF g_pmdn_d.getLength() > 0 AND (g_pmdl_m.pmdl011 <> g_pmdl_m_t.pmdl011 OR cl_null(g_pmdl_m_t.pmdl011)) THEN  #160727-00025#9
                  IF g_tax_app <> '1' THEN                 #160204-00006#1 add
                     IF cl_ask_confirm('apm-00351') THEN
                        CALL apmt500_change_pmdn016()      #重設單身稅別
                        #CALL apmt500_b_fill()             #160204-00006#1 mark  
                     END IF    
                 #160204-00006#1--add--(s)     
                  ELSE
                    CALL apmt500_change_pmdn016()          #重設單身稅別
                  END IF                        
                  CALL apmt500_b_fill()
                 #160204-00006#1--add--(e)                                    
               END IF
               
               #單頭送貨供應商有修改時，需同步更新單身送貨供應商
               #IF g_pmdl_m.pmdl022 <> g_pmdl_m_t.pmdl022 THEN
                  UPDATE pmdn_t SET pmdn023 = g_pmdl_m.pmdl022 WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdldocno_t
               #END IF
               
               #160727-00025#9---s
               #IF g_pmdl_m.pmdl017 <> g_pmdl_m_t.pmdl017 OR g_pmdl_m.pmdl015 <> g_pmdl_m_t.pmdl015 OR
               #   g_pmdl_m.pmdl009 <> g_pmdl_m_t.pmdl009 OR g_pmdl_m.pmdl010 <> g_pmdl_m_t.pmdl010 OR
               #   g_pmdl_m.pmdl054 <> g_pmdl_m_t.pmdl054 THEN
               IF (g_pmdl_m.pmdl017 <> g_pmdl_m_t.pmdl017 OR cl_null(g_pmdl_m_t.pmdl017)) OR 
                  (g_pmdl_m.pmdl015 <> g_pmdl_m_t.pmdl015 OR cl_null(g_pmdl_m_t.pmdl015)) OR
                  (g_pmdl_m.pmdl009 <> g_pmdl_m_t.pmdl009 OR cl_null(g_pmdl_m_t.pmdl009)) OR 
                  (g_pmdl_m.pmdl010 <> g_pmdl_m_t.pmdl010 OR cl_null(g_pmdl_m_t.pmdl010)) OR
                  (g_pmdl_m.pmdl054 <> g_pmdl_m_t.pmdl054 OR cl_null(g_pmdl_m_t.pmdl054)) THEN
               #160727-00025#9--e
                  #變更相關資料時，需詢問是否要重新取價，並重新計算含稅金額、未稅金額、稅額
                  IF g_pmdn_d.getLength() > 0 THEN
                     IF cl_ask_confirm('axm-00230') THEN                              
                        CALL apmt500_change_pmdn015()
                     END IF                              
                  END IF
                  
               END IF 
               
               #160104-00017#1 20160108 add by ming -----(S) 
               IF g_pmdn_d.getLength() > 0 THEN
                  #如果採購性質是vmi採購的話
                  #需要同步更新單身的庫存管理特徵 
                  IF g_pmdl_m.pmdl005 = '3' THEN
                     #且單頭的供應商有被修改時 
                     #或採購性質是由其他轉vmi時 
                     IF g_pmdl_m.pmdl004 != g_pmdl_m_t.pmdl004 OR
                       g_pmdl_m_t.pmdl005 != '3' THEN
                        UPDATE pmdn_t SET pmdn053 = g_pmdl_m.pmdl004
                         WHERE pmdnent   = g_enterprise
                           AND pmdndocno = g_pmdldocno_t
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = 'upd pmdn_t'
                           LET g_errparam.code   = SQLCA.sqlcode
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                           NEXT FIELD CURRENT
                        END IF
                     END IF

                     #如果是vmi採購的話，庫位必須是vmi倉 
                     #取得aoos020的vmi倉庫位Tag 
                     CALL cl_get_para(g_enterprise,g_site,'S-BAS-0043')
                          RETURNING l_code_s_bas_0043
                     #有設定庫位Tag的話才能往後找資料  
                     IF NOT cl_null(l_code_s_bas_0043) THEN
                        #如果庫位不是vmi倉的就直接清掉 
                        UPDATE pmdn_t SET pmdn028 = ''
                         WHERE pmdnent = g_enterprise
                           AND pmdndocno = g_pmdldocno_t
                           AND pmdn028 NOT IN(SELECT inaa001 FROM inaa_t
                                               WHERE inaaent  = g_enterprise
                                                 AND inaasite = g_site
                                                 AND inaa001 IN (SELECT DISTINCT inac001
                                                                   FROM inac_t
                                                                  WHERE inacent = g_enterprise
                                                                    AND inacsite = g_site
                                                                    AND inacstus = 'Y'
                                                                    AND inac003  = l_code_s_bas_0043))
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = 'upd pmdn_t'
                           LET g_errparam.code   = SQLCA.sqlcode
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF 
                  
                  #如果採購性質本來是vmi採購，現在不是vmi採購的話 
                  #需清空庫存管理特徵 
                  IF g_pmdl_m_t.pmdl005 = '3' AND g_pmdl_m.pmdl005 != '3' THEN
                     UPDATE pmdn_t SET pmdn053 = ''
                      WHERE pmdnent   = g_enterprise
                        AND pmdndocno =  g_pmdldocno_t
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.extend = 'upd pmdn_t'
                        LET g_errparam.code   = SQLCA.sqlcode
                        LET g_errparam.popup  = TRUE
                        CALL cl_err()

                        CALL s_transaction_end('N','0')
                        NEXT FIELD CURRENT
                     END IF
                  END IF

               END IF
               #160104-00017#1 20160108 add by ming -----(E) 
               #end add-point
               
               #將遮罩欄位還原
               CALL apmt500_pmdl_t_mask_restore('restore_mask_o')
               
               UPDATE pmdl_t SET (pmdldocno,pmdl001,pmdldocdt,pmdl004,pmdl002,pmdl003,pmdlsite,pmdlstus, 
                   pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009,pmdl010,pmdl011,pmdl012, 
                   pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl023,pmdl043,pmdl044,pmdl051, 
                   pmdl020,pmdl025,pmdl026,pmdl029,pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030, 
                   pmdl031,pmdl028,pmdl042,pmdl047,pmdl048,pmdl049,pmdl208,pmdl046,pmdl040,pmdl041,pmdlownid, 
                   pmdlowndp,pmdlcrtid,pmdlcrtdp,pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt) = (g_pmdl_m.pmdldocno, 
                   g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003, 
                   g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007, 
                   g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009, 
                   g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033, 
                   g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
                   g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020, 
                   g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022, 
                   g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030, 
                   g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048, 
                   g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041, 
                   g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt, 
                   g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt)
                WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdldocno_t
 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmdl_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭修改中 name="input.head.m_update"
               #ming 20150904 add -------------------(S) 
               #科目預算 
               CALL s_apmt500_stus_abg1(g_pmdl_m.pmdldocno,'U')
                    RETURNING l_success
               IF NOT l_success THEN
                  CALL s_transaction_end('N','0')
                  NEXT FIELD CURRENT
               END IF
               #ming 20150904 add -------------------(E) 
               #end add-point
               
               
               
               
               #將遮罩欄位進行遮蔽
               CALL apmt500_pmdl_t_mask_restore('restore_mask_n')
               
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_pmdl_m_t)
               LET g_log2 = util.JSON.stringify(g_pmdl_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
               
               #add-point:單頭修改後 name="input.head.a_update"
                              
               #end add-point
            END IF
            
            LET g_master_commit = "Y"
            LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
            
      END INPUT
   
 
{</section>}
 
{<section id="apmt500.input.body" >}
   
      #Page1 預設值產生於此處
      INPUT ARRAY g_pmdn_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_pmdn_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL apmt500_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1','2',"))
            END IF
            LET g_loc = 'm'
            LET g_rec_b = g_pmdn_d.getLength()
            #add-point:資料輸入前 name="input.d.before_input"
            ##單身沒有數據，即第一次新增
            #LET l_n = 0
            #SELECT COUNT(1) INTO l_n FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
            #IF l_n = 0 OR cl_null(l_n) THEN
            #   CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
            #   #請采勾稽
            #   IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
            #      CALL s_transaction_begin()
            #      IF apmt500_01(g_pmdl_m.pmdldocno) THEN
            #         CALL apmt500_b_fill()
            #         LET g_rec_b = g_pmdn_d.getLength()
            #         IF g_rec_b > 0 THEN
            #            CALL s_transaction_end('Y','0')
            #            #CALL apmt500_b_fill()
            #            LET g_flag2 = TRUE
            #            EXIT DIALOG
            #         ELSE
            #            LET g_flag2 = FALSE
            #            NEXT FIELD pmdn001
            #         END IF
            #      ELSE
            #         CALL s_transaction_end('N','0')
            #         LET g_flag2 = FALSE
            #         NEXT FIELD pmdn001
            #      END IF
            #   END IF
            #END IF            
            #end add-point
         
         BEFORE ROW
            #add-point:modify段before row2 name="input.body.before_row2"
            #ming 20150904 add ------------------(S)  
            #科目預算 
            LET l_insert1 = FALSE
            #ming 20150904 add ------------------(E)  
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_detail_idx_list[1] = l_ac
            LET g_current_page = 1
            
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt500_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt500_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_pmdn_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_pmdn_d[l_ac].pmdnseq IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_pmdn_d_t.* = g_pmdn_d[l_ac].*  #BACKUP
               LET g_pmdn_d_o.* = g_pmdn_d[l_ac].*  #BACKUP
               CALL apmt500_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body.after_set_entry_b"
               CALL apmt500_set_no_required_b()
               CALL apmt500_set_required_b() 
               #end add-point  
               CALL apmt500_set_no_entry_b(l_cmd)
               IF NOT apmt500_lock_b("pmdn_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt500_bcl INTO g_pmdn_d[l_ac].pmdnsite,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001, 
                      g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006, 
                      g_pmdn_d[l_ac].pmdn007,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009,g_pmdn_d[l_ac].pmdn024, 
                      g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014,g_pmdn_d[l_ac].pmdn045, 
                      g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016, 
                      g_pmdn_d[l_ac].pmdn017,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn047,g_pmdn_d[l_ac].pmdn048, 
                      g_pmdn_d[l_ac].pmdn023,g_pmdn_d[l_ac].pmdn019,g_pmdn_d[l_ac].pmdn020,g_pmdn_d[l_ac].pmdn052, 
                      g_pmdn_d[l_ac].pmdn021,g_pmdn_d[l_ac].pmdn022,g_pmdn_d[l_ac].pmdnunit,g_pmdn_d[l_ac].pmdnorga, 
                      g_pmdn_d[l_ac].pmdn049,g_pmdn_d[l_ac].pmdn051,g_pmdn_d[l_ac].pmdn054,g_pmdn_d[l_ac].pmdn055, 
                      g_pmdn_d[l_ac].pmdn056,g_pmdn_d[l_ac].pmdn057,g_pmdn_d[l_ac].pmdn050,g_pmdn2_d[l_ac].pmdnseq, 
                      g_pmdn2_d[l_ac].pmdn027,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn030, 
                      g_pmdn2_d[l_ac].pmdn053,g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn031, 
                      g_pmdn2_d[l_ac].pmdn032,g_pmdn2_d[l_ac].pmdn033,g_pmdn2_d[l_ac].pmdn003,g_pmdn2_d[l_ac].pmdn036, 
                      g_pmdn2_d[l_ac].pmdn037,g_pmdn2_d[l_ac].pmdn038,g_pmdn2_d[l_ac].pmdn058,g_pmdn2_d[l_ac].pmdn039, 
                      g_pmdn2_d[l_ac].pmdn035,g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042, 
                      g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn044
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_pmdn_d_t.pmdnseq,":",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_pmdn_d_mask_o[l_ac].* =  g_pmdn_d[l_ac].*
                  CALL apmt500_pmdn_t_mask()
                  LET g_pmdn_d_mask_n[l_ac].* =  g_pmdn_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL apmt500_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body.before_row"
            #IF l_cmd = 'a' THEN
            #   CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
            #   IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
            #      IF apmt500_01(g_pmdl_m.pmdldocno) THEN
            #         CALL apmt500_b_fill()
            #         LET g_rec_b = g_pmdn_d.getLength()
            #         IF g_rec_b > 0 THEN
            #            CALL s_transaction_end('Y','0')
            #            #CALL apmt500_b_fill()
            #            LET g_flag2 = TRUE
            #            EXIT DIALOG
            #         ELSE
            #            LET g_flag2 = FALSE
            #            EXIT DIALOG
            #         END IF
            #      ELSE
            #         CALL s_transaction_end('N','0')
            #         LET g_flag2 = FALSE
            #      END IF
            #   END IF
            #END IF
            
            IF l_cmd = 'u' THEN
               LET g_pmdn_d_o.* = g_pmdn_d[l_ac].*
            END IF
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
 
            #其他table進行lock
            
 
 
        
         BEFORE INSERT  
            
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmdn_d[l_ac].* TO NULL 
            INITIALIZE g_pmdn_d_t.* TO NULL 
            INITIALIZE g_pmdn_d_o.* TO NULL 
            #公用欄位給值(單身)
            
            #自定義預設值
                  LET g_pmdn_d[l_ac].pmdn007 = "0"
      LET g_pmdn_d[l_ac].pmdn009 = "0"
      LET g_pmdn_d[l_ac].pmdn024 = "N"
      LET g_pmdn_d[l_ac].pmdn045 = "1"
      LET g_pmdn_d[l_ac].pmdn011 = "0"
      LET g_pmdn_d[l_ac].pmdn015 = "0"
      LET g_pmdn_d[l_ac].pmdn046 = "0"
      LET g_pmdn_d[l_ac].pmdn047 = "0"
      LET g_pmdn_d[l_ac].pmdn048 = "0"
      LET g_pmdn_d[l_ac].pmdn019 = "1"
      LET g_pmdn_d[l_ac].pmdn020 = "1"
      LET g_pmdn_d[l_ac].pmdn052 = "N"
      LET g_pmdn_d[l_ac].pmdn021 = "N"
      LET g_pmdn_d[l_ac].pmdn022 = "Y"
      LET g_pmdn_d[l_ac].pmdn054 = "0"
      LET g_pmdn_d[l_ac].pmdn055 = "0"
      LET g_pmdn_d[l_ac].pmdn056 = "0"
      LET g_pmdn_d[l_ac].pmdn057 = "0"
 
            #add-point:modify段before備份 name="input.body.insert.before_bak"
            #當是VMI採購單時庫存管理特徵固定預設供應商編號，且不可以修改 
            IF g_pmdl_m.pmdl005 = '3' THEN
               LET g_pmdn2_d[l_ac].pmdn053 = g_pmdl_m.pmdl004
            END IF
            
            LET g_pmdn2_d[l_ac].pmdn032 = "1"
            
            #end add-point
            LET g_pmdn_d_t.* = g_pmdn_d[l_ac].*     #新輸入資料
            LET g_pmdn_d_o.* = g_pmdn_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL apmt500_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body.insert.after_set_entry_b"
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()            
            #end add-point
            CALL apmt500_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_pmdn_d[li_reproduce_target].* = g_pmdn_d[li_reproduce].*
               LET g_pmdn2_d[li_reproduce_target].* = g_pmdn2_d[li_reproduce].*
 
               LET g_pmdn_d[li_reproduce_target].pmdnseq = NULL
 
            END IF
            
 
 
            #add-point:modify段before insert name="input.body.before_insert"
            CALL s_transaction_begin()
            
            CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
            
            IF cl_null(g_argv[1]) OR g_argv[1] = '3' THEN   #一般採購單，不傳入參數 
               #請采勾稽時，單身不允許手動輸入，必須通過子作業產生
               IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno #新增前的單身筆數
                  CALL s_transaction_begin()
                  IF apmt500_01(g_pmdl_m.pmdldocno) THEN
                     #161205-00025#2---s
                     #CALL apmt500_b_fill()             
                     #LET g_rec_b = g_pmdn_d.getLength()
                     #IF g_rec_b > l_n THEN
                     LET l_n = 0 
                     SELECT COUNT(1) INTO l_n FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
                     IF l_n > 0 THEN
                     #161205-00025#2---e
                        #160913-00009#1 add---start---
                        LET l_count_1 = 0
                        SELECT COUNT(UNIQUE pmdp003) INTO l_count_1 FROM pmdp_t
                         WHERE pmdpdocno = g_pmdl_m.pmdldocno
                           AND pmdpent = g_enterprise #170113-00021#1
                        IF l_count_1 = 1 THEN
                           SELECT UNIQUE pmdp003 INTO l_pmdl008 FROM pmdp_t
                            WHERE pmdpdocno = g_pmdl_m.pmdldocno
                              AND pmdpent = g_enterprise #170113-00021#1
                           LET l_pmdl007 = '2'
                           UPDATE pmdl_t SET pmdl007 = l_pmdl007,pmdl008 = l_pmdl008
                            WHERE pmdldocno = g_pmdl_m.pmdldocno
                              AND pmdlent = g_enterprise #170113-00021#1
                        END IF
                        #160913-00009#1 add---end---
                        #161114-00031#1--add--begin--
                         LET l_count_2 = 0
                         SELECT COUNT(UNIQUE pmdp003) INTO l_count_2 FROM pmdp_t
                           WHERE pmdpdocno = g_pmdl_m.pmdldocno  AND pmdp003 <> g_pmdl_m.pmdl008
                             AND pmdpent = g_enterprise  #170207-00046#1 add
                         IF l_count_2 > 0  THEN
                           IF NOT cl_null(g_pmdl_m.pmdl008)  AND g_pmdl_m.pmdl007 = '2'   THEN                        
                              UPDATE pmdl_t SET pmdl008 = ''
                            WHERE pmdldocno = g_pmdl_m.pmdldocno
                              AND pmdlent = g_enterprise  #170207-00046#1 add
                           END IF 
                         END IF                         
                        #161114-00031#1--add--end---
                        CALL s_transaction_end('Y','0')
                        #CALL apmt500_b_fill()
                        LET g_flag2 = TRUE
                        EXIT DIALOG
                     ELSE
                        CALL s_transaction_end('N','0')
                        LET g_flag2 = FALSE
                        EXIT DIALOG
                     END IF
                  ELSE
                     CALL s_transaction_end('N','0')
                     LET g_flag2 = FALSE
                     EXIT DIALOG
                  END IF
               END IF
            END IF
            
            IF g_argv[1] = '1' THEN  #委外採購
               CALL s_transaction_begin()
               IF NOT cl_null(g_pmdl_m.pmdl008) THEN
                  IF NOT apmt500_pmdl008_chk() THEN
                     LET g_flag2 = FALSE
                     EXIT DIALOG
                  END IF
               END IF
               IF apmt500_05(g_pmdl_m.pmdldocno) THEN
                  #160112-00016#1--add---begin---
                  SELECT pmdl008 INTO g_pmdl_m.pmdl008 FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
                  DISPLAY BY NAME g_pmdl_m.pmdl008 
                  #160112-00016#1--add--end---
                  CALL apmt500_b_fill()
                  LET g_rec_b = g_pmdn_d.getLength()
                  IF g_rec_b > 0 THEN
                     CALL s_transaction_end('Y','0')
                     LET g_flag2 = TRUE
                     EXIT DIALOG
                  ELSE
                     CALL s_transaction_end('N','0')
                     LET g_flag2 = FALSE
                     EXIT DIALOG
                  END IF
               ELSE
                  CALL s_transaction_end('N','0')
                  LET g_flag2 = FALSE
                  EXIT DIALOG
               END IF
            END IF

            IF g_argv[1] = '2' THEN  #重覆性生產
               CALL s_transaction_begin()
               IF apmt500_06(g_pmdl_m.pmdldocno) THEN
                  CALL apmt500_b_fill()
                  LET g_rec_b = g_pmdn_d.getLength()
                  IF g_rec_b > 0 THEN
                     CALL s_transaction_end('Y','0')
                     LET g_flag2 = TRUE
                     EXIT DIALOG
                  ELSE
                     #160602-00002#1----s
                     #無資料產生
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'agl-00167'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #160602-00002#1----e                     
                     CALL s_transaction_end('N','0')
                     LET g_flag2 = FALSE
                     EXIT DIALOG
                  END IF
               ELSE
                  CALL s_transaction_end('N','0')
                  LET g_flag2 = FALSE
                  EXIT DIALOG
               END IF
            END IF    
            
            LET g_pmdn_d[l_ac].pmdnsite = g_site
            #LET g_pmdn_d[l_ac].pmdn002 =  ' '
            
            LET g_pmdn_d[l_ac].pmdnunit = g_site
            LET g_pmdn_d[l_ac].pmdnorga = g_site
            CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn_d[l_ac].pmdnunit_desc
            CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn_d[l_ac].pmdnorga_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdnunit_desc,g_pmdn_d[l_ac].pmdnorga_desc
            
            #新增時，若稅別應用=1.正常稅率，則單身的稅別、稅率預設為單頭的稅別、稅率
            IF g_tax_app = '1' THEN
               LET g_pmdn_d[l_ac].pmdn016 = g_pmdl_m.pmdl011
               LET g_pmdn_d[l_ac].pmdn017 = g_pmdl_m.pmdl012
            END IF
            
            CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc
            
            LET g_pmdn_d[l_ac].pmdn017 = g_pmdl_m.pmdl012
            
            LET g_pmdn_d[l_ac].pmdn023 = g_pmdl_m.pmdl022
            CALL apmt500_pmdl004_ref(g_pmdn_d[l_ac].pmdn023) RETURNING g_pmdn_d[l_ac].pmdn023_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn023_desc
            
            LET g_pmdn2_d[l_ac].pmdn031 = g_pmdl_m.pmdl020
            CALL apmt500_pmdl020_ref(g_pmdn2_d[l_ac].pmdn031) RETURNING g_pmdn2_d[l_ac].pmdn031_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn031_desc
            
            LET g_pmdn2_d[l_ac].pmdn025 = g_pmdl_m.pmdl025
            CALL apmt500_pmdl025_ref(g_pmdn2_d[l_ac].pmdn025) RETURNING g_pmdn2_d[l_ac].pmdn025_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn025_desc
            
            LET g_pmdn2_d[l_ac].pmdn026 = g_pmdl_m.pmdl026
            CALL apmt500_pmdl026_ref(g_pmdn2_d[l_ac].pmdn026) RETURNING g_pmdn2_d[l_ac].pmdn026_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026_desc
            
            #項次加1
            SELECT MAX(pmdnseq)+1 INTO g_pmdn_d[l_ac].pmdnseq FROM pmdn_t
              WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
            IF cl_null(g_pmdn_d[l_ac].pmdnseq) OR g_pmdn_d[l_ac].pmdnseq = 0 THEN
               LET g_pmdn_d[l_ac].pmdnseq = 1
            END IF
            LET g_pmdn2_d[l_ac].pmdnseq = g_pmdn_d[l_ac].pmdnseq
            
            #在新增訂單單身時，若已經有上一筆資料時，則出貨日期、收貨時段、理由碼、庫位、儲位等欄位則預設上一筆資料
            #到廠日期、到庫日期還是需要由料件前置時間+出貨日期做運算
            LET l_seq = g_pmdn_d[l_ac].pmdnseq - 1
            
            IF l_seq > 0 THEN
            
               SELECT pmdn012,pmdn049,pmdn028,pmdn029,pmdn030,pmdn053
                   INTO g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn049,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn030,g_pmdn2_d[l_ac].pmdn053
                  FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = l_seq
               #LET g_pmdn_d[l_ac].pmdn012 = g_pmdn_d[l_ac-1].pmdn012
               #LET g_pmdn_d[l_ac].pmdn049 = g_pmdn_d[l_ac-1].pmdn049
               #LET g_pmdn2_d[l_ac].pmdn028 = g_pmdn2_d[l_ac-1].pmdn028
               #LET g_pmdn2_d[l_ac].pmdn029 = g_pmdn2_d[l_ac-1].pmdn029
               #LET g_pmdn2_d[l_ac].pmdn030 = g_pmdn2_d[l_ac-1].pmdn030
               #LET g_pmdn2_d[l_ac].pmdn053 = g_pmdn2_d[l_ac-1].pmdn053
               
               CALL apmt500_pmdn049_ref(g_pmdn_d[l_ac].pmdn049) RETURNING g_pmdn_d[l_ac].pmdn049_desc
               DISPLAY BY NAME g_pmdn_d[l_ac].pmdn049_desc
               
               IF (NOT cl_null(g_pmdn_d[l_ac].pmdn012)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn001)) THEN
                  LET l_imaf173 = 0
                  LET l_imaf174 = 0
                  
                  SELECT imaf173,imaf174 INTO l_imaf173,l_imaf174
                    FROM imaf_t 
                    WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
                  
                  #1.輸入交貨日期後需自動計算到廠日期，公式為交貨日期+[T:料件據點進銷存檔].[C:到廠前置時間]
                  #2.輸入交貨日期後需自動計算到庫日期，公式為到廠日期+[T:料件據點進銷存檔].[C:到庫前置時間]
                  #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
                  SELECT ooef008,ooef009 INTO l_ooef008,l_ooef009 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001=g_site
                  
                  IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                     CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn012,0,l_imaf173) RETURNING g_pmdn_d[l_ac].pmdn013
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn013 = g_pmdn_d[l_ac].pmdn012
                  END IF
                  IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                     CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn013,0,l_imaf174) RETURNING g_pmdn_d[l_ac].pmdn014
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn014 = g_pmdn_d[l_ac].pmdn013
                  END IF
                  
                  #根據到庫日期計算緊急度
                  CALL apmt500_pmdn014_to_pmdn020()
               END IF
               DISPLAY BY NAME g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014
            END IF
            
            #150820#150819-00010 by whitney add start
            IF cl_null(g_pmdn2_d[l_ac].pmdn028) THEN
               CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING g_pmdn2_d[l_ac].pmdn028
            END IF
            #150820#150819-00010 by whitney add end
            
            CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
            
            CALL apmt500_pmdn029_ref(g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029) RETURNING g_pmdn2_d[l_ac].pmdn029_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn029_desc
            
            LET g_pmdn_d_t.* = g_pmdn_d[l_ac].*
            LET g_pmdn_d_o.* = g_pmdn_d[l_ac].*
            
            #end add-point  
  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身新增 name="input.body.b_a_insert"
            ##若單頭取價方式的基本資料設置單價不可為0時，則輸入的單價不可以為0
            #IF g_pmam006 = 'N' AND g_pmdn_d[l_ac].pmdn015 <= 0 THEN              
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.code = 'axc-00013'
            #   LET g_errparam.extend = g_pmdl_m.pmdldocno
            #   LET g_errparam.popup = TRUE
            #   CALL cl_err()
            #   #NEXT FIELD pmdn015
            #   CANCEL INSERT
            #END IF
            #
            ##依據取價方式設置的單價修改控管方式檢核修改後單價的合理性
            #LET l_errno = ''
            #IF NOT (cl_null(g_pmdl_m.pmdl017) OR cl_null(g_pmdn_d[l_ac].pmdn015) OR cl_null(g_pmdn2_d[l_ac].pmdn043) OR
            #        cl_null(g_pmdn2_d[l_ac].pmdn040) OR cl_null(g_pmdl_m.pmdl015) OR cl_null(g_pmdn_d[l_ac].pmdn001) OR
            #        cl_null(g_pmdn_d[l_ac].pmdn010)) THEN
            #   CALL s_purchase_price_check(g_pmdl_m.pmdl017,g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn040,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn010)
            #     RETURNING l_flag,l_errno
            #   IF NOT l_flag THEN
            #      INITIALIZE g_errparam TO NULL
            #      LET g_errparam.code = l_errno
            #      LET g_errparam.extend = ''
            #      LET g_errparam.popup = TRUE
            #      CALL cl_err() 
            #      #NEXT FIELD pmdn015
            #      CANCEL INSERT
            #   END IF  
            #END IF               
            ##檢查單身稅別不可空白
            #IF cl_null(g_pmdn_d[l_ac].pmdn016) THEN
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.code = 'axm-00231'
            #   LET g_errparam.extend = g_pmdl_m.pmdldocno
            #   LET g_errparam.popup = TRUE
            #   CALL cl_err()
            #   #NEXT FIELD pmdn016
            #   CANCEL INSERT
            #END IF          
            #料件有使用產品特徴則不可空白
            LET l_imaa005 = ''
            CALL apmt500_get_imaa005(g_enterprise,g_pmdn_d[l_ac].pmdn001) RETURNING l_imaa005
            IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' AND NOT cl_null(l_imaa005) THEN
            #   IF cl_null(g_pmdn_d[l_ac].pmdn002) THEN
            #      INITIALIZE g_errparam TO NULL
            #      LET g_errparam.code = 'sub-00124'
            #      LET g_errparam.extend = g_pmdl_m.pmdldocno
            #      LET g_errparam.popup = TRUE
            #      CALL cl_err()
            #      #NEXT FIELD pmdn002   
            #      CANCEL INSERT                  
            #   END IF
            ELSE 
               IF cl_null(g_pmdn_d[l_ac].pmdn002) THEN
                  LET g_pmdn_d[l_ac].pmdn002 = ' ' 
               END IF          
            END IF      
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM pmdn_t 
             WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
 
               AND pmdnseq = g_pmdn_d[l_ac].pmdnseq
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身新增前 name="input.body.b_insert"
               #整體參數未使用採購計價單位,則賦值當前的採購單位和數量
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" THEN
                  LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                  LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
               END IF               
               #end add-point
            
               #同步新增到同層的table
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmdl_m.pmdldocno
               LET gs_keys[2] = g_pmdn_d[g_detail_idx].pmdnseq
               CALL apmt500_insert_b('pmdn_t',gs_keys,"'1'")
                           
               #add-point:單身新增後 name="input.body.a_insert"
               #161031-00025#1---s
               IF NOT cl_null(g_pmdn_d[l_ac].ooff013) THEN
                  CALL s_aooi360_gen('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'','','','','','','','1',g_pmdn_d[l_ac].ooff013) RETURNING l_success
               END IF
               #161031-00025#1---e
                                       
               #end add-point
            ELSE    
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               INITIALIZE g_pmdn_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL apmt500_b_fill()
               #資料多語言用-增/改
               
               #add-point:input段-after_insert name="input.body.a_insert2"
               CALL s_transaction_end('Y','0')
               #CALL apmt500_04(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq)# RETURNING l_success
               IF g_pmdn_d[l_ac].pmdn024 = 'N' THEN
                  CALL s_apmt500_gen_pmdq(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) RETURNING l_success
               END IF
               
               CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) RETURNING l_success
               
               LET l_pmdnseq = NULL
               
               INITIALIZE l_pmdn.* TO NULL               
               SELECT pmdnent,pmdnsite,pmdndocno,pmdn001,pmdn002,
                      pmdn004,pmdn005,pmdn006,pmdn007,pmdn008,
	                   pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,
	                   pmdn045,pmdn010,pmdn011,pmdn015,pmdn016,
	                   pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,
	                   pmdn019,pmdn020,pmdn021,pmdn022,pmdnunit, 
                      pmdnorga,pmdn049,pmdn051,pmdn050,pmdn027,
	                   pmdn028,pmdn029,pmdn030,pmdn025,pmdn026,
	                   pmdn031,pmdn032,pmdn033,pmdn003,
	                   pmdn036,pmdn037,pmdn038,pmdn039,pmdn035,
	                   pmdn040,pmdn041,pmdn042,pmdn043,pmdn044
                INTO l_pmdn.pmdnent,l_pmdn.pmdnsite,l_pmdn.pmdndocno,l_pmdn.pmdn001,l_pmdn.pmdn002,
	                  l_pmdn.pmdn004,l_pmdn.pmdn005,l_pmdn.pmdn006,l_pmdn.pmdn007,l_pmdn.pmdn008,
	                  l_pmdn.pmdn009,l_pmdn.pmdn024,l_pmdn.pmdn012,l_pmdn.pmdn013,l_pmdn.pmdn014,
	                  l_pmdn.pmdn045,l_pmdn.pmdn010,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016,
	                  l_pmdn.pmdn017,l_pmdn.pmdn046,l_pmdn.pmdn047,l_pmdn.pmdn048,l_pmdn.pmdn023,
                     l_pmdn.pmdn019,l_pmdn.pmdn020,l_pmdn.pmdn021,l_pmdn.pmdn022,l_pmdn.pmdnunit,
	                  l_pmdn.pmdnorga,l_pmdn.pmdn049,l_pmdn.pmdn051,l_pmdn.pmdn050,l_pmdn.pmdn027,
	                  l_pmdn.pmdn028,l_pmdn.pmdn029,l_pmdn.pmdn030,l_pmdn.pmdn025,l_pmdn.pmdn026,
                     l_pmdn.pmdn031,l_pmdn.pmdn032,l_pmdn.pmdn033,l_pmdn.pmdn003,
	                  l_pmdn.pmdn036,l_pmdn.pmdn037,l_pmdn.pmdn038,l_pmdn.pmdn039,l_pmdn.pmdn035, 
                     l_pmdn.pmdn040,l_pmdn.pmdn041,l_pmdn.pmdn042,l_pmdn.pmdn043,l_pmdn.pmdn044
                 FROM pmdn_t 
                WHERE pmdnent = g_enterprise
                  AND pmdndocno = g_pmdl_m.pmdldocno
                  AND pmdnseq = g_pmdn_d[l_ac].pmdnseq
               
               IF l_inam.getLength() > 1 THEN  #因為第一筆資料已呈現在畫面並寫入DB, 從第二筆開始處理           
                  IF cl_null(l_pmdnseq) THEN   
                     SELECT MAX(pmdnseq) INTO l_pmdnseq
                       FROM pmdn_t
                      WHERE pmdnent   = g_enterprise
                        AND pmdndocno = g_pmdl_m.pmdldocno                     
                  END IF 
                  
                  CALL cl_err_collect_init()
                  LET l_length = l_inam.getLength()   #add by yany 2016/11/01
                  FOR l_i = 2 TO l_inam.getLength() 
                     IF cl_null(l_pmdnseq) OR l_pmdnseq = 0 THEN
                        LET l_pmdnseq = 1
                     ELSE
                        LET l_pmdnseq = l_pmdnseq + 1             
                     END IF 
                     
                     LET l_pmdn.pmdn002 = l_inam[l_i].inam002
                     LET l_pmdn.pmdn007 = l_inam[l_i].inam004
                     
                     #CALL cl_err_collect_init()
                     CALL s_apmt500_pmdn007_chk(g_pmdl_m.pmdldocno,l_pmdnseq,l_pmdn.pmdn001,l_pmdn.pmdn002,l_pmdn.pmdn004,l_pmdn.pmdn005,l_pmdn.pmdn006,l_pmdn.pmdn007) #add by lixiang 2015/10/15 pmdn002,pmdn004,pmdn005
                         RETURNING l_success,l_pmdn.pmdn007
                     IF NOT l_success THEN
                        CALL cl_err_collect_show()
                        CONTINUE FOR
                     END IF
                     
                     #計算參考數量
                     IF (NOT cl_null(l_pmdn.pmdn008)) AND (NOT cl_null(l_pmdn.pmdn001)) AND (NOT cl_null(l_pmdn.pmdn006)) THEN
                        #CALL s_aimi190_get_convert(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn008) RETURNING l_success,l_rate
                        #LET l_pmdn.pmdn009 = l_inam[l_i].inam004 * l_rate
                        CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn008,l_inam[l_i].inam004)
                               RETURNING l_success,l_pmdn.pmdn009
                        IF NOT cl_null(l_pmdn.pmdn009) THEN
                           CALL apmt500_unit_round(l_pmdn.pmdn008,l_pmdn.pmdn009) RETURNING l_pmdn.pmdn009
                        END IF 
                     END IF
                     
                     #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                     #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(l_pmdn.pmdn010)) AND (NOT cl_null(l_pmdn.pmdn001)) AND (NOT cl_null(l_pmdn.pmdn006)) THEN  #體參數使用採購計價單位
                        #CALL s_aimi190_get_convert(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn010) RETURNING l_success,l_rate
                        #LET l_pmdn.pmdn011 = l_inam[l_i].inam004 * l_rate
                        CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn010,l_inam[l_i].inam004)
                               RETURNING l_success,l_pmdn.pmdn011
                        IF NOT cl_null(l_pmdn.pmdn011) THEN
                           CALL apmt500_unit_round(l_pmdn.pmdn010,l_pmdn.pmdn011) RETURNING l_pmdn.pmdn011
                        END IF
                     ELSE
                        LET l_pmdn.pmdn010 = l_pmdn.pmdn006
                        LET l_pmdn.pmdn011 = l_pmdn.pmdn007                     
                     END IF
                     
                     CALL apmt500_get_qcap006(l_pmdn.pmdn001,l_pmdn.pmdn002,l_pmdn.pmdn004,l_pmdn.pmdn005) RETURNING l_pmdn.pmdn052
      
                     
                     #取出價格
                     IF cl_null(l_pmdn.pmdn010) OR cl_null(l_pmdn.pmdn011) THEN
                        LET l_pmdn.pmdn010 = l_pmdn.pmdn006
                        LET l_pmdn.pmdn011 = l_pmdn.pmdn007
                     END IF
                     CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,l_pmdn.pmdn001,l_pmdn.pmdn002,g_pmdl_m.pmdl015,
                             l_pmdn.pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                             g_pmdl_m.pmdldocdt,l_pmdn.pmdn010,l_pmdn.pmdn011,g_site,g_pmdl_m.pmdl054,g_type,l_pmdn.pmdn004,l_pmdn.pmdn005)
                         RETURNING l_pmdn.pmdn040,l_pmdn.pmdn043,l_pmdn.pmdn041,l_pmdn.pmdn042
                     
                     #若取到的價格為0 ，則給當前錄入的那個產品特徵的單價
                     IF l_pmdn.pmdn043 > 0 THEN
                        LET l_pmdn.pmdn015 = l_pmdn.pmdn043
                        LET l_pmdn.pmdn044 = 0
                     ELSE
                        LET l_pmdn.pmdn044 = ((l_pmdn.pmdn015 - l_pmdn.pmdn043) / l_pmdn.pmdn043) * 100
                     END IF
                     
                     LET l_pmdn.pmdnseq = l_pmdnseq
  
                     #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq,g_pmdl_m.pmdl015,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016)
                          RETURNING l_pmdn.pmdn046,l_pmdn.pmdn048,l_pmdn.pmdn047
                     
                     
                     INSERT INTO pmdn_t 
                           (pmdnent,pmdnsite,pmdndocno,pmdnseq,pmdn001,pmdn002,
                            pmdn004,pmdn005,pmdn006,pmdn007,pmdn008,
	                         pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,
	                         pmdn045,pmdn010,pmdn011,pmdn015,pmdn016,
	                         pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,
	                         pmdn019,pmdn020,pmdn021,pmdn022,pmdnunit, 
                            pmdnorga,pmdn049,pmdn051,pmdn050,pmdn027,
	                         pmdn028,pmdn029,pmdn030,pmdn025,pmdn026,
	                         pmdn031,pmdn032,pmdn033,pmdn003,
	                         pmdn036,pmdn037,pmdn038,pmdn039,pmdn035,
	                         pmdn040,pmdn041,pmdn042,pmdn043,pmdn044,pmdn052,
	                         pmdn054,pmdn055,pmdn056,pmdn057)
                          VALUES(l_pmdn.pmdnent,l_pmdn.pmdnsite,l_pmdn.pmdndocno,l_pmdnseq,l_pmdn.pmdn001,l_inam[l_i].inam002,
	                              l_pmdn.pmdn004,l_pmdn.pmdn005,l_pmdn.pmdn006,l_pmdn.pmdn007,l_pmdn.pmdn008,
	                              l_pmdn.pmdn009,l_pmdn.pmdn024,l_pmdn.pmdn012,l_pmdn.pmdn013,l_pmdn.pmdn014,
	                              l_pmdn.pmdn045,l_pmdn.pmdn010,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016,
	                              l_pmdn.pmdn017,l_pmdn.pmdn046,l_pmdn.pmdn047,l_pmdn.pmdn048,l_pmdn.pmdn023,
                                 l_pmdn.pmdn019,l_pmdn.pmdn020,l_pmdn.pmdn021,l_pmdn.pmdn022,l_pmdn.pmdnunit,
	                              l_pmdn.pmdnorga,l_pmdn.pmdn049,l_pmdn.pmdn051,l_pmdn.pmdn050,l_pmdn.pmdn027,
	                              l_pmdn.pmdn028,l_pmdn.pmdn029,l_pmdn.pmdn030,l_pmdn.pmdn025,l_pmdn.pmdn026,
                                 l_pmdn.pmdn031,l_pmdn.pmdn032,l_pmdn.pmdn033,l_pmdn.pmdn003,
	                              l_pmdn.pmdn036,l_pmdn.pmdn037,l_pmdn.pmdn038,l_pmdn.pmdn039,l_pmdn.pmdn035, 
                                 l_pmdn.pmdn040,l_pmdn.pmdn041,l_pmdn.pmdn042,l_pmdn.pmdn043,l_pmdn.pmdn044,l_pmdn.pmdn052,
                                 0,0,0,0) 
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "pmdn_t"
                        LET g_errparam.popup = FALSE
                        CALL cl_err()

                     END IF
                     
                     CALL s_apmt500_gen_pmdq(g_pmdl_m.pmdldocno,l_pmdnseq) RETURNING l_success
                     
                     CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,l_pmdnseq) RETURNING l_success
                     
                     #161031-00025#1---s
                     IF NOT cl_null(g_pmdn_d[l_ac].ooff013) THEN
                        CALL s_aooi360_gen('7',g_prog,g_pmdl_m.pmdldocno,l_pmdnseq,'','','','','','','','1',g_pmdn_d[l_ac].ooff013) RETURNING l_success
                     END IF
                     #161031-00025#1---e
                     
                  END FOR
                  CALL cl_err_collect_show() 
                  
                  #ming 20150903 add -------------------------(S) 
                  #科目預算 
                  LET l_insert1 = TRUE
                  CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
                       RETURNING l_success,l_slip
                  IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
                     IF cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
                        NEXT FIELD pmdn058
                     ELSE
                        CALL s_apmt500_stus_abg(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'I')
                             RETURNING l_success,l_errno
                        IF NOT l_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = ''
                           LET g_errparam.code   = l_errno
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()

                           CALL s_transaction_end('N','0')
                        END IF
                        LET l_insert1 = FALSE
                     END IF
                  END IF
                  #ming 20150903 add -------------------------(E) 
                  CALL apmt500_b_fill()
                  LET g_rec_b = l_inam.getLength() - 1
               END IF
               
                   
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身刪除後(=d) name="input.body.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身刪除前 name="input.body.b_delete"
               #ming 20150904 add --------------------------(S) 
               CALL s_apmt500_stus_abg(g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq,'D')
                    RETURNING l_success,l_errno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = l_errno
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF

               #ming 20150904 add --------------------------(E) 
               
               #更新工单sfcb041 委外数量
               #代买料不影响可委外数量
               IF g_pmdl_m.pmdl005 = '2' AND g_pmdl_m.pmdl007 = '4' THEN
                   IF g_pmdn_d_t.pmdn019 <> '8' THEN
                      DECLARE sfcb_upd CURSOR FOR 
                         SELECT DISTINCT pmdp003,pmdp004,pmdp023,pmdp009,pmdp010,pmdp001 FROM pmdp_t   #170208-00026#1 add pmdp001
                            WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                              AND pmdpseq = g_pmdn_d_t.pmdnseq
                      FOREACH sfcb_upd INTO l_pmdp003,l_pmdp004,l_pmdp023,l_pmdp009,l_pmdp010,l_pmdp001 #170208-00026#1 add pmdp001
                         #170208-00026#1 add   --begin--
                         SELECT COUNT(sfac001) INTO l_n1 FROM sfac_t
                          WHERE sfacent = g_enterprise AND sfacdocno = l_pmdp003
                            AND sfac001 = l_pmdp001 AND (sfac002 = '1' OR sfac002 = '2')
                         IF l_n1 = 0 THEN
                            CONTINUE FOREACH
                         END IF
                         #170208-00026#1 add   --end--
                      
                         #160316-00006#1---add---begin---
                         IF cl_null(l_pmdp009) THEN
                            LET l_pmdp009 = ' '
                         END IF
                         IF cl_null(l_pmdp010) THEN
                            LET l_pmdp010 = ' '
                         END IF
                         #160316-00006#1---add---end---
         
                         UPDATE sfcb_t SET sfcb041 = sfcb041 - l_pmdp023
                          WHERE sfcbent   = g_enterprise
                            AND sfcbdocno = l_pmdp003
                            AND sfcb001   = l_pmdp004
                            #AND sfcb003 = l_pmdp009  #160316-00006#1 mark
                            #AND sfcb004 = l_pmdp010  #160316-00006#1 mark
                            #160316-00006#1---add---begin---
                            AND (CASE WHEN sfcb003 IS NULL THEN ' ' ELSE sfcb003 END) = l_pmdp009
                            AND (CASE WHEN sfcb004 IS NULL THEN ' ' ELSE sfcb004 END) = l_pmdp010
                            #160316-00006#1---add---end---
                         IF SQLCA.sqlcode THEN
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = SQLCA.sqlcode
                            LET g_errparam.extend = 'update sfcb041'
                            LET g_errparam.popup = TRUE
                            CALL cl_err()
                         
                            CALL s_transaction_end('N','0')
                            CANCEL DELETE 
                            EXIT FOREACH                               
                         END IF
                      END FOREACH
                   END IF
               END IF               
               #end add-point 
               
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_pmdl_m.pmdldocno
 
               LET gs_keys[gs_keys.getLength()+1] = g_pmdn_d_t.pmdnseq
 
            
               #刪除同層單身
               IF NOT apmt500_delete_b('pmdn_t',gs_keys,"'1'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT apmt500_key_delete_b(gs_keys,'pmdn_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
 
               
               #add-point:單身刪除中 name="input.body.m_delete"
                  DELETE FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = g_pmdn_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdo_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF
                  
                  #更新請購單中的已轉採購量
                  IF NOT s_apmt500_upd_pmdb049(g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq,'-1') THEN
                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF
                  
                  DELETE FROM pmdp_t WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdp_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF

                  DELETE FROM pmdq_t WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdq_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF
                  
                  #刪除交易稅明細檔
                  DELETE FROM xrcd_t
                   WHERE xrcdent = g_enterprise
                     AND xrcddocno = g_pmdl_m.pmdldocno
                     AND xrcdseq = g_pmdn_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = "DELETE xrcd_t"
                     LET g_errparam.code   = SQLCA.sqlcode
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     CANCEL DELETE
                  END IF       

               #161031-00025#1---s
               CALL s_aooi360_del('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq,'','','','','','','','1') RETURNING l_success
               #161031-00025#1---e
               #end add-point 
               
               CALL s_transaction_end('Y','0')
               CLOSE apmt500_bcl
            
               LET g_rec_b = g_rec_b-1
               #add-point:單身刪除後 name="input.body.a_delete"
               
                  
               #end add-point
               LET l_count = g_pmdn_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body.after_delete"
                        
               #end add-point
            END IF
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_pmdn_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnsite
            #add-point:BEFORE FIELD pmdnsite name="input.b.page1.pmdnsite"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnsite
            
            #add-point:AFTER FIELD pmdnsite name="input.a.page1.pmdnsite"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdnsite
            #add-point:ON CHANGE pmdnsite name="input.g.page1.pmdnsite"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnseq
            #add-point:BEFORE FIELD pmdnseq name="input.b.page1.pmdnseq"
            ##單身沒有數據，即第一次新增
            #LET l_n = 0
            #SELECT COUNT(1) INTO l_n FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
            #IF cl_null(l_n) THEN
            #   LET l_n = 0
            #END IF
            #IF l_cmd = 'a' AND cl_null(g_pmdn_d[l_ac].pmdn001) AND l_n = 0 THEN
            #   CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
            #   IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
            #      IF apmt500_01(g_pmdl_m.pmdldocno) THEN
            #         CALL apmt500_b_fill()
            #         LET g_rec_b = g_pmdn_d.getLength()
            #         IF g_rec_b > 0 THEN
            #            CALL s_transaction_end('Y','0')
            #            #CALL apmt500_b_fill()
            #            LET g_flag2 = TRUE
            #            EXIT DIALOG
            #         ELSE
            #            LET g_flag2 = FALSE
            #            NEXT FIELD pmdn001
            #         END IF
            #      ELSE
            #         CALL s_transaction_end('N','0')
            #         LET g_flag2 = FALSE
            #         NEXT FIELD pmdn001
            #      END IF
            #   END IF
            #END IF
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnseq
            
            #add-point:AFTER FIELD pmdnseq name="input.a.page1.pmdnseq"
            #此段落由子樣板a05產生
            IF NOT cl_ap_chk_range(g_pmdn_d[l_ac].pmdnseq,"0.000","0","","","azz-00079",1) THEN
               LET g_pmdn_d[l_ac].pmdnseq = g_pmdn_d_t.pmdnseq
               NEXT FIELD pmdnseq
            END IF
            IF  g_pmdl_m.pmdldocno IS NOT NULL AND g_pmdn_d[l_ac].pmdnseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdl_m.pmdldocno != g_pmdldocno_t OR g_pmdn_d[l_ac].pmdnseq != g_pmdn_d_t.pmdnseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdn_t WHERE "||"pmdnent = '" ||g_enterprise|| "' AND "||"pmdndocno = '"||g_pmdl_m.pmdldocno ||"' AND "|| "pmdnseq = '"||g_pmdn_d[l_ac].pmdnseq ||"'",'std-00004',0) THEN 
                     LET g_pmdn_d[l_ac].pmdnseq = g_pmdn_d_t.pmdnseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdnseq
            #add-point:ON CHANGE pmdnseq name="input.g.page1.pmdnseq"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn001
            
            #add-point:AFTER FIELD pmdn001 name="input.a.page1.pmdn001"
            CALL apmt500_pmdn001_ref(g_pmdn_d[l_ac].pmdn001) RETURNING g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004  #160725-00019#1
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004  #160725-00019#1
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn001) THEN 
               #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdn_d[l_ac].pmdn001 != g_pmdn_d_o.pmdn001)) THEN 
               IF g_pmdn_d[l_ac].pmdn001 != g_pmdn_d_o.pmdn001 OR cl_null(g_pmdn_d_o.pmdn001) THEN
                  IF NOT apmt500_pmdn001_chk(g_pmdn_d[l_ac].pmdn001) THEN
                     LET g_pmdn_d[l_ac].pmdn001 = g_pmdn_d_o.pmdn001
                     CALL apmt500_pmdn001_ref(g_pmdn_d[l_ac].pmdn001) RETURNING g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
                  END IF
                  CALL apmt500_pmdn001_desc()
                  
                  #修改料號時需要開窗詢問是否重新取價，若選擇要時則需呼叫取價應用元件重新取價，
                  #並重新呼叫'計算金額'應用元件計算[C:含稅金額]、[C:未稅金額]、[C:稅額]
                  IF l_cmd = 'u' THEN 
                     IF cl_ask_confirm('axm-00230') THEN                              
                        #取出價格
                        IF cl_null(g_pmdn_d[l_ac].pmdn010) OR cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                           LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                           LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                        END IF
                        CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                                g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                            RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                       
                        LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                        LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                        LET g_pmdn2_d[l_ac].pmdn044 = 0
                        
                        #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                        CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                             RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        
                     END IF
                  ELSE
                     #取出價格
                     IF cl_null(g_pmdn_d[l_ac].pmdn010) OR cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                        LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                        LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                     END IF
                     CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                             g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                             g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                         RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                     
                     LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                     LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                     LET g_pmdn2_d[l_ac].pmdn044 = 0
                     
                     #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                          RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        
                                       
                  END IF   
               END IF
               LET g_pmdn_d_o.pmdn001 = g_pmdn_d[l_ac].pmdn001
            END IF 
           
            CALL apmt500_set_entry_b(l_cmd)
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()
            CALL apmt500_set_no_entry_b(l_cmd)
            
            LET g_pmdn2_d[l_ac].imaa001 = g_pmdn_d[l_ac].pmdn001
            LET g_pmdn2_d[l_ac].imaal003 = g_pmdn_d[l_ac].pmdn001_desc
            LET g_pmdn2_d[l_ac].imaal004 = g_pmdn_d[l_ac].imaal004
            #160314-00009#4   marked by zhujing 2016-3-16---(S)
#            LET l_imaa005 = ''
#            CALL apmt500_get_imaa005(g_enterprise,g_pmdn_d[l_ac].pmdn001) RETURNING l_imaa005
            #160314-00009#4   marked by zhujing 2016-3-16---(E) 
            #使用產品特徵 
            CALL l_inam.clear()
            IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' THEN 
#               IF NOT cl_null(l_imaa005) THEN     #160314-00009#4   marked by zhujing 2016-3-16
               IF s_feature_auto_chk(g_pmdn_d[l_ac].pmdn001) AND cl_null(g_pmdn_d[l_ac].pmdn002) THEN #160314-00009#4   mod by zhujing 2016-3-16
                  IF l_cmd = 'a' THEN            
                     #CALL l_inam.clear() 
                     #160725-00019#1--s
                     DISPLAY g_pmdn_d[l_ac].pmdn001_desc TO s_detail1[l_ac].pmdn001_desc
                     DISPLAY g_pmdn_d[l_ac].imaal004 TO s_detail1[l_ac].imaal004
                     #160725-00019#1--e                     
                     CALL s_feature(l_cmd,g_pmdn_d[l_ac].pmdn001,'','',g_site,g_pmdl_m.pmdldocno) RETURNING l_success,l_inam
                     LET g_pmdn_d[l_ac].pmdn002 = l_inam[1].inam002
                     LET g_pmdn_d[l_ac].pmdn007 = l_inam[1].inam004
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn007
                     
                     IF NOT cl_null(g_pmdn_d[l_ac].pmdn007) THEN  #160725-00019#1
                        #計算參考數量
                        IF (NOT cl_null(g_pmdn_d[l_ac].pmdn008)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn001)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) THEN
                           #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008) RETURNING l_success,l_rate
                           #LET g_pmdn_d[l_ac].pmdn009 = g_pmdn_d[l_ac].pmdn007 * l_rate
                           CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn007)
                                  RETURNING l_success,g_pmdn_d[l_ac].pmdn009
                           IF NOT cl_null(g_pmdn_d[l_ac].pmdn009) THEN
                              CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009) RETURNING g_pmdn_d[l_ac].pmdn009
                              DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009
                           END IF 
                        END IF
                        
                        #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                        #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                        IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdn_d[l_ac].pmdn010)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn001)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) THEN  #體參數使用採購計價單位
                           #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010) RETURNING l_success,l_rate
                           #LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007 * l_rate
                           CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn007)
                                  RETURNING l_success,g_pmdn_d[l_ac].pmdn011
                           IF NOT cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                              CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011) RETURNING g_pmdn_d[l_ac].pmdn011
                              DISPLAY BY NAME g_pmdn_d[l_ac].pmdn011
                           END IF
                        ELSE
                           LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                           LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007                  
                        END IF
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009,g_pmdn_d[l_ac].pmdn011
                        
                        CALL s_apmt500_pmdn007_chk(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007) #add by lixiang 2015/10/15 pmdn002,pmdn004,pmdn005
                            RETURNING l_success,g_pmdn_d[l_ac].pmdn007
                        IF NOT l_success THEN
                           NEXT FIELD pmdn007
                        END IF
                     END IF  #160725-00019#1
                  END IF
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn001
            #add-point:BEFORE FIELD pmdn001 name="input.b.page1.pmdn001"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn001
            #add-point:ON CHANGE pmdn001 name="input.g.page1.pmdn001"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn002
            
            #add-point:AFTER FIELD pmdn002 name="input.a.page1.pmdn002"
            CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002_desc 
            
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn002) THEN 
               #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdn_d[l_ac].pmdn002 != g_pmdn_d_o.pmdn002)) THEN 
               IF NOT s_feature_check(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) THEN
                  LET g_pmdn_d[l_ac].pmdn002 = g_pmdn_d_o.pmdn002
                  CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002_desc
                  NEXT FIELD CURRENT
               END IF
               #151224-00025#3 add start ------------------------
               IF NOT s_feature_direct_input(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d_o.pmdn002,g_pmdl_m.pmdldocno,g_pmdl_m.pmdlsite) THEN
                  NEXT FIELD CURRENT
               END IF
               #151224-00025#3 add end   ------------------------
               #檢查料件編號是否符合條件
              #IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) THEN #add by lixiang 2015/10/15 pmdn007 #add by lixiang 2015/12/04 add pmdldocno，pmdnseq   ##170207-00046#1 mark
               IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq) THEN     #170207-00046#1 add
                  LET g_pmdn_d[l_ac].pmdn002 = g_pmdn_d_o.pmdn002
                  CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002_desc
                  NEXT FIELD CURRENT
               END IF
                  
               IF g_pmdn_d[l_ac].pmdn002 != g_pmdn_d_o.pmdn002 OR cl_null(g_pmdn_d_o.pmdn002) THEN 
                  #2.呼叫產品特徵檢核應用元件，檢核輸入的產品特徵值是否合理
                  #3.當請採勾稽時，採購料號+採購產品特徵與請購料號+請購產品特徵不一樣時，必須檢核是否與請購料號+
                  #  請購產品特徵有替代關係，若沒有則不允許修改
                  
                  CALL apmt500_pmdn001_desc()
                  #修改料號時需要開窗詢問是否重新取價，若選擇要時則需呼叫取價應用元件重新取價，
                  #並重新呼叫'計算金額'應用元件計算[C:含稅金額]、[C:未稅金額]、[C:稅額]
                  IF l_cmd = 'u' THEN
                     IF cl_ask_confirm('axm-00230') THEN                              
                        #取出價格
                        IF cl_null(g_pmdn_d[l_ac].pmdn010) OR cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                           LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                           LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                        END IF
                        CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                                g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                            RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                        

                        LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                        LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                        LET g_pmdn2_d[l_ac].pmdn044 = 0

                        #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                        CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                             RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        
                     END IF
                  ELSE
                     #取出價格
                     IF cl_null(g_pmdn_d[l_ac].pmdn010) OR cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                        LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                        LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                     END IF
                     CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                             g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                             g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                         RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                     

                     LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                     LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                     LET g_pmdn2_d[l_ac].pmdn044 = 0

                     #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                          RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047     
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                                                  
                  END IF   
                                   
               END IF
               LET g_pmdn_d_o.pmdn002 = g_pmdn_d[l_ac].pmdn002
            END IF
            #IF cl_null(g_pmdn_d[l_ac].pmdn002) THEN
            #   LET g_pmdn_d[l_ac].pmdn002 = ' '
            #END IF   
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn002
            #add-point:BEFORE FIELD pmdn002 name="input.b.page1.pmdn002"
            #160314-00009#4   add by zhujing 2016-3-16----(S)
#            IF NOT cl_null(g_pmdn_d[l_ac].pmdn001) THEN
#               IF s_feature_auto_chk(g_pmdn_d[l_ac].pmdn001) AND cl_null(g_pmdn_d[l_ac].pmdn002) THEN
#                  CALL s_feature_single(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_site,'') RETURNING l_success,g_pmdn_d[l_ac].pmdn002
#                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002
#                  CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) 
#                     RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
#               END IF
#            END IF
            #160314-00009#4   add by zhujing 2016-3-16----(E)
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn002
            #add-point:ON CHANGE pmdn002 name="input.g.page1.pmdn002"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn004
            
            #add-point:AFTER FIELD pmdn004 name="input.a.page1.pmdn004"
            CALL apmt500_pmdn004_ref(g_pmdn_d[l_ac].pmdn004) RETURNING g_pmdn_d[l_ac].pmdn004_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn004_desc
            
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn004) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdn_d[l_ac].pmdn004
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aqc-00017:sub-01302|aeci004|",cl_get_progname("aeci004",g_lang,"2"),"|:EXEPROGaeci004"
               LET g_chkparam.err_str[2] ="aqc-00016:sub-01303|aeci004|",cl_get_progname("aeci004",g_lang,"2"),"|:EXEPROGaeci004"
               #160318-00025#15 by 07900 --add-end   
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_221") THEN
                  #檢查成功時後續處理
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdn_d[l_ac].pmdn004 = g_pmdn_d_t.pmdn004
                  CALL apmt500_pmdn004_ref(g_pmdn_d[l_ac].pmdn004) RETURNING g_pmdn_d[l_ac].pmdn004_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn004_desc
                  NEXT FIELD CURRENT
               END IF
               
               #檢查料件編號是否符合條件
              #IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) THEN #add by lixiang 2015/10/15 pmdn007 #add by lixiang 2015/12/04 add pmdldocno，pmdnseq  #170207-00046#1 mark
               IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq) THEN #170207-00046#1 add            
                  LET g_pmdn_d[l_ac].pmdn004 = g_pmdn_d_t.pmdn004
                  CALL apmt500_pmdn004_ref(g_pmdn_d[l_ac].pmdn004) RETURNING g_pmdn_d[l_ac].pmdn004_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn004_desc
                  NEXT FIELD CURRENT
               END IF
               
               CALL apmt500_get_qcap006(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005) RETURNING g_pmdn_d[l_ac].pmdn052
               
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn004
            #add-point:BEFORE FIELD pmdn004 name="input.b.page1.pmdn004"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn004
            #add-point:ON CHANGE pmdn004 name="input.g.page1.pmdn004"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn005
            #add-point:BEFORE FIELD pmdn005 name="input.b.page1.pmdn005"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn005
            
            #add-point:AFTER FIELD pmdn005 name="input.a.page1.pmdn005"
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn005) THEN 
               #檢查料件編號是否符合條件
              #IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) THEN #add by lixiang 2015/10/15 pmdn007 #add by lixiang 2015/12/04 add pmdldocno，pmdnseq  #170207-00046#1 mark
               IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq) THEN #170207-00046#1 add   
                  LET g_pmdn_d[l_ac].pmdn005 = g_pmdn_d_t.pmdn005
                  NEXT FIELD CURRENT
               END IF
               
               CALL apmt500_get_qcap006(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005) RETURNING g_pmdn_d[l_ac].pmdn052
               
            END IF             
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn005
            #add-point:ON CHANGE pmdn005 name="input.g.page1.pmdn005"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn006
            
            #add-point:AFTER FIELD pmdn006 name="input.a.page1.pmdn006"
            CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn006) RETURNING g_pmdn_d[l_ac].pmdn006_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn006_desc
            IF (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) AND (g_pmdn_d[l_ac].pmdn006 != g_pmdn_d_o.pmdn006 OR cl_null(g_pmdn_d_o.pmdn006)) THEN 
               IF NOT apmt500_unit_chk(g_pmdn_d[l_ac].pmdn006) THEN
                  LET g_pmdn_d[l_ac].pmdn006 = g_pmdn_d_t.pmdn006
                  CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn006) RETURNING g_pmdn_d[l_ac].pmdn006_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn006_desc
                  NEXT FIELD pmdn006
               END IF
               
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn007) THEN
                  CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007) RETURNING g_pmdn_d[l_ac].pmdn007
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn007 
                  
                  IF l_cmd = 'u' OR (g_pmdn_d[l_ac].pmdn007 <> 0 AND NOT cl_null(g_pmdn_d_o.pmdn007)) THEN #20150505 modify by lixiang 150504-00013#8
                     CALL cl_err_collect_init()
                     CALL s_apmt500_pmdn007_chk(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007)  #add by lixiang 2015/10/15 pmdn002,pmdn004,pmdn005
                         RETURNING l_success,l_pmdn007
                     CALL cl_err_collect_show()
                     IF NOT l_success THEN
                        LET g_pmdn_d[l_ac].pmdn006 = g_pmdn_d_o.pmdn006
                        NEXT FIELD pmdn006
                     END IF
                  END IF #20150505 modify by lixiang 150504-00013#8
                  
                  #計算參考數量
                  IF NOT cl_null(g_pmdn_d[l_ac].pmdn008) THEN
                     #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008) RETURNING l_success,l_rate
                     #LET g_pmdn_d[l_ac].pmdn009 = g_pmdn_d[l_ac].pmdn007 * l_rate
                     CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn009
                     IF NOT cl_null(g_pmdn_d[l_ac].pmdn009) THEN
                        CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009) RETURNING g_pmdn_d[l_ac].pmdn009
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009
                     END IF 
                  END IF
                  
                  #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                  #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                  IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdn_d[l_ac].pmdn010)) THEN  #體參數使用採購計價單位
                     #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010) RETURNING l_success,l_rate
                     #LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007 * l_rate
                     CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn011
                     IF NOT cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                        CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011) RETURNING g_pmdn_d[l_ac].pmdn011
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn011
                     END IF 
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                     LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                  END IF
                  IF g_pmdn_d[l_ac].pmdn011 != g_pmdn_d_o.pmdn011 OR cl_null(g_pmdn_d_o.pmdn011) THEN
                     IF cl_ask_confirm('axm-00230') THEN
                        IF NOT cl_null(g_pmdn_d[l_ac].pmdn010) THEN
                           #取出價格
                           CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                                   g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                   g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                               RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                        
                           LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                           LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                           LET g_pmdn2_d[l_ac].pmdn044 = 0
                                   
                           CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                                   RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                           DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                                      
                        END IF
                     END IF                        
                  END IF      
               END IF
               LET g_pmdn_d_o.pmdn006 = g_pmdn_d[l_ac].pmdn006            
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn006
            #add-point:BEFORE FIELD pmdn006 name="input.b.page1.pmdn006"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn006
            #add-point:ON CHANGE pmdn006 name="input.g.page1.pmdn006"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn007
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn_d[l_ac].pmdn007,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdn007
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdn007 name="input.a.page1.pmdn007"
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn007) THEN 
               IF g_pmdn_d[l_ac].pmdn007 != g_pmdn_d_o.pmdn007 OR cl_null(g_pmdn_d_o.pmdn007) THEN
                  #CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
                  #IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
                  CALL cl_err_collect_init()
                  CALL s_apmt500_pmdn007_chk(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007)   #add by lixiang 2015/10/15 pmdn002,pmdn004,pmdn005
                    RETURNING l_success,l_pmdn007
                  CALL cl_err_collect_show()
                  IF NOT l_success THEN
                     LET g_pmdn_d[l_ac].pmdn007 = g_pmdn_d_o.pmdn007
                     NEXT FIELD pmdn007
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn007 = l_pmdn007
                  END IF
                  #END IF
                  
                  #--151210-00002#1--add--(s)
                  #如來源為訂單，需控卡不可大於訂購量
                  IF g_pmdl_m.pmdl007 = '3' AND NOT cl_null(g_pmdl_m.pmdl008) THEN
                     IF NOT apmt500_order_chk() THEN                                     
                        LET g_pmdn_d[l_ac].pmdn007 = g_pmdn_d_o.pmdn007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #--151210-00002#1--add--(e)
                  
                  IF NOT cl_null(g_pmdn_d[l_ac].pmdn006) THEN
                     CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007) RETURNING g_pmdn_d[l_ac].pmdn007
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn007   
                  
                     #計算參考數量
                     IF NOT cl_null(g_pmdn_d[l_ac].pmdn008) THEN
                        #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008) RETURNING l_success,l_rate
                        #LET g_pmdn_d[l_ac].pmdn009 = g_pmdn_d[l_ac].pmdn007 * l_rate
                        CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn009
                        IF NOT cl_null(g_pmdn_d[l_ac].pmdn009) THEN
                           CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009) RETURNING g_pmdn_d[l_ac].pmdn009
                           DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009
                        END IF 
                     END IF
                     
                     #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                     #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdn_d[l_ac].pmdn010)) THEN  #體參數使用採購計價單位
                        #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010) RETURNING l_success,l_rate
                        #LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007 * l_rate
                        CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn011
                        IF NOT cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                           CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011) RETURNING g_pmdn_d[l_ac].pmdn011
                           DISPLAY BY NAME g_pmdn_d[l_ac].pmdn011
                        END IF
                     ELSE
                        LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                        LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007                     
                     END IF
                     
                     #取出價格
                     IF cl_null(g_pmdn_d[l_ac].pmdn010) OR cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                        LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                        LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                     END IF
                     CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                                g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                            RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                  
                     LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                     LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                     LET g_pmdn2_d[l_ac].pmdn044 = 0
  
                     #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                          RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                     
                     #ming 20150903 add ------------------------------------(S) 
                     #科目預算  
                     CALL apmt500_detail_abg('4')
                          RETURNING l_success,l_errno_abg,l_bgaf016,
                                    l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql

                     IF NOT l_success THEN
                        CASE l_errno_abg
                           WHEN 'abg-00103'     #輸入金額超出預算限額，不可輸入!!!  
                              CASE l_bgaf016
                                 WHEN '1'
                                 WHEN '2'
                                    INITIALIZE g_errparam TO NULL
                                    LET g_errparam.extend = ''
                                    LET g_errparam.code   = l_errno_abg
                                    LET g_errparam.popup  = TRUE
                                    CALL cl_err()
                                 WHEN '3'
                                    INITIALIZE g_errparam TO NULL
                                    LET g_errparam.extend = ''
                                    LET g_errparam.code   = l_errno_abg
                                    LET g_errparam.popup  = TRUE
                                    CALL cl_err()
                                    NEXT FIELD CURRENT
                              END CASE
                           WHEN 'abg-00104'     #輸入金額超出可用預算，請加速審核!!! 
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.extend = '' 
                              LET g_errparam.code   = l_errno_abg
                              LET g_errparam.popup  = TRUE
                              CALL cl_err()
                           OTHERWISE
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.extend = ''
                              LET g_errparam.code   = l_errno_abg
                              LET g_errparam.popup  = TRUE
                              CALL cl_err()
                              NEXT FIELD CURRENT
                        END CASE
                     END IF
                     #ming 20150903 add ------------------------------------(E)                               
                  END IF

                  #如果有維護多交期，重新維護價格
                  IF g_pmdn_d[l_ac].pmdn024 = 'Y' THEN
                     CALL apmt500_03(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn007) 
                       RETURNING g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014
                     #如果當前筆資料有多筆交期，則更像採購單單身的多交期欄位為'Y'
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM pmdq_t 
                        WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn_d[l_ac].pmdnseq
                     IF l_n > 1 THEN
                        LET g_pmdn_d[l_ac].pmdn024 = 'Y'
                     ELSE
                        LET g_pmdn_d[l_ac].pmdn024 = 'N'
                     END IF
                     #呼叫"產生採購交期明細資料"的Function產生交期明細資料
                     CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) RETURNING l_success
                  END IF
               END IF
            END IF 
            
            LET g_pmdn_d_o.pmdn007 = g_pmdn_d[l_ac].pmdn007

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn007
            #add-point:BEFORE FIELD pmdn007 name="input.b.page1.pmdn007"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn007
            #add-point:ON CHANGE pmdn007 name="input.g.page1.pmdn007"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn008
            
            #add-point:AFTER FIELD pmdn008 name="input.a.page1.pmdn008"
            CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn008) RETURNING g_pmdn_d[l_ac].pmdn008_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn008_desc
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn008) THEN 
               IF NOT apmt500_unit_chk(g_pmdn_d[l_ac].pmdn008) THEN
                  LET g_pmdn_d[l_ac].pmdn008 = g_pmdn_d_t.pmdn008
                  CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn008) RETURNING g_pmdn_d[l_ac].pmdn008_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn008_desc
                  NEXT FIELD CURRENT
               END IF
               
               #計算參考數量
               IF (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn007)) THEN
                  #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008) RETURNING l_success,l_rate
                  #LET g_pmdn_d[l_ac].pmdn009 = g_pmdn_d[l_ac].pmdn007 * l_rate
                  CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn009
               END IF
                  
               
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn009) THEN
                  CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009) RETURNING g_pmdn_d[l_ac].pmdn009
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009   
               END IF 
            END IF 
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn008
            #add-point:BEFORE FIELD pmdn008 name="input.b.page1.pmdn008"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn008
            #add-point:ON CHANGE pmdn008 name="input.g.page1.pmdn008"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn009
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn_d[l_ac].pmdn009,"0.000","1","","","azz-00079",1) THEN
               NEXT FIELD pmdn009
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdn009 name="input.a.page1.pmdn009"
                                    IF NOT cl_null(g_pmdn_d[l_ac].pmdn009) THEN
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn008) THEN
                  CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009) RETURNING g_pmdn_d[l_ac].pmdn009
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009   
               END IF             
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn009
            #add-point:BEFORE FIELD pmdn009 name="input.b.page1.pmdn009"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn009
            #add-point:ON CHANGE pmdn009 name="input.g.page1.pmdn009"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn024
            #add-point:BEFORE FIELD pmdn024 name="input.b.page1.pmdn024"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn024
            
            #add-point:AFTER FIELD pmdn024 name="input.a.page1.pmdn024"
            LET g_pmdn_d_o.pmdn024 = g_pmdn_d[l_ac].pmdn024
            CALL apmt500_set_entry_b(l_cmd)
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()
            CALL apmt500_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn024
            #add-point:ON CHANGE pmdn024 name="input.g.page1.pmdn024"
            IF g_pmdn_d[l_ac].pmdn024 = 'Y' THEN
               CALL apmt500_03(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn007) 
                 RETURNING g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014
               #如果當前筆資料有多筆交期，則更像採購單單身的多交期欄位為'Y'
               LET l_n = 0
               SELECT COUNT(1) INTO l_n FROM pmdq_t 
                  WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn_d[l_ac].pmdnseq
               IF l_n > 1 THEN
                  LET g_pmdn_d[l_ac].pmdn024 = 'Y'
               ELSE
                  LET g_pmdn_d[l_ac].pmdn024 = 'N'
               END IF
               #呼叫"產生採購交期明細資料"的Function產生交期明細資料
               CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) RETURNING l_success
            END IF

            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn012
            #add-point:BEFORE FIELD pmdn012 name="input.b.page1.pmdn012"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn012
            
            #add-point:AFTER FIELD pmdn012 name="input.a.page1.pmdn012"
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn012) THEN
               LET l_imaf173 = 0
               LET l_imaf174 = 0
               
               SELECT imaf173,imaf174 INTO l_imaf173,l_imaf174
                 FROM imaf_t 
                 WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
               #160222-00020#1--add---begin---
               #若是料件未設置，則抓取aoo020上設置的資料
               IF cl_null(l_imaf173) OR l_imaf173 = 0 THEN
                  LET l_imaf173 =  cl_get_para(g_enterprise,g_site,'S-BAS-0026')
               END IF
               IF cl_null(l_imaf174) OR l_imaf174 = 0 THEN
                  LET l_imaf174 =  cl_get_para(g_enterprise,g_site,'S-BAS-0027')
               END IF
               #160222-00020#1--add---end--- 
               
               #1.輸入交貨日期後需自動計算到廠日期，公式為交貨日期+[T:料件據點進銷存檔].[C:到廠前置時間]
               #2.輸入交貨日期後需自動計算到庫日期，公式為到廠日期+[T:料件據點進銷存檔].[C:到庫前置時間]
               #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
               SELECT ooef008,ooef009 INTO l_ooef008,l_ooef009 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001=g_site
               
               IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                  CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn012,0,l_imaf173) RETURNING g_pmdn_d[l_ac].pmdn013
               ELSE
                  LET g_pmdn_d[l_ac].pmdn013 = g_pmdn_d[l_ac].pmdn012
               END IF
               IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                  CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn013,0,l_imaf174) RETURNING g_pmdn_d[l_ac].pmdn014
               ELSE
                  LET g_pmdn_d[l_ac].pmdn014 = g_pmdn_d[l_ac].pmdn013
               END IF
               
               #根據到庫日期計算緊急度
               CALL apmt500_pmdn014_to_pmdn020()
            END IF
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn012
            #add-point:ON CHANGE pmdn012 name="input.g.page1.pmdn012"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn013
            #add-point:BEFORE FIELD pmdn013 name="input.b.page1.pmdn013"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn013
            
            #add-point:AFTER FIELD pmdn013 name="input.a.page1.pmdn013"
                                    LET l_imaf173 = 0
            LET l_imaf174 = 0
 
            SELECT imaf173,imaf174 INTO l_imaf173,l_imaf174
              FROM imaf_t 
              WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
            
            #160222-00020#1--add---begin---
            #若是料件未設置，則抓取aoo020上設置的資料
            IF cl_null(l_imaf173) OR l_imaf173 = 0 THEN
               LET l_imaf173 =  cl_get_para(g_enterprise,g_site,'S-BAS-0026')
            END IF
            IF cl_null(l_imaf174) OR l_imaf174 = 0 THEN
               LET l_imaf174 =  cl_get_para(g_enterprise,g_site,'S-BAS-0027')
            END IF
            #160222-00020#1--add---end---             
            #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
            SELECT ooef008,ooef009 INTO l_ooef008,l_ooef009 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001=g_site
                  
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn013) THEN
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn012) THEN
                  IF g_pmdn_d[l_ac].pmdn013 < g_pmdn_d[l_ac].pmdn012 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00267'
                     LET g_errparam.extend = g_pmdn_d[l_ac].pmdn013
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].pmdn013 = g_pmdn_d_t.pmdn013
                     NEXT FIELD CURRENT
                   END IF
               ELSE
                  #若交貨日期為NULL時，輸入到廠日期後需自動計算交貨日期，公式為到廠日期-[T:料件據點進銷存檔].[C:到廠前置時間]
                  IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                     CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn013,0,(l_imaf173*(-1))) RETURNING g_pmdn_d[l_ac].pmdn012
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn012 = g_pmdn_d[l_ac].pmdn013
                  END IF
               END IF
               #2.輸入到廠日期後需自動計算到庫日期，公式為到廠日期+[T:料件據點進銷存檔].[C:到庫前置時間]
               IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                  CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn013,0,l_imaf174) RETURNING g_pmdn_d[l_ac].pmdn014
               ELSE
                  LET g_pmdn_d[l_ac].pmdn014 = g_pmdn_d[l_ac].pmdn013
               END IF
               
               #根據到庫日期計算緊急度
               CALL apmt500_pmdn014_to_pmdn020()
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn013
            #add-point:ON CHANGE pmdn013 name="input.g.page1.pmdn013"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn014
            #add-point:BEFORE FIELD pmdn014 name="input.b.page1.pmdn014"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn014
            
            #add-point:AFTER FIELD pmdn014 name="input.a.page1.pmdn014"
                                    LET l_imaf173 = 0
            LET l_imaf174 = 0
 
            SELECT imaf173,imaf174 INTO l_imaf173,l_imaf174
              FROM imaf_t 
              WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
              
            #160222-00020#1--add---begin---
            #若是料件未設置，則抓取aoo020上設置的資料
            IF cl_null(l_imaf173) OR l_imaf173 = 0 THEN
               LET l_imaf173 =  cl_get_para(g_enterprise,g_site,'S-BAS-0026')
            END IF
            IF cl_null(l_imaf174) OR l_imaf174 = 0 THEN
               LET l_imaf174 =  cl_get_para(g_enterprise,g_site,'S-BAS-0027')
            END IF
            #160222-00020#1--add---end--- 
            
            #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
            SELECT ooef008,ooef009 INTO l_ooef008,l_ooef009 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001=g_site
                    
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn014) THEN
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn013) THEN
                  IF g_pmdn_d[l_ac].pmdn014 < g_pmdn_d[l_ac].pmdn013 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00271'
                     LET g_errparam.extend = g_pmdn_d[l_ac].pmdn014
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].pmdn014 = g_pmdn_d_t.pmdn014
                     NEXT FIELD CURRENT
                  END IF
               ELSE
                  #若到廠日期為NULL時，輸入到庫日期後需自動計算到廠日期，公式為到庫日期-[T:料件據點進銷存檔].[C:到庫前置時間]
                  IF (NOT cl_null(l_imaf174)) AND l_imaf174 <> 0 THEN
                     CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn014,0,(l_imaf174*(-1))) RETURNING g_pmdn_d[l_ac].pmdn013
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn013 = g_pmdn_d[l_ac].pmdn014
                  END IF           
               END IF
               
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn012) THEN
                  IF g_pmdn_d[l_ac].pmdn014 < g_pmdn_d[l_ac].pmdn012 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00272'
                     LET g_errparam.extend = g_pmdn_d[l_ac].pmdn014
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].pmdn014 = g_pmdn_d_t.pmdn014
                     NEXT FIELD CURRENT
                  END IF
               ELSE
               #若交貨日期為NULL時，輸入到庫日期後需自動計算交貨日期，公式為到廠日期-[T:料件據點進銷存檔].[C:到廠前置時間]
                  IF (NOT cl_null(l_imaf173)) AND l_imaf173 <> 0 THEN
                     CALL s_date_get_work_date(g_site,l_ooef008,l_ooef009,g_pmdn_d[l_ac].pmdn013,0,(l_imaf173*(-1))) RETURNING g_pmdn_d[l_ac].pmdn012
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn012 = g_pmdn_d[l_ac].pmdn013
                  END IF
               END IF

               #根據到庫日期計算緊急度
               CALL apmt500_pmdn014_to_pmdn020()
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn014
            #add-point:ON CHANGE pmdn014 name="input.g.page1.pmdn014"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn045
            #add-point:BEFORE FIELD pmdn045 name="input.b.page1.pmdn045"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn045
            
            #add-point:AFTER FIELD pmdn045 name="input.a.page1.pmdn045"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn045
            #add-point:ON CHANGE pmdn045 name="input.g.page1.pmdn045"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn010
            
            #add-point:AFTER FIELD pmdn010 name="input.a.page1.pmdn010"
            CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn010) RETURNING g_pmdn_d[l_ac].pmdn010_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn010_desc
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn010) THEN 
               IF g_pmdn_d[l_ac].pmdn010 != g_pmdn_d_o.pmdn010 OR cl_null(g_pmdn_d_o.pmdn010) THEN
                 
                  IF NOT apmt500_unit_chk(g_pmdn_d[l_ac].pmdn010) THEN
                     LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d_t.pmdn010
                     CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn010) RETURNING g_pmdn_d[l_ac].pmdn010_desc
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn010_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  IF (NOT cl_null(g_pmdn_d[l_ac].pmdn001)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn007)) THEN 
                      CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn007)
                         RETURNING l_success,g_pmdn_d[l_ac].pmdn011
                  END IF
                  
                  IF NOT cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                     CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011) RETURNING g_pmdn_d[l_ac].pmdn011
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn011
                  
                     #取出價格
                     CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                             g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                             g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                         RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                  
                     LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                     LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                     LET g_pmdn2_d[l_ac].pmdn044 = 0
                         
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                             RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047    
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        
                  END IF
               END IF                  
            END IF 
            LET g_pmdn_d_o.pmdn010 = g_pmdn_d[l_ac].pmdn010
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn010
            #add-point:BEFORE FIELD pmdn010 name="input.b.page1.pmdn010"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn010
            #add-point:ON CHANGE pmdn010 name="input.g.page1.pmdn010"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn011
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn_d[l_ac].pmdn011,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdn011
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdn011 name="input.a.page1.pmdn011"
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn011) THEN
               IF g_pmdn_d[l_ac].pmdn011 != g_pmdn_d_o.pmdn011 OR cl_null(g_pmdn_d_o.pmdn011) THEN
                
                  IF NOT cl_null(g_pmdn_d[l_ac].pmdn010) THEN
                     CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011) RETURNING g_pmdn_d[l_ac].pmdn011
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn011 
                  
                     #取出價格
                     CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdl_m.pmdl015,
                             g_pmdn_d[l_ac].pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                             g_pmdl_m.pmdldocdt,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_site,g_pmdl_m.pmdl054,g_type,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005)
                         RETURNING g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042
                  
                     LET g_pmdn_d[l_ac].pmdn015 = g_pmdn2_d[l_ac].pmdn043
                     LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015
                     LET g_pmdn2_d[l_ac].pmdn044 = 0
                             
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                             RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                                
                  END IF   
               END IF                  
            END IF
            LET g_pmdn_d_o.pmdn011 = g_pmdn_d[l_ac].pmdn011      

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn011
            #add-point:BEFORE FIELD pmdn011 name="input.b.page1.pmdn011"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn011
            #add-point:ON CHANGE pmdn011 name="input.g.page1.pmdn011"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn015
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn_d[l_ac].pmdn015,"0.000","1","","","azz-00079",1) THEN
               NEXT FIELD pmdn015
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdn015 name="input.a.page1.pmdn015"
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn015) THEN
               IF g_pmdn_d[l_ac].pmdn015 != g_pmdn_d_o.pmdn015 OR cl_null(g_pmdn_d_o.pmdn015) THEN
                  IF g_pmam006 = 'N' AND g_pmdn_d[l_ac].pmdn015 = 0 THEN  #價格不允許為0
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00273'
                     LET g_errparam.extend = g_pmdn_d[l_ac].pmdn015
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  
                     LET g_pmdn_d[l_ac].pmdn015 = g_pmdn_d_o.pmdn015
                     NEXT FIELD CURRENT
                  END IF
                  
                  #依據取價方式設置的單價修改控管方式檢核修改後單價的合理性
                  LET l_errno = ''
                  IF NOT (cl_null(g_pmdl_m.pmdl017) OR cl_null(g_pmdn_d[l_ac].pmdn015) OR cl_null(g_pmdn2_d[l_ac].pmdn043) OR
                          cl_null(g_pmdn2_d[l_ac].pmdn040) OR cl_null(g_pmdl_m.pmdl015) OR cl_null(g_pmdn_d[l_ac].pmdn001) OR
                          cl_null(g_pmdn_d[l_ac].pmdn010)) THEN
                     CALL s_purchase_price_check(g_pmdl_m.pmdl017,g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn040,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn010)
                       RETURNING l_flag,l_errno
                     IF NOT l_flag THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = l_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err() 
                        LET g_pmdn_d[l_ac].pmdn015 = g_pmdn_d_o.pmdn015
                        NEXT FIELD pmdn015
                     #160127-00022#1---add--begin---
                     #回傳值為TRUE,但取價方式上設置超過容差率的處理方式為警告，需要彈出提示框提示
                     ELSE
                        IF NOT cl_null(l_errno) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = l_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err() 
                        END IF
                     #160127-00022#1---add--end---
                     END IF  
                  END IF                          
                  
                  #呼叫幣別取位應用元件對單價作取位(依單頭幣別做取位基準)
                  CALL s_curr_round(g_site,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn015,'1') RETURNING g_pmdn_d[l_ac].pmdn015
                     
                  #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                  IF cl_null(g_pmdn_d[l_ac].pmdn010) OR cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                     LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                     LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
                  END IF
                  
                  CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                       RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                       
                  #計算價差比
                  IF g_pmdn2_d[l_ac].pmdn043<> 0 AND g_pmdn2_d[l_ac].pmdn043 <> g_pmdn_d[l_ac].pmdn015 THEN
                     #百分比形式
                     LET g_pmdn2_d[l_ac].pmdn044 = ((g_pmdn_d[l_ac].pmdn015 - g_pmdn2_d[l_ac].pmdn043) / g_pmdn2_d[l_ac].pmdn043) * 100
                  END IF                  
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn015,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                        
                  #ming 20150903 add ----------------------------(S) 
                  #科目預算 
                  CALL apmt500_detail_abg('4')
                       RETURNING l_success,l_errno_abg,l_bgaf016,
                                 l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql
                  IF NOT l_success THEN
                     CASE l_errno_abg
                        WHEN 'abg-00103'     #輸入金額超出預算限額，不可輸入!!!  
                           CASE l_bgaf016
                              WHEN '1'
                              WHEN '2'
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.extend = ''
                                 LET g_errparam.code   = l_errno_abg
                                 LET g_errparam.popup  = TRUE
                                 CALL cl_err()
                              WHEN '3'
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.extend = ''
                                 LET g_errparam.code   = l_errno_abg
                                 LET g_errparam.popup  = TRUE
                                 CALL cl_err()
                                 NEXT FIELD CURRENT
                           END CASE
                        WHEN 'abg-00104'     #輸入金額超出可用預算，請加速審核!!!  
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = ''
                           LET g_errparam.code   = l_errno_abg
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                        OTHERWISE
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = ''
                           LET g_errparam.code   = l_errno_abg
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()
                           NEXT FIELD CURRENT
                     END CASE
                  END IF
                  #ming 20150903 add ----------------------------(E) 
               END IF       
            END IF 
            
            LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn015
            #add-point:BEFORE FIELD pmdn015 name="input.b.page1.pmdn015"
            LET g_pmdn_d_o.pmdn015 = g_pmdn_d[l_ac].pmdn015            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn015
            #add-point:ON CHANGE pmdn015 name="input.g.page1.pmdn015"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn016
            
            #add-point:AFTER FIELD pmdn016 name="input.a.page1.pmdn016"
            CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc
            
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn016) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_site
               LET g_chkparam.arg2 = g_pmdn_d[l_ac].pmdn016

               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00223:sub-01302|aooi610|",cl_get_progname("aooi610",g_lang,"2"),"|:EXEPROGaooi610"
               #160318-00025#15 by 07900 --add-end  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oodb002") THEN
                  #檢查成功時後續處理
                   #是單一稅，只能輸入稅種為T01:增值稅的稅別，不然單身的含未稅金額會出現0的情況
                  LET l_oodb004 = ''
                  LET l_oodb003 = ''
                  SELECT oodb004,oodb003 INTO l_oodb004,l_oodb003 FROM oodb_t,ooef_t
                    WHERE ooefent = oodbent AND ooef001 = g_site AND ooef019 = oodb001
                      AND oodbent = g_enterprise AND oodb002 = g_pmdn_d[l_ac].pmdn016
                  IF l_oodb004 = '1' AND (l_oodb003 <> 'T01' OR cl_null(l_oodb003)) THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_pmdn_d[l_ac].pmdn016
                     LET g_errparam.code   = 'apm-00561'
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET g_pmdn_d[l_ac].pmdn016 = g_pmdn_d_t.pmdn016
                     CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  SELECT oodb006 INTO g_pmdn_d[l_ac].pmdn017 FROM oodb_t,ooef_t
                    WHERE ooefent = oodbent AND ooef001 = g_site AND ooef019 = oodb001
                      AND oodbent = g_enterprise AND oodb002 = g_pmdn_d[l_ac].pmdn016
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn017
                  
                  #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                  IF cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn007,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                       RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                  ELSE
                     CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,g_pmdl_m.pmdl015,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016)
                       RETURNING g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn047
                  END IF
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdn_d[l_ac].pmdn016 = g_pmdn_d_t.pmdn016
                  CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc
                  NEXT FIELD CURRENT
               END IF      
            END IF 
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn016
            #add-point:BEFORE FIELD pmdn016 name="input.b.page1.pmdn016"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn016
            #add-point:ON CHANGE pmdn016 name="input.g.page1.pmdn016"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn017
            #add-point:BEFORE FIELD pmdn017 name="input.b.page1.pmdn017"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn017
            
            #add-point:AFTER FIELD pmdn017 name="input.a.page1.pmdn017"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn017
            #add-point:ON CHANGE pmdn017 name="input.g.page1.pmdn017"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn046
            #add-point:BEFORE FIELD pmdn046 name="input.b.page1.pmdn046"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn046
            
            #add-point:AFTER FIELD pmdn046 name="input.a.page1.pmdn046"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn046
            #add-point:ON CHANGE pmdn046 name="input.g.page1.pmdn046"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn047
            #add-point:BEFORE FIELD pmdn047 name="input.b.page1.pmdn047"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn047
            
            #add-point:AFTER FIELD pmdn047 name="input.a.page1.pmdn047"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn047
            #add-point:ON CHANGE pmdn047 name="input.g.page1.pmdn047"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn048
            #add-point:BEFORE FIELD pmdn048 name="input.b.page1.pmdn048"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn048
            
            #add-point:AFTER FIELD pmdn048 name="input.a.page1.pmdn048"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn048
            #add-point:ON CHANGE pmdn048 name="input.g.page1.pmdn048"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn023
            
            #add-point:AFTER FIELD pmdn023 name="input.a.page1.pmdn023"
            CALL apmt500_pmdl004_ref(g_pmdn_d[l_ac].pmdn023) RETURNING g_pmdn_d[l_ac].pmdn023_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn023_desc 
            
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn023) THEN 
               IF g_pmdn_d[l_ac].pmdn023 != g_pmdl_m.pmdl004 THEN
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                   #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmdl_m.pmdl004
                  LET g_chkparam.arg2 = g_pmdn_d[l_ac].pmdn023
                  LET g_chkparam.arg3 = g_site
                  #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="axr-00049:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"
                  #160318-00025#15 by 07900 --add-end 
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_pmac002_2") THEN
                     #檢查成功時後續處理
                  
                  ELSE
                     #檢查失敗時後續處理
                     LET g_pmdn_d[l_ac].pmdn023 = g_pmdn_d_t.pmdn023
                     CALL apmt500_pmdl004_ref(g_pmdn_d[l_ac].pmdn023) RETURNING g_pmdn_d[l_ac].pmdn023_desc
                     DISPLAY BY NAME g_pmdn_d[l_ac].pmdn023_desc 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn023
            #add-point:BEFORE FIELD pmdn023 name="input.b.page1.pmdn023"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn023
            #add-point:ON CHANGE pmdn023 name="input.g.page1.pmdn023"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn019
            #add-point:BEFORE FIELD pmdn019 name="input.b.page1.pmdn019"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn019
            
            #add-point:AFTER FIELD pmdn019 name="input.a.page1.pmdn019"
            #子特性是樣品時，單價为0
            IF g_pmdn_d[l_ac].pmdn019 = '9' THEN
               LET g_pmdn_d[l_ac].pmdn015 = 0
               LET g_pmdn_d[l_ac].pmdn046 = 0
               LET g_pmdn_d[l_ac].pmdn047 = 0
               LET g_pmdn_d[l_ac].pmdn048 = 0
            END IF
            CALL apmt500_set_entry_b(l_cmd)
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()
            CALL apmt500_set_no_entry_b(l_cmd)            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn019
            #add-point:ON CHANGE pmdn019 name="input.g.page1.pmdn019"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn020
            #add-point:BEFORE FIELD pmdn020 name="input.b.page1.pmdn020"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn020
            
            #add-point:AFTER FIELD pmdn020 name="input.a.page1.pmdn020"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn020
            #add-point:ON CHANGE pmdn020 name="input.g.page1.pmdn020"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn052
            #add-point:BEFORE FIELD pmdn052 name="input.b.page1.pmdn052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn052
            
            #add-point:AFTER FIELD pmdn052 name="input.a.page1.pmdn052"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn052
            #add-point:ON CHANGE pmdn052 name="input.g.page1.pmdn052"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn021
            #add-point:BEFORE FIELD pmdn021 name="input.b.page1.pmdn021"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn021
            
            #add-point:AFTER FIELD pmdn021 name="input.a.page1.pmdn021"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn021
            #add-point:ON CHANGE pmdn021 name="input.g.page1.pmdn021"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn022
            #add-point:BEFORE FIELD pmdn022 name="input.b.page1.pmdn022"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn022
            
            #add-point:AFTER FIELD pmdn022 name="input.a.page1.pmdn022"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn022
            #add-point:ON CHANGE pmdn022 name="input.g.page1.pmdn022"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnunit
            
            #add-point:AFTER FIELD pmdnunit name="input.a.page1.pmdnunit"
            CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn_d[l_ac].pmdnunit_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdnunit_desc
            
            IF NOT cl_null(g_pmdn_d[l_ac].pmdnunit) THEN 
               IF NOT apmt500_pmdnunit_chk(g_pmdn_d[l_ac].pmdnunit) THEN
                  LET g_pmdn_d[l_ac].pmdnunit = g_pmdn_d_t.pmdnunit
                  CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn_d[l_ac].pmdnunit_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdnunit_desc
                  NEXT FIELD CURRENT
               END IF
               
               LET g_pmdn_d[l_ac].pmdnorga = g_pmdn_d[l_ac].pmdnunit
               CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn_d[l_ac].pmdnorga_desc
               DISPLAY BY NAME g_pmdn_d[l_ac].pmdnorga_desc
               
               CALL apmt500_get_oofb019(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn025_desc
               DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn025_desc
               
               CALL apmt500_get_oofb019_5(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn026_desc
               DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn026_desc
            
            ELSE
               LET g_pmdn_d[l_ac].pmdnunit = g_site
               CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn_d[l_ac].pmdnunit_desc
               DISPLAY BY NAME g_pmdn_d[l_ac].pmdnunit_desc     
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnunit
            #add-point:BEFORE FIELD pmdnunit name="input.b.page1.pmdnunit"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdnunit
            #add-point:ON CHANGE pmdnunit name="input.g.page1.pmdnunit"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdnorga
            
            #add-point:AFTER FIELD pmdnorga name="input.a.page1.pmdnorga"
                                    CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn_d[l_ac].pmdnorga_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdnorga_desc
            IF NOT cl_null(g_pmdn_d[l_ac].pmdnorga) THEN 
               IF NOT apmt500_pmdnunit_chk(g_pmdn_d[l_ac].pmdnorga) THEN
                  LET g_pmdn_d[l_ac].pmdnorga = g_pmdn_d_t.pmdnorga
                  CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn_d[l_ac].pmdnorga_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdnorga_desc
                  NEXT FIELD CURRENT
               END IF
    
               CALL apmt500_get_oofb019_5(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn026_desc
               DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn026_desc
            ELSE
               LET g_pmdn_d[l_ac].pmdnorga = g_site
               CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn_d[l_ac].pmdnorga_desc
               DISPLAY BY NAME g_pmdn_d[l_ac].pmdnorga_desc
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdnorga
            #add-point:BEFORE FIELD pmdnorga name="input.b.page1.pmdnorga"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdnorga
            #add-point:ON CHANGE pmdnorga name="input.g.page1.pmdnorga"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn049
            
            #add-point:AFTER FIELD pmdn049 name="input.a.page1.pmdn049"
            CALL apmt500_pmdn049_ref(g_pmdn_d[l_ac].pmdn049) RETURNING g_pmdn_d[l_ac].pmdn049_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn049_desc
            
            IF NOT cl_null(g_pmdn_d[l_ac].pmdn049) THEN
               IF NOT apmt500_pmdn049_chk(g_pmdn_d[l_ac].pmdn049) THEN
                  LET g_pmdn_d[l_ac].pmdn049 = g_pmdn_d_t.pmdn049
                  CALL apmt500_pmdn049_ref(g_pmdn_d[l_ac].pmdn049) RETURNING g_pmdn_d[l_ac].pmdn049_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn049_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn049
            #add-point:BEFORE FIELD pmdn049 name="input.b.page1.pmdn049"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn049
            #add-point:ON CHANGE pmdn049 name="input.g.page1.pmdn049"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn051
            
            #add-point:AFTER FIELD pmdn051 name="input.a.page1.pmdn051"
                                    INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdn_d[l_ac].pmdn051
            CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='265' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdn_d[l_ac].pmdn051_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn051_desc

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn051
            #add-point:BEFORE FIELD pmdn051 name="input.b.page1.pmdn051"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn051
            #add-point:ON CHANGE pmdn051 name="input.g.page1.pmdn051"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn054
            #add-point:BEFORE FIELD pmdn054 name="input.b.page1.pmdn054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn054
            
            #add-point:AFTER FIELD pmdn054 name="input.a.page1.pmdn054"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn054
            #add-point:ON CHANGE pmdn054 name="input.g.page1.pmdn054"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn055
            #add-point:BEFORE FIELD pmdn055 name="input.b.page1.pmdn055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn055
            
            #add-point:AFTER FIELD pmdn055 name="input.a.page1.pmdn055"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn055
            #add-point:ON CHANGE pmdn055 name="input.g.page1.pmdn055"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn056
            #add-point:BEFORE FIELD pmdn056 name="input.b.page1.pmdn056"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn056
            
            #add-point:AFTER FIELD pmdn056 name="input.a.page1.pmdn056"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn056
            #add-point:ON CHANGE pmdn056 name="input.g.page1.pmdn056"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn057
            #add-point:BEFORE FIELD pmdn057 name="input.b.page1.pmdn057"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn057
            
            #add-point:AFTER FIELD pmdn057 name="input.a.page1.pmdn057"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn057
            #add-point:ON CHANGE pmdn057 name="input.g.page1.pmdn057"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn050
            #add-point:BEFORE FIELD pmdn050 name="input.b.page1.pmdn050"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn050
            
            #add-point:AFTER FIELD pmdn050 name="input.a.page1.pmdn050"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn050
            #add-point:ON CHANGE pmdn050 name="input.g.page1.pmdn050"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD ooff013
            #add-point:BEFORE FIELD ooff013 name="input.b.page1.ooff013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD ooff013
            
            #add-point:AFTER FIELD ooff013 name="input.a.page1.ooff013"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE ooff013
            #add-point:ON CHANGE ooff013 name="input.g.page1.ooff013"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page1.pmdnsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnsite
            #add-point:ON ACTION controlp INFIELD pmdnsite name="input.c.page1.pmdnsite"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdnseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnseq
            #add-point:ON ACTION controlp INFIELD pmdnseq name="input.c.page1.pmdnseq"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn001
            #add-point:ON ACTION controlp INFIELD pmdn001 name="input.c.page1.pmdn001"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.where = "1=1 "
            
            LET l_sql = " 1=1"
            #CALL s_control_get_sql("imaa001",'6','4',g_user,g_dept) RETURNING l_success,l_sql
            #IF l_success THEN
            #   LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            #END IF
            #
            #LET l_sql1 = " 1=1"
            #CALL s_control_get_doc_sql("imaf016",g_pmdl_m.pmdldocno,'4') RETURNING l_success,l_sql1
            #IF l_success THEN
            #   LET g_qryparam.where = g_qryparam.where ," AND ",l_sql1
            #END IF
            #
            #LET l_sql2 = " 1=1"
            #CALL s_control_get_doc_sql("imaa009",g_pmdl_m.pmdldocno,'5') RETURNING l_success,l_sql2
            #IF l_success THEN
            #   LET g_qryparam.where = g_qryparam.where ," AND ",l_sql2
            #END IF
            
           #CALL s_control_get_item_sql('3',g_site,g_user,g_dept,g_pmdl_m.pmdldocno) RETURNING l_success,l_sql    #160411-00013#1  --- mark
            CALL s_control_get_item_sql('4',g_site,g_user,g_dept,g_pmdl_m.pmdldocno) RETURNING l_success,l_sql    #160411-00013#1  --- add
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            END IF 
            
            #ming 20150906 add ------------------------------(S) 
            #根據單別參數決定開窗是否開替代料 
            CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) 
                 RETURNING l_success,l_pmdldocno 
            IF cl_get_doc_para(g_enterprise,g_site,l_pmdldocno,'D-BAS-0096') = 'Y' THEN 
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn001) THEN 
                  LET g_qryparam.where = g_qryparam.where,
                                         " AND imaf001 IN (SELECT bmea008 ",
                                         "                   FROM bmea_t ",
                                         "                  WHERE bmeaent = '",g_enterprise,"' ",
                                         "                    AND bmeasite = '",g_site,"' ",
                                         "                    AND bmea003  = '",g_pmdn_d[l_ac].pmdn001,"' ",
                                         "                    AND bmea007 = '2' ",
                                         "                    AND bmea009<= '",g_today,"' ",
                                         "                    AND (bmea010 > '",g_today,"'  OR bmea010 IS NULL ) ",
                                         "                     ) " 
               END IF 
            END IF 
            #ming 20150906 add ------------------------------(E) 
            
            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn001             #給予default值

            CALL q_imaf001_15()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn001 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdn001 TO pmdn001              #顯示到畫面上
            CALL apmt500_pmdn001_ref(g_pmdn_d[l_ac].pmdn001) RETURNING g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004


            NEXT FIELD pmdn001                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn002
            #add-point:ON ACTION controlp INFIELD pmdn002 name="input.c.page1.pmdn002"
            LET l_imaa005 = ''
            CALL apmt500_get_imaa005(g_enterprise,g_pmdn_d[l_ac].pmdn001) RETURNING l_imaa005
               
            IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' AND NOT cl_null(l_imaa005) THEN
               IF l_cmd = 'a' THEN            
                  CALL l_inam.clear()            
                  CALL s_feature(l_cmd,g_pmdn_d[l_ac].pmdn001,'','',g_site,g_pmdl_m.pmdldocno) RETURNING l_success,l_inam
                  LET g_pmdn_d[l_ac].pmdn002 = l_inam[1].inam002
                  LET g_pmdn_d[l_ac].pmdn007 = l_inam[1].inam004
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn007
                  
                  #計算參考數量
                  IF (NOT cl_null(g_pmdn_d[l_ac].pmdn008)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn001)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) THEN
                     #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008) RETURNING l_success,l_rate
                     #LET g_pmdn_d[l_ac].pmdn009 = g_pmdn_d[l_ac].pmdn007 * l_rate
                     CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn009
                     IF NOT cl_null(g_pmdn_d[l_ac].pmdn009) THEN
                        CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009) RETURNING g_pmdn_d[l_ac].pmdn009
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009
                     END IF 
                  END IF
                  
                  #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                  #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                  IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdn_d[l_ac].pmdn010)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn001)) AND (NOT cl_null(g_pmdn_d[l_ac].pmdn006)) THEN  #體參數使用採購計價單位
                     #CALL s_aimi190_get_convert(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010) RETURNING l_success,l_rate
                     #LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007 * l_rate
                     CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn007)
                               RETURNING l_success,g_pmdn_d[l_ac].pmdn011
                     IF NOT cl_null(g_pmdn_d[l_ac].pmdn011) THEN
                        CALL apmt500_unit_round(g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011) RETURNING g_pmdn_d[l_ac].pmdn011
                        DISPLAY BY NAME g_pmdn_d[l_ac].pmdn011
                     END IF
                  ELSE
                     LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                     LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007                  
                  END IF
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn009,g_pmdn_d[l_ac].pmdn011
                  
               END IF
               IF l_cmd = 'u' THEN
                  CALL s_feature_single(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_site,g_pmdl_m.pmdldocno)
                     RETURNING l_success,g_pmdn_d[l_ac].pmdn002
                  CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002_desc
                  DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002
               END IF
            END IF               
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn004
            #add-point:ON ACTION controlp INFIELD pmdn004 name="input.c.page1.pmdn004"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn004             #給予default值
            LET g_qryparam.default2 = "" #g_pmdn_d[l_ac].oocq010 #參考欄位七

            #給予arg
            LET g_qryparam.arg1 = "221" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn004 = g_qryparam.return1              #將開窗取得的值回傳到變數
            #LET g_pmdn_d[l_ac].oocq010 = g_qryparam.return2 #參考欄位七

            DISPLAY g_pmdn_d[l_ac].pmdn004 TO pmdn004              #顯示到畫面上
            #DISPLAY g_pmdn_d[l_ac].oocq010 TO oocq010 #參考欄位七

            NEXT FIELD pmdn004                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn005
            #add-point:ON ACTION controlp INFIELD pmdn005 name="input.c.page1.pmdn005"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn006
            #add-point:ON ACTION controlp INFIELD pmdn006 name="input.c.page1.pmdn006"
                        #此段落由子樣板a07產生            
            #開窗i段
		   	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		   	LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn006             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn_d[l_ac].pmdn001

            CALL q_imao002()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn006 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdn006 TO pmdn006              #顯示到畫面上
            CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn006) RETURNING g_pmdn_d[l_ac].pmdn006_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn006_desc

            NEXT FIELD pmdn006                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn007
            #add-point:ON ACTION controlp INFIELD pmdn007 name="input.c.page1.pmdn007"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn008
            #add-point:ON ACTION controlp INFIELD pmdn008 name="input.c.page1.pmdn008"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn008             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn_d[l_ac].pmdn001
            CALL q_imao002()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn008 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdn008 TO pmdn008              #顯示到畫面上

            NEXT FIELD pmdn008                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn009
            #add-point:ON ACTION controlp INFIELD pmdn009 name="input.c.page1.pmdn009"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn024
            #add-point:ON ACTION controlp INFIELD pmdn024 name="input.c.page1.pmdn024"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn012
            #add-point:ON ACTION controlp INFIELD pmdn012 name="input.c.page1.pmdn012"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn013
            #add-point:ON ACTION controlp INFIELD pmdn013 name="input.c.page1.pmdn013"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn014
            #add-point:ON ACTION controlp INFIELD pmdn014 name="input.c.page1.pmdn014"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn045
            #add-point:ON ACTION controlp INFIELD pmdn045 name="input.c.page1.pmdn045"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn010
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn010
            #add-point:ON ACTION controlp INFIELD pmdn010 name="input.c.page1.pmdn010"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		   	LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn010             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn_d[l_ac].pmdn001
            CALL q_imao002()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn010 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdn010 TO pmdn010              #顯示到畫面上
            CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn010) RETURNING g_pmdn_d[l_ac].pmdn010_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn010_desc

            NEXT FIELD pmdn010                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn011
            #add-point:ON ACTION controlp INFIELD pmdn011 name="input.c.page1.pmdn011"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn015
            #add-point:ON ACTION controlp INFIELD pmdn015 name="input.c.page1.pmdn015"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn016
            #add-point:ON ACTION controlp INFIELD pmdn016 name="input.c.page1.pmdn016"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn016             #給予default值

            #給予arg

            #CALL q_oodb002_2()                                #呼叫開窗
            CALL q_oodb002_11()
            LET g_pmdn_d[l_ac].pmdn016 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdn016 TO pmdn016              #顯示到畫面上
            CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc

            NEXT FIELD pmdn016                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn017
            #add-point:ON ACTION controlp INFIELD pmdn017 name="input.c.page1.pmdn017"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn046
            #add-point:ON ACTION controlp INFIELD pmdn046 name="input.c.page1.pmdn046"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn047
            #add-point:ON ACTION controlp INFIELD pmdn047 name="input.c.page1.pmdn047"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn048
            #add-point:ON ACTION controlp INFIELD pmdn048 name="input.c.page1.pmdn048"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn023
            #add-point:ON ACTION controlp INFIELD pmdn023 name="input.c.page1.pmdn023"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn023             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004
            LET g_qryparam.where = " pmac003 = '2' "
            LET l_sql = " 1=1"
            CALL s_control_get_doc_sql("pmaa083",g_pmdl_m.pmdldocno,'2') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND pmac002 IN ( SELECT pmaa001 FROM pmaa_t WHERE pmaaent = '",g_enterprise,"' AND ",l_sql,")"
            END IF

            CALL q_pmac002_2()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn023 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdn023 TO pmdn023              #顯示到畫面上
            CALL apmt500_pmdl004_ref(g_pmdn_d[l_ac].pmdn023) RETURNING g_pmdn_d[l_ac].pmdn023_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn023_desc 

            NEXT FIELD pmdn023                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn019
            #add-point:ON ACTION controlp INFIELD pmdn019 name="input.c.page1.pmdn019"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn020
            #add-point:ON ACTION controlp INFIELD pmdn020 name="input.c.page1.pmdn020"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn052
            #add-point:ON ACTION controlp INFIELD pmdn052 name="input.c.page1.pmdn052"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn021
            #add-point:ON ACTION controlp INFIELD pmdn021 name="input.c.page1.pmdn021"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn022
            #add-point:ON ACTION controlp INFIELD pmdn022 name="input.c.page1.pmdn022"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdnunit
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnunit
            #add-point:ON ACTION controlp INFIELD pmdnunit name="input.c.page1.pmdnunit"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdnunit             #給予default值

            #給予arg

            #CALL q_ooef001()     #161019-00017#3
            CALL q_ooef001_1()   #161019-00017#3
            LET g_pmdn_d[l_ac].pmdnunit = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdnunit TO pmdnunit              #顯示到畫面上

            NEXT FIELD pmdnunit                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdnorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdnorga
            #add-point:ON ACTION controlp INFIELD pmdnorga name="input.c.page1.pmdnorga"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdnorga             #給予default值

            #給予arg

            #CALL q_ooef001()     #161019-00017#3
            CALL q_ooef001_1()   #161019-00017#3
            LET g_pmdn_d[l_ac].pmdnorga = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn_d[l_ac].pmdnorga TO pmdnorga              #顯示到畫面上

            NEXT FIELD pmdnorga                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn049
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn049
            #add-point:ON ACTION controlp INFIELD pmdn049 name="input.c.page1.pmdn049"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
			   
			   #根據單據別加上限制理由碼的條件
			   #獲取單據別
			   LET l_ooba002 = ''
			   CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
            
			   LET l_n = 0
			   SELECT COUNT(oobi003) INTO l_n FROM ooba_t,oobi_t WHERE oobaent=oobient AND ooba001=oobi001 AND ooba002=oobi002 
                    AND oobaent = g_enterprise AND ooba001 = l_ooef004 AND ooba002 = l_ooba002
			   IF l_n > 0 THEN
			      #判斷是正向列表還是負向列表
			      LET l_ooba015 = ''
			      SELECT ooba015 INTO l_ooba015 FROM ooba_t
			        WHERE oobaent = g_enterprise AND ooba001 = l_ooef004 AND ooba002 = l_ooba002
               #正向列表
               IF l_ooba015 = '1' THEN
                  LET g_qryparam.where = " oocq002 IN (SELECT oobi003 FROM oobi_t WHERE oobient = '",g_enterprise,"' AND oobi001 = '",l_ooef004,"' AND oobi002 = '",l_ooba002,"')"
               END IF
               
               #負向列表
               IF l_ooba015 = '2' THEN
                  LET g_qryparam.where = " oocq002 NOT IN (SELECT oobi003 FROM oobi_t WHERE oobient = '",g_enterprise,"' AND oobi001 = '",l_ooef004,"' AND oobi002 = '",l_ooba002,"')"
               END IF
            END IF

            LET g_qryparam.default1 = g_pmdn_d[l_ac].pmdn049             #給予default值
            LET g_qryparam.default2 = "" #g_pmdn_d[l_ac].oocq010 #參考欄位七

            #給予arg
            LET g_qryparam.arg1 = g_acc #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdn_d[l_ac].pmdn049 = g_qryparam.return1              #將開窗取得的值回傳到變數
            #LET g_pmdn_d[l_ac].oocq010 = g_qryparam.return2 #參考欄位七

            DISPLAY g_pmdn_d[l_ac].pmdn049 TO pmdn049              #顯示到畫面上
            #DISPLAY g_pmdn_d[l_ac].oocq010 TO oocq010 #參考欄位七
            CALL apmt500_pmdn049_ref(g_pmdn_d[l_ac].pmdn049) RETURNING g_pmdn_d[l_ac].pmdn049_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn049_desc

            NEXT FIELD pmdn049                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn051
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn051
            #add-point:ON ACTION controlp INFIELD pmdn051 name="input.c.page1.pmdn051"
 
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn054
            #add-point:ON ACTION controlp INFIELD pmdn054 name="input.c.page1.pmdn054"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn055
            #add-point:ON ACTION controlp INFIELD pmdn055 name="input.c.page1.pmdn055"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn056
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn056
            #add-point:ON ACTION controlp INFIELD pmdn056 name="input.c.page1.pmdn056"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn057
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn057
            #add-point:ON ACTION controlp INFIELD pmdn057 name="input.c.page1.pmdn057"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdn050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn050
            #add-point:ON ACTION controlp INFIELD pmdn050 name="input.c.page1.pmdn050"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.ooff013
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD ooff013
            #add-point:ON ACTION controlp INFIELD ooff013 name="input.c.page1.ooff013"
            #161031-00025#5 add-S
            IF NOT cl_null(g_pmdl_m.pmdldocno) AND l_ac > 0 THEN
               CALL aooi360_02('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'','','','','','','','1')
               CALL s_aooi360_sel('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'','','','','','','','1') RETURNING l_success,g_pmdn_d[l_ac].ooff013
            END IF
            #161031-00025#8 add-E
            #END add-point
 
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt500_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = g_pmdn_d[l_ac].pmdnseq 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*
            ELSE
            
               #add-point:單身修改前 name="input.body.b_update"
               #整體參數未使用採購計價單位,則賦值當前的採購單位和數量
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" THEN
                  LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
                  LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
               END IF                   
               #end add-point
               
               #寫入修改者/修改日期資訊(單身)
               
      
               #將遮罩欄位還原
               CALL apmt500_pmdn_t_mask_restore('restore_mask_o')
      
               UPDATE pmdn_t SET (pmdndocno,pmdnsite,pmdnseq,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006, 
                   pmdn007,pmdn008,pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015, 
                   pmdn016,pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022, 
                   pmdnunit,pmdnorga,pmdn049,pmdn051,pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,pmdn027, 
                   pmdn028,pmdn029,pmdn030,pmdn053,pmdn025,pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036, 
                   pmdn037,pmdn038,pmdn058,pmdn039,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044) = (g_pmdl_m.pmdldocno, 
                   g_pmdn_d[l_ac].pmdnsite,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002, 
                   g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007, 
                   g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009,g_pmdn_d[l_ac].pmdn024,g_pmdn_d[l_ac].pmdn012, 
                   g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014,g_pmdn_d[l_ac].pmdn045,g_pmdn_d[l_ac].pmdn010, 
                   g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn017, 
                   g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn047,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn023, 
                   g_pmdn_d[l_ac].pmdn019,g_pmdn_d[l_ac].pmdn020,g_pmdn_d[l_ac].pmdn052,g_pmdn_d[l_ac].pmdn021, 
                   g_pmdn_d[l_ac].pmdn022,g_pmdn_d[l_ac].pmdnunit,g_pmdn_d[l_ac].pmdnorga,g_pmdn_d[l_ac].pmdn049, 
                   g_pmdn_d[l_ac].pmdn051,g_pmdn_d[l_ac].pmdn054,g_pmdn_d[l_ac].pmdn055,g_pmdn_d[l_ac].pmdn056, 
                   g_pmdn_d[l_ac].pmdn057,g_pmdn_d[l_ac].pmdn050,g_pmdn2_d[l_ac].pmdn027,g_pmdn2_d[l_ac].pmdn028, 
                   g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn030,g_pmdn2_d[l_ac].pmdn053,g_pmdn2_d[l_ac].pmdn025, 
                   g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn031,g_pmdn2_d[l_ac].pmdn032,g_pmdn2_d[l_ac].pmdn033, 
                   g_pmdn2_d[l_ac].pmdn003,g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037,g_pmdn2_d[l_ac].pmdn038, 
                   g_pmdn2_d[l_ac].pmdn058,g_pmdn2_d[l_ac].pmdn039,g_pmdn2_d[l_ac].pmdn035,g_pmdn2_d[l_ac].pmdn040, 
                   g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn044) 
 
                WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno 
 
                  AND pmdnseq = g_pmdn_d_t.pmdnseq #項次   
 
                  
               #add-point:單身修改中 name="input.body.m_update"
                              
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdn_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*  
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()                   
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmdl_m.pmdldocno
               LET gs_keys_bak[1] = g_pmdldocno_t
               LET gs_keys[2] = g_pmdn_d[g_detail_idx].pmdnseq
               LET gs_keys_bak[2] = g_pmdn_d_t.pmdnseq
               CALL apmt500_update_b('pmdn_t',gs_keys,gs_keys_bak,"'1'")
               END CASE
 
               #將遮罩欄位進行遮蔽
               CALL apmt500_pmdn_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT(g_pmdn_d[g_detail_idx].pmdnseq = g_pmdn_d_t.pmdnseq 
 
                  ) THEN
                  LET gs_keys[01] = g_pmdl_m.pmdldocno
 
                  LET gs_keys[gs_keys.getLength()+1] = g_pmdn_d_t.pmdnseq
 
                  CALL apmt500_key_update_b(gs_keys,'pmdn_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_pmdl_m),util.JSON.stringify(g_pmdn_d_t)
               LET g_log2 = util.JSON.stringify(g_pmdl_m),util.JSON.stringify(g_pmdn_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身修改後 name="input.body.a_update"
               #若有修改到料號或產品特徵則需將對應的"交其明細"與"關聯單據明細"資料中的料件編號或產品特徵也同步更新
               IF g_pmdn_d[l_ac].pmdnseq <> g_pmdn_d_t.pmdnseq THEN
                  UPDATE pmdp_t SET pmdpseq = g_pmdn_d[l_ac].pmdnseq
                     WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdp_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
                  UPDATE pmdo_t SET pmdoseq = g_pmdn_d[l_ac].pmdnseq
                     WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN  #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdo_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
                  UPDATE pmdq_t SET pmdqseq = g_pmdn_d[l_ac].pmdnseq
                     WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdq_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
                  UPDATE  xrcd_t SET xrcdseq = g_pmdn_d[l_ac].pmdnseq
                     WHERE xrcdent = g_enterprise AND xrcddocno = g_pmdl_m.pmdldocno AND xrcdseq = g_pmdn_d_t.pmdnseq AND xrcdseq2 = 0
                  IF SQLCA.sqlcode THEN #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "xrcd_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               
               IF g_pmdn_d[l_ac].pmdn001 <> g_pmdn_d_t.pmdn001 THEN
                  UPDATE pmdp_t SET pmdp001 = g_pmdn_d[l_ac].pmdn001
                     WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdp_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
                  UPDATE pmdo_t SET pmdo001 = g_pmdn_d[l_ac].pmdn001
                     WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN  #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdo_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               IF g_pmdn_d[l_ac].pmdn002 <> g_pmdn_d_t.pmdn002 THEN
                  UPDATE pmdp_t SET pmdp002 = g_pmdn_d[l_ac].pmdn002
                     WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN  #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdp_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
                  UPDATE pmdo_t SET pmdo002 = g_pmdn_d[l_ac].pmdn002
                     WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = g_pmdn_d_t.pmdnseq 
                  IF SQLCA.sqlcode THEN  #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdo_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
               END IF 
                  
               #修改料號、產品特徵、採購單位、時需要開窗詢問是否重新取價，
               #若選擇要時則需呼叫取價應用元件重新取價，並重新計算[C:含稅金額]與[C:未稅金額] 

               #若有修改到料件編號、產品特徵、子件特性、採購數量、多交期資料(pmdq_t)、交貨日期、到廠日期、到庫日期
               #等欄位時，需呼叫"產生採購交期明細資料"的Function產生交期明細資料
               IF NOT s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) THEN
                  INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdo_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                  LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                  CALL s_transaction_end('N','0')
               END IF
               
               IF g_pmdn_d[l_ac].pmdn024 = 'N' THEN
                  CALL s_apmt500_gen_pmdq(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) RETURNING l_success
               END IF
               
               #161226-00035#1-(S)-add               
               #針對單位轉換,數量不變,也需更新來源單據已轉採購量
               IF (g_pmdn_d[l_ac].pmdn006 <> g_pmdn_d_t.pmdn006) AND (g_pmdn_d[l_ac].pmdn007 = g_pmdn_d_t.pmdn007) THEN
                  #一般採購時，更新來源單據請購單的已轉採購量
                  IF g_argv[1] = '3' THEN 
                     IF g_pmdl_m.pmdl007 NOT MATCHES '[34]' THEN  #来源是请购单
                        LET l_pmdn007 = g_pmdn_d[l_ac].pmdn007
                        DECLARE upd_pmdp023_2 CURSOR FOR
                           SELECT pmdpseq1,pmdp003,pmdp004,pmdp023,pmdp022 FROM pmdp_t 
                             WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq
                             ORDER BY pmdpseq1
                        LET l_pmdn007 = g_pmdn_d[l_ac].pmdn007
                        
                        FOREACH upd_pmdp023_2 INTO l_pmdpseq1,l_pmdp003,l_pmdp004,l_pmdp023,l_pmdp022                           
                           IF cl_null(l_pmdp023) THEN  
                              LET l_pmdp023 = 0 
                           END IF
                           
                           #請購單需求單位對應的可採購數量
                           SELECT pmdb006-pmdb049 INTO l_amount FROM pmdb_t 
                              WHERE pmdbent = g_enterprise AND pmdbdocno = l_pmdp003 AND pmdbseq = l_pmdp004
                           LET l_amount = l_amount + l_pmdp023
                           
                           #轉換成採購單位判斷
                           IF g_pmdn_d[l_ac].pmdn006 <> l_pmdp022 THEN
                              CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,l_pmdp022,g_pmdn_d[l_ac].pmdn006,l_amount)
                                     RETURNING l_success,l_amount
                           END IF
                                 
                           IF l_pmdn007 <=  l_amount THEN
                              #轉換成請購單需求單位
                              IF g_pmdn_d[l_ac].pmdn006 <> l_pmdp022 THEN
                                 CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,l_pmdp022,l_pmdn007)
                                        RETURNING l_success,l_pmdp023_1
                              ELSE
                                 LET l_pmdp023_1 = l_pmdn007
                              END IF
                              UPDATE pmdp_t SET pmdp023 = l_pmdp023_1,
                                                pmdp024 = l_pmdn007
                                 WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq AND pmdpseq1 = l_pmdpseq1
                              IF SQLCA.sqlcode THEN  #其他錯誤
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.code = SQLCA.sqlcode
                                 LET g_errparam.extend = "pmdp_t"
                                 LET g_errparam.popup = TRUE
                                 CALL cl_err()
                             
                                 LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                                 CALL s_transaction_end('N','0')
                              END IF 
                              
                              UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) - l_pmdp023 + l_pmdp023_1
                                  WHERE pmdbent = g_enterprise AND pmdbdocno = l_pmdp003 AND pmdbseq = l_pmdp004
                                  
                              LET l_pmdn007 = 0
                              
                           ELSE
                              #轉換成請購單需求單位
                              IF g_pmdn_d[l_ac].pmdn006 <> l_pmdp022 THEN
                                 CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,l_pmdp022,l_amount)
                                        RETURNING l_success,l_pmdp023_1
                              ELSE
                                 LET l_pmdp023_1 = l_amount
                              END IF
                              UPDATE pmdp_t SET pmdp023 = l_pmdp023_1,
                                                pmdp024 = l_amount
                                 WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq AND pmdpseq1 = l_pmdpseq1
                              IF SQLCA.sqlcode THEN  #其他錯誤
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.code = SQLCA.sqlcode
                                 LET g_errparam.extend = "pmdp_t"
                                 LET g_errparam.popup = TRUE
                                 CALL cl_err()
                              
                                 LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                                 CALL s_transaction_end('N','0')
                              END IF 
                              
                              UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) - l_pmdp023 + l_pmdp023_1
                                  WHERE pmdbent = g_enterprise AND pmdbdocno = l_pmdp003 AND pmdbseq = l_pmdp004
                              LET l_pmdn007 = l_pmdn007 - l_amount
                              
                           END IF
                        END FOREACH
                     END IF
                  END IF
               END IF
               #161226-00035#1-(E)-add
               
               IF g_pmdn_d[l_ac].pmdn007 <> g_pmdn_d_t.pmdn007 THEN
                  #一般採購時，更新來源單據請購單的數量
                  IF g_argv[1] = '3' THEN 
                     #IF g_pmdl_m.pmdl007 <> '3' THEN             #151210-00002#1 add  
                     IF g_pmdl_m.pmdl007 NOT MATCHES '[34]' THEN #160727-00025#9  #来源是请购单
                        LET l_pmdn007 = g_pmdn_d[l_ac].pmdn007
                        DECLARE upd_pmdp023 CURSOR FOR
                           SELECT pmdpseq1,pmdp003,pmdp004,pmdp023,pmdp022 FROM pmdp_t 
                             WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq
                             ORDER BY pmdpseq1
                        LET l_pmdn007 = g_pmdn_d[l_ac].pmdn007
                        FOREACH upd_pmdp023 INTO l_pmdpseq1,l_pmdp003,l_pmdp004,l_pmdp023,l_pmdp022
                           
                           #請購單需求單位對應的可採購數量
                           SELECT pmdb006-pmdb049 INTO l_amount FROM pmdb_t 
                              WHERE pmdbent = g_enterprise AND pmdbdocno = l_pmdp003 AND pmdbseq = l_pmdp004
                           LET l_amount = l_amount + l_pmdp023
                           
                           #轉換成採購單位判斷
                           IF g_pmdn_d[l_ac].pmdn006 <> l_pmdp022 THEN
                              CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,l_pmdp022,g_pmdn_d[l_ac].pmdn006,l_amount)
                                     RETURNING l_success,l_amount
                           END IF
                                 
                           IF l_pmdn007 <=  l_amount THEN
                              #轉換成請購單需求單位
                              IF g_pmdn_d[l_ac].pmdn006 <> l_pmdp022 THEN
                                 CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,l_pmdp022,l_pmdn007)
                                        RETURNING l_success,l_pmdp023_1
                              ELSE
                                 LET l_pmdp023_1 = l_pmdn007
                              END IF
                              UPDATE pmdp_t SET pmdp023 = l_pmdp023_1,
                                                pmdp024 = l_pmdn007
                                 WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq AND pmdpseq1 = l_pmdpseq1
                              IF SQLCA.sqlcode THEN  #其他錯誤
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.code = SQLCA.sqlcode
                                 LET g_errparam.extend = "pmdp_t"
                                 LET g_errparam.popup = TRUE
                                 CALL cl_err()
                             
                                 LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                                 CALL s_transaction_end('N','0')
                              END IF 
                              
                              UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) - l_pmdp023 + l_pmdp023_1
                                  WHERE pmdbent = g_enterprise AND pmdbdocno = l_pmdp003 AND pmdbseq = l_pmdp004
                                  
                              LET l_pmdn007 = 0
                              
                           ELSE
                              #轉換成請購單需求單位
                              IF g_pmdn_d[l_ac].pmdn006 <> l_pmdp022 THEN
                                 CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,l_pmdp022,l_amount)
                                        RETURNING l_success,l_pmdp023_1
                              ELSE
                                 LET l_pmdp023_1 = l_amount
                              END IF
                              UPDATE pmdp_t SET pmdp023 = l_pmdp023_1,
                                                pmdp024 = l_amount
                                 WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq AND pmdpseq1 = l_pmdpseq1
                              IF SQLCA.sqlcode THEN  #其他錯誤
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.code = SQLCA.sqlcode
                                 LET g_errparam.extend = "pmdp_t"
                                 LET g_errparam.popup = TRUE
                                 CALL cl_err()
                              
                                 LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                                 CALL s_transaction_end('N','0')
                              END IF 
                              
                              UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) - l_pmdp023 + l_pmdp023_1
                                  WHERE pmdbent = g_enterprise AND pmdbdocno = l_pmdp003 AND pmdbseq = l_pmdp004
                              LET l_pmdn007 = l_pmdn007 - l_amount
                              
                           END IF
                        END FOREACH
                    #--151210-00002#1--add--(s)    
                     ELSE
                     #來源為訂單時，更新來源單據的需求量
                       IF NOT cl_null(g_pmdl_m.pmdl008) THEN
                          CALL apmt500_order_upd()                 
                       END IF
                     END IF                     
                    #--151210-00002#1--add--(e) 
                  END IF
                  
                  #委外時，更新關聯單據和工單中的數量
                  IF g_argv[1] = '1' THEN 
                     UPDATE pmdp_t SET pmdp023 = g_pmdn_d[l_ac].pmdn007,
                                       pmdp024 = g_pmdn_d[l_ac].pmdn007
                        WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq 
                     IF SQLCA.sqlcode THEN  #其他錯誤
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "pmdp_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                  
                        LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                        CALL s_transaction_end('N','0')
                     END IF
                     SELECT pmdp003,pmdp004,pmdp009,pmdp010,pmdp001 INTO l_pmdp003,l_pmdp004,l_pmdp009,l_pmdp010,l_pmdp001 FROM pmdp_t  #170208-00026#1 add pmdp001
                        WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq AND ROWNUM = 1
                     
                     #170208-00026#1 add   --begin--
                     SELECT COUNT(sfac001) INTO l_n1 FROM sfac_t
                      WHERE sfacent = g_enterprise AND sfacdocno = l_pmdp003
                        AND sfac001 = l_pmdp001 AND (sfac002 = '1' OR sfac002 = '2')
                     IF l_n1 > 0 THEN
                     #170208-00026#1 add   --end--
                     
                     #160316-00006#1---add---begin---
                     IF cl_null(l_pmdp009) THEN
                        LET l_pmdp009 = ' '
                     END IF
                     IF cl_null(l_pmdp010) THEN
                        LET l_pmdp010 = ' '
                     END IF
                     #160316-00006#1---add---end---
         
                     UPDATE sfcb_t SET sfcb041 = sfcb041 - g_pmdn_d_t.pmdn007 + g_pmdn_d[l_ac].pmdn007
                      WHERE sfcbent   = g_enterprise
                        AND sfcbdocno = l_pmdp003
                        AND sfcb001   = l_pmdp004
                        #AND sfcb003 = l_pmdp009  #160316-00006#1 mark
                        #AND sfcb004 = l_pmdp010  #160316-00006#1 mark
                        #160316-00006#1---add---begin---
                        AND (CASE WHEN sfcb003 IS NULL THEN ' ' ELSE sfcb003 END) = l_pmdp009
                        AND (CASE WHEN sfcb004 IS NULL THEN ' ' ELSE sfcb004 END) = l_pmdp010
                        #160316-00006#1---add---end---
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = 'update sfcb041'
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                     
                        LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                        CALL s_transaction_end('N','0')                              
                     END IF    
                     END IF        #170208-00026#1 add 
                  END IF
                  
                  #重覆性生產時，更新關聯單據中的數量
                  IF g_argv[1] = '2' THEN 
                     UPDATE pmdp_t SET pmdp023 = g_pmdn_d[l_ac].pmdn007,
                                       pmdp024 = g_pmdn_d[l_ac].pmdn007
                        WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d_t.pmdnseq 
                     IF SQLCA.sqlcode THEN  #其他錯誤
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "pmdp_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                  
                        LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*                     
                        CALL s_transaction_end('N','0')
                     END IF
  
                  END IF
               END IF 
               
               #ming 20150904 add ------------------------------(S) 
               CALL s_apmt500_stus_abg(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'U')
                    RETURNING l_success,l_errno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = l_errno
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  LET g_pmdn_d[l_ac].* = g_pmdn_d_t.*
                  CALL s_transaction_end('N','0')
               END IF
               #ming 20150904 add ------------------------------(E) 
               
               #161031-00025#1---s
               CALL s_aooi360_del('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq,'','','','','','','','1') RETURNING l_success
               IF NOT cl_null(g_pmdn_d[l_ac].ooff013) THEN
                  CALL s_aooi360_gen('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'','','','','','','','1',g_pmdn_d[l_ac].ooff013) RETURNING l_success
               END IF
               #161031-00025#1---e
               #end add-point
 
            END IF
            
         AFTER ROW
            #add-point:單身after_row name="input.body.after_row"
                        
            #end add-point
            CALL apmt500_unlock_b("pmdn_t","'1'")
            CALL s_transaction_end('Y','0')
            #其他table進行unlock
            #add-point:單身after_row2 name="input.body.after_row2"
            
            #end add-point
              
         AFTER INPUT
            #add-point:input段after input  name="input.body.after_input"
          
            FOR l_i = 1 TO g_pmdn_d.getLength()                  #161114-00006#1 add 
           #FOR l_i = 1 TO g_rec_b     #mod by yany 2016/10/30   #161114-00006#1 mark
               #若單頭取價方式的基本資料設置單價不可為0時，則輸入的單價不可以為0
               IF g_pmam006 = 'N' AND g_pmdn_d[l_i].pmdn015 <= 0 AND g_pmdn_d[l_i].pmdn019 <> '9'THEN              
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-01010'
                  LET g_errparam.extend = g_pmdl_m.pmdldocno
                  LET g_errparam.replace[1] = g_pmdn_d[l_i].pmdnseq
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD pmdn015
               END IF
               
               #依據取價方式設置的單價修改控管方式檢核修改後單價的合理性
               LET l_errno = ''
               IF NOT (cl_null(g_pmdl_m.pmdl017) OR cl_null(g_pmdn_d[l_i].pmdn015) OR cl_null(g_pmdn2_d[l_i].pmdn043) OR
                       cl_null(g_pmdn2_d[l_i].pmdn040) OR cl_null(g_pmdl_m.pmdl015) OR cl_null(g_pmdn_d[l_i].pmdn001) OR
                       cl_null(g_pmdn_d[l_i].pmdn010)) THEN
                  CALL s_purchase_price_check(g_pmdl_m.pmdl017,g_pmdn_d[l_i].pmdn015,g_pmdn2_d[l_i].pmdn043,g_pmdn2_d[l_i].pmdn040,g_pmdl_m.pmdl015,g_pmdn_d[l_i].pmdn001,g_pmdn_d[l_i].pmdn002,g_pmdn_d[l_i].pmdn010)
                    RETURNING l_flag,l_errno
                  IF NOT l_flag THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = l_errno
                     LET g_errparam.extend = g_pmdn_d[l_i].pmdnseq
                     LET g_errparam.popup = TRUE
                     CALL cl_err() 
                     NEXT FIELD pmdn015
                  #160127-00022#1---add--begin---
                  #回傳值為TRUE,但取價方式上設置超過容差率的處理方式為警告，需要彈出提示框提示
                  ELSE
                     IF NOT cl_null(l_errno) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = l_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err() 
                     END IF
                  #160127-00022#1---add--end---
                  END IF  
               END IF               
               #檢查單身稅別不可空白
               IF cl_null(g_pmdn_d[l_i].pmdn016) THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.code = 'apm-01011'
                  LET g_errparam.extend = g_pmdl_m.pmdldocno
                  LET g_errparam.replace[1] = g_pmdn_d[l_i].pmdnseq
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD pmdn016
               END IF          
               #料件有使用產品特徴則不可空白
               LET l_imaa005 = ''
               CALL apmt500_get_imaa005(g_enterprise,g_pmdn_d[l_i].pmdn001) RETURNING l_imaa005
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' AND NOT cl_null(l_imaa005) THEN
                  #160908-00014#1--s
                  #對應的特徵群組有 勾選'需求來源可以不指定產品特徵'時，可以不指定產品特徵
                  LET l_imea003 =  ''
                  SELECT imea003 INTO l_imea003 FROM imea_t WHERE imeaent = g_enterprise AND imea001 = l_imaa005
                  IF l_imea003 = 'N' THEN
                  #160908-00014#1--e
                     IF cl_null(g_pmdn_d[l_i].pmdn002) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'apm-01012'
                        LET g_errparam.extend = g_pmdl_m.pmdldocno
                        LET g_errparam.replace[1] = g_pmdn_d[l_i].pmdnseq
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD pmdn002                  
                     END IF    
                  #160908-00014#1--s                     
                  ELSE
                     LET g_pmdn_d[l_i].pmdn002 = ' '
                  END IF
                  #160908-00014#1--e
               END IF   
            END FOR               
            #end add-point 
    
         ON ACTION controlo    
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_pmdn_d[li_reproduce_target].* = g_pmdn_d[li_reproduce].*
               LET g_pmdn2_d[li_reproduce_target].* = g_pmdn2_d[li_reproduce].*
 
               LET g_pmdn_d[li_reproduce_target].pmdnseq = NULL
 
            ELSE
               CALL FGL_SET_ARR_CURR(g_pmdn_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_pmdn_d.getLength()+1
            END IF
            
         #ON ACTION cancel
         #   LET INT_FLAG = 1
         #   LET g_detail_idx = 1
         #   EXIT DIALOG 
 
      END INPUT
      
      INPUT ARRAY g_pmdn2_d FROM s_detail2.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = FALSE, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)
                 
         #自訂ACTION(detail_input,page_2)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body2.before_input2"
            
            #end add-point
            
            CALL apmt500_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_pmdn2_d.getLength()
            #add-point:資料輸入前 name="input.body2.before_input"
            #ming 20150904 add -----------------------(S) 
            CALL FGL_SET_ARR_CURR(g_detail_idx)
            #ming 20150904 add -----------------------(E) 
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmdn2_d[l_ac].* TO NULL 
            INITIALIZE g_pmdn2_d_t.* TO NULL 
            INITIALIZE g_pmdn2_d_o.* TO NULL 
            #公用欄位給值(單身2)
            
            #自定義預設值(單身2)
                  LET g_pmdn2_d[l_ac].pmdn032 = "1"
      LET g_pmdn2_d[l_ac].pmdn035 = "1"
      LET g_pmdn2_d[l_ac].pmdn040 = "1"
      LET g_pmdn2_d[l_ac].pmdn043 = "0"
 
            #add-point:modify段before備份 name="input.body2.insert.before_bak"
            
            #end add-point
            LET g_pmdn2_d_t.* = g_pmdn2_d[l_ac].*     #新輸入資料
            LET g_pmdn2_d_o.* = g_pmdn2_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL apmt500_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body2.insert.after_set_entry_b"
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()            
            #end add-point
            CALL apmt500_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_pmdn_d[li_reproduce_target].* = g_pmdn_d[li_reproduce].*
               LET g_pmdn2_d[li_reproduce_target].* = g_pmdn2_d[li_reproduce].*
 
               LET g_pmdn2_d[li_reproduce_target].pmdnseq = NULL
            END IF
            
 
 
            #add-point:modify段before insert name="input.body2.before_insert"
                        
            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body2.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[2] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 2
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt500_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt500_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_pmdn2_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_pmdn2_d[l_ac].pmdnseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_pmdn2_d_t.* = g_pmdn2_d[l_ac].*  #BACKUP
               LET g_pmdn2_d_o.* = g_pmdn2_d[l_ac].*  #BACKUP
               CALL apmt500_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body2.after_set_entry_b"
               CALL apmt500_set_no_required_b()
               CALL apmt500_set_required_b()               
               #end add-point  
               CALL apmt500_set_no_entry_b(l_cmd)
               IF NOT apmt500_lock_b("pmdn_t","'2'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt500_bcl INTO g_pmdn_d[l_ac].pmdnsite,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001, 
                      g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006, 
                      g_pmdn_d[l_ac].pmdn007,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009,g_pmdn_d[l_ac].pmdn024, 
                      g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014,g_pmdn_d[l_ac].pmdn045, 
                      g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016, 
                      g_pmdn_d[l_ac].pmdn017,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn047,g_pmdn_d[l_ac].pmdn048, 
                      g_pmdn_d[l_ac].pmdn023,g_pmdn_d[l_ac].pmdn019,g_pmdn_d[l_ac].pmdn020,g_pmdn_d[l_ac].pmdn052, 
                      g_pmdn_d[l_ac].pmdn021,g_pmdn_d[l_ac].pmdn022,g_pmdn_d[l_ac].pmdnunit,g_pmdn_d[l_ac].pmdnorga, 
                      g_pmdn_d[l_ac].pmdn049,g_pmdn_d[l_ac].pmdn051,g_pmdn_d[l_ac].pmdn054,g_pmdn_d[l_ac].pmdn055, 
                      g_pmdn_d[l_ac].pmdn056,g_pmdn_d[l_ac].pmdn057,g_pmdn_d[l_ac].pmdn050,g_pmdn2_d[l_ac].pmdnseq, 
                      g_pmdn2_d[l_ac].pmdn027,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn030, 
                      g_pmdn2_d[l_ac].pmdn053,g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn031, 
                      g_pmdn2_d[l_ac].pmdn032,g_pmdn2_d[l_ac].pmdn033,g_pmdn2_d[l_ac].pmdn003,g_pmdn2_d[l_ac].pmdn036, 
                      g_pmdn2_d[l_ac].pmdn037,g_pmdn2_d[l_ac].pmdn038,g_pmdn2_d[l_ac].pmdn058,g_pmdn2_d[l_ac].pmdn039, 
                      g_pmdn2_d[l_ac].pmdn035,g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042, 
                      g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn044
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_pmdn2_d_mask_o[l_ac].* =  g_pmdn2_d[l_ac].*
                  CALL apmt500_pmdn_t_mask()
                  LET g_pmdn2_d_mask_n[l_ac].* =  g_pmdn2_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL apmt500_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body2.before_row"
           LET g_pmao_flag = 'N'       
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
 
            #其他table進行lock
            
 
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body2.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body2.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身2刪除前 name="input.body2.b_delete"
               #更新工单sfcb041 委外数量
               #代买料不影响可委外数量
               IF g_pmdl_m.pmdl005 = '2' AND g_pmdl_m.pmdl007 = '4' THEN
                   IF g_pmdn_d_t.pmdn019 <> '8' THEN
                      DECLARE sfcb_upd3 CURSOR FOR 
                         SELECT DISTINCT pmdp003,pmdp004,pmdp023,pmdp009,pmdp010,pmdp001 FROM pmdp_t   #170208-00026#1 add pmdp001 
                            WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                              AND pmdpseq = g_pmdn_d_t.pmdnseq
                      FOREACH sfcb_upd3 INTO l_pmdp003,l_pmdp004,l_pmdp023,l_pmdp009,l_pmdp010,l_pmdp001 #170208-00026#1 add pmdp001 
                      
                         #170208-00026#1 add   --begin--
                         SELECT COUNT(sfac001) INTO l_n1 FROM sfac_t
                          WHERE sfacent = g_enterprise AND sfacdocno = l_pmdp003
                            AND sfac001 = l_pmdp001 AND (sfac002 = '1' OR sfac002 = '2')
                         IF l_n1 = 0 THEN
                            CONTINUE FOREACH
                         END IF
                         #170208-00026#1 add   --end--
                      
                         #160316-00006#1---add---begin---
                         IF cl_null(l_pmdp009) THEN
                            LET l_pmdp009 = ' '
                         END IF
                         IF cl_null(l_pmdp010) THEN
                            LET l_pmdp010 = ' '
                         END IF
                         #160316-00006#1---add---end---
         
                         UPDATE sfcb_t SET sfcb041 = sfcb041 - l_pmdp023
                          WHERE sfcbent   = g_enterprise
                            AND sfcbdocno = l_pmdp003
                            AND sfcb001   = l_pmdp004
                            #AND sfcb003 = l_pmdp009  #160316-00006#1 mark
                            #AND sfcb004 = l_pmdp010  #160316-00006#1 mark
                            #160316-00006#1---add---begin---
                            AND (CASE WHEN sfcb003 IS NULL THEN ' ' ELSE sfcb003 END) = l_pmdp009
                            AND (CASE WHEN sfcb004 IS NULL THEN ' ' ELSE sfcb004 END) = l_pmdp010
                            #160316-00006#1---add---end---
                         IF SQLCA.sqlcode THEN
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = SQLCA.sqlcode
                            LET g_errparam.extend = 'update sfcb041'
                            LET g_errparam.popup = TRUE
                            CALL cl_err()
                         
                            CALL s_transaction_end('N','0')
                            CANCEL DELETE 
                            EXIT FOREACH                               
                         END IF
                      END FOREACH
                   END IF
               END IF                      
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_pmdl_m.pmdldocno
               LET gs_keys[gs_keys.getLength()+1] = g_pmdn2_d_t.pmdnseq
            
               #刪除同層單身
               IF NOT apmt500_delete_b('pmdn_t',gs_keys,"'2'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT apmt500_key_delete_b(gs_keys,'pmdn_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
 
               
               #add-point:單身2刪除中 name="input.body2.m_delete"
                              
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE apmt500_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身2刪除後 name="input.body2.a_delete"
                  DELETE FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = g_pmdn2_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdo_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF
                  
                  #更新請購單中的已轉採購量
                  IF NOT s_apmt500_upd_pmdb049(g_pmdl_m.pmdldocno,g_pmdn2_d_t.pmdnseq,'-1') THEN
                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF
                  
                  DELETE FROM pmdp_t WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn2_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdp_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF   
                  
                  DELETE FROM pmdq_t WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn2_d_t.pmdnseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdq_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     CANCEL DELETE  
                  END IF                   
               #end add-point
               LET l_count = g_pmdn_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body2.after_delete"
                        
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_pmdn2_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身2新增前 name="input.body2.b_a_insert"
            IF g_pmao_flag = 'Y' THEN
                  IF NOT s_axmt500_ins_pmao(g_pmdl_m.pmdldocno,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn2_d[l_ac].pmdn027,
                                            g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010) THEN
                     LET g_pmdn2_d[l_ac].pmdn027 = ''
                  END IF
               END IF             
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM pmdn_t 
             WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
               AND pmdnseq = g_pmdn2_d[l_ac].pmdnseq
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身2新增前 name="input.body2.b_insert"
                              
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmdl_m.pmdldocno
               LET gs_keys[2] = g_pmdn2_d[g_detail_idx].pmdnseq
               CALL apmt500_insert_b('pmdn_t',gs_keys,"'2'")
                           
               #add-point:單身新增後2 name="input.body2.a_insert"
                              
               #end add-point
            ELSE    
               INITIALIZE g_pmdn_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL apmt500_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body2.after_insert"
               
                             
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_pmdn2_d[l_ac].* = g_pmdn2_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt500_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_pmdn2_d[l_ac].* = g_pmdn2_d_t.*
            ELSE
               #add-point:單身page2修改前 name="input.body2.b_update"
               IF g_pmao_flag = 'Y' THEN
                  IF NOT s_axmt500_ins_pmao(g_pmdl_m.pmdldocno,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn2_d[l_ac].pmdn027,
                                            g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010) THEN
                     LET g_pmdn2_d[l_ac].pmdn027 = ''
                  END IF
               END IF                   
               #end add-point
               
               #寫入修改者/修改日期資訊(單身2)
               
               
               #將遮罩欄位還原
               CALL apmt500_pmdn_t_mask_restore('restore_mask_o')
                              
               UPDATE pmdn_t SET (pmdndocno,pmdnsite,pmdnseq,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006, 
                   pmdn007,pmdn008,pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015, 
                   pmdn016,pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022, 
                   pmdnunit,pmdnorga,pmdn049,pmdn051,pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,pmdn027, 
                   pmdn028,pmdn029,pmdn030,pmdn053,pmdn025,pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036, 
                   pmdn037,pmdn038,pmdn058,pmdn039,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044) = (g_pmdl_m.pmdldocno, 
                   g_pmdn_d[l_ac].pmdnsite,g_pmdn_d[l_ac].pmdnseq,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002, 
                   g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007, 
                   g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009,g_pmdn_d[l_ac].pmdn024,g_pmdn_d[l_ac].pmdn012, 
                   g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014,g_pmdn_d[l_ac].pmdn045,g_pmdn_d[l_ac].pmdn010, 
                   g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015,g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn017, 
                   g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn047,g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn023, 
                   g_pmdn_d[l_ac].pmdn019,g_pmdn_d[l_ac].pmdn020,g_pmdn_d[l_ac].pmdn052,g_pmdn_d[l_ac].pmdn021, 
                   g_pmdn_d[l_ac].pmdn022,g_pmdn_d[l_ac].pmdnunit,g_pmdn_d[l_ac].pmdnorga,g_pmdn_d[l_ac].pmdn049, 
                   g_pmdn_d[l_ac].pmdn051,g_pmdn_d[l_ac].pmdn054,g_pmdn_d[l_ac].pmdn055,g_pmdn_d[l_ac].pmdn056, 
                   g_pmdn_d[l_ac].pmdn057,g_pmdn_d[l_ac].pmdn050,g_pmdn2_d[l_ac].pmdn027,g_pmdn2_d[l_ac].pmdn028, 
                   g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn030,g_pmdn2_d[l_ac].pmdn053,g_pmdn2_d[l_ac].pmdn025, 
                   g_pmdn2_d[l_ac].pmdn026,g_pmdn2_d[l_ac].pmdn031,g_pmdn2_d[l_ac].pmdn032,g_pmdn2_d[l_ac].pmdn033, 
                   g_pmdn2_d[l_ac].pmdn003,g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037,g_pmdn2_d[l_ac].pmdn038, 
                   g_pmdn2_d[l_ac].pmdn058,g_pmdn2_d[l_ac].pmdn039,g_pmdn2_d[l_ac].pmdn035,g_pmdn2_d[l_ac].pmdn040, 
                   g_pmdn2_d[l_ac].pmdn041,g_pmdn2_d[l_ac].pmdn042,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn044)  
                   #自訂欄位頁簽
                WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
                  AND pmdnseq = g_pmdn2_d_t.pmdnseq #項次 
                  
               #add-point:單身page2修改中 name="input.body2.m_update"
                              
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_pmdn2_d[l_ac].* = g_pmdn2_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdn_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_pmdn2_d[l_ac].* = g_pmdn2_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmdl_m.pmdldocno
               LET gs_keys_bak[1] = g_pmdldocno_t
               LET gs_keys[2] = g_pmdn2_d[g_detail_idx].pmdnseq
               LET gs_keys_bak[2] = g_pmdn2_d_t.pmdnseq
               CALL apmt500_update_b('pmdn_t',gs_keys,gs_keys_bak,"'2'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL apmt500_pmdn_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_pmdn2_d[g_detail_idx].pmdnseq = g_pmdn2_d_t.pmdnseq 
                  ) THEN
                  LET gs_keys[01] = g_pmdl_m.pmdldocno
                  LET gs_keys[gs_keys.getLength()+1] = g_pmdn2_d_t.pmdnseq
                  CALL apmt500_key_update_b(gs_keys,'pmdn_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_pmdl_m),util.JSON.stringify(g_pmdn2_d_t)
               LET g_log2 = util.JSON.stringify(g_pmdl_m),util.JSON.stringify(g_pmdn2_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page2修改後 name="input.body2.a_update"
               #ming 20150904 add ------------------(S) 
               LET l_success = TRUE
               IF l_insert1 THEN
                  CALL s_apmt500_stus_abg(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'I')
                       RETURNING l_success,l_errno
                  LET l_insert1 = FALSE
               ELSE
                  CALL s_apmt500_stus_abg(g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'U')
                       RETURNING l_success,l_errno
               END IF
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = l_errno
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  LET g_pmdn2_d[l_ac].* = g_pmdn2_d_t.*
               END IF
               #ming 20150904 add ------------------(E) 
               #end add-point
            END IF
         
                  #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn027
            
            #add-point:AFTER FIELD pmdn027 name="input.a.page2.pmdn027"
            #20150505 modify by lixiang 150504-00013#7 --mark---
            #IF NOT cl_null(g_pmdn2_d[l_ac].pmdn027) THEN 
            #   #此段落由子樣板a19產生
            #   #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
            #   INITIALIZE g_chkparam.* TO NULL
            #   
            #   #設定g_chkparam.*的參數
            #   LET g_chkparam.arg1 = g_pmdl_m.pmdl004
            #   LET g_chkparam.arg2 = g_pmdn_d[l_ac].pmdn001
            #   LET g_chkparam.arg3 = g_pmdn_d[l_ac].pmdn002
            #   LET g_chkparam.arg4 = g_pmdn2_d[l_ac].pmdn027
            #   #呼叫檢查存在並帶值的library
            #   IF cl_chk_exist("v_pmao004") THEN
            #
            #   ELSE
            #      #檢查失敗時後續處理
            #      NEXT FIELD CURRENT
            #   END IF
            #END IF 
            #20150505 modify by lixiang 150504-00013#7 --mark---
            
            #20150505 modify by lixiang 150504-00013#7 --add---
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn027) THEN
               IF g_pmdn2_d[l_ac].pmdn027 != g_pmdn2_d_o.pmdn027 OR cl_null(g_pmdn2_d_o.pmdn027) THEN
                  #判斷供應商料號是否存在交易對象料號對應檔，若無，則跳出詢問示窗是否要回寫交易對象料號對應檔中
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n
                    FROM pmao_t
                   WHERE pmaoent = g_enterprise
                     AND pmao001 = g_pmdl_m.pmdl004
                     AND pmao002 = g_pmdn_d[l_ac].pmdn001
                     AND pmao003 = g_pmdn_d[l_ac].pmdn002
                     AND pmao004 = g_pmdn2_d[l_ac].pmdn027
                     AND pmao000 = '1'    #161221-00064##5 add
                  IF l_n = 0 THEN
                     IF cl_ask_confirm('apm-00894') THEN
                        LET g_pmao_flag = 'Y'
                        #IF NOT s_axmt500_ins_pmao(g_pmdl_m.pmdldocno,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn2_d[l_ac].pmdn027) THEN
                        #   LET g_pmdn2_d[l_ac].pmdn027 = ''
                        #   DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn027
                         #  NEXT FIELD pmdn027
                        #END IF
                     ELSE
                        
                        LET g_pmdn2_d[l_ac].pmdn027 = ''
                        DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn027
                        LET g_pmdn2_d[l_ac].l_pmao009 = ''
                        LET g_pmdn2_d[l_ac].l_pmao010 = ''
                        DISPLAY BY NAME g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
                        NEXT FIELD pmdn027
                     END IF
                  END IF
                  SELECT pmao009,pmao010
                    INTO g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
                    FROM pmao_t
                   WHERE pmaoent = g_enterprise
                     AND pmao001 = g_pmdl_m.pmdl004
                     AND pmao002 = g_pmdn_d[l_ac].pmdn001
                     AND pmao003 = g_pmdn_d[l_ac].pmdn002
                     AND pmao004 = g_pmdn2_d[l_ac].pmdn027   
                     AND pmao000 = '1'    #161221-00064##5 add                     
                     DISPLAY BY NAME g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
               END IF
            ELSE
               LET g_pmdn2_d[l_ac].l_pmao009 = ''
               LET g_pmdn2_d[l_ac].l_pmao010 = ''
               DISPLAY BY NAME g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
     
            END IF
            LET g_pmdn2_d_o.pmdn027 = g_pmdn2_d[l_ac].pmdn027      
            #20150505 modify by lixiang 150504-00013#7 --end---
            CALL apmt500_set_entry_b(l_cmd)
            CALL apmt500_set_no_entry_b(l_cmd)
            IF g_pmao_flag = 'Y' THEN
               NEXT FIELD l_pmao009
            END IF 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn027
            #add-point:BEFORE FIELD pmdn027 name="input.b.page2.pmdn027"
             CALL apmt500_set_entry_b(l_cmd)           
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn027
            #add-point:ON CHANGE pmdn027 name="input.g.page2.pmdn027"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_pmao009
            #add-point:BEFORE FIELD l_pmao009 name="input.b.page2.l_pmao009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_pmao009
            
            #add-point:AFTER FIELD l_pmao009 name="input.a.page2.l_pmao009"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_pmao009
            #add-point:ON CHANGE l_pmao009 name="input.g.page2.l_pmao009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_pmao010
            #add-point:BEFORE FIELD l_pmao010 name="input.b.page2.l_pmao010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_pmao010
            
            #add-point:AFTER FIELD l_pmao010 name="input.a.page2.l_pmao010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_pmao010
            #add-point:ON CHANGE l_pmao010 name="input.g.page2.l_pmao010"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn028
            
            #add-point:AFTER FIELD pmdn028 name="input.a.page2.pmdn028"
            CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn028) THEN 
               #此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdn_d[l_ac].pmdnunit
               LET g_chkparam.arg2 = g_pmdn2_d[l_ac].pmdn028

               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_inaa001_1") THEN
                  #檢查成功時後續處理
                  
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdn2_d[l_ac].pmdn028 = g_pmdn2_d_t.pmdn028
                  CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            
            #160104-00017#1 20160108 add by ming -----(S) 
               #如果採購性質是vmi採購的話，需要檢查是否為vmi倉 
               IF g_pmdl_m.pmdl005 = '3' THEN
                  IF g_pmdn2_d[l_ac].pmdn028 != g_pmdn2_d_o.pmdn028 OR cl_null(g_pmdn2_d_o.pmdn028) THEN
                     CALL cl_get_para(g_enterprise,g_site,'S-BAS-0043')
                          RETURNING l_code_s_bas_0043

                     LET l_cnt = 0
                     SELECT COUNT(1) INTO l_cnt
                       FROM inaa_t
                      WHERE inaaent  = g_enterprise
                        AND inaasite = g_site
                        AND inaa001 IN (SELECT DISTINCT inac001
                                          FROM inac_t
                                         WHERE inacent  = g_enterprise
                                           AND inacsite = g_site
                                           AND inacstus = 'Y'
                                           AND inac003  = l_code_s_bas_0043)
                        AND inaa001 = g_pmdn2_d[l_ac].pmdn028
                     IF cl_null(l_cnt) THEN
                        LET l_cnt = 0
                     END IF
                     IF l_cnt = 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.extend = g_pmdn2_d[l_ac].pmdn028
                        LET g_errparam.code   = 'apm-01060'
                        LET g_errparam.popup  = TRUE
                        CALL cl_err() 
                        
                        LET g_pmdn2_d[l_ac].pmdn028 = g_pmdn2_d_o.pmdn028
                        CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
                        DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #160104-00017#1 20160108 add by ming -----(E) 
            
            CALL apmt500_set_entry_b(l_cmd)
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()
            CALL apmt500_set_no_entry_b(l_cmd)
            
            IF NOT apmt500_pmdn029_chk() THEN
               LET g_pmdn2_d[l_ac].pmdn028 = g_pmdn2_d_t.pmdn028
               CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
               DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
               NEXT FIELD CURRENT            
            END IF
            
            #160104-00017#1 20160108 add by ming -----(S) 
            LET g_pmdn2_d_o.pmdn028 = g_pmdn2_d[l_ac].pmdn028
            #160104-00017#1 20160108 add by ming -----(E) 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn028
            #add-point:BEFORE FIELD pmdn028 name="input.b.page2.pmdn028"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn028
            #add-point:ON CHANGE pmdn028 name="input.g.page2.pmdn028"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn029
            
            #add-point:AFTER FIELD pmdn029 name="input.a.page2.pmdn029"
                                    CALL apmt500_pmdn029_ref(g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029) RETURNING g_pmdn2_d[l_ac].pmdn029_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn029_desc
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn029) THEN 
               IF NOT apmt500_pmdn029_chk() THEN
                  LET g_pmdn2_d[l_ac].pmdn029 = g_pmdn2_d_t.pmdn029
                  CALL apmt500_pmdn029_ref(g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029) RETURNING g_pmdn2_d[l_ac].pmdn029_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn029_desc
                  NEXT FIELD CURRENT            
               END IF
               
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn029
            #add-point:BEFORE FIELD pmdn029 name="input.b.page2.pmdn029"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn029
            #add-point:ON CHANGE pmdn029 name="input.g.page2.pmdn029"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn030
            #add-point:BEFORE FIELD pmdn030 name="input.b.page2.pmdn030"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn030
            
            #add-point:AFTER FIELD pmdn030 name="input.a.page2.pmdn030"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn030
            #add-point:ON CHANGE pmdn030 name="input.g.page2.pmdn030"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn053
            #add-point:BEFORE FIELD pmdn053 name="input.b.page2.pmdn053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn053
            
            #add-point:AFTER FIELD pmdn053 name="input.a.page2.pmdn053"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn053
            #add-point:ON CHANGE pmdn053 name="input.g.page2.pmdn053"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn025
            
            #add-point:AFTER FIELD pmdn025 name="input.a.page2.pmdn025"
                                    CALL apmt500_pmdl025_ref(g_pmdn2_d[l_ac].pmdn025) RETURNING g_pmdn2_d[l_ac].pmdn025_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn025_desc
            
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn025) THEN
               IF NOT apmt500_pmdn025_chk() THEN
                  LET g_pmdn2_d[l_ac].pmdn025 = g_pmdn2_d_t.pmdn025
                  CALL apmt500_pmdl025_ref(g_pmdn2_d[l_ac].pmdn025) RETURNING g_pmdn2_d[l_ac].pmdn025_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn025_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn025
            #add-point:BEFORE FIELD pmdn025 name="input.b.page2.pmdn025"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn025
            #add-point:ON CHANGE pmdn025 name="input.g.page2.pmdn025"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn026
            
            #add-point:AFTER FIELD pmdn026 name="input.a.page2.pmdn026"
            CALL apmt500_pmdl026_ref(g_pmdn2_d[l_ac].pmdn026) RETURNING g_pmdn2_d[l_ac].pmdn026_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026_desc
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn026) THEN
               LET l_oofb002 = ''
               SELECT ooef012 INTO l_oofb002 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_pmdn_d[l_ac].pmdnorga
               
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = l_oofb002
               LET g_chkparam.arg2 = g_pmdn2_d[l_ac].pmdn026
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="anm-00025:sub-01302|aooi350|",cl_get_progname("aooi350",g_lang,"2"),"|:EXEPROGaooi350"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF NOT cl_chk_exist("v_oofb019_2") THEN
                  LET g_pmdn2_d[l_ac].pmdn026 = g_pmdn2_d_t.pmdn026
                  CALL apmt500_pmdl026_ref(g_pmdn2_d[l_ac].pmdn026) RETURNING g_pmdn2_d[l_ac].pmdn026_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026_desc
                  NEXT FIELD CURRENT
               END IF
            END IF

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn026
            #add-point:BEFORE FIELD pmdn026 name="input.b.page2.pmdn026"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn026
            #add-point:ON CHANGE pmdn026 name="input.g.page2.pmdn026"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn031
            
            #add-point:AFTER FIELD pmdn031 name="input.a.page2.pmdn031"
                                    CALL apmt500_pmdl020_ref(g_pmdn2_d[l_ac].pmdn031) RETURNING g_pmdn2_d[l_ac].pmdn031_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn031_desc
            
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn031) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdn2_d[l_ac].pmdn031

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_263") THEN
                  #檢查成功時後續處理
                  
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdn2_d[l_ac].pmdn031 = g_pmdn2_d_t.pmdn031
                  CALL apmt500_pmdl020_ref(g_pmdn2_d[l_ac].pmdn031) RETURNING g_pmdn2_d[l_ac].pmdn031_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn031_desc
                  NEXT FIELD CURRENT
               END IF
            

            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn031
            #add-point:BEFORE FIELD pmdn031 name="input.b.page2.pmdn031"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn031
            #add-point:ON CHANGE pmdn031 name="input.g.page2.pmdn031"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn032
            #add-point:BEFORE FIELD pmdn032 name="input.b.page2.pmdn032"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn032
            
            #add-point:AFTER FIELD pmdn032 name="input.a.page2.pmdn032"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn032
            #add-point:ON CHANGE pmdn032 name="input.g.page2.pmdn032"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn033
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn2_d[l_ac].pmdn033,"0.000","1","100.000","1","azz-00087",1)  
                THEN
               NEXT FIELD pmdn033
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdn033 name="input.a.page2.pmdn033"
                                    IF NOT cl_null(g_pmdn2_d[l_ac].pmdn033) THEN 
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn033
            #add-point:BEFORE FIELD pmdn033 name="input.b.page2.pmdn033"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn033
            #add-point:ON CHANGE pmdn033 name="input.g.page2.pmdn033"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn003
            
            #add-point:AFTER FIELD pmdn003 name="input.a.page2.pmdn003"
                                    CALL apmt500_pmdn003_ref(g_pmdn2_d[l_ac].pmdn003) RETURNING g_pmdn2_d[l_ac].pmdn003_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn003_desc
            
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn003) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdn2_d[l_ac].pmdn003
               
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aim-00002:sub-01302|aimm200|",cl_get_progname("aimm200",g_lang,"2"),"|:EXEPROGaimm200"
               #160318-00025#15 by 07900 --add-end
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_imaa001_3") THEN
                  IF cl_chk_exist("v_imaf001_2") THEN
                     #檢查成功時後續處理
                     
                  ELSE
                     #檢查失敗時後續處理
                     LET g_pmdn2_d[l_ac].pmdn003 = g_pmdn2_d_t.pmdn003
                     CALL apmt500_pmdn003_ref(g_pmdn2_d[l_ac].pmdn003) RETURNING g_pmdn2_d[l_ac].pmdn003_desc
                     DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn003_desc
                     NEXT FIELD CURRENT
                  END IF
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdn2_d[l_ac].pmdn003 = g_pmdn2_d_t.pmdn003
                  CALL apmt500_pmdn003_ref(g_pmdn2_d[l_ac].pmdn003) RETURNING g_pmdn2_d[l_ac].pmdn003_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn003_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn003
            #add-point:BEFORE FIELD pmdn003 name="input.b.page2.pmdn003"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn003
            #add-point:ON CHANGE pmdn003 name="input.g.page2.pmdn003"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn036
            
            #add-point:AFTER FIELD pmdn036 name="input.a.page2.pmdn036"
            CALL s_desc_get_project_desc(g_pmdn2_d[l_ac].pmdn036) RETURNING g_pmdn2_d[l_ac].pmdn036_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn036_desc
            
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn036) THEN 
               IF g_pmdn2_d[l_ac].pmdn036 != g_pmdn2_d_o.pmdn036 OR cl_null(g_pmdn2_d_o.pmdn036) THEN
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmdn2_d[l_ac].pmdn036
                   #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="apj-00012:sub-01302|apjm200|",cl_get_progname("apjm200",g_lang,"2"),"|:EXEPROGapjm200"
                  #160318-00025#15 by 07900 --add-end 
                  
                  #呼叫檢查存在並帶值的library
                  IF NOT cl_chk_exist("v_pjba001") THEN
                     #檢查失敗時後續處理
                     LET g_pmdn2_d[l_ac].pmdn036 = g_pmdn2_d_o.pmdn036
                     CALL s_desc_get_project_desc(g_pmdn2_d[l_ac].pmdn036) RETURNING g_pmdn2_d[l_ac].pmdn036_desc
                     DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn036_desc
                     NEXT FIELD CURRENT
                  END IF
                  LET g_pmdn2_d[l_ac].pmdn037 = ''
                  LET g_pmdn2_d[l_ac].pmdn037_desc = ''
                  LET g_pmdn2_d[l_ac].pmdn038 = ''
                  LET g_pmdn2_d[l_ac].pmdn038_desc = ''
               END IF
            END IF 
            LET g_pmdn2_d_o.pmdn036 = g_pmdn2_d[l_ac].pmdn036

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn036
            #add-point:BEFORE FIELD pmdn036 name="input.b.page2.pmdn036"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn036
            #add-point:ON CHANGE pmdn036 name="input.g.page2.pmdn036"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn037
            
            #add-point:AFTER FIELD pmdn037 name="input.a.page2.pmdn037"
            CALL s_desc_get_wbs_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037) RETURNING g_pmdn2_d[l_ac].pmdn037_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn037_desc
            
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn037) THEN 
               #欄位存在檢查
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL

               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdn2_d[l_ac].pmdn036
               LET g_chkparam.arg2 = g_pmdn2_d[l_ac].pmdn037
                  
               #呼叫檢查存在並帶值的library
               IF NOT cl_chk_exist("v_pjbb002") THEN
                  #檢查失敗時後續處理
                  LET g_pmdn2_d[l_ac].pmdn037 = g_pmdn2_d_t.pmdn037
                  CALL s_desc_get_wbs_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037) RETURNING g_pmdn2_d[l_ac].pmdn037_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn037_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn037
            #add-point:BEFORE FIELD pmdn037 name="input.b.page2.pmdn037"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn037
            #add-point:ON CHANGE pmdn037 name="input.g.page2.pmdn037"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn038
            
            #add-point:AFTER FIELD pmdn038 name="input.a.page2.pmdn038"
            CALL s_desc_get_activity_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn038) RETURNING g_pmdn2_d[l_ac].pmdn038_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn038_desc
            
            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn038) THEN 
               #欄位存在檢查
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL

               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdn2_d[l_ac].pmdn036
               LET g_chkparam.arg2 = g_pmdn2_d[l_ac].pmdn038
                  
               #呼叫檢查存在並帶值的library
               IF NOT cl_chk_exist("v_pjbm002") THEN
                  #檢查失敗時後續處理
                  LET g_pmdn2_d[l_ac].pmdn038 = g_pmdn2_d_t.pmdn038
                  CALL s_desc_get_activity_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn038) RETURNING g_pmdn2_d[l_ac].pmdn038_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn038_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

                       
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn038
            #add-point:BEFORE FIELD pmdn038 name="input.b.page2.pmdn038"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn038
            #add-point:ON CHANGE pmdn038 name="input.g.page2.pmdn038"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn058
            
            #add-point:AFTER FIELD pmdn058 name="input.a.page2.pmdn058"
            #ming 20150903 add ---------------(S) 
            #科目預算 
            LET g_pmdn2_d[l_ac].pmdn058_desc = ''
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn058_desc

            IF NOT cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
               CALL apmt500_detail_abg('2')
                    RETURNING l_success,l_errno_abg,l_bgaf016,
                              l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql
               LET g_pmdn2_d[l_ac].pmdn058_desc = l_pmdn058_desc
               DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn058_desc

               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ''
                  LET g_errparam.code   = l_errno_abg
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()

                  LET g_pmdn2_d[l_ac].pmdn058 = g_pmdn2_d_t.pmdn058
                  CALL apmt500_detail_abg('3')
                       RETURNING l_success,l_errno_abg,l_bgaf016,
                                 l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql
                  LET g_pmdn2_d[l_ac].pmdn058_desc = l_pmdn058_desc
                  DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn058_desc
                  NEXT FIELD CURRENT
               END IF
               #161213-00041#1 add(s)   
               IF NOT cl_null(g_pmdn_d[l_ac].pmdn015) THEN
                  #科目預算  
                  CALL apmt500_detail_abg('4')
                       RETURNING l_success,l_errno_abg,l_bgaf016,
                                 l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql
                   
                  IF NOT l_success THEN
                     CASE l_errno_abg
                        WHEN 'abg-00103'     #輸入金額超出預算限額，不可輸入!!!  
                           CASE l_bgaf016
                              WHEN '1'
                              WHEN '2'
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.extend = ''
                                 LET g_errparam.code   = l_errno_abg
                                 LET g_errparam.popup  = TRUE
                                 CALL cl_err()
                              WHEN '3'
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.extend = ''
                                 LET g_errparam.code   = l_errno_abg
                                 LET g_errparam.popup  = TRUE
                                 CALL cl_err()
                                 NEXT FIELD CURRENT
                           END CASE
                        WHEN 'abg-00104'     #輸入金額超出可用預算，請加速審核!!! 
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = '' 
                           LET g_errparam.code   = l_errno_abg
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()
                        OTHERWISE
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.extend = ''
                           LET g_errparam.code   = l_errno_abg
                           LET g_errparam.popup  = TRUE
                           CALL cl_err()
                           NEXT FIELD CURRENT
                     END CASE
                  END IF
               END IF
               #161213-00041#1 add(e)
            END IF
            #ming 20150903 add ---------------(E) 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn058
            #add-point:BEFORE FIELD pmdn058 name="input.b.page2.pmdn058"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn058
            #add-point:ON CHANGE pmdn058 name="input.g.page2.pmdn058"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn058_desc
            #add-point:BEFORE FIELD pmdn058_desc name="input.b.page2.pmdn058_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn058_desc
            
            #add-point:AFTER FIELD pmdn058_desc name="input.a.page2.pmdn058_desc"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn058_desc
            #add-point:ON CHANGE pmdn058_desc name="input.g.page2.pmdn058_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn039
            #add-point:BEFORE FIELD pmdn039 name="input.b.page2.pmdn039"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn039
            
            #add-point:AFTER FIELD pmdn039 name="input.a.page2.pmdn039"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn039
            #add-point:ON CHANGE pmdn039 name="input.g.page2.pmdn039"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn035
            #add-point:BEFORE FIELD pmdn035 name="input.b.page2.pmdn035"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn035
            
            #add-point:AFTER FIELD pmdn035 name="input.a.page2.pmdn035"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn035
            #add-point:ON CHANGE pmdn035 name="input.g.page2.pmdn035"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn040
            #add-point:BEFORE FIELD pmdn040 name="input.b.page2.pmdn040"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn040
            
            #add-point:AFTER FIELD pmdn040 name="input.a.page2.pmdn040"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn040
            #add-point:ON CHANGE pmdn040 name="input.g.page2.pmdn040"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn041
            #add-point:BEFORE FIELD pmdn041 name="input.b.page2.pmdn041"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn041
            
            #add-point:AFTER FIELD pmdn041 name="input.a.page2.pmdn041"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn041
            #add-point:ON CHANGE pmdn041 name="input.g.page2.pmdn041"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn042
            #add-point:BEFORE FIELD pmdn042 name="input.b.page2.pmdn042"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn042
            
            #add-point:AFTER FIELD pmdn042 name="input.a.page2.pmdn042"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn042
            #add-point:ON CHANGE pmdn042 name="input.g.page2.pmdn042"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn043
            #add-point:BEFORE FIELD pmdn043 name="input.b.page2.pmdn043"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn043
            
            #add-point:AFTER FIELD pmdn043 name="input.a.page2.pmdn043"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn043
            #add-point:ON CHANGE pmdn043 name="input.g.page2.pmdn043"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdn044
            #add-point:BEFORE FIELD pmdn044 name="input.b.page2.pmdn044"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdn044
            
            #add-point:AFTER FIELD pmdn044 name="input.a.page2.pmdn044"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdn044
            #add-point:ON CHANGE pmdn044 name="input.g.page2.pmdn044"
                        
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page2.pmdn027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn027
            #add-point:ON ACTION controlp INFIELD pmdn027 name="input.c.page2.pmdn027"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn027             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004 #
            LET g_qryparam.arg2 = g_pmdn_d[l_ac].pmdn001 #
            LET g_qryparam.arg3 = g_pmdn_d[l_ac].pmdn002 #

            CALL q_pmao004_1()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn027 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn2_d[l_ac].pmdn027 TO pmdn027              #顯示到畫面上
            SELECT pmao009,pmao010
               INTO g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
               FROM pmao_t
              WHERE pmaoent = g_enterprise
                AND pmao001 = g_pmdl_m.pmdl004
                AND pmao002 = g_pmdn_d[l_ac].pmdn001
                AND pmao003 = g_pmdn_d[l_ac].pmdn002
                AND pmao004 = g_pmdn2_d[l_ac].pmdn027     
                AND pmao000 = '1'   #161221-00064##5 add                
            DISPLAY BY NAME g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
            NEXT FIELD pmdn027                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.l_pmao009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_pmao009
            #add-point:ON ACTION controlp INFIELD l_pmao009 name="input.c.page2.l_pmao009"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.l_pmao010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_pmao010
            #add-point:ON ACTION controlp INFIELD l_pmao010 name="input.c.page2.l_pmao010"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn028
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn028
            #add-point:ON ACTION controlp INFIELD pmdn028 name="input.c.page2.pmdn028"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn028             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn_d[l_ac].pmdnunit #

            CALL q_inaa001_6()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn028 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn2_d[l_ac].pmdn028 TO pmdn028              #顯示到畫面上

            NEXT FIELD pmdn028                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn029
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn029
            #add-point:ON ACTION controlp INFIELD pmdn029 name="input.c.page2.pmdn029"
                        #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn029             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn_d[l_ac].pmdnunit #
            LET g_qryparam.arg2 = g_pmdn2_d[l_ac].pmdn028 #

            CALL q_inab002_6()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn029 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn2_d[l_ac].pmdn029 TO pmdn029              #顯示到畫面上

            NEXT FIELD pmdn029                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn030
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn030
            #add-point:ON ACTION controlp INFIELD pmdn030 name="input.c.page2.pmdn030"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn053
            #add-point:ON ACTION controlp INFIELD pmdn053 name="input.c.page2.pmdn053"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn025
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn025
            #add-point:ON ACTION controlp INFIELD pmdn025 name="input.c.page2.pmdn025"
                        #此段落由子樣板a07產生            
            #開窗i段
            MENU "" ATTRIBUTE (STYLE="popup", IMAGE="question")
               ON ACTION open_ooef   #營運據點
                  LET g_bgjob = '1'
                  EXIT MENU

               ON ACTION open_inaa   #庫位
                  LET g_bgjob = '2'
                  EXIT MENU
            END MENU
            
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn025             #給予default值

            #給予arg
            LET l_ooef012 = ''
            IF g_bgjob = '1' THEN
               SELECT ooef012 INTO l_ooef012 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_pmdn_d[l_ac].pmdnunit
            ELSE
               SELECT inaa004 INTO l_ooef012 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_pmdn_d[l_ac].pmdnunit AND inaa001 = g_pmdn2_d[l_ac].pmdn028
            END IF
            LET g_qryparam.arg1 = l_ooef012
            LET g_qryparam.where = " oofb008 = '3' "
            

            CALL q_oofb019_1()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn025 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn2_d[l_ac].pmdn025 TO pmdn025              #顯示到畫面上
            CALL apmt500_pmdl025_ref(g_pmdn2_d[l_ac].pmdn025) RETURNING g_pmdn2_d[l_ac].pmdn025_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn025_desc

            NEXT FIELD pmdn025                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn026
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn026
            #add-point:ON ACTION controlp INFIELD pmdn026 name="input.c.page2.pmdn026"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn026             #給予default值

            #給予arg
            LET l_ooef012 = ''
            SELECT ooef012 INTO l_ooef012 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_pmdn_d[l_ac].pmdnorga
            
            LET g_qryparam.arg1 = l_ooef012
            LET g_qryparam.where = " oofb008 = '5' "

            CALL q_oofb019_1()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn026 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn2_d[l_ac].pmdn026 TO pmdn026              #顯示到畫面上
            CALL apmt500_pmdl026_ref(g_pmdn2_d[l_ac].pmdn026) RETURNING g_pmdn2_d[l_ac].pmdn026_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026_desc

            NEXT FIELD pmdn026                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn031
            #add-point:ON ACTION controlp INFIELD pmdn031 name="input.c.page2.pmdn031"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn031             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "263" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn031 = g_qryparam.return1              #將開窗取得的值回傳到變數
            #LET g_pmdn2_d[l_ac].oocq010 = g_qryparam.return2 #參考欄位七

            DISPLAY g_pmdn2_d[l_ac].pmdn031 TO pmdn031              #顯示到畫面上
            CALL apmt500_pmdl020_ref(g_pmdn2_d[l_ac].pmdn031) RETURNING g_pmdn2_d[l_ac].pmdn031_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn031_desc

            NEXT FIELD pmdn031                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn032
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn032
            #add-point:ON ACTION controlp INFIELD pmdn032 name="input.c.page2.pmdn032"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn033
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn033
            #add-point:ON ACTION controlp INFIELD pmdn033 name="input.c.page2.pmdn033"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn003
            #add-point:ON ACTION controlp INFIELD pmdn003 name="input.c.page2.pmdn003"
                        #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn003             #給予default值
            
            #給予arg

            CALL q_imaf001_5()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn003 = g_qryparam.return1              #將開窗取得的值回傳到變數
           
            DISPLAY g_pmdn2_d[l_ac].pmdn003 TO pmdn003              #顯示到畫面上
            CALL apmt500_pmdn003_ref(g_pmdn2_d[l_ac].pmdn003) RETURNING g_pmdn2_d[l_ac].pmdn003_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn003_desc

            NEXT FIELD pmdn003                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn036
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn036
            #add-point:ON ACTION controlp INFIELD pmdn036 name="input.c.page2.pmdn036"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn036             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #s


            CALL q_pjba001()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn036 = g_qryparam.return1              

            DISPLAY g_pmdn2_d[l_ac].pmdn036 TO pmdn036              #
            CALL s_desc_get_project_desc(g_pmdn2_d[l_ac].pmdn036) RETURNING g_pmdn2_d[l_ac].pmdn036_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn036_desc
         
            NEXT FIELD pmdn036                          #返回原欄位

                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn037
            #add-point:ON ACTION controlp INFIELD pmdn037 name="input.c.page2.pmdn037"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn037             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn2_d[l_ac].pmdn036  #s


            CALL q_pjbb002_1()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn037 = g_qryparam.return1              

            DISPLAY g_pmdn2_d[l_ac].pmdn037 TO pmdn037              #
            CALL s_desc_get_wbs_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037) RETURNING g_pmdn2_d[l_ac].pmdn037_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn037_desc
         
            NEXT FIELD pmdn037                          #返回原欄位

                       
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn038
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn038
            #add-point:ON ACTION controlp INFIELD pmdn038 name="input.c.page2.pmdn038"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn2_d[l_ac].pmdn038             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdn2_d[l_ac].pmdn036  #s


            CALL q_pjbm002()                                #呼叫開窗

            LET g_pmdn2_d[l_ac].pmdn038 = g_qryparam.return1              

            DISPLAY g_pmdn2_d[l_ac].pmdn038 TO pmdn038              #
            CALL s_desc_get_activity_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn038) RETURNING g_pmdn2_d[l_ac].pmdn038_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn038_desc
         
            NEXT FIELD pmdn038                          #返回原欄位

                                               
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn058
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn058
            #add-point:ON ACTION controlp INFIELD pmdn058 name="input.c.page2.pmdn058"
            #ming 20150903 add -------------------------(S)  
            #科目預算 
            CALL apmt500_detail_abg('1')
                 RETURNING l_success,l_errno_abg,l_bgaf016,
                           l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql
            LET g_pmdn2_d[l_ac].pmdn058 = l_pmdn058
            LET g_pmdn2_d[l_ac].pmdn058_desc = l_pmdn058_desc
            DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn058,g_pmdn2_d[l_ac].pmdn058_desc
            #ming 20150903 add -------------------------(E)  
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn058_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn058_desc
            #add-point:ON ACTION controlp INFIELD pmdn058_desc name="input.c.page2.pmdn058_desc"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn039
            #add-point:ON ACTION controlp INFIELD pmdn039 name="input.c.page2.pmdn039"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn035
            #add-point:ON ACTION controlp INFIELD pmdn035 name="input.c.page2.pmdn035"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn040
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn040
            #add-point:ON ACTION controlp INFIELD pmdn040 name="input.c.page2.pmdn040"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn041
            #add-point:ON ACTION controlp INFIELD pmdn041 name="input.c.page2.pmdn041"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn042
            #add-point:ON ACTION controlp INFIELD pmdn042 name="input.c.page2.pmdn042"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn043
            #add-point:ON ACTION controlp INFIELD pmdn043 name="input.c.page2.pmdn043"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page2.pmdn044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdn044
            #add-point:ON ACTION controlp INFIELD pmdn044 name="input.c.page2.pmdn044"
                        
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page2 after_row name="input.body2.after_row"
            #ming 20150903 add ---------------------------(S)             
            #科目預算 
            IF l_insert1 THEN
               CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
                    RETURNING l_success,l_slip
               IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
                  IF cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
                     NEXT FIELD pmdn058
                  END IF
               END IF
            END IF
            #ming 20150903 add ---------------------------(E)          
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_pmdn2_d[l_ac].* = g_pmdn2_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt500_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL apmt500_unlock_b("pmdn_t","'2'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page2 after_row2 name="input.body2.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body2.after_input"
                        
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_pmdn_d[li_reproduce_target].* = g_pmdn_d[li_reproduce].*
               LET g_pmdn2_d[li_reproduce_target].* = g_pmdn2_d[li_reproduce].*
 
               LET g_pmdn2_d[li_reproduce_target].pmdnseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_pmdn2_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_pmdn2_d.getLength()+1
            END IF
            
      END INPUT
      INPUT ARRAY g_pmdn4_d FROM s_detail4.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)
                 
         #自訂ACTION(detail_input,page_4)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body4.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_pmdn4_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL apmt500_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'5',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_pmdn4_d.getLength()
            #add-point:資料輸入前 name="input.body4.before_input"
                        
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmdn4_d[l_ac].* TO NULL 
            INITIALIZE g_pmdn4_d_t.* TO NULL 
            INITIALIZE g_pmdn4_d_o.* TO NULL 
            #公用欄位給值(單身4)
            
            #自定義預設值(單身4)
            
            #add-point:modify段before備份 name="input.body4.insert.before_bak"
            
            #end add-point
            LET g_pmdn4_d_t.* = g_pmdn4_d[l_ac].*     #新輸入資料
            LET g_pmdn4_d_o.* = g_pmdn4_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL apmt500_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body4.insert.after_set_entry_b"
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()            
            #end add-point
            CALL apmt500_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_pmdn4_d[li_reproduce_target].* = g_pmdn4_d[li_reproduce].*
 
               LET g_pmdn4_d[li_reproduce_target].pmdpseq = NULL
               LET g_pmdn4_d[li_reproduce_target].pmdpseq1 = NULL
            END IF
            
 
            #add-point:modify段before insert name="input.body4.before_insert"
            LET g_pmdn4_d[l_ac].pmdpsite = g_site
            LET g_pmdn4_d[l_ac].pmdpseq = g_pmdn_d[l_ac].pmdnseq
            
            SELECT MAX(pmdpseq1)+1 INTO g_pmdn4_d[l_ac].pmdpseq1 FROM pmdp_t
               WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                 AND pmdpseq = g_pmdn4_d[l_ac].pmdpseq
            IF cl_null(g_pmdn4_d[l_ac].pmdpseq1) OR g_pmdn4_d[l_ac].pmdpseq1 = 0 THEN
               LET g_pmdn4_d[l_ac].pmdpseq1 = 1
            END IF
            
            SELECT MAX(pmdp021)+1 INTO g_pmdn4_d[l_ac].pmdp021 FROM pmdp_t
               WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                 AND pmdpseq = g_pmdn4_d[l_ac].pmdpseq
            IF cl_null(g_pmdn4_d[l_ac].pmdp021) OR g_pmdn4_d[l_ac].pmdp021 = 0 THEN
               LET g_pmdn4_d[l_ac].pmdp021 = 1
            END IF
            
            SELECT pmdn001,pmdn002 INTO g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp002
              FROM pmdn_t
            WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
              AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
              
            CALL apmt500_pmdn001_ref(g_pmdn4_d[l_ac].pmdp001) RETURNING g_pmdn4_d[l_ac].pmdp001_desc,g_pmdn4_d[l_ac].imaal004
            DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp001_desc,g_pmdn4_d[l_ac].imaal004
            
            LET g_pmdn4_d[l_ac].pmdp025 = 0
            LET g_pmdn4_d[l_ac].pmdp026 = 0
            

            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body4.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[4] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 4
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt500_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt500_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_pmdn4_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_pmdn4_d[l_ac].pmdpseq IS NOT NULL
               AND g_pmdn4_d[l_ac].pmdpseq1 IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_pmdn4_d_t.* = g_pmdn4_d[l_ac].*  #BACKUP
               LET g_pmdn4_d_o.* = g_pmdn4_d[l_ac].*  #BACKUP
               CALL apmt500_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body4.after_set_entry_b"
               CALL apmt500_set_no_required_b()
               CALL apmt500_set_required_b()               
               #end add-point  
               CALL apmt500_set_no_entry_b(l_cmd)
               IF NOT apmt500_lock_b("pmdp_t","'4'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt500_bcl3 INTO g_pmdn4_d[l_ac].pmdpsite,g_pmdn4_d[l_ac].pmdpseq,g_pmdn4_d[l_ac].pmdpseq1, 
                      g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp002,g_pmdn4_d[l_ac].pmdp003,g_pmdn4_d[l_ac].pmdp004, 
                      g_pmdn4_d[l_ac].pmdp005,g_pmdn4_d[l_ac].pmdp006,g_pmdn4_d[l_ac].pmdp007,g_pmdn4_d[l_ac].pmdp008, 
                      g_pmdn4_d[l_ac].pmdp009,g_pmdn4_d[l_ac].pmdp010,g_pmdn4_d[l_ac].pmdp011,g_pmdn4_d[l_ac].pmdp012, 
                      g_pmdn4_d[l_ac].pmdp021,g_pmdn4_d[l_ac].pmdp022,g_pmdn4_d[l_ac].pmdp023,g_pmdn4_d[l_ac].pmdp024, 
                      g_pmdn4_d[l_ac].pmdp025,g_pmdn4_d[l_ac].pmdp026
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_pmdn4_d_mask_o[l_ac].* =  g_pmdn4_d[l_ac].*
                  CALL apmt500_pmdp_t_mask()
                  LET g_pmdn4_d_mask_n[l_ac].* =  g_pmdn4_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL apmt500_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body4.before_row"
                        
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body4.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body4.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身4刪除前 name="input.body4.b_delete"
                              
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_pmdl_m.pmdldocno
               LET gs_keys[gs_keys.getLength()+1] = g_pmdn4_d_t.pmdpseq
               LET gs_keys[gs_keys.getLength()+1] = g_pmdn4_d_t.pmdpseq1
            
               #刪除同層單身
               IF NOT apmt500_delete_b('pmdp_t',gs_keys,"'4'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT apmt500_key_delete_b(gs_keys,'pmdp_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt500_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身4刪除中 name="input.body4.m_delete"
               #160920-00035#2---s
               IF g_pmdl_m.pmdl007 = '5' THEN
                  IF cl_null(g_pmdn4_d[l_ac].pmdp008) THEN
                     LET g_pmdn4_d[l_ac].pmdp008 = ' '
                  END IF
                  DECLARE aps_upd2 CURSOR FOR 
                    SELECT DISTINCT pspcsite,pspc001,pspc002,pspc004,pspc061 FROM pspc_t
                      WHERE pspcent = g_enterprise AND pspc004 = g_pmdn4_d[l_ac].pmdp003
                        AND pspc050 = g_pmdn4_d[l_ac].pmdp007 AND pspc051 = g_pmdn4_d[l_ac].pmdp008
                        AND pspc055 = g_pmdl_m.pmdldocno AND pspc056 = g_pmdn4_d[l_ac].pmdpseq
                  FOREACH aps_upd2 INTO l_pspcsite,l_pspc001,l_pspc002,l_pspc004,l_pspc061
                     IF l_pspc061 > g_pmdn4_d[l_ac].pmdp023 THEN
                        UPDATE pspc_t SET pspc061 = pspc061 - g_pmdn4_d[l_ac].pmdp023
                           WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                             AND pspc004 = l_pspc004
                     ELSE
                        UPDATE pspc_t SET pspc055 = '',
                                          pspc056 = '',
                                          pspc061 = 0
                           WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                             AND pspc004 = l_pspc004
                     END IF
                  END FOREACH
               END IF
               #160920-00035#2--e               
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE apmt500_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身4刪除後 name="input.body4.a_delete"
                                    
               #end add-point
               LET l_count = g_pmdn_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body4.after_delete"
                        
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_pmdn4_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身4新增前 name="input.body4.b_a_insert"
                        
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM pmdp_t 
             WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
               AND pmdpseq = g_pmdn4_d[l_ac].pmdpseq
               AND pmdpseq1 = g_pmdn4_d[l_ac].pmdpseq1
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身4新增前 name="input.body4.b_insert"
                              
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmdl_m.pmdldocno
               LET gs_keys[2] = g_pmdn4_d[g_detail_idx].pmdpseq
               LET gs_keys[3] = g_pmdn4_d[g_detail_idx].pmdpseq1
               CALL apmt500_insert_b('pmdp_t',gs_keys,"'4'")
                           
               #add-point:單身新增後4 name="input.body4.a_insert"
                              
               #end add-point
            ELSE    
               INITIALIZE g_pmdn_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL apmt500_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body4.after_insert"
                              
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_pmdn4_d[l_ac].* = g_pmdn4_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt500_bcl3
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_pmdn4_d[l_ac].* = g_pmdn4_d_t.*
            ELSE
               #add-point:單身page4修改前 name="input.body4.b_update"
                              
               #end add-point
               
               #寫入修改者/修改日期資訊(單身4)
               
               
               #將遮罩欄位還原
               CALL apmt500_pmdp_t_mask_restore('restore_mask_o')
                              
               UPDATE pmdp_t SET (pmdpdocno,pmdpsite,pmdpseq,pmdpseq1,pmdp001,pmdp002,pmdp003,pmdp004, 
                   pmdp005,pmdp006,pmdp007,pmdp008,pmdp009,pmdp010,pmdp011,pmdp012,pmdp021,pmdp022,pmdp023, 
                   pmdp024,pmdp025,pmdp026) = (g_pmdl_m.pmdldocno,g_pmdn4_d[l_ac].pmdpsite,g_pmdn4_d[l_ac].pmdpseq, 
                   g_pmdn4_d[l_ac].pmdpseq1,g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp002,g_pmdn4_d[l_ac].pmdp003, 
                   g_pmdn4_d[l_ac].pmdp004,g_pmdn4_d[l_ac].pmdp005,g_pmdn4_d[l_ac].pmdp006,g_pmdn4_d[l_ac].pmdp007, 
                   g_pmdn4_d[l_ac].pmdp008,g_pmdn4_d[l_ac].pmdp009,g_pmdn4_d[l_ac].pmdp010,g_pmdn4_d[l_ac].pmdp011, 
                   g_pmdn4_d[l_ac].pmdp012,g_pmdn4_d[l_ac].pmdp021,g_pmdn4_d[l_ac].pmdp022,g_pmdn4_d[l_ac].pmdp023, 
                   g_pmdn4_d[l_ac].pmdp024,g_pmdn4_d[l_ac].pmdp025,g_pmdn4_d[l_ac].pmdp026) #自訂欄位頁簽 
 
                WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                  AND pmdpseq = g_pmdn4_d_t.pmdpseq #項次 
                  AND pmdpseq1 = g_pmdn4_d_t.pmdpseq1
                  
               #add-point:單身page4修改中 name="input.body4.m_update"
                              
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_pmdn4_d[l_ac].* = g_pmdn4_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdp_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_pmdn4_d[l_ac].* = g_pmdn4_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmdl_m.pmdldocno
               LET gs_keys_bak[1] = g_pmdldocno_t
               LET gs_keys[2] = g_pmdn4_d[g_detail_idx].pmdpseq
               LET gs_keys_bak[2] = g_pmdn4_d_t.pmdpseq
               LET gs_keys[3] = g_pmdn4_d[g_detail_idx].pmdpseq1
               LET gs_keys_bak[3] = g_pmdn4_d_t.pmdpseq1
               CALL apmt500_update_b('pmdp_t',gs_keys,gs_keys_bak,"'4'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL apmt500_pmdp_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_pmdn4_d[g_detail_idx].pmdpseq = g_pmdn4_d_t.pmdpseq 
                  AND g_pmdn4_d[g_detail_idx].pmdpseq1 = g_pmdn4_d_t.pmdpseq1 
                  ) THEN
                  LET gs_keys[01] = g_pmdl_m.pmdldocno
                  LET gs_keys[gs_keys.getLength()+1] = g_pmdn4_d_t.pmdpseq
                  LET gs_keys[gs_keys.getLength()+1] = g_pmdn4_d_t.pmdpseq1
                  CALL apmt500_key_update_b(gs_keys,'pmdp_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_pmdl_m),util.JSON.stringify(g_pmdn4_d_t)
               LET g_log2 = util.JSON.stringify(g_pmdl_m),util.JSON.stringify(g_pmdn4_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page4修改後 name="input.body4.a_update"
               #160905-00006#1---S
               #修改关联单据页签的来源单号等内容时，同步更新来源请购单的已转采购量栏位
               IF cl_null(g_pmdn4_d_t.pmdp023) THEN 
                  LET g_pmdn4_d_t.pmdp023 = 0 
               END IF
               IF g_pmdn4_d[l_ac].pmdp003 <> g_pmdn4_d_t.pmdp003 OR g_pmdn4_d[l_ac].pmdp004 <> g_pmdn4_d_t.pmdp004 THEN
                  UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) - g_pmdn4_d_t.pmdp023
                       WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmdn4_d_t.pmdp003 AND pmdbseq = g_pmdn4_d_t.pmdp004
                  UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) + g_pmdn4_d[l_ac].pmdp023
                          WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmdn4_d[l_ac].pmdp003 AND pmdbseq = g_pmdn4_d[l_ac].pmdp004 
               ELSE
                  IF g_pmdn4_d_t.pmdp023 <> g_pmdn4_d[l_ac].pmdp023 THEN
               #160905-00006#1---E   
                     UPDATE pmdb_t SET pmdb049 = (CASE WHEN pmdb049 IS NULL THEN 0 ELSE pmdb049 END) - g_pmdn4_d_t.pmdp023 + g_pmdn4_d[l_ac].pmdp023
                          WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmdn4_d[l_ac].pmdp003 AND pmdbseq = g_pmdn4_d[l_ac].pmdp004 
                  END IF #160905-00006#1    
               END IF #160905-00006#1
               
               #160905-00006#1---S
               IF g_pmdn4_d[l_ac].pmdp003 <> g_pmdn4_d_t.pmdp003 OR g_pmdn4_d[l_ac].pmdp004 <> g_pmdn4_d_t.pmdp004 THEN
                  #请采勾稽时，更新采购单单身的数量栏位
                  CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
                  IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
                     SELECT SUM(pmdp024) INTO l_pmdp024 FROM pmdp_t 
                        WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn4_d[l_ac].pmdpseq
                     SELECT pmdnseq,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006,pmdn007,pmdn008,pmdn010,pmdn011,pmdn016
                         INTO l_pmdn.pmdnseq,l_pmdn.pmdn001,l_pmdn.pmdn002,l_pmdn.pmdn004,l_pmdn.pmdn005,l_pmdn.pmdn006,
                              l_pmdn.pmdn007,l_pmdn.pmdn008,l_pmdn.pmdn010,l_pmdn.pmdn011,l_pmdn.pmdn016
                         FROM pmdn_t
                        WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                     #采购数量有调整
                     IF l_pmdp024 <> l_pmdn.pmdn007 THEN
                        LET l_pmdn.pmdn007 = l_pmdp024
                        IF NOT cl_null(l_pmdn.pmdn006) THEN
                           CALL apmt500_unit_round(l_pmdn.pmdn006,l_pmdn.pmdn007) RETURNING l_pmdn.pmdn007

                           #計算參考數量
                           IF NOT cl_null(l_pmdn.pmdn008) THEN
                              CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn008,l_pmdn.pmdn007)
                                     RETURNING l_success,l_pmdn.pmdn009
                           END IF
                           
                           #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                           #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                           IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(l_pmdn.pmdn010)) THEN  #體參數使用採購計價單位
                              CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn010,l_pmdn.pmdn007)
                                     RETURNING l_success,l_pmdn.pmdn011
                           ELSE
                              LET l_pmdn.pmdn010 = l_pmdn.pmdn006
                              LET l_pmdn.pmdn011 = l_pmdn.pmdn007                     
                           END IF
                           
                           #取出價格
                           IF cl_null(l_pmdn.pmdn010) OR cl_null(l_pmdn.pmdn011) THEN
                              LET l_pmdn.pmdn010 = l_pmdn.pmdn006
                              LET l_pmdn.pmdn011 = l_pmdn.pmdn007
                           END IF
                           CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,l_pmdn.pmdn001,l_pmdn.pmdn002,g_pmdl_m.pmdl015,
                                      l_pmdn.pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                      g_pmdl_m.pmdldocdt,l_pmdn.pmdn010,l_pmdn.pmdn011,g_site,g_pmdl_m.pmdl054,g_type,l_pmdn.pmdn004,l_pmdn.pmdn005)
                                  RETURNING l_pmdn.pmdn040,l_pmdn.pmdn043,l_pmdn.pmdn041,l_pmdn.pmdn042
                        
                           LET l_pmdn.pmdn015 = l_pmdn.pmdn043
                           LET l_pmdn.pmdn044 = 0
                        
                           #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                           CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq,g_pmdl_m.pmdl015,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016)
                                RETURNING l_pmdn.pmdn046,l_pmdn.pmdn048,l_pmdn.pmdn047                   
                        END IF
                        
                        UPDATE pmdn_t SET pmdn007 = l_pmdn.pmdn007,
                                          pmdn009 = l_pmdn.pmdn009,
                                          pmdn010 = l_pmdn.pmdn010,
                                          pmdn011 = l_pmdn.pmdn011,
                                          pmdn040 = l_pmdn.pmdn040,
                                          pmdn043 = l_pmdn.pmdn043,
                                          pmdn041 = l_pmdn.pmdn041,
                                          pmdn042 = l_pmdn.pmdn042,
                                          pmdn044 = l_pmdn.pmdn044,
                                          pmdn046 = l_pmdn.pmdn046,
                                          pmdn048 = l_pmdn.pmdn048,
                                          pmdn047 = l_pmdn.pmdn047
                              WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq 
                        
                        #如果有維護多交期，重新維護價格
                        IF l_pmdn.pmdn024 = 'Y' THEN
                           IF cl_ask_confirm('apm-01097') THEN
                              CALL apmt500_03(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq,l_pmdn.pmdn007) 
                                RETURNING l_pmdn.pmdn012,l_pmdn.pmdn013,l_pmdn.pmdn014
                              #呼叫"產生採購交期明細資料"的Function產生交期明細資料
                              CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq) RETURNING l_success
                              
                              UPDATE pmdn_t SET pmdn012 = l_pmdn.pmdn012,
                                                pmdn013 = l_pmdn.pmdn013,
                                                pmdn014 = l_pmdn.pmdn014
                                    WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq 
                           END IF
                        ELSE
                           CALL s_apmt500_gen_pmdq(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq) RETURNING l_success
                           
                           CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq) RETURNING l_success

                        END IF
                        
                        CALL apmt500_b_fill()
                     END IF

                  END IF
               END IF
               #160905-00006#1---E      
               #160920-00035#2---s
               IF g_pmdl_m.pmdl007 = '5' THEN
                  IF cl_null(g_pmdn4_d[l_ac].pmdp008) THEN
                     LET g_pmdn4_d[l_ac].pmdp008 = ' '
                  END IF
                  #修改来源单号
                  IF (NOT cl_null(g_pmdn4_d[l_ac].pmdp003)) AND ((g_pmdn4_d[l_ac].pmdp003 <> g_pmdn4_d_t.pmdp003 AND NOT cl_null(g_pmdn4_d_t.pmdp003)) 
                                                                 OR (g_pmdn4_d[l_ac].pmdp023 <> g_pmdn4_d_t.pmdp023)) THEN
                     SELECT DISTINCT pspcsite,pspc001,pspc002,pspc004,pspc061 
                          INTO l_pspcsite,l_pspc001,l_pspc002,l_pspc004,l_pspc061
                         FROM pspc_t
                       WHERE pspcent = g_enterprise AND pspc004 = g_pmdn4_d_t.pmdp003
                         AND pspc050 = g_pmdn4_d[l_ac].pmdp007 AND pspc051 = g_pmdn4_d[l_ac].pmdp008
                         AND pspc055 = g_pmdl_m.pmdldocno AND pspc056 = g_pmdn4_d[l_ac].pmdpseq
                     IF l_pspc061 > g_pmdn4_d_t.pmdp023 THEN
                        UPDATE pspc_t SET pspc061 = pspc061 - g_pmdn4_d_t.pmdp023
                           WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                             AND pspc004 = l_pspc004
                     ELSE
                        UPDATE pspc_t SET pspc055 = '',
                                          pspc056 = '',
                                          pspc061 = 0
                           WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                             AND pspc004 = l_pspc004
                     END IF
                     UPDATE pspc_t SET pspc061 = pspc061 + g_pmdn4_d[l_ac].pmdp023
                        WHERE pspcent = g_enterprise AND pspc004 = g_pmdn4_d[l_ac].pmdp003
                         AND pspc050 = g_pmdn4_d[l_ac].pmdp007 AND pspc051 = g_pmdn4_d[l_ac].pmdp008
                         AND pspc055 = g_pmdl_m.pmdldocno AND pspc056 = g_pmdn4_d[l_ac].pmdpseq
                  END IF
                  IF (cl_null(g_pmdn4_d[l_ac].pmdp003)) AND (NOT cl_null(g_pmdn4_d_t.pmdp003)) THEN
                     SELECT DISTINCT pspcsite,pspc001,pspc002,pspc004,pspc061 
                          INTO l_pspcsite,l_pspc001,l_pspc002,l_pspc004,l_pspc061
                         FROM pspc_t
                       WHERE pspcent = g_enterprise AND pspc004 = g_pmdn4_d[l_ac].pmdp003
                         AND pspc050 = g_pmdn4_d[l_ac].pmdp007 AND pspc051 = g_pmdn4_d[l_ac].pmdp008
                         AND pspc055 = g_pmdl_m.pmdldocno AND pspc056 = g_pmdn4_d[l_ac].pmdpseq
                     IF l_pspc061 > g_pmdn4_d_t.pmdp023 THEN
                        UPDATE pspc_t SET pspc061 = pspc061 - g_pmdn4_d_t.pmdp023
                           WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                             AND pspc004 = l_pspc004
                     ELSE
                        UPDATE pspc_t SET pspc055 = '',
                                          pspc056 = '',
                                          pspc061 = 0
                           WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                             AND pspc004 = l_pspc004
                     END IF
                  END IF
                  IF (NOT cl_null(g_pmdn4_d[l_ac].pmdp003)) AND (cl_null(g_pmdn4_d_t.pmdp003)) THEN
                     UPDATE pspc_t SET pspc061 = pspc061 + g_pmdn4_d[l_ac].pmdp023
                        WHERE pspcent = g_enterprise AND pspc004 = g_pmdn4_d[l_ac].pmdp003
                         AND pspc050 = g_pmdn4_d[l_ac].pmdp007 AND pspc051 = g_pmdn4_d[l_ac].pmdp008
                         AND pspc055 = g_pmdl_m.pmdldocno AND pspc056 = g_pmdn4_d[l_ac].pmdpseq
                  END IF
               END IF    
               #160920-00035#2---e                     
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdpsite
            #add-point:BEFORE FIELD pmdpsite name="input.b.page4.pmdpsite"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdpsite
            
            #add-point:AFTER FIELD pmdpsite name="input.a.page4.pmdpsite"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdpsite
            #add-point:ON CHANGE pmdpsite name="input.g.page4.pmdpsite"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdpseq
            #add-point:BEFORE FIELD pmdpseq name="input.b.page4.pmdpseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdpseq
            
            #add-point:AFTER FIELD pmdpseq name="input.a.page4.pmdpseq"
            #此段落由子樣板a05產生
            IF  g_pmdl_m.pmdldocno IS NOT NULL AND g_pmdn4_d[g_detail_idx].pmdpseq IS NOT NULL AND g_pmdn4_d[g_detail_idx].pmdpseq1 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdl_m.pmdldocno != g_pmdldocno_t OR g_pmdn4_d[g_detail_idx].pmdpseq != g_pmdn4_d_t.pmdpseq OR g_pmdn4_d[g_detail_idx].pmdpseq1 != g_pmdn4_d_t.pmdpseq1)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdp_t WHERE "||"pmdpent = '" ||g_enterprise|| "' AND "||"pmdpdocno = '"||g_pmdl_m.pmdldocno ||"' AND "|| "pmdpseq = '"||g_pmdn4_d[g_detail_idx].pmdpseq ||"' AND "|| "pmdpseq1 = '"||g_pmdn4_d[g_detail_idx].pmdpseq1 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdpseq
            #add-point:ON CHANGE pmdpseq name="input.g.page4.pmdpseq"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdpseq1
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn4_d[l_ac].pmdpseq1,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdpseq1
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdpseq1 name="input.a.page4.pmdpseq1"
                                    #此段落由子樣板a05產生
            IF  g_pmdl_m.pmdldocno IS NOT NULL AND g_pmdn4_d[l_ac].pmdpseq IS NOT NULL AND g_pmdn4_d[l_ac].pmdpseq1 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdl_m.pmdldocno != g_pmdldocno_t OR g_pmdn4_d[l_ac].pmdpseq != g_pmdn4_d_t.pmdpseq OR g_pmdn4_d[l_ac].pmdpseq1 != g_pmdn4_d_t.pmdpseq1)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdp_t WHERE "||"pmdpent = '" ||g_enterprise|| "' AND "||"pmdpdocno = '"||g_pmdl_m.pmdldocno ||"' AND "|| "pmdpseq = '"||g_pmdn4_d[l_ac].pmdpseq ||"' AND "|| "pmdpseq1 = '"||g_pmdn4_d[l_ac].pmdpseq1 ||"'",'std-00004',0) THEN 
                     LET g_pmdn4_d[l_ac].pmdpseq1 = g_pmdn4_d_t.pmdpseq1
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdpseq1
            #add-point:BEFORE FIELD pmdpseq1 name="input.b.page4.pmdpseq1"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdpseq1
            #add-point:ON CHANGE pmdpseq1 name="input.g.page4.pmdpseq1"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp001
            
            #add-point:AFTER FIELD pmdp001 name="input.a.page4.pmdp001"
                                    INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdn4_d[l_ac].pmdp001
            CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdn4_d[l_ac].pmdp001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp001_desc

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp001
            #add-point:BEFORE FIELD pmdp001 name="input.b.page4.pmdp001"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp001
            #add-point:ON CHANGE pmdp001 name="input.g.page4.pmdp001"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp002
            #add-point:BEFORE FIELD pmdp002 name="input.b.page4.pmdp002"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp002
            
            #add-point:AFTER FIELD pmdp002 name="input.a.page4.pmdp002"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp002
            #add-point:ON CHANGE pmdp002 name="input.g.page4.pmdp002"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp003
            #add-point:BEFORE FIELD pmdp003 name="input.b.page4.pmdp003"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp003
            
            #add-point:AFTER FIELD pmdp003 name="input.a.page4.pmdp003"
            IF NOT cl_null(g_pmdn4_d[l_ac].pmdp003) THEN
               #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdn4_d[l_ac].pmdp003 != g_pmdn4_d_t.pmdp003 )) THEN   #160905-00006#1 
               IF g_pmdn4_d[l_ac].pmdp003 != g_pmdn4_d_o.pmdp003 OR cl_null(g_pmdn4_d_o.pmdp003) THEN    #160905-00006#1 
                  IF NOT apmt500_pmdp003_chk(g_pmdn4_d[l_ac].pmdp003) THEN
                     #LET g_pmdn4_d[l_ac].pmdp003 = g_pmdn4_d_t.pmdp003  #160905-00006#1
                     LET g_pmdn4_d[l_ac].pmdp003 = g_pmdn4_d_o.pmdp003  #160905-00006#1
                     NEXT FIELD pmdp003
                  #ELSE                   #160905-00006#1 
                  #   NEXT FIELD pmdp004  #160905-00006#1
                  END IF
                  
                  #160905-00006#1--s
                  IF NOT cl_null(g_pmdn4_d[l_ac].pmdp004) THEN
                     IF NOT apmt500_pmdp004_chk(g_pmdn4_d[l_ac].pmdp003,g_pmdn4_d[l_ac].pmdp004) THEN
                        LET g_pmdn4_d[l_ac].pmdp003 = g_pmdn4_d_o.pmdp003
                        NEXT FIELD pmdp003
                     END IF
                     #若單據別設置是要作請採勾稽時，則修改料號時必須檢核是否與"關聯單據明細"中的來源料號有替代關係
                     CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
                     IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
                        SELECT pmdn001,pmdn002 INTO l_pmdn001,l_pmdn002 FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                        SELECT pmdb004,pmdb005 INTO l_pmdb004,l_pmdb005 FROM pmdb_t
                         WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmdn4_d[l_ac].pmdp003 AND pmdbseq = g_pmdn4_d[l_ac].pmdp004
                        IF (NOT cl_null(l_pmdb004)) AND (NOT cl_null(l_pmdn001)) AND (l_pmdb004 <> l_pmdn001) THEN
                           #請採購替代是否依據BOM替代資料
                           #選Y時，代表請購轉採購時可以依據BOM替代資料進行採購料的替代
                           #若選N，則是依據apmi131採購替代原則的設定進行採購料的替代
                           IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0096') = "Y" THEN
                              IF NOT s_apmt500_chk_bom_replace(l_pmdb004,l_pmdn001,l_pmdn002) THEN
                                 LET g_pmdn4_d[l_ac].pmdp003 = g_pmdn4_d_o.pmdp003
                                 NEXT FIELD pmdp003
                              END IF
                           ELSE                   
                              IF NOT s_pmaq_chk_replacement(g_pmdl_m.pmdl004,l_pmdb004,l_pmdn001,'2',l_pmdb005,l_pmdn002) THEN
                                 LET g_pmdn4_d[l_ac].pmdp003 = g_pmdn4_d_o.pmdp003
                                 NEXT FIELD pmdp003
                              END IF
                           END IF
                        END IF
                     END IF
                     CALL apmt500_pmdp004_ref()

                  END IF
                  #160905-00006#1--e
               END IF                  
            END IF
            LET g_pmdn4_d_o.pmdp003 = g_pmdn4_d[l_ac].pmdp003  #160905-00006#1 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp003
            #add-point:ON CHANGE pmdp003 name="input.g.page4.pmdp003"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp004
            #add-point:BEFORE FIELD pmdp004 name="input.b.page4.pmdp004"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp004
            
            #add-point:AFTER FIELD pmdp004 name="input.a.page4.pmdp004"
            IF NOT cl_null(g_pmdn4_d[l_ac].pmdp004) THEN
               #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdn4_d[l_ac].pmdp004 != g_pmdn4_d_t.pmdp004 )) THEN   #160905-00006#1 
               IF g_pmdn4_d[l_ac].pmdp004 != g_pmdn4_d_o.pmdp004 OR cl_null(g_pmdn4_d_o.pmdp004) THEN    #160905-00006#1 
                  IF NOT apmt500_pmdp004_chk(g_pmdn4_d[l_ac].pmdp003,g_pmdn4_d[l_ac].pmdp004) THEN
                     #LET g_pmdn4_d[l_ac].pmdp004 = g_pmdn4_d_t.pmdp004  #160905-00006#1 
                     LET g_pmdn4_d[l_ac].pmdp004 = g_pmdn4_d_o.pmdp004  #160905-00006#1 
                     NEXT FIELD pmdp004
                  END IF
                  #160905-00006#1--s
                  #若單據別設置是要作請採勾稽時，則修改料號時必須檢核是否與"關聯單據明細"中的來源料號有替代關係
                  CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
                  IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
                     SELECT pmdn001,pmdn002 INTO l_pmdn001,l_pmdn002 FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                     SELECT pmdb004,pmdb005 INTO l_pmdb004,l_pmdb005 FROM pmdb_t
                         WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmdn4_d[l_ac].pmdp003 AND pmdbseq = g_pmdn4_d[l_ac].pmdp004
                     IF (NOT cl_null(l_pmdb004)) AND (NOT cl_null(l_pmdn001)) AND (l_pmdb004 <> l_pmdn001) THEN
                        #請採購替代是否依據BOM替代資料
                        #選Y時，代表請購轉採購時可以依據BOM替代資料進行採購料的替代
                        #若選N，則是依據apmi131採購替代原則的設定進行採購料的替代
                        IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0096') = "Y" THEN
                           IF NOT s_apmt500_chk_bom_replace(l_pmdb004,l_pmdn001,l_pmdn002) THEN
                              LET g_pmdn4_d[l_ac].pmdp004 = g_pmdn4_d_o.pmdp004
                              NEXT FIELD pmdp004
                           END IF
                        ELSE                   
                           IF NOT s_pmaq_chk_replacement(g_pmdl_m.pmdl004,l_pmdb004,l_pmdn001,'2',l_pmdb005,l_pmdn002) THEN
                              LET g_pmdn4_d[l_ac].pmdp004 = g_pmdn4_d_o.pmdp004
                              NEXT FIELD pmdp004
                           END IF
                        END IF
                     END IF
                  END IF
                  #160905-00006#1--e   
                  CALL apmt500_pmdp004_ref()
                    
               END IF     
            END IF
            LET g_pmdn4_d_o.pmdp004 = g_pmdn4_d[l_ac].pmdp004  #160905-00006#1 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp004
            #add-point:ON CHANGE pmdp004 name="input.g.page4.pmdp004"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp005
            #add-point:BEFORE FIELD pmdp005 name="input.b.page4.pmdp005"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp005
            
            #add-point:AFTER FIELD pmdp005 name="input.a.page4.pmdp005"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp005
            #add-point:ON CHANGE pmdp005 name="input.g.page4.pmdp005"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp006
            #add-point:BEFORE FIELD pmdp006 name="input.b.page4.pmdp006"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp006
            
            #add-point:AFTER FIELD pmdp006 name="input.a.page4.pmdp006"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp006
            #add-point:ON CHANGE pmdp006 name="input.g.page4.pmdp006"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp007
            #add-point:BEFORE FIELD pmdp007 name="input.b.page4.pmdp007"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp007
            
            #add-point:AFTER FIELD pmdp007 name="input.a.page4.pmdp007"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp007
            #add-point:ON CHANGE pmdp007 name="input.g.page4.pmdp007"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp008
            #add-point:BEFORE FIELD pmdp008 name="input.b.page4.pmdp008"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp008
            
            #add-point:AFTER FIELD pmdp008 name="input.a.page4.pmdp008"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp008
            #add-point:ON CHANGE pmdp008 name="input.g.page4.pmdp008"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp009
            #add-point:BEFORE FIELD pmdp009 name="input.b.page4.pmdp009"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp009
            
            #add-point:AFTER FIELD pmdp009 name="input.a.page4.pmdp009"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp009
            #add-point:ON CHANGE pmdp009 name="input.g.page4.pmdp009"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp021
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn4_d[l_ac].pmdp021,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdp021
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdp021 name="input.a.page4.pmdp021"
                                    IF NOT cl_null(g_pmdn4_d[l_ac].pmdp021) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdn4_d[l_ac].pmdp021 != g_pmdn4_d_t.pmdp021)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdp_t WHERE "||"pmdpent = '" ||g_enterprise|| "' AND "||"pmdpdocno = '"||g_pmdl_m.pmdldocno ||"' AND "|| "pmdpseq = '"||g_pmdn4_d[l_ac].pmdpseq ||"'",'apm-00298',1) THEN 
                     LET g_pmdn4_d[l_ac].pmdp021 = g_pmdn4_d_t.pmdp021
                     NEXT FIELD CURRENT
                  END IF
               END IF            
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp021
            #add-point:BEFORE FIELD pmdp021 name="input.b.page4.pmdp021"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp021
            #add-point:ON CHANGE pmdp021 name="input.g.page4.pmdp021"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp022
            
            #add-point:AFTER FIELD pmdp022 name="input.a.page4.pmdp022"
                                    INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdn4_d[l_ac].pmdp022
            CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdn4_d[l_ac].pmdp022_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp022_desc

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp022
            #add-point:BEFORE FIELD pmdp022 name="input.b.page4.pmdp022"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp022
            #add-point:ON CHANGE pmdp022 name="input.g.page4.pmdp022"
                        
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp023
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdn4_d[l_ac].pmdp023,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdp023
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdp023 name="input.a.page4.pmdp023"
            IF NOT cl_null(g_pmdn4_d[l_ac].pmdp023) THEN
               IF g_pmdn4_d[l_ac].pmdp023 <> g_pmdn4_d_o.pmdp023 OR cl_null(g_pmdn4_d_o.pmdp023) THEN #160321-00037#1 add
                  IF NOT apmt500_pmdp023_chk(g_pmdn4_d[l_ac].pmdp003,g_pmdn4_d[l_ac].pmdp004,g_pmdn4_d[l_ac].pmdp023,g_pmdn4_d_t.pmdp023) THEN
                     #LET g_pmdn4_d[l_ac].pmdp023 = g_pmdn4_d_t.pmdp023  #160321-00037#1 mark
                     LET g_pmdn4_d[l_ac].pmdp023 = g_pmdn4_d_o.pmdp023   #160321-00037#1 add
                     NEXT FIELD pmdp023
                  END IF
                  
                  #計算折合採購數量
                  SELECT pmdn006,pmdn007 INTO l_pmdn006,l_pmdn007 FROM pmdn_t WHERE pmdnent=g_enterprise 
                      AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                      
                  #160321-00037#1--add---begin----
                  #請采勾稽時，判斷採購的數量 和 容差率的處理
                  CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
                  IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
                     IF cl_ask_confirm('apm-01097') THEN
                        IF l_pmdn006 <> g_pmdn4_d[l_ac].pmdp022 THEN
                           CALL s_aooi250_convert_qty(g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp022,l_pmdn006,g_pmdn4_d[l_ac].pmdp023)
                                  RETURNING l_success,l_pmdp023
                           IF NOT cl_null(l_pmdp023) THEN
                              CALL apmt500_unit_round(l_pmdn006,l_pmdp023) RETURNING l_pmdp023
                           END IF 
                           CALL s_aooi250_convert_qty(g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp022,l_pmdn006,g_pmdn4_d_o.pmdp023)
                                  RETURNING l_success,l_pmdp023_o
                           IF NOT cl_null(l_pmdp023_o) THEN
                              CALL apmt500_unit_round(l_pmdn006,l_pmdp023_o) RETURNING l_pmdp023_o
                           END IF 
                        ELSE
                           LET l_pmdp023 = g_pmdn4_d[l_ac].pmdp023
                           LET l_pmdp023_o = g_pmdn4_d_o.pmdp023
                        END IF
                        
                        LET l_pmdn007 = l_pmdn007 - l_pmdp023_o + l_pmdp023
                        
                        IF NOT cl_null(l_pmdn006) THEN
                           #計算參考數量
                           IF NOT cl_null(l_pmdn008) THEN
                              CALL s_aooi250_convert_qty(g_pmdn4_d[l_ac].pmdp001,l_pmdn006,l_pmdn008,l_pmdn007)
                                     RETURNING l_success,l_pmdn009
                              IF NOT cl_null(l_pmdn009) THEN
                                 CALL apmt500_unit_round(l_pmdn008,l_pmdn009) RETURNING l_pmdn009
                              END IF 
                           END IF
                           
                           #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                           #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                           IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(l_pmdn010)) THEN  #體參數使用採購計價單位
                              CALL s_aooi250_convert_qty(g_pmdn4_d[l_ac].pmdp001,l_pmdn006,l_pmdn010,l_pmdn007)
                                     RETURNING l_success,l_pmdn011
                              IF NOT cl_null(l_pmdn011) THEN
                                 CALL apmt500_unit_round(l_pmdn010,l_pmdn011) RETURNING l_pmdn011
                              END IF
                           ELSE
                              LET l_pmdn010 = l_pmdn006
                              LET l_pmdn011 = l_pmdn007                     
                           END IF
                           
                           #取出價格
                           IF cl_null(l_pmdn010) OR cl_null(l_pmdn011) THEN
                              LET l_pmdn010 = l_pmdn006
                              LET l_pmdn011 = l_pmdn007
                           END IF
                           
                           SELECT pmdn016,pmdn004,pmdn005,pmdn024 INTO l_pmdn016,l_pmdn004,l_pmdn005,l_pmdn024 FROM pmdn_t WHERE pmdnent=g_enterprise 
                              AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                      
                           CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp002,g_pmdl_m.pmdl015,
                                      l_pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                      g_pmdl_m.pmdldocdt,l_pmdn010,l_pmdn011,g_site,g_pmdl_m.pmdl054,g_type,l_pmdn004,l_pmdn005)
                                  RETURNING l_pmdn040,l_pmdn043,l_pmdn041,l_pmdn042
                                  
                           LET l_pmdn044 = 0
                           
                           #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                           CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,g_pmdn4_d[l_ac].pmdpseq,g_pmdl_m.pmdl015,l_pmdn011,l_pmdn043,l_pmdn016)
                                RETURNING l_pmdn046,l_pmdn048,l_pmdn047

                           UPDATE pmdn_t SET pmdn007 = l_pmdn007,
                                             pmdn009 = l_pmdn009,
                                             pmdn010 = l_pmdn010,
                                             pmdn011 = l_pmdn011,
                                             pmdn015 = l_pmdn043,
                                             pmdn040 = l_pmdn040,
                                             pmdn043 = l_pmdn043,
                                             pmdn041 = l_pmdn041,
                                             pmdn042 = l_pmdn042,
                                             pmdn044 = l_pmdn044,
                                             pmdn046 = l_pmdn046,
                                             pmdn048 = l_pmdn048,
                                             pmdn047 = l_pmdn047
                                WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                                             
                           #如果有維護多交期，重新維護價格
                           IF l_pmdn024 = 'Y' THEN
                              CALL apmt500_03(g_pmdl_m.pmdldocno,g_pmdn4_d[l_ac].pmdpseq,l_pmdn007) 
                                RETURNING l_pmdn012,l_pmdn013,l_pmdn014
                              #如果當前筆資料有多筆交期，則更像採購單單身的多交期欄位為'Y'
                              LET l_n = 0
                              SELECT COUNT(1) INTO l_n FROM pmdq_t 
                                 WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno AND pmdqseq = g_pmdn4_d[l_ac].pmdpseq
                              IF l_n > 1 THEN
                                 LET l_pmdn024 = 'Y'
                              ELSE
                                 LET l_pmdn024 = 'N'
                              END IF
                              
                              UPDATE pmdn_t SET pmdn012 = l_pmdn012,
                                                pmdn013 = l_pmdn013,
                                                pmdn014 = l_pmdn014,
                                                pmdn024 = l_pmdn024
                                   WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn4_d[l_ac].pmdpseq
                           ELSE
                              CALL s_apmt500_gen_pmdq(g_pmdl_m.pmdldocno,g_pmdn4_d[l_ac].pmdpseq) RETURNING l_success                           
                           END IF
                           
                           #呼叫"產生採購交期明細資料"的Function產生交期明細資料
                           CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,g_pmdn4_d[l_ac].pmdpseq) RETURNING l_success
                              
                        END IF
                        
                     ELSE
                        LET g_pmdn4_d[l_ac].pmdp023 = g_pmdn4_d_o.pmdp023
                        NEXT FIELD pmdp023
                     END IF
                  END IF
                  #160321-00037#1--add---end----
                  
                  IF l_pmdn006 <> g_pmdn4_d[l_ac].pmdp022 THEN
                     CALL s_aooi250_convert_qty(g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp022,l_pmdn006,g_pmdn4_d[l_ac].pmdp023)
                            RETURNING l_success,g_pmdn4_d[l_ac].pmdp024
                     IF NOT cl_null(g_pmdn4_d[l_ac].pmdp024) THEN
                        CALL apmt500_unit_round(g_pmdn4_d[l_ac].pmdp022,g_pmdn4_d[l_ac].pmdp024) RETURNING g_pmdn4_d[l_ac].pmdp024
                     END IF 
                  ELSE
                     LET g_pmdn4_d[l_ac].pmdp024 = g_pmdn4_d[l_ac].pmdp023
                  END IF
                          
                  DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp024 
               END IF   #160321-00037#1 add               
            END IF 
            LET g_pmdn4_d_o.pmdp023 = g_pmdn4_d[l_ac].pmdp023  #160321-00037#1 add   
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp023
            #add-point:BEFORE FIELD pmdp023 name="input.b.page4.pmdp023"
                        
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp023
            #add-point:ON CHANGE pmdp023 name="input.g.page4.pmdp023"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp024
            #add-point:BEFORE FIELD pmdp024 name="input.b.page4.pmdp024"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp024
            
            #add-point:AFTER FIELD pmdp024 name="input.a.page4.pmdp024"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp024
            #add-point:ON CHANGE pmdp024 name="input.g.page4.pmdp024"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp025
            #add-point:BEFORE FIELD pmdp025 name="input.b.page4.pmdp025"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp025
            
            #add-point:AFTER FIELD pmdp025 name="input.a.page4.pmdp025"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp025
            #add-point:ON CHANGE pmdp025 name="input.g.page4.pmdp025"
                        
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdp026
            #add-point:BEFORE FIELD pmdp026 name="input.b.page4.pmdp026"
                        
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdp026
            
            #add-point:AFTER FIELD pmdp026 name="input.a.page4.pmdp026"
                        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdp026
            #add-point:ON CHANGE pmdp026 name="input.g.page4.pmdp026"
                        
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page4.pmdpsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdpsite
            #add-point:ON ACTION controlp INFIELD pmdpsite name="input.c.page4.pmdpsite"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdpseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdpseq
            #add-point:ON ACTION controlp INFIELD pmdpseq name="input.c.page4.pmdpseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdpseq1
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdpseq1
            #add-point:ON ACTION controlp INFIELD pmdpseq1 name="input.c.page4.pmdpseq1"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp001
            #add-point:ON ACTION controlp INFIELD pmdp001 name="input.c.page4.pmdp001"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp002
            #add-point:ON ACTION controlp INFIELD pmdp002 name="input.c.page4.pmdp002"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp003
            #add-point:ON ACTION controlp INFIELD pmdp003 name="input.c.page4.pmdp003"
                        #此段落由子樣板a07產生            
            #開窗i段
            LET l_success = TRUE
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn4_d[l_ac].pmdp003             #給予default值
            LET g_qryparam.where = " 1=1 "
            
            #給予arg

            CASE g_pmdl_m.pmdl007
               WHEN '2'  #請購單 
                  #ming 20150823 add --------------------------------------------(S) 
                  LET g_qryparam.where = "pmdastus = 'Y' ",
                                         " AND pmdadocno IN (SELECT DISTINCT pmdbdocno ",
                                         "                     FROM pmdb_t ",
                                         "                    WHERE pmdbent = '",g_enterprise,"' ",
                                         "                      AND pmdbsite = '",g_site,"' ",
                                         "                      AND pmdb032 = '1' ",     
                                         "                      AND pmdb049 < pmdb006) "
                  #ming 20150823 add --------------------------------------------(E) 
                  
                  #150909 earl mod s
                  #組合過濾前後置單據資料SQL
                  CALL s_aooi210_get_check_sql(g_site,'',g_pmdl_m.pmdldocno,'4','','pmdadocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = g_qryparam.where," AND ",l_where
                     CALL q_pmdadocno() 
                  END IF
                  #150909 earl mod e

              #WHEN '3'  #訂單
               WHEN '4'  #工單
                  IF g_pmdl_m.pmdl006 = '8' THEN
                     LET g_qryparam.where = " sfaa003 = '6' "   #協作工單
                  END IF
                   
                  #150909 earl mod s
                  #組合過濾前後置單據資料SQL
                  CALL s_aooi210_get_check_sql(g_site,'',g_pmdl_m.pmdldocno,'4','','sfcbdocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = g_qryparam.where," AND ",l_where
                     CALL q_sfcbdocno_3()
                  END IF
                  #150909 earl mod e
                  
              #WHEN '5'  #MRP
            END CASE 
            
            #150909 earl mod s
            IF l_success THEN
               LET g_qryparam.where = " "
               LET g_pmdn4_d[l_ac].pmdp003 = g_qryparam.return1              #將開窗取得的值回傳到變數

               DISPLAY g_pmdn4_d[l_ac].pmdp003 TO pmdp003              #顯示到畫面上
            END IF

            NEXT FIELD pmdp003                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp004
            #add-point:ON ACTION controlp INFIELD pmdp004 name="input.c.page4.pmdp004"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp005
            #add-point:ON ACTION controlp INFIELD pmdp005 name="input.c.page4.pmdp005"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp006
            #add-point:ON ACTION controlp INFIELD pmdp006 name="input.c.page4.pmdp006"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp007
            #add-point:ON ACTION controlp INFIELD pmdp007 name="input.c.page4.pmdp007"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp008
            #add-point:ON ACTION controlp INFIELD pmdp008 name="input.c.page4.pmdp008"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp009
            #add-point:ON ACTION controlp INFIELD pmdp009 name="input.c.page4.pmdp009"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp021
            #add-point:ON ACTION controlp INFIELD pmdp021 name="input.c.page4.pmdp021"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp022
            #add-point:ON ACTION controlp INFIELD pmdp022 name="input.c.page4.pmdp022"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp023
            #add-point:ON ACTION controlp INFIELD pmdp023 name="input.c.page4.pmdp023"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp024
            #add-point:ON ACTION controlp INFIELD pmdp024 name="input.c.page4.pmdp024"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp025
            #add-point:ON ACTION controlp INFIELD pmdp025 name="input.c.page4.pmdp025"
                        
            #END add-point
 
 
         #Ctrlp:input.c.page4.pmdp026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdp026
            #add-point:ON ACTION controlp INFIELD pmdp026 name="input.c.page4.pmdp026"
                        
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page4 after_row name="input.body4.after_row"
                        
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_pmdn4_d[l_ac].* = g_pmdn4_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt500_bcl3
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL apmt500_unlock_b("pmdp_t","'4'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page4 after_row2 name="input.body4.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body4.after_input"
                        
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_pmdn4_d[li_reproduce_target].* = g_pmdn4_d[li_reproduce].*
 
               LET g_pmdn4_d[li_reproduce_target].pmdpseq = NULL
               LET g_pmdn4_d[li_reproduce_target].pmdpseq1 = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_pmdn4_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_pmdn4_d.getLength()+1
            END IF
            
      END INPUT
 
      
 
      DISPLAY ARRAY g_pmdn3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt500_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            LET g_detail_idx = l_ac
            
            #add-point:page3, before row動作 name="input.body3.before_row"
                        
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'4',"))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            CALL apmt500_idx_chk()
            LET g_current_page = 3
      
         #add-point:page3自定義行為 name="input.body3.action"
                  
         #end add-point
      
      END DISPLAY
      DISPLAY ARRAY g_pmdn6_d TO s_detail6.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt500_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail6")
            LET g_detail_idx = l_ac
            
            #add-point:page5, before row動作 name="input.body6.before_row"
                        
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue(""))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail6")
            CALL apmt500_idx_chk()
            LET g_current_page = 5
      
         #add-point:page5自定義行為 name="input.body6.action"
                  
         #end add-point
      
      END DISPLAY
 
 
 
{</section>}
 
{<section id="apmt500.input.other" >}
      
      #add-point:自定義input name="input.more_input"
      #AFTER DIALOG
         #LET g_field = DIALOG.getCurrentItem()  

      SUBDIALOG aoo_aooi360_01.aooi360_01_input   #备注单身  #161031-00025#1
      #end add-point
    
      BEFORE DIALOG 
         #CALL cl_err_collect_init()    
         #add-point:input段before dialog name="input.before_dialog"
         IF g_flag2 THEN
            LET g_flag2 = FALSE
            NEXT FIELD pmdn001
         END IF 
         
         #161031-00025#1---s
         #為了修改功能doubleClick可以直接進入單身, 需指定要進入哪一個單身
         IF NOT cl_null(p_cmd) AND p_cmd != 'a' THEN
            CASE g_aw
               WHEN "s_detail1_aooi360_01"
                  NEXT FIELD ooff012     
            END CASE
         END IF
         #161031-00025#1---e
         #end add-point    
         #重新導回資料到正確位置上
         CALL DIALOG.setCurrentRow("s_detail1",g_idx_group.getValue("'1','2',"))      
         CALL DIALOG.setCurrentRow("s_detail2",g_idx_group.getValue("'3',"))
         CALL DIALOG.setCurrentRow("s_detail3",g_idx_group.getValue("'4',"))
         CALL DIALOG.setCurrentRow("s_detail4",g_idx_group.getValue("'5',"))
         CALL DIALOG.setCurrentRow("s_detail6",g_idx_group.getValue(""))
 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            #add-point:input段next_field name="input.next_field"
            
            #end add-point  
            NEXT FIELD pmdldocno
         ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD pmdnsite
               WHEN "s_detail2"
                  NEXT FIELD pmdnseq_2
               WHEN "s_detail3"
                  NEXT FIELD pmdosite
               WHEN "s_detail4"
                  NEXT FIELD pmdpsite
               WHEN "s_detail6"
                  NEXT FIELD pmdmsite
 
               #add-point:input段modify_detail  name="input.modify_detail.other"
               
               #end add-point  
            END CASE
         END IF
      
      AFTER DIALOG
         #add-point:input段after_dialog name="input.after_dialog"
         
         #end add-point    
         
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept  name="input.accept"
         LET g_field = DIALOG.getCurrentItem()
         #160804-00055#1--s 
         #若是停在单头的单号、日期、供应商等固定区域的栏位，则给到第一个页签的第一个栏位上
         IF g_field = "pmdldocno" OR g_field = "pmdldocdt" OR g_field = "pmdl004" OR g_field = "pmdl002" OR g_field = "pmdl003" THEN
            LET g_field = "pmdl005"
         END IF
         #160804-00055#1--e         
         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         #add-point:input段cancel name="input.cancel"
         #ming 20150903 add -----------------------(S)  
         #科目預算  
         IF l_insert1 THEN
            CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
                 RETURNING l_success,l_slip
            IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
               IF cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
                  NEXT FIELD pmdn058
               END IF
            END IF
         END IF
         #ming 20150903 add -----------------------(E)  
         #160804-00055#1--s 
         LET g_field = DIALOG.getCurrentItem()
         #若是停在单头的单号、日期、供应商等固定区域的栏位，则给到第一个页签的第一个栏位上
         IF g_field = "pmdldocno" OR g_field = "pmdldocdt" OR g_field = "pmdl004" OR g_field = "pmdl002" OR g_field = "pmdl003" THEN
            LET g_field = "pmdl005"
         END IF
         #160804-00055#1--e 
         #end add-point  
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
         LET g_detail_idx_list[5] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
         CALL g_curr_diag.setCurrentRow("s_detail4",1)
         CALL g_curr_diag.setCurrentRow("s_detail6",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         #add-point:input段close name="input.close"
                  #ming 20150903 add ----------------------(S)  
         #科目預算 
         IF l_insert1 THEN
            CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
                 RETURNING l_success,l_slip
            IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
               IF cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
                  NEXT FIELD pmdn058
               END IF
            END IF
         END IF
         #ming 20150903 add ----------------------(E)  
         #end add-point  
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         #add-point:input段exit name="input.exit"
         #ming 20150903 add ---------------------(S)  
         #科目預算 
         IF l_insert1 THEN
            CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
                 RETURNING l_success,l_slip
            IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
               IF cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
                  NEXT FIELD pmdn058
               END IF
            END IF
         END IF
         #ming 20150903 add ---------------------(E)  
         #end add-point
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
         LET g_detail_idx_list[5] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
         CALL g_curr_diag.setCurrentRow("s_detail4",1)
         CALL g_curr_diag.setCurrentRow("s_detail6",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   #add-point:input段after input  name="input.after_input"
   #160805-00071#1--s
   #資料來源類型：新增時，僅顯示"1.無","8.預先採購單"二個選項，查詢、顯示時，才全部顯示
   CALL cl_set_combo_scc('pmdl007','2054')
   #160805-00071#1--e
   
   IF g_flag2 THEN
      CALL apmt500_input('u')
   END IF
   
   #重新計算整單的未稅、含稅總金額
   IF NOT cl_null(g_pmdl_m.pmdldocno) THEN
      #170113-00021#1---s
      #以下規則將不在呼叫 s_tax_recount 此函式重新計算金額
      #1.單身有不同稅別時
      #2.稅別有運用公式時(aooi610 公式編號不為空)
      LET l_count_1 = 0
      SELECT COUNT(UNIQUE pmdn016) INTO l_count_1 FROM pmdn_t
        WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
      LET l_cnt = 0
      SELECT COUNT(oodb002) INTO l_cnt FROM oodb_t,pmdn_t,ooef_t
        WHERE ooefent = oodbent AND ooef001 = g_site AND ooef019 = oodb001
          AND oodbent = g_enterprise AND oodb002 = pmdn016
          AND pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
          AND oodb007 IS NOT NULL
      IF l_count_1 > 1 OR l_cnt > 0 THEN
         SELECT SUM(pmdn046),SUM(pmdn047),SUM(pmdn048) INTO g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042
            FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
         IF cl_null(g_pmdl_m.pmdl040) THEN LET g_pmdl_m.pmdl040 = 0 END IF
         IF cl_null(g_pmdl_m.pmdl041) THEN LET g_pmdl_m.pmdl041 = 0 END IF
         IF cl_null(g_pmdl_m.pmdl042) THEN LET g_pmdl_m.pmdl042 = 0 END IF
      ELSE
      #170113-00021#1---e
        CALL s_tax_recount_tmp()  #161212-00022#1 add
        CALL s_transaction_begin()
       #CALL s_tax_recount_tmp()  #161212-00022#1 mark
        CALL s_tax_recount(g_pmdl_m.pmdldocno)
          RETURNING g_pmdl_m.pmdl040,g_pmdl_m.pmdl042,g_pmdl_m.pmdl041,l_xrcd113,l_xrcd114,l_xrcd115
      END IF   #170113-00021#1
      
      DISPLAY BY NAME g_pmdl_m.pmdl040,g_pmdl_m.pmdl042,g_pmdl_m.pmdl041
      UPDATE pmdl_t SET pmdl040 = g_pmdl_m.pmdl040,
                        pmdl042 = g_pmdl_m.pmdl042,
                        pmdl041 = g_pmdl_m.pmdl041
          WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
      
      #161128-00011#1---s      
      #CALL apmt500_adjust_pmdn(g_pmdl_m.pmdl040,g_pmdl_m.pmdl042,g_pmdl_m.pmdl041)  #160908-00010#1  
      #IF SQLCA.sqlcode THEN
      IF NOT s_apmt500_adjust_pmdn(g_pmdl_m.pmdldocno,g_pmdl_m.pmdl040,g_pmdl_m.pmdl042,g_pmdl_m.pmdl041) THEN
         CALL s_transaction_end('N','0')
      ELSE
         CALL s_transaction_end('Y','0')
      END IF
      #161128-00011#1---e
   END IF
   
   
   
   #CALL apmt500_b_fill()
   CALL apmt500_show()
   
   #end add-point    
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.show" >}
#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION apmt500_show()
   #add-point:show段define(客製用) name="show.define_customerization"
   
   #end add-point  
   DEFINE l_ac_t    LIKE type_t.num10
   #add-point:show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show.define"
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_ooba002   LIKE ooba_t.ooba002
   #end add-point  
   
   #add-point:Function前置處理 name="show.before"
      
   #end add-point
   
   
   
   IF g_bfill = "Y" THEN
      CALL apmt500_b_fill() #單身填充
      CALL apmt500_b_fill2('0') #單身填充
   END IF
     
   #帶出公用欄位reference值
   #應用 a12 樣板自動產生(Version:4)
 
 
 
   
   #顯示followup圖示
   #應用 a48 樣板自動產生(Version:3)
   CALL apmt500_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:show段reference name="show.head.reference"
   #161207-00033#27-S
   IF NOT cl_null(g_pmdl_m.pmdl028) THEN
      CALL s_desc_get_oneturn_guest_desc(g_pmdl_m.pmdl028) RETURNING g_pmdl_m.pmdl004_desc
      IF g_pmdl_m.pmdl021 = g_pmdl_m.pmdl004 THEN
         LET g_pmdl_m.pmdl021_desc = g_pmdl_m.pmdl004_desc
      END IF
      IF g_pmdl_m.pmdl022 = g_pmdl_m.pmdl004 THEN
         LET g_pmdl_m.pmdl022_desc = g_pmdl_m.pmdl004_desc
      END IF    
      IF g_pmdl_m.pmdl032 = g_pmdl_m.pmdl004 THEN
         LET g_pmdl_m.pmdl032_desc = g_pmdl_m.pmdl004_desc
      END IF 
      IF g_pmdl_m.pmdl052 = g_pmdl_m.pmdl004 THEN
         LET g_pmdl_m.pmdl052_desc = g_pmdl_m.pmdl004_desc
      END IF       
   END IF   
   #161207-00033#27-E
            
            #CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
            IF NOT cl_null(g_pmdl_m.pmdldocno) THEN
               CALL s_aooi200_get_slip_desc(g_pmdl_m.pmdldocno) RETURNING g_pmdl_m.pmdldocno_desc
               DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
            END IF
            
            #20150505 modify by lixiang 150504-00013#4--remark---
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl004) RETURNING g_pmdl_m.pmdl004_desc
            DISPLAY BY NAME g_pmdl_m.pmdl004_desc
            #20150505 modify by lixiang 150504-00013#4--remark--
            
            #CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl002_desc
            
            #CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl003_desc 
            
            CALL apmt500_pmdl027_ref(g_pmdl_m.pmdl004,g_pmdl_m.pmdl027) RETURNING g_pmdl_m.pmdl027_desc
            DISPLAY BY NAME g_pmdl_m.pmdl027_desc
            
            #CALL apmt500_pmdl009_ref(g_pmdl_m.pmdl009) RETURNING g_pmdl_m.pmdl009_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl009_desc
            
            #CALL apmt500_pmdl010_ref(g_pmdl_m.pmdl010) RETURNING g_pmdl_m.pmdl010_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl010_desc
            
            CALL apmt500_pmdl011_ref(g_pmdl_m.pmdl011) RETURNING g_pmdl_m.pmdl011_desc
            DISPLAY BY NAME g_pmdl_m.pmdl011_desc
            
            #CALL apmt500_pmdl015_ref(g_pmdl_m.pmdl015) RETURNING g_pmdl_m.pmdl015_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl015_desc
            
            #CALL apmt500_pmdl017_ref(g_pmdl_m.pmdl017) RETURNING g_pmdl_m.pmdl017_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl017_desc
            
            #CALL apmt500_pmdl018_ref(g_pmdl_m.pmdl018) RETURNING g_pmdl_m.pmdl018_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl018_desc
            
            #CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl020_desc
            
            CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
            DISPLAY BY NAME g_pmdl_m.pmdl025_desc
            
            CALL apmt500_pmdl026_ref(g_pmdl_m.pmdl026) RETURNING g_pmdl_m.pmdl026_desc
            DISPLAY BY NAME g_pmdl_m.pmdl026_desc
            
            #呼叫地址組合應用元件
            IF NOT cl_null(g_pmdl_m.pmdl025) THEN
               CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl025,g_lang) RETURNING l_success,g_pmdl_m.oofb017
            END IF
            IF NOT cl_null(g_pmdl_m.pmdl026) THEN
               CALL s_aooi350_get_address(g_oofa001,g_pmdl_m.pmdl026,g_lang) RETURNING l_success,g_pmdl_m.oofb017_1
            END IF
            
            DISPLAY BY NAME g_pmdl_m.oofb017,g_pmdl_m.oofb017_1
      
            
            #CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl029) RETURNING g_pmdl_m.pmdl029_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl029_desc 
            
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
            DISPLAY BY NAME g_pmdl_m.pmdl021_desc 
            
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
            DISPLAY BY NAME g_pmdl_m.pmdl022_desc 
            
            CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl032) RETURNING g_pmdl_m.pmdl032_desc
            DISPLAY BY NAME g_pmdl_m.pmdl032_desc 
            
            #CALL apmt500_pmdl023_ref(g_pmdl_m.pmdl023) RETURNING g_pmdl_m.pmdl023_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl023_desc
            
            #CALL apmt500_pmdl024_ref(g_pmdl_m.pmdl024) RETURNING g_pmdl_m.pmdl024_desc
            #DISPLAY BY NAME g_pmdl_m.pmdl024_desc
            
            CALL apmt500_pmdl033_ref(g_pmdl_m.pmdl033) RETURNING g_pmdl_m.pmdl033_desc
            DISPLAY BY NAME g_pmdl_m.pmdl033_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdlownid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdlownid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdlownid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdlowndp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdlowndp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdlowndp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdlcrtid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdlcrtid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdlcrtid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdlcrtdp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdlcrtdp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdlcrtdp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdlmodid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdlmodid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdlmodid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdl_m.pmdlcnfid
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_pmdl_m.pmdlcnfid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdl_m.pmdlcnfid_desc

   #end add-point
   
   #遮罩相關處理
   LET g_pmdl_m_mask_o.* =  g_pmdl_m.*
   CALL apmt500_pmdl_t_mask()
   LET g_pmdl_m_mask_n.* =  g_pmdl_m.*
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004, 
       g_pmdl_m.pmdl004_desc,g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc, 
       g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008, 
       g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc,g_pmdl_m.pmdl052,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl053, 
       g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010,g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011, 
       g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc, 
       g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl017_desc, 
       g_pmdl_m.pmdl018,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc, 
       g_pmdl_m.pmdl043,g_pmdl_m.pmdl043_desc,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl051_desc, 
       g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.oofb017, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.oofb017_1,g_pmdl_m.pmdl029,g_pmdl_m.pmdl029_desc, 
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022,g_pmdl_m.pmdl022_desc,g_pmdl_m.pmdl032, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048, 
       g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.fflabel_1,g_pmdl_m.pmdl040,g_pmdl_m.fflabel_2, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlowndp_desc, 
       g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlcrtdt, 
       g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfid_desc, 
       g_pmdl_m.pmdlcnfdt
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmdl_m.pmdlstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "H"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/hold.png")
         WHEN "C"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/closed.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "UH"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unhold.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
 
 
 
   
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_pmdn_d.getLength()
      #add-point:show段單身reference name="show.body.reference"
            #CALL apmt500_pmdn001_ref(g_pmdn_d[l_ac].pmdn001) RETURNING g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
            #
            #CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002_desc
            
            #CALL apmt500_pmdn004_ref(g_pmdn_d[l_ac].pmdn004) RETURNING g_pmdn_d[l_ac].pmdn004_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn004_desc
            #
            #CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn006) RETURNING g_pmdn_d[l_ac].pmdn006_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn006_desc
            #
            #CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn008) RETURNING g_pmdn_d[l_ac].pmdn008_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn008_desc
            #
            #CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn010) RETURNING g_pmdn_d[l_ac].pmdn010_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn010_desc

            #CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc

            CALL apmt500_pmdl004_ref(g_pmdn_d[l_ac].pmdn023) RETURNING g_pmdn_d[l_ac].pmdn023_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn023_desc
            
            #CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn_d[l_ac].pmdnunit_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdnunit_desc
            #
            #CALL apmt500_pmdl003_ref(g_pmdn_d[l_ac].pmdnorga) RETURNING g_pmdn_d[l_ac].pmdnorga_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdnorga_desc
            
            
            #CALL apmt500_pmdn049_ref(g_pmdn_d[l_ac].pmdn049) RETURNING g_pmdn_d[l_ac].pmdn049_desc
            #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn049_desc
            #
            #IF g_pmdl_m.pmdlstus = 'H' THEN  #留置狀態下，顯示留置理由碼說明
            #   CALL s_desc_get_acc_desc('317',g_pmdn_d[l_ac].pmdn051) RETURNING g_pmdn_d[l_ac].pmdn051_desc
            #   DISPLAY BY NAME g_pmdn_d[l_ac].pmdn051_desc
            #ELSE
            #   CALL s_desc_get_acc_desc('258',g_pmdn_d[l_ac].pmdn051) RETURNING g_pmdn_d[l_ac].pmdn051_desc
            #   DISPLAY BY NAME g_pmdn_d[l_ac].pmdn051_desc
            #END IF
            #
            #CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
            #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
            #
            #CALL apmt500_pmdn029_ref(g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029) RETURNING g_pmdn2_d[l_ac].pmdn029_desc
            #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn029_desc

      #end add-point
   END FOR
   
   FOR l_ac = 1 TO g_pmdn2_d.getLength()
      #add-point:show段單身reference name="show.body2.reference"
      LET g_pmdn2_d[l_ac].pmdnseq = g_pmdn_d[l_ac].pmdnseq
      LET g_pmdn2_d[l_ac].imaa001 = g_pmdn_d[l_ac].pmdn001
      LET g_pmdn2_d[l_ac].imaal003 = g_pmdn_d[l_ac].pmdn001_desc
      LET g_pmdn2_d[l_ac].imaal004 = g_pmdn_d[l_ac].imaal004
      LET g_pmdn2_d[l_ac].imaa005 = g_pmdn_d[l_ac].pmdn002
      LET g_pmdn2_d[l_ac].imaa005_1_desc = g_pmdn_d[l_ac].pmdn002_desc
      
      #CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
      #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
      #
      #CALL apmt500_pmdn029_ref(g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029) RETURNING g_pmdn2_d[l_ac].pmdn029_desc
      #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn029_desc
      
      CALL apmt500_pmdl025_ref(g_pmdn2_d[l_ac].pmdn025) RETURNING g_pmdn2_d[l_ac].pmdn025_desc
      DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn025_desc
      
      CALL apmt500_pmdl026_ref(g_pmdn2_d[l_ac].pmdn026) RETURNING g_pmdn2_d[l_ac].pmdn026_desc
      DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn026_desc
      
      #CALL apmt500_pmdl020_ref(g_pmdn2_d[l_ac].pmdn031) RETURNING g_pmdn2_d[l_ac].pmdn031_desc
      #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn031_desc
      #
      #CALL apmt500_pmdn003_ref(g_pmdn2_d[l_ac].pmdn003) RETURNING g_pmdn2_d[l_ac].pmdn003_desc
      #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn003_desc
      
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdn3_d.getLength()
      #add-point:show段單身reference name="show.body3.reference"

      CALL apmt500_pmdn001_ref(g_pmdn3_d[l_ac].pmdo001) RETURNING g_pmdn3_d[l_ac].pmdo001_desc,g_pmdn3_d[l_ac].imaal004
      DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo001_desc,g_pmdn3_d[l_ac].imaal004
      
      #CALL apmt500_unit_ref(g_pmdn3_d[l_ac].pmdo004) RETURNING g_pmdn3_d[l_ac].pmdo004_desc
      #DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo004_desc
      #
      #CALL apmt500_unit_ref(g_pmdn3_d[l_ac].pmdo028) RETURNING g_pmdn3_d[l_ac].pmdo028_desc
      #DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo028_desc
      #
      #INITIALIZE g_ref_fields TO NULL
      #LET g_ref_fields[1] = g_pmdn3_d[l_ac].pmdo010
      #CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='274' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      #LET g_pmdn3_d[l_ac].pmdo010_desc = '', g_rtn_fields[1] , ''
      #DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo010_desc
      #
      #CALL apmt500_unit_ref(g_pmdn3_d[l_ac].pmdo030) RETURNING g_pmdn3_d[l_ac].pmdo030_desc
      #DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo030_desc
      
      CALL apmt500_pmdl011_ref(g_pmdn3_d[l_ac].pmdo023) RETURNING g_pmdn3_d[l_ac].pmdo023_desc
      DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo023_desc
      
      #INITIALIZE g_ref_fields TO NULL
      #LET g_ref_fields[1] = g_pmdn3_d[l_ac].pmdo026
      #CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      #LET g_pmdn3_d[l_ac].pmdo026_desc = '', g_rtn_fields[1] , ''
      #DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo026_desc
      
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdn4_d.getLength()
      #add-point:show段單身reference name="show.body4.reference"

      CALL apmt500_pmdn001_ref(g_pmdn4_d[l_ac].pmdp001) RETURNING g_pmdn4_d[l_ac].pmdp001_desc,g_pmdn4_d[l_ac].imaal004
      DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp001_desc,g_pmdn4_d[l_ac].imaal004
      
      #CALL apmt500_unit_ref(g_pmdn4_d[l_ac].pmdp022) RETURNING g_pmdn4_d[l_ac].pmdp022_desc
      #DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp022_desc

      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdn6_d.getLength()
      #add-point:show段單身reference name="show.body6.reference"
      #INITIALIZE g_ref_fields TO NULL
      #LET g_ref_fields[1] = g_pmdn6_d[l_ac].pmdm002
      #CALL ap_ref_array2(g_ref_fields,"SELECT ooibl004 FROM ooibl_t WHERE ooiblent='"||g_enterprise||"' AND ooibl002=? AND ooibl003='"||g_dlang||"'","") RETURNING g_rtn_fields
      #LET g_pmdn6_d[l_ac].pmdm002_desc = '', g_rtn_fields[1] , ''
      #DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm002_desc

      #end add-point
   END FOR
 
   
    
   
   #add-point:show段other name="show.other"
   #160907-00053#1  add  --begin--
   #防止数组最后会莫名多出来空白行   
   WHILE TRUE
      IF g_pmdn_d.getLength() > 0 THEN
         IF cl_null(g_pmdn_d[g_pmdn_d.getLength()].pmdnseq) THEN
            CALL g_pmdn_d.deleteElement(g_pmdn_d.getLength())
         ELSE
            EXIT WHILE
         END IF
      ELSE
         EXIT WHILE
      END IF
   END WHILE
   #160907-00053#1  add  --end--   
   #end add-point  
   
   LET l_ac = l_ac_t
   
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()     
 
   CALL apmt500_detail_show()
 
   #add-point:show段之後 name="show.after"
      
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.detail_show" >}
#+ 第二階單身reference
PRIVATE FUNCTION apmt500_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point  
   #add-point:detail_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
      
   #end add-point  
   
   #add-point:Function前置處理 name="detail_show.before"
      
   #end add-point
   
   #add-point:detail_show段之後 name="detail_show.after"
      
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.reproduce" >}
#+ 資料複製
PRIVATE FUNCTION apmt500_reproduce()
   #add-point:reproduce段define(客製用) name="reproduce.define_customerization"
   
   #end add-point   
   DEFINE l_newno     LIKE pmdl_t.pmdldocno 
   DEFINE l_oldno     LIKE pmdl_t.pmdldocno 
 
   DEFINE l_master    RECORD LIKE pmdl_t.* #此變數樣板目前無使用
   DEFINE l_detail    RECORD LIKE pmdn_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE pmdo_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE pmdp_t.* #此變數樣板目前無使用
 
   DEFINE l_detail4    RECORD LIKE pmdm_t.* #此變數樣板目前無使用
 
 
 
   DEFINE l_cnt       LIKE type_t.num10
   #add-point:reproduce段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="reproduce.define"
      
   #end add-point   
   
   #add-point:Function前置處理  name="reproduce.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET g_master_insert = FALSE
   
   IF g_pmdl_m.pmdldocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
    
   LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
    
   LET g_pmdl_m.pmdldocno = ""
 
 
   CALL cl_set_head_visible("","YES")
 
   #公用欄位給予預設值
   #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_pmdl_m.pmdlownid = g_user
      LET g_pmdl_m.pmdlowndp = g_dept
      LET g_pmdl_m.pmdlcrtid = g_user
      LET g_pmdl_m.pmdlcrtdp = g_dept 
      LET g_pmdl_m.pmdlcrtdt = cl_get_current()
      LET g_pmdl_m.pmdlmodid = g_user
      LET g_pmdl_m.pmdlmoddt = cl_get_current()
      LET g_pmdl_m.pmdlstus = 'N'
 
 
 
   
   CALL s_transaction_begin()
   
   #add-point:複製輸入前 name="reproduce.head.b_input"
   #160225-00021#1---add-begin----
   LET g_pmdl_m.pmdl047 = "N"
   LET g_pmdl_m.pmdl048 = "N"
   LET g_pmdl_m.pmdl049 = "N"  
   #160225-00021#1---add-end----   
   #end add-point
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmdl_m.pmdlstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "H"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/hold.png")
         WHEN "C"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/closed.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "UH"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unhold.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
 
 
 
   
   #清空key欄位的desc
      LET g_pmdl_m.pmdldocno_desc = ''
   DISPLAY BY NAME g_pmdl_m.pmdldocno_desc
 
   
   CALL apmt500_input("r")
   
   IF INT_FLAG AND NOT g_master_insert THEN
      LET INT_FLAG = 0
      DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
      DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
      LET INT_FLAG = 0
      INITIALIZE g_pmdl_m.* TO NULL
      INITIALIZE g_pmdn_d TO NULL
      INITIALIZE g_pmdn2_d TO NULL
      INITIALIZE g_pmdn3_d TO NULL
      INITIALIZE g_pmdn4_d TO NULL
      INITIALIZE g_pmdn6_d TO NULL
 
      #add-point:複製取消後 name="reproduce.cancel"
      
      #end add-point
      CALL apmt500_show()
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = '' 
      LET g_errparam.code = 9001 
      LET g_errparam.popup = FALSE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt500_set_act_visible()   
   CALL apmt500_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " pmdlent = " ||g_enterprise|| " AND",
                      " pmdldocno = '", g_pmdl_m.pmdldocno, "' "
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL apmt500_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   #add-point:完成複製段落後 name="reproduce.after_reproduce"
      
   #end add-point
   
   CALL apmt500_idx_chk()
   
   LET g_data_owner = g_pmdl_m.pmdlownid      
   LET g_data_dept  = g_pmdl_m.pmdlowndp
   
   #功能已完成,通報訊息中心
   CALL apmt500_msgcentre_notify('reproduce')
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.detail_reproduce" >}
#+ 單身自動複製
PRIVATE FUNCTION apmt500_detail_reproduce()
   #add-point:delete段define(客製用) name="detail_reproduce.define_customerization"
   
   #end add-point    
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE pmdn_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE pmdo_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE pmdp_t.* #此變數樣板目前無使用
 
   DEFINE l_detail4    RECORD LIKE pmdm_t.* #此變數樣板目前無使用
 
 
 
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_reproduce.define"
      
   #end add-point    
   
   #add-point:Function前置處理  name="detail_reproduce.pre_function"
   
   #end add-point
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE apmt500_detail
   
   #add-point:單身複製前1 name="detail_reproduce.body.table1.b_insert"
      
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdn_t
    WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdldocno_t
 
    INTO TEMP apmt500_detail
 
   #將key修正為調整後   
   UPDATE apmt500_detail 
      #更新key欄位
      SET pmdndocno = g_pmdl_m.pmdldocno
 
      #更新共用欄位
      
 
   #add-point:單身修改前 name="detail_reproduce.body.table1.b_update"
   
   #end add-point                                       
  
   #將資料塞回原table   
   INSERT INTO pmdn_t SELECT * FROM apmt500_detail
   
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "reproduce:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #add-point:單身複製中1 name="detail_reproduce.body.table1.m_insert"
   UPDATE pmdn_t SET pmdn045 = '1' WHERE pmdnent = g_enterprise AND pmdndocno =  g_pmdl_m.pmdldocno   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt500_detail
   
   #add-point:單身複製後1 name="detail_reproduce.body.table1.a_insert"
      
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table2.b_insert"
      
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdo_t 
    WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdldocno_t
 
    INTO TEMP apmt500_detail
 
   #將key修正為調整後   
   UPDATE apmt500_detail SET pmdodocno = g_pmdl_m.pmdldocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table2.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdo_t SELECT * FROM apmt500_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table2.m_insert"
   UPDATE pmdo_t SET pmdo015 = 0,pmdo016 = 0,pmdo017 = 0,pmdo019 = 0,pmdo020 = 0,pmdo021 = '2',pmdo026 = '',pmdo027 = '',pmdo040 = 0  #160225-00021#1 add pmdo040
       WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno
       
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt500_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table2.a_insert"
      
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table3.b_insert"
      
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdp_t 
    WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdldocno_t
 
    INTO TEMP apmt500_detail
 
   #將key修正為調整後   
   UPDATE apmt500_detail SET pmdpdocno = g_pmdl_m.pmdldocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table3.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdp_t SELECT * FROM apmt500_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table3.m_insert"
      
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt500_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table3.a_insert"
      
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table4.b_insert"
      
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdm_t 
    WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdldocno_t
 
    INTO TEMP apmt500_detail
 
   #將key修正為調整後   
   UPDATE apmt500_detail SET pmdmdocno = g_pmdl_m.pmdldocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table4.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdm_t SELECT * FROM apmt500_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table4.m_insert"
   #更新多期賬款中的應付單號等欄位
   UPDATE pmdm_t SET pmdm007 = '' , pmdm008 = 0 , pmdm009 = 0 , pmdm010 = 0 , pmdm011 = 0 , pmdm012 = 0 , pmdm013 = 0
      WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
  

   DROP TABLE apmt500_detail
   
   #CREATE TEMP TABLE
   LET ls_sql = 
      "CREATE GLOBAL TEMPORARY TABLE apmt500_detail AS ",
      "SELECT * FROM pmdq_t "
   PREPARE repro_tbl5 FROM ls_sql
   EXECUTE repro_tbl5
   FREE repro_tbl5
      
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO apmt500_detail SELECT * FROM pmdq_t
                                         WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdldocno_t
 
   #將key修正為調整後   
   UPDATE apmt500_detail SET pmdqdocno = g_pmdl_m.pmdldocno
   #將資料塞回原table   
   INSERT INTO pmdq_t SELECT * FROM apmt500_detail   
   
   
   #複製單身的金額檔xrcd_t
   DROP TABLE apmt500_detail
   
   #CREATE TEMP TABLE
   LET ls_sql = 
      "CREATE GLOBAL TEMPORARY TABLE apmt500_detail AS ",
      "SELECT * FROM xrcd_t "
   PREPARE repro_tbl6 FROM ls_sql
   EXECUTE repro_tbl6
   FREE repro_tbl6
      
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO apmt500_detail SELECT * FROM xrcd_t
                                         WHERE xrcdent = g_enterprise AND xrcddocno = g_pmdldocno_t
 
   #將key修正為調整後   
   UPDATE apmt500_detail SET xrcddocno = g_pmdl_m.pmdldocno
   #將資料塞回原table   
   INSERT INTO xrcd_t SELECT * FROM apmt500_detail   
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt500_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table4.a_insert"
  
   #end add-point
 
 
   
 
   
   #多語言複製段落
   
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.delete" >}
#+ 資料刪除
PRIVATE FUNCTION apmt500_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"
   
   #end add-point     
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
   DEFINE  l_pmdl028       LIKE pmdl_t.pmdl028
   DEFINE  l_pmdp003       LIKE pmdp_t.pmdp003
   DEFINE  l_pmdp004       LIKE pmdp_t.pmdp004
   DEFINE  l_pmdp023       LIKE pmdp_t.pmdp023
   DEFINE l_pmdp009        LIKE pmdp_t.pmdp009
   DEFINE l_pmdp010        LIKE pmdp_t.pmdp010
   DEFINE  l_pmdnseq       LIKE pmdn_t.pmdnseq
   DEFINE  l_cnt           LIKE type_t.num5 
   #ming 20150904 add -----------------------------(S) 
   DEFINE l_success        LIKE type_t.num5
   #ming 20150904 add -----------------------------(E) 
   #160920-00035#1---s
   DEFINE l_pspcsite       LIKE pspc_t.pspcsite
   DEFINE l_pspc001        LIKE pspc_t.pspc001
   DEFINE l_pspc002        LIKE pspc_t.pspc002
   DEFINE l_pspc004        LIKE pspc_t.pspc004
   DEFINE l_pspc061        LIKE pspc_t.pspc061
   DEFINE l_pmdpseq        LIKE pmdp_t.pmdpseq
   DEFINE l_pmdp007        LIKE pmdp_t.pmdp007
   DEFINE l_pmdp008        LIKE pmdp_t.pmdp008
   DEFINE l_sql            STRING
   DEFINE l_ooff012        LIKE ooff_t.ooff012  #161031-00025#1
   DEFINE l_pmdp001        LIKE pmdp_t.pmdp001  #170208-00026#1 add
   DEFINE l_n1             LIKE type_t.num5     #170208-00026#1 add
   #160920-00035#1--e
   
   #end add-point     
   
   #add-point:Function前置處理  name="delete.pre_function"
   
   #end add-point
   
   IF g_pmdl_m.pmdldocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   
   
   CALL s_transaction_begin()
 
   OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt500_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE apmt500_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
       g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
       g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
       g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
       g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
       g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
       g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
       g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
       g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
       g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
       g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid_desc, 
       g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc
   
   
   #檢查是否允許此動作
   IF NOT apmt500_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_pmdl_m_mask_o.* =  g_pmdl_m.*
   CALL apmt500_pmdl_t_mask()
   LET g_pmdl_m_mask_n.* =  g_pmdl_m.*
   
   CALL apmt500_show()
   
   #add-point:delete段before ask name="delete.before_ask"
   
   #end add-point 
 
   IF cl_ask_del_master() THEN              #確認一下
   
      #add-point:單頭刪除前 name="delete.head.b_delete"
                  LET l_pmdl028 = g_pmdl_m.pmdl028
      #end add-point   
      
      #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL apmt500_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
  
  
      #資料備份
      LET g_pmdldocno_t = g_pmdl_m.pmdldocno
 
 
      DELETE FROM pmdl_t
       WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
 
       
      #add-point:單頭刪除中 name="delete.head.m_delete"
            
      #end add-point
       
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_pmdl_m.pmdldocno,":",SQLERRMESSAGE  
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF
      
      #add-point:單頭刪除後 name="delete.head.a_delete"
    #2015/09/14 by stellar add ----- (S)
    #stellar修改：apmt501在刪除的時候，會去用單別檢查編號的正確性，因為採購單號已經等於工單號碼了，所以原來檢查的地方會判斷成apmt501不能用工單的單別錯誤
    IF NOT (g_pmdl_m.pmdldocno = g_pmdl_m.pmdl008 AND g_pmdl_m.pmdl007 = '4') THEN 
    #2015/09/14 by stellar add ----- (E)
      IF NOT s_aooi200_del_docno(g_pmdl_m.pmdldocno,g_pmdl_m.pmdldocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
    END IF   #2015/09/14 by stellar add
      #end add-point
  
      #add-point:單身刪除前 name="delete.body.b_delete"
      #ming 20150904 add ------------------------(S) 
      CALL s_apmt500_stus_abg1(g_pmdl_m.pmdldocno,'D')
           RETURNING l_success
      IF NOT l_success THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #ming 20150904 add ------------------------(E) 
      
      #更新工单sfcb041 委外数量
      #代买料不影响可委外数量
      IF g_pmdl_m.pmdl005 = '2' AND g_pmdl_m.pmdl007 = '4' THEN
          
          DECLARE sfcb_upd2 CURSOR FOR 
                SELECT DISTINCT pmdp003,pmdp004,pmdp023,pmdp009,pmdp010,pmdp001 FROM pmdp_t,pmdn_t   #170208-00026#1 add pmdp001
                   WHERE pmdpent = pmdnent AND pmdpdocno = pmdndocno AND pmdpseq = pmdnseq AND pmdn019 <> '8'
                     AND pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                     
          FOREACH sfcb_upd2 INTO l_pmdp003,l_pmdp004,l_pmdp023,l_pmdp009,l_pmdp010,l_pmdp001   #170208-00026#1 add pmdp001
             
             #170208-00026#1 add   --begin--
             SELECT COUNT(sfac001) INTO l_n1 FROM sfac_t
              WHERE sfacent = g_enterprise AND sfacdocno = l_pmdp003
                AND sfac001 = l_pmdp001 AND (sfac002 = '1' OR sfac002 = '2')
             IF l_n1 = 0 THEN
                CONTINUE FOREACH
             END IF
             #170208-00026#1 add   --end--
             
             #160316-00006#1---add---begin---
             IF cl_null(l_pmdp009) THEN
                LET l_pmdp009 = ' '
             END IF
             IF cl_null(l_pmdp010) THEN
                LET l_pmdp010 = ' '
             END IF
             #160316-00006#1---add---end---
         
             UPDATE sfcb_t SET sfcb041 = sfcb041 - l_pmdp023
              WHERE sfcbent   = g_enterprise
                AND sfcbdocno = l_pmdp003
                AND sfcb001   = l_pmdp004
                #AND sfcb003 = l_pmdp009  #160316-00006#1 mark
                #AND sfcb004 = l_pmdp010  #160316-00006#1 mark
                #160316-00006#1---add---begin---
                AND (CASE WHEN sfcb003 IS NULL THEN ' ' ELSE sfcb003 END) = l_pmdp009
                AND (CASE WHEN sfcb004 IS NULL THEN ' ' ELSE sfcb004 END) = l_pmdp010
                #160316-00006#1---add---end---
             IF SQLCA.sqlcode THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = SQLCA.sqlcode
                LET g_errparam.extend = 'update sfcb041'
                LET g_errparam.popup = TRUE
                CALL cl_err()
                CALL s_transaction_end('N','0')
                RETURN                              
             END IF
          END FOREACH
      END IF
      
      DECLARE pmdn_cur2 CURSOR FOR
        SELECT pmdnseq FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
      
      FOREACH pmdn_cur2 INTO l_pmdnseq
         #更新請購單中的已轉採購量
         IF NOT s_apmt500_upd_pmdb049(g_pmdl_m.pmdldocno,l_pmdnseq,'-1') THEN
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      
      END FOREACH
            
      #end add-point
      
      DELETE FROM pmdn_t
       WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
 
 
      #add-point:單身刪除中 name="delete.body.m_delete"
            
      #end add-point
         
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF    
 
      #add-point:單身刪除後 name="delete.body.a_delete"
            
      #end add-point
      
            
                                                               
      #add-point:單身刪除前 name="delete.body.b_delete2"
            
      #end add-point
      DELETE FROM pmdo_t
       WHERE pmdoent = g_enterprise AND
             pmdodocno = g_pmdl_m.pmdldocno
      #add-point:單身刪除中 name="delete.body.m_delete2"
            
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete2"
            
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete3"
      #160920-00035#2---s
      IF g_pmdl_m.pmdl007 = '5' THEN
         DECLARE aps_cs1 CURSOR FOR 
             SELECT DISTINCT pmdpseq,pmdp003,pmdp007,pmdp008,pmdp023 FROM pmdb_t 
                WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmda_m.pmdadocno
                
         LET l_sql =  " SELECT DISTINCT pspcsite,pspc001,pspc002,pspc004,pspc061 FROM pspc_t ",
                      "    WHERE pspcent = ",g_enterprise," AND pspc004 = ? ", 
                      "      AND pspc050 = ? AND pspc051 = ? ",
                      "      AND pspc055 = '",g_pmdl_m.pmdldocno,"' AND pspc056 = ? "
         PREPARE apmt500_aps_sel FROM l_sql
         DECLARE apmt500_aps_upd1 CURSOR FOR apmt500_aps_sel      
         
         FOREACH aps_cs1 INTO l_pmdpseq,l_pmdp003,l_pmdp007,l_pmdp008,l_pmdp023
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               EXIT FOREACH
            END IF
            
            IF cl_null(l_pmdp008) THEN
               LET l_pmdp008 = ' '
            END IF
            FOREACH apmt500_aps_upd1 USING l_pmdp003,l_pmdp007,l_pmdp008,l_pmdpseq
                    INTO l_pspcsite,l_pspc001,l_pspc002,l_pspc004,l_pspc061
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  EXIT FOREACH
               END IF
               IF l_pspc061 > l_pmdp023 THEN
                  UPDATE pspc_t SET pspc061 = pspc061 - l_pmdp023
                     WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                       AND pspc004 = l_pspc004
               ELSE
                  UPDATE pspc_t SET pspc055 = '',
                                    pspc056 = '',
                                    pspc061 = 0
                     WHERE pspcent = g_enterprise AND pspcsite = l_pspcsite AND pspc001 = l_pspc001
                       AND pspc004 = l_pspc004
               END IF
            END FOREACH
         END FOREACH
      END IF
      #160920-00035#2--e
      #end add-point
      DELETE FROM pmdp_t
       WHERE pmdpent = g_enterprise AND
             pmdpdocno = g_pmdl_m.pmdldocno
      #add-point:單身刪除中 name="delete.body.m_delete3"
            
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdo_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete3"
            
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete4"
            
      #end add-point
      DELETE FROM pmdm_t
       WHERE pmdment = g_enterprise AND
             pmdmdocno = g_pmdl_m.pmdldocno
      #add-point:單身刪除中 name="delete.body.m_delete4"
            
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete4"
      DELETE FROM pmdq_t WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdldocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "pmdq_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
 
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #一次性交易對象
      DELETE FROM pmak_t WHERE pmakent = g_enterprise AND pmak001 = l_pmdl028
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "pmak_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
 
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #161031-00025#1---s
      #IF NOT s_aooi360_del('6',g_prog,g_pmdl_m.pmdldocno,'','','','','','','','','4') THEN
      #   CALL s_transaction_end('N','0')
      #   RETURN
      #END IF
      #161031-00025#1---e
      
      #刪除交易稅明細檔
      LET l_cnt = 0
      SELECT COUNT(1) INTO l_cnt
        FROM xrcd_t
       WHERE xrcdent = g_enterprise
         AND xrcddocno = g_pmdl_m.pmdldocno
         AND xrcdseq2 = 0
      IF l_cnt > 0 THEN
         DELETE FROM xrcd_t
          WHERE xrcdent = g_enterprise
            AND xrcddocno = g_pmdl_m.pmdldocno
            AND xrcdseq2 = 0
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "DELETE xrcd_t"
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = FALSE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END IF

      #161031-00025#1---s
      #单头的aooi360_01的备注单身资料同步删除 ;#单身的长备注栏位也要同步删除
      DELETE FROM ooff_t WHERE ooffent = g_enterprise AND ooff002 = g_prog AND ooff003 = g_pmdl_m.pmdldocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "ooff_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         CALL s_transaction_end('N','0')
         RETURN
      END IF
      CALL aooi360_01_clear_detail() 
      #161031-00025#1---e
      #end add-point
 
 
 
 
      
      #修改歷程記錄(刪除)
      LET g_log1 = util.JSON.stringify(g_pmdl_m)   #(ver:78)
      IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:78)
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
             
      CLEAR FORM
      CALL g_pmdn_d.clear() 
      CALL g_pmdn2_d.clear()       
      CALL g_pmdn3_d.clear()       
      CALL g_pmdn4_d.clear()       
      CALL g_pmdn6_d.clear()       
 
     
      CALL apmt500_ui_browser_refresh()  
      #CALL apmt500_ui_headershow()  
      #CALL apmt500_ui_detailshow()
 
      #add-point:多語言刪除 name="delete.lang.before_delete"
      
      #end add-point
      
      #單頭多語言刪除
      
      
      #單身多語言刪除
      
      
      
      
      
 
   
      #add-point:多語言刪除 name="delete.lang.delete"
      
      #end add-point
      
      IF g_browser_cnt > 0 THEN 
         #CALL apmt500_browser_fill("")
         CALL apmt500_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
         DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
      ELSE
         CLEAR FORM
      END IF
      
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
 
   CLOSE apmt500_cl
 
   #功能已完成,通報訊息中心
   CALL apmt500_msgcentre_notify('delete')
    
END FUNCTION
 
{</section>}
 
{<section id="apmt500.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION apmt500_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point     
   DEFINE p_wc2      STRING
   DEFINE li_idx     LIKE type_t.num10
   #add-point:b_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   DEFINE l_pmdoseq  LIKE pmdo_t.pmdoseq
   DEFINE l_pmdoseq1 LIKE pmdo_t.pmdoseq1
   DEFINE l_pmdo003  LIKE pmdo_t.pmdo003
   DEFINE l_pmdo001  LIKE pmdo_t.pmdo001
   DEFINE l_pmdo002  LIKE pmdo_t.pmdo002
   DEFINE l_pmdo004  LIKE pmdo_t.pmdo004
   DEFINE l_pmdo005  LIKE pmdo_t.pmdo005 
   DEFINE l_success  LIKE type_t.num5  
   DEFINE l_wc2_table1  STRING
   DEFINE l_wc2_table2  STRING
   DEFINE l_wc2_table3  STRING    
   #ming 20150903 add --------------------------(S) 
   DEFINE l_errno            LIKE gzze_t.gzze001
   DEFINE l_bgaf016          LIKE bgaf_t.bgaf016
   DEFINE l_pmdn058          LIKE pmdn_t.pmdn058
   DEFINE l_pmdn058_desc     LIKE type_t.chr500
   DEFINE l_pmdn058_desc_sql STRING
   #ming 20150903 add --------------------------(E) 
   #end add-point     
   
   #add-point:Function前置處理  name="b_fill.pre_function"
   
   #end add-point
   
   #清空第一階單身
   CALL g_pmdn_d.clear()
   CALL g_pmdn2_d.clear()
   CALL g_pmdn3_d.clear()
   CALL g_pmdn4_d.clear()
   CALL g_pmdn6_d.clear()
 
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"
   LET l_wc2_table1 = g_wc2_table1
   LET l_wc2_table2 = g_wc2_table2
   LET l_wc2_table3 = g_wc2_table3
   #end add-point
   
   #判斷是否填充
   IF apmt500_fill_chk(1) THEN
      #切換上下筆時不重組SQL
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
      #add-point:b_fill段long_sql_if name="b_fill.long_sql_if"
      
      #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdnsite,pmdnseq,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006,pmdn007, 
             pmdn008,pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015,pmdn016, 
             pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022,pmdnunit, 
             pmdnorga,pmdn049,pmdn051,pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,pmdnseq,pmdn027,pmdn028, 
             pmdn029,pmdn030,pmdn053,pmdn025,pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036,pmdn037, 
             pmdn038,pmdn058,pmdn039,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044 ,t1.imaal003 ,t2.inaml004 , 
             t3.oocql004 ,t4.oocal003 ,t5.oocal003 ,t6.oocal003 ,t7.pmaal004 ,t8.ooefl003 ,t9.ooefl003 , 
             t10.inayl003 ,t11.inab003 ,t12.oocql004 ,t13.imaal003 ,t14.pjbal003 ,t15.pjbbl004 ,t16.pjbml004 FROM pmdn_t", 
                
                     " INNER JOIN pmdl_t ON pmdlent = " ||g_enterprise|| " AND pmdldocno = pmdndocno ",
 
                     #"",
                     
                     "",
                     #下層單身所需的join條件
 
                                    " LEFT JOIN imaal_t t1 ON t1.imaalent="||g_enterprise||" AND t1.imaal001=pmdn001 AND t1.imaal002='"||g_dlang||"' ",
               " LEFT JOIN inaml_t t2 ON t2.inamlent="||g_enterprise||" AND t2.inaml001=pmdn001 AND t2.inaml002=pmdn002 AND t2.inaml003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t3 ON t3.oocqlent="||g_enterprise||" AND t3.oocql001='221' AND t3.oocql002=pmdn004 AND t3.oocql003='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t4 ON t4.oocalent="||g_enterprise||" AND t4.oocal001=pmdn006 AND t4.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t5 ON t5.oocalent="||g_enterprise||" AND t5.oocal001=pmdn008 AND t5.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t6 ON t6.oocalent="||g_enterprise||" AND t6.oocal001=pmdn010 AND t6.oocal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t7 ON t7.pmaalent="||g_enterprise||" AND t7.pmaal001=pmdn023 AND t7.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t8 ON t8.ooeflent="||g_enterprise||" AND t8.ooefl001=pmdnunit AND t8.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t9 ON t9.ooeflent="||g_enterprise||" AND t9.ooefl001=pmdnorga AND t9.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t10 ON t10.inaylent="||g_enterprise||" AND t10.inayl001=pmdn028 AND t10.inayl002='"||g_dlang||"' ",
               " LEFT JOIN inab_t t11 ON t11.inabent="||g_enterprise||" AND t11.inabsite=pmdnsite AND t11.inab001=pmdn028 AND t11.inab002=pmdn029  ",
               " LEFT JOIN oocql_t t12 ON t12.oocqlent="||g_enterprise||" AND t12.oocql001='263' AND t12.oocql002=pmdn031 AND t12.oocql003='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t13 ON t13.imaalent="||g_enterprise||" AND t13.imaal001=pmdn003 AND t13.imaal002='"||g_dlang||"' ",
               " LEFT JOIN pjbal_t t14 ON t14.pjbalent="||g_enterprise||" AND t14.pjbal001=pmdn036 AND t14.pjbal002='"||g_dlang||"' ",
               " LEFT JOIN pjbbl_t t15 ON t15.pjbblent="||g_enterprise||" AND t15.pjbbl001=pmdn036 AND t15.pjbbl002=pmdn037 AND t15.pjbbl003='"||g_dlang||"' ",
               " LEFT JOIN pjbml_t t16 ON t16.pjbmlent="||g_enterprise||" AND t16.pjbml001=pmdn036 AND t16.pjbml002=pmdn038 AND t16.pjbml003='"||g_dlang||"' ",
 
                     " WHERE pmdnent=? AND pmdndocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段sql_before name="b_fill.body.fill_sql"
         IF NOT cl_null(g_wc2_table2) AND g_wc2_table2 <> " 1=1" THEN
            LET g_wc2_table1 = g_wc2_table1 CLIPPED,
                               " AND (pmdndocno,pmdnseq) IN (SELECT pmdodocno,pmdoseq FROM pmdo_t ",
                                                            " WHERE pmdoent = pmdnent ",
                                                            "   AND pmdodocno = pmdndocno ",
                                                            "   AND pmdoseq = pmdnseq ",
                                                            "   AND ",g_wc2_table2 CLIPPED,")"
         END IF
         IF NOT cl_null(g_wc2_table3) AND g_wc2_table3 <> " 1=1" THEN
            LET g_wc2_table1 = g_wc2_table1 CLIPPED,
                               " AND (pmdndocno,pmdnseq) IN (SELECT pmdpdocno,pmdpseq FROM pmdp_t ",
                                                            " WHERE pmdpent = pmdnent ",
                                                            "   AND pmdpdocno = pmdndocno ",
                                                            "   AND pmdpseq = pmdnseq ",
                                                            "   AND ",g_wc2_table3 CLIPPED,")"
         END IF  
         #end add-point
         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdn_t.pmdnseq"
         
         #add-point:單身填充控制 name="b_fill.sql"
         LET g_wc2_table1 = l_wc2_table1
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt500_pb FROM g_sql
         DECLARE b_fill_cs CURSOR FOR apmt500_pb
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
   #  OPEN b_fill_cs USING g_enterprise,g_pmdl_m.pmdldocno   #(ver:78)
                                               
      FOREACH b_fill_cs USING g_enterprise,g_pmdl_m.pmdldocno INTO g_pmdn_d[l_ac].pmdnsite,g_pmdn_d[l_ac].pmdnseq, 
          g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005, 
          g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn007,g_pmdn_d[l_ac].pmdn008,g_pmdn_d[l_ac].pmdn009, 
          g_pmdn_d[l_ac].pmdn024,g_pmdn_d[l_ac].pmdn012,g_pmdn_d[l_ac].pmdn013,g_pmdn_d[l_ac].pmdn014, 
          g_pmdn_d[l_ac].pmdn045,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdn011,g_pmdn_d[l_ac].pmdn015, 
          g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn017,g_pmdn_d[l_ac].pmdn046,g_pmdn_d[l_ac].pmdn047, 
          g_pmdn_d[l_ac].pmdn048,g_pmdn_d[l_ac].pmdn023,g_pmdn_d[l_ac].pmdn019,g_pmdn_d[l_ac].pmdn020, 
          g_pmdn_d[l_ac].pmdn052,g_pmdn_d[l_ac].pmdn021,g_pmdn_d[l_ac].pmdn022,g_pmdn_d[l_ac].pmdnunit, 
          g_pmdn_d[l_ac].pmdnorga,g_pmdn_d[l_ac].pmdn049,g_pmdn_d[l_ac].pmdn051,g_pmdn_d[l_ac].pmdn054, 
          g_pmdn_d[l_ac].pmdn055,g_pmdn_d[l_ac].pmdn056,g_pmdn_d[l_ac].pmdn057,g_pmdn_d[l_ac].pmdn050, 
          g_pmdn2_d[l_ac].pmdnseq,g_pmdn2_d[l_ac].pmdn027,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029, 
          g_pmdn2_d[l_ac].pmdn030,g_pmdn2_d[l_ac].pmdn053,g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn026, 
          g_pmdn2_d[l_ac].pmdn031,g_pmdn2_d[l_ac].pmdn032,g_pmdn2_d[l_ac].pmdn033,g_pmdn2_d[l_ac].pmdn003, 
          g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037,g_pmdn2_d[l_ac].pmdn038,g_pmdn2_d[l_ac].pmdn058, 
          g_pmdn2_d[l_ac].pmdn039,g_pmdn2_d[l_ac].pmdn035,g_pmdn2_d[l_ac].pmdn040,g_pmdn2_d[l_ac].pmdn041, 
          g_pmdn2_d[l_ac].pmdn042,g_pmdn2_d[l_ac].pmdn043,g_pmdn2_d[l_ac].pmdn044,g_pmdn_d[l_ac].pmdn001_desc, 
          g_pmdn_d[l_ac].pmdn002_desc,g_pmdn_d[l_ac].pmdn004_desc,g_pmdn_d[l_ac].pmdn006_desc,g_pmdn_d[l_ac].pmdn008_desc, 
          g_pmdn_d[l_ac].pmdn010_desc,g_pmdn_d[l_ac].pmdn023_desc,g_pmdn_d[l_ac].pmdnunit_desc,g_pmdn_d[l_ac].pmdnorga_desc, 
          g_pmdn2_d[l_ac].pmdn028_desc,g_pmdn2_d[l_ac].pmdn029_desc,g_pmdn2_d[l_ac].pmdn031_desc,g_pmdn2_d[l_ac].pmdn003_desc, 
          g_pmdn2_d[l_ac].pmdn036_desc,g_pmdn2_d[l_ac].pmdn037_desc,g_pmdn2_d[l_ac].pmdn038_desc   #(ver:78) 
 
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
         #161207-00033#27-S
         IF g_pmdn_d[l_ac].pmdn023 = g_pmdl_m.pmdl004 THEN
            LET g_pmdn_d[l_ac].pmdn023_desc = g_pmdl_m.pmdl004_desc
         END IF
         #161207-00033#27-E
         CALL apmt500_pmdn001_ref(g_pmdn_d[l_ac].pmdn001) RETURNING g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
         DISPLAY BY NAME g_pmdn_d[l_ac].pmdn001_desc,g_pmdn_d[l_ac].imaal004
         
         #161205-00025#2---s         
         #CALL s_feature_description(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002) RETURNING l_success,g_pmdn_d[l_ac].pmdn002_desc
         #DISPLAY BY NAME g_pmdn_d[l_ac].pmdn002_desc
         #161205-00025#2---e
         
         CALL apmt500_pmdl011_ref(g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
         DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016_desc
         
         CALL apmt500_pmdn049_ref(g_pmdn_d[l_ac].pmdn049) RETURNING g_pmdn_d[l_ac].pmdn049_desc
         DISPLAY BY NAME g_pmdn_d[l_ac].pmdn049_desc
         
         IF g_pmdl_m.pmdlstus = 'H' THEN  #留置狀態下，顯示留置理由碼說明
            CALL s_desc_get_acc_desc('317',g_pmdn_d[l_ac].pmdn051) RETURNING g_pmdn_d[l_ac].pmdn051_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn051_desc
         ELSE
            CALL s_desc_get_acc_desc('258',g_pmdn_d[l_ac].pmdn051) RETURNING g_pmdn_d[l_ac].pmdn051_desc
            DISPLAY BY NAME g_pmdn_d[l_ac].pmdn051_desc
         END IF
         
         #161205-00025#2---s   
         #CALL apmt500_pmdn028_ref(g_pmdn2_d[l_ac].pmdn028) RETURNING g_pmdn2_d[l_ac].pmdn028_desc
         #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn028_desc
         #
         #CALL apmt500_pmdn029_ref(g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029) RETURNING g_pmdn2_d[l_ac].pmdn029_desc
         #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn029_desc
         #
         #CALL s_desc_get_project_desc(g_pmdn2_d[l_ac].pmdn036) RETURNING g_pmdn2_d[l_ac].pmdn036_desc
         #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn036_desc
         #
         #CALL s_desc_get_wbs_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn037) RETURNING g_pmdn2_d[l_ac].pmdn037_desc
         #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn037_desc
         #
         #CALL s_desc_get_activity_desc(g_pmdn2_d[l_ac].pmdn036,g_pmdn2_d[l_ac].pmdn038) RETURNING g_pmdn2_d[l_ac].pmdn038_desc
         #DISPLAY BY NAME g_pmdn2_d[l_ac].pmdn038_desc
         #161205-00025#2---e
         
         SELECT pmao009,pmao010
           INTO g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
           FROM pmao_t
           WHERE pmaoent = g_enterprise
             AND pmao001 = g_pmdl_m.pmdl004
             AND pmao002 = g_pmdn_d[l_ac].pmdn001
             AND pmao003 = g_pmdn_d[l_ac].pmdn002
             AND pmao004 = g_pmdn2_d[l_ac].pmdn027
             AND pmao000 = '1'      #161221-00064##5 add             
   
         LET g_pmdn2_d[l_ac].pmdnseq = g_pmdn_d[l_ac].pmdnseq
         LET g_pmdn2_d[l_ac].imaa001 = g_pmdn_d[l_ac].pmdn001
         LET g_pmdn2_d[l_ac].imaal003 = g_pmdn_d[l_ac].pmdn001_desc
         LET g_pmdn2_d[l_ac].imaal004 = g_pmdn_d[l_ac].imaal004
         LET g_pmdn2_d[l_ac].imaa005 = g_pmdn_d[l_ac].pmdn002
         LET g_pmdn2_d[l_ac].imaa005_1_desc = g_pmdn_d[l_ac].pmdn002_desc 
         
         #ming 20150903 add ---------------------------------------(S) 
         #科目預算 
         CALL apmt500_detail_abg('3')
              RETURNING l_success,l_errno,l_bgaf016,
                        l_pmdn058,l_pmdn058_desc,l_pmdn058_desc_sql
         LET g_pmdn2_d[l_ac].pmdn058_desc = l_pmdn058_desc
         #ming 20150903 add ---------------------------------------(E) 
         
         #161031-00025#1---s
         CALL s_aooi360_sel('7',g_prog,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq,'','','','','','','','1') RETURNING l_success,g_pmdn_d[l_ac].ooff013
         #161031-00025#1---s
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_ac
               LET g_errparam.code = 9035 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
    
   #判斷是否填充
   IF apmt500_fill_chk(2) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body2.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdosite,pmdoseq,pmdoseq1,pmdo003,pmdo001,pmdo002,pmdo004,pmdo005, 
             pmdoseq2,pmdo006,pmdo028,pmdo029,pmdo011,pmdo012,pmdo013,pmdo010,pmdo014,pmdo009,pmdo015, 
             pmdo016,pmdo017,pmdo040,pmdo019,pmdo020,pmdo021,pmdo030,pmdo031,pmdo022,pmdo023,pmdo024, 
             pmdo032,pmdo033,pmdo034,pmdo025,pmdo026,pmdo027,pmdo041,pmdo042,pmdo043,pmdo044 ,t17.imaal003 , 
             t18.oocal003 ,t19.oocal003 ,t20.oocql004 ,t21.oocal003 ,t22.ooag011 FROM pmdo_t",   
                     " INNER JOIN  pmdl_t ON pmdlent = " ||g_enterprise|| " AND pmdldocno = pmdodocno ",
 
                     "",
                     
                                    " LEFT JOIN imaal_t t17 ON t17.imaalent="||g_enterprise||" AND t17.imaal001=pmdo001 AND t17.imaal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t18 ON t18.oocalent="||g_enterprise||" AND t18.oocal001=pmdo004 AND t18.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t19 ON t19.oocalent="||g_enterprise||" AND t19.oocal001=pmdo028 AND t19.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t20 ON t20.oocqlent="||g_enterprise||" AND t20.oocql001='274' AND t20.oocql002=pmdo010 AND t20.oocql003='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t21 ON t21.oocalent="||g_enterprise||" AND t21.oocal001=pmdo030 AND t21.oocal002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t22 ON t22.ooagent="||g_enterprise||" AND t22.ooag001=pmdo026  ",
 
                     " WHERE pmdoent=? AND pmdodocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body2.fill_sql"
         IF NOT cl_null(g_wc2_table1) AND g_wc2_table1 <> " 1=1" THEN
            LET g_wc2_table2 = g_wc2_table2 CLIPPED,
                               " AND (pmdodocno,pmdoseq) IN (SELECT pmdndocno,pmdnseq FROM pmdn_t ",
                                                            " WHERE pmdoent = pmdnent ",
                                                            "   AND pmdodocno = pmdndocno ",
                                                            "   AND pmdoseq = pmdnseq ",
                                                            "   AND ",g_wc2_table1 CLIPPED,")"
         END IF
         IF NOT cl_null(g_wc2_table3) AND g_wc2_table3 <> " 1=1" THEN
            LET g_wc2_table2 = g_wc2_table2 CLIPPED,
                               " AND (pmdodocno,pmdoseq) IN (SELECT pmdpdocno,pmdpseq FROM pmdp_t ",
                                                            " WHERE pmdpent = pmdoent ",
                                                            "   AND pmdpdocno = pmdodocno ",
                                                            "   AND pmdpseq = pmdoseq ",
                                                            "   AND ",g_wc2_table3 CLIPPED,")"
         END IF 
         #end add-point
         IF NOT cl_null(g_wc2_table2) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdo_t.pmdoseq,pmdo_t.pmdoseq1,pmdo_t.pmdoseq2"
         
         #add-point:單身填充控制 name="b_fill.sql2"
         LET g_wc2_table2 = l_wc2_table2   
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt500_pb2 FROM g_sql
         DECLARE b_fill_cs2 CURSOR FOR apmt500_pb2
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs2 USING g_enterprise,g_pmdl_m.pmdldocno   #(ver:78)
                                               
      FOREACH b_fill_cs2 USING g_enterprise,g_pmdl_m.pmdldocno INTO g_pmdn3_d[l_ac].pmdosite,g_pmdn3_d[l_ac].pmdoseq, 
          g_pmdn3_d[l_ac].pmdoseq1,g_pmdn3_d[l_ac].pmdo003,g_pmdn3_d[l_ac].pmdo001,g_pmdn3_d[l_ac].pmdo002, 
          g_pmdn3_d[l_ac].pmdo004,g_pmdn3_d[l_ac].pmdo005,g_pmdn3_d[l_ac].pmdoseq2,g_pmdn3_d[l_ac].pmdo006, 
          g_pmdn3_d[l_ac].pmdo028,g_pmdn3_d[l_ac].pmdo029,g_pmdn3_d[l_ac].pmdo011,g_pmdn3_d[l_ac].pmdo012, 
          g_pmdn3_d[l_ac].pmdo013,g_pmdn3_d[l_ac].pmdo010,g_pmdn3_d[l_ac].pmdo014,g_pmdn3_d[l_ac].pmdo009, 
          g_pmdn3_d[l_ac].pmdo015,g_pmdn3_d[l_ac].pmdo016,g_pmdn3_d[l_ac].pmdo017,g_pmdn3_d[l_ac].pmdo040, 
          g_pmdn3_d[l_ac].pmdo019,g_pmdn3_d[l_ac].pmdo020,g_pmdn3_d[l_ac].pmdo021,g_pmdn3_d[l_ac].pmdo030, 
          g_pmdn3_d[l_ac].pmdo031,g_pmdn3_d[l_ac].pmdo022,g_pmdn3_d[l_ac].pmdo023,g_pmdn3_d[l_ac].pmdo024, 
          g_pmdn3_d[l_ac].pmdo032,g_pmdn3_d[l_ac].pmdo033,g_pmdn3_d[l_ac].pmdo034,g_pmdn3_d[l_ac].pmdo025, 
          g_pmdn3_d[l_ac].pmdo026,g_pmdn3_d[l_ac].pmdo027,g_pmdn3_d[l_ac].pmdo041,g_pmdn3_d[l_ac].pmdo042, 
          g_pmdn3_d[l_ac].pmdo043,g_pmdn3_d[l_ac].pmdo044,g_pmdn3_d[l_ac].pmdo001_desc,g_pmdn3_d[l_ac].pmdo004_desc, 
          g_pmdn3_d[l_ac].pmdo028_desc,g_pmdn3_d[l_ac].pmdo010_desc,g_pmdn3_d[l_ac].pmdo030_desc,g_pmdn3_d[l_ac].pmdo026_desc  
            #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill2.fill"
         CALL s_desc_get_item_desc(g_pmdn3_d[l_ac].pmdo001) RETURNING g_pmdn3_d[l_ac].pmdo001_desc,g_pmdn3_d[l_ac].imaal004
         DISPLAY BY NAME g_pmdn3_d[l_ac].pmdo001_desc,g_pmdn3_d[l_ac].imaal004
          
         IF g_pmdn3_d[l_ac].pmdoseq = l_pmdoseq 
                 AND g_pmdn3_d[l_ac].pmdoseq1 = l_pmdoseq1
                 AND g_pmdn3_d[l_ac].pmdo003 = l_pmdo003
                 AND g_pmdn3_d[l_ac].pmdo001 = l_pmdo001
                 AND g_pmdn3_d[l_ac].pmdo002 = l_pmdo002
                 AND g_pmdn3_d[l_ac].pmdo004 = l_pmdo004
                 AND g_pmdn3_d[l_ac].pmdo005 = l_pmdo005 THEN
                 
            LET l_pmdoseq = g_pmdn3_d[l_ac].pmdoseq
            LET l_pmdoseq1 = g_pmdn3_d[l_ac].pmdoseq1
            LET l_pmdo003 = g_pmdn3_d[l_ac].pmdo003
            LET l_pmdo001 = g_pmdn3_d[l_ac].pmdo001
            LET l_pmdo002 = g_pmdn3_d[l_ac].pmdo002
            LET l_pmdo004 = g_pmdn3_d[l_ac].pmdo004
            LET l_pmdo005 = g_pmdn3_d[l_ac].pmdo005
        
            LET g_pmdn3_d[l_ac].pmdoseq = ''
            LET g_pmdn3_d[l_ac].pmdoseq1 = ''
            LET g_pmdn3_d[l_ac].pmdo003 = ''
            LET g_pmdn3_d[l_ac].pmdo001 = ''
            LET g_pmdn3_d[l_ac].pmdo001_desc = ''
            LET g_pmdn3_d[l_ac].imaal004 = ''
            LET g_pmdn3_d[l_ac].pmdo002 = ''
            LET g_pmdn3_d[l_ac].pmdo004 = ''
            LET g_pmdn3_d[l_ac].pmdo004_desc = ''
            LET g_pmdn3_d[l_ac].pmdo005 = ''
         ELSE
            LET l_pmdoseq = g_pmdn3_d[l_ac].pmdoseq
            LET l_pmdoseq1 = g_pmdn3_d[l_ac].pmdoseq1
            LET l_pmdo003 = g_pmdn3_d[l_ac].pmdo003
            LET l_pmdo001 = g_pmdn3_d[l_ac].pmdo001
            LET l_pmdo002 = g_pmdn3_d[l_ac].pmdo002
            LET l_pmdo004 = g_pmdn3_d[l_ac].pmdo004
            LET l_pmdo005 = g_pmdn3_d[l_ac].pmdo005
         END IF
         
         
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF apmt500_fill_chk(3) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body3.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdpsite,pmdpseq,pmdpseq1,pmdp001,pmdp002,pmdp003,pmdp004,pmdp005, 
             pmdp006,pmdp007,pmdp008,pmdp009,pmdp010,pmdp011,pmdp012,pmdp021,pmdp022,pmdp023,pmdp024, 
             pmdp025,pmdp026 ,t23.imaal003 ,t24.oocal003 FROM pmdp_t",   
                     " INNER JOIN  pmdl_t ON pmdlent = " ||g_enterprise|| " AND pmdldocno = pmdpdocno ",
 
                     "",
                     
                                    " LEFT JOIN imaal_t t23 ON t23.imaalent="||g_enterprise||" AND t23.imaal001=pmdp001 AND t23.imaal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t24 ON t24.oocalent="||g_enterprise||" AND t24.oocal001=pmdp022 AND t24.oocal002='"||g_dlang||"' ",
 
                     " WHERE pmdpent=? AND pmdpdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body3.fill_sql"
         IF NOT cl_null(g_wc2_table1) AND g_wc2_table1 <> " 1=1" THEN
            LET g_wc2_table3 = g_wc2_table3 CLIPPED,
                               " AND (pmdpdocno,pmdpseq) IN (SELECT pmdndocno,pmdnseq FROM pmdn_t ",
                                                            " WHERE pmdpent = pmdnent ",
                                                            "   AND pmdpdocno = pmdndocno ",
                                                            "   AND pmdpseq = pmdnseq ",
                                                            "   AND ",g_wc2_table1 CLIPPED,")"
         END IF
         IF NOT cl_null(g_wc2_table2) AND g_wc2_table2 <> " 1=1" THEN
            LET g_wc2_table3 = g_wc2_table3 CLIPPED,
                               " AND (pmdpdocno,pmdpseq) IN (SELECT pmdodocno,pmdoseq FROM pmdo_t ",
                                                            " WHERE pmdpent = pmdoent ",
                                                            "   AND pmdpdocno = pmdodocno ",
                                                            "   AND pmdpseq = pmdoseq ",
                                                            "   AND ",g_wc2_table2 CLIPPED,")"
         END IF    
         #end add-point
         IF NOT cl_null(g_wc2_table3) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdp_t.pmdpseq,pmdp_t.pmdpseq1"
         
         #add-point:單身填充控制 name="b_fill.sql3"
         LET g_wc2_table3 = l_wc2_table3   
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt500_pb3 FROM g_sql
         DECLARE b_fill_cs3 CURSOR FOR apmt500_pb3
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs3 USING g_enterprise,g_pmdl_m.pmdldocno   #(ver:78)
                                               
      FOREACH b_fill_cs3 USING g_enterprise,g_pmdl_m.pmdldocno INTO g_pmdn4_d[l_ac].pmdpsite,g_pmdn4_d[l_ac].pmdpseq, 
          g_pmdn4_d[l_ac].pmdpseq1,g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp002,g_pmdn4_d[l_ac].pmdp003, 
          g_pmdn4_d[l_ac].pmdp004,g_pmdn4_d[l_ac].pmdp005,g_pmdn4_d[l_ac].pmdp006,g_pmdn4_d[l_ac].pmdp007, 
          g_pmdn4_d[l_ac].pmdp008,g_pmdn4_d[l_ac].pmdp009,g_pmdn4_d[l_ac].pmdp010,g_pmdn4_d[l_ac].pmdp011, 
          g_pmdn4_d[l_ac].pmdp012,g_pmdn4_d[l_ac].pmdp021,g_pmdn4_d[l_ac].pmdp022,g_pmdn4_d[l_ac].pmdp023, 
          g_pmdn4_d[l_ac].pmdp024,g_pmdn4_d[l_ac].pmdp025,g_pmdn4_d[l_ac].pmdp026,g_pmdn4_d[l_ac].pmdp001_desc, 
          g_pmdn4_d[l_ac].pmdp022_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill3.fill"
         CALL s_desc_get_item_desc(g_pmdn4_d[l_ac].pmdp001) RETURNING g_pmdn4_d[l_ac].pmdp001_desc,g_pmdn4_d[l_ac].imaal004
         DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp001_desc,g_pmdn4_d[l_ac].imaal004        
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF apmt500_fill_chk(4) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body4.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdmsite,pmdm001,pmdm014,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006, 
             pmdm007,pmdm008,pmdm009 ,t25.ooibl004 FROM pmdm_t",   
                     " INNER JOIN  pmdl_t ON pmdlent = " ||g_enterprise|| " AND pmdldocno = pmdmdocno ",
 
                     "",
                     
                                    " LEFT JOIN ooibl_t t25 ON t25.ooiblent="||g_enterprise||" AND t25.ooibl002=pmdm002 AND t25.ooibl003='"||g_dlang||"' ",
 
                     " WHERE pmdment=? AND pmdmdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body4.fill_sql"
            
         #end add-point
         IF NOT cl_null(g_wc2_table4) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table4 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdm_t.pmdm001"
         
         #add-point:單身填充控制 name="b_fill.sql4"
            
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt500_pb4 FROM g_sql
         DECLARE b_fill_cs4 CURSOR FOR apmt500_pb4
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs4 USING g_enterprise,g_pmdl_m.pmdldocno   #(ver:78)
                                               
      FOREACH b_fill_cs4 USING g_enterprise,g_pmdl_m.pmdldocno INTO g_pmdn6_d[l_ac].pmdmsite,g_pmdn6_d[l_ac].pmdm001, 
          g_pmdn6_d[l_ac].pmdm014,g_pmdn6_d[l_ac].pmdm002,g_pmdn6_d[l_ac].pmdm003,g_pmdn6_d[l_ac].pmdm004, 
          g_pmdn6_d[l_ac].pmdm005,g_pmdn6_d[l_ac].pmdm006,g_pmdn6_d[l_ac].pmdm007,g_pmdn6_d[l_ac].pmdm008, 
          g_pmdn6_d[l_ac].pmdm009,g_pmdn6_d[l_ac].pmdm002_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill4.fill"
                           CALL apmt500_pmdl009_ref(g_pmdn6_d[l_ac].pmdm002) RETURNING g_pmdn6_d[l_ac].pmdm002_desc
         DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm002_desc
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
 
   
   #add-point:browser_fill段其他table處理 name="browser_fill.other_fill"
   #161031-00025#1---s
   #161031-00025#1---s
   LET g_ooff001_d = '6'   #6.單據單頭備註
   LET g_ooff002_d = g_prog
   LET g_ooff003_d = g_pmdl_m.pmdldocno   #单号
   LET g_ooff004_d = 0     #项次
   LET g_ooff005_d = ' '
   LET g_ooff006_d = ' '
   LET g_ooff007_d = ' '
   LET g_ooff008_d = ' '
   LET g_ooff009_d = ' '
   LET g_ooff010_d = ' '
   LET g_ooff011_d = ' '
   CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身 
   #161031-00025#1---e
   #end add-point
   
   CALL g_pmdn_d.deleteElement(g_pmdn_d.getLength())
   CALL g_pmdn2_d.deleteElement(g_pmdn2_d.getLength())
   CALL g_pmdn3_d.deleteElement(g_pmdn3_d.getLength())
   CALL g_pmdn4_d.deleteElement(g_pmdn4_d.getLength())
   CALL g_pmdn6_d.deleteElement(g_pmdn6_d.getLength())
 
   
 
   LET l_ac = g_cnt
   LET g_cnt = 0  
   
   FREE apmt500_pb
   FREE apmt500_pb2
 
   FREE apmt500_pb3
 
   FREE apmt500_pb4
 
 
   
   LET li_idx = l_ac
   
   #遮罩相關處理
   FOR l_ac = 1 TO g_pmdn_d.getLength()
      LET g_pmdn_d_mask_o[l_ac].* =  g_pmdn_d[l_ac].*
      CALL apmt500_pmdn_t_mask()
      LET g_pmdn_d_mask_n[l_ac].* =  g_pmdn_d[l_ac].*
   END FOR
   
   LET g_pmdn2_d_mask_o.* =  g_pmdn2_d.*
   FOR l_ac = 1 TO g_pmdn2_d.getLength()
      LET g_pmdn2_d_mask_o[l_ac].* =  g_pmdn2_d[l_ac].*
      CALL apmt500_pmdn_t_mask()
      LET g_pmdn2_d_mask_n[l_ac].* =  g_pmdn2_d[l_ac].*
   END FOR
   LET g_pmdn3_d_mask_o.* =  g_pmdn3_d.*
   FOR l_ac = 1 TO g_pmdn3_d.getLength()
      LET g_pmdn3_d_mask_o[l_ac].* =  g_pmdn3_d[l_ac].*
      CALL apmt500_pmdo_t_mask()
      LET g_pmdn3_d_mask_n[l_ac].* =  g_pmdn3_d[l_ac].*
   END FOR
   LET g_pmdn4_d_mask_o.* =  g_pmdn4_d.*
   FOR l_ac = 1 TO g_pmdn4_d.getLength()
      LET g_pmdn4_d_mask_o[l_ac].* =  g_pmdn4_d[l_ac].*
      CALL apmt500_pmdp_t_mask()
      LET g_pmdn4_d_mask_n[l_ac].* =  g_pmdn4_d[l_ac].*
   END FOR
   LET g_pmdn6_d_mask_o.* =  g_pmdn6_d.*
   FOR l_ac = 1 TO g_pmdn6_d.getLength()
      LET g_pmdn6_d_mask_o[l_ac].* =  g_pmdn6_d[l_ac].*
      CALL apmt500_pmdm_t_mask()
      LET g_pmdn6_d_mask_n[l_ac].* =  g_pmdn6_d[l_ac].*
   END FOR
 
   
   LET l_ac = li_idx
   
   CALL cl_ap_performance_next_end()
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.delete_b" >}
#+ 刪除單身後其他table連動
PRIVATE FUNCTION apmt500_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"
      
   #end add-point     
   
   #add-point:Function前置處理  name="delete_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1','2',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete"
            
      #end add-point    
      DELETE FROM pmdn_t
       WHERE pmdnent = g_enterprise AND
         pmdndocno = ps_keys_bak[1] AND pmdnseq = ps_keys_bak[2]
      #add-point:delete_b段刪除中 name="delete_b.m_delete"
            
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = ":",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_pmdn_d.deleteElement(li_idx) 
      END IF 
      IF ps_page <> "'2'" THEN 
         CALL g_pmdn2_d.deleteElement(li_idx) 
      END IF 
 
   END IF
   
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete2"
            
      #end add-point    
      DELETE FROM pmdo_t
       WHERE pmdoent = g_enterprise AND
             pmdodocno = ps_keys_bak[1] AND pmdoseq = ps_keys_bak[2] AND pmdoseq1 = ps_keys_bak[3] AND pmdoseq2 = ps_keys_bak[4]
      #add-point:delete_b段刪除中 name="delete_b.m_delete2"
            
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdo_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_pmdn3_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete2"
            
      #end add-point    
   END IF
 
   LET ls_group = "'4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete3"
      IF NOT s_apmt500_upd_pmdb049(ps_keys_bak[1],ps_keys_bak[2],'-1') THEN
         
      END IF      
      #end add-point    
      DELETE FROM pmdp_t
       WHERE pmdpent = g_enterprise AND
             pmdpdocno = ps_keys_bak[1] AND pmdpseq = ps_keys_bak[2] AND pmdpseq1 = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete3"
            
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'4'" THEN 
         CALL g_pmdn4_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete3"
            
      #end add-point    
   END IF
 
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete4"
            
      #end add-point    
      DELETE FROM pmdm_t
       WHERE pmdment = g_enterprise AND
             pmdmdocno = ps_keys_bak[1] AND pmdm001 = ps_keys_bak[2]
      #add-point:delete_b段刪除中 name="delete_b.m_delete4"
            
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdm_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'5'" THEN 
         CALL g_pmdn6_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete4"
            
      #end add-point    
   END IF
 
 
   
 
   
   #add-point:delete_b段other name="delete_b.other"
      
   #end add-point  
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.insert_b" >}
#+ 新增單身後其他table連動
PRIVATE FUNCTION apmt500_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:insert_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"
      
   #end add-point     
   
   #add-point:Function前置處理  name="insert_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1','2',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert"
            
      #end add-point 
      INSERT INTO pmdn_t
                  (pmdnent,
                   pmdndocno,
                   pmdnseq
                   ,pmdnsite,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006,pmdn007,pmdn008,pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015,pmdn016,pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022,pmdnunit,pmdnorga,pmdn049,pmdn051,pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,pmdn027,pmdn028,pmdn029,pmdn030,pmdn053,pmdn025,pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036,pmdn037,pmdn038,pmdn058,pmdn039,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2]
                   ,g_pmdn_d[g_detail_idx].pmdnsite,g_pmdn_d[g_detail_idx].pmdn001,g_pmdn_d[g_detail_idx].pmdn002, 
                       g_pmdn_d[g_detail_idx].pmdn004,g_pmdn_d[g_detail_idx].pmdn005,g_pmdn_d[g_detail_idx].pmdn006, 
                       g_pmdn_d[g_detail_idx].pmdn007,g_pmdn_d[g_detail_idx].pmdn008,g_pmdn_d[g_detail_idx].pmdn009, 
                       g_pmdn_d[g_detail_idx].pmdn024,g_pmdn_d[g_detail_idx].pmdn012,g_pmdn_d[g_detail_idx].pmdn013, 
                       g_pmdn_d[g_detail_idx].pmdn014,g_pmdn_d[g_detail_idx].pmdn045,g_pmdn_d[g_detail_idx].pmdn010, 
                       g_pmdn_d[g_detail_idx].pmdn011,g_pmdn_d[g_detail_idx].pmdn015,g_pmdn_d[g_detail_idx].pmdn016, 
                       g_pmdn_d[g_detail_idx].pmdn017,g_pmdn_d[g_detail_idx].pmdn046,g_pmdn_d[g_detail_idx].pmdn047, 
                       g_pmdn_d[g_detail_idx].pmdn048,g_pmdn_d[g_detail_idx].pmdn023,g_pmdn_d[g_detail_idx].pmdn019, 
                       g_pmdn_d[g_detail_idx].pmdn020,g_pmdn_d[g_detail_idx].pmdn052,g_pmdn_d[g_detail_idx].pmdn021, 
                       g_pmdn_d[g_detail_idx].pmdn022,g_pmdn_d[g_detail_idx].pmdnunit,g_pmdn_d[g_detail_idx].pmdnorga, 
                       g_pmdn_d[g_detail_idx].pmdn049,g_pmdn_d[g_detail_idx].pmdn051,g_pmdn_d[g_detail_idx].pmdn054, 
                       g_pmdn_d[g_detail_idx].pmdn055,g_pmdn_d[g_detail_idx].pmdn056,g_pmdn_d[g_detail_idx].pmdn057, 
                       g_pmdn_d[g_detail_idx].pmdn050,g_pmdn2_d[g_detail_idx].pmdn027,g_pmdn2_d[g_detail_idx].pmdn028, 
                       g_pmdn2_d[g_detail_idx].pmdn029,g_pmdn2_d[g_detail_idx].pmdn030,g_pmdn2_d[g_detail_idx].pmdn053, 
                       g_pmdn2_d[g_detail_idx].pmdn025,g_pmdn2_d[g_detail_idx].pmdn026,g_pmdn2_d[g_detail_idx].pmdn031, 
                       g_pmdn2_d[g_detail_idx].pmdn032,g_pmdn2_d[g_detail_idx].pmdn033,g_pmdn2_d[g_detail_idx].pmdn003, 
                       g_pmdn2_d[g_detail_idx].pmdn036,g_pmdn2_d[g_detail_idx].pmdn037,g_pmdn2_d[g_detail_idx].pmdn038, 
                       g_pmdn2_d[g_detail_idx].pmdn058,g_pmdn2_d[g_detail_idx].pmdn039,g_pmdn2_d[g_detail_idx].pmdn035, 
                       g_pmdn2_d[g_detail_idx].pmdn040,g_pmdn2_d[g_detail_idx].pmdn041,g_pmdn2_d[g_detail_idx].pmdn042, 
                       g_pmdn2_d[g_detail_idx].pmdn043,g_pmdn2_d[g_detail_idx].pmdn044)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert"
            
      #end add-point 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_pmdn_d.insertElement(li_idx) 
      END IF 
      IF ps_page <> "'2'" THEN 
         CALL g_pmdn2_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert"
            
      #end add-point 
   END IF
   
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert2"
            
      #end add-point 
      INSERT INTO pmdo_t
                  (pmdoent,
                   pmdodocno,
                   pmdoseq,pmdoseq1,pmdoseq2
                   ,pmdosite,pmdo003,pmdo001,pmdo002,pmdo004,pmdo005,pmdo006,pmdo028,pmdo029,pmdo011,pmdo012,pmdo013,pmdo010,pmdo014,pmdo009,pmdo015,pmdo016,pmdo017,pmdo040,pmdo019,pmdo020,pmdo021,pmdo030,pmdo031,pmdo022,pmdo023,pmdo024,pmdo032,pmdo033,pmdo034,pmdo025,pmdo026,pmdo027,pmdo041,pmdo042,pmdo043,pmdo044) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4]
                   ,g_pmdn3_d[g_detail_idx].pmdosite,g_pmdn3_d[g_detail_idx].pmdo003,g_pmdn3_d[g_detail_idx].pmdo001, 
                       g_pmdn3_d[g_detail_idx].pmdo002,g_pmdn3_d[g_detail_idx].pmdo004,g_pmdn3_d[g_detail_idx].pmdo005, 
                       g_pmdn3_d[g_detail_idx].pmdo006,g_pmdn3_d[g_detail_idx].pmdo028,g_pmdn3_d[g_detail_idx].pmdo029, 
                       g_pmdn3_d[g_detail_idx].pmdo011,g_pmdn3_d[g_detail_idx].pmdo012,g_pmdn3_d[g_detail_idx].pmdo013, 
                       g_pmdn3_d[g_detail_idx].pmdo010,g_pmdn3_d[g_detail_idx].pmdo014,g_pmdn3_d[g_detail_idx].pmdo009, 
                       g_pmdn3_d[g_detail_idx].pmdo015,g_pmdn3_d[g_detail_idx].pmdo016,g_pmdn3_d[g_detail_idx].pmdo017, 
                       g_pmdn3_d[g_detail_idx].pmdo040,g_pmdn3_d[g_detail_idx].pmdo019,g_pmdn3_d[g_detail_idx].pmdo020, 
                       g_pmdn3_d[g_detail_idx].pmdo021,g_pmdn3_d[g_detail_idx].pmdo030,g_pmdn3_d[g_detail_idx].pmdo031, 
                       g_pmdn3_d[g_detail_idx].pmdo022,g_pmdn3_d[g_detail_idx].pmdo023,g_pmdn3_d[g_detail_idx].pmdo024, 
                       g_pmdn3_d[g_detail_idx].pmdo032,g_pmdn3_d[g_detail_idx].pmdo033,g_pmdn3_d[g_detail_idx].pmdo034, 
                       g_pmdn3_d[g_detail_idx].pmdo025,g_pmdn3_d[g_detail_idx].pmdo026,g_pmdn3_d[g_detail_idx].pmdo027, 
                       g_pmdn3_d[g_detail_idx].pmdo041,g_pmdn3_d[g_detail_idx].pmdo042,g_pmdn3_d[g_detail_idx].pmdo043, 
                       g_pmdn3_d[g_detail_idx].pmdo044)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert2"
            
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdo_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_pmdn3_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert2"
            
      #end add-point
   END IF
 
   LET ls_group = "'4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert3"
            
      #end add-point 
      INSERT INTO pmdp_t
                  (pmdpent,
                   pmdpdocno,
                   pmdpseq,pmdpseq1
                   ,pmdpsite,pmdp001,pmdp002,pmdp003,pmdp004,pmdp005,pmdp006,pmdp007,pmdp008,pmdp009,pmdp010,pmdp011,pmdp012,pmdp021,pmdp022,pmdp023,pmdp024,pmdp025,pmdp026) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_pmdn4_d[g_detail_idx].pmdpsite,g_pmdn4_d[g_detail_idx].pmdp001,g_pmdn4_d[g_detail_idx].pmdp002, 
                       g_pmdn4_d[g_detail_idx].pmdp003,g_pmdn4_d[g_detail_idx].pmdp004,g_pmdn4_d[g_detail_idx].pmdp005, 
                       g_pmdn4_d[g_detail_idx].pmdp006,g_pmdn4_d[g_detail_idx].pmdp007,g_pmdn4_d[g_detail_idx].pmdp008, 
                       g_pmdn4_d[g_detail_idx].pmdp009,g_pmdn4_d[g_detail_idx].pmdp010,g_pmdn4_d[g_detail_idx].pmdp011, 
                       g_pmdn4_d[g_detail_idx].pmdp012,g_pmdn4_d[g_detail_idx].pmdp021,g_pmdn4_d[g_detail_idx].pmdp022, 
                       g_pmdn4_d[g_detail_idx].pmdp023,g_pmdn4_d[g_detail_idx].pmdp024,g_pmdn4_d[g_detail_idx].pmdp025, 
                       g_pmdn4_d[g_detail_idx].pmdp026)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert3"
            
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'4'" THEN 
         CALL g_pmdn4_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert3"
      #更新請購單中的已轉採購量
      IF NOT s_apmt500_upd_pmdb049(ps_keys[1],ps_keys[2],'1') THEN
         
      END IF      
      #end add-point
   END IF
 
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert4"
            
      #end add-point 
      INSERT INTO pmdm_t
                  (pmdment,
                   pmdmdocno,
                   pmdm001
                   ,pmdmsite,pmdm014,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007,pmdm008,pmdm009) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2]
                   ,g_pmdn6_d[g_detail_idx].pmdmsite,g_pmdn6_d[g_detail_idx].pmdm014,g_pmdn6_d[g_detail_idx].pmdm002, 
                       g_pmdn6_d[g_detail_idx].pmdm003,g_pmdn6_d[g_detail_idx].pmdm004,g_pmdn6_d[g_detail_idx].pmdm005, 
                       g_pmdn6_d[g_detail_idx].pmdm006,g_pmdn6_d[g_detail_idx].pmdm007,g_pmdn6_d[g_detail_idx].pmdm008, 
                       g_pmdn6_d[g_detail_idx].pmdm009)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert4"
            
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdm_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'5'" THEN 
         CALL g_pmdn6_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert4"
            
      #end add-point
   END IF
 
 
   
 
   
   #add-point:insert_b段other name="insert_b.other"
      
   #end add-point     
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.update_b" >}
#+ 修改單身後其他table連動
PRIVATE FUNCTION apmt500_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"
   
   #end add-point   
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"
      
   #end add-point   
   
   #add-point:Function前置處理  name="update_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE   
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
   #判斷是否是同一群組的table
   LET ls_group = "'1','2',"
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdn_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update"
            
      #end add-point 
      
      #將遮罩欄位還原
      CALL apmt500_pmdn_t_mask_restore('restore_mask_o')
               
      UPDATE pmdn_t 
         SET (pmdndocno,
              pmdnseq
              ,pmdnsite,pmdn001,pmdn002,pmdn004,pmdn005,pmdn006,pmdn007,pmdn008,pmdn009,pmdn024,pmdn012,pmdn013,pmdn014,pmdn045,pmdn010,pmdn011,pmdn015,pmdn016,pmdn017,pmdn046,pmdn047,pmdn048,pmdn023,pmdn019,pmdn020,pmdn052,pmdn021,pmdn022,pmdnunit,pmdnorga,pmdn049,pmdn051,pmdn054,pmdn055,pmdn056,pmdn057,pmdn050,pmdn027,pmdn028,pmdn029,pmdn030,pmdn053,pmdn025,pmdn026,pmdn031,pmdn032,pmdn033,pmdn003,pmdn036,pmdn037,pmdn038,pmdn058,pmdn039,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044) 
              = 
             (ps_keys[1],ps_keys[2]
              ,g_pmdn_d[g_detail_idx].pmdnsite,g_pmdn_d[g_detail_idx].pmdn001,g_pmdn_d[g_detail_idx].pmdn002, 
                  g_pmdn_d[g_detail_idx].pmdn004,g_pmdn_d[g_detail_idx].pmdn005,g_pmdn_d[g_detail_idx].pmdn006, 
                  g_pmdn_d[g_detail_idx].pmdn007,g_pmdn_d[g_detail_idx].pmdn008,g_pmdn_d[g_detail_idx].pmdn009, 
                  g_pmdn_d[g_detail_idx].pmdn024,g_pmdn_d[g_detail_idx].pmdn012,g_pmdn_d[g_detail_idx].pmdn013, 
                  g_pmdn_d[g_detail_idx].pmdn014,g_pmdn_d[g_detail_idx].pmdn045,g_pmdn_d[g_detail_idx].pmdn010, 
                  g_pmdn_d[g_detail_idx].pmdn011,g_pmdn_d[g_detail_idx].pmdn015,g_pmdn_d[g_detail_idx].pmdn016, 
                  g_pmdn_d[g_detail_idx].pmdn017,g_pmdn_d[g_detail_idx].pmdn046,g_pmdn_d[g_detail_idx].pmdn047, 
                  g_pmdn_d[g_detail_idx].pmdn048,g_pmdn_d[g_detail_idx].pmdn023,g_pmdn_d[g_detail_idx].pmdn019, 
                  g_pmdn_d[g_detail_idx].pmdn020,g_pmdn_d[g_detail_idx].pmdn052,g_pmdn_d[g_detail_idx].pmdn021, 
                  g_pmdn_d[g_detail_idx].pmdn022,g_pmdn_d[g_detail_idx].pmdnunit,g_pmdn_d[g_detail_idx].pmdnorga, 
                  g_pmdn_d[g_detail_idx].pmdn049,g_pmdn_d[g_detail_idx].pmdn051,g_pmdn_d[g_detail_idx].pmdn054, 
                  g_pmdn_d[g_detail_idx].pmdn055,g_pmdn_d[g_detail_idx].pmdn056,g_pmdn_d[g_detail_idx].pmdn057, 
                  g_pmdn_d[g_detail_idx].pmdn050,g_pmdn2_d[g_detail_idx].pmdn027,g_pmdn2_d[g_detail_idx].pmdn028, 
                  g_pmdn2_d[g_detail_idx].pmdn029,g_pmdn2_d[g_detail_idx].pmdn030,g_pmdn2_d[g_detail_idx].pmdn053, 
                  g_pmdn2_d[g_detail_idx].pmdn025,g_pmdn2_d[g_detail_idx].pmdn026,g_pmdn2_d[g_detail_idx].pmdn031, 
                  g_pmdn2_d[g_detail_idx].pmdn032,g_pmdn2_d[g_detail_idx].pmdn033,g_pmdn2_d[g_detail_idx].pmdn003, 
                  g_pmdn2_d[g_detail_idx].pmdn036,g_pmdn2_d[g_detail_idx].pmdn037,g_pmdn2_d[g_detail_idx].pmdn038, 
                  g_pmdn2_d[g_detail_idx].pmdn058,g_pmdn2_d[g_detail_idx].pmdn039,g_pmdn2_d[g_detail_idx].pmdn035, 
                  g_pmdn2_d[g_detail_idx].pmdn040,g_pmdn2_d[g_detail_idx].pmdn041,g_pmdn2_d[g_detail_idx].pmdn042, 
                  g_pmdn2_d[g_detail_idx].pmdn043,g_pmdn2_d[g_detail_idx].pmdn044) 
         WHERE pmdnent = g_enterprise AND pmdndocno = ps_keys_bak[1] AND pmdnseq = ps_keys_bak[2]
      #add-point:update_b段修改中 name="update_b.m_update"
            
      #end add-point   
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdn_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdn_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
 
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt500_pmdn_t_mask_restore('restore_mask_n')
               
      #add-point:update_b段修改後 name="update_b.after_update"
            
      #end add-point  
   END IF
   
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
   
   
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdo_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update2"
            
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt500_pmdo_t_mask_restore('restore_mask_o')
               
      UPDATE pmdo_t 
         SET (pmdodocno,
              pmdoseq,pmdoseq1,pmdoseq2
              ,pmdosite,pmdo003,pmdo001,pmdo002,pmdo004,pmdo005,pmdo006,pmdo028,pmdo029,pmdo011,pmdo012,pmdo013,pmdo010,pmdo014,pmdo009,pmdo015,pmdo016,pmdo017,pmdo040,pmdo019,pmdo020,pmdo021,pmdo030,pmdo031,pmdo022,pmdo023,pmdo024,pmdo032,pmdo033,pmdo034,pmdo025,pmdo026,pmdo027,pmdo041,pmdo042,pmdo043,pmdo044) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4]
              ,g_pmdn3_d[g_detail_idx].pmdosite,g_pmdn3_d[g_detail_idx].pmdo003,g_pmdn3_d[g_detail_idx].pmdo001, 
                  g_pmdn3_d[g_detail_idx].pmdo002,g_pmdn3_d[g_detail_idx].pmdo004,g_pmdn3_d[g_detail_idx].pmdo005, 
                  g_pmdn3_d[g_detail_idx].pmdo006,g_pmdn3_d[g_detail_idx].pmdo028,g_pmdn3_d[g_detail_idx].pmdo029, 
                  g_pmdn3_d[g_detail_idx].pmdo011,g_pmdn3_d[g_detail_idx].pmdo012,g_pmdn3_d[g_detail_idx].pmdo013, 
                  g_pmdn3_d[g_detail_idx].pmdo010,g_pmdn3_d[g_detail_idx].pmdo014,g_pmdn3_d[g_detail_idx].pmdo009, 
                  g_pmdn3_d[g_detail_idx].pmdo015,g_pmdn3_d[g_detail_idx].pmdo016,g_pmdn3_d[g_detail_idx].pmdo017, 
                  g_pmdn3_d[g_detail_idx].pmdo040,g_pmdn3_d[g_detail_idx].pmdo019,g_pmdn3_d[g_detail_idx].pmdo020, 
                  g_pmdn3_d[g_detail_idx].pmdo021,g_pmdn3_d[g_detail_idx].pmdo030,g_pmdn3_d[g_detail_idx].pmdo031, 
                  g_pmdn3_d[g_detail_idx].pmdo022,g_pmdn3_d[g_detail_idx].pmdo023,g_pmdn3_d[g_detail_idx].pmdo024, 
                  g_pmdn3_d[g_detail_idx].pmdo032,g_pmdn3_d[g_detail_idx].pmdo033,g_pmdn3_d[g_detail_idx].pmdo034, 
                  g_pmdn3_d[g_detail_idx].pmdo025,g_pmdn3_d[g_detail_idx].pmdo026,g_pmdn3_d[g_detail_idx].pmdo027, 
                  g_pmdn3_d[g_detail_idx].pmdo041,g_pmdn3_d[g_detail_idx].pmdo042,g_pmdn3_d[g_detail_idx].pmdo043, 
                  g_pmdn3_d[g_detail_idx].pmdo044) 
         WHERE pmdoent = g_enterprise AND pmdodocno = ps_keys_bak[1] AND pmdoseq = ps_keys_bak[2] AND pmdoseq1 = ps_keys_bak[3] AND pmdoseq2 = ps_keys_bak[4]
      #add-point:update_b段修改中 name="update_b.m_update2"
            
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdo_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdo_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt500_pmdo_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update2"
            
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdp_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update3"
            
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt500_pmdp_t_mask_restore('restore_mask_o')
               
      UPDATE pmdp_t 
         SET (pmdpdocno,
              pmdpseq,pmdpseq1
              ,pmdpsite,pmdp001,pmdp002,pmdp003,pmdp004,pmdp005,pmdp006,pmdp007,pmdp008,pmdp009,pmdp010,pmdp011,pmdp012,pmdp021,pmdp022,pmdp023,pmdp024,pmdp025,pmdp026) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_pmdn4_d[g_detail_idx].pmdpsite,g_pmdn4_d[g_detail_idx].pmdp001,g_pmdn4_d[g_detail_idx].pmdp002, 
                  g_pmdn4_d[g_detail_idx].pmdp003,g_pmdn4_d[g_detail_idx].pmdp004,g_pmdn4_d[g_detail_idx].pmdp005, 
                  g_pmdn4_d[g_detail_idx].pmdp006,g_pmdn4_d[g_detail_idx].pmdp007,g_pmdn4_d[g_detail_idx].pmdp008, 
                  g_pmdn4_d[g_detail_idx].pmdp009,g_pmdn4_d[g_detail_idx].pmdp010,g_pmdn4_d[g_detail_idx].pmdp011, 
                  g_pmdn4_d[g_detail_idx].pmdp012,g_pmdn4_d[g_detail_idx].pmdp021,g_pmdn4_d[g_detail_idx].pmdp022, 
                  g_pmdn4_d[g_detail_idx].pmdp023,g_pmdn4_d[g_detail_idx].pmdp024,g_pmdn4_d[g_detail_idx].pmdp025, 
                  g_pmdn4_d[g_detail_idx].pmdp026) 
         WHERE pmdpent = g_enterprise AND pmdpdocno = ps_keys_bak[1] AND pmdpseq = ps_keys_bak[2] AND pmdpseq1 = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update3"
            
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdp_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdp_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt500_pmdp_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update3"
            
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdm_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update4"
            
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt500_pmdm_t_mask_restore('restore_mask_o')
               
      UPDATE pmdm_t 
         SET (pmdmdocno,
              pmdm001
              ,pmdmsite,pmdm014,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007,pmdm008,pmdm009) 
              = 
             (ps_keys[1],ps_keys[2]
              ,g_pmdn6_d[g_detail_idx].pmdmsite,g_pmdn6_d[g_detail_idx].pmdm014,g_pmdn6_d[g_detail_idx].pmdm002, 
                  g_pmdn6_d[g_detail_idx].pmdm003,g_pmdn6_d[g_detail_idx].pmdm004,g_pmdn6_d[g_detail_idx].pmdm005, 
                  g_pmdn6_d[g_detail_idx].pmdm006,g_pmdn6_d[g_detail_idx].pmdm007,g_pmdn6_d[g_detail_idx].pmdm008, 
                  g_pmdn6_d[g_detail_idx].pmdm009) 
         WHERE pmdment = g_enterprise AND pmdmdocno = ps_keys_bak[1] AND pmdm001 = ps_keys_bak[2]
      #add-point:update_b段修改中 name="update_b.m_update4"
            
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdm_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdm_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt500_pmdm_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update4"
            
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
 
   
 
   
   #add-point:update_b段other name="update_b.other"
      
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.key_update_b" >}
#+ 上層單身key欄位變動後, 連帶修正下層單身key欄位
PRIVATE FUNCTION apmt500_key_update_b(ps_keys_bak,ps_table)
   #add-point:update_b段define(客製用) name="key_update_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_key       DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_update_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_update_b.pre_function"
   
   #end add-point
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.key_delete_b" >}
#+ 上層單身刪除後, 連帶刪除下層單身key欄位
PRIVATE FUNCTION apmt500_key_delete_b(ps_keys_bak,ps_table)
   #add-point:delete_b段define(客製用) name="key_delete_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_delete_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_delete_b.pre_function"
   
   #end add-point
   
 
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.lock_b" >}
#+ 連動lock其他單身table資料
PRIVATE FUNCTION apmt500_lock_b(ps_table,ps_page)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"
   
   #end add-point   
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"
      
   #end add-point   
   
   #add-point:Function前置處理  name="lock_b.pre_function"
   
   #end add-point
    
   #先刷新資料
   #CALL apmt500_b_fill()
   
   #鎖定整組table
   #LET ls_group = "'1','2',"
   #僅鎖定自身table
   LET ls_group = "pmdn_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN apmt500_bcl USING g_enterprise,
                                       g_pmdl_m.pmdldocno,g_pmdn_d[g_detail_idx].pmdnseq     
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt500_bcl:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
                                    
   #鎖定整組table
   #LET ls_group = "'3',"
   #僅鎖定自身table
   LET ls_group = "pmdo_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt500_bcl2 USING g_enterprise,
                                             g_pmdl_m.pmdldocno,g_pmdn3_d[g_detail_idx].pmdoseq,g_pmdn3_d[g_detail_idx].pmdoseq1, 
                                                 g_pmdn3_d[g_detail_idx].pmdoseq2
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt500_bcl2:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'4',"
   #僅鎖定自身table
   LET ls_group = "pmdp_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt500_bcl3 USING g_enterprise,
                                             g_pmdl_m.pmdldocno,g_pmdn4_d[g_detail_idx].pmdpseq,g_pmdn4_d[g_detail_idx].pmdpseq1 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt500_bcl3:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'5',"
   #僅鎖定自身table
   LET ls_group = "pmdm_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt500_bcl4 USING g_enterprise,
                                             g_pmdl_m.pmdldocno,g_pmdn6_d[g_detail_idx].pmdm001
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt500_bcl4:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
 
   
 
   
   #add-point:lock_b段other name="lock_b.other"
      
   #end add-point  
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.unlock_b" >}
#+ 連動unlock其他單身table資料
PRIVATE FUNCTION apmt500_unlock_b(ps_table,ps_page)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"
   
   #end add-point  
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"
      
   #end add-point  
   
   #add-point:Function前置處理  name="unlock_b.pre_function"
   
   #end add-point
    
   LET ls_group = "'1','2',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt500_bcl
   END IF
   
   LET ls_group = "'3',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt500_bcl2
   END IF
 
   LET ls_group = "'4',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt500_bcl3
   END IF
 
   LET ls_group = "'5',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt500_bcl4
   END IF
 
 
   
 
 
   #add-point:unlock_b段other name="unlock_b.other"
      
   #end add-point  
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_entry" >}
#+ 單頭欄位開啟設定
PRIVATE FUNCTION apmt500_set_entry(p_cmd)
   #add-point:set_entry段define(客製用) name="set_entry.define_customerization"
   
   #end add-point       
   DEFINE p_cmd   LIKE type_t.chr1  
   #add-point:set_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry.define"
      
   #end add-point       
   
   #add-point:Function前置處理  name="set_entry.pre_function"
   
   #end add-point
   
   CALL cl_set_comp_entry("pmdldocno",TRUE)
   
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("pmdldocno",TRUE)
      CALL cl_set_comp_entry("pmdldocdt",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry段欄位控制 name="set_entry.field_control"
                  CALL cl_set_comp_entry("pmdldocdt",TRUE)
      #end add-point  
   END IF
   
   #add-point:set_entry段欄位控制後 name="set_entry.after_control"
   
   CALL cl_set_comp_entry("pmdl002,pmdl003,pmdl004,pmdl005",TRUE)
   CALL cl_set_comp_entry("pmdl006,pmdl007,pmdl008,pmdl009,pmdl010",TRUE)
   CALL cl_set_comp_entry("pmdl011,pmdl015",TRUE)   
   CALL cl_set_comp_entry("pmdl016,pmdl017,pmdl018,pmdl019,pmdl020",TRUE)
   CALL cl_set_comp_entry("pmdl021,pmdl022,pmdl023,pmdl024,pmdl025",TRUE)
   CALL cl_set_comp_entry("pmdl026,pmdl027,pmdl029",TRUE)
   CALL cl_set_comp_entry("pmdl032,pmdl033",TRUE)
   CALL cl_set_comp_entry("pmdl043,pmdl044,pmdl046",TRUE)
   CALL cl_set_comp_entry("pmdl051,pmdl052,pmdl053,pmdl054,pmdl055",TRUE)
   
   CALL cl_set_comp_entry("pmdnunit,pmdnorga,pmdn015",TRUE)
                                 
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_no_entry" >}
#+ 單頭欄位關閉設定
PRIVATE FUNCTION apmt500_set_no_entry(p_cmd)
   #add-point:set_no_entry段define(客製用) name="set_no_entry.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry.define"
   DEFINE l_fields  STRING
   DEFINE l_n       LIKE type_t.num10
   #end add-point     
   
   #add-point:Function前置處理  name="set_no_entry.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("pmdldocno",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry段欄位控制 name="set_no_entry.field_control"
      #CALL cl_set_comp_entry("pmdldocdt",FALSE)
      #end add-point 
   END IF 
   
   IF p_cmd = 'u' THEN  #docno,ld欄位確認是絕對關閉
      CALL cl_set_comp_entry("pmdldocno",FALSE)
   END IF 
 
#  IF p_cmd = 'u' THEN  #docdt欄位依照設定關閉(FALSE則為設定不同意修正) #(ver:78)
      IF NOT cl_chk_update_docdt() THEN
         CALL cl_set_comp_entry("pmdldocdt",FALSE)
      END IF
#  END IF 
   
   #add-point:set_no_entry段欄位控制後 name="set_no_entry.after_control"
         #IF g_flag THEN
   #   CALL cl_set_comp_entry("pmdldocno,pmdldocdt",FALSE)
   #END IF
   
   IF g_argv[1] MATCHES '[12]' THEN  #委外採購單
      CALL cl_set_comp_entry("pmdl005,pmdl007",FALSE)
   END IF
   
   IF g_argv[1] MATCHES '[4]' THEN  #借貨採購單
      CALL cl_set_comp_entry("pmdl005",FALSE)
   END IF
   
   
   #單頭"多角性質"=3.代採購指定供應商時,最終供應商栏位才開放輸入,否則由系統清為空白.
   IF g_pmdl_m.pmdl006 != '3' THEN
      CALL cl_set_comp_entry("pmdl052",FALSE)
      LET g_pmdl_m.pmdl052 = ''
   END IF
   
   #單頭"多角性質"='7'點對點時,兩角目的據點欄位才可維護
   IF g_pmdl_m.pmdl006 != '7' THEN
      CALL cl_set_comp_entry("pmdl053",FALSE)
      LET g_pmdl_m.pmdl053 = ''
   END IF
   
   #單頭"多角性質"([T:採購單頭檔].[C:多角性質])=2.代採購或3.代採購指定供應商時,多角流程代碼欄位才允許輸入
   IF g_pmdl_m.pmdl006 NOT MATCHES '[23]' THEN
      CALL cl_set_comp_entry("pmdl051",FALSE)
      LET g_pmdl_m.pmdl051 = ''
   END IF
   
   IF NOT g_flag1 THEN
      CALL cl_set_comp_entry("pmdl046",FALSE)
   ELSE
      CALL cl_set_comp_entry("pmdl002,pmdl003,pmdl004,pmdl005",FALSE)
      CALL cl_set_comp_entry("pmdl006,pmdl007,pmdl008,pmdl009,pmdl010",FALSE)
      CALL cl_set_comp_entry("pmdl011,pmdl015",FALSE)
      CALL cl_set_comp_entry("pmdl016,pmdl017,pmdl018,pmdl019,pmdl020",FALSE)
      CALL cl_set_comp_entry("pmdl021,pmdl022,pmdl023,pmdl024,pmdl025",FALSE)
      CALL cl_set_comp_entry("pmdl026,pmdl027,pmdl029,pmdl030",FALSE)
      CALL cl_set_comp_entry("pmdl031,pmdl032,pmdl033",FALSE)
      CALL cl_set_comp_entry("pmdl040",FALSE)
      CALL cl_set_comp_entry("pmdl041,pmdl044,pmdl047,pmdl048,pmdl049",FALSE)
      CALL cl_set_comp_entry("pmdl051,pmdl052,pmdl053,pmdl054,pmdl055",FALSE)
      
   END IF
   
   IF g_pmdl_m.pmdl007 ='8' AND (NOT cl_null(g_pmdl_m.pmdl008)) THEN
      CALL cl_set_comp_entry("pmdl004,pmdl005",FALSE)
      CALL cl_set_comp_entry("pmdl006,pmdl009,pmdl010",FALSE)
      CALL cl_set_comp_entry("pmdl011,pmdl012,pmdl013,pmdl015",FALSE)
      CALL cl_set_comp_entry("pmdl016,pmdl017,pmdl018,pmdl019,pmdl020",FALSE)
      CALL cl_set_comp_entry("pmdl021,pmdl022,pmdl023,pmdl024,pmdl025",FALSE)
      CALL cl_set_comp_entry("pmdl026,pmdl027,pmdl028,pmdl029,pmdl030",FALSE)
      CALL cl_set_comp_entry("pmdl031,pmdl032,pmdl033",FALSE)
      CALL cl_set_comp_entry("pmdl040",FALSE)
      CALL cl_set_comp_entry("pmdl041,pmdl042,pmdl043,pmdl044",FALSE)
      CALL cl_set_comp_entry("pmdl046,pmdl047,pmdl048,pmdl049",FALSE)
      CALL cl_set_comp_entry("pmdl051,pmdl052,pmdl053,pmdl054,pmdl055",FALSE)
   
   END IF
   CALL cl_set_comp_entry("pmdl043",FALSE)

   #當單頭多角性質為"5:統購自付"時,收貨據點才可維護
   IF g_pmdl_m.pmdl006 <> '5' THEN
      CALL cl_set_comp_entry("pmdnunit,pmdnorga",FALSE)
      IF l_ac > 0 THEN  #防止數組溢出
         LET g_pmdn_d[l_ac].pmdnunit = g_site
         LET g_pmdn_d[l_ac].pmdnorga = g_site
      END IF
   END IF
   
   #依單據別設定判斷欄位是否需要做輸入控制
   IF NOT cl_null(g_pmdl_m.pmdldocno) THEN
      LET l_fields = ''
      CALL s_aooi200_get_doc_fields(g_site,'1',g_pmdl_m.pmdldocno) RETURNING l_fields
      CALL cl_set_comp_entry(l_fields,FALSE)
   END IF
   
   #若單身已有資料，則來源數據類型、來源單號都不可修改
   SELECT COUNT(1) INTO l_n FROM pmdp_t WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
   IF l_n > 0 THEN
      CALL cl_set_comp_entry("pmdl007,pmdl008",FALSE)
   END IF
   
   #131121-00001#34---s---
   #重覆性生产来源单号不可输入
   IF g_argv[1] MATCHES '[2]' THEN  #委外採購單
      CALL cl_set_comp_entry("pmdl008",FALSE)
   END IF
   #131121-00001#34---e---
   
   #160805-00071#1--s
   #來源單號：資料來源類型="8"時，才可維護
   #單據修改時，資料來源類型不為"1,8"時，"資料來源類型"、"來源單號"都不可維護
   IF g_pmdl_m.pmdl007 <> '8' THEN
      CALL cl_set_comp_entry("pmdl008",FALSE)
   END IF
   IF p_cmd = 'u' THEN
      IF g_pmdl_m.pmdl007 NOT MATCHES '[18]' THEN
         CALL cl_set_comp_entry("pmdl007,pmdl008",FALSE)
      END IF
   END IF 
   #160805-00071#1--e
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_entry_b" >}
#+ 單身欄位開啟設定
PRIVATE FUNCTION apmt500_set_entry_b(p_cmd)
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
      
   #end add-point     
   
   #add-point:Function前置處理  name="set_entry_b.pre_function"
   
   #end add-point
    
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("",TRUE)
      #add-point:set_entry段欄位控制 name="set_entry_b.field_control"
      
      #end add-point  
   END IF
   
   #add-point:set_entry_b段 name="set_entry_b.set_entry_b"
   CALL cl_set_comp_entry("pmdm001,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006",TRUE)
   
   CALL cl_set_comp_entry("pmdnseq,pmdnunit,pmdnorga",TRUE)
   CALL cl_set_comp_entry("pmdn001,pmdn002,pmdn003,pmdn004,pmdn005",TRUE)
   CALL cl_set_comp_entry("pmdn006,pmdn007,pmdn009,pmdn010",TRUE)
   CALL cl_set_comp_entry("pmdn011,pmdn012,pmdn013,pmdn014,pmdn015",TRUE)
   CALL cl_set_comp_entry("pmdn016,pmdn019",TRUE)
   CALL cl_set_comp_entry("pmdn021,pmdn022,pmdn023,pmdn024,pmdn025",TRUE)
   CALL cl_set_comp_entry("pmdn026,pmdn027,pmdn028,pmdn029,pmdn030",TRUE)
   CALL cl_set_comp_entry("pmdn031,pmdn032,pmdn033",TRUE)
   CALL cl_set_comp_entry("pmdn036,pmdn037,pmdn038,pmdn039",TRUE)
   CALL cl_set_comp_entry("pmdn049,pmdn050,pmdn053",TRUE)
                           
   CALL cl_set_comp_entry("l_pmao009,l_pmao010",TRUE)
   
   #ming 20150903 add ------------------------------(S)  
   #科目預算 
   CALL cl_set_comp_entry("pmdn058",TRUE)
   #ming 20150903 add ------------------------------(E) 
   CALL cl_set_comp_entry("pmdpseq",TRUE)   
   #end add-point  
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_no_entry_b" >}
#+ 單身欄位關閉設定
PRIVATE FUNCTION apmt500_set_no_entry_b(p_cmd)
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"
   
   #end add-point    
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   DEFINE l_imaa005   LIKE imaa_t.imaa005
   DEFINE l_imaf015   LIKE imaf_t.imaf015
   DEFINE l_imaf144   LIKE imaf_t.imaf144
   DEFINE l_n         LIKE type_t.num5
   DEFINE l_inaa007   LIKE inaa_t.inaa007
   DEFINE l_imaf061   LIKE imaf_t.imaf061
   DEFINE l_imaf055   LIKE imaf_t.imaf055 
   
   #ming 20150903 add -------------------(S) 
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_slip      LIKE pmdl_t.pmdldocno
   #ming 20150903 add -------------------(E) 
   #161006-00018#7---s
   DEFINE l_pmdb038   LIKE pmdb_t.pmdb038
   DEFINE l_pmdb039   LIKE pmdb_t.pmdb039
   #161006-00018#7---e
   #end add-point    
   
   #add-point:Function前置處理  name="set_no_entry_b.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"
      
      #end add-point 
   END IF 
   
   #add-point:set_no_entry_b段 name="set_no_entry_b.set_no_entry_b"
   IF (NOT cl_null(g_pmdn6_d_t.pmdm007)) AND (g_pmdn6_d_t.pmdm008> 0 OR g_pmdn6_d_t.pmdm009 > 0) THEN
      CALL cl_set_comp_entry("pmdm001,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006",FALSE)
   END IF
   
   #委外、重覆性生產，若有來源單據，則料號等欄位不可修改
   IF g_argv[1] MATCHES '[12]' THEN
      LET l_n = 0
      SELECT COUNT(1) INTO l_n FROM pmdp_t 
         WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
      IF (NOT cl_null(g_pmdl_m.pmdl008)) OR l_n > 0 THEN
          CALL cl_set_comp_entry("pmdn001,pmdn002,pmdn004,pmdn005",FALSE)
       END IF
   END IF
   
   #料件不使用產品特徵時，產品特徵欄位不可錄入
   LET l_imaa005 = ''
   CALL apmt500_get_imaa005(g_enterprise,g_pmdn_d[l_ac].pmdn001) RETURNING l_imaa005
   IF cl_null(l_imaa005) THEN
      CALL cl_set_comp_entry("pmdn002",FALSE)
      LET g_pmdn_d[l_ac].pmdn002 = ' '
   ELSE
      IF cl_null(g_pmdn_d[l_ac].pmdn002) THEN
         LET g_pmdn_d[l_ac].pmdn002 = ''
      END IF
   END IF
   
   #當料件主檔設置要做參考單位管理時，則參考数量允許輸入，不允許空白
   LET l_imaf015 = ''
   LET l_imaf144 = ''
   LET l_imaf061 = ''
   LET l_imaf055 = ''
   SELECT imaf015,imaf144,imaf061,imaf055 INTO l_imaf015,l_imaf144,l_imaf061,l_imaf055 FROM imaf_t WHERE imafent = g_enterprise AND imaf001 = g_pmdn_d[l_ac].pmdn001 AND imafsite = g_site
   IF cl_null(l_imaf015) THEN
      CALL cl_set_comp_entry("pmdn009",FALSE)
      LET g_pmdn_d[l_ac].pmdn008 = ''
      LET g_pmdn_d[l_ac].pmdn008_desc = ''
      LET g_pmdn_d[l_ac].pmdn009 = '' 
   END IF 
   
   #[T:料件據點進銷存檔].[C:庫存批號控管]=2時,[C:不可有批號]欄位不可輸入
   IF l_imaf061 = '2' THEN
      CALL cl_set_comp_entry("pmdn030",FALSE)
      LET g_pmdn2_d[l_ac].pmdn030 = ' '
   END IF
   
   #若設定imaf055(庫存管理特徵)等於'2.不可有庫存管理特徵'時，則[C:庫存管理特徵]欄位不可輸入
   IF l_imaf055 = '2' THEN
      CALL cl_set_comp_entry("pmdn053",FALSE)
      LET g_pmdn2_d[l_ac].pmdn053 = ''
   END IF

   IF g_pmdn_d[l_ac].pmdn024 = 'Y' THEN
      CALL cl_set_comp_entry("pmdn012,pmdn013,pmdn014",FALSE)
      #LET g_pmdn_d[l_ac].pmdn012 = ''
      #LET g_pmdn_d[l_ac].pmdn013 = ''
      #LET g_pmdn_d[l_ac].pmdn014 = ''
   END IF
   #料件不使用計價單位時，計價單位、計價數量不可維護
   IF cl_null(l_imaf144) THEN
      CALL cl_set_comp_entry("pmdn010,pmdn011",FALSE)
      LET g_pmdn_d[l_ac].pmdn010 = g_pmdn_d[l_ac].pmdn006
      LET g_pmdn_d[l_ac].pmdn010_desc = g_pmdn_d[l_ac].pmdn006_desc
      LET g_pmdn_d[l_ac].pmdn011 = g_pmdn_d[l_ac].pmdn007
   END IF
   
   #若1.正常稅率，則單身稅別不可輸入
   IF g_tax_app = '1' THEN
      CALL cl_set_comp_entry("pmdn016",FALSE)
   END IF
   #單頭取價方式的基本資料設置不允許修改單價 , 未取到價格不允許人工輸入
   IF (g_pmdn2_d[l_ac].pmdn043 > 0 OR g_pmam002 <> 'Y') AND g_pmam003 <> 'Y' THEN
      CALL cl_set_comp_entry("pmdn015",FALSE)
   END IF
   
   #庫位不使用儲位管理時，儲位不可維護
   SELECT inaa007 INTO l_inaa007 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_pmdn2_d[l_ac].pmdn028
   IF l_inaa007 = '5' THEN
      CALL cl_set_comp_entry("pmdn029",FALSE)
      LET g_pmdn2_d[l_ac].pmdn029 = ' '
      LET g_pmdn2_d[l_ac].pmdn029_desc = ''
   END IF

   #單價含稅時，可錄入含稅金額，
   IF g_pmdl_m.pmdl013 = 'Y' THEN
      CALL cl_set_comp_entry("pmdm005",FALSE)
   ELSE
      CALL cl_set_comp_entry("pmdm006",FALSE)
   END IF
   
   #當是VMI採購單時庫存管理特徵固定預設供應商編號，且不可以修改 
   IF g_pmdl_m.pmdl005 = '3' THEN
      LET g_pmdn2_d[l_ac].pmdn053 = g_pmdl_m.pmdl004
      CALL cl_set_comp_entry("pmdn053",FALSE)
   END IF
   
   #當單頭多角性質為"5:統購自付"時,收貨據點才可維護
   IF g_pmdl_m.pmdl006 NOT MATCHES '[45]' THEN   #150814 earl mod
      CALL cl_set_comp_entry("pmdnunit,pmdnorga",FALSE)
      LET g_pmdn_d[l_ac].pmdnunit = g_site
      LET g_pmdn_d[l_ac].pmdnorga = g_site
   END IF
   
   #子特性是樣品時，單價为0
   IF g_pmdn_d[l_ac].pmdn019 = '9' THEN
      CALL cl_set_comp_entry("pmdn015",FALSE)
   END IF
   
   IF g_pmdl_m.pmdl007 ='8' AND (NOT cl_null(g_pmdl_m.pmdl008)) THEN
      CALL cl_set_comp_entry("pmdnseq,pmdnunit,pmdnorga",FALSE)
      CALL cl_set_comp_entry("pmdn001,pmdn002,pmdn003,pmdn004,pmdn005",FALSE)
      CALL cl_set_comp_entry("pmdn006,pmdn008,pmdn010",FALSE)
      CALL cl_set_comp_entry("pmdn012,pmdn013,pmdn014,pmdn015",FALSE)
      CALL cl_set_comp_entry("pmdn016,pmdn017,pmdn019,pmdn020",FALSE)
      CALL cl_set_comp_entry("pmdn021,pmdn022,pmdn023,pmdn024,pmdn025",FALSE)
      CALL cl_set_comp_entry("pmdn026,pmdn027,pmdn028,pmdn029,pmdn030",FALSE)
      CALL cl_set_comp_entry("pmdn031,pmdn032,pmdn033,pmdn035",FALSE)
      CALL cl_set_comp_entry("pmdn036,pmdn037,pmdn038,pmdn039",FALSE)
      CALL cl_set_comp_entry("pmdn040,pmdn041,pmdn042,pmdn043,pmdn044,pmdn045",FALSE)
      CALL cl_set_comp_entry("pmdn046,pmdn047,pmdn048,pmdn049,pmdn050",FALSE)
      CALL cl_set_comp_entry("pmdn052,pmdn053",FALSE)
   
   END IF
   
   IF  g_pmao_flag = 'Y' THEN
   ELSE
      CALL cl_set_comp_entry("l_pmao009,l_pmao010",FALSE)
   END IF 
   
   #來源請購單有專案編號、WBS、項目編號時，採購單的不可修改
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmdp_t,pmdb_t 
      WHERE pmdpent = pmdbent AND pmdp003 = pmdbdocno AND pmdp004 = pmdbseq
        AND pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d[l_ac].pmdnseq 
        AND pmdb034 IS NOT NULL
   IF l_n > 0 THEN
      CALL cl_set_comp_entry("pmdn036",FALSE)
   END IF
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmdp_t,pmdb_t 
      WHERE pmdpent = pmdbent AND pmdp003 = pmdbdocno AND pmdp004 = pmdbseq
        AND pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d[l_ac].pmdnseq 
        AND pmdb035 IS NOT NULL
   IF l_n > 0 THEN
      CALL cl_set_comp_entry("pmdn037",FALSE)
   END IF
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmdp_t,pmdb_t 
      WHERE pmdpent = pmdbent AND pmdp003 = pmdbdocno AND pmdp004 = pmdbseq
        AND pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d[l_ac].pmdnseq 
        AND pmdb036 IS NOT NULL
   IF l_n > 0 THEN
      CALL cl_set_comp_entry("pmdn038",FALSE)
   END IF
   
   IF (NOT cl_null(g_pmdl_m.pmdl008)) OR l_n > 0 THEN
      CALL cl_set_comp_entry("pmdn001,pmdn002,pmdn004,pmdn005",FALSE)
   END IF
   
   #ming 20150903 add --------------------------------(S) 
   CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
        RETURNING l_success,l_slip
   IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'N' THEN
      CALL cl_set_comp_entry('pmdn058',FALSE)
   END IF
   #ming 20150903 add --------------------------------(E) 
   
   #161006-00018#7---s
   IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-MFG-0085') = "N" THEN
      SELECT pmdb038,pmdb039 INTO l_pmdb038,l_pmdb039 FROM pmdp_t,pmdb_t 
         WHERE pmdpent = pmdbent AND pmdp003 = pmdbdocno AND pmdp004 = pmdbseq
           AND pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno AND pmdpseq = g_pmdn_d[l_ac].pmdnseq 
      IF NOT cl_null(l_pmdb038) THEN
         CALL cl_set_comp_entry("pmdn028",FALSE)   
      END IF
      IF l_pmdb039 IS NOT NULL THEN
         CALL cl_set_comp_entry("pmdn029",FALSE)   
      END IF      
   END IF
   #161006-00018#7---e
   
   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("pmdpseq",FALSE)   
   END IF
   
   
   #end add-point     
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_act_visible" >}
#+ 單頭權限開啟
PRIVATE FUNCTION apmt500_set_act_visible()
   #add-point:set_act_visible段define(客製用) name="set_act_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible.define"
   
   #end add-point   
   #add-point:set_act_visible段 name="set_act_visible.set_act_visible"
   CALL cl_set_act_visible("modify,query,delete,open_pmdm,open_apmt500_01,open_apmi004_01,modify_detail,reproduce,open_apmt500_03,bpm_status,get_detail_price,hold", TRUE)
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_act_no_visible" >}
#+ 單頭權限關閉
PRIVATE FUNCTION apmt500_set_act_no_visible()
   #add-point:set_act_no_visible段define(客製用) name="set_act_no_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible.define"
   DEFINE l_pmaa004  LIKE pmaa_t.pmaa004
   DEFINE l_n        LIKE type_t.num5
   DEFINE l_ooba002  LIKE ooba_t.ooba002
   DEFINE l_success  LIKE type_t.num5
   #end add-point   
   #add-point:set_act_no_visible段 name="set_act_no_visible.set_act_no_visible"

   IF g_pmdl_m.pmdlstus NOT MATCHES '[NDR]' THEN  # N未確認/D抽單/R已拒絕允許修改
      CALL cl_set_act_visible("modify,delete,open_pmdm,open_apmt500_01,modify_detail,get_detail_price", FALSE)
   END IF
   
   IF g_pmdl_m.pmdlstus NOT MATCHES '[NDR]' THEN  # N未確認/D抽單/R已拒絕允許修改
      CALL cl_set_act_visible("open_apmt500_03", FALSE)
   END IF
   
   
   IF NOT cl_bpm_chk() THEN    #此單據不需提交至BPM，則隱藏按鈕 
       CALL cl_set_act_visible("bpm_status",FALSE)
   END IF

   
   IF NOT cl_null(g_pmdl_m.pmdl004) THEN
       LET l_pmaa004 = ''
       SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmdl_m.pmdl004
       IF l_pmaa004 NOT MATCHES '[24]' THEN
          CALL cl_set_act_visible("open_apmi004_01", FALSE)
       END IF
    ELSE
       CALL cl_set_act_visible("open_apmi004_01", FALSE)
    END IF
    
    #請采勾稽時，或者有來源單據的時候，不提供複製功能，因為來源單據的資料不一樣
    CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
    IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
       CALL cl_set_act_visible("reproduce", FALSE)
    END IF
    
    LET l_n = 0
    SELECT COUNT(1) INTO l_n FROM pmdp_t WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
    IF l_n > 0 OR g_pmdl_m.pmdl007 <> '1' THEN
       CALL cl_set_act_visible("reproduce", FALSE)
    END IF
    
    IF (NOT cl_null(g_argv[02])) OR (NOT cl_null(g_argv[03])) THEN
       CALL cl_set_act_visible("query", FALSE)
    END IF
    
    #單身無資料，不顯示重新取價ACTION
    LET l_n = 0
    SELECT COUNT(1) INTO l_n FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
    IF l_n = 0 THEN
       CALL cl_set_act_visible("get_detail_price,open_apmt500_03",FALSE)
    END IF
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_act_visible_b" >}
#+ 單身權限開啟
PRIVATE FUNCTION apmt500_set_act_visible_b()
   #add-point:set_act_visible_b段define(客製用) name="set_act_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible_b.define"
   
   #end add-point   
   #add-point:set_act_visible_b段 name="set_act_visible_b.set_act_visible_b"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.set_act_no_visible_b" >}
#+ 單身權限關閉
PRIVATE FUNCTION apmt500_set_act_no_visible_b()
   #add-point:set_act_no_visible_b段define(客製用) name="set_act_no_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible_b.define"
   
   #end add-point   
   #add-point:set_act_no_visible_b段 name="set_act_no_visible_b.set_act_no_visible_b"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.default_search" >}
#+ 外部參數搜尋
PRIVATE FUNCTION apmt500_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"
   
   #end add-point  
   DEFINE li_idx     LIKE type_t.num10
   DEFINE li_cnt     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
      
   #end add-point  
   
   #add-point:Function前置處理 name="default_search.before"
      
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[01]) THEN
      LET ls_wc = ls_wc, " pmdldocno = '", g_argv[01], "' AND "
   END IF
   
 
   
   #add-point:default_search段after sql name="default_search.after_sql"
   #LET ls_wc = ' 1=1 '   #170116-00001#1 mark
   LET ls_wc = ' '        #170116-00001#1 add
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = " pmdldocno = '", g_argv[02], "' AND "
   END IF
   
   #傳單號範圍至apmt500,一次查詢可查詢出多個單號資料
   IF NOT cl_null(g_argv[03]) THEN
      LET ls_wc = ls_wc , g_argv[03], " AND "
   END IF
   
   #其他程式串查用，傳入 site，變更g_site要變更TITLE 用cl_ui_wintitle去變更
   IF NOT cl_null(g_argv[04]) THEN
      LET g_site = g_argv[04]
      CALL cl_ui_wintitle(FALSE)
   END IF 
   #end add-point  
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      #若無外部參數則預設為1=2
      LET g_default = FALSE
      
      #預設查詢條件
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc2_table2 TO NULL
 
         INITIALIZE g_wc2_table3 TO NULL
 
         INITIALIZE g_wc2_table4 TO NULL
 
 
         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "pmdl_t" 
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "pmdn_t" 
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "pmdo_t" 
                  LET g_wc2_table2 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "pmdp_t" 
                  LET g_wc2_table3 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "pmdm_t" 
                  LET g_wc2_table4 = la_wc[li_idx].wc
 
 
               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
            OR NOT cl_null(g_wc2_table2)
 
            OR NOT cl_null(g_wc2_table3)
 
            OR NOT cl_null(g_wc2_table4)
 
 
            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
            END IF
 
            IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
            END IF
 
            IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
            END IF
 
 
            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF
         
            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
    
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
   END IF
   
   #add-point:default_search段結束前 name="default_search.after"
   #IF g_argv[01] = '1' THEN  #委外採購
   #   LET g_wc = g_wc," AND pmdl005 = '2'"
   #ELSE
   #   IF g_argv[01] = '2' THEN  #重覆性生產委外採購
   #      LET g_wc = g_wc," AND pmdl005 = '5'"
   #   ELSE
   #      LET g_wc = g_wc," AND pmdl005 NOT IN ('2','5') "
   #   END IF
   #END IF
   
   CASE g_argv[01]
      WHEN "1"   #委外採購
         LET g_wc = g_wc," AND pmdl005 = '2'"
      WHEN "2"   #重覆性生產委外採購
         LET g_wc = g_wc," AND pmdl005 = '5'"
      WHEN "3"   #一般採購
         LET g_wc = g_wc," AND pmdl005 NOT IN ('2','5','6') "
      WHEN "4"   #借貨採購
         LET g_wc = g_wc," AND pmdl005 = '6'"
      
   END CASE
      
   
   ##傳單號範圍至apmt500,一次查詢可查詢出多個單號資料
   #IF NOT cl_null(g_argv[03]) THEN
   #   LET g_wc = g_wc," AND ",g_argv[03]
   #   LET g_default = TRUE
   #END IF

   #end add-point  
 
   IF g_wc.getIndexOf(" 1=2", 1) THEN
      LET g_default = TRUE
   END IF
 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.state_change" >}
   #應用 a09 樣板自動產生(Version:17)
#+ 確認碼變更 
PRIVATE FUNCTION apmt500_statechange()
   #add-point:statechange段define(客製用) name="statechange.define_customerization"
   
   #end add-point  
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="statechange.define"
   DEFINE l_success  LIKE type_t.num5
   #150625 earl add start
   DEFINE la_param   RECORD
          prog           STRING,
          actionid       STRING,
          background     LIKE type_t.chr1,
          param          DYNAMIC ARRAY OF STRING
                     END RECORD

   DEFINE ls_js         STRING
   DEFINE l_pmdl030     LIKE pmdl_t.pmdl030
   DEFINE l_pmaa088     LIKE pmaa_t.pmaa088
   DEFINE l_n           LIKE type_t.num10
   #150625 earl add end
   
   #end add-point  
   
   #add-point:Function前置處理 name="statechange.before"
   IF g_pmdl_m.pmdlstus MATCHES '[XC]' THEN
      RETURN
   END IF
   #end add-point  
   
   ERROR ""     #清空畫面右下側ERROR區塊
 
   IF g_pmdl_m.pmdldocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   CALL s_transaction_begin()
   
   OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
   IF STATUS THEN
      CLOSE apmt500_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt500_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
       g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
       g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
       g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
       g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
       g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
       g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
       g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
       g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
       g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
       g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid_desc, 
       g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc
   
 
   #檢查是否允許此動作
   IF NOT apmt500_action_chk() THEN
      CLOSE apmt500_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004, 
       g_pmdl_m.pmdl004_desc,g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc, 
       g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008, 
       g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc,g_pmdl_m.pmdl052,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl053, 
       g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010,g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011, 
       g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc, 
       g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl017_desc, 
       g_pmdl_m.pmdl018,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc, 
       g_pmdl_m.pmdl043,g_pmdl_m.pmdl043_desc,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl051_desc, 
       g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.oofb017, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.oofb017_1,g_pmdl_m.pmdl029,g_pmdl_m.pmdl029_desc, 
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022,g_pmdl_m.pmdl022_desc,g_pmdl_m.pmdl032, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048, 
       g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.fflabel_1,g_pmdl_m.pmdl040,g_pmdl_m.fflabel_2, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlowndp_desc, 
       g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlcrtdt, 
       g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfid_desc, 
       g_pmdl_m.pmdlcnfdt
 
   CASE g_pmdl_m.pmdlstus
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      WHEN "H"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/hold.png")
      WHEN "C"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/closed.png")
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "D"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      WHEN "W"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
      WHEN "UH"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unhold.png")
      WHEN "X"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
      
   END CASE
 
   #add-point:資料刷新後 name="statechange.after_refresh"
   
   #end add-point
 
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_pmdl_m.pmdlstus
            
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "Y"
               HIDE OPTION "confirmed"
            WHEN "H"
               HIDE OPTION "hold"
            WHEN "C"
               HIDE OPTION "closed"
            WHEN "A"
               HIDE OPTION "approved"
            WHEN "D"
               HIDE OPTION "withdraw"
            WHEN "R"
               HIDE OPTION "rejection"
            WHEN "W"
               HIDE OPTION "signing"
            WHEN "UH"
               HIDE OPTION "unhold"
            WHEN "X"
               HIDE OPTION "invalid"
         END CASE
     
      #add-point:menu前 name="statechange.before_menu"
      CALL cl_set_act_visible("unconfirmed,invalid,confirmed,hold,unhold",TRUE)
      CALL cl_set_act_visible("closed",FALSE)
      CALL cl_set_act_visible("signing,withdraw",FALSE)      
      
      CASE g_pmdl_m.pmdlstus
         WHEN "N"
            CALL cl_set_act_visible("unconfirmed,hold,unhold",FALSE)
            #需提交至BPM時，則顯示「提交」功能並隱藏「確認」功能
            IF cl_bpm_chk() THEN
                CALL cl_set_act_visible("signing",TRUE)
                CALL cl_set_act_visible("confirmed",FALSE)
            END IF
            
         WHEN "R"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed,hold,unhold",FALSE)

         WHEN "D"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed,hold,unhold",FALSE) 
   
         WHEN "X"
            CALL cl_set_act_visible("unconfirmed,invalid,confirmed,hold,unhold",FALSE)

         WHEN "Y"
            CALL cl_set_act_visible("invalid,confirmed,unhold",FALSE)
            #採購已經全收之採購單不可使用留置功能
            LET l_n = 0
            SELECT COUNT(1) INTO l_n FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND (pmdo006 - pmdo015) > 0
            IF l_n = 0 THEN
               CALL cl_set_act_visible("hold",FALSE)
            END IF           
            
         WHEN "W"    #只能顯示抽單;其餘應用功能皆隱藏
             CALL cl_set_act_visible("withdraw",TRUE)  
             CALL cl_set_act_visible("unconfirmed,invalid,confirmed,hold,unhold",FALSE)
         
         WHEN "A"     #只能顯示確認; 其餘應用功能皆隱藏
             CALL cl_set_act_visible("confirmed ",TRUE)  
             CALL cl_set_act_visible("unconfirmed,invalid,hold,unhold",FALSE)
          
          WHEN "H"   #留置
            CALL cl_set_act_visible("unconfirmed,invalid,confirmed,hold",FALSE)

   
      END CASE
      #end add-point
      
      #應用 a36 樣板自動產生(Version:5)
      #提交
      ON ACTION signing
         IF cl_auth_chk_act("signing") THEN
            IF NOT apmt500_send() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE apmt500_cl
            RETURN
         END IF
    
      #抽單
      ON ACTION withdraw
         IF cl_auth_chk_act("withdraw") THEN
            IF NOT apmt500_draw_out() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE apmt500_cl
            RETURN
         END IF
 
 
 
	  
      ON ACTION unconfirmed
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制 name="statechange.unconfirmed"
            
            #end add-point
         END IF
         EXIT MENU
      ON ACTION confirmed
         IF cl_auth_chk_act("confirmed") THEN
            LET lc_state = "Y"
            #add-point:action控制 name="statechange.confirmed"
                  
            #end add-point
         END IF
         EXIT MENU
      ON ACTION hold
         IF cl_auth_chk_act("hold") THEN
            LET lc_state = "H"
            #add-point:action控制 name="statechange.hold"
                  
            #end add-point
         END IF
         EXIT MENU
      ON ACTION closed
         IF cl_auth_chk_act("closed") THEN
            LET lc_state = "C"
            #add-point:action控制 name="statechange.closed"
            
            #end add-point
         END IF
         EXIT MENU
      ON ACTION approved
         IF cl_auth_chk_act("approved") THEN
            LET lc_state = "A"
            #add-point:action控制 name="statechange.approved"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION withdraw
      #   IF cl_auth_chk_act("withdraw") THEN
      #      LET lc_state = "D"
      #      #add-point:action控制 name="statechange.withdraw"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION rejection
         IF cl_auth_chk_act("rejection") THEN
            LET lc_state = "R"
            #add-point:action控制 name="statechange.rejection"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION signing
      #   IF cl_auth_chk_act("signing") THEN
      #      LET lc_state = "W"
      #      #add-point:action控制 name="statechange.signing"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION unhold
         IF cl_auth_chk_act("unhold") THEN
            LET lc_state = "UH"
            #add-point:action控制 name="statechange.unhold"
            
            #end add-point
         END IF
         EXIT MENU
      ON ACTION invalid
         IF cl_auth_chk_act("invalid") THEN
            LET lc_state = "X"
            #add-point:action控制 name="statechange.invalid"
                  
            #end add-point
         END IF
         EXIT MENU
 
      #add-point:stus控制 name="statechange.more_control"
            
      #end add-point
      
   END MENU
   
   #確認被選取的狀態碼在清單中
   IF (lc_state <> "N" 
      AND lc_state <> "Y"
      AND lc_state <> "H"
      AND lc_state <> "C"
      AND lc_state <> "A"
      AND lc_state <> "D"
      AND lc_state <> "R"
      AND lc_state <> "W"
      AND lc_state <> "UH"
      AND lc_state <> "X"
      ) OR 
      g_pmdl_m.pmdlstus = lc_state OR cl_null(lc_state) THEN
      CLOSE apmt500_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #add-point:stus修改前 name="statechange.b_update"
   #画面应该停留在第一个页签上
   CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")   #160824-00014#1 
            
   #CALL s_transaction_begin()  #161027-00035#1 mark
   IF lc_state = 'Y' THEN
      CALL cl_err_collect_init()
      CALL s_apmt500_conf_chk(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         #160728-00008#1-s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1-e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      IF NOT cl_ask_confirm('aim-00108') THEN
         #160728-00008#1-s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1-e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      CALL cl_err_collect_init()
      CALL s_apmt500_conf_upd(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         CLOSE apmt500_cl   #160728-00008#1
         CALL s_transaction_end('N','0')
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add

      CALL s_transaction_end('Y','0')
      #150625---earl---add---s
      #多角自動拋轉
      IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
         g_pmdl_m.pmdl006 MATCHES '[23]' AND
         g_pmdl_m.pmdl051 IS NOT NULL THEN  #150814 earl mod
         INITIALIZE la_param.* TO NULL
         LET la_param.prog     = 'aicp200'
         LET la_param.param[1] = g_pmdl_m.pmdldocno
         LET ls_js = util.JSON.stringify(la_param)
         CALL cl_cmdrun_wait(ls_js)
         #161027-00035#1-s add
         LET l_pmdl030 = ''
         SELECT pmdl030 INTO l_pmdl030
           FROM pmdl_t
          WHERE pmdlent = g_enterprise
            AND pmdldocno = g_pmdl_m.pmdldocno
         #多角流程拋轉失敗！
         IF l_pmdl030 <> 'Y' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code   = 'aic-00177'
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            CALL s_transaction_begin()
            CALL cl_err_collect_init()
            CALL s_apmt500_unconf_upd(g_pmdl_m.pmdldocno) RETURNING l_success
            CALL cl_err_collect_show()
            CALL s_transaction_end('Y','0')
            CLOSE apmt500_cl
            RETURN
         END IF
         #161027-00035#1-e add
      END IF
      #150625---earl---add---e
      
      #END IF  #161027-00035#1 mark
      #供應商的"寄發郵件前預覽報表"="Y"，則於畫面呈現apmr500報表資料
      #供應商的"寄發郵件前預覽報表"="N"，則直接發mail給供應商通訊方式中，"寄發郵件"="Y"之連絡人與採購人員
      #收件人資訊在"寄發郵件前預覽報表"前呼叫
      CALL apmt500_maillist()
      SELECT pmaa088 INTO l_pmaa088 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmdl_m.pmdl004
      IF l_pmaa088 = 'Y' THEN
         CALL apmr500_g01("pmdlent = "|| g_enterprise ||" AND pmdldocno = '"||g_pmdl_m.pmdldocno||"'",'','') #161031-00024#6 add ''
      ELSE
         LET g_rep_wc = "pmdlent = "|| g_enterprise ||" AND pmdldocno = '"||g_pmdl_m.pmdldocno||"'"
         LET la_param.prog = "apmr500"
         LET ls_js = g_rep_wc,",''"
         LET la_param.param[1] = ls_js
         LET la_param.background = "Y"
         LET ls_js = util.JSON.stringify(la_param)
         CALL cl_cmdrun_wait(ls_js)
         #161027-00035#1-s mark
         #   END IF
         #END IF
         #161027-00035#1-e add
      END IF
   END IF
   
   IF lc_state = 'N' THEN
      CALL cl_err_collect_init()
      CALL s_apmt500_unconf_chk(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      IF NOT cl_ask_confirm('aim-00110') THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      #150625---earl---add---s
      CALL s_transaction_end('Y','0')
      #多角自動拋轉還原
      IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
         g_pmdl_m.pmdl006 MATCHES '[23]' AND
         g_pmdl_m.pmdl051 IS NOT NULL THEN  #150814 earl mod
         INITIALIZE la_param.* TO NULL
         LET la_param.prog     = 'aicp210'
         LET la_param.param[1] = g_pmdl_m.pmdldocno
         LET ls_js = util.JSON.stringify(la_param)
         CALL cl_cmdrun_wait(ls_js)
      END IF
      LET l_pmdl030 = ''
      SELECT pmdl030 INTO l_pmdl030
        FROM pmdl_t
       WHERE pmdlent = g_enterprise
         AND pmdldocno = g_pmdl_m.pmdldocno
      IF l_pmdl030 = 'Y' THEN
         INITIALIZE g_errparam TO NULL
         #多角流程已拋轉之單據不可取消確認！
         LET g_errparam.code   = 'aic-00180'
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         #CALL s_transaction_end('N','0')   #160816-00068#15 add  #161027-00035#1 mark
         #CALL cl_err_collect_show()  #161027-00035#1 mark
         CLOSE apmt500_cl
         RETURN
      END IF
      CALL s_transaction_begin()
      #161027-00035#1-s mark
      #OPEN apmt500_cl USING g_enterprise,g_pmdl_m.pmdldocno
      #IF STATUS THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.extend = "OPEN apmt500_cl:"
      #   LET g_errparam.code   = STATUS
      #   LET g_errparam.popup  = TRUE
      #   CALL cl_err()
      #   CLOSE apmt500_cl
      #   CALL s_transaction_end('N','0')
      #   CALL cl_err_collect_show()
      #   RETURN
      #END IF
      #161027-00035#1-e mark
      #150625---earl---add---e
      CALL cl_err_collect_init()
      CALL s_apmt500_unconf_upd(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         CLOSE apmt500_cl  #160728-00008#1
         CALL s_transaction_end('N','0')
         RETURN
         #161027-00035#1-s mark
         #   ELSE
         #      CALL s_transaction_end('Y','0')
         #   END IF
         #END IF
         #161027-00035#1-s mark
      END IF
   END IF
   
   IF lc_state = 'X' THEN
      CALL cl_err_collect_init()
      CALL s_apmt500_invalid_chk(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      IF NOT cl_ask_confirm('aim-00109') THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      CALL cl_err_collect_init()
      CALL s_apmt500_invalid_upd(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         CLOSE apmt500_cl  #160728-00008#1
         CALL s_transaction_end('N','0')
         RETURN
         #161027-00035#1-s mark
         #   ELSE
         #      CALL s_transaction_end('Y','0')
         #   END IF
         #END IF
         #161027-00035#1-s mark
      END IF
   END IF
   
   #留置
   IF lc_state = 'H' THEN
      CALL cl_err_collect_init()
      CALL s_apmt500_hold_chk(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      IF NOT cl_ask_confirm('apm-00737') THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      IF NOT apmt500_upd_pmdl043() THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      CALL cl_err_collect_init()
      CALL s_apmt500_hold_upd(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         CLOSE apmt500_cl  #160728-00008#1
         CALL s_transaction_end('N','0')
         RETURN
         #161027-00035#1-s mark
         #      ELSE
         #         CALL s_transaction_end('Y','0')
         #      END IF
         #   END IF
         #END IF
         #161027-00035#1-s mark
      END IF
   END IF
   
   #取消留置
   IF lc_state = 'UH' THEN
      CALL cl_err_collect_init()
      CALL s_apmt500_unhold_chk(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      IF NOT cl_ask_confirm('apm-00738') THEN
         #160728-00008#1--s
         CLOSE apmt500_cl
         CALL s_transaction_end('N','0')
         #160728-00008#1---e
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      #161027-00035#1-s add
      #多角自動拋轉
      IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
         g_pmdl_m.pmdl006 MATCHES '[23]' AND
         g_pmdl_m.pmdl051 IS NOT NULL THEN
         UPDATE pmdl_t SET pmdlstus = 'Y'
          WHERE pmdlent = g_enterprise
            AND pmdldocno = g_pmdl_m.pmdldocno
         CALL s_transaction_end('Y','0')
         INITIALIZE la_param.* TO NULL
         LET la_param.prog     = 'aicp200'
         LET la_param.param[1] = g_pmdl_m.pmdldocno
         LET ls_js = util.JSON.stringify(la_param)
         CALL cl_cmdrun_wait(ls_js)
         LET l_pmdl030 = ''
         SELECT pmdl030 INTO l_pmdl030
           FROM pmdl_t
          WHERE pmdlent = g_enterprise
            AND pmdldocno = g_pmdl_m.pmdldocno
         #多角流程拋轉失敗！
         IF l_pmdl030 <> 'Y' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code   = 'aic-00177'
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            CALL s_transaction_begin()
            UPDATE pmdl_t SET pmdlstus = 'H'
             WHERE pmdlent = g_enterprise
               AND pmdldocno = g_pmdl_m.pmdldocno
            CALL s_transaction_end('Y','0')
            CLOSE apmt500_cl
            RETURN
         END IF
         CALL s_transaction_begin()
      END IF
      #161027-00035#1-e add
      CALL cl_err_collect_init()
      CALL s_apmt500_unhold_upd(g_pmdl_m.pmdldocno) RETURNING l_success
      CALL cl_err_collect_show()
      IF NOT l_success THEN
         CLOSE apmt500_cl  #160728-00008#1
         CALL s_transaction_end('N','0')
         RETURN
      #ELSE  #161027-00035#1 mark
      END IF  #161027-00035#1 add
      #161027-00035#1-s mark
      #CALL s_transaction_end('Y','0')  #161027-00035#1 mark
      ##150625---earl---add---s
      ##多角自動拋轉
      #IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
      #   g_pmdl_m.pmdl006 MATCHES '[23]' AND
      #   g_pmdl_m.pmdl051 IS NOT NULL THEN  #150814 earl mod
      #   INITIALIZE la_param.* TO NULL
      #   LET la_param.prog     = 'aicp200'
      #   LET la_param.param[1] = g_pmdl_m.pmdldocno
      #   LET ls_js = util.JSON.stringify(la_param)
      #   CALL cl_cmdrun_wait(ls_js)
      #END IF
      ##150625---earl---add---e
      #      END IF
      #   END IF
      #END IF
      #161027-00035#1-s mark
   END IF
   
   #因為取消留置時，狀態碼應給'Y',而不是更新為'UH'
   SELECT pmdlstus INTO lc_state FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno

   #end add-point
   
   LET g_pmdl_m.pmdlmodid = g_user
   LET g_pmdl_m.pmdlmoddt = cl_get_current()
   LET g_pmdl_m.pmdlstus = lc_state
   
   #異動狀態碼欄位/修改人/修改日期
   UPDATE pmdl_t 
      SET (pmdlstus,pmdlmodid,pmdlmoddt) 
        = (g_pmdl_m.pmdlstus,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt)     
    WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
 
    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "H"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/hold.png")
         WHEN "C"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/closed.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "UH"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unhold.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         
      END CASE
    
      #撈取異動後的資料
      EXECUTE apmt500_master_referesh USING g_pmdl_m.pmdldocno INTO g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001, 
          g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus, 
          g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052, 
          g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
          g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
          g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025, 
          g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024, 
          g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
          g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040, 
          g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp, 
          g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt, 
          g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010_desc, 
          g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043_desc, 
          g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022_desc, 
          g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp_desc, 
          g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlcnfid_desc 
 
      
      #將資料顯示到畫面上
      DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt, 
          g_pmdl_m.pmdl004,g_pmdl_m.pmdl004_desc,g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003, 
          g_pmdl_m.pmdl003_desc,g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006, 
          g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc,g_pmdl_m.pmdl052, 
          g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010, 
          g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011,g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
          g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc,g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016, 
          g_pmdl_m.pmdl017,g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl018,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl019, 
          g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc,g_pmdl_m.pmdl043,g_pmdl_m.pmdl043_desc,g_pmdl_m.pmdl044, 
          g_pmdl_m.pmdl051,g_pmdl_m.pmdl051_desc,g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl025, 
          g_pmdl_m.pmdl025_desc,g_pmdl_m.oofb017,g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.oofb017_1, 
          g_pmdl_m.pmdl029,g_pmdl_m.pmdl029_desc,g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022, 
          g_pmdl_m.pmdl022_desc,g_pmdl_m.pmdl032,g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc, 
          g_pmdl_m.pmdl054,g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042, 
          g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.fflabel_1, 
          g_pmdl_m.pmdl040,g_pmdl_m.fflabel_2,g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlownid_desc, 
          g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlowndp_desc,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp, 
          g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlmoddt, 
          g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfid_desc,g_pmdl_m.pmdlcnfdt
   END IF
 
   #add-point:stus修改後 name="statechange.a_update"
   #CALL apmt500_b_fill()  #160728-00008#1
   #end add-point
 
   #add-point:statechange段結束前 name="statechange.after"
   #画面应该停留在第一个页签上
   CALL gfrm_curr.ensureFieldVisible("pmdl_t.pmdl005")   #160824-00014#1     
   #end add-point  
 
   CLOSE apmt500_cl
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL apmt500_msgcentre_notify('statechange:'||lc_state)
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt500.idx_chk" >}
#+ 顯示正確的單身資料筆數
PRIVATE FUNCTION apmt500_idx_chk()
   #add-point:idx_chk段define(客製用) name="idx_chk.define_customerization"
   
   #end add-point  
   #add-point:idx_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="idx_chk.define"
      
   #end add-point  
   
   #add-point:Function前置處理  name="idx_chk.pre_function"
   
   #end add-point
   
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_pmdn_d.getLength() THEN
         LET g_detail_idx = g_pmdn_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdn_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdn_d.getLength() TO FORMONLY.cnt
   END IF
   
   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail2")
      IF g_detail_idx > g_pmdn2_d.getLength() THEN
         LET g_detail_idx = g_pmdn2_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdn2_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdn2_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail3")
      IF g_detail_idx > g_pmdn3_d.getLength() THEN
         LET g_detail_idx = g_pmdn3_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdn3_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdn3_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 4 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail4")
      IF g_detail_idx > g_pmdn4_d.getLength() THEN
         LET g_detail_idx = g_pmdn4_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdn4_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdn4_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 5 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail6")
      IF g_detail_idx > g_pmdn6_d.getLength() THEN
         LET g_detail_idx = g_pmdn6_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdn6_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdn6_d.getLength() TO FORMONLY.cnt
   END IF
 
   
   #add-point:idx_chk段other name="idx_chk.other"
      
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.b_fill2" >}
#+ 單身陣列填充2
PRIVATE FUNCTION apmt500_b_fill2(pi_idx)
   #add-point:b_fill2段define(客製用) name="b_fill2.define_customerization"
   
   #end add-point
   DEFINE pi_idx                 LIKE type_t.num10
   DEFINE li_ac                  LIKE type_t.num10
   DEFINE li_detail_idx_tmp      LIKE type_t.num10
   DEFINE ls_chk                 LIKE type_t.chr1
   #add-point:b_fill2段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill2.define"
      
   #end add-point
   
   #add-point:Function前置處理  name="b_fill2.pre_function"
   
   #end add-point
   
   LET li_ac = l_ac 
   
   IF g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   LET li_detail_idx_tmp = g_detail_idx
   
 
      
 
      
   #add-point:單身填充後 name="b_fill2.after_fill"
      
   #end add-point
    
   LET l_ac = li_ac
   
   CALL apmt500_detail_show()
   
   LET g_detail_idx = li_detail_idx_tmp
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.fill_chk" >}
#+ 單身填充確認
PRIVATE FUNCTION apmt500_fill_chk(ps_idx)
   #add-point:fill_chk段define(客製用) name="fill_chk.define_customerization"
   
   #end add-point
   DEFINE ps_idx        LIKE type_t.chr10
   #add-point:fill_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fill_chk.define"
      
   #end add-point
   
   #add-point:Function前置處理 name="fill_chk.before_chk"
   
   #end add-point
   
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
 
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND 
      (cl_null(g_wc2_table2) OR g_wc2_table2.trim() = '1=1')  AND 
      (cl_null(g_wc2_table3) OR g_wc2_table3.trim() = '1=1')  AND 
      (cl_null(g_wc2_table4) OR g_wc2_table4.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"
            
      #end add-point
      RETURN TRUE
   END IF
   
   #add-point:fill_chk段after_chk name="fill_chk.after_chk"
   IF ((NOT cl_null(g_wc2_table1) AND g_wc2_table1.trim() <> '1=1')) OR
      ((NOT cl_null(g_wc2_table2) AND g_wc2_table2.trim() <> '1=1')) OR
      ((NOT cl_null(g_wc2_table3) AND g_wc2_table3.trim() <> '1=1')) OR
      ((NOT cl_null(g_wc2_table4) AND g_wc2_table4.trim() <> '1=1')) THEN
      RETURN TRUE
   END IF
   #end add-point
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="apmt500.status_show" >}
PRIVATE FUNCTION apmt500_status_show()
   #add-point:status_show段define(客製用) name="status_show.define_customerization"
   
   #end add-point
   #add-point:status_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="status_show.define"
   
   #end add-point
   
   #add-point:status_show段status_show name="status_show.status_show"
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="apmt500.mask_functions" >}
&include "erp/apm/apmt500_mask.4gl"
 
{</section>}
 
{<section id="apmt500.signature" >}
   #應用 a39 樣板自動產生(Version:10)
#+ BPM提交
PRIVATE FUNCTION apmt500_send()
   #add-point:send段define(客製用) name="send.define_customerization"
   
   #end add-point 
   #add-point:send段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="send.define"
   
   #end add-point 
   
   #add-point:Function前置處理  name="send.pre_function"
   
   #end add-point
   
   #依據單據個數，需要指定所有單身條件為" 1=1"  (單身有幾個就要設幾個)
   LET g_wc2_table1 = " 1=1"
   LET g_wc2_table2 = " 1=1"
   LET g_wc2_table3 = " 1=1"
   LET g_wc2_table4 = " 1=1"
 
 
   CALL apmt500_show()
   CALL apmt500_set_pk_array()
   
   #add-point: 初始化的ADP name="send.before_send"
   IF NOT s_apmt500_conf_chk(g_pmdl_m.pmdldocno) THEN
      CLOSE apmt500_cl
      CALL s_transaction_end('N','0')
      RETURN FALSE
   END IF

   #end add-point
   
   #公用變數初始化
   CALL cl_bpm_data_init()
                  
   #依照主檔/單身個數產生 CALL cl_bpm_set_master_data() / cl_bpm_set_detail_data() 
   #單頭固定為 CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(xxxx)) 傳入參數: (1)單頭陣列  ; 回傳值: 無
   CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(g_pmdl_m))
                              
   #單身固定為 CALL cl_bpm_set_detail_data(s_detailX, util.JSONArray.fromFGL(xxxx)) 傳入參數: (1)單身SR名稱  (2)單身陣列  ; 回傳值: 無
   CALL cl_bpm_set_detail_data("s_detail1", util.JSONArray.fromFGL(g_pmdn_d))
   CALL cl_bpm_set_detail_data("s_detail2", util.JSONArray.fromFGL(g_pmdn2_d))
   CALL cl_bpm_set_detail_data("s_detail3", util.JSONArray.fromFGL(g_pmdn3_d))
   CALL cl_bpm_set_detail_data("s_detail4", util.JSONArray.fromFGL(g_pmdn4_d))
   CALL cl_bpm_set_detail_data("s_detail6", util.JSONArray.fromFGL(g_pmdn6_d))
 
 
   # cl_bpm_cli() 裡有包含以前的aws_condition()=>送簽資料檢核和更新單據狀況碼為'W'
   # cl_bpm_cli() 傳入參數:無  ;  回傳值: 0 開單失敗; 1 開單成功
 
   #add-point: 提交前的ADP name="send.before_cli"
   
   #end add-point
 
   #開單失敗
   IF NOT cl_bpm_cli() THEN 
      RETURN FALSE
   END IF
 
   #add-point: 提交後的ADP name="send.after_send"
   
   #end add-point
 
   #此段落不需要刪除資料,但是否需要refresh圖片樣式???
   #CALL apmt500_ui_browser_refresh()
 
   #重新指定此筆單據資料狀態圖片=>送簽中
   LET g_browser[g_current_idx].b_statepic = "stus/16/signing.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL apmt500_ui_headershow()
   CALL apmt500_ui_detailshow()
 
   RETURN TRUE
   
END FUNCTION
 
 
 
#應用 a40 樣板自動產生(Version:9)
#+ BPM抽單
PRIVATE FUNCTION apmt500_draw_out()
   #add-point:draw段define name="draw.define_customerization"
   
   #end add-point
   #add-point:draw段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="draw.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="draw.pre_function"
   
   #end add-point
   
   #抽單失敗
   IF NOT cl_bpm_draw_out() THEN 
      RETURN FALSE
   END IF    
          
   #重新指定此筆單據資料狀態圖片=>抽單
   LET g_browser[g_current_idx].b_statepic = "stus/16/draw_out.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL apmt500_ui_headershow()  
   CALL apmt500_ui_detailshow()
 
   #add-point:Function後置處理  name="draw.after_function"
   
   #end add-point
 
   RETURN TRUE
   
END FUNCTION
 
 
 
 
 
{</section>}
 
{<section id="apmt500.set_pk_array" >}
   #應用 a51 樣板自動產生(Version:8)
#+ 給予pk_array內容
PRIVATE FUNCTION apmt500_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point  
   
   #若l_ac<=0代表沒有資料
   IF l_ac <= 0 THEN
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_pmdl_m.pmdldocno
   LET g_pk_array[1].column = 'pmdldocno'
 
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point  
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt500.other_dialog" readonly="Y" >}
   
 
{</section>}
 
{<section id="apmt500.msgcentre_notify" >}
#應用 a66 樣板自動產生(Version:6)
PRIVATE FUNCTION apmt500_msgcentre_notify(lc_state)
   #add-point:msgcentre_notify段define name="msgcentre_notify.define_customerization"
   
   #end add-point   
   DEFINE lc_state LIKE type_t.chr80
   #add-point:msgcentre_notify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="msgcentre_notify.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="msgcentre_notify.pre_function"
   
   #end add-point
   
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = lc_state
 
   #PK資料填寫
   CALL apmt500_set_pk_array()
   #單頭資料填寫
   LET g_msgparam.data[1] = util.JSON.stringify(g_pmdl_m)
 
   #add-point:msgcentre其他通知 name="msgcentre_notify.process"
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt500.action_chk" >}
#+ 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
PRIVATE FUNCTION apmt500_action_chk()
   #add-point:action_chk段define(客製用) name="action_chk.define_customerization"
   
   #end add-point
   #add-point:action_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="action_chk.define"
   
   #end add-point
   
   #add-point:action_chk段action_chk name="action_chk.action_chk"
   #160818-00017#27--s
   SELECT pmdlstus INTO g_pmdl_m.pmdlstus FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
   IF (g_action_choice="modify" OR g_action_choice="delete" OR g_action_choice="modify_detail")  THEN
      LET g_errno = NULL
      CASE g_pmdl_m.pmdlstus  
        WHEN "Y"
           LET g_errno = 'sub-00178'
        WHEN "C"
           LET g_errno = 'ain-00197'
        WHEN "W"
           LET g_errno = 'sub-01347'
        WHEN "UH"
           LET g_errno = 'sub-01358'
        WHEN "H"
           LET g_errno = 'sub-01348'
        WHEN "X"
           LET g_errno = 'sub-00229'
      
      END CASE
      
      IF NOT cl_null(g_errno) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = g_errno
         LET g_errparam.extend = g_pmdl_m.pmdlstus
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_errno = NULL
         CALL apmt500_set_act_visible()
         CALL apmt500_set_act_no_visible()
         CALL apmt500_show()
         RETURN FALSE
      END IF
   END IF
   #160818-00017#27---e
   #end add-point
      
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt500.other_function" readonly="Y" >}
#獲取員工編號說明
PRIVATE FUNCTION apmt500_pmdl002_ref(p_pmdl002)
DEFINE p_pmdl002      LIKE pmdl_t.pmdl002
DEFINE r_pmdl002_desc LIKE oofa_t.oofa011

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl002
       CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
       LET r_pmdl002_desc = '', g_rtn_fields[1] , ''
       RETURN r_pmdl002_desc

END FUNCTION
#獲取部門編號說明
PRIVATE FUNCTION apmt500_pmdl003_ref(p_pmdl003)
DEFINE p_pmdl003      LIKE pmdl_t.pmdl003
DEFINE r_pmdl003_desc LIKE ooefl_t.ooefl003

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl003
       CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_pmdl003_desc = '', g_rtn_fields[1] , ''
       RETURN r_pmdl003_desc

END FUNCTION
#供應商檢查
PRIVATE FUNCTION apmt500_pmdl004_chk(p_pmdl004)
DEFINE p_pmdl004    LIKE pmdl_t.pmdl004
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdn001    LIKE pmdn_t.pmdn001
DEFINE l_pmdn002    LIKE pmdn_t.pmdn002
DEFINE l_pmdn004    LIKE pmdn_t.pmdn004
DEFINE l_pmdn005    LIKE pmdn_t.pmdn005
DEFINE l_pmdn007    LIKE pmdn_t.pmdn007   #add by lixiang 2015/10/15
DEFINE l_pmdnseq    LIKE pmdn_t.pmdnseq   #add by lixiang 2015/12/04
       LET r_success = TRUE
       
       IF NOT cl_null(p_pmdl004) THEN 
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL
          
          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = p_pmdl004
   
          #呼叫檢查存在並帶值的library
          #IF NOT cl_chk_exist("v_pmaa001_1") THEN  #160727-00025#9
          IF NOT cl_chk_exist("v_pmaa001_27") THEN  #160727-00025#9
             LET r_success = FALSE
             RETURN r_success
          END IF
          
          #151217-00014#1 ---add (S)---
          #IF NOT cl_chk_exist("v_pmab001_1") THEN #160727-00025#9
          IF NOT cl_chk_exist("v_pmab001_3") THEN  #160727-00025#9
             #檢查失敗時後續處理
             LET r_success = FALSE
             RETURN r_success
          END IF
          #151217-00014#1 ---add (E)---
          
          #判斷輸入的供應商編號是否在採購控制組限制的供應商範圍內，若不在限制內則不允許跟此供應商採購  
          CALL s_control_chk_group('2','4',g_user,g_dept,p_pmdl004,'','','','') RETURNING l_success,l_flag
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00268'
                LET g_errparam.extend = p_pmdl004
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF 
          END IF
          
          #檢核輸入的供應商是否在單據別限制範圍內，若不在限制內則不允許跟此供應商採購
          CALL s_control_chk_doc('2',g_pmdl_m.pmdldocno,p_pmdl004,'','','','') RETURNING l_success,l_flag
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                #INITIALIZE g_errparam TO NULL
                #LET g_errparam.code = 'apm-00239'
                #LET g_errparam.extend = p_pmdl004
                #LET g_errparam.popup = TRUE
                #CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF 
          END IF
          
          #檢查料件編號是否符合條件
          DECLARE pmdn_cur CURSOR FOR
            SELECT pmdn001,pmdn002,pmdn004,pmdn005,pmdn007,pmdnseq FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
          FOREACH pmdn_cur INTO l_pmdn001,l_pmdn002,l_pmdn004,l_pmdn005,l_pmdn007,l_pmdnseq  #add by lixiang 2015/10/15 pmdn007 #add by lixiang 2015/12/04 add pmdnseq
             IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,l_pmdn001,l_pmdn002,l_pmdn004,l_pmdn005,p_pmdl004,l_pmdn007,g_pmdl_m.pmdldocno,l_pmdnseq) THEN #add by lixiang 2015/10/15 l_pmdn007  #add by lixiang 2015/12/04 add pmdldocno，pmdnseq
                LET r_success = FALSE
                RETURN r_success
             END IF
          END FOREACH
       END IF 
       RETURN r_success
       
END FUNCTION
#帶出供應商說明
PRIVATE FUNCTION apmt500_pmdl004_ref(p_pmdl004)
DEFINE p_pmdl004    LIKE pmdl_t.pmdl004
DEFINE r_pmaal004   LIKE pmaal_t.pmaal004
DEFINE l_pmaa004    LIKE pmaa_t.pmaa004  #20150505 modify by lixiang 150504-00013#4 add

        LET r_pmaal004 = ''  #20150505 modify by lixiang 150504-00013#4 add
        
        INITIALIZE g_ref_fields TO NULL
        LET g_ref_fields[1] = p_pmdl004
        CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
        LET r_pmaal004 = '', g_rtn_fields[1] , ''
        
        #20150505 modify by lixiang 150504-00013#4--add---
        LET l_pmaa004 = ''
        SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = p_pmdl004
        IF l_pmaa004 MATCHES '[24]' THEN   #一次性交易對象
           SELECT pmak003 INTO r_pmaal004 FROM pmak_t WHERE pmakent = g_enterprise AND pmak001 = g_pmdl_m.pmdl028
           #161207-00033#27-S
#           IF NOT cl_null(g_pmdl_m.pmdl028) AND NOT cl_null(r_pmaal004) THEN
#              LET r_pmaal004 = g_pmdl_m.pmdl028,'.',r_pmaal004
#           END IF
           #161207-00033#27-E
        END IF
        #20150505 modify by lixiang 150504-00013#4--end---
        
        RETURN r_pmaal004
            
END FUNCTION
#根據供應商編號帶出其他欄位值
PRIVATE FUNCTION apmt500_pmdl004_desc()
DEFINE l_n         LIKE type_t.num5
DEFINE l_ooef016   LIKE ooef_t.ooef016
DEFINE l_success   LIKE type_t.num5
DEFINE l_controlno LIKE ooha_t.ooha001
DEFINE l_scc40     LIKE type_t.chr2
DEFINE l_oodbl004  LIKE oodbl_t.oodbl004  #稅別名稱
DEFINE l_oodb005   LIKE oodb_t.oodb005    #含稅否
DEFINE l_oodb006   LIKE oodb_t.oodb006    #稅率 
DEFINE l_oodb011   LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定
DEFINE l_pmaa086   LIKE pmaa_t.pmaa086    #預設採購員   #2015/03/03 by stellar add
DEFINE l_pmaa087   LIKE pmaa_t.pmaa087    #預設採購部門 #2015/03/03 by stellar add
#161124-00048#9 mod-S
#DEFINE l_pmal      RECORD LIKE pmal_t.*
#DEFINE l_pmab      RECORD LIKE pmab_t.*
DEFINE l_pmal RECORD  #採購控制組供應商預設條件檔
       pmalent LIKE pmal_t.pmalent, #企业编号
       pmal001 LIKE pmal_t.pmal001, #交易对象编号
       pmal002 LIKE pmal_t.pmal002, #控制组编号
       pmal003 LIKE pmal_t.pmal003, #惯用交易币种
       pmal004 LIKE pmal_t.pmal004, #惯用税务规则
       pmal005 LIKE pmal_t.pmal005, #惯用发票开立方式
       pmal006 LIKE pmal_t.pmal006, #惯用付款条件
       pmal008 LIKE pmal_t.pmal008, #惯用采购渠道
       pmal009 LIKE pmal_t.pmal009, #惯用采购分类
       pmal010 LIKE pmal_t.pmal010, #惯用报表语言
       pmal011 LIKE pmal_t.pmal011, #惯用交运方式
       pmal012 LIKE pmal_t.pmal012, #惯用交运起点
       pmal013 LIKE pmal_t.pmal013, #惯用交运终点
       pmal014 LIKE pmal_t.pmal014, #惯用卸货港
       pmal015 LIKE pmal_t.pmal015, #惯用佣金率
       pmal016 LIKE pmal_t.pmal016, #折扣率
       pmal017 LIKE pmal_t.pmal017, #惯用ForWarder
       pmal018 LIKE pmal_t.pmal018, #惯用Notify
       pmal019 LIKE pmal_t.pmal019, #负责采购人员
       pmal020 LIKE pmal_t.pmal020, #惯用交易条件
       pmal021 LIKE pmal_t.pmal021, #惯用取价方式
       pmal022 LIKE pmal_t.pmal022, #惯用票类型
       pmal023 LIKE pmal_t.pmal023, #惯用内外购
       pmal024 LIKE pmal_t.pmal024, #惯用汇率计算基准
       pmalownid LIKE pmal_t.pmalownid, #资料所有者
       pmalowndp LIKE pmal_t.pmalowndp, #资料所有部门
       pmalcrtid LIKE pmal_t.pmalcrtid, #资料录入者
       pmalcrtdp LIKE pmal_t.pmalcrtdp, #资料录入部门
       pmalcrtdt LIKE pmal_t.pmalcrtdt, #资料创建日
       pmalmodid LIKE pmal_t.pmalmodid, #资料更改者
       pmalmoddt LIKE pmal_t.pmalmoddt, #最近更改日
       pmalstus LIKE pmal_t.pmalstus, #状态码
       pmal025 LIKE pmal_t.pmal025  #负责采购部门
END RECORD
DEFINE l_pmab RECORD  #交易對象據點檔
       pmabent LIKE pmab_t.pmabent, #企业编号
       pmabsite LIKE pmab_t.pmabsite, #营运据点
       pmab001 LIKE pmab_t.pmab001, #交易对象编号
       pmab002 LIKE pmab_t.pmab002, #信用额度检查
       pmab003 LIKE pmab_t.pmab003, #额度交易对象
       pmab004 LIKE pmab_t.pmab004, #信用评核等级
       pmab005 LIKE pmab_t.pmab005, #额度计算币种
       pmab006 LIKE pmab_t.pmab006, #企业额度
       pmab007 LIKE pmab_t.pmab007, #可超出率
       pmab008 LIKE pmab_t.pmab008, #有效期限
       pmab009 LIKE pmab_t.pmab009, #逾期账款宽限天数
       pmab010 LIKE pmab_t.pmab010, #允许除外额度
       pmab011 LIKE pmab_t.pmab011, #额度警示水准一
       pmab012 LIKE pmab_t.pmab012, #水准一通知层
       pmab013 LIKE pmab_t.pmab013, #额度警示水准二
       pmab014 LIKE pmab_t.pmab014, #水准二通知层
       pmab015 LIKE pmab_t.pmab015, #额度警示水准三
       pmab016 LIKE pmab_t.pmab016, #水准三通知层
       pmab017 LIKE pmab_t.pmab017, #启动预期应收通知
       pmab018 LIKE pmab_t.pmab018, #预期应收通知层
       pmab030 LIKE pmab_t.pmab030, #供应商ABC分类
       pmab031 LIKE pmab_t.pmab031, #负责采购人员
       pmab032 LIKE pmab_t.pmab032, #供应商惯用报表语言
       pmab033 LIKE pmab_t.pmab033, #供应商惯用交易币种
       pmab034 LIKE pmab_t.pmab034, #供应商惯用交易税种
       pmab035 LIKE pmab_t.pmab035, #供应商惯用发票开立方式
       pmab036 LIKE pmab_t.pmab036, #供应商惯用立账方式
       pmab037 LIKE pmab_t.pmab037, #供应商惯用付款条件
       pmab038 LIKE pmab_t.pmab038, #供应商惯用采购渠道
       pmab039 LIKE pmab_t.pmab039, #供应商惯用采购分类
       pmab040 LIKE pmab_t.pmab040, #供应商惯用交运方式
       pmab041 LIKE pmab_t.pmab041, #供应商惯用交运起点
       pmab042 LIKE pmab_t.pmab042, #供应商惯用交运终点
       pmab043 LIKE pmab_t.pmab043, #供应商惯用卸货港
       pmab044 LIKE pmab_t.pmab044, #供应商惯用其它条件
       pmab045 LIKE pmab_t.pmab045, #供应商惯用佣金率
       pmab046 LIKE pmab_t.pmab046, #供应商折扣率
       pmab047 LIKE pmab_t.pmab047, #供应商惯用Forwarder
       pmab048 LIKE pmab_t.pmab048, #供应商惯用 Notify
       pmab049 LIKE pmab_t.pmab049, #默认允许分批收货
       pmab050 LIKE pmab_t.pmab050, #最多可拆解批次
       pmab051 LIKE pmab_t.pmab051, #默认允许提前收货
       pmab052 LIKE pmab_t.pmab052, #可提前收货天数
       pmab053 LIKE pmab_t.pmab053, #惯用交易条件
       pmab054 LIKE pmab_t.pmab054, #惯用取价方式
       pmab055 LIKE pmab_t.pmab055, #应付账款类别
       pmab056 LIKE pmab_t.pmab056, #供应商惯用发票类型
       pmab057 LIKE pmab_t.pmab057, #供应商惯用内外购
       pmab058 LIKE pmab_t.pmab058, #供应商惯用汇率计算基准
       pmab060 LIKE pmab_t.pmab060, #供应商评鉴计算分类
       pmab061 LIKE pmab_t.pmab061, #价格评分
       pmab062 LIKE pmab_t.pmab062, #达交率评分
       pmab063 LIKE pmab_t.pmab063, #质量评分
       pmab064 LIKE pmab_t.pmab064, #配合度评分
       pmab065 LIKE pmab_t.pmab065, #调整加减分
       pmab066 LIKE pmab_t.pmab066, #定性评分一
       pmab067 LIKE pmab_t.pmab067, #定性评分二
       pmab068 LIKE pmab_t.pmab068, #定性评分三
       pmab069 LIKE pmab_t.pmab069, #定性评分四
       pmab070 LIKE pmab_t.pmab070, #定性评分五
       pmab071 LIKE pmab_t.pmab071, #检验程度
       pmab072 LIKE pmab_t.pmab072, #检验水准
       pmab073 LIKE pmab_t.pmab073, #检验级数
       pmab080 LIKE pmab_t.pmab080, #客户ABC分类
       pmab081 LIKE pmab_t.pmab081, #负责业务人员
       pmab082 LIKE pmab_t.pmab082, #客户惯用报表语言
       pmab083 LIKE pmab_t.pmab083, #客户惯用交易币种
       pmab084 LIKE pmab_t.pmab084, #客户惯用交易税种
       pmab085 LIKE pmab_t.pmab085, #客户惯用发票开立方式
       pmab086 LIKE pmab_t.pmab086, #客户惯用立账方式
       pmab087 LIKE pmab_t.pmab087, #客户惯用收款条件
       pmab088 LIKE pmab_t.pmab088, #客户惯用销售渠道
       pmab089 LIKE pmab_t.pmab089, #客户惯用销售分类
       pmab090 LIKE pmab_t.pmab090, #客户惯用交运方式
       pmab091 LIKE pmab_t.pmab091, #客户惯用交运起点
       pmab092 LIKE pmab_t.pmab092, #客户惯用交运终点
       pmab093 LIKE pmab_t.pmab093, #客户惯用卸货港
       pmab094 LIKE pmab_t.pmab094, #客户惯用其它条件
       pmab095 LIKE pmab_t.pmab095, #客户惯用佣金率
       pmab096 LIKE pmab_t.pmab096, #客户折扣率
       pmab097 LIKE pmab_t.pmab097, #客户惯用Forwarder
       pmab098 LIKE pmab_t.pmab098, #客户惯用 Notify
       pmab099 LIKE pmab_t.pmab099, #默认允许分批交货
       pmab100 LIKE pmab_t.pmab100, #最多可拆解批次
       pmab101 LIKE pmab_t.pmab101, #默认允许提前交货
       pmab102 LIKE pmab_t.pmab102, #可提前交货天数
       pmab103 LIKE pmab_t.pmab103, #惯用交易条件
       pmab104 LIKE pmab_t.pmab104, #惯用取价方式
       pmab105 LIKE pmab_t.pmab105, #应收账款类别
       pmab106 LIKE pmab_t.pmab106, #客户惯用发票类型
       pmab107 LIKE pmab_t.pmab107, #客户惯用内外销
       pmab108 LIKE pmab_t.pmab108, #客户惯用汇率计算基准
       pmabownid LIKE pmab_t.pmabownid, #资料所有者
       pmabowndp LIKE pmab_t.pmabowndp, #资料所有部门
       pmabcrtid LIKE pmab_t.pmabcrtid, #资料录入者
       pmabcrtdp LIKE pmab_t.pmabcrtdp, #资料录入部门
       pmabcrtdt LIKE pmab_t.pmabcrtdt, #资料创建日
       pmabmodid LIKE pmab_t.pmabmodid, #资料更改者
       pmabmoddt LIKE pmab_t.pmabmoddt, #最近更改日
       pmabcnfid LIKE pmab_t.pmabcnfid, #资料审核者
       pmabcnfdt LIKE pmab_t.pmabcnfdt, #数据审核日
       pmabstus LIKE pmab_t.pmabstus, #状态码
       pmab059 LIKE pmab_t.pmab059, #负责采购部门
       pmab109 LIKE pmab_t.pmab109, #负责业务部门
       pmab110 LIKE pmab_t.pmab110, #供应商条码包装数量
       pmab111 LIKE pmab_t.pmab111, #客户条码包装数量
       pmab019 LIKE pmab_t.pmab019, #逾期账款宽限额度
       pmab020 LIKE pmab_t.pmab020, #除外额有效日期
       pmab112 LIKE pmab_t.pmab112  #是否使用EC
END RECORD
#161124-00048#9 mod-E

     ##2015/03/03 by stellar add ----- (S)
     #LET g_pmdl_m.pmdl002 = ''
     #LET g_pmdl_m.pmdl002_desc = ''
     #LET g_pmdl_m.pmdl003 = ''
     #LET g_pmdl_m.pmdl003_desc = ''
     ##2015/03/03 by stellar add ----- (E)
     
     LET l_n = 0
     #LET g_pmdl_m.pmdl009 = ''
     #LET g_pmdl_m.pmdl009_desc = ''
     #LET g_pmdl_m.pmdl010 = ''
     #LET g_pmdl_m.pmdl010_desc = ''
     #LET g_pmdl_m.pmdl011 = ''
     #LET g_pmdl_m.pmdl011_desc = ''
     #LET g_pmdl_m.pmdl012 = ''
     #LET g_pmdl_m.pmdl013 = ''
     #LET g_pmdl_m.pmdl015 = ''
     #LET g_pmdl_m.pmdl015_desc = ''
     #LET g_pmdl_m.pmdl016 = ''
     #LET g_pmdl_m.pmdl017 = ''
     #LET g_pmdl_m.pmdl017_desc = ''
     #LET g_pmdl_m.pmdl020 = ''
     #LET g_pmdl_m.pmdl020_desc = ''
     #LET g_pmdl_m.pmdl023 = ''
     #LET g_pmdl_m.pmdl023_desc = ''
     #LET g_pmdl_m.pmdl024 = ''
     #LET g_pmdl_m.pmdl024_desc = ''
     #LET g_pmdl_m.pmdl033 = ''
     #LET g_pmdl_m.pmdl033_desc = ''
     #LET g_pmdl_m.pmdl054 = ''
     #LET g_pmdl_m.pmdl055 = ''
      
      #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
      #LET l_controlno = ''
      #CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,l_controlno
      IF cl_null(g_controlno) THEN
         CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,g_controlno
      END IF
      
      #IF NOT cl_null(l_controlno) THEN
      IF NOT cl_null(g_controlno) THEN
         #判斷供應商是否有設置採購控制組供應商預設條件(apmi110)，若有則抓取相關的預設條件default到採購單上
         SELECT COUNT(1) INTO l_n FROM pmal_t 
            WHERE pmalent = g_enterprise AND pmal001 = g_pmdl_m.pmdl004 
              #AND pmal002 = l_controlno
              AND pmal002 = g_controlno
              AND pmalstus = 'Y'
         IF l_n > 0 THEN
            SELECT pmal006,pmal020,pmal004,pmal003,pmal021,pmal011,pmal008,pmal009,pmal022,pmal023,pmal024
                  ,pmal019,pmal025   #2015/03/04 by stellar add
              #INTO g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl015,g_pmdl_m.pmdl017,g_pmdl_m.pmdl020,
              #     g_pmdl_m.pmdl023,g_pmdl_m.pmdl024,g_pmdl_m.pmdl033,
              #     g_pmdl_m.pmdl054,g_pmdl_m.pmdl055
              #    ,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003   #2015/03/04 by stellar add
              INTO l_pmal.pmal006,l_pmal.pmal020,l_pmal.pmal004,l_pmal.pmal003,l_pmal.pmal021,l_pmal.pmal011,l_pmal.pmal008,
                   l_pmal.pmal009,l_pmal.pmal022,l_pmal.pmal023,l_pmal.pmal024,l_pmal.pmal019,l_pmal.pmal025
            FROM pmal_t WHERE pmalent = g_enterprise AND pmal001 = g_pmdl_m.pmdl004 
                          #AND pmal002 = l_controlno 
                          AND pmal002 = g_controlno
                          AND pmalstus = 'Y'
            
            #先判斷欄位是否在單據別設定的預設欄位中，如果存在，則不重新帶值，不存在，則根據供應商帶預設值
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl009') THEN
               LET g_pmdl_m.pmdl009 = l_pmal.pmal006
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl010') THEN
               LET g_pmdl_m.pmdl010 = l_pmal.pmal020
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl011') THEN
               LET g_pmdl_m.pmdl011 = l_pmal.pmal004
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl015') THEN
               LET g_pmdl_m.pmdl015 = l_pmal.pmal003
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl017') THEN
               LET g_pmdl_m.pmdl017 = l_pmal.pmal021
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl020') THEN
               LET g_pmdl_m.pmdl020 = l_pmal.pmal011
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl023') THEN
               LET g_pmdl_m.pmdl023 = l_pmal.pmal008
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl024') THEN
               LET g_pmdl_m.pmdl024 = l_pmal.pmal009
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl033') THEN
               LET g_pmdl_m.pmdl033 = l_pmal.pmal022
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl054') THEN
               LET g_pmdl_m.pmdl054 = l_pmal.pmal023
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl055') THEN
               LET g_pmdl_m.pmdl055 = l_pmal.pmal024
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl002') THEN
               LET g_pmdl_m.pmdl002 = l_pmal.pmal019
            END IF
            IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl003') THEN
               LET g_pmdl_m.pmdl003 = l_pmal.pmal025
            END IF
            
         END IF
      END IF
      
      #若沒有設置採購控制組供應商預設條件資料則改抓供應商據點預設條件(apmm202)資料  
      #IF cl_null(l_controlno) OR l_n = 0 THEN
      IF cl_null(g_controlno) OR l_n = 0 THEN
         SELECT pmab037,pmab053,pmab034,pmab033,pmab054,pmab040,pmab038,pmab039,pmab056,pmab057,pmab058
               ,pmab031,pmab059   #2015/03/04 by stellar add
             #INTO g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl015,g_pmdl_m.pmdl017,g_pmdl_m.pmdl020,g_pmdl_m.pmdl023,g_pmdl_m.pmdl024,g_pmdl_m.pmdl033,
             #     g_pmdl_m.pmdl054,g_pmdl_m.pmdl055
             #    ,g_pmdl_m.pmdl002,g_pmdl_m.pmdl003   #2015/03/04 by stellar add
             INTO l_pmab.pmab037,l_pmab.pmab053,l_pmab.pmab034,l_pmab.pmab033,l_pmab.pmab054,l_pmab.pmab040,l_pmab.pmab038,
                  l_pmab.pmab039,l_pmab.pmab056,l_pmab.pmab057,l_pmab.pmab058,l_pmab.pmab031,l_pmab.pmab059
           FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = g_pmdl_m.pmdl004
         #先判斷欄位是否在單據別設定的預設欄位中，如果存在，則不重新帶值，不存在，則根據供應商帶預設值
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl009') THEN
            LET g_pmdl_m.pmdl009 = l_pmab.pmab037
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl010') THEN
            LET g_pmdl_m.pmdl010 = l_pmab.pmab053
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl011') THEN
            LET g_pmdl_m.pmdl011 = l_pmab.pmab034
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl015') THEN
            LET g_pmdl_m.pmdl015 = l_pmab.pmab033
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl017') THEN
            LET g_pmdl_m.pmdl017 = l_pmab.pmab054
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl020') THEN
            LET g_pmdl_m.pmdl020 = l_pmab.pmab040
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl023') THEN
            LET g_pmdl_m.pmdl023 = l_pmab.pmab038
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl024') THEN
            LET g_pmdl_m.pmdl024 = l_pmab.pmab039
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl033') THEN
            LET g_pmdl_m.pmdl033 = l_pmab.pmab056
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl054') THEN
            LET g_pmdl_m.pmdl054 = l_pmab.pmab057
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl055') THEN
            LET g_pmdl_m.pmdl055 = l_pmab.pmab058
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl002') THEN
            LET g_pmdl_m.pmdl002 = l_pmab.pmab031
         END IF
         IF NOT s_aooi200_chk_doc_fields(g_site,'1',g_pmdl_m.pmdldocno,'pmdl003') THEN
            LET g_pmdl_m.pmdl003 = l_pmab.pmab059
         END IF
        
      END IF
      
      #2015/03/04 by stellar add ----- (S)
      IF cl_null(g_pmdl_m.pmdl002) OR cl_null(g_pmdl_m.pmdl003) THEN
         LET l_pmaa086 = ''
         LET l_pmaa087 = ''
         SELECT pmaa086,pmaa087 INTO l_pmaa086,l_pmaa087
           FROM pmaa_t
          WHERE pmaaent = g_enterprise
            AND pmaa001 = g_pmdl_m.pmdl004
         IF cl_null(g_pmdl_m.pmdl002) THEN
            LET g_pmdl_m.pmdl002 = l_pmaa086
         END IF
         
         IF cl_null(g_pmdl_m.pmdl003) THEN
            LET g_pmdl_m.pmdl003 = l_pmaa087
         END IF
      END IF
      
      IF cl_null(g_pmdl_m.pmdl002) THEN
         LET g_pmdl_m.pmdl002 = g_user
      END IF
      
      IF cl_null(g_pmdl_m.pmdl003) THEN
         SELECT ooag003 INTO g_pmdl_m.pmdl003
           FROM ooag_t 
          WHERE ooagent = g_enterprise 
            AND ooag001 = g_pmdl_m.pmdl002
      END IF
      
      CALL s_desc_get_person_desc(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
      CALL s_desc_get_department_desc(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
      
      DISPLAY BY NAME g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,
                      g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc
      #2015/03/04 by stellar add ----- (E)
      
      #取得銷售分類
      LET g_pmab039 = g_pmdl_m.pmdl024
      #取稅率、單價含稅否
      IF NOT cl_null(g_pmdl_m.pmdl011) THEN
         LET l_oodb005 = ''
         LET l_oodb006 = ''
         LET l_oodb011 = ''
         CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
           RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
           
         IF l_success THEN
            LET g_tax_app = l_oodb011
            LET g_pmdl_m.pmdl012 = l_oodb006
            LET g_pmdl_m.pmdl013 = l_oodb005
            LET g_pmdl_m.pmdl011_desc = l_oodbl004
         END IF           
      END IF
     
      #取得價格是否允許修改,修改容差率,價格超過容差率的處理方式,允許單價為0
       LET g_pmam003 = ''
       LET g_pmam006 = ''
       LET g_pmam002 = ''
       SELECT pmam003,pmam006,pmam002
         INTO g_pmam003,g_pmam006,g_pmam002
         FROM pmam_t       
        WHERE pmament = g_enterprise
          AND pmam001 = g_pmdl_m.pmdl017  
      
      IF cl_null(g_pmdl_m.pmdl054) THEN
         LET g_pmdl_m.pmdl054 = '1'
      END IF
      
      #取匯率
      IF NOT cl_null(g_pmdl_m.pmdl015) THEN
         #根據內外購獲取當前營運據點參數設置的汇率类型
         LET l_scc40 = ''
         IF g_pmdl_m.pmdl054 = '1' THEN   #內購
            LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
         END IF
         IF g_pmdl_m.pmdl054 = '2' THEN   #外購
            LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
         END IF
         LET l_ooef016 = ''
         SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
         IF NOT cl_null(l_scc40) THEN
            CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmdl_m.pmdl015,l_ooef016,0,l_scc40) RETURNING g_pmdl_m.pmdl016
         END IF
      END IF
      
      CALL apmt500_pmdl009_ref(g_pmdl_m.pmdl009) RETURNING g_pmdl_m.pmdl009_desc
      CALL apmt500_pmdl010_ref(g_pmdl_m.pmdl010) RETURNING g_pmdl_m.pmdl010_desc
      CALL apmt500_pmdl011_ref(g_pmdl_m.pmdl011) RETURNING g_pmdl_m.pmdl011_desc
      CALL apmt500_pmdl015_ref(g_pmdl_m.pmdl015) RETURNING g_pmdl_m.pmdl015_desc
      CALL apmt500_pmdl017_ref(g_pmdl_m.pmdl017) RETURNING g_pmdl_m.pmdl017_desc
      CALL apmt500_pmdl023_ref(g_pmdl_m.pmdl023) RETURNING g_pmdl_m.pmdl023_desc
      CALL apmt500_pmdl024_ref(g_pmdl_m.pmdl024) RETURNING g_pmdl_m.pmdl024_desc
      CALL apmt500_pmdl033_ref(g_pmdl_m.pmdl033) RETURNING g_pmdl_m.pmdl033_desc
      CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
      
      CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc  #160804-00022#1
      
      DISPLAY BY NAME g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010,g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011,g_pmdl_m.pmdl011_desc,
                      g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,
                      g_pmdl_m.pmdl017_desc,g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc,
                      g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc
                      
      #抓取交易對象夥伴關係檔且交易類型為"1:收/付款對象"的交易對象顯示在採購單上的
      #[C:帳款供應商]，若有設置多筆收/付款交易對象時，則取有勾選主要的交易對象那一個，
      #若沒有設交易對象夥伴關係檔且交易類型為"1:收/付款對象"的交易對象時，則[C:帳款供應商]預設採購供應商
      LET g_pmdl_m.pmdl021 = ''
      LET g_pmdl_m.pmdl021_desc = ''
      SELECT pmac002 INTO g_pmdl_m.pmdl021 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmdl_m.pmdl004 AND pmac003 = '1' AND pmacstus = 'Y' AND pmac004 = 'Y'
      IF cl_null(g_pmdl_m.pmdl021) THEN
         SELECT pmac002 INTO g_pmdl_m.pmdl021 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmdl_m.pmdl004 AND pmac003 = '1' AND pmacstus = 'Y' AND rownum = 1
         IF cl_null(g_pmdl_m.pmdl021) THEN
            LET g_pmdl_m.pmdl021 = g_pmdl_m.pmdl004
         END IF
      END IF
      CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
      DISPLAY BY NAME g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc
      
      #抓取交易對象夥伴關係檔且交易類型為"2:出貨對象"的交易對象顯示在採購單上的[C:送貨供應商]，
      #若有設置多筆出貨交易對象時，則取有勾選主要的交易對象那一個，
      #若沒有設交易對象夥伴關係檔且交易類型為"2:出貨對象"的交易對象時，則[C:送貨供應商]預設採購供應商
      LET g_pmdl_m.pmdl022 = ''
      LET g_pmdl_m.pmdl022_desc = ''
      SELECT pmac002 INTO g_pmdl_m.pmdl022 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmdl_m.pmdl004 AND pmac003 = '2' AND pmacstus = 'Y' AND pmac004 = 'Y'
      IF cl_null(g_pmdl_m.pmdl022) THEN
         SELECT pmac002 INTO g_pmdl_m.pmdl022 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmdl_m.pmdl004 AND pmac003 = '2' AND pmacstus = 'Y' AND rownum = 1
         IF cl_null(g_pmdl_m.pmdl022) THEN
            LET g_pmdl_m.pmdl022 = g_pmdl_m.pmdl004
         END IF
      END IF
      CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
      DISPLAY BY NAME g_pmdl_m.pmdl022,g_pmdl_m.pmdl022_desc
      
      #抓取交易對象聯絡人明細檔的聯絡對像識別碼顯示在採購單上的[C:供應商連絡人]，
      #若有設置多個聯絡人時，則取有勾選主要聯絡人的那一個
      LET g_pmdl_m.pmdl027 = ''
      LET g_pmdl_m.pmdl027_desc = ''
      SELECT pmaj002 INTO g_pmdl_m.pmdl027 FROM pmaj_t WHERE pmajent = g_enterprise AND pmaj001 = g_pmdl_m.pmdl004 AND pmajstus = 'Y' AND pmaj004 = 'Y'
      IF cl_null(g_pmdl_m.pmdl022) THEN
         SELECT pmaj002 INTO g_pmdl_m.pmdl027 FROM pmaj_t WHERE pmajent = g_enterprise AND pmaj001 = g_pmdl_m.pmdl004 AND pmajstus = 'Y' AND pmaj004 = 'Y' AND rownum = 1  
      END IF
      CALL apmt500_pmdl027_ref(g_pmdl_m.pmdl004,g_pmdl_m.pmdl027) RETURNING g_pmdl_m.pmdl027_desc
      DISPLAY BY NAME g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc
      
END FUNCTION
#根据不同的资料来源类型，判断资料的有效否
PRIVATE FUNCTION apmt500_pmdl008_chk()
DEFINE r_success     LIKE type_t.num5
DEFINE l_n           LIKE type_t.num5
DEFINE l_flag        LIKE type_t.num5
DEFINE l_sum_pmdn007 LIKE pmdn_t.pmdn007
DEFINE l_pmdn007     LIKE pmdn_t.pmdn007
DEFINE l_pmdnseq     LIKE pmdn_t.pmdnseq
DEFINE l_pmdp023     LIKE pmdp_t.pmdp023
DEFINE l_sfca003     LIKE sfca_t.sfca003

       LET r_success = TRUE
       
       #150909 earl add s
       IF NOT s_aooi210_check_doc(g_site,'',g_pmdl_m.pmdl008,g_pmdl_m.pmdldocno,'4','') THEN
          LET r_success = FALSE
          RETURN r_success
       END IF
       #150909 earl add e
       
       CASE g_pmdl_m.pmdl007
          WHEN '2'  #請購單
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
             
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = g_pmdl_m.pmdl008
 
             #呼叫檢查存在並帶值的library
             IF NOT cl_chk_exist("v_pmdadocno") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
         #WHEN '3'  #訂單
          WHEN '4'  #工單
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
             
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = g_pmdl_m.pmdl008
             
             #呼叫檢查存在並帶值的library
             IF g_pmdl_m.pmdl006 = '8' THEN   #協作採購單
                IF NOT cl_chk_exist("v_sfcbdocno_2") THEN
                   #檢查失敗時後續處理
                   LET r_success = FALSE
                   RETURN r_success
                END IF
             ELSE
                IF NOT cl_chk_exist("v_sfcbdocno_1") THEN
                   #檢查失敗時後續處理
                   LET r_success = FALSE
                   RETURN r_success
                END IF
                #判斷是否存在可委外的數量
                #LET l_n = 0
                #SELECT COUNT(1) INTO l_n FROM sfcb_t 
                #  WHERE sfcbent   = g_enterprise AND
                #       ((CASE WHEN sfcb027 IS NULL THEN 0 ELSE sfcb027 END)+(CASE WHEN sfcb029 IS NULL THEN 0 ELSE sfcb029 END)+(CASE WHEN sfcb030 IS NULL THEN 0 ELSE sfcb030 END)+
                #        (CASE WHEN sfcb031 IS NULL THEN 0 ELSE sfcb031 END)+(CASE WHEN sfcb032 IS NULL THEN 0 ELSE sfcb032 END)-(CASE WHEN sfcb033 IS NULL THEN 0 ELSE sfcb033 END)-
                #        (CASE WHEN sfcb034 IS NULL THEN 0 ELSE sfcb034 END)-(CASE WHEN sfcb035 IS NULL THEN 0 ELSE sfcb035 END)-(CASE WHEN sfcb036 IS NULL THEN 0 ELSE sfcb036 END)-
                #        (CASE WHEN sfcb037 IS NULL THEN 0 ELSE sfcb037 END)-(CASE WHEN sfcb038 IS NULL THEN 0 ELSE sfcb038 END)-(CASE WHEN sfcb039 IS NULL THEN 0 ELSE sfcb039 END)-
                #        (CASE WHEN sfcb041 IS NULL THEN 0 ELSE sfcb041 END)-(CASE WHEN sfcb042 IS NULL THEN 0 ELSE sfcb042 END)) > 0 
                #   AND sfcbdocno = g_pmdl_m.pmdl008
                #160112-00016#1--mark--begin---
                #SELECT SUM(pmdp023) INTO l_pmdp023 FROM pmdp_t,pmdl_t 
                #  WHERE pmdpent = pmdlent AND pmdpent = g_enterprise
                #   AND pmdpdocno = pmdldocno
                #   AND pmdp003   = g_pmdl_m.pmdl008          
                #   AND pmdlstus <> 'X' 
                #   AND pmdldocno <> g_pmdl_m.pmdldocno
                #SELECT sfca003 INTO l_sfca003 FROM sfca_t WHERE sfcaent = g_enterprise AND sfcadocno = g_pmdl_m.pmdl008
                #IF cl_null(l_pmdp023) THEN
                #   LET l_pmdp023 = 0
                #END IF
                #160112-00016#1--mark--end---
                #160112-00016#1--add--begin---
                #可委外数大于0时才可委外
                #可委外數=標準產出數量(sfcb027)+重工轉入(sfcb029)+工單轉入(sfcb030)+分割轉入(sfcb031)+合併轉入(sfcb032)
                #        -良品轉出(sfcb033)-重工轉出(sfcb034)-工單轉出(sfcb035)-當站報廢(sfcb036)-當站下線(sfcb037)
                #        -分割轉出(sfcb038)-合併轉出(sfcb039)-委外數量(sfcb041)+委外完工數量(sfcb042) 
                SELECT COUNT(1) INTO l_n FROM sfcb_t 
                 WHERE sfcbent = g_enterprise AND sfcbsite = g_site
                   AND sfcbdocno = g_pmdl_m.pmdl008
                   AND (sfcb027+sfcb029+sfcb030+sfcb031+sfcb032-sfcb033-sfcb034-sfcb035-sfcb036-sfcb037-sfcb038-sfcb039-sfcb041+sfcb042) > 0
                #160112-00016#1--add--end---
                #IF l_pmdp023 = l_sfca003 THEN  #160112-00016#1 mark
                IF l_n = 0 OR cl_null(l_n) THEN #160112-00016#1 add
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.code = 'apm-00772'
                   LET g_errparam.extend = g_pmdl_m.pmdl008
                   LET g_errparam.popup = TRUE
                   CALL cl_err()
                   LET r_success = FALSE
                END IF
             END IF
         #WHEN '5'  #MRP
         
         WHEN '7'  #倉退
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
             
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = g_pmdl_m.pmdl008
             
             #呼叫檢查存在並帶值的library
             IF NOT cl_chk_exist("v_pmdsdocno_5") THEN
                #檢查失敗時後續處理
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #該來源單據不可存在一筆未確認的採購單
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdl008 = g_pmdl_m.pmdl008 AND pmdlstus = 'N'
             IF l_n > 0 THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00618'
                LET g_errparam.extend = g_pmdl_m.pmdl008
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
          WHEN '8'  #預先採購
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
              #160318-00025#15 by 07900 --add-str 
              LET g_errshow = TRUE #是否開窗
              #160318-00025#15 by 07900 --add-end
              
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = g_pmdl_m.pmdl008
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00337:sub-01302|apmt500|",cl_get_progname("apmt500",g_lang,"2"),"|:EXEPROGapmt500"
              #160318-00025#15 by 07900 --add-end
              
             #呼叫檢查存在並帶值的library
             IF NOT cl_chk_exist("v_pmdldocno_2") THEN
                #檢查失敗時後續處理
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #該來源單據不可存在一筆未確認的採購單
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdl008 = g_pmdl_m.pmdl008 AND pmdlstus = 'N'
             IF l_n > 0 THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00618'
                LET g_errparam.extend = g_pmdl_m.pmdl008
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
             LET l_flag = FALSE
       
             DECLARE pmdl008_chk_cs CURSOR FOR
                SELECT pmdnseq,pmdn007 FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdl008
             FOREACH pmdl008_chk_cs INTO l_pmdnseq,l_pmdn007
                #已轉採購單的數量
                SELECT SUM(pmdn007) INTO l_sum_pmdn007 FROM pmdn_t,pmdl_t 
                   WHERE pmdlent = pmdnent AND pmdldocno = pmdndocno AND pmdl008 = g_pmdl_m.pmdl008 
                     AND pmdnseq = l_pmdnseq AND pmdlstus <> 'X'
                IF cl_null(l_sum_pmdn007) THEN
                   LET l_sum_pmdn007 = 0
                END IF
                IF l_pmdn007 > l_sum_pmdn007 THEN
                   LET l_flag = TRUE
                   EXIT FOREACH
                END IF
                
             END FOREACH
             #該來源單據的可採購數量已為零
             IF NOT l_flag THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00619'
                LET g_errparam.extend = g_pmdl_m.pmdl008
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
            END IF
            
       END CASE
       RETURN r_success
       
END FUNCTION

################################################################################
# Descriptions...: 聯絡人的名稱是抓axmi100的全名顯示
# Memo...........:
# Usage..........: CALL apmt500_pmdl027_ref(p_pmdl004,p_pmdl027)
#                : RETURNING r_pmaj012
# Input parameter: p_pmdl004   交易對象編號
#                : p_pmdl027   聯絡人識別碼
# Return code....: r_pmaj012   全名
# Date & Author..: 150527 By whitney
# Modify.........: 
################################################################################
PRIVATE FUNCTION apmt500_pmdl027_ref(p_pmdl004,p_pmdl027)
DEFINE p_pmdl004   LIKE pmdl_t.pmdl004
DEFINE p_pmdl027   LIKE pmdl_t.pmdl027
DEFINE r_pmaj012   LIKE pmaj_t.pmaj012 

   LET r_pmaj012 = ''

   IF cl_null(p_pmdl004) OR cl_null(p_pmdl027) THEN
      RETURN r_pmaj012
   END IF

   SELECT pmaj012 INTO r_pmaj012
     FROM pmaj_t
    WHERE pmajent = g_enterprise
      AND pmaj001 = p_pmdl004
      AND pmaj002 = p_pmdl027
   RETURN r_pmaj012
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl009_ref(p_pmdl009)
DEFINE p_pmdl009      LIKE pmdl_t.pmdl009
DEFINE r_ooibl004     LIKE ooibl_t.ooibl004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl009
       CALL ap_ref_array2(g_ref_fields,"SELECT ooibl004 FROM ooibl_t WHERE ooiblent='"||g_enterprise||"' AND ooibl002=? AND ooibl003='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_ooibl004 = g_rtn_fields[1]
       RETURN r_ooibl004
       
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl010_ref(p_pmdl010)
DEFINE p_pmdl010      LIKE pmdl_t.pmdl010
DEFINE r_oocql004     LIKE oocql_t.oocql004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl010
       CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='238' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_oocql004 = g_rtn_fields[1]
       RETURN r_oocql004
       
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl011_ref(p_pmdl011)
DEFINE p_pmdl011      LIKE pmdl_t.pmdl011
DEFINE r_oodbl004     LIKE oodbl_t.oodbl004

       LET r_oodbl004 = ''
       CALL s_desc_get_tax_desc(g_ooef019,p_pmdl011) RETURNING r_oodbl004
       RETURN r_oodbl004
      
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl015_ref(p_pmdl015)
DEFINE p_pmdl015      LIKE pmdl_t.pmdl015
DEFINE r_ooail003     LIKE ooail_t.ooail003

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl015
       CALL ap_ref_array2(g_ref_fields,"SELECT ooail003 FROM ooail_t WHERE ooailent='"||g_enterprise||"' AND ooail001=? AND ooail002='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_ooail003 = '', g_rtn_fields[1] , ''
       RETURN r_ooail003
     
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl017_ref(p_pmdl017)
DEFINE p_pmdl017    LIKE pmdl_t.pmdl017
DEFINE r_pmaml003   LIKE pmaml_t.pmaml003

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl017
       CALL ap_ref_array2(g_ref_fields,"SELECT pmaml003 FROM pmaml_t WHERE pmamlent='"||g_enterprise||"' AND pmaml001=? AND pmaml002='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_pmaml003 = '', g_rtn_fields[1] , ''
       RETURN r_pmaml003
     
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl018_ref(p_pmdl018)
DEFINE p_pmdl018    LIKE pmdl_t.pmdl018
DEFINE r_ooidl003   LIKE ooidl_t.ooidl003

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl018
       CALL ap_ref_array2(g_ref_fields,"SELECT ooidl003 FROM ooidl_t WHERE ooidlent='"||g_enterprise||"' AND ooidl001=? AND ooidl002='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_ooidl003 = '', g_rtn_fields[1] , ''
       RETURN r_ooidl003
     
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl020_ref(p_pmdl020)
DEFINE p_pmdl020   LIKE pmdl_t.pmdl020
DEFINE r_oocql004  LIKE oocql_t.oocql004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl020
       CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='263' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_oocql004 = '', g_rtn_fields[1] , ''
       RETURN r_oocql004

END FUNCTION

PRIVATE FUNCTION apmt500_pmdl025_ref(p_pmdl025)
DEFINE p_pmdl025   LIKE pmdl_t.pmdl025
DEFINE r_oofb011   LIKE oofb_t.oofb011

       LET r_oofb011 =  ''
       SELECT oofb011 INTO r_oofb011 FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = g_oofa001 AND oofb008 = '3' AND oofb019 = p_pmdl025
       RETURN r_oofb011
       
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl026_ref(p_pmdl026)
DEFINE p_pmdl026   LIKE pmdl_t.pmdl026
DEFINE r_oofb011   LIKE oofb_t.oofb011

       LET r_oofb011 =  ''
       SELECT oofb011 INTO r_oofb011 FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = g_oofa001 AND oofb008 = '5' AND oofb019 = p_pmdl026
       RETURN r_oofb011
     
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl003_chk(p_pmdl003)
DEFINE p_pmdl003   LIKE pmdl_t.pmdl003
DEFINE r_success   LIKE type_t.num5
   
       LET r_success = TRUE
       
       IF NOT cl_null(p_pmdl003) THEN 
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL
          #160318-00025#15 by 07900 --add-str 
          LET g_errshow = TRUE #是否開窗
          #160318-00025#15 by 07900 --add-end
          
          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = p_pmdl003
          LET g_chkparam.arg2 = g_pmdl_m.pmdldocdt
          #160318-00025#15 by 07900 --add-str 
          LET g_chkparam.err_str[1] ="aoo-00029:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
          #160318-00025#15 by 07900 --add-end
          #呼叫檢查存在並帶值的library
          IF NOT cl_chk_exist("v_ooeg001") THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF 
       RETURN r_success
       
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl023_ref(p_pmdl023)
DEFINE p_pmdl023     LIKE pmdl_t.pmdl023
DEFINE r_oocql004    LIKE oocql_t.oocql004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl023
       #160621-00003#3 20160627 modify by beckxie---S
       #CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='275' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
       CALL ap_ref_array2(g_ref_fields,"SELECT oojdl003 FROM oojdl_t WHERE oojdlent='"||g_enterprise||"' AND oojdl001=? AND oojdl002='"||g_dlang||"'","") RETURNING g_rtn_fields
       #160621-00003#3 20160627 modify by beckxie---E
       LET r_oocql004 = '', g_rtn_fields[1] , ''
       RETURN r_oocql004

END FUNCTION

PRIVATE FUNCTION apmt500_pmdl023_chk(p_pmdl023)
DEFINE p_pmdl023    LIKE pmdl_t.pmdl023
DEFINE r_success    LIKE type_t.num5
DEFINE l_msg1       LIKE gzze_t.gzze003   #160621-00003#3 20160629 add by beckxie
       LET r_success = TRUE
       #160621-00003#3 20160629 add by beckxie---S
       SELECT gzze003 INTO l_msg1 
         FROM gzze_t 
        WHERE gzze001 = 'aoo-00309' 
          AND gzze002 = g_dlang   
       #160621-00003#3 20160629 add by beckxie---E
       IF NOT cl_null(p_pmdl023) THEN
          #160621-00003#3 20160627 modify by beckxie---S
          #IF NOT s_azzi650_chk_exist('275',p_pmdl023) THEN
          INITIALIZE g_chkparam.* TO NULL
          LET g_chkparam.arg1 = p_pmdl023
          LET g_chkparam.arg2 = '2'
          LET g_chkparam.err_str[1] = "aoo-00299|",l_msg1
          IF NOT cl_chk_exist("v_oojd001") THEN
          #160621-00003#3 20160627 modify by beckxie---E
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
       RETURN r_success
       
END FUNCTION
#維護多長期預付款單身
PRIVATE FUNCTION apmt500_open_pmdm()
DEFINE  l_cmd           LIKE type_t.chr1
DEFINE  l_ac_t          LIKE type_t.num5                #未取消的ARRAY CNT 
DEFINE  l_n             LIKE type_t.num5                #檢查重複用  
DEFINE  l_cnt           LIKE type_t.num5                #檢查重複用  
DEFINE  l_lock_sw       LIKE type_t.chr1                #單身鎖住否  
DEFINE  l_allow_insert  LIKE type_t.num5                #可新增否 
DEFINE  l_allow_delete  LIKE type_t.num5                #可刪除否  
DEFINE  l_count         LIKE type_t.num5
DEFINE  l_i             LIKE type_t.num5
DEFINE  l_insert        BOOLEAN
DEFINE  ls_return       STRING
DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
DEFINE  l_vars          DYNAMIC ARRAY OF STRING
DEFINE  l_fields        DYNAMIC ARRAY OF STRING
DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
DEFINE  l_pmdm005       LIKE pmdm_t.pmdm005
DEFINE  l_pmdm006       LIKE pmdm_t.pmdm006
DEFINE  l_forupd_sql    STRING
DEFINE  l_pmdl040       LIKE pmdl_t.pmdl040
DEFINE  l_pmdl041       LIKE pmdl_t.pmdl041
DEFINE  l_oodbl004      LIKE oodbl_t.oodbl004  #稅別名稱
DEFINE  l_oodb005       LIKE oodb_t.oodb005    #含稅否
DEFINE  l_oodb006       LIKE oodb_t.oodb006    #稅率
DEFINE  l_oodb011       LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定
DEFINE  l_success       LIKE type_t.num5
DEFINE  l_pmdl013       LIKE pmdl_t.pmdl013
DEFINE  l_xrcd103        LIKE xrcd_t.xrcd103
DEFINE  l_xrcd104        LIKE xrcd_t.xrcd104
DEFINE  l_xrcd105        LIKE xrcd_t.xrcd105
DEFINE  l_xrcd113        LIKE xrcd_t.xrcd113
DEFINE  l_xrcd114        LIKE xrcd_t.xrcd114
DEFINE  l_xrcd115        LIKE xrcd_t.xrcd115



   IF g_pmdl_m.pmdldocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF
   
   #SELECT UNIQUE pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004,pmdl003,pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl009,pmdl010,pmdl011,pmdl012,pmdl013,pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl043,pmdl044,pmdl020,pmdl025,pmdl026,pmdl029,pmdl021,pmdl022,pmdl032,pmdl023,pmdl024,pmdl030,pmdl031,pmdl028,pmdl040,pmdl041,pmdl042,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp,pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt
   #   INTO g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl023,g_pmdl_m.pmdl024,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt
   # FROM pmdl_t
   # WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
 
   SELECT pmdl013,pmdl040,pmdl041 INTO l_pmdl013,l_pmdl040,l_pmdl041 FROM pmdl_t
    WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
    
   IF cl_null(l_pmdl040) THEN
      LET l_pmdl040 = 0
   END IF
   
   IF cl_null(l_pmdl041) THEN
      LET l_pmdl041 = 0
   END IF
   
   #取得稅別類型
   CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
     RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
   IF l_success THEN
      LET g_tax_app = l_oodb011
   END IF  
   
   ERROR ""
  
   CALL s_transaction_begin()
   
  LET l_forupd_sql = " SELECT pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004, 
       pmdl003,pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009, 
       pmdl010,pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018, 
       pmdl019,pmdl023,pmdl043,pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029, 
       pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl040, 
       pmdl041,pmdl042,pmdl047,pmdl048,pmdl049,pmdl046,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp, 
       pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt", 
                      " FROM pmdl_t",
                      " WHERE pmdlent= ? AND pmdldocno=? FOR UPDATE"

   LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)                #轉換不同資料庫語法
   DECLARE apmt500_cl2 CURSOR FROM l_forupd_sql    
   OPEN apmt500_cl2 USING g_enterprise,g_pmdl_m.pmdldocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt500_cl2:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt500_cl2
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改的資料
   FETCH apmt500_cl2 INTO g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt, 
       g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,
       g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027, 
       g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,
       g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,
       g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,
       g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl046,g_pmdl_m.pmdlownid,
       g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt, 
       g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_pmdl_m.pmdldocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE apmt500_cl2
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   DISPLAY BY NAME g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl023,g_pmdl_m.pmdl024,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042
   
   CALL apmt500_show()  
   
   LET g_forupd_sql = "SELECT pmdmsite,pmdm001,pmdm014,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007,pmdm008,pmdm009 FROM pmdm_t WHERE pmdment=? AND pmdmdocno=? AND pmdm001=? FOR UPDATE"
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   DECLARE apmt500_bcl5 CURSOR FROM g_forupd_sql

   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'

   
   LET g_errshow = 1
   
   LET g_flag1 = TRUE
   #取得稅別類型
   CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
     RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
   IF l_success THEN
      LET g_tax_app = l_oodb011
   END IF 
   CALL apmt500_set_entry('u')
   CALL apmt500_set_no_required()
   CALL apmt500_set_required()
   CALL apmt500_set_no_entry('u')
   
   WHILE TRUE   #160520-00026#2-add
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      INPUT BY NAME g_pmdl_m.pmdl046 ATTRIBUTE(WITHOUT DEFAULTS)
      
         BEFORE INPUT
            CALL s_transaction_begin()
            
            
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
            UPDATE pmdl_t SET pmdl046 = g_pmdl_m.pmdl046 
              WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
            CASE
               WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = "std-00009"
                  LET g_errparam.extend = "pmdl_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
               WHEN SQLCA.sqlcode #其他錯誤
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "pmdl_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
               OTHERWISE
                  CALL s_transaction_end('Y','0')
            END CASE              
            
      END INPUT
      
      INPUT ARRAY g_pmdn6_d FROM s_detail6.*
         ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                 INSERT ROW = l_allow_insert,
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)
                 

         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_pmdn6_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 

            CALL apmt500_b_fill()
            LET g_rec_b = g_pmdn6_d.getLength()
            
         BEFORE INSERT
            
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmdn6_d[l_ac].* TO NULL 
            LET g_pmdn6_d[l_ac].pmdmsite = g_site
            
            SELECT MAX(pmdm001)+1 INTO g_pmdn6_d[l_ac].pmdm001 FROM pmdm_t
              WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
            IF cl_null(g_pmdn6_d[l_ac].pmdm001) OR g_pmdn6_d[l_ac].pmdm001 = 0 THEN
               LET g_pmdn6_d[l_ac].pmdm001 = 1
            END IF
           #161012-00055#1-s-add 
            IF l_ac > 1 THEN
               #自動推算剩餘金額
               LET l_pmdm005 = 0
               LET l_pmdm006 = 0
               CALL apmt500_get_amt(g_pmdl_m.pmdldocno,g_pmdn6_d[l_ac].pmdm001,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041)
                 RETURNING l_pmdm005,l_pmdm006
               IF l_pmdm005 = 0  OR l_pmdm006 = 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'axm-00628' #分期帳款含稅/未稅金額總合，已達到整單總含稅/未稅金額，不可再新增！
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CANCEL INSERT
               ELSE
                  LET g_pmdn6_d[l_ac].pmdm005 = l_pmdm005
                  LET g_pmdn6_d[l_ac].pmdm006 = l_pmdm006
                  #若 預收款發票開立方式="1.不開發票" AND 帳款類型="2.訂金"
                  IF g_pmdl_m.pmdl046 = '1' AND g_pmdn6_d[l_ac].pmdm014 = '2' THEN
                     #含稅否
                     IF g_pmdl_m.pmdl013 = "Y" THEN
                        LET g_pmdn6_d[l_ac].pmdm005 = l_pmdm006
                     ELSE
                        LET g_pmdn6_d[l_ac].pmdm006 = l_pmdm005
                     END IF
                  END IF
               END IF                 
            END IF            
           #161012-00055#1-e-add
            
            LET g_pmdn6_d_t.* = g_pmdn6_d[l_ac].*     #新輸入資料
            LET g_pmdn6_d_o.* = g_pmdn6_d[l_ac].*
            CALL cl_show_fld_cont()
            CALL apmt500_set_entry_b(l_cmd)
            CALL apmt500_set_no_required_b()
            CALL apmt500_set_required_b()
            CALL apmt500_set_no_entry_b(l_cmd)
            
         BEFORE ROW     
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            
            OPEN apmt500_cl2 USING g_enterprise,g_pmdl_m.pmdldocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  STATUS
               LET g_errparam.extend = "OPEN apmt500_cl2:"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CLOSE apmt500_cl2
               CALL s_transaction_end('N','0')
               RETURN
            END IF
           
            LET g_rec_b = g_pmdn6_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_pmdn6_d[l_ac].pmdm001 IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_pmdn6_d_t.* = g_pmdn6_d[l_ac].*  #BACKUP
               LET g_pmdn6_d_o.* = g_pmdn6_d[l_ac].*
               CALL apmt500_set_entry_b(l_cmd)
               CALL apmt500_set_no_required_b()
               CALL apmt500_set_required_b()
               CALL apmt500_set_no_entry_b(l_cmd)
               
               OPEN apmt500_bcl5 USING g_enterprise,g_pmdl_m.pmdldocno,g_pmdn6_d[l_ac].pmdm001
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "apmt500_bcl5"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt500_bcl5 INTO g_pmdn6_d[l_ac].pmdmsite,g_pmdn6_d[l_ac].pmdm001,g_pmdn6_d[l_ac].pmdm014,g_pmdn6_d[l_ac].pmdm002,g_pmdn6_d[l_ac].pmdm003,g_pmdn6_d[l_ac].pmdm004,g_pmdn6_d[l_ac].pmdm005,g_pmdn6_d[l_ac].pmdm006,g_pmdn6_d[l_ac].pmdm007,g_pmdn6_d[l_ac].pmdm008,g_pmdn6_d[l_ac].pmdm009
                   IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET l_lock_sw = "Y"
                  END IF
                  
                  INITIALIZE g_ref_fields TO NULL
                  LET g_ref_fields[1] = g_pmdn6_d[l_ac].pmdm002
                  CALL ap_ref_array2(g_ref_fields,"SELECT ooibl004 FROM ooibl_t WHERE ooiblent='"||g_enterprise||"' AND ooibl002=? AND ooibl003='"||g_dlang||"'","") RETURNING g_rtn_fields
                  LET g_pmdn6_d[l_ac].pmdm002_desc = '', g_rtn_fields[1] , ''
                  DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm002_desc
                  
                  LET g_bfill = "N"
                  CALL apmt500_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF            
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_pmdn6_d.deleteElement(l_ac)
               NEXT FIELD pmdm001
            END IF
         
            IF g_pmdn6_d[l_ac].pmdm001 IS NOT NULL
            THEN
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CANCEL DELETE
               END IF
               
               DELETE FROM pmdm_t
                WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno AND
                      pmdm001 = g_pmdn6_d_t.pmdm001

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "pmdn_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL DELETE   
               ELSE
                  LET g_rec_b = g_rec_b-1

                  CALL s_transaction_end('Y','0')
               END IF 
               CLOSE apmt500_bcl5
               LET l_count = g_pmdn_d.getLength()
            END IF 

         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM pmdm_t 
             WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
               AND pmdm001 = g_pmdn6_d[l_ac].pmdm001
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               INSERT INTO pmdm_t
                  (pmdment,pmdmdocno,pmdm001,pmdmsite,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007,pmdm008,pmdm009,pmdm014) 
                 VALUES(g_enterprise,g_pmdl_m.pmdldocno,g_pmdn6_d[l_ac].pmdm001,
                   g_pmdn6_d[l_ac].pmdmsite,g_pmdn6_d[l_ac].pmdm002,g_pmdn6_d[l_ac].pmdm003, 
                   g_pmdn6_d[l_ac].pmdm004,g_pmdn6_d[l_ac].pmdm005,g_pmdn6_d[l_ac].pmdm006, 
                   g_pmdn6_d[l_ac].pmdm007,g_pmdn6_d[l_ac].pmdm008,g_pmdn6_d[l_ac].pmdm009,g_pmdn6_d[l_ac].pmdm014) 

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "pmdm_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
  
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               END IF
            ELSE    
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()

               INITIALIZE g_pmdn_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF
            
            CALL s_transaction_end('Y','0')
            ERROR 'INSERT O.K'
            LET g_rec_b = g_rec_b + 1
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               LET g_pmdn6_d[l_ac].* = g_pmdn6_d_t.*
               CLOSE apmt500_bcl5
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_pmdn6_d[l_ac].* = g_pmdn6_d_t.*
            ELSE
               UPDATE pmdm_t SET (pmdmdocno,pmdmsite,pmdm001,pmdm002,pmdm003,pmdm004,pmdm005,pmdm006,pmdm007,pmdm008,pmdm009,pmdm014) = (g_pmdl_m.pmdldocno,g_pmdn6_d[l_ac].pmdmsite,g_pmdn6_d[l_ac].pmdm001,g_pmdn6_d[l_ac].pmdm002,g_pmdn6_d[l_ac].pmdm003,g_pmdn6_d[l_ac].pmdm004,g_pmdn6_d[l_ac].pmdm005,g_pmdn6_d[l_ac].pmdm006,g_pmdn6_d[l_ac].pmdm007,g_pmdn6_d[l_ac].pmdm008,g_pmdn6_d[l_ac].pmdm009,g_pmdn6_d[l_ac].pmdm014) #自訂欄位頁簽
                WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
                  AND pmdm001 = g_pmdn6_d_t.pmdm001 #項次                   
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "std-00009"
                     LET g_errparam.extend = "pmdm_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_pmdn6_d[l_ac].* = g_pmdn6_d_t.*
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "pmdm_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
  
                     CALL s_transaction_end('N','0')
                     LET g_pmdn6_d[l_ac].* = g_pmdn6_d_t.*
                  OTHERWISE
                      #INITIALIZE gs_keys TO NULL 
                      #LET gs_keys[1] = g_pmdl_m.pmdldocno
                      #LET gs_keys_bak[1] = g_pmdldocno_t
                      #LET gs_keys[2] = g_pmdn6_d[g_detail_idx].pmdm001
                      #LET gs_keys_bak[2] = g_pmdn6_d_t.pmdm001
                      #CALL apmt500_update_b('pmdm_t',gs_keys,gs_keys_bak,"'5'")
                     #資料多語言用-增/改
                     
               END CASE
            END IF
         
         #---------------------<  Detail: page5  >---------------------
         #----<<pmdm001>>----
         #此段落由子樣板a02產生
         AFTER FIELD pmdm001
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_pmdn6_d[l_ac].pmdm001,"0.000","0","","","azz-00079",1) THEN
               LET g_pmdn6_d[l_ac].pmdm001 = g_pmdn6_d_t.pmdm001
               NEXT FIELD pmdm001
            END IF

            #此段落由子樣板a05產生
            IF  g_pmdl_m.pmdldocno IS NOT NULL AND g_pmdn6_d[l_ac].pmdm001 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdl_m.pmdldocno != g_pmdldocno_t OR g_pmdn6_d[l_ac].pmdm001 != g_pmdn6_d_t.pmdm001)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdm_t WHERE "||"pmdment = '" ||g_enterprise|| "' AND "||"pmdmdocno = '"||g_pmdl_m.pmdldocno ||"' AND "|| "pmdm001 = '"||g_pmdn6_d[l_ac].pmdm001 ||"'",'std-00004',0) THEN 
                     LET g_pmdn6_d[l_ac].pmdm001 = g_pmdn6_d_t.pmdm001
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
         
         #160520-00026#2-add-(S)
         AFTER FIELD pmdm014
            IF NOT cl_null(g_pmdn6_d[l_ac].pmdm014) AND g_pmdl_m.pmdl046 = '1' THEN
               #IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_pmdn6_d[l_ac].pmdm014 <> g_pmdn6_d_o.pmdm014 OR g_pmdn6_d_t.pmdm014 IS NULL)) THEN   #160824-00007#346 Mark By Ken 170109
               IF (g_pmdn6_d[l_ac].pmdm014 <> g_pmdn6_d_o.pmdm014 OR g_pmdn6_d_o.pmdm014 IS NULL) THEN    #160824-00007#346 Add By Ken 170109
                  CASE
                     WHEN g_pmdn6_d[l_ac].pmdm014 = '2' AND g_pmdn6_d_o.pmdm014 <> '2'
                        #含稅否
                        IF g_pmdl_m.pmdl013 = 'Y' THEN
                           #未稅金額=含稅金額
                           LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d[l_ac].pmdm006
                        ELSE
                           #含稅金額=未稅金額
                           LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d[l_ac].pmdm005
                        END IF
                     WHEN g_pmdn6_d[l_ac].pmdm014 <> '2' AND g_pmdn6_d_o.pmdm014 = '2'
                        #含稅否
                        IF g_pmdl_m.pmdl013 = 'Y' THEN
                           CALL s_tax_count(g_site,g_pmdl_m.pmdl011,g_pmdn6_d[l_ac].pmdm006,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
                               RETURNING g_pmdn6_d[l_ac].pmdm005,l_xrcd104,l_xrcd105,l_xrcd113,l_xrcd114,l_xrcd115
                        ELSE
                           CALL s_tax_count(g_site,g_pmdl_m.pmdl011,g_pmdn6_d[l_ac].pmdm005,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
                               RETURNING l_xrcd103,l_xrcd104,g_pmdn6_d[l_ac].pmdm006,l_xrcd113,l_xrcd114,l_xrcd115
                        END IF
                  END CASE
                  DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm005,g_pmdn6_d[l_ac].pmdm006
               END IF
            END IF
            LET g_pmdn6_d_o.pmdm014 = g_pmdn6_d[l_ac].pmdm014
            LET g_pmdn6_d_o.* = g_pmdn6_d[l_ac].*    #160824-00007#346 Add By Ken 170109
         #160520-00026#2-add-(E)
         
         #----<<pmdm002>>----
         #此段落由子樣板a02產生
         AFTER FIELD pmdm002
            CALL apmt500_pmdl009_ref(g_pmdn6_d[l_ac].pmdm002) RETURNING g_pmdn6_d[l_ac].pmdm002_desc
            DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm002_desc
            
            IF NOT cl_null(g_pmdn6_d[l_ac].pmdm002) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdl_m.pmdl004
               LET g_chkparam.arg2 = g_pmdn6_d[l_ac].pmdm002
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmad002_1") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdn6_d[l_ac].pmdm002 = g_pmdn6_d_t.pmdm002
                  CALL apmt500_pmdl009_ref(g_pmdn6_d[l_ac].pmdm002) RETURNING g_pmdn6_d[l_ac].pmdm002_desc
                  DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm002_desc
                  NEXT FIELD CURRENT
               END IF
               
               #自動推算預計應付款日、預計票據到期日
               CALL s_fin_date_ap_payable(g_site,g_pmdl_m.pmdl004,g_pmdn6_d[l_ac].pmdm002,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdldocdt)
                  RETURNING l_success,g_pmdn6_d[l_ac].pmdm003,g_pmdn6_d[l_ac].pmdm004
               DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm003,g_pmdn6_d[l_ac].pmdm004
               
            END IF 

         AFTER FIELD pmdm004
            IF g_pmdn6_d[l_ac].pmdm003 > g_pmdn6_d[l_ac].pmdm004 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'adb-00080'
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()
               NEXT FIELD CURRENT
            END IF
            
         AFTER FIELD pmdm005
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_pmdn6_d[l_ac].pmdm005,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdm005
            END IF
            IF NOT cl_null(g_pmdn6_d[l_ac].pmdm005) THEN
               IF g_pmdn6_d[l_ac].pmdm005 != g_pmdn6_d_o.pmdm005 OR g_pmdn6_d_o.pmdm005 IS NULL THEN            
                  
                  #多帳期預付款金額加總不可超過整張採購單總採購金額(含未稅金額均不能超過)
                  LET l_pmdm005 = 0
                 #161012-00055#1-s-add
                  CALL apmt500_get_amt(g_pmdl_m.pmdldocno,g_pmdn6_d[l_ac].pmdm001,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041)
                    RETURNING l_pmdm005,l_pmdm006
                  #170111-00065#1-s
                  IF g_pmdl_m.pmdl046 = '1' THEN  #不開立發票
                     IF g_pmdn6_d[l_ac].pmdm005 > l_pmdm006 THEN  #含稅金額
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'apm-00264'
                        LET g_errparam.extend = g_pmdl_m.pmdldocno
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_t.pmdm005
                        NEXT FIELD pmdm005                  
                     END IF
                  ELSE
                  #170111-00065#1-e
                  IF g_pmdn6_d[l_ac].pmdm005 > l_pmdm005 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00263'
                     LET g_errparam.extend = g_pmdl_m.pmdldocno
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_t.pmdm005  #160824-00007#346 Mark By Ken 170109
                     LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_o.pmdm005   #160824-00007#346 Add By Ken 170109
                     NEXT FIELD pmdm005                  
                  END IF
                  END IF  #170111-00065#1
                 #161012-00055#1-e-add
                 #161012-00055#1-s-mark 
                 #SELECT SUM(pmdm005) INTO l_pmdm005 FROM pmdm_t 
                 #   WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
                 #IF cl_null(l_pmdm005) THEN
                 #   LET l_pmdm005 = 0
                 #END IF
                 #
                 #IF cl_null(g_pmdn6_d_t.pmdm005) THEN
                 #   LET g_pmdn6_d_t.pmdm005 = 0
                 #END IF
                 #IF l_pmdm005 + g_pmdn6_d[l_ac].pmdm005 - g_pmdn6_d_t.pmdm005 > l_pmdl041 THEN
                 #   INITIALIZE g_errparam TO NULL
                 #   LET g_errparam.code = 'apm-00263'
                 #   LET g_errparam.extend = g_pmdl_m.pmdldocno
                 #   LET g_errparam.popup = TRUE
                 #   CALL cl_err()
                 #   LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_t.pmdm005
                 #   NEXT FIELD pmdm005
                 #END IF
                 #161012-00055#1-e-mark 
                  #稅率依單頭需未稅金額自動推算含稅金額
                  #IF g_tax_app = '1' THEN
                     #160824-00007#346 Mark By Ken 170109(S)
                     #IF cl_null(g_pmdn6_d[l_ac].pmdm006) OR g_pmdn6_d[l_ac].pmdm006 = 0 OR 
                     #    g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_t.pmdm006 THEN
                     #160824-00007#346 Mark By Ken 170109(E)
                     #160824-00007#346 Add By Ken 170109(S)
                     IF cl_null(g_pmdn6_d[l_ac].pmdm006) OR g_pmdn6_d[l_ac].pmdm006 = 0 OR 
                         g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_o.pmdm006 THEN                     
                     #160824-00007#346 Add By Ken 170109(E)
                         #160520-00026#2-mod-(S)
#                         #CALL s_tax_get_xrcd105(g_pmdn6_d[l_ac].pmdm005,g_pmdl_m.pmdl012,g_pmdl_m.pmdl015)
#                         #  RETURNING g_pmdn6_d[l_ac].pmdm006
#                         CALL s_tax_count(g_site,g_pmdl_m.pmdl011,g_pmdn6_d[l_ac].pmdm005,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
#                            RETURNING l_xrcd103,l_xrcd104,g_pmdn6_d[l_ac].pmdm006,l_xrcd113,l_xrcd114,l_xrcd115
                         #推算含稅金額
                         #170111-00065#1-s
                         ##---預收款發票開立方式="1.不開發票" AND 帳款類型='2.訂金'
                         #IF g_pmdl_m.pmdl046 = '1' AND g_pmdn6_d[l_ac].pmdm014 = '2' THEN
                         #預收款發票開立方式="1.不開發票" AND 帳款類型='1.簽約金'或'2.訂金'
                         IF g_pmdl_m.pmdl046 = '1' AND g_pmdn6_d[l_ac].pmdm014 MATCHES '[12]' THEN
                         #170111-00065#1-e
                            #含稅金額=未稅金額
                            LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d[l_ac].pmdm005
                         ELSE
                            CALL s_tax_count(g_site,g_pmdl_m.pmdl011,g_pmdn6_d[l_ac].pmdm005,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
                               RETURNING l_xrcd103,l_xrcd104,g_pmdn6_d[l_ac].pmdm006,l_xrcd113,l_xrcd114,l_xrcd115
                         END IF
                         #160520-00026#2-mod-(E)
                         DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm006  
                     END IF
                  #END IF
               END IF
               
               #呼叫幣別取位應用元件對單價作取位(依單頭幣別做取位基準)
               CALL s_curr_round(g_site,g_pmdl_m.pmdl015,g_pmdn6_d[l_ac].pmdm005,'2') RETURNING g_pmdn6_d[l_ac].pmdm005
               CALL s_curr_round(g_site,g_pmdl_m.pmdl015,g_pmdn6_d[l_ac].pmdm006,'2') RETURNING g_pmdn6_d[l_ac].pmdm006         
              
            END IF
            
            LET g_pmdn6_d_o.pmdm005 = g_pmdn6_d[l_ac].pmdm005
            LET g_pmdn6_d_o.* = g_pmdn6_d[l_ac].*    #160824-00007#346 Add By Ken 170109

         AFTER FIELD pmdm006
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_pmdn6_d[l_ac].pmdm006,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdm006
            END IF
            IF NOT cl_null(g_pmdn6_d[l_ac].pmdm006) THEN
               IF g_pmdn6_d[l_ac].pmdm006 != g_pmdn6_d_o.pmdm006 OR g_pmdn6_d_o.pmdm006 IS NULL THEN                                    
                  LET l_pmdm006 = 0
                 #161012-00055#1-s-add
                  CALL apmt500_get_amt(g_pmdl_m.pmdldocno,g_pmdn6_d[l_ac].pmdm001,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041)
                    RETURNING l_pmdm005,l_pmdm006 
                  IF g_pmdn6_d[l_ac].pmdm006 > l_pmdm006 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00264'
                     LET g_errparam.extend = g_pmdl_m.pmdldocno
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     #LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_t.pmdm006  #160824-00007#346 Mark By Ken 170109
                     LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_o.pmdm006   #160824-00007#346 Add By Ken 170109
                     NEXT FIELD pmdm006                
                  END IF                   
                 #161012-00055#1-e-add
                 #161012-00055#1-s-mark 
                 #SELECT SUM(pmdm006) INTO l_pmdm006 FROM pmdm_t 
                 #   WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
                 #IF cl_null(l_pmdm006) THEN
                 #   LET l_pmdm006 = 0
                 #END IF
                 #IF cl_null(g_pmdn6_d_t.pmdm006) THEN
                 #   LET g_pmdn6_d_t.pmdm006 = 0
                 #END IF
                 #IF l_pmdm006 + g_pmdn6_d[l_ac].pmdm006 - g_pmdn6_d_t.pmdm006 > l_pmdl041 THEN
                 #   INITIALIZE g_errparam TO NULL
                 #   LET g_errparam.code = 'apm-00264'
                 #   LET g_errparam.extend = g_pmdl_m.pmdldocno
                 #   LET g_errparam.popup = TRUE
                 #   CALL cl_err()
                 #   LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_t.pmdm006
                 #   NEXT FIELD pmdm006
                 #END IF
                 #161012-00055#1-e-mark  
                   #稅率依單頭需含稅金額自動推算未稅金額
                  #IF g_tax_app = '1' THEN
                     #160824-00007#346 Mark By Ken 170109(S)
                     #IF cl_null(g_pmdn6_d[l_ac].pmdm005) OR g_pmdn6_d[l_ac].pmdm005 = 0 OR 
                     #    g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_t.pmdm005 THEN
                     #160824-00007#346 Mark By Ken 170109(E)
                     #160824-00007#346 Add By Ken 170109(S)
                     IF cl_null(g_pmdn6_d[l_ac].pmdm005) OR g_pmdn6_d[l_ac].pmdm005 = 0 OR 
                         g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_o.pmdm005 THEN 
                     #160824-00007#346 Add By Ken 170109(E)                         
                         #160520-00026#2-mod-(S)
#                         CALL s_tax_get_xrcd103(g_pmdn6_d[l_ac].pmdm006,g_pmdl_m.pmdl012,g_pmdl_m.pmdl015)
#                            RETURNING g_pmdn6_d[l_ac].pmdm005
#                         CALL s_tax_count(g_site,g_pmdl_m.pmdl011,g_pmdn6_d[l_ac].pmdm006,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
#                            RETURNING g_pmdn6_d[l_ac].pmdm005,l_xrcd104,l_xrcd105,l_xrcd113,l_xrcd114,l_xrcd115
                         #---預收款發票開立方式="1.不開發票" AND 帳款類型='2.訂金'
                         IF g_pmdl_m.pmdl046 = '1' AND g_pmdn6_d[l_ac].pmdm014 = '2' THEN
                            #未稅金額=含稅金額
                            LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d[l_ac].pmdm006
                         ELSE
                            CALL s_tax_count(g_site,g_pmdl_m.pmdl011,g_pmdn6_d[l_ac].pmdm006,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
                               RETURNING g_pmdn6_d[l_ac].pmdm005,l_xrcd104,l_xrcd105,l_xrcd113,l_xrcd114,l_xrcd115
                         END IF
                         #160520-00026#2-mod-(E)
                         DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm005  
                     END IF
                  #END IF
                  
                END IF
                
                #呼叫幣別取位應用元件對單價作取位(依單頭幣別做取位基準)
                CALL s_curr_round(g_site,g_pmdl_m.pmdl015,g_pmdn6_d[l_ac].pmdm005,'2') RETURNING g_pmdn6_d[l_ac].pmdm005
                CALL s_curr_round(g_site,g_pmdl_m.pmdl015,g_pmdn6_d[l_ac].pmdm006,'2') RETURNING g_pmdn6_d[l_ac].pmdm006         
                
             END IF
                          
             LET g_pmdn6_d_o.pmdm006 = g_pmdn6_d[l_ac].pmdm006             
             LET g_pmdn6_d_o.* = g_pmdn6_d[l_ac].*    #160824-00007#346 Add By Ken 170109
         #---------------------<  Detail: page5  >---------------------
         #----<<pmdm002>>----
         #Ctrlp:input.c.page5.pmdm002
         ON ACTION controlp INFIELD pmdm002
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdn6_d[l_ac].pmdm002             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdl_m.pmdl004 #

            CALL q_pmad002_2()                                #呼叫開窗

            LET g_pmdn6_d[l_ac].pmdm002 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdn6_d[l_ac].pmdm002 TO pmdm002              #顯示到畫面上
            CALL apmt500_pmdl009_ref(g_pmdn6_d[l_ac].pmdm002) RETURNING g_pmdn6_d[l_ac].pmdm002_desc
            DISPLAY BY NAME g_pmdn6_d[l_ac].pmdm002_desc

            NEXT FIELD pmdm002                          #返回原欄位

 
         AFTER ROW
            LET l_ac = ARR_CURR()
            LET l_ac_t = l_ac
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_pmdn6_d[l_ac].* = g_pmdn6_d_t.*
               END IF
               CLOSE apmt500_bcl5
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
            
            #多帳期預付款金額加總不可超過整張採購單總採購金額(含未稅金額均不能超過)
            #LET l_pmdm005 = 0
            #LET l_pmdm006 = 0
            #SELECT SUM(pmdm005) INTO l_pmdm005 FROM pmdm_t 
            #   WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
            #SELECT SUM(pmdm006) INTO l_pmdm006 FROM pmdm_t 
            #   WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
            #IF cl_null(l_pmdm005) THEN
            #   LET l_pmdm005 = 0
            #END IF
            #IF cl_null(l_pmdm006) THEN
            #   LET l_pmdm006 = 0
            #END IF
            #IF l_pmdm005 > g_pmdl_m.pmdl040 THEN
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.code = 'apm-00263'
            #   LET g_errparam.extend = g_pmdl_m.pmdldocno
            #   LET g_errparam.popup = TRUE
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')  
            #
            #   NEXT FIELD pmdm005
            #END IF
            #IF l_pmdm006 > g_pmdl_m.pmdl041 THEN
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.code = 'apm-00264'
            #   LET g_errparam.extend = g_pmdl_m.pmdldocno
            #   LET g_errparam.popup = TRUE
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')  
            #
            #   LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_t.pmdm006
            #   NEXT FIELD pmdm006
            #END IF
            
            #其他table進行unlock
            CLOSE apmt500_bcl5
            CALL s_transaction_end('Y','0')  
            
         AFTER INPUT
            #160520-00026#2-mark-(S)  整段移至apmt500_pmdm005_pmdm006_total_chk中
#            #多帳期預付款金額加總不可超過整張採購單總採購金額(含未稅金額均不能超過)
#            LET l_pmdm005 = 0
#            LET l_pmdm006 = 0
#            SELECT SUM(pmdm005) INTO l_pmdm005 FROM pmdm_t 
#               WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
#            SELECT SUM(pmdm006) INTO l_pmdm006 FROM pmdm_t 
#               WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
#            #含稅時，比較整張單據的含稅金額，未稅時，比較未稅總金額
#            IF l_pmdl013 = 'Y' THEN 
#               IF l_pmdm006 <> g_pmdl_m.pmdl041 THEN
#                  INITIALIZE g_errparam TO NULL
#                  LET g_errparam.code = 'apm-00588'
#                  LET g_errparam.extend = g_pmdl_m.pmdldocno
#                  LET g_errparam.popup = TRUE
#                  CALL cl_err()
#               
#                  LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_t.pmdm006
#                  NEXT FIELD pmdm006
#               END IF
#            ELSE
#               IF l_pmdm005 <> g_pmdl_m.pmdl040 THEN
#                  INITIALIZE g_errparam TO NULL
#                  LET g_errparam.code = 'apm-00587'
#                  LET g_errparam.extend = g_pmdl_m.pmdldocno
#                  LET g_errparam.popup = TRUE
#                  CALL cl_err()
#               
#                  NEXT FIELD pmdm005
#               END IF
#            END IF
            #160520-00026#2-mark-(E)
            #160520-00026#2-add-(S)
            #重新計算含稅/未稅的值
            IF g_pmdl_m.pmdl046 = '1' THEN
               IF NOT apmt500_pmdm005_pmdm006_upd() THEN
                 NEXT FIELD CURRENT
               END IF
            END IF
            #160520-00026#2-add-(E)
      END INPUT
   
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         CALL cl_set_head_visible("","AUTO")
 
      ON ACTION accept
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
         
   END DIALOG
   #160520-00026#2-add-(S)
      #採購總未稅金額/採購總含稅金額 檢查
      CALL apmt500_pmdm005_pmdm006_total_chk() RETURNING l_success
      IF l_success AND g_pmdl_m.pmdl046 = '1' THEN
         #計算整張單輸入的未稅/含稅金額
         SELECT SUM(pmdm005),SUM(pmdm006) INTO l_pmdm005,l_pmdm006 
           FROM pmdm_t 
           WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
         #含稅否
         IF g_pmdl_m.pmdl013 = "Y" THEN
            #含稅的單，調未稅金額
            CALL apmt500_pmdm006_adjust(l_pmdm005) RETURNING l_success
         ELSE
            #未稅的單，調含稅金額
            CALL apmt500_pmdm005_adjust(l_pmdm006) RETURNING l_success
         END IF
      END IF
      
      IF l_success THEN
         CALL apmt500_b_fill()
         EXIT WHILE
      ELSE
         CONTINUE WHILE
      END IF
   END WHILE
   #160520-00026#2-add-(E)
   CLOSE apmt500_cl2
   LET g_flag1 = FALSE
   LET INT_FLAG = FALSE
            
END FUNCTION
#料件編號檢查
PRIVATE FUNCTION apmt500_pmdn001_chk(p_pmdn001)
DEFINE p_pmdn001     LIKE pmdn_t.pmdn001
DEFINE l_flag        LIKE type_t.num5
DEFINE l_success     LIKE type_t.num5
DEFINE l_ooba002     LIKE ooba_t.ooba002
DEFINE l_pmdp007     LIKE pmdp_t.pmdp007
DEFINE r_success     LIKE type_t.num5
DEFINE l_pmdp008     LIKE pmdp_t.pmdp008

       LET r_success = TRUE
       
       IF NOT cl_null(p_pmdn001) THEN 
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL
          
          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = p_pmdn001
             
          #呼叫檢查存在並帶值的library
          IF cl_chk_exist("v_imaa001") THEN
             IF NOT cl_chk_exist("v_imaf001_14") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          ELSE
             LET r_success = FALSE
             RETURN r_success
          END IF
          
          #判斷輸入的料件編號是否在控制組限制的產品範圍內，若不在限制內則不允許請購此料
          CALL s_control_chk_group('3','4',g_user,g_dept,p_pmdn001,'','','','') RETURNING l_success,l_flag
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00265'
                LET g_errparam.extend = p_pmdn001
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF 
          END IF
          
          #檢核輸入的料件的生命週期是否在單據別限制範圍內，若不在限制內則不允許請購此料
       #  CALL s_control_chk_doc('4',g_pmdl_m.pmdldocno,p_pmdn001,'','','','') RETURNING l_success,l_flag   #mark by yany
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                #CALL cl_err(p_pmdn001,'ain-00015',1)
                LET r_success = FALSE
                RETURN r_success
             END IF 
          END IF
          
          #檢核輸入的料件的產品分類是否在單據別限制範圍內，若不在限制內則不允許請購此料
      #   CALL s_control_chk_doc('5',g_pmdl_m.pmdldocno,p_pmdn001,'','','','') RETURNING l_success,l_flag    #mark by yany
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                LET r_success = FALSE
                #CALL cl_err(p_pmdn001,'apm-00238',1)
                RETURN r_success
             END IF 
          END IF
          
          #若單據別設置是要作請採勾稽時，則修改料號時必須檢核是否與"關聯單據明細"中的來源料號有替代關係
          CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
          IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0061') = "Y" THEN
             DECLARE pmdp007_cur CURSOR FOR
                SELECT DISTINCT pmdp007,pmdp008 FROM pmdp_t 
                  WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdl_m.pmdldocno
                    AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
             FOREACH pmdp007_cur INTO l_pmdp007,l_pmdp008
                IF l_pmdp007 <> p_pmdn001 THEN
                   #請採購替代是否依據BOM替代資料
                   #選Y時，代表請購轉採購時可以依據BOM替代資料進行採購料的替代
                   #若選N，則是依據apmi131採購替代原則的設定進行採購料的替代
                   IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0096') = "Y" THEN
                      IF NOT s_apmt500_chk_bom_replace(l_pmdp007,p_pmdn001,g_pmdn_d[l_ac].pmdn002) THEN
                         LET r_success = FALSE
                         RETURN r_success
                      END IF
                   ELSE                   
                      IF NOT s_pmaq_chk_replacement(g_pmdl_m.pmdl004,l_pmdp007,p_pmdn001,'2',l_pmdp008,g_pmdn_d[l_ac].pmdn002) THEN
                         LET r_success = FALSE
                         RETURN r_success
                      END IF
                   END IF
                   
                END IF
             END FOREACH
          END IF
          
          #檢查料件編號是否符合條件
         #IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,p_pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d[l_ac].pmdnseq) THEN #add by lixiang 2015/10/15 pmdn007 #add by lixiang 2015/12/04 add pmdldocno，pmdnseq   #170207-00046#1 mark
          IF NOT s_apmt500_item_avl_chk(g_pmdl_m.pmdldocdt,p_pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn007,g_pmdl_m.pmdldocno,g_pmdn_d_t.pmdnseq) THEN #170207-00046#1 add
             LET r_success = FALSE
             RETURN r_success
          END IF
          
          #151229 earl add s
          #多角製造批序號檢查
          IF NOT s_apmt500_inao_chk(g_pmdl_m.pmdldocno,g_pmdl_m.pmdl051,p_pmdn001) THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
          #151229 earl add e
          
       END IF
       RETURN r_success
       
END FUNCTION
#料件編號帶品名、規格
PRIVATE FUNCTION apmt500_pmdn001_ref(p_pmdn001)
DEFINE p_pmdn001     LIKE pmdn_t.pmdn001
DEFINE r_imaal003    LIKE imaal_t.imaal003
DEFINE r_imaal004    LIKE imaal_t.imaal004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdn001
       CALL ap_ref_array2(g_ref_fields,"SELECT imaal003,imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_imaal003 = '', g_rtn_fields[1] , ''
       LET r_imaal004 = '', g_rtn_fields[2] , ''
       RETURN r_imaal003,r_imaal004
       
END FUNCTION
#根據料件編號、供應商、採購控制組帶出欄位預設值
PRIVATE FUNCTION apmt500_pmdn001_desc()
DEFINE l_n         LIKE type_t.num5
DEFINE l_success   LIKE type_t.num5
DEFINE l_controlno LIKE ooha_t.ooha001
DEFINE l_imaf158   LIKE imaf_t.imaf158

      LET l_n = 0
      LET g_pmdn_d[l_ac].pmdn006 = ''
      LET g_pmdn_d[l_ac].pmdn006_desc = ''
      LET g_pmdn_d[l_ac].pmdn010 = ''
      LET g_pmdn_d[l_ac].pmdn010_desc = ''
      #LET g_pmdn2_d[l_ac].pmdn028 = ''
      #LET g_pmdn2_d[l_ac].pmdn028_desc = ''
      #LET g_pmdn2_d[l_ac].pmdn029 = ''
      #LET g_pmdn2_d[l_ac].pmdn029_desc = ''
      LET g_pmdn2_d[l_ac].pmdn003 = ''
      LET g_pmdn2_d[l_ac].pmdn003_desc = ''
      LET g_pmdn2_d[l_ac].pmdn033 = ''
      
      #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
      #LET l_controlno = ''
      #CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,l_controlno
      IF cl_null(g_controlno) THEN
         CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,g_controlno
      END IF
      
      #IF NOT cl_null(l_controlno) THEN
      IF NOT cl_null(g_controlno) THEN
         SELECT COUNT(1) INTO l_n FROM pmap_t 
            WHERE pmapent = g_enterprise AND pmapsite = g_site AND pmap001 = g_pmdl_m.pmdl004
              #AND pmap002 = l_controlno 
              AND pmap002 = g_controlno 
              AND pmap003 = g_pmdn_d[l_ac].pmdn001 AND pmap004 = g_pmdn_d[l_ac].pmdn002
         #若採購料件有設置'供應商控制組料件預設條件'(apmi121)時，則需將設置的預設條件值預設到採購單對應欄位
         IF l_n > 0 THEN
            #SELECT pmap006,pmap008,pmap009,pmap010,pmap011,pmap012,pmap014,pmap005
            #  INTO g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdnunit,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn031,g_pmdn2_d[l_ac].pmdn003
            SELECT pmap006,pmap008,pmap009,pmap012,pmap014,pmap005
              INTO g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn_d[l_ac].pmdnunit,g_pmdn2_d[l_ac].pmdn025,g_pmdn2_d[l_ac].pmdn031,g_pmdn2_d[l_ac].pmdn003
            
            FROM pmap_t 
            WHERE pmapent = g_enterprise AND pmapsite = g_site AND pmap001 = g_pmdl_m.pmdl004
              #AND pmap002 = l_controlno
              AND pmap002 = g_controlno 
              AND pmap003 = g_pmdn_d[l_ac].pmdn001 AND pmap004 = g_pmdn_d[l_ac].pmdn002
  
         END IF
      END IF
      
      #IF cl_null(l_controlno) OR l_n = 0 THEN   
      IF cl_null(g_controlno) OR l_n = 0 THEN   
         #沒有設置'供應商控制組料件預設條件'(apmi121)才改抓料件進銷存檔預設的條件
         #SELECT imaf143,imaf144,imaf091,imaf092,imaf157
         #  INTO g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn2_d[l_ac].pmdn028,g_pmdn2_d[l_ac].pmdn029,g_pmdn2_d[l_ac].pmdn003
         SELECT imaf143,imaf144,imaf157
           INTO g_pmdn_d[l_ac].pmdn006,g_pmdn_d[l_ac].pmdn010,g_pmdn2_d[l_ac].pmdn003
           FROM imaf_t
         WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001  
      END IF
      
      CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn006) RETURNING g_pmdn_d[l_ac].pmdn006_desc
      CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn010) RETURNING g_pmdn_d[l_ac].pmdn010_desc
      CALL apmt500_pmdl004_ref(g_pmdn_d[l_ac].pmdnunit) RETURNING g_pmdn_d[l_ac].pmdnunit_desc
      
      #若稅別應用為2.依料件設定，呼叫應用元件帶出稅別、稅率
      IF g_tax_app = '2' AND NOT cl_null(g_pmab039) THEN
         #依料件檢核是否有依交易分類設定稅別
         #151208-00004#2--mark---begin----
         #CALL s_tax_chktype(g_pmdl_m.pmdlsite,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,'2',g_pmab039)
         #  RETURNING l_success,g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn017 
         #151208-00004#2--mark---end----
         #151208-00004#2--add---begin----
         CALL s_tax_by_item(g_pmdl_m.pmdlsite,g_pmdl_m.pmdl011,g_pmdl_m.pmdl004,g_pmdn_d[l_ac].pmdn001,'2',g_pmab039)
            RETURNING l_success,g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn017          
         #151208-00004#2--add---end----
         IF l_success THEN
            CALL s_desc_get_tax_desc1(g_site,g_pmdn_d[l_ac].pmdn016) RETURNING g_pmdn_d[l_ac].pmdn016_desc
         ELSE
            #檢查失敗時後續處理
            LET g_pmdn_d[l_ac].pmdn016 = ''
            LET g_pmdn_d[l_ac].pmdn016_desc = ''
            LET g_pmdn_d[l_ac].pmdn017 = ''
         END IF           
      ELSE
         LET g_pmdn_d[l_ac].pmdn016 = g_pmdl_m.pmdl011
         LET g_pmdn_d[l_ac].pmdn017 = g_pmdl_m.pmdl012
      END IF             
      DISPLAY BY NAME g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn016_desc,g_pmdn_d[l_ac].pmdn017
      
      #[C:備品率] = [T:料件進銷存檔].[C:採購備品率]  imaf165
      #[C:參考單位] = [T:料件進銷存檔][C:參考單位]   imaf015
      #若[T:料件進銷存檔].[C:接單拆解方式(採購)]的值為'1:自動CKD'或是'2:自動SKD'時，imaf158
      #則[C:子件特性]的值預設'2:CKD'或是'3:SKD'
      LET g_pmdn_d[l_ac].pmdn008 = ''
      LET g_pmdn_d[l_ac].pmdn008_desc = ''
      LET g_pmdn2_d[l_ac].pmdn033 = ''
      LET g_pmdn_d[l_ac].pmdn019 = '1'
      LET l_imaf158 = ''
      SELECT imaf158,imaf165,imaf015 INTO l_imaf158,g_pmdn2_d[l_ac].pmdn033,g_pmdn_d[l_ac].pmdn008 FROM imaf_t
        WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
      IF l_imaf158 = '1' THEN
         LET g_pmdn_d[l_ac].pmdn019 = '2'
      END IF
      IF l_imaf158 = '2' THEN
         LET g_pmdn_d[l_ac].pmdn019 = '3'
      END IF
      
      CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn008) RETURNING g_pmdn_d[l_ac].pmdn008_desc
      
      #整體參數使用採購計價單位時:
      #[C:計價單位]=[T:料件據點進銷存檔].[C:採購計價單位] 
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  
         SELECT imaf144 INTO g_pmdn_d[l_ac].pmdn010 FROM imaf_t
            WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
      END IF
      CALL apmt500_unit_ref(g_pmdn_d[l_ac].pmdn010) RETURNING g_pmdn_d[l_ac].pmdn010_desc
      
      #若採購料件有設置'交易對象對應料號'(apmi070)有供應商料號時，需將對應的料號抓出顯示在
      #[C:供應商料號]欄位上，若有設置多筆對應料號時以有勾選主要對應料那一筆為預設值
      LET g_pmdn2_d[l_ac].pmdn027 = ''
      SELECT pmao004 INTO g_pmdn2_d[l_ac].pmdn027 FROM pmao_t 
        WHERE pmaoent = g_enterprise AND pmao001 = g_pmdl_m.pmdl004 AND pmao002 = g_pmdn_d[l_ac].pmdn001 
          AND pmao003 = g_pmdn_d[l_ac].pmdn002 AND pmao007 = 'Y'
          AND pmao000 = '1'      #161221-00064##5 add
      IF cl_null(g_pmdn2_d[l_ac].pmdn027) THEN
         SELECT pmao004 INTO g_pmdn2_d[l_ac].pmdn027 FROM pmao_t 
           WHERE pmaoent = g_enterprise AND pmao001 = g_pmdl_m.pmdl004 AND pmao002 = g_pmdn_d[l_ac].pmdn001 
             AND pmao000 = '1'      #161221-00064##5 add
             AND pmao003 = g_pmdn_d[l_ac].pmdn002 AND rownum = 1
             
          SELECT pmao009,pmao010
            INTO g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
            FROM pmao_t
           WHERE pmaoent = g_enterprise
             AND pmao001 = g_pmdl_m.pmdl004
             AND pmao002 = g_pmdn_d[l_ac].pmdn001
             AND pmao003 = g_pmdn_d[l_ac].pmdn002
             AND pmao004 = g_pmdn2_d[l_ac].pmdn027                      
             AND pmao000 = '1'      #161221-00064##5 add
         DISPLAY BY NAME g_pmdn2_d[l_ac].l_pmao009,g_pmdn2_d[l_ac].l_pmao010
      END IF 

      CALL apmt500_get_qcap006(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn002,g_pmdn_d[l_ac].pmdn004,g_pmdn_d[l_ac].pmdn005) RETURNING g_pmdn_d[l_ac].pmdn052
      
END FUNCTION

PRIVATE FUNCTION apmt500_pmdn004_ref(p_pmdn004)
DEFINE p_pmdn004   LIKE pmdn_t.pmdn004
DEFINE r_oocql004  LIKE oocql_t.oocql004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdn004
       CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='221' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_oocql004 = '', g_rtn_fields[1] , ''
       RETURN r_oocql004

END FUNCTION
#單位資料檢查
PRIVATE FUNCTION apmt500_unit_chk(p_pmdn006)
DEFINE p_pmdn006    LIKE pmdn_t.pmdn006
DEFINE r_success    LIKE type_t.num5
       
       LET r_success = TRUE
       
       IF NOT cl_null(p_pmdn006) THEN 
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL
          
          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = g_pmdn_d[l_ac].pmdn001
          LET g_chkparam.arg2 = p_pmdn006
   
          #呼叫檢查存在並帶值的library
          IF NOT cl_chk_exist("v_imao002") THEN
             LET r_success = FALSE
             RETURN r_success             
          END IF
       END IF 
       RETURN r_success 

END FUNCTION
#單位帶出說明
PRIVATE FUNCTION apmt500_unit_ref(p_pmdn006)
DEFINE p_pmdn006    LIKE pmdn_t.pmdn006
DEFINE r_oocal003   LIKE oocal_t.oocal003

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdn006
       CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_oocal003 = '', g_rtn_fields[1] , ''
       RETURN r_oocal003
       
END FUNCTION
#根據單位取位類型對數量進行取位
PRIVATE FUNCTION apmt500_unit_round(p_pmdn006,p_pmdn007)
DEFINE p_pmdn006   LIKE pmdn_t.pmdn006     #單位
DEFINE p_pmdn007   LIKE pmdn_t.pmdn007     #數量
DEFINE l_success   LIKE type_t.num5
DEFINE l_ooca002   LIKE ooca_t.ooca002      #小数位数
DEFINE l_ooca004   LIKE ooca_t.ooca004      #舍入类型 
DEFINE r_pmdn007   LIKE pmdn_t.pmdn007     #數量
        
       LET l_success = NULL
       LET l_ooca002 = 0
       LET l_ooca004 = NULL
       LET r_pmdn007 = 0
       
       #抓取单位档中的小数位数和舍入类型
       IF NOT cl_null(p_pmdn006) THEN
          CALL s_aooi250_get_msg(p_pmdn006) RETURNING l_success,l_ooca002,l_ooca004
          IF l_success THEN
             IF NOT cl_null(p_pmdn007) THEN
                CALL s_num_round(l_ooca004,p_pmdn007,l_ooca002) RETURNING r_pmdn007
                RETURN r_pmdn007
             END IF
          END IF
       END IF
       RETURN r_pmdn007
       
END FUNCTION
#根據到庫日期計算緊急度
PRIVATE FUNCTION apmt500_pmdn014_to_pmdn020()
DEFINE l_imaf171    LIKE imaf_t.imaf171
DEFINE l_imaf172    LIKE imaf_t.imaf172
DEFINE l_imaf173    LIKE imaf_t.imaf173
DEFINE l_imaf174    LIKE imaf_t.imaf174
DEFINE l_imaf175    LIKE imaf_t.imaf175
DEFINE l_time1      LIKE imaf_t.imaf171
DEFINE l_time2      LIKE imaf_t.imaf171

        IF NOT cl_null(g_pmdn_d[l_ac].pmdn014) THEN  
          LET l_imaf171 = 0
          LET l_imaf172 = 0
          LET l_imaf173 = 0
          LET l_imaf174 = 0
          LET l_imaf175 = 0
          LET l_time1 = 0
          LET l_time2 = 0
          
          SELECT imaf171,imaf172,imaf173,imaf174,imaf175 INTO l_imaf171,l_imaf172,l_imaf173,l_imaf174,l_imaf175
            FROM imaf_t 
            WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdn_d[l_ac].pmdn001
            
          #160222-00020#1--add---begin---
          #若是料件未設置，則抓取aoo020上設置的資料
          IF cl_null(l_imaf171) OR l_imaf171 = 0 THEN
             LET l_imaf171 =  cl_get_para(g_enterprise,g_site,'S-BAS-0024')
          END IF
          IF cl_null(l_imaf172) OR l_imaf172 = 0 THEN
             LET l_imaf172 =  cl_get_para(g_enterprise,g_site,'S-BAS-0025')
          END IF
          IF cl_null(l_imaf173) OR l_imaf173 = 0 THEN
             LET l_imaf173 =  cl_get_para(g_enterprise,g_site,'S-BAS-0026')
          END IF
          IF cl_null(l_imaf174) OR l_imaf174 = 0 THEN
             LET l_imaf174 =  cl_get_para(g_enterprise,g_site,'S-BAS-0027')
          END IF
          #160222-00020#1--add---end--- 

          LET l_time1 = g_pmdn_d[l_ac].pmdn014 - g_today         #到庫日期  - g_today
          LET l_time2 = l_imaf171+l_imaf172+l_imaf173+l_imaf174  #[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數
          
          #1.若輸入的到庫日期 - g_today >[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數時，則[C:緊急度] = '1'(一般)
          IF l_time1 >= l_time2 THEN
             LET g_pmdn_d[l_ac].pmdn020 = '1'
          END IF
          
          #2.若輸入的到庫日期 - g_today <[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數，
          #   且到庫日期 - g_today >[T:料件據點進銷存檔].[C:嚴守交期前置時間]時，則[C:緊急度] = '2'(緊急)
          IF l_time1 < l_time2 AND l_time1 >= l_imaf175 THEN
             LET g_pmdn_d[l_ac].pmdn020 = '2'
          END IF
          
          #3.若輸入的到庫日期 - g_today <[T:料件據點進銷存檔].[C:嚴守交期前置時間]時，則[C:緊急度] = '3'(特急)
          IF l_time1 < l_imaf175 THEN
             LET g_pmdn_d[l_ac].pmdn020 = '3'
          END IF
       END IF
            
END FUNCTION
#檢查營運據點
PRIVATE FUNCTION apmt500_pmdnunit_chk(p_pmdnunit)
DEFINE p_pmdnunit   LIKE pmdn_t.pmdnunit
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5
DEFINE r_success    LIKE type_t.num5

   LET r_success = TRUE
   
   IF NOT cl_null(p_pmdnunit) THEN 
      #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
      INITIALIZE g_chkparam.* TO NULL
      #160318-00025#15 by 07900 --add-str 
      LET g_errshow = TRUE #是否開窗
      #160318-00025#15 by 07900 --add-end
      
      #設定g_chkparam.*的參數
      LET g_chkparam.arg1 = p_pmdnunit
      #160318-00025#15 by 07900 --add-str 
      LET g_chkparam.err_str[1] ="aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
      #160318-00025#15 by 07900 --add-end
      
      #呼叫檢查存在並帶值的library
      #IF NOT cl_chk_exist("v_ooef001") THEN    #161019-00017#3
      IF NOT cl_chk_exist("v_ooef001_13") THEN  #161019-00017#3
         LET r_success = FALSE
         RETURN r_success
      END IF
      #檢核輸入的營運據點是否在採購控制組的限制範圍內
      CALL s_control_chk_group('5','4',g_user,g_dept,p_pmdnunit ,'','','','') RETURNING l_success,l_flag
      IF NOT l_success THEN      #处理状态
         LET r_success = FALSE
         RETURN r_success
      ELSE
         IF NOT l_flag THEN      #是否存在
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'apm-00274'
            LET g_errparam.extend = p_pmdnunit
            LET g_errparam.popup = TRUE
            CALL cl_err()
    
            LET r_success = FALSE
            RETURN r_success
         END IF 
      END IF
    
   END IF 

   RETURN r_success  #150814 earl add
END FUNCTION
#根據營運據點獲取該營運據點的收貨地址
PRIVATE FUNCTION apmt500_get_oofb019(p_site)
DEFINE p_site     LIKE ooef_t.ooef001
DEFINE l_oofa001  LIKE oofa_t.oofa001
DEFINE r_oofb019  LIKE oofb_t.oofb019
DEFINE r_oofb011  LIKE oofb_t.oofb011

      LET r_oofb019 = ''
      LET r_oofb011 = ''

      #獲取當前營運據點的聯絡對象識別碼
      LET l_oofa001 = ''
      SELECT oofa001 INTO l_oofa001 FROM oofa_t WHERE oofaent = g_enterprise AND oofa002 = '1' AND oofa003 = p_site
      
      IF NOT cl_null(l_oofa001) THEN
         #主要出貨地址
         SELECT oofb019,oofb011 INTO r_oofb019,r_oofb011 FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = l_oofa001 AND oofb008 = '3' AND oofb010 = 'Y'
         ##若沒有勾選主要的
         #IF cl_null(r_oofb019) THEN
         #   SELECT oofb019,oofb011 INTO r_oofb019,r_oofb011 FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = l_oofa001 AND oofb008 = '3' AND rownum = 1
         #END IF
         #呼叫地址組合應用元件
         
      END IF   
      RETURN r_oofb019,r_oofb011 
         
END FUNCTION
#根據營運據點獲取該營運據點的發票地址
PRIVATE FUNCTION apmt500_get_oofb019_5(p_site)
DEFINE p_site     LIKE ooef_t.ooef001
DEFINE l_oofa001  LIKE oofa_t.oofa001
DEFINE r_oofb019  LIKE oofb_t.oofb019
DEFINE r_oofb011  LIKE oofb_t.oofb011

      LET r_oofb019 = ''
      LET r_oofb011 = ''

      #獲取當前營運據點的聯絡對象識別碼
      LET l_oofa001 = ''
      SELECT oofa001 INTO l_oofa001 FROM oofa_t WHERE oofaent = g_enterprise AND oofa002 = '1' AND oofa003 = p_site
      
      IF NOT cl_null(l_oofa001) THEN
         #主要帳款地址
         SELECT oofb019,oofb011 INTO r_oofb019,r_oofb011 FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = l_oofa001 AND oofb008 = '5' AND oofb010 = 'Y'
         ##若沒有勾選主要的
         #IF cl_null(r_oofb019) THEN
         #   SELECT oofb019,oofb011 INTO r_oofb019,r_oofb011 FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = l_oofa001 AND oofb008 = '5' AND rownum = 1
         #END IF
         #呼叫地址組合應用元件
         
      END IF
      RETURN r_oofb019,r_oofb011 
      
END FUNCTION
#檢查理由碼
PRIVATE FUNCTION apmt500_pmdn049_chk(p_pmdn049)
DEFINE p_pmdn049  LIKE pmdn_t.pmdn049
DEFINE l_success  LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5
DEFINE l_flag     LIKE type_t.num5

        LET r_success = TRUE
        
        IF NOT cl_null(p_pmdn049) THEN
           CALL s_azzi650_chk_exist(g_acc,p_pmdn049) RETURNING l_success
           IF NOT l_success THEN
               LET r_success = FALSE
               RETURN r_success
           END IF
           
           #s_control_chk_doc('8',pmdldocno,pmdb031,'','','','')應用元件，
           #檢核輸入的理由碼是否在單據別限制範圍內，若不在限制內則不允許使用此理由碼
           CALL s_control_chk_doc('8',g_pmdl_m.pmdldocno,p_pmdn049,'','','','') RETURNING l_success,l_flag
           IF NOT r_success THEN
              LET r_success = FALSE
              RETURN r_success
           ELSE
              IF NOT l_flag THEN
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
        END IF           
        RETURN r_success

END FUNCTION
#理由碼帶值
PRIVATE FUNCTION apmt500_pmdn049_ref(p_pmdn049)
DEFINE p_pmdn049  LIKE pmdn_t.pmdn049
DEFINE r_oocql004 LIKE oocql_t.oocql004

        INITIALIZE g_ref_fields TO NULL
        LET g_ref_fields[1] = p_pmdn049
        CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='"||g_acc||"' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
        LET r_oocql004 = '', g_rtn_fields[1] , ''
        RETURN r_oocql004
            
END FUNCTION
#儲位編號檢查
PRIVATE FUNCTION apmt500_pmdn029_chk()
DEFINE r_success  LIKE type_t.num5

        LET r_success = TRUE
        IF NOT cl_null(g_pmdn2_d[l_ac].pmdn029) THEN 
           #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
           INITIALIZE g_chkparam.* TO NULL
           
           #設定g_chkparam.*的參數
           LET g_chkparam.arg1 = g_pmdn_d[l_ac].pmdnunit
           LET g_chkparam.arg2 = g_pmdn2_d[l_ac].pmdn028
           LET g_chkparam.arg3 = g_pmdn2_d[l_ac].pmdn029
 
           #呼叫檢查存在並帶值的library
           IF NOT cl_chk_exist("v_inab002_1") THEN
              LET r_success = FALSE
              RETURN r_success
           END IF
        END IF
        RETURN r_success        

END FUNCTION

PRIVATE FUNCTION apmt500_pmdn028_ref(p_pmdn028)
DEFINE p_pmdn028      LIKE pmdn_t.pmdn028
DEFINE r_inaa002      LIKE inaa_t.inaa002

      LET r_inaa002 = ''
      CALL s_desc_get_stock_desc(g_site,p_pmdn028) RETURNING r_inaa002
      
      RETURN r_inaa002

END FUNCTION

PRIVATE FUNCTION apmt500_pmdn029_ref(p_pmdn028,p_pmdn029)
DEFINE p_pmdn028      LIKE pmdn_t.pmdn028
DEFINE p_pmdn029      LIKE pmdn_t.pmdn029
DEFINE r_inab003      LIKE inab_t.inab003

       LET r_inab003 = ''
       CALL s_desc_get_locator_desc(g_site,p_pmdn028,p_pmdn029) RETURNING r_inab003
       RETURN r_inab003

END FUNCTION

PRIVATE FUNCTION apmt500_pmdn025_chk()
DEFINE l_ooef012   LIKE ooef_t.ooef012
DEFINE l_n         LIKE type_t.num5
DEFINE r_success   LIKE type_t.num5

       LET r_success = TRUE
       
       IF NOT cl_null(g_pmdn2_d[l_ac].pmdn025) THEN 
          #先判斷是否存在與對應庫位的聯絡地址檔中
          LET l_n = 0
          LET l_ooef012 = ''
          IF (NOT cl_null(g_pmdn_d[l_ac].pmdnunit)) AND (NOT cl_null(g_pmdn2_d[l_ac].pmdn028)) THEN
             SELECT inaa004 INTO l_ooef012 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_pmdn_d[l_ac].pmdnunit AND inaa001 = g_pmdn2_d[l_ac].pmdn028
           
             SELECT COUNT(1) INTO l_n FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = l_ooef012 AND oofb019 = g_pmdn2_d[l_ac].pmdn025 AND oofbstus = 'Y' AND oofb008 = '3'
          END IF
          IF l_n = 0 THEN
             #若不存在與對應庫位的聯絡地址檔中，在判斷是否存在與對應營運據點聯絡地址檔中，若都不存在，則報錯
             LET l_ooef012 = ''
             IF NOT cl_null(g_pmdn_d[l_ac].pmdnunit) THEN
                SELECT ooef012 INTO l_ooef012 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 =  g_pmdn_d[l_ac].pmdnunit
                SELECT COUNT(1) INTO l_n FROM oofb_t WHERE oofbent = g_enterprise AND oofb002 = l_ooef012 AND oofb019 = g_pmdn2_d[l_ac].pmdn025 AND oofbstus = 'Y' AND oofb008 = '3'
                IF l_n = 0 THEN
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.code = 'apm-00216'
                   LET g_errparam.extend = g_pmdn2_d[l_ac].pmdn025
                   LET g_errparam.popup = TRUE
                   CALL cl_err()

                   LET r_success = FALSE
                   RETURN r_success
                END IF
             END IF
          END IF
       END IF 
       RETURN r_success

END FUNCTION

PRIVATE FUNCTION apmt500_pmdn003_ref(p_pmdn003)
DEFINE p_pmdn003    LIKE pmdn_t.pmdn003
DEFINE r_imaal003   LIKE imaal_t.imaal003

        INITIALIZE g_ref_fields TO NULL
        LET g_ref_fields[1] = p_pmdn003
        CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
        LET r_imaal003 = '', g_rtn_fields[1] , ''
        RETURN r_imaal003
         
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl033_ref(p_pmdl033)
DEFINE p_pmdl033    LIKE pmdl_t.pmdl033
DEFINE r_isacl004   LIKE isacl_t.isacl004

        INITIALIZE g_ref_fields TO NULL
        LET g_ref_fields[1] = p_pmdl033
        CALL ap_ref_array2(g_ref_fields,"SELECT isacl004 FROM isacl_t WHERE isaclent='"||g_enterprise||"' AND isacl001='"||g_ooef019||"' AND isacl002=? AND isacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
        LET r_isacl004 = '', g_rtn_fields[1] , ''
        RETURN r_isacl004
         
END FUNCTION
#來源單號檢查
PRIVATE FUNCTION apmt500_pmdp003_chk(p_pmdp003)
DEFINE p_pmdp003    LIKE pmdp_t.pmdp003
DEFINE r_success    LIKE type_t.num5

       LET r_success = TRUE
       
       #150909 earl add s
       IF NOT s_aooi210_check_doc(g_site,'',p_pmdp003,g_pmdl_m.pmdldocno,'4','') THEN
          LET r_success = FALSE
          RETURN r_success
       END IF
       #150909 earl add e
       
       CASE g_pmdl_m.pmdl007
          WHEN '2'  #請購單
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
 
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmdp003
 
             #呼叫檢查存在並帶值的library
             IF NOT cl_chk_exist("v_pmdadocno") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
         #WHEN '3'  #訂單
         #WHEN '4'  #工單
         #WHEN '5'  #MRP
       END CASE
       RETURN r_success
  
END FUNCTION
#來源項次檢查
PRIVATE FUNCTION apmt500_pmdp004_chk(p_pmdp003,p_pmdp004)
DEFINE p_pmdp003    LIKE pmdp_t.pmdp003
DEFINE p_pmdp004    LIKE pmdp_t.pmdp004
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdb049    LIKE pmdb_t.pmdb049
DEFINE l_pmdb006    LIKE pmdb_t.pmdb006
DEFINE l_pmdb014    LIKE pmdb_t.pmdb014
DEFINE l_pmdb015    LIKE pmdb_t.pmdb015
DEFINE l_pmdb032    LIKE pmdb_t.pmdb032
DEFINE l_pmdp023    LIKE pmdp_t.pmdp023

       LET r_success = TRUE
       LET l_pmdb049 = ''
       LET l_pmdb006 = ''
       LET l_pmdb014 = ''
       LET l_pmdb015 = ''
       SELECT SUM(pmdp023) INTO l_pmdp023 FROM pmdp_t,pmdl_t 
         WHERE pmdpent = pmdlent AND pmdpdocno = pmdldocno AND pmdlstus = 'N'
           AND pmdpent = g_enterprise AND pmdp003 = p_pmdp003 AND pmdp004 = p_pmdp004
           AND (pmdpdocno <> g_pmdl_m.pmdldocno OR pmdpseq <> g_pmdn4_d[l_ac].pmdpseq OR pmdpseq1 <> g_pmdn4_d[l_ac].pmdpseq1 )
       IF cl_null(l_pmdp023) THEN
          LET l_pmdp023 = 0
       END IF
       
       CASE g_pmdl_m.pmdl007
          WHEN '2'  #請購單
             SELECT NVL(pmdb049,0),NVL(pmdb006,0),pmdb014,pmdb015,pmdb032 
                INTO l_pmdb049,l_pmdb006,l_pmdb014,l_pmdb015,l_pmdb032
               FROM pmdb_t 
               WHERE pmdbent = g_enterprise AND pmdbdocno = p_pmdp003 AND pmdbseq = p_pmdp004
             CASE WHEN SQLCA.sqlcode = 100
                       INITIALIZE g_errparam TO NULL
                       LET g_errparam.code = 'apm-00295'
                       LET g_errparam.extend = p_pmdp004
                       LET g_errparam.popup = TRUE
                       CALL cl_err()
             
                       LET r_success = FALSE
                       RETURN r_success
                  WHEN l_pmdb032 <> '1'  #結案狀態不可錄入
                       INITIALIZE g_errparam TO NULL
                       LET g_errparam.code = 'sub-00437'
                       LET g_errparam.extend = p_pmdp004
                       LET g_errparam.popup = TRUE
                       CALL cl_err()
             
                       LET r_success = FALSE
                       RETURN r_success 
                  #WHEN l_pmdb049 >= l_pmdb006 - l_pmdp023  #已轉採購量大於等於需求量   #160905-00006#1
                  WHEN l_pmdb049 >= l_pmdb006   #已轉採購量大於等於需求量               #160905-00006#1
                       INITIALIZE g_errparam TO NULL
                       LET g_errparam.code = 'apm-00296'
                       LET g_errparam.extend = p_pmdp004
                       LET g_errparam.popup = TRUE
                       CALL cl_err()
             
                       LET r_success = FALSE
                       RETURN r_success
             END CASE
             IF l_pmdb014 = '3' AND l_pmdb015 <> g_pmdl_m.pmdl004 THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00297'
                LET g_errparam.extend = p_pmdp004
                LET g_errparam.popup = TRUE
                CALL cl_err()
             
                LET r_success = FALSE
                RETURN r_success           
             END IF
         #WHEN '3'  #訂單
         #WHEN '4'  #工單
         #WHEN '5'  #MRP
       END CASE
       RETURN r_success
  
END FUNCTION

PRIVATE FUNCTION apmt500_pmdp004_ref()
DEFINE l_pmdp023    LIKE pmdp_t.pmdp023   
DEFINE l_success    LIKE type_t.num5  #160905-00006#1

      #SELECT pmdb004,pmdb005,pmdb007,pmdb006,pmdb049   #160905-00006#1
      SELECT pmdb004,pmdb005,pmdb007,(pmdb006-NVL(pmdb049,0))   #160905-00006#1
        INTO g_pmdn4_d[l_ac].pmdp007,g_pmdn4_d[l_ac].pmdp008,g_pmdn4_d[l_ac].pmdp022,g_pmdn4_d[l_ac].pmdp023
        FROM pmdb_t
        WHERE pmdbent = g_enterprise AND pmdbdocno = g_pmdn4_d[l_ac].pmdp003 AND pmdbseq = g_pmdn4_d[l_ac].pmdp004
      #160905-00006#1--S
      ##其他單據或項次上已經維護的數量
      #SELECT SUM(pmdp023) INTO l_pmdp023 FROM pmdp_t,pmdl_t 
      #  WHERE pmdpent = pmdlent AND pmdpdocno = pmdldocno AND pmdlstus = 'N'
      #    AND pmdpent = g_enterprise AND pmdp003 = g_pmdn4_d[l_ac].pmdp003 AND pmdp004 = g_pmdn4_d[l_ac].pmdp004
      #    AND (pmdpdocno <> g_pmdl_m.pmdldocno OR pmdpseq <> g_pmdn4_d[l_ac].pmdpseq OR pmdpseq1 <> g_pmdn4_d[l_ac].pmdpseq1 )
      #160905-00006#1---E
      IF cl_null(l_pmdp023) THEN
         LET l_pmdp023 = 0
      END IF
      
      LET g_pmdn4_d[l_ac].pmdp023 = g_pmdn4_d[l_ac].pmdp023 - l_pmdp023
      
      #160905-00006#1--s
      #LET g_pmdn4_d[l_ac].pmdp024 = g_pmdn4_d[l_ac].pmdp023
      CALL s_aooi250_convert_qty(g_pmdn4_d[l_ac].pmdp001,g_pmdn4_d[l_ac].pmdp022,g_pmdn_d[g_detail_idx].pmdn006,g_pmdn4_d[l_ac].pmdp023)
           RETURNING l_success,g_pmdn4_d[l_ac].pmdp024
      #160905-00006#1---e
      
      DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp007,g_pmdn4_d[l_ac].pmdp008,g_pmdn4_d[l_ac].pmdp022,g_pmdn4_d[l_ac].pmdp023,g_pmdn4_d[l_ac].pmdp024
      
      CALL apmt500_unit_ref(g_pmdn4_d[l_ac].pmdp022) RETURNING g_pmdn4_d[l_ac].pmdp022_desc
      DISPLAY BY NAME g_pmdn4_d[l_ac].pmdp022_desc
      
END FUNCTION
#複製時欄位初始化
PRIVATE FUNCTION apmt500_reproduce_init()
      
      LET g_pmdl_m.pmdl001 = "0"   #版次
      LET g_pmdl_m.pmdldocno = ''
      LET g_pmdl_m.pmdldocno_desc = ''
      LET g_pmdl_m.pmdldocdt = g_today
      LET g_pmdl_m.pmdl008 = ""   #來源單號
      DISPLAY BY NAME g_pmdl_m.pmdl008
      
      LET g_pmdl_m.pmdlsite = g_site
      #獲取當前營運據點的出貨地址、帳款地址
      CALL apmt500_get_oofb019(g_site) RETURNING g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc
      CALL apmt500_get_oofb019(g_site) RETURNING g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc
      DISPLAY BY NAME g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc
      
      DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt
      LET g_pmdl_m.pmdlstus = 'N'
      CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")
      DISPLAY BY NAME g_pmdl_m.pmdlstus
      LET g_pmdl_m.pmdl002 = g_user
      LET g_pmdl_m.pmdl003 = g_dept
      CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
      DISPLAY BY NAME g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc

      CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
      DISPLAY BY NAME g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc
      
      LET g_pmdl_m.pmdl030 = 'N'
      LET g_pmdl_m.pmdl031 = ''

      LET g_pmdl_m.pmdlownid = g_user
      LET g_pmdl_m.pmdlowndp = g_dept
      LET g_pmdl_m.pmdlcrtid = g_user
      LET g_pmdl_m.pmdlcrtdp = g_dept
      LET g_pmdl_m.pmdlcrtdt = cl_get_current()
      LET g_pmdl_m.pmdlmodid = NULL
      LET g_pmdl_m.pmdlmodid_desc = NULL
      LET g_pmdl_m.pmdlmoddt = NULL
      LET g_pmdl_m.pmdlcnfid = NULL
      LET g_pmdl_m.pmdlcnfid_desc = NULL
      LET g_pmdl_m.pmdlcnfdt = NULL
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_pmdl_m.pmdlownid
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_pmdl_m.pmdlownid_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_pmdl_m.pmdlownid_desc

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_pmdl_m.pmdlowndp
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_pmdl_m.pmdlowndp_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_pmdl_m.pmdlowndp_desc

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_pmdl_m.pmdlcrtid
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_pmdl_m.pmdlcrtid_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_pmdl_m.pmdlcrtid_desc

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_pmdl_m.pmdlcrtdp
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_pmdl_m.pmdlcrtdp_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_pmdl_m.pmdlcrtdp_desc

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_pmdl_m.pmdlmodid
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_pmdl_m.pmdlmodid_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_pmdl_m.pmdlmodid_desc

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_pmdl_m.pmdlcnfid
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_pmdl_m.pmdlcnfid_desc = '', g_rtn_fields[1] , ''
      DISPLAY BY NAME g_pmdl_m.pmdlcnfid_desc
      
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl024_chk(p_pmdl024)
DEFINE p_pmdl024    LIKE pmdl_t.pmdl024
DEFINE r_success    LIKE type_t.num5

       LET r_success = TRUE
       
       IF NOT cl_null(p_pmdl024) THEN
          IF NOT s_azzi650_chk_exist('264',p_pmdl024) THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
       RETURN r_success
       
END FUNCTION

#來源單據中需求數量的檢查
PRIVATE FUNCTION apmt500_pmdp023_chk(p_pmdp003,p_pmdp004,p_pmdp023,p_pmdp023_t)
DEFINE p_pmdp003    LIKE pmdp_t.pmdp003
DEFINE p_pmdp004    LIKE pmdp_t.pmdp004
DEFINE p_pmdp023    LIKE pmdp_t.pmdp023
DEFINE p_pmdp023_t  LIKE pmdp_t.pmdp023
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdb049    LIKE pmdb_t.pmdb049
DEFINE l_pmdb006    LIKE pmdb_t.pmdb006
DEFINE l_pmdp023_1  LIKE pmdp_t.pmdp023   #來源單據的最大需求數量
DEFINE l_pmdp023_2  LIKE pmdp_t.pmdp023   #採購單中已錄入來源單據的數量
DEFINE l_slip       LIKE oobx_t.oobx001
DEFINE l_oobx003    LIKE oobx_t.oobx003
DEFINE l_success    LIKE type_t.num5

       LET r_success = TRUE
       LET l_pmdb049 = ''
       LET l_pmdb006 = ''
       LET l_pmdp023_1 = 0
       LET l_pmdp023_2 = 0
       IF cl_null(p_pmdp023_t) THEN
          LET p_pmdp023_t = 0
       END IF

       #抓取單據性質
       CALL s_aooi200_get_slip(p_pmdp003) RETURNING l_success,l_slip
       SELECT oobx003 INTO l_oobx003
         FROM oobx_t
        WHERE oobx001 = l_slip
          AND oobxent = g_enterprise
          
       CASE l_oobx003
          WHEN 'apmt400'  #請購單
             SELECT NVL(pmdb049,0),NVL(pmdb006,0)
                INTO l_pmdb049,l_pmdb006
               FROM pmdb_t 
               WHERE pmdbent = g_enterprise AND pmdbdocno = p_pmdp003 AND pmdbseq = p_pmdp004
               
             LET l_pmdp023_1 = l_pmdb006 - l_pmdb049  #需求數量+超交數量-已轉採購量
             
             #SELECT SUM(pmdp023) INTO l_pmdp023_2 FROM pmdp_t,pmdl_t 
             #  WHERE pmdpent = pmdlent AND pmdpdocno = pmdldocno AND pmdlstus = 'N'
             #    AND pmdpent = g_enterprise AND pmdp003 = p_pmdp003
             #    AND pmdp004 = p_pmdp004
             IF cl_null(l_pmdp023_2) THEN
                LET l_pmdp023_2 = 0
             END IF
             IF p_pmdp023 > l_pmdp023_1 - l_pmdp023_2 + p_pmdp023_t THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00800'
                LET g_errparam.extend = p_pmdp004
                LET g_errparam.popup = TRUE
                CALL cl_err()
             
                LET r_success = FALSE
                RETURN r_success
             END IF
             
         #WHEN '3'  #訂單
         #WHEN '4'  #工單
         #WHEN '5'  #MRP
       END CASE
       RETURN r_success
  
END FUNCTION

PRIVATE FUNCTION apmt500_pmdl024_ref(p_pmdl024)
DEFINE p_pmdl024     LIKE pmdl_t.pmdl024
DEFINE r_oocql004    LIKE oocql_t.oocql004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdl024
       CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='264' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_oocql004 = '', g_rtn_fields[1] , ''
       RETURN r_oocql004

END FUNCTION
################################################################################
# Descriptions...: 取得單據別設定的欄位預設值
# Memo...........: 需搭配單據別aooi200的設定
# Usage..........: CALL apmt500_get_col_default()
# Date & Author..: 2014/02/14 By lixiang
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_get_col_default()
   LET g_pmdl_m.pmdldocdt = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdldocdt',g_pmdl_m.pmdldocdt)
   LET g_pmdl_m.pmdl001 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl001',g_pmdl_m.pmdl001)
   LET g_pmdl_m.pmdl002 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl002',g_pmdl_m.pmdl002)
   LET g_pmdl_m.pmdl003 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl003',g_pmdl_m.pmdl003)
   LET g_pmdl_m.pmdl004 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl004',g_pmdl_m.pmdl004)
   LET g_pmdl_m.pmdl005 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl005',g_pmdl_m.pmdl005)
   LET g_pmdl_m.pmdl006 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl006',g_pmdl_m.pmdl006)
   LET g_pmdl_m.pmdl007 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl007',g_pmdl_m.pmdl007)
   LET g_pmdl_m.pmdl008 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl008',g_pmdl_m.pmdl008)
   LET g_pmdl_m.pmdl027 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl027',g_pmdl_m.pmdl027)
   LET g_pmdl_m.pmdl009 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl009',g_pmdl_m.pmdl009)
   LET g_pmdl_m.pmdl010 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl010',g_pmdl_m.pmdl010)
   LET g_pmdl_m.pmdl011 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl011',g_pmdl_m.pmdl011)
   LET g_pmdl_m.pmdl012 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl012',g_pmdl_m.pmdl012)
   LET g_pmdl_m.pmdl013 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl013',g_pmdl_m.pmdl013)
   LET g_pmdl_m.pmdl033 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl033',g_pmdl_m.pmdl033)
   LET g_pmdl_m.pmdl015 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl015',g_pmdl_m.pmdl015)
   LET g_pmdl_m.pmdl016 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl016',g_pmdl_m.pmdl016)
   LET g_pmdl_m.pmdl017 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl017',g_pmdl_m.pmdl017)
   LET g_pmdl_m.pmdl018 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl018',g_pmdl_m.pmdl018)
   LET g_pmdl_m.pmdl019 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl019',g_pmdl_m.pmdl019)
   LET g_pmdl_m.pmdl043 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl043',g_pmdl_m.pmdl043)
   LET g_pmdl_m.pmdl044 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl044',g_pmdl_m.pmdl044)
   LET g_pmdl_m.pmdl020 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl020',g_pmdl_m.pmdl020)
   LET g_pmdl_m.pmdl025 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl025',g_pmdl_m.pmdl025)
   LET g_pmdl_m.pmdl026 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl026',g_pmdl_m.pmdl026)
   LET g_pmdl_m.pmdl029 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl029',g_pmdl_m.pmdl029)
   LET g_pmdl_m.pmdl021 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl021',g_pmdl_m.pmdl021)
   LET g_pmdl_m.pmdl022 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl022',g_pmdl_m.pmdl022)
   LET g_pmdl_m.pmdl032 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl032',g_pmdl_m.pmdl032)
   LET g_pmdl_m.pmdl023 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl023',g_pmdl_m.pmdl023)
   LET g_pmdl_m.pmdl024 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl024',g_pmdl_m.pmdl024)
   LET g_pmdl_m.pmdl030 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl030',g_pmdl_m.pmdl030)
   LET g_pmdl_m.pmdl031 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl031',g_pmdl_m.pmdl031)
   LET g_pmdl_m.pmdl028 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl028',g_pmdl_m.pmdl028)
   LET g_pmdl_m.pmdl040 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl040',g_pmdl_m.pmdl040)
   LET g_pmdl_m.pmdl041 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl041',g_pmdl_m.pmdl041)
   LET g_pmdl_m.pmdl042 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl042',g_pmdl_m.pmdl042)
   LET g_pmdl_m.pmdl046 = s_aooi200_get_doc_default(g_site,'1',g_pmdl_m.pmdldocno,'pmdl046',g_pmdl_m.pmdl046)

   DISPLAY BY NAME g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl002,g_pmdl_m.pmdl004, 
     g_pmdl_m.pmdl003,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008, 
     g_pmdl_m.pmdl027,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013, 
     g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019, 
     g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029, 
     g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl023,g_pmdl_m.pmdl024,g_pmdl_m.pmdl030, 
     g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042,g_pmdl_m.pmdl046
       
   CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl004) RETURNING g_pmdl_m.pmdl004_desc
   DISPLAY BY NAME g_pmdl_m.pmdl004_desc

   CALL apmt500_pmdl002_ref(g_pmdl_m.pmdl002) RETURNING g_pmdl_m.pmdl002_desc
   DISPLAY BY NAME g_pmdl_m.pmdl002_desc

   CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl003) RETURNING g_pmdl_m.pmdl003_desc
   DISPLAY BY NAME g_pmdl_m.pmdl003_desc 
   
   CALL apmt500_pmdl027_ref(g_pmdl_m.pmdl004,g_pmdl_m.pmdl027) RETURNING g_pmdl_m.pmdl027_desc
   DISPLAY BY NAME g_pmdl_m.pmdl027_desc
   
   CALL apmt500_pmdl009_ref(g_pmdl_m.pmdl009) RETURNING g_pmdl_m.pmdl009_desc
   DISPLAY BY NAME g_pmdl_m.pmdl009_desc
   
   CALL apmt500_pmdl010_ref(g_pmdl_m.pmdl010) RETURNING g_pmdl_m.pmdl010_desc
   DISPLAY BY NAME g_pmdl_m.pmdl010_desc
   
   CALL apmt500_pmdl011_ref(g_pmdl_m.pmdl011) RETURNING g_pmdl_m.pmdl011_desc
   DISPLAY BY NAME g_pmdl_m.pmdl011_desc
   
   CALL apmt500_pmdl015_ref(g_pmdl_m.pmdl015) RETURNING g_pmdl_m.pmdl015_desc
   DISPLAY BY NAME g_pmdl_m.pmdl015_desc
   
   CALL apmt500_pmdl017_ref(g_pmdl_m.pmdl017) RETURNING g_pmdl_m.pmdl017_desc
   DISPLAY BY NAME g_pmdl_m.pmdl017_desc
   
   CALL apmt500_pmdl018_ref(g_pmdl_m.pmdl018) RETURNING g_pmdl_m.pmdl018_desc
   DISPLAY BY NAME g_pmdl_m.pmdl018_desc
   
   CALL s_desc_get_acc_desc('317',g_pmdl_m.pmdl043) RETURNING g_pmdl_m.pmdl043_desc
   DISPLAY BY NAME g_pmdl_m.pmdl043_desc
   
   CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc
   DISPLAY BY NAME g_pmdl_m.pmdl020_desc
   
   CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
   DISPLAY BY NAME g_pmdl_m.pmdl025_desc
   
   CALL apmt500_pmdl026_ref(g_pmdl_m.pmdl026) RETURNING g_pmdl_m.pmdl026_desc
   DISPLAY BY NAME g_pmdl_m.pmdl026_desc
   
   CALL apmt500_pmdl003_ref(g_pmdl_m.pmdl029) RETURNING g_pmdl_m.pmdl029_desc
   DISPLAY BY NAME g_pmdl_m.pmdl029_desc 
   
   CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl021) RETURNING g_pmdl_m.pmdl021_desc
   DISPLAY BY NAME g_pmdl_m.pmdl021_desc 
   
   CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl022) RETURNING g_pmdl_m.pmdl022_desc
   DISPLAY BY NAME g_pmdl_m.pmdl022_desc 
   
   CALL apmt500_pmdl004_ref(g_pmdl_m.pmdl032) RETURNING g_pmdl_m.pmdl032_desc
   DISPLAY BY NAME g_pmdl_m.pmdl032_desc 
   
   CALL apmt500_pmdl023_ref(g_pmdl_m.pmdl023) RETURNING g_pmdl_m.pmdl023_desc
   DISPLAY BY NAME g_pmdl_m.pmdl023_desc
   
   CALL apmt500_pmdl024_ref(g_pmdl_m.pmdl024) RETURNING g_pmdl_m.pmdl024_desc
   DISPLAY BY NAME g_pmdl_m.pmdl024_desc
   
   CALL apmt500_pmdl033_ref(g_pmdl_m.pmdl033) RETURNING g_pmdl_m.pmdl033_desc
   DISPLAY BY NAME g_pmdl_m.pmdl033_desc 
END FUNCTION
################################################################################
# Descriptions...: 取得產品特徵類別
# Memo...........:
# Usage..........: CALL apmt500_get_imaa005(p_enterprise,p_imaa001)
#                  RETURNING r_imaa005
# Input parameter: p_enterprise   企業編號
#                : p_imaa001      料號
# Return code....: r_imaa005      特徵類別
# Date & Author..: 2014/06/12 By lixiang
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_get_imaa005(p_enterprise,p_imaa001)
   DEFINE p_enterprise   LIKE type_t.num5,
          p_imaa001      LIKE imaa_t.imaa001
   DEFINE r_imaa005      LIKE imaa_t.imaa005

   LET r_imaa005 = ''
   SELECT imaa005 INTO r_imaa005 
     FROM imaa_t 
    WHERE imaaent = p_enterprise 
      AND imaa001 = p_imaa001
      
   RETURN r_imaa005   
   
END FUNCTION

#獲得料件是否檢驗
PRIVATE FUNCTION apmt500_get_qcap006(p_pmdn001,p_pmdn002,p_pmdn004,p_pmdn005)
DEFINE l_sql      STRING
DEFINE r_pmdn052  LIKE pmdn_t.pmdn052
DEFINE p_pmdn001  LIKE pmdn_t.pmdn001
DEFINE p_pmdn002  LIKE pmdn_t.pmdn002
DEFINE p_pmdn004  LIKE pmdn_t.pmdn004
DEFINE p_pmdn005  LIKE pmdn_t.pmdn005

      LET r_pmdn052 = ''
      
      LET l_sql = " SELECT qcap006 FROM qcap_t ",
                 " WHERE qcapent = '",g_enterprise,"' ",
                 "  AND qcapsite = '",g_site,"' ",
                 "  AND qcap001 = '",p_pmdn001,"' ",
                 "  AND qcap002 = '",g_pmdl_m.pmdl004,"' "
                 
      IF p_pmdn002 IS NOT NULL THEN
         LET l_sql = l_sql ," AND (qcap005 = '",p_pmdn002,"' OR qcap005 = 'ALL' )"
      END IF
      IF (NOT cl_null(p_pmdn004)) AND (NOT cl_null(p_pmdn005)) THEN
         LET l_sql = l_sql ," AND (qcap003 = '",p_pmdn004,"' OR qcap003 = 'ALL' ) AND qcap004 = '",p_pmdn005,"' "
      END IF
      
      PREPARE get_qcap FROM l_sql
      EXECUTE get_qcap INTO r_pmdn052   
      FREE get_qcap
      
      IF cl_null(r_pmdn052) THEN
         #若沒有維護aqci050,再從aqci040中帶值
         SELECT imae114 INTO r_pmdn052 FROM imae_t 
             WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = p_pmdn001
             
      END IF
      
      IF cl_null(r_pmdn052) THEN
         LET r_pmdn052 = 'N'
      END IF
      RETURN r_pmdn052
         
END FUNCTION

#是否重新取價
PRIVATE FUNCTION apmt500_change_pmdn015()
  DEFINE l_success     LIKE type_t.num5
  DEFINE l_pmdnseq     LIKE pmdn_t.pmdnseq    #項次
  DEFINE l_pmdn001     LIKE pmdn_t.pmdn001    #料件
  DEFINE l_pmdn002     LIKE pmdn_t.pmdn002    #產品特徵
  DEFINE l_pmdn010     LIKE pmdn_t.pmdn010    #單位
  DEFINE l_pmdn011     LIKE pmdn_t.pmdn011    #數量
  DEFINE l_pmdn015     LIKE pmdn_t.pmdn015    #單價
  DEFINE l_pmdn016     LIKE pmdn_t.pmdn016    #稅別
  DEFINE l_pmdn040     LIKE pmdn_t.pmdn040    #取價來源
  DEFINE l_pmdn041     LIKE pmdn_t.pmdn041    #價格參考單號
  DEFINE l_pmdn042     LIKE pmdn_t.pmdn042    #價格參考項次
  DEFINE l_pmdn043     LIKE pmdn_t.pmdn043    #取出價格
  DEFINE l_pmdn046     LIKE pmdn_t.pmdn046    #未稅金額
  DEFINE l_pmdn047     LIKE pmdn_t.pmdn047    #含稅金額
  DEFINE l_pmdn048     LIKE pmdn_t.pmdn048    #稅額
  DEFINE l_pmdn004     LIKE pmdn_t.pmdn004
  DEFINE l_pmdn005     LIKE pmdn_t.pmdn005
  DEFINE l_pmdn007     LIKE pmdn_t.pmdn007
  DEFINE l_pmdn006     LIKE pmdn_t.pmdn006
  
  DECLARE sel_pmdn015_cur CURSOR FOR
     SELECT pmdnseq,pmdn001,pmdn002,pmdn006,pmdn007,pmdn010,pmdn011,pmdn016,pmdn004,pmdn005
       FROM pmdn_t
      WHERE pmdnent = g_enterprise 
        AND pmdndocno = g_pmdl_m.pmdldocno

  FOREACH sel_pmdn015_cur INTO l_pmdnseq,l_pmdn001,l_pmdn002,l_pmdn006,l_pmdn007,l_pmdn010,l_pmdn011,l_pmdn016,l_pmdn004,l_pmdn005
       #單身重新取價
       IF cl_null(l_pmdn010) OR cl_null(l_pmdn011) THEN
          LET l_pmdn010 = l_pmdn006
          LET l_pmdn011 = l_pmdn007
       END IF
          
       CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,l_pmdn001,l_pmdn002,g_pmdl_m.pmdl015,
                                l_pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                                g_pmdl_m.pmdldocdt,l_pmdn010,l_pmdn011,g_site,g_pmdl_m.pmdl054,g_type,l_pmdn004,l_pmdn005)
             RETURNING l_pmdn040,l_pmdn043,l_pmdn041,l_pmdn042
      
       LET l_pmdn015 = l_pmdn043


       #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
       CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,l_pmdnseq,g_pmdl_m.pmdl015,l_pmdn011,l_pmdn015,l_pmdn016)
             RETURNING l_pmdn046,l_pmdn048,l_pmdn047
           
       UPDATE pmdn_t SET pmdn015 = l_pmdn015,
                         pmdn040 = l_pmdn040,
                         pmdn041 = l_pmdn041,
                         pmdn042 = l_pmdn042,
                         pmdn043 = l_pmdn043,
                         pmdn044 = 0,
                         pmdn046 = l_pmdn046,
                         pmdn047 = l_pmdn047,
                         pmdn048 = l_pmdn048
        WHERE pmdnent = g_enterprise 
          AND pmdndocno = g_pmdl_m.pmdldocno
          AND pmdnseq = l_pmdnseq  
         #重新產生交期明細資料
         CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,l_pmdnseq) RETURNING l_success          
  END FOREACH
  
  CALL apmt500_b_fill() 

END FUNCTION

#是否修改單身稅別
PRIVATE FUNCTION apmt500_change_pmdn016()
DEFINE l_success         LIKE type_t.num5
DEFINE l_pmdnseq         LIKE pmdn_t.pmdnseq
DEFINE l_pmdn001         LIKE pmdn_t.pmdn001
DEFINE l_pmdn011         LIKE pmdn_t.pmdn011
DEFINE l_pmdn015         LIKE pmdn_t.pmdn015
DEFINE l_pmdn016         LIKE pmdn_t.pmdn016
DEFINE l_pmdn017         LIKE pmdn_t.pmdn017
DEFINE l_pmdn046         LIKE pmdn_t.pmdn046
DEFINE l_pmdn047         LIKE pmdn_t.pmdn047
DEFINE l_pmdn048         LIKE pmdn_t.pmdn048
DEFINE l_pmdn007         LIKE pmdn_t.pmdn007

      DECLARE sel_pmdn016_cs CURSOR FOR
       SELECT pmdnseq,pmdn001,pmdn007,pmdn011,pmdn015
         FROM pmdn_t
        WHERE pmdnent = g_enterprise
          AND pmdndocno = g_pmdl_m.pmdldocno
 
      FOREACH sel_pmdn016_cs INTO l_pmdnseq,l_pmdn001,l_pmdn007,l_pmdn011,l_pmdn015
         IF g_tax_app = '2' AND NOT cl_null(l_pmdn001) AND NOT cl_null(g_pmab039) THEN
            #依料件設定
            #151208-00004#2--mark---begin----
            #CALL s_tax_chktype(g_pmdl_m.pmdlsite,g_pmdl_m.pmdl004,l_pmdn001,'2',g_pmab039)
            #     RETURNING l_success,l_pmdn016,l_pmdn017
            #151208-00004#2--add---begin----
            CALL s_tax_by_item(g_pmdl_m.pmdlsite,g_pmdl_m.pmdl011,g_pmdl_m.pmdl004,l_pmdn001,'2',g_pmab039)
               RETURNING l_success,g_pmdn_d[l_ac].pmdn016,g_pmdn_d[l_ac].pmdn017          
            #151208-00004#2--add---end----
            IF NOT l_success THEN
               #稅別檢查失敗，將稅別、稅率清空
               LET l_pmdn016 = ''
               LET l_pmdn017 = ''
            END IF                   
         ELSE
            #依正常稅率
            LET l_pmdn016 = g_pmdl_m.pmdl011
            LET l_pmdn017 = g_pmdl_m.pmdl012
         END IF
         IF cl_null(l_pmdn011) THEN
            LET l_pmdn011 = l_pmdn007
         END IF
         
         #重新計算含稅、未稅金額
         CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,l_pmdnseq,g_pmdl_m.pmdl015,l_pmdn011,l_pmdn015,l_pmdn016)
                           
           RETURNING l_pmdn046,l_pmdn048,l_pmdn047
          
         UPDATE pmdn_t SET pmdn016 = l_pmdn016,
                           pmdn017 = l_pmdn017,
                           pmdn046 = l_pmdn046,
                           pmdn047 = l_pmdn047,
                           pmdn048 = l_pmdn048
          WHERE pmdnent = g_enterprise
            AND pmdndocno = g_pmdl_m.pmdldocno
            AND pmdnseq = l_pmdnseq   

         #重新產生交期明細資料
         CALL s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,l_pmdnseq) RETURNING l_success
      END FOREACH
      CALL apmt500_b_fill()
END FUNCTION

#根據來源單號帶出資料(預先採購單)
PRIVATE FUNCTION apmt500_pmdl008_desc()
#160801-00028#1---s
DEFINE l_pmda010  LIKE pmda_t.pmda010
DEFINE l_pmda005  LIKE pmda_t.pmda005
DEFINE l_success  LIKE type_t.num5
DEFINE l_oodb011  LIKE oodb_t.oodb011
DEFINE l_ooef016  LIKE ooef_t.ooef016
DEFINE l_scc40    LIKE type_t.chr2
#160801-00028#1---e
#160831-00047#1---s
DEFINE l_pmda021  LIKE pmda_t.pmda021
DEFINE l_pmda024  LIKE pmda_t.pmda024
DEFINE l_pmda025  LIKE pmda_t.pmda025
#160831-00047#1---e

     #160801-00028#1---s
     #IF g_pmdl_m.pmdl007 <>  '8' THEN
     #   RETURN
     #END IF
     #160801-00028#1---e
     IF cl_null(g_pmdl_m.pmdl008) THEN
        RETURN
     END IF
     
     #160801-00028#1---s
     IF g_pmdl_m.pmdl007 =  '2' THEN  #请购单
        SELECT pmda010,pmda005,pmda021,pmda024,pmda025   #160831-00047#1 pmda021,pmda024,pmda025
            INTO l_pmda010,l_pmda005,l_pmda021,l_pmda024,l_pmda025  #160831-00047#1 pmda021,pmda024,pmda025  
           FROM pmda_t WHERE pmdaent = g_enterprise AND pmdadocno = g_pmdl_m.pmdl008
        IF NOT cl_null(l_pmda010) THEN
           LET g_pmdl_m.pmdl011 = l_pmda010
           CALL s_tax_chk(g_site,g_pmdl_m.pmdl011)
               RETURNING l_success,g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl013,g_pmdl_m.pmdl012,l_oodb011 
            DISPLAY BY NAME g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl013,g_pmdl_m.pmdl012
        END IF
        IF NOT cl_null(l_pmda010) THEN
           LET g_pmdl_m.pmdl015 = l_pmda005
           LET l_ooef016 = ''
           SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
           #根據內外購獲取當前營運據點參數設置的汇率类型
           LET l_scc40 = ''
           IF g_pmdl_m.pmdl054 = '1' THEN   #內購
              LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
           END IF
           IF g_pmdl_m.pmdl054 = '2' THEN   #外購
              LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
           END IF
           IF NOT cl_null(l_scc40) THEN
              CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmdl_m.pmdl015,l_ooef016,0,l_scc40) RETURNING g_pmdl_m.pmdl016
              DISPLAY BY NAME g_pmdl_m.pmdl016
           END IF
        END IF
        #160831-00047#1---s
        IF NOT cl_null(l_pmda021) THEN
           LET g_pmdl_m.pmdl020 = l_pmda021
           CALL apmt500_pmdl020_ref(g_pmdl_m.pmdl020) RETURNING g_pmdl_m.pmdl020_desc
           DISPLAY BY NAME g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc
        END IF
        IF NOT cl_null(l_pmda024) THEN
           LET g_pmdl_m.pmdl025 = l_pmda024
           CALL apmt500_pmdl025_ref(g_pmdl_m.pmdl025) RETURNING g_pmdl_m.pmdl025_desc
           DISPLAY BY NAME g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc
        END IF
        IF NOT cl_null(l_pmda025) THEN
           LET g_pmdl_m.pmdl026 = l_pmda025
           CALL apmt500_pmdl026_ref(g_pmdl_m.pmdl026) RETURNING g_pmdl_m.pmdl026_desc
           DISPLAY BY NAME g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc
        END IF
        #160831-00047#1---e
     END IF
     #160801-00028#1---e
     
     IF g_pmdl_m.pmdl007 = '8' THEN  #預先採購單  #160801-00028#1
        SELECT pmdl004,pmdl005,pmdl006,pmdl027,pmdl052,pmdl053,pmdl009,pmdl010,pmdl011,pmdl012,pmdl013,pmdl033,
               pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl023,pmdl043,pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,
               pmdl029,pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl042,pmdl047,
               pmdl048,pmdl049,pmdl046,pmdl040,pmdl041
          INTO g_pmdl_m.pmdl004,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,
               g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,
               g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,
               g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,
               g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,
               g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,
               g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041
          FROM pmdl_t
          WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdl008
      END IF  #160801-00028#1
      
      DISPLAY BY NAME g_pmdl_m.pmdl004,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl027,g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,
           g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,
           g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,
           g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,
           g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,
           g_pmdl_m.pmdl055,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,
           g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl046,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041
       

END FUNCTION

PRIVATE FUNCTION apmt500_set_no_required()

    CALL cl_set_comp_required("pmdl008,pmdl051",FALSE)

END FUNCTION

PRIVATE FUNCTION apmt500_set_required()
  
    IF g_pmdl_m.pmdl007 MATCHES '[78]' THEN
       CALL cl_set_comp_required("pmdl008",TRUE)
    END IF
    
    IF g_pmdl_m.pmdl006 MATCHES '[23]' THEN
       CALL cl_set_comp_required("pmdl051",TRUE)
    END IF
    
END FUNCTION

#根據預先採購單，產生採購單單身
PRIVATE FUNCTION apmt500_gen_purchase_pmdn()
#161124-00048#9 mod-S
#DEFINE l_pmdn      RECORD LIKE pmdn_t.*
DEFINE l_pmdn RECORD  #採購單身明細檔
       pmdnent LIKE pmdn_t.pmdnent, #企业编号
       pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
       pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
       pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
       pmdnseq LIKE pmdn_t.pmdnseq, #项次
       pmdn001 LIKE pmdn_t.pmdn001, #料件编号
       pmdn002 LIKE pmdn_t.pmdn002, #产品特征
       pmdn003 LIKE pmdn_t.pmdn003, #包装容器
       pmdn004 LIKE pmdn_t.pmdn004, #作业编号
       pmdn005 LIKE pmdn_t.pmdn005, #作业序
       pmdn006 LIKE pmdn_t.pmdn006, #采购单位
       pmdn007 LIKE pmdn_t.pmdn007, #采购数量
       pmdn008 LIKE pmdn_t.pmdn008, #参考单位
       pmdn009 LIKE pmdn_t.pmdn009, #参考数量
       pmdn010 LIKE pmdn_t.pmdn010, #计价单位
       pmdn011 LIKE pmdn_t.pmdn011, #计价数量
       pmdn012 LIKE pmdn_t.pmdn012, #出货日期
       pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
       pmdn014 LIKE pmdn_t.pmdn014, #到库日期
       pmdn015 LIKE pmdn_t.pmdn015, #单价
       pmdn016 LIKE pmdn_t.pmdn016, #税种
       pmdn017 LIKE pmdn_t.pmdn017, #税率
       pmdn019 LIKE pmdn_t.pmdn019, #子件特性
       pmdn020 LIKE pmdn_t.pmdn020, #紧急度
       pmdn021 LIKE pmdn_t.pmdn021, #保税
       pmdn022 LIKE pmdn_t.pmdn022, #部分交货
       pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
       pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
       pmdn024 LIKE pmdn_t.pmdn024, #多交期
       pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
       pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
       pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
       pmdn028 LIKE pmdn_t.pmdn028, #收货库位
       pmdn029 LIKE pmdn_t.pmdn029, #收货储位
       pmdn030 LIKE pmdn_t.pmdn030, #收货批号
       pmdn031 LIKE pmdn_t.pmdn031, #运输方式
       pmdn032 LIKE pmdn_t.pmdn032, #取货模式
       pmdn033 LIKE pmdn_t.pmdn033, #备品率
       pmdn034 LIKE pmdn_t.pmdn034, #no use
       pmdn035 LIKE pmdn_t.pmdn035, #价格核决
       pmdn036 LIKE pmdn_t.pmdn036, #项目编号
       pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
       pmdn038 LIKE pmdn_t.pmdn038, #活动编号
       pmdn039 LIKE pmdn_t.pmdn039, #费用原因
       pmdn040 LIKE pmdn_t.pmdn040, #取价来源
       pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
       pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
       pmdn043 LIKE pmdn_t.pmdn043, #取出价格
       pmdn044 LIKE pmdn_t.pmdn044, #价差比
       pmdn045 LIKE pmdn_t.pmdn045, #行状态
       pmdn046 LIKE pmdn_t.pmdn046, #税前金额
       pmdn047 LIKE pmdn_t.pmdn047, #含税金额
       pmdn048 LIKE pmdn_t.pmdn048, #税额
       pmdn049 LIKE pmdn_t.pmdn049, #理由码
       pmdn050 LIKE pmdn_t.pmdn050, #备注
       pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
       pmdn052 LIKE pmdn_t.pmdn052, #检验否
       pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
       pmdn200 LIKE pmdn_t.pmdn200, #商品条码
       pmdn201 LIKE pmdn_t.pmdn201, #包装单位
       pmdn202 LIKE pmdn_t.pmdn202, #包装数量
       pmdn203 LIKE pmdn_t.pmdn203, #收货部门
       pmdn204 LIKE pmdn_t.pmdn204, #No Use
       pmdn205 LIKE pmdn_t.pmdn205, #要货组织
       pmdn206 LIKE pmdn_t.pmdn206, #库存量
       pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
       pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
       pmdn209 LIKE pmdn_t.pmdn209, #上月销量
       pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
       pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
       pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
       pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
       pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
       pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
       pmdn216 LIKE pmdn_t.pmdn216, #经营方式
       pmdn217 LIKE pmdn_t.pmdn217, #结算方式
       pmdn218 LIKE pmdn_t.pmdn218, #合同编号
       pmdn219 LIKE pmdn_t.pmdn219, #协议编号
       pmdn220 LIKE pmdn_t.pmdn220, #采购人员
       pmdn221 LIKE pmdn_t.pmdn221, #采购部门
       pmdn222 LIKE pmdn_t.pmdn222, #采购中心
       pmdn223 LIKE pmdn_t.pmdn223, #配送中心
       pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
       pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
       pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
       pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
       pmdn054 LIKE pmdn_t.pmdn054, #还料数量
       pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
       pmdn056 LIKE pmdn_t.pmdn056, #还价数量
       pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
       pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
       pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
       pmdn058 LIKE pmdn_t.pmdn058, #预算科目
       pmdn228 LIKE pmdn_t.pmdn228  #商品品类
END RECORD
#161124-00048#9 mod-E
DEFINE r_success   LIKE type_t.num5
DEFINE l_pmdn007   LIKE pmdn_t.pmdn007
DEFINE l_success   LIKE type_t.num5
DEFINE l_pmdn007_t LIKE pmdn_t.pmdn007
DEFINE l_ooba002   LIKE ooba_t.ooba002  #150820#150819-00010 by whitney add

     LET r_success = TRUE
     
     IF g_pmdl_m.pmdl007 <>  '8' THEN
        RETURN r_success
     END IF
     IF cl_null(g_pmdl_m.pmdl008) THEN
        RETURN r_success
     END IF
     #161124-00048#9 mod-S
#     DECLARE pur_ins_pmdn CURSOR FOR
#         SELECT * FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdl008
     DECLARE pur_ins_pmdn CURSOR FOR
         SELECT pmdnent,pmdnsite,pmdnunit,pmdndocno,pmdnseq,
                pmdn001,pmdn002,pmdn003,pmdn004,pmdn005,
                pmdn006,pmdn007,pmdn008,pmdn009,pmdn010,
                pmdn011,pmdn012,pmdn013,pmdn014,pmdn015,
                pmdn016,pmdn017,pmdn019,pmdn020,pmdn021,
                pmdn022,pmdnorga,pmdn023,pmdn024,pmdn025,
                pmdn026,pmdn027,pmdn028,pmdn029,pmdn030,
                pmdn031,pmdn032,pmdn033,pmdn034,pmdn035,
                pmdn036,pmdn037,pmdn038,pmdn039,pmdn040,
                pmdn041,pmdn042,pmdn043,pmdn044,pmdn045,
                pmdn046,pmdn047,pmdn048,pmdn049,pmdn050,
                pmdn051,pmdn052,pmdn053,pmdn200,pmdn201,
                pmdn202,pmdn203,pmdn204,pmdn205,pmdn206,
                pmdn207,pmdn208,pmdn209,pmdn210,pmdn211,
                pmdn212,pmdn213,pmdn214,pmdn215,pmdn216,
                pmdn217,pmdn218,pmdn219,pmdn220,pmdn221,
                pmdn222,pmdn223,pmdn224,pmdn900,pmdn999,
                pmdn225,pmdn054,pmdn055,pmdn056,pmdn057,
                pmdn226,pmdn227,pmdn058,pmdn228
           FROM pmdn_t 
          WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdl008
     #161124-00048#9 mod-S
     
     INITIALIZE l_pmdn.* TO NULL     
     FOREACH pur_ins_pmdn INTO l_pmdn.*
        
        LET l_pmdn.pmdndocno = g_pmdl_m.pmdldocno
        
        #已轉採購單的數量
        SELECT SUM(pmdn007) INTO l_pmdn007 FROM pmdn_t,pmdl_t 
           WHERE pmdlent = pmdnent AND pmdldocno = pmdndocno AND pmdl008 = g_pmdl_m.pmdl008 
             AND pmdnseq = l_pmdn.pmdnseq AND pmdlstus <> 'X'
             
        IF cl_null(l_pmdn007) THEN
           LET l_pmdn007 = 0
        END IF
        LET l_pmdn007_t = l_pmdn.pmdn007
        LET l_pmdn.pmdn007 = l_pmdn.pmdn007 - l_pmdn007
        IF l_pmdn.pmdn007 = 0 THEN
           CONTINUE FOREACH
        END IF
        
        IF NOT cl_null(l_pmdn.pmdn006) THEN
           CALL s_aooi250_take_decimals(l_pmdn.pmdn006,l_pmdn.pmdn007)
              RETURNING l_success,l_pmdn.pmdn007
                   
           IF (NOT cl_null(l_pmdn.pmdn008)) AND (NOT cl_null(l_pmdn.pmdn001)) THEN
              CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn008,l_pmdn.pmdn007)
                        RETURNING l_success,l_pmdn.pmdn009
              CALL s_aooi250_take_decimals(l_pmdn.pmdn008,l_pmdn.pmdn009)
                  RETURNING l_success,l_pmdn.pmdn009
           END IF
           
           IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(l_pmdn.pmdn010)) AND (NOT cl_null(l_pmdn.pmdn010)) THEN
              CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn010,l_pmdn.pmdn007)
                        RETURNING l_success,l_pmdn.pmdn011
              CALL s_aooi250_take_decimals(l_pmdn.pmdn010,l_pmdn.pmdn011)
                  RETURNING l_success,l_pmdn.pmdn011
           ELSE
              LET l_pmdn.pmdn010 = l_pmdn.pmdn006
              LET l_pmdn.pmdn011 = l_pmdn.pmdn007
           END IF
        END IF
        
        #重新計算含稅、未稅金額
        CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq,g_pmdl_m.pmdl015,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016)
                          
          RETURNING l_pmdn.pmdn046,l_pmdn.pmdn048,l_pmdn.pmdn047
        
        #150820#150819-00010 by whitney add start
        IF cl_null(l_pmdn.pmdn028) THEN
           CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_ooba002
           CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING l_pmdn.pmdn028
        END IF
        #150820#150819-00010 by whitney add end
        
        #新增採購單身明細
        INSERT INTO pmdn_t(pmdnent,pmdnsite,pmdndocno,pmdnseq,pmdn001,pmdn002,pmdn003,pmdn006,pmdn007,
                           pmdn008,pmdn009,pmdn010,pmdn011,pmdn012,pmdn013,pmdn014,pmdn015,pmdn016,
                           pmdn017,pmdn019,pmdn020,pmdn021,pmdn022,pmdn023,pmdn024,pmdn025,pmdn026,
                           pmdn027,pmdn028,pmdn029,pmdn030,pmdn031,pmdn032,pmdn033,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044,pmdn045,
                           pmdn046,pmdn047,pmdn048,pmdnunit,pmdnorga,pmdn052,pmdn053,
                           pmdn054,pmdn055,pmdn056,pmdn057,pmdn058)
          VALUES (g_enterprise,l_pmdn.pmdnsite,l_pmdn.pmdndocno,l_pmdn.pmdnseq,l_pmdn.pmdn001,l_pmdn.pmdn002,
                  l_pmdn.pmdn003,l_pmdn.pmdn006,l_pmdn.pmdn007,l_pmdn.pmdn008,l_pmdn.pmdn009,
                  l_pmdn.pmdn010,l_pmdn.pmdn011,l_pmdn.pmdn012,l_pmdn.pmdn013,l_pmdn.pmdn014,
                  l_pmdn.pmdn015,l_pmdn.pmdn016,l_pmdn.pmdn017,l_pmdn.pmdn019,l_pmdn.pmdn020,
                  l_pmdn.pmdn021,l_pmdn.pmdn022,l_pmdn.pmdn023,l_pmdn.pmdn024,l_pmdn.pmdn025,
                  l_pmdn.pmdn026,l_pmdn.pmdn027,l_pmdn.pmdn028,l_pmdn.pmdn029,l_pmdn.pmdn030,l_pmdn.pmdn031,
                  l_pmdn.pmdn032,l_pmdn.pmdn033,l_pmdn.pmdn035,l_pmdn.pmdn040,l_pmdn.pmdn041,l_pmdn.pmdn042,
                  l_pmdn.pmdn043,l_pmdn.pmdn044,l_pmdn.pmdn045,
                  l_pmdn.pmdn046,l_pmdn.pmdn047,l_pmdn.pmdn048,l_pmdn.pmdnunit,l_pmdn.pmdnorga,
                  l_pmdn.pmdn052,l_pmdn.pmdn053,
                  0,0,0,0,l_pmdn.pmdn058)
        IF SQLCA.SQLcode  THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "pmdn_t"
            LET g_errparam.popup = TRUE
            CALL cl_err()
        
            LET r_success = FALSE                 
            RETURN r_success
        END IF
        
        #新增交期明細資料
        IF NOT apmt500_gen_purchase_pmdq(l_pmdn.pmdnseq) THEN
           LET r_success = FALSE                 
           RETURN r_success
        END IF
        
        IF NOT s_apmt500_gen_pmdo(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq) THEN
           LET r_success = FALSE                 
           RETURN r_success
        END IF
        
        #新增關聯單身明細
        IF NOT apmt500_gen_purchase_pmdp(l_pmdn.*) THEN
           LET r_success = FALSE                 
           RETURN r_success
        END IF
        
        ##更新請購單中的已轉採購量
        #IF NOT s_apmt500_upd_pmdb049(l_pmdn.pmdndocno,l_pmdn.pmdnseq,'1') THEN
        #   LET r_success = FALSE                 
        #   RETURN r_success
        #END IF
        
        INITIALIZE l_pmdn.* TO NULL
     END FOREACH
     
     RETURN r_success
     
END FUNCTION

#新增交期明細資料
PRIVATE FUNCTION apmt500_gen_purchase_pmdq(p_pmdnseq)
DEFINE p_pmdnseq     LIKE pmdn_t.pmdnseq
DEFINE r_success     LIKE type_t.num5
#161124-00048#9 mod-S
#DEFINE l_pmdq        RECORD LIKE pmdq_t.*
DEFINE l_pmdq RECORD  #採購多交期匯總檔
       pmdqent LIKE pmdq_t.pmdqent, #企业编号
       pmdqsite LIKE pmdq_t.pmdqsite, #营运据点
       pmdqdocno LIKE pmdq_t.pmdqdocno, #采购单号
       pmdqseq LIKE pmdq_t.pmdqseq, #采购项次
       pmdqseq2 LIKE pmdq_t.pmdqseq2, #分批序
       pmdq002 LIKE pmdq_t.pmdq002, #分批数量
       pmdq003 LIKE pmdq_t.pmdq003, #交货日期
       pmdq004 LIKE pmdq_t.pmdq004, #到厂日期
       pmdq005 LIKE pmdq_t.pmdq005, #到库日期
       pmdq006 LIKE pmdq_t.pmdq006, #收货时段
       pmdq007 LIKE pmdq_t.pmdq007, #MRP冻结否
       pmdq008 LIKE pmdq_t.pmdq008, #交期类型
       pmdq201 LIKE pmdq_t.pmdq201, #分批包装单位
       pmdq202 LIKE pmdq_t.pmdq202, #分批包装数量
       pmdq900 LIKE pmdq_t.pmdq900, #保留字段str
       pmdq999 LIKE pmdq_t.pmdq999  #保留字段end
END RECORD
#161124-00048#9 mod-E
DEFINE l_pmdq002     LIKE pmdq_t.pmdq002

     LET r_success = TRUE
     #161124-00048#9 mod-S
#     DECLARE pur_ins_pmdq CURSOR FOR
#         SELECT * FROM pmdq_t WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdl008 AND pmdqseq = p_pmdnseq
     DECLARE pur_ins_pmdq CURSOR FOR
         SELECT pmdqent,pmdqsite,pmdqdocno,pmdqseq,pmdqseq2,
                pmdq002,pmdq003,pmdq004,pmdq005,pmdq006,
                pmdq007,pmdq008,pmdq201,pmdq202,pmdq900,
                pmdq999 
           FROM pmdq_t 
          WHERE pmdqent = g_enterprise AND pmdqdocno = g_pmdl_m.pmdl008 AND pmdqseq = p_pmdnseq
     #161124-00048#9 mod-E
     
     INITIALIZE l_pmdq.* TO NULL     
     FOREACH pur_ins_pmdq INTO l_pmdq.*
        
        LET l_pmdq.pmdqdocno = g_pmdl_m.pmdldocno
        
        #已轉採購單的數量
        SELECT SUM(pmdq002) INTO l_pmdq002 FROM pmdq_t,pmdl_t 
           WHERE pmdlent = pmdqent AND pmdldocno = pmdqdocno AND pmdl008 = g_pmdl_m.pmdl008 
             AND pmdqseq = l_pmdq.pmdqseq AND pmdqseq2 = l_pmdq.pmdqseq2 AND pmdlstus <> 'X'
        
        IF cl_null(l_pmdq002) THEN
           LET l_pmdq002 = 0
        END IF
        
        LET l_pmdq.pmdq002 = l_pmdq.pmdq002 - l_pmdq002
        IF l_pmdq.pmdq002 = 0 THEN
           CONTINUE FOREACH
        END IF
        
        INSERT INTO pmdq_t(pmdqent,pmdqsite,pmdqdocno,pmdqseq,pmdqseq2,pmdq002,pmdq003,pmdq004,
                           pmdq005,pmdq006,pmdq007,pmdq008)
                VALUES (g_enterprise,l_pmdq.pmdqsite,l_pmdq.pmdqdocno,l_pmdq.pmdqseq,l_pmdq.pmdqseq2,
                        l_pmdq.pmdq002,l_pmdq.pmdq003,l_pmdq.pmdq004,l_pmdq.pmdq005,l_pmdq.pmdq006,l_pmdq.pmdq007,l_pmdq.pmdq008)
        IF SQLCA.SQLcode  THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = SQLCA.sqlcode
           LET g_errparam.extend = "pmdq_t"
           LET g_errparam.popup = TRUE
           CALL cl_err()

           LET r_success = FALSE                 
           RETURN r_success
        END IF

        
        INITIALIZE l_pmdq.* TO NULL
     END FOREACH
     
     RETURN r_success
     
END FUNCTION

#新增關聯單身明細
PRIVATE FUNCTION apmt500_gen_purchase_pmdp(p_pmdn)
#161124-00048#9 mod-S
#DEFINE p_pmdn    RECORD LIKE pmdn_t.*
#DEFINE l_pmdp    RECORD LIKE pmdp_t.*
DEFINE p_pmdn RECORD  #採購單身明細檔
       pmdnent LIKE pmdn_t.pmdnent, #企业编号
       pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
       pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
       pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
       pmdnseq LIKE pmdn_t.pmdnseq, #项次
       pmdn001 LIKE pmdn_t.pmdn001, #料件编号
       pmdn002 LIKE pmdn_t.pmdn002, #产品特征
       pmdn003 LIKE pmdn_t.pmdn003, #包装容器
       pmdn004 LIKE pmdn_t.pmdn004, #作业编号
       pmdn005 LIKE pmdn_t.pmdn005, #作业序
       pmdn006 LIKE pmdn_t.pmdn006, #采购单位
       pmdn007 LIKE pmdn_t.pmdn007, #采购数量
       pmdn008 LIKE pmdn_t.pmdn008, #参考单位
       pmdn009 LIKE pmdn_t.pmdn009, #参考数量
       pmdn010 LIKE pmdn_t.pmdn010, #计价单位
       pmdn011 LIKE pmdn_t.pmdn011, #计价数量
       pmdn012 LIKE pmdn_t.pmdn012, #出货日期
       pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
       pmdn014 LIKE pmdn_t.pmdn014, #到库日期
       pmdn015 LIKE pmdn_t.pmdn015, #单价
       pmdn016 LIKE pmdn_t.pmdn016, #税种
       pmdn017 LIKE pmdn_t.pmdn017, #税率
       pmdn019 LIKE pmdn_t.pmdn019, #子件特性
       pmdn020 LIKE pmdn_t.pmdn020, #紧急度
       pmdn021 LIKE pmdn_t.pmdn021, #保税
       pmdn022 LIKE pmdn_t.pmdn022, #部分交货
       pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
       pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
       pmdn024 LIKE pmdn_t.pmdn024, #多交期
       pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
       pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
       pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
       pmdn028 LIKE pmdn_t.pmdn028, #收货库位
       pmdn029 LIKE pmdn_t.pmdn029, #收货储位
       pmdn030 LIKE pmdn_t.pmdn030, #收货批号
       pmdn031 LIKE pmdn_t.pmdn031, #运输方式
       pmdn032 LIKE pmdn_t.pmdn032, #取货模式
       pmdn033 LIKE pmdn_t.pmdn033, #备品率
       pmdn034 LIKE pmdn_t.pmdn034, #no use
       pmdn035 LIKE pmdn_t.pmdn035, #价格核决
       pmdn036 LIKE pmdn_t.pmdn036, #项目编号
       pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
       pmdn038 LIKE pmdn_t.pmdn038, #活动编号
       pmdn039 LIKE pmdn_t.pmdn039, #费用原因
       pmdn040 LIKE pmdn_t.pmdn040, #取价来源
       pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
       pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
       pmdn043 LIKE pmdn_t.pmdn043, #取出价格
       pmdn044 LIKE pmdn_t.pmdn044, #价差比
       pmdn045 LIKE pmdn_t.pmdn045, #行状态
       pmdn046 LIKE pmdn_t.pmdn046, #税前金额
       pmdn047 LIKE pmdn_t.pmdn047, #含税金额
       pmdn048 LIKE pmdn_t.pmdn048, #税额
       pmdn049 LIKE pmdn_t.pmdn049, #理由码
       pmdn050 LIKE pmdn_t.pmdn050, #备注
       pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
       pmdn052 LIKE pmdn_t.pmdn052, #检验否
       pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
       pmdn200 LIKE pmdn_t.pmdn200, #商品条码
       pmdn201 LIKE pmdn_t.pmdn201, #包装单位
       pmdn202 LIKE pmdn_t.pmdn202, #包装数量
       pmdn203 LIKE pmdn_t.pmdn203, #收货部门
       pmdn204 LIKE pmdn_t.pmdn204, #No Use
       pmdn205 LIKE pmdn_t.pmdn205, #要货组织
       pmdn206 LIKE pmdn_t.pmdn206, #库存量
       pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
       pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
       pmdn209 LIKE pmdn_t.pmdn209, #上月销量
       pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
       pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
       pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
       pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
       pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
       pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
       pmdn216 LIKE pmdn_t.pmdn216, #经营方式
       pmdn217 LIKE pmdn_t.pmdn217, #结算方式
       pmdn218 LIKE pmdn_t.pmdn218, #合同编号
       pmdn219 LIKE pmdn_t.pmdn219, #协议编号
       pmdn220 LIKE pmdn_t.pmdn220, #采购人员
       pmdn221 LIKE pmdn_t.pmdn221, #采购部门
       pmdn222 LIKE pmdn_t.pmdn222, #采购中心
       pmdn223 LIKE pmdn_t.pmdn223, #配送中心
       pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
       pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
       pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
       pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
       pmdn054 LIKE pmdn_t.pmdn054, #还料数量
       pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
       pmdn056 LIKE pmdn_t.pmdn056, #还价数量
       pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
       pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
       pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
       pmdn058 LIKE pmdn_t.pmdn058, #预算科目
       pmdn228 LIKE pmdn_t.pmdn228  #商品品类
END RECORD
DEFINE l_pmdp RECORD  #採購關聯單據明細檔
       pmdpent LIKE pmdp_t.pmdpent, #企业编号
       pmdpsite LIKE pmdp_t.pmdpsite, #营运据点
       pmdpdocno LIKE pmdp_t.pmdpdocno, #采购单号
       pmdpseq LIKE pmdp_t.pmdpseq, #采购项次
       pmdpseq1 LIKE pmdp_t.pmdpseq1, #项序
       pmdp001 LIKE pmdp_t.pmdp001, #料件编号
       pmdp002 LIKE pmdp_t.pmdp002, #产品特征
       pmdp003 LIKE pmdp_t.pmdp003, #来源单号
       pmdp004 LIKE pmdp_t.pmdp004, #来源项次
       pmdp005 LIKE pmdp_t.pmdp005, #来源项序
       pmdp006 LIKE pmdp_t.pmdp006, #来源分批序
       pmdp007 LIKE pmdp_t.pmdp007, #来源料号
       pmdp008 LIKE pmdp_t.pmdp008, #来源产品特征
       pmdp009 LIKE pmdp_t.pmdp009, #来源作业编号
       pmdp010 LIKE pmdp_t.pmdp010, #来源作业序
       pmdp011 LIKE pmdp_t.pmdp011, #来源BOM特性
       pmdp012 LIKE pmdp_t.pmdp012, #来源生产控制组
       pmdp021 LIKE pmdp_t.pmdp021, #冲销顺序
       pmdp022 LIKE pmdp_t.pmdp022, #需求单位
       pmdp023 LIKE pmdp_t.pmdp023, #需求数量
       pmdp024 LIKE pmdp_t.pmdp024, #折合采购量
       pmdp025 LIKE pmdp_t.pmdp025, #已收货量
       pmdp026 LIKE pmdp_t.pmdp026, #已入库量
       pmdp900 LIKE pmdp_t.pmdp900, #保留字段str
       pmdp999 LIKE pmdp_t.pmdp999  #保留字段end
END RECORD
#161124-00048#9 mod-E
DEFINE p_pmdn007 LIKE pmdn_t.pmdn007
DEFINE r_success LIKE type_t.num5

    LET r_success = TRUE
    
    LET l_pmdp.pmdpdocno = p_pmdn.pmdndocno
    LET l_pmdp.pmdpseq = p_pmdn.pmdnseq
    
    #項序加1
    SELECT MAX(pmdpseq1)+1 INTO l_pmdp.pmdpseq1 FROM pmdp_t
      WHERE pmdpent = g_enterprise AND pmdpdocno = p_pmdn.pmdndocno AND pmdpseq = p_pmdn.pmdnseq
    IF cl_null(l_pmdp.pmdpseq1) OR l_pmdp.pmdpseq1 = 0 THEN
       LET l_pmdp.pmdpseq1 = 1
    END IF
    
    LET l_pmdp.pmdp001 = p_pmdn.pmdn001
    LET l_pmdp.pmdp002 = p_pmdn.pmdn002
    LET l_pmdp.pmdp003 = g_pmdl_m.pmdl008
    LET l_pmdp.pmdp004 = p_pmdn.pmdnseq
    
    LET l_pmdp.pmdp007 = p_pmdn.pmdn001
    LET l_pmdp.pmdp008 = p_pmdn.pmdn002
    LET l_pmdp.pmdp009 = p_pmdn.pmdn004
    LET l_pmdp.pmdp010 = p_pmdn.pmdn005
    
    LET l_pmdp.pmdp022 = p_pmdn.pmdn006
    LET l_pmdp.pmdp023 = p_pmdn.pmdn007
    LET l_pmdp.pmdp024 = p_pmdn.pmdn007
    LET l_pmdp.pmdp025 = 0
    LET l_pmdp.pmdp026 = 0
    
    SELECT MAX(pmdp021)+1 INTO l_pmdp.pmdp021 FROM pmdp_t
       WHERE pmdp001 = l_pmdp.pmdp001 AND pmdp002 = l_pmdp.pmdp002 AND pmdp022 = l_pmdp.pmdp022
         AND pmdpdocno = l_pmdp.pmdpdocno
         AND pmdpent   = g_enterprise   #160905-00007#11 Add
    IF cl_null(l_pmdp.pmdp021) OR l_pmdp.pmdp021 = 0 THEN
       LET l_pmdp.pmdp021 = 1
    END IF
          
    
    INSERT INTO pmdp_t(pmdpent,pmdpsite,pmdpdocno,pmdpseq,pmdpseq1,pmdp001,pmdp002,pmdp003,pmdp004,
                       pmdp007,pmdp008,pmdp009,pmdp010,pmdp021,pmdp022,pmdp023,pmdp024,pmdp025,pmdp026)
               VALUES (g_enterprise,g_site,l_pmdp.pmdpdocno,l_pmdp.pmdpseq,l_pmdp.pmdpseq1,l_pmdp.pmdp001,
                       l_pmdp.pmdp002,l_pmdp.pmdp003,l_pmdp.pmdp004,l_pmdp.pmdp007,l_pmdp.pmdp008,l_pmdp.pmdp009,l_pmdp.pmdp010,
                       l_pmdp.pmdp021,l_pmdp.pmdp022,l_pmdp.pmdp023,l_pmdp.pmdp024,l_pmdp.pmdp025,l_pmdp.pmdp026)
    IF SQLCA.SQLcode  THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = SQLCA.sqlcode
       LET g_errparam.extend = "pmdp_t"
       LET g_errparam.popup = TRUE
       CALL cl_err()

       LET r_success = FALSE                 
       RETURN r_success
    END IF
    
    RETURN r_success

END FUNCTION

PRIVATE FUNCTION apmt500_set_required_b()
DEFINE l_imaf055  LIKE imaf_t.imaf055
DEFINE l_imaa004  LIKE imaa_t.imaa004   #160815-00031#2
DEFINE l_imaa005  LIKE imaa_t.imaa005   #160908-00014#1
DEFINE l_imea003  LIKE imea_t.imea003   #160908-00014#1

   LET l_imaf055 = ''
   SELECT imaf055 INTO l_imaf055 FROM imaf_t WHERE imafent = g_enterprise AND imaf001 = g_pmdn_d[l_ac].pmdn001 AND imafsite = g_site
   
   #若設定imaf055(庫存管理特徵)等於'1.必須有庫存管理特徵'時，則[C:庫存管理特徵]欄位必須輸入
   IF l_imaf055 = '1' THEN
      CALL cl_set_comp_required("pmdn053",TRUE)
   END IF
   
   #160815-00031#2---s
   LET l_imaa004 = ''
   SELECT imaa004 INTO l_imaa004 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_pmdn_d[l_ac].pmdn001
   IF l_imaa004 = 'E' THEN
      CALL cl_set_comp_required("pmdn050",TRUE)
   END IF
   #160815-00031#2---e
   
   #160908-00014#1--s
   #對應的特徵群組有 勾選'需求來源可以不指定產品特徵'時，可以不指定產品特徵
   LET l_imaa005 = ''
   CALL apmt500_get_imaa005(g_enterprise,g_pmdn_d[l_ac].pmdn001) RETURNING l_imaa005
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' AND NOT cl_null(l_imaa005) THEN
      LET l_imea003 =  ''
      SELECT imea003 INTO l_imea003 FROM imea_t WHERE imeaent = g_enterprise AND imea001 = l_imaa005
      IF l_imea003 = 'N' THEN
         CALL cl_set_comp_required("pmdn002",TRUE)
      END IF
   END IF
   #160908-00014#1--e
   
   
END FUNCTION

PRIVATE FUNCTION apmt500_set_no_required_b()

   CALL cl_set_comp_required("pmdn053",FALSE)
   
   CALL cl_set_comp_required("pmdn050",FALSE) #160815-00031#2
   
   CALL cl_set_comp_required("pmdn002",FALSE)  #160908-00014#1

END FUNCTION

#留置時，維護留置理由碼
PRIVATE FUNCTION apmt500_upd_pmdl043()
DEFINE r_success   LIKE type_t.num5
DEFINE l_pmdlmoddt LIKE pmdl_t.pmdlmoddt
DEFINE l_sql       STRING

   LET r_success = TRUE
   
   IF g_pmdl_m.pmdldocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   LET l_sql = " SELECT pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004, 
                        pmdl003,pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009, 
                        pmdl010,pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018, 
                        pmdl019,pmdl023,pmdl043,pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029, 
                        pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl040, 
                        pmdl041,pmdl042,pmdl047,pmdl048,pmdl049,pmdl046,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp, 
                        pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt", 
                      " FROM pmdl_t",
                      " WHERE pmdlent= ? AND pmdldocno=? FOR UPDATE"
   LET l_sql = cl_sql_forupd(l_sql)                #轉換不同資料庫語法
   LET l_sql = cl_sql_add_mask(l_sql)              #遮蔽特定資料
   DECLARE apmt500_pmdl043_cl CURSOR FROM l_sql
   
   OPEN apmt500_pmdl043_cl USING g_enterprise,g_pmdl_m.pmdldocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt500_pmdl043_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt500_pmdl043_cl
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #鎖住將被更改的資料
   FETCH apmt500_pmdl043_cl INTO g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt, 
       g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,
       g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027, 
       g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,
       g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,
       g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,
       g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl046,g_pmdl_m.pmdlownid,
       g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt, 
       g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt
   
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_pmdl_m.pmdldocno 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      CLOSE apmt500_pmdl043_cl
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   CALL apmt500_show()
    
   CALL cl_set_comp_entry("pmdl043",TRUE)
   
   LET g_pmdl_m_t.* = g_pmdl_m.*
   
   INPUT BY NAME g_pmdl_m.pmdl043 WITHOUT DEFAULTS
             
      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG = 1 THEN
            LET INT_FLAG = 0
            LET r_success = FALSE
            RETURN r_success
         END IF

      AFTER FIELD pmdl043
         CALL s_desc_get_acc_desc('317',g_pmdl_m.pmdl043) RETURNING g_pmdl_m.pmdl043_desc
         DISPLAY BY NAME g_pmdl_m.pmdl043_desc
         IF NOT cl_null(g_pmdl_m.pmdl043) THEN
            IF NOT s_azzi650_chk_exist('317',g_pmdl_m.pmdl043) THEN
               LET g_pmdl_m.pmdl043 = g_pmdl_m_t.pmdl043
               CALL s_desc_get_acc_desc('317',g_pmdl_m.pmdl043) RETURNING g_pmdl_m.pmdl043_desc
               DISPLAY BY NAME g_pmdl_m.pmdl043_desc
               NEXT FIELD pmdl043
            END IF
         END IF
         
      ON ACTION controlp INFIELD pmdl043
         INITIALIZE g_qryparam.* TO NULL
         LET g_qryparam.state = 'i'
         LET g_qryparam.reqry = FALSE

         LET g_qryparam.default1 = g_pmdl_m.pmdl043             
         #給予arg
         LET g_qryparam.arg1 = "317" 
         CALL q_oocq002()                                #呼叫開窗

         LET g_pmdl_m.pmdl043 = g_qryparam.return1    
         DISPLAY g_pmdl_m.pmdl043 TO pmdl043 
         CALL s_desc_get_acc_desc('317',g_pmdl_m.pmdl043) RETURNING g_pmdl_m.pmdl043_desc
         DISPLAY BY NAME g_pmdl_m.pmdl043_desc         
         NEXT FIELD pmdl043                          #返回原欄位

      
   END INPUT
   
   IF INT_FLAG OR g_pmdl_m.pmdl043 IS NULL THEN
      LET INT_FLAG = 0
      LET r_success = FALSE
      RETURN r_success
   END IF

   LET l_pmdlmoddt = cl_get_current()

   UPDATE pmdl_t SET pmdl043 = g_pmdl_m.pmdl043,
                     pmdlmodid = g_user,
                     pmdlmoddt = l_pmdlmoddt
     WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "g_pmdl_m"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt500_pmdl043_cl
      LET r_success = FALSE
      RETURN r_success 
   END IF
   
   CALL cl_set_comp_entry("pmdl043",FALSE)
    
   CLOSE apmt500_pmdl043_cl
   
   RETURN r_success
   
END FUNCTION
#對整個單身重新取價
PRIVATE FUNCTION apmt500_get_detail_price()
DEFINE l_forupd_sql    STRING
#161124-00048#9 mod-S
#DEFINE l_pmdn      RECORD LIKE pmdn_t.*
DEFINE l_pmdn RECORD  #採購單身明細檔
       pmdnent LIKE pmdn_t.pmdnent, #企业编号
       pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
       pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
       pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
       pmdnseq LIKE pmdn_t.pmdnseq, #项次
       pmdn001 LIKE pmdn_t.pmdn001, #料件编号
       pmdn002 LIKE pmdn_t.pmdn002, #产品特征
       pmdn003 LIKE pmdn_t.pmdn003, #包装容器
       pmdn004 LIKE pmdn_t.pmdn004, #作业编号
       pmdn005 LIKE pmdn_t.pmdn005, #作业序
       pmdn006 LIKE pmdn_t.pmdn006, #采购单位
       pmdn007 LIKE pmdn_t.pmdn007, #采购数量
       pmdn008 LIKE pmdn_t.pmdn008, #参考单位
       pmdn009 LIKE pmdn_t.pmdn009, #参考数量
       pmdn010 LIKE pmdn_t.pmdn010, #计价单位
       pmdn011 LIKE pmdn_t.pmdn011, #计价数量
       pmdn012 LIKE pmdn_t.pmdn012, #出货日期
       pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
       pmdn014 LIKE pmdn_t.pmdn014, #到库日期
       pmdn015 LIKE pmdn_t.pmdn015, #单价
       pmdn016 LIKE pmdn_t.pmdn016, #税种
       pmdn017 LIKE pmdn_t.pmdn017, #税率
       pmdn019 LIKE pmdn_t.pmdn019, #子件特性
       pmdn020 LIKE pmdn_t.pmdn020, #紧急度
       pmdn021 LIKE pmdn_t.pmdn021, #保税
       pmdn022 LIKE pmdn_t.pmdn022, #部分交货
       pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
       pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
       pmdn024 LIKE pmdn_t.pmdn024, #多交期
       pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
       pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
       pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
       pmdn028 LIKE pmdn_t.pmdn028, #收货库位
       pmdn029 LIKE pmdn_t.pmdn029, #收货储位
       pmdn030 LIKE pmdn_t.pmdn030, #收货批号
       pmdn031 LIKE pmdn_t.pmdn031, #运输方式
       pmdn032 LIKE pmdn_t.pmdn032, #取货模式
       pmdn033 LIKE pmdn_t.pmdn033, #备品率
       pmdn034 LIKE pmdn_t.pmdn034, #no use
       pmdn035 LIKE pmdn_t.pmdn035, #价格核决
       pmdn036 LIKE pmdn_t.pmdn036, #项目编号
       pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
       pmdn038 LIKE pmdn_t.pmdn038, #活动编号
       pmdn039 LIKE pmdn_t.pmdn039, #费用原因
       pmdn040 LIKE pmdn_t.pmdn040, #取价来源
       pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
       pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
       pmdn043 LIKE pmdn_t.pmdn043, #取出价格
       pmdn044 LIKE pmdn_t.pmdn044, #价差比
       pmdn045 LIKE pmdn_t.pmdn045, #行状态
       pmdn046 LIKE pmdn_t.pmdn046, #税前金额
       pmdn047 LIKE pmdn_t.pmdn047, #含税金额
       pmdn048 LIKE pmdn_t.pmdn048, #税额
       pmdn049 LIKE pmdn_t.pmdn049, #理由码
       pmdn050 LIKE pmdn_t.pmdn050, #备注
       pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
       pmdn052 LIKE pmdn_t.pmdn052, #检验否
       pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
       pmdn200 LIKE pmdn_t.pmdn200, #商品条码
       pmdn201 LIKE pmdn_t.pmdn201, #包装单位
       pmdn202 LIKE pmdn_t.pmdn202, #包装数量
       pmdn203 LIKE pmdn_t.pmdn203, #收货部门
       pmdn204 LIKE pmdn_t.pmdn204, #No Use
       pmdn205 LIKE pmdn_t.pmdn205, #要货组织
       pmdn206 LIKE pmdn_t.pmdn206, #库存量
       pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
       pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
       pmdn209 LIKE pmdn_t.pmdn209, #上月销量
       pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
       pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
       pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
       pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
       pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
       pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
       pmdn216 LIKE pmdn_t.pmdn216, #经营方式
       pmdn217 LIKE pmdn_t.pmdn217, #结算方式
       pmdn218 LIKE pmdn_t.pmdn218, #合同编号
       pmdn219 LIKE pmdn_t.pmdn219, #协议编号
       pmdn220 LIKE pmdn_t.pmdn220, #采购人员
       pmdn221 LIKE pmdn_t.pmdn221, #采购部门
       pmdn222 LIKE pmdn_t.pmdn222, #采购中心
       pmdn223 LIKE pmdn_t.pmdn223, #配送中心
       pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
       pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
       pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
       pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
       pmdn054 LIKE pmdn_t.pmdn054, #还料数量
       pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
       pmdn056 LIKE pmdn_t.pmdn056, #还价数量
       pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
       pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
       pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
       pmdn058 LIKE pmdn_t.pmdn058, #预算科目
       pmdn228 LIKE pmdn_t.pmdn228  #商品品类
END RECORD
#161124-00048#9 mod-E
DEFINE l_success       LIKE type_t.num5
DEFINE l_pmdo027       DATETIME YEAR TO SECOND
#161124-00048#9 mod-S
#DEFINE l_pmdo          RECORD LIKE pmdo_t.*
DEFINE l_pmdo RECORD  #採購交期明細檔
       pmdoent LIKE pmdo_t.pmdoent, #企业编号
       pmdosite LIKE pmdo_t.pmdosite, #营运据点
       pmdodocno LIKE pmdo_t.pmdodocno, #采购单号
       pmdoseq LIKE pmdo_t.pmdoseq, #采购项次
       pmdoseq1 LIKE pmdo_t.pmdoseq1, #项序
       pmdoseq2 LIKE pmdo_t.pmdoseq2, #分批序
       pmdo001 LIKE pmdo_t.pmdo001, #料件编号
       pmdo002 LIKE pmdo_t.pmdo002, #产品特征
       pmdo003 LIKE pmdo_t.pmdo003, #子件特性
       pmdo004 LIKE pmdo_t.pmdo004, #采购单位
       pmdo005 LIKE pmdo_t.pmdo005, #采购总数量
       pmdo006 LIKE pmdo_t.pmdo006, #分批采购数量
       pmdo007 LIKE pmdo_t.pmdo007, #折合主件数量
       pmdo008 LIKE pmdo_t.pmdo008, #QPA
       pmdo009 LIKE pmdo_t.pmdo009, #交期类型
       pmdo010 LIKE pmdo_t.pmdo010, #收货时段
       pmdo011 LIKE pmdo_t.pmdo011, #出货日期
       pmdo012 LIKE pmdo_t.pmdo012, #到厂日期
       pmdo013 LIKE pmdo_t.pmdo013, #到库日期
       pmdo014 LIKE pmdo_t.pmdo014, #MRP交期冻结
       pmdo015 LIKE pmdo_t.pmdo015, #已收货量
       pmdo016 LIKE pmdo_t.pmdo016, #验退量
       pmdo017 LIKE pmdo_t.pmdo017, #仓退换货量
       pmdo019 LIKE pmdo_t.pmdo019, #已入库量
       pmdo020 LIKE pmdo_t.pmdo020, #VMI请款量
       pmdo021 LIKE pmdo_t.pmdo021, #交货状态
       pmdo022 LIKE pmdo_t.pmdo022, #参考价格
       pmdo023 LIKE pmdo_t.pmdo023, #税种
       pmdo024 LIKE pmdo_t.pmdo024, #税率
       pmdo025 LIKE pmdo_t.pmdo025, #电子采购单号
       pmdo026 LIKE pmdo_t.pmdo026, #最近更改人员
       pmdo027 LIKE pmdo_t.pmdo027, #最近更改时间
       pmdo028 LIKE pmdo_t.pmdo028, #分批参考单位
       pmdo029 LIKE pmdo_t.pmdo029, #分批参考数量
       pmdo030 LIKE pmdo_t.pmdo030, #分批计价单位
       pmdo031 LIKE pmdo_t.pmdo031, #分批计价数量
       pmdo032 LIKE pmdo_t.pmdo032, #分批税前金额
       pmdo033 LIKE pmdo_t.pmdo033, #分批含税金额
       pmdo034 LIKE pmdo_t.pmdo034, #分批税额
       pmdo035 LIKE pmdo_t.pmdo035, #初始营运据点
       pmdo036 LIKE pmdo_t.pmdo036, #初始来源单号
       pmdo037 LIKE pmdo_t.pmdo037, #初始来源项次
       pmdo038 LIKE pmdo_t.pmdo038, #初始项序
       pmdo039 LIKE pmdo_t.pmdo039, #初始分批序
       pmdo040 LIKE pmdo_t.pmdo040, #仓退量
       pmdo200 LIKE pmdo_t.pmdo200, #分批包装单位
       pmdo201 LIKE pmdo_t.pmdo201, #分批包装数量
       pmdo900 LIKE pmdo_t.pmdo900, #保留字段str
       pmdo999 LIKE pmdo_t.pmdo999, #保留字段end
       pmdo041 LIKE pmdo_t.pmdo041, #还料数量
       pmdo042 LIKE pmdo_t.pmdo042, #还量参考数量
       pmdo043 LIKE pmdo_t.pmdo043, #还价数量
       pmdo044 LIKE pmdo_t.pmdo044  #还价参考数量
END RECORD
#161124-00048#9 mod-S
DEFINE l_xrcd113       LIKE xrcd_t.xrcd113
DEFINE l_xrcd114       LIKE xrcd_t.xrcd114
DEFINE l_xrcd115       LIKE xrcd_t.xrcd115
DEFINE l_pmdo032       LIKE pmdo_t.pmdo032
DEFINE l_pmdo033       LIKE pmdo_t.pmdo033
DEFINE l_pmdo034       LIKE pmdo_t.pmdo034
DEFINE l_pmdoseq1      LIKE pmdo_t.pmdoseq1
DEFINE l_pmdoseq2      LIKE pmdo_t.pmdoseq2
DEFINE l_count_1       LIKE type_t.num10    #170113-00021#1
DEFINE l_cnt           LIKE type_t.num10    #170113-00021#1

   IF g_pmdl_m.pmdldocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF
   
   CALL s_tax_recount_tmp()  #161212-00022#1 add
   CALL s_transaction_begin()

   LET l_forupd_sql = " SELECT pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004, ",
                      " pmdl003,pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009, ",
                      " pmdl010,pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018, ",
                      " pmdl019,pmdl023,pmdl043,pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029, ",
                      " pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl040, ",
                      " pmdl041,pmdl042,pmdl047,pmdl048,pmdl049,pmdl046,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp, ",
                      " pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt", 
                      " FROM pmdl_t",
                      " WHERE pmdlent= ? AND pmdldocno=? FOR UPDATE"

   LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)                #轉換不同資料庫語法
   DECLARE apmt500_cl3 CURSOR FROM l_forupd_sql    
   OPEN apmt500_cl3 USING g_enterprise,g_pmdl_m.pmdldocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt500_cl3:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt500_cl3
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改的資料
   FETCH apmt500_cl3 INTO g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt, 
       g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,
       g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027, 
       g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,
       g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,
       g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,
       g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl046,g_pmdl_m.pmdlownid,
       g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt, 
       g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_pmdl_m.pmdldocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE apmt500_cl3
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   DISPLAY BY NAME g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl043,g_pmdl_m.pmdl044,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.pmdl029,g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl023,g_pmdl_m.pmdl024,g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042
   
   CALL apmt500_show() 
   #161124-00048#9 mod-S
#   DECLARE get_price_cs CURSOR FOR
#       SELECT * FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
   DECLARE get_price_cs CURSOR FOR
       SELECT pmdnent,pmdnsite,pmdnunit,pmdndocno,pmdnseq,
              pmdn001,pmdn002,pmdn003,pmdn004,pmdn005,
              pmdn006,pmdn007,pmdn008,pmdn009,pmdn010,
              pmdn011,pmdn012,pmdn013,pmdn014,pmdn015,
              pmdn016,pmdn017,pmdn019,pmdn020,pmdn021,
              pmdn022,pmdnorga,pmdn023,pmdn024,pmdn025,
              pmdn026,pmdn027,pmdn028,pmdn029,pmdn030,
              pmdn031,pmdn032,pmdn033,pmdn034,pmdn035,
              pmdn036,pmdn037,pmdn038,pmdn039,pmdn040,
              pmdn041,pmdn042,pmdn043,pmdn044,pmdn045,
              pmdn046,pmdn047,pmdn048,pmdn049,pmdn050,
              pmdn051,pmdn052,pmdn053,pmdn200,pmdn201,
              pmdn202,pmdn203,pmdn204,pmdn205,pmdn206,
              pmdn207,pmdn208,pmdn209,pmdn210,pmdn211,
              pmdn212,pmdn213,pmdn214,pmdn215,pmdn216,
              pmdn217,pmdn218,pmdn219,pmdn220,pmdn221,
              pmdn222,pmdn223,pmdn224,pmdn900,pmdn999,
              pmdn225,pmdn054,pmdn055,pmdn056,pmdn057,
              pmdn226,pmdn227,pmdn058,pmdn228
         FROM pmdn_t 
        WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
   #161124-00048#9 mod-E
   
   LET l_pmdo027 = cl_get_current()
   
   
   CALL cl_err_collect_init()
   
   FOREACH get_price_cs INTO l_pmdn.*
   
      CALL s_apmt500_get_price(g_pmdl_m.pmdl017,g_pmdl_m.pmdl004,l_pmdn.pmdn001,l_pmdn.pmdn002,g_pmdl_m.pmdl015,
                               l_pmdn.pmdn016,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl023,g_pmdl_m.pmdldocno,
                               g_pmdl_m.pmdldocdt,l_pmdn.pmdn010,l_pmdn.pmdn011,g_site,g_pmdl_m.pmdl054,g_type,l_pmdn.pmdn004,l_pmdn.pmdn005)
            RETURNING l_pmdn.pmdn040,l_pmdn.pmdn043,l_pmdn.pmdn041,l_pmdn.pmdn042
      
      LET l_pmdn.pmdn015 = l_pmdn.pmdn043


      #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
      CALL s_apmt500_get_amount(g_pmdl_m.pmdldocno,l_pmdn.pmdnseq,g_pmdl_m.pmdl015,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016)
            RETURNING l_pmdn.pmdn046,l_pmdn.pmdn048,l_pmdn.pmdn047
          
      UPDATE pmdn_t SET pmdn015 = l_pmdn.pmdn015,
                        pmdn040 = l_pmdn.pmdn040,
                        pmdn041 = l_pmdn.pmdn041,
                        pmdn042 = l_pmdn.pmdn042,
                        pmdn043 = l_pmdn.pmdn043,
                        pmdn044 = 0,
                        pmdn046 = l_pmdn.pmdn046,
                        pmdn047 = l_pmdn.pmdn047,
                        pmdn048 = l_pmdn.pmdn048
       WHERE pmdnent = g_enterprise 
         AND pmdndocno = g_pmdl_m.pmdldocno
         AND pmdnseq = l_pmdn.pmdnseq  
        #更新交期明細資料
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "pmdn_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
      
      END IF   
      #161124-00048#9 mod-S
#      DECLARE upd_pmdo_cs CURSOR FOR
#         SELECT * FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq
      DECLARE upd_pmdo_cs CURSOR FOR
         SELECT pmdoent,pmdosite,pmdodocno,pmdoseq,pmdoseq1,
                pmdoseq2,pmdo001,pmdo002,pmdo003,pmdo004,
                pmdo005,pmdo006,pmdo007,pmdo008,pmdo009,
                pmdo010,pmdo011,pmdo012,pmdo013,pmdo014,
                pmdo015,pmdo016,pmdo017,pmdo019,pmdo020,
                pmdo021,pmdo022,pmdo023,pmdo024,pmdo025,
                pmdo026,pmdo027,pmdo028,pmdo029,pmdo030,
                pmdo031,pmdo032,pmdo033,pmdo034,pmdo035,
                pmdo036,pmdo037,pmdo038,pmdo039,pmdo040,
                pmdo200,pmdo201,pmdo900,pmdo999,pmdo041,
                pmdo042,pmdo043,pmdo044 
           FROM pmdo_t 
          WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq
      #161124-00048#9 mod-E

      FOREACH upd_pmdo_cs INTO l_pmdo.*
          #參考價格
          LET l_pmdo.pmdo022 = l_pmdn.pmdn015
          
          #計算金額 分批數量/總數量 * 金額
          LET l_pmdo.pmdo032 = l_pmdo.pmdo006 / l_pmdo.pmdo005 * l_pmdn.pmdn046  #分批未稅金額
          LET l_pmdo.pmdo033 = l_pmdo.pmdo006 / l_pmdo.pmdo005 * l_pmdn.pmdn047  #分批含稅金額
          LET l_pmdo.pmdo034 = l_pmdo.pmdo006 / l_pmdo.pmdo005 * l_pmdn.pmdn048  #分批稅金額
          
          UPDATE pmdo_t SET pmdo022 = l_pmdo.pmdo022,
                            pmdo032 = l_pmdo.pmdo032,
                            pmdo033 = l_pmdo.pmdo033,
                            pmdo034 = l_pmdo.pmdo034,
                            pmdo026 = g_user,
                            pmdo027 = l_pmdo027
            WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq 
              AND pmdoseq1 = l_pmdo.pmdoseq1 AND pmdoseq2 = l_pmdo.pmdoseq2
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "pmdo_t"
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF     
      END FOREACH
      
      #計算尾差,加在最小项次的上面
      SELECT SUM(pmdo032),SUM(pmdo033),SUM(pmdo034) INTO l_pmdo032,l_pmdo033,l_pmdo034
         FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq AND pmdo003 <> '6' 
      IF l_pmdo032 <> l_pmdn.pmdn046 OR l_pmdo033 <> l_pmdn.pmdn047 OR l_pmdo034 <> l_pmdn.pmdn048 THEN
         SELECT MIN(pmdoseq1) INTO l_pmdoseq1 FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq
         SELECT MIN(pmdoseq2) INTO l_pmdoseq2 FROM pmdo_t 
            WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq AND pmdoseq1 = l_pmdoseq1
         
         UPDATE pmdo_t SET pmdo032 = pmdo032 + (l_pmdn.pmdn046 - l_pmdo032),
                           pmdo033 = pmdo033 + (l_pmdn.pmdn047 - l_pmdo033),
                           pmdo034 = pmdo034 + (l_pmdn.pmdn048 - l_pmdo034)
            WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdl_m.pmdldocno AND pmdoseq = l_pmdn.pmdnseq 
              AND pmdoseq1 = l_pmdoseq1 AND pmdoseq2 = l_pmdoseq2
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "pmdo_t"
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF     
      END IF
      
   END FOREACH
   
   #CALL s_tax_recount_tmp()  #161212-00022#1 mark
   #170113-00021#1---s
   #以下規則將不在呼叫 s_tax_recount 此函式重新計算金額
   #1.單身有不同稅別時
   #2.稅別有運用公式時(aooi610 公式編號不為空)
   LET l_count_1 = 0
   SELECT COUNT(UNIQUE pmdn016) INTO l_count_1 FROM pmdn_t
     WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
   LET l_cnt = 0
   SELECT COUNT(oodb002) INTO l_cnt FROM oodb_t,pmdn_t,ooef_t
     WHERE ooefent = oodbent AND ooef001 = g_site AND ooef019 = oodb001
       AND oodbent = g_enterprise AND oodb002 = pmdn016
       AND pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
       AND oodb007 IS NOT NULL
   IF l_count_1 > 1 OR l_cnt > 0 THEN
      SELECT SUM(pmdn046),SUM(pmdn047),SUM(pmdn048) INTO g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042
         FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdl_m.pmdldocno
      IF cl_null(g_pmdl_m.pmdl040) THEN LET g_pmdl_m.pmdl040 = 0 END IF
      IF cl_null(g_pmdl_m.pmdl041) THEN LET g_pmdl_m.pmdl041 = 0 END IF
      IF cl_null(g_pmdl_m.pmdl042) THEN LET g_pmdl_m.pmdl042 = 0 END IF
   ELSE
   #170113-00021#1---e
      CALL s_tax_recount(g_pmdl_m.pmdldocno)
        RETURNING g_pmdl_m.pmdl040,g_pmdl_m.pmdl042,g_pmdl_m.pmdl041,l_xrcd113,l_xrcd114,l_xrcd115
   END IF  #170113-00021#1
   
   DISPLAY BY NAME g_pmdl_m.pmdl040,g_pmdl_m.pmdl042,g_pmdl_m.pmdl041
   UPDATE pmdl_t SET pmdl040 = g_pmdl_m.pmdl040,
                     pmdl042 = g_pmdl_m.pmdl042,
                     pmdl041 = g_pmdl_m.pmdl041
       WHERE pmdlent = g_enterprise AND pmdldocno = g_pmdl_m.pmdldocno
       
   CALL cl_err_collect_show()
  
   CALL s_transaction_end('Y','0')
   CLOSE apmt500_cl3
   
   CALL apmt500_b_fill() 
   
END FUNCTION

#收件人資訊、郵件信件主旨內容等
PRIVATE FUNCTION apmt500_maillist()
DEFINE ls_tmp       STRING
DEFINE li_result    LIKE type_t.num5
DEFINE ls_file      STRING
DEFINE lc_channel   base.Channel
DEFINE ls_text      STRING
DEFINE ls_path      STRING
DEFINE l_str        STRING
DEFINE l_gzzal001   LIKE gzzal_t.gzzal001
DEFINE l_pmaa027    LIKE pmaa_t.pmaa027
DEFINE l_oofc012    LIKE oofc_t.oofc012
DEFINE l_ooag002    LIKE ooag_t.ooag002
DEFINE l_pmdldocno  STRING
DEFINE ls_context   STRING
DEFINE l_cmd        STRING
DEFINE l_recipient  STRING   #收件者
DEFINE i            LIKE type_t.num5
   
   
   CALL g_schedule_d.clear() 
   
   #判斷據點參數是否使用mail功能(據點參數:S-BAS-0050)
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0050') = 'N' THEN
      RETURN
   END IF
   
   #信件暫存檔案路徑
   LET ls_file = "apmt500Mail_",FGL_GETPID() USING "<<<<<",".txt"
   LET ls_file = os.Path.join(FGL_GETENV("TEMPDIR"),ls_file)

   IF os.Path.exists(ls_file) THEN
      IF os.Path.delete(ls_file) THEN END IF
   END IF
   
   #作業
   LET l_gzzal001 = ''
   CASE g_argv[1]
      WHEN '1'
         LET l_gzzal001 = 'apmt501'
      WHEN '2'
         LET l_gzzal001 = 'apmt503'
      WHEN '3'
         LET l_gzzal001 = 'apmt500'
      WHEN '4'
         LET l_gzzal001 = 'apmt504'
      OTHERWISE EXIT CASE
   END CASE
   
   #作業名
   LET l_str = ''
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = l_gzzal001
   CALL ap_ref_array2(g_ref_fields,"SELECT gzzal003 FROM gzzal_t WHERE gzzal001=? AND gzzal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET l_str = '', g_rtn_fields[1] , ''
   
   LET l_pmdldocno = g_pmdl_m.pmdldocno
   
   #%1(%2)資料確認通知--單號：%3
   LET l_str = cl_getmsg_parm('apm-00965',g_lang,l_gzzal001 ||'|'|| l_str ||'|'|| l_pmdldocno)
   LET ls_text = ls_text ,"&ensp;&ensp;" ,l_str,"<br>"
   
   #信件檔案
   LET lc_channel = base.Channel.create()
   CALL lc_channel.openFile(ls_file CLIPPED, "w" )
   CALL lc_channel.setDelimiter("")
   CALL lc_channel.write(ls_text)
   CALL lc_channel.close()
   
   #信件主旨
   LET g_mail_subject = l_str,' ',g_today,' ',l_str
   
   #信件本文
   LET ls_context = cl_getmsg("apm-00966",g_lang) CLIPPED  #詳見附件
   LET g_mail_context = ls_context
   
   ##寄信人-必須要寫@後面的mail address
   #LET g_mail_sender = "top18@digiwin.biz:TOP18_Admin"
   
   #供應商聯絡對象識別碼
   SELECT pmaa027 INTO l_pmaa027 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmdl_m.pmdl004
   
   #採購人員聯絡對象識別碼
   SELECT ooag002 INTO l_ooag002 FROM ooag_t WHERE ooagent = g_enterprise AND ooag001 = g_pmdl_m.pmdl002

   #LET g_schedule_d[1].gzpe007 = "1"          #形式
   #LET g_schedule_d[1].gzpe004 = l_pmaa027    #聯絡對象識別碼
   #LET g_schedule_d[1].gzpe010 = "1"          #附件格式,1:PDF
   #
   #LET g_schedule_d[2].gzpe007 = "1"          #形式
   #LET g_schedule_d[2].gzpe004 = l_ooag002    #聯絡對象識別碼
   #LET g_schedule_d[2].gzpe010 = "1"          #附件格式,1:PDF
 
   LET i = 1
   

   DECLARE mail_send CURSOR FOR 
      SELECT oofc012 FROM oofc_t WHERE oofcent = g_enterprise AND ((oofc002 = l_pmaa027 AND oofc015 = 'Y' AND oofc008 = '4') OR (oofc002 = l_ooag002 AND oofc008 = '4'))
   FOREACH mail_send INTO l_oofc012
      IF SQLCA.sqlcode THEN
         EXIT FOREACH
      END IF
      
      IF cl_null(l_oofc012) THEN
         CONTINUE FOREACH
      END IF
      
      #LET g_schedule_d[i].gzpe005 = g_mail_subject #信件主旨
      #LET g_schedule_d[i].gzpe006 = g_mail_context #信件本文
      
      LET g_schedule_d[i].gzpe007 = "1"          #形式
      #LET g_schedule_d[i].gzpe004 = l_oofc012    #聯絡對象識別碼
      LET g_schedule_d[i].gzpe009 = l_oofc012    #E-mail Address
      LET g_schedule_d[i].gzpe010 = "1"          #附件格式,1:PDF
      LET g_schedule_d[i].gzpe003 = "Z"    #160222-00018#1 add
      
      LET i = i + 1
   END FOREACH
   

END FUNCTION

################################################################################
# Descriptions...: 科目預算的處理
# Memo...........:
# Usage..........: CALL apmt500_detail_abg(p_type)
#                  RETURNING r_success,r_errno,r_bgaf016,r_bgae001,r_bgae001_desc
# Input parameter: p_type         1.預算項目開窗
#                                 2.預算項目檢核
#                                 3.預算項目說明
#                                 4.檢核金額
# Return code....: r_success      TRUE/FALSE
#                : r_errno        錯誤訊息
#                : r_bgaf016      錯誤處理方式
#                : r_bgae001      預算項目
#                : r_bgae001_desc 說明
# Date & Author..: 2015/09/05 By ming
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_detail_abg(p_type)
   DEFINE p_type             LIKE type_t.chr10
   DEFINE r_success          LIKE type_t.num5            #true/false  
   DEFINE r_errno            LIKE gzze_t.gzze001         #錯誤訊息  
   DEFINE r_bgaf016          LIKE bgaf_t.bgaf016         #錯誤處理方式  
   DEFINE r_bgae001          LIKE bgae_t.bgae001         #預算項目  
   DEFINE r_bgae001_desc     LIKE type_t.chr80           #說明  
   DEFINE r_bgae001_desc_sql STRING
   DEFINE l_success          LIKE type_t.num5
   DEFINE l_slip             LIKE pmda_t.pmdadocno
   DEFINE l_imaa009          LIKE imaa_t.imaa009
   DEFINE l_tran             RECORD
                                act              LIKE type_t.chr10,   #[1].chr 動作
                                site             LIKE ooef_t.ooef001, #[2].chr 預算組織
                                dat              LIKE type_t.dat,     #[3].dat 日期
                                bgae001          LIKE bgae_t.bgae001, #[4].chr 預算項目
                                bgbd013          LIKE bgbd_t.bgbd013, #[5].chr 部門
                                bgbd014          LIKE bgbd_t.bgbd014, #[6].chr 利潤成本中心
                                bgbd015          LIKE bgbd_t.bgbd015, #[7].chr 區域
                                bgbd016          LIKE bgbd_t.bgbd016, #[8].chr 交易客商
                                bgbd017          LIKE bgbd_t.bgbd017, #[9].chr 收款客商
                                bgbd018          LIKE bgbd_t.bgbd018, #[10].chr 客群
                                bgbd019          LIKE bgbd_t.bgbd019, #[11].chr 產品類別
                                bgbd020          LIKE bgbd_t.bgbd020, #[12].chr 人員
                                bgbd021          LIKE bgbd_t.bgbd021, #[13].chr 專案
                                bgbd022          LIKE bgbd_t.bgbd022, #[14].chr WBS
                                bgbd023          LIKE bgbd_t.bgbd023, #[15].chr 經營方式
                                bgbd024          LIKE bgbd_t.bgbd024, #[16].chr 自由核算項一
                                bgbd025          LIKE bgbd_t.bgbd025, #[17].chr 自由核算項二
                                bgbd026          LIKE bgbd_t.bgbd026, #[18].chr 自由核算項三 
                                bgbd027          LIKE bgbd_t.bgbd027, #[19].chr 自由核算項四
                                bgbd028          LIKE bgbd_t.bgbd028, #[20].chr 自由核算項五
                                bgbd029          LIKE bgbd_t.bgbd029, #[21].chr 自由核算項六
                                bgbd030          LIKE bgbd_t.bgbd030, #[22].chr 自由核算項七
                                bgbd031          LIKE bgbd_t.bgbd031, #[23].chr 自由核算項八
                                bgbd032          LIKE bgbd_t.bgbd032, #[24].chr 自由核算項九
                                bgbd033          LIKE bgbd_t.bgbd033, #[25].chr 自由核算項十 
                                bgbd042          LIKE bgbd_t.bgbd042, #[26].chr 渠道
                                bgbd043          LIKE bgbd_t.bgbd043, #[27].chr 品牌
                                used036          LIKE bgbd_t.bgbd036, #[28].chr 使用程式
                                used037          LIKE bgbd_t.bgbd037, #[29].chr 使用單號 
                                used038          LIKE bgbd_t.bgbd038, #[30].chr 使用項次
                                sour036          LIKE bgbd_t.bgbd036, #[31].chr 轉出程式
                                sour037          LIKE bgbd_t.bgbd037, #[32].chr 轉出單號
                                sour038          LIKE bgbd_t.bgbd038, #[33].chr 轉出項次
                                curr             LIKE ooai_t.ooai001, #[34].chr 幣別
                                account          LIKE type_t.num20_6 #[35].chr 金額
                             END RECORD
   DEFINE ls_js              STRING

   LET r_success          = TRUE
   LET r_errno            = ''
   LET r_bgaf016          = ''
   LET r_bgae001          = ''
   LET r_bgae001_desc     = '' 
   LET r_bgae001_desc_sql = ''

   CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno)
        RETURNING l_success,l_slip

   IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'N' THEN
      RETURN r_success,r_errno,r_bgaf016,
             r_bgae001,r_bgae001_desc,r_bgae001_desc_sql
   END IF
   
   #add by lixiang 2015/12/17---begin---
   #當傳入類型的金額檢核時，但預算科目為空，則無需進行檢核，否則會出現畫面上預算科目為空，修改數量時卻一直報錯，無法繼續報錯
   IF p_type = '4' AND cl_null(g_pmdn2_d[l_ac].pmdn058) THEN
       RETURN r_success,r_errno,r_bgaf016,
             r_bgae001,r_bgae001_desc,r_bgae001_desc_sql
   END IF
   #add by lixiang 2015/12/17---end-----

   LET l_imaa009 = ''
   SELECT imaa009 INTO l_imaa009
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdn_d[l_ac].pmdn001

   INITIALIZE l_tran.* TO NULL
   LET l_tran.site = g_site
   LET l_tran.dat  = g_pmdl_m.pmdldocdt

   LET l_tran.bgae001 = g_pmdn2_d[l_ac].pmdn058

   LET l_tran.bgbd013 = g_pmdl_m.pmdl003
   LET l_tran.bgbd016 = g_pmdn_d[l_ac].pmdn023
   LET l_tran.bgbd019 = l_imaa009
   LET l_tran.bgbd020 = g_pmdl_m.pmdl002
   LET l_tran.bgbd021 = g_pmdn2_d[l_ac].pmdn036
   LET l_tran.bgbd022 = g_pmdn2_d[l_ac].pmdn037
   LET l_tran.used036 = 'apmt500'
   LET l_tran.used037 = g_pmdl_m.pmdldocno 
   LET l_tran.used038 = g_pmdn2_d[l_ac].pmdnseq
   LET l_tran.curr    = g_pmdl_m.pmdl015
   LET l_tran.account = g_pmdn_d[l_ac].pmdn046

   LET ls_js = util.JSON.stringify(l_tran)

   CASE p_type
      WHEN '1'
         CALL s_abg_bgae001_query2(ls_js)
              RETURNING r_bgae001

         LET l_tran.bgae001 = r_bgae001
         LET ls_js = util.JSON.stringify(l_tran)
         CALL s_abg_bgae001_desc2(ls_js)
              RETURNING r_bgae001_desc
      WHEN '2'
         CALL s_abg_bgae001_chk2(ls_js)
              RETURNING r_success,r_errno
         IF r_success THEN
            CALL s_abg_bgae001_desc2(ls_js)
                 RETURNING r_bgae001_desc
         END IF
      WHEN '3' 
         CALL s_abg_bgae001_desc2(ls_js)
              RETURNING r_bgae001_desc
      WHEN '4'
         CALL s_abg_bg_used_chk(ls_js)
              RETURNING r_success,r_errno,r_bgaf016
      WHEN '5'
         CALL s_abg_bgae001_desc2_sql(ls_js)
              RETURNING r_bgae001_desc_sql
   END CASE

   RETURN r_success,r_errno,r_bgaf016,r_bgae001,r_bgae001_desc,r_bgae001_desc_sql
   
END FUNCTION

################################################################################
# Descriptions...: 來源為訂單時，數量不可大於訂購量
# Memo...........:
# Usage..........: CALL apmt500_order_chk()
#                  RETURNING r_success
# Input parameter:
# Return code....: r_success
# Date & Author..: 151210-00002#1 151221 By Polly
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_order_chk()
DEFINE l_pmdp003 LIKE pmdp_t.pmdp003
DEFINE l_pmdp004 LIKE pmdp_t.pmdp004
DEFINE l_xmdc007 LIKE xmdc_t.xmdc007
DEFINE l_pmdp023 LIKE pmdp_t.pmdp023
DEFINE r_success LIKE type_t.num5


  LET r_success = TRUE
  
  SELECT DISTINCT pmdp003,pmdp004
    INTO l_pmdp003,l_pmdp004
   FROM pmdp_t
  WHERE pmdpent = g_enterprise
    AND pmdpdocno = g_pmdl_m.pmdldocno
    AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
  
  IF cl_null(l_pmdp003) OR cl_null(l_pmdp004) THEN
     INITIALIZE g_errparam TO NULL
     LET g_errparam.code = 'sub-00344'
     LET g_errparam.extend = g_pmdl_m.pmdldocno
     LET g_errparam.popup = TRUE
     CALL cl_err()        
     LET r_success = FALSE
     RETURN r_success
  END IF   
  
  LET l_xmdc007 = 0    
  SELECT xmdc007 INTO l_xmdc007
    FROM xmdc_t
   WHERE xmdcent = g_enterprise
     AND xmdcdocno = l_pmdp003
     AND xmdcseq = l_pmdp004
  IF cl_null(l_xmdc007) THEN LET l_xmdc007 = 0 END IF
  
  LET l_pmdp023 = 0
  SELECT SUM(pmdp023) INTO l_pmdp023
    FROM pmdl_t,pmdn_t,pmdp_t
   WHERE pmdlent = pmdnent AND pmdldocno = pmdndocno
     AND pmdnent = pmdpent AND pmdndocno = pmdpdocno AND pmdnseq = pmdpseq
     AND pmdlstus <> 'X'
     AND (pmdndocno <> g_pmdl_m.pmdldocno AND pmdnseq = g_pmdn_d[l_ac].pmdnseq)
     AND pmdp003 = l_pmdp003 AND pmdp004 = l_pmdp004
  
  IF cl_null(l_pmdp023) THEN LET l_pmdp023 = 0 END IF
  
  IF l_pmdp023 + g_pmdn_d[l_ac].pmdn007 > l_xmdc007 THEN
     INITIALIZE g_errparam TO NULL
     LET g_errparam.code = 'apm-01056'
     LET g_errparam.extend = g_pmdl_m.pmdldocno
     LET g_errparam.popup = TRUE
     CALL cl_err()        
     LET r_success = FALSE
     RETURN r_success  
  END IF
  RETURN r_success  
END FUNCTION

################################################################################
# Descriptions...: 來源為訂單時，更新來源需求數量
# Memo...........:
# Usage..........: CALL apmt500_order_upd()
#                  RETURNING r_success
# Input parameter:
# Return code....: r_success
# Date & Author..: 151210-00002#1 151221 By Polly
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_order_upd()
DEFINE l_pmdp022   LIKE pmdp_t.pmdp022
DEFINE l_pmdp023   LIKE pmdp_t.pmdp023
DEFINE l_pmdp023_1 LIKE type_t.num5
DEFINE l_pmdpseq1  LIKE pmdp_t.pmdpseq1
DEFINE l_cnt       LIKE type_t.num5
DEFINE l_i         LIKE type_t.num5
DEFINE l_success   LIKE type_t.num5

      LET l_pmdp023 = 0
      SELECT DISTINCT pmdp022 INTO l_pmdp022
        FROM pmdp_t
       WHERE pmdpent = g_enterprise
         AND pmdpdocno = g_pmdl_m.pmdldocno
         AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
      IF l_pmdp022 <> g_pmdn_d[l_ac].pmdn006 THEN
         #將採購數量轉換成需求數量
         CALL s_aooi250_convert_qty(g_pmdn_d[l_ac].pmdn001,g_pmdn_d[l_ac].pmdn006,l_pmdp022,g_pmdn_d[l_ac].pmdn007)
           RETURNING l_success,l_pmdp023
      ELSE 
          LET l_pmdp023 = g_pmdn_d[l_ac].pmdn007     
      END IF
      LET l_cnt = 0
      SELECT COUNT(1) INTO l_cnt
        FROM pmdp_t
       WHERE pmdpent = g_enterprise
         AND pmdpdocno = g_pmdl_m.pmdldocno
         AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt = 1 THEN
         UPDATE pmdp_t SET pmdp023 = l_pmdp023,
                           pmdp024 = l_pmdp023         
          WHERE pmdpent = g_enterprise 
            AND pmdpdocno = g_pmdl_m.pmdldocno 
            AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
      ELSE
         LET l_i = 1
         LET l_pmdp023_1 = l_pmdp023 / l_cnt
         DECLARE apmt500_order_c1 CURSOR FOR
           SELECT pmdpseq1 FROM pmdp_t
          WHERE pmdpent = g_enterprise 
            AND pmdpdocno = g_pmdl_m.pmdldocno 
            AND pmdpseq = g_pmdn_d[l_ac].pmdnseq           
         FOREACH apmt500_order_c1 INTO l_pmdpseq1
            IF l_i = l_cnt THEN
               LET l_pmdp023_1 = l_pmdp023
            END IF
            UPDATE pmdp_t SET pmdp023 = l_pmdp023_1,
                              pmdp024 = l_pmdp023_1            
             WHERE pmdpent = g_enterprise 
               AND pmdpdocno = g_pmdl_m.pmdldocno 
               AND pmdpseq = g_pmdn_d[l_ac].pmdnseq
               AND pmdpseq1 = l_pmdpseq1               
            LET l_pmdp023 = l_pmdp023 - l_pmdp023_1
            LET l_i = l_i + 1            
         END FOREACH         
      END IF

END FUNCTION

################################################################################
# Descriptions...: 是否為流水號一致之多角單據
# Memo...........:
# Usage..........: CALL axmt500_icac010_control()
#                  RETURNING r_success
# Input parameter: 
#                : 
# Return code....: TRUE,FALSE
#                : 
# Date & Author..: 151210-00009#1  2015/12/30 By earl
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_icac010_control()
   DEFINE r_success      LIKE type_t.num5
   DEFINE l_slip         LIKE oobal_t.oobal002
   DEFINE l_success      LIKE type_t.num5
   DEFINE l_cnt          LIKE type_t.num10
   
   LET r_success = FALSE  #不控卡
   
   IF g_aic_doc THEN
      IF NOT cl_null(g_pmdl_m.pmdldocno) THEN
         CALL s_aooi200_get_slip(g_pmdl_m.pmdldocno) RETURNING l_success,l_slip
         
         IF l_success THEN
            LET l_cnt = 0
            SELECT COUNT(1) INTO l_cnt
              FROM icab_t,icac_t
             WHERE icabent = icacent AND icacent = g_enterprise
               AND icab001 = icac001
               AND icab002 = icac002
               AND icab003 = g_site
               AND icac010 = l_slip
               
            IF l_cnt > 0 THEN
               LET r_success = TRUE  #控卡
            END IF
         END IF
         
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 總含稅金額/未稅金額檢查
# Memo...........: 多帳期預付款金額加總不可超過整張採購單總採購金額(含未稅金額均不能超過)
# Usage..........: CALL apmt500_pmdm005_pmdm006_total_chk()
#                  RETURNING r_success
# Input parameter: 
# Return code....: 
# Date & Author..: 2016/07/04 By dorislai(#160520-00026#2)
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_pmdm005_pmdm006_total_chk()
   DEFINE l_pmdm005  LIKE pmdm_t.pmdm005
   DEFINE l_pmdm006  LIKE pmdm_t.pmdm006
   DEFINE r_success  LIKE type_t.num5
   
   LET r_success = TRUE
   
   #多帳期預付款金額加總不可超過整張採購單總採購金額(含未稅金額均不能超過)
   LET l_pmdm005 = 0
   LET l_pmdm006 = 0
   SELECT SUM(pmdm005),SUM(pmdm006) INTO l_pmdm005,l_pmdm006 
     FROM pmdm_t 
      WHERE pmdment = g_enterprise AND pmdmdocno = g_pmdl_m.pmdldocno
      
   #含稅時，比較整張單據的含稅金額，未稅時，比較未稅總金額
   IF g_pmdl_m.pmdl013 = 'Y' THEN 
      #整張含稅金額<>總含稅金額
      IF l_pmdm006 <> g_pmdl_m.pmdl041 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00588'  #多期預付款含稅總金額需與整張採購單含稅總金額一致！
         LET g_errparam.extend = g_pmdl_m.pmdldocno
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_pmdn6_d[l_ac].pmdm006 = g_pmdn6_d_t.pmdm006
         LET r_success = FALSE
      END IF
   #170111-00065#1-s
   #ELSE
   #   #整張未稅金額<>總未稅金額
   #   IF l_pmdm005 <> g_pmdl_m.pmdl040 THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = 'apm-00587'  #多期預付款未稅總金額需與整張採購單未稅總金額一致！
   #      LET g_errparam.extend = g_pmdl_m.pmdldocno
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #      LET g_pmdn6_d[l_ac].pmdm005 = g_pmdn6_d_t.pmdm005
   #      LET r_success = FALSE
   #   END IF
   #170111-00065#1-e
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 重新計算含稅金額、未稅金額
# Memo...........: 1.預收款發票開立方式="1.不開發票"
#                : 1-1.帳款類型='2.訂金'，含稅的單：未稅=含稅；未稅同之
#                             <>'2.訂金'，自行計算各自的含稅/未稅
# Usage..........: CALL apmt500_pmdm005_pmdm006_upd()
#                  RETURNING r_success
# Input parameter: 
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 2016/07/04 By dorislai(#160520-00026#2)
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_pmdm005_pmdm006_upd()
   DEFINE  l_sql      STRING
   DEFINE  r_success  LIKE type_t.num5
   DEFINE  l_xrcd103  LIKE xrcd_t.xrcd103
   DEFINE  l_xrcd104  LIKE xrcd_t.xrcd104
   DEFINE  l_xrcd105  LIKE xrcd_t.xrcd105
   DEFINE  l_xrcd113  LIKE xrcd_t.xrcd113
   DEFINE  l_xrcd114  LIKE xrcd_t.xrcd114
   DEFINE  l_xrcd115  LIKE xrcd_t.xrcd115
   DEFINE  l_pmdm     RECORD
                      pmdm001 LIKE pmdm_t.pmdm001,
                      pmdm014 LIKE pmdm_t.pmdm014,
                      pmdm005 LIKE pmdm_t.pmdm005,
                      pmdm006 LIKE pmdm_t.pmdm006
                      END RECORD
  
   LET r_success = TRUE 
  
   LET l_sql = " SELECT pmdm001,pmdm014,pmdm005,pmdm006 ",
               "   FROM pmdm_t ",
               "  WHERE pmdment = '",g_enterprise,"'",
               "    AND pmdmdocno = '",g_pmdl_m.pmdldocno,"'"
   PREPARE apmt500_amount_pre FROM l_sql
   DECLARE apmt500_amount_cur CURSOR FOR apmt500_amount_pre 
   
   INITIALIZE l_pmdm.* TO NULL
   FOREACH apmt500_amount_cur INTO l_pmdm.pmdm001,l_pmdm.pmdm014,l_pmdm.pmdm005,l_pmdm.pmdm006
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "Foreach:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #帳款類型 = '2'
      IF l_pmdm.pmdm014 = '2' THEN
         #含稅否
         IF g_pmdl_m.pmdl013 = 'Y' THEN
            LET l_pmdm.pmdm005 = l_pmdm.pmdm006 #未稅金額=含稅金額
         ELSE
            LET l_pmdm.pmdm006 = l_pmdm.pmdm005 #含稅金額=未稅金額
         END IF 
      ELSE
         #含稅否
         IF g_pmdl_m.pmdl013 = 'Y' THEN
            CALL s_tax_count(g_site,g_pmdl_m.pmdl011,l_pmdm.pmdm006,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
                   RETURNING l_pmdm.pmdm005,l_xrcd104,l_xrcd105,l_xrcd113,l_xrcd114,l_xrcd115
         ELSE
            CALL s_tax_count(g_site,g_pmdl_m.pmdl011,l_pmdm.pmdm005,0,g_pmdl_m.pmdl015,g_pmdl_m.pmdl016)
                   RETURNING l_xrcd103,l_xrcd104,l_pmdm.pmdm006,l_xrcd113,l_xrcd114,l_xrcd115
         END IF
      END IF
      #更新含稅、未稅的金額
      UPDATE pmdm_t 
         SET pmdm005 = l_pmdm.pmdm005,
             pmdm006 = l_pmdm.pmdm006
       WHERE pmdment = g_enterprise
         AND pmdmdocno = g_pmdl_m.pmdldocno
         AND pmdm001 = l_pmdm.pmdm001
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.extend = "UPDATE pmdm_t"
         LET g_errparam.popup  = TRUE
         CALL cl_err() 
         LET r_success = FALSE
         EXIT FOREACH
      END IF
   END FOREACH
  
   FREE apmt500_amount_pre
  
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 單價不含稅，調整含稅金額
# Memo...........: 結構：1.先算 含稅金額 總差額
#                :       2.抓取 MAX(含稅金額) AND 帳款類型<>'2'
#                :       2-1. 抓不到值 or MAX(含稅金額)+差額 < 0
#                :            則抓 MAX(含稅金額) AND 帳款類型='2'
#                :       3.更新含稅金額
# Usage..........: CALL apmt500_pmdm005_adjust(p_pmdm006)
#                  RETURNING r_success
# Input parameter: p_pmdm006      整張單總含稅金額
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 2016/07/04 By dorislai(#160520-00026#2)
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_pmdm005_adjust(p_pmdm006)
   DEFINE  p_pmdm006      LIKE pmdm_t.pmdm006
   DEFINE  r_success      LIKE type_t.num5
   DEFINE  l_pmdm001      LIKE pmdm_t.pmdm001
   DEFINE  l_pmdm006      LIKE pmdm_t.pmdm006
   DEFINE  l_amount       LIKE type_t.num20_6
   DEFINE  l_amount_diff  LIKE type_t.num20_6
   DEFINE  l_chk          LIKE type_t.num5
   DEFINE  l_msg          STRING
   
   LET l_pmdm001 = ''
   LET l_amount = 0
   LET l_amount_diff = 0
   LET l_chk = FALSE
   LET r_success = TRUE
   
   #含稅金額的差額 = 採購總含稅金額 - 整張單含稅金額
   LET l_amount_diff = g_pmdl_m.pmdl041 - p_pmdm006
   
   IF l_amount_diff <> 0 THEN
      #含稅金額(抓取最大一筆未稅金額+帳款類型<>'2')
      SELECT pmdm001,pmdm006,pmdm006 INTO l_pmdm001,l_pmdm006,l_amount
        FROM pmdm_t
       WHERE pmdment = g_enterprise
         AND pmdmdocno = g_pmdl_m.pmdldocno
         AND pmdm014 <> '2'
         AND pmdm006 = ( SELECT MAX(pmdm006 ) FROM pmdm_t
                          WHERE pmdment = g_enterprise
                            AND pmdmdocno = g_pmdl_m.pmdldocno
                            AND pmdm014 <> '2')
                            
                                              #加總過後的含稅金額，不可為負的
      IF cl_null(l_amount) OR l_amount = 0 OR (l_pmdm006+l_amount_diff) < 0 THEN
         #換抓最大一筆未稅金額+帳款類型='2'
         SELECT pmdm001,pmdm006 INTO l_pmdm001,l_amount
           FROM pmdm_t
          WHERE pmdment = g_enterprise
            AND pmdmdocno = g_pmdl_m.pmdldocno
            AND pmdm014 = '2'
            AND (pmdm006 + l_amount_diff) > 0 #加總過後的含稅金額，不可為負的
            AND pmdm006 = ( SELECT MAX(pmdm006 ) FROM pmdm_t
                             WHERE pmdment = g_enterprise
                               AND pmdmdocno = g_pmdl_m.pmdldocno
                               AND pmdm014 = '2')
         IF l_amount > 0 AND NOT cl_null(l_amount) THEN
            IF (l_pmdm006+l_amount_diff) < 0 THEN
               #帳款類型為非2.訂金，其金額不足額補稅額，稅額將全計入最大一筆訂金中，是否確認執行？
               LET l_msg = 'axm-00793' 
            ELSE
               #全為不開發票之訂金，稅額將全計入最大一筆訂金中，是否確認執行？
               LET l_msg = 'axm-00790'
            END IF
            IF cl_ask_confirm(l_msg) THEN  
               LET l_chk = TRUE
            END IF
         END IF
      ELSE
         IF (l_pmdm006+l_amount_diff) > 0 THEN
            LET l_chk = TRUE
         ELSE
            LET l_chk = FALSE
         END IF
      END IF
      
      #將差額補入含稅金額
      IF l_chk THEN
         UPDATE pmdm_t
            SET pmdm006 = pmdm006 + l_amount_diff
          WHERE pmdment = g_enterprise
            AND pmdmdocno = g_pmdl_m.pmdldocno
            AND pmdm001 = l_pmdm001
            AND pmdm006 = l_amount
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.extend = "UPDATE pmdm_t"
            LET g_errparam.popup  = FALSE
            CALL cl_err()     
            LET r_success = FALSE         
         END IF
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 單價含稅，調整未稅金額
# Memo...........: 結構：1.先算 未稅金額 總差額
#                :       2.抓取 MAX(未稅金額) AND 帳款類型<>'2'
#                :       2-1. 抓不到值 or MAX(未稅金額)+差額 < 0
#                :            則抓 MAX(未稅金額) AND 帳款類型='2'
#                :       3.更新未稅金額
# Usage..........: CALL apmt500_pmdm006_adjust(p_pmdm005)
#                  RETURNING r_success
# Input parameter: p_pmdm005      整張單總未稅金額
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 2016/07/04 By dorislai(#160520-00026#2)
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_pmdm006_adjust(p_pmdm005)
   DEFINE  p_pmdm005      LIKE pmdm_t.pmdm005
   DEFINE  r_success      LIKE type_t.num5
   DEFINE  l_pmdm001      LIKE pmdm_t.pmdm001
   DEFINE  l_pmdm005      LIKE pmdm_t.pmdm005
   DEFINE  l_amount       LIKE type_t.num20_6
   DEFINE  l_amount_diff  LIKE type_t.num20_6
   DEFINE  l_chk          LIKE type_t.num5
   DEFINE  l_msg          STRING
   
   LET l_pmdm001 = ''
   LET l_amount = 0
   LET l_amount_diff = 0
   LET l_chk = FALSE
   LET r_success = TRUE
   
   #未稅金額的差額 = 採購總未稅金額 - 整張單未稅金額
   LET l_amount_diff = g_pmdl_m.pmdl040 - p_pmdm005
   
   IF l_amount_diff <> 0 THEN
      #含稅金額(抓取最大一筆未稅金額+帳款類型<>'2')
      SELECT pmdm001,pmdm005,pmdm005 INTO l_pmdm001,l_pmdm005,l_amount
        FROM pmdm_t
       WHERE pmdment = g_enterprise
         AND pmdmdocno = g_pmdl_m.pmdldocno
         AND pmdm014 <> '2'
         AND pmdm005 = ( SELECT MAX(pmdm005) FROM pmdm_t
                          WHERE pmdment = g_enterprise
                            AND pmdmdocno = g_pmdl_m.pmdldocno
                            AND pmdm014 <> '2')
                            
                                             #加總過後的含稅金額，不可為負的
      IF cl_null(l_amount) OR l_amount = 0 OR (l_pmdm005+l_amount_diff) < 0 THEN
         #換抓最大一筆未稅金額+帳款類型='2'
         SELECT pmdm001,pmdm005 INTO l_pmdm001,l_amount
           FROM pmdm_t
          WHERE pmdment = g_enterprise
            AND pmdmdocno = g_pmdl_m.pmdldocno
            AND pmdm014 = '2'
            AND (pmdm005 + l_amount_diff) > 0 #加總過後的含稅金額，不可為負的
            AND pmdm005 = ( SELECT MAX(pmdm005) FROM pmdm_t
                             WHERE pmdment = g_enterprise
                               AND pmdmdocno = g_pmdl_m.pmdldocno
                               AND pmdm014 = '2')
         IF l_amount > 0 AND NOT cl_null(l_amount) THEN
            IF (l_pmdm005+l_amount_diff) < 0 THEN
               #帳款類型為非2.訂金，其金額不足額補稅額，稅額將全計入最大一筆訂金中，是否確認執行？
               LET l_msg = 'axm-00793' 
            ELSE
               #全為不開發票之訂金，稅額將全計入最大一筆訂金中，是否確認執行？
               LET l_msg = 'axm-00790'
            END IF
            IF cl_ask_confirm(l_msg) THEN  
               LET l_chk = TRUE
            END IF
         END IF
      ELSE
         IF (l_pmdm005+l_amount_diff) > 0 THEN
            LET l_chk = TRUE
         ELSE
            LET l_chk = FALSE
         END IF
      END IF
      
      #將差額補入未稅金額
      IF l_chk THEN
         UPDATE pmdm_t
            SET pmdm005 = pmdm005 + l_amount_diff
          WHERE pmdment = g_enterprise
            AND pmdmdocno = g_pmdl_m.pmdldocno
            AND pmdm001 = l_pmdm001
            AND pmdm005 = l_amount
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.extend = "UPDATE pmdm_t"
            LET g_errparam.popup  = FALSE
            CALL cl_err()     
            LET r_success = FALSE         
         END IF
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 調整金額尾差
# Memo...........:
# Usage..........: CALL apmt500_adjust_pmdn(p_xrcd103,p_xrcd104,p_xrcd105)
# Input parameter: p_xrcd103   原幣未稅金額
#                : p_xrcd104   原幣稅額
#                : p_xrcd105   原幣含稅金額
# Return code....: 
# Date & Author..: #160908-00010#1 By lixiang
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt500_adjust_pmdn(p_xrcd103,p_xrcd104,p_xrcd105)

   DEFINE l_pmdn046    LIKE pmdn_t.pmdn046
   DEFINE l_pmdn047    LIKE pmdn_t.pmdn047
   DEFINE l_pmdn048    LIKE pmdn_t.pmdn048
   DEFINE l_pmdnseq    LIKE pmdn_t.pmdnseq
   DEFINE p_xrcd103    LIKE xrcd_t.xrcd103
   DEFINE p_xrcd104    LIKE xrcd_t.xrcd104
   DEFINE p_xrcd105    LIKE xrcd_t.xrcd105
#161128-00011#1---mark---
#搬到s_apmt500元件中   
#   LET l_pmdn046 = 0
#   LET l_pmdn047 = 0
#   LET l_pmdn048 = 0
#   LET l_pmdnseq = ''
#   
#   #抓取出貨總金額(未稅、含稅、稅額)
#   SELECT SUM(pmdn046),SUM(pmdn047),SUM(pmdn048)
#     INTO l_pmdn046,l_pmdn047,l_pmdn048
#     FROM pmdn_t
#    WHERE pmdnent = g_enterprise
#      AND pmdnsite = g_site
#      AND pmdndocno = g_pmdl_m.pmdldocno
#      
#   #調整金額(未稅、含稅、稅額)
#   IF p_xrcd103 <> l_pmdn046 OR p_xrcd104 <> l_pmdn047 OR p_xrcd105 <> l_pmdn048 THEN
#      #抓取最大筆金額的項次
#      SELECT pmdnseq INTO l_pmdnseq
#        FROM pmdn_t
#       WHERE pmdnent = g_enterprise
#         AND pmdnsite = g_site
#         AND pmdndocno = g_pmdl_m.pmdldocno
#       ORDER BY pmdn046 DESC
#     #補尾差
#     UPDATE pmdn_t SET pmdn046 = pmdn046 + (p_xrcd103-l_pmdn046),
#                       pmdn047 = pmdn047 + (p_xrcd105-l_pmdn047),
#                       pmdn048 = pmdn048 + (p_xrcd104-l_pmdn048)
#       WHERE pmdnent = g_enterprise
#         AND pmdnsite = g_site
#         AND pmdndocno = g_pmdl_m.pmdldocno
#         AND pmdnseq = l_pmdnseq
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = "UPDATE pmdn_t"
#         LET g_errparam.popup = TRUE
#         CALL cl_err()         
#      END IF 
#   END IF
#161128-00011#1---mark---   
END FUNCTION

################################################################################
# Descriptions...: 自動推算多帳期含稅/未稅金額
# Memo...........:
# Usage..........: CALL apmt500_get_amt(p_pmdmdocno,p_pmdm001,p_pmdl040,p_pmdl041)
#                  RETURNING r_pmdm005,r_pmdm006
# Input parameter: p_pmdmdocno   單號
#                : p_pmdm001     期別
#                : p_pmdl040     總未稅金額
#                : p_pmdl041     總含稅金額
# Return code....: r_pmdm005     未稅金額
#                : r_pmdm006     含稅金額
# Date & Author..: 161012-00055#1 161018 By 02040
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt500_get_amt(p_pmdmdocno,p_pmdm001,p_pmdl040,p_pmdl041)
DEFINE p_pmdmdocno  LIKE pmdm_t.pmdmdocno
DEFINE p_pmdm001    LIKE pmdm_t.pmdm001
DEFINE p_pmdl040    LIKE pmdl_t.pmdl040
DEFINE p_pmdl041    LIKE pmdl_t.pmdl041
DEFINE l_pmdm005    LIKE pmdm_t.pmdm005
DEFINE l_pmdm006    LIKE pmdm_t.pmdm006
DEFINE r_pmdm005    LIKE pmdm_t.pmdm005
DEFINE r_pmdm006    LIKE pmdm_t.pmdm006


    LET r_pmdm005 = 0
    LET r_pmdm006 = 0
    IF cl_null(p_pmdmdocno) OR cl_null(p_pmdm001) OR cl_null(p_pmdl040) OR
       cl_null(p_pmdl041) THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = 'sub-00228'
       LET g_errparam.extend = ''
       LET g_errparam.popup = TRUE
       CALL cl_err()
       RETURN r_pmdm005,r_pmdm006
    END IF

   SELECT SUM(pmdm005),SUM(pmdm006)
     INTO l_pmdm005,l_pmdm006
     FROM pmdm_t
    WHERE pmdment = g_enterprise
      AND pmdmdocno = p_pmdmdocno
      AND pmdm001 <> p_pmdm001

   IF cl_null(l_pmdm005) THEN LET l_pmdm005 = 0 END IF
   IF cl_null(l_pmdm006) THEN LET l_pmdm006 = 0 END IF

   LET r_pmdm005 = p_pmdl040 - l_pmdm005
   LET r_pmdm006 = p_pmdl041 - l_pmdm006

   RETURN r_pmdm005,r_pmdm006


END FUNCTION

#161031-00025#1 add
#维护备注单身
PRIVATE FUNCTION apmt500_remaks()
DEFINE l_sql      STRING

   IF g_pmdl_m.pmdldocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   LET l_sql = " SELECT pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004,
                        pmdl003,pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009, 
                        pmdl010,pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018, 
                        pmdl019,pmdl023,pmdl043,pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029, 
                        pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,pmdl055,pmdl030,pmdl031,pmdl028,pmdl040, 
                        pmdl041,pmdl042,pmdl047,pmdl048,pmdl049,pmdl046,pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp, 
                        pmdlcrtdt,pmdlmodid,pmdlmoddt,pmdlcnfid,pmdlcnfdt", 
                      " FROM pmdl_t",
                      " WHERE pmdlent= ? AND pmdldocno=? FOR UPDATE"
   LET l_sql = cl_sql_forupd(l_sql)                #轉換不同資料庫語法
   LET l_sql = cl_sql_add_mask(l_sql)              #遮蔽特定資料
   DECLARE apmt500_ooff_cl CURSOR FROM l_sql
   
   CALL s_transaction_begin()
   
   OPEN apmt500_ooff_cl USING g_enterprise,g_pmdl_m.pmdldocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt500_ooff_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt500_ooff_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #鎖住將被更改的資料
   FETCH apmt500_ooff_cl INTO g_pmdl_m.pmdlsite,g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocdt, 
       g_pmdl_m.pmdl002,g_pmdl_m.pmdl004,g_pmdl_m.pmdl003,
       g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008,g_pmdl_m.pmdl027, 
       g_pmdl_m.pmdl052,g_pmdl_m.pmdl053,g_pmdl_m.pmdl009,g_pmdl_m.pmdl010,g_pmdl_m.pmdl011,
       g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl015,
       g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl018,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl043,
       g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl020,g_pmdl_m.pmdl025,g_pmdl_m.pmdl026,g_pmdl_m.pmdl029,
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl022,g_pmdl_m.pmdl032,g_pmdl_m.pmdl024,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl040,g_pmdl_m.pmdl041,g_pmdl_m.pmdl042, 
       g_pmdl_m.pmdl047,g_pmdl_m.pmdl048,g_pmdl_m.pmdl049,g_pmdl_m.pmdl046,g_pmdl_m.pmdlownid,
       g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdt,g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmoddt, 
       g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfdt
   
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_pmdl_m.pmdldocno 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      CLOSE apmt500_ooff_cl
      CALL s_transaction_end('N','0')
      RETURN 
   END IF
 
   #檢查是否允許此動作
   IF NOT apmt500_action_chk() THEN
      CLOSE apmt500_ooff_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmdl_m.pmdldocno,g_pmdl_m.pmdl001,g_pmdl_m.pmdldocno_desc,g_pmdl_m.pmdldocdt,g_pmdl_m.pmdl004, 
       g_pmdl_m.pmdl004_desc,g_pmdl_m.pmdl002,g_pmdl_m.pmdl002_desc,g_pmdl_m.pmdl003,g_pmdl_m.pmdl003_desc, 
       g_pmdl_m.pmdlsite,g_pmdl_m.pmdlstus,g_pmdl_m.pmdl005,g_pmdl_m.pmdl006,g_pmdl_m.pmdl007,g_pmdl_m.pmdl008, 
       g_pmdl_m.pmdl027,g_pmdl_m.pmdl027_desc,g_pmdl_m.pmdl052,g_pmdl_m.pmdl052_desc,g_pmdl_m.pmdl053, 
       g_pmdl_m.pmdl009,g_pmdl_m.pmdl009_desc,g_pmdl_m.pmdl010,g_pmdl_m.pmdl010_desc,g_pmdl_m.pmdl011, 
       g_pmdl_m.pmdl011_desc,g_pmdl_m.pmdl012,g_pmdl_m.pmdl013,g_pmdl_m.pmdl033,g_pmdl_m.pmdl033_desc, 
       g_pmdl_m.pmdl015,g_pmdl_m.pmdl015_desc,g_pmdl_m.pmdl016,g_pmdl_m.pmdl017,g_pmdl_m.pmdl017_desc, 
       g_pmdl_m.pmdl018,g_pmdl_m.pmdl018_desc,g_pmdl_m.pmdl019,g_pmdl_m.pmdl023,g_pmdl_m.pmdl023_desc, 
       g_pmdl_m.pmdl043,g_pmdl_m.pmdl043_desc,g_pmdl_m.pmdl044,g_pmdl_m.pmdl051,g_pmdl_m.pmdl051_desc, 
       g_pmdl_m.pmdl020,g_pmdl_m.pmdl020_desc,g_pmdl_m.pmdl025,g_pmdl_m.pmdl025_desc,g_pmdl_m.oofb017, 
       g_pmdl_m.pmdl026,g_pmdl_m.pmdl026_desc,g_pmdl_m.oofb017_1,g_pmdl_m.pmdl029,g_pmdl_m.pmdl029_desc, 
       g_pmdl_m.pmdl021,g_pmdl_m.pmdl021_desc,g_pmdl_m.pmdl022,g_pmdl_m.pmdl022_desc,g_pmdl_m.pmdl032, 
       g_pmdl_m.pmdl032_desc,g_pmdl_m.pmdl024,g_pmdl_m.pmdl024_desc,g_pmdl_m.pmdl054,g_pmdl_m.pmdl055, 
       g_pmdl_m.pmdl030,g_pmdl_m.pmdl031,g_pmdl_m.pmdl028,g_pmdl_m.pmdl042,g_pmdl_m.pmdl047,g_pmdl_m.pmdl048, 
       g_pmdl_m.pmdl049,g_pmdl_m.pmdl208,g_pmdl_m.pmdl046,g_pmdl_m.fflabel_1,g_pmdl_m.pmdl040,g_pmdl_m.fflabel_2, 
       g_pmdl_m.pmdl041,g_pmdl_m.pmdlownid,g_pmdl_m.pmdlownid_desc,g_pmdl_m.pmdlowndp,g_pmdl_m.pmdlowndp_desc, 
       g_pmdl_m.pmdlcrtid,g_pmdl_m.pmdlcrtid_desc,g_pmdl_m.pmdlcrtdp,g_pmdl_m.pmdlcrtdp_desc,g_pmdl_m.pmdlcrtdt, 
       g_pmdl_m.pmdlmodid,g_pmdl_m.pmdlmodid_desc,g_pmdl_m.pmdlmoddt,g_pmdl_m.pmdlcnfid,g_pmdl_m.pmdlcnfid_desc, 
       g_pmdl_m.pmdlcnfdt
 
   LET g_detail_insert = cl_auth_detail_input("insert")
   LET g_detail_delete = cl_auth_detail_input("delete")
   
   LET g_ooff001_d = '6'   #6.單據單頭備註
   LET g_ooff002_d = g_prog   
   LET g_ooff003_d = g_pmdl_m.pmdldocno   #单号  
   LET g_ooff004_d = 0    #项次
   LET g_ooff005_d = ' '
   LET g_ooff006_d = ' '
   LET g_ooff007_d = ' '
   LET g_ooff008_d = ' '
   LET g_ooff009_d = ' '
   LET g_ooff010_d = ' '
   LET g_ooff011_d = ' '
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      SUBDIALOG aoo_aooi360_01.aooi360_01_input   #备注单身
      
      ON ACTION accept  
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄) 
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   CLOSE apmt500_ooff_cl
   
   CALL s_transaction_end('Y','0')
   
   CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身 

END FUNCTION

 
{</section>}
 
