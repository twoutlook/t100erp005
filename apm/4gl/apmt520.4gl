#該程式未解開Section, 採用最新樣板產出!
{<section id="apmt520.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0091(2017-02-17 15:26:39), PR版次:0091(2017-02-17 16:46:36)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000675
#+ Filename...: apmt520
#+ Description: 採購收貨單維護作業
#+ Creator....: 02294(2014-02-24 13:56:12)
#+ Modifier...: 02294 -SD/PR- 02294
 
{</section>}
 
{<section id="apmt520.global" >}
#應用 t01 樣板自動產生(Version:79)
#add-point:填寫註解說明 name="global.memo" 
#151201-00008#1   2015/12/01  By shiun     倉退(apmt580)單身的理由碼要是必要輸入
#151217-00014#3   2015/12/18  By Charles4m 檢查供應商是否存在apmm202(供應商據點資料)中
#151224-00025#3   2015/12/24  By fionchen  產品特徵欄位若無開窗輸入反而自行手動輸入時,則無法新增至inam_t
#151229-00009#1   2015/12/29  By tsungyung 當工單發料套數是0時，在單頭單身的採購單號欄位控卡不可以收貨。
#151210-00009#1   2015/12/30  By earl      多角流水號一致時，開窗、校驗調整
#151221-00010#1...2016/01/05  By ming      apmt531在輸入完供應商後，也應該要能帶出財務資訊
#160111-00030#1   2016/01/29  By Ann_Huang apmt520為多隻程式共用，有些程式畫面是沒有拉pmds001(過帳日期)的欄位,會預設帶g_today
#                                          所以在apmt561(委外驗退單)若做補單時,後續再判斷結案時,會拿過帳日期與單據日期這兩個欄位來做運算，導致結案判斷有誤
#151111-00023#1   2016/01/29  By dorislai  多加4的條件
#160122-00017#1   2016/02/02  By lixiang   储位管理若设置事前定义时，才需检验储位是否存在储位基本资料档中
#160127-00018#1   2016/02/02  By lixiang   并入#160122-00017#1一并调整
#151023-00018#1   2016/02/15  By lixiang   apmt571，希望判断如委外站是最后一站能直接生成工单入库单，不要审核，如非最后一站能直接生成报工单（审核）
#160217-00002#1   2016/02/24  By lixiang   營運據點的預設品管參照編號改從aqcs010參數設置作業中抓取
#150917-00001#3   2016/03/03  By earl      多角中斷調整為可拆單功能
#160224-00002#1   2016/03/14  By lixiang   單別參數有設置預設庫位時，帶出預設庫位
#160316-00007#3   2016/03/16  By lixiang   製造批序號相關的邏輯加上對庫存管理特徵的處理
#160314-00009#3   2016/03/17  By zhujing   各程式增加产品特征是否需要自动开窗的程式段处理
#160302-00027#2   2016/03/29  By lixiang   單別欄位先檢核單別是否符合條件，再判斷是否重複(防止單別誤輸入的時候，先報錯的是重複，報錯不準確)
#160328-00010#1   2016/03/31  By Ann_Huang 若有採用"多角單據流水號保持一致 E-BAS-0018", 則採購收貨單新增時，開窗會出現SQL語法錯誤,修正括號不成對
#160318-00025#15  2016/04/06  BY 07900     重复错误讯息的修改
#160407-00010#1   2016/04/07  By lixiang   验退单 单身会有两个产品特征栏位
#160407-00028#1   2016/04/07  By lixiang   收货单走制造批序号时，验退单、入库单更改库储批栏位不需弹出提示
#160407-00029#1   2016/04/07  By lixiang   单据复制时，制造批序号资料不要一并复制
#160411-00017#1   2016/04/13  By lixiang   修正倉退單在挑選製造批序號時的操作方式
#160413-00038#1   2016/04/14  By lixiang   委外收货单在检核来源工单是否有发料套数时，需考虑倒扣料的情况，工单备料单身都是倒扣料时，无需考虑发料套数
#160413-00011#9   2016/04/19  By lixiang   效能優化(用 filter二次過濾，二次過濾時 g_wc 不會清空，因此寫在 browser_fill的 g_wc 會出現疊加情況，故調整g_wc的賦值位置)
#130909-00003#58  2016/04/29  By lixiang   增加委外收貨單拆件元件逻辑
#160128-00023#1   2016/05/03  By lixiang   委外入庫單增加自動產生倒扣料功能
#160606-00013#1   2016/06/07  By lixiang   apmt521/apmt531收货时，若指定子件特性为12.联产品，开窗应开出此工单的联产品料件供挑选
#160606-00010#1   2016/06/08  By dorislai  修改cmdrun傳過來時，pmdsdocno用IN去串接
#160512-00004#2   2016/06/18  By dorislai  1.新增欄位-製造日期(pmdt219)  2.有效日期需>製造日期 
#                                           3.製造日期(pmdt219)、有效日期(pmdt089)在aini010有值的話，帶預設值&不可輸入；沒值，開放給user輸入
#160617-00005#2   2016/06/27  By lixiang   輸入收貨、入庫明細時， 料件批號須有批號且自動編碼而批號為空就自動編碼
#160512-00004#6   2016/06/29  By dorislai  新增欄位-製造日期(pmdu202)
#160629-00018#1   2016/07/01  By lixiang   复制资料时，清空单身的 主账套暂估数量pmdt066，账套二暂估数量pmdt067，账套三暂估数量pmdt068，主账套已请款数量pmdt056 账套二已请款数量pmdt057 账套三已请款数量pmdt058
#160519-00022#2   2016/06/30  By xianghui  入库单apmt530/apmt532/pmat570添加批号控管
#160719-00002#1   2016/07/19  By lixiang   apmt520的b_fill中单身查询条件的变量组条件之后没有备份还原，导致where条件一直在叠加
#160720-00015#1   2016/07/20  By lixiang   过账段效能优化
#160519-00008#16  2016/07/29  By lixh      单据上库存管理特征栏位依料件设定控管
#160713-00001#1   2016/08/02  By lixiang   採購入庫單(apmt530、apmt531、apmt532、apmt534)
#                                          1.收貨人員欄位應直接帶目前輸入人員即可，不需依供應商預設採購員重帶
#                                          2.還沒輸入單別前，先輸入供應商，會出現傳入參數為空的錯訊息，請修正錯誤訊息“請先輸入單別”
#160804-00025#1   2016/08/10  By lixiang   过账后点击整单操作中的【取回】，输入完取回日期确定保存后，栏位不应该是开启输入的颜色
#160805-00015#1   2016/08/10  By lixiang   显示状态下同步带出单身理由码栏位说明
#160805-00008#1   2016/08/10  By lixiang   收货单产生QC单的单据日期给g_today
#160801-00043#1   2016/08/10  By lixiang   收貨入庫單的採購性質為"3.VMI採購"時，單身的庫位僅能選"VMI存貨庫位";反之非VMI採購，不可選VMI相關庫位
#160804-00005#1   2016/08/16  By lixiang   透过更改单价action修改单价时，发票代码、发票号码栏位不可输入
#160815-00031#3   2016/08/16  By lixiang   料件類別為"E"的，卡備註要必輸 
#160812-00017#8   2016/08/16  By 06137     在satatchange( )的FUNCTION中，有RETURN指令但沒有加上transaction_end( ) 造成transaction沒有結束就直接RETURN
#160816-00001#9   2016/08/19  By 08734     抓取理由碼改CALL sub
#160811-00014#2   2016/08/24  By dongsz    增加扫码录入功能scan_barcode
#160905-00007#11  2016/09/05  By 01727     调整系统中无ENT的SQL条件增加ent
#160905-00016#1   2016/09/13  By lixiang   仓退单单头增加折让证明单开立方式栏位
#160914-00025#1   2016/09/14  By 02040     多角最終供應商在打收貨單時，多張採購單合併收貨，增加合併的檢查
#160831-00016#1   2016/09/20  By lixiang   修改單頭稅別時，同步更新單身的稅別欄位並重新計算金額
#160831-00070#1   2016/10/04  By 06814     增加條碼輸入邏輯
#161005-00037#1   2016/10/07  By charles4m cl_cmdrun() 要給 la_param 值前，要用 INITIALIZE la_param.* TO NULL 先將 la_param 清空
#160831-00070#14  2016/10/13  By 06814     1.增加條碼輸入邏輯(apmt571)
#                                          2.因為是共用程式，如暂无扫码录入功能，要把扫码录入按钮隐藏
#161012-00053#1   2016/10/17  By tangyi    “采购单号”没有录入时，根据供应商据点默认资料带出财务信息,增加委外采购单；
#161021-00018#1   2016/10/21  By 00768     apmt580仓退单，如果单头有输入收货单号，单身收货项次栏位必输
#161024-00023#1   2016/10/26  By 06137     1.整单操作，增加按钮'产生拣货装箱单'，按钮逻辑见分镜apmt520；
#                                          2.整单操作-生成入库单按钮增加判断，if单号存于拣货装箱单(aint701)里的来源单号[inbm004]，且拣货装箱.状态码不为作废，则报错提示；
#                                          3.取消审核时判断，if单号存于拣货装箱单(aint701)里的来源单号[inbm004]，且拣货装箱.状态码不为作废，不可做取消审核」；
#                                          4.整单操作-生成入库单，新增为公用元件，传入单据类型、单号，IF传入的单据类型=1.委外采购收货单 THEN 按原逻辑处理（是否调公用元件待和制造及服务确认），IF传入的单据类型=2.装箱单 THEN 数量[pmdt020]写入装箱来源档.已装箱量[inbp009]，多库储批数量，按照已装箱量依序写满（例如采收收货100，分A仓50，B仓50，装箱80，则生成入库单，A仓50，B仓30）条件：单号=单号[inbp002]，项次=项次[inbp003]，备注写入‘装箱单产生’，调用委外采购入库apmt571审核元件
#161019-00046#1   2016/11/11  By lixiang   单头输入委外采购单后，若是代买料的不控管发料套数
#                                          整批产生单身时，若单身特性是代买料，不检核发料套数;审核时数量检核，代买料不需匹配发料套数
#161111-00053#1   2016/11/11  By lixiang   當 匯率計算基準(pmds049)為 2:依收貨日匯率 時,請開放匯率欄位維護應用
#161109-00066#1   2016/11/11  By lixiang   税别是复合税时，一个项次会产生多笔xrcd的资料，更新单身的金额时，需以项次取合计
#161101-00081#1   2016/11/14  By wuxja     增加单别预设栏位逻辑
#161116-00009#1   2016/11/16  By wuxja     考虑到有超交率的情况，收货>采购时，可收货不可小于0,若还需超收，手动维护
#161117-00013#1   2016/11/17  By ouhz      apmt560,apmt570 收货来源开窗只查询收货单单身(允收数量-已入库量-验退数量)>0的数量
#161006-00018#8   2016/11/21  By lixiang   來源單據指定庫儲後，根據單據別參數判斷是否允許修改

#161027-00035#1   2016/11/28  By Whitney   參數設定多角單據自動拋轉時，如拋轉未成功，彈出錯誤訊息，並將單據資料一併還原
#161208-00023#1   2016/12/09  By 06137     产生拣货装箱单时，单身pmdt005=8.委外代买料的部分，不产生到装箱单身inbp档
#161125-00010#1   2016/12/13  By lixiang   倉退方式"產生新採購單"時，新PO的單價應該為原PO的單價，不可重新取價
#160929-00038#1   2016/11/23  By lixiang   收货入库的计价数量栏位处理，先预设带出剩余的计价数量，不用单位换算重新计算
#161124-00048#11  2016/12/19  By zhujing   .*整批调整
#161207-00033#27  2016/12/22  By lixh      一次性交易對象顯示說明，所有的客戶/供應商欄位都應該處理
#161205-00025#3   2016/12/22  By lixiang  效能优化
#161201-00033#1   2016/12/26  By lixiang  入库时，单身选择的库位，其储位管理属性为：2:使用储位管理-人工指定,自行输入的储位需要同步回写到aini002储位基本资料档中。
#161209-00043#1   2016/12/26  By lixiang  委外收货单，点击单头对应的采购单串查，应正确带出采购单的资料
#161207-00033#38  2016/12/28  By lixiang  1.无采购收货单，维护供应商是一次性交易对象时，需产生一次性交易对象识别码
#                                         2.采购收货单作业，若供应商是一次性交易对象时，来源采购单必输
#161229-00012#1   2016/12/30  By lixiang 若單別設置自動過賬時，程式出錯無法正常過賬。
#161230-00015#1   2016/12/30  By lixiang   多库储批维护画面输入批号时一直抱重复的错误
#170103-00025#1   2017/01/03  By lixiang  参考数量栏位都可以修改
#161215-00081#1   2017/01/05  By wuxja    如果单身所有项次都已转QC单后，不应提示生成QC单成功
#161101-00064#1   2017/01/05  By wuxja    采购性质为借货采购时，不可维护进项发票明细
#170111-00050#1   2017/01/12  By wuxja    费用性料件，库位可不输
#170116-00040#1   2017/01/17  By wuxja    若单身采购单对应多角编号一样时回写单头
#160824-00007#348 2017/01/18  By 06137    修正舊值備份寫法
#170120-00009#1   2017/01/20  By wuxja    1、查询时需加上site的条件，防止查询方案时其他据点资料也会出来 2、委外倉退的倉退方式只能是4，不可预设其他值
#170202-00018#1   2017/02/07  By Ann_Huang 調整驗退單單身不須顯示判定結果欄位(pmdt083、pmdt083_desc)
#160604-00034#7   2017/02/08  By lixh      單據的單據日期及過帳日期應依aoos020裡"進銷存單據日期控管方式"、"進銷存過帳日期控管方式"處理,
#                                          如參數設定為"不可修改"時，則新增、修改時，都不可異動該欄位資料
#161031-00025#15 17/02/07 By xujing ：1.單頭增加"備註"頁籤嵌入aooi360_01，放在異動資訊前面
#                                     2.原"備註"action，改為確認後，可維護"備註"頁籤資料
#                                     3.單身最後面增加顯示"長備註"欄位，要可開窗輸入，一樣抓取aooi360的備註顯示，項次 = 單身項次、控制類型 = 列印在後
#170208-00055#1   2017/02/15  By wuxja  拆件元件不需要考虑发料套数
#170206-00030#1   2017/02/17  By lixiang  即时刷新单身的资料，比如由审核、过账等时回写了单身资料，要即时刷新
#170118-00051#1   2017/02/17  By lixiang 將原"產生入庫單"、"產生驗退單" 二個選項合併為"產生入庫/驗退單"
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"
IMPORT FGL sub_s_lot
IMPORT FGL aoo_aooi360_01  #161031-00025#15 add
#end add-point 
 
SCHEMA ds 
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔 name="global.inc"
GLOBALS "../../../com/sub/4gl/s_aic_carry.inc"   #150615 earl add
#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_pmds_m        RECORD
       pmdssite LIKE pmds_t.pmdssite, 
   pmdsdocno LIKE pmds_t.pmdsdocno, 
   pmdsdocno_desc LIKE type_t.chr80, 
   pmdsdocdt LIKE pmds_t.pmdsdocdt, 
   pmds001 LIKE pmds_t.pmds001, 
   pmds002 LIKE pmds_t.pmds002, 
   pmds002_desc LIKE type_t.chr80, 
   pmds003 LIKE pmds_t.pmds003, 
   pmds003_desc LIKE type_t.chr80, 
   pmdsstus LIKE pmds_t.pmdsstus, 
   pmds006 LIKE pmds_t.pmds006, 
   pmds007 LIKE pmds_t.pmds007, 
   pmds007_desc LIKE type_t.chr80, 
   pmds008 LIKE pmds_t.pmds008, 
   pmds008_desc LIKE type_t.chr80, 
   pmds009 LIKE pmds_t.pmds009, 
   pmds009_desc LIKE type_t.chr80, 
   pmds010 LIKE pmds_t.pmds010, 
   pmds052 LIKE pmds_t.pmds052, 
   pmds028 LIKE pmds_t.pmds028, 
   pmds000 LIKE pmds_t.pmds000, 
   pmds100 LIKE pmds_t.pmds100, 
   pmds011 LIKE pmds_t.pmds011, 
   pmds014 LIKE pmds_t.pmds014, 
   pmds081 LIKE pmds_t.pmds081, 
   pmds045 LIKE pmds_t.pmds045, 
   pmds021 LIKE pmds_t.pmds021, 
   pmds022 LIKE pmds_t.pmds022, 
   pmds023 LIKE pmds_t.pmds023, 
   pmds024 LIKE pmds_t.pmds024, 
   pmds031 LIKE pmds_t.pmds031, 
   pmds031_desc LIKE type_t.chr80, 
   pmds032 LIKE pmds_t.pmds032, 
   pmds032_desc LIKE type_t.chr80, 
   pmds033 LIKE pmds_t.pmds033, 
   pmds033_desc LIKE type_t.chr80, 
   pmds034 LIKE pmds_t.pmds034, 
   pmds035 LIKE pmds_t.pmds035, 
   pmds036 LIKE pmds_t.pmds036, 
   pmds037 LIKE pmds_t.pmds037, 
   pmds037_desc LIKE type_t.chr80, 
   pmds038 LIKE pmds_t.pmds038, 
   pmds039 LIKE pmds_t.pmds039, 
   pmds039_desc LIKE type_t.chr80, 
   pmds040 LIKE pmds_t.pmds040, 
   pmds040_desc LIKE type_t.chr80, 
   pmds012 LIKE pmds_t.pmds012, 
   pmds012_desc LIKE type_t.chr80, 
   pmds101 LIKE pmds_t.pmds101, 
   pmds102 LIKE pmds_t.pmds102, 
   pmds103 LIKE pmds_t.pmds103, 
   pmds048 LIKE pmds_t.pmds048, 
   pmds047 LIKE pmds_t.pmds047, 
   pmds049 LIKE pmds_t.pmds049, 
   pmds053 LIKE pmds_t.pmds053, 
   pmds053_desc LIKE type_t.chr80, 
   pmds041 LIKE pmds_t.pmds041, 
   pmds043 LIKE pmds_t.pmds043, 
   pmds044 LIKE pmds_t.pmds044, 
   pmds046 LIKE pmds_t.pmds046, 
   pmds054 LIKE pmds_t.pmds054, 
   pmds055 LIKE pmds_t.pmds055, 
   pmds050 LIKE pmds_t.pmds050, 
   pmds057 LIKE pmds_t.pmds057, 
   pmds042 LIKE pmds_t.pmds042, 
   pmds058 LIKE pmds_t.pmds058, 
   pmdsownid LIKE pmds_t.pmdsownid, 
   pmdsownid_desc LIKE type_t.chr80, 
   pmdsowndp LIKE pmds_t.pmdsowndp, 
   pmdsowndp_desc LIKE type_t.chr80, 
   pmdscrtid LIKE pmds_t.pmdscrtid, 
   pmdscrtid_desc LIKE type_t.chr80, 
   pmdscrtdp LIKE pmds_t.pmdscrtdp, 
   pmdscrtdp_desc LIKE type_t.chr80, 
   pmdscrtdt LIKE pmds_t.pmdscrtdt, 
   pmdsmodid LIKE pmds_t.pmdsmodid, 
   pmdsmodid_desc LIKE type_t.chr80, 
   pmdsmoddt LIKE pmds_t.pmdsmoddt, 
   pmdscnfid LIKE pmds_t.pmdscnfid, 
   pmdscnfid_desc LIKE type_t.chr80, 
   pmdscnfdt LIKE pmds_t.pmdscnfdt, 
   pmdspstid LIKE pmds_t.pmdspstid, 
   pmdspstid_desc LIKE type_t.chr80, 
   pmdspstdt LIKE pmds_t.pmdspstdt
       END RECORD
 
#單身 type 宣告
PRIVATE TYPE type_g_pmdt_d        RECORD
       pmdtsite LIKE pmdt_t.pmdtsite, 
   pmdtseq LIKE pmdt_t.pmdtseq, 
   pmdt027 LIKE pmdt_t.pmdt027, 
   pmdt028 LIKE pmdt_t.pmdt028, 
   pmdt001 LIKE pmdt_t.pmdt001, 
   pmdt002 LIKE pmdt_t.pmdt002, 
   pmdt003 LIKE pmdt_t.pmdt003, 
   pmdt004 LIKE pmdt_t.pmdt004, 
   pmdt081 LIKE pmdt_t.pmdt081, 
   pmdt082 LIKE pmdt_t.pmdt082, 
   pmdt083 LIKE pmdt_t.pmdt083, 
   pmdt083_desc LIKE type_t.chr500, 
   pmdt005 LIKE pmdt_t.pmdt005, 
   pmdo001 LIKE type_t.chr500, 
   imaal003 LIKE type_t.chr500, 
   imaal004 LIKE type_t.chr500, 
   pmdo002 LIKE pmdo_t.pmdo002, 
   pmdo002_desc LIKE type_t.chr500, 
   pmdt006 LIKE pmdt_t.pmdt006, 
   pmdt006_desc LIKE type_t.chr500, 
   pmdt006_desc2 LIKE type_t.chr500, 
   pmdt007 LIKE pmdt_t.pmdt007, 
   pmdt007_desc LIKE type_t.chr500, 
   pmdt009 LIKE pmdt_t.pmdt009, 
   pmdt009_desc LIKE type_t.chr500, 
   pmdt010 LIKE pmdt_t.pmdt010, 
   pmdt025 LIKE pmdt_t.pmdt025, 
   pmdt011 LIKE pmdt_t.pmdt011, 
   pmdt019 LIKE pmdt_t.pmdt019, 
   pmdt019_desc LIKE type_t.chr500, 
   pmdt020 LIKE pmdt_t.pmdt020, 
   pmdt021 LIKE pmdt_t.pmdt021, 
   pmdt021_desc LIKE type_t.chr500, 
   pmdt022 LIKE pmdt_t.pmdt022, 
   pmdt008 LIKE pmdt_t.pmdt008, 
   pmdt008_desc LIKE type_t.chr500, 
   pmdt023 LIKE pmdt_t.pmdt023, 
   pmdt023_desc LIKE type_t.chr500, 
   pmdt024 LIKE pmdt_t.pmdt024, 
   pmdt090 LIKE pmdt_t.pmdt090, 
   pmdt091 LIKE pmdt_t.pmdt091, 
   pmdt036 LIKE pmdt_t.pmdt036, 
   pmdt046 LIKE pmdt_t.pmdt046, 
   pmdt046_desc LIKE type_t.chr500, 
   pmdt037 LIKE pmdt_t.pmdt037, 
   pmdt038 LIKE pmdt_t.pmdt038, 
   pmdt039 LIKE pmdt_t.pmdt039, 
   pmdt047 LIKE pmdt_t.pmdt047, 
   pmdt092 LIKE pmdt_t.pmdt092, 
   pmdt093 LIKE pmdt_t.pmdt093, 
   pmdt026 LIKE pmdt_t.pmdt026, 
   pmdt041 LIKE pmdt_t.pmdt041, 
   pmdt062 LIKE pmdt_t.pmdt062, 
   pmdt016 LIKE pmdt_t.pmdt016, 
   pmdt016_desc LIKE type_t.chr500, 
   pmdt017 LIKE pmdt_t.pmdt017, 
   pmdt017_desc LIKE type_t.chr500, 
   pmdt018 LIKE pmdt_t.pmdt018, 
   pmdt063 LIKE pmdt_t.pmdt063, 
   pmdt072 LIKE pmdt_t.pmdt072, 
   pmdt072_desc LIKE type_t.chr500, 
   pmdt073 LIKE pmdt_t.pmdt073, 
   pmdt073_desc LIKE type_t.chr500, 
   pmdt074 LIKE pmdt_t.pmdt074, 
   pmdt074_desc LIKE type_t.chr500, 
   pmdt075 LIKE pmdt_t.pmdt075, 
   pmdt075_desc LIKE type_t.chr500, 
   pmdt040 LIKE pmdt_t.pmdt040, 
   pmdt052 LIKE pmdt_t.pmdt052, 
   pmdt051 LIKE pmdt_t.pmdt051, 
   pmdt051_desc LIKE type_t.chr500, 
   pmdt070 LIKE pmdt_t.pmdt070, 
   pmdt071 LIKE pmdt_t.pmdt071, 
   pmdt059 LIKE pmdt_t.pmdt059, 
   pmdt053 LIKE pmdt_t.pmdt053, 
   pmdt054 LIKE pmdt_t.pmdt054, 
   pmdt055 LIKE pmdt_t.pmdt055, 
   pmdt060 LIKE pmdt_t.pmdt060, 
   pmdt061 LIKE pmdt_t.pmdt061, 
   pmdt042 LIKE pmdt_t.pmdt042, 
   pmdt043 LIKE pmdt_t.pmdt043, 
   pmdt048 LIKE pmdt_t.pmdt048, 
   pmdt044 LIKE pmdt_t.pmdt044, 
   pmdt045 LIKE pmdt_t.pmdt045, 
   pmdt049 LIKE pmdt_t.pmdt049, 
   pmdt050 LIKE pmdt_t.pmdt050, 
   pmdt084 LIKE pmdt_t.pmdt084, 
   pmdt219 LIKE pmdt_t.pmdt219, 
   pmdt089 LIKE pmdt_t.pmdt089, 
   pmdt088 LIKE pmdt_t.pmdt088, 
   ooff013 LIKE type_t.chr500
       END RECORD
PRIVATE TYPE type_g_pmdt2_d RECORD
       pmdusite LIKE pmdu_t.pmdusite, 
   pmduseq LIKE pmdu_t.pmduseq, 
   pmduseq1 LIKE pmdu_t.pmduseq1, 
   pmdu001 LIKE pmdu_t.pmdu001, 
   pmdu001_desc LIKE type_t.chr500, 
   imaal004 LIKE imaal_t.imaal004, 
   pmdu002 LIKE pmdu_t.pmdu002, 
   pmdu002_desc LIKE type_t.chr500, 
   pmdu003 LIKE pmdu_t.pmdu003, 
   pmdu004 LIKE pmdu_t.pmdu004, 
   pmdu006 LIKE pmdu_t.pmdu006, 
   pmdu006_desc LIKE type_t.chr500, 
   pmdu007 LIKE pmdu_t.pmdu007, 
   pmdu007_desc LIKE type_t.chr500, 
   pmdu008 LIKE pmdu_t.pmdu008, 
   pmdu005 LIKE pmdu_t.pmdu005, 
   pmdu009 LIKE pmdu_t.pmdu009, 
   pmdu009_desc LIKE type_t.chr500, 
   pmdu010 LIKE pmdu_t.pmdu010, 
   pmdu011 LIKE pmdu_t.pmdu011, 
   pmdu011_desc LIKE type_t.chr500, 
   pmdu012 LIKE pmdu_t.pmdu012, 
   pmdu013 LIKE pmdu_t.pmdu013, 
   pmdu014 LIKE pmdu_t.pmdu014, 
   pmdu015 LIKE pmdu_t.pmdu015, 
   pmdu202 LIKE pmdu_t.pmdu202, 
   pmdu017 LIKE pmdu_t.pmdu017, 
   pmdu016 LIKE pmdu_t.pmdu016
       END RECORD
PRIVATE TYPE type_g_pmdt3_d RECORD
       pmdvsite LIKE pmdv_t.pmdvsite, 
   pmdvseq LIKE pmdv_t.pmdvseq, 
   pmdvseq1 LIKE pmdv_t.pmdvseq1, 
   pmdv005 LIKE pmdv_t.pmdv005, 
   pmdv001 LIKE pmdv_t.pmdv001, 
   pmdv001_desc LIKE type_t.chr500, 
   imaal004 LIKE imaal_t.imaal004, 
   pmdv002 LIKE pmdv_t.pmdv002, 
   pmdv002_desc LIKE type_t.chr500, 
   pmdv003 LIKE pmdv_t.pmdv003, 
   pmdv004 LIKE pmdv_t.pmdv004, 
   pmdv014 LIKE pmdv_t.pmdv014, 
   pmdv015 LIKE pmdv_t.pmdv015, 
   pmdv016 LIKE pmdv_t.pmdv016, 
   pmdv017 LIKE pmdv_t.pmdv017, 
   pmdv018 LIKE pmdv_t.pmdv018, 
   pmdv018_desc LIKE type_t.chr500, 
   pmdv019 LIKE pmdv_t.pmdv019
       END RECORD
 
 
PRIVATE TYPE type_browser RECORD
         b_statepic     LIKE type_t.chr50,
            b_pmdsdocno LIKE pmds_t.pmdsdocno,
      b_pmdsdocdt LIKE pmds_t.pmdsdocdt,
      b_pmds002 LIKE pmds_t.pmds002,
   b_pmds002_desc LIKE type_t.chr80,
      b_pmds003 LIKE pmds_t.pmds003,
   b_pmds003_desc LIKE type_t.chr80,
      b_pmds007 LIKE pmds_t.pmds007,
      b_pmds008 LIKE pmds_t.pmds008,
      b_pmds009 LIKE pmds_t.pmds009
       END RECORD
       
#add-point:自定義模組變數(Module Variable) (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="global.variable"
TYPE type_g_pmdt4_d        RECORD
   pmdtseq LIKE pmdt_t.pmdtseq,
   pmdt001 LIKE pmdt_t.pmdt001, 
   pmdt002 LIKE pmdt_t.pmdt002, 
   pmdt003 LIKE pmdt_t.pmdt003, 
   pmdt004 LIKE pmdt_t.pmdt004, 
   pmdt049 LIKE pmdt_t.pmdt049,
   pmdt050 LIKE pmdt_t.pmdt050, 
   #ming 20150922 add ------------------------------(S) 
   isam011 LIKE isam_t.isam011,     #發票日期  
   #ming 20150922 add ------------------------------(E) 
   pmdt005 LIKE pmdt_t.pmdt005, 
   pmdt006 LIKE pmdt_t.pmdt006, 
   imaal003 LIKE imaal_t.imaal003, 
   imaal004 LIKE imaal_t.imaal004, 
   pmdt007 LIKE pmdt_t.pmdt007,
   pmdt007_desc LIKE type_t.chr500,    
   pmdt009 LIKE pmdt_t.pmdt009, 
   pmdt010 LIKE pmdt_t.pmdt010,
   pmdt019 LIKE pmdt_t.pmdt019, 
   pmdt019_desc LIKE type_t.chr500, 
   pmdt020 LIKE pmdt_t.pmdt020,
   pmdt023 LIKE pmdt_t.pmdt023, 
   pmdt023_desc LIKE type_t.chr500, 
   pmdt024 LIKE pmdt_t.pmdt024, 
   pmdt040 LIKE pmdt_t.pmdt040,
   pmdt036 LIKE pmdt_t.pmdt036,
   pmdt046 LIKE pmdt_t.pmdt046,
   pmdt046_desc LIKE type_t.chr500,     
   pmdt037 LIKE pmdt_t.pmdt037, 
   pmdt038 LIKE pmdt_t.pmdt038, 
   pmdt039 LIKE pmdt_t.pmdt039,
   pmdt047 LIKE pmdt_t.pmdt047,
   pmdt092 LIKE pmdt_t.pmdt092,
   pmdt093 LIKE pmdt_t.pmdt093
       END RECORD
DEFINE g_pmdt4_d   DYNAMIC ARRAY OF type_g_pmdt4_d
DEFINE g_pmdt4_d_t type_g_pmdt4_d
DEFINE g_pmdt4_d_o type_g_pmdt4_d
DEFINE g_rec_b4    LIKE type_t.num5           
DEFINE l_ac4       LIKE type_t.num5 

DEFINE g_flag2        LIKE type_t.num5
DEFINE g_acc          LIKE gzcb_t.gzcb007
DEFINE g_flag3        LIKE type_t.num5
DEFINE g_ooef025      LIKE ooef_t.ooef025
DEFINE g_pmab039      LIKE pmab_t.pmab039  
DEFINE g_tax_app      LIKE oodb_t.oodb011      #取得稅別類型1:正常稅率2:依料件設定
DEFINE g_pmam003      LIKE pmam_t.pmam003      #價格是否允許修改
DEFINE g_pmam006      LIKE pmam_t.pmam006      #允許價格為0
DEFINE g_pmam002      LIKE pmam_t.pmam002      #未取到價格可以人工輸入
DEFINE g_upd_price    LIKE type_t.num5         #是否可以修改單價
DEFINE g_pmdldocno    LIKE pmdl_t.pmdldocno    #倉退單產生新的採購單單號
DEFINE g_controlno    LIKE ooha_t.ooha001      #控制組

GLOBALS

#mark by lixiang 2016/1/12--begin----   
##字段順序個數需與s_lot中的一樣
#TYPE type_g_inao_d        RECORD
#    inaoseq       LIKE inao_t.inaoseq,
#    inaoseq1      LIKE inao_t.inaoseq1,
#    inaoseq2      LIKE inao_t.inaoseq2,
#    inao001       LIKE inao_t.inao001,
#    inao001_desc  LIKE imaal_t.imaal003,
#    inao001_desc2 LIKE imaal_t.imaal004,
#    inao008       LIKE inao_t.inao008,
#    inao009       LIKE inao_t.inao009,
#    inao010       LIKE inao_t.inao010,
#    inao012       LIKE inao_t.inao012
#       END RECORD
#mark by lixiang 2016/1/12--end----
#add by lixiang 2016/1/12--begin----   
 TYPE type_g_inao_d        RECORD
    inao000           LIKE inao_t.inao000,
    inao013           LIKE inao_t.inao013,
    inaodocno         LIKE inao_t.inaodocno,
    inaoseq           LIKE inao_t.inaoseq,
    inaoseq1          LIKE inao_t.inaoseq1,
    inaoseq2          LIKE inao_t.inaoseq2,
    inao001           LIKE inao_t.inao001,
    inao001_desc      LIKE type_t.chr500,
    inao001_desc_desc LIKE type_t.chr500,
    inao008           LIKE inao_t.inao008,
    inao009           LIKE inao_t.inao009,
    inao012           LIKE inao_t.inao012,
    inao010           LIKE inao_t.inao010,
    inao011           LIKE inao_t.inao011
                  END RECORD
#add by lixiang 2016/1/12--end----   
DEFINE g_inao_d          DYNAMIC ARRAY OF type_g_inao_d
DEFINE g_detail_insert   LIKE type_t.num5   #單身的新增權限
DEFINE g_detail_delete   LIKE type_t.num5   #單身的刪除權限
DEFINE g_wc2_lot         STRING             #製造批序號QBE條件
DEFINE g_d_idx_lot       LIKE type_t.num5   #製造批序號所在筆數
DEFINE g_d_cnt_lot       LIKE type_t.num5   #製造批序號總筆數
DEFINE g_appoint_idx     LIKE type_t.num5   #指定進入單身行數
END GLOBALS
DEFINE g_detail_id          STRING             #紀錄停留在製造批序號Page

DEFINE g_aic_doc   LIKE type_t.num5    #151210-00009#1  2015/12/30 By earl add
DEFINE g_ooef019   LIKE ooef_t.ooef019 #160720-00015#1
DEFINE g_slip_wc   STRING              #160510-00043#2
DEFINE g_bas_0043  LIKE type_t.chr80   #160801-00043#1
DEFINE g_bas_0019  LIKE type_t.chr80   #161205-00025#3
#161031-00025#15 add(s)
GLOBALS
TYPE type_g_ooff_d        RECORD
       ooff001 LIKE ooff_t.ooff001, 
   ooff002 LIKE ooff_t.ooff002, 
   ooff004 LIKE ooff_t.ooff004, 
   ooff005 LIKE ooff_t.ooff005, 
   ooff006 LIKE ooff_t.ooff006, 
   ooff007 LIKE ooff_t.ooff007, 
   ooff008 LIKE ooff_t.ooff008, 
   ooff009 LIKE ooff_t.ooff009, 
   ooff010 LIKE ooff_t.ooff010, 
   ooff011 LIKE ooff_t.ooff011, 
   ooff003 LIKE ooff_t.ooff003, 
   ooff012 LIKE ooff_t.ooff012, 
   ooff013 LIKE ooff_t.ooff013, 
   ooff014 LIKE ooff_t.ooff014
       END RECORD
 
DEFINE g_ooff_d4          DYNAMIC ARRAY OF type_g_ooff_d

DEFINE g_detail_insert   LIKE type_t.num5   #單身的新增權限
DEFINE g_detail_delete   LIKE type_t.num5   #單身的刪除權限
DEFINE g_wc2_i36001      STRING             #备注单身QBE條件
DEFINE g_d_idx_i36001    LIKE type_t.num5   #备注单身所在筆數
DEFINE g_d_cnt_i36001    LIKE type_t.num5   #备注单身總筆數
DEFINE g_appoint_idx     LIKE type_t.num5   #指定進入單身行數
DEFINE g_ooff001_d       LIKE ooff_t.ooff001
DEFINE g_ooff002_d       LIKE ooff_t.ooff002
DEFINE g_ooff003_d       LIKE ooff_t.ooff003
DEFINE g_ooff004_d       LIKE ooff_t.ooff004
DEFINE g_ooff005_d       LIKE ooff_t.ooff005
DEFINE g_ooff006_d       LIKE ooff_t.ooff006
DEFINE g_ooff007_d       LIKE ooff_t.ooff007
DEFINE g_ooff008_d       LIKE ooff_t.ooff008
DEFINE g_ooff009_d       LIKE ooff_t.ooff009
DEFINE g_ooff010_d       LIKE ooff_t.ooff010
DEFINE g_ooff011_d       LIKE ooff_t.ooff011
END GLOBALS
#161031-00025#15 add(e)
#end add-point
       
#模組變數(Module Variables)
DEFINE g_pmds_m          type_g_pmds_m
DEFINE g_pmds_m_t        type_g_pmds_m
DEFINE g_pmds_m_o        type_g_pmds_m
DEFINE g_pmds_m_mask_o   type_g_pmds_m #轉換遮罩前資料
DEFINE g_pmds_m_mask_n   type_g_pmds_m #轉換遮罩後資料
 
   DEFINE g_pmdsdocno_t LIKE pmds_t.pmdsdocno
 
 
DEFINE g_pmdt_d          DYNAMIC ARRAY OF type_g_pmdt_d
DEFINE g_pmdt_d_t        type_g_pmdt_d
DEFINE g_pmdt_d_o        type_g_pmdt_d
DEFINE g_pmdt_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt_d #轉換遮罩前資料
DEFINE g_pmdt_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt_d #轉換遮罩後資料
DEFINE g_pmdt2_d          DYNAMIC ARRAY OF type_g_pmdt2_d
DEFINE g_pmdt2_d_t        type_g_pmdt2_d
DEFINE g_pmdt2_d_o        type_g_pmdt2_d
DEFINE g_pmdt2_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt2_d #轉換遮罩前資料
DEFINE g_pmdt2_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt2_d #轉換遮罩後資料
DEFINE g_pmdt3_d          DYNAMIC ARRAY OF type_g_pmdt3_d
DEFINE g_pmdt3_d_t        type_g_pmdt3_d
DEFINE g_pmdt3_d_o        type_g_pmdt3_d
DEFINE g_pmdt3_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt3_d #轉換遮罩前資料
DEFINE g_pmdt3_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt3_d #轉換遮罩後資料
 
 
DEFINE g_browser         DYNAMIC ARRAY OF type_browser
DEFINE g_browser_f       DYNAMIC ARRAY OF type_browser
 
 
DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc2_table2   STRING
 
DEFINE g_wc2_table3   STRING
 
 
 
DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING
 
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog
                                                               
DEFINE g_pagestart           LIKE type_t.num10                 
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)
DEFINE g_order               STRING                             #查詢排序欄位
                                                        
DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入
 
DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明(global.argv) name="global.argv"

#end add-point
 
{</section>}
 
{<section id="apmt520.main" >}
#應用 a26 樣板自動產生(Version:7)
#+ 作業開始(主程式類型)
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"
            
   #end add-point   
   
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("apm","")
 
   #add-point:作業初始化 name="main.init"
   IF NOT cl_null(g_argv[1]) THEN
      LET g_pmds_m.pmds000 = g_argv[1]
   END IF
   
   CALL s_tax_recount_tmp()
   
   CALL apmt520_04_create_tmp()  #130909-00003#58 add
   
   LET g_acc = ''
   #抓取[T:系統分類值檔].[C:系統分類碼]=24且[T:系統分類值檔].[C:系統分類碼]=g_prog 的[T:系統分類值檔].[C:參考欄位>
   #SELECT gzcb004 INTO g_acc FROM gzcb_t WHERE gzcb001 = '24' AND gzcb002 = g_prog   #160816-00001#9  2016/08/19  By 08734 Mark
   LET g_acc = s_fin_get_scc_value('24',g_prog,'2')  #160816-00001#9  2016/08/19  By 08734 add
   
   #160801-00043#1--s
   #放到apmt520_init()中
   ##品管參照表編號
   #LET g_ooef025 = ''
   ##SELECT ooef025 INTO g_ooef025 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site #160217-00002#1 mark
   #LET g_ooef025 = cl_get_para(g_enterprise,g_site,'S-MFG-0046')   #160217-00002#1 add
   #
   #SELECT ooef019 INTO g_ooef019 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site  #160720-00015#1
   #
   #LET g_flag2 = FALSE
   ##LET g_flag3 = TRUE
   #LET g_upd_price = TRUE
   #
   #LET g_bas_0043 = ''
   #LET g_bas_0043 = cl_get_para(g_enterprise,g_site,'S-BAS-0043')  #VMI存貨庫位Tag
   #160801-00043#1--e
   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define name="main.define_sql"
            
   #end add-point
   LET g_forupd_sql = " SELECT pmdssite,pmdsdocno,'',pmdsdocdt,pmds001,pmds002,'',pmds003,'',pmdsstus, 
       pmds006,pmds007,'',pmds008,'',pmds009,'',pmds010,pmds052,pmds028,pmds000,pmds100,pmds011,pmds014, 
       pmds081,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,'',pmds032,'',pmds033,'',pmds034,pmds035, 
       pmds036,pmds037,'',pmds038,pmds039,'',pmds040,'',pmds012,'',pmds101,pmds102,pmds103,pmds048,pmds047, 
       pmds049,pmds053,'',pmds041,pmds043,pmds044,pmds046,pmds054,pmds055,pmds050,pmds057,pmds042,pmds058, 
       pmdsownid,'',pmdsowndp,'',pmdscrtid,'',pmdscrtdp,'',pmdscrtdt,pmdsmodid,'',pmdsmoddt,pmdscnfid, 
       '',pmdscnfdt,pmdspstid,'',pmdspstdt", 
                      " FROM pmds_t",
                      " WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
   #add-point:SQL_define name="main.after_define_sql"
            
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt520_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT DISTINCT t0.pmdssite,t0.pmdsdocno,t0.pmdsdocdt,t0.pmds001,t0.pmds002,t0.pmds003, 
       t0.pmdsstus,t0.pmds006,t0.pmds007,t0.pmds008,t0.pmds009,t0.pmds010,t0.pmds052,t0.pmds028,t0.pmds000, 
       t0.pmds100,t0.pmds011,t0.pmds014,t0.pmds081,t0.pmds045,t0.pmds021,t0.pmds022,t0.pmds023,t0.pmds024, 
       t0.pmds031,t0.pmds032,t0.pmds033,t0.pmds034,t0.pmds035,t0.pmds036,t0.pmds037,t0.pmds038,t0.pmds039, 
       t0.pmds040,t0.pmds012,t0.pmds101,t0.pmds102,t0.pmds103,t0.pmds048,t0.pmds047,t0.pmds049,t0.pmds053, 
       t0.pmds041,t0.pmds043,t0.pmds044,t0.pmds046,t0.pmds054,t0.pmds055,t0.pmds050,t0.pmds057,t0.pmds042, 
       t0.pmds058,t0.pmdsownid,t0.pmdsowndp,t0.pmdscrtid,t0.pmdscrtdp,t0.pmdscrtdt,t0.pmdsmodid,t0.pmdsmoddt, 
       t0.pmdscnfid,t0.pmdscnfdt,t0.pmdspstid,t0.pmdspstdt,t1.ooag011 ,t2.ooefl003 ,t3.pmaal004 ,t4.pmaal004 , 
       t5.pmaal004 ,t6.ooibl004 ,t7.oocql004 ,t8.ooail003 ,t9.pmaml003 ,t10.ooidl003 ,t11.oojdl003 , 
       t12.icaal003 ,t13.ooag011 ,t14.ooefl003 ,t15.ooag011 ,t16.ooefl003 ,t17.ooag011 ,t18.ooag011 , 
       t19.ooag011",
               " FROM pmds_t t0",
                              " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmds002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmds003 AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t3 ON t3.pmaalent="||g_enterprise||" AND t3.pmaal001=t0.pmds007 AND t3.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t4 ON t4.pmaalent="||g_enterprise||" AND t4.pmaal001=t0.pmds008 AND t4.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t5 ON t5.pmaalent="||g_enterprise||" AND t5.pmaal001=t0.pmds009 AND t5.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN ooibl_t t6 ON t6.ooiblent="||g_enterprise||" AND t6.ooibl002=t0.pmds031 AND t6.ooibl003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t7 ON t7.oocqlent="||g_enterprise||" AND t7.oocql001='238' AND t7.oocql002=t0.pmds032 AND t7.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooail_t t8 ON t8.ooailent="||g_enterprise||" AND t8.ooail001=t0.pmds037 AND t8.ooail002='"||g_dlang||"' ",
               " LEFT JOIN pmaml_t t9 ON t9.pmamlent="||g_enterprise||" AND t9.pmaml001=t0.pmds039 AND t9.pmaml002='"||g_dlang||"' ",
               " LEFT JOIN ooidl_t t10 ON t10.ooidlent="||g_enterprise||" AND t10.ooidl001=t0.pmds040 AND t10.ooidl002='"||g_dlang||"' ",
               " LEFT JOIN oojdl_t t11 ON t11.oojdlent="||g_enterprise||" AND t11.oojdl001=t0.pmds012 AND t11.oojdl002='"||g_dlang||"' ",
               " LEFT JOIN icaal_t t12 ON t12.icaalent="||g_enterprise||" AND t12.icaal001=t0.pmds053 AND t12.icaal002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t13 ON t13.ooagent="||g_enterprise||" AND t13.ooag001=t0.pmdsownid  ",
               " LEFT JOIN ooefl_t t14 ON t14.ooeflent="||g_enterprise||" AND t14.ooefl001=t0.pmdsowndp AND t14.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t15 ON t15.ooagent="||g_enterprise||" AND t15.ooag001=t0.pmdscrtid  ",
               " LEFT JOIN ooefl_t t16 ON t16.ooeflent="||g_enterprise||" AND t16.ooefl001=t0.pmdscrtdp AND t16.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t17 ON t17.ooagent="||g_enterprise||" AND t17.ooag001=t0.pmdsmodid  ",
               " LEFT JOIN ooag_t t18 ON t18.ooagent="||g_enterprise||" AND t18.ooag001=t0.pmdscnfid  ",
               " LEFT JOIN ooag_t t19 ON t19.ooagent="||g_enterprise||" AND t19.ooag001=t0.pmdspstid  ",
 
               " WHERE t0.pmdsent = " ||g_enterprise|| " AND t0.pmdsdocno = ?"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define name="main.after_refresh_sql"
   
   #end add-point
   PREPARE apmt520_master_referesh FROM g_sql
 
    
 
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
                        
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apmt520 WITH FORM cl_ap_formpath("apm",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apmt520_init()   
 
      #進入選單 Menu (="N")
      CALL apmt520_ui_dialog() 
      
      #add-point:畫面關閉前 name="main.before_close"
      CALL s_lot_ins_drop_tmp() 
      CALL s_lot_sel_drop_tmp()    
 
      CALL s_asft335_drop_tmp_table()   #151023-00018#1
      CALL apmt520_04_drop_tmp()  #130909-00003#58 add

      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_apmt520
      
   END IF 
   
   CLOSE apmt520_cl
   
   
 
   #add-point:作業離開前 name="main.exit"
            
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
 
 
 
{</section>}
 
{<section id="apmt520.init" >}
#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION apmt520_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point    
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
DEFINE l_gzze003  LIKE gzze_t.gzze003    
DEFINE l_success  LIKE type_t.num5  #151023-00018#1
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"
   
   #end add-point
   
   LET g_bfill       = "Y"
   LET g_detail_idx  = 1 #第一層單身指標
   LET g_detail_idx2 = 1 #第二層單身指標
   
   #各個page指標
   LET g_detail_idx_list[1] = 1 
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
 
   LET g_error_show  = 1
   LET l_ac = 1 #單身指標
      CALL cl_set_combo_scc_part('pmdsstus','13','N,Y,S,A,D,R,W,X,Z')
 
      CALL cl_set_combo_scc('pmds000','2060') 
   CALL cl_set_combo_scc('pmds100','2062') 
   CALL cl_set_combo_scc('pmds011','2061') 
   CALL cl_set_combo_scc('pmds014','2053') 
   CALL cl_set_combo_scc('pmds036','2026') 
   CALL cl_set_combo_scc('pmds103','8325') 
   CALL cl_set_combo_scc('pmds048','2087') 
   CALL cl_set_combo_scc('pmds049','2086') 
   CALL cl_set_combo_scc('pmds054','3086') 
   CALL cl_set_combo_scc('pmds057','4060') 
   CALL cl_set_combo_scc('pmdt083','5073') 
   CALL cl_set_combo_scc('pmdt005','2055') 
   CALL cl_set_combo_scc('pmdt025','2036') 
   CALL cl_set_combo_scc('pmdt040','2039') 
   CALL cl_set_combo_scc('pmdt052','2035') 
   CALL cl_set_combo_scc('pmdv005','2055') 
 
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #page群組
   LET g_idx_group = om.SaxAttributes.create()
   CALL g_idx_group.addAttribute("'1',","1")
   CALL g_idx_group.addAttribute("'2',","1")
   CALL g_idx_group.addAttribute("'3',","1")
 
 
   #add-point:畫面資料初始化 name="init.init"
   #161031-00025#15 add(s)
   CALL cl_ui_replace_sub_window(cl_ap_formpath("aoo", "aooi360_01"), "grid_remarks", "Table", "s_detail1_aooi360_01")
   CALL cl_set_combo_scc_part('ooff012','11','1,2,4')
   CALL cl_set_comp_visible("ooff003",FALSE)
   #161031-00025#15 add(e)
   #160801-00043#1--s
   #放到apmt520_init()中
   #品管參照表編號
   LET g_ooef025 = ''
   #SELECT ooef025 INTO g_ooef025 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site #160217-00002#1 mark
   LET g_ooef025 = cl_get_para(g_enterprise,g_site,'S-MFG-0046')   #160217-00002#1 add
   
   SELECT ooef019 INTO g_ooef019 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site  #160720-00015#1
   
   LET g_flag2 = FALSE
   #LET g_flag3 = TRUE
   LET g_upd_price = TRUE
   
   LET g_bas_0043 = ''
   LET g_bas_0043 = cl_get_para(g_enterprise,g_site,'S-BAS-0043')  #VMI存貨庫位Tag
   #160801-00043#1--e
   
   LET g_bas_0019 =  cl_get_para(g_enterprise,g_site,'S-BAS-0019') #是否使用计价单位  #161205-00025#3
   
   CALL cl_set_combo_scc('pmdt005_1','2055')
   CALL cl_set_combo_scc('pmdt040_1','2039')
   CALL cl_set_combo_scc('pmdu013','5073')
   CALL cl_set_combo_scc('pmdv005','2055')
   
   #子程式畫面取代主程式元件，嵌入製造批序號單身
   CALL cl_ui_replace_sub_window(cl_ap_formpath("sub", "s_lot_s01"), "grid_s_lot", "Table", "s_detail1_s_lot_s01")

   CALL s_lot_ins_create_tmp()
   CALL s_lot_sel_create_tmp()
   
   CALL s_asft335_cre_tmp_table() RETURNING l_success  #151023-00018#1
   
   #判斷據點參數若不使用參考單位時，則參考單位、數量需隱藏不可以維護(據點參數:S-BAS-0028)
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'N' THEN
      CALL cl_set_comp_visible("pmdt021,pmdt021_desc,pmdt022,pmdu011,pmdu011_desc,pmdu012",FALSE)
   END IF

   #判斷據點參數若不使用產品特徵時，則產品特徵需隱藏不可以維護(據點參數:S-BAS-0036)
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'N' THEN
      CALL cl_set_comp_visible("pmdo002_1,pmdo002_desc,pmdt007,pmdt007_desc,pmdu002,pmdu002_desc,pmdv002,pmdv002_desc,pmdt007_1,pmdt007_1_desc",FALSE)
   END IF

   #整體參數未使用採購計價單位
   #IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" THEN  #161205-00025#3
   IF g_bas_0019 = "N" THEN   #161205-00025#3
      CALL cl_set_comp_visible("pmdt023,pmdt023_desc,pmdt024,pmdt023_1,pmdt023_desc1,pmdt024_1",FALSE)
   END IF

   CALL cl_set_comp_visible("pmdt008,pmdt008_desc",FALSE)
   
   #g_argv[1] 參數說明
   #1.採購收貨單    apmt520      2.無採購收貨單 apmt522      3.採購收貨入庫單 apmt530  4.無採購收貨入庫單 apmt532
   #5.驗退單        apmt560      6.入庫單 apmt570           7.倉退單 apmt580
   #8.委外採購收貨單 apmt521      9.重覆性生產收貨單 apmt523 
   #10.委外驗退單    apmt561     11.重覆性生產驗退 apmt563
   #12.委外收貨入庫單 apmt571    13.重覆性生產入庫單 apmt573
   #14.委外倉退單    apmt581     15.重覆性生產倉退單 apmt583
   #20.委外採購收貨入庫單 apmt531
   #23.借貨採購收貨單 apmt524    24.借貨採購收貨入庫單 apmt534  25.借貨入庫單 apmt574   26.借貨歸還單  apmt584
   
   CALL cl_set_comp_visible("pmdu013,pmdu014,pmdu015",FALSE)
   
   IF g_argv[1] MATCHES '[1289]' THEN
      #判斷據點參數若收貨單不使用製造批序號時，則製造批序號頁簽需隱藏不可以維護(據點參數:S-BAS-0049)
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0049') = 'N' THEN
         CALL cl_set_comp_visible("page_8",FALSE)
      END IF
   END IF
   IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
      CALL cl_set_comp_visible("page_8",FALSE)
   END IF
   
   IF g_argv[1] MATCHES '[1234]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
      #不需要顯示單據性質欄位
      CALL cl_set_comp_visible("lbl_pmds000,pmds000",FALSE)
   END IF
   IF g_argv[1] MATCHES '[1234689]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '20' THEN
      #不需要顯示取回日期欄位
      CALL cl_set_comp_visible("lbl_pmds081,pmds081",FALSE)
   END IF
   IF g_argv[1] MATCHES '[1234789]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
      #不需要顯示 QC單號、QC評定項次、判定結果欄位
      CALL cl_set_comp_visible("pmdt081,pmdt082,pmdt083,pmdt083_desc",FALSE)
   END IF

   #170202-00018#1-(S)-add
   IF g_argv[1] = '5' THEN
      #不需要顯示 判定結果欄位
      CALL cl_set_comp_visible("pmdt083,pmdt083_desc",FALSE)
   END IF
   #170202-00018#1-(E)-add
   
   IF g_argv[1] MATCHES '[12345689]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '20' THEN
      #不需要顯示倉退類型欄位
      CALL cl_set_comp_visible("lbl_pmds100,pmds100,lbl_pmds101,pmds101,lbl_pmds102,pmds102,pmdt049,pmdt050",FALSE)
      CALL cl_set_comp_visible("lbl_pmds103,pmds103",FALSE) #160905-00016#1
   END IF
   
   IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26'  THEN
      #不需要顯示取價、付款信息等欄位
      #CALL cl_set_comp_visible("lbl_pmds039,pmds039,pmds039_desc,lbl_pmds040,pmds040,pmds040_desc",FALSE)
      CALL cl_set_comp_visible("lbl_pmds040,pmds040,pmds040_desc",FALSE)
   END IF

   IF g_argv[1] MATCHES '[12589]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '23' THEN
      #此作業單頭的狀態頁籤不需要呈現扣帳日期,最近過帳人員與過帳日期兩個欄位
      CALL cl_set_comp_visible("lbl_pmds001,pmds001,lbl_pmdspstid,pmdspstid,lbl_pmdspstdt,pmdspstdt",FALSE)
   END IF
   
   #IF g_argv[1] MATCHES '[135689]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
   #   #此作業單頭不需要呈現財務資訊頁籤
   #   CALL cl_set_comp_visible("page_5",FALSE)
   #END IF
   
   #IF g_argv[1] MATCHES '[1356789]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
   #   CALL cl_set_comp_visible("lbl_pmds012,pmds012,pmds012_desc",FALSE)
   #END IF

   IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
      #此作業單身"收貨明細頁籤"的單價、稅別、稅率、未稅金額、含稅金額、來源收貨單號，來源收貨項次需隱藏不可以維護
      CALL cl_set_comp_visible("pmdt036,pmdt046,pmdt046_desc,pmdt037,pmdt038,pmdt039,pmdt047,pmdt027,pmdt028",FALSE)
   END IF

   IF g_argv[1] MATCHES '[1234567]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
      #作業單身所有頁籤只要有作業編號、製程序的欄位均需隱藏、不可以維護，這兩個欄位只有委外收貨作業才可以維護
      CALL cl_set_comp_visible("pmdt009,pmdt009_desc,pmdt010,pmdu003,pmdu004,pmdv003,pmdv004,pmdt009_1,pmdt010_1",FALSE)
   END IF

   IF g_argv[1] MATCHES '[24]' THEN
      #作業單身採購單號欄位，需要隱藏不可以維護
      #所有頁籤只要有採購單號、採購項次、採購項序、分批序、子件特性、採購料號、採購產品特徵欄位均需隱藏ˋ不可以維      
      CALL cl_set_comp_visible("prog_pmds006,pmds006,pmdt001,pmdt002,pmdt003,pmdt004,pmdo001,imaal003,imaal004,pmdt027,pmdt028",FALSE)
      CALL cl_set_comp_visible("pmdo002_1,pmdo002_desc,pmdt001_1,pmdt002_1,pmdt003_1,pmdt004_1",FALSE)
      #單身的"原始需求分配明細"頁籤需要隱藏不可以維護
      CALL cl_set_comp_visible("page_4",FALSE)
   END IF
   #151111-00023#1-多加4的條件
   IF NOT (g_argv[1] MATCHES '[47]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26')  THEN
      #不需要顯示合約差異調整的欄位
      CALL cl_set_comp_visible("lbl_pmds054,pmds054,lbl_pmds055,pmds055,pmdt070,pmdt071",FALSE)
   END IF
   
   #借貨歸還單，倉退類型隱藏
   IF g_argv[1] = '26' THEN
      CALL cl_set_comp_visible("lbl_pmds100,pmds100",FALSE)
   END IF
      
   IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26'   THEN
      #不需要顯示來源單號、項序、分批序等欄位
      #CALL cl_set_comp_visible("pmdt001,pmdt002,pmdt003,pmdt004",FALSE)
      CALL cl_set_comp_visible("pmdt027,pmdo001,imaal003,imaal004,pmdo002,pmdo002_1,pmdo002_desc,pmdt025,pmdt011",FALSE) #160407-00010#1 add pmdo002_1
      CALL cl_set_comp_visible("pmdt036,pmdt046,pmdt046_desc,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt041",FALSE)
      CALL cl_set_comp_visible("pmdt040,pmdt052,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061",FALSE)
      #CALL cl_set_comp_visible("page_3",FALSE)
      CALL cl_set_comp_visible("pmdvseq1",FALSE)
      CALL cl_set_comp_visible("pmdu013,pmdu014,pmdu015",FALSE)
   END IF

   IF g_argv[1] MATCHES '[57]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
      #不需要原始需求分配頁簽
      CALL cl_set_comp_visible("page_4",FALSE)
      CALL cl_set_comp_visible("pmds052",FALSE)  #供應商出貨日
   END IF
   
   #借貨歸還單才顯示借貨還價數量、金額等，其他作業不顯示
   IF g_argv[1] <> '26' THEN
       CALL cl_set_comp_visible("pmdt090,pmdt091,pmdt092,pmdt093",FALSE)
   END IF
   
   #160128-00023#1---add---begin---
   #委外入庫單顯示倒扣領料單號
   IF NOT ( g_argv[1] = '12' OR g_argv[1] = '20') THEN
      CALL cl_set_comp_visible("lbl_pmds058,pmds058",FALSE)
   END IF
   #160128-00023#1---add---end---

   IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
      #收貨單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00420' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)

      #收貨日期
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00421' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocdt',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocdt',l_gzze003)

      #收貨人員
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00422' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds002',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds002',l_gzze003)

      #收貨部門
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00423' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmds003',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds003',l_gzze003)
   END IF

   IF g_argv[1] MATCHES '[34567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
      #單身的限定庫位、限定儲位、限定批號名稱更新成庫位、儲位、批號    
      #庫位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00426' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt016',l_gzze003)

      #儲位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00427' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt017',l_gzze003)

      #批號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00428' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt018',l_gzze003)
   END IF

   #驗退單 apmt560
   IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN
      #驗退資訊頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00445' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('master_Folder_page',l_gzze003)

      #驗退明細頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00446' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('bpage_1',l_gzze003)

      #驗退單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00436' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)

      #驗退日期
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00437' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocdt',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocdt',l_gzze003)

      #驗退人員
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00438' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds002',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds002',l_gzze003)

      #驗退部門
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00439' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmds003',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds003',l_gzze003)
      
      ##收貨項次
      #LET l_gzze003 = ' '
      #SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00457' AND gzze002 = g_dlang
      #CALL cl_set_comp_att_text('pmdt002',l_gzze003)

      #驗退料號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00440' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt006',l_gzze003)
      CALL cl_set_comp_att_text('pmdt006_1',l_gzze003)
      CALL cl_set_comp_att_text('pmdv001',l_gzze003)

      ##驗退產品特徵
      #LET l_gzze003 = ' '
      #SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00441' AND gzze002 = g_dlang
      #CALL cl_set_comp_att_text('pmdt007',l_gzze003)
      #CALL cl_set_comp_att_text('pmdt007_1',l_gzze003)
      #CALL cl_set_comp_att_text('pmdv002',l_gzze003)

      #驗退單位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00442' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt019',l_gzze003)
      CALL cl_set_comp_att_text('pmdt019_1',l_gzze003)
      CALL cl_set_comp_att_text('pmdv018',l_gzze003)

      #驗退數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00443' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt020',l_gzze003)
      CALL cl_set_comp_att_text('pmdt020_1',l_gzze003)

      #驗退分配數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00444' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdv019',l_gzze003)

   END IF

   IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
      #收貨單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00420' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds006',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds006',l_gzze003)
      #CALL cl_set_comp_att_text('pmdt001',l_gzze003)

   END IF
   
   #入庫單 apmt570
   IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25'  THEN
      #入庫資訊頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00499' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('master_Folder_page',l_gzze003)

      #入庫明細頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00500' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('bpage_1',l_gzze003)

      #入庫單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00501' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)

      #入庫日期
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00502' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocdt',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocdt',l_gzze003)

      #入庫人員
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00503' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds002',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds002',l_gzze003)

      #入庫部門
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00504' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmds003',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds003',l_gzze003)
      
      ##收貨項次
      #LET l_gzze003 = ' '
      #SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00457' AND gzze002 = g_dlang
      #CALL cl_set_comp_att_text('pmdt002',l_gzze003)

      #入庫料號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00505' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt006',l_gzze003)
      CALL cl_set_comp_att_text('pmdt006_1',l_gzze003)
      CALL cl_set_comp_att_text('pmdv001',l_gzze003)

      ##入庫產品特徵
      #LET l_gzze003 = ' '
      #SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00506' AND gzze002 = g_dlang
      #CALL cl_set_comp_att_text('pmdt007',l_gzze003)
      #CALL cl_set_comp_att_text('pmdt007_1',l_gzze003)
      #CALL cl_set_comp_att_text('pmdv002',l_gzze003)

      #入庫單位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00507' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt019',l_gzze003)
      CALL cl_set_comp_att_text('pmdt019_1',l_gzze003)
      CALL cl_set_comp_att_text('pmdv018',l_gzze003)

      #入庫數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00508' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt020',l_gzze003)
      CALL cl_set_comp_att_text('pmdt020_1',l_gzze003)

      #入庫分配數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00509' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdv019',l_gzze003)

   END IF
   
   #倉退單 apmt580
   IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26'  THEN
      #倉退資訊頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00510' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('master_Folder_page',l_gzze003)

      #倉退明細頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00521' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('page_5',l_gzze003)
      
      #折讓資訊頁簽
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00511' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('bpage_1',l_gzze003)

      #倉退單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00512' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)

      #倉退日期
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00513' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocdt',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocdt',l_gzze003)

      #倉退人員
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00514' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds002',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds002',l_gzze003)

      #倉退部門
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00515' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmds003',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds003',l_gzze003)
      
      ##收貨項次
      #LET l_gzze003 = ' '
      #SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00457' AND gzze002 = g_dlang
      #CALL cl_set_comp_att_text('pmdt002',l_gzze003)

      #倉退料號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00516' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt006',l_gzze003)
      CALL cl_set_comp_att_text('pmdt006_1',l_gzze003)
      CALL cl_set_comp_att_text('pmdv001',l_gzze003)

      ##倉退產品特徵
      #LET l_gzze003 = ' '
      #SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00517' AND gzze002 = g_dlang
      #CALL cl_set_comp_att_text('pmdt007',l_gzze003)
      #CALL cl_set_comp_att_text('pmdt007_1',l_gzze003)
      #CALL cl_set_comp_att_text('pmdv002',l_gzze003)

      #倉退單位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00518' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt019',l_gzze003)
      CALL cl_set_comp_att_text('pmdt019_1',l_gzze003)
      CALL cl_set_comp_att_text('pmdv018',l_gzze003)

      #倉退數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00519' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt020',l_gzze003)
      CALL cl_set_comp_att_text('pmdt020_1',l_gzze003)

   END IF
   
   #23.借貨採購收貨單 apmt524    24.借貨採購收貨入庫單 apmt534  25.借貨入庫單 apmt574   26.借貨歸還單  apmt584
   #借貨採購收貨單 apmt524
   IF g_argv[1] = '23' OR g_argv[1] = '24' THEN
      #借货收貨單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00865' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)
      
      #借货採購單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00853' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds006',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds006',l_gzze003)
   END IF
   
   IF g_argv[1] = '25' THEN 
      #借货入庫單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00866' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)
   END IF
   
   IF g_argv[1] = '26' THEN 
      #借货歸還單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00867' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocno',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocno',l_gzze003)

      #歸還日期
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00868' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdsdocdt',l_gzze003)
      CALL cl_set_comp_att_text('b_pmdsdocdt',l_gzze003)

      #歸還人員
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00869' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds002',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds002',l_gzze003)

      #歸還部門
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00870' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmds003',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds003',l_gzze003)
      
      #借貨料號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00891' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt006,pmdu001,pmdv001,pmdt006_1',l_gzze003)
      
      #借貨單位
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00892' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt019,pmdt019_1',l_gzze003)
      
      #借貨還量數量
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'axm-00536' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('pmdt020,pmdt020_1',l_gzze003)

   END IF
   
   
   IF g_argv[1] = '25' OR g_argv[1] = '26' THEN 
      #借货收貨單號
      LET l_gzze003 = ' '
      SELECT gzze003 INTO l_gzze003 FROM gzze_t WHERE gzze001 = 'apm-00865' AND gzze002 = g_dlang
      CALL cl_set_comp_att_text('prog_pmds006',l_gzze003)
      CALL cl_set_comp_att_text('b_pmds006',l_gzze003)
   END IF
   

   #委外、重覆性生產，先隱藏 單據性質
   IF g_argv[1] = '8' OR g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14' OR  g_argv[1] = '9' OR g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
      CALL cl_set_comp_visible("lbl_pmds000,pmds000",FALSE)
   END IF
   
   #收貨、入庫、倉退下顯示先隱藏價格頁簽
   #IF g_argv[1] MATCHES '[1346789]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
       CALL cl_set_comp_visible("page_7",FALSE)
   #END IF
   
   #151201-00008#1 By shiun--(S)
   IF g_argv[1] = '7' THEN
      CALL cl_set_comp_required("pmdt051",TRUE)
   END IF
   #151201-00008#1 By shiun--(E)
   
   #隱藏toolbar下拉中的ACTION 菜單
   CALL apmt520_act_visible_init()
   
   #151210-00009#1  2015/12/30 By earl s
   IF cl_get_para(g_enterprise,'','E-BAS-0018') = 'Y' THEN
      LET g_aic_doc = TRUE
   ELSE
      LET g_aic_doc = FALSE
   END IF
   #151210-00009#1  2015/12/30 By earl e
   CALL s_aooi200_filter_slip('pmdsdocno') RETURNING g_slip_wc    #160510-00043#2
   #end add-point
   
   #初始化搜尋條件
   CALL apmt520_default_search()
    
END FUNCTION
 
{</section>}
 
{<section id="apmt520.ui_dialog" >}
#+ 功能選單
PRIVATE FUNCTION apmt520_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_idx     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE lb_first   BOOLEAN
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE la_output  DYNAMIC ARRAY OF STRING   #報表元件鬆耦合使用
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   DEFINE l_success  LIKE type_t.num5 
   DEFINE l_n        LIKE type_t.num5 
   DEFINE l_n1       LIKE type_t.num5
   DEFINE l_n2       LIKE type_t.num5   
   DEFINE l_slip     LIKE oobal_t.oobal002
   DEFINE l_prog     LIKE oobx_t.oobx004
   DEFINE l_type     LIKE pmds_t.pmds000
   DEFINE l_pmdl005  LIKE pmdl_t.pmdl005
   DEFINE tran_master RECORD
                    wc  STRING
                    END RECORD
   DEFINE l_tran      STRING
   DEFINE l_amount  LIKE pmdt_t.pmdt020
   DEFINE l_pmdt026 LIKE pmdt_t.pmdt026
   DEFINE l_pmdt081 LIKE pmdt_t.pmdt081
   DEFINE l_pmdt082 LIKE pmdt_t.pmdt082
   DEFINE l_pmdt028 LIKE pmdt_t.pmdt028
   DEFINE l_inao013 LIKE inao_t.inao013
   DEFINE l_pmdtdocno LIKE pmdt_t.pmdtdocno
   DEFINE l_pmdtseq_1 LIKE pmdt_t.pmdtseq
   #add--2015/08/27 By shiun--(S)
   DEFINE l_cnt      LIKE type_t.num10
   DEFINE l_cnt2     LIKE type_t.num10
   #add--2015/08/27 By shiun--(E)
   
   DEFINE l_pmdu006        LIKE pmdu_t.pmdu006
   DEFINE l_pmdu007        LIKE pmdu_t.pmdu007
   DEFINE l_pmdu008        LIKE pmdu_t.pmdu008
   DEFINE l_pmdu005        LIKE pmdu_t.pmdu005   #160316-00007#3 add
   
   DEFINE l_start_no    LIKE sffb_t.sffbdocno   #151023-00018#1 add
   DEFINE l_end_no      LIKE sffb_t.sffbdocno   #151023-00018#1 add
   
   #end add-point
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"
   
   #end add-point
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   #因應查詢方案進行處理
   IF g_default THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   ELSE
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF
   
   #action default動作
   #應用 a42 樣板自動產生(Version:3)
   #進入程式時預設執行的動作
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL apmt520_insert()
            #add-point:ON ACTION insert name="menu.default.insert"
                                                
            #END add-point
         END IF
 
      #add-point:action default自訂 name="ui_dialog.action_default"
                        
      #end add-point
      OTHERWISE
   END CASE
 
 
 
   
   LET lb_first = TRUE
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"
            
   #end add-point
   
   WHILE TRUE 
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_pmds_m.* TO NULL
         CALL g_pmdt_d.clear()
         CALL g_pmdt2_d.clear()
         CALL g_pmdt3_d.clear()
 
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL apmt520_init()
      END IF
   
      CALL lib_cl_dlg.cl_dlg_before_display()
            
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
         #左側瀏覽頁簽
         DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)
            BEFORE ROW
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE
         
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF 
               
               CALL apmt520_fetch('') # reload data
               LET l_ac = 1
               CALL apmt520_ui_detailshow() #Setting the current row 
         
               CALL apmt520_idx_chk()
               #NEXT FIELD pmdtseq
         
               ON ACTION qbefield_user   #欄位隱藏設定 
                  LET g_action_choice="qbefield_user"
                  CALL cl_ui_qbefield_user()
         END DISPLAY
    
         DISPLAY ARRAY g_pmdt_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt520_idx_chk()
               #確定當下選擇的筆數
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[1] = l_ac
               CALL g_idx_group.addAttribute("'1',",l_ac)
               
               #add-point:page1, before row動作 name="ui_dialog.page1.before_row"
               CALL apmt520_set_act_visible_b()
               CALL apmt520_set_act_no_visible_b()                                               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_current_page = 1
               #顯示單身筆數
               CALL apmt520_idx_chk()
               #add-point:page1自定義行為 name="ui_dialog.page1.before_display"
                                                            
               #end add-point
               
            #自訂ACTION(detail_show,page_1)
            
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_asft335
            LET g_action_choice="gen_asft335"
            IF cl_auth_chk_act("gen_asft335") THEN
               
               #add-point:ON ACTION gen_asft335 name="menu.detail_show.page1.gen_asft335"
               #151023-00018#1---add---begin----
               #委外入庫單產生報工單
               IF NOT cl_null(g_pmds_m.pmdsdocno) AND l_ac > 0 THEN
                  IF (NOT cl_null(g_pmdt_d[l_ac].pmdt009)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt010)) AND g_pmdt_d[l_ac].pmdt005 <> '8' THEN  #委外代買料不需要產生報工單

                     CALL s_transaction_begin()
                     CALL cl_err_collect_init() 
                     CALL s_apmt520_gen_asft335('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010) RETURNING l_success,l_start_no,l_end_no
                     CALL cl_err_collect_show()   
                     IF NOT l_success THEN
                        CALL s_transaction_end('N','0')
                     ELSE
                        IF NOT cl_null(l_start_no) THEN
                           CALL s_transaction_end('Y','0')
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'aap-00125'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           LET g_errparam.replace[1] = l_start_no
                           CALL cl_err()
                        ELSE
                           CALL s_transaction_end('N','0')
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'agl-00167'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                        END IF
                     END IF

                  END IF
               END IF
               #151023-00018#1---add---end----
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_asft340
            LET g_action_choice="gen_asft340"
            IF cl_auth_chk_act("gen_asft340") THEN
               
               #add-point:ON ACTION gen_asft340 name="menu.detail_show.page1.gen_asft340"
               #151023-00018#1---add---begin----
               #委外入庫單產生工單入庫單
               IF NOT cl_null(g_pmds_m.pmdsdocno) AND l_ac > 0 THEN
                  IF (NOT cl_null(g_pmdt_d[l_ac].pmdt009)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt010)) AND g_pmdt_d[l_ac].pmdt005 <> '8' THEN  #委外代買料不需要產生報工單
                     
                     CALL s_transaction_begin()
                     CALL cl_err_collect_init() 
                     CALL s_apmt520_gen_asft340('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010) RETURNING l_success,l_start_no,l_end_no
                     CALL cl_err_collect_show()   
                     IF NOT l_success THEN
                        CALL s_transaction_end('N','0')
                     ELSE
                        IF NOT cl_null(l_start_no) THEN
                           CALL s_transaction_end('Y','0')
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'aap-00125'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           LET g_errparam.replace[1] = l_start_no
                           CALL cl_err()
                        ELSE
                           CALL s_transaction_end('N','0')
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'agl-00167'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                        END IF
                     END IF
                     
                  END IF
               END IF
               #151023-00018#1---add---end----
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION detail_qrystr
               MENU "" ATTRIBUTE(STYLE="popup")
                  #add-point:ON ACTION detail_qrystr相關動作 name="menu.detail_show.page1_sub.detail_qrystr"
                  
                  #END add-point
                                 #應用 a43 樣板自動產生(Version:4)
               ON ACTION prog_apmt500
                  LET g_action_choice="prog_apmt500"
                  IF cl_auth_chk_act("prog_apmt500") THEN
                     
                     #add-point:ON ACTION prog_apmt500 name="menu.detail_show.page1_sub.prog_apmt500"
                     #應用 a41 樣板自動產生(Version:2)
                     #使用JSON格式組合參數與作業編號(串查)
                     
                     #抓取單據別
                     LET l_slip = ''
                     LET l_prog = ''
                     IF l_ac > 0 THEN
                        IF NOT cl_null(g_pmdt_d[l_ac].pmdt001) THEN
                           #161209-00043#1--s
                           #因为委外采购单的单号，是由工单单号直接抛转过来的，所以对应的单别性质是工单，但串查时，应串到委外采购单上
                           IF g_argv[1] MATCHES '[89]' OR g_argv[1] = '20' THEN
                              INITIALIZE la_param.* TO NULL
                              LET la_param.prog     = 'apmt501'
                              LET la_param.param[1] = g_pmdt_d[l_ac].pmdt001
                              
                              LET ls_js = util.JSON.stringify(la_param)
                              CALL cl_cmdrun(ls_js)
                           ELSE
                           #161209-00043#1---e
                              CALL s_aooi200_get_slip(g_pmdt_d[l_ac].pmdt001) RETURNING l_success,l_slip
                              IF NOT cl_null(l_slip) THEN
                                 SELECT oobx004 INTO l_prog
                                   FROM oobx_t
                                  WHERE oobxent = g_enterprise
                                    AND oobx001 = l_slip
                              END IF
                              IF NOT cl_null(l_prog) THEN
                                 INITIALIZE la_param.* TO NULL
                                 LET la_param.prog     = l_prog
                                 LET la_param.param[1] = g_pmdt_d[l_ac].pmdt001
                                 
                                 LET ls_js = util.JSON.stringify(la_param)
                                 CALL cl_cmdrun(ls_js)
                              END IF
                           END IF  #161209-00043#1
                        END IF 
                     END IF
                     #END add-point
                     
                  END IF
 
 
 
 
               END MENU
 
 
 
               #add-point:ON ACTION detail_qrystr name="menu.detail_show.page1.detail_qrystr"
               
               #END add-point
 
 
 
 
               
            #add-point:page1自定義行為 name="ui_dialog.page1.action"
                                                
            #end add-point
               
         END DISPLAY
        
         #第一階單身段落
         DISPLAY ARRAY g_pmdt2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt520_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[2] = l_ac
               CALL g_idx_group.addAttribute("'2',",l_ac)
               
               #add-point:page2, before row動作 name="ui_dialog.body2.before_row"
               CALL apmt520_set_act_visible_b()
               CALL apmt520_set_act_no_visible_b()               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_current_page = 2
               #顯示單身筆數
               CALL apmt520_idx_chk()
               #add-point:page2自定義行為 name="ui_dialog.body2.before_display"
                                                            
               #end add-point
      
            #自訂ACTION(detail_show,page_2)
            
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION s_lot_ins
            LET g_action_choice="s_lot_ins"
            IF cl_auth_chk_act("s_lot_ins") THEN
               
               #add-point:ON ACTION s_lot_ins name="menu.detail_show.page2.s_lot_ins"
               IF cl_null(g_detail_idx) OR g_detail_idx = 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'abm-00073'
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  EXIT DIALOG
               END IF
               
               IF g_pmds_m.pmdsstus <> 'N' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00035'
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  EXIT DIALOG
               END IF
               
               IF NOT cl_null(g_pmds_m.pmdsdocno) AND
                  NOT cl_null(g_pmdt2_d[g_detail_idx].pmduseq) AND
                  NOT cl_null(g_pmdt2_d[g_detail_idx].pmduseq1) AND
                  NOT cl_null(g_pmdt2_d[g_detail_idx].pmdu001) AND
                  NOT cl_null(g_pmdt2_d[g_detail_idx].pmdu009) AND
                  NOT cl_null(g_pmdt2_d[g_detail_idx].pmdu010) AND
                  NOT cl_null(g_pmds_m.pmds007) THEN
                  LET l_success = ''
                  LET l_amount = ''
                  CALL s_transaction_begin()
                  
                  SELECT pmdt026,pmdt081,pmdt082,pmdt028 INTO l_pmdt026,l_pmdt081,l_pmdt082,l_pmdt028 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt2_d[g_detail_idx].pmduseq
                  #CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'2',g_pmds_m.pmds007,'1','')
                  #   RETURNING l_success,l_amount
                  
                  #判斷據點參數若收貨單使用製造批序號時，則製造批序號頁簽可以維護(據點參數:S-BAS-0049)
                  IF g_argv[1] MATCHES '[1289]' THEN
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0049') = 'Y' THEN
                        CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'2',g_pmds_m.pmds007,'1','',g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu005)  #160316-00007#3 add pmdu005
                           RETURNING l_success,l_amount
                     END IF
                  END IF
                  
                  #直接收貨入庫單
                  IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '20' THEN
                     CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'2',g_pmds_m.pmds007,'1','',g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu005)  #160316-00007#3 add pmdu005
                        RETURNING l_success,l_amount
                  END IF
                  
                  #驗退單、入庫單
                  #1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
                  #1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
                  #1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
                  IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                     SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = l_pmdt028
                     IF l_n > 0 THEN
                        #SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt2_d[g_detail_idx].pmduseq AND inaoseq1 = g_pmdt2_d[g_detail_idx].pmduseq1
                        #IF cl_null(l_n) OR l_n = 0 THEN
                           #驗退、入庫、倉退單據，賦值來源單據的製造批序號資料inao_t
                           CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) RETURNING l_success
                           IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                              IF l_pmdt026 = 'Y' THEN
                                 IF NOT s_apmt520_ins_inao('1',l_pmdt081,l_pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) THEN
                                    #LET r_success = FALSE
                                    #RETURN r_success
                                 END IF
                              ELSE
                                 IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,l_pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) THEN
                                    #LET r_success = FALSE
                                    #RETURN r_success
                                 END IF
                              END IF
                           END IF
                        #END IF
                        CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu005,g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'1',g_prog,'','','','','0')
                           RETURNING l_success
                        CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) RETURNING l_success
                     ELSE
                        IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                           CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'2',g_pmds_m.pmds007,'1','',g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu005)  #160316-00007#3 add pmdu005
                              RETURNING l_success,l_amount
                        END IF
                     END IF
                  END IF
                  
                  #仓退单：若有指定收货单号：
                  #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
                  #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
                  #若没有指定收货单号则直接由库存档选取
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                     IF NOT cl_null(g_pmds_m.pmds006) THEN
                        #SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = l_pmdt028
                        #IF l_n > 0 THEN
                           #SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt2_d[g_detail_idx].pmduseq AND inaoseq1 = g_pmdt2_d[g_detail_idx].pmduseq1
                           #IF cl_null(l_n) OR l_n = 0 THEN
                              CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,'') RETURNING l_success
                              DECLARE sel_pmdt_cs3 CURSOR FOR
                                  SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                     WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno 
                                       AND pmdsent = g_enterprise 
                                       AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = l_pmdt028 AND pmds000 IN ('6','12','13'))
                                          OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = l_pmdt028 AND pmds000 IN ('3','4','20')))
                                       AND pmdsstus = 'S'
                              FOREACH sel_pmdt_cs3 INTO l_pmdtdocno,l_pmdtseq_1
                                 IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) THEN
                                    #LET r_success = FALSE
                                    #RETURN r_success
                                 END IF
                              END FOREACH
                           #END IF
                           CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu005,g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'-1',g_prog,'','','','','0')
                              RETURNING l_success
                           CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) RETURNING l_success   
                     ELSE
                         CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002,g_pmdt2_d[g_detail_idx].pmdu005,g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,'-1',g_prog,'','','','','0')
                            RETURNING l_success
                     END IF
                  END IF
                  
                  IF l_success THEN
                     CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) RETURNING l_success
                     CALL s_transaction_end('Y','0')
                  ELSE
                     CALL s_transaction_end('N','0')  
                  END IF
                  #倉退單，出入庫碼為出庫，其餘為入庫
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                     LET l_inao013 = '-1'
                  ELSE
                     LET l_inao013 = '1'
                  END IF
                  CALL s_lot_b_fill('1',g_site,'2',g_pmds_m.pmdsdocno,'','',l_inao013)  
               END IF
               #END add-point
               
            END IF
 
 
 
 
         
            #add-point:page2自定義行為 name="ui_dialog.body2.action"
                                                
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdt3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt520_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[3] = l_ac
               CALL g_idx_group.addAttribute("'3',",l_ac)
               
               #add-point:page3, before row動作 name="ui_dialog.body3.before_row"
                                                            
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 3
               #顯示單身筆數
               CALL apmt520_idx_chk()
               #add-point:page3自定義行為 name="ui_dialog.body3.before_display"
                                                            
               #end add-point
      
            #自訂ACTION(detail_show,page_3)
            
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION detail_qrystr
               MENU "" ATTRIBUTE(STYLE="popup")
                  #add-point:ON ACTION detail_qrystr相關動作 name="menu.detail_show.page3_sub.detail_qrystr"
                  
                  #END add-point
                                 #應用 a43 樣板自動產生(Version:4)
               ON ACTION prog_apmt400
                  LET g_action_choice="prog_apmt400"
                  IF cl_auth_chk_act("prog_apmt400") THEN
                     
                     #add-point:ON ACTION prog_apmt400 name="menu.detail_show.page3_sub.prog_apmt400"
                     #應用 a41 樣板自動產生(Version:2)
                     #使用JSON格式組合參數與作業編號(串查)
                     #抓取單據別
                     LET l_slip = ''
                     LET l_prog = ''
                     IF l_ac > 0 THEN
                        IF NOT cl_null(g_pmdt3_d[l_ac].pmdv014) THEN
                           CALL s_aooi200_get_slip(g_pmdt3_d[l_ac].pmdv014) RETURNING l_success,l_slip
                           IF NOT cl_null(l_slip) THEN
                              SELECT oobx004 INTO l_prog
                                FROM oobx_t
                               WHERE oobxent = g_enterprise
                                 AND oobx001 = l_slip
                           END IF
                           IF NOT cl_null(l_prog) THEN
                              INITIALIZE la_param.* TO NULL
                              LET la_param.prog     = l_prog
                              LET la_param.param[1] = g_pmdt3_d[l_ac].pmdv014
                             
                              LET ls_js = util.JSON.stringify(la_param)
                              CALL cl_cmdrun(ls_js)
                           END IF
                        END IF
                     END IF

                     #END add-point
                     
                  END IF
 
 
 
 
               END MENU
 
 
 
               #add-point:ON ACTION detail_qrystr name="menu.detail_show.page3.detail_qrystr"
               
               #END add-point
 
 
 
 
         
            #add-point:page3自定義行為 name="ui_dialog.body3.action"
                                                
            #end add-point
         
         END DISPLAY
 
         
 
         
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         DISPLAY ARRAY g_pmdt4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx = l_ac
               
            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_current_page = 4
         
         END DISPLAY 

         SUBDIALOG sub_s_lot.s_lot_display
         SUBDIALOG aoo_aooi360_01.aooi360_01_display #161031-00025#15 add
         #end add-point
         
         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
         SUBDIALOG lib_cl_dlg.cl_dlg_relateapps
      
         BEFORE DIALOG
            #先填充browser資料
            CALL apmt520_browser_fill("")
            CALL cl_notice()
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               LET g_current_idx = g_current_row
            END IF
            
            #確保g_current_idx位於正常區間內
            #小於,等於0則指到第1筆
            IF g_current_idx <= 0 THEN
               LET g_current_idx = 1
            END IF
            #超過最大筆數則指到最後1筆
            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF 
            
            LET g_current_sw = TRUE
            LET g_current_row = g_current_idx #目前指標
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL apmt520_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL apmt520_ui_detailshow() #Setting the current row 
            
            #筆數顯示
            LET g_current_page = 1
            CALL apmt520_idx_chk()
            CALL cl_ap_performance_cal()
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            ON ACTION lot_page
               LET g_detail_id = "lot_page"
               NEXT FIELD inaoseq                                    
            #end add-point
 
         #add-point:ui_dialog段more_action name="ui_dialog.more_action"
          #161031-00025#15 add(s)
         ON ACTION remarks_page
            LET g_detail_id = "remarks_page"
            NEXT FIELD ooff012
         #161031-00025#15 add(e)
         #end add-point
 
         #狀態碼切換
         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL apmt520_statechange()
            #根據資料狀態切換action狀態
            CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
            CALL apmt520_set_act_visible()   
            CALL apmt520_set_act_no_visible()
            IF NOT (g_pmds_m.pmdsdocno IS NULL
 
              ) THEN
               #組合條件
               LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                                  " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
               #填到對應位置
               CALL apmt520_browser_fill("")
            END IF
         #應用 a32 樣板自動產生(Version:3)
         #簽核狀況
         ON ACTION bpm_status
            #查詢簽核狀況, 統一建立HyperLink
            CALL cl_bpm_status()
            #add-point:ON ACTION bpm_status name="menu.bpm_status"
            
            #END add-point
 
 
 
          
         #查詢方案選擇 
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "pmds_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdt_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdu_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdv_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
 
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               CALL apmt520_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF
         
         #查詢方案選擇
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "pmds_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdt_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdu_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdv_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL apmt520_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "" 
                     LET g_errparam.code = "-100" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL apmt520_fetch("F")
                  END IF
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()
          
         #應用 a49 樣板自動產生(Version:4)
            #過濾瀏覽頁資料
            ON ACTION filter
               LET g_action_choice = "fetch"
               #add-point:filter action name="ui_dialog.action.filter"
               
               #end add-point
               CALL apmt520_filter()
               EXIT DIALOG
 
 
 
         
         ON ACTION first
            LET g_action_choice = "fetch"
            CALL apmt520_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt520_idx_chk()
            
         ON ACTION previous
            LET g_action_choice = "fetch"
            CALL apmt520_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt520_idx_chk()
            
         ON ACTION jump
            LET g_action_choice = "fetch"
            CALL apmt520_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt520_idx_chk()
            
         ON ACTION next
            LET g_action_choice = "fetch"
            CALL apmt520_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt520_idx_chk()
            
         ON ACTION last
            LET g_action_choice = "fetch"
            CALL apmt520_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt520_idx_chk()
          
         #excel匯出功能          
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               #browser
               CALL g_export_node.clear()
               IF g_main_hidden = 1 THEN
                  LET g_export_node[1] = base.typeInfo.create(g_browser)
                  LET g_export_id[1]   = "s_browse"
                  CALL cl_export_to_excel()
               #非browser
               ELSE
                  LET g_export_node[1] = base.typeInfo.create(g_pmdt_d)
                  LET g_export_id[1]   = "s_detail1"
                  LET g_export_node[2] = base.typeInfo.create(g_pmdt2_d)
                  LET g_export_id[2]   = "s_detail2"
                  LET g_export_node[3] = base.typeInfo.create(g_pmdt3_d)
                  LET g_export_id[3]   = "s_detail3"
 
                  #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
                  LET g_export_node[4] = base.typeInfo.create(g_pmdt4_d)
                  LET g_export_id[4]   = "s_detail4"
                  
                  LET g_export_node[5] = base.typeInfo.create(g_inao_d)
                  LET g_export_id[5]   = "s_detail1_s_lot_s01"
                  #161031-00025#15 add(s)
                  LET g_export_node[6] = base.typeInfo.create(g_ooff_d4)
                  LET g_export_id[6]   = "s_detail1_aooi360_01"
                  #161031-00025#15 add(e)
                  #END add-point
                  CALL cl_export_to_excel_getpage()
                  CALL cl_export_to_excel()
               END IF
            END IF
        
         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
    
         #主頁摺疊
         ON ACTION mainhidden       
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
               CALL cl_notice()
            END IF
            
         #瀏覽頁折疊
         ON ACTION worksheethidden   
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF
            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD pmdtseq
            END IF
       
         #單頭摺疊，可利用hot key "Alt-s"開啟/關閉單頭
         ON ACTION controls     
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF
    
         
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_pmdv
            LET g_action_choice="gen_pmdv"
            IF cl_auth_chk_act("gen_pmdv") THEN
               
               #add-point:ON ACTION gen_pmdv name="menu.gen_pmdv"
               IF (NOT cl_null(g_pmds_m.pmdsdocno)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdtseq)) THEN
                  CALL apmt520_02(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
                  CALL apmt520_b_fill()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_pmdw
            LET g_action_choice="gen_pmdw"
            IF cl_auth_chk_act("gen_pmdw") THEN
               
               #add-point:ON ACTION gen_pmdw name="menu.gen_pmdw"
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL apmt520_05(g_pmds_m.pmdsdocno)
                  SELECT pmds038 INTO g_pmds_m.pmds038 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno =g_pmds_m.pmdsdocno
                  DISPLAY BY NAME g_pmds_m.pmds038
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL apmt520_modify()
               #add-point:ON ACTION modify name="menu.modify"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL apmt520_modify()
               #add-point:ON ACTION modify_detail name="menu.modify_detail"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_check_back
            LET g_action_choice="query_check_back"
            IF cl_auth_chk_act("query_check_back") THEN
               
               #add-point:ON ACTION query_check_back name="menu.query_check_back"
               #串查到驗退單
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
               INITIALIZE la_param.* TO NULL #161005-00037#1 add
                  CASE g_argv[1]
                     WHEN '1' LET la_param.prog = 'apmt560'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '2' LET la_param.prog = 'apmt560'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '8' LET la_param.prog = 'apmt561'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '9' LET la_param.prog = 'apmt563'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                  END CASE
                  #CALL cl_cmdrun_wait(ls_js)
                  CALL cl_cmdrun(ls_js)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_detail_aapt110_01
            LET g_action_choice="query_detail_aapt110_01"
            IF cl_auth_chk_act("query_detail_aapt110_01") THEN
               
               #add-point:ON ACTION query_detail_aapt110_01 name="menu.query_detail_aapt110_01"
               #明細發票查詢
              #161012-00055#2-s-mark
              #IF (NOT cl_null(g_pmds_m.pmdsdocno)) AND l_ac > 0 THEN
              #   CALL aapt110_01(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
              #END IF
              #161012-00055#2-e-mark 
              #161012-00055#2-s-add
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL aapt110_07(g_pmds_m.pmdsdocno)
               END IF
              #161012-00055#2-e-add              
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION demo
            LET g_action_choice="demo"
            IF cl_auth_chk_act("demo") THEN
               
               #add-point:ON ACTION demo name="menu.demo"
#               CALL aooi360_02('6',g_prog,g_pmds_m.pmdsdocno,'','','','','','','','','')  #161031-00025#15 mark
               #161031-00025#15 add(s)
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL apmt520_remarks()
               END IF
               #161031-00025#15 add(e)
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_aint701
            LET g_action_choice="gen_aint701"
            IF cl_auth_chk_act("gen_aint701") THEN
               
               #add-point:ON ACTION gen_aint701 name="menu.gen_aint701"
               IF g_pmds_m.pmdsdocno IS NULL THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = "std-00003"
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = FALSE
                  CALL cl_err()
                  EXIT DIALOG
               END IF  
               IF g_pmds_m.pmdsstus != 'Y' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = "ain-00808"
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = FALSE
                  CALL cl_err()
                  EXIT DIALOG
               END IF
               IF g_argv[1] = '8' THEN   
                  #檢查是否存在aint701
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt
                    FROM inbm_t
                   WHERE inbment = g_enterprise
                     AND inbm004 = g_pmds_m.pmdsdocno
                     AND inbmstus != 'X'
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ain-00805'  
                     LET g_errparam.extend = g_pmds_m.pmdsdocno
                     LET g_errparam.popup = TRUE
                     CALL cl_err()  
                     EXIT DIALOG                     
                  END IF
                  #檢查是否存在apmt571明細
                  LET l_cnt = 0 
                  SELECT COUNT(1) INTO l_cnt
                    FROM pmds_t
                   WHERE pmdsent = g_enterprise
                     AND pmds006 = g_pmds_m.pmdsdocno
                     AND pmdsstus != 'X'
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ain-00806'  
                     LET g_errparam.extend = g_pmds_m.pmdsdocno
                     LET g_errparam.popup = TRUE
                     CALL cl_err()  
                     EXIT DIALOG                     
                  END IF   
                  CALL s_transaction_begin()
                  CALL cl_err_collect_init() 
                  CALL apmt520_ins_inbm(g_pmds_m.pmdsdocno) RETURNING l_success
                  CALL cl_err_collect_show()
                  IF l_success THEN
                     CALL s_transaction_end('Y','1')
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF                                     
               END IF                
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_purchase
            LET g_action_choice="gen_purchase"
            IF cl_auth_chk_act("gen_purchase") THEN
               
               #add-point:ON ACTION gen_purchase name="menu.gen_purchase"
               CALL apmt520_gen_purchase()
               #串查到採購單
               IF NOT cl_null(g_pmdldocno) THEN
               INITIALIZE la_param.* TO NULL #161005-00037#1 add
                  CASE g_argv[1]
                     WHEN '7' LET la_param.prog = 'apmt500'
                              LET la_param.param[1] = g_pmdldocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '14' LET la_param.prog = 'apmt501'
                              LET la_param.param[1] = g_pmdldocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '15' LET la_param.prog = 'apmt503'
                              LET la_param.param[1] = g_pmdldocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '26' LET la_param.prog = 'apmt504'
                              LET la_param.param[1] = g_pmdldocno
                              LET ls_js = util.JSON.stringify( la_param )
                  END CASE
                  #CALL cl_cmdrun_wait(ls_js)
                  CALL cl_cmdrun(ls_js)
                  LET g_pmdldocno = ''
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_warehouse_voucher
            LET g_action_choice="query_warehouse_voucher"
            IF cl_auth_chk_act("query_warehouse_voucher") THEN
               
               #add-point:ON ACTION query_warehouse_voucher name="menu.query_warehouse_voucher"
               #串查到入庫單
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
               INITIALIZE la_param.* TO NULL #161005-00037#1 add
                  CASE g_argv[1]
                     WHEN '1' LET la_param.prog = 'apmt570'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '2' LET la_param.prog = 'apmt570'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '8' LET la_param.prog = 'apmt571'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '9' LET la_param.prog = 'apmt573'
                              LET la_param.param[1] = ''
                              LET la_param.param[2] = g_pmds_m.pmdsdocno
                              LET ls_js = util.JSON.stringify( la_param )
                     WHEN '23' LET la_param.prog = 'apmt574'
                               LET la_param.param[1] = ''
                               LET la_param.param[2] = g_pmds_m.pmdsdocno
                               LET ls_js = util.JSON.stringify( la_param )
                  END CASE
                  #CALL cl_cmdrun_wait(ls_js)
                  CALL cl_cmdrun(ls_js)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION upd_pmds052
            LET g_action_choice="upd_pmds052"
            IF cl_auth_chk_act("upd_pmds052") THEN
               
               #add-point:ON ACTION upd_pmds052 name="menu.upd_pmds052"
               CALL apmt520_upd_pmds052()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION upd_pmds081
            LET g_action_choice="upd_pmds081"
            IF cl_auth_chk_act("upd_pmds081") THEN
               
               #add-point:ON ACTION upd_pmds081 name="menu.upd_pmds081"
               CALL apmt520_upd_pmds081()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL apmt520_delete()
               #add-point:ON ACTION delete name="menu.delete"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_aapp320_7
            LET g_action_choice="gen_aapp320_7"
            IF cl_auth_chk_act("gen_aapp320_7") THEN
               
               #add-point:ON ACTION gen_aapp320_7 name="menu.gen_aapp320_7"
               #modify--2015/08/27 By shiun--(S)
               #倉退單發票產生
#               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
#                  LET tran_master.wc  = "pmdtdocno = '",g_pmds_m.pmdsdocno,"' "
#                  LET l_tran = util.JSON.stringify(tran_master)    #打包參數
#
#                  INITIALIZE la_param.* TO NULL
#                  LET la_param.prog = 'aapp320'
#                  LET la_param.param[1] = l_tran       #把打包的參數 放到cmd_run的第一個參數
#                  LET la_param.background = 'N'
#                  
#                  LET ls_js = util.JSON.stringify(la_param)
#                  
#                  CALL cl_cmdrun(ls_js)
#               END IF
               #入庫單發票產生
               #增加查有無發票且金額相等的才可執行
               IF NOT cl_null(g_pmds_m.pmdsdocno)THEN
                  #帳款單是否產生
                  LET l_cnt = NULL
                  SELECT COUNT(1) INTO l_cnt 
                    FROM pmdt_t
                   WHERE pmdtent = g_enterprise 
                     AND pmdtdocno = g_pmds_m.pmdsdocno
                     AND pmdt056 > 0     
                  IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF

                  #發票要存在且金額對等
                  LET l_cnt2 = NULL
                  SELECT COUNT(DISTINCT pmdtdocno) INTO l_cnt2 FROM pmdt_t,pmds_t
                   WHERE pmdtent = pmdsent
                     AND pmdtdocno = pmdsdocno
                     AND pmdtent = g_enterprise
                     AND pmdtdocno = g_pmds_m.pmdsdocno
                     AND (pmdsdocno IN (SELECT pmdtdocno FROM (SELECT pmdtdocno,SUM(pmdt039) pmdt039,pmdw025 FROM pmdw_t,pmdt_t         
                                                               WHERE pmdtent =    g_enterprise           AND pmdtent = pmdwent 
                                                                 AND pmdtdocno = pmdwdocno           
                                                               GROUP BY pmdtdocno,pmdw025)      
                                        WHERE pmdt039 = pmdw025 ) 
                 
                           OR pmds006 IN (SELECT pmdtdocno FROM (SELECT pmdtdocno,SUM(pmdt039) pmdt039,pmdw025 FROM pmdw_t,pmdt_t         
                                                                 WHERE pmdtent =    g_enterprise           AND pmdtent = pmdwent 
                                                                   AND pmdtdocno = pmdwdocno           
                                                                 GROUP BY pmdtdocno,pmdw025)      
                                          WHERE pmdt039 = pmdw025 )) 
                  IF cl_null(l_cnt2)THEN LET l_cnt2 = 0 END IF
                  
                  CASE
                     WHEN l_cnt > 0
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'axm-00711'   #已產生帳款單, 不可重覆執行！
                        LET g_errparam.extend = g_pmds_m.pmdsdocno
                        LET g_errparam.popup = TRUE
                        CALL cl_err()                     
                     #ming 20151008 mark -----(S) 
                     #財務還沒改好，所以一定會不相符，暫時先將此註解 
                     #WHEN l_cnt2 = 0 
                     #   INITIALIZE g_errparam TO NULL
                     #   LET g_errparam.code = 'aap-00394'   #不存在對應的發票或發票金額與入庫單金額不相符,不可執行拋轉!
                     #   LET g_errparam.extend = g_pmds_m.pmdsdocno
                     #   LET g_errparam.popup = TRUE
                     #   CALL cl_err()                       
                     #ming 20151008 mark -----(E) 
                     OTHERWISE
                        #執行產生對帳+拋轉帳款
                        LET tran_master.wc  = "pmdtdocno = '",g_pmds_m.pmdsdocno,"' "
                        LET l_tran = util.JSON.stringify(tran_master)    #打包參數
                        
                        INITIALIZE la_param.* TO NULL
                        LET la_param.prog = 'aapp320'
                        LET la_param.param[1] = l_tran       #把打包的參數 放到cmd_run的第一個參數
                        LET la_param.background = 'N'
                        
                        LET ls_js = util.JSON.stringify(la_param)
                        
                        CALL cl_cmdrun(ls_js)                        
                  END CASE
               END IF
               #modify--2015/08/27 By shiun--(E)
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL apmt520_insert()
               #add-point:ON ACTION insert name="menu.insert"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_aapt110_01
            LET g_action_choice="query_aapt110_01"
            IF cl_auth_chk_act("query_aapt110_01") THEN
               
               #add-point:ON ACTION query_aapt110_01 name="menu.query_aapt110_01"
               #發票訊息查詢
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL aapt110_01(g_pmds_m.pmdsdocno,0)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION store_in_by_qc
            LET g_action_choice="store_in_by_qc"
            IF cl_auth_chk_act("store_in_by_qc") THEN
               
               #add-point:ON ACTION store_in_by_qc name="menu.store_in_by_qc"
               CALL s_transaction_begin()
               IF NOT s_apmt520_gen_store_in_by_iqc(g_pmds_m.pmdsdocno) THEN
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
                  CALL apmt520_b_fill()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_aapp320
            LET g_action_choice="gen_aapp320"
            IF cl_auth_chk_act("gen_aapp320") THEN
               
               #add-point:ON ACTION gen_aapp320 name="menu.gen_aapp320"
               #modify--2015/08/27 By shiun--(S)
               #倉退單發票產生
#               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
#                  LET tran_master.wc  = "pmdtdocno = '",g_pmds_m.pmdsdocno,"' "
#                  LET l_tran = util.JSON.stringify(tran_master)    #打包參數
#
#                  INITIALIZE la_param.* TO NULL
#                  LET la_param.prog = 'aapp320'
#                  LET la_param.param[1] = l_tran       #把打包的參數 放到cmd_run的第一個參數
#                  LET la_param.background = 'N'
#                  
#                  LET ls_js = util.JSON.stringify(la_param)
#                  
#                  CALL cl_cmdrun(ls_js)
#               END IF
               #入庫單發票產生
               #增加查有無發票且金額相等的才可執行
               IF NOT cl_null(g_pmds_m.pmdsdocno)THEN
                  #帳款單是否產生
                  LET l_cnt = NULL
                  SELECT COUNT(1) INTO l_cnt 
                    FROM pmdt_t
                   WHERE pmdtent = g_enterprise 
                     AND pmdtdocno = g_pmds_m.pmdsdocno
                     AND pmdt056 > 0     
                  IF cl_null(l_cnt)THEN LET l_cnt = 0 END IF

                  #發票要存在且金額對等
                  LET l_cnt2 = NULL
                  SELECT COUNT(DISTINCT pmdtdocno) INTO l_cnt2 FROM pmdt_t,pmds_t
                   WHERE pmdtent = pmdsent
                     AND pmdtdocno = pmdsdocno
                     AND pmdtent = g_enterprise
                     AND pmdtdocno = g_pmds_m.pmdsdocno
                     AND (pmdsdocno IN (SELECT pmdtdocno FROM (SELECT pmdtdocno,SUM(pmdt039) pmdt039,pmdw025 FROM pmdw_t,pmdt_t         
                                                               WHERE pmdtent =    g_enterprise           AND pmdtent = pmdwent 
                                                                 AND pmdtdocno = pmdwdocno           
                                                               GROUP BY pmdtdocno,pmdw025)      
                                        WHERE pmdt039 = pmdw025 ) 
                 
                           OR pmds006 IN (SELECT pmdtdocno FROM (SELECT pmdtdocno,SUM(pmdt039) pmdt039,pmdw025 FROM pmdw_t,pmdt_t         
                                                                 WHERE pmdtent =    g_enterprise           AND pmdtent = pmdwent 
                                                                   AND pmdtdocno = pmdwdocno           
                                                                 GROUP BY pmdtdocno,pmdw025)      
                                          WHERE pmdt039 = pmdw025 )) 
                  IF cl_null(l_cnt2)THEN LET l_cnt2 = 0 END IF
                  
                  CASE
                     WHEN l_cnt > 0
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'axm-00711'   #已產生帳款單, 不可重覆執行！
                        LET g_errparam.extend = g_pmds_m.pmdsdocno
                        LET g_errparam.popup = TRUE
                        CALL cl_err()                     
                     #ming 20151008 mark -----(S) 
                     #財務還沒改好，所以金額一定會不相符，因此暫時註解 
                     #WHEN l_cnt2 = 0 
                     #   INITIALIZE g_errparam TO NULL
                     #   LET g_errparam.code = 'aap-00394'   #不存在對應的發票或發票金額與入庫單金額不相符,不可執行拋轉!
                     #   LET g_errparam.extend = g_pmds_m.pmdsdocno
                     #   LET g_errparam.popup = TRUE
                     #   CALL cl_err()                       
                     #ming 20151008 mark -----(E) 
                     OTHERWISE
                        #執行產生對帳+拋轉帳款
                        LET tran_master.wc  = "pmdtdocno = '",g_pmds_m.pmdsdocno,"' "
                        LET l_tran = util.JSON.stringify(tran_master)    #打包參數
                        
                        INITIALIZE la_param.* TO NULL
                        LET la_param.prog = 'aapp320'
                        LET la_param.param[1] = l_tran       #把打包的參數 放到cmd_run的第一個參數
                        LET la_param.background = 'N'
                        
                        LET ls_js = util.JSON.stringify(la_param)
                        
                        CALL cl_cmdrun(ls_js)                        
                  END CASE
               END IF
               #modify--2015/08/27 By shiun--(E)
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmt520_03
            LET g_action_choice="open_apmt520_03"
            IF cl_auth_chk_act("open_apmt520_03") THEN
               
               #add-point:ON ACTION open_apmt520_03 name="menu.open_apmt520_03"
               LET l_ac = ARR_CURR()
               IF l_ac > 0 THEN
                  #如果有維護多庫儲批
                  CALL s_transaction_begin()
                  IF NOT apmt520_03('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'','','','','','','','','','','','','') THEN #161006-00018#8 add '',''
                     CALL s_transaction_end('N','0')
                  ELSE
                     #若維護了多筆庫儲批資料，則更新多庫儲批否為'Y'
                     SELECT COUNT(1) INTO l_n FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d[l_ac].pmdtseq
                     IF l_n > 1 AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                        UPDATE pmdt_t SET pmdt062 = 'Y' WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
                     END IF
                     #非多庫儲批未勾選時候，若通過多庫儲批子作業修改了庫儲批資料，也同步回寫主作業單身的庫儲批欄位
                     IF l_n = 1 AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                        SELECT pmdu005,pmdu006,pmdu007,pmdu008 INTO l_pmdu005,l_pmdu006,l_pmdu007,l_pmdu008   #160316-00007#3 add pmdu005
                            FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d[l_ac].pmdtseq
                        UPDATE pmdt_t SET pmdt016 = l_pmdu006,
                                          pmdt017 = l_pmdu007,
                                          pmdt018 = l_pmdu008,
                                          pmdt063 = l_pmdu005   #160316-00007#3 add
                            WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
                     END IF
                     CALL s_transaction_end('Y','0')
                  END IF
                  CALL apmt520_b_fill()
                  
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output name="menu.output"
               #CALL apmr520_g01("pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'",'Y','Y')
               LET g_rep_wc = "pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'"               
               #END add-point
               &include "erp/apm/apmt520_rep.4gl"
               #add-point:ON ACTION output.after name="menu.after_output"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION quickprint
            LET g_action_choice="quickprint"
            IF cl_auth_chk_act("quickprint") THEN
               
               #add-point:ON ACTION quickprint name="menu.quickprint"
               #CALL apmr520_g01("pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'",'Y','Y')
               LET g_rep_wc = "pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'"               
               #END add-point
               &include "erp/apm/apmt520_rep.4gl"
               #add-point:ON ACTION quickprint.after name="menu.after_quickprint"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL apmt520_reproduce()
               #add-point:ON ACTION reproduce name="menu.reproduce"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_pmdt
            LET g_action_choice="gen_pmdt"
            IF cl_auth_chk_act("gen_pmdt") THEN
               
               #add-point:ON ACTION gen_pmdt name="menu.gen_pmdt"
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL s_transaction_begin()
                  IF NOT apmt520_01(g_pmds_m.pmdsdocno) THEN
                     CALL s_transaction_end('N','0')
                  ELSE
                     CALL s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) RETURNING l_success
                     CALL s_transaction_end('Y','0')
                  END IF
                  CALL apmt520_b_fill()
               END IF   
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION get_detail_price
            LET g_action_choice="get_detail_price"
            IF cl_auth_chk_act("get_detail_price") THEN
               
               #add-point:ON ACTION get_detail_price name="menu.get_detail_price"
               IF cl_ask_promp('apm-00801') THEN
                  CALL apmt520_get_detail_price()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL apmt520_query()
               #add-point:ON ACTION query name="menu.query"
                                                            
               #END add-point
               #應用 a59 樣板自動產生(Version:3)  
               CALL g_curr_diag.setCurrentRow("s_detail1",1)
               CALL g_curr_diag.setCurrentRow("s_detail2",1)
               CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
 
 
 
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_asft314
            LET g_action_choice="gen_asft314"
            IF cl_auth_chk_act("gen_asft314") THEN
               
               #add-point:ON ACTION gen_asft314 name="menu.gen_asft314"
               #160128-00023#1---add---begin---
               #委外入庫單增加自動產生倒扣料功能
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL s_transaction_begin()
                  CALL cl_err_collect_init() 
                  CALL s_apmt520_gen_asft314('1',g_pmds_m.pmdsdocno) RETURNING l_success,l_start_no,l_end_no
                  CALL cl_err_collect_show()   
                  IF NOT l_success THEN
                     CALL s_transaction_end('N','0')
                  ELSE
                     IF NOT cl_null(l_start_no) THEN
                        CALL s_transaction_end('Y','0')
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'aap-00125'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        LET g_errparam.replace[1] = l_start_no
                        CALL cl_err()
                        LET g_pmds_m.pmds058 = l_start_no
                        DISPLAY BY NAME g_pmds_m.pmds058
                     ELSE
                        CALL s_transaction_end('N','0')
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'agl-00167'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                     END IF
                  END IF

               END IF
               #160128-00023#1---add---end---
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_qc
            LET g_action_choice="gen_qc"
            IF cl_auth_chk_act("gen_qc") THEN
               
               #add-point:ON ACTION gen_qc name="menu.gen_qc"
               CALL apmt520_gen_iqc()
               CALL s_lot_b_fill('1',g_site,'2',g_pmds_m.pmdsdocno,'','','1') 
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_warehouse_or_check_back
            LET g_action_choice="gen_warehouse_or_check_back"
            IF cl_auth_chk_act("gen_warehouse_or_check_back") THEN
               
               #add-point:ON ACTION gen_warehouse_or_check_back name="menu.gen_warehouse_or_check_back"
               #170118-00051#1---s
               IF apmt520_gen_warehouse_or_check_back() THEN
                  IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                     #串查到入庫單
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM pmds_t 
                         WHERE pmdsent = g_enterprise AND pmds006 = g_pmds_m.pmdsdocno AND pmds000 IN ('6','12','13','25')
                     IF l_n > 0 THEN 
                        INITIALIZE la_param.* TO NULL
                        CASE g_argv[1]
                           WHEN '1' LET la_param.prog = 'apmt570'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '2' LET la_param.prog = 'apmt570'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '8' LET la_param.prog = 'apmt571'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '9' LET la_param.prog = 'apmt573'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '23' LET la_param.prog = 'apmt574'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                        END CASE
                        CALL cl_cmdrun(ls_js)
                     END IF
                     #串查到验退单
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM pmds_t 
                         WHERE pmdsent = g_enterprise AND pmds006 = g_pmds_m.pmdsdocno AND pmds000 IN ('5','10','11')
                     IF l_n > 0 THEN 
                        INITIALIZE la_param.* TO NULL
                        CASE g_argv[1]
                           WHEN '1' LET la_param.prog = 'apmt560'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '2' LET la_param.prog = 'apmt560'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '8' LET la_param.prog = 'apmt561'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                           WHEN '9' LET la_param.prog = 'apmt563'
                                    LET la_param.param[1] = ''
                                    LET la_param.param[2] = g_pmds_m.pmdsdocno
                                    LET ls_js = util.JSON.stringify( la_param )
                        END CASE
                        CALL cl_cmdrun(ls_js)
                     END IF
                  END IF
               END IF
               #170118-00051#1---e
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION scan_barcode
            LET g_action_choice="scan_barcode"
            IF cl_auth_chk_act("scan_barcode") THEN
               
               #add-point:ON ACTION scan_barcode name="menu.scan_barcode"
               IF g_argv[1] MATCHES '[1467]' OR g_argv[1] = '12' THEN   #160831-00070#1 20161004 add by beckxie
                  #160811-00014#2--dongsz add--s
                  #单头无资料，不可点击
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmds_t
                   WHERE pmdsent = g_enterprise
                     AND pmdsdocno = g_pmds_m.pmdsdocno
                     AND pmdsstus = 'N'
                  IF l_n < 1 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asl-00022'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     CONTINUE DIALOG
                  END IF
                  IF g_argv[1] ='1' OR g_argv[1] ='6' OR g_argv[1] ='12' THEN   #160831-00070#1 20160929 add by beckxie
                     #采购单号为空，不可点击按钮
                     IF cl_null(g_pmds_m.pmds006) THEN
                        INITIALIZE g_errparam TO NULL
                        #160831-00070#14 20161013 add by beckxie---S
                        IF g_argv[1] = '12' OR g_argv[1] = '6' THEN  #委外採購入庫&採購入庫
                           LET g_errparam.code = 'asl-00029'         #請先在入庫資訊頁籤維護收貨單號！
                        END IF
                        IF g_argv[1] = '1' THEN                      #採購收貨
                           LET g_errparam.code = 'asl-00023'         #請先在收貨信息頁籤維護本次收貨的採購單號！
                        END IF
                        #160831-00070#14 20161013 add by beckxie---E
                        #LET g_errparam.code = 'asl-00023'   #160831-00070#14 20161013 mark by beckxie
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CONTINUE DIALOG
                     END IF
                  END IF   #160831-00070#1 20160929 add by beckxie
                  
                  #160831-00070#1 20160929 add by beckxie---S
                  #必填欄位檢查
                  CALL cl_err_collect_init()
                  IF NOT apmt520_scan_chk_reqf() THEN
                     CALL cl_err_collect_show()
                     CONTINUE DIALOG
                  END IF
                  CALL cl_err_collect_show()
                  #160831-00070#1 20160929 add by beckxie---E
                  
                  #写入扫码录入临时表资料
                  CALL s_scancode_apmt520_ins_tmp(g_pmds_m.pmdsdocno)
                  CALL apmt520_b_fill()
                  #160811-00014#2--dongsz add--e
               END IF   #160831-00070#1 20161004 add by beckxie
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_qc
            LET g_action_choice="query_qc"
            IF cl_auth_chk_act("query_qc") THEN
               
               #add-point:ON ACTION query_qc name="menu.query_qc"
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  INITIALIZE la_param.* TO NULL #161005-00037#1 add
                  LET la_param.prog = 'aqct300'
                  LET la_param.param[1] = ''
                  LET la_param.param[2] = ''
                  LET la_param.param[3] = g_pmds_m.pmdsdocno
                  LET ls_js = util.JSON.stringify( la_param )
                  CALL cl_cmdrun(ls_js)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION upd_price
            LET g_action_choice="upd_price"
            IF cl_auth_chk_act("upd_price") THEN
               
               #add-point:ON ACTION upd_price name="menu.upd_price"
               
               CALL apmt520_upd_price()
              
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_pmds002
            LET g_action_choice="prog_pmds002"
            IF cl_auth_chk_act("prog_pmds002") THEN
               
               #add-point:ON ACTION prog_pmds002 name="menu.prog_pmds002"
               #+ 此段落由子樣板a45產生
               CALL cl_user_contact("aooi130", "ooag_t", "ooag002", "ooag001",'')


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_pmds006
            LET g_action_choice="prog_pmds006"
            IF cl_auth_chk_act("prog_pmds006") THEN
               
               #add-point:ON ACTION prog_pmds006 name="menu.prog_pmds006"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               #抓取單據別
               LET l_slip = ''
               LET l_prog = ''
               IF NOT cl_null(g_pmds_m.pmds006) THEN
                  #161209-00043#1--s
                  #因为委外采购单的单号，是由工单单号直接抛转过来的，所以对应的单别性质是工单，但串查时，应串到委外采购单上
                  IF g_argv[1] MATCHES '[89]' OR g_argv[1] = '20' THEN
                     INITIALIZE la_param.* TO NULL
                     LET la_param.prog     = 'apmt501'
                     LET la_param.param[1] = g_pmds_m.pmds006
                     
                     LET ls_js = util.JSON.stringify(la_param)
                     CALL cl_cmdrun(ls_js)
                  ELSE
                  #161209-00043#1---e
                     CALL s_aooi200_get_slip(g_pmds_m.pmds006) RETURNING l_success,l_slip
                     IF NOT cl_null(l_slip) THEN
                        SELECT oobx004 INTO l_prog
                          FROM oobx_t
                         WHERE oobxent = g_enterprise
                           AND oobx001 = l_slip
                     END IF
                     IF NOT cl_null(l_prog) THEN
                        INITIALIZE la_param.* TO NULL
                        LET la_param.prog     = l_prog
                        LET la_param.param[1] = g_pmds_m.pmds006
                        
                        LET ls_js = util.JSON.stringify(la_param)
                        CALL cl_cmdrun(ls_js)
                     END IF
                  END IF   #161209-00043#1
               END IF
               #END add-point
               
            END IF
 
 
 
 
         
         #應用 a46 樣板自動產生(Version:3)
         #新增相關文件
         ON ACTION related_document
            CALL apmt520_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"
               
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL apmt520_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"
            
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL apmt520_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"
            
            #END add-point
            CALL cl_user_overview_follow(g_pmds_m.pmdsdocdt)
 
 
 
         
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
    
         #交談指令共用ACTION
         &include "common_action.4gl" 
            CONTINUE DIALOG
      END DIALOG
 
      #(ver:79) ---add start---
      #add-point:ui_dialog段 after dialog name="ui_dialog.exit_dialog"
      
      #end add-point
      #(ver:79) --- add end ---
    
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         EXIT WHILE
      END IF
    
   END WHILE    
      
   CALL cl_set_act_visible("accept,cancel", TRUE)
    
END FUNCTION
 
{</section>}
 
{<section id="apmt520.browser_fill" >}
#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION apmt520_browser_fill(ps_page_action)
   #add-point:browser_fill段define(客製用) name="browser_fill.define_customerization"
   
   #end add-point  
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   #add-point:browser_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="browser_fill.define"
   
   #end add-point    
   
   #add-point:Function前置處理 name="browser_fill.before_browser_fill"
   #161031-00025#15 add(s)
   IF cl_null(g_add_browse) THEN
      CALL aooi360_01_clear_detail()   #清除备注单身
   END IF
   #161031-00025#15 add(e)
   #end add-point
   
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
 
   #add-point:browser_fill,foreach前 name="browser_fill.before_foreach"
   
   #160413-00011#9--mark---begin---
   #IF cl_null(g_wc) THEN
   #   LET g_wc = " pmdssite = '",g_site,"' "
   #ELSE
   #   LET g_wc = g_wc," AND pmdssite = '",g_site,"' "
   #END IF
   #
   #IF NOT cl_null(g_argv[1]) THEN
   #   LET g_wc = g_wc," AND pmds000 = '", g_argv[1], "' "
   #END IF
   #
   #LET l_wc  = g_wc.trim()     
   #160413-00011#9--mark---end---
   
   LET g_wc = g_wc," AND pmdssite = '",g_site,"' "    #170120-00009#1 add
   LET l_wc  = g_wc.trim()                            #170120-00009#1 add
   
   #160510-00043#2--(S)
   IF NOT cl_null(g_slip_wc) THEN
      LET g_wc = g_wc," AND ",g_slip_wc
      LET l_wc  = g_wc.trim()
   END IF   
   #160510-00043#2--(E)
   
   #end add-point
   
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT DISTINCT pmdsdocno ",
                      " FROM pmds_t ",
                      " ",
                      " LEFT JOIN pmdt_t ON pmdtent = pmdsent AND pmdsdocno = pmdtdocno ", "  ",
                      #add-point:browser_fill段sql(pmdt_t1) name="browser_fill.cnt.join.}"
                      
                      #end add-point
                      " LEFT JOIN pmdu_t ON pmduent = pmdsent AND pmdsdocno = pmdudocno", "  ",
                      #add-point:browser_fill段sql(pmdu_t1) name="browser_fill.cnt.join.pmdu_t1"
                      
                      #end add-point
 
                      " LEFT JOIN pmdv_t ON pmdvent = pmdsent AND pmdsdocno = pmdvdocno", "  ",
                      #add-point:browser_fill段sql(pmdv_t1) name="browser_fill.cnt.join.pmdv_t1"
                      
                      #end add-point
 
 
 
                      " ", 
                      " ", 
                      " ",                      
 
                      " ",                      
 
 
 
                      " WHERE pmdsent = " ||g_enterprise|| " AND pmdtent = " ||g_enterprise|| " AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("pmds_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT DISTINCT pmdsdocno ",
                      " FROM pmds_t ", 
                      "  ",
                      "  ",
                      " WHERE pmdsent = " ||g_enterprise|| " AND ",l_wc CLIPPED, cl_sql_add_filter("pmds_t")
   END IF
   
   #add-point:browser_fill,cnt wc name="browser_fill.cnt_sqlwc"
   #161031-00025#15 add(s)
   IF NOT cl_null(g_wc2_i36001) AND g_wc2_i36001 <> " 1=1" THEN
      LET l_sub_sql = l_sub_sql CLIPPED, " AND pmdsdocno IN ( SELECT ooff003 FROM ooff_t WHERE ooffent = ",g_enterprise," AND ooff001 = '6' AND ooff004= 0 AND ",g_wc2_i36001 CLIPPED ,")"
   END IF
   #161031-00025#15 add(e)
   #end add-point
   
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   
   #add-point:browser_fill,count前 name="browser_fill.before_count"
            
   #end add-point
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE header_cnt_pre FROM g_sql
      EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
      FREE header_cnt_pre
   END IF
    
   IF g_browser_cnt > g_max_browse THEN
      IF g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_browser_cnt
         LET g_errparam.code = 9035 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
      END IF
      LET g_browser_cnt = g_max_browse
   END IF
   
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN
      #清除畫面
      CLEAR FORM                
      INITIALIZE g_pmds_m.* TO NULL
      CALL g_pmdt_d.clear()        
      CALL g_pmdt2_d.clear() 
      CALL g_pmdt3_d.clear() 
 
      #add-point:browser_fill g_add_browse段額外處理 name="browser_fill.add_browse.other"
      
      #end add-point   
      CALL g_browser.clear()
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1" 
      LET g_cnt = g_current_idx
   END IF
 
   #依照t0.pmdsdocno,t0.pmdsdocdt,t0.pmds002,t0.pmds003,t0.pmds007,t0.pmds008,t0.pmds009 Browser欄位定義(取代原本bs_sql功能)
   #考量到單身可能下條件, 所以此處需join單身所有table
   #DISTINCT是為了避免在join時出現重複的資料(如果不加DISTINCT則須在程式中過濾)
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.pmdsstus,t0.pmdsdocno,t0.pmdsdocdt,t0.pmds002,t0.pmds003,t0.pmds007, 
          t0.pmds008,t0.pmds009,t1.ooag011 ,t2.ooefl003 ",
                  " FROM pmds_t t0",
                  "  ",
                  "  LEFT JOIN pmdt_t ON pmdtent = pmdsent AND pmdsdocno = pmdtdocno ", "  ", 
                  #add-point:browser_fill段sql(pmdt_t1) name="browser_fill.join.pmdt_t1"
                  
                  #end add-point
                  "  LEFT JOIN pmdu_t ON pmduent = pmdsent AND pmdsdocno = pmdudocno", "  ", 
                  #add-point:browser_fill段sql(pmdu_t1) name="browser_fill.join.pmdu_t1"
               "          AND pmdtseq = pmduseq ",
                  #end add-point
 
                  "  LEFT JOIN pmdv_t ON pmdvent = pmdsent AND pmdsdocno = pmdvdocno", "  ", 
                  #add-point:browser_fill段sql(pmdv_t1) name="browser_fill.join.pmdv_t1"
               "          AND pmdtseq = pmdvseq ",
                  #end add-point
 
 
 
                  " ", 
                  " ",                      
 
                  " ",                      
 
 
 
                                 " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmds002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmds003 AND t2.ooefl002='"||g_dlang||"' ",
 
                  " WHERE t0.pmdsent = " ||g_enterprise|| " AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("pmds_t")
   ELSE
      #單身無輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.pmdsstus,t0.pmdsdocno,t0.pmdsdocdt,t0.pmds002,t0.pmds003,t0.pmds007, 
          t0.pmds008,t0.pmds009,t1.ooag011 ,t2.ooefl003 ",
                  " FROM pmds_t t0",
                  "  ",
                                 " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmds002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmds003 AND t2.ooefl002='"||g_dlang||"' ",
 
                  " WHERE t0.pmdsent = " ||g_enterprise|| " AND ",l_wc, cl_sql_add_filter("pmds_t")
   END IF
   #add-point:browser_fill,sql wc name="browser_fill.fill_sqlwc"
   
   #end add-point
   LET g_sql = g_sql, " ORDER BY pmdsdocno ",g_order
 
   #add-point:browser_fill,before_prepare name="browser_fill.before_prepare"
            
   #end add-point
        
   #LET g_sql = cl_sql_add_tabid(g_sql,"pmds_t") #WC重組
   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE browse_pre FROM g_sql
      DECLARE browse_cur CURSOR FOR browse_pre
      
      #add-point:browser_fill段open cursor name="browser_fill.open"
            
      #end add-point
      
      FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_pmdsdocno,g_browser[g_cnt].b_pmdsdocdt, 
          g_browser[g_cnt].b_pmds002,g_browser[g_cnt].b_pmds003,g_browser[g_cnt].b_pmds007,g_browser[g_cnt].b_pmds008, 
          g_browser[g_cnt].b_pmds009,g_browser[g_cnt].b_pmds002_desc,g_browser[g_cnt].b_pmds003_desc 
 
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "Foreach:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         #add-point:browser_fill段reference name="browser_fill.reference"
                        
         #end add-point
      
         #遮罩相關處理
         CALL apmt520_browser_mask()
      
               #應用 a24 樣板自動產生(Version:3)
      #browser顯示圖片
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         WHEN "S"
            LET g_browser[g_cnt].b_statepic = "stus/16/posted.png"
         WHEN "A"
            LET g_browser[g_cnt].b_statepic = "stus/16/approved.png"
         WHEN "D"
            LET g_browser[g_cnt].b_statepic = "stus/16/withdraw.png"
         WHEN "R"
            LET g_browser[g_cnt].b_statepic = "stus/16/rejection.png"
         WHEN "W"
            LET g_browser[g_cnt].b_statepic = "stus/16/signing.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/invalid.png"
         WHEN "Z"
            LET g_browser[g_cnt].b_statepic = "stus/16/unposted.png"
         
      END CASE
 
 
 
         LET g_cnt = g_cnt + 1
         IF g_cnt > g_max_browse THEN
            EXIT FOREACH
         END IF
         
      END FOREACH
      FREE browse_pre
   END IF
   
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   
   IF cl_null(g_browser[g_cnt].b_pmdsdocno) THEN
      CALL g_browser.deleteElement(g_cnt)
   END IF
   
   LET g_header_cnt  = g_browser.getLength()
   LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
 
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
 
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
                  
   
   #add-point:browser_fill段結束前 name="browser_fill.after"
            
   #end add-point   
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.ui_headershow" >}
#+ 單頭資料重新顯示
PRIVATE FUNCTION apmt520_ui_headershow()
   #add-point:ui_headershow段define(客製用) name="ui_headershow.define_customerization"
   
   #end add-point  
   #add-point:ui_headershow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_headershow.define"
            
   #end add-point      
   
   #add-point:Function前置處理  name="ui_headershow.pre_function"
   
   #end add-point
   
   LET g_pmds_m.pmdsdocno = g_browser[g_current_idx].b_pmdsdocno   
 
   EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
       g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
       g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
       g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
       g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
       g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc,g_pmds_m.pmdsownid_desc, 
       g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
   
   CALL apmt520_pmds_t_mask()
   CALL apmt520_show()
      
END FUNCTION
 
{</section>}
 
{<section id="apmt520.ui_detailshow" >}
#+ 單身資料重新顯示
PRIVATE FUNCTION apmt520_ui_detailshow()
   #add-point:ui_detailshow段define(客製用) name="ui_detailshow.define_customerization"
   
   #end add-point    
   #add-point:ui_detailshow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_detailshow.define"
            
   #end add-point    
 
   #add-point:Function前置處理 name="ui_detailshow.before"
            
   #end add-point    
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail3",g_detail_idx)
 
   END IF
   
   #add-point:ui_detailshow段after name="ui_detailshow.after"
            
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.ui_browser_refresh" >}
#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION apmt520_ui_browser_refresh()
   #add-point:ui_browser_refresh段define(客製用) name="ui_browser_refresh.define_customerization"
   
   #end add-point    
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_browser_refresh.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="ui_browser_refresh.pre_function"
   
   #end add-point
   
   LET g_browser_cnt = g_browser.getLength()
   LET g_header_cnt  = g_browser.getLength()
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_pmdsdocno = g_pmds_m.pmdsdocno 
 
         THEN
         CALL g_browser.deleteElement(l_i)
         EXIT FOR
      END IF
   END FOR
   LET g_browser_cnt = g_browser_cnt - 1
   LET g_header_cnt = g_header_cnt - 1
    
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
      CLEAR FORM
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
   
   #add-point:ui_browser_refresh段after name="ui_browser_refresh.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.construct" >}
#+ QBE資料查詢
PRIVATE FUNCTION apmt520_construct()
   #add-point:cs段define(客製用) name="cs.define_customerization"
   
   #end add-point    
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   DEFINE la_wc       DYNAMIC ARRAY OF RECORD
          tableid     STRING,
          wc          STRING
          END RECORD
   DEFINE li_idx      LIKE type_t.num10
   #add-point:cs段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="cs.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="cs.pre_function"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#15 add
   #end add-point
    
   #清除畫面
   CLEAR FORM                
   INITIALIZE g_pmds_m.* TO NULL
   CALL g_pmdt_d.clear()        
   CALL g_pmdt2_d.clear() 
   CALL g_pmdt3_d.clear() 
 
   
   LET g_action_choice = ""
    
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc2_table2 TO NULL
 
   INITIALIZE g_wc2_table3 TO NULL
 
 
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段開始前 name="cs.before_construct"
            
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON pmdssite,pmdsdocno,pmdsdocno_desc,pmdsdocdt,pmds001,pmds002,pmds003, 
          pmdsstus,pmds006,pmds007,pmds008,pmds009,pmds010,pmds052,pmds028,pmds000,pmds100,pmds011,pmds014, 
          pmds081,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035,pmds036, 
          pmds037,pmds038,pmds039,pmds040,pmds012,pmds101,pmds102,pmds103,pmds048,pmds047,pmds049,pmds053, 
          pmds041,pmds043,pmds044,pmds046,pmds054,pmds055,pmds050,pmds057,pmds042,pmds058,pmdsownid, 
          pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt,pmdspstid, 
          pmdspstdt
 
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.head.before_construct"
                                                
            #end add-point 
            
         #公用欄位開窗相關處理
         #應用 a11 樣板自動產生(Version:3)
         #共用欄位查詢處理  
         ##----<<pmdscrtdt>>----
         AFTER FIELD pmdscrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
         #----<<pmdsmoddt>>----
         AFTER FIELD pmdsmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmdscnfdt>>----
         AFTER FIELD pmdscnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmdspstdt>>----
         AFTER FIELD pmdspstdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
 
 
            
         #一般欄位開窗相關處理    
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdssite
            #add-point:BEFORE FIELD pmdssite name="construct.b.pmdssite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdssite
            
            #add-point:AFTER FIELD pmdssite name="construct.a.pmdssite"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdssite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdssite
            #add-point:ON ACTION controlp INFIELD pmdssite name="construct.c.pmdssite"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdsdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocno
            #add-point:ON ACTION controlp INFIELD pmdsdocno name="construct.c.pmdsdocno"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_argv[1]   #單據類型
			   #160510-00043#2--(S)   
            IF NOT cl_null(g_slip_wc) THEN
               LET g_qryparam.where = g_slip_wc
            END IF
            #160510-00043#2--(E)
            CALL q_pmdsdocno()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsdocno  #顯示到畫面上

            NEXT FIELD pmdsdocno                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocno
            #add-point:BEFORE FIELD pmdsdocno name="construct.b.pmdsdocno"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocno
            
            #add-point:AFTER FIELD pmdsdocno name="construct.a.pmdsdocno"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocno_desc
            #add-point:BEFORE FIELD pmdsdocno_desc name="construct.b.pmdsdocno_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocno_desc
            
            #add-point:AFTER FIELD pmdsdocno_desc name="construct.a.pmdsdocno_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsdocno_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocno_desc
            #add-point:ON ACTION controlp INFIELD pmdsdocno_desc name="construct.c.pmdsdocno_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocdt
            #add-point:BEFORE FIELD pmdsdocdt name="construct.b.pmdsdocdt"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocdt
            
            #add-point:AFTER FIELD pmdsdocdt name="construct.a.pmdsdocdt"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocdt
            #add-point:ON ACTION controlp INFIELD pmdsdocdt name="construct.c.pmdsdocdt"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds001
            #add-point:BEFORE FIELD pmds001 name="construct.b.pmds001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds001
            
            #add-point:AFTER FIELD pmds001 name="construct.a.pmds001"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds001
            #add-point:ON ACTION controlp INFIELD pmds001 name="construct.c.pmds001"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds002
            #add-point:ON ACTION controlp INFIELD pmds002 name="construct.c.pmds002"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds002  #顯示到畫面上

            NEXT FIELD pmds002                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds002
            #add-point:BEFORE FIELD pmds002 name="construct.b.pmds002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds002
            
            #add-point:AFTER FIELD pmds002 name="construct.a.pmds002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds003
            #add-point:ON ACTION controlp INFIELD pmds003 name="construct.c.pmds003"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds003  #顯示到畫面上

            NEXT FIELD pmds003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds003
            #add-point:BEFORE FIELD pmds003 name="construct.b.pmds003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds003
            
            #add-point:AFTER FIELD pmds003 name="construct.a.pmds003"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsstus
            #add-point:BEFORE FIELD pmdsstus name="construct.b.pmdsstus"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsstus
            
            #add-point:AFTER FIELD pmdsstus name="construct.a.pmdsstus"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsstus
            #add-point:ON ACTION controlp INFIELD pmdsstus name="construct.c.pmdsstus"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds006
            #add-point:ON ACTION controlp INFIELD pmds006 name="construct.c.pmds006"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   #採購收貨時開窗開採購單號
			   IF g_argv[1] MATCHES '[13]' THEN
			      LET g_qryparam.where = " pmdl005 NOT IN ('2','5','6') " #一般採購單
               CALL q_pmdldocno_7()                           #呼叫開窗
            END IF
            IF g_argv[1] = '8' OR g_argv[1] = '20' THEN   #委外採購
               LET g_qryparam.where = " pmdl005 ='2' " 
               CALL q_pmdldocno_7() 
            END IF
            IF g_argv[1] = '9' THEN   #重覆性生產採購
               LET g_qryparam.where = " pmdl005 ='5' "
               CALL q_pmdldocno_7() 
            END IF
            #驗退、入庫時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            
            #委外驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14'THEN   #委外驗退
               LET g_qryparam.arg1 = "('8','20')"
               CALL q_pmdsdocno() 
            END IF

            #重覆性生產驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' THEN   #重覆性驗退
               LET g_qryparam.arg1 = "('9')"
               CALL q_pmdsdocno() 
            END IF
            
            #借貨收貨單
            IF g_argv[1] = '23' OR g_argv[1] = '24' THEN
               LET g_qryparam.where = " pmdl005 ='6' " 
               CALL q_pmdldocno_7() 
            END IF
            
            #借貨入庫時開窗開借貨收貨單號
            IF g_argv[1] = '25' THEN
               LET g_qryparam.arg1 = "('23')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            #借貨倉退時開窗開借貨收貨單號
            IF g_argv[1] = '26' THEN
               LET g_qryparam.arg1 = "('23','24')"      
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            
            DISPLAY g_qryparam.return1 TO pmds006  #顯示到畫面上

            NEXT FIELD pmds006                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds006
            #add-point:BEFORE FIELD pmds006 name="construct.b.pmds006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds006
            
            #add-point:AFTER FIELD pmds006 name="construct.a.pmds006"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds007
            #add-point:ON ACTION controlp INFIELD pmds007 name="construct.c.pmds007"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmaa001_3()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds007  #顯示到畫面上

            NEXT FIELD pmds007                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds007
            #add-point:BEFORE FIELD pmds007 name="construct.b.pmds007"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds007
            
            #add-point:AFTER FIELD pmds007 name="construct.a.pmds007"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds008
            #add-point:ON ACTION controlp INFIELD pmds008 name="construct.c.pmds008"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " pmac003 = '1' "  #付款
            CALL q_pmac002_2()                            #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds008  #顯示到畫面上

            NEXT FIELD pmds008                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds008
            #add-point:BEFORE FIELD pmds008 name="construct.b.pmds008"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds008
            
            #add-point:AFTER FIELD pmds008 name="construct.a.pmds008"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds009
            #add-point:ON ACTION controlp INFIELD pmds009 name="construct.c.pmds009"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " pmac003 = '2' "  #
            CALL q_pmac002_2()                            #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds009  #顯示到畫面上

            NEXT FIELD pmds009                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds009
            #add-point:BEFORE FIELD pmds009 name="construct.b.pmds009"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds009
            
            #add-point:AFTER FIELD pmds009 name="construct.a.pmds009"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds010
            #add-point:BEFORE FIELD pmds010 name="construct.b.pmds010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds010
            
            #add-point:AFTER FIELD pmds010 name="construct.a.pmds010"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds010
            #add-point:ON ACTION controlp INFIELD pmds010 name="construct.c.pmds010"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds052
            #add-point:BEFORE FIELD pmds052 name="construct.b.pmds052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds052
            
            #add-point:AFTER FIELD pmds052 name="construct.a.pmds052"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds052
            #add-point:ON ACTION controlp INFIELD pmds052 name="construct.c.pmds052"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds028
            #add-point:BEFORE FIELD pmds028 name="construct.b.pmds028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds028
            
            #add-point:AFTER FIELD pmds028 name="construct.a.pmds028"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds028
            #add-point:ON ACTION controlp INFIELD pmds028 name="construct.c.pmds028"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds000
            #add-point:BEFORE FIELD pmds000 name="construct.b.pmds000"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds000
            
            #add-point:AFTER FIELD pmds000 name="construct.a.pmds000"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds000
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds000
            #add-point:ON ACTION controlp INFIELD pmds000 name="construct.c.pmds000"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds100
            #add-point:BEFORE FIELD pmds100 name="construct.b.pmds100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds100
            
            #add-point:AFTER FIELD pmds100 name="construct.a.pmds100"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds100
            #add-point:ON ACTION controlp INFIELD pmds100 name="construct.c.pmds100"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds011
            #add-point:BEFORE FIELD pmds011 name="construct.b.pmds011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds011
            
            #add-point:AFTER FIELD pmds011 name="construct.a.pmds011"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds011
            #add-point:ON ACTION controlp INFIELD pmds011 name="construct.c.pmds011"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds014
            #add-point:BEFORE FIELD pmds014 name="construct.b.pmds014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds014
            
            #add-point:AFTER FIELD pmds014 name="construct.a.pmds014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds014
            #add-point:ON ACTION controlp INFIELD pmds014 name="construct.c.pmds014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds081
            #add-point:BEFORE FIELD pmds081 name="construct.b.pmds081"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds081
            
            #add-point:AFTER FIELD pmds081 name="construct.a.pmds081"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds081
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds081
            #add-point:ON ACTION controlp INFIELD pmds081 name="construct.c.pmds081"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds045
            #add-point:BEFORE FIELD pmds045 name="construct.b.pmds045"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds045
            
            #add-point:AFTER FIELD pmds045 name="construct.a.pmds045"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds045
            #add-point:ON ACTION controlp INFIELD pmds045 name="construct.c.pmds045"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds021
            #add-point:BEFORE FIELD pmds021 name="construct.b.pmds021"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds021
            
            #add-point:AFTER FIELD pmds021 name="construct.a.pmds021"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds021
            #add-point:ON ACTION controlp INFIELD pmds021 name="construct.c.pmds021"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds022
            #add-point:BEFORE FIELD pmds022 name="construct.b.pmds022"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds022
            
            #add-point:AFTER FIELD pmds022 name="construct.a.pmds022"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds022
            #add-point:ON ACTION controlp INFIELD pmds022 name="construct.c.pmds022"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds023
            #add-point:BEFORE FIELD pmds023 name="construct.b.pmds023"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds023
            
            #add-point:AFTER FIELD pmds023 name="construct.a.pmds023"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds023
            #add-point:ON ACTION controlp INFIELD pmds023 name="construct.c.pmds023"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds024
            #add-point:BEFORE FIELD pmds024 name="construct.b.pmds024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds024
            
            #add-point:AFTER FIELD pmds024 name="construct.a.pmds024"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds024
            #add-point:ON ACTION controlp INFIELD pmds024 name="construct.c.pmds024"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds031
            #add-point:ON ACTION controlp INFIELD pmds031 name="construct.c.pmds031"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmad002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds031  #顯示到畫面上

            NEXT FIELD pmds031                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds031
            #add-point:BEFORE FIELD pmds031 name="construct.b.pmds031"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds031
            
            #add-point:AFTER FIELD pmds031 name="construct.a.pmds031"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds032
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds032
            #add-point:ON ACTION controlp INFIELD pmds032 name="construct.c.pmds032"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = "238"
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds032  #顯示到畫面上

            NEXT FIELD pmds032                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds032
            #add-point:BEFORE FIELD pmds032 name="construct.b.pmds032"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds032
            
            #add-point:AFTER FIELD pmds032 name="construct.a.pmds032"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds033
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds033
            #add-point:ON ACTION controlp INFIELD pmds033 name="construct.c.pmds033"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oodb002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds033  #顯示到畫面上

            NEXT FIELD pmds033                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds033
            #add-point:BEFORE FIELD pmds033 name="construct.b.pmds033"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds033
            
            #add-point:AFTER FIELD pmds033 name="construct.a.pmds033"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds034
            #add-point:BEFORE FIELD pmds034 name="construct.b.pmds034"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds034
            
            #add-point:AFTER FIELD pmds034 name="construct.a.pmds034"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds034
            #add-point:ON ACTION controlp INFIELD pmds034 name="construct.c.pmds034"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds035
            #add-point:BEFORE FIELD pmds035 name="construct.b.pmds035"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds035
            
            #add-point:AFTER FIELD pmds035 name="construct.a.pmds035"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds035
            #add-point:ON ACTION controlp INFIELD pmds035 name="construct.c.pmds035"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds036
            #add-point:BEFORE FIELD pmds036 name="construct.b.pmds036"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds036
            
            #add-point:AFTER FIELD pmds036 name="construct.a.pmds036"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds036
            #add-point:ON ACTION controlp INFIELD pmds036 name="construct.c.pmds036"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds037
            #add-point:ON ACTION controlp INFIELD pmds037 name="construct.c.pmds037"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.arg1 = g_site
            CALL q_ooaj002_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds037  #顯示到畫面上

            NEXT FIELD pmds037                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds037
            #add-point:BEFORE FIELD pmds037 name="construct.b.pmds037"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds037
            
            #add-point:AFTER FIELD pmds037 name="construct.a.pmds037"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds038
            #add-point:BEFORE FIELD pmds038 name="construct.b.pmds038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds038
            
            #add-point:AFTER FIELD pmds038 name="construct.a.pmds038"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds038
            #add-point:ON ACTION controlp INFIELD pmds038 name="construct.c.pmds038"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds039
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds039
            #add-point:ON ACTION controlp INFIELD pmds039 name="construct.c.pmds039"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmam001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds039  #顯示到畫面上

            NEXT FIELD pmds039                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds039
            #add-point:BEFORE FIELD pmds039 name="construct.b.pmds039"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds039
            
            #add-point:AFTER FIELD pmds039 name="construct.a.pmds039"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds040
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds040
            #add-point:ON ACTION controlp INFIELD pmds040 name="construct.c.pmds040"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooid001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds040  #顯示到畫面上

            NEXT FIELD pmds040                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds040
            #add-point:BEFORE FIELD pmds040 name="construct.b.pmds040"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds040
            
            #add-point:AFTER FIELD pmds040 name="construct.a.pmds040"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds012
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds012
            #add-point:ON ACTION controlp INFIELD pmds012 name="construct.c.pmds012"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #160621-00003#3 20160627 modify by beckxie---S
			   #LET g_qryparam.arg1 = "275"
            #CALL q_oocq002()                           #呼叫開窗
            LET g_qryparam.arg1 = '2'
            CALL q_oojd001_1()
            #160621-00003#3 20160627 modify by beckxie---E
            DISPLAY g_qryparam.return1 TO pmds012  #顯示到畫面上
            NEXT FIELD pmds012                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds012
            #add-point:BEFORE FIELD pmds012 name="construct.b.pmds012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds012
            
            #add-point:AFTER FIELD pmds012 name="construct.a.pmds012"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds101
            #add-point:BEFORE FIELD pmds101 name="construct.b.pmds101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds101
            
            #add-point:AFTER FIELD pmds101 name="construct.a.pmds101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds101
            #add-point:ON ACTION controlp INFIELD pmds101 name="construct.c.pmds101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds102
            #add-point:BEFORE FIELD pmds102 name="construct.b.pmds102"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds102
            
            #add-point:AFTER FIELD pmds102 name="construct.a.pmds102"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds102
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds102
            #add-point:ON ACTION controlp INFIELD pmds102 name="construct.c.pmds102"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds103
            #add-point:BEFORE FIELD pmds103 name="construct.b.pmds103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds103
            
            #add-point:AFTER FIELD pmds103 name="construct.a.pmds103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds103
            #add-point:ON ACTION controlp INFIELD pmds103 name="construct.c.pmds103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds048
            #add-point:BEFORE FIELD pmds048 name="construct.b.pmds048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds048
            
            #add-point:AFTER FIELD pmds048 name="construct.a.pmds048"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds048
            #add-point:ON ACTION controlp INFIELD pmds048 name="construct.c.pmds048"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds047
            #add-point:BEFORE FIELD pmds047 name="construct.b.pmds047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds047
            
            #add-point:AFTER FIELD pmds047 name="construct.a.pmds047"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds047
            #add-point:ON ACTION controlp INFIELD pmds047 name="construct.c.pmds047"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds049
            #add-point:BEFORE FIELD pmds049 name="construct.b.pmds049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds049
            
            #add-point:AFTER FIELD pmds049 name="construct.a.pmds049"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds049
            #add-point:ON ACTION controlp INFIELD pmds049 name="construct.c.pmds049"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds053
            #add-point:BEFORE FIELD pmds053 name="construct.b.pmds053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds053
            
            #add-point:AFTER FIELD pmds053 name="construct.a.pmds053"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds053
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds053
            #add-point:ON ACTION controlp INFIELD pmds053 name="construct.c.pmds053"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_icaa001_7()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds053  #顯示到畫面上
            NEXT FIELD pmds053                     #返回原欄位

            #END add-point
 
 
         #Ctrlp:construct.c.pmds041
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds041
            #add-point:ON ACTION controlp INFIELD pmds041 name="construct.c.pmds041"
            
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_argv[1]
            LET g_qryparam.where = " pmdssite = '",g_site,"' AND pmds000 = '",g_argv[01],"'"
            
            CALL q_pmds041_2()
            
            DISPLAY g_qryparam.return1 TO pmds041  #顯示到畫面上

            NEXT FIELD pmds041                     #返回原欄位
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds041
            #add-point:BEFORE FIELD pmds041 name="construct.b.pmds041"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds041
            
            #add-point:AFTER FIELD pmds041 name="construct.a.pmds041"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds043
            #add-point:BEFORE FIELD pmds043 name="construct.b.pmds043"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds043
            
            #add-point:AFTER FIELD pmds043 name="construct.a.pmds043"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds043
            #add-point:ON ACTION controlp INFIELD pmds043 name="construct.c.pmds043"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds044
            #add-point:BEFORE FIELD pmds044 name="construct.b.pmds044"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds044
            
            #add-point:AFTER FIELD pmds044 name="construct.a.pmds044"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds044
            #add-point:ON ACTION controlp INFIELD pmds044 name="construct.c.pmds044"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds046
            #add-point:BEFORE FIELD pmds046 name="construct.b.pmds046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds046
            
            #add-point:AFTER FIELD pmds046 name="construct.a.pmds046"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds046
            #add-point:ON ACTION controlp INFIELD pmds046 name="construct.c.pmds046"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds054
            #add-point:BEFORE FIELD pmds054 name="construct.b.pmds054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds054
            
            #add-point:AFTER FIELD pmds054 name="construct.a.pmds054"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds054
            #add-point:ON ACTION controlp INFIELD pmds054 name="construct.c.pmds054"
            
            #END add-point
 
 
         #Ctrlp:construct.c.pmds055
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds055
            #add-point:ON ACTION controlp INFIELD pmds055 name="construct.c.pmds055"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pmds055()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds055  #顯示到畫面上
            NEXT FIELD pmds055                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds055
            #add-point:BEFORE FIELD pmds055 name="construct.b.pmds055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds055
            
            #add-point:AFTER FIELD pmds055 name="construct.a.pmds055"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds050
            #add-point:BEFORE FIELD pmds050 name="construct.b.pmds050"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds050
            
            #add-point:AFTER FIELD pmds050 name="construct.a.pmds050"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds050
            #add-point:ON ACTION controlp INFIELD pmds050 name="construct.c.pmds050"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds057
            #add-point:BEFORE FIELD pmds057 name="construct.b.pmds057"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds057
            
            #add-point:AFTER FIELD pmds057 name="construct.a.pmds057"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds057
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds057
            #add-point:ON ACTION controlp INFIELD pmds057 name="construct.c.pmds057"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds042
            #add-point:BEFORE FIELD pmds042 name="construct.b.pmds042"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds042
            
            #add-point:AFTER FIELD pmds042 name="construct.a.pmds042"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds042
            #add-point:ON ACTION controlp INFIELD pmds042 name="construct.c.pmds042"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds058
            #add-point:BEFORE FIELD pmds058 name="construct.b.pmds058"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds058
            
            #add-point:AFTER FIELD pmds058 name="construct.a.pmds058"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds058
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds058
            #add-point:ON ACTION controlp INFIELD pmds058 name="construct.c.pmds058"
            
            #END add-point
 
 
         #Ctrlp:construct.c.pmdsownid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsownid
            #add-point:ON ACTION controlp INFIELD pmdsownid name="construct.c.pmdsownid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsownid  #顯示到畫面上

            NEXT FIELD pmdsownid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsownid
            #add-point:BEFORE FIELD pmdsownid name="construct.b.pmdsownid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsownid
            
            #add-point:AFTER FIELD pmdsownid name="construct.a.pmdsownid"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsowndp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsowndp
            #add-point:ON ACTION controlp INFIELD pmdsowndp name="construct.c.pmdsowndp"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsowndp  #顯示到畫面上

            NEXT FIELD pmdsowndp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsowndp
            #add-point:BEFORE FIELD pmdsowndp name="construct.b.pmdsowndp"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsowndp
            
            #add-point:AFTER FIELD pmdsowndp name="construct.a.pmdsowndp"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdscrtid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdscrtid
            #add-point:ON ACTION controlp INFIELD pmdscrtid name="construct.c.pmdscrtid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdscrtid  #顯示到畫面上

            NEXT FIELD pmdscrtid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscrtid
            #add-point:BEFORE FIELD pmdscrtid name="construct.b.pmdscrtid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdscrtid
            
            #add-point:AFTER FIELD pmdscrtid name="construct.a.pmdscrtid"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdscrtdp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdscrtdp
            #add-point:ON ACTION controlp INFIELD pmdscrtdp name="construct.c.pmdscrtdp"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdscrtdp  #顯示到畫面上

            NEXT FIELD pmdscrtdp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscrtdp
            #add-point:BEFORE FIELD pmdscrtdp name="construct.b.pmdscrtdp"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdscrtdp
            
            #add-point:AFTER FIELD pmdscrtdp name="construct.a.pmdscrtdp"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscrtdt
            #add-point:BEFORE FIELD pmdscrtdt name="construct.b.pmdscrtdt"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdsmodid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsmodid
            #add-point:ON ACTION controlp INFIELD pmdsmodid name="construct.c.pmdsmodid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsmodid  #顯示到畫面上

            NEXT FIELD pmdsmodid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsmodid
            #add-point:BEFORE FIELD pmdsmodid name="construct.b.pmdsmodid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsmodid
            
            #add-point:AFTER FIELD pmdsmodid name="construct.a.pmdsmodid"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsmoddt
            #add-point:BEFORE FIELD pmdsmoddt name="construct.b.pmdsmoddt"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdscnfid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdscnfid
            #add-point:ON ACTION controlp INFIELD pmdscnfid name="construct.c.pmdscnfid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdscnfid  #顯示到畫面上

            NEXT FIELD pmdscnfid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscnfid
            #add-point:BEFORE FIELD pmdscnfid name="construct.b.pmdscnfid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdscnfid
            
            #add-point:AFTER FIELD pmdscnfid name="construct.a.pmdscnfid"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscnfdt
            #add-point:BEFORE FIELD pmdscnfdt name="construct.b.pmdscnfdt"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdspstid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdspstid
            #add-point:ON ACTION controlp INFIELD pmdspstid name="construct.c.pmdspstid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdspstid  #顯示到畫面上

            NEXT FIELD pmdspstid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdspstid
            #add-point:BEFORE FIELD pmdspstid name="construct.b.pmdspstid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdspstid
            
            #add-point:AFTER FIELD pmdspstid name="construct.a.pmdspstid"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdspstdt
            #add-point:BEFORE FIELD pmdspstdt name="construct.b.pmdspstdt"
                                                
            #END add-point
 
 
 
         
      END CONSTRUCT
 
      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON pmdtsite,pmdtseq,pmdt027,pmdt028,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081, 
          pmdt082,pmdt083,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021, 
          pmdt022,pmdt008,pmdt023,pmdt024,pmdt090,pmdt091,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047, 
          pmdt092,pmdt093,pmdt026,pmdt041,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt072,pmdt073,pmdt074, 
          pmdt075,pmdt075_desc,pmdt051,pmdt070,pmdt071,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061, 
          pmdt042,pmdt043,pmdt048,pmdt044,pmdt045,pmdt049,pmdt050,pmdt084,pmdt219,pmdt089,pmdt088,ooff013 
 
           FROM s_detail1[1].pmdtsite,s_detail1[1].pmdtseq,s_detail1[1].pmdt027,s_detail1[1].pmdt028, 
               s_detail1[1].pmdt001,s_detail1[1].pmdt002,s_detail1[1].pmdt003,s_detail1[1].pmdt004,s_detail1[1].pmdt081, 
               s_detail1[1].pmdt082,s_detail1[1].pmdt083,s_detail1[1].pmdt005,s_detail1[1].pmdt006,s_detail1[1].pmdt007, 
               s_detail1[1].pmdt009,s_detail1[1].pmdt010,s_detail1[1].pmdt025,s_detail1[1].pmdt011,s_detail1[1].pmdt019, 
               s_detail1[1].pmdt020,s_detail1[1].pmdt021,s_detail1[1].pmdt022,s_detail1[1].pmdt008,s_detail1[1].pmdt023, 
               s_detail1[1].pmdt024,s_detail1[1].pmdt090,s_detail1[1].pmdt091,s_detail1[1].pmdt036,s_detail1[1].pmdt046, 
               s_detail1[1].pmdt037,s_detail1[1].pmdt038,s_detail1[1].pmdt039,s_detail1[1].pmdt047,s_detail1[1].pmdt092, 
               s_detail1[1].pmdt093,s_detail1[1].pmdt026,s_detail1[1].pmdt041,s_detail1[1].pmdt062,s_detail1[1].pmdt016, 
               s_detail1[1].pmdt017,s_detail1[1].pmdt018,s_detail1[1].pmdt063,s_detail1[1].pmdt072,s_detail1[1].pmdt073, 
               s_detail1[1].pmdt074,s_detail1[1].pmdt075,s_detail1[1].pmdt075_desc,s_detail1[1].pmdt051, 
               s_detail1[1].pmdt070,s_detail1[1].pmdt071,s_detail1[1].pmdt059,s_detail1[1].pmdt053,s_detail1[1].pmdt054, 
               s_detail1[1].pmdt055,s_detail1[1].pmdt060,s_detail1[1].pmdt061,s_detail1[1].pmdt042,s_detail1[1].pmdt043, 
               s_detail1[1].pmdt048,s_detail1[1].pmdt044,s_detail1[1].pmdt045,s_detail1[1].pmdt049,s_detail1[1].pmdt050, 
               s_detail1[1].pmdt084,s_detail1[1].pmdt219,s_detail1[1].pmdt089,s_detail1[1].pmdt088,s_detail1[1].ooff013 
 
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body.before_construct"
                                                
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtsite
            #add-point:BEFORE FIELD pmdtsite name="construct.b.page1.pmdtsite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtsite
            
            #add-point:AFTER FIELD pmdtsite name="construct.a.page1.pmdtsite"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdtsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtsite
            #add-point:ON ACTION controlp INFIELD pmdtsite name="construct.c.page1.pmdtsite"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtseq
            #add-point:BEFORE FIELD pmdtseq name="construct.b.page1.pmdtseq"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtseq
            
            #add-point:AFTER FIELD pmdtseq name="construct.a.page1.pmdtseq"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdtseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtseq
            #add-point:ON ACTION controlp INFIELD pmdtseq name="construct.c.page1.pmdtseq"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt027
            #add-point:BEFORE FIELD pmdt027 name="construct.b.page1.pmdt027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt027
            
            #add-point:AFTER FIELD pmdt027 name="construct.a.page1.pmdt027"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt027
            #add-point:ON ACTION controlp INFIELD pmdt027 name="construct.c.page1.pmdt027"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			
            #驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            
            #委外驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14'THEN   #委外驗退
               LET g_qryparam.arg1 = "('8')"
               CALL q_pmdsdocno() 
            END IF
            #重覆性生產驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' THEN   #重覆性驗退
               LET g_qryparam.arg1 = "('9')"
               CALL q_pmdsdocno() 
            END IF
            
            DISPLAY g_qryparam.return1 TO pmdt027  #顯示到畫面上

            NEXT FIELD pmdt027                     #返回原欄位

            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt028
            #add-point:BEFORE FIELD pmdt028 name="construct.b.page1.pmdt028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt028
            
            #add-point:AFTER FIELD pmdt028 name="construct.a.page1.pmdt028"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt028
            #add-point:ON ACTION controlp INFIELD pmdt028 name="construct.c.page1.pmdt028"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt001
            #add-point:ON ACTION controlp INFIELD pmdt001 name="construct.c.page1.pmdt001"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			
            #採購收貨時開窗開採購單號
			   IF g_argv[1] MATCHES '[13567]' THEN
               LET g_qryparam.where = " pmdl005 NOT IN ('2','5','6') "
               CALL q_pmdldocno_7()                           #呼叫開窗
            END IF
            IF g_argv[1] = '8' OR g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14' OR g_argv[1] = '20' THEN   #委外採購
               LET g_qryparam.where = " pmdl005 ='2' " 
               CALL q_pmdldocno_7() 
            END IF
            IF g_argv[1] = '9' OR g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' THEN   #重覆性生產採購
               LET g_qryparam.where = " pmdl005 ='5' "
               CALL q_pmdldocno_7() 
            END IF
           
            #借貨收貨單
            IF g_argv[1] = '23' OR g_argv[1] = '24' THEN
               LET g_qryparam.where = " pmdl005 ='6' " 
               CALL q_pmdldocno_7() 
            END IF
            
            DISPLAY g_qryparam.return1 TO pmdt001  #顯示到畫面上

            NEXT FIELD pmdt001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt001
            #add-point:BEFORE FIELD pmdt001 name="construct.b.page1.pmdt001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt001
            
            #add-point:AFTER FIELD pmdt001 name="construct.a.page1.pmdt001"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt002
            #add-point:BEFORE FIELD pmdt002 name="construct.b.page1.pmdt002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt002
            
            #add-point:AFTER FIELD pmdt002 name="construct.a.page1.pmdt002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt002
            #add-point:ON ACTION controlp INFIELD pmdt002 name="construct.c.page1.pmdt002"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt003
            #add-point:BEFORE FIELD pmdt003 name="construct.b.page1.pmdt003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt003
            
            #add-point:AFTER FIELD pmdt003 name="construct.a.page1.pmdt003"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt003
            #add-point:ON ACTION controlp INFIELD pmdt003 name="construct.c.page1.pmdt003"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt004
            #add-point:BEFORE FIELD pmdt004 name="construct.b.page1.pmdt004"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt004
            
            #add-point:AFTER FIELD pmdt004 name="construct.a.page1.pmdt004"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt004
            #add-point:ON ACTION controlp INFIELD pmdt004 name="construct.c.page1.pmdt004"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt081
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt081
            #add-point:ON ACTION controlp INFIELD pmdt081 name="construct.c.page1.pmdt081"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			
            CALL q_qcbadocno()                          
            
            DISPLAY g_qryparam.return1 TO pmdt081  #顯示到畫面上

            NEXT FIELD pmdt081                     #返回原欄位

            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt081
            #add-point:BEFORE FIELD pmdt081 name="construct.b.page1.pmdt081"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt081
            
            #add-point:AFTER FIELD pmdt081 name="construct.a.page1.pmdt081"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt082
            #add-point:BEFORE FIELD pmdt082 name="construct.b.page1.pmdt082"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt082
            
            #add-point:AFTER FIELD pmdt082 name="construct.a.page1.pmdt082"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt082
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt082
            #add-point:ON ACTION controlp INFIELD pmdt082 name="construct.c.page1.pmdt082"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt083
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt083
            #add-point:ON ACTION controlp INFIELD pmdt083 name="construct.c.page1.pmdt083"
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_ooef025
            CALL q_qcao002_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt083  #顯示到畫面上
            NEXT FIELD pmdt083                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt083
            #add-point:BEFORE FIELD pmdt083 name="construct.b.page1.pmdt083"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt083
            
            #add-point:AFTER FIELD pmdt083 name="construct.a.page1.pmdt083"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt005
            #add-point:BEFORE FIELD pmdt005 name="construct.b.page1.pmdt005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt005
            
            #add-point:AFTER FIELD pmdt005 name="construct.a.page1.pmdt005"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt005
            #add-point:ON ACTION controlp INFIELD pmdt005 name="construct.c.page1.pmdt005"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt006
            #add-point:ON ACTION controlp INFIELD pmdt006 name="construct.c.page1.pmdt006"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_imaf001_15()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt006  #顯示到畫面上

            NEXT FIELD pmdt006                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt006
            #add-point:BEFORE FIELD pmdt006 name="construct.b.page1.pmdt006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt006
            
            #add-point:AFTER FIELD pmdt006 name="construct.a.page1.pmdt006"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt007
            #add-point:BEFORE FIELD pmdt007 name="construct.b.page1.pmdt007"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt007
            
            #add-point:AFTER FIELD pmdt007 name="construct.a.page1.pmdt007"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt007
            #add-point:ON ACTION controlp INFIELD pmdt007 name="construct.c.page1.pmdt007"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt009
            #add-point:ON ACTION controlp INFIELD pmdt009 name="construct.c.page1.pmdt009"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "221" #

            CALL q_oocq002()                               #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt009  #顯示到畫面上

            NEXT FIELD pmdt009                     #返回原欄位

                                               
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt009
            #add-point:BEFORE FIELD pmdt009 name="construct.b.page1.pmdt009"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt009
            
            #add-point:AFTER FIELD pmdt009 name="construct.a.page1.pmdt009"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt010
            #add-point:BEFORE FIELD pmdt010 name="construct.b.page1.pmdt010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt010
            
            #add-point:AFTER FIELD pmdt010 name="construct.a.page1.pmdt010"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt010
            #add-point:ON ACTION controlp INFIELD pmdt010 name="construct.c.page1.pmdt010"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt025
            #add-point:BEFORE FIELD pmdt025 name="construct.b.page1.pmdt025"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt025
            
            #add-point:AFTER FIELD pmdt025 name="construct.a.page1.pmdt025"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt025
            #add-point:ON ACTION controlp INFIELD pmdt025 name="construct.c.page1.pmdt025"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt011
            #add-point:BEFORE FIELD pmdt011 name="construct.b.page1.pmdt011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt011
            
            #add-point:AFTER FIELD pmdt011 name="construct.a.page1.pmdt011"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt011
            #add-point:ON ACTION controlp INFIELD pmdt011 name="construct.c.page1.pmdt011"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt019
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt019
            #add-point:ON ACTION controlp INFIELD pmdt019 name="construct.c.page1.pmdt019"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt019  #顯示到畫面上

            NEXT FIELD pmdt019                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt019
            #add-point:BEFORE FIELD pmdt019 name="construct.b.page1.pmdt019"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt019
            
            #add-point:AFTER FIELD pmdt019 name="construct.a.page1.pmdt019"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt020
            #add-point:BEFORE FIELD pmdt020 name="construct.b.page1.pmdt020"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt020
            
            #add-point:AFTER FIELD pmdt020 name="construct.a.page1.pmdt020"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt020
            #add-point:ON ACTION controlp INFIELD pmdt020 name="construct.c.page1.pmdt020"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt021
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt021
            #add-point:ON ACTION controlp INFIELD pmdt021 name="construct.c.page1.pmdt021"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt021  #顯示到畫面上

            NEXT FIELD pmdt021                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt021
            #add-point:BEFORE FIELD pmdt021 name="construct.b.page1.pmdt021"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt021
            
            #add-point:AFTER FIELD pmdt021 name="construct.a.page1.pmdt021"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt022
            #add-point:BEFORE FIELD pmdt022 name="construct.b.page1.pmdt022"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt022
            
            #add-point:AFTER FIELD pmdt022 name="construct.a.page1.pmdt022"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt022
            #add-point:ON ACTION controlp INFIELD pmdt022 name="construct.c.page1.pmdt022"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt008
            #add-point:ON ACTION controlp INFIELD pmdt008 name="construct.c.page1.pmdt008"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_imaf001_5()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt008  #顯示到畫面上

            NEXT FIELD pmdt008                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt008
            #add-point:BEFORE FIELD pmdt008 name="construct.b.page1.pmdt008"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt008
            
            #add-point:AFTER FIELD pmdt008 name="construct.a.page1.pmdt008"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt023
            #add-point:ON ACTION controlp INFIELD pmdt023 name="construct.c.page1.pmdt023"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt023  #顯示到畫面上

            NEXT FIELD pmdt023                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt023
            #add-point:BEFORE FIELD pmdt023 name="construct.b.page1.pmdt023"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt023
            
            #add-point:AFTER FIELD pmdt023 name="construct.a.page1.pmdt023"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt024
            #add-point:BEFORE FIELD pmdt024 name="construct.b.page1.pmdt024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt024
            
            #add-point:AFTER FIELD pmdt024 name="construct.a.page1.pmdt024"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt024
            #add-point:ON ACTION controlp INFIELD pmdt024 name="construct.c.page1.pmdt024"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt090
            #add-point:BEFORE FIELD pmdt090 name="construct.b.page1.pmdt090"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt090
            
            #add-point:AFTER FIELD pmdt090 name="construct.a.page1.pmdt090"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt090
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt090
            #add-point:ON ACTION controlp INFIELD pmdt090 name="construct.c.page1.pmdt090"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt091
            #add-point:BEFORE FIELD pmdt091 name="construct.b.page1.pmdt091"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt091
            
            #add-point:AFTER FIELD pmdt091 name="construct.a.page1.pmdt091"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt091
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt091
            #add-point:ON ACTION controlp INFIELD pmdt091 name="construct.c.page1.pmdt091"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt036
            #add-point:BEFORE FIELD pmdt036 name="construct.b.page1.pmdt036"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt036
            
            #add-point:AFTER FIELD pmdt036 name="construct.a.page1.pmdt036"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt036
            #add-point:ON ACTION controlp INFIELD pmdt036 name="construct.c.page1.pmdt036"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt046
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt046
            #add-point:ON ACTION controlp INFIELD pmdt046 name="construct.c.page1.pmdt046"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oodb002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt046  #顯示到畫面上

            NEXT FIELD pmdt046                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt046
            #add-point:BEFORE FIELD pmdt046 name="construct.b.page1.pmdt046"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt046
            
            #add-point:AFTER FIELD pmdt046 name="construct.a.page1.pmdt046"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt037
            #add-point:BEFORE FIELD pmdt037 name="construct.b.page1.pmdt037"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt037
            
            #add-point:AFTER FIELD pmdt037 name="construct.a.page1.pmdt037"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt037
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt037
            #add-point:ON ACTION controlp INFIELD pmdt037 name="construct.c.page1.pmdt037"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt038
            #add-point:BEFORE FIELD pmdt038 name="construct.b.page1.pmdt038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt038
            
            #add-point:AFTER FIELD pmdt038 name="construct.a.page1.pmdt038"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt038
            #add-point:ON ACTION controlp INFIELD pmdt038 name="construct.c.page1.pmdt038"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt039
            #add-point:BEFORE FIELD pmdt039 name="construct.b.page1.pmdt039"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt039
            
            #add-point:AFTER FIELD pmdt039 name="construct.a.page1.pmdt039"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt039
            #add-point:ON ACTION controlp INFIELD pmdt039 name="construct.c.page1.pmdt039"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt047
            #add-point:BEFORE FIELD pmdt047 name="construct.b.page1.pmdt047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt047
            
            #add-point:AFTER FIELD pmdt047 name="construct.a.page1.pmdt047"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt047
            #add-point:ON ACTION controlp INFIELD pmdt047 name="construct.c.page1.pmdt047"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt092
            #add-point:BEFORE FIELD pmdt092 name="construct.b.page1.pmdt092"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt092
            
            #add-point:AFTER FIELD pmdt092 name="construct.a.page1.pmdt092"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt092
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt092
            #add-point:ON ACTION controlp INFIELD pmdt092 name="construct.c.page1.pmdt092"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt093
            #add-point:BEFORE FIELD pmdt093 name="construct.b.page1.pmdt093"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt093
            
            #add-point:AFTER FIELD pmdt093 name="construct.a.page1.pmdt093"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt093
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt093
            #add-point:ON ACTION controlp INFIELD pmdt093 name="construct.c.page1.pmdt093"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt026
            #add-point:BEFORE FIELD pmdt026 name="construct.b.page1.pmdt026"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt026
            
            #add-point:AFTER FIELD pmdt026 name="construct.a.page1.pmdt026"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt026
            #add-point:ON ACTION controlp INFIELD pmdt026 name="construct.c.page1.pmdt026"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt041
            #add-point:BEFORE FIELD pmdt041 name="construct.b.page1.pmdt041"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt041
            
            #add-point:AFTER FIELD pmdt041 name="construct.a.page1.pmdt041"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt041
            #add-point:ON ACTION controlp INFIELD pmdt041 name="construct.c.page1.pmdt041"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt062
            #add-point:BEFORE FIELD pmdt062 name="construct.b.page1.pmdt062"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt062
            
            #add-point:AFTER FIELD pmdt062 name="construct.a.page1.pmdt062"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt062
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt062
            #add-point:ON ACTION controlp INFIELD pmdt062 name="construct.c.page1.pmdt062"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt016
            #add-point:ON ACTION controlp INFIELD pmdt016 name="construct.c.page1.pmdt016"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inaa001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt016  #顯示到畫面上

            NEXT FIELD pmdt016                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt016
            #add-point:BEFORE FIELD pmdt016 name="construct.b.page1.pmdt016"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt016
            
            #add-point:AFTER FIELD pmdt016 name="construct.a.page1.pmdt016"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt017
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt017
            #add-point:ON ACTION controlp INFIELD pmdt017 name="construct.c.page1.pmdt017"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inab002_3()                            #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt017  #顯示到畫面上
            NEXT FIELD pmdt017                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt017
            #add-point:BEFORE FIELD pmdt017 name="construct.b.page1.pmdt017"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt017
            
            #add-point:AFTER FIELD pmdt017 name="construct.a.page1.pmdt017"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt018
            #add-point:BEFORE FIELD pmdt018 name="construct.b.page1.pmdt018"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt018
            
            #add-point:AFTER FIELD pmdt018 name="construct.a.page1.pmdt018"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt018
            #add-point:ON ACTION controlp INFIELD pmdt018 name="construct.c.page1.pmdt018"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt063
            #add-point:BEFORE FIELD pmdt063 name="construct.b.page1.pmdt063"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt063
            
            #add-point:AFTER FIELD pmdt063 name="construct.a.page1.pmdt063"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt063
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt063
            #add-point:ON ACTION controlp INFIELD pmdt063 name="construct.c.page1.pmdt063"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt072
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt072
            #add-point:ON ACTION controlp INFIELD pmdt072 name="construct.c.page1.pmdt072"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pjba001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt072  #顯示到畫面上
            NEXT FIELD pmdt072                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt072
            #add-point:BEFORE FIELD pmdt072 name="construct.b.page1.pmdt072"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt072
            
            #add-point:AFTER FIELD pmdt072 name="construct.a.page1.pmdt072"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt073
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt073
            #add-point:ON ACTION controlp INFIELD pmdt073 name="construct.c.page1.pmdt073"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pjbb002_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt073  #顯示到畫面上
            NEXT FIELD pmdt073                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt073
            #add-point:BEFORE FIELD pmdt073 name="construct.b.page1.pmdt073"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt073
            
            #add-point:AFTER FIELD pmdt073 name="construct.a.page1.pmdt073"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt074
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt074
            #add-point:ON ACTION controlp INFIELD pmdt074 name="construct.c.page1.pmdt074"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pjbm002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt074  #顯示到畫面上
            NEXT FIELD pmdt074                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt074
            #add-point:BEFORE FIELD pmdt074 name="construct.b.page1.pmdt074"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt074
            
            #add-point:AFTER FIELD pmdt074 name="construct.a.page1.pmdt074"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt075
            #add-point:BEFORE FIELD pmdt075 name="construct.b.page1.pmdt075"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt075
            
            #add-point:AFTER FIELD pmdt075 name="construct.a.page1.pmdt075"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt075
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt075
            #add-point:ON ACTION controlp INFIELD pmdt075 name="construct.c.page1.pmdt075"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt075_desc
            #add-point:BEFORE FIELD pmdt075_desc name="construct.b.page1.pmdt075_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt075_desc
            
            #add-point:AFTER FIELD pmdt075_desc name="construct.a.page1.pmdt075_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt075_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt075_desc
            #add-point:ON ACTION controlp INFIELD pmdt075_desc name="construct.c.page1.pmdt075_desc"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt051
            #add-point:ON ACTION controlp INFIELD pmdt051 name="construct.c.page1.pmdt051"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_acc
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt051  #顯示到畫面上

            NEXT FIELD pmdt051                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt051
            #add-point:BEFORE FIELD pmdt051 name="construct.b.page1.pmdt051"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt051
            
            #add-point:AFTER FIELD pmdt051 name="construct.a.page1.pmdt051"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt070
            #add-point:BEFORE FIELD pmdt070 name="construct.b.page1.pmdt070"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt070
            
            #add-point:AFTER FIELD pmdt070 name="construct.a.page1.pmdt070"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt070
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt070
            #add-point:ON ACTION controlp INFIELD pmdt070 name="construct.c.page1.pmdt070"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt071
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt071
            #add-point:ON ACTION controlp INFIELD pmdt071 name="construct.c.page1.pmdt071"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_pmdt070()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt071  #顯示到畫面上
            NEXT FIELD pmdt071                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt071
            #add-point:BEFORE FIELD pmdt071 name="construct.b.page1.pmdt071"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt071
            
            #add-point:AFTER FIELD pmdt071 name="construct.a.page1.pmdt071"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt059
            #add-point:BEFORE FIELD pmdt059 name="construct.b.page1.pmdt059"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt059
            
            #add-point:AFTER FIELD pmdt059 name="construct.a.page1.pmdt059"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt059
            #add-point:ON ACTION controlp INFIELD pmdt059 name="construct.c.page1.pmdt059"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt053
            #add-point:BEFORE FIELD pmdt053 name="construct.b.page1.pmdt053"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt053
            
            #add-point:AFTER FIELD pmdt053 name="construct.a.page1.pmdt053"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt053
            #add-point:ON ACTION controlp INFIELD pmdt053 name="construct.c.page1.pmdt053"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt054
            #add-point:BEFORE FIELD pmdt054 name="construct.b.page1.pmdt054"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt054
            
            #add-point:AFTER FIELD pmdt054 name="construct.a.page1.pmdt054"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt054
            #add-point:ON ACTION controlp INFIELD pmdt054 name="construct.c.page1.pmdt054"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt055
            #add-point:BEFORE FIELD pmdt055 name="construct.b.page1.pmdt055"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt055
            
            #add-point:AFTER FIELD pmdt055 name="construct.a.page1.pmdt055"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt055
            #add-point:ON ACTION controlp INFIELD pmdt055 name="construct.c.page1.pmdt055"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt060
            #add-point:BEFORE FIELD pmdt060 name="construct.b.page1.pmdt060"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt060
            
            #add-point:AFTER FIELD pmdt060 name="construct.a.page1.pmdt060"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt060
            #add-point:ON ACTION controlp INFIELD pmdt060 name="construct.c.page1.pmdt060"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt061
            #add-point:BEFORE FIELD pmdt061 name="construct.b.page1.pmdt061"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt061
            
            #add-point:AFTER FIELD pmdt061 name="construct.a.page1.pmdt061"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt061
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt061
            #add-point:ON ACTION controlp INFIELD pmdt061 name="construct.c.page1.pmdt061"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt042
            #add-point:BEFORE FIELD pmdt042 name="construct.b.page1.pmdt042"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt042
            
            #add-point:AFTER FIELD pmdt042 name="construct.a.page1.pmdt042"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt042
            #add-point:ON ACTION controlp INFIELD pmdt042 name="construct.c.page1.pmdt042"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt043
            #add-point:BEFORE FIELD pmdt043 name="construct.b.page1.pmdt043"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt043
            
            #add-point:AFTER FIELD pmdt043 name="construct.a.page1.pmdt043"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt043
            #add-point:ON ACTION controlp INFIELD pmdt043 name="construct.c.page1.pmdt043"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt048
            #add-point:BEFORE FIELD pmdt048 name="construct.b.page1.pmdt048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt048
            
            #add-point:AFTER FIELD pmdt048 name="construct.a.page1.pmdt048"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt048
            #add-point:ON ACTION controlp INFIELD pmdt048 name="construct.c.page1.pmdt048"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt044
            #add-point:BEFORE FIELD pmdt044 name="construct.b.page1.pmdt044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt044
            
            #add-point:AFTER FIELD pmdt044 name="construct.a.page1.pmdt044"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt044
            #add-point:ON ACTION controlp INFIELD pmdt044 name="construct.c.page1.pmdt044"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt045
            #add-point:BEFORE FIELD pmdt045 name="construct.b.page1.pmdt045"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt045
            
            #add-point:AFTER FIELD pmdt045 name="construct.a.page1.pmdt045"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt045
            #add-point:ON ACTION controlp INFIELD pmdt045 name="construct.c.page1.pmdt045"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt049
            #add-point:BEFORE FIELD pmdt049 name="construct.b.page1.pmdt049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt049
            
            #add-point:AFTER FIELD pmdt049 name="construct.a.page1.pmdt049"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt049
            #add-point:ON ACTION controlp INFIELD pmdt049 name="construct.c.page1.pmdt049"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt050
            #add-point:BEFORE FIELD pmdt050 name="construct.b.page1.pmdt050"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt050
            
            #add-point:AFTER FIELD pmdt050 name="construct.a.page1.pmdt050"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt050
            #add-point:ON ACTION controlp INFIELD pmdt050 name="construct.c.page1.pmdt050"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt084
            #add-point:BEFORE FIELD pmdt084 name="construct.b.page1.pmdt084"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt084
            
            #add-point:AFTER FIELD pmdt084 name="construct.a.page1.pmdt084"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt084
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt084
            #add-point:ON ACTION controlp INFIELD pmdt084 name="construct.c.page1.pmdt084"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt219
            #add-point:BEFORE FIELD pmdt219 name="construct.b.page1.pmdt219"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt219
            
            #add-point:AFTER FIELD pmdt219 name="construct.a.page1.pmdt219"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt219
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt219
            #add-point:ON ACTION controlp INFIELD pmdt219 name="construct.c.page1.pmdt219"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt089
            #add-point:BEFORE FIELD pmdt089 name="construct.b.page1.pmdt089"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt089
            
            #add-point:AFTER FIELD pmdt089 name="construct.a.page1.pmdt089"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt089
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt089
            #add-point:ON ACTION controlp INFIELD pmdt089 name="construct.c.page1.pmdt089"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt088
            #add-point:BEFORE FIELD pmdt088 name="construct.b.page1.pmdt088"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt088
            
            #add-point:AFTER FIELD pmdt088 name="construct.a.page1.pmdt088"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt088
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt088
            #add-point:ON ACTION controlp INFIELD pmdt088 name="construct.c.page1.pmdt088"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD ooff013
            #add-point:BEFORE FIELD ooff013 name="construct.b.page1.ooff013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD ooff013
            
            #add-point:AFTER FIELD ooff013 name="construct.a.page1.ooff013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.ooff013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD ooff013
            #add-point:ON ACTION controlp INFIELD ooff013 name="construct.c.page1.ooff013"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
      
      CONSTRUCT g_wc2_table2 ON pmduseq,pmdu001,pmdu002,pmdu003,pmdu004,pmdu006,pmdu007,pmdu008,pmdu005, 
          pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016
           FROM s_detail2[1].pmduseq,s_detail2[1].pmdu001,s_detail2[1].pmdu002,s_detail2[1].pmdu003, 
               s_detail2[1].pmdu004,s_detail2[1].pmdu006,s_detail2[1].pmdu007,s_detail2[1].pmdu008,s_detail2[1].pmdu005, 
               s_detail2[1].pmdu009,s_detail2[1].pmdu010,s_detail2[1].pmdu011,s_detail2[1].pmdu012,s_detail2[1].pmdu013, 
               s_detail2[1].pmdu014,s_detail2[1].pmdu015,s_detail2[1].pmdu202,s_detail2[1].pmdu017,s_detail2[1].pmdu016 
 
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body2.before_construct"
 
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 2)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmduseq
            #add-point:BEFORE FIELD pmduseq name="construct.b.page2.pmduseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmduseq
            
            #add-point:AFTER FIELD pmduseq name="construct.a.page2.pmduseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmduseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmduseq
            #add-point:ON ACTION controlp INFIELD pmduseq name="construct.c.page2.pmduseq"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu001
            #add-point:ON ACTION controlp INFIELD pmdu001 name="construct.c.page2.pmdu001"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_imaf001_15()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu001  #顯示到畫面上

            NEXT FIELD pmdu001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu001
            #add-point:BEFORE FIELD pmdu001 name="construct.b.page2.pmdu001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu001
            
            #add-point:AFTER FIELD pmdu001 name="construct.a.page2.pmdu001"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu002
            #add-point:BEFORE FIELD pmdu002 name="construct.b.page2.pmdu002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu002
            
            #add-point:AFTER FIELD pmdu002 name="construct.a.page2.pmdu002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu002
            #add-point:ON ACTION controlp INFIELD pmdu002 name="construct.c.page2.pmdu002"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu003
            #add-point:BEFORE FIELD pmdu003 name="construct.b.page2.pmdu003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu003
            
            #add-point:AFTER FIELD pmdu003 name="construct.a.page2.pmdu003"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu003
            #add-point:ON ACTION controlp INFIELD pmdu003 name="construct.c.page2.pmdu003"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "221" #

            CALL q_oocq002()                               #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu003  #顯示到畫面上

            NEXT FIELD pmdu003                     #返回原欄位

                                                               
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu004
            #add-point:BEFORE FIELD pmdu004 name="construct.b.page2.pmdu004"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu004
            
            #add-point:AFTER FIELD pmdu004 name="construct.a.page2.pmdu004"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu004
            #add-point:ON ACTION controlp INFIELD pmdu004 name="construct.c.page2.pmdu004"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu006
            #add-point:ON ACTION controlp INFIELD pmdu006 name="construct.c.page2.pmdu006"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu006  #顯示到畫面上

            NEXT FIELD pmdu006                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu006
            #add-point:BEFORE FIELD pmdu006 name="construct.b.page2.pmdu006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu006
            
            #add-point:AFTER FIELD pmdu006 name="construct.a.page2.pmdu006"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu007
            #add-point:ON ACTION controlp INFIELD pmdu007 name="construct.c.page2.pmdu007"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inab002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu007  #顯示到畫面上

            NEXT FIELD pmdu007                     #返回原欄位

                                    
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu007
            #add-point:BEFORE FIELD pmdu007 name="construct.b.page2.pmdu007"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu007
            
            #add-point:AFTER FIELD pmdu007 name="construct.a.page2.pmdu007"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu008
            #add-point:BEFORE FIELD pmdu008 name="construct.b.page2.pmdu008"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu008
            
            #add-point:AFTER FIELD pmdu008 name="construct.a.page2.pmdu008"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu008
            #add-point:ON ACTION controlp INFIELD pmdu008 name="construct.c.page2.pmdu008"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu005
            #add-point:BEFORE FIELD pmdu005 name="construct.b.page2.pmdu005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu005
            
            #add-point:AFTER FIELD pmdu005 name="construct.a.page2.pmdu005"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu005
            #add-point:ON ACTION controlp INFIELD pmdu005 name="construct.c.page2.pmdu005"
 
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu009
            #add-point:ON ACTION controlp INFIELD pmdu009 name="construct.c.page2.pmdu009"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu009  #顯示到畫面上

            NEXT FIELD pmdu009                     #返回原欄位

                                    
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu009
            #add-point:BEFORE FIELD pmdu009 name="construct.b.page2.pmdu009"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu009
            
            #add-point:AFTER FIELD pmdu009 name="construct.a.page2.pmdu009"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu010
            #add-point:BEFORE FIELD pmdu010 name="construct.b.page2.pmdu010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu010
            
            #add-point:AFTER FIELD pmdu010 name="construct.a.page2.pmdu010"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu010
            #add-point:ON ACTION controlp INFIELD pmdu010 name="construct.c.page2.pmdu010"
 
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu011
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu011
            #add-point:ON ACTION controlp INFIELD pmdu011 name="construct.c.page2.pmdu011"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu011  #顯示到畫面上

            NEXT FIELD pmdu011                     #返回原欄位
                                            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu011
            #add-point:BEFORE FIELD pmdu011 name="construct.b.page2.pmdu011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu011
            
            #add-point:AFTER FIELD pmdu011 name="construct.a.page2.pmdu011"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu012
            #add-point:BEFORE FIELD pmdu012 name="construct.b.page2.pmdu012"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu012
            
            #add-point:AFTER FIELD pmdu012 name="construct.a.page2.pmdu012"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu012
            #add-point:ON ACTION controlp INFIELD pmdu012 name="construct.c.page2.pmdu012"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu013
            #add-point:BEFORE FIELD pmdu013 name="construct.b.page2.pmdu013"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu013
            
            #add-point:AFTER FIELD pmdu013 name="construct.a.page2.pmdu013"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu013
            #add-point:ON ACTION controlp INFIELD pmdu013 name="construct.c.page2.pmdu013"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu014
            #add-point:BEFORE FIELD pmdu014 name="construct.b.page2.pmdu014"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu014
            
            #add-point:AFTER FIELD pmdu014 name="construct.a.page2.pmdu014"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu014
            #add-point:ON ACTION controlp INFIELD pmdu014 name="construct.c.page2.pmdu014"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu015
            #add-point:BEFORE FIELD pmdu015 name="construct.b.page2.pmdu015"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu015
            
            #add-point:AFTER FIELD pmdu015 name="construct.a.page2.pmdu015"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu015
            #add-point:ON ACTION controlp INFIELD pmdu015 name="construct.c.page2.pmdu015"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu202
            #add-point:BEFORE FIELD pmdu202 name="construct.b.page2.pmdu202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu202
            
            #add-point:AFTER FIELD pmdu202 name="construct.a.page2.pmdu202"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu202
            #add-point:ON ACTION controlp INFIELD pmdu202 name="construct.c.page2.pmdu202"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu017
            #add-point:BEFORE FIELD pmdu017 name="construct.b.page2.pmdu017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu017
            
            #add-point:AFTER FIELD pmdu017 name="construct.a.page2.pmdu017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu017
            #add-point:ON ACTION controlp INFIELD pmdu017 name="construct.c.page2.pmdu017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu016
            #add-point:BEFORE FIELD pmdu016 name="construct.b.page2.pmdu016"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu016
            
            #add-point:AFTER FIELD pmdu016 name="construct.a.page2.pmdu016"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu016
            #add-point:ON ACTION controlp INFIELD pmdu016 name="construct.c.page2.pmdu016"
                                                
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table3 ON pmdvseq,pmdvseq1,pmdv005,pmdv001,pmdv002,pmdv003,pmdv004,pmdv014,pmdv015, 
          pmdv016,pmdv017,pmdv018,pmdv019
           FROM s_detail3[1].pmdvseq,s_detail3[1].pmdvseq1,s_detail3[1].pmdv005,s_detail3[1].pmdv001, 
               s_detail3[1].pmdv002,s_detail3[1].pmdv003,s_detail3[1].pmdv004,s_detail3[1].pmdv014,s_detail3[1].pmdv015, 
               s_detail3[1].pmdv016,s_detail3[1].pmdv017,s_detail3[1].pmdv018,s_detail3[1].pmdv019
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body3.before_construct"
 
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 3)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdvseq
            #add-point:BEFORE FIELD pmdvseq name="construct.b.page3.pmdvseq"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdvseq
            
            #add-point:AFTER FIELD pmdvseq name="construct.a.page3.pmdvseq"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdvseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdvseq
            #add-point:ON ACTION controlp INFIELD pmdvseq name="construct.c.page3.pmdvseq"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdvseq1
            #add-point:BEFORE FIELD pmdvseq1 name="construct.b.page3.pmdvseq1"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdvseq1
            
            #add-point:AFTER FIELD pmdvseq1 name="construct.a.page3.pmdvseq1"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdvseq1
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdvseq1
            #add-point:ON ACTION controlp INFIELD pmdvseq1 name="construct.c.page3.pmdvseq1"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv005
            #add-point:BEFORE FIELD pmdv005 name="construct.b.page3.pmdv005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv005
            
            #add-point:AFTER FIELD pmdv005 name="construct.a.page3.pmdv005"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv005
            #add-point:ON ACTION controlp INFIELD pmdv005 name="construct.c.page3.pmdv005"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdv001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv001
            #add-point:ON ACTION controlp INFIELD pmdv001 name="construct.c.page3.pmdv001"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_imaf001_15()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdv001  #顯示到畫面上
            NEXT FIELD pmdv001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv001
            #add-point:BEFORE FIELD pmdv001 name="construct.b.page3.pmdv001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv001
            
            #add-point:AFTER FIELD pmdv001 name="construct.a.page3.pmdv001"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv002
            #add-point:BEFORE FIELD pmdv002 name="construct.b.page3.pmdv002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv002
            
            #add-point:AFTER FIELD pmdv002 name="construct.a.page3.pmdv002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv002
            #add-point:ON ACTION controlp INFIELD pmdv002 name="construct.c.page3.pmdv002"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv003
            #add-point:BEFORE FIELD pmdv003 name="construct.b.page3.pmdv003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv003
            
            #add-point:AFTER FIELD pmdv003 name="construct.a.page3.pmdv003"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv003
            #add-point:ON ACTION controlp INFIELD pmdv003 name="construct.c.page3.pmdv003"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "221" #

            CALL q_oocq002()                               #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdv003  #顯示到畫面上

            NEXT FIELD pmdv003                     #返回原欄位
                                       
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv004
            #add-point:BEFORE FIELD pmdv004 name="construct.b.page3.pmdv004"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv004
            
            #add-point:AFTER FIELD pmdv004 name="construct.a.page3.pmdv004"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv004
            #add-point:ON ACTION controlp INFIELD pmdv004 name="construct.c.page3.pmdv004"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv014
            #add-point:BEFORE FIELD pmdv014 name="construct.b.page3.pmdv014"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv014
            
            #add-point:AFTER FIELD pmdv014 name="construct.a.page3.pmdv014"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv014
            #add-point:ON ACTION controlp INFIELD pmdv014 name="construct.c.page3.pmdv014"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv015
            #add-point:BEFORE FIELD pmdv015 name="construct.b.page3.pmdv015"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv015
            
            #add-point:AFTER FIELD pmdv015 name="construct.a.page3.pmdv015"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv015
            #add-point:ON ACTION controlp INFIELD pmdv015 name="construct.c.page3.pmdv015"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv016
            #add-point:BEFORE FIELD pmdv016 name="construct.b.page3.pmdv016"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv016
            
            #add-point:AFTER FIELD pmdv016 name="construct.a.page3.pmdv016"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv016
            #add-point:ON ACTION controlp INFIELD pmdv016 name="construct.c.page3.pmdv016"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv017
            #add-point:BEFORE FIELD pmdv017 name="construct.b.page3.pmdv017"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv017
            
            #add-point:AFTER FIELD pmdv017 name="construct.a.page3.pmdv017"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv017
            #add-point:ON ACTION controlp INFIELD pmdv017 name="construct.c.page3.pmdv017"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdv018
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv018
            #add-point:ON ACTION controlp INFIELD pmdv018 name="construct.c.page3.pmdv018"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdv018  #顯示到畫面上
            NEXT FIELD pmdv018                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv018
            #add-point:BEFORE FIELD pmdv018 name="construct.b.page3.pmdv018"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv018
            
            #add-point:AFTER FIELD pmdv018 name="construct.a.page3.pmdv018"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv019
            #add-point:BEFORE FIELD pmdv019 name="construct.b.page3.pmdv019"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv019
            
            #add-point:AFTER FIELD pmdv019 name="construct.a.page3.pmdv019"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv019
            #add-point:ON ACTION controlp INFIELD pmdv019 name="construct.c.page3.pmdv019"
                                                
            #END add-point
 
 
   
       
      END CONSTRUCT
 
 
      
 
      
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令) name="cs.add_cs"
      SUBDIALOG aoo_aooi360_01.aooi360_01_construct   #备注单身  #161031-00025#15 add                   
      #end add-point
 
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段b_dialog name="cs.b_dialog"
         LET g_pmdt_d[1].pmdtseq = ""
         DISPLAY ARRAY g_pmdt_d TO s_detail1.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY  
         LET g_pmdt2_d[1].pmduseq1 = ""
         DISPLAY ARRAY g_pmdt2_d TO s_detail2.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY  
         LET g_pmdt3_d[1].pmdvseq1 = ""
         DISPLAY ARRAY g_pmdt3_d TO s_detail3.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY    
         
         #end add-point  
 
      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
         IF NOT cl_null(ls_wc) THEN
            CALL util.JSON.parse(ls_wc, la_wc)
            INITIALIZE g_wc, g_wc2, g_wc2_table1, g_wc2_extend TO NULL
            INITIALIZE g_wc2_table2 TO NULL
 
            INITIALIZE g_wc2_table3 TO NULL
 
 
            FOR li_idx = 1 TO la_wc.getLength()
               CASE
                  WHEN la_wc[li_idx].tableid = "pmds_t" 
                     LET g_wc = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "pmdt_t" 
                     LET g_wc2_table1 = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "pmdu_t" 
                     LET g_wc2_table2 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "pmdv_t" 
                     LET g_wc2_table3 = la_wc[li_idx].wc
 
 
               END CASE
            END FOR
         END IF
    
      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   IF g_wc2_table2 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
   END IF
 
   IF g_wc2_table3 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
   END IF
 
 
 
 
   
   #add-point:cs段結束前 name="cs.after_construct"
   #160413-00011#9--add---begin---
   IF cl_null(g_wc) THEN
      LET g_wc = " pmdssite = '",g_site,"' "
   ELSE
      LET g_wc = g_wc," AND pmdssite = '",g_site,"' "
   END IF
   
   IF NOT cl_null(g_argv[1]) THEN
      LET g_wc = g_wc," AND pmds000 = '", g_argv[1], "' "
   END IF    
   #160413-00011#9--add---end---           
   #end add-point    
 
   IF INT_FLAG THEN
      RETURN
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.filter" >}
#應用 a50 樣板自動產生(Version:8)
#+ filter過濾功能
PRIVATE FUNCTION apmt520_filter()
   #add-point:filter段define name="filter.define_customerization"
   
   #end add-point   
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="filter.pre_function"
   
   #end add-point
   
   #切換畫面
   IF NOT g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF   
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter.trim()
   LET g_wc_t = g_wc
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter_t, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON pmdsdocno,pmdsdocdt,pmds002,pmds003,pmds007,pmds008,pmds009
                          FROM s_browse[1].b_pmdsdocno,s_browse[1].b_pmdsdocdt,s_browse[1].b_pmds002, 
                              s_browse[1].b_pmds003,s_browse[1].b_pmds007,s_browse[1].b_pmds008,s_browse[1].b_pmds009 
 
 
         BEFORE CONSTRUCT
               DISPLAY apmt520_filter_parser('pmdsdocno') TO s_browse[1].b_pmdsdocno
            DISPLAY apmt520_filter_parser('pmdsdocdt') TO s_browse[1].b_pmdsdocdt
            DISPLAY apmt520_filter_parser('pmds002') TO s_browse[1].b_pmds002
            DISPLAY apmt520_filter_parser('pmds003') TO s_browse[1].b_pmds003
            DISPLAY apmt520_filter_parser('pmds007') TO s_browse[1].b_pmds007
            DISPLAY apmt520_filter_parser('pmds008') TO s_browse[1].b_pmds008
            DISPLAY apmt520_filter_parser('pmds009') TO s_browse[1].b_pmds009
      
         #add-point:filter段cs_ctrl name="filter.cs_ctrl"
         
         #end add-point
      
      END CONSTRUCT
 
      #add-point:filter段add_cs name="filter.add_cs"
                        
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog name="filter.b_dialog"
                                    
         #end add-point  
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
      LET g_wc = g_wc , g_wc_filter
   ELSE
      LET g_wc_filter = g_wc_filter_t
      LET g_wc = g_wc_t
   END IF
 
      CALL apmt520_filter_show('pmdsdocno')
   CALL apmt520_filter_show('pmdsdocdt')
   CALL apmt520_filter_show('pmds002')
   CALL apmt520_filter_show('pmds003')
   CALL apmt520_filter_show('pmds007')
   CALL apmt520_filter_show('pmds008')
   CALL apmt520_filter_show('pmds009')
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.filter_parser" >}
#+ filter過濾功能
PRIVATE FUNCTION apmt520_filter_parser(ps_field)
   #add-point:filter段define name="filter_parser.define_customerization"
   
   #end add-point    
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter_parser.define"
            
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.filter_show" >}
#+ 顯示過濾條件
PRIVATE FUNCTION apmt520_filter_show(ps_field)
   DEFINE ps_field         STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.b_", ps_field
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = apmt520_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.query" >}
#+ 資料查詢QBE功能準備
PRIVATE FUNCTION apmt520_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point   
   DEFINE ls_wc STRING
   #add-point:query段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF   
   
   LET ls_wc = g_wc
   
   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()       
   CALL g_pmdt_d.clear()
   CALL g_pmdt2_d.clear()
   CALL g_pmdt3_d.clear()
 
   
   #add-point:query段other name="query.other"
   CALL s_lot_clear_detail() 
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#15 add   
   #end add-point   
   
   DISPLAY '' TO FORMONLY.idx
   DISPLAY '' TO FORMONLY.cnt
   DISPLAY '' TO FORMONLY.b_index
   DISPLAY '' TO FORMONLY.b_count
   DISPLAY '' TO FORMONLY.h_index
   DISPLAY '' TO FORMONLY.h_count
   
   CALL apmt520_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      #LET g_wc = ls_wc
      LET g_wc = " 1=2"
      CALL apmt520_browser_fill("")
      CALL apmt520_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化 
   LET g_detail_cnt  = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   LET g_detail_idx_list[1] = 1
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
 
   LET g_error_show  = 1
   LET g_wc_filter   = ""
   LET l_ac = 1
   CALL FGL_SET_ARR_CURR(1)
      CALL apmt520_filter_show('pmdsdocno')
   CALL apmt520_filter_show('pmdsdocdt')
   CALL apmt520_filter_show('pmds002')
   CALL apmt520_filter_show('pmds003')
   CALL apmt520_filter_show('pmds007')
   CALL apmt520_filter_show('pmds008')
   CALL apmt520_filter_show('pmds009')
   CALL apmt520_browser_fill("F")
         
   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "-100" 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
   ELSE
      CALL apmt520_fetch("F") 
      #顯示單身筆數
      CALL apmt520_idx_chk()
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.fetch" >}
#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION apmt520_fetch(p_flag)
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point    
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fetch.define"
 
   #end add-point    
   
   #add-point:Function前置處理  name="fetch.pre_function"
   
   #end add-point
   
   IF g_browser_cnt = 0 THEN
      RETURN
   END IF
 
   #清空第二階單身
 
   
   CALL cl_ap_performance_next_start()
   CASE p_flag
      WHEN 'F' 
         LET g_current_idx = 1
      WHEN 'L'  
         LET g_current_idx = g_browser.getLength()              
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         LET g_no_ask = FALSE  
   END CASE 
 
   CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引
   
   LET g_current_row = g_current_idx
   LET g_detail_cnt = g_header_cnt                  
   
   #單身總筆數顯示
   IF g_detail_cnt > 0 THEN
      #若單身有資料時, idx至少為1
      IF g_detail_idx <= 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx  
   ELSE
      LET g_detail_idx = 0
      DISPLAY '' TO FORMONLY.idx    
   END IF
   
   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )
 
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #避免超出browser資料筆數上限
   IF g_current_idx > g_browser.getLength() THEN
      LET g_browser_idx = g_browser.getLength()
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_pmds_m.pmdsdocno = g_browser[g_current_idx].b_pmdsdocno
 
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
       g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
       g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
       g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
       g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
       g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc,g_pmds_m.pmdsownid_desc, 
       g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt520_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt520_set_act_visible()   
   CALL apmt520_set_act_no_visible()
   
   #add-point:fetch段action控制 name="fetch.action_control"
 
   #end add-point  
   
   
   
   #add-point:fetch結束前 name="fetch.after"
            
   #end add-point
   
   #保存單頭舊值
   LET g_pmds_m_t.* = g_pmds_m.*
   LET g_pmds_m_o.* = g_pmds_m.*
   
   LET g_data_owner = g_pmds_m.pmdsownid      
   LET g_data_dept  = g_pmds_m.pmdsowndp
   
   #重新顯示   
   CALL apmt520_show()
 
   #應用 a56 樣板自動產生(Version:3)
   #檢查此單據是否需顯示BPM簽核狀況按鈕 
   IF cl_bpm_chk() THEN
      CALL cl_set_act_visible("bpm_status",TRUE)
   ELSE
      CALL cl_set_act_visible("bpm_status",FALSE)
   END IF
 
 
 
 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.insert" >}
#+ 資料新增
PRIVATE FUNCTION apmt520_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"
   
   #end add-point    
   #add-point:insert段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="insert.pre_function"
   
   #end add-point
   
   #清畫面欄位內容
   CLEAR FORM                    
   CALL g_pmdt_d.clear()   
   CALL g_pmdt2_d.clear()  
   CALL g_pmdt3_d.clear()  
 
 
   INITIALIZE g_pmds_m.* TO NULL             #DEFAULT 設定
   
   LET g_pmdsdocno_t = NULL
 
   
   LET g_master_insert = FALSE
   
   #add-point:insert段before name="insert.before"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#15 add
   #end add-point    
   
   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_pmds_m.pmdsownid = g_user
      LET g_pmds_m.pmdsowndp = g_dept
      LET g_pmds_m.pmdscrtid = g_user
      LET g_pmds_m.pmdscrtdp = g_dept 
      LET g_pmds_m.pmdscrtdt = cl_get_current()
      LET g_pmds_m.pmdsmodid = g_user
      LET g_pmds_m.pmdsmoddt = cl_get_current()
      LET g_pmds_m.pmdsstus = 'N'
 
 
 
 
      #append欄位給值
      
     
      #一般欄位給值
            LET g_pmds_m.pmds100 = "3"
      LET g_pmds_m.pmds011 = "1"
      LET g_pmds_m.pmds014 = "1"
      LET g_pmds_m.pmds021 = "N"
      LET g_pmds_m.pmds036 = "1"
      LET g_pmds_m.pmds103 = "1"
      LET g_pmds_m.pmds048 = "1"
      LET g_pmds_m.pmds047 = "N"
      LET g_pmds_m.pmds049 = "1"
      LET g_pmds_m.pmds043 = "0"
      LET g_pmds_m.pmds044 = "0"
      LET g_pmds_m.pmds046 = "0"
      LET g_pmds_m.pmds054 = "1"
      LET g_pmds_m.pmds050 = "N"
      LET g_pmds_m.pmds057 = "1"
 
  
      #add-point:單頭預設值 name="insert.default"
      CALL g_pmdt4_d.clear()  
      CALL s_lot_clear_detail()
      
      IF NOT cl_null(g_argv[1]) THEN
         LET g_pmds_m.pmds000 = g_argv[1]
      END IF
      
      LET g_pmds_m.pmdssite = g_site
      LET g_pmds_m.pmdsstus = "N"
      
      LET g_pmds_m.pmdsdocdt = g_today
      
      LET g_pmds_m.pmds001 = g_today  #扣賬日期
      
      LET g_pmds_m.pmds002 = g_user
      LET g_pmds_m.pmds003 = g_dept
      
      LET g_pmds_m.pmds011 = "1"
      
      IF g_argv[1] = '8' OR g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14' OR g_argv[1] = '20' THEN
         LET g_pmds_m.pmds011 = "2"
      END IF
      IF g_argv[1] = '9' OR g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' THEN
         LET g_pmds_m.pmds011 = "5"
      END IF
      IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
         LET g_pmds_m.pmds011 = "6"
      END IF
      
      
      LET g_pmds_m.pmds100 = "3"
      
      #委外倉退的倉退方式只能選4.倉退折讓，其他的都不能選，請在輸入時限制
      IF g_argv[1] = '14' THEN
         LET g_pmds_m.pmds100 = "4"
      END IF
      
      #借貨歸還單，倉退類型預設為1
      IF g_argv[1] = '26' THEN
         LET g_pmds_m.pmds100 = "1"
      END IF
      
      CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
      CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
      DISPLAY BY NAME g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc
      
      INITIALIZE g_pmds_m_t.* TO NULL
      LET g_pmds_m_t.*  = g_pmds_m.* 
      LET g_pmds_m_o.*  = g_pmds_m.* 
      #161031-00025#15 add(s)
      LET g_ooff001_d = '6'   #6.單據單頭備註
      LET g_ooff002_d = g_prog
      LET g_ooff003_d = ''    #单号
      LET g_ooff004_d = 0     #项次
      LET g_ooff005_d = ' '
      LET g_ooff006_d = ' '
      LET g_ooff007_d = ' '
      LET g_ooff008_d = ' '
      LET g_ooff009_d = ' '
      LET g_ooff010_d = ' '
      LET g_ooff011_d = ' '
      #161031-00025#15 add(e) 
      #end add-point 
      
      #保存單頭舊值(用於資料輸入錯誤還原預設值時使用)
      LET g_pmds_m_t.* = g_pmds_m.*
      LET g_pmds_m_o.* = g_pmds_m.*
      
      #顯示狀態(stus)圖片
            #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmds_m.pmdsstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
 
 
 
    
      CALL apmt520_input("a")
      
      #add-point:單頭輸入後 name="insert.after_insert"
      #161207-00033#38---s
      #供应商的一次交易对象或内部员工时，单头新增后，需更新pmak中的参考单号为单头完整单号
      #无采购收货单，维护供应商是一次性交易对象时，需产生一次性交易对象识别码
      IF g_argv[1] MATCHES '[24]' THEN
         UPDATE pmak_t SET pmak006 = g_pmds_m.pmdsdocno WHERE pmakent = g_enterprise AND pmak001 = g_pmds_m.pmds028
         IF INT_FLAG  AND (NOT cl_null(g_pmds_m.pmds028)) THEN
            DELETE FROM pmak_t WHERE pmakent = g_enterprise AND pmak001 = g_pmds_m.pmds028
         END IF
      END IF
      #161207-00033#38---e
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
      END IF
      
      IF NOT g_master_insert THEN
         DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
         DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
         INITIALIZE g_pmds_m.* TO NULL
         INITIALIZE g_pmdt_d TO NULL
         INITIALIZE g_pmdt2_d TO NULL
         INITIALIZE g_pmdt3_d TO NULL
 
         #add-point:取消新增後 name="insert.cancel"
         
         #end add-point 
         CALL apmt520_show()
         RETURN
      END IF
      
      LET INT_FLAG = 0
      #CALL g_pmdt_d.clear()
      #CALL g_pmdt2_d.clear()
      #CALL g_pmdt3_d.clear()
 
 
      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE
        
   END WHILE
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt520_set_act_visible()   
   CALL apmt520_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                      " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
                      
   #add-point:組合新增資料的條件後 name="insert.after.add_browse"
   
   #end add-point
      
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL apmt520_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   CLOSE apmt520_cl
   
   CALL apmt520_idx_chk()
   
   #撈取異動後的資料(主要是帶出reference)
   EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
       g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
       g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
       g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
       g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
       g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc,g_pmds_m.pmdsownid_desc, 
       g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
   
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt520_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001, 
       g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus, 
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008,g_pmds_m.pmds008_desc, 
       g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000, 
       g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds031_desc,g_pmds_m.pmds032, 
       g_pmds_m.pmds032_desc,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds039_desc, 
       g_pmds_m.pmds040,g_pmds_m.pmds040_desc,g_pmds_m.pmds012,g_pmds_m.pmds012_desc,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053, 
       g_pmds_m.pmds053_desc,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054, 
       g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid, 
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid, 
       g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
   
   #add-point:新增結束後 name="insert.after"
   CALL apmt520_show()   #161207-00033#38
   #end add-point 
   
   LET g_data_owner = g_pmds_m.pmdsownid      
   LET g_data_dept  = g_pmds_m.pmdsowndp
   
   #功能已完成,通報訊息中心
   CALL apmt520_msgcentre_notify('insert')
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.modify" >}
#+ 資料修改
PRIVATE FUNCTION apmt520_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"
   
   #end add-point    
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   DEFINE l_wc2_table1          STRING
   DEFINE l_wc2_table2   STRING
 
   DEFINE l_wc2_table3   STRING
 
 
 
   #add-point:modify段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="modify.pre_function"
   
   #end add-point
   
   #保存單頭舊值
   LET g_pmds_m_t.* = g_pmds_m.*
   LET g_pmds_m_o.* = g_pmds_m.*
   
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   ERROR ""
  
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   CALL s_transaction_begin()
   
   OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt520_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
       g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
       g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
       g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
       g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
       g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc,g_pmds_m.pmdsownid_desc, 
       g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
   
   #檢查是否允許此動作
   IF NOT apmt520_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt520_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   
   
   #add-point:modify段show之前 name="modify.before_show"
   
   #end add-point  
   
   #LET l_wc2_table1 = g_wc2_table1
   #LET g_wc2_table1 = " 1=1"
   #LET l_wc2_table2 = g_wc2_table2
   #LET l_wc2_table2 = " 1=1"
 
   #LET l_wc2_table3 = g_wc2_table3
   #LET l_wc2_table3 = " 1=1"
 
 
 
   
   CALL apmt520_show()
   #add-point:modify段show之後 name="modify.after_show"
   #IF g_pmds_m.pmdsstus <> 'N' THEN
   IF g_pmds_m.pmdsstus NOT MATCHES "[NDR]" THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.code   = "apm-00035" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   #end add-point
   
   #LET g_wc2_table1 = l_wc2_table1
   #LET  g_wc2_table2 = l_wc2_table2 
 
   #LET  g_wc2_table3 = l_wc2_table3 
 
 
 
    
   WHILE TRUE
      LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
      
      #寫入修改者/修改日期資訊(單頭)
      LET g_pmds_m.pmdsmodid = g_user 
LET g_pmds_m.pmdsmoddt = cl_get_current()
LET g_pmds_m.pmdsmodid_desc = cl_get_username(g_pmds_m.pmdsmodid)
      
      #add-point:modify段修改前 name="modify.before_input"
      #「D抽單 / R已拒絕」狀況碼更改資料後，需還原為「N未確認」
      IF g_pmds_m.pmdsstus MATCHES "[DR]" THEN 
         LET g_pmds_m.pmdsstus = "N"
      END IF
        
      #end add-point
      
      #欄位更改
      LET g_loc = 'n'
      LET g_update = FALSE
      LET g_master_commit = "N"
      CALL apmt520_input("u")
      LET g_loc = 'n'
 
      #add-point:modify段修改後 name="modify.after_input"
                        
      #end add-point
      
      IF g_update OR NOT INT_FLAG THEN
         #若有modid跟moddt則進行update
         UPDATE pmds_t SET (pmdsmodid,pmdsmoddt) = (g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt)
          WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmdsdocno_t
 
      END IF
    
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         #若單頭無commit則還原
         IF g_master_commit = "N" THEN
            LET g_pmds_m.* = g_pmds_m_t.*
            CALL apmt520_show()
         END IF
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN
      END IF 
                  
      #若單頭key欄位有變更
      IF g_pmds_m.pmdsdocno != g_pmds_m_t.pmdsdocno
 
      THEN
         CALL s_transaction_begin()
         
         #add-point:單身fk修改前 name="modify.body.b_fk_update"
                                    
         #end add-point
         
         #更新單身key值
         UPDATE pmdt_t SET pmdtdocno = g_pmds_m.pmdsdocno
 
          WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m_t.pmdsdocno
 
            
         #add-point:單身fk修改中 name="modify.body.m_fk_update"
                                    
         #end add-point
 
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdt_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #add-point:單身fk修改後 name="modify.body.a_fk_update"
                                    
         #end add-point
         
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update2"
                                    
         #end add-point
         
         UPDATE pmdu_t
            SET pmdudocno = g_pmds_m.pmdsdocno
 
          WHERE pmduent = g_enterprise AND
                pmdudocno = g_pmdsdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update2"
                                    
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdu_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update2"
                                    
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update3"
                                    
         #end add-point
         
         UPDATE pmdv_t
            SET pmdvdocno = g_pmds_m.pmdsdocno
 
          WHERE pmdvent = g_enterprise AND
                pmdvdocno = g_pmdsdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update3"
                                    
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdv_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update3"
                                    
         #end add-point
 
 
         
 
         
         #UPDATE 多語言table key值
         
         
         
 
         CALL s_transaction_end('Y','0')
      END IF
    
      EXIT WHILE
   END WHILE
 
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt520_set_act_visible()   
   CALL apmt520_set_act_no_visible()
 
   #組合新增資料的條件
   LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                      " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
   #填到對應位置
   CALL apmt520_browser_fill("")
 
   CLOSE apmt520_cl
   
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL apmt520_msgcentre_notify('modify')
 
END FUNCTION 
 
{</section>}
 
{<section id="apmt520.input" >}
#+ 資料輸入
PRIVATE FUNCTION apmt520_input(p_cmd)
   #add-point:input段define(客製用) name="input.define_customerization"
   
   #end add-point  
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num10                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num10                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num10
   DEFINE  l_i                   LIKE type_t.num10
   DEFINE  l_ac_t                LIKE type_t.num10
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num10
   DEFINE  li_reproduce_target   LIKE type_t.num10
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   #add-point:input段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="input.define"
   DEFINE  l_success    LIKE type_t.num5
   DEFINE  l_ooef004    LIKE ooef_t.ooef004
   DEFINE  l_rate       LIKE inaj_t.inaj014
   DEFINE  l_imaa005    LIKE imaa_t.imaa005
   DEFINE l_xrcd104     LIKE xrcd_t.xrcd104
   DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
   DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
   DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
   DEFINE l_sql         STRING
   DEFINE l_ooef016     LIKE ooef_t.ooef016
   DEFINE l_scc40       LIKE type_t.chr2
   DEFINE l_oodbl004    LIKE oodbl_t.oodbl004  #稅別名稱
   DEFINE l_oodb005     LIKE oodb_t.oodb005    #含稅否
   DEFINE l_oodb006     LIKE oodb_t.oodb006    #稅率 
   DEFINE l_oodb011     LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定
   DEFINE l_pmds000     LIKE pmds_t.pmds000  
   DEFINE l_pmdn042     LIKE pmdn_t.pmdn042
   DEFINE l_pmdtseq     LIKE pmdt_t.pmdtseq
   DEFINE  l_inam       DYNAMIC ARRAY OF RECORD   #記錄產品特徵
              inam001      LIKE inam_t.inam001,
              inam002      LIKE inam_t.inam002,
              inam004      LIKE inam_t.inam004
                        END RECORD
   #161124-00048#11 mod-S
#   DEFINE l_pmdt        RECORD LIKE pmdt_t.*
   DEFINE l_pmdt RECORD  #收貨/入庫單身明細檔
          pmdtent LIKE pmdt_t.pmdtent, #企业编号
          pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
          pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
          pmdtseq LIKE pmdt_t.pmdtseq, #项次
          pmdt001 LIKE pmdt_t.pmdt001, #采购单号
          pmdt002 LIKE pmdt_t.pmdt002, #采购项次
          pmdt003 LIKE pmdt_t.pmdt003, #采购项序
          pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
          pmdt005 LIKE pmdt_t.pmdt005, #子件特性
          pmdt006 LIKE pmdt_t.pmdt006, #料件编号
          pmdt007 LIKE pmdt_t.pmdt007, #产品特征
          pmdt008 LIKE pmdt_t.pmdt008, #包装容器
          pmdt009 LIKE pmdt_t.pmdt009, #作业编号
          pmdt010 LIKE pmdt_t.pmdt010, #作业序
          pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
          pmdt016 LIKE pmdt_t.pmdt016, #库位
          pmdt017 LIKE pmdt_t.pmdt017, #储位
          pmdt018 LIKE pmdt_t.pmdt018, #批号
          pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
          pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
          pmdt021 LIKE pmdt_t.pmdt021, #参考单位
          pmdt022 LIKE pmdt_t.pmdt022, #参考数量
          pmdt023 LIKE pmdt_t.pmdt023, #计价单位
          pmdt024 LIKE pmdt_t.pmdt024, #计价数量
          pmdt025 LIKE pmdt_t.pmdt025, #紧急度
          pmdt026 LIKE pmdt_t.pmdt026, #检验否
          pmdt027 LIKE pmdt_t.pmdt027, #收货单号
          pmdt028 LIKE pmdt_t.pmdt028, #收货项次
          pmdt036 LIKE pmdt_t.pmdt036, #单价
          pmdt037 LIKE pmdt_t.pmdt037, #税率
          pmdt038 LIKE pmdt_t.pmdt038, #税前金额
          pmdt039 LIKE pmdt_t.pmdt039, #含税金额
          pmdt040 LIKE pmdt_t.pmdt040, #价格核决
          pmdt041 LIKE pmdt_t.pmdt041, #保税否
          pmdt042 LIKE pmdt_t.pmdt042, #取价来源
          pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
          pmdt044 LIKE pmdt_t.pmdt044, #取出单价
          pmdt045 LIKE pmdt_t.pmdt045, #价差比
          pmdt046 LIKE pmdt_t.pmdt046, #税种
          pmdt047 LIKE pmdt_t.pmdt047, #税额
          pmdt051 LIKE pmdt_t.pmdt051, #理由码
          pmdt052 LIKE pmdt_t.pmdt052, #状态码
          pmdt053 LIKE pmdt_t.pmdt053, #允收数量
          pmdt054 LIKE pmdt_t.pmdt054, #已入库量
          pmdt055 LIKE pmdt_t.pmdt055, #验退量
          pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
          pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
          pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
          pmdt059 LIKE pmdt_t.pmdt059, #备注
          pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
          pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
          pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
          pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
          pmdt064 LIKE pmdt_t.pmdt064, #出货单号
          pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
          pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
          pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
          pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
          pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
          pmdt081 LIKE pmdt_t.pmdt081, #QC单号
          pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
          pmdt083 LIKE pmdt_t.pmdt083, #判定结果
          pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
          pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
          pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
          pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
          pmdt088 LIKE pmdt_t.pmdt088, #存货备注
          pmdt089 LIKE pmdt_t.pmdt089, #有效日期
          pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
          pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
          pmdt200 LIKE pmdt_t.pmdt200, #商品条码
          pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
          pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
          pmdt203 LIKE pmdt_t.pmdt203, #采购组织
          pmdt204 LIKE pmdt_t.pmdt204, #采购中心
          pmdt205 LIKE pmdt_t.pmdt205, #要货组织
          pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
          pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
          pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
          pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
          pmdt210 LIKE pmdt_t.pmdt210, #经营方式
          pmdt211 LIKE pmdt_t.pmdt211, #结算方式
          pmdt212 LIKE pmdt_t.pmdt212, #合同编号
          pmdt213 LIKE pmdt_t.pmdt213, #协议编号
          pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
          pmdt070 LIKE pmdt_t.pmdt070, #参考单号
          pmdt071 LIKE pmdt_t.pmdt071, #参考项次
          pmdt214 LIKE pmdt_t.pmdt214, #采购方式
          pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
          pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
          pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
          pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
          pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
          pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
          pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
          pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
          pmdt218 LIKE pmdt_t.pmdt218, #采购价
          pmdt219 LIKE pmdt_t.pmdt219, #制造日期
          pmdt072 LIKE pmdt_t.pmdt072, #项目编号
          pmdt073 LIKE pmdt_t.pmdt073, #WBS
          pmdt074 LIKE pmdt_t.pmdt074, #活动编号
          pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
          pmdt049 LIKE pmdt_t.pmdt049, #发票编号
          pmdt050 LIKE pmdt_t.pmdt050, #发票号码
          pmdt075 LIKE pmdt_t.pmdt075, #预算细项
          pmdt220 LIKE pmdt_t.pmdt220, #商品品类
          pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
   END RECORD
   #161124-00048#11 mod-E
   DEFINE l_flag        LIKE type_t.num5  #用於判斷收貨單進單身時，是否再次詢問是否根據採購單頭自動產生單身
   DEFINE l_gzcbl004    LIKE gzcbl_t.gzcbl004
   DEFINE l_ooba002     LIKE ooba_t.ooba002
   DEFINE l_pmdt020     LIKE pmdt_t.pmdt020
   DEFINE l_pmdt039     LIKE pmdt_t.pmdt039
   DEFINE l_where_1     STRING   #150610 earl add
   DEFINE l_where_2     STRING   #150610 earl add
   DEFINE l_imaf071     LIKE imaf_t.imaf071
   DEFINE l_imaf081     LIKE imaf_t.imaf081
   DEFINE l_amount      LIKE pmdt_t.pmdt020
   DEFINE l_pmdtdocno   LIKE pmdt_t.pmdtdocno
   DEFINE l_pmdtseq_1   LIKE pmdt_t.pmdtseq
   #add--2015/08/31 By shiun--(S)
   DEFINE l_slip           LIKE pmds_t.pmdsdocno
   DEFINE l_insert1        LIKE type_t.num5     
   DEFINE l_errno          LIKE gzze_t.gzze001  
   DEFINE l_bgaf016        LIKE bgaf_t.bgaf016  
   DEFINE l_pmdt075        LIKE pmdt_t.pmdt075  
   DEFINE l_pmdt075_desc   LIKE type_t.chr80    
   #add--2015/08/31 By shiun--(E)
   DEFINE l_where      STRING   #150909 earl add
   
   DEFINE l_pmdu006        LIKE pmdu_t.pmdu006
   DEFINE l_pmdu007        LIKE pmdu_t.pmdu007
   DEFINE l_pmdu008        LIKE pmdu_t.pmdu008
   DEFINE l_pmdu005        LIKE pmdu_t.pmdu005    #160316-00007#3 add

   DEFINE l_sfaa049        LIKE sfaa_t.sfaa049    #151229-00009#1 add
   DEFINE l_pmdl005        LIKE pmdl_t.pmdl005    #151229-00009#1 add
   
#150917-00001#3  2016/03/08  By earl add s
   DEFINE l_chk            LIKE type_t.num5        #TRUE 需要校驗檢查  FALSE  不需校驗檢查
   DEFINE l_qty            LIKE xmdl_t.xmdl205     #未續拋數量
   DEFINE l_qty_batch      LIKE xmdl_t.xmdl205     #未續拋數量(考慮批號)
   DEFINE l_inaa007        LIKE inaa_t.inaa007
#150917-00001#3  2016/03/08  By earl add e
   DEFINE l_pmdl008        LIKE pmdl_t.pmdl008 #160413-00038#1 add
   DEFINE l_pmdp003        LIKE pmdp_t.pmdp003  #160606-00013#1
   #160617-00005#2---s--
   DEFINE l_imaf061      LIKE imaf_t.imaf061
   DEFINE l_imaf062      LIKE imaf_t.imaf062
   DEFINE l_imaf063      LIKE imaf_t.imaf063
   DEFINE l_oofg_return DYNAMIC ARRAY OF RECORD    
             oofg019     LIKE oofg_t.oofg019,   #field
             oofg020     LIKE oofg_t.oofg020    #value
                     END RECORD
   #160617-00005#2---e--
   DEFINE l_msg2         LIKE gzze_t.gzze003   #160621-00003#3 20160629 add by beckxie
   DEFINE l_imaf064      LIKE imaf_t.imaf064  #160519-00022#7   
   DEFINE l_imaf055      LIKE imaf_t.imaf055  #160519-00008#16
   DEFINE l_pmaa004      LIKE pmaa_t.pmaa004   #161207-00033#38
   DEFINE l_n1           LIKE type_t.num5      #170116-00040#1 add
   #end add-point  
   
   #add-point:Function前置處理  name="input.pre_function"
   #160621-00003#3 20160629 add by beckxie---S
   LET l_msg2 = ''
   SELECT gzze003 INTO l_msg2 FROM gzze_t WHERE gzze001 = 'aoo-00309' AND gzze002 = g_dlang
   #160621-00003#3 20160629 add by beckxie---E
   #end add-point
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001, 
       g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus, 
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008,g_pmds_m.pmds008_desc, 
       g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000, 
       g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds031_desc,g_pmds_m.pmds032, 
       g_pmds_m.pmds032_desc,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds039_desc, 
       g_pmds_m.pmds040,g_pmds_m.pmds040_desc,g_pmds_m.pmds012,g_pmds_m.pmds012_desc,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053, 
       g_pmds_m.pmds053_desc,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054, 
       g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid, 
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid, 
       g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql name="input.define_sql"
            
   #end add-point 
   LET g_forupd_sql = "SELECT pmdtsite,pmdtseq,pmdt027,pmdt028,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081, 
       pmdt082,pmdt083,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021, 
       pmdt022,pmdt008,pmdt023,pmdt024,pmdt090,pmdt091,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047, 
       pmdt092,pmdt093,pmdt026,pmdt041,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt072,pmdt073,pmdt074, 
       pmdt075,pmdt040,pmdt052,pmdt051,pmdt070,pmdt071,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061, 
       pmdt042,pmdt043,pmdt048,pmdt044,pmdt045,pmdt049,pmdt050,pmdt084,pmdt219,pmdt089,pmdt088 FROM  
       pmdt_t WHERE pmdtent=? AND pmdtdocno=? AND pmdtseq=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql"
            
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt520_bcl CURSOR FROM g_forupd_sql
   
   #add-point:input段define_sql name="input.define_sql2"
            
   #end add-point    
   LET g_forupd_sql = "SELECT pmdusite,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu003,pmdu004,pmdu006,pmdu007, 
       pmdu008,pmdu005,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016  
       FROM pmdu_t WHERE pmduent=? AND pmdudocno=? AND pmduseq=? AND pmduseq1=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql2"
            
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt520_bcl2 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql3"
            
   #end add-point    
   LET g_forupd_sql = "SELECT pmdvsite,pmdvseq,pmdvseq1,pmdv005,pmdv001,pmdv002,pmdv003,pmdv004,pmdv014, 
       pmdv015,pmdv016,pmdv017,pmdv018,pmdv019 FROM pmdv_t WHERE pmdvent=? AND pmdvdocno=? AND pmdvseq=?  
       AND pmdvseq1=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql3"
            
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt520_bcl3 CURSOR FROM g_forupd_sql
 
 
   
 
 
   #add-point:input段define_sql name="input.other_sql"
            
   #end add-point 
 
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL apmt520_set_entry(p_cmd)
   #add-point:set_entry後 name="input.after_set_entry"
   
   LET g_controlno = ''
   
   IF p_cmd = 'u' AND g_argv[1] MATCHES '[24]' THEN   
      #取得採購通路
      LET g_pmab039 = g_pmds_m.pmds012
      #取得稅別類型
      CALL s_tax_chk(g_site,g_pmds_m.pmds033)
        RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
      IF l_success THEN
         LET g_tax_app = l_oodb011
      END IF     
      #取得價格是否允許修改,修改容差率,價格超過容差率的處理方式,允許單價為0
       LET g_pmam003 = ''
       LET g_pmam006 = ''
       LET g_pmam002 = ''
       SELECT pmam003,pmam006,pmam002
         INTO g_pmam003,g_pmam006,g_pmam002
         FROM pmam_t       
        WHERE pmament = g_enterprise
          AND pmam001 = g_pmds_m.pmds039            
   END IF   
   
   CALL apmt520_set_no_required()
   CALL apmt520_set_required() 
   #161031-00025#15 add(s)
   LET g_detail_insert = l_allow_insert
   LET g_detail_delete = l_allow_delete
   #161031-00025#15 add(e)   
   #end add-point
   CALL apmt520_set_no_entry(p_cmd)
 
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009, 
       g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011, 
       g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
       g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012, 
       g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049, 
       g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054, 
       g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058
   
   LET lb_reproduce = FALSE
   LET l_ac_t = 1
   
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
   
   #add-point:資料輸入前 name="input.before_input"
   LET l_ooef004 = ''
   SELECT ooef004 INTO l_ooef004 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
   
   LET g_errshow = 1
   LET l_flag = TRUE
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
{</section>}
 
{<section id="apmt520.input.head" >}
      #單頭段
      INPUT BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002, 
          g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009, 
          g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011, 
          g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
          g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
          g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012, 
          g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049, 
          g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054, 
          g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION(master_input)
         
     
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt520_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt520_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            CALL apmt520_set_entry(p_cmd)
            #add-point:資料輸入前 name="input.m.before_input"
                                                
            #end add-point
            CALL apmt520_set_no_entry(p_cmd)
    
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdssite
            #add-point:BEFORE FIELD pmdssite name="input.b.pmdssite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdssite
            
            #add-point:AFTER FIELD pmdssite name="input.a.pmdssite"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdssite
            #add-point:ON CHANGE pmdssite name="input.g.pmdssite"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocno
            
            #add-point:AFTER FIELD pmdsdocno name="input.a.pmdsdocno"
                                                            #此段落由子樣板a05產生
            CALL s_aooi200_get_slip_desc(g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmdsdocno_desc
            DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
            
            IF  NOT cl_null(g_pmds_m.pmdsdocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmds_m.pmdsdocno != g_pmdsdocno_t )) THEN 
                  #160302-00027#2---mark---begin--
                  #IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmds_t WHERE "||"pmdsent = '" ||g_enterprise|| "' AND "||"pmdsdocno = '"||g_pmds_m.pmdsdocno ||"'",'std-00004',0) THEN 
                  #   LET g_pmds_m.pmdsdocno = g_pmdsdocno_t
                  #   CALL s_aooi200_get_slip_desc(g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmdsdocno_desc
                  #   DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
                  #   NEXT FIELD CURRENT
                  #END IF
                  #160302-00027#2---mark---end--
                  
                  IF NOT s_aooi200_chk_slip(g_site,'',g_pmds_m.pmdsdocno,g_prog) THEN
                     LET g_pmds_m.pmdsdocno = g_pmdsdocno_t
                     CALL s_aooi200_get_slip_desc(g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmdsdocno_desc
                     DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
                     NEXT FIELD CURRENT
                  END IF
                  #160302-00027#2---add---begin--
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmds_t WHERE "||"pmdsent = '" ||g_enterprise|| "' AND "||"pmdsdocno = '"||g_pmds_m.pmdsdocno ||"'",'std-00004',0) THEN 
                     LET g_pmds_m.pmdsdocno = g_pmdsdocno_t
                     CALL s_aooi200_get_slip_desc(g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmdsdocno_desc
                     DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
                     NEXT FIELD CURRENT
                  END IF
                  #160302-00027#2---add---end--
                  
                  #150909 earl add s
                  #檢核前後置單別的合理性
                  IF NOT cl_null(g_pmds_m.pmds006) THEN
                     IF NOT s_aooi210_check_doc(g_site,'',g_pmds_m.pmds006,g_pmds_m.pmdsdocno,'3','') THEN
                        LET g_pmds_m.pmdsdocno = g_pmdsdocno_t
                        CALL s_aooi200_get_slip_desc(g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmdsdocno_desc
                        DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #150909 earl add e
                  
               END IF
               
               CALL apmt520_get_col_default()    #161101-00081#1 add
            END IF



            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocno
            #add-point:BEFORE FIELD pmdsdocno name="input.b.pmdsdocno"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdsdocno
            #add-point:ON CHANGE pmdsdocno name="input.g.pmdsdocno"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocdt
            #add-point:BEFORE FIELD pmdsdocdt name="input.b.pmdsdocdt"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocdt
            
            #add-point:AFTER FIELD pmdsdocdt name="input.a.pmdsdocdt"
            #160111-00030#1 --- add Start ---
            #當單據日期異動則一併同步扣帳日期,則不預設帶入g_today
            IF NOT cl_null(g_pmds_m.pmdsdocdt) AND (g_pmds_m_o.pmdsdocdt != g_pmds_m.pmdsdocdt OR cl_null(g_pmds_m_o.pmdsdocdt) ) THEN
               LET g_pmds_m_o.pmdsdocdt = g_pmds_m.pmdsdocdt
               LET g_pmds_m.pmds001 = g_pmds_m.pmdsdocdt  #扣賬日期
               DISPLAY BY NAME g_pmds_m.pmds001
            END IF
            #160111-00030#1 --- add End ---                                    
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdsdocdt
            #add-point:ON CHANGE pmdsdocdt name="input.g.pmdsdocdt"
 
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds001
            #add-point:BEFORE FIELD pmds001 name="input.b.pmds001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds001
            
            #add-point:AFTER FIELD pmds001 name="input.a.pmds001"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds001
            #add-point:ON CHANGE pmds001 name="input.g.pmds001"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds002
            
            #add-point:AFTER FIELD pmds002 name="input.a.pmds002"
            CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
            DISPLAY BY NAME g_pmds_m.pmds002_desc
            
            IF NOT cl_null(g_pmds_m.pmds002) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               #IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmds_m.pmds002 != g_pmds_m_t.pmds002 OR cl_null(g_pmds_m_t.pmds002))) THEN   #160824-00007#348 Mark By Ken 170118
               IF (g_pmds_m.pmds002 != g_pmds_m_o.pmds002 OR cl_null(g_pmds_m_o.pmds002)) THEN    #160824-00007#348 Add By Ken 170118
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmds_m.pmds002
			         #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"
                  #160318-00025#15 by 07900 --add-end 
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_ooag001") THEN
                     #檢查成功時後續處理
                     SELECT ooag003 INTO g_pmds_m.pmds003 FROM ooag_t WHERE ooagent = g_enterprise AND ooag001 = g_pmds_m.pmds002
			            CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
                     DISPLAY BY NAME g_pmds_m.pmds003_desc
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_pmds_m.pmds002 = g_pmds_m_t.pmds002  #160824-00007#348 Mark By Ken 170118
                     LET g_pmds_m.pmds002 = g_pmds_m_o.pmds002   #160824-00007#348 Add By Ken 170118
                     CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
                     DISPLAY BY NAME g_pmds_m.pmds002_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            LET g_pmds_m_o.* = g_pmds_m.*   #160824-00007#348 Add By Ken 170118
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds002
            #add-point:BEFORE FIELD pmds002 name="input.b.pmds002"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds002
            #add-point:ON CHANGE pmds002 name="input.g.pmds002"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds003
            
            #add-point:AFTER FIELD pmds003 name="input.a.pmds003"
            CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
            DISPLAY BY NAME g_pmds_m.pmds003_desc
            
            IF NOT cl_null(g_pmds_m.pmds003) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
                #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmds_m.pmds003
               LET g_chkparam.arg2 = g_pmds_m.pmdsdocdt
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00029:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
               #160318-00025#15 by 07900 --add-end 
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooeg001") THEN
                  #檢查成功時後續處理
                  
               ELSE
                  #檢查失敗時後續處理
                  #LET g_pmds_m.pmds003 = g_pmds_m_t.pmds003  #160824-00007#348 Mark By Ken 170118
                  LET g_pmds_m.pmds003 = g_pmds_m_o.pmds003   #160824-00007#348 Add By Ken 170118
                  CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
                  DISPLAY BY NAME g_pmds_m.pmds003_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            LET g_pmds_m_o.* = g_pmds_m.*   #160824-00007#348 Add By Ken 170118
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds003
            #add-point:BEFORE FIELD pmds003 name="input.b.pmds003"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds003
            #add-point:ON CHANGE pmds003 name="input.g.pmds003"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsstus
            #add-point:BEFORE FIELD pmdsstus name="input.b.pmdsstus"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsstus
            
            #add-point:AFTER FIELD pmdsstus name="input.a.pmdsstus"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdsstus
            #add-point:ON CHANGE pmdsstus name="input.g.pmdsstus"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds006
            #add-point:BEFORE FIELD pmds006 name="input.b.pmds006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds006
            
            #add-point:AFTER FIELD pmds006 name="input.a.pmds006"
            IF NOT cl_null(g_pmds_m.pmds006) THEN 
               IF g_pmds_m.pmds006 != g_pmds_m_o.pmds006 OR cl_null(g_pmds_m_o.pmds006) THEN
                  IF NOT apmt520_pmds006_chk(g_pmds_m.pmds006) THEN
                     LET g_pmds_m.pmds006 = g_pmds_m_o.pmds006
                     NEXT FIELD CURRENT
                  END IF
                  #根據採購單單號帶值
                  CALL apmt520_pmds006_desc()
               END IF
               
               #151229-00009#1 --- add start ---
               LET l_pmdl005 = ''
               LET l_pmdl008 = '' #160413-00038#1 add
               SELECT pmdl005,pmdl008 INTO l_pmdl005,l_pmdl008  #160413-00038#1 add pmdl008
                 FROM pmdl_t
                WHERE pmdlent = g_enterprise
                  AND pmdldocno = g_pmds_m.pmds006
               
               IF l_pmdl005 = '2' OR l_pmdl005 = '5' THEN  #委外採購 or 重複性委外採購
                  #160413-00038#1--add---begin---
                  #工单备料单身都是倒扣料时，无需考虑发料套数
                  LET l_n = 0 
                  SELECT COUNT(1) INTO l_n FROM sfba_t WHERE sfbaent = g_enterprise AND sfbadocno = l_pmdl008 AND sfba009 = 'N'
                                                         AND sfba015 = 0    #161019-00046#1                
                  IF l_n > 0 THEN
                  #160413-00038#1--add---end----
                     LET l_sfaa049 = 0
                     SELECT sfaa_t.sfaa049 INTO l_sfaa049
                       FROM pmdl_t,sfaa_t
                      WHERE pmdlent = sfaaent
                        AND pmdl008 = sfaadocno
                        AND pmdl005 = l_pmdl005 
                        AND pmdl007 = '4'   #工單
                        AND pmdlent = g_enterprise
                        AND pmdldocno = g_pmds_m.pmds006 
                     IF cl_null(l_sfaa049) THEN LET l_sfaa049 = 0 END IF
                     IF l_sfaa049 = 0 THEN   #發出量為0，尚未發出，無法收貨
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'apm-01058'
                        LET g_errparam.extend = g_pmds_m.pmds006 
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD pmds006
                     END IF
                  END IF  #160413-00038#1 add
               END IF
               #151229-00009#1 --- add end   ---
               #151111-00023#1-add----(S)
               IF g_argv[1] = '7' THEN
                  IF cl_null(g_pmds_m.pmds006) THEN
                     LET g_pmds_m.pmds054 = '1'
                  ELSE
                     SELECT pmds054 INTO g_pmds_m.pmds054
                       FROM pmds_t
                      WHERE pmdsent = g_enterprise
                        AND pmdsdocno = g_pmds_m.pmds006   
                        AND pmds000 IN ('1','2','3','4')                        
                  END IF
               END IF
               #151111-00023#1-add----(E)
            #150611 earl add s
            ELSE
               LET g_pmds_m.pmds041 = ''  #多角流程序號清空
               LET g_pmds_m_o.pmds041 = g_pmds_m.pmds041
               DISPLAY BY NAME g_pmds_m.pmds041
            #150611 earl add e
            END IF
            LET g_pmds_m_o.pmds006 = g_pmds_m.pmds006
            CALL apmt520_set_entry(p_cmd)
            CALL apmt520_set_no_required()
            CALL apmt520_set_required()               
            CALL apmt520_set_no_entry(p_cmd)            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds006
            #add-point:ON CHANGE pmds006 name="input.g.pmds006"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds007
            
            #add-point:AFTER FIELD pmds007 name="input.a.pmds007"
            CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
            DISPLAY BY NAME g_pmds_m.pmds007_desc
            
            IF NOT cl_null(g_pmds_m.pmds007) THEN
               IF g_pmds_m.pmds007 != g_pmds_m_o.pmds007 OR cl_null(g_pmds_m_o.pmds007) THEN
                  #倉退單時，若單身有資料，則提示是否確認修改供應商資料，若是，則刪除單身資料，若否，則供應商不修改
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                     IF l_n > 0 THEN
                        IF cl_ask_confirm('apm-01063') THEN
                           SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d[l_ac].pmdtseq
                           IF l_n > 0 THEN
                              IF NOT s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,'','') THEN
                                 
                              END IF
                           END IF
                  
                           DELETE FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                           DELETE FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno
                           DELETE FROM pmdv_t WHERE pmdvent = g_enterprise AND pmdvdocno = g_pmds_m.pmdsdocno 
                           #刪除交易稅明細檔
                           DELETE FROM xrcd_t WHERE xrcdent = g_enterprise AND xrcddocno = g_pmds_m.pmdsdocno
                           
                           #刪除inao製造批序號異動明細檔
                           DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno
                           
                           IF g_pmds_m.pmds054 = '2' OR g_pmds_m.pmds054 = '4' THEN
                              #將對應的pmeo025的狀態更新成'1.未處理'
                              UPDATE pmeo_t SET pmeo025 = '1',
                                                pmeo027 = '',
                                                pmeo028 = ''
                                  WHERE pmeoent = g_enterprise AND (pmeo000 ='1' OR pmeo000 = '3') AND pmeo027 = g_pmds_m.pmdsdocno
                           END IF
                           CALL g_pmdt_d.clear()   
                           CALL g_pmdt2_d.clear()  
                           CALL g_pmdt3_d.clear()  
                           CALL g_pmdt4_d.clear()
                        ELSE
                           LET g_pmds_m.pmds007 = g_pmds_m_o.pmds007
                           CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
                           DISPLAY BY NAME g_pmds_m.pmds007_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
                  IF NOT apmt520_pmds007_chk(g_pmds_m.pmds007) THEN
                     LET g_pmds_m.pmds007 = g_pmds_m_o.pmds007
                     CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
                     DISPLAY BY NAME g_pmds_m.pmds007_desc
                     NEXT FIELD CURRENT
                  END IF
                     
                  #如果供應商有修改，根據供應商帶值
                  CALL apmt520_pmds007_desc()
                  
                  #161207-00033#38---s
                  #无采购收货单，维护供应商是一次性交易对象时，需产生一次性交易对象识别码
                  IF g_argv[1] MATCHES '[24]' THEN
                     #若輸入供應商的法人類型為'2:一次性交易'或是'4:內部員工'時，則自動串apmi004_01
                     #維護一次性交易對項基本資料，維護完基本資料後會回傳一個一次性交易對象識別碼，
                     #將識別碼值預設給pmdl028欄位
                     LET l_pmaa004 = ''
                     LET g_pmds_m.pmds028 = NULL
                     SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmds_m.pmds007
                     IF l_pmaa004 = '2' THEN   #一次性交易對象
                        CALL apmi004_01('1',g_pmds_m.pmds028,g_pmds_m.pmds007,g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmds028
                        CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
                        DISPLAY BY NAME g_pmds_m.pmds007_desc
                        IF g_pmds_m.pmds008 = g_pmds_m.pmds007 THEN
                           LET g_pmds_m.pmds008_desc = g_pmds_m.pmds007_desc
                           DISPLAY BY NAME g_pmds_m.pmds008_desc 
                        END IF
                        IF g_pmds_m.pmds009 = g_pmds_m.pmds007 THEN
                           LET g_pmds_m.pmds009_desc = g_pmds_m.pmds007_desc
                           DISPLAY BY NAME g_pmds_m.pmds009_desc 
                        END IF
                     END IF
                     IF l_pmaa004 = '4' THEN   #內部員工
                        CALL apmi004_01('2',g_pmds_m.pmds028,g_pmds_m.pmds007,g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmds028
                        CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
                        DISPLAY BY NAME g_pmds_m.pmds007_desc
                        IF g_pmds_m.pmds008 = g_pmds_m.pmds007 THEN
                           LET g_pmds_m.pmds008_desc = g_pmds_m.pmds007_desc
                           DISPLAY BY NAME g_pmds_m.pmds008_desc 
                        END IF
                        IF g_pmds_m.pmds009 = g_pmds_m.pmds007 THEN
                           LET g_pmds_m.pmds009_desc = g_pmds_m.pmds007_desc
                           DISPLAY BY NAME g_pmds_m.pmds009_desc 
                        END IF
                     END IF
                  END IF
                  #161207-00033#38---e
               END IF
            END IF
            LET g_pmds_m_o.pmds007 = g_pmds_m.pmds007
            #161207-00033#38---s
            CALL apmt520_set_entry(p_cmd)
            CALL apmt520_set_no_required()
            CALL apmt520_set_required()               
            CALL apmt520_set_no_entry(p_cmd)    
            #161207-00033#38---e
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds007
            #add-point:BEFORE FIELD pmds007 name="input.b.pmds007"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds007
            #add-point:ON CHANGE pmds007 name="input.g.pmds007"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds008
            
            #add-point:AFTER FIELD pmds008 name="input.a.pmds008"
            CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
            DISPLAY BY NAME g_pmds_m.pmds008_desc 
            
            IF NOT cl_null(g_pmds_m.pmds008) AND (g_pmds_m.pmds008 != g_pmds_m.pmds007) THEN 
               IF NOT apmt520_pmds008_chk() THEN
                  LET g_pmds_m.pmds008 = g_pmds_m_t.pmds008
                  CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
                  DISPLAY BY NAME g_pmds_m.pmds008_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds008
            #add-point:BEFORE FIELD pmds008 name="input.b.pmds008"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds008
            #add-point:ON CHANGE pmds008 name="input.g.pmds008"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds009
            
            #add-point:AFTER FIELD pmds009 name="input.a.pmds009"
            CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
            DISPLAY BY NAME g_pmds_m.pmds009_desc 
            
            IF NOT cl_null(g_pmds_m.pmds009) AND (g_pmds_m.pmds009 != g_pmds_m.pmds007) THEN 
               IF NOT apmt520_pmds009_chk() THEN
                  LET g_pmds_m.pmds009 = g_pmds_m_t.pmds009
                  CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
                  DISPLAY BY NAME g_pmds_m.pmds009_desc
                  NEXT FIELD CURRENT
               END IF
               
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmds_m.pmds007
               LET g_chkparam.arg2 = g_pmds_m.pmds009
               LET g_chkparam.arg3 = g_site
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="axr-00049:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmac002_2") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmds_m.pmds009 = g_pmds_m_t.pmds009
                  CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
                  DISPLAY BY NAME g_pmds_m.pmds009_desc 
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds009
            #add-point:BEFORE FIELD pmds009 name="input.b.pmds009"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds009
            #add-point:ON CHANGE pmds009 name="input.g.pmds009"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds010
            #add-point:BEFORE FIELD pmds010 name="input.b.pmds010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds010
            
            #add-point:AFTER FIELD pmds010 name="input.a.pmds010"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds010
            #add-point:ON CHANGE pmds010 name="input.g.pmds010"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds052
            #add-point:BEFORE FIELD pmds052 name="input.b.pmds052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds052
            
            #add-point:AFTER FIELD pmds052 name="input.a.pmds052"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds052
            #add-point:ON CHANGE pmds052 name="input.g.pmds052"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds028
            #add-point:BEFORE FIELD pmds028 name="input.b.pmds028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds028
            
            #add-point:AFTER FIELD pmds028 name="input.a.pmds028"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds028
            #add-point:ON CHANGE pmds028 name="input.g.pmds028"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds000
            #add-point:BEFORE FIELD pmds000 name="input.b.pmds000"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds000
            
            #add-point:AFTER FIELD pmds000 name="input.a.pmds000"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds000
            #add-point:ON CHANGE pmds000 name="input.g.pmds000"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds100
            #add-point:BEFORE FIELD pmds100 name="input.b.pmds100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds100
            
            #add-point:AFTER FIELD pmds100 name="input.a.pmds100"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds100
            #add-point:ON CHANGE pmds100 name="input.g.pmds100"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds011
            #add-point:BEFORE FIELD pmds011 name="input.b.pmds011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds011
            
            #add-point:AFTER FIELD pmds011 name="input.a.pmds011"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds011
            #add-point:ON CHANGE pmds011 name="input.g.pmds011"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds014
            #add-point:BEFORE FIELD pmds014 name="input.b.pmds014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds014
            
            #add-point:AFTER FIELD pmds014 name="input.a.pmds014"
            IF NOT cl_null(g_pmds_m.pmds014) THEN
               IF g_pmds_m.pmds014 <> g_pmds_m_o.pmds014 OR cl_null(g_pmds_m_o.pmds014) THEN
                  IF NOT apmt520_pmds014_pmds053_chk(g_pmds_m.pmds014,g_pmds_m.pmds053) THEN
                     LET g_pmds_m.pmds014 = g_pmds_m_o.pmds014
                  
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            
            LET g_pmds_m_o.pmds014 = g_pmds_m.pmds014
            
            CALL apmt520_set_entry(p_cmd)
            CALL apmt520_set_no_required()
            CALL apmt520_set_required()
            CALL apmt520_set_no_entry(p_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds014
            #add-point:ON CHANGE pmds014 name="input.g.pmds014"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds081
            #add-point:BEFORE FIELD pmds081 name="input.b.pmds081"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds081
            
            #add-point:AFTER FIELD pmds081 name="input.a.pmds081"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds081
            #add-point:ON CHANGE pmds081 name="input.g.pmds081"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds045
            #add-point:BEFORE FIELD pmds045 name="input.b.pmds045"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds045
            
            #add-point:AFTER FIELD pmds045 name="input.a.pmds045"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds045
            #add-point:ON CHANGE pmds045 name="input.g.pmds045"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds021
            #add-point:BEFORE FIELD pmds021 name="input.b.pmds021"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds021
            
            #add-point:AFTER FIELD pmds021 name="input.a.pmds021"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds021
            #add-point:ON CHANGE pmds021 name="input.g.pmds021"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds022
            #add-point:BEFORE FIELD pmds022 name="input.b.pmds022"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds022
            
            #add-point:AFTER FIELD pmds022 name="input.a.pmds022"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds022
            #add-point:ON CHANGE pmds022 name="input.g.pmds022"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds023
            #add-point:BEFORE FIELD pmds023 name="input.b.pmds023"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds023
            
            #add-point:AFTER FIELD pmds023 name="input.a.pmds023"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds023
            #add-point:ON CHANGE pmds023 name="input.g.pmds023"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds024
            #add-point:BEFORE FIELD pmds024 name="input.b.pmds024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds024
            
            #add-point:AFTER FIELD pmds024 name="input.a.pmds024"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds024
            #add-point:ON CHANGE pmds024 name="input.g.pmds024"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds031
            
            #add-point:AFTER FIELD pmds031 name="input.a.pmds031"
            CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
            DISPLAY BY NAME g_pmds_m.pmds031_desc
            
            IF NOT cl_null(g_pmds_m.pmds031) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmds_m.pmds007
               LET g_chkparam.arg2 = g_pmds_m.pmds031

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_pmad002_1") THEN
                  #檢查成功時後續處理
                 
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmds_m.pmds031 = g_pmds_m_t.pmds031
                  CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
                  DISPLAY BY NAME g_pmds_m.pmds031_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds031
            #add-point:BEFORE FIELD pmds031 name="input.b.pmds031"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds031
            #add-point:ON CHANGE pmds031 name="input.g.pmds031"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds032
            
            #add-point:AFTER FIELD pmds032 name="input.a.pmds032"
            CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
            DISPLAY BY NAME g_pmds_m.pmds032_desc
            IF NOT cl_null(g_pmds_m.pmds031) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
                #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmds_m.pmds032
               #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="apm-00070:sub-01302|apmi012|",cl_get_progname("apmi012",g_lang,"2"),"|:EXEPROGapmi012"
               #160318-00025#15 by 07900 --add-end
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oocq002_238") THEN
                  #檢查成功時後續處理F
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmds_m.pmds032 = g_pmds_m_t.pmds032
                  CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
                  DISPLAY BY NAME g_pmds_m.pmds032_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds032
            #add-point:BEFORE FIELD pmds032 name="input.b.pmds032"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds032
            #add-point:ON CHANGE pmds032 name="input.g.pmds032"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds033
            
            #add-point:AFTER FIELD pmds033 name="input.a.pmds033"
            CALL apmt520_pmds033_ref(g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
            DISPLAY BY NAME g_pmds_m.pmds033_desc
            IF NOT cl_null(g_pmds_m.pmds033) THEN
               CALL s_tax_chk(g_site,g_pmds_m.pmds033)
                     RETURNING l_success,g_pmds_m.pmds033_desc,g_pmds_m.pmds035,g_pmds_m.pmds034,l_oodb011
                  
               IF NOT l_success THEN
                  LET g_pmds_m.pmds033 = g_pmds_m_t.pmds033
                  LET g_pmds_m.pmds034 = g_pmds_m_t.pmds034
                  LET g_pmds_m.pmds035 = g_pmds_m_t.pmds035
                  NEXT FIELD CURRENT
               ELSE                    
                  LET g_tax_app = l_oodb011  
               END IF
               DISPLAY BY NAME g_pmds_m.pmds035,g_pmds_m.pmds034
            END IF

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds033
            #add-point:BEFORE FIELD pmds033 name="input.b.pmds033"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds033
            #add-point:ON CHANGE pmds033 name="input.g.pmds033"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds034
            #add-point:BEFORE FIELD pmds034 name="input.b.pmds034"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds034
            
            #add-point:AFTER FIELD pmds034 name="input.a.pmds034"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds034
            #add-point:ON CHANGE pmds034 name="input.g.pmds034"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds035
            #add-point:BEFORE FIELD pmds035 name="input.b.pmds035"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds035
            
            #add-point:AFTER FIELD pmds035 name="input.a.pmds035"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds035
            #add-point:ON CHANGE pmds035 name="input.g.pmds035"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds036
            #add-point:BEFORE FIELD pmds036 name="input.b.pmds036"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds036
            
            #add-point:AFTER FIELD pmds036 name="input.a.pmds036"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds036
            #add-point:ON CHANGE pmds036 name="input.g.pmds036"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds037
            
            #add-point:AFTER FIELD pmds037 name="input.a.pmds037"
            CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
            DISPLAY BY NAME g_pmds_m.pmds037_desc
            IF NOT cl_null(g_pmds_m.pmds037) THEN
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_site
               LET g_chkparam.arg2 = g_pmds_m.pmds037
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00176:sub-01302|aooi150|",cl_get_progname("aooi150",g_lang,"2"),"|:EXEPROGaooi150"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooaj002") THEN
                  #檢查成功時後續處理
                  LET l_ooef016 = ''
                  SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
                  #根據內外購獲取當前營運據點參數設置的汇率类型
                  LET l_scc40 = ''
                  IF g_pmds_m.pmds048 = '1' THEN   #內購
                     LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
                  END IF
                  IF g_pmds_m.pmds048 = '2' THEN   #外購
                     LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
                  END IF
                  IF (NOT cl_null(l_scc40)) AND (NOT cl_null(l_ooef016)) THEN
                     CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmds_m.pmds037,l_ooef016,0,l_scc40) RETURNING g_pmds_m.pmds038
                  END IF
                  DISPLAY BY NAME g_pmds_m.pmds038
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmds_m.pmds037 = g_pmds_m_t.pmds037
                  CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
                  DISPLAY BY NAME g_pmds_m.pmds037_desc
                 
                  NEXT FIELD CURRENT
               END IF
            END IF

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds037
            #add-point:BEFORE FIELD pmds037 name="input.b.pmds037"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds037
            #add-point:ON CHANGE pmds037 name="input.g.pmds037"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds038
            #add-point:BEFORE FIELD pmds038 name="input.b.pmds038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds038
            
            #add-point:AFTER FIELD pmds038 name="input.a.pmds038"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds038
            #add-point:ON CHANGE pmds038 name="input.g.pmds038"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds039
            
            #add-point:AFTER FIELD pmds039 name="input.a.pmds039"
            CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
            DISPLAY BY NAME g_pmds_m.pmds039_desc
            
            IF NOT cl_null(g_pmds_m.pmds039) THEN 
               IF g_pmds_m.pmds039 != g_pmds_m_o.pmds039 OR cl_null(g_pmds_m_o.pmds039) THEN            
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmds_m.pmds039
                  #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="apm-00210:sub-01302|apmi130|",cl_get_progname("apmi130",g_lang,"2"),"|:EXEPROGapmi130"
                  #160318-00025#15 by 07900 --add-end 
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_pmam001") THEN
                     #檢查成功時後續處理
                     #重新抓取價格是否允許修改,修改容差率,價格超過容差率的處理方式,允許單價為0
                     LET g_pmam003 = ''
                     LET g_pmam006 = ''
                     LET g_pmam002 = ''
                     SELECT pmam003,pmam006,pmam002
                       INTO g_pmam003,g_pmam006,g_pmam002
                       FROM pmam_t       
                      WHERE pmament = g_enterprise
                        AND pmam001 = g_pmds_m.pmds039
                   
                  ELSE
                     #檢查失敗時後續處理
                     LET g_pmds_m.pmds039 = g_pmds_m_t.pmds039
                     CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
                     DISPLAY BY NAME g_pmds_m.pmds039_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            
            LET g_pmds_m_o.pmds039 = g_pmds_m.pmds039
            
            CALL apmt520_set_entry(p_cmd)
            CALL apmt520_set_no_required()
            CALL apmt520_set_required()
            CALL apmt520_set_no_entry(p_cmd)


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds039
            #add-point:BEFORE FIELD pmds039 name="input.b.pmds039"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds039
            #add-point:ON CHANGE pmds039 name="input.g.pmds039"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds040
            
            #add-point:AFTER FIELD pmds040 name="input.a.pmds040"
            CALL s_desc_ooid001_desc(g_pmds_m.pmds040) RETURNING g_pmds_m.pmds040_desc
            DISPLAY BY NAME g_pmds_m.pmds040_desc
            
            IF NOT cl_null(g_pmds_m.pmds040) THEN 
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
                #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmds_m.pmds040
                 #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00194:sub-01302|aooi717|",cl_get_progname("aooi717",g_lang,"2"),"|:EXEPROGaooi717"
               #160318-00025#15 by 07900 --add-end   
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooid001") THEN
                  #檢查成功時後續處理

               ELSE
                  #檢查失敗時後續處理
                  LET g_pmds_m.pmds040 = g_pmds_m_t.pmds040
                  CALL s_desc_ooid001_desc(g_pmds_m.pmds040) RETURNING g_pmds_m.pmds040_desc
                  DISPLAY BY NAME g_pmds_m.pmds040_desc
                  NEXT FIELD CURRENT
               END IF   
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds040
            #add-point:BEFORE FIELD pmds040 name="input.b.pmds040"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds040
            #add-point:ON CHANGE pmds040 name="input.g.pmds040"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds012
            
            #add-point:AFTER FIELD pmds012 name="input.a.pmds012"
            #160621-00003#3 20160629 modify by beckxie---S
            #CALL s_desc_get_acc_desc('275',g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
            CALL s_desc_get_oojdl003_desc(g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
            #160621-00003#3 20160629 modify by beckxie---E
            DISPLAY BY NAME g_pmds_m.pmds012_desc
            IF NOT cl_null(g_pmds_m.pmds012) THEN
               #160621-00003#3 20160627 modify by beckxie---S
               #IF NOT s_azzi650_chk_exist('275',g_pmds_m.pmds012) THEN
               INITIALIZE g_chkparam.* TO NULL 
               LET g_chkparam.arg1 = g_pmds_m.pmds012
               LET g_chkparam.arg2 = '2'
               LET g_chkparam.err_str[1] = "aoo-00299|",l_msg2
               IF NOT cl_chk_exist("v_oojd001") THEN
               #160621-00003#3 20160627 modify by beckxie---E
                  LET g_pmds_m.pmds012 = g_pmds_m_t.pmds012
                  #160621-00003#3 20160629 modify by beckxie---S
                  #CALL s_desc_get_acc_desc('275',g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
                  CALL s_desc_get_oojdl003_desc(g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
                  #160621-00003#3 20160629 modify by beckxie---E
                  DISPLAY BY NAME g_pmds_m.pmds012_desc
                  NEXT FIELD pmds012
               END IF
             END IF
             DISPLAY BY NAME g_pmds_m.pmds012_desc

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds012
            #add-point:BEFORE FIELD pmds012 name="input.b.pmds012"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds012
            #add-point:ON CHANGE pmds012 name="input.g.pmds012"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds101
            #add-point:BEFORE FIELD pmds101 name="input.b.pmds101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds101
            
            #add-point:AFTER FIELD pmds101 name="input.a.pmds101"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds101
            #add-point:ON CHANGE pmds101 name="input.g.pmds101"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds102
            #add-point:BEFORE FIELD pmds102 name="input.b.pmds102"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds102
            
            #add-point:AFTER FIELD pmds102 name="input.a.pmds102"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds102
            #add-point:ON CHANGE pmds102 name="input.g.pmds102"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds103
            #add-point:BEFORE FIELD pmds103 name="input.b.pmds103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds103
            
            #add-point:AFTER FIELD pmds103 name="input.a.pmds103"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds103
            #add-point:ON CHANGE pmds103 name="input.g.pmds103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds048
            #add-point:BEFORE FIELD pmds048 name="input.b.pmds048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds048
            
            #add-point:AFTER FIELD pmds048 name="input.a.pmds048"
            #取匯率
            IF NOT cl_null(g_pmds_m.pmds037) THEN
               #根據內外購獲取當前營運據點參數設置的汇率类型
               LET l_scc40 = ''
               IF g_pmds_m.pmds048 = '1' THEN   #內購
                  LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
               END IF
               IF g_pmds_m.pmds048 = '2' THEN   #外購
                  LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
               END IF
               LET l_ooef016 = ''
               SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
               IF (NOT cl_null(l_scc40)) AND (NOT cl_null(l_ooef016)) THEN
                  CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmds_m.pmds037,l_ooef016,0,l_scc40) RETURNING g_pmds_m.pmds038
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds048
            #add-point:ON CHANGE pmds048 name="input.g.pmds048"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds047
            #add-point:BEFORE FIELD pmds047 name="input.b.pmds047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds047
            
            #add-point:AFTER FIELD pmds047 name="input.a.pmds047"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds047
            #add-point:ON CHANGE pmds047 name="input.g.pmds047"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds049
            #add-point:BEFORE FIELD pmds049 name="input.b.pmds049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds049
            
            #add-point:AFTER FIELD pmds049 name="input.a.pmds049"
            #161111-00053#1---s
            CALL apmt520_set_entry(p_cmd)
            CALL apmt520_set_no_required()
            CALL apmt520_set_required()               
            CALL apmt520_set_no_entry(p_cmd)   
            #161111-00053#1---e
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds049
            #add-point:ON CHANGE pmds049 name="input.g.pmds049"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds053
            
            #add-point:AFTER FIELD pmds053 name="input.a.pmds053"
            CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
            DISPLAY BY NAME g_pmds_m.pmds053_desc
            
            IF NOT cl_null(g_pmds_m.pmds053) THEN
            #150610 earl mod s
#               #此段落由子樣板a19產生
#               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
#               INITIALIZE g_chkparam.* TO NULL
#
#               #設定g_chkparam.*的參數
#               LET g_chkparam.arg1 = g_pmds_m.pmds053
#               LET g_chkparam.arg2 = g_site
#               IF g_pmds_m.pmds014 = '2' THEN
#                  IF NOT cl_chk_exist("v_icaa001_4") THEN
#                     LET g_pmds_m.pmds053 = g_pmds_m_t.pmds053
#                     CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
#                     DISPLAY BY NAME g_pmds_m.pmds053_desc
#                     NEXT FIELD CURRENT
#                  END IF
#               END IF
#               IF g_pmds_m.pmds014 = '3' THEN
#                  IF NOT cl_chk_exist("v_icaa001_5") THEN
#                     LET g_pmds_m.pmds053 = g_pmds_m_t.pmds053
#                     CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
#                     DISPLAY BY NAME g_pmds_m.pmds053_desc
#                     NEXT FIELD CURRENT
#                  END IF
#               END IF
               IF g_pmds_m.pmds053 <> g_pmds_m_o.pmds053 OR cl_null(g_pmds_m_o.pmds053) THEN
               
                  IF NOT apmt520_pmds014_pmds053_chk(g_pmds_m.pmds014,g_pmds_m.pmds053) THEN
                     LET g_pmds_m.pmds053 = g_pmds_m_o.pmds053
                     CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
                     DISPLAY BY NAME g_pmds_m.pmds053_desc
                     NEXT FIELD CURRENT
                  END IF
                  
               END IF
            END IF
            
            LET g_pmds_m_o.pmds053 = g_pmds_m.pmds053
            #150610 earl mod e
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds053
            #add-point:BEFORE FIELD pmds053 name="input.b.pmds053"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds053
            #add-point:ON CHANGE pmds053 name="input.g.pmds053"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds041
            #add-point:BEFORE FIELD pmds041 name="input.b.pmds041"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds041
            
            #add-point:AFTER FIELD pmds041 name="input.a.pmds041"
            
            IF NOT cl_null(g_pmds_m.pmds041) THEN 
               IF g_pmds_m.pmds041 <> g_pmds_m_o.pmds041 OR cl_null(g_pmds_m_o.pmds041) THEN
                  
                  #150917-00001#3   2016/03/03  By earl mark s
#                  #中斷續拋
#                  IF apmt520_break_continue(g_pmds_m.pmds053) THEN
#                     #多角序號檢查
#                     IF NOT cl_null(g_pmds_m.pmds006) THEN
#                        IF NOT apmt520_source_pmds041_chk(g_pmds_m.pmds006,g_pmds_m.pmds041) THEN
#                           LET g_pmds_m.pmds041 = g_pmds_m_o.pmds041
#                           NEXT FIELD CURRENT
#                        END IF
#                     END IF
#                     
#                  END IF
                  #150917-00001#3   2016/03/03  By earl mark e
                  
               END IF
            END IF 

            LET g_pmds_m_o.pmds041 = g_pmds_m.pmds041
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds041
            #add-point:ON CHANGE pmds041 name="input.g.pmds041"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds043
            #add-point:BEFORE FIELD pmds043 name="input.b.pmds043"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds043
            
            #add-point:AFTER FIELD pmds043 name="input.a.pmds043"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds043
            #add-point:ON CHANGE pmds043 name="input.g.pmds043"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds044
            #add-point:BEFORE FIELD pmds044 name="input.b.pmds044"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds044
            
            #add-point:AFTER FIELD pmds044 name="input.a.pmds044"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds044
            #add-point:ON CHANGE pmds044 name="input.g.pmds044"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds046
            #add-point:BEFORE FIELD pmds046 name="input.b.pmds046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds046
            
            #add-point:AFTER FIELD pmds046 name="input.a.pmds046"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds046
            #add-point:ON CHANGE pmds046 name="input.g.pmds046"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds054
            #add-point:BEFORE FIELD pmds054 name="input.b.pmds054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds054
            
            #add-point:AFTER FIELD pmds054 name="input.a.pmds054"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds054
            #add-point:ON CHANGE pmds054 name="input.g.pmds054"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds055
            #add-point:BEFORE FIELD pmds055 name="input.b.pmds055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds055
            
            #add-point:AFTER FIELD pmds055 name="input.a.pmds055"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds055
            #add-point:ON CHANGE pmds055 name="input.g.pmds055"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds050
            #add-point:BEFORE FIELD pmds050 name="input.b.pmds050"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds050
            
            #add-point:AFTER FIELD pmds050 name="input.a.pmds050"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds050
            #add-point:ON CHANGE pmds050 name="input.g.pmds050"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds057
            #add-point:BEFORE FIELD pmds057 name="input.b.pmds057"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds057
            
            #add-point:AFTER FIELD pmds057 name="input.a.pmds057"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds057
            #add-point:ON CHANGE pmds057 name="input.g.pmds057"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds042
            #add-point:BEFORE FIELD pmds042 name="input.b.pmds042"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds042
            
            #add-point:AFTER FIELD pmds042 name="input.a.pmds042"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds042
            #add-point:ON CHANGE pmds042 name="input.g.pmds042"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds058
            #add-point:BEFORE FIELD pmds058 name="input.b.pmds058"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds058
            
            #add-point:AFTER FIELD pmds058 name="input.a.pmds058"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds058
            #add-point:ON CHANGE pmds058 name="input.g.pmds058"
            
            #END add-point 
 
 
 #欄位檢查
                  #Ctrlp:input.c.pmdssite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdssite
            #add-point:ON ACTION controlp INFIELD pmdssite name="input.c.pmdssite"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmdsdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocno
            #add-point:ON ACTION controlp INFIELD pmdsdocno name="input.c.pmdsdocno"
                                                #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmdsdocno             #給予default值

            #給予arg
            LET g_qryparam.arg1 = l_ooef004 #
            LET g_qryparam.arg2 = g_prog #

            #150909 earl mod s
            IF NOT cl_null(g_pmds_m.pmds006) THEN
               CALL s_aooi210_get_search_sql(g_site,'',g_pmds_m.pmds006,g_prog) RETURNING l_success,l_where
            ELSE
               LET l_success = TRUE
               LET l_where = "1=1"
            END IF
            
            IF l_success THEN
               #151210-00009#1  2015/12/30 By earl s
               IF g_aic_doc THEN
                  LET l_where = l_where,
                                " AND NOT EXISTS ( (SELECT 1 FROM icaa_t,icab_t a,icac_t ",
                                "                  WHERE icaaent = a.icabent AND a.icabent = icacent AND icacent = ",g_enterprise,
                                "                    AND icaa001 = a.icab001 AND a.icab001 = icac001",
                                "                    AND a.icab002 = icac002",
                                "                    AND a.icab003 = '",g_site,"'",
                                "                    AND (ooba002 = icac011 OR ooba002 = icac012 OR ooba002 = icac013)"
                            #排除正拋初始站、逆拋最終站、逆拋中斷初始站
                            IF g_argv[1] <> '7' AND g_argv[1] <> '14' THEN
                                LET l_where = l_where,
                                              "    AND NOT ( ((icaa003 = '2' OR icaa003 = '3')",
                                              "              AND (icaa004 = '1' OR (icaa004 = '2' AND icaa005 = 'Y')) AND a.icab002 = '0')",
                                              "          OR (icaa003 = '3'",
                                              "              AND icaa004 = '2' AND a.icab002 = (SELECT MAX(b.icab002) FROM icab_t b",
                                              "                                                  WHERE b.icabent = icaaent",
                                              "                                                    AND b.icab001 = icaa001))",
                                              "            )",
                                              "       )",  #160328-00010#1  --- add
                                              ")"
                                
                            ELSE
                                LET l_where = l_where,
                                              "    AND NOT ( ((icaa003 = '2' OR icaa003 = '3')",
                                              "              AND icaa004 = '1' AND a.icab002 = '0')",
                                              "          OR (icaa003 = '3'",
                                              "              AND icaa004 = '2' AND a.icab002 = (SELECT MAX(b.icab002) FROM icab_t b",
                                              "                                                  WHERE b.icabent = icaaent",
                                              "                                                    AND b.icab001 = icaa001))",
                                              "            )",
                                              "       )",  #160328-00010#1  --- add
                                              ")"
                            END IF
                                
               END IF
               #151210-00009#1  2015/12/30 By earl e
               
               LET g_qryparam.where = l_where
               CALL q_ooba002_1()                                #呼叫開窗

               LET g_pmds_m.pmdsdocno = g_qryparam.return1              #將開窗取得的值回傳到變數

               DISPLAY g_pmds_m.pmdsdocno TO pmdsdocno              #顯示到畫面上
               CALL s_aooi200_get_slip_desc(g_pmds_m.pmdsdocno) RETURNING g_pmds_m.pmdsdocno_desc
               DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
            END IF
            #150909 earl mod e

            NEXT FIELD pmdsdocno                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdsdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocdt
            #add-point:ON ACTION controlp INFIELD pmdsdocdt name="input.c.pmdsdocdt"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds001
            #add-point:ON ACTION controlp INFIELD pmds001 name="input.c.pmds001"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds002
            #add-point:ON ACTION controlp INFIELD pmds002 name="input.c.pmds002"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds002             #給予default值

            #給予arg

            CALL q_ooag001()                                #呼叫開窗

            LET g_pmds_m.pmds002 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds002 TO pmds002              #顯示到畫面上

            NEXT FIELD pmds002                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds003
            #add-point:ON ACTION controlp INFIELD pmds003 name="input.c.pmds003"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds003             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmdsdocdt #

            CALL q_ooeg001()                                #呼叫開窗

            LET g_pmds_m.pmds003 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds003 TO pmds003              #顯示到畫面上

            NEXT FIELD pmds003                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmdsstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsstus
            #add-point:ON ACTION controlp INFIELD pmdsstus name="input.c.pmdsstus"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds006
            #add-point:ON ACTION controlp INFIELD pmds006 name="input.c.pmds006"
                                                #此段落由子樣板a07產生            

            #150610 earl add s
            LET l_where_1 = " (pmdl051 IS NULL ",
                            "  OR (pmdl051 IN (SELECT icaa001 FROM icaa_t LEFT OUTER JOIN icab_t ON icabent = icaaent AND icab001 = icaa001 WHERE icaaent = ",g_enterprise," AND icaastus = 'Y'",
                            "                     AND ((icaa003 = '2' OR icaa003 = '3') AND icaa004 = '1' AND icab002 = 0 AND icab003 = '",g_site,"')",
                            "                          OR (icaa003 = '3' AND icaa004 = '2' AND icab002 = (SELECT MAX(icab002) FROM icab_t WHERE icabent = icaaent AND icab001 = icaa001) AND icab003 = '",g_site,"')",
                            "                          OR (icaa005 = 'Y' AND (icaa003 = '2' OR icaa003 = '3') AND icaa004 = '2'  AND icab002 = 0 AND icab003 = '",g_site,"')",
                            "                 )",
                            "     )",
                            " )"
                              
            LET l_where_2 = " (pmds053 IS NULL ",
                            "  OR (pmds053 IN (SELECT icaa001 FROM icaa_t LEFT OUTER JOIN icab_t ON icabent = icaaent AND icab001 = icaa001 WHERE icaaent = ",g_enterprise," AND icaastus = 'Y'",
                            "                     AND ((icaa003 = '2' OR icaa003 = '3') AND icaa004 = '1' AND icab002 = 0 AND icab003 = '",g_site,"')",
                            "                          OR (icaa003 = '3' AND icaa004 = '2' AND icab002 = (SELECT MAX(icab002) FROM icab_t WHERE icabent = icaaent AND icab001 = icaa001) AND icab003 = '",g_site,"')",
                            "                          OR (icaa005 = 'Y' AND (icaa003 = '2' OR icaa003 = '3') AND icaa004 = '2'  AND icab002 = 0 AND icab003 = '",g_site,"')",
                            "                 )",
                            "     )",
                            " )"
            #150610 earl add e
            
            #150909 earl mod s
            #組合過濾前後置單據資料SQL
            CALL s_aooi210_get_check_sql(g_site,'',g_pmds_m.pmdsdocno,'4','','pmdldocno') RETURNING l_success,l_where
            IF l_success THEN
               LET l_where_1 = l_where_1," AND ",l_where
            END IF
            
            IF l_success THEN
               CALL s_aooi210_get_check_sql(g_site,'',g_pmds_m.pmdsdocno,'4','','pmdsdocno') RETURNING l_success,l_where
               IF l_success THEN
                  LET l_where_2 = l_where_2," AND ",l_where
               END IF
            END IF
            #150909 earl mod e

            IF l_success THEN
               #開窗i段
			      INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
			      LET g_qryparam.reqry = FALSE
               
               LET g_qryparam.default1 = g_pmds_m.pmds006             #給予default值
               #採購收貨時開窗開採購單號
			      IF g_argv[1] MATCHES '[13]' THEN
			         LET g_qryparam.where = " pmdl005 NOT IN ('2','5','6') "
                                        # " AND pmdldocno IN (SELECT DISTINCT pmdndocno FROM pmdn_t WHERE pmdnent = '",g_enterprise,"' AND pmdnunit = '",g_site,"') "          
                                        
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_1  #150610 earl add
                                 
                  CALL q_pmdldocno_7()                           #呼叫開窗
               END IF
               IF g_argv[1] = '8' OR g_argv[1] = '20' THEN   #委外採購
                  LET g_qryparam.where = " pmdl005 ='2' " 
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_1  #150610 earl add
                  
                  CALL q_pmdldocno_7() 
               END IF
               IF g_argv[1] = '9' THEN   #重覆性生產採購
                  LET g_qryparam.where = " pmdl005 ='5' "
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_1  #150610 earl add
                  
                  CALL q_pmdldocno_7() 
               END IF
               
               #借貨收貨單
               IF g_argv[1] = '23' OR g_argv[1] = '24' THEN
                  LET g_qryparam.where = " pmdl005 ='6' " 
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_1  #150610 earl add
                  
                  CALL q_pmdldocno_7() 
               END IF
               
               #驗退、入庫、倉退時開窗開收貨單號
               IF g_argv[1] MATCHES '[56]' THEN
                  LET g_qryparam.arg1 = "('1','2')"
                  LET g_qryparam.where = " (pmdt053 - pmdt054 - pmdt055 > 0 ) "  #161117-00013#1 add      
                 #LET g_qryparam.where = l_where_2  #150610 earl add             #161117-00013#1 mark
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_2      #161117-00013#1 add
                  
                  CALL q_pmdsdocno()                           #呼叫開窗
               END IF
               #倉退時開窗開收貨單號
               IF g_argv[1] MATCHES '[7]' THEN
                  LET g_qryparam.arg1 = "('1','2','3','4')"
                  
                  LET g_qryparam.where = l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno()                           #呼叫開窗
               END IF
               
               #委外驗退、入庫、倉退時開窗開收貨單號
               IF g_argv[1] = '10' THEN   #委外驗退
                  LET g_qryparam.arg1 = "('8','20')"
                  
                  LET g_qryparam.where = l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno() 
               END IF
               IF g_argv[1] = '12' THEN   #委外入庫
                  LET g_qryparam.arg1 = "('8','20')"
                  LET g_qryparam.where = " (pmdt053 - pmdt054 > 0) "
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno() 
               END IF
               IF g_argv[1] = '14' THEN   #委外倉退
                  LET g_qryparam.arg1 = "('8','20')"
                  LET g_qryparam.where = " pmdt054 > 0 "
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno() 
               END IF
               #重覆性生產驗退、入庫、倉退時開窗開收貨單號
               IF g_argv[1] = '11' THEN   #重覆性驗退
                  LET g_qryparam.arg1 = "('9')"
                  
                  LET g_qryparam.where = l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno() 
               END IF
               IF g_argv[1] = '13' THEN   #重覆性入庫
                  LET g_qryparam.arg1 = "('9')"
                  LET g_qryparam.where = " (pmdt053 - pmdt054 > 0 ) "
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno() 
               END IF
               IF g_argv[1] = '15' THEN   #重覆性倉退
                  LET g_qryparam.arg1 = "('9')"
                  LET g_qryparam.where = " pmdt054 > 0 "
                  
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno() 
               END IF
               
               #借貨入庫時開窗開借貨收貨單號
               IF g_argv[1] = '25' THEN
                  LET g_qryparam.arg1 = "('23')"
                  
                  LET g_qryparam.where = l_where_2  #150610 earl add
                  
                  CALL q_pmdsdocno()                           #呼叫開窗
               END IF
               #借貨倉退時開窗開借貨收貨單號
               IF g_argv[1] = '26' THEN
                  LET g_qryparam.arg1 = "('23','24')"         
                  LET g_qryparam.where = l_where_2  #150610 earl add                     
                  CALL q_pmdsdocno()                           #呼叫開窗
               END IF
               
               LET g_pmds_m.pmds006 = g_qryparam.return1              #將開窗取得的值回傳到變數
               
               DISPLAY g_pmds_m.pmds006 TO pmds006              #顯示到畫面上
            END IF

            NEXT FIELD pmds006                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds007
            #add-point:ON ACTION controlp INFIELD pmds007 name="input.c.pmds007"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		    	LET g_qryparam.reqry = FALSE
			   LET g_qryparam.where = "pmaa001 IN (SELECT pmab001 FROM pmab_t ",                                             #151217-00014#3 add
                                   "             WHERE pmabsite = '",g_site,"' AND pmabent = '",g_enterprise,"' AND 1=1)" #151217-00014#3 add
            LET g_qryparam.default1 = g_pmds_m.pmds007             #給予default值

            #LET g_qryparam.where = "1=1 " #151217-00014#3 mark
            #160713-00001#1---s
            IF cl_null(g_pmds_m.pmdsdocno) THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = "apm-00603" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               NEXT FIELD pmdsdocno
            END IF
            #160713-00001#1---e
            LET l_sql = ''
            CALL s_control_get_doc_sql("pmaa083",g_pmds_m.pmdsdocno,'2') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            END IF
            #給予arg

            CALL q_pmaa001_3()                                #呼叫開窗

            LET g_pmds_m.pmds007 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds007 TO pmds007              #顯示到畫面上
            
            CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
            DISPLAY BY NAME g_pmds_m.pmds007_desc

            NEXT FIELD pmds007                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds008
            #add-point:ON ACTION controlp INFIELD pmds008 name="input.c.pmds008"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds008             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmds007
            LET g_qryparam.where = " pmac003 = '1' "  #付款
            
            #160713-00001#1---s
            IF cl_null(g_pmds_m.pmdsdocno) THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = "apm-00603" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               NEXT FIELD pmdsdocno
            END IF
            #160713-00001#1---e
            
            LET l_sql = ''
            CALL s_control_get_doc_sql("pmaa083",g_pmds_m.pmdsdocno,'2') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND pmac002 IN ( SELECT pmaa001 FROM pmaa_t WHERE pmaaent = '",g_enterprise,"' AND ",l_sql,")"
            END IF
            CALL q_pmac002_2()                                #呼叫開窗

            LET g_pmds_m.pmds008 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds008 TO pmds008              #顯示到畫面上
            
            CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
            DISPLAY BY NAME g_pmds_m.pmds008_desc

            NEXT FIELD pmds008                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds009
            #add-point:ON ACTION controlp INFIELD pmds009 name="input.c.pmds009"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds009             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmds007
            
            #160713-00001#1---s
            IF cl_null(g_pmds_m.pmdsdocno) THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = "apm-00603" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               NEXT FIELD pmdsdocno
            END IF
            #160713-00001#1---e
            
            LET g_qryparam.where = " pmac003 = '2' "  #
            LET l_sql = ''
            CALL s_control_get_doc_sql("pmaa083",g_pmds_m.pmdsdocno,'2') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND pmac002 IN ( SELECT pmaa001 FROM pmaa_t WHERE pmaaent = '",g_enterprise,"' AND ",l_sql,")"
            END IF
            
            IF NOT cl_null(g_pmds_m.pmds006) THEN
               LET g_qryparam.where = g_qryparam.where ," AND pmac002 IN (SELECT pmdn023 FROM pmdn_t WHERE pmdnent = '",g_enterprise,"' AND pmdndocno = '",g_pmds_m.pmds006,"' )"
            END IF
            CALL q_pmac002_2()                          #呼叫開窗

            LET g_pmds_m.pmds009 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds009 TO pmds009              #顯示到畫面上
            
            CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
            DISPLAY BY NAME g_pmds_m.pmds009_desc

            NEXT FIELD pmds009                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds010
            #add-point:ON ACTION controlp INFIELD pmds010 name="input.c.pmds010"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds052
            #add-point:ON ACTION controlp INFIELD pmds052 name="input.c.pmds052"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds028
            #add-point:ON ACTION controlp INFIELD pmds028 name="input.c.pmds028"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds000
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds000
            #add-point:ON ACTION controlp INFIELD pmds000 name="input.c.pmds000"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds100
            #add-point:ON ACTION controlp INFIELD pmds100 name="input.c.pmds100"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds011
            #add-point:ON ACTION controlp INFIELD pmds011 name="input.c.pmds011"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds014
            #add-point:ON ACTION controlp INFIELD pmds014 name="input.c.pmds014"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds081
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds081
            #add-point:ON ACTION controlp INFIELD pmds081 name="input.c.pmds081"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds045
            #add-point:ON ACTION controlp INFIELD pmds045 name="input.c.pmds045"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds021
            #add-point:ON ACTION controlp INFIELD pmds021 name="input.c.pmds021"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds022
            #add-point:ON ACTION controlp INFIELD pmds022 name="input.c.pmds022"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds023
            #add-point:ON ACTION controlp INFIELD pmds023 name="input.c.pmds023"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds024
            #add-point:ON ACTION controlp INFIELD pmds024 name="input.c.pmds024"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds031
            #add-point:ON ACTION controlp INFIELD pmds031 name="input.c.pmds031"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds031             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmds007 #

            CALL q_pmad002_2()                                #呼叫開窗

            LET g_pmds_m.pmds031 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds031 TO pmds031              #顯示到畫面上
            
            CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
            DISPLAY BY NAME g_pmds_m.pmds031_desc
            NEXT FIELD pmds031                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds032
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds032
            #add-point:ON ACTION controlp INFIELD pmds032 name="input.c.pmds032"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds032             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "238" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmds_m.pmds032 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds032 TO pmds032              #顯示到畫面上
            
            CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
            DISPLAY BY NAME g_pmds_m.pmds032_desc
            
            NEXT FIELD pmds032                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds033
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds033
            #add-point:ON ACTION controlp INFIELD pmds033 name="input.c.pmds033"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds033             #給予default值

            #給予arg

            CALL q_oodb002_2()                                #呼叫開窗

            LET g_pmds_m.pmds033 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds033 TO pmds033              #顯示到畫面上
            
            CALL apmt520_pmds033_ref(g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
            DISPLAY BY NAME g_pmds_m.pmds033_desc
            
            NEXT FIELD pmds033                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds034
            #add-point:ON ACTION controlp INFIELD pmds034 name="input.c.pmds034"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds035
            #add-point:ON ACTION controlp INFIELD pmds035 name="input.c.pmds035"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds036
            #add-point:ON ACTION controlp INFIELD pmds036 name="input.c.pmds036"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds037
            #add-point:ON ACTION controlp INFIELD pmds037 name="input.c.pmds037"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds037             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_site #

            CALL q_ooaj002_1()                                #呼叫開窗

            LET g_pmds_m.pmds037 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds037 TO pmds037              #顯示到畫面上
            
            CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
            DISPLAY BY NAME g_pmds_m.pmds037_desc
            
            NEXT FIELD pmds037                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds038
            #add-point:ON ACTION controlp INFIELD pmds038 name="input.c.pmds038"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds039
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds039
            #add-point:ON ACTION controlp INFIELD pmds039 name="input.c.pmds039"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds039             #給予default值

            #給予arg

            CALL q_pmam001()                                #呼叫開窗

            LET g_pmds_m.pmds039 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds039 TO pmds039              #顯示到畫面上
            
            CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
            DISPLAY BY NAME g_pmds_m.pmds039_desc
            
            NEXT FIELD pmds039                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds040
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds040
            #add-point:ON ACTION controlp INFIELD pmds040 name="input.c.pmds040"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds040             #給予default值

            #給予arg

            CALL q_ooid001_2()                                #呼叫開窗

            LET g_pmds_m.pmds040 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmds_m.pmds040 TO pmds040              #顯示到畫面上
            
            CALL s_desc_ooid001_desc(g_pmds_m.pmds040) RETURNING g_pmds_m.pmds040_desc
            DISPLAY BY NAME g_pmds_m.pmds040_desc

            NEXT FIELD pmds040                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds012
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds012
            #add-point:ON ACTION controlp INFIELD pmds012 name="input.c.pmds012"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds012             #給予default值
            LET g_qryparam.default2 = "" #g_pmds_m.oocq002 #應用分類碼
            #給予arg
            #160621-00003#3 20160627 modify by beckxie---S
			   #LET g_qryparam.arg1 = "275"
            #CALL q_oocq002()                           #呼叫開窗
            LET g_qryparam.arg1 = '2'
            CALL q_oojd001_1()
            #160621-00003#3 20160627 modify by beckxie---E

            LET g_pmds_m.pmds012 = g_qryparam.return1              
            #LET g_pmds_m.oocq002 = g_qryparam.return2 
            DISPLAY g_pmds_m.pmds012 TO pmds012              #
            #DISPLAY g_pmds_m.oocq002 TO oocq002 #應用分類碼
            NEXT FIELD pmds012                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.pmds101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds101
            #add-point:ON ACTION controlp INFIELD pmds101 name="input.c.pmds101"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds102
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds102
            #add-point:ON ACTION controlp INFIELD pmds102 name="input.c.pmds102"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds103
            #add-point:ON ACTION controlp INFIELD pmds103 name="input.c.pmds103"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds048
            #add-point:ON ACTION controlp INFIELD pmds048 name="input.c.pmds048"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds047
            #add-point:ON ACTION controlp INFIELD pmds047 name="input.c.pmds047"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds049
            #add-point:ON ACTION controlp INFIELD pmds049 name="input.c.pmds049"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds053
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds053
            #add-point:ON ACTION controlp INFIELD pmds053 name="input.c.pmds053"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmds_m.pmds053             #給予default值

            #給予arg
            IF g_pmds_m.pmds014 = '2' THEN
               LET g_qryparam.where = " icaa003 = '2' "
            END IF
            IF g_pmds_m.pmds014 = '3' THEN
               LET g_qryparam.where = " icaa003 = '3' "
            END IF

            CALL q_icaa001_7()                                #呼叫開窗

            LET g_pmds_m.pmds053 = g_qryparam.return1

            DISPLAY g_pmds_m.pmds053 TO pmds053              #
            CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
            DISPLAY BY NAME g_pmds_m.pmds053_desc

            NEXT FIELD pmds053                          #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.pmds041
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds041
            #add-point:ON ACTION controlp INFIELD pmds041 name="input.c.pmds041"
            #此段落由子樣板a08產生
            #開窗i段
            
            #有來源單號限制
			   IF NOT cl_null(g_pmds_m.pmds006) THEN
			      INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
			      LET g_qryparam.reqry = FALSE
               
               LET g_qryparam.default1 = g_pmds_m.pmds041             #給予default值
               
               LET l_where_1 = ''
               LET l_where_2 = ''

               IF g_pmds_m.pmds014 = '2' THEN #代採購
			         LET l_where_1 = " xmdkdocno IN (SELECT xmdkdocno FROM xmdk_t",
			                         "                WHERE xmdkent = ",g_enterprise,
			                         "                  AND xmdk083 = 'Y'",
			                         "                  AND xmdksite = (SELECT icab003 FROM icab_t ",
			                         "                                   WHERE icabent = ",g_enterprise,
			                         "                                     AND icab001 = xmdk044",
			                         "                                     AND icab002 = (SELECT MAX(icab002) FROM icab_t",
			                         "                                                     WHERE icabent = ",g_enterprise,
			                         "                                                       AND icab001 = xmdk044))",
			                         "                  AND xmdk006 IN (SELECT xmdadocno FROM xmda_t",
			                         "                                   WHERE xmdaent = ",g_enterprise,
                                  "                                     AND xmda031 IN (SELECT pmdl031 FROM pmdl_t",
                                  "                                                      WHERE pmdlent = ",g_enterprise,
                                  "                                                        AND pmdldocno = '",g_pmds_m.pmds006,"'",
                                  "                                                    )",
                                  "                                 )",
                                  "              )"

                  LET g_qryparam.where = l_where_1
               
                  LET g_qryparam.arg1 = '1'
                  LET g_qryparam.arg2 = g_pmds_m.pmdsdocno
                  LET g_qryparam.arg3 = '2'
                  CALL q_xmdk035()
			      ELSE   #代採購指定供應商
			         LET l_where_1 = " pmdsdocno IN (SELECT pmdsdocno FROM pmds_t",
			                         "                WHERE pmdsent = ",g_enterprise,
			                         "                  AND pmds050 = 'Y'",
			                         "                  AND pmdssite = (SELECT icab003 FROM icab_t ",
			                         "                                   WHERE icabent = ",g_enterprise,
			                         "                                     AND icab001 = pmds053",
			                         "                                     AND icab002 = (SELECT MAX(icab002) FROM icab_t",
			                         "                                                     WHERE icabent = ",g_enterprise,
			                         "                                                       AND icab001 = pmds053))",
			                         "                  AND pmds006 IN (SELECT pmdldocno FROM pmdl_t",
			                         "                                   WHERE pmdlent = ",g_enterprise,
                                  "                                     AND pmdl031 IN (SELECT pmdl031 FROM pmdl_t",
                                  "                                                      WHERE pmdlent = ",g_enterprise,
                                  "                                                        AND pmdldocno = '",g_pmds_m.pmds006,"'",
                                  "                                                    )",
                                  "                                   UNION",
                                  "                                  SELECT pmdsdocno FROM pmds_t",
			                         "                                   WHERE pmdsent = ",g_enterprise,
                                  "                                     AND pmds041 IN (SELECT pmds041 FROM pmds_t",
                                  "                                                      WHERE pmdsent = ",g_enterprise,
                                  "                                                        AND pmdsdocno = '",g_pmds_m.pmds006,"'",
                                  "                                                    )",
                                  "                                 )",
                                  "              )"

                  LET g_qryparam.where = l_where_1
                  LET g_qryparam.arg1 = g_argv[1]
                  LET g_qryparam.arg2 = g_pmds_m.pmdsdocno
            
                  CALL q_pmds041_2()
               END IF

               LET g_pmds_m.pmds041 = g_qryparam.return1
               DISPLAY g_pmds_m.pmds041 TO pmds041  #顯示到畫面上
            END IF
            
            NEXT FIELD pmds041                     #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.pmds043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds043
            #add-point:ON ACTION controlp INFIELD pmds043 name="input.c.pmds043"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds044
            #add-point:ON ACTION controlp INFIELD pmds044 name="input.c.pmds044"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds046
            #add-point:ON ACTION controlp INFIELD pmds046 name="input.c.pmds046"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds054
            #add-point:ON ACTION controlp INFIELD pmds054 name="input.c.pmds054"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds055
            #add-point:ON ACTION controlp INFIELD pmds055 name="input.c.pmds055"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds050
            #add-point:ON ACTION controlp INFIELD pmds050 name="input.c.pmds050"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds057
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds057
            #add-point:ON ACTION controlp INFIELD pmds057 name="input.c.pmds057"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds042
            #add-point:ON ACTION controlp INFIELD pmds042 name="input.c.pmds042"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds058
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds058
            #add-point:ON ACTION controlp INFIELD pmds058 name="input.c.pmds058"
            
            #END add-point
 
 
 #欄位開窗
            
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
 
            #CALL cl_err_collect_show()      #錯誤訊息統整顯示
            #CALL cl_showmsg()
            DISPLAY BY NAME g_pmds_m.pmdsdocno
                        
            #add-point:單頭INPUT後 name="input.head.after_input"
            IF cl_null(g_pmds_m.pmds006) AND g_pmds_m.pmds100 = '2' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'apm-00656'
               LET g_errparam.extend = g_pmds_m.pmdsdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD pmds100
            END IF
          
            #end add-point
                        
            IF p_cmd <> 'u' THEN
    
               CALL s_transaction_begin()
               
               #add-point:單頭新增前 name="input.head.b_insert"
               CALL s_aooi200_gen_docno(g_site,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_prog) RETURNING l_success,g_pmds_m.pmdsdocno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00003'
                  LET g_errparam.extend = g_pmds_m.pmdsdocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  NEXT FIELD pmdsdocno
               END IF                
               #end add-point
               
               INSERT INTO pmds_t (pmdsent,pmdssite,pmdsdocno,pmdsdocdt,pmds001,pmds002,pmds003,pmdsstus, 
                   pmds006,pmds007,pmds008,pmds009,pmds010,pmds052,pmds028,pmds000,pmds100,pmds011,pmds014, 
                   pmds081,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035, 
                   pmds036,pmds037,pmds038,pmds039,pmds040,pmds012,pmds101,pmds102,pmds103,pmds048,pmds047, 
                   pmds049,pmds053,pmds041,pmds043,pmds044,pmds046,pmds054,pmds055,pmds050,pmds057,pmds042, 
                   pmds058,pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid, 
                   pmdscnfdt,pmdspstid,pmdspstdt)
               VALUES (g_enterprise,g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001, 
                   g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007, 
                   g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
                   g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081, 
                   g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024, 
                   g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
                   g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040, 
                   g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048, 
                   g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
                   g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050, 
                   g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp, 
                   g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt, 
                   g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt) 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "g_pmds_m:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭新增中 name="input.head.m_insert"
               #161207-00033#38---s
               #供应商的一次交易对象或内部员工时，单头新增后，需更新pmak中的参考单号为单头完整单号
               #无采购收货单，维护供应商是一次性交易对象时，需产生一次性交易对象识别码
               IF g_argv[1] MATCHES '[24]' THEN
                  UPDATE pmak_t SET pmak006 = g_pmds_m.pmdsdocno WHERE pmakent = g_enterprise AND pmak001 = g_pmds_m.pmds028
               END IF
               #161207-00033#38---e      
               LET g_ooff003_d = g_pmds_m.pmdsdocno   #161031-00025#15 add               
               #end add-point
               
               
               
               
               #add-point:單頭新增後 name="input.head.a_insert"
               
               #150917-00001#3   2016/03/03  By earl mark s
#               #150617 earl mod s
#               #中斷續拋，直接由最終站將資料帶出
#               IF apmt520_break_continue(g_pmds_m.pmds053) THEN
#               
#                  CALL apmt520_default(g_pmds_m.pmdsdocno,g_pmds_m.pmds006,g_pmds_m.pmds053,g_pmds_m.pmds041)
#                  RETURNING l_success
#                  
#                  IF NOT l_success THEN
#                     CALL s_transaction_end('N','0')
#                     CONTINUE DIALOG
#                  END IF
#                  
#                  LET l_flag = FALSE
#                   
#                  CALL apmt520_b_fill()
#               
#               ELSE
               
                  CALL s_transaction_end('Y','0') 

                  LET g_master_insert = TRUE
               
                  #LET p_cmd = 'u'
               
                  #單頭有採購單號開窗詢問是否自動產生單身
                  IF (g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20') AND l_cmd_t <> 'r' THEN #採購收貨單時
                     LET l_n = 0 
                     SELECT COUNT(1) INTO l_n FROM pmdt_t
                       WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                     IF l_n = 0 OR cl_null(l_n) THEN
                        CALL s_transaction_begin()
                        IF NOT cl_null(g_pmds_m.pmds006) THEN
                           IF cl_ask_confirm('apm-00384') THEN   #詢問是否自動產生單身
                              LET l_flag = FALSE
                              CALL apmt520_gen_pmdt()  #自動產生單身
                              CALL s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) RETURNING l_success
                              CALL apmt520_b_fill()
                              LET p_cmd = 'u'
                              LET g_rec_b = g_pmdt_d.getLength()
                              IF g_rec_b > 0 THEN
                                 CALL s_transaction_end('Y','0')
                                 LET g_flag2 = TRUE
                                 EXIT DIALOG
                              ELSE
                                 CALL s_transaction_end('N','0')
                                 LET g_flag2 = FALSE
                                 NEXT FIELD pmdt001
                              END IF
                           ELSE
                               LET l_flag = FALSE
                           END IF
                        END IF
                     END IF
                  END IF
                  
                  #單頭有採購收貨單號開窗詢問是否自動產生單身
                  IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN #採購收貨入庫單時
                     LET l_n = 0 
                     SELECT COUNT(1) INTO l_n FROM pmdt_t
                       WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                     IF l_n = 0 OR cl_null(l_n) THEN
                        CALL s_transaction_begin()
                        IF NOT cl_null(g_pmds_m.pmds006) THEN
                           IF cl_ask_confirm('apm-00579') THEN   #詢問是否自動產生單身
                              LET l_flag = FALSE
                              CALL apmt520_receipt_gen_pmdt()  #自動產生單身
                              #CALL s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) RETURNING l_success
                              CALL apmt520_b_fill()
                              LET p_cmd = 'u'
                              LET g_rec_b = g_pmdt_d.getLength()
                              IF g_rec_b > 0 THEN
                                 CALL s_transaction_end('Y','0')
                                 LET g_flag2 = TRUE
                                 EXIT DIALOG
                              ELSE
                                 CALL s_transaction_end('N','0')
                                 LET g_flag2 = FALSE
                                 NEXT FIELD pmdt028
                              END IF
                           ELSE
                               LET l_flag = FALSE
                           END IF
                        END IF
                     END IF
                  END IF
                  
#               END IF
#               #150617 earl mod e
               #150917-00001#3   2016/03/03  By earl mark e
                             
               #end add-point
               CALL s_transaction_end('Y','0') 
               
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL apmt520_detail_reproduce()
                  #因應特定程式需求, 重新刷新單身資料
                  CALL apmt520_b_fill()
                  CALL apmt520_b_fill2('0')
               END IF
               
               #add-point:單頭新增後 name="input.head.a_insert2"
               
               #end add-point
               
               LET g_master_insert = TRUE
               
               LET p_cmd = 'u'
            ELSE
               CALL s_transaction_begin()
            
               #add-point:單頭修改前 name="input.head.b_update"
               #160831-00016#1---s
               IF g_argv[1] MATCHES '[24]' THEN
                  #取稅率、單價含稅否
                  IF NOT cl_null(g_pmds_m.pmds033) THEN
                     LET l_oodb005 = ''
                     LET l_oodb006 = ''
                     LET l_oodb011 = ''
                     CALL s_tax_chk(g_site,g_pmds_m.pmds033)
                       RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                       
                     IF NOT l_success THEN
                        NEXT FIELD pmds033
                     ELSE                             
                        LET g_tax_app = l_oodb011                    
                     END IF           
                  END IF
                  
                  #單身有資料時，才詢問是否重設单身税别及税率？            
                  IF g_pmdt_d.getLength() > 0 AND (g_pmds_m.pmds033 <> g_pmds_m_t.pmds033 OR cl_null(g_pmds_m_t.pmds033)) THEN 
                     IF g_tax_app <> '1' THEN              
                        IF cl_ask_confirm('apm-00351') THEN
                           CALL apmt520_change_pmdt046()      #重設單身稅別
                        END IF       
                     ELSE
                       CALL apmt520_change_pmdt046()      #重設單身稅別
                     END IF                        
                     CALL apmt520_b_fill()                                 
                  END IF
               END IF
               #160831-00016#1---e                                             
               #end add-point
               
               #將遮罩欄位還原
               CALL apmt520_pmds_t_mask_restore('restore_mask_o')
               
               UPDATE pmds_t SET (pmdssite,pmdsdocno,pmdsdocdt,pmds001,pmds002,pmds003,pmdsstus,pmds006, 
                   pmds007,pmds008,pmds009,pmds010,pmds052,pmds028,pmds000,pmds100,pmds011,pmds014,pmds081, 
                   pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035,pmds036, 
                   pmds037,pmds038,pmds039,pmds040,pmds012,pmds101,pmds102,pmds103,pmds048,pmds047,pmds049, 
                   pmds053,pmds041,pmds043,pmds044,pmds046,pmds054,pmds055,pmds050,pmds057,pmds042,pmds058, 
                   pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt, 
                   pmdspstid,pmdspstdt) = (g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001, 
                   g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007, 
                   g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
                   g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081, 
                   g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024, 
                   g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
                   g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040, 
                   g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048, 
                   g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
                   g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050, 
                   g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp, 
                   g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt, 
                   g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt)
                WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmdsdocno_t
 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmds_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭修改中 name="input.head.m_update"
   
               #150917-00001#3   2016/03/03  By earl mark s
#               #150617 earl add s
#               #中斷續拋，直接由最終站將資料帶出
#               IF apmt520_break_continue(g_pmds_m.pmds053) THEN
#               
#                  CALL apmt520_default(g_pmds_m.pmdsdocno,g_pmds_m.pmds006,g_pmds_m.pmds053,g_pmds_m.pmds041)
#                  RETURNING l_success
#                  
#                  IF NOT l_success THEN
#                     CALL s_transaction_end('N','0')
#                     CONTINUE DIALOG
#                  END IF
#                  
#                  CALL apmt520_b_fill()
#               END IF
#               #150617 earl add e
               #150917-00001#3   2016/03/03  By earl mark e
               
               #add--2015/08/31 By shiun--(S)
               CALL s_apmt520_stus_abg1(g_pmds_m.pmdsdocno,'U')
                    RETURNING l_success
               IF NOT l_success THEN
                  CALL s_transaction_end('N','0')
                  NEXT FIELD CURRENT
               END IF
               #add--2015/08/31 By shiun--(E)
               #end add-point
               
               
               
               
               #將遮罩欄位進行遮蔽
               CALL apmt520_pmds_t_mask_restore('restore_mask_n')
               
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_pmds_m_t)
               LET g_log2 = util.JSON.stringify(g_pmds_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
               
               #add-point:單頭修改後 name="input.head.a_update"
                                                            
               #end add-point
            END IF
            
            LET g_master_commit = "Y"
            LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
            
      END INPUT
   
 
{</section>}
 
{<section id="apmt520.input.body" >}
   
      #Page1 預設值產生於此處
      INPUT ARRAY g_pmdt_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION s_lot_ins
            LET g_action_choice="s_lot_ins"
            IF cl_auth_chk_act("s_lot_ins") THEN
               
               #add-point:ON ACTION s_lot_ins name="input.detail_input.page1.s_lot_ins"
               IF NOT cl_null(g_pmds_m.pmdsdocno) AND
                  NOT cl_null(g_pmdt_d[l_ac].pmdtseq) AND
                  NOT cl_null(g_pmdt_d[l_ac].pmdt006) AND
                  NOT cl_null(g_pmdt_d[l_ac].pmdt019) AND
                  NOT cl_null(g_pmdt_d[l_ac].pmdt020) AND
                  NOT cl_null(g_pmds_m.pmds007) THEN
                  LET l_success = ''
                  LET l_amount = ''
                  #抓取料件據點進銷存相關資訊
                  LET l_imaf071 = NULL
                  LET l_imaf081 = NULL
                  SELECT imaf071,imaf081 INTO l_imaf071,l_imaf081 FROM imaf_t WHERE imafent = g_enterprise
                    AND imafsite = g_site AND imaf001 = g_pmdt_d[l_ac].pmdt006
                  #若料件設置要做製造批序號管理時，新增時維護完數量時自動開啟批序號維護作業維護相關資料
                  IF (l_imaf071 = '1' OR l_imaf081 = '1' OR l_imaf071 = '3' OR l_imaf081 = '3') AND g_pmdt_d[l_ac].pmdt020 > 0 AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                     #判斷據點參數若收貨單使用製造批序號時，則製造批序號頁簽可以維護(據點參數:S-BAS-0049)
                     IF g_argv[1] MATCHES '[1289]' THEN
                        IF cl_get_para(g_enterprise,g_site,'S-BAS-0049') = 'Y' THEN
                           CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'2',g_pmds_m.pmds007,'1','',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                               RETURNING l_success,l_amount
                        END IF
                     END IF
                     
                     #直接收貨入庫單
                     IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '20' THEN
                        CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'2',g_pmds_m.pmds007,'1','',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                            RETURNING l_success,l_amount
                     END IF

                     #驗退單、入庫單
                     #1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
                     #1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
                     #1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
                     IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                        SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = g_pmdt_d[l_ac].pmdt028
                        IF l_n > 0 THEN
                           #驗退、入庫、倉退單據，賦值來源單據的製造批序號資料inao_t
                           CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                           IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                              IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                                 IF NOT s_apmt520_ins_inao('1',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                 END IF
                              ELSE
                                 IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                 END IF
                              END IF
                           END IF
                           CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'1',g_prog,'','','','','0')
                               RETURNING l_success
                           CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success  
                           CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success   
                        ELSE
                           IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                              CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'2',g_pmds_m.pmds007,'1','',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                                 RETURNING l_success,l_amount
                           END IF
                        END IF
                     END IF
                     
                     #仓退单：若有指定收货单号：
                     #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
                     #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
                     #若没有指定收货单号则直接由库存档选取
                     IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                        IF NOT cl_null(g_pmds_m.pmds006) THEN
                           SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                              WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                AND pmdsent = g_enterprise 
                                AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                   OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                AND pmdsstus = 'S'
                           IF l_n > 0 THEN
                              CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              DECLARE sel_pmdt_cs4 CURSOR FOR
                                  SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                     WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno 
                                       AND pmdsent = g_enterprise 
                                       AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                          OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                       AND pmdsstus = 'S'
                              FOREACH sel_pmdt_cs4 INTO l_pmdtdocno,l_pmdtseq_1
                                 IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1) THEN
                                 END IF
                              END FOREACH
                              CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                 RETURNING l_success
                              CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                           END IF
                          
                        ELSE
                            CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                               RETURNING l_success
                        END IF
                     END IF
                  END IF
               END IF
               #END add-point
            END IF
 
 
 
 
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body.before_input2"
            
            #150917-00001#3   2016/03/03  By earl mark s
#            #150617 earl add s
#            #中斷續拋，直接由最終站將資料帶出
#            IF apmt520_break_continue(g_pmds_m.pmds053) THEN
#               EXIT DIALOG
#            END IF
#            #150617 earl add e
            #150917-00001#3   2016/03/03  By earl mark e
               
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_pmdt_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL apmt520_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
            END IF
            LET g_loc = 'm'
            LET g_rec_b = g_pmdt_d.getLength()
            #add-point:資料輸入前 name="input.d.before_input"
            #進入單身若單身沒有任何收貨項次且單頭沒有打採購單號時，自動呼叫apmt520_01子作業整批產生收貨單身資料
            #單頭有採購單號開窗詢問是否自動產生單身
            IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN #採購收貨單時
               LET l_n = 0 
               SELECT COUNT(1) INTO l_n FROM pmdt_t
                 WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
               IF l_n = 0 OR cl_null(l_n) THEN
                  CALL s_transaction_begin()
                  IF NOT cl_null(g_pmds_m.pmds006) THEN
                     IF l_flag THEN
                        IF cl_ask_confirm('apm-00384') THEN   #詢問是否自動產生單身
                           CALL apmt520_gen_pmdt()  #自動產生單身
                           CALL s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) RETURNING l_success
                           #161205-00025#3---s
                           #CALL apmt520_b_fill()
                           #LET g_rec_b = g_pmdt_d.getLength()
                           #IF g_rec_b > 0 THEN
                           LET l_n = 0 
                           SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                           IF l_n > 0 THEN
                           #161205-00025#e---e
                              CALL s_transaction_end('Y','0')
                              LET g_flag2 = TRUE
                              EXIT DIALOG
                           ELSE
                              CALL s_transaction_end('N','0')
                              LET g_flag2 = FALSE
                              NEXT FIELD pmdt001
                           END IF
                        END IF
                     END IF
                  ELSE
                     IF g_argv[1] MATCHES '[13]' OR g_argv[1] = '23' OR g_argv[1] = '24' THEN #採購收貨單時
                        IF apmt520_01(g_pmds_m.pmdsdocno) THEN
                           CALL s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) RETURNING l_success
                           #161205-00025#3---s
                           #CALL apmt520_b_fill()
                           #LET g_rec_b = g_pmdt_d.getLength()
                           #IF g_rec_b > 0 THEN
                           LET l_n = 0 
                           SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                           IF l_n > 0 THEN
                           #161205-00025#e---e
                              CALL s_transaction_end('Y','0')
                              LET g_flag2 = TRUE
                              EXIT DIALOG
                           ELSE
                              CALL s_transaction_end('N','0')
                              LET g_flag2 = FALSE
                              NEXT FIELD pmdt001
                           END IF
                        ELSE
                           CALL s_transaction_end('N','0')
                           LET g_flag2 = FALSE
                           NEXT FIELD pmdt001
                        END IF
                     END IF
                  END IF
               END IF
            END IF
            
            #單頭有採購收貨單號開窗詢問是否自動產生單身
            IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN #採購收貨入庫單時
               LET l_n = 0 
               SELECT COUNT(1) INTO l_n FROM pmdt_t
                 WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
               IF l_n = 0 OR cl_null(l_n) THEN
                  CALL s_transaction_begin()
                  IF NOT cl_null(g_pmds_m.pmds006) THEN
                     IF l_flag THEN
                        IF cl_ask_confirm('apm-00579') THEN   #詢問是否自動產生單身
                           CALL apmt520_receipt_gen_pmdt()  #自動產生單身
                           #CALL s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) RETURNING l_success
                           #161205-00025#3---s
                           #CALL apmt520_b_fill()
                           #LET g_rec_b = g_pmdt_d.getLength()
                           #IF g_rec_b > 0 THEN
                           LET l_n = 0 
                           SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                           IF l_n > 0 THEN
                           #161205-00025#e---e
                              CALL s_transaction_end('Y','0')
                              LET g_flag2 = TRUE
                              EXIT DIALOG
                           ELSE
                              CALL s_transaction_end('N','0')
                              LET g_flag2 = FALSE
                              NEXT FIELD pmdt028
                           END IF
                        END IF
                     END IF  
                  END IF
               END IF
            END IF
            CALL FGL_SET_ARR_CURR(g_detail_idx)   #add--2015/08/31 By shiun
            #end add-point
         
         BEFORE ROW
            #add-point:modify段before row2 name="input.body.before_row2"
            LET l_insert1 = FALSE   #add--2015/08/31 By shiun
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_detail_idx_list[1] = l_ac
            LET g_current_page = 1
            
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt520_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt520_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_pmdt_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_pmdt_d[l_ac].pmdtseq IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_pmdt_d_t.* = g_pmdt_d[l_ac].*  #BACKUP
               LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*  #BACKUP
               CALL apmt520_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body.after_set_entry_b"
               LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*   
               
               CALL apmt520_set_no_required_b()
               CALL apmt520_set_required_b()
               
               #end add-point  
               CALL apmt520_set_no_entry_b(l_cmd)
               IF NOT apmt520_lock_b("pmdt_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt520_bcl INTO g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt027, 
                      g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003, 
                      g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt083, 
                      g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009, 
                      g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt011,g_pmdt_d[l_ac].pmdt019, 
                      g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt008, 
                      g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt090,g_pmdt_d[l_ac].pmdt091, 
                      g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt038, 
                      g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt092,g_pmdt_d[l_ac].pmdt093, 
                      g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt041,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt016, 
                      g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt072, 
                      g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074,g_pmdt_d[l_ac].pmdt075,g_pmdt_d[l_ac].pmdt040, 
                      g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051,g_pmdt_d[l_ac].pmdt070,g_pmdt_d[l_ac].pmdt071, 
                      g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055, 
                      g_pmdt_d[l_ac].pmdt060,g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt043, 
                      g_pmdt_d[l_ac].pmdt048,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt045,g_pmdt_d[l_ac].pmdt049, 
                      g_pmdt_d[l_ac].pmdt050,g_pmdt_d[l_ac].pmdt084,g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089, 
                      g_pmdt_d[l_ac].pmdt088
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_pmdt_d_t.pmdtseq,":",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_pmdt_d_mask_o[l_ac].* =  g_pmdt_d[l_ac].*
                  CALL apmt520_pmdt_t_mask()
                  LET g_pmdt_d_mask_n[l_ac].* =  g_pmdt_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL apmt520_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body.before_row"
                                               
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
        
         BEFORE INSERT  
            
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmdt_d[l_ac].* TO NULL 
            INITIALIZE g_pmdt_d_t.* TO NULL 
            INITIALIZE g_pmdt_d_o.* TO NULL 
            #公用欄位給值(單身)
            
            #自定義預設值
                  LET g_pmdt_d[l_ac].pmdt005 = "1"
      LET g_pmdt_d[l_ac].pmdt025 = "1"
      LET g_pmdt_d[l_ac].pmdt020 = "0"
      LET g_pmdt_d[l_ac].pmdt022 = "0"
      LET g_pmdt_d[l_ac].pmdt024 = "0"
      LET g_pmdt_d[l_ac].pmdt090 = "0"
      LET g_pmdt_d[l_ac].pmdt091 = "0"
      LET g_pmdt_d[l_ac].pmdt036 = "0"
      LET g_pmdt_d[l_ac].pmdt038 = "0"
      LET g_pmdt_d[l_ac].pmdt039 = "0"
      LET g_pmdt_d[l_ac].pmdt047 = "0"
      LET g_pmdt_d[l_ac].pmdt092 = "0"
      LET g_pmdt_d[l_ac].pmdt093 = "0"
      LET g_pmdt_d[l_ac].pmdt026 = "N"
      LET g_pmdt_d[l_ac].pmdt041 = "N"
      LET g_pmdt_d[l_ac].pmdt062 = "N"
      LET g_pmdt_d[l_ac].pmdt071 = "0"
      LET g_pmdt_d[l_ac].pmdt053 = "0"
      LET g_pmdt_d[l_ac].pmdt054 = "0"
      LET g_pmdt_d[l_ac].pmdt055 = "0"
      LET g_pmdt_d[l_ac].pmdt061 = "0"
      LET g_pmdt_d[l_ac].pmdt048 = "0"
      LET g_pmdt_d[l_ac].pmdt044 = "0"
      LET g_pmdt_d[l_ac].pmdt084 = "N"
 
            #add-point:modify段before備份 name="input.body.insert.before_bak"
            CALL s_transaction_begin()
            
            #150901 earl add s
            #多角性質為"2:代採購、3:代採購指定供應商、4:統購統付、6:中間交易"
            #IF g_pmds_m.pmds014 MATCHES '[2346]' THEN
            #   LET g_pmdt_d[l_ac].pmdt084 = 'N'
            #ELSE
            #   LET g_pmdt_d[l_ac].pmdt084 = 'Y'
            #END IF
            
            #pmdt084給值一律給"Y"
            LET g_pmdt_d[l_ac].pmdt084 = 'Y'
            #採購性質是VMI時，pmdt084 給'N'
            IF g_argv[1] MATCHES '[67]' AND g_pmds_m.pmds011 = '3' THEN
               LET g_pmdt_d[l_ac].pmdt084 = 'N'
            END IF
            
#            #自立應付欄位是判斷多角時是不是要自立帳款，所以在一般的採購入庫/倉退與銷售出貨/銷退流程新增時,此欄位均預設為’Y’
#            IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
#               LET g_pmdt_d[l_ac].pmdt084 = 'Y'
#            ELSE
#               LET g_pmdt_d[l_ac].pmdt084 = 'N'
#            END IF
            #150901 earl add e
            
            LET g_pmdt_d[l_ac].pmdt089 = ''
            #end add-point
            LET g_pmdt_d_t.* = g_pmdt_d[l_ac].*     #新輸入資料
            LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL apmt520_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body.insert.after_set_entry_b"
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
                                                   
            #end add-point
            CALL apmt520_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_pmdt_d[li_reproduce_target].* = g_pmdt_d[li_reproduce].*
 
               LET g_pmdt_d[li_reproduce_target].pmdtseq = NULL
 
            END IF
            
 
            #add-point:modify段before insert name="input.body.before_insert"
            SELECT MAX(pmdtseq)+1 INTO g_pmdt_d[l_ac].pmdtseq FROM pmdt_t
              WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
            IF cl_null(g_pmdt_d[l_ac].pmdtseq) OR g_pmdt_d[l_ac].pmdtseq = 0 THEN
               LET g_pmdt_d[l_ac].pmdtseq = 1
            END IF
            
            LET g_pmdt_d[l_ac].pmdtsite = g_site
            
            #單頭採購單不為空時，單身預設單頭的採購單號
            IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
               IF NOT cl_null(g_pmds_m.pmds006) THEN
                  LET g_pmdt_d[l_ac].pmdt001 = g_pmds_m.pmds006
               END IF
            END IF
            #驗退、入庫、倉退時，收貨來源單號預設單頭的來源單號
            IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
               #單頭收貨單不為空時，單身預設單頭的收貨單號
               IF NOT cl_null(g_pmds_m.pmds006) THEN
                  LET g_pmdt_d[l_ac].pmdt027 = g_pmds_m.pmds006
               END IF
            END IF
            
            LET g_pmdt_d[l_ac].pmdt053 = 0
            LET g_pmdt_d[l_ac].pmdt054 = 0
            LET g_pmdt_d[l_ac].pmdt055 = 0
            LET g_pmdt_d[l_ac].pmdt052 = '1'  #狀態碼 '1:一般'
            
            #倉退單，當倉退方式為'4:'價格折讓'時，數量欄位預設為0且不可以維護
            IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15') AND g_pmds_m.pmds100 = '4' THEN
               LET g_pmdt_d[l_ac].pmdt020 = 0
            END IF
            
            #無採購單來源時
            IF g_argv[1] MATCHES '[24]' THEN
               LET g_pmdt_d[l_ac].pmdt046 = g_pmds_m.pmds033
               LET g_pmdt_d[l_ac].pmdt037 = g_pmds_m.pmds033
               CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
            END IF
            
            #若单据别对应的参数“是否依客户/厂商做库存管理”='Y'，则将供应商编号带入到此栏位
            IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' THEN
               CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
               IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0090') = 'Y' THEN
                  LET g_pmdt_d[l_ac].pmdt063 = g_pmds_m.pmds007
               END IF
            END IF
            #dorislai-20150824-add----(S)
            #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
            IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
               #預設欄位
               CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
               IF l_success THEN
                  CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016
                  #應用參數
                  IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING g_pmdt_d[l_ac].pmdt016
                  END IF
               END IF          
            END IF
            #dorislai-20150824-add----(E)
            LET g_pmdt_d_t.* = g_pmdt_d[l_ac].*     #新輸入資料
            LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*     #新輸入資料
            #end add-point  
  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身新增 name="input.body.b_a_insert"
                                                
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM pmdt_t 
             WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
 
               AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身新增前 name="input.body.b_insert"
               #160617-00005#2---s--
               IF g_argv[1] MATCHES '[1234689]' OR g_argv[1] = '12' OR g_argv[1] = '13'  OR g_argv[1] = '20' THEN
                  LET l_imaf061 = ''
                  LET l_imaf062 = ''
                  LET l_imaf063 = ''
                  SELECT imaf061,imaf062,imaf063 INTO l_imaf061,l_imaf062,l_imaf063  
                    FROM imaf_t WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdt_d[l_ac].pmdt006
               
                  IF cl_null(g_pmdt_d[l_ac].pmdt018) AND l_imaf061 = '1' AND l_imaf062 = 'Y' AND (NOT cl_null(l_imaf063)) THEN
                     CALL s_aooi390_gen_1('6',l_imaf063) RETURNING l_success,g_pmdt_d[l_ac].pmdt018,l_oofg_return
                     IF NOT l_success THEN
                        LET g_pmdt_d[l_ac].pmdt018 = ''
                     ELSE
                        CALL s_aooi390_get_auto_no('6',g_pmdt_d[l_ac].pmdt018) RETURNING l_success,g_pmdt_d[l_ac].pmdt018
                        CALL s_aooi390_oofi_upd('6',g_pmdt_d[l_ac].pmdt018) RETURNING l_success
                     END IF
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt018
               END IF
               #160617-00005#2---e--                                             
               #end add-point
            
               #同步新增到同層的table
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmds_m.pmdsdocno
               LET gs_keys[2] = g_pmdt_d[g_detail_idx].pmdtseq
               CALL apmt520_insert_b('pmdt_t',gs_keys,"'1'")
                           
               #add-point:單身新增後 name="input.body.a_insert"
               #161031-00025#15 add(s)
               IF NOT cl_null(g_pmdt_d[l_ac].ooff013) THEN
                  CALL s_aooi360_gen('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'','','','','','','','1',g_pmdt_d[l_ac].ooff013) RETURNING l_success
               END IF
               #161031-00025#15 add(e)                           
               #end add-point
            ELSE    
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               INITIALIZE g_pmdt_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL apmt520_b_fill()
               #資料多語言用-增/改
               
               #add-point:input段-after_insert name="input.body.a_insert2"
               IF NOT apmt520_ins_pmdu() THEN
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               END IF  
               
               #無採購單來源時
               IF g_argv[1] MATCHES '[24]' THEN
                  LET l_pmdtseq = NULL
               
                  INITIALIZE l_pmdt.* TO NULL               
                  SELECT pmdtent,pmdtsite,pmdtdocno,pmdtseq,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081,pmdt082,pmdt083, 
                         pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021,pmdt022,pmdt008, 
                         pmdt023,pmdt024,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt041,pmdt062,pmdt016, 
                         pmdt017,pmdt018,pmdt063,pmdt040,pmdt052,pmdt051,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061, 
                         pmdt042,pmdt043,pmdt044,pmdt045,pmdt084,
                         pmdt072,pmdt073,pmdt074
                    INTO l_pmdt.pmdtent,l_pmdt.pmdtsite,l_pmdt.pmdtdocno,l_pmdt.pmdtseq,l_pmdt.pmdt001,l_pmdt.pmdt002,
                         l_pmdt.pmdt003,l_pmdt.pmdt004,l_pmdt.pmdt081,l_pmdt.pmdt082,l_pmdt.pmdt083, 
                         l_pmdt.pmdt005,l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt009,l_pmdt.pmdt010,l_pmdt.pmdt025,
                         l_pmdt.pmdt011,l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021,l_pmdt.pmdt022,l_pmdt.pmdt008, 
                         l_pmdt.pmdt023,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046,l_pmdt.pmdt037,l_pmdt.pmdt038,
                         l_pmdt.pmdt039,l_pmdt.pmdt047,l_pmdt.pmdt026,l_pmdt.pmdt041,l_pmdt.pmdt062,l_pmdt.pmdt016, 
                         l_pmdt.pmdt017,l_pmdt.pmdt018,l_pmdt.pmdt063,l_pmdt.pmdt040,l_pmdt.pmdt052,l_pmdt.pmdt051,
                         l_pmdt.pmdt059,l_pmdt.pmdt053,l_pmdt.pmdt054,l_pmdt.pmdt055,l_pmdt.pmdt060,l_pmdt.pmdt061, 
                         l_pmdt.pmdt042,l_pmdt.pmdt043,l_pmdt.pmdt044,l_pmdt.pmdt045,l_pmdt.pmdt084,
                         l_pmdt.pmdt072,l_pmdt.pmdt073,l_pmdt.pmdt074
                    FROM pmdt_t 
                   WHERE pmdtent = g_enterprise
                     AND pmdtdocno = g_pmds_m.pmdsdocno
                     AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
                  
                  IF l_inam.getLength() > 1 THEN  #因為第一筆資料已呈現在畫面並寫入DB, 從第二筆開始處理           
                     IF cl_null(l_pmdtseq) THEN   
                        SELECT MAX(pmdtseq) INTO l_pmdtseq
                          FROM pmdt_t
                         WHERE pmdtent   = g_enterprise
                           AND pmdtdocno = g_pmds_m.pmdsdocno                     
                     END IF 
                    
                     LET l_ac_t = l_ac
                     
                     FOR l_i = 2 TO l_inam.getLength() 
                        IF cl_null(l_pmdtseq) OR l_pmdtseq = 0 THEN
                           LET l_pmdtseq = 1
                        ELSE
                           LET l_pmdtseq = l_pmdtseq + 1             
                        END IF 
                        
                        LET l_pmdt.pmdtseq = l_pmdtseq
                        LET l_pmdt.pmdt007 = l_inam[l_i].inam002
                        LET l_pmdt.pmdt020 = l_inam[l_i].inam004
                        
                        #計算參考數量
                        IF (NOT cl_null(l_pmdt.pmdt021)) AND (NOT cl_null(l_pmdt.pmdt006)) AND (NOT cl_null(l_pmdt.pmdt019)) THEN
                           #CALL s_aimi190_get_convert(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt021) RETURNING l_success,l_rate
                           #LET l_pmdt.pmdt022 = l_pmdt.pmdt020 * l_rate
                           CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt021,l_pmdt.pmdt020)
                                         RETURNING l_success,l_pmdt.pmdt022
                        END IF
                        
                        #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                        #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                        IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(l_pmdt.pmdt023)) AND (NOT cl_null(l_pmdt.pmdt006)) AND (NOT cl_null(l_pmdt.pmdt019)) AND apmt520_get_imaf144(l_pmdt.pmdt006) THEN  #體參數使用採購計價單位  
                           #CALL s_aimi190_get_convert(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023) RETURNING l_success,l_rate
                           #LET l_pmdt.pmdt024 = l_pmdt.pmdt020 * l_rate
                           CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
                                         RETURNING l_success,l_pmdt.pmdt024
                        ELSE
                           LET l_pmdt.pmdt023 = l_pmdt.pmdt019
                           LET l_pmdt.pmdt024 = l_pmdt.pmdt020            
                        END IF

                        IF cl_null(l_pmdt.pmdt023) OR cl_null(l_pmdt.pmdt024) THEN
                           LET l_pmdt.pmdt023 = l_pmdt.pmdt019
                           LET l_pmdt.pmdt024 = l_pmdt.pmdt020  
                        END IF
                        
                        
                        IF (NOT cl_null(g_pmds_m.pmds039)) AND (NOT cl_null(g_pmds_m.pmds007)) AND (NOT cl_null(l_pmdt.pmdt006)) AND
                           (NOT cl_null(g_pmds_m.pmds037)) AND (NOT cl_null(l_pmdt.pmdt046)) AND (NOT cl_null(g_pmds_m.pmds031)) AND 
                           (NOT cl_null(g_pmds_m.pmds032)) AND (NOT cl_null(g_pmds_m.pmds012)) AND (NOT cl_null(g_pmds_m.pmdsdocno)) AND
                           (NOT cl_null(g_pmds_m.pmdsdocdt)) AND (NOT cl_null(l_pmdt.pmdt023)) AND (NOT cl_null(l_pmdt.pmdt024)) THEN
                         
                           CALL s_purchase_price_get(g_pmds_m.pmds039,g_pmds_m.pmds007,l_pmdt.pmdt006,l_pmdt.pmdt007,
                                                     g_pmds_m.pmds037,l_pmdt.pmdt046,g_pmds_m.pmds031,g_pmds_m.pmds032,
                                                     g_pmds_m.pmds012,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,l_pmdt.pmdt023,
                                                     l_pmdt.pmdt024,g_site,g_pmds_m.pmds048,'1',l_pmdt.pmdt009,
                                                     l_pmdt.pmdt010)          
                                 RETURNING l_pmdt.pmdt042,l_pmdt.pmdt044,l_pmdt.pmdt043,l_pmdt.pmdt048
                           
                           #呼叫幣別取位應用元件對單價作取位(依單頭幣別做取位基準)
                           CALL s_curr_round(g_site,g_pmds_m.pmds037,l_pmdt.pmdt044,'1') RETURNING l_pmdt.pmdt044
                           
                           LET l_pmdt.pmdt036 = l_pmdt.pmdt044
                           LET l_pmdt.pmdt045 = 0
                           
                        END IF
                 
                        #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
                        CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq,l_pmdt.pmdt001,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046)
                                RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039 
                        
                        
                        INSERT INTO pmdt_t 
                              (pmdtent,pmdtsite,pmdtdocno,pmdtseq,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081,pmdt082,pmdt083, 
                               pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021,pmdt022,pmdt008, 
                               pmdt023,pmdt024,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt041,pmdt062,pmdt016, 
                               pmdt017,pmdt018,pmdt063,pmdt040,pmdt052,pmdt051,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061, 
                               pmdt042,pmdt043,pmdt044,pmdt045,pmdt048,pmdt084,pmdt088,pmdt089,
                               pmdt072,pmdt073,pmdt074)
                             VALUES(l_pmdt.pmdtent,l_pmdt.pmdtsite,l_pmdt.pmdtdocno,l_pmdt.pmdtseq,l_pmdt.pmdt001,l_pmdt.pmdt002,
                                    l_pmdt.pmdt003,l_pmdt.pmdt004,l_pmdt.pmdt081,l_pmdt.pmdt082,l_pmdt.pmdt083, 
                                    l_pmdt.pmdt005,l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt009,l_pmdt.pmdt010,l_pmdt.pmdt025,
                                    l_pmdt.pmdt011,l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021,l_pmdt.pmdt022,l_pmdt.pmdt008, 
                                    l_pmdt.pmdt023,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046,l_pmdt.pmdt037,l_pmdt.pmdt038,
                                    l_pmdt.pmdt039,l_pmdt.pmdt047,l_pmdt.pmdt026,l_pmdt.pmdt041,l_pmdt.pmdt062,l_pmdt.pmdt016, 
                                    l_pmdt.pmdt017,l_pmdt.pmdt018,l_pmdt.pmdt063,l_pmdt.pmdt040,l_pmdt.pmdt052,l_pmdt.pmdt051,
                                    l_pmdt.pmdt059,l_pmdt.pmdt053,l_pmdt.pmdt054,l_pmdt.pmdt055,l_pmdt.pmdt060,l_pmdt.pmdt061, 
                                    l_pmdt.pmdt042,l_pmdt.pmdt043,l_pmdt.pmdt044,l_pmdt.pmdt045,l_pmdt.pmdt048,l_pmdt.pmdt084,l_pmdt.pmdt088,l_pmdt.pmdt089,
                                    l_pmdt.pmdt072,l_pmdt.pmdt073,l_pmdt.pmdt074) 
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "pmdt_t"
                           LET g_errparam.popup = FALSE
                           CALL cl_err()
                 
                        ELSE
                           LET l_ac = l_ac + 1
                           
                           SELECT pmdtsite,pmdtseq,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081,pmdt082,pmdt083, 
                                  pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021,pmdt022,pmdt008, 
                                  pmdt023,pmdt024,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt041,pmdt062,pmdt016, 
                                  pmdt017,pmdt018,pmdt063,pmdt040,pmdt052,pmdt051,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061, 
                                  pmdt042,pmdt043,pmdt044,pmdt045,pmdt048,
                                  pmdt072,pmdt073,pmdt074
                             INTO g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002, 
                                  g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082, 
                                  g_pmdt_d[l_ac].pmdt083,g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007, 
                                  g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt011, 
                                  g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022, 
                                  g_pmdt_d[l_ac].pmdt008,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036, 
                                  g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039, 
                                  g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt041,g_pmdt_d[l_ac].pmdt062, 
                                  g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063, 
                                  g_pmdt_d[l_ac].pmdt040,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051,g_pmdt_d[l_ac].pmdt059, 
                                  g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt060, 
                                  g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt044, 
                                  g_pmdt_d[l_ac].pmdt045,g_pmdt_d[l_ac].pmdt048,
                                  g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074
                             FROM pmdt_t 
                            WHERE pmdtent = g_enterprise
                              AND pmdtdocno = g_pmds_m.pmdsdocno
                              AND pmdtseq = l_pmdt.pmdtseq
                              
                           LET l_pmdtseq = g_pmdt_d_t.pmdtseq
                           LET g_pmdt_d_t.pmdtseq = ''
                           CALL apmt520_ins_pmdu() RETURNING l_success
                           LET g_pmdt_d_t.pmdtseq = l_pmdtseq
                        END IF
                     END FOR
                     
                     LET l_ac = l_ac_t
                     
                     CALL apmt520_b_fill()
                     LET g_rec_b = l_inam.getLength() - 1
                  END IF
               END IF
               
               #產生收貨原始需求分配明細資料
               IF NOT s_apmt520_gen_pmdv(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq) THEN
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               END IF  

               #130909-00003#58--add--begin---  
               #輸入的採購單號、項次對應到子件特性是"拆件主件"，在輸入完資料後，開啟子程式畫面apmt521_01，
               #選擇要收貨的料件，並依選擇的元件產生子件特性為11.拆件元件
               IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' THEN
                  IF g_pmdt_d[l_ac].pmdt005 ='10' THEN
                     CALL apmt520_04(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
                     CALL apmt520_b_fill()
                  END IF
               END IF
               #130909-00003#58--add--end---  
               
               
               #以入庫單為例
               #在打入庫單時，若料號走QC，則根據QC單的製造批序號帶入入庫單，且同時回寫對應QC單的製造批序號中的已入庫量欄位
               #             若不走QC，則根據來源收貨單的製造批序號帶入入庫單，且同事回寫收貨單的製造批序號的已入庫量欄位
               #所以入庫單在刪除，或作廢時，也需將入庫單來源單據中的已入庫量欄位更新
               IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d[l_ac].pmdtseq
                  IF l_n > 0 THEN
                     IF NOT s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') THEN
                        CALL s_transaction_end('N','0')                    
                        CANCEL INSERT
                     END IF
                  END IF
               END IF
               #add--2015/08/31 By shiun--(S)
               LET l_insert1 = TRUE
               CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) 
                    RETURNING l_success,l_slip
               IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
                  IF cl_null(g_pmdt_d[l_ac].pmdt075) THEN
                     NEXT FIELD pmdt075
                  ELSE
                     CALL s_apmt520_stus_abg(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'I')
                          RETURNING l_success,l_errno
                     IF NOT l_success THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = l_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        
                        CALL s_transaction_end('N','0')
                     END IF
                     LET l_insert1 = FALSE
                  END IF
               END IF
               #add--2015/08/31 By shiun--(E)
               
               #160617-00005#2---s--
               IF g_argv[1] MATCHES '[1234689]' OR g_argv[1] = '12' OR g_argv[1] = '13'  OR g_argv[1] = '20' THEN
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                    UPDATE pmdu_t SET pmdu008 = g_pmdt_d[l_ac].pmdt018
                                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d_t.pmdtseq
                  END IF
               END IF
               #160617-00005#2---e-- 
               
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身刪除後(=d) name="input.body.after_delete_d"
               #增加一下刪除段落，用於一下操作情況：
               #單身錄入收貨項次後，帶出收貨資料到單身，此時修改數量欄位，或修改多庫儲批否欄位，會彈出製造批序號的開窗或多庫儲批的開窗挑選資料，此時點確定時，製造批序號或多庫儲批資料已經寫入相應的表中
               #而這時，在單身錄入狀態下，再點刪除，此時before delete 會走到此段落，所以需再手動將已經插入table的資料刪除
               
               
               #以入庫單為例
               #在打入庫單時，若料號走QC，則根據QC單的製造批序號帶入入庫單，且同時回寫對應QC單的製造批序號中的已入庫量欄位
               #             若不走QC，則根據來源收貨單的製造批序號帶入入庫單，且同事回寫收貨單的製造批序號的已入庫量欄位
               #所以入庫單在刪除，或作廢時，也需將入庫單來源單據中的已入庫量欄位更新
               IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d[l_ac].pmdtseq
                  IF l_n > 0 THEN
                     IF NOT s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') THEN
                        CALL s_transaction_end('N','0')
                        CANCEL DELETE
                     END IF
                  END IF
               END IF     
               #刪除inao製造批序號異動明細檔
               DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d[l_ac].pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "DELETE inao_t"
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = FALSE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               END IF      
               
               DELETE FROM pmdu_t
                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND
                       pmduseq = g_pmdt_d[l_ac].pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmdu_t" 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE 
               END IF               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身刪除前 name="input.body.b_delete"
               #判斷資料來源為"EC"時，單頭不可刪除
               IF g_argv[1] MATCHES '[1234]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
                  IF g_pmds_m.pmds057 = '2' THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = g_pmds_m.pmdsdocno
                     LET g_errparam.code   = 'axm-00712'
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     CANCEL DELETE
                  END IF
               END IF
   
               
               #以入庫單為例
               #在打入庫單時，若料號走QC，則根據QC單的製造批序號帶入入庫單，且同時回寫對應QC單的製造批序號中的已入庫量欄位
               #             若不走QC，則根據來源收貨單的製造批序號帶入入庫單，且同事回寫收貨單的製造批序號的已入庫量欄位
               #所以入庫單在刪除，或作廢時，也需將入庫單來源單據中的已入庫量欄位更新
               IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d_t.pmdtseq
                  IF l_n > 0 THEN
                     IF NOT s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d_t.pmdtseq,'') THEN
                        CALL s_transaction_end('N','0')
                        CANCEL DELETE
                     END IF
                  END IF
               END IF                                             
               #add--2015/08/31 By shiun--(S)
               CALL s_apmt520_stus_abg(g_pmds_m.pmdsdocno,g_pmdt_d_t.pmdtseq,'D')
                    RETURNING l_success,l_errno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = l_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  CLOSE apmt520_bcl
                  CANCEL DELETE
               END IF
               #add--2015/08/31 By shiun--(E)
               #end add-point 
               
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_pmds_m.pmdsdocno
 
               LET gs_keys[gs_keys.getLength()+1] = g_pmdt_d_t.pmdtseq
 
            
               #刪除同層單身
               IF NOT apmt520_delete_b('pmdt_t',gs_keys,"'1'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt520_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT apmt520_key_delete_b(gs_keys,'pmdt_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt520_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身刪除中 name="input.body.m_delete"
               DELETE FROM pmdu_t
                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND
                       pmduseq = g_pmdt_d_t.pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmdu_t" 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE 
               END IF
               DELETE FROM pmdv_t
                 WHERE pmdvent = g_enterprise AND pmdvdocno = g_pmds_m.pmdsdocno AND
                       pmdvseq = g_pmdt_d_t.pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmdv_t" 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE 
               END IF
                
               #刪除交易稅明細檔
               DELETE FROM xrcd_t
                WHERE xrcdent = g_enterprise
                  AND xrcddocno = g_pmds_m.pmdsdocno
                  AND xrcdseq = g_pmdt_d_t.pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "DELETE xrcd_t"
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               END IF      
               
               #刪除inao製造批序號異動明細檔
               DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d_t.pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "DELETE inao_t"
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = FALSE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               END IF
               #161031-00025#15 add(s)
               CALL s_aooi360_del('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d_t.pmdtseq,'','','','','','','','1') RETURNING l_success
               #161031-00025#15 add(e)
               #end add-point 
               
               CALL s_transaction_end('Y','0')
               CLOSE apmt520_bcl
            
               LET g_rec_b = g_rec_b-1
               #add-point:單身刪除後 name="input.body.a_delete"
               
               #end add-point
               LET l_count = g_pmdt_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body.after_delete"
                                                
               #end add-point
            END IF
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_pmdt_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtsite
            #add-point:BEFORE FIELD pmdtsite name="input.b.page1.pmdtsite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtsite
            
            #add-point:AFTER FIELD pmdtsite name="input.a.page1.pmdtsite"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdtsite
            #add-point:ON CHANGE pmdtsite name="input.g.page1.pmdtsite"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtseq
            #add-point:BEFORE FIELD pmdtseq name="input.b.page1.pmdtseq"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtseq
            
            #add-point:AFTER FIELD pmdtseq name="input.a.page1.pmdtseq"
                                                            #此段落由子樣板a05產生
            IF  g_pmds_m.pmdsdocno IS NOT NULL AND g_pmdt_d[l_ac].pmdtseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmds_m.pmdsdocno != g_pmdsdocno_t OR g_pmdt_d[l_ac].pmdtseq != g_pmdt_d_t.pmdtseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM pmdt_t WHERE "||"pmdtent = '" ||g_enterprise|| "' AND "||"pmdtdocno = '"||g_pmds_m.pmdsdocno ||"' AND "|| "pmdtseq = '"||g_pmdt_d[l_ac].pmdtseq ||"'",'std-00004',0) THEN 
                     LET g_pmdt_d[l_ac].pmdtseq = g_pmdt_d_t.pmdtseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdtseq
            #add-point:ON CHANGE pmdtseq name="input.g.page1.pmdtseq"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt027
            #add-point:BEFORE FIELD pmdt027 name="input.b.page1.pmdt027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt027
            
            #add-point:AFTER FIELD pmdt027 name="input.a.page1.pmdt027"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt027
            #add-point:ON CHANGE pmdt027 name="input.g.page1.pmdt027"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt028
            #add-point:BEFORE FIELD pmdt028 name="input.b.page1.pmdt028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt028
            
            #add-point:AFTER FIELD pmdt028 name="input.a.page1.pmdt028"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt028)  THEN
               IF g_pmdt_d[l_ac].pmdt028 != g_pmdt_d_o.pmdt028 OR cl_null(g_pmdt_d_o.pmdt028) THEN 
                  IF NOT apmt520_pmdt028_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt028 = g_pmdt_d_o.pmdt028
                     NEXT FIELD pmdt028
                  END IF
                  
                  #入庫、驗退對應的收貨項次存在多筆QC單資料時，自動新增QC資料
                  LET l_n = 0 
                  SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
                  IF l_cmd = 'a' AND l_n = 0 THEN
                     IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN 
                        LET l_n = 0 
                        IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN 
                           SELECT COUNT(qcbcseq) INTO l_n FROM qcbc_t,qcba_t 
                              WHERE qcbcent = g_enterprise AND qcbcent  = qcbaent
                                AND qcbcsite  = g_site AND qcbcsite = qcbasite
                                AND qcbcdocno = qcbadocno 
                                AND qcba001   = g_pmds_m.pmds006
                                AND qcba002   = g_pmdt_d[l_ac].pmdt028
                                AND qcbastus  = 'Y' AND qcbc012 = '4'
                        END IF
                        IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN 
                           SELECT COUNT(qcbcseq) INTO l_n FROM qcbc_t,qcba_t 
                              WHERE qcbcent = g_enterprise AND qcbcent  = qcbaent
                                AND qcbcsite  = g_site AND qcbcsite = qcbasite
                                AND qcbcdocno = qcbadocno 
                                AND qcba001   = g_pmds_m.pmds006
                                AND qcba002   = g_pmdt_d[l_ac].pmdt028
                                AND qcbastus  = 'Y' AND qcbc012 <> '4'
                        END IF
                        IF l_n > 1 THEN
                           IF NOT cl_null(g_pmds_m.pmds006) THEN
                              IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN 
                                 CALL s_apmt520_gen_pmdt('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdt028,'1') RETURNING l_success
                              END IF
                              IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN 
                                 CALL s_apmt520_gen_pmdt('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdt028,'1') RETURNING l_success
                              END IF
                              #CALL apmt520_b_fill()
                              #LET g_rec_b = g_pmdt_d.getLength()
                              #IF g_rec_b > 0 THEN
                              IF l_success THEN
                                 CALL s_transaction_end('Y','0')
                                 LET g_flag2 = TRUE
                                 EXIT DIALOG
                              ELSE
                                 CALL s_transaction_end('N','0')
                                 LET g_flag2 = FALSE
                                 NEXT FIELD pmdt028
                              END IF
                           END IF
                        END IF
                     END IF
                  END IF
                  CALL apmt520_pmdt028_desc()
               END IF
            END IF
            
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            LET g_pmdt_d_o.pmdt028 = g_pmdt_d[l_ac].pmdt028
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt028
            #add-point:ON CHANGE pmdt028 name="input.g.page1.pmdt028"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt001
            #add-point:BEFORE FIELD pmdt001 name="input.b.page1.pmdt001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt001
            
            #add-point:AFTER FIELD pmdt001 name="input.a.page1.pmdt001"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt001) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdt_d[l_ac].pmdt001 != g_pmdt_d_o.pmdt001 OR cl_null(g_pmdt_d_o.pmdt001))) THEN 
                  IF NOT apmt520_pmdt001_chk(g_pmdt_d[l_ac].pmdt001) THEN
                     LET g_pmdt_d[l_ac].pmdt001 = g_pmdt_d_o.pmdt001
                     NEXT FIELD pmdt001
                  END IF

                  #151229-00009#1 --- add start ---
                  LET l_pmdl005 = ''
                  LET l_pmdl008 = '' #160413-00038#1 add
                  SELECT pmdl005,pmdl008 INTO l_pmdl005,l_pmdl008  #160413-00038#1 add pmdl008
                    FROM pmdl_t
                   WHERE pmdlent = g_enterprise
                     AND pmdldocno = g_pmdt_d[l_ac].pmdt001
                  
                  IF l_pmdl005 = '2' OR l_pmdl005 = '5' THEN  #委外採購 or 重複性委外採購
                     #160413-00038#1--add---begin---
                     #工单备料单身都是倒扣料时，无需考虑发料套数
                     LET l_n = 0 
                     SELECT COUNT(1) INTO l_n FROM sfba_t WHERE sfbaent = g_enterprise AND sfbadocno = l_pmdl008 AND sfba009 = 'N'
                                                            AND sfba015 = 0    #161019-00046#1
                     IF l_n > 0 THEN
                     #160413-00038#1--add---end----
                        LET l_sfaa049 = 0
                        SELECT sfaa_t.sfaa049 INTO l_sfaa049
                          FROM pmdl_t,sfaa_t
                         WHERE pmdlent = sfaaent
                           AND pmdl008 = sfaadocno
                           AND pmdl005 = l_pmdl005
                           AND pmdl007 = '4'   #工單
                           AND pmdlent = g_enterprise
                           AND pmdldocno = g_pmdt_d[l_ac].pmdt001 
                        IF cl_null(l_sfaa049) THEN LET l_sfaa049 = 0 END IF
                        IF l_sfaa049 = 0 THEN   #發出量為0，尚未發出，無法收貨
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'apm-01058'
                           LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001 
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           NEXT FIELD pmdt001
                        END IF
                     END IF  #160413-00038#1 add
                  END IF     
                  #151229-00009#1 --- add end   ---

                  #若採購項次、採購項序、採購分批序均有值時，需撿核該採購單是否有對應的交期明細資料
                  IF NOT apmt520_pmdo_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt001 = g_pmdt_d_o.pmdt001
                     NEXT FIELD pmdt001
                  END IF
                  
                  CALL apmt520_pmdt001_desc()
                  
               END IF
            END IF
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
               
            CALL apmt520_set_no_entry_b(l_cmd)
            
            LET g_pmdt_d_o.pmdt001 = g_pmdt_d[l_ac].pmdt001            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt001
            #add-point:ON CHANGE pmdt001 name="input.g.page1.pmdt001"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt002
            #add-point:BEFORE FIELD pmdt002 name="input.b.page1.pmdt002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt002
            
            #add-point:AFTER FIELD pmdt002 name="input.a.page1.pmdt002"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt002)  THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdt_d[l_ac].pmdt002 != g_pmdt_d_o.pmdt002 OR cl_null(g_pmdt_d_o.pmdt002))) THEN 
                  IF NOT apmt520_pmdt002_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt002 = g_pmdt_d_o.pmdt002
                     NEXT FIELD pmdt002
                  END IF
                  
                  #有採購單號為來源單據
                  IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
                     #若採購項次、採購項序、採購分批序均有值時，需撿核該採購單是否有對應的交期明細資料
                     IF NOT apmt520_pmdo_chk() THEN
                        LET g_pmdt_d[l_ac].pmdt002 = g_pmdt_d_o.pmdt002
                        NEXT FIELD pmdt002
                     END IF
                     
                     #是否存在送貨據點=g_site的採購資料
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM pmdn_t 
                        WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdt_d[l_ac].pmdt001 AND pmdnseq = g_pmdt_d[l_ac].pmdt002 AND pmdnunit = g_site
                     IF l_n = 0 OR cl_null(l_n) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'apm-00375'
                        LET g_errparam.extend = g_pmdt_d[l_ac].pmdt002
                        LET g_errparam.popup = TRUE
                        CALL cl_err()

                        LET g_pmdt_d[l_ac].pmdt002 = g_pmdt_d_o.pmdt002
                        NEXT FIELD pmdt002
                     END IF
                     
                     #CALL apmt520_pmdt001_desc()
                     
                     #若輸入的採購單號+採購項次的pmdo_t只有對應一個採購項序時，則自動將採購項序預設到收貨單身[C:採購項次]上
                     #若輸入的採購單號+採購項次的pmdo_t只有對應一個分批序時，則自動將分批序預設到收貨單身[C:分批序]上
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001 AND pmdoseq = g_pmdt_d[l_ac].pmdt002
                     IF l_n = 1 THEN
                        SELECT pmdoseq1,pmdoseq2 INTO g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004 FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001 AND pmdoseq = g_pmdt_d[l_ac].pmdt002                   
                        DISPLAY BY NAME g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004
                        
                        LET g_pmdt_d_o.pmdt003 = g_pmdt_d[l_ac].pmdt003 
                        LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004 
                     END IF
                     
                     CALL apmt520_pmdt001_desc()
                     
                  END IF

               END IF
            END IF
            
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            LET g_pmdt_d_o.pmdt002 = g_pmdt_d[l_ac].pmdt002          
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt002
            #add-point:ON CHANGE pmdt002 name="input.g.page1.pmdt002"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt003
            #add-point:BEFORE FIELD pmdt003 name="input.b.page1.pmdt003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt003
            
            #add-point:AFTER FIELD pmdt003 name="input.a.page1.pmdt003"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt003) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdt_d[l_ac].pmdt003 != g_pmdt_d_o.pmdt003 OR cl_null(g_pmdt_d_o.pmdt003))) THEN 
                  #輸入的採購單號+採購項次+採購項序必須存在pmdo_t中
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001 AND pmdoseq = g_pmdt_d[l_ac].pmdt002 AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
                  IF l_n = 0 OR cl_null(l_n) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00374'
                     LET g_errparam.extend = g_pmdt_d[l_ac].pmdt003
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdt_d[l_ac].pmdt003 = g_pmdt_d_o.pmdt003
                     NEXT FIELD pmdt003
                  END IF
          
                  #若採購項次、採購項序、採購分批序均有值時，需撿核該採購單是否有對應的交期明細資料
                  IF NOT apmt520_pmdo_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt003 = g_pmdt_d_o.pmdt003
                     NEXT FIELD pmdt003
                  END IF
                  
                  CALL apmt520_pmdt001_desc()
                  
                  #若輸入的採購單號+採購項次+採購項序的pmdo_t只有對應一個分批序時，則自動將分批序預設到收貨單身[C:分批序]上
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001 AND pmdoseq = g_pmdt_d[l_ac].pmdt002 AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
                  IF l_n = 1 THEN
                     SELECT pmdoseq2 INTO g_pmdt_d[l_ac].pmdt004 FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001 AND pmdoseq = g_pmdt_d[l_ac].pmdt002 AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003                  
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt004
                     
                     LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004 
                  END IF
                  
               END IF
            END IF
            
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            LET g_pmdt_d_o.pmdt003 = g_pmdt_d[l_ac].pmdt003                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt003
            #add-point:ON CHANGE pmdt003 name="input.g.page1.pmdt003"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt004
            #add-point:BEFORE FIELD pmdt004 name="input.b.page1.pmdt004"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt004
            
            #add-point:AFTER FIELD pmdt004 name="input.a.page1.pmdt004"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt004)  THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdt_d[l_ac].pmdt004 != g_pmdt_d_o.pmdt004 OR cl_null(g_pmdt_d_o.pmdt004))) THEN 
                 
                  #若採購項次、採購項序、採購分批序均有值時，需撿核該採購單是否有對應的交期明細資料
                  IF NOT apmt520_pmdo_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt004 = g_pmdt_d_o.pmdt004
                     NEXT FIELD pmdt004
                  END IF
                  
                  CALL apmt520_pmdt001_desc()
                  
               END IF
            END IF
            
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004                   
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt004
            #add-point:ON CHANGE pmdt004 name="input.g.page1.pmdt004"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt081
            #add-point:BEFORE FIELD pmdt081 name="input.b.page1.pmdt081"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt081
            
            #add-point:AFTER FIELD pmdt081 name="input.a.page1.pmdt081"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt081) THEN
               IF g_pmdt_d[l_ac].pmdt081 != g_pmdt_d_o.pmdt081 OR cl_null(g_pmdt_d_o.pmdt081) THEN 
                  IF NOT apmt520_pmdt081_chk(g_pmdt_d[l_ac].pmdt081) THEN
                     LET g_pmdt_d[l_ac].pmdt081 = g_pmdt_d_t.pmdt081
                     NEXT FIELD pmdt081
                  END IF
                  
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt082) THEN
                     IF NOT apmt520_pmdt082_chk(g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082) THEN
                        LET g_pmdt_d[l_ac].pmdt082 = g_pmdt_d_t.pmdt082
                        NEXT FIELD pmdt082
                     END IF
                  END IF
               END IF
            END IF
            
            LET g_pmdt_d_o.pmdt081 = g_pmdt_d[l_ac].pmdt081 
               
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt081
            #add-point:ON CHANGE pmdt081 name="input.g.page1.pmdt081"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt082
            #add-point:BEFORE FIELD pmdt082 name="input.b.page1.pmdt082"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt082
            
            #add-point:AFTER FIELD pmdt082 name="input.a.page1.pmdt082"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt082) THEN
               IF g_pmdt_d[l_ac].pmdt082 != g_pmdt_d_o.pmdt082 OR cl_null(g_pmdt_d_o.pmdt082) THEN 
                  IF NOT apmt520_pmdt082_chk(g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082) THEN
                     LET g_pmdt_d[l_ac].pmdt082 = g_pmdt_d_t.pmdt082
                     NEXT FIELD pmdt082
                  END IF
                  
                  CALL apmt520_pmdt082_desc()
                  
               END IF
            END IF
            LET g_pmdt_d_o.pmdt082 = g_pmdt_d[l_ac].pmdt082
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt082
            #add-point:ON CHANGE pmdt082 name="input.g.page1.pmdt082"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt083
            
            #add-point:AFTER FIELD pmdt083 name="input.a.page1.pmdt083"
 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt083
            #add-point:BEFORE FIELD pmdt083 name="input.b.page1.pmdt083"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt083
            #add-point:ON CHANGE pmdt083 name="input.g.page1.pmdt083"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt005
            #add-point:BEFORE FIELD pmdt005 name="input.b.page1.pmdt005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt005
            
            #add-point:AFTER FIELD pmdt005 name="input.a.page1.pmdt005"
            #160606-00013#1---s
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt005) THEN
               IF g_pmdt_d[l_ac].pmdt005 != g_pmdt_d_o.pmdt005 OR cl_null(g_pmdt_d_o.pmdt005) THEN 
            #160606-00013#1---e
                  IF g_pmdt_d[l_ac].pmdt005 = '9' THEN  #樣品
                     LET g_pmdt_d[l_ac].pmdt001 = ''
                     LET g_pmdt_d[l_ac].pmdt002 = ''
                     LET g_pmdt_d[l_ac].pmdt003 = ''
                     LET g_pmdt_d[l_ac].pmdt004 = ''
                     LET g_pmdt_d[l_ac].pmdt036 = 0
                     LET g_pmdt_d[l_ac].pmdt038 = 0
                     LET g_pmdt_d[l_ac].pmdt039 = 0
                     LET g_pmdt_d[l_ac].pmdt047 = 0
                  END IF
                  
                  #160606-00013#1---s
			         #当委外采购来源工单有联产品，子件特性要可以修改为联产品，然后料件可以输入联产品料号
                  IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' AND g_pmdt_d[l_ac].pmdt005 = '12' THEN
                     LET g_pmdt_d[l_ac].pmdt006 = ''
                     LET g_pmdt_d[l_ac].pmdt006_desc = ''
                     LET g_pmdt_d[l_ac].pmdt006_desc2 = ''
                     LET g_pmdt_d[l_ac].pmdt007 = ''
                     LET g_pmdt_d[l_ac].pmdt007_desc = ''
                  END IF
               END IF
            END IF
            LET g_pmdt_d_o.pmdt005 = g_pmdt_d[l_ac].pmdt005
            #160606-00013#1---e    
            
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt005
            #add-point:ON CHANGE pmdt005 name="input.g.page1.pmdt005"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt006
            
            #add-point:AFTER FIELD pmdt006 name="input.a.page1.pmdt006"
            CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
            
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt006) THEN
               IF g_pmdt_d[l_ac].pmdt006 != g_pmdt_d_o.pmdt006 OR cl_null(g_pmdt_d_o.pmdt006) THEN 
                 
                  IF NOT apmt520_pmdt006_chk(g_pmdt_d[l_ac].pmdt006) THEN
                     LET g_pmdt_d[l_ac].pmdt006 = g_pmdt_d_t.pmdt006
                     CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
                     NEXT FIELD pmdt006
                  END IF
                  
                  #mod zhangllc 151201 --begin 税别等栏位会被清空
                  #IF ((cl_null(g_pmdt_d[l_ac].pmdt001)) AND (cl_null(g_pmdt_d[l_ac].pmdt002)) AND (cl_null(g_pmdt_d[l_ac].pmdt003)) AND (cl_null(g_pmdt_d[l_ac].pmdt004)))
                  #    OR ((cl_null(g_pmdt_d[l_ac].pmdt027)) AND (cl_null(g_pmdt_d[l_ac].pmdt028)))  THEN
                  IF  (cl_null(g_pmdt_d[l_ac].pmdt001) OR cl_null(g_pmdt_d[l_ac].pmdt002) OR cl_null(g_pmdt_d[l_ac].pmdt003) OR cl_null(g_pmdt_d[l_ac].pmdt004))
                  AND (cl_null(g_pmdt_d[l_ac].pmdt027) OR cl_null(g_pmdt_d[l_ac].pmdt028))  THEN
                  #mod zhangllc 151201 --end
                     CALL apmt520_pmdt006_desc()
                  END IF
                  
                  IF g_argv[1] MATCHES '[24]' OR ((g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND cl_null(g_pmds_m.pmds006)) THEN
                     #160314-00009#3   marked by zhujing 2016-3-17-----(S) 元件中有判断
#                     LET l_imaa005 = ''
#                     CALL apmt520_get_imaa005(g_enterprise,g_pmdt_d[l_ac].pmdt006) RETURNING l_imaa005
                     #160314-00009#3   marked by zhujing 2016-3-17-----(E) 
                     #使用產品特徵 
                     CALL l_inam.clear()     
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' THEN 
#                        IF NOT cl_null(l_imaa005) THEN      #160314-00009#3   marked by zhujing 2016-3-17
                        IF s_feature_auto_chk(g_pmdt_d[l_ac].pmdt006) AND cl_null(g_pmdt_d[l_ac].pmdt007) THEN      #160314-00009#3   mod by zhujing 2016-3-17
                           IF l_cmd = 'a' THEN            
                              #CALL l_inam.clear()            
                              CALL s_feature(l_cmd,g_pmdt_d[l_ac].pmdt006,'','',g_site,g_pmds_m.pmdsdocno) RETURNING l_success,l_inam
                              LET g_pmdt_d[l_ac].pmdt007 = l_inam[1].inam002
                              LET g_pmdt_d[l_ac].pmdt020 = l_inam[1].inam004
                              DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt020
                              
                              #計算參考數量
                              IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) THEN
                                 #CALL s_aimi190_get_convert(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021) RETURNING l_success,l_rate
                                 #LET g_pmdt_d[l_ac].pmdt022 = g_pmdt_d[l_ac].pmdt020 * l_rate
                                 CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                                         RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                              END IF
                              
                              #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                              #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                              IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN  #體參數使用採購計價單位
                                 #ALL s_aimi190_get_convert(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023) RETURNING l_success,l_rate
                                 #ET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020 * l_rate
                                 CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                         RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                              ELSE
                                 LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                                 LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020            
                              END IF
                              DISPLAY BY NAME g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt024
                           END IF
                        END IF
                     END IF
                     
                     CALL apmt520_pmdt006_desc()
                     
                     #修改料號時需要開窗詢問是否重新取價，若選擇要時則需呼叫取價應用元件重新取價，
                     #並重新呼叫'計算金額'應用元件計算[C:含稅金額]、[C:未稅金額]、[C:稅額]
                     IF l_cmd = 'u' THEN 
                        IF cl_ask_confirm('axm-00230') THEN                              
                           #取出價格
                           CALL apmt520_get_price()
                          
                           #未稅金額、含稅金額
                           IF (NOT cl_null(g_pmdt_d[l_ac].pmdt024)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                              CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                                RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039            
                           END IF
                           DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                           
                        END IF
                     ELSE
                        #取出價格
                        CALL apmt520_get_price()
                        #未稅金額、含稅金額
                        IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                           CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                             RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039            
                        END IF
                        DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                     END IF   
                  END IF
                 
                  #預設沖銷順序
                  LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                              " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                              "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                              "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' "
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                     LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) OR g_pmdt_d[l_ac].pmdt017 = ' ' THEN
                     LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
                  END IF
                  PREPARE pmdt011_pre FROM l_sql
                  EXECUTE pmdt011_pre INTO g_pmdt_d[l_ac].pmdt011
          
                  IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
                     LET g_pmdt_d[l_ac].pmdt011 = 1
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011
               END IF
               LET g_pmdt_d_o.pmdt006 = g_pmdt_d[l_ac].pmdt006
            END IF
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt006
            #add-point:BEFORE FIELD pmdt006 name="input.b.page1.pmdt006"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt006
            #add-point:ON CHANGE pmdt006 name="input.g.page1.pmdt006"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt007
            
            #add-point:AFTER FIELD pmdt007 name="input.a.page1.pmdt007"
            CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
            
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt007) THEN
               #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmdt_d[l_ac].pmdt007 != g_pmdt_d_t.pmdt007 OR cl_null(g_pmdt_d_t.pmdt007))) THEN    #160824-00007#348 Mark By Ken 170118
               IF (g_pmdt_d[l_ac].pmdt007 != g_pmdt_d_o.pmdt007 OR cl_null(g_pmdt_d_o.pmdt007)) THEN     #160824-00007#348 Add By Ken 170118
                  
                    
                  IF NOT s_feature_check(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) THEN
                     #LET g_pmdt_d[l_ac].pmdt007 = g_pmdt_d_t.pmdt007  #160824-00007#348 Mark By Ken 170118
                     LET g_pmdt_d[l_ac].pmdt007 = g_pmdt_d_o.pmdt007   #160824-00007#348 Add By Ken 170118
                     CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                     NEXT FIELD CURRENT
                  END IF
                  #151224-00025#3 add start ------------------------
                  IF NOT s_feature_direct_input(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d_t.pmdt007,g_pmds_m.pmdsdocno,g_pmds_m.pmdssite) THEN
                     NEXT FIELD CURRENT
                  END IF
                  #151224-00025#3 add end   ------------------------   
                  #收貨單在維護料號時需檢核料件AVL控管點(imaa044)設置，若是設置'2:可採購，不可收貨'時，則要檢核
                  #其他收貨、無採購收貨、收貨入庫單等作業也需考慮
                  IF g_argv[1] MATCHES '[123489]' OR g_argv[1] = '20' THEN
                     IF NOT s_apmt520_item_avl_chk(g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmds_m.pmds007) THEN
                        #LET g_pmdt_d[l_ac].pmdt007 = g_pmdt_d_t.pmdt007  #160824-00007#348 Mark By Ken 170118
                        LET g_pmdt_d[l_ac].pmdt007 = g_pmdt_d_o.pmdt007   #160824-00007#348 Add By Ken 170118                        
                        CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                        DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  
                  IF g_argv[1] MATCHES '[24]' OR ((g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND cl_null(g_pmds_m.pmds006)) THEN
                     
                     #修改料號時需要開窗詢問是否重新取價，若選擇要時則需呼叫取價應用元件重新取價，
                     #並重新呼叫'計算金額'應用元件計算[C:含稅金額]、[C:未稅金額]、[C:稅額]
                     IF l_cmd = 'u' THEN 
                        IF cl_ask_confirm('axm-00230') THEN                              
                           #取出價格
                           CALL apmt520_get_price()
                          
                           #未稅金額、含稅金額
                           IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                              CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                                RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039            
                           END IF
                           DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                        END IF
                     ELSE
                        #取出價格
                        CALL apmt520_get_price()
                        #未稅金額、含稅金額
                        IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                           CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                             RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039            
                        END IF
                        DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                     END IF   
                  END IF
                  #預設沖銷順序
                  LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                              " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                              "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                              "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' "
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                     LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) OR g_pmdt_d[l_ac].pmdt017 = ' ' THEN
                     LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
                  END IF
                  PREPARE pmdt011_pre1 FROM l_sql
                  EXECUTE pmdt011_pre1 INTO g_pmdt_d[l_ac].pmdt011
          
                  IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
                     LET g_pmdt_d[l_ac].pmdt011 = 1
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011   
               END IF
            END IF   
            #160512-00004#2-add-(S)
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()   #160519-00008#16
            CALL apmt520_set_required_b()      #160519-00008#16      
            CALL apmt520_set_no_entry_b(l_cmd)
            #160512-00004#2-add-(E)
            LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*     #160824-00007#348 Add By Ken 170118
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt007
            #add-point:BEFORE FIELD pmdt007 name="input.b.page1.pmdt007"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt007
            #add-point:ON CHANGE pmdt007 name="input.g.page1.pmdt007"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt009
            
            #add-point:AFTER FIELD pmdt009 name="input.a.page1.pmdt009"
            CALL s_desc_get_acc_desc('221',g_pmdt_d[l_ac].pmdt009) RETURNING g_pmdt_d[l_ac].pmdt009_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt009_desc
               
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt009) THEN
               IF NOT s_azzi650_chk_exist('221',g_pmdt_d[l_ac].pmdt009) THEN
                  LET g_pmdt_d[l_ac].pmdt009 = g_pmdt_d_t.pmdt009
                  CALL s_desc_get_acc_desc('221',g_pmdt_d[l_ac].pmdt009) RETURNING g_pmdt_d[l_ac].pmdt009_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt009_desc
                  NEXT FIELD pmdt009
               END IF
               #收貨單在維護料號時需檢核料件AVL控管點(imaa044)設置，若是設置'2:可採購，不可收貨'時，則要檢核
               #其他收貨、無採購收貨、收貨入庫單等作業也需考慮
               IF g_argv[1] MATCHES '[123489]' OR g_argv[1] = '20' THEN
                  IF NOT s_apmt520_item_avl_chk(g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmds_m.pmds007) THEN
                     LET g_pmdt_d[l_ac].pmdt009 = g_pmdt_d_t.pmdt009
                     CALL s_desc_get_acc_desc('221',g_pmdt_d[l_ac].pmdt009) RETURNING g_pmdt_d[l_ac].pmdt009_desc
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt009_desc
                     NEXT FIELD pmdt009
                  END IF
               END IF
            END IF               
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt009
            #add-point:BEFORE FIELD pmdt009 name="input.b.page1.pmdt009"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt009
            #add-point:ON CHANGE pmdt009 name="input.g.page1.pmdt009"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt010
            #add-point:BEFORE FIELD pmdt010 name="input.b.page1.pmdt010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt010
            
            #add-point:AFTER FIELD pmdt010 name="input.a.page1.pmdt010"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt010) THEN
               #收貨單在維護料號時需檢核料件AVL控管點(imaa044)設置，若是設置'2:可採購，不可收貨'時，則要檢核
               #其他收貨、無採購收貨、收貨入庫單等作業也需考慮
               IF g_argv[1] MATCHES '[123489]' OR g_argv[1] = '20' THEN
                  IF NOT s_apmt520_item_avl_chk(g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmds_m.pmds007) THEN
                     LET g_pmdt_d[l_ac].pmdt010 = g_pmdt_d_t.pmdt010
                     NEXT FIELD pmdt010
                  END IF
               END IF
            END IF                                      
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt010
            #add-point:ON CHANGE pmdt010 name="input.g.page1.pmdt010"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt025
            #add-point:BEFORE FIELD pmdt025 name="input.b.page1.pmdt025"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt025
            
            #add-point:AFTER FIELD pmdt025 name="input.a.page1.pmdt025"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt025
            #add-point:ON CHANGE pmdt025 name="input.g.page1.pmdt025"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt011
            #add-point:BEFORE FIELD pmdt011 name="input.b.page1.pmdt011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt011
            
            #add-point:AFTER FIELD pmdt011 name="input.a.page1.pmdt011"
            IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt011,"0","0","","","azz-00079",1) THEN
               LET g_pmdt_d[l_ac].pmdt011 = g_pmdt_d_t.pmdt011
               NEXT FIELD pmdt011
            END IF 
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt011) THEN
               IF g_pmdt_d[l_ac].pmdt011 != g_pmdt_d_t.pmdt011 OR cl_null(g_pmdt_d_t.pmdt011) THEN             
                  LET l_n = 0
                  LET l_sql = " SELECT COUNT(1) FROM pmdt_t ",
                              " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                              "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                              "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' ",
                              "   AND pmdt011 = '",g_pmdt_d[l_ac].pmdt011,"' "
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                     LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) OR g_pmdt_d[l_ac].pmdt017 = ' ' THEN
                     LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
                  END IF
                  PREPARE pmdt011_cn_pre FROM l_sql
                  EXECUTE pmdt011_cn_pre INTO l_n
                  IF l_n > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00407'
                     LET g_errparam.extend = g_pmdt_d[l_ac].pmdt011
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_pmdt_d[l_ac].pmdt011 = g_pmdt_d_t.pmdt011
                     NEXT FIELD pmdt011
                  END IF
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt011
            #add-point:ON CHANGE pmdt011 name="input.g.page1.pmdt011"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt019
            
            #add-point:AFTER FIELD pmdt019 name="input.a.page1.pmdt019"
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
               IF g_pmdt_d[l_ac].pmdt019 <> g_pmdt_d_o.pmdt019 OR cl_null(g_pmdt_d_o.pmdt019) THEN
                  IF NOT apmt520_unit_chk(g_pmdt_d[l_ac].pmdt019) THEN
                     LET g_pmdt_d[l_ac].pmdt019 = g_pmdt_d_t.pmdt019
                     CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc
                     NEXT FIELD pmdt019
                  END IF
                  
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt020) THEN
                     CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020)
                        RETURNING l_success,g_pmdt_d[l_ac].pmdt020
                             
                     IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
                        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                                  RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                        CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022)
                            RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                            
                     ELSE
                        LET g_pmdt_d[l_ac].pmdt022 = ''
                     END IF
                     
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                  RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                        CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                            RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                     ELSE
                        LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                        LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
                     END IF
                  END IF
                  
                  #預設沖銷順序
                  LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                              " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                              "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                              "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' ",
                              "   AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) OR g_pmdt_d[l_ac].pmdt017 = ' ' THEN
                     LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
                  END IF
                  PREPARE pmdt011_pre2 FROM l_sql
                  EXECUTE pmdt011_pre2 INTO g_pmdt_d[l_ac].pmdt011
                  
                  IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
                     LET g_pmdt_d[l_ac].pmdt011 = 1
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011
               END IF
               LET g_pmdt_d_o.pmdt019 = g_pmdt_d[l_ac].pmdt019
            END IF

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt019
            #add-point:BEFORE FIELD pmdt019 name="input.b.page1.pmdt019"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt019
            #add-point:ON CHANGE pmdt019 name="input.g.page1.pmdt019"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt020
            #add-point:BEFORE FIELD pmdt020 name="input.b.page1.pmdt020"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt020
            
            #add-point:AFTER FIELD pmdt020 name="input.a.page1.pmdt020"
            #倉退單，當倉退方式為'4:'價格折讓'時，數量欄位預設為0
            IF ((g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' ) AND g_pmds_m.pmds100 = '4') OR g_argv[1] = '26' THEN
               IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt020,"0.000","1","","","azz-00079",1) THEN
                  LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_t.pmdt020
                  NEXT FIELD pmdt020
               END IF
            ELSE
               IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt020,"0.000","0","","","azz-00079",1) THEN
                  LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_t.pmdt020
                  NEXT FIELD pmdt020
               END IF
            END IF
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt020)  THEN 
               #IF g_pmdt_d[l_ac].pmdt020 <> g_pmdt_d_o.pmdt020 OR cl_null(g_pmdt_d_o.pmdt020)  THEN
               #採購收貨、採購收貨入庫 時判斷收貨數量
               #IF (NOT cl_null(g_pmdt_d[l_ac].pmdt001)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt002)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt003)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt004)) THEN
                  IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
                     IF NOT s_apmt520_chk_pmdt020(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,'',0,g_pmdt_d[l_ac].pmdt020) THEN
                        LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_t.pmdt020
                        NEXT FIELD pmdt020
                     END IF
                  END IF
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                     IF NOT s_apmt520_chk_pmdt020(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,0,0,'',0,g_pmdt_d[l_ac].pmdt020) THEN
                        LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_t.pmdt020
                        NEXT FIELD pmdt020
                     END IF
                  END IF
                  
                  #抓取料件據點進銷存相關資訊
                  LET l_imaf071 = NULL
                  LET l_imaf081 = NULL
                  SELECT imaf071,imaf081 INTO l_imaf071,l_imaf081 FROM imaf_t WHERE imafent = g_enterprise
                    AND imafsite = g_site AND imaf001 = g_pmdt_d[l_ac].pmdt006
                  #若料件設置要做製造批序號管理時，新增時維護完數量時自動開啟批序號維護作業維護相關資料
                  IF (l_imaf071 = '1' OR l_imaf081 = '1') AND g_pmdt_d[l_ac].pmdt020 > 0 AND g_pmdt_d[l_ac].pmdt062 = 'N'
                        AND ( NOT cl_null(g_pmdt_d[l_ac].pmdtseq) AND
                              NOT cl_null(g_pmdt_d[l_ac].pmdt006) AND
                              NOT cl_null(g_pmdt_d[l_ac].pmdt019) AND
                              NOT cl_null(g_pmdt_d[l_ac].pmdt020) ) THEN 
                     
                     SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d[l_ac].pmdtseq
                     IF cl_null(l_n) THEN
                        LET l_n = 0
                     END IF
                     IF l_n = 0 OR (g_pmdt_d[l_ac].pmdt020 <> g_pmdt_d_o.pmdt020 OR cl_null(g_pmdt_d_o.pmdt020)) THEN
                        #判斷據點參數若收貨單使用製造批序號時，則製造批序號頁簽可以維護(據點參數:S-BAS-0049)
                        IF g_argv[1] MATCHES '[1289]' THEN
                           IF cl_get_para(g_enterprise,g_site,'S-BAS-0049') = 'Y' THEN
                              CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'2',g_pmds_m.pmds007,'1','',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                                  RETURNING l_success,l_amount
                           END IF
                        END IF
                        
                        #直接收貨入庫單
                        IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '20' THEN
                           CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'2',g_pmds_m.pmds007,'1','',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                               RETURNING l_success,l_amount
                        END IF
                        
                        #無採購的收貨單、收貨入庫單，詢問是否修改數量等於製造批序號總數量
                        IF g_argv[1] MATCHES '[24]' THEN
                           IF g_pmdt_d[l_ac].pmdt020 <> l_amount THEN
                              IF cl_ask_confirm('ain-00249') THEN
                                 LET g_pmdt_d[l_ac].pmdt020 = l_amount
                              END IF
                           END IF
                        END IF
                        
                        #驗退單、入庫單
                        #1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
                        #1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
                        #1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
                        IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                           SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = g_pmdt_d[l_ac].pmdt028
                           IF l_n > 0 THEN
                              CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                              IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                                 IF NOT s_apmt520_ins_inao('1',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                 END IF
                              ELSE
                                 IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                 END IF
                              END IF
                              CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'1',g_prog,'','','','','0')
                                    RETURNING l_success
                              CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                           ELSE
                              IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                                 CALL s_lot_ins(g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'2',g_pmds_m.pmds007,'1','',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                                    RETURNING l_success,l_amount
                              END IF
                           END IF
                        END IF
                        
                        #仓退单：若有指定收货单号：
                        #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
                        #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
                        #若没有指定收货单号则直接由库存档选取
                        IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                           #倉退時，庫位、儲位不為空時，才彈窗選擇製造批序號
                           IF (NOT cl_null(g_pmdt_d[l_ac].pmdt016)) AND g_pmdt_d[l_ac].pmdt017 IS NOT NULL THEN #160411-00017#1 add
                              IF NOT cl_null(g_pmds_m.pmds006) THEN
                                 SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                    WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                      AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                      AND pmdsent = g_enterprise 
                                      AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                         OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                      AND pmdsstus = 'S'
                                 IF l_n > 0 THEN
                                    CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                    DECLARE sel_pmdt_cs5 CURSOR FOR
                                       SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                          WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                            AND pmdsent = g_enterprise 
                                            AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                               OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                            AND pmdsstus = 'S'
                                    FOREACH sel_pmdt_cs5 INTO l_pmdtdocno,l_pmdtseq_1
                                       IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                       END IF
                                    END FOREACH
                                    CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                       RETURNING l_success
                                    CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                 END IF
                              ELSE
                                  CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                     RETURNING l_success
                              END IF
                           END IF  #160411-00017#1 add
                        END IF
                     END IF
                  END IF
                 
                  #借貨歸還單時 （借貨還量數量+借貨還價數量）不可大於已入庫量 - （已登打的借貨還量數量+已登打的借貨還價數量）！
                  IF g_argv[1] = '26' THEN
                     IF cl_null(g_pmdt_d[l_ac].pmdt090) THEN
                        LET g_pmdt_d[l_ac].pmdt090 = 0
                     END IF
                     LET l_pmdt020 = g_pmdt_d[l_ac].pmdt020 + g_pmdt_d[l_ac].pmdt090
                     IF NOT s_apmt520_chk_pmdt020(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,0,0,'',0,l_pmdt020) THEN
                        LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_t.pmdt020
                        NEXT FIELD pmdt020
                     END IF
                  END IF 
                  IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
                     IF NOT s_apmt520_chk_pmdt020(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,0,0,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt020) THEN
                        LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_t.pmdt020
                        NEXT FIELD pmdt020
                     END IF
                  END IF                  
               
                  #150917-00001#3  2016/03/08  By earl add s
                  #多角可續拋數量
                  IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' OR
                     g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
                     
                     CALL s_aic_carry_continue_qty(g_site,g_pmds_m.pmds053,'2',g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,'',g_pmds_m.pmdsdocno,g_pmdt_d_t.pmdtseq)
                     RETURNING l_chk,l_qty,l_qty_batch
                     
                     IF l_chk THEN
                        IF l_qty < g_pmdt_d[l_ac].pmdt020 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'apm-01091'  #項次%1 多角入庫單"入庫數量"不可大於最終站可續拋數量！
                           LET g_errparam.extend = g_pmds_m.pmdsdocno
                           LET g_errparam.popup = TRUE
                           LET g_errparam.replace[1] = g_pmdt_d[l_ac].pmdtseq
                           CALL cl_err()
                        
                           LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_o.pmdt020
                           NEXT FIELD pmdt020
                        END IF
                     END IF
                  END IF
                  #150917-00001#3  2016/03/08  By earl add e

               #END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                     CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020)
                        RETURNING l_success,g_pmdt_d[l_ac].pmdt020
                             
                     IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
                        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                                  RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                        CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022)
                            RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                            
                     ELSE
                        LET g_pmdt_d[l_ac].pmdt022 = ''
                     END IF
                     
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                  RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                        CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                            RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                     ELSE
                        LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                        LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
                     END IF
                  END IF
               
                  #未稅金額、含稅金額
                  IF g_argv[1] MATCHES '[24]' OR ((g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND cl_null(g_pmds_m.pmds006)) THEN
                     CALL apmt520_get_price()
                  END IF
                  
                  IF (NOT cl_null(g_pmdt_d[l_ac].pmdt036)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                     CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                       RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                  
                  IF g_pmdt_d[l_ac].pmdt020 <> g_pmdt_d_o.pmdt020 OR cl_null(g_pmdt_d_o.pmdt020)  THEN
                    IF g_pmdt_d[l_ac].pmdt062 = 'Y' THEN
                       IF NOT apmt520_03('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002) THEN #161006-00018#8 add pmdt001,pmdt002
                          LET g_pmdt_d[l_ac].pmdt062 = g_pmdt_d_o.pmdt062
                          NEXT FIELD pmdt062
                       END IF
                    END IF
                  END IF
               #END IF   
                                  
            END IF 
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020 
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt020
            #add-point:ON CHANGE pmdt020 name="input.g.page1.pmdt020"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt021
            
            #add-point:AFTER FIELD pmdt021 name="input.a.page1.pmdt021"
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt021) THEN
               IF NOT apmt520_unit_chk(g_pmdt_d[l_ac].pmdt021) THEN
                  LET g_pmdt_d[l_ac].pmdt021 = g_pmdt_d_t.pmdt021
                  CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc
                  NEXT FIELD pmdt019
               END IF
               IF (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
                  CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                            RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                  CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022)
                      RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                      
               ELSE
                  LET g_pmdt_d[l_ac].pmdt022 = ''
               END IF
               
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt021
            #add-point:BEFORE FIELD pmdt021 name="input.b.page1.pmdt021"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt021
            #add-point:ON CHANGE pmdt021 name="input.g.page1.pmdt021"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt022
            #add-point:BEFORE FIELD pmdt022 name="input.b.page1.pmdt022"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt022
            
            #add-point:AFTER FIELD pmdt022 name="input.a.page1.pmdt022"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt022
            #add-point:ON CHANGE pmdt022 name="input.g.page1.pmdt022"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt008
            
            #add-point:AFTER FIELD pmdt008 name="input.a.page1.pmdt008"
            CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt008) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt008
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aim-00002:sub-01302|aimm200|",cl_get_progname("aimm200",g_lang,"2"),"|:EXEPROGaimm200"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_imaa001_3") THEN
                  IF cl_chk_exist("v_imaf001_2") THEN
                     
                  ELSE
                     #檢查失敗時後續處理
                     LET g_pmdt_d[l_ac].pmdt008 = g_pmdt_d_t.pmdt008
                     CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
                     NEXT FIELD CURRENT
                  END IF
               ELSE
                  LET g_pmdt_d[l_ac].pmdt008 = g_pmdt_d_t.pmdt008
                  CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt008
            #add-point:BEFORE FIELD pmdt008 name="input.b.page1.pmdt008"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt008
            #add-point:ON CHANGE pmdt008 name="input.g.page1.pmdt008"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt023
            
            #add-point:AFTER FIELD pmdt023 name="input.a.page1.pmdt023"
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt023) THEN
               IF NOT apmt520_unit_chk(g_pmdt_d[l_ac].pmdt023) THEN
                  LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d_t.pmdt023
                  CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
                  NEXT FIELD pmdt023
               END IF
               
               IF (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
                  CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                            RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                  CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                      RETURNING l_success,g_pmdt_d[l_ac].pmdt024
               ELSE
                  LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                  LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
               END IF
               
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt023
            #add-point:BEFORE FIELD pmdt023 name="input.b.page1.pmdt023"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt023
            #add-point:ON CHANGE pmdt023 name="input.g.page1.pmdt023"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt024
            #add-point:BEFORE FIELD pmdt024 name="input.b.page1.pmdt024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt024
            
            #add-point:AFTER FIELD pmdt024 name="input.a.page1.pmdt024"
            IF (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt024)) THEN
               IF g_pmdt_d[l_ac].pmdt024 <> g_pmdt_d_t.pmdt024 OR cl_null(g_pmdt_d_t.pmdt024) THEN
                  CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt024   
                 
                  IF g_argv[1] MATCHES '[24]' OR ((g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND cl_null(g_pmds_m.pmds006)) THEN
                     #取出價格
                     CALL apmt520_get_price()
                  END IF
                  
                  #未稅金額、含稅金額
                  IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                     CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                       RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039            
                       
                     #add--2015/08/31 By shiun--(S)
                     CALL apmt520_detail_abg('4')
                          RETURNING l_success,l_errno,l_bgaf016,l_pmdt075,l_pmdt075_desc
                     IF NOT l_success THEN
                        CASE l_errno
                           WHEN 'abg-00103'
                                CASE l_bgaf016
                                   WHEN '1'
                                   WHEN '2'
                                        INITIALIZE g_errparam TO NULL
                                        LET g_errparam.code = l_errno
                                        LET g_errparam.extend = ''
                                        LET g_errparam.popup = TRUE
                                        CALL cl_err()
                                   WHEN '3'
                                        INITIALIZE g_errparam TO NULL
                                        LET g_errparam.code = l_errno
                                        LET g_errparam.extend = ''
                                        LET g_errparam.popup = TRUE
                                        CALL cl_err()
                                        NEXT FIELD CURRENT
                                END CASE
                           WHEN 'abg-00104'
                                INITIALIZE g_errparam TO NULL
                                LET g_errparam.code = l_errno
                                LET g_errparam.extend = ''
                                LET g_errparam.popup = TRUE
                                CALL cl_err()
                           OTHERWISE
                                INITIALIZE g_errparam TO NULL
                                LET g_errparam.code = l_errno
                                LET g_errparam.extend = ''
                                LET g_errparam.popup = TRUE
                                CALL cl_err()
                                NEXT FIELD CURRENT
                        END CASE
                     END IF
                     #add--2015/08/31 By shiun--(E)
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF   
            END IF                      
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt024
            #add-point:ON CHANGE pmdt024 name="input.g.page1.pmdt024"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt090
            #add-point:BEFORE FIELD pmdt090 name="input.b.page1.pmdt090"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt090
            
            #add-point:AFTER FIELD pmdt090 name="input.a.page1.pmdt090"
            IF g_argv[1] = '26' THEN
               IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt090,"0.000","1","","","azz-00079",1) THEN
                  LET g_pmdt_d[l_ac].pmdt090 = g_pmdt_d_t.pmdt090
                  NEXT FIELD pmdt090
               END IF
            
               IF NOT cl_null(g_pmdt_d[l_ac].pmdt090)  THEN 
                  IF g_pmdt_d[l_ac].pmdt090 <> g_pmdt_d_o.pmdt090 OR cl_null(g_pmdt_d_o.pmdt090)  THEN
                     #借貨歸還單時 （借貨還量數量+借貨還價數量）不可大於已入庫量 - （已登打的借貨還量數量+已登打的借貨還價數量）！
                     IF g_argv[1] = '26' THEN
                        IF cl_null(g_pmdt_d[l_ac].pmdt020) THEN
                           LET g_pmdt_d[l_ac].pmdt020 = 0
                        END IF
                        LET l_pmdt020 = g_pmdt_d[l_ac].pmdt020 + g_pmdt_d[l_ac].pmdt090
                        IF NOT s_apmt520_chk_pmdt020(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,0,0,'',0,l_pmdt020) THEN
                           LET g_pmdt_d[l_ac].pmdt090 = g_pmdt_d_t.pmdt090
                           NEXT FIELD pmdt090
                        END IF
                     END IF 
                     
                     IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                        CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt090)
                           RETURNING l_success,g_pmdt_d[l_ac].pmdt090
                                
                        IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
                           CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt090)
                                     RETURNING l_success,g_pmdt_d[l_ac].pmdt091
                           CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt091)
                               RETURNING l_success,g_pmdt_d[l_ac].pmdt091
                               
                        ELSE
                           LET g_pmdt_d[l_ac].pmdt091 = ''
                        END IF
                     END IF
               
                     IF (NOT cl_null(g_pmdt_d[l_ac].pmdt036)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                        CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt090,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                          RETURNING g_pmdt_d[l_ac].pmdt092,l_pmdt039,g_pmdt_d[l_ac].pmdt093
                     END IF
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt092,g_pmdt_d[l_ac].pmdt093
                     
                  END IF   
                  LET g_pmdt_d_o.pmdt090 = g_pmdt_d[l_ac].pmdt090  
               END IF                  
            END IF 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt090
            #add-point:ON CHANGE pmdt090 name="input.g.page1.pmdt090"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt091
            #add-point:BEFORE FIELD pmdt091 name="input.b.page1.pmdt091"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt091
            
            #add-point:AFTER FIELD pmdt091 name="input.a.page1.pmdt091"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt091
            #add-point:ON CHANGE pmdt091 name="input.g.page1.pmdt091"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt036
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt036,"0.000","1","","","azz-00079",1) THEN
               NEXT FIELD pmdt036
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdt036 name="input.a.page1.pmdt036"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt036) THEN
               #未稅金額、含稅金額
               IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
                  CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                    RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039            
                  #add--2015/08/31 By shiun--(S)
                  CALL apmt520_detail_abg('4')
                       RETURNING l_success,l_errno,l_bgaf016,l_pmdt075,l_pmdt075_desc
                  IF NOT l_success THEN
                     CASE l_errno
                        WHEN 'abg-00103'
                             CASE l_bgaf016
                                WHEN '1'
                                WHEN '2'
                                     INITIALIZE g_errparam TO NULL
                                     LET g_errparam.code = l_errno
                                     LET g_errparam.extend = ''
                                     LET g_errparam.popup = TRUE
                                     CALL cl_err()
                                WHEN '3'
                                     INITIALIZE g_errparam TO NULL
                                     LET g_errparam.code = l_errno
                                     LET g_errparam.extend = ''
                                     LET g_errparam.popup = TRUE
                                     CALL cl_err()
                                     NEXT FIELD CURRENT
                             END CASE
                        WHEN 'abg-00104'
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = l_errno
                             LET g_errparam.extend = ''
                             LET g_errparam.popup = TRUE
                             CALL cl_err()
                        OTHERWISE
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = l_errno
                             LET g_errparam.extend = ''
                             LET g_errparam.popup = TRUE
                             CALL cl_err()
                             NEXT FIELD CURRENT
                     END CASE
                  END IF
                  #add--2015/08/31 By shiun--(E)
               END IF
            END IF 
            #價差比
            IF g_pmdt_d[l_ac].pmdt044 > 0 THEN 
               LET g_pmdt_d[l_ac].pmdt045 = (g_pmdt_d[l_ac].pmdt044 - g_pmdt_d[l_ac].pmdt036) / g_pmdt_d[l_ac].pmdt044
            END IF
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt045

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt036
            #add-point:BEFORE FIELD pmdt036 name="input.b.page1.pmdt036"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt036
            #add-point:ON CHANGE pmdt036 name="input.g.page1.pmdt036"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt046
            
            #add-point:AFTER FIELD pmdt046 name="input.a.page1.pmdt046"
            CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
            
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt046) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #160318-00025#15 by 07900 --add-str 
               LET g_errshow = TRUE #是否開窗
               #160318-00025#15 by 07900 --add-end
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_site
               LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt046
                #160318-00025#15 by 07900 --add-str 
               LET g_chkparam.err_str[1] ="aoo-00223:sub-01302|aooi610|",cl_get_progname("aooi610",g_lang,"2"),"|:EXEPROGaooi610"
               #160318-00025#15 by 07900 --add-end 
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_oodb002") THEN
                  #檢查成功時後續處理
                  
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdt_d[l_ac].pmdt046 = g_pmdt_d_t.pmdt046
                  CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
                  NEXT FIELD CURRENT
               END IF
               
               #未稅金額、含稅金額
               IF (NOT cl_null(g_pmdt_d[l_ac].pmdt036)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) THEN
                  CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                    RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF
            END IF 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt046
            #add-point:BEFORE FIELD pmdt046 name="input.b.page1.pmdt046"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt046
            #add-point:ON CHANGE pmdt046 name="input.g.page1.pmdt046"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt037
            #add-point:BEFORE FIELD pmdt037 name="input.b.page1.pmdt037"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt037
            
            #add-point:AFTER FIELD pmdt037 name="input.a.page1.pmdt037"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt037
            #add-point:ON CHANGE pmdt037 name="input.g.page1.pmdt037"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt038
            #add-point:BEFORE FIELD pmdt038 name="input.b.page1.pmdt038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt038
            
            #add-point:AFTER FIELD pmdt038 name="input.a.page1.pmdt038"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt038
            #add-point:ON CHANGE pmdt038 name="input.g.page1.pmdt038"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt039
            #add-point:BEFORE FIELD pmdt039 name="input.b.page1.pmdt039"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt039
            
            #add-point:AFTER FIELD pmdt039 name="input.a.page1.pmdt039"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt039
            #add-point:ON CHANGE pmdt039 name="input.g.page1.pmdt039"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt047
            #add-point:BEFORE FIELD pmdt047 name="input.b.page1.pmdt047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt047
            
            #add-point:AFTER FIELD pmdt047 name="input.a.page1.pmdt047"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt047
            #add-point:ON CHANGE pmdt047 name="input.g.page1.pmdt047"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt092
            #add-point:BEFORE FIELD pmdt092 name="input.b.page1.pmdt092"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt092
            
            #add-point:AFTER FIELD pmdt092 name="input.a.page1.pmdt092"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt092
            #add-point:ON CHANGE pmdt092 name="input.g.page1.pmdt092"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt093
            #add-point:BEFORE FIELD pmdt093 name="input.b.page1.pmdt093"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt093
            
            #add-point:AFTER FIELD pmdt093 name="input.a.page1.pmdt093"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt093
            #add-point:ON CHANGE pmdt093 name="input.g.page1.pmdt093"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt026
            #add-point:BEFORE FIELD pmdt026 name="input.b.page1.pmdt026"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt026
            
            #add-point:AFTER FIELD pmdt026 name="input.a.page1.pmdt026"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt026
            #add-point:ON CHANGE pmdt026 name="input.g.page1.pmdt026"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt041
            #add-point:BEFORE FIELD pmdt041 name="input.b.page1.pmdt041"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt041
            
            #add-point:AFTER FIELD pmdt041 name="input.a.page1.pmdt041"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt041
            #add-point:ON CHANGE pmdt041 name="input.g.page1.pmdt041"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt062
            #add-point:BEFORE FIELD pmdt062 name="input.b.page1.pmdt062"
            LET g_pmdt_d_o.pmdt062 = g_pmdt_d[l_ac].pmdt062
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt062
            
            #add-point:AFTER FIELD pmdt062 name="input.a.page1.pmdt062"
            IF g_pmdt_d[l_ac].pmdt062 != g_pmdt_d_o.pmdt062 OR cl_null(g_pmdt_d_o.pmdt062) THEN
               #由N ==> Y
               IF g_pmdt_d[l_ac].pmdt062 = 'Y' THEN
                  IF NOT apmt520_03('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002) THEN   #161006-00018#8 add pmdt001,pmdt002
                     LET g_pmdt_d[l_ac].pmdt062 = g_pmdt_d_o.pmdt062
                     NEXT FIELD pmdt062
                  END IF
               END IF
               #由Y ==> N
               IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                  CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                  DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno AND inaoseq = g_pmdt_d[l_ac].pmdtseq
               END IF
            END IF
            
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            
            LET g_pmdt_d_o.pmdt062 = g_pmdt_d[l_ac].pmdt062
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt062
            #add-point:ON CHANGE pmdt062 name="input.g.page1.pmdt062"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt016
            
            #add-point:AFTER FIELD pmdt016 name="input.a.page1.pmdt016"
            CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
            
            IF (NOT cl_null(g_pmdt_d[l_ac].pmdt016)) AND (g_pmdt_d[l_ac].pmdt016 != g_pmdt_d_o.pmdt016 OR cl_null(g_pmdt_d_o.pmdt016)) THEN 
#此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_site
               LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt016
               
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_inaa001_1") THEN
                  ##倉退時 輸入的料件+產品特徵+庫存管理特徵+庫位必須存在[T:庫存明細檔]中
                  #IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  #   IF NOT apmt520_chk_inag004(g_pmdt_d[l_ac].pmdt016) THEN
                  #      LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_t.pmdt016
                  #      CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
                  #      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
                  #      NEXT FIELD pmdt016
                  #   END IF
                  #END IF
                  
                  #160801-00043#1--s
                  IF NOT cl_null(g_bas_0043) THEN  #VMI存貨庫位Tag
                     LET l_n = 0
                     SELECT COUNT(1) INTO l_n FROM inac_t WHERE inacent = g_enterprise AND inacsite = g_site AND inac001 = g_pmdt_d[l_ac].pmdt016 AND inac003 = g_bas_0043
                     IF g_pmds_m.pmds011 = '3' THEN   #VMI采购
                        IF l_n = 0 OR cl_null(l_n) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'apm-01060'
                           LET g_errparam.extend = g_pmdt_d[l_ac].pmdt016
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                           CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
                           DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
                           NEXT FIELD CURRENT
                        END IF
                     ELSE
                        IF l_n > 0 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'apm-01122'
                           LET g_errparam.extend = g_pmdt_d[l_ac].pmdt016
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                           CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
                           DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
                  #160801-00043#1--e

                  
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) THEN 
                     IF NOT apmt520_pmdt017_chk() THEN
                         LET g_pmdt_d[l_ac].pmdt017 = ''
                         LET g_pmdt_d[l_ac].pmdt017_desc = ''
                         LET g_pmdt_d_o.pmdt017 = ''
                         #NEXT FIELD pmdt017
                      END IF
                  END IF
                  #庫位不使用儲位管理時，儲位不可維護
                  SELECT inaa007 INTO l_inaa007 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_pmdt_d[l_ac].pmdt016
                  IF l_inaa007 = '5' THEN
                     LET g_pmdt_d[l_ac].pmdt017 = ' '
                     LET g_pmdt_d[l_ac].pmdt017_desc = ''
                  ELSE
                     IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                        LET g_pmdt_d[l_ac].pmdt017 = ''
                     END IF
                  END IF
                  
                  #修改庫位後，若是收貨單，則需同步更新製造批序號的庫儲批，若是驗退、入庫、倉退單，則詢問是否確認修改，若確認修改，則刪除原先的製造批序號資料，開窗重新挑選
                  IF g_argv[1] MATCHES '[128934]' OR g_argv[1] = '20' 
                     OR g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN  #160407-00028#1 add
                     CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                         RETURNING l_success
                  END IF
                  ##160407-00028#1--mark--begin---
                  ##驗退單、入庫單
                  ##1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
                  ##1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
                  ##1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
                  #IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                  #   SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = g_pmdt_d[l_ac].pmdt028
                  #   IF l_n > 0 THEN
                  #      CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success,l_n
                  #      IF  l_n > 0 THEN
                  #         IF l_success THEN
                  #            CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                  #            CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                  #            
                  #            IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                  #               IF NOT s_apmt520_ins_inao('1',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                  #               END IF
                  #            ELSE
                  #               IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                  #               END IF
                  #            END IF
                  #            CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'1',g_prog,'','','','','0')
                  #                  RETURNING l_success
                  #            CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                  #            CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                  #         ELSE
                  #            LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                  #            CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
                  #            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
                  #         END IF
                  #      END IF
                  #   ELSE
                  #      IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                  #         CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                  #             RETURNING l_success
                  #      END IF
                  #   END IF
                  #END IF
                  #160407-00028#1--mark---end---
                  
                  #仓退单：若有指定收货单号：
                  #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
                  #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
                  #若没有指定收货单号则直接由库存档选取
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                     #庫位修改的時候才彈窗詢問，直接維護的話，不彈窗詢問，直接開窗維護
                     IF g_pmdt_d[l_ac].pmdt017 IS NOT NULL THEN #160411-00017#1 add
                        IF g_pmdt_d[l_ac].pmdt016 != g_pmdt_d_o.pmdt016 THEN   #160411-00017#1 add
                           CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success,l_n
                           IF l_n > 0 THEN
                              IF l_success THEN
                                 IF NOT cl_null(g_pmds_m.pmds006) THEN
                                    SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                       WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                         AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                         AND pmdsent = g_enterprise 
                                         AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                            OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                         AND pmdsstus = 'S'
                                    IF l_n > 0 THEN
                                       CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                       CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                       DECLARE sel_pmdt_cs6 CURSOR FOR
                                          SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                             WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                               AND pmdsent = g_enterprise 
                                               AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                                  OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                               AND pmdsstus = 'S'
                                       FOREACH sel_pmdt_cs6 INTO l_pmdtdocno,l_pmdtseq_1
                                          IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                          END IF
                                       END FOREACH
                                       CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                          RETURNING l_success
                                       CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                       CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                    END IF
                                 ELSE
                                    CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                       RETURNING l_success
                                 END IF
                              ELSE
                                 LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                                 CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
                                 DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
                              END IF
                           END IF
                        ##160411-00017#1---add---begin----
                        ELSE
                        
                           IF NOT cl_null(g_pmds_m.pmds006) THEN
                              SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                 WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                   AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                   AND pmdsent = g_enterprise 
                                   AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                      OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                   AND pmdsstus = 'S'
                              IF l_n > 0 THEN
                                 CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                 CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                 DECLARE sel_pmdt_cs10 CURSOR FOR
                                    SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                       WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                         AND pmdsent = g_enterprise 
                                         AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                            OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                         AND pmdsstus = 'S'
                                 FOREACH sel_pmdt_cs10 INTO l_pmdtdocno,l_pmdtseq_1
                                    IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                    END IF
                                 END FOREACH
                                 CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                    RETURNING l_success
                                 CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                 CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                              END IF
                           ELSE
                              CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                 RETURNING l_success
                           END IF
                        END IF
                     END IF
                     ##160411-00017#1---add---end----
                  END IF
                 
                  #預設沖銷順序
                  LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                              " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                              "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                              "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' ",
                              "   AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                     LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) OR g_pmdt_d[l_ac].pmdt017 = ' ' THEN
                     LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
                  END IF
                  PREPARE pmdt011_pre3 FROM l_sql
                  EXECUTE pmdt011_pre3 INTO g_pmdt_d[l_ac].pmdt011
          
                  IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
                     LET g_pmdt_d[l_ac].pmdt011 = 1
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                  CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 
            CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()
            CALL apmt520_set_required_b()
            CALL apmt520_set_no_entry_b(l_cmd)
            
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017  #160411-00017#1 add
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt016
            #add-point:BEFORE FIELD pmdt016 name="input.b.page1.pmdt016"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt016
            #add-point:ON CHANGE pmdt016 name="input.g.page1.pmdt016"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt017
            
            #add-point:AFTER FIELD pmdt017 name="input.a.page1.pmdt017"
            #160316-00007#3--add--begin---
            IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
               LET g_pmdt_d[l_ac].pmdt017 = ' '
            END IF
            #160316-00007#3---add--end----
            CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            
            #IF (NOT cl_null(g_pmdt_d[l_ac].pmdt017)) AND (g_pmdt_d[l_ac].pmdt017 != g_pmdt_d_o.pmdt017 OR cl_null(g_pmdt_d_o.pmdt017)) THEN   #160316-00007#3 mark
            IF (NOT cl_null(g_pmdt_d[l_ac].pmdt016)) AND (g_pmdt_d[l_ac].pmdt017 IS NOT NULL) AND (g_pmdt_d[l_ac].pmdt017 != g_pmdt_d_o.pmdt017 OR g_pmdt_d_o.pmdt017 IS NULL) THEN     #160316-00007#3 add
               #161201-00033#1--s
               #入库时，单身选择的库位，其储位管理属性为：2:使用储位管理-人工指定。
               #自行输入的储位需要同步回写到aini002储位基本资料档中。
               IF g_argv[1] MATCHES '[346]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '20' THEN
                  LET l_inaa007 = ''
                  SELECT inaa007 INTO l_inaa007 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_pmdt_d[l_ac].pmdt016
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM inab_t WHERE inabent = g_enterprise AND inabsite = g_site
                         AND inab001 = g_pmdt_d[l_ac].pmdt016 AND inab002 = g_pmdt_d[l_ac].pmdt017
                  IF cl_null(l_n) THEN  LET l_n = 0 END IF
                  IF l_inaa007 = '2' AND l_n = 0 THEN
                     IF NOT s_aini002_ins_inab(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'ain-00282'
                        LET g_errparam.extend = "inab_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                        CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
                        DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               #161201-00033#1--e
               
               IF apmt520_pmdt017_chk() THEN
               

                  #修改儲後，若是收貨單，則需同步更新製造批序號的庫儲批，若是驗退、入庫、倉退單，則詢問是否確認修改，若確認修改，則刪除原先的製造批序號資料，開窗重新挑選
                  IF g_argv[1] MATCHES '[128934]' OR g_argv[1] = '20' 
                     OR g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN  #160407-00028#1 add
                     CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                         RETURNING l_success
                  END IF
                  #160407-00028#1--mark---begin----
                  ##驗退單、入庫單
                  ##1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
                  ##1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
                  ##1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
                  #IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                  #   SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = g_pmdt_d[l_ac].pmdt028
                  #   IF l_n > 0 THEN
                  #      CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success,l_n
                  #      IF l_n > 0 THEN
                  #         IF l_success THEN
                  #            CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                  #            CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                  #            
                  #            IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                  #               IF NOT s_apmt520_ins_inao('1',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                  #               END IF
                  #            ELSE
                  #               IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                  #               END IF
                  #            END IF
                  #            CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'1',g_prog,'','','','','0')
                  #                  RETURNING l_success
                  #            CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                  #            CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                  #         ELSE
                  #            LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                  #            CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
                  #            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
                  #         END IF
                  #      END IF
                  #   ELSE
                  #      IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                  #         CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                  #             RETURNING l_success
                  #      END IF
                  #   END IF
                  #END IF    
                  #160407-00028#1--mark---end---
                  
                  #仓退单：若有指定收货单号：
                  #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
                  #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
                  #若没有指定收货单号则直接由库存档选取
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                     IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN #160411-00017#1 add
                        IF g_pmdt_d[l_ac].pmdt017 != g_pmdt_d_o.pmdt017 THEN #160411-00017#1 add
                           CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success,l_n
                           IF l_n > 0 THEN
                              IF l_success THEN
                                 IF NOT cl_null(g_pmds_m.pmds006) THEN
                                    SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                       WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                         AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                         AND pmdsent = g_enterprise 
                                         AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                            OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                         AND pmdsstus = 'S'
                                    IF l_n > 0 THEN
                                       CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                       CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                       DECLARE sel_pmdt_cs7 CURSOR FOR
                                          SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                             WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                               AND pmdsent = g_enterprise 
                                               AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                                  OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                               AND pmdsstus = 'S'
                                       FOREACH sel_pmdt_cs7 INTO l_pmdtdocno,l_pmdtseq_1
                                          IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                          END IF
                                       END FOREACH
                                       CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                          RETURNING l_success
                                       CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                       CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                    END IF
                                 ELSE
                                    CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                       RETURNING l_success
                                 END IF
                              ELSE
                                 LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                                 CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
                                 DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
                              END IF
                           END IF
                        #160411-00017#1--add---begin---
                        ELSE
                           IF NOT cl_null(g_pmds_m.pmds006) THEN
                              SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                 WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                   AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                   AND pmdsent = g_enterprise 
                                   AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                      OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                   AND pmdsstus = 'S'
                              IF l_n > 0 THEN
                                 CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                 CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                 DECLARE sel_pmdt_cs11 CURSOR FOR
                                    SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                       WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                         AND pmdsent = g_enterprise 
                                         AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                            OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                         AND pmdsstus = 'S'
                                 FOREACH sel_pmdt_cs11 INTO l_pmdtdocno,l_pmdtseq_1
                                    IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                    END IF
                                 END FOREACH
                                 CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                    RETURNING l_success
                                 CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                 CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                              END IF
                           ELSE
                              CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                 RETURNING l_success
                           END IF
                        END IF
                     END IF
                     #160411-00017#1--add---end---
                  END IF
                  
                  #預設沖銷順序
                  LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                              " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                              "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                              "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' ",
                              "   AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                     LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
                  END IF
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
                  END IF
                  PREPARE pmdt011_pre4 FROM l_sql
                  EXECUTE pmdt011_pre4 INTO g_pmdt_d[l_ac].pmdt011
          
                  IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
                     LET g_pmdt_d[l_ac].pmdt011 = 1
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011
               ELSE
                  #檢查失敗時後續處理
                  LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                  CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
                  NEXT FIELD CURRENT
               END IF
            
            END IF 
            CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt017
            #add-point:BEFORE FIELD pmdt017 name="input.b.page1.pmdt017"
     
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt017
            #add-point:ON CHANGE pmdt017 name="input.g.page1.pmdt017"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt018
            #add-point:BEFORE FIELD pmdt018 name="input.b.page1.pmdt018"
            IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
               LET g_pmdt_d[l_ac].pmdt018 = ' '
            END IF  
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018                                         
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt018
            
            #add-point:AFTER FIELD pmdt018 name="input.a.page1.pmdt018"
            #160519-00022#7---mod---e
            ##160316-00007#3--add--begin---
            #IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
            #   LET g_pmdt_d[l_ac].pmdt018 = ' '
            #END IF
            ##160316-00007#3---add--end----
            IF g_argv[1] MATCHES '[346]' THEN 
               SELECT imaf064,imaf061 
                 INTO l_imaf064,l_imaf061
                 FROM imaf_t  
                WHERE imafent = g_enterprise
                  AND imafsite = g_site
                  AND imaf001 = g_pmdt_d_o.pmdt006
               IF l_imaf061 <> '1' THEN
                  IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET g_pmdt_d[l_ac].pmdt018 = ' '
                  END IF
               ELSE
                  IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                     LET g_pmdt_d[l_ac].pmdt018 = ''
                  END IF                                 
               END IF
            ELSE
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_pmdt_d[l_ac].pmdt018 = ' '
               END IF            
            END IF
            #160519-00022#7---mod---e
            #IF (NOT cl_null(g_pmdt_d[l_ac].pmdt018)) AND (g_pmdt_d[l_ac].pmdt018 != g_pmdt_d_o.pmdt018 OR cl_null(g_pmdt_d_o.pmdt018)) THEN  #160316-00007#3 mark
            IF (g_pmdt_d[l_ac].pmdt018 IS NOT NULL) AND (g_pmdt_d[l_ac].pmdt018 != g_pmdt_d_o.pmdt018 OR g_pmdt_d_o.pmdt018 IS NULL) THEN    #160316-00007#3 add
               
               #倉退時有輸入收貨單來源時，批號僅能輸入該收貨單的入庫批號，不可隨便輸
               LET l_n = 0
               IF g_argv[1] = '7' THEN  #倉退
                  LET l_pmds000 = '6'
               END IF
               IF g_argv[1] = '14' THEN  #委外倉退
                  LET l_pmds000 = '12'
               END IF
               IF g_argv[1] = '15' THEN  #重覆性生產倉退
                 LET l_pmds000 = '13'
               END IF
               
               SELECT COUNT(1) INTO l_n FROM pmds_t,pmdt_t 
                  WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno AND pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                    AND pmds000 = l_pmds000 AND pmdsstus = 'S'
                    
               IF l_n > 0 THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmds_t,pmdt_t,pmdu_t 
                     WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno 
                       AND pmdtent = pmduent AND pmdtdocno = pmdudocno AND pmdtseq = pmduseq
                       AND pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                       AND pmds000 = l_pmds000 AND pmdsstus = 'S' AND pmdu008 = g_pmdt_d[l_ac].pmdt018
                  IF l_n = 0 OR cl_null(l_n) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00629'
                     LET g_errparam.extend = g_pmdt_d[l_ac].pmdt018
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                     NEXT FIELD pmdt018
                  END IF
               END IF
               #160519-00022#7---add---s
               #入库单的批号需要根据料件设定进行控管
               IF g_argv[1] MATCHES '[346]' THEN             
                  SELECT imaf064,imaf061 
                    INTO l_imaf064,l_imaf061
                    FROM imaf_t  
                   WHERE imafent = g_enterprise
                     AND imafsite = g_site
                     AND imaf001 = g_pmdt_d_o.pmdt006
                  IF l_imaf061 <> '2' THEN 
                     LET l_cnt = 0 
                     IF NOT cl_null(g_pmdt_d_o.pmdt007) THEN 
                        SELECT COUNT(1) INTO l_cnt
                          FROM inad_t
                         WHERE inadent = g_enterprise
                           AND inadsite = g_site
                           AND inad001 = g_pmdt_d_o.pmdt006  
                           AND inad002 = g_pmdt_d_o.pmdt007
                           AND inad003 = g_pmdt_d[l_ac].pmdt018
                     ELSE
                        SELECT COUNT(1) INTO l_cnt
                          FROM inad_t
                         WHERE inadent = g_enterprise
                           AND inadsite = g_site
                           AND inad001 = g_pmdt_d_o.pmdt006  
                           AND inad003 = g_pmdt_d[l_ac].pmdt018
                     END IF
                     #IF l_n > 0 THEN   #161230-00015#1
                     IF l_cnt > 0 THEN  #161230-00015#1
                        IF l_imaf064 = '1' THEN 
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'ain-00269'
                           LET g_errparam.extend = g_pmdt_d[l_ac].pmdt018
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                           NEXT FIELD CURRENT
                        END IF  
                        IF l_imaf064 = '2' THEN 
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'ain-00269'
                           LET g_errparam.extend = g_pmdt_d[l_ac].pmdt018
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                        END IF                      
                     END IF                     
                  END IF
               END IF                  
               #160519-00022#7---add---e               
               #修改批號後，若是收貨單，則需同步更新製造批序號的庫儲批，若是驗退、入庫、倉退單，則詢問是否確認修改，若確認修改，則刪除原先的製造批序號資料，開窗重新挑選
               IF g_argv[1] MATCHES '[128934]' OR g_argv[1] = '20' 
                  OR g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN  #160407-00028#1 add
                  CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
                      RETURNING l_success
               END IF
               #160407-00028#1--mark---begin---
               ##驗退單、入庫單
               ##1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
               ##1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
               ##1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
               #IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
               #   SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = g_pmdt_d[l_ac].pmdt028
               #   IF l_n > 0 THEN
               #      CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success ,l_n
               #      IF l_n > 0 THEN
               #         IF l_success THEN
               #            CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
               #            CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
               #            
               #            IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
               #               IF NOT s_apmt520_ins_inao('1',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
               #               END IF
               #            ELSE
               #               IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
               #               END IF
               #            END IF
               #            CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'1',g_prog,'','','','','0')
               #                  RETURNING l_success
               #            CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
               #            CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
               #         ELSE
               #            LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
               #         END IF
               #      END IF
               #   ELSE
               #      IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
               #         CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)  #160316-00007#3 add pmdt063
               #             RETURNING l_success
               #      END IF
               #   END IF
               #END IF
               #160407-00028#1--mark---end---
               
               #仓退单：若有指定收货单号：
               #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
               #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
               #若没有指定收货单号则直接由库存档选取
               IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) AND g_pmdt_d[l_ac].pmdt017 IS NOT NULL THEN #160411-00017#1 add
                     IF g_pmdt_d[l_ac].pmdt018 != g_pmdt_d_o.pmdt018 THEN #160411-00017#1 add
                        CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success,l_n
                        IF l_n > 0 THEN
                           IF l_success THEN
                              IF NOT cl_null(g_pmds_m.pmds006) THEN
                                 SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                    WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                      AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                      AND pmdsent = g_enterprise 
                                      AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                         OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                      AND pmdsstus = 'S'
                                 IF l_n > 0 THEN
                                    CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                    CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    DECLARE sel_pmdt_cs8 CURSOR FOR
                                       SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                          WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                            AND pmdsent = g_enterprise 
                                            AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                               OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                            AND pmdsstus = 'S'
                                    FOREACH sel_pmdt_cs8 INTO l_pmdtdocno,l_pmdtseq_1
                                       IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                       END IF
                                    END FOREACH
                                    CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                       RETURNING l_success
                                    CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                 END IF
                              ELSE
                                 CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                 CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                    RETURNING l_success
                              END IF
                           ELSE
                              LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                           END IF
                        END IF
                     #160411-00017#1--add---begin---   
                     ELSE
                        IF NOT cl_null(g_pmds_m.pmds006) THEN
                           SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                              WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                AND pmdsent = g_enterprise 
                                AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                   OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                AND pmdsstus = 'S'
                           IF l_n > 0 THEN
                              CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                              CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              DECLARE sel_pmdt_cs12 CURSOR FOR
                                 SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                    WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                      AND pmdsent = g_enterprise 
                                      AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                         OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                      AND pmdsstus = 'S'
                              FOREACH sel_pmdt_cs12 INTO l_pmdtdocno,l_pmdtseq_1
                                 IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                 END IF
                              END FOREACH
                              CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                 RETURNING l_success
                              CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                           END IF
                        ELSE
                           CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                           CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                              RETURNING l_success
                        END IF
                     END IF
                  END IF
                  #160411-00017#1--add---end---
               END IF
               
               #若料件要做批號管理且又有做有效期管理時，需要自動計算該批的有效日期
               CALL s_aini010_calculate_effdt(g_site,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt018,g_pmds_m.pmdsdocdt) RETURNING g_pmdt_d[l_ac].pmdt089                  
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt089
               
               LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                           " WHERE pmdtent = '",g_enterprise,"' AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                           "   AND pmdt006 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                           "   AND pmdt007 = '",g_pmdt_d[l_ac].pmdt007,"' ",
                           "   AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
               IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
                  LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
               END IF
               IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                  LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
               END IF
               IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
               END IF
               PREPARE pmdt011_pre5 FROM l_sql
               EXECUTE pmdt011_pre5 INTO g_pmdt_d[l_ac].pmdt011
          
               IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
                  LET g_pmdt_d[l_ac].pmdt011 = 1
               END IF 
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011
               
            END IF  
            #160512-00004#2-add-(S)
            CALL apmt520_set_entry_b(l_cmd)
            CALL apmt520_set_no_required_b()   #160519-00008#16
            CALL apmt520_set_required_b()      #160519-00008#16              
            CALL apmt520_set_no_entry_b(l_cmd)
            #160512-00004#2-add-(E)
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt018
            #add-point:ON CHANGE pmdt018 name="input.g.page1.pmdt018"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt063
            #add-point:BEFORE FIELD pmdt063 name="input.b.page1.pmdt063"
            #160519-00008#16-s
            SELECT imaf055 INTO l_imaf055 FROM imaf_t
             WHERE imafent = g_enterprise
               AND imafsite = g_site
               AND imaf001 = g_pmdt_d[l_ac].pmdt006  
            IF l_imaf055 <> '1' THEN
            #160519-00008#16-e                  
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_pmdt_d[l_ac].pmdt063 = ' '
               END IF  
            END IF #160519-00008#16
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt063
            
            #add-point:AFTER FIELD pmdt063 name="input.a.page1.pmdt063"
            #160316-00007#3---add--begin----
            IF l_imaf055 <> '1' THEN  #160519-00008#16          
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_pmdt_d[l_ac].pmdt063 = ' '
               END IF
            END IF  #160519-00008#16 
            IF (g_pmdt_d[l_ac].pmdt063 IS NOT NULL) AND (g_pmdt_d[l_ac].pmdt063 != g_pmdt_d_o.pmdt063 OR g_pmdt_d_o.pmdt063 IS NULL) THEN 
               
               #倉退時有輸入收貨單來源時，批號僅能輸入該收貨單的入庫批號，不可隨便輸
               LET l_n = 0
               IF g_argv[1] = '7' THEN  #倉退
                  LET l_pmds000 = '6'
               END IF
               IF g_argv[1] = '14' THEN  #委外倉退
                  LET l_pmds000 = '12'
               END IF
               IF g_argv[1] = '15' THEN  #重覆性生產倉退
                 LET l_pmds000 = '13'
               END IF
               
               SELECT COUNT(1) INTO l_n FROM pmds_t,pmdt_t 
                  WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno AND pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                    AND pmds000 = l_pmds000 AND pmdsstus = 'S'
                    
               IF l_n > 0 THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM pmds_t,pmdt_t,pmdu_t 
                     WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno 
                       AND pmdtent = pmduent AND pmdtdocno = pmdudocno AND pmdtseq = pmduseq
                       AND pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                       AND pmds000 = l_pmds000 AND pmdsstus = 'S' AND pmdu008 = g_pmdt_d[l_ac].pmdt018
                  IF l_n = 0 OR cl_null(l_n) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00629'
                     LET g_errparam.extend = g_pmdt_d[l_ac].pmdt063
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
                     NEXT FIELD pmdt063
                  END IF
               END IF
               
               #修改批號後，若是收貨單，則需同步更新製造批序號的庫儲批，若是驗退、入庫、倉退單，則詢問是否確認修改，若確認修改，則刪除原先的製造批序號資料，開窗重新挑選
               IF g_argv[1] MATCHES '[128934]' OR g_argv[1] = '20' 
                  OR g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN  #160407-00028#1 add
                  CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063)
                      RETURNING l_success
               END IF
               #160407-00028#1--mark---begin--
               ##驗退單、入庫單
               ##1、先判斷是否有收貨單，再判斷收貨單是否有維護製造批序號
               ##1.1 若有，則根據來再判斷當前料號是否走QC，若走QC，則批序號來源是qc單的，若不走，則來源收貨單
               ##1.2若收貨單沒有維護製造批序號，則入庫單、無收貨來源的倉退單可自行新增
               #IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
               #   SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmds006 AND inaoseq = g_pmdt_d[l_ac].pmdt028
               #   IF l_n > 0 THEN
               #      CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success ,l_n
               #      IF l_n > 0 THEN
               #         IF l_success THEN
               #            CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
               #            CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
               #            
               #            IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
               #               IF NOT s_apmt520_ins_inao('1',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
               #               END IF
               #            ELSE
               #               IF NOT s_apmt520_ins_inao('1',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
               #               END IF
               #            END IF
               #            CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'1',g_prog,'','','','','0')
               #                  RETURNING l_success
               #            CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
               #            CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
               #         ELSE
               #            LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
               #         END IF
               #      END IF
               #   ELSE
               #      IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
               #         CALL s_lot_upd_inao(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_site,g_pmdt_d[l_ac].pmdt063) 
               #             RETURNING l_success
               #      END IF
               #   END IF
               #END IF
               #160407-00028#1--end---
               
               #仓退单：若有指定收货单号：
               #   1)	收货单有维护制造批序号资料，只能挑选收货单制造批序号资料
               #   2)	收货单没有维护制造批序号资料，只能挑选收货单对应的入库单的资料
               #若没有指定收货单号则直接由库存档选取
               IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) AND g_pmdt_d[l_ac].pmdt017 IS NOT NULL THEN #160411-00017#1 add
                     IF g_pmdt_d[l_ac].pmdt063 != g_pmdt_d_o.pmdt063 THEN #160411-00017#1 add
                        CALL s_lot_inao_chk(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1,'2',g_site) RETURNING l_success,l_n
                        IF l_n > 0 THEN
                           IF l_success THEN
                              IF NOT cl_null(g_pmds_m.pmds006) THEN
                                 SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                                    WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                      AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                      AND pmdsent = g_enterprise 
                                      AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                         OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                      AND pmdsstus = 'S'
                                 IF l_n > 0 THEN
                                    CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                    CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    DECLARE sel_pmdt_cs13 CURSOR FOR
                                       SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                          WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                            AND pmdsent = g_enterprise 
                                            AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                               OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                            AND pmdsstus = 'S'
                                    FOREACH sel_pmdt_cs13 INTO l_pmdtdocno,l_pmdtseq_1
                                       IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                       END IF
                                    END FOREACH
                                    CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                       RETURNING l_success
                                    CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                    CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                                 END IF
                              ELSE
                                 CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                                 CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                    RETURNING l_success
                              END IF
                           ELSE
                              LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
                           END IF
                        END IF
                     #160411-00017#1---add--begin---
                     ELSE   
                        IF NOT cl_null(g_pmds_m.pmds006) THEN
                           SELECT COUNT(inaodocno) INTO l_n FROM inao_t,pmds_t,pmdt_t 
                              WHERE inaoent = pmdsent AND inaodocno = pmdsdocno AND inaoseq = pmdtseq
                                AND pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                AND pmdsent = g_enterprise 
                                AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                   OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                AND pmdsstus = 'S'
                           IF l_n > 0 THEN
                              CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                              CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              DECLARE sel_pmdt_cs9 CURSOR FOR
                                 SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                                    WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno
                                      AND pmdsent = g_enterprise 
                                      AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                         OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20')))
                                      AND pmdsstus = 'S'
                              FOREACH sel_pmdt_cs9 INTO l_pmdtdocno,l_pmdtseq_1
                                 IF NOT s_apmt520_ins_inao('1',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                                 END IF
                              END FOREACH
                              CALL s_lot_sel('2','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                                 RETURNING l_success
                              CALL s_apmt520_del_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                              CALL s_apmt520_upd_inao('1',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                           END IF
                        ELSE
                           CALL s_apmt520_del_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) RETURNING l_success
                           CALL s_lot_sel('1','2',g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'1',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,'-1',g_prog,'','','','','0')
                              RETURNING l_success
                        END IF
                     END IF
                  END IF
                  #160411-00017#1---add--end---
               END IF
               
            END IF  

            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063
            #160316-00007#3---add----end-----
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt063
            #add-point:ON CHANGE pmdt063 name="input.g.page1.pmdt063"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt072
            
            #add-point:AFTER FIELD pmdt072 name="input.a.page1.pmdt072"
            CALL s_desc_get_project_desc(g_pmdt_d[l_ac].pmdt072) RETURNING g_pmdt_d[l_ac].pmdt072_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt072_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt072) THEN 
#應用 a17 樣板自動產生(Version:2)
               IF g_pmdt_d[l_ac].pmdt072 != g_pmdt_d_o.pmdt072 OR cl_null(g_pmdt_d_o.pmdt072) THEN
                  #欄位存在檢查
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  #160318-00025#15 by 07900 --add-str 
                  LET g_errshow = TRUE #是否開窗
                  #160318-00025#15 by 07900 --add-end
                  
                  #設定g_chkparam.*的參數
                  LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt072
                  #160318-00025#15 by 07900 --add-str 
                  LET g_chkparam.err_str[1] ="apj-00012:sub-01302|apjm200|",cl_get_progname("apjm200",g_lang,"2"),"|:EXEPROGapjm200"
                  #160318-00025#15 by 07900 --add-end 
                  
                  #呼叫檢查存在並帶值的library
                  IF NOT cl_chk_exist("v_pjba001") THEN
                     #檢查失敗時後續處理
                     LET g_pmdt_d[l_ac].pmdt072 = g_pmdt_d_o.pmdt072
                     CALL s_desc_get_project_desc(g_pmdt_d[l_ac].pmdt072) RETURNING g_pmdt_d[l_ac].pmdt072_desc
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt072_desc
                     NEXT FIELD CURRENT
                  END IF
                  LET g_pmdt_d[l_ac].pmdt073 = ''
                  LET g_pmdt_d[l_ac].pmdt073_desc = ''
                  LET g_pmdt_d[l_ac].pmdt074 = ''
                  LET g_pmdt_d[l_ac].pmdt074_desc = ''
               END IF

            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt072
            #add-point:BEFORE FIELD pmdt072 name="input.b.page1.pmdt072"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt072
            #add-point:ON CHANGE pmdt072 name="input.g.page1.pmdt072"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt073
            
            #add-point:AFTER FIELD pmdt073 name="input.a.page1.pmdt073"
            CALL s_desc_get_wbs_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073) RETURNING g_pmdt_d[l_ac].pmdt073_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt073_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt073) THEN 
#應用 a17 樣板自動產生(Version:2)
               #欄位存在檢查
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL

               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt072
               LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt073
                  
               #呼叫檢查存在並帶值的library
               IF NOT cl_chk_exist("v_pjbb002") THEN
                  #檢查失敗時後續處理
                  LET g_pmdt_d[l_ac].pmdt073 = g_pmdt_d_t.pmdt073
                  CALL s_desc_get_wbs_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073) RETURNING g_pmdt_d[l_ac].pmdt073_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt073_desc
                  NEXT FIELD CURRENT
               END IF

            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt073
            #add-point:BEFORE FIELD pmdt073 name="input.b.page1.pmdt073"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt073
            #add-point:ON CHANGE pmdt073 name="input.g.page1.pmdt073"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt074
            
            #add-point:AFTER FIELD pmdt074 name="input.a.page1.pmdt074"
            CALL s_desc_get_activity_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt074) RETURNING g_pmdt_d[l_ac].pmdt074_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt074_desc

            IF NOT cl_null(g_pmdt_d[l_ac].pmdt074) THEN 
#應用 a17 樣板自動產生(Version:2)
               #欄位存在檢查
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL

               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt072
               LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt074
                  
               #呼叫檢查存在並帶值的library
               IF NOT cl_chk_exist("v_pjbm002") THEN
                  #檢查失敗時後續處理
                  LET g_pmdt_d[l_ac].pmdt074 = g_pmdt_d_t.pmdt074
                  CALL s_desc_get_activity_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt074) RETURNING g_pmdt_d[l_ac].pmdt074_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt074_desc
                  NEXT FIELD CURRENT
               END IF
            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt074
            #add-point:BEFORE FIELD pmdt074 name="input.b.page1.pmdt074"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt074
            #add-point:ON CHANGE pmdt074 name="input.g.page1.pmdt074"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt075
            
            #add-point:AFTER FIELD pmdt075 name="input.a.page1.pmdt075"
            #add--2015/08/31 By shiun--(S)
            LET g_pmdt_d[l_ac].pmdt075_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt075_desc
            
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt075) THEN
               CALL apmt520_detail_abg('2')
                    RETURNING l_success,l_errno,l_bgaf016,l_pmdt075,l_pmdt075_desc
               LET g_pmdt_d[l_ac].pmdt075_desc = l_pmdt075_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt075_desc
               
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = l_errno
                  LET g_errparam.extend = g_pmdt_d[l_ac].pmdt075
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  
                  LET g_pmdt_d[l_ac].pmdt075 = g_pmdt_d_t.pmdt075
                  CALL apmt520_detail_abg('3')
                       RETURNING l_success,l_errno,l_bgaf016,l_pmdt075,l_pmdt075_desc
                  LET g_pmdt_d[l_ac].pmdt075_desc = l_pmdt075_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt075,g_pmdt_d[l_ac].pmdt075_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            #add--2015/08/31 By shiun--(E)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt075
            #add-point:BEFORE FIELD pmdt075 name="input.b.page1.pmdt075"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt075
            #add-point:ON CHANGE pmdt075 name="input.g.page1.pmdt075"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt075_desc
            #add-point:BEFORE FIELD pmdt075_desc name="input.b.page1.pmdt075_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt075_desc
            
            #add-point:AFTER FIELD pmdt075_desc name="input.a.page1.pmdt075_desc"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt075_desc
            #add-point:ON CHANGE pmdt075_desc name="input.g.page1.pmdt075_desc"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt051
            
            #add-point:AFTER FIELD pmdt051 name="input.a.page1.pmdt051"
            CALL s_desc_get_acc_desc(g_acc,g_pmdt_d[l_ac].pmdt051) RETURNING g_pmdt_d[l_ac].pmdt051_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt051_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt051) THEN
               IF NOT apmt520_pmdt051_chk(g_pmdt_d[l_ac].pmdt051) THEN
                  LET g_pmdt_d[l_ac].pmdt051 = g_pmdt_d_t.pmdt051               
                  CALL s_desc_get_acc_desc(g_acc,g_pmdt_d[l_ac].pmdt051) RETURNING g_pmdt_d[l_ac].pmdt051_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt051_desc
                  NEXT FIELD pmdt051
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt051
            #add-point:BEFORE FIELD pmdt051 name="input.b.page1.pmdt051"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt051
            #add-point:ON CHANGE pmdt051 name="input.g.page1.pmdt051"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt070
            #add-point:BEFORE FIELD pmdt070 name="input.b.page1.pmdt070"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt070
            
            #add-point:AFTER FIELD pmdt070 name="input.a.page1.pmdt070"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt070
            #add-point:ON CHANGE pmdt070 name="input.g.page1.pmdt070"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt071
            #add-point:BEFORE FIELD pmdt071 name="input.b.page1.pmdt071"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt071
            
            #add-point:AFTER FIELD pmdt071 name="input.a.page1.pmdt071"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt071
            #add-point:ON CHANGE pmdt071 name="input.g.page1.pmdt071"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt059
            #add-point:BEFORE FIELD pmdt059 name="input.b.page1.pmdt059"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt059
            
            #add-point:AFTER FIELD pmdt059 name="input.a.page1.pmdt059"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt059
            #add-point:ON CHANGE pmdt059 name="input.g.page1.pmdt059"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt053
            #add-point:BEFORE FIELD pmdt053 name="input.b.page1.pmdt053"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt053
            
            #add-point:AFTER FIELD pmdt053 name="input.a.page1.pmdt053"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt053
            #add-point:ON CHANGE pmdt053 name="input.g.page1.pmdt053"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt054
            #add-point:BEFORE FIELD pmdt054 name="input.b.page1.pmdt054"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt054
            
            #add-point:AFTER FIELD pmdt054 name="input.a.page1.pmdt054"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt054
            #add-point:ON CHANGE pmdt054 name="input.g.page1.pmdt054"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt055
            #add-point:BEFORE FIELD pmdt055 name="input.b.page1.pmdt055"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt055
            
            #add-point:AFTER FIELD pmdt055 name="input.a.page1.pmdt055"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt055
            #add-point:ON CHANGE pmdt055 name="input.g.page1.pmdt055"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt060
            #add-point:BEFORE FIELD pmdt060 name="input.b.page1.pmdt060"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt060
            
            #add-point:AFTER FIELD pmdt060 name="input.a.page1.pmdt060"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt060
            #add-point:ON CHANGE pmdt060 name="input.g.page1.pmdt060"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt061
            #add-point:BEFORE FIELD pmdt061 name="input.b.page1.pmdt061"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt061
            
            #add-point:AFTER FIELD pmdt061 name="input.a.page1.pmdt061"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt061
            #add-point:ON CHANGE pmdt061 name="input.g.page1.pmdt061"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt042
            #add-point:BEFORE FIELD pmdt042 name="input.b.page1.pmdt042"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt042
            
            #add-point:AFTER FIELD pmdt042 name="input.a.page1.pmdt042"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt042
            #add-point:ON CHANGE pmdt042 name="input.g.page1.pmdt042"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt043
            #add-point:BEFORE FIELD pmdt043 name="input.b.page1.pmdt043"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt043
            
            #add-point:AFTER FIELD pmdt043 name="input.a.page1.pmdt043"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt043
            #add-point:ON CHANGE pmdt043 name="input.g.page1.pmdt043"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt048
            #add-point:BEFORE FIELD pmdt048 name="input.b.page1.pmdt048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt048
            
            #add-point:AFTER FIELD pmdt048 name="input.a.page1.pmdt048"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt048
            #add-point:ON CHANGE pmdt048 name="input.g.page1.pmdt048"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt044
            #add-point:BEFORE FIELD pmdt044 name="input.b.page1.pmdt044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt044
            
            #add-point:AFTER FIELD pmdt044 name="input.a.page1.pmdt044"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt044
            #add-point:ON CHANGE pmdt044 name="input.g.page1.pmdt044"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt045
            #add-point:BEFORE FIELD pmdt045 name="input.b.page1.pmdt045"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt045
            
            #add-point:AFTER FIELD pmdt045 name="input.a.page1.pmdt045"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt045
            #add-point:ON CHANGE pmdt045 name="input.g.page1.pmdt045"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt049
            #add-point:BEFORE FIELD pmdt049 name="input.b.page1.pmdt049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt049
            
            #add-point:AFTER FIELD pmdt049 name="input.a.page1.pmdt049"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt049
            #add-point:ON CHANGE pmdt049 name="input.g.page1.pmdt049"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt050
            #add-point:BEFORE FIELD pmdt050 name="input.b.page1.pmdt050"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt050
            
            #add-point:AFTER FIELD pmdt050 name="input.a.page1.pmdt050"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt050
            #add-point:ON CHANGE pmdt050 name="input.g.page1.pmdt050"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt084
            #add-point:BEFORE FIELD pmdt084 name="input.b.page1.pmdt084"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt084
            
            #add-point:AFTER FIELD pmdt084 name="input.a.page1.pmdt084"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt084
            #add-point:ON CHANGE pmdt084 name="input.g.page1.pmdt084"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt219
            #add-point:BEFORE FIELD pmdt219 name="input.b.page1.pmdt219"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt219
            
            #add-point:AFTER FIELD pmdt219 name="input.a.page1.pmdt219"
            #160512-00004#2-add-(S)
            IF NOT apmt520_pmdt219_pmdt089_chk(g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089) THEN
               LET g_pmdt_d[l_ac].pmdt219 = g_pmdt_d_o.pmdt219
               NEXT FIELD CURRENT
            END IF
            LET g_pmdt_d_o.pmdt219 = g_pmdt_d[l_ac].pmdt219
            #160512-00004#2-add-(E)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt219
            #add-point:ON CHANGE pmdt219 name="input.g.page1.pmdt219"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt089
            #add-point:BEFORE FIELD pmdt089 name="input.b.page1.pmdt089"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt089
            
            #add-point:AFTER FIELD pmdt089 name="input.a.page1.pmdt089"
            #160512-00004#2-add-(S)
            IF NOT apmt520_pmdt219_pmdt089_chk(g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089) THEN
               LET g_pmdt_d[l_ac].pmdt089 = g_pmdt_d_o.pmdt089
               NEXT FIELD CURRENT
            END IF
            LET g_pmdt_d_o.pmdt089 = g_pmdt_d[l_ac].pmdt089
            #160512-00004#2-add-(E)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt089
            #add-point:ON CHANGE pmdt089 name="input.g.page1.pmdt089"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt088
            #add-point:BEFORE FIELD pmdt088 name="input.b.page1.pmdt088"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt088
            
            #add-point:AFTER FIELD pmdt088 name="input.a.page1.pmdt088"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt088
            #add-point:ON CHANGE pmdt088 name="input.g.page1.pmdt088"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD ooff013
            #add-point:BEFORE FIELD ooff013 name="input.b.page1.ooff013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD ooff013
            
            #add-point:AFTER FIELD ooff013 name="input.a.page1.ooff013"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE ooff013
            #add-point:ON CHANGE ooff013 name="input.g.page1.ooff013"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page1.pmdtsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtsite
            #add-point:ON ACTION controlp INFIELD pmdtsite name="input.c.page1.pmdtsite"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdtseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtseq
            #add-point:ON ACTION controlp INFIELD pmdtseq name="input.c.page1.pmdtseq"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt027
            #add-point:ON ACTION controlp INFIELD pmdt027 name="input.c.page1.pmdt027"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt027             #給予default值
            
            #驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            
           #委外驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] = '10' THEN   #委外驗退
               LET g_qryparam.arg1 = "('8')"
               CALL q_pmdsdocno() 
            END IF
            IF g_argv[1] = '12' THEN   #委外入庫
               LET g_qryparam.arg1 = "('8')"
               LET g_qryparam.where = " (pmdt053 - pmdt054 > 0) "
               CALL q_pmdsdocno() 
            END IF
            IF g_argv[1] = '14' THEN   #委外倉退
               LET g_qryparam.arg1 = "('8')"
               LET g_qryparam.where = " pmdt054 > 0 "
               CALL q_pmdsdocno() 
            END IF
            #重覆性生產驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] = '11' THEN   #重覆性驗退
               LET g_qryparam.arg1 = "('9')"
               CALL q_pmdsdocno() 
            END IF
            IF g_argv[1] = '13' THEN   #重覆性入庫
               LET g_qryparam.arg1 = "('9')"
               LET g_qryparam.where = " (pmdt053 - pmdt054 > 0 ) "
               CALL q_pmdsdocno() 
            END IF
            IF g_argv[1] = '15' THEN   #重覆性倉退
               LET g_qryparam.arg1 = "('9')"
               LET g_qryparam.where = " pmdt054 > 0 "
               CALL q_pmdsdocno() 
            END IF
            
            LET g_pmdt_d[l_ac].pmdt027 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt027 TO pmdt027              #顯示到畫面上

            NEXT FIELD pmdt027                          #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt028
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt028
            #add-point:ON ACTION controlp INFIELD pmdt028 name="input.c.page1.pmdt028"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt028             #給予default值
            
            #驗退、入庫、倉退時開窗開收貨單號對應的項次
            IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14' OR g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
               LET g_qryparam.arg1 = g_pmds_m.pmds006           
               CALL q_pmdtseq()                           #呼叫開窗
               LET g_pmdt_d[l_ac].pmdt028 = g_qryparam.return1              #將開窗取得的值回傳到變數
               DISPLAY g_pmdt_d[l_ac].pmdt028 TO pmdt028              #顯示到畫面上
            END IF
            
            NEXT FIELD pmdt028                          #返回原欄位
                               
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt001
            #add-point:ON ACTION controlp INFIELD pmdt001 name="input.c.page1.pmdt001"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt001             #給予default值
            
            #採購收貨時開窗開採購單號
			   IF g_argv[1] MATCHES '[13]' THEN
               LET g_qryparam.where = " pmdl005 NOT IN ('2','5','6') AND pmdl004 = '",g_pmds_m.pmds007,"' "
               CALL q_pmdldocno_7()                           #呼叫開窗
            END IF
            IF g_argv[1] = '8' OR g_argv[1] = '20' THEN   #委外採購
               LET g_qryparam.where = " pmdl005 ='2' AND pmdl004 = '",g_pmds_m.pmds007,"' " 
               CALL q_pmdldocno_7() 
            END IF
            IF g_argv[1] = '9' THEN   #重覆性生產採購
               LET g_qryparam.where = " pmdl005 ='5' AND pmdl004 = '",g_pmds_m.pmds007,"' "
               CALL q_pmdldocno_7() 
            END IF
            IF g_argv[1] = '23' OR g_argv[1] = '24' THEN   #委外採購
               LET g_qryparam.where = " pmdl005 ='6' AND pmdl004 = '",g_pmds_m.pmds007,"' " 
               CALL q_pmdldocno_7() 
            END IF
            
            
            LET g_pmdt_d[l_ac].pmdt001 = g_qryparam.return1              #將開窗取得的值回傳到變數        
            DISPLAY g_pmdt_d[l_ac].pmdt001 TO pmdt001              #顯示到畫面上
            LET g_pmdt_d[l_ac].pmdt002 = g_qryparam.return2 #161102-00064#1 add by tangyi 161103
            DISPLAY g_pmdt_d[l_ac].pmdt002 TO pmdt002       #161102-00064#1 add by tangyi 161103    
            
            NEXT FIELD pmdt001                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt002
            #add-point:ON ACTION controlp INFIELD pmdt002 name="input.c.page1.pmdt002"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt002             #給予default值
            
            #採購收貨時開窗開採購單號對應的項次
			   IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
               LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt001
               CALL q_pmdoseq()                           #呼叫開窗
               LET g_pmdt_d[l_ac].pmdt002 = g_qryparam.return1              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt003 = g_qryparam.return2              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt004 = g_qryparam.return3              #將開窗取得的值回傳到變數
               DISPLAY g_pmdt_d[l_ac].pmdt002 TO pmdt002              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt003 TO pmdt003              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt004 TO pmdt004              #顯示到畫面上
            END IF
            
            NEXT FIELD pmdt002                          #返回原欄位
                                         
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt003
            #add-point:ON ACTION controlp INFIELD pmdt003 name="input.c.page1.pmdt003"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt004
            #add-point:ON ACTION controlp INFIELD pmdt004 name="input.c.page1.pmdt004"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt081
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt081
            #add-point:ON ACTION controlp INFIELD pmdt081 name="input.c.page1.pmdt081"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt081             #給予default值
            LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt082
            LET g_qryparam.arg1 = g_ooef025
            
            LET g_qryparam.where = " qcba001 = '",g_pmds_m.pmds006,"' AND qcba002 = '",g_pmdt_d[l_ac].pmdt028,"' "
           
            IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
               LET g_qryparam.where = g_qryparam.where , " AND (qcbc009 - qcbc010) > 0  "
            END IF
            
            CALL q_qcbcdocno()                           #呼叫開窗
            
            LET g_pmdt_d[l_ac].pmdt081 = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_pmdt_d[l_ac].pmdt082 = g_qryparam.return2

            DISPLAY g_pmdt_d[l_ac].pmdt081 TO pmdt081              #顯示到畫面上
            DISPLAY g_pmdt_d[l_ac].pmdt082 TO pmdt082 
            CALL apmt520_pmdt083_ref(g_pmdt_d[l_ac].pmdt083) RETURNING g_pmdt_d[l_ac].pmdt083_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt083_desc
            NEXT FIELD pmdt081                          #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt082
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt082
            #add-point:ON ACTION controlp INFIELD pmdt082 name="input.c.page1.pmdt082"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt081             #給予default值
            LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt082
            LET g_qryparam.arg1 = g_ooef025
            LET g_qryparam.where = " qcba001 = '",g_pmds_m.pmds006,"' AND qcba002 = '",g_pmdt_d[l_ac].pmdt028,"' "
            IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
               LET g_qryparam.where = g_qryparam.where , " AND (qcbc009 - qcbc010) > 0  "
            END IF
            
            CALL q_qcbcdocno()                           #呼叫開窗
            
            LET g_pmdt_d[l_ac].pmdt081 = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_pmdt_d[l_ac].pmdt082 = g_qryparam.return2

            DISPLAY g_pmdt_d[l_ac].pmdt081 TO pmdt081              #顯示到畫面上
            DISPLAY g_pmdt_d[l_ac].pmdt082 TO pmdt082 
            CALL apmt520_pmdt083_ref(g_pmdt_d[l_ac].pmdt083) RETURNING g_pmdt_d[l_ac].pmdt083_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt083_desc

            NEXT FIELD pmdt082                         #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt083
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt083
            #add-point:ON ACTION controlp INFIELD pmdt083 name="input.c.page1.pmdt083"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt083             #給予default值
           
            #給予arg
            LET g_qryparam.arg1 = g_ooef025

            
            CALL q_qcao002_1()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt083 = g_qryparam.return1              
             
            DISPLAY g_pmdt_d[l_ac].pmdt083 TO pmdt083              #
            
            NEXT FIELD pmdt083                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt005
            #add-point:ON ACTION controlp INFIELD pmdt005 name="input.c.page1.pmdt005"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt006
            #add-point:ON ACTION controlp INFIELD pmdt006 name="input.c.page1.pmdt006"
                                                #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
			   
			   #倉退时，開有庫存的庫位
            IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26'THEN
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt006
               LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt007
               LET g_qryparam.default3 = g_pmdt_d[l_ac].pmdt016             #給予default
               LET g_qryparam.default4 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.default5 = g_pmdt_d[l_ac].pmdt018
               LET g_qryparam.default6 = g_pmdt_d[l_ac].pmdt063
               
               CALL q_inag001_3() 
            
			      LET g_pmdt_d[l_ac].pmdt006 = g_qryparam.return1
			      LET g_pmdt_d[l_ac].pmdt007 = g_qryparam.return2
			      LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return3              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return4              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return5              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return6
               
               DISPLAY g_pmdt_d[l_ac].pmdt006 TO pmdt006
               DISPLAY g_pmdt_d[l_ac].pmdt007 TO pmdt007
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063 
               
               CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
           
               CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
			   ELSE
			      LET g_qryparam.where = " 1=1"
			      LET l_sql = " 1=1"
               #單據別的產品生命週期
               CALL s_control_get_doc_sql("imaf016",g_pmds_m.pmdsdocno,'4') RETURNING l_success,l_sql
               IF l_success THEN
                  IF cl_null(l_sql) THEN
                     LET l_sql = " 1=1"
                  END IF
                  LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
               END IF
               LET l_sql = " 1=1"
               #單據別的產品分類
               CALL s_control_get_doc_sql("imaa009",g_pmds_m.pmdsdocno,'5') RETURNING l_success,l_sql
               IF l_success THEN
                  IF cl_null(l_sql) THEN
                     LET l_sql = " 1=1"
                  END IF
                  LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
               END IF
               
               #160606-00013#1---s
			      #当委外采购来源工单有联产品，子件特性要可以修改为联产品，然后料件可以输入联产品料号
               IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' AND g_pmdt_d[l_ac].pmdt005 = '12' THEN
                  SELECT pmdp003 INTO l_pmdp003 FROM pmdp_t WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdt_d[l_ac].pmdt001 AND pmdpseq = g_pmdt_d[l_ac].pmdt002 
                  LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt006
                  LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt007
                  
                  LET g_qryparam.arg1 = l_pmdp003
                  LET g_qryparam.arg2 = '2'
                  CALL q_sfac001() 
            
			         LET g_pmdt_d[l_ac].pmdt006 = g_qryparam.return1
			         LET g_pmdt_d[l_ac].pmdt007 = g_qryparam.return2
                  
                  DISPLAY g_pmdt_d[l_ac].pmdt006 TO pmdt006
                  DISPLAY g_pmdt_d[l_ac].pmdt007 TO pmdt007
                  CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
               ELSE
               #160606-00013#1---e               
                  LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt006             #給予default值
                  
                  #給予arg
                  
                  CALL q_imaf001_15()                                #呼叫開窗
                  
                  LET g_pmdt_d[l_ac].pmdt006 = g_qryparam.return1              #將開窗取得的值回傳到變數
               END IF #160606-00013#1
            END IF
            
            DISPLAY g_pmdt_d[l_ac].pmdt006 TO pmdt006              #顯示到畫面上
            CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2

            NEXT FIELD pmdt006                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt007
            #add-point:ON ACTION controlp INFIELD pmdt007 name="input.c.page1.pmdt007"
            LET l_imaa005 = ''
            CALL apmt520_get_imaa005(g_enterprise,g_pmdt_d[l_ac].pmdt006) RETURNING l_imaa005
               
            IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'Y' AND NOT cl_null(l_imaa005) THEN
               IF g_argv[1] MATCHES '[24]' THEN  #無採購(來源)單據時，和正常新增一樣
                  IF l_cmd = 'a' THEN            
                     CALL l_inam.clear()            
                     CALL s_feature(l_cmd,g_pmdt_d[l_ac].pmdt006,'','',g_site,g_pmds_m.pmdsdocno) RETURNING l_success,l_inam
                     LET g_pmdt_d[l_ac].pmdt007 = l_inam[1].inam002
                     LET g_pmdt_d[l_ac].pmdt020 = l_inam[1].inam004
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt020
                     
                     #計算參考數量
                     IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) THEN
                        #CALL s_aimi190_get_convert(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021) RETURNING l_success,l_rate
                        #LET g_pmdt_d[l_ac].pmdt022 = g_pmdt_d[l_ac].pmdt020 * l_rate
                        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                                         RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                     END IF
                     
                     #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
                     #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
                     IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN  #體參數使用採購計價單位
                        #CALL s_aimi190_get_convert(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023) RETURNING l_success,l_rate
                        #LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020 * l_rate
                        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                         RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                     ELSE
                        LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                        LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020            
                     END IF
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt024
                     
                  END IF
               ELSE
                  CALL s_feature_single(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_site,g_pmds_m.pmdsdocno)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt007
                  CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007
               END IF
               
               IF l_cmd = 'u' THEN
                  CALL s_feature_single(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_site,g_pmds_m.pmdsdocno)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt007
                  CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007
               END IF
            END IF                                       
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt009
            #add-point:ON ACTION controlp INFIELD pmdt009 name="input.c.page1.pmdt009"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt009             #給予default值
            LET g_qryparam.default2 = "" #g_pmdn_d[l_ac].oocq010 #參考欄位七

            #給予arg
            LET g_qryparam.arg1 = "221" #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt009 = g_qryparam.return1              #將開窗取得的值回傳到變數
            #LET g_pmdn_d[l_ac].oocq010 = g_qryparam.return2 #參考欄位七

            DISPLAY g_pmdt_d[l_ac].pmdt009 TO pmdt009              #顯示到畫面上
            #DISPLAY g_pmdn_d[l_ac].oocq010 TO oocq010 #參考欄位七

            NEXT FIELD pmdt009                          #返回原欄位
                                                        
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt010
            #add-point:ON ACTION controlp INFIELD pmdt010 name="input.c.page1.pmdt010"
           
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt025
            #add-point:ON ACTION controlp INFIELD pmdt025 name="input.c.page1.pmdt025"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt011
            #add-point:ON ACTION controlp INFIELD pmdt011 name="input.c.page1.pmdt011"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt019
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt019
            #add-point:ON ACTION controlp INFIELD pmdt019 name="input.c.page1.pmdt019"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt019             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
            CALL q_imao002()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt019 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt019 TO pmdt019              #顯示到畫面上
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc

            NEXT FIELD pmdt019                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt020
            #add-point:ON ACTION controlp INFIELD pmdt020 name="input.c.page1.pmdt020"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt021
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt021
            #add-point:ON ACTION controlp INFIELD pmdt021 name="input.c.page1.pmdt021"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt021             #給予default值

            #給予arg

            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
            CALL q_imao002()                                  #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt021 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt021 TO pmdt021              #顯示到畫面上
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc

            NEXT FIELD pmdt021                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt022
            #add-point:ON ACTION controlp INFIELD pmdt022 name="input.c.page1.pmdt022"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt008
            #add-point:ON ACTION controlp INFIELD pmdt008 name="input.c.page1.pmdt008"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt008             #給予default值

            #給予arg

            CALL q_imaf001_5()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt008 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt008 TO pmdt008              #顯示到畫面上

            NEXT FIELD pmdt008                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt023
            #add-point:ON ACTION controlp INFIELD pmdt023 name="input.c.page1.pmdt023"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt023             #給予default值

            #給予arg

            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
            CALL q_imao002()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt023 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt023 TO pmdt023              #顯示到畫面上
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc

            NEXT FIELD pmdt023                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt024
            #add-point:ON ACTION controlp INFIELD pmdt024 name="input.c.page1.pmdt024"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt090
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt090
            #add-point:ON ACTION controlp INFIELD pmdt090 name="input.c.page1.pmdt090"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt091
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt091
            #add-point:ON ACTION controlp INFIELD pmdt091 name="input.c.page1.pmdt091"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt036
            #add-point:ON ACTION controlp INFIELD pmdt036 name="input.c.page1.pmdt036"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt046
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt046
            #add-point:ON ACTION controlp INFIELD pmdt046 name="input.c.page1.pmdt046"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt046             #給予default值

            #給予arg

            CALL q_oodb002_2()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt046 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt046 TO pmdt046              #顯示到畫面上

            NEXT FIELD pmdt046                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt037
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt037
            #add-point:ON ACTION controlp INFIELD pmdt037 name="input.c.page1.pmdt037"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt038
            #add-point:ON ACTION controlp INFIELD pmdt038 name="input.c.page1.pmdt038"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt039
            #add-point:ON ACTION controlp INFIELD pmdt039 name="input.c.page1.pmdt039"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt047
            #add-point:ON ACTION controlp INFIELD pmdt047 name="input.c.page1.pmdt047"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt092
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt092
            #add-point:ON ACTION controlp INFIELD pmdt092 name="input.c.page1.pmdt092"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt093
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt093
            #add-point:ON ACTION controlp INFIELD pmdt093 name="input.c.page1.pmdt093"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt026
            #add-point:ON ACTION controlp INFIELD pmdt026 name="input.c.page1.pmdt026"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt041
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt041
            #add-point:ON ACTION controlp INFIELD pmdt041 name="input.c.page1.pmdt041"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt062
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt062
            #add-point:ON ACTION controlp INFIELD pmdt062 name="input.c.page1.pmdt062"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt016
            #add-point:ON ACTION controlp INFIELD pmdt016 name="input.c.page1.pmdt016"
                                                #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt016             #給予default值

            #給予arg
            #倉退时，開有庫存的庫位
            IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
               LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdt007
               
               #160801-00043#1--s
               IF NOT cl_null(g_bas_0043) THEN  #VMI存貨庫位Tag
                  IF g_pmds_m.pmds011 = '3' THEN   #VMI采购
                     LET g_qryparam.where = " inag004 IN (SELECT inac001 FROM inac_t WHERE inacent = '",g_enterprise,"' AND inacsite = '",g_site,"' AND inac003 = '",g_bas_0043,"') "
                  ELSE
                     LET g_qryparam.where = " inag004 NOT IN (SELECT inac001 FROM inac_t WHERE inacent = '",g_enterprise,"' AND inacsite = '",g_site,"' AND inac003 = '",g_bas_0043,"') "
                  END IF
               END IF
               #160801-00043#1--e
               
               CALL q_inag004_13()  
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return2              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return3              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return4
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063 
               
               CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            ELSE
               #160801-00043#1--s
               IF NOT cl_null(g_bas_0043) THEN  #VMI存貨庫位Tag
                  IF g_pmds_m.pmds011 = '3' THEN   #VMI采购
                     LET g_qryparam.where = " inaa001 IN (SELECT inac001 FROM inac_t WHERE inacent = '",g_enterprise,"' AND inacsite = '",g_site,"' AND inac003 = '",g_bas_0043,"') "
                  ELSE
                     LET g_qryparam.where = " inaa001 NOT IN (SELECT inac001 FROM inac_t WHERE inacent = '",g_enterprise,"' AND inacsite = '",g_site,"' AND inac003 = '",g_bas_0043,"') "
                  END IF
               END IF
               #160801-00043#1--e
               
               CALL q_inaa001_2()                                #呼叫開窗
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1              #將開窗取得的值回傳到變數
               
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016              #顯示到畫面上
            END IF
            
            CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
            
            NEXT FIELD pmdt016                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt017
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt017
            #add-point:ON ACTION controlp INFIELD pmdt017 name="input.c.page1.pmdt017"
                                                #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            #倉退时，開有庫存的庫位
            IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt016             #給予default
               LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.default3 = g_pmdt_d[l_ac].pmdt018
               LET g_qryparam.default4 = g_pmdt_d[l_ac].pmdt063
            
               LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdt007
               
               CALL q_inag004_13() 
                              
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return2              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return3              #將開窗取得的值回傳到變數
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return4
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018              #顯示到畫面上
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063 
               
               CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            ELSE
               
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt017
               #給予arg
               LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt016
               
               CALL q_inab002_3()                                #呼叫開窗
               
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return1              #將開窗取得的值回傳到變數
               
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017              #顯示到畫面上
               
            END IF
           
            CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            

            NEXT FIELD pmdt017                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt018
            #add-point:ON ACTION controlp INFIELD pmdt018 name="input.c.page1.pmdt018"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt063
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt063
            #add-point:ON ACTION controlp INFIELD pmdt063 name="input.c.page1.pmdt063"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt072
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt072
            #add-point:ON ACTION controlp INFIELD pmdt072 name="input.c.page1.pmdt072"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt072             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #s


            CALL q_pjba001()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt072 = g_qryparam.return1              

            DISPLAY g_pmdt_d[l_ac].pmdt072 TO pmdt072              #
            CALL s_desc_get_project_desc(g_pmdt_d[l_ac].pmdt072) RETURNING g_pmdt_d[l_ac].pmdt072_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt072_desc

            NEXT FIELD pmdt072                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt073
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt073
            #add-point:ON ACTION controlp INFIELD pmdt073 name="input.c.page1.pmdt073"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt073             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt072 #s


            CALL q_pjbb002_1()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt073 = g_qryparam.return1              

            DISPLAY g_pmdt_d[l_ac].pmdt073 TO pmdt073              #
            CALL s_desc_get_wbs_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073) RETURNING g_pmdt_d[l_ac].pmdt073_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt073_desc

            NEXT FIELD pmdt073                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt074
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt074
            #add-point:ON ACTION controlp INFIELD pmdt074 name="input.c.page1.pmdt074"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt074             #給予default值

            #給予arg
            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt072 #s


            CALL q_pjbm002()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt074 = g_qryparam.return1              

            DISPLAY g_pmdt_d[l_ac].pmdt074 TO pmdt074              #
            CALL s_desc_get_activity_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt074) RETURNING g_pmdt_d[l_ac].pmdt074_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt074_desc

            NEXT FIELD pmdt074                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt075
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt075
            #add-point:ON ACTION controlp INFIELD pmdt075 name="input.c.page1.pmdt075"
            #add--2015/08/31 By shiun--(S)
            CALL apmt520_detail_abg('1')
                 RETURNING l_success,l_errno,l_bgaf016,l_pmdt075,l_pmdt075_desc
            LET g_pmdt_d[l_ac].pmdt075 = l_pmdt075
            LET g_pmdt_d[l_ac].pmdt075_desc = l_pmdt075_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt075,g_pmdt_d[l_ac].pmdt075_desc
            #add--2015/08/31 By shiun--(E)
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt075_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt075_desc
            #add-point:ON ACTION controlp INFIELD pmdt075_desc name="input.c.page1.pmdt075_desc"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt051
            #add-point:ON ACTION controlp INFIELD pmdt051 name="input.c.page1.pmdt051"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt051             #給予default值

            LET g_qryparam.where = "1=1 "
            
            LET l_sql = ''
            CALL s_control_get_doc_sql("oocq002",g_pmds_m.pmdsdocno,'8') RETURNING l_success,l_sql
            IF l_success THEN
               IF cl_null(l_sql) THEN
                  LET l_sql = " 1=1"
               END IF
               LET g_qryparam.where = g_qryparam.where ," AND ",l_sql
            END IF
            
            #給予arg
            LET g_qryparam.arg1 = g_acc #

            CALL q_oocq002()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt051 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt051 TO pmdt051              #顯示到畫面上
            #160805-00015#1--s
            CALL s_desc_get_acc_desc(g_acc,g_pmdt_d[l_ac].pmdt051) RETURNING g_pmdt_d[l_ac].pmdt051_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt051_desc
            #160805-00015#1--e

            NEXT FIELD pmdt051                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt070
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt070
            #add-point:ON ACTION controlp INFIELD pmdt070 name="input.c.page1.pmdt070"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt071
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt071
            #add-point:ON ACTION controlp INFIELD pmdt071 name="input.c.page1.pmdt071"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt059
            #add-point:ON ACTION controlp INFIELD pmdt059 name="input.c.page1.pmdt059"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt053
            #add-point:ON ACTION controlp INFIELD pmdt053 name="input.c.page1.pmdt053"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt054
            #add-point:ON ACTION controlp INFIELD pmdt054 name="input.c.page1.pmdt054"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt055
            #add-point:ON ACTION controlp INFIELD pmdt055 name="input.c.page1.pmdt055"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt060
            #add-point:ON ACTION controlp INFIELD pmdt060 name="input.c.page1.pmdt060"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt061
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt061
            #add-point:ON ACTION controlp INFIELD pmdt061 name="input.c.page1.pmdt061"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt042
            #add-point:ON ACTION controlp INFIELD pmdt042 name="input.c.page1.pmdt042"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt043
            #add-point:ON ACTION controlp INFIELD pmdt043 name="input.c.page1.pmdt043"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt048
            #add-point:ON ACTION controlp INFIELD pmdt048 name="input.c.page1.pmdt048"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt044
            #add-point:ON ACTION controlp INFIELD pmdt044 name="input.c.page1.pmdt044"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt045
            #add-point:ON ACTION controlp INFIELD pmdt045 name="input.c.page1.pmdt045"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt049
            #add-point:ON ACTION controlp INFIELD pmdt049 name="input.c.page1.pmdt049"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt050
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt050
            #add-point:ON ACTION controlp INFIELD pmdt050 name="input.c.page1.pmdt050"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt084
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt084
            #add-point:ON ACTION controlp INFIELD pmdt084 name="input.c.page1.pmdt084"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt219
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt219
            #add-point:ON ACTION controlp INFIELD pmdt219 name="input.c.page1.pmdt219"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt089
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt089
            #add-point:ON ACTION controlp INFIELD pmdt089 name="input.c.page1.pmdt089"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt088
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt088
            #add-point:ON ACTION controlp INFIELD pmdt088 name="input.c.page1.pmdt088"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.ooff013
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD ooff013
            #add-point:ON ACTION controlp INFIELD ooff013 name="input.c.page1.ooff013"
            #161031-00025#15 add-S
            IF NOT cl_null(g_pmds_m.pmdsdocno) AND l_ac > 0 THEN
               CALL aooi360_02('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'','','','','','','','1')
               CALL s_aooi360_sel('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'','','','','','','','1') RETURNING l_success,g_pmdt_d[l_ac].ooff013
               LET g_ooff001_d = '6'   #6.單據單頭備註
               LET g_ooff002_d = g_prog
               LET g_ooff003_d = g_pmds_m.pmdsdocno   #单号
               LET g_ooff004_d = 0     #项次
               LET g_ooff005_d = ' '
               LET g_ooff006_d = ' '
               LET g_ooff007_d = ' '
               LET g_ooff008_d = ' '
               LET g_ooff009_d = ' '
               LET g_ooff010_d = ' '
               LET g_ooff011_d = ' '
               CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身 
            END IF
            #161031-00025#15 add-E
            #END add-point
 
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt520_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = g_pmdt_d[l_ac].pmdtseq 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
            ELSE
            
               #add-point:單身修改前 name="input.body.b_update"
               #儲位、批號 若為空，給一個空格
               IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET g_pmdt_d[l_ac].pmdt017 = ' '
               END IF 
	           
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_pmdt_d[l_ac].pmdt018 = ' '
               END IF    

               #整體參數未使用採購計價單位,則賦值當前的採購單位和數量
               IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N"  OR (NOT apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006)) THEN
                  LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                  LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
               END IF
               
               #160617-00005#2---s--
               IF g_argv[1] MATCHES '[1234689]' OR g_argv[1] = '12' OR g_argv[1] = '13'  OR g_argv[1] = '20' THEN
                  LET l_imaf061 = ''
                  LET l_imaf062 = ''
                  LET l_imaf063 = ''
                  SELECT imaf061,imaf062,imaf063 INTO l_imaf061,l_imaf062,l_imaf063  
                    FROM imaf_t WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdt_d[l_ac].pmdt006
               
                  IF cl_null(g_pmdt_d[l_ac].pmdt018) AND l_imaf061 = '1' AND l_imaf062 = 'Y' AND (NOT cl_null(l_imaf063)) THEN
                     CALL s_aooi390_gen_1('6',l_imaf063) RETURNING l_success,g_pmdt_d[l_ac].pmdt018,l_oofg_return
                     IF NOT l_success THEN
                        LET g_pmdt_d[l_ac].pmdt018 = ' '
                     ELSE
                        CALL s_aooi390_get_auto_no('6',g_pmdt_d[l_ac].pmdt018) RETURNING l_success,g_pmdt_d[l_ac].pmdt018
                        CALL s_aooi390_oofi_upd('6',g_pmdt_d[l_ac].pmdt018) RETURNING l_success
                     END IF
                  END IF
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt018
               END IF
               #160617-00005#2---e--       
               #end add-point
               
               #寫入修改者/修改日期資訊(單身)
               
      
               #將遮罩欄位還原
               CALL apmt520_pmdt_t_mask_restore('restore_mask_o')
      
               UPDATE pmdt_t SET (pmdtdocno,pmdtsite,pmdtseq,pmdt027,pmdt028,pmdt001,pmdt002,pmdt003, 
                   pmdt004,pmdt081,pmdt082,pmdt083,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011, 
                   pmdt019,pmdt020,pmdt021,pmdt022,pmdt008,pmdt023,pmdt024,pmdt090,pmdt091,pmdt036,pmdt046, 
                   pmdt037,pmdt038,pmdt039,pmdt047,pmdt092,pmdt093,pmdt026,pmdt041,pmdt062,pmdt016,pmdt017, 
                   pmdt018,pmdt063,pmdt072,pmdt073,pmdt074,pmdt075,pmdt040,pmdt052,pmdt051,pmdt070,pmdt071, 
                   pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt042,pmdt043,pmdt048,pmdt044,pmdt045, 
                   pmdt049,pmdt050,pmdt084,pmdt219,pmdt089,pmdt088) = (g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtsite, 
                   g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt001, 
                   g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt081, 
                   g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt083,g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt006, 
                   g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt025, 
                   g_pmdt_d[l_ac].pmdt011,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021, 
                   g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt008,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024, 
                   g_pmdt_d[l_ac].pmdt090,g_pmdt_d[l_ac].pmdt091,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046, 
                   g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047, 
                   g_pmdt_d[l_ac].pmdt092,g_pmdt_d[l_ac].pmdt093,g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt041, 
                   g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018, 
                   g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074, 
                   g_pmdt_d[l_ac].pmdt075,g_pmdt_d[l_ac].pmdt040,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051, 
                   g_pmdt_d[l_ac].pmdt070,g_pmdt_d[l_ac].pmdt071,g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt053, 
                   g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt060,g_pmdt_d[l_ac].pmdt061, 
                   g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt048,g_pmdt_d[l_ac].pmdt044, 
                   g_pmdt_d[l_ac].pmdt045,g_pmdt_d[l_ac].pmdt049,g_pmdt_d[l_ac].pmdt050,g_pmdt_d[l_ac].pmdt084, 
                   g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt088)
                WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno 
 
                  AND pmdtseq = g_pmdt_d_t.pmdtseq #項次   
 
                  
               #add-point:單身修改中 name="input.body.m_update"
                                                            
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdt_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*  
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()                   
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmds_m.pmdsdocno
               LET gs_keys_bak[1] = g_pmdsdocno_t
               LET gs_keys[2] = g_pmdt_d[g_detail_idx].pmdtseq
               LET gs_keys_bak[2] = g_pmdt_d_t.pmdtseq
               CALL apmt520_update_b('pmdt_t',gs_keys,gs_keys_bak,"'1'")
               END CASE
 
               #將遮罩欄位進行遮蔽
               CALL apmt520_pmdt_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT(g_pmdt_d[g_detail_idx].pmdtseq = g_pmdt_d_t.pmdtseq 
 
                  ) THEN
                  LET gs_keys[01] = g_pmds_m.pmdsdocno
 
                  LET gs_keys[gs_keys.getLength()+1] = g_pmdt_d_t.pmdtseq
 
                  CALL apmt520_key_update_b(gs_keys,'pmdt_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_pmds_m),util.JSON.stringify(g_pmdt_d_t)
               LET g_log2 = util.JSON.stringify(g_pmds_m),util.JSON.stringify(g_pmdt_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身修改後 name="input.body.a_update"
               #若有修改到採購單號、項次、或 收貨單號，收貨項次、數量時需檢核採購項次是否有對應的關連單據資料，若有則在修改確認時需乎叫
               #原始需求分配function產生原始需求分配明細資料
               IF g_pmdt_d[l_ac].pmdt001 != g_pmdt_d_t.pmdt001 OR g_pmdt_d[l_ac].pmdt002 != g_pmdt_d_t.pmdt002 OR g_pmdt_d[l_ac].pmdt020 != g_pmdt_d_t.pmdt020
                  OR g_pmdt_d[l_ac].pmdt027 != g_pmdt_d_t.pmdt027 OR g_pmdt_d[l_ac].pmdt028 != g_pmdt_d_t.pmdt028 THEN
                  IF NOT s_apmt520_gen_pmdv(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq) THEN
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
               END IF 
               
               #由'Y'-->改為'N',則需新增一筆資料到多库储批單身
               IF g_pmdt_d[l_ac].pmdt062 != g_pmdt_d_t.pmdt062 AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                  IF NOT apmt520_ins_pmdu() THEN
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
               ELSE
                  #多庫儲批為'N'，則更新相關欄位
                  IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                     UPDATE pmdu_t SET pmduseq = g_pmdt_d[l_ac].pmdtseq,
                                       pmdu001 = g_pmdt_d[l_ac].pmdt006,
                                       pmdu002 = g_pmdt_d[l_ac].pmdt007,
                                       pmdu003 = g_pmdt_d[l_ac].pmdt009,
                                       pmdu004 = g_pmdt_d[l_ac].pmdt010,
                                       pmdu005 = g_pmdt_d[l_ac].pmdt063,
                                       pmdu006 = g_pmdt_d[l_ac].pmdt016,
                                       pmdu007 = g_pmdt_d[l_ac].pmdt017,
                                       pmdu008 = g_pmdt_d[l_ac].pmdt018,
                                       pmdu009 = g_pmdt_d[l_ac].pmdt019,
                                       pmdu010 = g_pmdt_d[l_ac].pmdt020,
                                       pmdu011 = g_pmdt_d[l_ac].pmdt021,
                                       pmdu012 = g_pmdt_d[l_ac].pmdt022,
                                       pmdu016 = g_pmdt_d[l_ac].pmdt088,
                                       pmdu202 = g_pmdt_d[l_ac].pmdt219,  # 製造日期 160512-00004#6-add
                                       pmdu017 = g_pmdt_d[l_ac].pmdt089
                                       
                                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d_t.pmdtseq
                  ELSE
                     UPDATE pmdu_t SET pmduseq = g_pmdt_d[l_ac].pmdtseq,
                                       pmdu001 = g_pmdt_d[l_ac].pmdt006,
                                       pmdu002 = g_pmdt_d[l_ac].pmdt007,
                                       pmdu003 = g_pmdt_d[l_ac].pmdt009,
                                       pmdu004 = g_pmdt_d[l_ac].pmdt010
                                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d_t.pmdtseq
                     #3.若有修改到存貨備註時，需開窗詢問是否同步更新[T:多庫儲批明細檔].[C:存貨備註]
                     IF ((g_pmdt_d[l_ac].pmdt088 != g_pmdt_d_t.pmdt088) OR ((NOT cl_null(g_pmdt_d[l_ac].pmdt088)) AND cl_null(g_pmdt_d_t.pmdt088)) OR ((NOT cl_null(g_pmdt_d_t.pmdt088)) AND cl_null(g_pmdt_d[l_ac].pmdt088))) THEN
                        IF cl_ask_confirm('apm-00645') THEN
                           UPDATE pmdu_t SET pmdu016 = g_pmdt_d[l_ac].pmdt088
                             WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d_t.pmdtseq #項次
                        END IF
                     END IF
                  END IF
               END IF
               #160617-00005#2---s--
               IF g_argv[1] MATCHES '[1234689]' OR g_argv[1] = '12' OR g_argv[1] = '13'  OR g_argv[1] = '20' THEN
                  IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                    UPDATE pmdu_t SET pmdu008 = g_pmdt_d[l_ac].pmdt018
                                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d_t.pmdtseq
                  END IF
               END IF
               #160617-00005#2---e-- 
               #add--2015/08/31 By shiun--(S)
               CALL s_apmt520_stus_abg(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'U')
                    RETURNING l_success,l_errno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = l_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
               END IF
               #add--2015/08/31 By shiun--(E)
                #161031-00025#15 add(s)
               CALL s_aooi360_del('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d_t.pmdtseq,'','','','','','','','1') RETURNING l_success
               IF NOT cl_null(g_pmdt_d[l_ac].ooff013) THEN
                  CALL s_aooi360_gen('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'','','','','','','','1',g_pmdt_d[l_ac].ooff013) RETURNING l_success
               END IF
               #161031-00025#15 add(e)               
               CALL apmt520_b_fill()
               
               #end add-point
 
            END IF
            
         AFTER ROW
            #add-point:單身after_row name="input.body.after_row"
            IF l_insert1 THEN
               CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) 
                    RETURNING l_success,l_slip
               IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
                  IF cl_null(g_pmdt_d[l_ac].pmdt075) THEN
                     NEXT FIELD pmdt075
                  END IF
               END IF
            END IF 
            #end add-point
            CALL apmt520_unlock_b("pmdt_t","'1'")
            CALL s_transaction_end('Y','0')
            #其他table進行unlock
            #add-point:單身after_row2 name="input.body.after_row2"
            
            #end add-point
              
         AFTER INPUT
            #add-point:input段after input  name="input.body.after_input"
            #呼叫產生匯總與檢驗狀況的Function來更新匯總與檢驗狀況明細資料
            #CALL s_transaction_begin()
            #IF NOT s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) THEN
            #   CALL s_transaction_end('N','0')
            #ELSE
            #   CALL s_transaction_end('Y','0')
            #END IF  
            #170116-00040#1 add  --begin--
            IF cl_null(g_pmds_m.pmds053) THEN
               #採購收貨、採購收貨入庫時，根據採購單單號帶值
               IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
                  SELECT COUNT(DISTINCT pmdl051) INTO l_n1 FROM pmdl_t
                   WHERE pmdlent = g_enterprise 
                     AND pmdldocno IN(SELECT pmdt001 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno)
                  IF l_n1 = 1 THEN
                     SELECT DISTINCT pmdl051 INTO g_pmds_m.pmds053 FROM pmdl_t
                      WHERE pmdlent = g_enterprise 
                        AND pmdldocno IN(SELECT pmdt001 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno)
                     UPDATE pmds_t SET pmds053 = g_pmds_m.pmds053
                      WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
                     DISPLAY BY NAME g_pmds_m.pmds053
                  END IF
               END IF
            END IF
            #170116-00040#1 add  --end--
            #end add-point 
    
         ON ACTION controlo    
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_pmdt_d[li_reproduce_target].* = g_pmdt_d[li_reproduce].*
 
               LET g_pmdt_d[li_reproduce_target].pmdtseq = NULL
 
            ELSE
               CALL FGL_SET_ARR_CURR(g_pmdt_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_pmdt_d.getLength()+1
            END IF
            
         #ON ACTION cancel
         #   LET INT_FLAG = 1
         #   LET g_detail_idx = 1
         #   EXIT DIALOG 
 
      END INPUT
      
 
      
 
      DISPLAY ARRAY g_pmdt2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt520_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail2")
            LET g_detail_idx = l_ac
            
            #add-point:page2, before row動作 name="input.body2.before_row"
                                                
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail2")
            CALL apmt520_idx_chk()
            LET g_current_page = 2
      
         #add-point:page2自定義行為 name="input.body2.action"
         
         #end add-point
      
      END DISPLAY
      DISPLAY ARRAY g_pmdt3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt520_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            LET g_detail_idx = l_ac
            
            #add-point:page3, before row動作 name="input.body3.before_row"
                                                
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            CALL apmt520_idx_chk()
            LET g_current_page = 3
      
         #add-point:page3自定義行為 name="input.body3.action"
         
         #end add-point
      
      END DISPLAY
 
 
 
{</section>}
 
{<section id="apmt520.input.other" >}
      
      #add-point:自定義input name="input.more_input"
      SUBDIALOG aoo_aooi360_01.aooi360_01_input   #备注单身  #161031-00025#15 add 
      ON ACTION open_apmt520_03
         LET g_action_choice="open_apmt520_03"
         IF cl_auth_chk_act("open_apmt520_03") THEN
            IF l_ac > 0 THEN
               CALL s_transaction_begin()
               IF NOT apmt520_03('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002) THEN  #161006-00018#8 add pmdt001,pmdt002
                  CALL s_transaction_end('N','0')
               ELSE
                  #若維護了多筆庫儲批資料，則更新多庫儲批否為'Y'
                  SELECT COUNT(1) INTO l_n FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d[l_ac].pmdtseq
                  IF l_n > 1 AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                     UPDATE pmdt_t SET pmdt062 = 'Y' WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
                  END IF
                  #非多庫儲批未勾選時候，若通過多庫儲批子作業修改了庫儲批資料，也同步回寫主作業單身的庫儲批欄位
                  IF l_n = 1 AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                     SELECT pmdu005,pmdu006,pmdu007,pmdu008 INTO l_pmdu005,l_pmdu006,l_pmdu007,l_pmdu008  #160316-00007#3 add pmdu005
                         FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d[l_ac].pmdtseq
                     UPDATE pmdt_t SET pmdt016 = l_pmdu006,
                                       pmdt017 = l_pmdu007,
                                       pmdt018 = l_pmdu008,
                                       pmdt063 = l_pmdu005   #160316-00007#3 add
                         WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
                  END IF
                  CALL s_transaction_end('Y','0')
               END IF
               CALL apmt520_b_fill()
            END IF
         END IF  
              
      #end add-point
    
      BEFORE DIALOG 
         #CALL cl_err_collect_init()    
         #add-point:input段before dialog name="input.before_dialog"
         IF g_flag2 THEN
            LET g_flag2 = FALSE
            NEXT FIELD pmdt001
         END IF  
         #161031-00025#15 add(s)
         #為了修改功能doubleClick可以直接進入單身, 需指定要進入哪一個單身
         IF NOT cl_null(p_cmd) AND p_cmd != 'a' THEN
            CASE g_aw
               WHEN "s_detail1_aooi360_01"
                  NEXT FIELD ooff012     
            END CASE
         END IF
         #161031-00025#15 add(e)         
         #end add-point    
         #重新導回資料到正確位置上
         CALL DIALOG.setCurrentRow("s_detail1",g_idx_group.getValue("'1',"))      
         CALL DIALOG.setCurrentRow("s_detail2",g_idx_group.getValue("'2',"))
         CALL DIALOG.setCurrentRow("s_detail3",g_idx_group.getValue("'3',"))
 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            #add-point:input段next_field name="input.next_field"
            
            #end add-point  
            NEXT FIELD pmdsdocno
         ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD pmdtsite
               WHEN "s_detail2"
                  NEXT FIELD pmdusite
               WHEN "s_detail3"
                  NEXT FIELD pmdvsite
 
               #add-point:input段modify_detail  name="input.modify_detail.other"
               
               #end add-point  
            END CASE
         END IF
      
      AFTER DIALOG
         #add-point:input段after_dialog name="input.after_dialog"
         
         #end add-point    
         
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept  name="input.accept"
         
         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         #add-point:input段cancel name="input.cancel"
         #add--2015/08/31 By shiun--(S)
         IF l_insert1 THEN
            CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) 
                 RETURNING l_success,l_slip
            IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
               IF cl_null(g_pmdt_d[l_ac].pmdt075) THEN
                  NEXT FIELD pmdt075
               END IF
            END IF
         END IF
         #add--2015/08/31 By shiun--(E)
         #end add-point  
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         #add-point:input段close name="input.close"
         #add--2015/08/31 By shiun--(S)
         IF l_insert1 THEN
            CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) 
                 RETURNING l_success,l_slip
            IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
               IF cl_null(g_pmdt_d[l_ac].pmdt075) THEN
                  NEXT FIELD pmdt075
               END IF
            END IF
         END IF
         #add--2015/08/31 By shiun--(E)
         #end add-point  
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         #add-point:input段exit name="input.exit"
         #add--2015/08/31 By shiun--(S)
         IF l_insert1 THEN
            CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) 
                 RETURNING l_success,l_slip
            IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'Y' THEN
               IF cl_null(g_pmdt_d[l_ac].pmdt075) THEN
                  NEXT FIELD pmdt075
               END IF
            END IF
         END IF
         #add--2015/08/31 By shiun--(E)
         #end add-point
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   #add-point:input段after input  name="input.after_input"
   IF g_flag2 THEN
      CALL apmt520_input('u')
   END IF  

   #重新計算整單的未稅、含稅總金額
   IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
      CALL s_transaction_begin()
      CALL s_tax_recount(g_pmds_m.pmdsdocno)
        RETURNING g_pmds_m.pmds043,g_pmds_m.pmds046,g_pmds_m.pmds044,l_xrcd113,l_xrcd114,l_xrcd115
      UPDATE pmds_t SET pmds043 = g_pmds_m.pmds043,
                        pmds044 = g_pmds_m.pmds044,
                        pmds046 = g_pmds_m.pmds046
          WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
          
#      CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt #151124-00015#1-mark
      
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
      ELSE
         #151124-00015#1-mod-(S)
         #xrcd回寫pmdt
#         CALL s_transaction_end('Y','0')
          CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING l_success
          IF l_success THEN
             CALL s_transaction_end('Y','0')
          ELSE
             CALL s_transaction_end('N','0')
          END IF
         #151124-00015#1-mod-(E)
      END IF
   END IF  

   CALL apmt520_b_fill()
   #end add-point    
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.show" >}
#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION apmt520_show()
   #add-point:show段define(客製用) name="show.define_customerization"
   
   #end add-point  
   DEFINE l_ac_t    LIKE type_t.num10
   #add-point:show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show.define"
   DEFINE l_success LIKE type_t.num5
   DEFINE l_ooba002 LIKE ooba_t.ooba002
   #end add-point  
   
   #add-point:Function前置處理 name="show.before"
            
   #end add-point
   
   
   
   IF g_bfill = "Y" THEN
      CALL apmt520_b_fill() #單身填充
      CALL apmt520_b_fill2('0') #單身填充
   END IF
     
   #帶出公用欄位reference值
   #應用 a12 樣板自動產生(Version:4)
 
 
 
   
   #顯示followup圖示
   #應用 a48 樣板自動產生(Version:3)
   CALL apmt520_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:show段reference name="show.head.reference"
   #161207-00033#27-S 
   IF NOT cl_null(g_pmds_m.pmds028) THEN
      CALL s_desc_get_oneturn_guest_desc(g_pmds_m.pmds028) RETURNING g_pmds_m.pmds007_desc
      IF g_pmds_m.pmds008 = g_pmds_m.pmds007 THEN
         LET g_pmds_m.pmds008_desc = g_pmds_m.pmds007_desc
      END IF
      IF g_pmds_m.pmds009 = g_pmds_m.pmds007 THEN
         LET g_pmds_m.pmds009_desc = g_pmds_m.pmds007_desc
      END IF      
   END IF
   #161207-00033#27-E         
            
            IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
               CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
               CALL s_aooi200_get_slip_desc(l_ooba002) RETURNING g_pmds_m.pmdsdocno_desc
            END IF
            
            DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
            
            #CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
            #DISPLAY BY NAME g_pmds_m.pmds002_desc
            #
            #CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
            #DISPLAY BY NAME g_pmds_m.pmds003_desc
            
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdsownid
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdsownid_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdsownid_desc
            #
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdsowndp
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdsowndp_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdsowndp_desc
            #
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdscrtid
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdscrtid_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdscrtid_desc
            #
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdscrtdp
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdscrtdp_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdscrtdp_desc
            #
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdsmodid
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdsmodid_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdsmodid_desc
            #
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdscnfid
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdscnfid_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdscnfid_desc
            #
            #INITIALIZE g_ref_fields TO NULL
            #LET g_ref_fields[1] = g_pmds_m.pmdspstid
            #CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            #LET g_pmds_m.pmdspstid_desc = '', g_rtn_fields[1] , ''
            #DISPLAY BY NAME g_pmds_m.pmdspstid_desc
            
            #CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
            #DISPLAY BY NAME g_pmds_m.pmds007_desc
            #
            #CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
            #DISPLAY BY NAME g_pmds_m.pmds008_desc
            #
            #CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
            #DISPLAY BY NAME g_pmds_m.pmds009_desc
            #
            #CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
            #DISPLAY BY NAME g_pmds_m.pmds031_desc
            
            #CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
            #DISPLAY BY NAME g_pmds_m.pmds032_desc
            
            CALL apmt520_pmds033_ref(g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
            DISPLAY BY NAME g_pmds_m.pmds033_desc
            
            #CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
            #DISPLAY BY NAME g_pmds_m.pmds037_desc
            #
            #CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
            #DISPLAY BY NAME g_pmds_m.pmds039_desc
            #
            #CALL s_desc_ooid001_desc(g_pmds_m.pmds040) RETURNING g_pmds_m.pmds040_desc
            #DISPLAY BY NAME g_pmds_m.pmds040_desc

   #end add-point
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt520_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001, 
       g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus, 
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008,g_pmds_m.pmds008_desc, 
       g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000, 
       g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds031_desc,g_pmds_m.pmds032, 
       g_pmds_m.pmds032_desc,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds039_desc, 
       g_pmds_m.pmds040,g_pmds_m.pmds040_desc,g_pmds_m.pmds012,g_pmds_m.pmds012_desc,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053, 
       g_pmds_m.pmds053_desc,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054, 
       g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid, 
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid, 
       g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmds_m.pmdsstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
 
 
 
   
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_pmdt_d.getLength()
      #add-point:show段單身reference name="show.body.reference"
          #160720-00015#1---s
          #SELECT pmdo001,pmdo002 INTO g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002
          # FROM pmdo_t 
          # WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001
          #   AND pmdoseq = g_pmdt_d[l_ac].pmdt002
          #   AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
          #   AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
          #   
          #CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdo001) RETURNING g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004
          #DISPLAY BY NAME g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004
          #
          #CALL s_feature_description(g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002) RETURNING l_success,g_pmdt_d[l_ac].pmdo002_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdo002_desc
          #
          #CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          #
          #CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
          #160720-00015#1---e
          
          #CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc
          #
          #CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
          #
          #CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc
          #
          #CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
          
          #160720-00015#1---s
          #CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
          #
          #CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
          #
          #CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
          #
          #CALL s_desc_get_acc_desc(g_acc,g_pmdt_d[l_ac].pmdt051) RETURNING g_pmdt_d[l_ac].pmdt051_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt051_desc
          #  
          #CALL apmt520_pmdt083_ref(g_pmdt_d[l_ac].pmdt083) RETURNING g_pmdt_d[l_ac].pmdt083_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt083_desc
          #160720-00015#1---e
      #end add-point
   END FOR
   
   FOR l_ac = 1 TO g_pmdt2_d.getLength()
      #add-point:show段單身reference name="show.body2.reference"
          #160720-00015#1---s
          #CALL s_desc_get_item_desc(g_pmdt2_d[l_ac].pmdu001) RETURNING g_pmdt2_d[l_ac].pmdu001_desc,g_pmdt2_d[l_ac].imaal004
          #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu001_desc,g_pmdt2_d[l_ac].imaal004
          #
          #CALL s_feature_description(g_pmdt2_d[l_ac].pmdu001,g_pmdt2_d[l_ac].pmdu002) RETURNING l_success,g_pmdt2_d[l_ac].pmdu002_desc
          #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu002_desc
          #
          #CALL s_desc_get_stock_desc(g_site,g_pmdt2_d[l_ac].pmdu006) RETURNING g_pmdt2_d[l_ac].pmdu006_desc
          #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu006_desc
          #
          #CALL s_desc_get_locator_desc(g_site,g_pmdt2_d[l_ac].pmdu006,g_pmdt2_d[l_ac].pmdu007) RETURNING g_pmdt2_d[l_ac].pmdu007_desc
          #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu007_desc
          #160720-00015#1---e
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdt3_d.getLength()
      #add-point:show段單身reference name="show.body3.reference"
          #160720-00015#1---s
          #CALL s_desc_get_item_desc(g_pmdt3_d[l_ac].pmdv001) RETURNING g_pmdt3_d[l_ac].pmdv001_desc,g_pmdt3_d[l_ac].imaal004
          #DISPLAY BY NAME g_pmdt3_d[l_ac].pmdv001_desc,g_pmdt3_d[l_ac].imaal004
          #
          #CALL s_feature_description(g_pmdt3_d[l_ac].pmdv001,g_pmdt3_d[l_ac].pmdv002) RETURNING l_success,g_pmdt3_d[l_ac].pmdv002_desc
          #DISPLAY BY NAME g_pmdt3_d[l_ac].pmdv002_desc
          #160720-00015#1---e
      #end add-point
   END FOR
 
   
    
   
   #add-point:show段other name="show.other"
   CALL apmt520_b4_fill()     
   #end add-point  
   
   LET l_ac = l_ac_t
   
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()     
 
   CALL apmt520_detail_show()
 
   #add-point:show段之後 name="show.after"
            
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.detail_show" >}
#+ 第二階單身reference
PRIVATE FUNCTION apmt520_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point  
   #add-point:detail_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
            
   #end add-point  
   
   #add-point:Function前置處理 name="detail_show.before"
            
   #end add-point
   
   #add-point:detail_show段之後 name="detail_show.after"
            
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.reproduce" >}
#+ 資料複製
PRIVATE FUNCTION apmt520_reproduce()
   #add-point:reproduce段define(客製用) name="reproduce.define_customerization"
   
   #end add-point   
   DEFINE l_newno     LIKE pmds_t.pmdsdocno 
   DEFINE l_oldno     LIKE pmds_t.pmdsdocno 
 
   DEFINE l_master    RECORD LIKE pmds_t.* #此變數樣板目前無使用
   DEFINE l_detail    RECORD LIKE pmdt_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE pmdu_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE pmdv_t.* #此變數樣板目前無使用
 
 
 
   DEFINE l_cnt       LIKE type_t.num10
   #add-point:reproduce段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="reproduce.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="reproduce.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET g_master_insert = FALSE
   
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
    
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
    
   LET g_pmds_m.pmdsdocno = ""
 
 
   CALL cl_set_head_visible("","YES")
 
   #公用欄位給予預設值
   #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_pmds_m.pmdsownid = g_user
      LET g_pmds_m.pmdsowndp = g_dept
      LET g_pmds_m.pmdscrtid = g_user
      LET g_pmds_m.pmdscrtdp = g_dept 
      LET g_pmds_m.pmdscrtdt = cl_get_current()
      LET g_pmds_m.pmdsmodid = g_user
      LET g_pmds_m.pmdsmoddt = cl_get_current()
      LET g_pmds_m.pmdsstus = 'N'
 
 
 
   
   CALL s_transaction_begin()
   
   #add-point:複製輸入前 name="reproduce.head.b_input"
   
   CALL s_desc_get_person_desc(g_pmds_m.pmdsownid) RETURNING g_pmds_m.pmdsownid_desc
   DISPLAY BY NAME g_pmds_m.pmdsownid_desc
   
   CALL s_desc_get_person_desc(g_pmds_m.pmdscrtid) RETURNING g_pmds_m.pmdscrtid_desc
   DISPLAY BY NAME g_pmds_m.pmdscrtid_desc

   CALL s_desc_get_department_desc(g_pmds_m.pmdsowndp) RETURNING g_pmds_m.pmdsowndp_desc
   DISPLAY BY NAME g_pmds_m.pmdsowndp_desc
   
   CALL s_desc_get_department_desc(g_pmds_m.pmdscrtdp) RETURNING g_pmds_m.pmdscrtdp_desc
   DISPLAY BY NAME g_pmds_m.pmdscrtdp_desc
   
   LET g_pmds_m.pmdsmodid = ''
   LET g_pmds_m.pmdscnfid = ''
   LET g_pmds_m.pmdscnfid_desc = ''
   LET g_pmds_m.pmdscnfdt = ''
   LET g_pmds_m.pmdspstid = ''
   LET g_pmds_m.pmdspstid_desc = ''
   LET g_pmds_m.pmdspstdt = ''
      
   LET g_pmds_m.pmdsdocdt = g_today
   LET g_pmds_m.pmds002 = g_user
   CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
   DISPLAY BY NAME g_pmds_m.pmds002_desc
   LET g_pmds_m.pmds003 = g_dept
   CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
   DISPLAY BY NAME g_pmds_m.pmds003_desc
            
   
   #end add-point
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmds_m.pmdsstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
 
 
 
   
   #清空key欄位的desc
      LET g_pmds_m.pmdsdocno_desc = ''
   DISPLAY BY NAME g_pmds_m.pmdsdocno_desc
 
   
   CALL apmt520_input("r")
   
   IF INT_FLAG AND NOT g_master_insert THEN
      LET INT_FLAG = 0
      DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
      DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
      LET INT_FLAG = 0
      INITIALIZE g_pmds_m.* TO NULL
      INITIALIZE g_pmdt_d TO NULL
      INITIALIZE g_pmdt2_d TO NULL
      INITIALIZE g_pmdt3_d TO NULL
 
      #add-point:複製取消後 name="reproduce.cancel"
      
      #end add-point
      CALL apmt520_show()
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = '' 
      LET g_errparam.code = 9001 
      LET g_errparam.popup = FALSE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt520_set_act_visible()   
   CALL apmt520_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                      " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL apmt520_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   #add-point:完成複製段落後 name="reproduce.after_reproduce"
            
   #end add-point
   
   CALL apmt520_idx_chk()
   
   LET g_data_owner = g_pmds_m.pmdsownid      
   LET g_data_dept  = g_pmds_m.pmdsowndp
   
   #功能已完成,通報訊息中心
   CALL apmt520_msgcentre_notify('reproduce')
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.detail_reproduce" >}
#+ 單身自動複製
PRIVATE FUNCTION apmt520_detail_reproduce()
   #add-point:delete段define(客製用) name="detail_reproduce.define_customerization"
   
   #end add-point    
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE pmdt_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE pmdu_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE pmdv_t.* #此變數樣板目前無使用
 
 
 
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_reproduce.define"
   DEFINE l_success   LIKE type_t.num5          
   #end add-point    
   
   #add-point:Function前置處理  name="detail_reproduce.pre_function"
   
   #end add-point
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE apmt520_detail
   
   #add-point:單身複製前1 name="detail_reproduce.body.table1.b_insert"
            
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdt_t
    WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmdsdocno_t
 
    INTO TEMP apmt520_detail
 
   #將key修正為調整後   
   UPDATE apmt520_detail 
      #更新key欄位
      SET pmdtdocno = g_pmds_m.pmdsdocno
 
      #更新共用欄位
      
 
   #add-point:單身修改前 name="detail_reproduce.body.table1.b_update"
   UPDATE apmt520_detail SET pmdt053 = 0 , pmdt054 = 0, pmdt055 = 0, pmdt052 = '1',  #狀態碼 '1:一般'
                             pmdt066 = 0 , pmdt067 = 0, pmdt068 = 0, pmdt069 = 0,    #160629-00018#1
                             pmdt056 = 0 , pmdt057 = 0, pmdt058 = 0                  #160629-00018#1
        
   #end add-point                                       
  
   #將資料塞回原table   
   INSERT INTO pmdt_t SELECT * FROM apmt520_detail
   
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "reproduce:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #add-point:單身複製中1 name="detail_reproduce.body.table1.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt520_detail
   
   #add-point:單身複製後1 name="detail_reproduce.body.table1.a_insert"
            
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table2.b_insert"
            
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdu_t 
    WHERE pmduent = g_enterprise AND pmdudocno = g_pmdsdocno_t
 
    INTO TEMP apmt520_detail
 
   #將key修正為調整後   
   UPDATE apmt520_detail SET pmdudocno = g_pmds_m.pmdsdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table2.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdu_t SELECT * FROM apmt520_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table2.m_insert"
   UPDATE pmdu_t SET pmdu013 = 0 , pmdu014 = 0, pmdu015 = 0
        WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno
                
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt520_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table2.a_insert"
            
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table3.b_insert"
            
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdv_t 
    WHERE pmdvent = g_enterprise AND pmdvdocno = g_pmdsdocno_t
 
    INTO TEMP apmt520_detail
 
   #將key修正為調整後   
   UPDATE apmt520_detail SET pmdvdocno = g_pmds_m.pmdsdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table3.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdv_t SELECT * FROM apmt520_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table3.m_insert"
            
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt520_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table3.a_insert"
   #160407-00029#1--mark--begin---
   ##複製來源單據的inao的資料
   ##CREATE TEMP TABLE
   #LET ls_sql = 
   #   "CREATE GLOBAL TEMPORARY TABLE apmt520_detail AS ",
   #   "SELECT * FROM inao_t "
   #PREPARE repro_tbl4 FROM ls_sql
   #EXECUTE repro_tbl4
   #FREE repro_tbl4
   #   
   ##將符合條件的資料丟入TEMP TABLE
   #INSERT INTO apmt520_detail SELECT * FROM inao_t
   #                                      WHERE inaoent = g_enterprise AND inaodocno = g_pmdsdocno_t
   #
   #
   ##將key修正為調整後   
   #UPDATE apmt520_detail SET inaodocno = g_pmds_m.pmdsdocno
   #
   #
   ##將資料塞回原table   
   #INSERT INTO inao_t SELECT * FROM apmt520_detail
   #
   #UPDATE inao_t SET inao020 = 0 , inao021 = 0, inao022 = 0 ,inao023 = 0,inao024 = 0
   #     WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno
   #
   ##刪除TEMP TABLE
   #DROP TABLE apmt520_detail
   #160407-00029#1--end--
   #end add-point
 
 
   
 
   
   #多語言複製段落
   
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.delete" >}
#+ 資料刪除
PRIVATE FUNCTION apmt520_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"
   
   #end add-point     
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
   DEFINE l_cnt            LIKE type_t.num10   
   DEFINE l_pmds054        LIKE pmds_t.pmds054   
   DEFINE l_n              LIKE type_t.num10
   DEFINE l_success        LIKE type_t.num5  #add--2015/08/31 By shiun
   DEFINE l_ooff012        LIKE ooff_t.ooff012  #161031-00025#15 add
   #end add-point     
   
   #add-point:Function前置處理  name="delete.pre_function"
   
   #end add-point
   
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   
   
   CALL s_transaction_begin()
 
   OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt520_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
       g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
       g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
       g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
       g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
       g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc,g_pmds_m.pmdsownid_desc, 
       g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
   
   
   #檢查是否允許此動作
   IF NOT apmt520_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt520_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   CALL apmt520_show()
   
   #add-point:delete段before ask name="delete.before_ask"
   #IF g_pmds_m.pmdsstus <> 'N' THEN
   IF g_pmds_m.pmdsstus NOT MATCHES "[NDR]" THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.code   = "apm-00034"
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')      
      RETURN
   END IF
   
   #判斷資料來源為"EC"時，單頭不可刪除
   IF g_argv[1] MATCHES '[1234]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
      IF g_pmds_m.pmds057 = '2' THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = g_pmds_m.pmdsdocno
         LET g_errparam.code   = 'axm-00712'
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         CLOSE apmt520_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
   END IF
   #end add-point 
 
   IF cl_ask_del_master() THEN              #確認一下
   
      #add-point:單頭刪除前 name="delete.head.b_delete"
      #add by lixiang 2015/07/23 
      #倉退單在過帳還原時若pmds054為'2.採購合約差異處理'時，刪除或作廢單據時，須將對應的pmeo025的狀態更新成'1.未處理'
      LET l_pmds054 = ''
      SELECT pmds054 INTO l_pmds054 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno  

      #以入庫單為例
      #在打入庫單時，若料號走QC，則根據QC單的製造批序號帶入入庫單，且同時回寫對應QC單的製造批序號中的已入庫量欄位
      #             若不走QC，則根據來源收貨單的製造批序號帶入入庫單，且同事回寫收貨單的製造批序號的已入庫量欄位
      #所以入庫單在刪除，或作廢時，也需將入庫單來源單據中的已入庫量欄位更新
      IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
         SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno
         IF l_n > 0 THEN
            IF NOT s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,'','') THEN
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END IF
      END IF
      #end add-point   
      
      #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL apmt520_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
  
  
      #資料備份
      LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
 
      DELETE FROM pmds_t
       WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
 
       
      #add-point:單頭刪除中 name="delete.head.m_delete"
                        
      #end add-point
       
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_pmds_m.pmdsdocno,":",SQLERRMESSAGE  
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF
      
      #add-point:單頭刪除後 name="delete.head.a_delete"
      IF NOT s_aooi200_del_docno(g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF   
      #end add-point
  
      #add-point:單身刪除前 name="delete.body.b_delete"
      #add--2015/08/31 By shiun--(S)
      CALL s_apmt520_stus_abg1(g_pmds_m.pmdsdocno,'D')
           RETURNING l_success
      IF NOT l_success THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #add--2015/08/31 By shiun--(E)
      #end add-point
      
      DELETE FROM pmdt_t
       WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
 
 
      #add-point:單身刪除中 name="delete.body.m_delete"
                        
      #end add-point
         
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF    
 
      #add-point:單身刪除後 name="delete.body.a_delete"
                        
      #end add-point
      
            
                                                               
      #add-point:單身刪除前 name="delete.body.b_delete2"
                        
      #end add-point
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise AND
             pmdudocno = g_pmds_m.pmdsdocno
      #add-point:單身刪除中 name="delete.body.m_delete2"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete2"
                        
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete3"
                        
      #end add-point
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise AND
             pmdvdocno = g_pmds_m.pmdsdocno
      #add-point:單身刪除中 name="delete.body.m_delete3"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete3"
      CALL g_pmdt4_d.clear()
      
      DELETE FROM pmdw_t
       WHERE pmdwent = g_enterprise AND
             pmdwdocno = g_pmds_m.pmdsdocno

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdw_t" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      IF NOT s_aooi360_del('6',g_prog,g_pmds_m.pmdsdocno,'','','','','','','','','4') THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #刪除交易稅明細檔
      LET l_cnt = 0
      SELECT COUNT(1) INTO l_cnt
        FROM xrcd_t
       WHERE xrcdent = g_enterprise
         AND xrcddocno = g_pmds_m.pmdsdocno
      IF l_cnt > 0 THEN
         DELETE FROM xrcd_t
          WHERE xrcdent = g_enterprise
            AND xrcddocno = g_pmds_m.pmdsdocno
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "DELETE xrcd_t"
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = FALSE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END IF
      
      #倉退單在過帳還原時若pmds054為'2.採購合約差異處理'時，刪除或作廢單據時，須將對應的pmeo025的狀態更新成'1.未處理'
      IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND (l_pmds054 = '2' OR l_pmds054 = '4') THEN
         #將對應的pmeo025的狀態更新成'1.未處理'
         UPDATE pmeo_t SET pmeo025 = '1',
                           pmeo027 = '',
                           pmeo028 = ''
             WHERE pmeoent = g_enterprise AND (pmeo000 ='1' OR pmeo000 = '3') AND pmeo027 = g_pmds_m.pmdsdocno
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "UPDATE pmeo_t"
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = FALSE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END IF
     
      #刪除inao製造批序號異動明細檔
      DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "DELETE inao_t"
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #161207-00033#38---s
      #无采购收货单，维护供应商是一次性交易对象时，需产生一次性交易对象识别码
      IF g_argv[1] MATCHES '[24]' THEN
        #一次性交易對象
        DELETE FROM pmak_t WHERE pmakent = g_enterprise AND pmak001 = g_pmds_m.pmds028
        IF SQLCA.sqlcode THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = SQLCA.sqlcode
           LET g_errparam.extend = "pmak_t"
           LET g_errparam.popup = FALSE
           CALL cl_err()
        
           CALL s_transaction_end('N','0')
           RETURN
        END IF
      END IF
      #161207-00033#38---e
      
      CALL s_lot_clear_detail()
      #161031-00025#15 add(s)
      #单头的aooi360_01的备注单身资料同步删除
      DECLARE ooff_cs CURSOR FOR
         SELECT ooff012 INTO l_ooff012 FROM ooff_t WHERE ooffent = g_enterprise AND ooff001 = '6' AND ooff003 = g_pmds_m.pmdsdocno AND ooff004 = 0
      FOREACH ooff_cs INTO l_ooff012   
         IF NOT s_aooi360_del('6',g_prog,g_pmds_m.pmdsdocno,'','','','','','','','',l_ooff012) THEN
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END FOREACH
      CALL aooi360_01_clear_detail()   #清除备注单身  
      
      #单身的长备注栏位也要同步删除
      IF NOT s_aooi360_del('7',g_prog,g_pmds_m.pmdsdocno,'','','','','','','','','1') THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #161031-00025#15 add(e)
      #end add-point
 
 
 
 
      
      #修改歷程記錄(刪除)
      LET g_log1 = util.JSON.stringify(g_pmds_m)   #(ver:78)
      IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:78)
         CLOSE apmt520_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
             
      CLEAR FORM
      CALL g_pmdt_d.clear() 
      CALL g_pmdt2_d.clear()       
      CALL g_pmdt3_d.clear()       
 
     
      CALL apmt520_ui_browser_refresh()  
      #CALL apmt520_ui_headershow()  
      #CALL apmt520_ui_detailshow()
 
      #add-point:多語言刪除 name="delete.lang.before_delete"
      
      #end add-point
      
      #單頭多語言刪除
      
      
      #單身多語言刪除
      
      
      
 
   
      #add-point:多語言刪除 name="delete.lang.delete"
      
      #end add-point
      
      IF g_browser_cnt > 0 THEN 
         #CALL apmt520_browser_fill("")
         CALL apmt520_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
         DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
      ELSE
         CLEAR FORM
      END IF
      
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
 
   CLOSE apmt520_cl
 
   #功能已完成,通報訊息中心
   CALL apmt520_msgcentre_notify('delete')
    
END FUNCTION
 
{</section>}
 
{<section id="apmt520.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION apmt520_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point     
   DEFINE p_wc2      STRING
   DEFINE li_idx     LIKE type_t.num10
   #add-point:b_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   DEFINE l_success LIKE type_t.num5   
   DEFINE l_inao013 LIKE inao_t.inao013   
   #add--2015/08/31 By shiun--(S)
   DEFINE l_errno          LIKE gzze_t.gzze001
   DEFINE l_bgaf016        LIKE bgaf_t.bgaf016
   DEFINE l_pmdt075        LIKE pmdt_t.pmdt075
   DEFINE l_pmdt075_desc   LIKE type_t.chr80  
   #add--2015/08/31 By shiun--(E)
   #160719-00002#1---s--
   DEFINE l_wc2_table1  STRING
   DEFINE l_wc2_table2  STRING
   DEFINE l_wc2_table3  STRING
   #160719-00002#1---e--
   #end add-point     
   
   #add-point:Function前置處理  name="b_fill.pre_function"
   
   #end add-point
   
   #清空第一階單身
   CALL g_pmdt_d.clear()
   CALL g_pmdt2_d.clear()
   CALL g_pmdt3_d.clear()
 
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"
   #160719-00002#1---s--
   LET l_wc2_table1 = g_wc2_table1
   LET l_wc2_table2 = g_wc2_table2
   LET l_wc2_table3 = g_wc2_table3
   #160719-00002#1---e--
   #end add-point
   
   #判斷是否填充
   IF apmt520_fill_chk(1) THEN
      #切換上下筆時不重組SQL
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
      #add-point:b_fill段long_sql_if name="b_fill.long_sql_if"
      
      #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdtsite,pmdtseq,pmdt027,pmdt028,pmdt001,pmdt002,pmdt003,pmdt004, 
             pmdt081,pmdt082,pmdt083,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019, 
             pmdt020,pmdt021,pmdt022,pmdt008,pmdt023,pmdt024,pmdt090,pmdt091,pmdt036,pmdt046,pmdt037, 
             pmdt038,pmdt039,pmdt047,pmdt092,pmdt093,pmdt026,pmdt041,pmdt062,pmdt016,pmdt017,pmdt018, 
             pmdt063,pmdt072,pmdt073,pmdt074,pmdt075,pmdt040,pmdt052,pmdt051,pmdt070,pmdt071,pmdt059, 
             pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt042,pmdt043,pmdt048,pmdt044,pmdt045,pmdt049, 
             pmdt050,pmdt084,pmdt219,pmdt089,pmdt088 ,t1.imaal003 ,t2.inaml004 ,t3.oocql004 ,t4.oocal003 , 
             t5.oocal003 ,t6.imaal003 ,t7.oocal003 ,t8.inayl003 ,t9.inab003 ,t10.pjbal003 ,t11.pjbbl004 , 
             t12.pjbml004 FROM pmdt_t",   
                     " INNER JOIN pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = pmdtdocno ",
 
                     #"",
                     
                     "",
                     #下層單身所需的join條件
 
                                    " LEFT JOIN imaal_t t1 ON t1.imaalent="||g_enterprise||" AND t1.imaal001=pmdt006 AND t1.imaal002='"||g_dlang||"' ",
               " LEFT JOIN inaml_t t2 ON t2.inamlent="||g_enterprise||" AND t2.inaml001=pmdt006 AND t2.inaml002=pmdt007 AND t2.inaml003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t3 ON t3.oocqlent="||g_enterprise||" AND t3.oocql001='221' AND t3.oocql002=pmdt009 AND t3.oocql003='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t4 ON t4.oocalent="||g_enterprise||" AND t4.oocal001=pmdt019 AND t4.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t5 ON t5.oocalent="||g_enterprise||" AND t5.oocal001=pmdt021 AND t5.oocal002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t6 ON t6.imaalent="||g_enterprise||" AND t6.imaal001=pmdt008 AND t6.imaal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t7 ON t7.oocalent="||g_enterprise||" AND t7.oocal001=pmdt023 AND t7.oocal002='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t8 ON t8.inaylent="||g_enterprise||" AND t8.inayl001=pmdt016 AND t8.inayl002='"||g_dlang||"' ",
               " LEFT JOIN inab_t t9 ON t9.inabent="||g_enterprise||" AND t9.inabsite=pmdtsite AND t9.inab001=pmdt016 AND t9.inab002=pmdt017  ",
               " LEFT JOIN pjbal_t t10 ON t10.pjbalent="||g_enterprise||" AND t10.pjbal001=pmdt072 AND t10.pjbal002='"||g_dlang||"' ",
               " LEFT JOIN pjbbl_t t11 ON t11.pjbblent="||g_enterprise||" AND t11.pjbbl001=pmdt072 AND t11.pjbbl002=pmdt073 AND t11.pjbbl003='"||g_dlang||"' ",
               " LEFT JOIN pjbml_t t12 ON t12.pjbmlent="||g_enterprise||" AND t12.pjbml001=pmdt072 AND t12.pjbml002=pmdt074 AND t12.pjbml003='"||g_dlang||"' ",
 
                     " WHERE pmdtent=? AND pmdtdocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段sql_before name="b_fill.body.fill_sql"
         IF NOT cl_null(g_wc2_table2) AND g_wc2_table2 <> " 1=1" THEN
            LET g_wc2_table1 = g_wc2_table1 CLIPPED,
                               " AND (pmdtdocno,pmdtseq) IN (SELECT pmdudocno,pmduseq FROM pmdu_t ",
                                                            " WHERE pmduent = pmdtent ",
                                                            "   AND pmdudocno = pmdtdocno ",
                                                            "   AND pmduseq = pmdtseq ",
                                                            "   AND ",g_wc2_table2 CLIPPED,")"
         END IF
         IF NOT cl_null(g_wc2_table3) AND g_wc2_table3 <> " 1=1" THEN
            LET g_wc2_table1 = g_wc2_table1 CLIPPED,
                               " AND (pmdtdocno,pmdtseq) IN (SELECT pmdvdocno,pmdvseq FROM pmdv_t ",
                                                            " WHERE pmdvent = pmdtent ",
                                                            "   AND pmdvdocno = pmdtdocno ",
                                                            "   AND pmdvseq = pmdtseq ",
                                                            "   AND ",g_wc2_table3 CLIPPED,")"
         END IF                 
         #end add-point
         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdt_t.pmdtseq"
         
         #add-point:單身填充控制 name="b_fill.sql"
         LET g_wc2_table1 = l_wc2_table1   #160719-00002#1
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt520_pb FROM g_sql
         DECLARE b_fill_cs CURSOR FOR apmt520_pb
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
   #  OPEN b_fill_cs USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq, 
          g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002, 
          g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082, 
          g_pmdt_d[l_ac].pmdt083,g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007, 
          g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt011, 
          g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022, 
          g_pmdt_d[l_ac].pmdt008,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt090, 
          g_pmdt_d[l_ac].pmdt091,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt037, 
          g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt092, 
          g_pmdt_d[l_ac].pmdt093,g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt041,g_pmdt_d[l_ac].pmdt062, 
          g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063, 
          g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074,g_pmdt_d[l_ac].pmdt075, 
          g_pmdt_d[l_ac].pmdt040,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051,g_pmdt_d[l_ac].pmdt070, 
          g_pmdt_d[l_ac].pmdt071,g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054, 
          g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt060,g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt042, 
          g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt048,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt045, 
          g_pmdt_d[l_ac].pmdt049,g_pmdt_d[l_ac].pmdt050,g_pmdt_d[l_ac].pmdt084,g_pmdt_d[l_ac].pmdt219, 
          g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt088,g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt007_desc, 
          g_pmdt_d[l_ac].pmdt009_desc,g_pmdt_d[l_ac].pmdt019_desc,g_pmdt_d[l_ac].pmdt021_desc,g_pmdt_d[l_ac].pmdt008_desc, 
          g_pmdt_d[l_ac].pmdt023_desc,g_pmdt_d[l_ac].pmdt016_desc,g_pmdt_d[l_ac].pmdt017_desc,g_pmdt_d[l_ac].pmdt072_desc, 
          g_pmdt_d[l_ac].pmdt073_desc,g_pmdt_d[l_ac].pmdt074_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
          #160720-00015#1--s 
          #SELECT pmdo001,pmdo002 INTO g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002
          # FROM pmdo_t 
          # WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001
          #   AND pmdoseq = g_pmdt_d[l_ac].pmdt002
          #   AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
          #   AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
           
          #CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdo001) RETURNING g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004
          #DISPLAY BY NAME g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004
          #
          #CALL s_feature_description(g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002) RETURNING l_success,g_pmdt_d[l_ac].pmdo002_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdo002_desc
          SELECT pmdo001,pmdo002,imaal003,imaal004,inaml004 
             INTO g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002,g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004,g_pmdt_d[l_ac].pmdo002_desc
           FROM pmdo_t 
              LEFT JOIN imaal_t ON imaalent=g_enterprise AND imaal001=pmdo001 AND imaal002=g_dlang
              LEFT JOIN inaml_t ON inamlent=g_enterprise AND inaml001=pmdo001 AND inaml002=pmdo002 AND inaml003=g_dlang
           WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001
             AND pmdoseq = g_pmdt_d[l_ac].pmdt002
             AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
             AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
          #160720-00015#1---e
          
          CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          
          #160720-00015#1---s
          #CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
          #160720-00015#1---e
          
         # CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
         # DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc
         # 
         # CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
         # DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
         # 
         # CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
         # DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc
         # 
         # CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
         # DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
          
          CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
          
          #160720-00015#1---s
          #CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
          #
          #CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
          #160720-00015#1---e
          
          CALL apmt520_pmdt083_ref(g_pmdt_d[l_ac].pmdt083) RETURNING g_pmdt_d[l_ac].pmdt083_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt083_desc
          
          #160720-00015#1---s
          #CALL s_desc_get_project_desc(g_pmdt_d[l_ac].pmdt072) RETURNING g_pmdt_d[l_ac].pmdt072_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt072_desc
          #
          #CALL s_desc_get_wbs_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073) RETURNING g_pmdt_d[l_ac].pmdt073_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt073_desc
          #
          #CALL s_desc_get_activity_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt074) RETURNING g_pmdt_d[l_ac].pmdt074_desc
          #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt074_desc
          #160720-00015#1---e
          
          #160805-00015#1--s
          CALL s_desc_get_acc_desc(g_acc,g_pmdt_d[l_ac].pmdt051) RETURNING g_pmdt_d[l_ac].pmdt051_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt051_desc
          #160805-00015#1--e
          
          #add--2015/08/31 By shiun--(S)
          CALL apmt520_detail_abg('3')
               RETURNING l_success,l_errno,l_bgaf016,l_pmdt075,l_pmdt075_desc
          LET g_pmdt_d[l_ac].pmdt075_desc = l_pmdt075_desc
          #add--2015/08/31 By shiun--(E)
          #161031-00025#15 add(s)
         CALL s_aooi360_sel('7',g_prog,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'','','','','','','','1') RETURNING l_success,g_pmdt_d[l_ac].ooff013
         #161031-00025#15 add(e) 
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_ac
               LET g_errparam.code = 9035 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
    
   #判斷是否填充
   IF apmt520_fill_chk(2) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body2.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdusite,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu003,pmdu004,pmdu006, 
             pmdu007,pmdu008,pmdu005,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu202, 
             pmdu017,pmdu016 ,t13.imaal003 ,t14.inaml004 ,t15.inayl003 ,t16.inab003 ,t17.oocal003 ,t18.oocal003 FROM pmdu_t", 
                
                     " INNER JOIN  pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = pmdudocno ",
 
                     "",
                     
                                    " LEFT JOIN imaal_t t13 ON t13.imaalent="||g_enterprise||" AND t13.imaal001=pmdu001 AND t13.imaal002='"||g_dlang||"' ",
               " LEFT JOIN inaml_t t14 ON t14.inamlent="||g_enterprise||" AND t14.inaml001=pmdu001 AND t14.inaml002=pmdu002 AND t14.inaml003='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t15 ON t15.inaylent="||g_enterprise||" AND t15.inayl001=pmdu006 AND t15.inayl002='"||g_dlang||"' ",
               " LEFT JOIN inab_t t16 ON t16.inabent="||g_enterprise||" AND t16.inabsite=pmdusite AND t16.inab001=pmdu006 AND t16.inab002=pmdu007  ",
               " LEFT JOIN oocal_t t17 ON t17.oocalent="||g_enterprise||" AND t17.oocal001=pmdu009 AND t17.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t18 ON t18.oocalent="||g_enterprise||" AND t18.oocal001=pmdu011 AND t18.oocal002='"||g_dlang||"' ",
 
                     " WHERE pmduent=? AND pmdudocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body2.fill_sql"
         IF NOT cl_null(g_wc2_table1) AND g_wc2_table1 <> " 1=1" THEN
            LET g_wc2_table2 = g_wc2_table2 CLIPPED,
                               " AND (pmdudocno,pmduseq) IN (SELECT pmdtdocno,pmduseq FROM pmdt_t ",
                                                            " WHERE pmduent = pmdtent ",
                                                            "   AND pmdudocno = pmdtdocno ",
                                                            "   AND pmduseq = pmdtseq ",
                                                            "   AND ",g_wc2_table1 CLIPPED,")"
         END IF
         IF NOT cl_null(g_wc2_table3) AND g_wc2_table3 <> " 1=1" THEN
            LET g_wc2_table2 = g_wc2_table2 CLIPPED,
                               " AND (pmdudocno,pmduseq) IN (SELECT pmdvdocno,pmdvseq FROM pmdv_t ",
                                                            " WHERE pmdvent = pmduent ",
                                                            "   AND pmdvdocno = pmdudocno ",
                                                            "   AND pmdvseq = pmduseq ",
                                                            "   AND ",g_wc2_table3 CLIPPED,")"
         END IF                    
         #end add-point
         IF NOT cl_null(g_wc2_table2) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdu_t.pmduseq,pmdu_t.pmduseq1"
         
         #add-point:單身填充控制 name="b_fill.sql2"
         LET g_wc2_table2 = l_wc2_table2   #160719-00002#1                
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt520_pb2 FROM g_sql
         DECLARE b_fill_cs2 CURSOR FOR apmt520_pb2
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs2 USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs2 USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt2_d[l_ac].pmdusite,g_pmdt2_d[l_ac].pmduseq, 
          g_pmdt2_d[l_ac].pmduseq1,g_pmdt2_d[l_ac].pmdu001,g_pmdt2_d[l_ac].pmdu002,g_pmdt2_d[l_ac].pmdu003, 
          g_pmdt2_d[l_ac].pmdu004,g_pmdt2_d[l_ac].pmdu006,g_pmdt2_d[l_ac].pmdu007,g_pmdt2_d[l_ac].pmdu008, 
          g_pmdt2_d[l_ac].pmdu005,g_pmdt2_d[l_ac].pmdu009,g_pmdt2_d[l_ac].pmdu010,g_pmdt2_d[l_ac].pmdu011, 
          g_pmdt2_d[l_ac].pmdu012,g_pmdt2_d[l_ac].pmdu013,g_pmdt2_d[l_ac].pmdu014,g_pmdt2_d[l_ac].pmdu015, 
          g_pmdt2_d[l_ac].pmdu202,g_pmdt2_d[l_ac].pmdu017,g_pmdt2_d[l_ac].pmdu016,g_pmdt2_d[l_ac].pmdu001_desc, 
          g_pmdt2_d[l_ac].pmdu002_desc,g_pmdt2_d[l_ac].pmdu006_desc,g_pmdt2_d[l_ac].pmdu007_desc,g_pmdt2_d[l_ac].pmdu009_desc, 
          g_pmdt2_d[l_ac].pmdu011_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill2.fill"
         CALL s_desc_get_item_desc(g_pmdt2_d[l_ac].pmdu001) RETURNING g_pmdt2_d[l_ac].pmdu001_desc,g_pmdt2_d[l_ac].imaal004
         DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu001_desc,g_pmdt2_d[l_ac].imaal004
         
         #160720-00015#1---s
         #CALL s_feature_description(g_pmdt2_d[l_ac].pmdu001,g_pmdt2_d[l_ac].pmdu002) RETURNING l_success,g_pmdt2_d[l_ac].pmdu002_desc
         #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu002_desc
         #160720-00015#1---e
         
         #160720-00015#1---s
         #CALL s_desc_get_stock_desc(g_site,g_pmdt2_d[l_ac].pmdu006) RETURNING g_pmdt2_d[l_ac].pmdu006_desc
         #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu006_desc
         #
         #CALL s_desc_get_locator_desc(g_site,g_pmdt2_d[l_ac].pmdu006,g_pmdt2_d[l_ac].pmdu007) RETURNING g_pmdt2_d[l_ac].pmdu007_desc
         #DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu007_desc     
         #160720-00015#1---e
         
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF apmt520_fill_chk(3) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body3.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdvsite,pmdvseq,pmdvseq1,pmdv005,pmdv001,pmdv002,pmdv003,pmdv004, 
             pmdv014,pmdv015,pmdv016,pmdv017,pmdv018,pmdv019 ,t19.imaal003 ,t20.inaml004 ,t21.oocal003 FROM pmdv_t", 
                
                     " INNER JOIN  pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = pmdvdocno ",
 
                     "",
                     
                                    " LEFT JOIN imaal_t t19 ON t19.imaalent="||g_enterprise||" AND t19.imaal001=pmdv001 AND t19.imaal002='"||g_dlang||"' ",
               " LEFT JOIN inaml_t t20 ON t20.inamlent="||g_enterprise||" AND t20.inaml001=pmdv001 AND t20.inaml002=pmdv002 AND t20.inaml003='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t21 ON t21.oocalent="||g_enterprise||" AND t21.oocal001=pmdv018 AND t21.oocal002='"||g_dlang||"' ",
 
                     " WHERE pmdvent=? AND pmdvdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body3.fill_sql"
         IF NOT cl_null(g_wc2_table1) AND g_wc2_table1 <> " 1=1" THEN
            LET g_wc2_table3 = g_wc2_table3 CLIPPED,
                               " AND (pmdvdocno,pmdvseq) IN (SELECT pmdtdocno,pmdtseq FROM pmdt_t ",
                                                            " WHERE pmdvent = pmdtent ",
                                                            "   AND pmdvdocno = pmdtdocno ",
                                                            "   AND pmdvseq = pmdtseq ",
                                                            "   AND ",g_wc2_table1 CLIPPED,")"
         END IF
         IF NOT cl_null(g_wc2_table2) AND g_wc2_table2 <> " 1=1" THEN
            LET g_wc2_table3 = g_wc2_table3 CLIPPED,
                               " AND (pmdvdocno,pmdvseq) IN (SELECT pmdudocno,pmduseq FROM pmdu_t ",
                                                            " WHERE pmdvent = pmduent ",
                                                            "   AND pmdvdocno = pmdudocno ",
                                                            "   AND pmdvseq = pmduseq ",
                                                            "   AND ",g_wc2_table3 CLIPPED,")"
         END IF                     
         #end add-point
         IF NOT cl_null(g_wc2_table3) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdv_t.pmdvseq,pmdv_t.pmdvseq1"
         
         #add-point:單身填充控制 name="b_fill.sql3"
         LET g_wc2_table3 = l_wc2_table3   #160719-00002#1                
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt520_pb3 FROM g_sql
         DECLARE b_fill_cs3 CURSOR FOR apmt520_pb3
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs3 USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs3 USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt3_d[l_ac].pmdvsite,g_pmdt3_d[l_ac].pmdvseq, 
          g_pmdt3_d[l_ac].pmdvseq1,g_pmdt3_d[l_ac].pmdv005,g_pmdt3_d[l_ac].pmdv001,g_pmdt3_d[l_ac].pmdv002, 
          g_pmdt3_d[l_ac].pmdv003,g_pmdt3_d[l_ac].pmdv004,g_pmdt3_d[l_ac].pmdv014,g_pmdt3_d[l_ac].pmdv015, 
          g_pmdt3_d[l_ac].pmdv016,g_pmdt3_d[l_ac].pmdv017,g_pmdt3_d[l_ac].pmdv018,g_pmdt3_d[l_ac].pmdv019, 
          g_pmdt3_d[l_ac].pmdv001_desc,g_pmdt3_d[l_ac].pmdv002_desc,g_pmdt3_d[l_ac].pmdv018_desc   #(ver:78) 
 
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill3.fill"
         CALL s_desc_get_item_desc(g_pmdt3_d[l_ac].pmdv001) RETURNING g_pmdt3_d[l_ac].pmdv001_desc,g_pmdt3_d[l_ac].imaal004
         DISPLAY BY NAME g_pmdt2_d[l_ac].pmdu001_desc,g_pmdt2_d[l_ac].imaal004
         
         #160720-00015#1---s
         #CALL s_feature_description(g_pmdt3_d[l_ac].pmdv001,g_pmdt3_d[l_ac].pmdv002) RETURNING l_success,g_pmdt3_d[l_ac].pmdv002_desc
         #DISPLAY BY NAME g_pmdt3_d[l_ac].pmdv002_desc  
         #160720-00015#1---e   
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
 
   
   #add-point:browser_fill段其他table處理 name="browser_fill.other_fill"
   CALL apmt520_b4_fill() 
   IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
      #倉退單，出入庫碼為出庫，其餘為入庫
      IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
         LET l_inao013 = '-1'
      ELSE
         LET l_inao013 = '1'
      END IF
      CALL s_lot_b_fill('1',g_site,'2',g_pmds_m.pmdsdocno,'','',l_inao013) 
   END IF
   #161031-00025#15 add(s)
   LET g_ooff001_d = '6'   #6.單據單頭備註
   LET g_ooff002_d = g_prog
   LET g_ooff003_d = g_pmds_m.pmdsdocno   #单号
   LET g_ooff004_d = 0     #项次
   LET g_ooff005_d = ' '
   LET g_ooff006_d = ' '
   LET g_ooff007_d = ' '
   LET g_ooff008_d = ' '
   LET g_ooff009_d = ' '
   LET g_ooff010_d = ' '
   LET g_ooff011_d = ' '
   CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身 
   #161031-00025#15 add(e)
   #end add-point
   
   CALL g_pmdt_d.deleteElement(g_pmdt_d.getLength())
   CALL g_pmdt2_d.deleteElement(g_pmdt2_d.getLength())
   CALL g_pmdt3_d.deleteElement(g_pmdt3_d.getLength())
 
   
 
   LET l_ac = g_cnt
   LET g_cnt = 0  
   
   FREE apmt520_pb
   FREE apmt520_pb2
 
   FREE apmt520_pb3
 
 
   
   LET li_idx = l_ac
   
   #遮罩相關處理
   FOR l_ac = 1 TO g_pmdt_d.getLength()
      LET g_pmdt_d_mask_o[l_ac].* =  g_pmdt_d[l_ac].*
      CALL apmt520_pmdt_t_mask()
      LET g_pmdt_d_mask_n[l_ac].* =  g_pmdt_d[l_ac].*
   END FOR
   
   LET g_pmdt2_d_mask_o.* =  g_pmdt2_d.*
   FOR l_ac = 1 TO g_pmdt2_d.getLength()
      LET g_pmdt2_d_mask_o[l_ac].* =  g_pmdt2_d[l_ac].*
      CALL apmt520_pmdu_t_mask()
      LET g_pmdt2_d_mask_n[l_ac].* =  g_pmdt2_d[l_ac].*
   END FOR
   LET g_pmdt3_d_mask_o.* =  g_pmdt3_d.*
   FOR l_ac = 1 TO g_pmdt3_d.getLength()
      LET g_pmdt3_d_mask_o[l_ac].* =  g_pmdt3_d[l_ac].*
      CALL apmt520_pmdv_t_mask()
      LET g_pmdt3_d_mask_n[l_ac].* =  g_pmdt3_d[l_ac].*
   END FOR
 
   
   LET l_ac = li_idx
   
   CALL cl_ap_performance_next_end()
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.delete_b" >}
#+ 刪除單身後其他table連動
PRIVATE FUNCTION apmt520_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"
   DEFINE l_pmds054 LIKE pmds_t.pmds054         
   #end add-point     
   
   #add-point:Function前置處理  name="delete_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete"
                        
      #end add-point    
      DELETE FROM pmdt_t
       WHERE pmdtent = g_enterprise AND
         pmdtdocno = ps_keys_bak[1] AND pmdtseq = ps_keys_bak[2]
      #add-point:delete_b段刪除中 name="delete_b.m_delete"
                        
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = ":",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_pmdt_d.deleteElement(li_idx) 
      END IF 
 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete2"
                        
      #end add-point    
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise AND
             pmdudocno = ps_keys_bak[1] AND pmduseq = ps_keys_bak[2] AND pmduseq1 = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete2"
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise AND
         pmdudocno = ps_keys_bak[1] AND pmduseq = ps_keys_bak[2]                  
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_pmdt2_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete2"
                        
      #end add-point    
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete3"
                        
      #end add-point    
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise AND
             pmdvdocno = ps_keys_bak[1] AND pmdvseq = ps_keys_bak[2] AND pmdvseq1 = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete3"
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise AND
         pmdvdocno = ps_keys_bak[1] AND pmdvseq = ps_keys_bak[2]                  
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_pmdt3_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete3"
                        
      #end add-point    
   END IF
 
 
   
 
   
   #add-point:delete_b段other name="delete_b.other"
   #倉退單在過帳還原時若pmds054為'2.採購合約差異處理'時，刪除或作廢單據時，須將對應的pmeo025的狀態更新成'1.未處理'
   LET l_pmds054 = ''
   SELECT pmds054 INTO l_pmds054 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
   IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND (l_pmds054 = '2' OR l_pmds054 = '4') THEN
      #將對應的pmeo025的狀態更新成'1.未處理'
      UPDATE pmeo_t SET pmeo025 = '1',
                        pmeo027 = '',
                        pmeo028 = ''
          WHERE pmeoent = g_enterprise AND (pmeo000 ='1' OR pmeo000 = '3') AND pmeo027 = ps_keys_bak[1] AND pmeo028 = ps_keys_bak[2] 
   END IF         
   #end add-point  
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.insert_b" >}
#+ 新增單身後其他table連動
PRIVATE FUNCTION apmt520_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:insert_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"
            
   #end add-point     
   
   #add-point:Function前置處理  name="insert_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert"
     
      #產品特征為null時，給空格
      IF cl_null(g_pmdt_d[g_detail_idx].pmdt007) THEN
         LET g_pmdt_d[g_detail_idx].pmdt007 = ' '
      END IF 
      
      #儲位、批號 若為空，給一個空格
      IF cl_null(g_pmdt_d[g_detail_idx].pmdt017) THEN
         LET g_pmdt_d[g_detail_idx].pmdt017 = ' '
      END IF 

      IF cl_null(g_pmdt_d[g_detail_idx].pmdt018) THEN
         LET g_pmdt_d[g_detail_idx].pmdt018 = ' '
      END IF
      
      
      #直接收貨入庫時，無需檢驗
      IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
         LET g_pmdt_d[g_detail_idx].pmdt026 = 'N'
      END IF
      
      #150901 earl add s
      ##多角性質為"2:代採購、3:代採購指定供應商、4:統購統付、6:中間交易"
      #IF g_pmds_m.pmds014 MATCHES '[2346]' THEN
      #   LET g_pmdt_d[g_detail_idx].pmdt084 = 'N'
      #ELSE
      #   LET g_pmdt_d[g_detail_idx].pmdt084 = 'Y'
      #END IF
      
#      #自立應付欄位是判斷多角時是不是要自立帳款，所以在一般的採購入庫/倉退與銷售出貨/銷退流程新增時,此欄位均預設為’Y’
#      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
#         LET g_pmdt_d[g_detail_idx].pmdt084 = 'Y'
#      ELSE
#         LET g_pmdt_d[g_detail_idx].pmdt084 = 'N'
#      END IF
      #150901 earl add e
      
      #pmdt084給值一律給"Y"
      LET g_pmdt_d[g_detail_idx].pmdt084 = 'Y'
      #採購性質是VMI時，pmdt084 給'N'
      IF g_argv[1] MATCHES '[67]' AND g_pmds_m.pmds011 = '3' THEN
         LET g_pmdt_d[g_detail_idx].pmdt084 = 'N'
      END IF
      
      IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '25' THEN 
         IF g_pmdt_d[g_detail_idx].pmdt026 = 'Y' THEN
            LET g_pmdt_d[g_detail_idx].pmdt062 = 'N'         
         END IF
      ELSE
         IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N"  OR (NOT apmt520_get_imaf144(g_pmdt_d[g_detail_idx].pmdt006)) THEN
            LET g_pmdt_d[g_detail_idx].pmdt023 = g_pmdt_d[g_detail_idx].pmdt019
            LET g_pmdt_d[g_detail_idx].pmdt024 = g_pmdt_d[g_detail_idx].pmdt020
         END IF
      END IF
      
      #未稅金額、含稅金額
      IF (NOT cl_null(g_pmdt_d[g_detail_idx].pmdt024)) AND (NOT cl_null(g_pmdt_d[g_detail_idx].pmdt046)) THEN
         CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[g_detail_idx].pmdtseq,g_pmdt_d[g_detail_idx].pmdt001,g_pmdt_d[g_detail_idx].pmdt024,g_pmdt_d[g_detail_idx].pmdt036,g_pmdt_d[g_detail_idx].pmdt046)
           RETURNING g_pmdt_d[g_detail_idx].pmdt038,g_pmdt_d[g_detail_idx].pmdt047,g_pmdt_d[g_detail_idx].pmdt039            
      END IF
      
      #end add-point 
      INSERT INTO pmdt_t
                  (pmdtent,
                   pmdtdocno,
                   pmdtseq
                   ,pmdtsite,pmdt027,pmdt028,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081,pmdt082,pmdt083,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021,pmdt022,pmdt008,pmdt023,pmdt024,pmdt090,pmdt091,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt092,pmdt093,pmdt026,pmdt041,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt072,pmdt073,pmdt074,pmdt075,pmdt040,pmdt052,pmdt051,pmdt070,pmdt071,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt042,pmdt043,pmdt048,pmdt044,pmdt045,pmdt049,pmdt050,pmdt084,pmdt219,pmdt089,pmdt088) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2]
                   ,g_pmdt_d[g_detail_idx].pmdtsite,g_pmdt_d[g_detail_idx].pmdt027,g_pmdt_d[g_detail_idx].pmdt028, 
                       g_pmdt_d[g_detail_idx].pmdt001,g_pmdt_d[g_detail_idx].pmdt002,g_pmdt_d[g_detail_idx].pmdt003, 
                       g_pmdt_d[g_detail_idx].pmdt004,g_pmdt_d[g_detail_idx].pmdt081,g_pmdt_d[g_detail_idx].pmdt082, 
                       g_pmdt_d[g_detail_idx].pmdt083,g_pmdt_d[g_detail_idx].pmdt005,g_pmdt_d[g_detail_idx].pmdt006, 
                       g_pmdt_d[g_detail_idx].pmdt007,g_pmdt_d[g_detail_idx].pmdt009,g_pmdt_d[g_detail_idx].pmdt010, 
                       g_pmdt_d[g_detail_idx].pmdt025,g_pmdt_d[g_detail_idx].pmdt011,g_pmdt_d[g_detail_idx].pmdt019, 
                       g_pmdt_d[g_detail_idx].pmdt020,g_pmdt_d[g_detail_idx].pmdt021,g_pmdt_d[g_detail_idx].pmdt022, 
                       g_pmdt_d[g_detail_idx].pmdt008,g_pmdt_d[g_detail_idx].pmdt023,g_pmdt_d[g_detail_idx].pmdt024, 
                       g_pmdt_d[g_detail_idx].pmdt090,g_pmdt_d[g_detail_idx].pmdt091,g_pmdt_d[g_detail_idx].pmdt036, 
                       g_pmdt_d[g_detail_idx].pmdt046,g_pmdt_d[g_detail_idx].pmdt037,g_pmdt_d[g_detail_idx].pmdt038, 
                       g_pmdt_d[g_detail_idx].pmdt039,g_pmdt_d[g_detail_idx].pmdt047,g_pmdt_d[g_detail_idx].pmdt092, 
                       g_pmdt_d[g_detail_idx].pmdt093,g_pmdt_d[g_detail_idx].pmdt026,g_pmdt_d[g_detail_idx].pmdt041, 
                       g_pmdt_d[g_detail_idx].pmdt062,g_pmdt_d[g_detail_idx].pmdt016,g_pmdt_d[g_detail_idx].pmdt017, 
                       g_pmdt_d[g_detail_idx].pmdt018,g_pmdt_d[g_detail_idx].pmdt063,g_pmdt_d[g_detail_idx].pmdt072, 
                       g_pmdt_d[g_detail_idx].pmdt073,g_pmdt_d[g_detail_idx].pmdt074,g_pmdt_d[g_detail_idx].pmdt075, 
                       g_pmdt_d[g_detail_idx].pmdt040,g_pmdt_d[g_detail_idx].pmdt052,g_pmdt_d[g_detail_idx].pmdt051, 
                       g_pmdt_d[g_detail_idx].pmdt070,g_pmdt_d[g_detail_idx].pmdt071,g_pmdt_d[g_detail_idx].pmdt059, 
                       g_pmdt_d[g_detail_idx].pmdt053,g_pmdt_d[g_detail_idx].pmdt054,g_pmdt_d[g_detail_idx].pmdt055, 
                       g_pmdt_d[g_detail_idx].pmdt060,g_pmdt_d[g_detail_idx].pmdt061,g_pmdt_d[g_detail_idx].pmdt042, 
                       g_pmdt_d[g_detail_idx].pmdt043,g_pmdt_d[g_detail_idx].pmdt048,g_pmdt_d[g_detail_idx].pmdt044, 
                       g_pmdt_d[g_detail_idx].pmdt045,g_pmdt_d[g_detail_idx].pmdt049,g_pmdt_d[g_detail_idx].pmdt050, 
                       g_pmdt_d[g_detail_idx].pmdt084,g_pmdt_d[g_detail_idx].pmdt219,g_pmdt_d[g_detail_idx].pmdt089, 
                       g_pmdt_d[g_detail_idx].pmdt088)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert"
                        
      #end add-point 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_pmdt_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert"
      #數量欄位賦 0
      UPDATE pmdt_t  
       SET pmdt056 = 0,
           pmdt057 = 0,
           pmdt058 = 0,
           pmdt066 = 0,
           pmdt067 = 0,
           pmdt068 = 0,
           pmdt069 = 0 
        WHERE pmdtent = g_enterprise AND pmdtdocno = ps_keys[1] AND pmdtseq = ps_keys[2]           
      #end add-point 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert2"
                        
      #end add-point 
      INSERT INTO pmdu_t
                  (pmduent,
                   pmdudocno,
                   pmduseq,pmduseq1
                   ,pmdusite,pmdu001,pmdu002,pmdu003,pmdu004,pmdu006,pmdu007,pmdu008,pmdu005,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_pmdt2_d[g_detail_idx].pmdusite,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002, 
                       g_pmdt2_d[g_detail_idx].pmdu003,g_pmdt2_d[g_detail_idx].pmdu004,g_pmdt2_d[g_detail_idx].pmdu006, 
                       g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu005, 
                       g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,g_pmdt2_d[g_detail_idx].pmdu011, 
                       g_pmdt2_d[g_detail_idx].pmdu012,g_pmdt2_d[g_detail_idx].pmdu013,g_pmdt2_d[g_detail_idx].pmdu014, 
                       g_pmdt2_d[g_detail_idx].pmdu015,g_pmdt2_d[g_detail_idx].pmdu202,g_pmdt2_d[g_detail_idx].pmdu017, 
                       g_pmdt2_d[g_detail_idx].pmdu016)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert2"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_pmdt2_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert2"
                        
      #end add-point
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert3"
                        
      #end add-point 
      INSERT INTO pmdv_t
                  (pmdvent,
                   pmdvdocno,
                   pmdvseq,pmdvseq1
                   ,pmdvsite,pmdv005,pmdv001,pmdv002,pmdv003,pmdv004,pmdv014,pmdv015,pmdv016,pmdv017,pmdv018,pmdv019) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_pmdt3_d[g_detail_idx].pmdvsite,g_pmdt3_d[g_detail_idx].pmdv005,g_pmdt3_d[g_detail_idx].pmdv001, 
                       g_pmdt3_d[g_detail_idx].pmdv002,g_pmdt3_d[g_detail_idx].pmdv003,g_pmdt3_d[g_detail_idx].pmdv004, 
                       g_pmdt3_d[g_detail_idx].pmdv014,g_pmdt3_d[g_detail_idx].pmdv015,g_pmdt3_d[g_detail_idx].pmdv016, 
                       g_pmdt3_d[g_detail_idx].pmdv017,g_pmdt3_d[g_detail_idx].pmdv018,g_pmdt3_d[g_detail_idx].pmdv019) 
 
      #add-point:insert_b段資料新增中 name="insert_b.m_insert3"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_pmdt3_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert3"
                        
      #end add-point
   END IF
 
 
   
 
   
   #add-point:insert_b段other name="insert_b.other"
            
   #end add-point     
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.update_b" >}
#+ 修改單身後其他table連動
PRIVATE FUNCTION apmt520_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"
   
   #end add-point   
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="update_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE   
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdt_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update"
      #儲位、批號 若為空，給一個空格
      IF cl_null(g_pmdt_d[g_detail_idx].pmdt017) THEN
         LET g_pmdt_d[g_detail_idx].pmdt017 = ' '
      END IF 

      IF cl_null(g_pmdt_d[g_detail_idx].pmdt018) THEN
         LET g_pmdt_d[g_detail_idx].pmdt018 = ' '
      END IF   

      IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '25' THEN 
         IF g_pmdt_d[g_detail_idx].pmdt026 = 'Y' THEN
            LET g_pmdt_d[g_detail_idx].pmdt062 = 'N'         
         END IF
      ELSE
         IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" OR (NOT apmt520_get_imaf144(g_pmdt_d[g_detail_idx].pmdt006)) THEN
            LET g_pmdt_d[g_detail_idx].pmdt023 = g_pmdt_d[g_detail_idx].pmdt019
            LET g_pmdt_d[g_detail_idx].pmdt024 = g_pmdt_d[g_detail_idx].pmdt020
         END IF
      END IF
      
      #未稅金額、含稅金額
      IF (NOT cl_null(g_pmdt_d[g_detail_idx].pmdt024)) AND (NOT cl_null(g_pmdt_d[g_detail_idx].pmdt046)) THEN
         CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[g_detail_idx].pmdtseq,g_pmdt_d[g_detail_idx].pmdt001,g_pmdt_d[g_detail_idx].pmdt024,g_pmdt_d[g_detail_idx].pmdt036,g_pmdt_d[g_detail_idx].pmdt046)
           RETURNING g_pmdt_d[g_detail_idx].pmdt038,g_pmdt_d[g_detail_idx].pmdt047,g_pmdt_d[g_detail_idx].pmdt039            
      END IF
      
      #end add-point 
      
      #將遮罩欄位還原
      CALL apmt520_pmdt_t_mask_restore('restore_mask_o')
               
      UPDATE pmdt_t 
         SET (pmdtdocno,
              pmdtseq
              ,pmdtsite,pmdt027,pmdt028,pmdt001,pmdt002,pmdt003,pmdt004,pmdt081,pmdt082,pmdt083,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021,pmdt022,pmdt008,pmdt023,pmdt024,pmdt090,pmdt091,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt092,pmdt093,pmdt026,pmdt041,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt072,pmdt073,pmdt074,pmdt075,pmdt040,pmdt052,pmdt051,pmdt070,pmdt071,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt042,pmdt043,pmdt048,pmdt044,pmdt045,pmdt049,pmdt050,pmdt084,pmdt219,pmdt089,pmdt088) 
              = 
             (ps_keys[1],ps_keys[2]
              ,g_pmdt_d[g_detail_idx].pmdtsite,g_pmdt_d[g_detail_idx].pmdt027,g_pmdt_d[g_detail_idx].pmdt028, 
                  g_pmdt_d[g_detail_idx].pmdt001,g_pmdt_d[g_detail_idx].pmdt002,g_pmdt_d[g_detail_idx].pmdt003, 
                  g_pmdt_d[g_detail_idx].pmdt004,g_pmdt_d[g_detail_idx].pmdt081,g_pmdt_d[g_detail_idx].pmdt082, 
                  g_pmdt_d[g_detail_idx].pmdt083,g_pmdt_d[g_detail_idx].pmdt005,g_pmdt_d[g_detail_idx].pmdt006, 
                  g_pmdt_d[g_detail_idx].pmdt007,g_pmdt_d[g_detail_idx].pmdt009,g_pmdt_d[g_detail_idx].pmdt010, 
                  g_pmdt_d[g_detail_idx].pmdt025,g_pmdt_d[g_detail_idx].pmdt011,g_pmdt_d[g_detail_idx].pmdt019, 
                  g_pmdt_d[g_detail_idx].pmdt020,g_pmdt_d[g_detail_idx].pmdt021,g_pmdt_d[g_detail_idx].pmdt022, 
                  g_pmdt_d[g_detail_idx].pmdt008,g_pmdt_d[g_detail_idx].pmdt023,g_pmdt_d[g_detail_idx].pmdt024, 
                  g_pmdt_d[g_detail_idx].pmdt090,g_pmdt_d[g_detail_idx].pmdt091,g_pmdt_d[g_detail_idx].pmdt036, 
                  g_pmdt_d[g_detail_idx].pmdt046,g_pmdt_d[g_detail_idx].pmdt037,g_pmdt_d[g_detail_idx].pmdt038, 
                  g_pmdt_d[g_detail_idx].pmdt039,g_pmdt_d[g_detail_idx].pmdt047,g_pmdt_d[g_detail_idx].pmdt092, 
                  g_pmdt_d[g_detail_idx].pmdt093,g_pmdt_d[g_detail_idx].pmdt026,g_pmdt_d[g_detail_idx].pmdt041, 
                  g_pmdt_d[g_detail_idx].pmdt062,g_pmdt_d[g_detail_idx].pmdt016,g_pmdt_d[g_detail_idx].pmdt017, 
                  g_pmdt_d[g_detail_idx].pmdt018,g_pmdt_d[g_detail_idx].pmdt063,g_pmdt_d[g_detail_idx].pmdt072, 
                  g_pmdt_d[g_detail_idx].pmdt073,g_pmdt_d[g_detail_idx].pmdt074,g_pmdt_d[g_detail_idx].pmdt075, 
                  g_pmdt_d[g_detail_idx].pmdt040,g_pmdt_d[g_detail_idx].pmdt052,g_pmdt_d[g_detail_idx].pmdt051, 
                  g_pmdt_d[g_detail_idx].pmdt070,g_pmdt_d[g_detail_idx].pmdt071,g_pmdt_d[g_detail_idx].pmdt059, 
                  g_pmdt_d[g_detail_idx].pmdt053,g_pmdt_d[g_detail_idx].pmdt054,g_pmdt_d[g_detail_idx].pmdt055, 
                  g_pmdt_d[g_detail_idx].pmdt060,g_pmdt_d[g_detail_idx].pmdt061,g_pmdt_d[g_detail_idx].pmdt042, 
                  g_pmdt_d[g_detail_idx].pmdt043,g_pmdt_d[g_detail_idx].pmdt048,g_pmdt_d[g_detail_idx].pmdt044, 
                  g_pmdt_d[g_detail_idx].pmdt045,g_pmdt_d[g_detail_idx].pmdt049,g_pmdt_d[g_detail_idx].pmdt050, 
                  g_pmdt_d[g_detail_idx].pmdt084,g_pmdt_d[g_detail_idx].pmdt219,g_pmdt_d[g_detail_idx].pmdt089, 
                  g_pmdt_d[g_detail_idx].pmdt088) 
         WHERE pmdtent = g_enterprise AND pmdtdocno = ps_keys_bak[1] AND pmdtseq = ps_keys_bak[2]
      #add-point:update_b段修改中 name="update_b.m_update"
                        
      #end add-point   
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdt_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
 
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt520_pmdt_t_mask_restore('restore_mask_n')
               
      #add-point:update_b段修改後 name="update_b.after_update"
                        
      #end add-point  
   END IF
   
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
   
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdu_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update2"
                        
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt520_pmdu_t_mask_restore('restore_mask_o')
               
      UPDATE pmdu_t 
         SET (pmdudocno,
              pmduseq,pmduseq1
              ,pmdusite,pmdu001,pmdu002,pmdu003,pmdu004,pmdu006,pmdu007,pmdu008,pmdu005,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_pmdt2_d[g_detail_idx].pmdusite,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002, 
                  g_pmdt2_d[g_detail_idx].pmdu003,g_pmdt2_d[g_detail_idx].pmdu004,g_pmdt2_d[g_detail_idx].pmdu006, 
                  g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008,g_pmdt2_d[g_detail_idx].pmdu005, 
                  g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,g_pmdt2_d[g_detail_idx].pmdu011, 
                  g_pmdt2_d[g_detail_idx].pmdu012,g_pmdt2_d[g_detail_idx].pmdu013,g_pmdt2_d[g_detail_idx].pmdu014, 
                  g_pmdt2_d[g_detail_idx].pmdu015,g_pmdt2_d[g_detail_idx].pmdu202,g_pmdt2_d[g_detail_idx].pmdu017, 
                  g_pmdt2_d[g_detail_idx].pmdu016) 
         WHERE pmduent = g_enterprise AND pmdudocno = ps_keys_bak[1] AND pmduseq = ps_keys_bak[2] AND pmduseq1 = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update2"
                        
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdu_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt520_pmdu_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update2"
                        
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdv_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update3"
                        
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt520_pmdv_t_mask_restore('restore_mask_o')
               
      UPDATE pmdv_t 
         SET (pmdvdocno,
              pmdvseq,pmdvseq1
              ,pmdvsite,pmdv005,pmdv001,pmdv002,pmdv003,pmdv004,pmdv014,pmdv015,pmdv016,pmdv017,pmdv018,pmdv019) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_pmdt3_d[g_detail_idx].pmdvsite,g_pmdt3_d[g_detail_idx].pmdv005,g_pmdt3_d[g_detail_idx].pmdv001, 
                  g_pmdt3_d[g_detail_idx].pmdv002,g_pmdt3_d[g_detail_idx].pmdv003,g_pmdt3_d[g_detail_idx].pmdv004, 
                  g_pmdt3_d[g_detail_idx].pmdv014,g_pmdt3_d[g_detail_idx].pmdv015,g_pmdt3_d[g_detail_idx].pmdv016, 
                  g_pmdt3_d[g_detail_idx].pmdv017,g_pmdt3_d[g_detail_idx].pmdv018,g_pmdt3_d[g_detail_idx].pmdv019)  
 
         WHERE pmdvent = g_enterprise AND pmdvdocno = ps_keys_bak[1] AND pmdvseq = ps_keys_bak[2] AND pmdvseq1 = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update3"
                        
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdv_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt520_pmdv_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update3"
                        
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
 
   
 
   
   #add-point:update_b段other name="update_b.other"
            
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.key_update_b" >}
#+ 上層單身key欄位變動後, 連帶修正下層單身key欄位
PRIVATE FUNCTION apmt520_key_update_b(ps_keys_bak,ps_table)
   #add-point:update_b段define(客製用) name="key_update_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_key       DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_update_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_update_b.pre_function"
   
   #end add-point
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.key_delete_b" >}
#+ 上層單身刪除後, 連帶刪除下層單身key欄位
PRIVATE FUNCTION apmt520_key_delete_b(ps_keys_bak,ps_table)
   #add-point:delete_b段define(客製用) name="key_delete_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_delete_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_delete_b.pre_function"
   
   #end add-point
   
 
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.lock_b" >}
#+ 連動lock其他單身table資料
PRIVATE FUNCTION apmt520_lock_b(ps_table,ps_page)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"
   
   #end add-point   
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="lock_b.pre_function"
   
   #end add-point
    
   #先刷新資料
   #CALL apmt520_b_fill()
   
   #鎖定整組table
   #LET ls_group = "'1',"
   #僅鎖定自身table
   LET ls_group = "pmdt_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN apmt520_bcl USING g_enterprise,
                                       g_pmds_m.pmdsdocno,g_pmdt_d[g_detail_idx].pmdtseq     
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt520_bcl:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
                                    
   #鎖定整組table
   #LET ls_group = "'2',"
   #僅鎖定自身table
   LET ls_group = "pmdu_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt520_bcl2 USING g_enterprise,
                                             g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt520_bcl2:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'3',"
   #僅鎖定自身table
   LET ls_group = "pmdv_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt520_bcl3 USING g_enterprise,
                                             g_pmds_m.pmdsdocno,g_pmdt3_d[g_detail_idx].pmdvseq,g_pmdt3_d[g_detail_idx].pmdvseq1 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt520_bcl3:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
 
   
 
   
   #add-point:lock_b段other name="lock_b.other"
            
   #end add-point  
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.unlock_b" >}
#+ 連動unlock其他單身table資料
PRIVATE FUNCTION apmt520_unlock_b(ps_table,ps_page)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"
   
   #end add-point  
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"
            
   #end add-point  
   
   #add-point:Function前置處理  name="unlock_b.pre_function"
   
   #end add-point
    
   LET ls_group = "'1',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt520_bcl
   END IF
   
   LET ls_group = "'2',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt520_bcl2
   END IF
 
   LET ls_group = "'3',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt520_bcl3
   END IF
 
 
   
 
 
   #add-point:unlock_b段other name="unlock_b.other"
            
   #end add-point  
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_entry" >}
#+ 單頭欄位開啟設定
PRIVATE FUNCTION apmt520_set_entry(p_cmd)
   #add-point:set_entry段define(客製用) name="set_entry.define_customerization"
   
   #end add-point       
   DEFINE p_cmd   LIKE type_t.chr1  
   #add-point:set_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry.define"
            
   #end add-point       
   
   #add-point:Function前置處理  name="set_entry.pre_function"
   
   #end add-point
   
   CALL cl_set_comp_entry("pmdsdocno",TRUE)
   
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("pmdsdocno",TRUE)
      CALL cl_set_comp_entry("pmdsdocdt",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry段欄位控制 name="set_entry.field_control"
      CALL cl_set_comp_entry("pmdsdocdt",TRUE)
      #end add-point  
   END IF
   
   #add-point:set_entry段欄位控制後 name="set_entry.after_control"
   CALL cl_set_comp_entry("pmdsdocno,pmdsdocdt",TRUE)
   CALL cl_set_comp_entry("pmds002,pmds003",TRUE)
   CALL cl_set_comp_entry("pmds006,pmds007,pmds008,pmds009,pmds010",TRUE)
   CALL cl_set_comp_entry("pmds011,pmds012",TRUE)
   CALL cl_set_comp_entry("pmds021,pmds022,pmds023,pmds024",TRUE)
   CALL cl_set_comp_entry("pmds031,pmds032,pmds033",TRUE)
   CALL cl_set_comp_entry("pmds036,pmds037,pmds038,pmds039,pmds040",TRUE)
   CALL cl_set_comp_entry("pmds041,pmds045",TRUE)
   CALL cl_set_comp_entry("pmds048,pmds049",TRUE)
   CALL cl_set_comp_entry("pmds052,pmds053",TRUE)
   CALL cl_set_comp_entry("pmds081,pmds100",TRUE)
   CALL cl_set_comp_entry("pmds001",TRUE)  #160604-00034#7
   
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_no_entry" >}
#+ 單頭欄位關閉設定
PRIVATE FUNCTION apmt520_set_no_entry(p_cmd)
   #add-point:set_no_entry段define(客製用) name="set_no_entry.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry.define"
   DEFINE l_n     LIKE type_t.num5        
   #ming 20151012 add ----------(S) 
   DEFINE l_count LIKE type_t.num5 
   #ming 20151012 add ----------(E) 
   #end add-point     
   
   #add-point:Function前置處理  name="set_no_entry.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("pmdsdocno",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry段欄位控制 name="set_no_entry.field_control"
      #CALL cl_set_comp_entry("pmdsdocdt",FALSE)
      #end add-point 
   END IF 
   
   IF p_cmd = 'u' THEN  #docno,ld欄位確認是絕對關閉
      CALL cl_set_comp_entry("pmdsdocno",FALSE)
   END IF 
 
#  IF p_cmd = 'u' THEN  #docdt欄位依照設定關閉(FALSE則為設定不同意修正) #(ver:78)
      IF NOT cl_chk_update_docdt() THEN
         CALL cl_set_comp_entry("pmdsdocdt",FALSE)
      END IF
#  END IF 
   
   #add-point:set_no_entry段欄位控制後 name="set_no_entry.after_control"
   #160604-00034#7-S
   IF NOT cl_chk_update_pstdt() THEN
      CALL cl_set_comp_entry("pmds001",FALSE)
   END IF   
   #160604-00034#7-E
   IF NOT cl_null(g_pmds_m.pmds006) THEN
      CALL cl_set_comp_entry("pmds007,pmds008,pmds011,pmds014",FALSE)
   END IF
   
   IF g_argv[1] = '8' OR g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14' OR g_argv[1] = '9' OR g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' OR g_argv[1] = '20' THEN
      CALL cl_set_comp_entry("pmds011,pmds014",FALSE)
   END IF
   
   #驗退、入庫時，根據收貨單帶出的相關資訊欄位，不可修改
   IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
      CALL cl_set_comp_entry("pmds007,pmds008,pmds009,pmds010,pmds011,pmds021,pmds022,pmds023,pmds024,pmds041,pmds042,pmds014",FALSE)
      
   END IF
   IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
      CALL cl_set_comp_entry("pmds011",FALSE)
      
   END IF
   
   #如果單身有維護資料，則收貨單號欄位不可以進行修改
   SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
   IF l_n > 0 THEN
      CALL cl_set_comp_entry("pmds006,pmds014",FALSE)
   END IF
   
   #取回日期只有在用取回action時，才可錄入
   #IF g_flag3 THEN
   #   CALL cl_set_comp_entry("pmds081",FALSE)
   #END IF
   
   #委外倉退的倉退方式只能選4.倉退折讓，其他的都不能選，請在輸入時限制
   IF g_argv[1] = '14' THEN
      CALL cl_set_comp_entry("pmds100",FALSE)
   END IF
   
   #收貨單有輸入採購單號將”多角流程代碼”帶入並且no_entry
   IF g_argv[1] MATCHES '[13896]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '20' THEN
      IF NOT cl_null(g_pmds_m.pmds006) THEN
         CALL cl_set_comp_entry("pmds053",FALSE)
      ELSE
         #無輸入採購單號時若多角性質為”2:代採購、3:代採購指定供應商”時”多角流程代碼”才可輸入
         IF g_pmds_m.pmds014 NOT MATCHES '[23]' OR g_argv[1] = '24' THEN
            CALL cl_set_comp_entry("pmds053",FALSE)
         END IF
      END IF
   ELSE
      CALL cl_set_comp_entry("pmds053",FALSE)
   END IF
   
   #財務資訊頁籤不可輸入
   IF g_argv[1] MATCHES '[135689]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '20' THEN
       IF NOT cl_null(g_pmds_m.pmds006) THEN 
          #161111-00053#1--s
          #CALL cl_set_comp_entry("pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040,pmds012",FALSE)  
          IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' THEN
             CALL cl_set_comp_entry("pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040,pmds012",FALSE)  
          ELSE
             CALL cl_set_comp_entry("pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,pmds037,pmds039,pmds040,pmds012",FALSE)
             IF g_pmds_m.pmds049 <> '2' THEN
                CALL cl_set_comp_entry("pmds038",FALSE)
             END IF
          END IF             
          #161111-00053#1---e
       END IF
   END IF

   
   #150917-00001#3   2016/03/03  By earl mark s
#   #150615 earl add s
#   #有來源且中斷續拋
#   IF NOT cl_null(g_pmds_m.pmds006)
#      AND apmt520_break_continue(g_pmds_m.pmds053) THEN
#      
#      #除多角序號pmds041，其餘欄位全鎖
#      CALL cl_set_comp_entry("pmdsdocno,pmdsdocdt",FALSE)
#      CALL cl_set_comp_entry("pmds002,pmds003",FALSE)
#      CALL cl_set_comp_entry("pmds009,pmds010",FALSE)
#      CALL cl_set_comp_entry("pmds021,pmds022,pmds023,pmds024",FALSE)
#      CALL cl_set_comp_entry("pmds042,pmds045,pmds048,pmds049",FALSE)
#      CALL cl_set_comp_entry("pmds052",FALSE)
#      
#   ELSE
      CALL cl_set_comp_entry("pmds041",FALSE)  #多角序號
#   END IF
#   #150615 earl add e 
   #150917-00001#3   2016/03/03  By earl mark e
   
   #ming 20151012 add ----------(S) 
   #apmt530如果已經有單身資料的話，則供應商欄位皆不可修改 
   IF g_argv[1] = '3' THEN 
      LET l_count = 0 
      SELECT COUNT(1) INTO l_count 
        FROM pmdt_t 
       WHERE pmdtent   = g_enterprise 
         AND pmdtdocno = g_pmds_m.pmdsdocno 
      IF cl_null(l_count) THEN 
         LET l_count = 0 
      END IF 
      IF l_count > 0 THEN 
         CALL cl_set_comp_entry("pmds007,pmds008,pmds009",FALSE) 
      END IF 
   END IF 
   #ming 20151012 add ----------(E) 
   
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_entry_b" >}
#+ 單身欄位開啟設定
PRIVATE FUNCTION apmt520_set_entry_b(p_cmd)
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
            
   #end add-point     
   
   #add-point:Function前置處理  name="set_entry_b.pre_function"
   
   #end add-point
    
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("",TRUE)
      #add-point:set_entry段欄位控制 name="set_entry_b.field_control"
      
      #end add-point  
   END IF
   
   #add-point:set_entry_b段 name="set_entry_b.set_entry_b"
   CALL cl_set_comp_entry("pmdt001,pmdt002,pmdt003,pmdt004,pmdt005",TRUE)
   CALL cl_set_comp_entry("pmdt006,pmdt007,pmdt008,pmdt009,pmdt010",TRUE)
   CALL cl_set_comp_entry("pmdt016,pmdt017,pmdt018,pmdt019,pmdt020",TRUE)
   CALL cl_set_comp_entry("pmdt022,pmdt023,pmdt024,pmdt025",TRUE)
   CALL cl_set_comp_entry("pmdt028",TRUE)
   CALL cl_set_comp_entry("pmdt036,pmdt046",TRUE)
   CALL cl_set_comp_entry("pmdt062,pmdt063",TRUE) 
   CALL cl_set_comp_entry("pmdt072,pmdt073,pmdt074,pmdt075",TRUE)
   CALL cl_set_comp_entry("pmdt081,pmdt082,pmdt089",TRUE)
   CALL cl_set_comp_entry("pmdt219",TRUE) #160512-00004#2-add
   CALL cl_set_comp_required("pmdt018",FALSE)  #160519-00022#7 add
   #end add-point  
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_no_entry_b" >}
#+ 單身欄位關閉設定
PRIVATE FUNCTION apmt520_set_no_entry_b(p_cmd)
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"
   
   #end add-point    
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   DEFINE l_imaa005   LIKE imaa_t.imaa005
   DEFINE l_pmdn028   LIKE pmdn_t.pmdn028
   DEFINE l_pmdn029   LIKE pmdn_t.pmdn029
   DEFINE l_pmdn030   LIKE pmdn_t.pmdn030
   DEFINE l_imaf015   LIKE imaf_t.imaf015
   DEFINE l_imaf144   LIKE imaf_t.imaf144
   DEFINE l_pmdt016   LIKE pmdt_t.pmdt016
   DEFINE l_pmdt017   LIKE pmdt_t.pmdt017
   DEFINE l_pmdt018   LIKE pmdt_t.pmdt018
   DEFINE l_inaa007   LIKE inaa_t.inaa007
   DEFINE l_imaf061   LIKE imaf_t.imaf061
   DEFINE l_imaf055   LIKE imaf_t.imaf055
   DEFINE l_pmdn053   LIKE pmdn_t.pmdn053
   DEFINE l_pmdt063   LIKE pmdt_t.pmdt063
   #add--2015/08/31 By shiun--(S)
   DEFINE l_success   LIKE type_t.num5     
   DEFINE l_slip      LIKE pmds_t.pmdsdocno
   #add--2015/08/31 By shiun--(E)
   DEFINE l_pjaa013   LIKE pjaa_t.pjaa013
   DEFINE l_n         LIKE type_t.num5   #160606-00013#1
   DEFINE l_inad014   LIKE inad_t.inad014 #160512-00004#2-add
   DEFINE l_inad011   LIKE inad_t.inad011 #160512-00004#2-add
   DEFINE l_mfg_0085  LIKE type_t.chr1    #161006-00018#8
   #end add-point    
   
   #add-point:Function前置處理  name="set_no_entry_b.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"
      
      #end add-point 
   END IF 
   
   #add-point:set_no_entry_b段 name="set_no_entry_b.set_no_entry_b"
   #單頭採購單不為空時，單身預設單頭的採購單號
   IF (NOT cl_null(g_pmds_m.pmds006)) OR (NOT cl_null(g_pmdt_d[l_ac].pmdt001)) THEN
      #160606-00013#1---s
      #CALL cl_set_comp_entry("pmdt001,pmdt025,pmdt005,pmdt019,pmdt021,pmdt022,pmdt008,pmdt023,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt026",FALSE)
      IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' THEN
         #CALL cl_set_comp_entry("pmdt001,pmdt025,pmdt019,pmdt021,pmdt022,pmdt008,pmdt023,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt026",FALSE)  #170103-00025#1
         CALL cl_set_comp_entry("pmdt001,pmdt025,pmdt019,pmdt021,pmdt008,pmdt023,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt026",FALSE)  #170103-00025#1
         #当委外采购来源工单有联产品，子件特性要可以修改为联产品，然后料件可以输入联产品料号
         IF NOT cl_null(g_pmdt_d[l_ac].pmdt002) THEN
            SELECT COUNT(pmdpseq) INTO l_n FROM pmdp_t,sfac_t
               WHERE pmdpent = sfacent AND pmdp003 = sfacdocno AND sfac002 = '2' #联产品
                 AND pmdpent = g_enterprise AND pmdpdocno = g_pmdt_d[l_ac].pmdt001 AND pmdpseq = g_pmdt_d[l_ac].pmdt002 
            IF l_n = 0 OR cl_null(l_n) THEN
                CALL cl_set_comp_entry("pmdt005",FALSE)
            END IF
         END IF
      ELSE
         #CALL cl_set_comp_entry("pmdt001,pmdt025,pmdt005,pmdt019,pmdt021,pmdt022,pmdt008,pmdt023,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt026",FALSE) #170103-00025#1
         CALL cl_set_comp_entry("pmdt001,pmdt025,pmdt005,pmdt019,pmdt021,pmdt008,pmdt023,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt026",FALSE) #170103-00025#1
      END IF
      #160606-00013#1---e
      IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
         CALL cl_set_comp_entry("pmdt006,pmdt007",FALSE)
         CALL cl_set_comp_entry("pmdt001,pmdt002,pmdt003,pmdt004",FALSE)
      END IF
   END IF
   
   #倉退單單頭沒打收貨單號時，倉退方式不能選"2"，且單身收貨項次、採購單號、項次、項序要分批序都不能打
   IF cl_null(g_pmds_m.pmds006) THEN   
      IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
         CALL cl_set_comp_entry("pmdt028,pmdt001,pmdt002,pmdt003,pmdt004",FALSE)
      END IF
   END IF 
   
   #IF g_argv[1] MATCHES '[24]' THEN
      #當料件有使用產品特徵功能時此欄位才可輸入
      LET l_imaa005  = ''
      SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_pmdt_d[l_ac].pmdt006
      IF cl_null(l_imaa005) THEN
         CALL cl_set_comp_entry("pmdt007",FALSE)
         LET g_pmdt_d[l_ac].pmdt007 = ' '
         LET g_pmdt_d[l_ac].pmdt007_desc = ''
      ELSE
         IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
            LET g_pmdt_d[l_ac].pmdt007 = ''
            LET g_pmdt_d[l_ac].pmdt007_desc = ''
         END IF
      END IF
      
      #當料件主檔設置要做參考單位管理時，則參考数量允許輸入，不允許空白
      LET l_imaf015 = ''
      LET l_imaf144 = ''
      LET l_imaf061 = ''
      LET l_imaf055 = ''
      SELECT imaf015,imaf144,imaf061,imaf055 INTO l_imaf015,l_imaf144,l_imaf061,l_imaf055 FROM imaf_t WHERE imafent = g_enterprise AND imaf001 = g_pmdt_d[l_ac].pmdt006 AND imafsite = g_site
      IF cl_null(l_imaf015) THEN
         CALL cl_set_comp_entry("pmdt022",FALSE)
         LET g_pmdt_d[l_ac].pmdt021 = ''
         LET g_pmdt_d[l_ac].pmdt021_desc = ''
         LET g_pmdt_d[l_ac].pmdt022 = ''
      END IF

      #料件不使用計價單位是，計價單位、計價數量不可維護
      IF cl_null(l_imaf144) THEN
         CALL cl_set_comp_entry("pmdt023,pmdt024",FALSE)
         LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
         LET g_pmdt_d[l_ac].pmdt023_desc = g_pmdt_d[l_ac].pmdt019_desc
         LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
      END IF  

      #[T:料件據點進銷存檔].[C:庫存批號控管]=2時,[C:不可有批號]欄位不可輸入
      IF l_imaf061 = '2' THEN
         CALL cl_set_comp_entry("pmdt018",FALSE)
         LET g_pmdt_d[l_ac].pmdt018 = ' '
      END IF
      #160519-00022#7---add---s
      #入库单的批号需要根据料件设定进行控管
      IF g_argv[1] MATCHES '[346]' THEN      
         CASE l_imaf061
            WHEN '1'
               CALL cl_set_comp_required("pmdt018",TRUE)
            WHEN '2'
               CALL cl_set_comp_entry("pmdt018",FALSE)
         END CASE 
      END IF         
      #160519-00022#7---add---e       
      #若設定imaf055(庫存管理特徵)等於'2.不可有庫存管理特徵'時，則[C:庫存管理特徵]欄位不可輸入
      IF l_imaf055 = '2' THEN
         CALL cl_set_comp_entry("pmdt063",FALSE)
         LET g_pmdt_d[l_ac].pmdt063 = ' '
      END IF
   #END IF
   
   #收貨時，來源單據有維護庫儲批 則，不可再修改
   #入庫、驗退、倉退時，來源採購單據有維護庫儲批 則，不可再修改
   IF g_argv[1] MATCHES '[1389567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
      #161006-00018#8---s
      CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_slip
      #來源單據指定庫儲後，是否允許修改
      LET l_mfg_0085 = cl_get_doc_para(g_enterprise,g_site,l_slip,'D-MFG-0085')
      
      #如果來源單據的庫位資料不為空，則依單別參數判斷庫儲批欄位是否可以修改
      #如果來源單據的庫位資料為空，則不依參數，都要可以維護
      IF l_mfg_0085 = 'N' THEN
      #161006-00018#8---e
         LET l_pmdn028 = ''
         LET l_pmdn029 = ''
         LET l_pmdn030 = ''
         SELECT pmdn028,pmdn029,pmdn030,pmdn053 INTO l_pmdn028,l_pmdn029,l_pmdn030,l_pmdn053
            FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdt_d[l_ac].pmdt001 AND pmdnseq = g_pmdt_d[l_ac].pmdt002
      
         IF NOT cl_null(l_pmdn028) THEN
             CALL cl_set_comp_entry("pmdt016",FALSE)
         END IF
         IF NOT cl_null(l_pmdn029) THEN
             CALL cl_set_comp_entry("pmdt017",FALSE)
         END IF
         IF NOT cl_null(l_pmdn030) THEN
             CALL cl_set_comp_entry("pmdt018",FALSE)
         END IF
         IF NOT cl_null(l_pmdn053) THEN
             CALL cl_set_comp_entry("pmdt063",FALSE)
         END IF
         #來源單號中有限定庫儲批，則多庫儲批否不可錄入
         IF (NOT cl_null(l_pmdn028)) OR (NOT cl_null(l_pmdn029)) OR (NOT cl_null(l_pmdn030)) THEN
            CALL cl_set_comp_entry("pmdt062",FALSE) 
         END IF
            
         #入庫、驗退單有QC單維護了庫儲批時，庫儲批也不可以修改
         IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
            SELECT qcbc005,qcbc006,qcbc007 INTO l_pmdn028,l_pmdn029,l_pmdn030
               FROM qcbc_t WHERE qcbcent = g_enterprise AND qcbcdocno = g_pmdt_d[l_ac].pmdt081 AND qcbcseq = g_pmdt_d[l_ac].pmdt082
            IF NOT cl_null(l_pmdn028) THEN
                CALL cl_set_comp_entry("pmdt016",FALSE)
            END IF
            IF NOT cl_null(l_pmdn029) THEN
                CALL cl_set_comp_entry("pmdt017",FALSE)
            END IF
            IF NOT cl_null(l_pmdn030) THEN
                CALL cl_set_comp_entry("pmdt018",FALSE)
            END IF
            IF NOT cl_null(l_pmdn053) THEN
                CALL cl_set_comp_entry("pmdt063",FALSE)
            END IF
            #來源單號中有限定庫儲批，則多庫儲批否不可錄入
            IF (NOT cl_null(l_pmdn028)) OR (NOT cl_null(l_pmdn029)) OR (NOT cl_null(l_pmdn030)) THEN
               CALL cl_set_comp_entry("pmdt062",FALSE) 
            END IF
         END IF
      END IF   #161006-00018#8 add
   END IF
   
   ##入庫、驗退、倉退時，來源採購單據有維護庫儲批 則，不可再修改
   #IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
   #   LET l_pmdt016 = ''
   #   LET l_pmdt017 = ''
   #   LET l_pmdt018 = ''
   #   SELECT pmdt016,pmdt017,pmdt018,pmdt063 INTO l_pmdt016,l_pmdt017,l_pmdt018,l_pmdt063
   #      FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028
   #   IF NOT cl_null(l_pmdt016) THEN
   #       CALL cl_set_comp_entry("pmdt016",FALSE)
   #   END IF
   #   IF NOT cl_null(l_pmdt017) THEN
   #       CALL cl_set_comp_entry("pmdt017",FALSE)
   #   END IF
   #   IF NOT cl_null(l_pmdt018) THEN
   #       CALL cl_set_comp_entry("pmdt018",FALSE)
   #   END IF
   #   IF NOT cl_null(l_pmdt063) THEN
   #       CALL cl_set_comp_entry("pmdt063",FALSE)
   #   END IF
   #   #來源單號中有限定庫儲批，則多庫儲批否不可錄入
   #   IF (NOT cl_null(l_pmdt016)) OR (NOT cl_null(l_pmdt017)) OR (NOT cl_null(l_pmdt018)) THEN
   #      CALL cl_set_comp_entry("pmdt062",FALSE) 
   #   END IF
   #END IF
   
   IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN
      #CALL cl_set_comp_entry("pmdt006,pmdt007,pmdt008,pmdt009,pmdt010,pmdt016,pmdt017,pmdt018,pmdt019",FALSE)
      CALL cl_set_comp_entry("pmdt006,pmdt007,pmdt008,pmdt009,pmdt010,pmdt019",FALSE)
   END IF
   
   #驗退、入庫單時可輸，其他noentry
   IF g_argv[1] MATCHES '[1234789]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
      CALL cl_set_comp_entry("pmdt081,pmdt082",FALSE)
   END IF
   
   #160512-00004#2-mod-(S)
#   IF g_pmdt_d[l_ac].pmdt062 = 'Y' THEN
#      LET g_pmdt_d[l_ac].pmdt016 = ''
#      LET g_pmdt_d[l_ac].pmdt016_desc = ''
#      LET g_pmdt_d[l_ac].pmdt017 = ''
#      LET g_pmdt_d[l_ac].pmdt017_desc = ''
#      LET g_pmdt_d[l_ac].pmdt018 = ''
#      LET g_pmdt_d[l_ac].pmdt089 = ''
#      CALL cl_set_comp_entry("pmdt016,pmdt017,pmdt018,pmdt089",FALSE)
#   END IF
   IF g_pmdt_d[l_ac].pmdt062 = 'Y' THEN
      LET g_pmdt_d[l_ac].pmdt016 = ''
      LET g_pmdt_d[l_ac].pmdt016_desc = ''
      LET g_pmdt_d[l_ac].pmdt017 = ''
      LET g_pmdt_d[l_ac].pmdt017_desc = ''
      LET g_pmdt_d[l_ac].pmdt018 = ''
      LET g_pmdt_d[l_ac].pmdt089 = ''
      LET g_pmdt_d[l_ac].pmdt219 = ''
      CALL cl_set_comp_entry("pmdt016,pmdt017,pmdt018,pmdt089,pmdt219",FALSE)
   ELSE
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt006) AND NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
         LET l_inad011 = ''
         LET l_inad014 = ''
         SELECT inad014,inad011 INTO l_inad014,l_inad011
           FROM inad_t
          WHERE inadent = g_enterprise
            AND inadsite = g_site
            AND inad001 = g_pmdt_d[l_ac].pmdt006
            AND inad002 = g_pmdt_d[l_ac].pmdt007
            AND inad003 = g_pmdt_d[l_ac].pmdt018
         #製造日期
         IF NOT cl_null(l_inad014) THEN
            LET g_pmdt_d[l_ac].pmdt219 = l_inad014
            CALL cl_set_comp_entry("pmdt219",FALSE)
         END IF
         #有效日期
         IF NOT cl_null(l_inad011) THEN
            LET g_pmdt_d[l_ac].pmdt089 = l_inad011
            CALL cl_set_comp_entry("pmdt089",FALSE)
         END IF
         DISPLAY BY NAME g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089
      END IF
   END IF
   #160512-00004#2-mod-(E)
   
   #倉退單，當倉退方式為'4:'價格折讓'時，數量欄位預設為0且不可以維護
   #IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND g_pmds_m.pmds100 = '4' THEN
   #   CALL cl_set_comp_entry("pmdt020",FALSE) 
   #END IF
   
   #庫位不使用儲位管理時，儲位不可維護
   SELECT inaa007 INTO l_inaa007 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_pmdt_d[l_ac].pmdt016
   IF l_inaa007 = '5' THEN
      CALL cl_set_comp_entry("pmdt017",FALSE)
      LET g_pmdt_d[l_ac].pmdt017 = ' '
      LET g_pmdt_d[l_ac].pmdt017_desc = ''
   END IF
   
   IF g_argv[1] MATCHES '[24]' THEN
      #無採購單的收貨/收貨入庫
      #若1.正常稅率，則單身稅別不可輸入
      IF g_tax_app = '1' THEN
         CALL cl_set_comp_entry("pmdt046",FALSE)
      END IF
      #單頭取價方式的基本資料設置不允許修改單價 , 未取到價格不允許人工輸入
      IF (g_pmdt_d[l_ac].pmdt036 > 0 OR g_pmam002 <> 'Y') AND g_pmam003 <> 'Y' THEN
         CALL cl_set_comp_entry("pmdt036",FALSE)
      END IF
   ELSE
      CALL cl_set_comp_entry("pmdt036",FALSE)
      #CALL cl_set_comp_entry("pmdt072,pmdt073,pmdt074",FALSE)
   END IF
   
   #無收貨來源的倉退單可以輸入專案編號等欄位，有收貨來源則不可輸入
   IF ((g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15') AND (NOT cl_null(g_pmds_m.pmds006))) OR (g_argv[1] NOT MATCHES '[24]')  THEN
      CALL cl_set_comp_entry("pmdt072,pmdt073,pmdt074",FALSE)
   END IF
   
   IF g_pmdt_d[l_ac].pmdt005 = '9' THEN  #樣品
      CALL cl_set_comp_entry("pmdt036,pmdt001,pmdt002,pmdt003,pmdt004",FALSE)
   END IF

   #借貨管理下，庫存管理特徵欄位不可輸入
   IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' THEN
      CALL cl_set_comp_entry("pmdt063",FALSE)
   END IF
   
   #add--2015/08/31 By shiun--(S)
   CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno)
        RETURNING l_success,l_slip
   IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'N' THEN
      CALL cl_set_comp_entry("pmdt75",FALSE)
   END IF
   
   #有專案代號且"專案庫存控管"="Y"時，自動將專案代號帶入庫存管理特徵欄位中，不可修改
   IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '20' THEN
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt072) THEN
         SELECT pjaa013 INTO l_pjaa013 FROM pjaa_t,pjba_t 
            WHERE pjaaent = pjbaent AND pjaa001 = pjba000 AND pjaaent = g_enterprise AND pjba001 = g_pmdt_d[l_ac].pmdt072
         IF l_pjaa013 = 'Y' THEN
            LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d[l_ac].pmdt072
            CALL cl_set_comp_entry("pmdt063",FALSE)
         END IF
      END IF  
   END IF      
   #add--2015/08/31 By shiun--(S)
   #end add-point     
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_act_visible" >}
#+ 單頭權限開啟
PRIVATE FUNCTION apmt520_set_act_visible()
   #add-point:set_act_visible段define(客製用) name="set_act_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible.define"
   
   #end add-point   
   #add-point:set_act_visible段 name="set_act_visible.set_act_visible"
   CALL cl_set_act_visible("modify,delete,modify_detail,open_apmt520_03",TRUE)
   
   CALL cl_set_act_visible("gen_pmdt,gen_pmdv",TRUE)   
   
   #只有無採購單時，複製功能才有意義，其他有來源單據，都是根據來源單據帶值
   CALL cl_set_act_visible("reproduce",TRUE)   
   
   #驗退、倉退下顯示取回日期，取回功能
   CALL cl_set_act_visible("upd_pmds081,upd_pmds052",TRUE) 
  
   #入庫、倉退下顯示可以修改價格
   CALL cl_set_act_visible("upd_price",TRUE) 
  
   #收貨單 下 可以顯示產生入庫單
   #CALL cl_set_act_visible("gen_warehouse_voucher,gen_check_back,query_check_back,query_warehouse_voucher",TRUE) #170118-00051#1
   CALL cl_set_act_visible("gen_warehouse_or_check_back,query_check_back,query_warehouse_voucher",TRUE) #170118-00051#1
   
   #當倉退方式為2,3時才可以執行此action產生新的一張採購單
   CALL cl_set_act_visible("gen_purchase",TRUE)
   
   CALL cl_set_act_visible("gen_qc,store_in_by_qc,get_detail_price,query_qc",TRUE)
   
   #入庫、倉退單據性質下，顯示產生入庫、倉退單發票的action
   CALL cl_set_act_visible("gen_aapp320,gen_aapp320_7",TRUE)
   
   #判斷據點參數若收貨單使用製造批序號時，則製造批序號頁簽可以維護(據點參數:S-BAS-0049)
   CALL cl_set_act_visible("s_lot_ins",TRUE)
   
   #委外入庫單下，顯示產生報工單、工單入庫單
   CALL cl_set_act_visible("gen_asft335,gen_asft340",TRUE)  #151023-00018#1  add
   
   #委外入庫單下，顯示產生倒扣料
   CALL cl_set_act_visible("gen_asft314",TRUE)  #160128-00023#1 add
   
   CALL cl_set_act_visible("gen_pmdw",TRUE)     #161101-00064#1 add  
      
   LET g_upd_price = TRUE
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_act_no_visible" >}
#+ 單頭權限關閉
PRIVATE FUNCTION apmt520_set_act_no_visible()
   #add-point:set_act_no_visible段define(客製用) name="set_act_no_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible.define"
   DEFINE l_n1       LIKE type_t.num5
   DEFINE l_n2       LIKE type_t.num5
   DEFINE l_cnt      LIKE type_t.num5
   
   #end add-point   
   #add-point:set_act_no_visible段 name="set_act_no_visible.set_act_no_visible"
   IF g_pmds_m.pmdsstus <> 'N' THEN
      #CALL cl_set_act_visible("modify,delete,modify_detail,get_detail_price",FALSE)
      CALL cl_set_act_visible("get_detail_price",FALSE)
   END IF
   IF g_pmds_m.pmdsstus NOT MATCHES '[NY]' THEN
      CALL cl_set_act_visible("open_apmt520_03",FALSE)
   END IF
   
   IF NOT ((g_argv[1] MATCHES '[13]' OR g_argv[1] = '23' OR g_argv[1] = '24') AND g_pmds_m.pmdsstus = 'N') THEN   #採購收貨單
      CALL cl_set_act_visible("gen_pmdt,gen_pmdv",FALSE)
   END IF

   #只有無採購單時，複製功能才有意義，其他有來源單據，都是根據來源單據帶值
   IF g_argv[1] NOT MATCHES '[24]' THEN
      CALL cl_set_act_visible("reproduce",FALSE)
   END IF
   
   #驗退、倉退下顯示取回日期，取回功能
   IF NOT (g_argv[1] MATCHES '[57]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') THEN
      CALL cl_set_act_visible("upd_pmds081",FALSE)
   END IF 
   
   #驗退、倉退下隱藏供應商出貨日功能
   IF g_argv[1] MATCHES '[57]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
      CALL cl_set_act_visible("upd_pmds052",FALSE)
   END IF 
   
   ##入庫、倉退下顯示可以修改價格
   IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN
      #未轉應付之前都可以變更價格
      LET l_n1 = 0
      #單頭來源單號
      #SELECT COUNT(1) INTO l_n1 FROM apca_t 
      #   WHERE apcaent = g_enterprise AND (apca016 = "apmt570" OR apca016 = "APMT570") AND apca018 = g_pmds_m.pmdsdocno AND apcastus <> 'X'
      SELECT COUNT(1) INTO l_n1 FROM apca_t 
         WHERE apcaent = g_enterprise AND apca018 = g_pmds_m.pmdsdocno AND apcastus <> 'X'
      LET l_n2 = 0
      ##單身來源單號
      #SELECT COUNT(1) INTO l_n2 FROM apcb_t,apca_t 
      #   WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno AND apcastus <> 'X'
      #     AND apcbent = g_enterprise AND (apcb001 = "apmt570" OR apca016 = "APMT570") AND apcb002 = g_pmds_m.pmdsdocno
      #單身來源單號
      SELECT COUNT(1) INTO l_n2 FROM apcb_t,apca_t 
         WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno AND apcastus <> 'X'
           AND apcbent = g_enterprise AND apcb002 = g_pmds_m.pmdsdocno
      IF l_n1 > 0 OR l_n2 > 0 THEN
         #CALL cl_set_act_visible("upd_price",FALSE)
         LET g_upd_price = FALSE
      END IF
   ELSE
      LET g_upd_price = FALSE
   END IF 
   
   #收貨單 下 可以顯示產生入庫單
   IF NOT (g_argv[1] MATCHES '[1289]' OR g_argv[1] = '23')  THEN
      #CALL cl_set_act_visible("gen_warehouse_voucher,gen_check_back,gen_qc,query_qc",FALSE)  #170118-00051#1
      CALL cl_set_act_visible("gen_warehouse_or_check_back,gen_qc,query_qc",FALSE)    #170118-00051#1
   ELSE
      #检查入庫單對應的收貨單单身是否有IQC项次
      LET l_cnt = 0 
      SELECT COUNT(1) INTO l_cnt FROM pmdt_t
        WHERE pmdtent   = g_enterprise
          AND pmdtdocno = g_pmds_m.pmdsdocno
          AND pmdt026   = 'Y'  
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt = 0 THEN
         CALL cl_set_act_visible("gen_qc,query_qc",FALSE)
      END IF
   END IF
   
   IF g_pmds_m.pmdsstus <> 'Y' THEN
      CALL cl_set_act_visible("gen_qc,query_qc",FALSE)
   END IF
   
   #入庫 顯示根據IQC結果重新產生入庫單身明細
   IF NOT (g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25')  THEN
      CALL cl_set_act_visible("store_in_by_qc",FALSE)
   ELSE
       #检查入庫單對應的收貨單单身是否有IQC项次
      LET l_cnt = 0 
      SELECT COUNT(1) INTO l_cnt FROM pmdt_t
        WHERE pmdtent   = g_enterprise
          AND pmdtdocno = g_pmds_m.pmds006
          AND pmdt026   = 'Y'  
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt = 0 THEN
         CALL cl_set_act_visible("store_in_by_qc",FALSE)
      END IF
   END IF
   
   IF g_pmds_m.pmdsstus <> 'N' THEN
      CALL cl_set_act_visible("store_in_by_qc",FALSE)
   END IF
   
   #當倉退方式為2,3時才可以執行此action產生新的一張採購單
   IF NOT (g_argv[1] MATCHES '[7]' AND g_pmds_m.pmdsstus MATCHES '[S]' AND g_pmds_m.pmds100 MATCHES '[3]' ) THEN
      CALL cl_set_act_visible("gen_purchase",FALSE)
   END IF
   
   IF g_pmds_m.pmdsstus = 'X' THEN   #作廢
      CALL cl_set_act_visible("upd_pmds081,upd_pmds052,upd_price",FALSE)
      #CALL cl_set_act_visible("upd_pmds081,upd_pmds052",FALSE)
      #LET g_upd_price = FALSE
   END IF
   
   #單身無資料，不顯示重新取價ACTION
   LET l_cnt = 0
   SELECT COUNT(1) INTO l_cnt FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
   IF l_cnt = 0 THEN
      CALL cl_set_act_visible("get_detail_price,open_apmt520_03",FALSE)
   END IF
   
   IF g_pmds_m.pmdsstus NOT MATCHES "[NDR]" THEN   # N未確認/D抽單/R已拒絕允許修改
      CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)
   END IF
   
   #入庫、倉退單據性質下，顯示產生入庫、倉退單發票的action
   IF g_pmds_m.pmdsstus <> 'S' THEN
      CALL cl_set_act_visible("gen_aapp320,gen_aapp320_7",FALSE)
   END IF
   
   #判斷據點參數若收貨單使用製造批序號時，則製造批序號頁簽可以維護(據點參數:S-BAS-0049)
   IF g_argv[1] MATCHES '[12895]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN
      IF g_pmds_m.pmdsstus <> 'N' THEN
         CALL cl_set_act_visible("s_lot_ins",FALSE)
      END IF
   END IF
   IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '20' THEN
      IF g_pmds_m.pmdsstus NOT MATCHES '[NY]' THEN
         CALL cl_set_act_visible("s_lot_ins",FALSE)
      END IF
   END IF 

   #151023-00018#1----add---begin---
   #委外入庫單下，顯示產生報工單、工單入庫單，過賬後才可產生
   IF g_pmds_m.pmdsstus <> 'S' THEN 
      CALL cl_set_act_visible("gen_asft335,gen_asft340",FALSE)
      
      #委外入庫單下，顯示產生倒扣料
      CALL cl_set_act_visible("gen_asft314",FALSE)  #160128-00023#1 add
   END IF   
   #151023-00018#1----add---end---
   
   #161101-00064#1 add  --begin--
   #采购性质为借货时，不可维护进项发票资讯
   IF g_pmds_m.pmds011 = '6' THEN
      CALL cl_set_act_visible("gen_pmdw",FALSE)
   END IF
   #161101-00064#1 add  --end--
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_act_visible_b" >}
#+ 單身權限開啟
PRIVATE FUNCTION apmt520_set_act_visible_b()
   #add-point:set_act_visible_b段define(客製用) name="set_act_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible_b.define"
   
   #end add-point   
   #add-point:set_act_visible_b段 name="set_act_visible_b.set_act_visible_b"
   CALL cl_set_act_visible("s_lot_ins",TRUE)
   
   #委外入庫單下，顯示產生報工單、工單入庫單
   CALL cl_set_act_visible("gen_asft335,gen_asft340",TRUE)  #151023-00018#1  add
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.set_act_no_visible_b" >}
#+ 單身權限關閉
PRIVATE FUNCTION apmt520_set_act_no_visible_b()
   #add-point:set_act_no_visible_b段define(客製用) name="set_act_no_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible_b.define"
   DEFINE l_imaf071     LIKE imaf_t.imaf071
   DEFINE l_imaf081     LIKE imaf_t.imaf081
   #end add-point   
   #add-point:set_act_no_visible_b段 name="set_act_no_visible_b.set_act_no_visible_b"
   #抓取料件據點進銷存相關資訊
   LET l_imaf071 = NULL
   LET l_imaf081 = NULL
   SELECT imaf071,imaf081 INTO l_imaf071,l_imaf081 FROM imaf_t WHERE imafent = g_enterprise
     AND imafsite = g_site AND imaf001 = g_pmdt2_d[g_detail_idx].pmdu001
           
   IF l_imaf071 = '2' AND l_imaf081 = '2'THEN 
      CALL cl_set_act_visible("s_lot_ins",FALSE)
   END IF
   
   #151023-00018#1--add--begin---
   IF l_ac > 0 THEN
      #作業編號或作業序或者子特性是代買料時，不顯示產生報工單、工單入庫單的按鈕
      IF cl_null(g_pmdt_d[l_ac].pmdt009) OR cl_null(g_pmdt_d[l_ac].pmdt010) OR g_pmdt_d[l_ac].pmdt005 = '8' THEN
         CALL cl_set_act_visible("gen_asft335,gen_asft340",FALSE)
      END IF
   ELSE
      CALL cl_set_act_visible("gen_asft335,gen_asft340",FALSE)
   END IF
   #151023-00018#1--add--end-----
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.default_search" >}
#+ 外部參數搜尋
PRIVATE FUNCTION apmt520_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"
   
   #end add-point  
   DEFINE li_idx     LIKE type_t.num10
   DEFINE li_cnt     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
            
   #end add-point  
   
   #add-point:Function前置處理 name="default_search.before"
            
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[01]) THEN
      LET ls_wc = ls_wc, " pmdsdocno = '", g_argv[01], "' AND "
   END IF
   
 
   
   #add-point:default_search段after sql name="default_search.after_sql"
   LET ls_wc = ''
   #160606-00010#1-mod-(S)
#   IF NOT cl_null(g_argv[02]) THEN
#      LET ls_wc = " pmdsdocno = '", g_argv[02], "' AND "
#   END IF
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = " pmdsdocno IN ('", g_argv[02], "') AND "
   END IF
   #160606-00010#1-mod-(E)
   IF NOT cl_null(g_argv[03]) THEN
      IF cl_null(ls_wc) THEN
         LET ls_wc = " pmds006 = '", g_argv[03], "' AND "
      ELSE
         LET ls_wc = ls_wc , " pmds006 = '", g_argv[03], "' AND "
      END IF
   END IF
  
   #其他程式串查用，傳入 site，變更g_site要變更TITLE 用cl_ui_wintitle去變更
   IF NOT cl_null(g_argv[04]) THEN
      LET g_site = g_argv[04]
      CALL cl_ui_wintitle(FALSE)
   END IF 

   #傳單號範圍至apmt520,一次查詢可查詢出多個單號資料
   IF NOT cl_null(g_argv[05]) THEN
      IF cl_null(ls_wc) THEN
         LET ls_wc = g_argv[05], " AND "
      ELSE
         LET ls_wc = ls_wc , g_argv[05], " AND "
      END IF
   END IF
   
   #end add-point  
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      #若無外部參數則預設為1=2
      LET g_default = FALSE
      
      #預設查詢條件
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc2_table2 TO NULL
 
         INITIALIZE g_wc2_table3 TO NULL
 
 
         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "pmds_t" 
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "pmdt_t" 
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "pmdu_t" 
                  LET g_wc2_table2 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "pmdv_t" 
                  LET g_wc2_table3 = la_wc[li_idx].wc
 
 
               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
            OR NOT cl_null(g_wc2_table2)
 
            OR NOT cl_null(g_wc2_table3)
 
 
            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
            END IF
 
            IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
            END IF
 
 
            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF
         
            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
    
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
   END IF
   
   #add-point:default_search段結束前 name="default_search.after"
   IF NOT cl_null(g_argv[01]) THEN
      LET g_wc = g_wc , " AND pmds000 = '", g_argv[01], "' "
   END IF
   
   LET g_wc = g_wc," AND pmdssite = '",g_site,"' "  #160413-00011#9 add

   #end add-point  
 
   IF g_wc.getIndexOf(" 1=2", 1) THEN
      LET g_default = TRUE
   END IF
 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.state_change" >}
   #應用 a09 樣板自動產生(Version:17)
#+ 確認碼變更 
PRIVATE FUNCTION apmt520_statechange()
   #add-point:statechange段define(客製用) name="statechange.define_customerization"
   
   #end add-point  
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="statechange.define"
   DEFINE l_success LIKE type_t.num5
   DEFINE l_ooba002 LIKE ooba_t.ooba002
   DEFINE l_pmds054 LIKE pmds_t.pmds054
   #150626---earl---add---s
   DEFINE la_param   RECORD
          prog          STRING,
          actionid      STRING,
          background    LIKE type_t.chr1,
          param         DYNAMIC ARRAY OF STRING
                     END RECORD

   DEFINE ls_js         STRING
   DEFINE l_pmds050     LIKE pmds_t.pmds050
   #150626---earl---add---e
   
   #end add-point  
   
   #add-point:Function前置處理 name="statechange.before"
   IF g_pmds_m.pmdsstus = 'X' THEN
      RETURN
   END IF
   
   #end add-point  
   
   ERROR ""     #清空畫面右下側ERROR區塊
 
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   CALL s_transaction_begin()
   
   OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt520_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
       g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
       g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
       g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
       g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
       g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc,g_pmds_m.pmdsownid_desc, 
       g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
   
 
   #檢查是否允許此動作
   IF NOT apmt520_action_chk() THEN
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001, 
       g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus, 
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008,g_pmds_m.pmds008_desc, 
       g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000, 
       g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds031_desc,g_pmds_m.pmds032, 
       g_pmds_m.pmds032_desc,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds039_desc, 
       g_pmds_m.pmds040,g_pmds_m.pmds040_desc,g_pmds_m.pmds012,g_pmds_m.pmds012_desc,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053, 
       g_pmds_m.pmds053_desc,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054, 
       g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid, 
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc, 
       g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid, 
       g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
 
   CASE g_pmds_m.pmdsstus
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      WHEN "S"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "D"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      WHEN "W"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
      WHEN "X"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
      WHEN "Z"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
      
   END CASE
 
   #add-point:資料刷新後 name="statechange.after_refresh"
   #161207-00033#27-S 
#   IF NOT cl_null(g_pmds_m.pmds028) THEN
#      CALL s_desc_get_oneturn_guest_desc(g_pmds_m.pmds028) RETURNING g_pmds_m.pmds007_desc
#      IF g_pmds_m.pmds008 = g_pmds_m.pmds007 THEN
#         LET g_pmds_m.pmds008_desc = g_pmds_m.pmds007_desc
#      END IF
#      IF g_pmds_m.pmds009 = g_pmds_m.pmds007 THEN
#         LET g_pmds_m.pmds009_desc = g_pmds_m.pmds007_desc
#      END IF      
#      DISPLAY BY NAME g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc
#   END IF
   #161207-00033#27-E  
   CALL apmt520_show() #161207-00033#27   
   #end add-point
 
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_pmds_m.pmdsstus
            
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "Y"
               HIDE OPTION "confirmed"
            WHEN "S"
               HIDE OPTION "posted"
            WHEN "A"
               HIDE OPTION "approved"
            WHEN "D"
               HIDE OPTION "withdraw"
            WHEN "R"
               HIDE OPTION "rejection"
            WHEN "W"
               HIDE OPTION "signing"
            WHEN "X"
               HIDE OPTION "invalid"
            WHEN "Z"
               HIDE OPTION "unposted"
         END CASE
     
      #add-point:menu前 name="statechange.before_menu"
      CALL cl_set_act_visible("unconfirmed,invalid,confirmed,unconfirmed",TRUE)
      
      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN   #入庫單才有過賬功能
         CALL cl_set_act_visible("posted,unposted",TRUE)
      ELSE
         CALL cl_set_act_visible("posted,unposted",FALSE)
      END IF
      CALL cl_set_act_visible("signing,withdraw",FALSE)
      CASE g_pmds_m.pmdsstus
         WHEN "N"
            CALL cl_set_act_visible("unconfirmed,posted,unposted,",FALSE)
            #需提交至BPM時，則顯示「提交」功能並隱藏「確認」功能
            IF cl_bpm_chk() THEN
                CALL cl_set_act_visible("signing",TRUE)
                CALL cl_set_act_visible("confirmed",FALSE)
            END IF
         WHEN "R"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed",FALSE)

         WHEN "D"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed",FALSE)
         WHEN "W"    #只能顯示抽單;其餘應用功能皆隱藏
             CALL cl_set_act_visible("withdraw",TRUE)
            #mid 151109 增加隱藏過帳及過帳還原             
            #CALL cl_set_act_visible("unconfirmed,invalid,confirmed",FALSE)
             CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted,unposted",FALSE)
         
         WHEN "A"     #只能顯示確認; 其餘應用功能皆隱藏
             CALL cl_set_act_visible("confirmed ",TRUE)  
             CALL cl_set_act_visible("unconfirmed,invalid",FALSE)

         WHEN "X"
            CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted,unposted",FALSE)

         WHEN "Y"
            CALL cl_set_act_visible("invalid,confirmed,unposted",FALSE)
            
         WHEN "S"
             CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted",FALSE)
      END CASE                  
      #end add-point
      
      #應用 a36 樣板自動產生(Version:5)
      #提交
      ON ACTION signing
         IF cl_auth_chk_act("signing") THEN
            IF NOT apmt520_send() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE apmt520_cl
            RETURN
         END IF
    
      #抽單
      ON ACTION withdraw
         IF cl_auth_chk_act("withdraw") THEN
            IF NOT apmt520_draw_out() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE apmt520_cl
            RETURN
         END IF
 
 
 
	  
      ON ACTION unconfirmed
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制 name="statechange.unconfirmed"
            #161027-00035#1-s mark
            #按標準寫法挪至#add-point:stus修改前 name="statechange.b_update"
            #CALL cl_err_collect_init() 
            #CALL s_apmt520_unconf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            #CALL cl_err_collect_show()
            #IF NOT l_success THEN
            #   CLOSE apmt520_cl  #160720-00015#1
            #   CALL s_transaction_end('N','0')   #160613-00003#1-add
            #   RETURN
            #ELSE
            #   IF NOT cl_ask_confirm('aim-00110') THEN
            #      CLOSE apmt520_cl  #160720-00015#1
            #      CALL s_transaction_end('N','0')   #160613-00003#1-add
            #      RETURN
            #   ELSE
            #      CALL s_transaction_begin()
            #      
            #      CALL cl_err_collect_init() 
            #      CALL s_apmt520_unconf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            #      CALL cl_err_collect_show()
            #      IF NOT l_success THEN
            #         CLOSE apmt520_cl  #160720-00015#1
            #         CALL s_transaction_end('N','0')
            #         RETURN
            #      ELSE
            #         CALL s_transaction_end('Y','0')
            #      END IF
            #   END IF
            #END IF
            #161027-00035#1-e mark
            #end add-point
         END IF
         EXIT MENU
      ON ACTION confirmed
         IF cl_auth_chk_act("confirmed") THEN
            LET lc_state = "Y"
            #add-point:action控制 name="statechange.confirmed"
            #161027-00035#1-s mark
            #按標準寫法挪至#add-point:stus修改前 name="statechange.b_update"
            #CALL cl_err_collect_init() 
            #CALL s_apmt520_conf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            #CALL cl_err_collect_show()
            #IF NOT l_success THEN
            #   CLOSE apmt520_cl  #160720-00015#1
            #   CALL s_transaction_end('N','0')   #160613-00003#1-add
            #   RETURN
            #ELSE
            #  #151217-00014#2 ---add (S)---
            #   INITIALIZE g_chkparam.* TO NULL
            #
            #  #設定g_chkparam.*的參數
            #  LET g_chkparam.arg1 = g_pmds_m.pmds007
            #   IF NOT cl_chk_exist("v_pmab001_1") THEN
            #      #檢查失敗時後續處理
            #      LET l_success = FALSE
            #      CLOSE apmt520_cl  #160720-00015#1
            #      CALL s_transaction_end('N','0')   #160720-00015#1
            #      RETURN
            #   END IF
            #  #151217-00014#2 ---add (E)---
            #   IF NOT cl_ask_confirm('aim-00108') THEN
            #      CLOSE apmt520_cl  #160720-00015#1
            #      CALL s_transaction_end('N','0')   #160613-00003#1-add
            #      RETURN
            #   ELSE
            #      CALL s_transaction_begin()
            #      
            #      CALL cl_err_collect_init() 
            #      CALL s_apmt520_conf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            #      CALL cl_err_collect_show()
            #      IF NOT l_success THEN
            #         CLOSE apmt520_cl  #160720-00015#1
            #         CALL s_transaction_end('N','0')
            #         RETURN
            #      ELSE
            #         CALL s_transaction_end('Y','0')
            #      END IF
            #   END IF
            #END IF
            ##確認後自動過賬
            #IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN   #入庫單才有過賬功能
            #   CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
            #   IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0083') = 'Y' THEN
            #      CALL s_transaction_begin()
            #      IF apmt520_upd_pmds001() THEN
            #         CALL cl_err_collect_init() 
            #         CALL s_apmt520_posted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            #         CALL cl_err_collect_show()
            #         IF NOT l_success THEN
            #            CLOSE apmt520_cl  #160720-00015#1
            #            CALL s_transaction_end('N','0')
            #            RETURN
            #         ELSE
            #            CALL cl_err_collect_init() 
            #            CALL s_apmt520_posted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            #            CALL cl_err_collect_show()
            #            IF NOT l_success THEN
            #               CLOSE apmt520_cl  #160720-00015#1
            #               CALL s_transaction_end('N','0')
            #               RETURN
            #            ELSE
            #               LET lc_state = "S"
            #               CALL s_transaction_end('Y','0')
            #               
            #               #150626---earl---add---s
            #               #多角自動拋轉
            #               IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
            #                  g_pmds_m.pmds014 MATCHES '[1238]' AND
            #                  g_pmds_m.pmds053 IS NOT NULL THEN
            #      
            #                  INITIALIZE la_param.* TO NULL
            #
            #                  IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
            #                     LET la_param.prog     = 'aicp800'
            #                     LET la_param.param[1] = g_pmds_m.pmdsdocno
            #                  ELSE
            #                     LET la_param.prog     = 'aicp400'
            #                     LET la_param.param[1] = g_pmds_m.pmdsdocno
            #                  END IF
            #               
            #                  LET ls_js = util.JSON.stringify(la_param)
            #                  CALL cl_cmdrun_wait(ls_js)
            #               END IF
            #               #150626---earl---add---e
            #               
            #            END IF
            #         END IF
            #      ELSE
            #         CLOSE apmt520_cl  #160720-00015#1
            #         CALL s_transaction_end('N','0')
            #         RETURN
            #      END IF
            #   END IF
            #END IF       
            #161027-00035#1-e mark
            #end add-point
         END IF
         EXIT MENU
      ON ACTION posted
         IF cl_auth_chk_act("posted") THEN
            LET lc_state = "S"
            #add-point:action控制 name="statechange.posted"
            #161027-00035#1-s mark
            #按標準寫法挪至#add-point:stus修改前 name="statechange.b_update"
            #IF NOT cl_ask_confirm('sub-00232') THEN
            #   CLOSE apmt520_cl  #160720-00015#1
            #   CALL s_transaction_end('N','0')
            #   RETURN
            #ELSE
            #   CALL s_transaction_begin()
            #   IF apmt520_upd_pmds001() THEN
            #      CALL cl_err_collect_init() 
            #      CALL s_apmt520_posted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            #      CALL cl_err_collect_show()
            #      IF NOT l_success THEN
            #         CLOSE apmt520_cl  #160720-00015#1
            #         CALL s_transaction_end('N','0')
            #         RETURN
            #      ELSE
            #         CALL cl_err_collect_init() 
            #         CALL s_apmt520_posted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            #         CALL cl_err_collect_show()
            #         IF NOT l_success THEN
            #            CLOSE apmt520_cl  #160720-00015#1
            #            CALL s_transaction_end('N','0')
            #            RETURN
            #         ELSE
            #            CALL s_transaction_end('Y','0')
            #            
            #            #150626---earl---add---s
            #            #多角自動拋轉
            #            IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
            #               g_pmds_m.pmds014 MATCHES '[1238]' AND
            #               g_pmds_m.pmds053 IS NOT NULL THEN
            #                     
            #               INITIALIZE la_param.* TO NULL
            #            
            #               IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
            #                  LET la_param.prog     = 'aicp800'
            #                  LET la_param.param[1] = g_pmds_m.pmdsdocno
            #               ELSE
            #                  LET la_param.prog     = 'aicp400'
            #                  LET la_param.param[1] = g_pmds_m.pmdsdocno
            #               END IF
            #            
            #               LET ls_js = util.JSON.stringify(la_param)
            #               CALL cl_cmdrun_wait(ls_js)
            #            END IF
            #            #150626---earl---add---e
            #            
            #         END IF
            #      END IF
            #   ELSE
            #      CLOSE apmt520_cl  #160720-00015#1
            #      CALL s_transaction_end('N','0')
            #      RETURN
            #   END IF
            #END IF                            
            #161027-00035#1-e mark
            #end add-point
         END IF
         EXIT MENU
      ON ACTION approved
         IF cl_auth_chk_act("approved") THEN
            LET lc_state = "A"
            #add-point:action控制 name="statechange.approved"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION withdraw
      #   IF cl_auth_chk_act("withdraw") THEN
      #      LET lc_state = "D"
      #      #add-point:action控制 name="statechange.withdraw"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION rejection
         IF cl_auth_chk_act("rejection") THEN
            LET lc_state = "R"
            #add-point:action控制 name="statechange.rejection"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION signing
      #   IF cl_auth_chk_act("signing") THEN
      #      LET lc_state = "W"
      #      #add-point:action控制 name="statechange.signing"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION invalid
         IF cl_auth_chk_act("invalid") THEN
            LET lc_state = "X"
            #add-point:action控制 name="statechange.invalid"
            #161027-00035#1-s mark
            #按標準寫法挪至#add-point:stus修改前 name="statechange.b_update"
            #CALL cl_err_collect_init() 
            #CALL s_apmt520_invalid_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            #CALL cl_err_collect_show()
            #IF NOT l_success THEN
            #   CLOSE apmt520_cl  #160720-00015#1
            #   CALL s_transaction_end('N','0')   #160613-00003#1-add
            #   RETURN
            #ELSE
            #   IF NOT cl_ask_confirm('aim-00109') THEN
            #      CLOSE apmt520_cl  #160720-00015#1
            #      CALL s_transaction_end('N','0')   #160613-00003#1-add
            #      RETURN
            #   ELSE
            #      CALL s_transaction_begin()
            #      
            #      CALL cl_err_collect_init() 
            #      CALL s_apmt520_invalid_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            #      CALL cl_err_collect_show()
            #      IF NOT l_success THEN
            #         CALL s_transaction_end('N','0')
            #         RETURN
            #      ELSE
            #         #倉退單在過帳還原時若pmds054為'2.採購合約差異處理'時，刪除或作廢單據時，須將對應的pmeo025的狀態更新成'1.未處理'
            #         LET l_pmds054 = ''
            #         SELECT pmds054 INTO l_pmds054 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
            #         IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND (l_pmds054 = '2' OR l_pmds054 = '4') THEN
            #            #將對應的pmeo025的狀態更新成'1.未處理'
            #            UPDATE pmeo_t SET pmeo025 = '1',
            #                              pmeo027 = '',
            #                              pmeo028 = ''
            #                WHERE pmeoent = g_enterprise AND (pmeo000 ='1' OR pmeo000 = '3') AND pmeo027 = g_pmds_m.pmdsdocno
            #         END IF
            #         CALL s_transaction_end('Y','0')
            #      END IF
            #   END IF
            #END IF                        
            #161027-00035#1-e mark
            #end add-point
         END IF
         EXIT MENU
      ON ACTION unposted
         IF cl_auth_chk_act("unposted") THEN
            LET lc_state = "Z"
            #add-point:action控制 name="statechange.unposted"
            #161027-00035#1-s mark
            #按標準寫法挪至#add-point:stus修改前 name="statechange.b_update"
            #LET lc_state = "Y"
            #
            ##mark by lixiang 2015/07/23 倉退單來源是數據來源是合約時，正常過賬還原
            ##LET l_pmds054 = ''
            ##SELECT pmds054 INTO l_pmds054 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
            ###2.倉退單在過帳還原時若pmds054為'2.採購合約差異處理'時，過帳還原時只能將此倉退單更新成作廢狀態
            ###2-1.過帳還原時彈窗告知是採購合約差異處理單是否進行過帳還原，若選擇是則只能將倉退單更新成作廢
            ###2-2.須將對應的pmeo025的狀態更新成'1.未處理'
            ##IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND (l_pmds054 = '2' OR l_pmds054 = '4') THEN
            ##   IF NOT cl_ask_confirm('apm-00890') THEN 
            ##      RETURN
            ##   ELSE
            ##      CALL s_transaction_begin()
            ##      
            ##      CALL cl_err_collect_init() 
            ##      CALL s_apmt520_unposted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            ##      CALL cl_err_collect_show()
            ##      IF NOT l_success THEN
            ##         CALL s_transaction_end('N','0')
            ##         RETURN
            ##      ELSE
            ##         #150626---earl---add---s
            ##         CALL s_transaction_end('Y','0')
            ##
            ##         #多角自動拋轉還原
            ##         IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
            ##            g_pmds_m.pmds014 MATCHES '[1238]' AND
            ##            g_pmds_m.pmds053 IS NOT NULL THEN
            ##
            ##            INITIALIZE la_param.* TO NULL
            ##         
            ##            IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
            ##               LET la_param.prog     = 'aicp810'
            ##               LET la_param.param[1] = g_pmds_m.pmdsdocno
            ##            ELSE
            ##               LET la_param.prog     = 'aicp410'
            ##               LET la_param.param[1] = g_pmds_m.pmdsdocno
            ##            END IF
            ##         
            ##            LET ls_js = util.JSON.stringify(la_param)
            ##            CALL cl_cmdrun_wait(ls_js)
            ##         END IF
            ##
            ##         LET l_pmds050 = ''
            ##         SELECT pmds050 INTO l_pmds050
            ##           FROM pmds_t
            ##          WHERE pmdsent = g_enterprise
            ##            AND pmdsdocno = g_pmds_m.pmdsdocno
            ##         
            ##         IF l_pmds050 = 'Y' THEN
            ##            INITIALIZE g_errparam TO NULL
            ##            LET g_errparam.extend = ""
            ##            LET g_errparam.code   = 'aic-00181'   #多角流程已拋轉之單據不可取消過帳！
            ##            LET g_errparam.popup  = TRUE
            ##            CALL cl_err()
            ##
            ##            CALL cl_err_collect_show()
            ##            CLOSE apmt520_cl
            ##            RETURN
            ##         END IF
            ##
            ##         CALL s_transaction_begin()
            ##
            ##         OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
            ##         IF STATUS THEN
            ##            INITIALIZE g_errparam TO NULL
            ##            LET g_errparam.extend = "OPEN apmt520_cl:"
            ##            LET g_errparam.code   = STATUS
            ##            LET g_errparam.popup  = TRUE
            ##            CALL cl_err()
            ##            CLOSE apmt520_cl
            ##            CALL s_transaction_end('N','0')
            ##            CALL cl_err_collect_show()
            ##            RETURN
            ##         END IF
            ##         #150626---earl---add---e
            ##         
            ##         CALL cl_err_collect_init() 
            ##         CALL s_apmt520_unposted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            ##         CALL cl_err_collect_show()
            ##         IF NOT l_success THEN
            ##            CALL s_transaction_end('N','0')
            ##            RETURN
            ##         END IF
            ##      END IF
            ##      
            ##      LET lc_state = "N"
            ##      #過賬還原後，再進行取消確認的邏輯
            ##      CALL cl_err_collect_init() 
            ##      CALL s_apmt520_unconf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            ##      CALL cl_err_collect_show()
            ##      IF NOT l_success THEN
            ##         CALL s_transaction_end('N','0')
            ##         RETURN
            ##      ELSE
            ##         CALL cl_err_collect_init() 
            ##         CALL s_apmt520_unconf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            ##         CALL cl_err_collect_show()
            ##         IF NOT l_success THEN
            ##            CALL s_transaction_end('N','0')
            ##            RETURN
            ##         END IF
            ##      END IF
            ##      
            ##      LET lc_state = "X"
            ##      #取消確認後，再進行作廢
            ##      CALL cl_err_collect_init() 
            ##      CALL s_apmt520_invalid_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            ##      CALL cl_err_collect_show()
            ##      IF NOT l_success THEN
            ##         CALL s_transaction_end('N','0')
            ##         RETURN
            ##      ELSE
            ##         CALL cl_err_collect_init() 
            ##         CALL s_apmt520_invalid_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            ##         CALL cl_err_collect_show()
            ##         IF NOT l_success THEN
            ##            CALL s_transaction_end('N','0')
            ##            RETURN
            ##         END IF
            ##      END IF 
            ##      #將對應的pmeo025的狀態更新成'1.未處理'
            ##      UPDATE pmeo_t SET pmeo025 = '1',
            ##                        pmeo027 = '',
            ##                        pmeo028 = ''
            ##        WHERE pmeoent = g_enterprise AND (pmeo000 ='1' OR pmeo000 = '3') AND pmeo027 = g_pmds_m.pmdsdocno               
            ##      CALL s_transaction_end('Y','0')               
            ##   END IF
            ##ELSE
            ##mark by lixiang 2015/07/23
            #   IF NOT cl_ask_confirm('sub-00233') THEN
            #      CLOSE apmt520_cl  #160720-00015#1
            #      CALL s_transaction_end('N','0')
            #      RETURN
            #   ELSE
            #      CALL cl_err_collect_init() 
            #      CALL s_apmt520_unposted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
            #      CALL cl_err_collect_show()
            #      IF NOT l_success THEN
            #         CLOSE apmt520_cl  #160720-00015#1
            #         CALL s_transaction_end('N','0')   #160613-00003#1-add
            #         RETURN
            #      ELSE
            #         #150626---earl---add---s
            #         CALL s_transaction_end('Y','0')
            #
            #         #多角自動拋轉還原
            #         IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
            #            g_pmds_m.pmds014 MATCHES '[1238]' AND
            #            g_pmds_m.pmds053 IS NOT NULL THEN
            #            
            #            INITIALIZE la_param.* TO NULL
            #         
            #            IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
            #               LET la_param.prog     = 'aicp810'
            #               LET la_param.param[1] = g_pmds_m.pmdsdocno
            #            ELSE
            #               LET la_param.prog     = 'aicp410'
            #               LET la_param.param[1] = g_pmds_m.pmdsdocno
            #            END IF
            #         
            #            LET ls_js = util.JSON.stringify(la_param)
            #            CALL cl_cmdrun_wait(ls_js)
            #         END IF
            #
            #         LET l_pmds050 = ''
            #         SELECT pmds050 INTO l_pmds050
            #           FROM pmds_t
            #          WHERE pmdsent = g_enterprise
            #            AND pmdsdocno = g_pmds_m.pmdsdocno
            #         
            #         IF l_pmds050 = 'Y' THEN
            #            INITIALIZE g_errparam TO NULL
            #            LET g_errparam.extend = ""
            #            LET g_errparam.code   = 'aic-00181'   #多角流程已拋轉之單據不可取消過帳！
            #            LET g_errparam.popup  = TRUE
            #            CALL cl_err()
            #
            #            CALL cl_err_collect_show()
            #            CLOSE apmt520_cl
            #            CALL s_transaction_end('N','0')     #160812-00017#8 Add By Ken 160816
            #            RETURN
            #         END IF
            #
            #         CALL s_transaction_begin()
            #
            #         OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
            #         IF STATUS THEN
            #            INITIALIZE g_errparam TO NULL
            #            LET g_errparam.extend = "OPEN apmt520_cl:"
            #            LET g_errparam.code   = STATUS
            #            LET g_errparam.popup  = TRUE
            #            CALL cl_err()
            #            CLOSE apmt520_cl
            #            CALL s_transaction_end('N','0')
            #            CALL cl_err_collect_show()
            #            RETURN
            #         END IF
            #         #150626---earl---add---e
            #
            #         CALL s_transaction_begin()
            #         CALL cl_err_collect_init() 
            #         CALL s_apmt520_unposted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            #         CALL cl_err_collect_show()
            #         IF NOT l_success THEN
            #            CLOSE apmt520_cl  #160720-00015#1
            #            CALL s_transaction_end('N','0')
            #            RETURN
            #         ELSE
            #            CALL s_transaction_end('Y','0')
            #         END IF
            #      END IF
            #   END IF
            ##END IF       
            #161027-00035#1-e mark
            #end add-point
         END IF
         EXIT MENU
 
      #add-point:stus控制 name="statechange.more_control"
 
      #end add-point
      
   END MENU
   
   #確認被選取的狀態碼在清單中
   IF (lc_state <> "N" 
      AND lc_state <> "Y"
      AND lc_state <> "S"
      AND lc_state <> "A"
      AND lc_state <> "D"
      AND lc_state <> "R"
      AND lc_state <> "W"
      AND lc_state <> "X"
      AND lc_state <> "Z"
      ) OR 
      g_pmds_m.pmdsstus = lc_state OR cl_null(lc_state) THEN
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #add-point:stus修改前 name="statechange.b_update"
      
      #161027-00035#1-s add
      
      IF lc_state = "N" THEN
         CALL cl_err_collect_init()
         CALL s_apmt520_unconf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         IF NOT cl_ask_confirm('aim-00110') THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         CALL cl_err_collect_init()
         CALL s_apmt520_unconf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END IF
      
      IF lc_state = "Y" THEN
         CALL cl_err_collect_init()
         CALL s_apmt520_conf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #151217-00014#2-s add
         INITIALIZE g_chkparam.* TO NULL
         LET g_chkparam.arg1 = g_pmds_m.pmds007
         #IF NOT cl_chk_exist("v_pmab001_1") THEN  #161207-00033#38
         IF NOT cl_chk_exist("v_pmab001_3") THEN   #161207-00033#38
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #151217-00014#2-e add
         IF NOT cl_ask_confirm('aim-00108') THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         CALL cl_err_collect_init()
         CALL s_apmt520_conf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #確認後自動過賬
         IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' THEN   #入庫單才有過賬功能
            CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
            IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0083') = 'Y' THEN
               IF NOT apmt520_upd_pmds001() THEN
                  CLOSE apmt520_cl
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
               CALL cl_err_collect_init() 
               CALL s_apmt520_posted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
               CALL cl_err_collect_show()
               IF NOT l_success THEN
                  CLOSE apmt520_cl
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
               CALL cl_err_collect_init() 
               CALL s_apmt520_posted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
               CALL cl_err_collect_show()
               IF NOT l_success THEN
                  CLOSE apmt520_cl
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
               #LET lc_state = "S"  #161229-00012#1 #此处不能对lc_state赋值为S,赋值后，走到下面程序符合过账条件，在走一次过账逻辑，导致报错
               #多角自動拋轉
               IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
                  g_pmds_m.pmds014 MATCHES '[1238]' AND
                  g_pmds_m.pmds053 IS NOT NULL THEN
                  CALL s_transaction_end('Y','0')
                  INITIALIZE la_param.* TO NULL
                  IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
                     LET la_param.prog     = 'aicp800'
                     LET la_param.param[1] = g_pmds_m.pmdsdocno
                  ELSE
                     LET la_param.prog     = 'aicp400'
                     LET la_param.param[1] = g_pmds_m.pmdsdocno
                  END IF
                  LET ls_js = util.JSON.stringify(la_param)
                  CALL cl_cmdrun_wait(ls_js)
                  LET l_pmds050 = ''
                  SELECT pmds050 INTO l_pmds050
                    FROM pmds_t
                   WHERE pmdsent = g_enterprise
                     AND pmdsdocno = g_pmds_m.pmdsdocno
                  #多角流程拋轉失敗！
                  IF l_pmds050 <> 'Y' THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code   = 'aic-00177'
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     CALL s_transaction_begin()
                     CALL cl_err_collect_init()
                     CALL s_apmt520_unposted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
                     CALL cl_err_collect_show()
                     CALL s_transaction_end('Y','0')
                     CLOSE apmt520_cl
                     RETURN
                  END IF
                  CALL s_transaction_begin()
               END IF
            END IF
         END IF
      END IF
         
      IF lc_state = "S" THEN
         IF NOT cl_ask_confirm('sub-00232') THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         IF NOT apmt520_upd_pmds001() THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         CALL cl_err_collect_init() 
         CALL s_apmt520_posted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         CALL cl_err_collect_init() 
         CALL s_apmt520_posted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #多角自動拋轉
         IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
            g_pmds_m.pmds014 MATCHES '[1238]' AND
            g_pmds_m.pmds053 IS NOT NULL THEN
            CALL s_transaction_end('Y','0')
            INITIALIZE la_param.* TO NULL
            IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
               LET la_param.prog     = 'aicp800'
               LET la_param.param[1] = g_pmds_m.pmdsdocno
            ELSE
               LET la_param.prog     = 'aicp400'
               LET la_param.param[1] = g_pmds_m.pmdsdocno
            END IF
            LET ls_js = util.JSON.stringify(la_param)
            CALL cl_cmdrun_wait(ls_js)
            LET l_pmds050 = ''
            SELECT pmds050 INTO l_pmds050
              FROM pmds_t
             WHERE pmdsent = g_enterprise
               AND pmdsdocno = g_pmds_m.pmdsdocno
            #多角流程拋轉失敗！
            IF l_pmds050 <> 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code   = 'aic-00177'
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               CALL s_transaction_begin()
               CALL cl_err_collect_init()
               CALL s_apmt520_unposted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
               CALL cl_err_collect_show()
               CALL s_transaction_end('Y','0')
               CLOSE apmt520_cl
               RETURN
            END IF
            CALL s_transaction_begin()
         END IF
      END IF
      
      IF lc_state = "X" THEN
         CALL cl_err_collect_init()
         CALL s_apmt520_invalid_chk(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         IF NOT cl_ask_confirm('aim-00109') THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         CALL cl_err_collect_init() 
         CALL s_apmt520_invalid_upd(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #倉退單在過帳還原時若pmds054為'2.採購合約差異處理'時，刪除或作廢單據時，須將對應的pmeo025的狀態更新成'1.未處理'
         LET l_pmds054 = ''
         SELECT pmds054 INTO l_pmds054 FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
         IF (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND (l_pmds054 = '2' OR l_pmds054 = '4') THEN
            #將對應的pmeo025的狀態更新成'1.未處理'
            UPDATE pmeo_t SET pmeo025 = '1',
                              pmeo027 = '',
                              pmeo028 = ''
                WHERE pmeoent = g_enterprise AND (pmeo000 ='1' OR pmeo000 = '3') AND pmeo027 = g_pmds_m.pmdsdocno
         END IF
      END IF
      
      IF lc_state = "Z" THEN
         CALL cl_err_collect_init() 
         CALL s_apmt520_unposted_chk(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         IF NOT cl_ask_confirm('sub-00233') THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #多角自動拋轉還原
         IF cl_get_para(g_enterprise,'','E-BAS-0022') = 'Y' AND
            g_pmds_m.pmds014 MATCHES '[1238]' AND
            g_pmds_m.pmds053 IS NOT NULL THEN
            INITIALIZE la_param.* TO NULL
            IF g_pmds_m.pmds000 = '7' OR g_pmds_m.pmds000 = '14' THEN   #採購倉退維護作業,委外採購倉退作業
               LET la_param.prog     = 'aicp810'
               LET la_param.param[1] = g_pmds_m.pmdsdocno
            ELSE
               LET la_param.prog     = 'aicp410'
               LET la_param.param[1] = g_pmds_m.pmdsdocno
            END IF
            LET ls_js = util.JSON.stringify(la_param)
            CALL cl_cmdrun_wait(ls_js)
            LET l_pmds050 = ''
            SELECT pmds050 INTO l_pmds050
              FROM pmds_t
             WHERE pmdsent = g_enterprise
               AND pmdsdocno = g_pmds_m.pmdsdocno
            IF l_pmds050 = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               #多角流程已拋轉之單據不可取消過帳！
               LET g_errparam.code   = 'aic-00181'
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               CLOSE apmt520_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END IF
         CALL cl_err_collect_init() 
         CALL s_apmt520_unposted_upd(g_pmds_m.pmdsdocno) RETURNING l_success
         CALL cl_err_collect_show()
         IF NOT l_success THEN
            CLOSE apmt520_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         LET lc_state = "Y"
      END IF
      
      #161027-00035#1-e add

   #161229-00012#1--s
   SELECT pmdsstus INTO lc_state FROM pmds_t
     WHERE pmdsent = g_enterprise
       AND pmdsdocno = g_pmds_m.pmdsdocno
   #161229-00012#1--e
   #end add-point
   
   LET g_pmds_m.pmdsmodid = g_user
   LET g_pmds_m.pmdsmoddt = cl_get_current()
   LET g_pmds_m.pmdsstus = lc_state
   
   #異動狀態碼欄位/修改人/修改日期
   UPDATE pmds_t 
      SET (pmdsstus,pmdsmodid,pmdsmoddt) 
        = (g_pmds_m.pmdsstus,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt)     
    WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
 
    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
    
      #撈取異動後的資料
      EXECUTE apmt520_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
          g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
          g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028, 
          g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045, 
          g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032, 
          g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038, 
          g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
          g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043, 
          g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057, 
          g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid, 
          g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid, 
          g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
          g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
          g_pmds_m.pmds037_desc,g_pmds_m.pmds039_desc,g_pmds_m.pmds040_desc,g_pmds_m.pmds012_desc,g_pmds_m.pmds053_desc, 
          g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc, 
          g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
      
      #將資料顯示到畫面上
      DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmdsdocdt, 
          g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003,g_pmds_m.pmds003_desc, 
          g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008, 
          g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052, 
          g_pmds_m.pmds028,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081, 
          g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031, 
          g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds033,g_pmds_m.pmds033_desc, 
          g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds037_desc, 
          g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds039_desc,g_pmds_m.pmds040,g_pmds_m.pmds040_desc, 
          g_pmds_m.pmds012,g_pmds_m.pmds012_desc,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103, 
          g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds053_desc, 
          g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055, 
          g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc, 
          g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp, 
          g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt, 
          g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc, 
          g_pmds_m.pmdspstdt
   END IF
 
   #add-point:stus修改後 name="statechange.a_update"
   #CALL apmt520_fetch('')  #重新加載action    #160720-00015#1     
   #end add-point
 
   #add-point:statechange段結束前 name="statechange.after"
   #161207-00033#27-S 
   IF NOT cl_null(g_pmds_m.pmds028) THEN
      CALL s_desc_get_oneturn_guest_desc(g_pmds_m.pmds028) RETURNING g_pmds_m.pmds007_desc
      IF g_pmds_m.pmds008 = g_pmds_m.pmds007 THEN
         LET g_pmds_m.pmds008_desc = g_pmds_m.pmds007_desc
      END IF
      IF g_pmds_m.pmds009 = g_pmds_m.pmds007 THEN
         LET g_pmds_m.pmds009_desc = g_pmds_m.pmds007_desc
      END IF      
      DISPLAY BY NAME g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc
   END IF
   #161207-00033#27-E      

   CALL apmt520_b_fill()     #170206-00030#1 add #即时刷新单身的资料，比如由审核、过账等时回写了单身资料，要即时刷新
   #end add-point  
 
   CLOSE apmt520_cl
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL apmt520_msgcentre_notify('statechange:'||lc_state)
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt520.idx_chk" >}
#+ 顯示正確的單身資料筆數
PRIVATE FUNCTION apmt520_idx_chk()
   #add-point:idx_chk段define(客製用) name="idx_chk.define_customerization"
   
   #end add-point  
   #add-point:idx_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="idx_chk.define"
            
   #end add-point  
   
   #add-point:Function前置處理  name="idx_chk.pre_function"
   
   #end add-point
   
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_pmdt_d.getLength() THEN
         LET g_detail_idx = g_pmdt_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt_d.getLength() TO FORMONLY.cnt
   END IF
   
   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail2")
      IF g_detail_idx > g_pmdt2_d.getLength() THEN
         LET g_detail_idx = g_pmdt2_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt2_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt2_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail3")
      IF g_detail_idx > g_pmdt3_d.getLength() THEN
         LET g_detail_idx = g_pmdt3_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt3_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt3_d.getLength() TO FORMONLY.cnt
   END IF
 
   
   #add-point:idx_chk段other name="idx_chk.other"
   IF g_current_page = 4 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail4")
      IF g_detail_idx > g_pmdt4_d.getLength() THEN
         LET g_detail_idx = g_pmdt4_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt4_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt4_d.getLength() TO FORMONLY.cnt
   END IF
   
   #若停留在嵌入的Page, 必須更新單身筆數顯示
   CASE g_detail_id
      WHEN "lot_page"
         DISPLAY g_d_idx_lot, g_d_cnt_lot TO FORMONLY.idx, FORMONLY.cnt
   END CASE        
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.b_fill2" >}
#+ 單身陣列填充2
PRIVATE FUNCTION apmt520_b_fill2(pi_idx)
   #add-point:b_fill2段define(客製用) name="b_fill2.define_customerization"
   
   #end add-point
   DEFINE pi_idx                 LIKE type_t.num10
   DEFINE li_ac                  LIKE type_t.num10
   DEFINE li_detail_idx_tmp      LIKE type_t.num10
   DEFINE ls_chk                 LIKE type_t.chr1
   #add-point:b_fill2段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill2.define"
            
   #end add-point
   
   #add-point:Function前置處理  name="b_fill2.pre_function"
   
   #end add-point
   
   LET li_ac = l_ac 
   
   IF g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   LET li_detail_idx_tmp = g_detail_idx
   
 
      
 
      
   #add-point:單身填充後 name="b_fill2.after_fill"
            
   #end add-point
    
   LET l_ac = li_ac
   
   CALL apmt520_detail_show()
   
   LET g_detail_idx = li_detail_idx_tmp
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.fill_chk" >}
#+ 單身填充確認
PRIVATE FUNCTION apmt520_fill_chk(ps_idx)
   #add-point:fill_chk段define(客製用) name="fill_chk.define_customerization"
   
   #end add-point
   DEFINE ps_idx        LIKE type_t.chr10
   #add-point:fill_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fill_chk.define"
            
   #end add-point
   
   #add-point:Function前置處理 name="fill_chk.before_chk"
   
   #end add-point
   
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
 
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND 
      (cl_null(g_wc2_table2) OR g_wc2_table2.trim() = '1=1')  AND 
      (cl_null(g_wc2_table3) OR g_wc2_table3.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"
                        
      #end add-point
      RETURN TRUE
   END IF
   
   #add-point:fill_chk段after_chk name="fill_chk.after_chk"
   IF ((NOT cl_null(g_wc2_table1) AND g_wc2_table1.trim() <> '1=1')) OR
      ((NOT cl_null(g_wc2_table2) AND g_wc2_table2.trim() <> '1=1')) OR
      ((NOT cl_null(g_wc2_table3) AND g_wc2_table3.trim() <> '1=1')) THEN
      RETURN TRUE
   END IF
   #end add-point
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="apmt520.status_show" >}
PRIVATE FUNCTION apmt520_status_show()
   #add-point:status_show段define(客製用) name="status_show.define_customerization"
   
   #end add-point
   #add-point:status_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="status_show.define"
   
   #end add-point
   
   #add-point:status_show段status_show name="status_show.status_show"
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="apmt520.mask_functions" >}
&include "erp/apm/apmt520_mask.4gl"
 
{</section>}
 
{<section id="apmt520.signature" >}
   #應用 a39 樣板自動產生(Version:10)
#+ BPM提交
PRIVATE FUNCTION apmt520_send()
   #add-point:send段define(客製用) name="send.define_customerization"
   
   #end add-point 
   #add-point:send段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="send.define"
   
   #end add-point 
   
   #add-point:Function前置處理  name="send.pre_function"
   
   #end add-point
   
   #依據單據個數，需要指定所有單身條件為" 1=1"  (單身有幾個就要設幾個)
   LET g_wc2_table1 = " 1=1"
   LET g_wc2_table2 = " 1=1"
   LET g_wc2_table3 = " 1=1"
 
 
   CALL apmt520_show()
   CALL apmt520_set_pk_array()
   
   #add-point: 初始化的ADP name="send.before_send"
   #確認前檢核段
   IF NOT s_apmt520_conf_chk(g_pmds_m.pmdsdocno) THEN 
      CLOSE apmt520_cl
      CALL s_transaction_end('N','0')
      RETURN FALSE
   END IF
   #end add-point
   
   #公用變數初始化
   CALL cl_bpm_data_init()
                  
   #依照主檔/單身個數產生 CALL cl_bpm_set_master_data() / cl_bpm_set_detail_data() 
   #單頭固定為 CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(xxxx)) 傳入參數: (1)單頭陣列  ; 回傳值: 無
   CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(g_pmds_m))
                              
   #單身固定為 CALL cl_bpm_set_detail_data(s_detailX, util.JSONArray.fromFGL(xxxx)) 傳入參數: (1)單身SR名稱  (2)單身陣列  ; 回傳值: 無
   CALL cl_bpm_set_detail_data("s_detail1", util.JSONArray.fromFGL(g_pmdt_d))
   CALL cl_bpm_set_detail_data("s_detail2", util.JSONArray.fromFGL(g_pmdt2_d))
   CALL cl_bpm_set_detail_data("s_detail3", util.JSONArray.fromFGL(g_pmdt3_d))
 
 
   # cl_bpm_cli() 裡有包含以前的aws_condition()=>送簽資料檢核和更新單據狀況碼為'W'
   # cl_bpm_cli() 傳入參數:無  ;  回傳值: 0 開單失敗; 1 開單成功
 
   #add-point: 提交前的ADP name="send.before_cli"
   
   #end add-point
 
   #開單失敗
   IF NOT cl_bpm_cli() THEN 
      RETURN FALSE
   END IF
 
   #add-point: 提交後的ADP name="send.after_send"
   
   #end add-point
 
   #此段落不需要刪除資料,但是否需要refresh圖片樣式???
   #CALL apmt520_ui_browser_refresh()
 
   #重新指定此筆單據資料狀態圖片=>送簽中
   LET g_browser[g_current_idx].b_statepic = "stus/16/signing.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL apmt520_ui_headershow()
   CALL apmt520_ui_detailshow()
 
   RETURN TRUE
   
END FUNCTION
 
 
 
#應用 a40 樣板自動產生(Version:9)
#+ BPM抽單
PRIVATE FUNCTION apmt520_draw_out()
   #add-point:draw段define name="draw.define_customerization"
   
   #end add-point
   #add-point:draw段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="draw.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="draw.pre_function"
   
   #end add-point
   
   #抽單失敗
   IF NOT cl_bpm_draw_out() THEN 
      RETURN FALSE
   END IF    
          
   #重新指定此筆單據資料狀態圖片=>抽單
   LET g_browser[g_current_idx].b_statepic = "stus/16/draw_out.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL apmt520_ui_headershow()  
   CALL apmt520_ui_detailshow()
 
   #add-point:Function後置處理  name="draw.after_function"
   
   #end add-point
 
   RETURN TRUE
   
END FUNCTION
 
 
 
 
 
{</section>}
 
{<section id="apmt520.set_pk_array" >}
   #應用 a51 樣板自動產生(Version:8)
#+ 給予pk_array內容
PRIVATE FUNCTION apmt520_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point  
   
   #若l_ac<=0代表沒有資料
   IF l_ac <= 0 THEN
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_pmds_m.pmdsdocno
   LET g_pk_array[1].column = 'pmdsdocno'
 
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point  
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt520.other_dialog" readonly="Y" >}
   
 
{</section>}
 
{<section id="apmt520.msgcentre_notify" >}
#應用 a66 樣板自動產生(Version:6)
PRIVATE FUNCTION apmt520_msgcentre_notify(lc_state)
   #add-point:msgcentre_notify段define name="msgcentre_notify.define_customerization"
   
   #end add-point   
   DEFINE lc_state LIKE type_t.chr80
   #add-point:msgcentre_notify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="msgcentre_notify.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="msgcentre_notify.pre_function"
   
   #end add-point
   
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = lc_state
 
   #PK資料填寫
   CALL apmt520_set_pk_array()
   #單頭資料填寫
   LET g_msgparam.data[1] = util.JSON.stringify(g_pmds_m)
 
   #add-point:msgcentre其他通知 name="msgcentre_notify.process"
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt520.action_chk" >}
#+ 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
PRIVATE FUNCTION apmt520_action_chk()
   #add-point:action_chk段define(客製用) name="action_chk.define_customerization"
   
   #end add-point
   #add-point:action_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="action_chk.define"
   
   #end add-point
   
   #add-point:action_chk段action_chk name="action_chk.action_chk"
   
   #end add-point
      
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt520.other_function" readonly="Y" >}

#採購收貨、採購收貨入庫時，根據採購單單號帶值
#驗退、入庫、倉退時，根據收貨單單號帶值
PRIVATE FUNCTION apmt520_pmds006_desc()
DEFINE l_pmdl005  LIKE pmdl_t.pmdl005
DEFINE l_pmdl006  LIKE pmdl_t.pmdl006
DEFINE l_ooef016  LIKE ooef_t.ooef016
DEFINE l_scc40    LIKE type_t.chr2
   
DEFINE l_cnt      LIKE type_t.num10  #150611 earl add

        #採購收貨、採購收貨入庫時，根據採購單單號帶值
        IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
           #將採購單頭上的採購供應商、帳款供應商、送貨供應商值預設到收貨單單頭的相關欄位上
           LET g_pmds_m.pmds007 = ''
           LET g_pmds_m.pmds008 = ''
           LET g_pmds_m.pmds009 = ''
           LET g_pmds_m.pmds052 = ''
           LET l_pmdl005 = ''
           LET l_pmdl006 = ''
           
           SELECT pmdl004,pmdl021,pmdl022,pmdl005,pmdl006,
                  pmdl009,pmdl010,pmdl011,pmdl012,pmdl013,pmdl015,pmdl016,pmdl023,pmdl051,pmdl017,
                  pmdl028   #161207-00033#38
              INTO g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds011,g_pmds_m.pmds014,
                   g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,
                   g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds012,g_pmds_m.pmds053,g_pmds_m.pmds039,
                   g_pmds_m.pmds028  #161207-00033#38
             FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = g_pmds_m.pmds006
          
           CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
           DISPLAY BY NAME g_pmds_m.pmds007_desc
           CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
           DISPLAY BY NAME g_pmds_m.pmds008_desc
           CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
           DISPLAY BY NAME g_pmds_m.pmds009_desc
           #160621-00003#3 20160629 modify by beckxie---S
           #CALL s_desc_get_acc_desc('275',g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
           CALL s_desc_get_oojdl003_desc(g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
           #160621-00003#3 20160629 modify by beckxie---E
           DISPLAY BY NAME g_pmds_m.pmds012_desc
           
           CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
           DISPLAY BY NAME g_pmds_m.pmds053_desc
           
           CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
           DISPLAY BY NAME g_pmds_m.pmds039_desc
           
           
           ##依據輸入的採購單號的採購性質(pmdl005)與多角性質(pmdl006)的值設[C:採購性質]欄位的值，
           ##預設原則如下:
           ##2-1.當pmdl005 = '1' or '4'且pmdl006='1'時，則[C:採購性質] = '1:一般採購'
           ##2-2.當pmdl005 = '1' or '4'且pmdl006='4' or '5'時，則[C:採購性質] = '7:統一採購'
           ##2-3.當pmdl005 = '3'時，則[C:採購性質] = '9:VMI採購'
           #IF g_argv[1] MATCHES '[13]' THEN
           #   IF l_pmdl005 MATCHES '[14]' AND l_pmdl006 = '1' THEN
           #      LET g_pmds_m.pmds011 = '1'
           #   END IF
           #   IF l_pmdl005 MATCHES '[14]' AND l_pmdl006 MATCHES '[45]' THEN
           #      LET g_pmds_m.pmds011 = '7'
           #   END IF
           #   IF l_pmdl005 = '3' THEN
           #      LET g_pmds_m.pmds011 = '9'
           #   END IF
           #   DISPLAY BY NAME g_pmds_m.pmds011
           #END IF
           
           #150917-00001#3   2016/03/03  By earl mark s
#           #150611 earl add s
#           #若多角流程代碼為中斷續拋
#           IF apmt520_break_continue(g_pmds_m.pmds053) THEN
#              CALL apmt520_sel_pmds041(g_pmds_m.pmds006,g_pmds_m.pmds041) RETURNING l_cnt,g_pmds_m.pmds041
#           ELSE
              LET g_pmds_m.pmds041 = ''
#           END IF
           #150917-00001#3   2016/03/03  By earl mark e
           
           DISPLAY BY NAME g_pmds_m.pmds041
           #150611 earl add e
           #150917-00001#3   2016/03/03  By earl mark e
           
        END IF
        
        #驗退、入庫、倉退時，根據收貨單單號帶值
        IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
           SELECT pmds007,pmds008,pmds009,pmds010,pmds011,pmds012,pmds014,pmds021,pmds022,pmds023,pmds024,pmds028, #161207-00033#38 remark pmds028
                  pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040,
                  pmds041,pmds042,pmds043,pmds044,pmds046,pmds052,pmds053
             INTO g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds011,g_pmds_m.pmds012,g_pmds_m.pmds014,
                  g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds028,
                  g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,
                  g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,
                  g_pmds_m.pmds041,g_pmds_m.pmds042,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,
                  g_pmds_m.pmds052,g_pmds_m.pmds053
             FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmds006
             
           DISPLAY BY NAME g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds011,g_pmds_m.pmds014,
                  g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds028, #161207-00033#38 remark pmds028
                  g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,
                  g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,
                  g_pmds_m.pmds041,g_pmds_m.pmds042,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,
                  g_pmds_m.pmds052,g_pmds_m.pmds053
                  
           CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
           DISPLAY BY NAME g_pmds_m.pmds007_desc
           CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
           DISPLAY BY NAME g_pmds_m.pmds008_desc
           CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
           DISPLAY BY NAME g_pmds_m.pmds009_desc  
           
           CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
           DISPLAY BY NAME g_pmds_m.pmds037_desc
           
           CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
           DISPLAY BY NAME g_pmds_m.pmds053_desc
           
           CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
           DISPLAY BY NAME g_pmds_m.pmds039_desc
           
           #150917-00001#3   2016/03/03  By earl mark s
#           #150611 earl add s
#           #若多角流程代碼為中斷續拋
#           IF apmt520_break_continue(g_pmds_m.pmds053) THEN
#              CALL apmt520_sel_pmds041(g_pmds_m.pmds006,g_pmds_m.pmds041) RETURNING l_cnt,g_pmds_m.pmds041
#           ELSE
              LET g_pmds_m.pmds041 = ''
#           END IF
           #150917-00001#3   2016/03/03  By earl mark e
           
           DISPLAY BY NAME g_pmds_m.pmds041
           #150611 earl add e

        END IF
        
        #驗退倉退不從取
        IF NOT (g_argv[1] MATCHES '[57]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') THEN
           #取匯率
           IF NOT cl_null(g_pmds_m.pmds037) THEN
              #根據內外購獲取當前營運據點參數設置的汇率类型
              LET l_scc40 = ''
              IF g_pmds_m.pmds048 = '1' THEN   #內購
                 LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
              END IF
              IF g_pmds_m.pmds048 = '2' THEN   #外購
                 LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
              END IF
              LET l_ooef016 = ''
              SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
              IF (NOT cl_null(l_scc40)) AND (NOT cl_null(l_ooef016)) THEN
                 CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmds_m.pmds037,l_ooef016,0,l_scc40) RETURNING g_pmds_m.pmds038
                 DISPLAY BY NAME g_pmds_m.pmds038
              END IF
           END IF
        END IF
        
END FUNCTION
#採購單單號檢查
PRIVATE FUNCTION apmt520_pmds006_chk(p_pmds006)
DEFINE p_pmds006   LIKE pmds_t.pmds006
DEFINE l_pmdl005   LIKE pmdl_t.pmdl005
DEFINE l_pmdl006   LIKE pmdl_t.pmdl006
DEFINE l_pmdl051   LIKE pmdl_t.pmdl051  #150610 earl add
DEFINE l_pmdl030   LIKE pmdl_t.pmdl030  #150610 earl add
DEFINE l_gzze003   LIKE gzze_t.gzze003  #150610 earl add
DEFINE l_success   LIKE type_t.num5
DEFINE l_ooba002   LIKE ooba_t.ooba002
DEFINE l_n         LIKE type_t.num10
DEFINE r_success   LIKE type_t.num5
DEFINE l_pmdldocdt LIKE pmdl_t.pmdldocdt

#151210-00009#1  2015/12/30 By earl s
DEFINE l_sql      STRING
DEFINE l_slip1    LIKE ooba_t.ooba001
DEFINE l_slip2    LIKE ooba_t.ooba001
#151210-00009#1  2015/12/30 By earl e

       LET r_success = TRUE
       
       IF NOT cl_null(p_pmds006) THEN
          
          #150909 earl add s
          IF NOT s_aooi210_check_doc(g_site,'',p_pmds006,g_pmds_m.pmdsdocno,'4','') THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
          #150909 earl add e
          
          CALL cl_getmsg('apm-00942',g_dlang) RETURNING l_gzze003   #採購單維護作業apmt500  #150610 earl add
          
          LET l_pmdl005 = ''
          LET l_pmdl006 = ''
          LET l_pmdl030 = '' #150610 earl add
          LET l_pmdl051 = '' #150610 earl add
          SELECT pmdl005,pmdl006,pmdldocdt,
                 pmdl030,pmdl051     #150610 earl add
            INTO l_pmdl005,l_pmdl006,l_pmdldocdt,
                 l_pmdl030,l_pmdl051   #150610 earl add
            FROM pmdl_t
           WHERE pmdlent = g_enterprise AND pmdldocno = p_pmds006

          #採購收貨、採購收貨入庫時採購採購單號
          IF g_argv[1] MATCHES '[13]' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
              LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             LET g_chkparam.where = " pmdl005 NOT IN ('2','5','6')"
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00337:sub-01302|apmt500|",cl_get_progname("apmt500",g_lang,"2"),"|:EXEPROGapmt500"
             #160318-00025#15 by 07900 --add-end 
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             #150814 earl mod start
             #IF NOT cl_chk_exist("v_pmdldocno") THEN
             IF NOT cl_chk_exist("v_pmds006") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #site的判定應該是採購單身的pmdnunit
             LET l_n = 0
             SELECT pmdnseq INTO l_n
               FROM pmdn_t
              WHERE pmdnent = g_enterprise
                AND pmdndocno = p_pmds006
                AND pmdnunit = g_site
             
             IF cl_null(l_n) OR l_n = 0 THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00987'   #此採購單無任何一筆項次的收貨據點與當前營運據點一樣，不允許輸入此採購單！
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                
                CALL cl_err()
            
                LET r_success = FALSE
                RETURN r_success
             END IF
             #150814 earl mod end
             
             #輸入的採購單號的採購性質(pmdl005)值需為'1:一般採購' or '3:VMI採購' or '4:預先採購'
             IF l_pmdl005 NOT MATCHES '[134]' THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00338'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
          END IF
          
          #採購收貨、採購收貨入庫時採購採購單號
          IF g_argv[1] = '23' OR g_argv[1] = '24' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             LET g_chkparam.where = " pmdl005 = '6' "
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00876:sub-01302|apmt504|",cl_get_progname("apmt504",g_lang,"2"),"|:EXEPROGapmt504"
             #160318-00025#15 by 07900 --add-end 
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdldocno_6") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #輸入的採購單號的採購性質(pmdl005)值需為'6:借貨採購'
             IF l_pmdl005 NOT MATCHES '[6]' THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00872'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          IF g_argv[1] MATCHES '[13]' OR g_argv[1] = '23' OR g_argv[1] = '24'THEN  
             #採購日期不可晚於收貨單上的收貨日期！
             IF g_pmds_m.pmdsdocdt < l_pmdldocdt THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00650'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #輸入的採購單號的多角性質(pmdl006)值需為'1:一般交易' or '4:統購統付' or '5:統購自付'
             IF l_pmdl006 NOT MATCHES '[12345]' THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00339'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #輸入採購單號的採購明細必須有一筆以上的送貨據點(pmdnunit)與g_site一樣的資料才可以
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdn_t 
                WHERE pmdnent = g_enterprise AND pmdndocno = p_pmds006 AND pmdnunit = g_site
             IF l_n = 0 OR cl_null(l_n) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00340'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #採購收貨
          IF g_argv[1] MATCHES '[1]' OR g_argv[1] = '23' THEN
             #輸入的採購單單別參數"收貨是否直接入庫(D-BAS-0074)"為N時才可以輸入
             CALL s_aooi200_get_slip(p_pmds006) RETURNING l_success,l_ooba002
             IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0074') != 'N' THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00341'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #採購收貨入庫
          IF g_argv[1] MATCHES '[3]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
             #輸入的採購單單別參數"收貨是否直接入庫(D-BAS-0074)"為Y時才可以輸入
             CALL s_aooi200_get_slip(p_pmds006) RETURNING l_success,l_ooba002
             IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0074') != 'Y' THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00447'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #委外採購收貨時 委外採購單號
          IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
              LET g_errshow = TRUE #是否開窗
              #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00563:sub-01302|apmt501|",cl_get_progname("apmt501",g_lang,"2"),"|:EXEPROGapmt501"
             #160318-00025#15 by 07900 --add-end
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdldocno_1") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #採購日期不可晚於收貨單上的收貨日期！
             IF g_pmds_m.pmdsdocdt < l_pmdldocdt THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00650'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #輸入採購單號的採購明細必須有一筆以上的送貨據點(pmdnunit)與g_site一樣的資料才可以
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdn_t 
                WHERE pmdnent = g_enterprise AND pmdndocno = p_pmds006 AND pmdnunit = g_site
             IF l_n = 0 OR cl_null(l_n) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00340'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #重覆性生產採購收貨時 委外採購單號
          IF g_argv[1] MATCHES '[9]' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             #160318-00025#15 by 07900 --add-str 
              LET g_chkparam.err_str[1] ="apm-00565:sub-01302|apmt503|",cl_get_progname("apmt503",g_lang,"2"),"|:EXEPROGapmt503"
             #160318-00025#15 by 07900 --add-end 
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdldocno_3") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #採購日期不可晚於收貨單上的收貨日期！
             IF g_pmds_m.pmdsdocdt < l_pmdldocdt THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00650'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #輸入採購單號的採購明細必須有一筆以上的送貨據點(pmdnunit)與g_site一樣的資料才可以
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdn_t 
                WHERE pmdnent = g_enterprise AND pmdndocno = p_pmds006 AND pmdnunit = g_site
             IF l_n = 0 OR cl_null(l_n) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00340'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #驗退時檢查收貨單號
          IF g_argv[1] MATCHES '[5]' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00449:sub-01302|apmt520",cl_get_progname("apmt520",g_lang,"2"),s_fin_get_colname("azzi001_01","or"),"|apmt522",cl_get_progname("apmt522",g_lang,"2")
             #160318-00025#15 by 07900 --add-end
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_2") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #檢查是否已做QC
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdt_t
              WHERE pmdtent = g_enterprise
                AND pmdtdocno = p_pmds006
                AND ((EXISTS (SELECT qcba001 FROM qcba_t WHERE qcbaent = g_enterprise AND qcba001 = pmdtdocno AND qcbastus = 'Y') AND pmdt026 = 'Y') OR pmdt026 = 'N')
             IF cl_null(l_n) OR l_n <= 0 THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00680'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = p_pmds006
              AND (((((CASE WHEN pmdt020 IS NULL THEN 0 ELSE pmdt020 END) - (CASE WHEN pmdt053 IS NULL THEN 0 ELSE pmdt053 END) - (CASE WHEN pmdt055 IS NULL THEN 0 ELSE pmdt055 END)) > 0) AND pmdt026 = 'Y')
               OR ((((CASE WHEN pmdt053 IS NULL THEN 0 ELSE pmdt053 END) - (CASE WHEN pmdt054 IS NULL THEN 0 ELSE pmdt054 END) - (CASE WHEN pmdt055 IS NULL THEN 0 ELSE pmdt055 END)) > 0) AND pmdt026 = 'N'))
             IF l_n = 0 OR cl_null(l_n) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00630'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #入庫時檢查收貨單號
          IF g_argv[1] MATCHES '[6]' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00449:sub-01302|apmt520",cl_get_progname("apmt520",g_lang,"2"),s_fin_get_colname("azzi001_01","or"),"|apmt522",cl_get_progname("apmt522",g_lang,"2")
             #160318-00025#15 by 07900 --add-end
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_2") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = p_pmds006
              AND ( (CASE WHEN pmdt053 IS NULL THEN 0 ELSE pmdt053 END) - (CASE WHEN pmdt054 IS NULL THEN 0 ELSE pmdt054 END)) > 0
             IF l_n = 0 OR cl_null(l_n) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00630'
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #倉退時檢查收貨單號
          IF g_argv[1] MATCHES '[7]' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		     
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             LET g_chkparam.where = " pmds000 IN ('1','2','3','4') "
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_6") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #委外驗退、入庫、倉退時檢查收貨單號
          IF g_argv[1] = '10' OR g_argv[1] = '12' OR g_argv[1] = '14' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		     
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_9") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          #重覆性生產驗退、入庫、倉退時檢查收貨單號
          IF g_argv[1] = '11' OR g_argv[1] = '13' OR g_argv[1] = '15' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00569:sub-01302|apmt523|",cl_get_progname("apmt523",g_lang,"2"),"|:EXEPROGapmt523"
             #160318-00025#15 by 07900 --add-end 
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_4") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
          #借貨入庫、倉退時檢查收貨單號
          IF g_argv[1] = '25' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		       #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="apm-00875:sub-01302|apmt524|",cl_get_progname("apmt524",g_lang,"2"),"|:EXEPROGapmt524"
             #160318-00025#15 by 07900 --add-end 
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_1") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          IF g_argv[1] = '26' THEN
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
		     
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = p_pmds006
             
             #呼叫檢查存在並帶值的library
             #輸入的採購單號狀態需要為已確認且未結案的採購單
             IF NOT cl_chk_exist("v_pmdsdocno_11") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
       
          #150610 earl add s
          #多角check
          IF NOT apmt520_pmds014_pmds053_chk(l_pmdl006,l_pmdl051) THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
          #多角性質為：2:代採購,3:代採購指定供應商,4:統購統付,5:統購自付,6:中間交易
          IF l_pmdl006 = '2' OR
             l_pmdl006 = '3' OR
             #l_pmdl006 = '4' OR   #150814 earl mark  統購統付多角代碼預設為空(由aicp950再設定)
             #l_pmdl006 = '5' OR   #150814 earl mark  統購自付多角代碼預設為空
             l_pmdl006 = '6' THEN
             
             IF cl_null(l_pmdl051) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'axm-00496'     #多角性質為多角流程時，"多角流程代碼"不可為空！
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
               
                LET g_errparam.replace[1] = l_gzze003
               
                CALL cl_err()
               
                LET r_success = FALSE
                RETURN r_success
             ELSE
                #150917-00001#3   2016/03/03  By earl mark s
#                #中斷續拋
#                IF apmt520_break_continue(l_pmdl051) THEN
#                
#                   #多角序號檢查
#                   IF NOT apmt520_source_pmds041_chk(p_pmds006,g_pmds_m.pmds041) THEN
#                      LET r_success = FALSE
#                      RETURN r_success
#                   END IF
#                   
#                END IF
                #150917-00001#3   2016/03/03  By earl mark e
                
             END IF
          
             IF l_pmdl030 <> 'Y' THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'axm-00517'     #來源需為"多角貿易已拋轉"之單據！
                LET g_errparam.extend = p_pmds006
                LET g_errparam.popup = TRUE
               
                LET g_errparam.replace[1] = l_gzze003
               
                CALL cl_err()
               
                LET r_success = FALSE
                RETURN r_success
             END IF

          END IF
          #150610 earl add e
          
          #151210-00009#1  2015/12/30 By earl s
          IF g_aic_doc THEN
             LET l_slip1 = ''
             LET l_slip2 = ''
             CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_slip1
             CALL s_aooi200_get_slip(p_pmds006) RETURNING l_success,l_slip2
             
             LET l_sql = "SELECT COUNT(1)",
                         "  FROM icab_t,icac_t",
                         " WHERE icabent = icacent AND icacent = ",g_enterprise,
                         "   AND icab001 = icac001",
                         "   AND icab002 = icac002",
                         "   AND icab003 = '",g_site,"'",
                         "   AND (icac011 = '",l_slip1,"' OR icac012 = '",l_slip1,"' OR icac013 = '",l_slip1,"')"             
             PREPARE apmt520_pmds006_pre1 FROM l_sql
             
             LET l_sql = l_sql," AND (icac010 = '",l_slip2,"' OR icac011 = '",l_slip2,"' OR icac012 = '",l_slip2,"')"
             PREPARE apmt520_pmds006_pre2 FROM l_sql
          
             LET l_n = 0
             EXECUTE apmt520_pmds006_pre1 INTO l_n
             
             IF l_n > 0 THEN
                LET l_n = 0
                EXECUTE apmt520_pmds006_pre2 INTO l_n
                IF l_n = 0 THEN
                   INITIALIZE g_errparam TO NULL
                   LET g_errparam.code = "aic-00211"   #多角貿易設定為"多角單據流水號保持一致"時前後單別需存在對應關係！
                   LET g_errparam.extend = ""
                   LET g_errparam.popup = FALSE
                   CALL cl_err()
          
                   LET r_success = FALSE
                   RETURN r_success
                END IF
          
             END IF
          
          END IF
          #151210-00009#1  2015/12/30 By earl e
          
       END IF
       
       RETURN r_success
       
END FUNCTION

PRIVATE FUNCTION apmt520_pmds007_ref(p_pmds007)
DEFINE p_pmds007    LIKE pmds_t.pmds007
DEFINE r_pmaal004   LIKE pmaal_t.pmaal004
#161207-00033#26-S
DEFINE l_pmaal004   LIKE pmaal_t.pmaal004
DEFINE l_pmaa004    LIKE pmaa_t.pmaa004  
#161207-00033#26-E

        INITIALIZE g_ref_fields TO NULL
        LET g_ref_fields[1] = p_pmds007
        CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
        LET r_pmaal004 = '', g_rtn_fields[1] , ''
        
        #161207-00033#27-S
        SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t
         WHERE pmaaent = g_enterprise
           AND pmaa001 = g_pmds_m.pmds007
        IF l_pmaa004 = '2' OR l_pmaa004 = '4' THEN
           CALL s_desc_get_oneturn_guest_desc(g_pmds_m.pmds028) RETURNING l_pmaal004   
        END IF 
        IF p_pmds007 = g_pmds_m.pmds007 THEN
           LET r_pmaal004 = l_pmaal004
        END IF        
        #161207-00033#27-E
        
        RETURN r_pmaal004
        
END FUNCTION
#單身採購單號檢查
PRIVATE FUNCTION apmt520_pmdt001_chk(p_pmdt001)
   DEFINE p_pmdt001   LIKE pmdt_t.pmdt001
   DEFINE l_pmdl006   LIKE pmdl_t.pmdl006
   DEFINE l_pmdl005   LIKE pmdl_t.pmdl005
   DEFINE l_pmdl006_1 LIKE pmdl_t.pmdl006
   DEFINE l_pmdl010   LIKE pmdl_t.pmdl010
   DEFINE l_pmdl010_1 LIKE pmdl_t.pmdl010
   DEFINE r_success   LIKE type_t.num5
   DEFINE l_seq       LIKE pmdt_t.pmdtseq
   DEFINE l_pmdt001   LIKE pmdt_t.pmdt001
   DEFINE l_pmdl051   LIKE pmdl_t.pmdl051
   DEFINE l_pmdl011   LIKE pmdl_t.pmdl011
   DEFINE l_pmdl015   LIKE pmdl_t.pmdl015
   DEFINE l_pmdl011_1 LIKE pmdl_t.pmdl011
   DEFINE l_pmdl015_1 LIKE pmdl_t.pmdl015
   DEFINE l_pmdl004   LIKE pmdl_t.pmdl004 
   #ming 20151013 add ----------------------(S) 
   DEFINE l_pmdl009   LIKE pmdl_t.pmdl009     #付款條件 
   #ming 20151013 add ----------------------(E)
  #160914-00025#1-s-add 
   DEFINE l_pmdl007   LIKE pmdl_t.pmdl007  
   DEFINE l_pmdl017   LIKE pmdl_t.pmdl017 
   DEFINE l_pmdl017_1 LIKE pmdl_t.pmdl017 
   DEFINE l_pmdl018   LIKE pmdl_t.pmdl018
   DEFINE l_pmdl018_1 LIKE pmdl_t.pmdl018
   DEFINE l_pmdl019   LIKE pmdl_t.pmdl019 
   DEFINE l_pmdl019_1 LIKE pmdl_t.pmdl019
   DEFINE l_pmdl020   LIKE pmdl_t.pmdl020 
   DEFINE l_pmdl020_1 LIKE pmdl_t.pmdl020
   DEFINE l_pmdl021   LIKE pmdl_t.pmdl021 
   DEFINE l_pmdl021_1 LIKE pmdl_t.pmdl021
   DEFINE l_pmdl022   LIKE pmdl_t.pmdl022 
   DEFINE l_pmdl022_1 LIKE pmdl_t.pmdl022
   DEFINE l_pmdl023   LIKE pmdl_t.pmdl023 
   DEFINE l_pmdl023_1 LIKE pmdl_t.pmdl023
   DEFINE l_pmdl024   LIKE pmdl_t.pmdl024 
   DEFINE l_pmdl024_1 LIKE pmdl_t.pmdl024
   DEFINE l_pmdl025   LIKE pmdl_t.pmdl025 
   DEFINE l_pmdl025_1 LIKE pmdl_t.pmdl025
   DEFINE l_pmdl026   LIKE pmdl_t.pmdl026 
   DEFINE l_pmdl026_1 LIKE pmdl_t.pmdl026
   DEFINE l_pmdl029   LIKE pmdl_t.pmdl029 
   DEFINE l_pmdl029_1 LIKE pmdl_t.pmdl029
   DEFINE l_pmdl033   LIKE pmdl_t.pmdl033 
   DEFINE l_pmdl033_1 LIKE pmdl_t.pmdl033       
   DEFINE l_pmdl052   LIKE pmdl_t.pmdl052   
   DEFINE l_pmdl052_1 LIKE pmdl_t.pmdl052  
   DEFINE l_pmdl054   LIKE pmdl_t.pmdl054 
   DEFINE l_pmdl054_1 LIKE pmdl_t.pmdl054
   DEFINE l_pmdl055   LIKE pmdl_t.pmdl055 
   DEFINE l_pmdl055_1 LIKE pmdl_t.pmdl055   
  #160914-00025#1-e-add  

   LET r_success = TRUE
       
   IF NOT cl_null(p_pmdt001) THEN
      IF NOT apmt520_pmds006_chk(p_pmdt001) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
          
      #輸入的採購單的採購性質要跟單頭的一致
      #ming 20151013 modify ----------(S) 
      #LET l_pmdl005 = ''
      #LET l_pmdl006 = ''
      #LET l_pmdl011 = ''
      #LET l_pmdl015 = ''
      #LET l_pmdl004 = ''
      #SELECT pmdl004,pmdl005,pmdl006,pmdl010,pmdl011,pmdl015 
      #  INTO l_pmdl004,l_pmdl005,l_pmdl006,l_pmdl010,l_pmdl011,l_pmdl015 
      #  FROM pmdl_t
      # WHERE pmdlent   = g_enterprise 
      #   AND pmdldocno = p_pmdt001
      #加入付款條件的檢查 
      LET l_pmdl005 = ''
      LET l_pmdl006 = ''
      LET l_pmdl009 = '' 
      LET l_pmdl011 = ''
      LET l_pmdl015 = ''
      LET l_pmdl004 = ''
     #160914-00025#1-s-add 
      LET l_pmdl007 = ''
      LET l_pmdl017 = ''
      LET l_pmdl018 = ''
      LET l_pmdl019 = ''
      LET l_pmdl020 = ''
      LET l_pmdl021 = ''
      LET l_pmdl022 = ''
      LET l_pmdl023 = ''
      LET l_pmdl024 = ''
      LET l_pmdl025 = ''
      LET l_pmdl026 = ''
      LET l_pmdl029 = ''
      LET l_pmdl033 = ''
      LET l_pmdl051 = ''
      LET l_pmdl052 = ''
      LET l_pmdl054 = ''
      LET l_pmdl055 = ''                                     
     #160914-00025#1-e-add
     #160914-00025#1-s-mark     
     #SELECT pmdl004,pmdl005,pmdl006,pmdl010,pmdl011,
     #       pmdl015,pmdl009
     #  INTO l_pmdl004,l_pmdl005,l_pmdl006,l_pmdl010,l_pmdl011,
     #       l_pmdl015,l_pmdl009
     #160914-00025#1-e-mark
     #160914-00025#1-s-add     
      SELECT pmdl004,pmdl005,pmdl006,pmdl007,pmdl009,
             pmdl010,pmdl011,pmdl015,pmdl017,pmdl018,
             pmdl019,pmdl020,pmdl021,pmdl022,pmdl023,
             pmdl024,pmdl025,pmdl026,pmdl029,pmdl033,
             pmdl051,pmdl052,pmdl054,pmdl055
        INTO l_pmdl004,l_pmdl005,l_pmdl006,l_pmdl007,l_pmdl009,
             l_pmdl010,l_pmdl011,l_pmdl015,l_pmdl017,l_pmdl018,
             l_pmdl019,l_pmdl020,l_pmdl021,l_pmdl022,l_pmdl023,
             l_pmdl024,l_pmdl025,l_pmdl026,l_pmdl029,l_pmdl033,
             l_pmdl051,l_pmdl052,l_pmdl054,l_pmdl055             
     #160914-00025#1-e-add        
        FROM pmdl_t
       WHERE pmdlent   = g_enterprise 
         AND pmdldocno = p_pmdt001
      #ming 20151013 modify ----------(E) 
         
      #输入的采购单号的供应商与单头采购供应商不一致！
      IF l_pmdl004 <> g_pmds_m.pmds007 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00730'
         LET g_errparam.extend = p_pmdt001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #輸入的採購單號的採購性質與單頭採購性質不一致！  
      IF l_pmdl005 <> g_pmds_m.pmds011 THEN         
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00365'
         LET g_errparam.extend = p_pmdt001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
          
      IF NOT cl_null(g_pmds_m.pmds053) THEN
         #輸入的採購單號的多角流程代碼與單頭的多角流程代碼不一致！
         IF l_pmdl051 <> g_pmds_m.pmds053 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'apm-00829' 
            LET g_errparam.extend = p_pmdt001
            LET g_errparam.popup = TRUE
            CALL cl_err()          
            LET r_success = FALSE
            RETURN r_success
         END IF
      END IF
          
      #输入的采购单号的税别与单头税别不一致！
      IF l_pmdl011 <> g_pmds_m.pmds033 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00838'
         LET g_errparam.extend = p_pmdt001
         LET g_errparam.popup = TRUE
         CALL cl_err()          
         LET r_success = FALSE
         RETURN r_success
      END IF
          
      #输入的采购单号的币别与单头币别不一致！
      IF l_pmdl015 <> g_pmds_m.pmds037 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00839'
         LET g_errparam.extend = p_pmdt001
         LET g_errparam.popup = TRUE
         CALL cl_err()          
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #ming 20151013 add ----------(S) 
      IF l_pmdl009 <> g_pmds_m.pmds031 THEN 
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = p_pmdt001 
         LET g_errparam.code   = 'apm-01004'      #輸入的採購單號的付款條件與單頭付款條件不一致！
         LET g_errparam.popup  = TRUE 
         CALL cl_err()          
         LET r_success = FALSE 
         RETURN r_success 
      END IF 
      #ming 20151013 add ----------(E) 
          
      LET l_pmdl006_1 = ''
      LET l_pmdl010_1 = ''
      LET l_pmdl011_1 = ''
      LET l_pmdl015_1 = ''
     #160914-00025#1-s-add 
      LET l_pmdl017_1 = ''
      LET l_pmdl018_1 = ''
      LET l_pmdl019_1 = ''
      LET l_pmdl020_1 = ''
      LET l_pmdl021_1 = ''
      LET l_pmdl022_1 = ''
      LET l_pmdl023_1 = ''
      LET l_pmdl024_1 = ''
      LET l_pmdl025_1 = ''
      LET l_pmdl026_1 = ''
      LET l_pmdl029_1 = ''
      LET l_pmdl033_1 = ''
      LET l_pmdl052_1 = ''
      LET l_pmdl054_1 = ''
      LET l_pmdl055_1 = ''       
     #160914-00025#1-e-add  
      LET l_seq = g_pmdt_d[l_ac].pmdtseq - 1
      IF l_seq > 0 THEN
         SELECT pmdt001 
           INTO l_pmdt001 
           FROM pmdt_t 
          WHERE pmdtent   = g_enterprise 
            AND pmdtdocno = g_pmds_m.pmdsdocno 
            AND pmdtseq   = l_seq
        #160914-00025#1-s-mark
        #SELECT pmdl006,pmdl010,pmdl011,pmdl015
        #  INTO l_pmdl006_1,l_pmdl010_1,l_pmdl011_1,l_pmdl015_1
        #160914-00025#1-e-mark            
        #160914-00025#1-s-add     
         SELECT pmdl006,
                pmdl010,pmdl011,pmdl015,pmdl017,pmdl018,
                pmdl019,pmdl020,pmdl021,pmdl022,pmdl023,
                pmdl024,pmdl025,pmdl026,pmdl029,pmdl033,
                pmdl052,pmdl054,pmdl055
           INTO l_pmdl006_1,
                l_pmdl010_1,l_pmdl011_1,l_pmdl015_1,l_pmdl017_1,l_pmdl018_1,
                l_pmdl019_1,l_pmdl020_1,l_pmdl021_1,l_pmdl022_1,l_pmdl023_1,
                l_pmdl024_1,l_pmdl025_1,l_pmdl026_1,l_pmdl029_1,l_pmdl033_1,
                l_pmdl052_1,l_pmdl054_1,l_pmdl055_1             
        #160914-00025#1-e-add             
           FROM pmdl_t
          WHERE pmdlent   = g_enterprise 
            AND pmdldocno = l_pmdt001             
         #輸入的採購單的多角性質需一致，不可不同收貨項次對應採購單的多角性質不一致
         IF l_pmdl006 <> l_pmdl006_1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'apm-00366'
            LET g_errparam.extend = p_pmdt001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
            RETURN r_success
         END IF
             
         #当收貨單身有對到多張採購單時，檢核單身所有的採購單的交易條件都要一樣
         IF l_pmdl010 <> l_pmdl010_1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'apm-00367'
            LET g_errparam.extend = p_pmdt001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
            RETURN r_success
         END IF
        #160914-00025#1-s-add
         IF (l_pmdl005 = '1' AND l_pmdl006 = '3') OR (l_pmdl005 = '1' AND l_pmdl006 = '1' AND l_pmdl007 = '9') THEN
           #輸入採購單的多角流程代號需一致，不可不同收貨項次對應採購單的多角流程代號不一致
            IF l_pmdl052 <> l_pmdl052_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00230'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF         
           #輸入的採購單的最終供應商需一致，不可不同收貨項次對應採購單的最終供應商不一致
            IF l_pmdl052 <> l_pmdl052_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00229'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的取價方式需一致，不可不同收貨項次對應採購單的取價方式不一致
            IF l_pmdl017 <> l_pmdl017_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00231'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF 
            #輸入採購單的付款優惠條件需一致，不可不同收貨項次對應採購單的付款優惠條件不一致
            IF l_pmdl018 <> l_pmdl018_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00232'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF    
            #輸入採購單的納入APS計算需一致，不可不同收貨項次對應採購單的納入APS計算不一致
            IF l_pmdl019 <> l_pmdl019_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00233'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF 
            #輸入採購單的運送方式需一致，不可不同收貨項次對應採購單的運送方式不一致
            IF l_pmdl020 <> l_pmdl020_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00234'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF 
            #輸入採購單的付款供應商需一致，不可不同收貨項次對應採購單的付款供應商不一致
            IF l_pmdl021 <> l_pmdl021_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00235'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的送貨供應商需一致，不可不同收貨項次對應採購單的送貨供應商不一致
            IF l_pmdl022 <> l_pmdl022_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00236'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的採購通路需一致，不可不同收貨項次對應採購單的採購通路不一致
            IF l_pmdl023 <> l_pmdl023_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00237'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的採購分類需一致，不可不同收貨項次對應採購單的採購分類不一致
            IF l_pmdl024 <> l_pmdl024_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00238'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的送貨方式需一致，不可不同收貨項次對應採購單的送貨方式不一致
            IF l_pmdl025 <> l_pmdl025_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00239'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的帳款地址需一致，不可不同收貨項次對應採購單的帳款地址不一致
            IF l_pmdl026 <> l_pmdl026_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00240'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的收貨部門需一致，不可不同收貨項次對應採購單的收貨部門不一致
            IF l_pmdl029 <> l_pmdl029_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00241'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的發票類型需一致，不可不同收貨項次對應採購單的發票類型不一致
            IF l_pmdl033 <> l_pmdl033_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00242'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的內外購需一致，不可不同收貨項次對應採購單的內外購不一致
            IF l_pmdl054 <> l_pmdl054_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00243'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
            #輸入採購單的匯率計算基準需一致，不可不同收貨項次對應採購單的匯率計算基準不一致
            IF l_pmdl055 <> l_pmdl055_1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'aic-00244'
               LET g_errparam.extend = p_pmdt001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF         
         END IF   
        #160914-00025#1-e-add
      END IF
   END IF
       
   RETURN r_success
     
END FUNCTION
#檢查是否存在對應的交期明細資料
PRIVATE FUNCTION apmt520_pmdo_chk()
DEFINE l_n       LIKE type_t.num5
DEFINE r_success LIKE type_t.num5

       LET r_success = TRUE
       
       #150814 earl add start
       IF (NOT cl_null(g_pmdt_d[l_ac].pmdt001)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt002)) THEN
          LET l_n = 0 
          SELECT COUNT(1) INTO l_n FROM pmdn_t 
            WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdt_d[l_ac].pmdt001
              AND pmdnseq = g_pmdt_d[l_ac].pmdt002
              AND pmdnunit = g_site
              
          IF cl_null(l_n) OR l_n = 0 THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'apm-00369'
             LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
             LET g_errparam.popup = TRUE
             CALL cl_err()

             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
       #150814 earl add end
       
       #若採購單號、採購項次、採購項序、採購分批序均有值時，需撿核該採購單是否有對應的交期明細資料
       IF (NOT cl_null(g_pmdt_d[l_ac].pmdt001)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt002)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt003)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt004)) THEN
          LET l_n = 0 
          SELECT COUNT(1) INTO l_n FROM pmdo_t 
            WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001
              AND pmdoseq = g_pmdt_d[l_ac].pmdt002
              AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
              AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
          IF cl_null(l_n) OR l_n = 0 THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'apm-00369'
             LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
             LET g_errparam.popup = TRUE
             CALL cl_err()

             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
       
       RETURN r_success
       
       
END FUNCTION
#帶出採購單相關資料
PRIVATE FUNCTION apmt520_pmdt001_desc()
   DEFINE l_pmdt020   LIKE pmdt_t.pmdt020
   DEFINE l_pmdo006   LIKE pmdo_t.pmdo006
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_rate      LIKE inaj_t.inaj014
   DEFINE l_sql       STRING
   DEFINE l_pmdp003   LIKE pmdp_t.pmdp003
   DEFINE l_pmdp009   LIKE pmdp_t.pmdp009
   DEFINE l_pmdp010   LIKE pmdp_t.pmdp010
   DEFINE l_sets      LIKE type_t.num26_10
   DEFINE l_ooba002   LIKE ooba_t.ooba002  #dorislai-20150824-add

#150917-00001#3  2016/03/08  By earl add s
   DEFINE l_chk            LIKE type_t.num5        #TRUE 需要校驗檢查  FALSE  不需校驗檢查
   DEFINE l_qty            LIKE xmdl_t.xmdl205     #未續拋數量
   DEFINE l_qty_batch      LIKE xmdl_t.xmdl205     #未續拋數量(考慮批號)
#150917-00001#3  2016/03/08  By earl add e

   IF (NOT cl_null(g_pmdt_d[l_ac].pmdt001)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt002)) AND 
      (NOT cl_null(g_pmdt_d[l_ac].pmdt003)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt004)) THEN
      LET g_pmdt_d[l_ac].pmdo001 = ''  #採購料號
      LET g_pmdt_d[l_ac].pmdo002 = ''  #產品特徵
      LET g_pmdt_d[l_ac].pmdt005 = ''  #子特性
      LET g_pmdt_d[l_ac].pmdt019 = ''  #單位
      LET g_pmdt_d[l_ac].pmdt020 = 0   #數量
      LET g_pmdt_d[l_ac].pmdt006 = ''  #收貨料號
      LET g_pmdt_d[l_ac].pmdt007 = ''  #收貨產品特徵
      LET g_pmdt_d[l_ac].pmdt036 = 0    #單價
      LET g_pmdt_d[l_ac].pmdt046 = ''   #稅別
      LET g_pmdt_d[l_ac].pmdt037 = 0    #稅率
      
      SELECT pmdo001,pmdo002,pmdo003,pmdo004,(pmdo006-pmdo015+pmdo016+pmdo017),pmdo022,pmdo023,pmdo024 
        INTO g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002,g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt019,
             l_pmdo006,
             g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt037
        FROM pmdo_t 
       WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001
         AND pmdoseq = g_pmdt_d[l_ac].pmdt002
         AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
         AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
      LET g_pmdt_d[l_ac].pmdt006 = g_pmdt_d[l_ac].pmdo001  #收貨料號
      LET g_pmdt_d[l_ac].pmdt007 = g_pmdt_d[l_ac].pmdo002  #收貨產品特徵
          
      IF cl_null(l_pmdo006) THEN
         LET l_pmdo006 = 0
      END IF
      
      #其他收貨單上錄入的數量
      LET l_pmdt020 = 0
      ##130909-00003#58---add--begin---
      IF g_pmdt_d[l_ac].pmdt005 = '10' THEN  
         SELECT SUM(pmdt020) INTO l_pmdt020 
            FROM pmdt_t,pmds_t 
            WHERE pmdtent   = pmdsent 
              AND pmdtdocno = pmdsdocno
              AND pmdtent   = g_enterprise 
              AND pmdt001   = g_pmdt_d[l_ac].pmdt001
              AND pmdt002   = g_pmdt_d[l_ac].pmdt002
              AND pmdt003   = g_pmdt_d[l_ac].pmdt003
              AND pmdt004   = g_pmdt_d[l_ac].pmdt004
              AND pmdsstus = 'N'  
              AND pmds100 <> '4'   #151020-00006 by whitney modify
              AND pmds000   = g_pmds_m.pmds000
              AND pmdt005 = '10'
      ELSE
         IF g_pmdt_d[l_ac].pmdt005 = '11' THEN  
           SELECT SUM(pmdt020) INTO l_pmdt020 
             FROM pmdt_t,pmds_t 
             WHERE pmdtent   = pmdsent 
               AND pmdtdocno = pmdsdocno
               AND pmdtent   = g_enterprise 
               AND pmdt001   = g_pmdt_d[l_ac].pmdt001
               AND pmdt002   = g_pmdt_d[l_ac].pmdt002
               AND pmdt003   = g_pmdt_d[l_ac].pmdt003
               AND pmdt004   = g_pmdt_d[l_ac].pmdt004
               AND pmdsstus = 'N'  
               AND pmds100 <> '4'   #151020-00006 by whitney modify
               AND pmds000   = g_pmds_m.pmds000
               AND pmdt005 = '11' AND pmdt006 = g_pmdt_d[l_ac].pmdt006
         ELSE
      #130909-00003#58--add---end---
           SELECT SUM(pmdt020) INTO l_pmdt020 
             FROM pmdt_t,pmds_t 
             WHERE pmdtent   = pmdsent 
               AND pmdtdocno = pmdsdocno
               AND pmdtent   = g_enterprise 
               AND pmdt001   = g_pmdt_d[l_ac].pmdt001
               AND pmdt002   = g_pmdt_d[l_ac].pmdt002
               AND pmdt003   = g_pmdt_d[l_ac].pmdt003
               AND pmdt004   = g_pmdt_d[l_ac].pmdt004
               AND pmdsstus = 'N'  
               AND pmds100 <> '4'   #151020-00006 by whitney modify
               AND pmds000   = g_pmds_m.pmds000
         END IF  #130909-00003#58 add  
      END IF  #130909-00003#58 add                 
      IF cl_null(l_pmdt020) THEN
         LET l_pmdt020 = 0
      END IF
          
      #委外採購收貨時，收貨數量要判斷本項次收貨量+對應工單已收貨量-驗退量-類型4倉退量+其他單據收貨量不可大於工單齊套套數（s_asft340_full_sets）
      IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' THEN
         #獲得收穫對應的採購單號和項次
         #SELECT pmdt001,pmdt002 INTO l_pmdt001,l_pmdt002 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = p_pmdsdocno AND pmdtseq = p_pmdtseq
         #根據採購單和項次找到來源工單的單號、作業號製程序
         SELECT pmdp003,pmdp009,pmdp010 INTO l_pmdp003,l_pmdp009,l_pmdp010 
           FROM pmdp_t 
          WHERE pmdpent   = g_enterprise 
            AND pmdpdocno = g_pmdt_d[l_ac].pmdt001 
            AND pmdpseq   = g_pmdt_d[l_ac].pmdt002
            
         CALL s_asft340_full_sets(l_pmdp003,l_pmdp009,l_pmdp010,g_pmds_m.pmdsdocdt) 
              RETURNING l_success,l_sets
         IF l_pmdo006 < l_sets THEN
            LET l_sets = l_pmdo006
         END IF
         
         #161019-00046#1--s
         #委外代买料不考虑发料套数
         IF g_pmdt_d[l_ac].pmdt005 = '8' OR g_pmdt_d[l_ac].pmdt005 = '11' THEN   #170208-00055#1 add '11' 拆件元件也不考虑发料套数
            LET l_sets = l_pmdo006
         END IF
         #161019-00046#1--e
         
         LET g_pmdt_d[l_ac].pmdt020 = l_sets - l_pmdt020
             
         #帶出工單的指定入庫庫位，儲位，批號
         SELECT DISTINCT pmdp003 INTO l_pmdp003 
           FROM pmdp_t 
          WHERE pmdpent = g_enterprise 
            AND pmdpdocno = g_pmdt_d[l_ac].pmdt001 
            AND pmdpseq = g_pmdt_d[l_ac].pmdt002
         SELECT sfaa034,sfaa035,sfaa059 
           INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018 
           FROM sfaa_t
          WHERE sfaaent = g_enterprise 
            AND sfaadocno = l_pmdp003
         CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
         DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
         
         CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
         DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
         
      ELSE
         #收貨數量 =pmdo006(需求量)-pmdo015(已收貨量)+pmdo016(驗退量)-已登打收貨單位確認量
         LET g_pmdt_d[l_ac].pmdt020 = l_pmdo006 - l_pmdt020
      END IF

      #150917-00001#3  2016/03/08  By earl add s
      #多角可續拋數量
      IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' OR
         g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
         
         CALL s_aic_carry_continue_qty(g_site,g_pmds_m.pmds053,'2',g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,'','','')
         RETURNING l_chk,l_qty,l_qty_batch
         
         IF l_chk THEN
            IF l_qty < g_pmdt_d[l_ac].pmdt020 THEN
               LET g_pmdt_d[l_ac].pmdt020 = l_qty
            END IF
         END IF
      END IF
      #150917-00001#3  2016/03/08  By earl add e

      CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdo001) 
           RETURNING g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004
      DISPLAY BY NAME g_pmdt_d[l_ac].imaal003,g_pmdt_d[l_ac].imaal004
          
      CALL s_feature_description(g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002) 
           RETURNING l_success,g_pmdt_d[l_ac].pmdo002_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdo002_desc
          
      CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) 
           RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          
      CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) 
           RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
          
      CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) 
           RETURNING g_pmdt_d[l_ac].pmdt019_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc
          
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdo001,g_pmdt_d[l_ac].pmdo002,g_pmdt_d[l_ac].pmdt005, 
                      g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020
          
      LET g_pmdt_d[l_ac].pmdt008 = ''   #包裝容器
      LET g_pmdt_d[l_ac].pmdt009 = ''   #作業編號
      LET g_pmdt_d[l_ac].pmdt010 = ''   #製程序
      LET g_pmdt_d[l_ac].pmdt021 = ''   #參考單位
      LET g_pmdt_d[l_ac].pmdt022 = 0    #參考數量
      LET g_pmdt_d[l_ac].pmdt023 = ''   #計價單位
      LET g_pmdt_d[l_ac].pmdt024 = 0    #計價數量
      LET g_pmdt_d[l_ac].pmdt025 = ''   #緊急度
      LET g_pmdt_d[l_ac].pmdt016 = ''   #庫位
      LET g_pmdt_d[l_ac].pmdt017 = ''   #儲位
      LET g_pmdt_d[l_ac].pmdt018 = ''   #批號
      LET g_pmdt_d[l_ac].pmdt040 = ''   #價格類型
      LET g_pmdt_d[l_ac].pmdt041 = ''   #保稅
      LET g_pmdt_d[l_ac].pmdt059 = ''   #備註
          
      SELECT pmdn003,pmdn004,pmdn005,pmdn008,pmdn010,pmdn020,pmdn028,pmdn029,pmdn030,pmdn035,pmdn021,pmdn052,pmdn050,
             pmdn040,pmdn041,pmdn042,pmdn043,pmdn044,
             pmdn036,pmdn037,pmdn038
        INTO g_pmdt_d[l_ac].pmdt008,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt021,
             g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt016,
             g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt040,g_pmdt_d[l_ac].pmdt041,
             g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt059,
             g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt048,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt045,
             g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074                
        FROM pmdn_t
       WHERE pmdnent   = g_enterprise 
         AND pmdndocno = g_pmdt_d[l_ac].pmdt001
         AND pmdnseq   = g_pmdt_d[l_ac].pmdt002
      
      #dorislai-20150824-add----(S)
      #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
      IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
         #預設欄位
         CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
         IF l_success THEN
            CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016',g_pmdt_d[l_ac].pmdt016) 
                 RETURNING g_pmdt_d[l_ac].pmdt016
            #應用參數
            IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
               CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') 
                    RETURNING g_pmdt_d[l_ac].pmdt016
            END IF
         END IF          
      END IF
      #dorislai-20150824-add----(E)   
           
      #若委外採購時來源單據沒有倉儲批，帶出預設值
      #IF g_pmdt_d[l_ac].pmdt062 = 'N' AND g_argv[1] MATCHES '[8]' THEN
      #預設料件的庫儲
      IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
         IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
            SELECT imaf091,imaf092 INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017
              FROM imaf_t
              WHERE imafent  = g_enterprise 
                AND imafsite = g_site 
                AND imaf001  = g_pmdt_d[l_ac].pmdt006
         END IF
         IF g_pmdt_d[l_ac].pmdt017 IS NULL THEN
            SELECT imaf092 INTO g_pmdt_d[l_ac].pmdt017
              FROM imaf_t
             WHERE imafent  = g_enterprise 
               AND imafsite = g_site 
               AND imaf001  = g_pmdt_d[l_ac].pmdt006
         END IF
      END IF
      
      LET l_rate = 1
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt021) THEN
         #CALL s_aimi190_get_convert(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021) RETURNING l_success,l_rate
         #LET g_pmdt_d[l_ac].pmdt022 = g_pmdt_d[l_ac].pmdt020 * l_rate   #參考數量
         CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019, 
                                    g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
              RETURNING l_success,g_pmdt_d[l_ac].pmdt022
      ELSE
         LET g_pmdt_d[l_ac].pmdt022 = ''
      END IF
          
      LET l_rate = 1
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
         #CALL s_aimi190_get_convert(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023) RETURNING l_success,l_rate
         #LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020 * l_rate   #計價數量
         #160929-00038#1---s
         CALL s_apmt520_get_pmdt024(g_pmds_m.pmds000,g_pmds_m.pmdsdocno,'','',g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt023)
             RETURNING g_pmdt_d[l_ac].pmdt024
         IF cl_null(g_pmdt_d[l_ac].pmdt024) OR g_pmdt_d[l_ac].pmdt024 = 0 THEN
         #160929-00038#1---e
            CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019, 
                                       g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                   RETURNING l_success,g_pmdt_d[l_ac].pmdt024
         END IF #160929-00038#1
      ELSE
         LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
         LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
      END IF
          
      LET g_pmdt_d[l_ac].pmdt052 = '1'              #狀態碼 '1:一般'
          
      #預設沖銷順序
      LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
                  "  WHERE pmdtent   = '",g_enterprise,"' ", 
                  "    AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
                  "    AND pmdt006   = '",g_pmdt_d[l_ac].pmdt006,"' ",
                  "    AND pmdt007   = '",g_pmdt_d[l_ac].pmdt007,"' "
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
         LET l_sql =  l_sql , " AND pmdt019 = '",g_pmdt_d[l_ac].pmdt019,"' "
      END IF
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
         LET l_sql =  l_sql , " AND pmdt016 = '",g_pmdt_d[l_ac].pmdt016,"' "
      END IF
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) OR g_pmdt_d[l_ac].pmdt017 = ' ' THEN
         LET l_sql =  l_sql , " AND pmdt017 = '",g_pmdt_d[l_ac].pmdt017,"' "
      END IF
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
         LET l_sql =  l_sql , " AND pmdt018 = '",g_pmdt_d[l_ac].pmdt018,"' "
      END IF
      PREPARE pmdt011_pre7 FROM l_sql
      EXECUTE pmdt011_pre7 INTO g_pmdt_d[l_ac].pmdt011
          
      IF cl_null(g_pmdt_d[l_ac].pmdt011) OR g_pmdt_d[l_ac].pmdt011 = 0 THEN
         LET g_pmdt_d[l_ac].pmdt011 = 1
      END IF
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt011
                  
          
      CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
          
      CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc
          
      CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
          
      CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
          
      CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
          
      CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
          
      IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt036)) AND 
         (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
         CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001, 
                                   g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
           RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
         DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
      END IF
          
      CALL s_desc_get_project_desc(g_pmdt_d[l_ac].pmdt072) RETURNING g_pmdt_d[l_ac].pmdt072_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt072_desc
          
      CALL s_desc_get_wbs_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073) 
           RETURNING g_pmdt_d[l_ac].pmdt073_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt073_desc
          
      CALL s_desc_get_activity_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt074) 
           RETURNING g_pmdt_d[l_ac].pmdt074_desc
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt074_desc
        
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010, 
                      g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt023,
                      g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046,
                      g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt016,
                      g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt040,
                      g_pmdt_d[l_ac].pmdt041,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt072, 
                      g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074
      
      #20151012 ming mark ------------------------------------------------------------(S)       
      #不可由單身回寫單頭資料，容易造成資料異常 
      ##若單頭交易條件、幣別等資料，根據採購單號帶出
      #IF cl_null(g_pmds_m.pmds031) OR cl_null(g_pmds_m.pmds032) OR cl_null(g_pmds_m.pmds033) OR 
      #   cl_null(g_pmds_m.pmds037) OR cl_null(g_pmds_m.pmds012) THEN
      #   SELECT pmdl009,pmdl010,pmdl011,pmdl012,pmdl013,pmdl015,pmdl016,pmdl023 
      #     INTO g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034, 
      #          g_pmds_m.pmds035,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds012
      #     FROM pmdl_t 
      #    WHERE pmdlent   = g_enterprise 
      #      AND pmdldocno = g_pmdt_d[l_ac].pmdt001
      #      
      #   UPDATE pmds_t SET pmds031 = g_pmds_m.pmds031,
      #                     pmds032 = g_pmds_m.pmds032,
      #                     pmds033 = g_pmds_m.pmds033,
      #                     pmds034 = g_pmds_m.pmds034,
      #                     pmds035 = g_pmds_m.pmds035,
      #                     pmds037 = g_pmds_m.pmds037,
      #                     pmds038 = g_pmds_m.pmds038,
      #                     pmds012 = g_pmds_m.pmds012
      #    WHERE pmdsent = g_enterprise 
      #      AND pmdsdocno = g_pmds_m.pmdsdocno
      #END IF
      #20151012 ming mark ------------------------------------------------------------(E) 

   END IF
       
END FUNCTION

PRIVATE FUNCTION apmt520_pmdt008_ref(p_pmdt008)
DEFINE p_pmdt008    LIKE pmdt_t.pmdt008
DEFINE r_imaal003   LIKE imaal_t.imaal003

        INITIALIZE g_ref_fields TO NULL
        LET g_ref_fields[1] = p_pmdt008
        CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
        LET r_imaal003 = '', g_rtn_fields[1] , ''
        RETURN r_imaal003
       
END FUNCTION

#採購收貨、採購收貨入庫時，檢查對應採購單號的採購項次
#驗退、入庫、倉退時，檢查對應收貨單號的收貨項次
PRIVATE FUNCTION apmt520_pmdt002_chk()
DEFINE l_pmdn045    LIKE pmdn_t.pmdn045
DEFINE l_n          LIKE type_t.num5
DEFINE l_pmdt020    LIKE pmdt_t.pmdt020
DEFINE l_pmdt054    LIKE pmdt_t.pmdt054
DEFINE l_pmdt055    LIKE pmdt_t.pmdt055
DEFINE l_pmdt020_1  LIKE pmdt_t.pmdt020
DEFINE l_qcba017    LIKE qcba_t.qcba017
DEFINE l_qcba023    LIKE qcba_t.qcba023
DEFINE l_pmdt026    LIKE pmdt_t.pmdt026
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdn023    LIKE pmdn_t.pmdn023

        LET r_success = TRUE
        
        #採購收貨、採購收貨入庫時，檢查對應採購單號的採購項次
        IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
           #輸入的採購單號+採購項次必須存在pmdo_t中
           LET l_n = 0
           SELECT COUNT(1) INTO l_n FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = g_pmdt_d[l_ac].pmdt001 AND pmdoseq = g_pmdt_d[l_ac].pmdt002
           IF l_n = 0 OR cl_null(l_n) THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'apm-00372'
              LET g_errparam.extend = g_pmdt_d[l_ac].pmdt002
              LET g_errparam.popup = TRUE
              CALL cl_err()

              LET r_success = FALSE
              RETURN r_success
           END IF
           
           #輸入的採購項次行狀態不可以為結案狀態
           LET l_pmdn045 = ''
           LET l_pmdn023 = ''
           SELECT pmdn023,pmdn045 INTO l_pmdn023,l_pmdn045 FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = g_pmdt_d[l_ac].pmdt001 AND pmdnseq = g_pmdt_d[l_ac].pmdt002
           CASE WHEN SQLCA.sqlcode = 100
                     INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'apm-00372'
              LET g_errparam.extend = g_pmdt_d[l_ac].pmdt002
              LET g_errparam.popup = TRUE
              CALL cl_err()

                     LET r_success = FALSE
                WHEN l_pmdn045 <> '1'
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00373'
                     LET g_errparam.extend = g_pmdt_d[l_ac].pmdt002
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET r_success = FALSE
                WHEN SQLCA.SQLCODE != 0
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.SQLCODE
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET r_success = FALSE
           END CASE
           
           #输入的采购单号的供应商与单头送货供应商不一致！
           IF l_pmdn023 <> g_pmds_m.pmds009 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'apm-00841'
              LET g_errparam.extend = g_pmdt_d[l_ac].pmdt002
              LET g_errparam.popup = TRUE
              CALL cl_err()
           
              LET r_success = FALSE
              RETURN r_success
           END IF
           
        END IF

        RETURN r_success
        
END FUNCTION
#收貨料號檢查
PRIVATE FUNCTION apmt520_pmdt006_chk(p_pmdt006)
DEFINE p_pmdt006     LIKE pmdt_t.pmdt006
DEFINE l_flag        LIKE type_t.num5
DEFINE l_success     LIKE type_t.num5
DEFINE l_ooba002     LIKE ooba_t.ooba002
DEFINE l_pmdp007     LIKE pmdp_t.pmdp007
DEFINE r_success     LIKE type_t.num5
DEFINE l_pmdp003     LIKE pmdp_t.pmdp003  #160606-00013#1

       LET r_success = TRUE

       IF NOT cl_null(p_pmdt006) THEN
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL

          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = p_pmdt006

          #呼叫檢查存在並帶值的library
          IF cl_chk_exist("v_imaa001") THEN
             IF NOT cl_chk_exist("v_imaf001_14") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             ##倉退时，開有庫存的料號
             #IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
             #   IF NOT cl_chk_exist("v_inag001") THEN
             #      LET r_success = FALSE
             #      RETURN r_success
             #   END IF
             #END IF
          ELSE
             LET r_success = FALSE
             RETURN r_success
          END IF

          ##判斷輸入的料件編號是否在控制組限制的產品範圍內，若不在限制內則不允許請購此料
          #CALL s_control_chk_group('3','4',g_user,g_dept,p_pmdt006,'','','','') RETURNING l_success,l_flag
          #IF NOT l_success THEN      #处理状态
          #   LET r_success = FALSE
          #   RETURN r_success
          #ELSE
          #   IF NOT l_flag THEN      #是否存在
          #      CALL cl_err(p_pmdt006,'apm-00265',1)
          #      LET r_success = FALSE
          #      RETURN r_success
          #   END IF
          #END IF

          #檢核輸入的料件的生命週期是否在單據別限制範圍內，若不在限制內則不允許請購此料
          CALL s_control_chk_doc('4',g_pmds_m.pmdsdocno,p_pmdt006,'','','','') RETURNING l_success,l_flag
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                #CALL cl_err(p_pmdt006,'ain-00015',1)
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF

          #檢核輸入的料件的產品分類是否在單據別限制範圍內，若不在限制內則不允許請購此料
          CALL s_control_chk_doc('5',g_pmds_m.pmdsdocno,p_pmdt006,'','','','') RETURNING l_success,l_flag
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                LET r_success = FALSE
                #CALL cl_err(p_pmdt006,'apm-00238',1)
                RETURN r_success
             END IF
          END IF
          
          #當收貨料號與採購料號不一樣時，必須檢核是否與採購料號有替代關係，若沒有則不允許修改
          IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
             IF p_pmdt006 <> g_pmdt_d[l_ac].pmdo001 AND NOT cl_null(g_pmdt_d[l_ac].pmdo001) THEN
                #160606-00013#1---s
			       #当委外采购来源工单有联产品，子件特性要可以修改为联产品，然后料件可以输入联产品料号
                IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' AND g_pmdt_d[l_ac].pmdt005 = '12' THEN
                   SELECT pmdp003 INTO l_pmdp003 FROM pmdp_t WHERE pmdpent = g_enterprise AND pmdpdocno = g_pmdt_d[l_ac].pmdt001 AND pmdpseq = g_pmdt_d[l_ac].pmdt002 
                   #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                   INITIALIZE g_chkparam.* TO NULL
                   
                   #設定g_chkparam.*的參數
                   LET g_chkparam.arg1 = l_pmdp003
                   LET g_chkparam.arg2 = p_pmdt006
                   
                   #呼叫檢查存在並帶值的library
                   IF NOT cl_chk_exist("v_sfac001_1") THEN
                      LET r_success = FALSE
                      RETURN r_success
                   END IF
                ELSE
                #160606-00013#1---e    
                   IF NOT s_pmaq_chk_replacement(g_pmds_m.pmds007,g_pmdt_d[l_ac].pmdo001,p_pmdt006,'3',g_pmdt_d[l_ac].pmdo002,g_pmdt_d[l_ac].pmdt007) THEN
                      LET r_success = FALSE
                      RETURN r_success
                   END IF
                END IF #160606-00013#1
             END IF 
          END IF 
          
          #收貨單在維護料號時需檢核料件AVL控管點(imaa044)設置，若是設置'2:可採購，不可收貨'時，則要檢核
          #其他收貨、無採購收貨、收貨入庫單等作業也需考慮
          IF g_argv[1] MATCHES '[123489]' OR g_argv[1] = '20' THEN
             IF NOT s_apmt520_item_avl_chk(g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdtseq,p_pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmds_m.pmds007) THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          
       END IF
       
       RETURN r_success

END FUNCTION
#根據單頭採購單號，自動產生單身
PRIVATE FUNCTION apmt520_gen_pmdt()
   #161124-00048#11 mod-S
#   DEFINE l_pmdo           RECORD LIKE pmdo_t.*
#   DEFINE l_pmdt           RECORD LIKE pmdt_t.*
#   DEFINE l_pmdn           RECORD LIKE pmdn_t.*
   DEFINE l_pmdo RECORD  #採購交期明細檔
          pmdoent LIKE pmdo_t.pmdoent, #企业编号
          pmdosite LIKE pmdo_t.pmdosite, #营运据点
          pmdodocno LIKE pmdo_t.pmdodocno, #采购单号
          pmdoseq LIKE pmdo_t.pmdoseq, #采购项次
          pmdoseq1 LIKE pmdo_t.pmdoseq1, #项序
          pmdoseq2 LIKE pmdo_t.pmdoseq2, #分批序
          pmdo001 LIKE pmdo_t.pmdo001, #料件编号
          pmdo002 LIKE pmdo_t.pmdo002, #产品特征
          pmdo003 LIKE pmdo_t.pmdo003, #子件特性
          pmdo004 LIKE pmdo_t.pmdo004, #采购单位
          pmdo005 LIKE pmdo_t.pmdo005, #采购总数量
          pmdo006 LIKE pmdo_t.pmdo006, #分批采购数量
          pmdo007 LIKE pmdo_t.pmdo007, #折合主件数量
          pmdo008 LIKE pmdo_t.pmdo008, #QPA
          pmdo009 LIKE pmdo_t.pmdo009, #交期类型
          pmdo010 LIKE pmdo_t.pmdo010, #收货时段
          pmdo011 LIKE pmdo_t.pmdo011, #出货日期
          pmdo012 LIKE pmdo_t.pmdo012, #到厂日期
          pmdo013 LIKE pmdo_t.pmdo013, #到库日期
          pmdo014 LIKE pmdo_t.pmdo014, #MRP交期冻结
          pmdo015 LIKE pmdo_t.pmdo015, #已收货量
          pmdo016 LIKE pmdo_t.pmdo016, #验退量
          pmdo017 LIKE pmdo_t.pmdo017, #仓退换货量
          pmdo019 LIKE pmdo_t.pmdo019, #已入库量
          pmdo020 LIKE pmdo_t.pmdo020, #VMI请款量
          pmdo021 LIKE pmdo_t.pmdo021, #交货状态
          pmdo022 LIKE pmdo_t.pmdo022, #参考价格
          pmdo023 LIKE pmdo_t.pmdo023, #税种
          pmdo024 LIKE pmdo_t.pmdo024, #税率
          pmdo025 LIKE pmdo_t.pmdo025, #电子采购单号
          pmdo026 LIKE pmdo_t.pmdo026, #最近更改人员
          pmdo027 LIKE pmdo_t.pmdo027, #最近更改时间
          pmdo028 LIKE pmdo_t.pmdo028, #分批参考单位
          pmdo029 LIKE pmdo_t.pmdo029, #分批参考数量
          pmdo030 LIKE pmdo_t.pmdo030, #分批计价单位
          pmdo031 LIKE pmdo_t.pmdo031, #分批计价数量
          pmdo032 LIKE pmdo_t.pmdo032, #分批税前金额
          pmdo033 LIKE pmdo_t.pmdo033, #分批含税金额
          pmdo034 LIKE pmdo_t.pmdo034, #分批税额
          pmdo035 LIKE pmdo_t.pmdo035, #初始营运据点
          pmdo036 LIKE pmdo_t.pmdo036, #初始来源单号
          pmdo037 LIKE pmdo_t.pmdo037, #初始来源项次
          pmdo038 LIKE pmdo_t.pmdo038, #初始项序
          pmdo039 LIKE pmdo_t.pmdo039, #初始分批序
          pmdo040 LIKE pmdo_t.pmdo040, #仓退量
          pmdo200 LIKE pmdo_t.pmdo200, #分批包装单位
          pmdo201 LIKE pmdo_t.pmdo201, #分批包装数量
          pmdo900 LIKE pmdo_t.pmdo900, #保留字段str
          pmdo999 LIKE pmdo_t.pmdo999, #保留字段end
          pmdo041 LIKE pmdo_t.pmdo041, #还料数量
          pmdo042 LIKE pmdo_t.pmdo042, #还量参考数量
          pmdo043 LIKE pmdo_t.pmdo043, #还价数量
          pmdo044 LIKE pmdo_t.pmdo044  #还价参考数量
   END RECORD
   DEFINE l_pmdt RECORD  #收貨/入庫單身明細檔
          pmdtent LIKE pmdt_t.pmdtent, #企业编号
          pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
          pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
          pmdtseq LIKE pmdt_t.pmdtseq, #项次
          pmdt001 LIKE pmdt_t.pmdt001, #采购单号
          pmdt002 LIKE pmdt_t.pmdt002, #采购项次
          pmdt003 LIKE pmdt_t.pmdt003, #采购项序
          pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
          pmdt005 LIKE pmdt_t.pmdt005, #子件特性
          pmdt006 LIKE pmdt_t.pmdt006, #料件编号
          pmdt007 LIKE pmdt_t.pmdt007, #产品特征
          pmdt008 LIKE pmdt_t.pmdt008, #包装容器
          pmdt009 LIKE pmdt_t.pmdt009, #作业编号
          pmdt010 LIKE pmdt_t.pmdt010, #作业序
          pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
          pmdt016 LIKE pmdt_t.pmdt016, #库位
          pmdt017 LIKE pmdt_t.pmdt017, #储位
          pmdt018 LIKE pmdt_t.pmdt018, #批号
          pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
          pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
          pmdt021 LIKE pmdt_t.pmdt021, #参考单位
          pmdt022 LIKE pmdt_t.pmdt022, #参考数量
          pmdt023 LIKE pmdt_t.pmdt023, #计价单位
          pmdt024 LIKE pmdt_t.pmdt024, #计价数量
          pmdt025 LIKE pmdt_t.pmdt025, #紧急度
          pmdt026 LIKE pmdt_t.pmdt026, #检验否
          pmdt027 LIKE pmdt_t.pmdt027, #收货单号
          pmdt028 LIKE pmdt_t.pmdt028, #收货项次
          pmdt036 LIKE pmdt_t.pmdt036, #单价
          pmdt037 LIKE pmdt_t.pmdt037, #税率
          pmdt038 LIKE pmdt_t.pmdt038, #税前金额
          pmdt039 LIKE pmdt_t.pmdt039, #含税金额
          pmdt040 LIKE pmdt_t.pmdt040, #价格核决
          pmdt041 LIKE pmdt_t.pmdt041, #保税否
          pmdt042 LIKE pmdt_t.pmdt042, #取价来源
          pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
          pmdt044 LIKE pmdt_t.pmdt044, #取出单价
          pmdt045 LIKE pmdt_t.pmdt045, #价差比
          pmdt046 LIKE pmdt_t.pmdt046, #税种
          pmdt047 LIKE pmdt_t.pmdt047, #税额
          pmdt051 LIKE pmdt_t.pmdt051, #理由码
          pmdt052 LIKE pmdt_t.pmdt052, #状态码
          pmdt053 LIKE pmdt_t.pmdt053, #允收数量
          pmdt054 LIKE pmdt_t.pmdt054, #已入库量
          pmdt055 LIKE pmdt_t.pmdt055, #验退量
          pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
          pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
          pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
          pmdt059 LIKE pmdt_t.pmdt059, #备注
          pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
          pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
          pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
          pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
          pmdt064 LIKE pmdt_t.pmdt064, #出货单号
          pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
          pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
          pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
          pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
          pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
          pmdt081 LIKE pmdt_t.pmdt081, #QC单号
          pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
          pmdt083 LIKE pmdt_t.pmdt083, #判定结果
          pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
          pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
          pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
          pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
          pmdt088 LIKE pmdt_t.pmdt088, #存货备注
          pmdt089 LIKE pmdt_t.pmdt089, #有效日期
          pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
          pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
          pmdt200 LIKE pmdt_t.pmdt200, #商品条码
          pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
          pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
          pmdt203 LIKE pmdt_t.pmdt203, #采购组织
          pmdt204 LIKE pmdt_t.pmdt204, #采购中心
          pmdt205 LIKE pmdt_t.pmdt205, #要货组织
          pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
          pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
          pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
          pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
          pmdt210 LIKE pmdt_t.pmdt210, #经营方式
          pmdt211 LIKE pmdt_t.pmdt211, #结算方式
          pmdt212 LIKE pmdt_t.pmdt212, #合同编号
          pmdt213 LIKE pmdt_t.pmdt213, #协议编号
          pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
          pmdt070 LIKE pmdt_t.pmdt070, #参考单号
          pmdt071 LIKE pmdt_t.pmdt071, #参考项次
          pmdt214 LIKE pmdt_t.pmdt214, #采购方式
          pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
          pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
          pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
          pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
          pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
          pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
          pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
          pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
          pmdt218 LIKE pmdt_t.pmdt218, #采购价
          pmdt219 LIKE pmdt_t.pmdt219, #制造日期
          pmdt072 LIKE pmdt_t.pmdt072, #项目编号
          pmdt073 LIKE pmdt_t.pmdt073, #WBS
          pmdt074 LIKE pmdt_t.pmdt074, #活动编号
          pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
          pmdt049 LIKE pmdt_t.pmdt049, #发票编号
          pmdt050 LIKE pmdt_t.pmdt050, #发票号码
          pmdt075 LIKE pmdt_t.pmdt075, #预算细项
          pmdt220 LIKE pmdt_t.pmdt220, #商品品类
          pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
   END RECORD
   DEFINE l_pmdn RECORD  #採購單身明細檔
          pmdnent LIKE pmdn_t.pmdnent, #企业编号
          pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
          pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
          pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
          pmdnseq LIKE pmdn_t.pmdnseq, #项次
          pmdn001 LIKE pmdn_t.pmdn001, #料件编号
          pmdn002 LIKE pmdn_t.pmdn002, #产品特征
          pmdn003 LIKE pmdn_t.pmdn003, #包装容器
          pmdn004 LIKE pmdn_t.pmdn004, #作业编号
          pmdn005 LIKE pmdn_t.pmdn005, #作业序
          pmdn006 LIKE pmdn_t.pmdn006, #采购单位
          pmdn007 LIKE pmdn_t.pmdn007, #采购数量
          pmdn008 LIKE pmdn_t.pmdn008, #参考单位
          pmdn009 LIKE pmdn_t.pmdn009, #参考数量
          pmdn010 LIKE pmdn_t.pmdn010, #计价单位
          pmdn011 LIKE pmdn_t.pmdn011, #计价数量
          pmdn012 LIKE pmdn_t.pmdn012, #出货日期
          pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
          pmdn014 LIKE pmdn_t.pmdn014, #到库日期
          pmdn015 LIKE pmdn_t.pmdn015, #单价
          pmdn016 LIKE pmdn_t.pmdn016, #税种
          pmdn017 LIKE pmdn_t.pmdn017, #税率
          pmdn019 LIKE pmdn_t.pmdn019, #子件特性
          pmdn020 LIKE pmdn_t.pmdn020, #紧急度
          pmdn021 LIKE pmdn_t.pmdn021, #保税
          pmdn022 LIKE pmdn_t.pmdn022, #部分交货
          pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
          pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
          pmdn024 LIKE pmdn_t.pmdn024, #多交期
          pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
          pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
          pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
          pmdn028 LIKE pmdn_t.pmdn028, #收货库位
          pmdn029 LIKE pmdn_t.pmdn029, #收货储位
          pmdn030 LIKE pmdn_t.pmdn030, #收货批号
          pmdn031 LIKE pmdn_t.pmdn031, #运输方式
          pmdn032 LIKE pmdn_t.pmdn032, #取货模式
          pmdn033 LIKE pmdn_t.pmdn033, #备品率
          pmdn034 LIKE pmdn_t.pmdn034, #no use
          pmdn035 LIKE pmdn_t.pmdn035, #价格核决
          pmdn036 LIKE pmdn_t.pmdn036, #项目编号
          pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
          pmdn038 LIKE pmdn_t.pmdn038, #活动编号
          pmdn039 LIKE pmdn_t.pmdn039, #费用原因
          pmdn040 LIKE pmdn_t.pmdn040, #取价来源
          pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
          pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
          pmdn043 LIKE pmdn_t.pmdn043, #取出价格
          pmdn044 LIKE pmdn_t.pmdn044, #价差比
          pmdn045 LIKE pmdn_t.pmdn045, #行状态
          pmdn046 LIKE pmdn_t.pmdn046, #税前金额
          pmdn047 LIKE pmdn_t.pmdn047, #含税金额
          pmdn048 LIKE pmdn_t.pmdn048, #税额
          pmdn049 LIKE pmdn_t.pmdn049, #理由码
          pmdn050 LIKE pmdn_t.pmdn050, #备注
          pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
          pmdn052 LIKE pmdn_t.pmdn052, #检验否
          pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
          pmdn200 LIKE pmdn_t.pmdn200, #商品条码
          pmdn201 LIKE pmdn_t.pmdn201, #包装单位
          pmdn202 LIKE pmdn_t.pmdn202, #包装数量
          pmdn203 LIKE pmdn_t.pmdn203, #收货部门
          pmdn204 LIKE pmdn_t.pmdn204, #No Use
          pmdn205 LIKE pmdn_t.pmdn205, #要货组织
          pmdn206 LIKE pmdn_t.pmdn206, #库存量
          pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
          pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
          pmdn209 LIKE pmdn_t.pmdn209, #上月销量
          pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
          pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
          pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
          pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
          pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
          pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
          pmdn216 LIKE pmdn_t.pmdn216, #经营方式
          pmdn217 LIKE pmdn_t.pmdn217, #结算方式
          pmdn218 LIKE pmdn_t.pmdn218, #合同编号
          pmdn219 LIKE pmdn_t.pmdn219, #协议编号
          pmdn220 LIKE pmdn_t.pmdn220, #采购人员
          pmdn221 LIKE pmdn_t.pmdn221, #采购部门
          pmdn222 LIKE pmdn_t.pmdn222, #采购中心
          pmdn223 LIKE pmdn_t.pmdn223, #配送中心
          pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
          pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
          pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
          pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
          pmdn054 LIKE pmdn_t.pmdn054, #还料数量
          pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
          pmdn056 LIKE pmdn_t.pmdn056, #还价数量
          pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
          pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
          pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
          pmdn058 LIKE pmdn_t.pmdn058, #预算科目
          pmdn228 LIKE pmdn_t.pmdn228  #商品品类
   END RECORD
   #161124-00048#11 mod-E
   DEFINE l_pmdt020        LIKE pmdt_t.pmdt020
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_rate           LIKE inaj_t.inaj014
   DEFINE l_flag           LIKE type_t.num5
   DEFINE l_xrcd104        LIKE xrcd_t.xrcd104
   DEFINE l_xrcd113        LIKE xrcd_t.xrcd113
   DEFINE l_xrcd114        LIKE xrcd_t.xrcd114
   DEFINE l_xrcd115        LIKE xrcd_t.xrcd115
   DEFINE l_sql            STRING
   DEFINE l_quantity       LIKE pmdt_t.pmdt020
   DEFINE l_pmdv019        LIKE pmdv_t.pmdv019
   DEFINE l_pmdp003        LIKE pmdp_t.pmdp003
   DEFINE l_pmdp004        LIKE pmdp_t.pmdp004
   DEFINE l_pmdp009        LIKE pmdp_t.pmdp009
   DEFINE l_pmdp010        LIKE pmdp_t.pmdp010
   DEFINE l_sets           LIKE type_t.num26_10
   DEFINE l_ooba002        LIKE ooba_t.ooba002
 
#150917-00001#3  2016/03/08  By earl add s
   DEFINE l_chk            LIKE type_t.num5        #TRUE 需要校驗檢查  FALSE  不需校驗檢查
   DEFINE l_qty            LIKE xmdl_t.xmdl205     #未續拋數量
   DEFINE l_qty_batch      LIKE xmdl_t.xmdl205     #未續拋數量(考慮批號)
#150917-00001#3  2016/03/08  By earl add e
   #160617-00005#2---s--
   DEFINE l_imaf061      LIKE imaf_t.imaf061
   DEFINE l_imaf062      LIKE imaf_t.imaf062
   DEFINE l_imaf063      LIKE imaf_t.imaf063
   DEFINE l_oofg_return DYNAMIC ARRAY OF RECORD    
             oofg019     LIKE oofg_t.oofg019,   #field
             oofg020     LIKE oofg_t.oofg020    #value
                     END RECORD
   #160617-00005#2---e--
   DEFINE l_pmdt024      LIKE pmdt_t.pmdt024   #remark by lixiang 20161208
   
   #161205-00025#3---s
   DEFINE l_ooba_pmdt016 LIKE pmdt_t.pmdt016
   DEFINE l_mfg_0076     LIKE pmdt_t.pmdt016
   DEFINE l_pmdt016      LIKE pmdt_t.pmdt016
   DEFINE l_pmdt017      LIKE pmdt_t.pmdt017
   DEFINE l_pmdt018      LIKE pmdt_t.pmdt018
   DEFINE l_bas_0090     LIKE type_t.chr80
   #161205-00025#3---e

   CALL s_transaction_begin()
   #161124-00048#11 mod-S
#   LET l_sql = " SELECT pmdo_t.*,pmdn_t.* FROM pmdo_t,pmdn_t,pmdl_t ",
   LET l_sql = " SELECT pmdo_t.pmdoent,pmdo_t.pmdosite,pmdo_t.pmdodocno,pmdo_t.pmdoseq,pmdo_t.pmdoseq1,",
               "        pmdo_t.pmdoseq2,pmdo_t.pmdo001,pmdo_t.pmdo002,pmdo_t.pmdo003,pmdo_t.pmdo004,",
               "        pmdo_t.pmdo005,pmdo_t.pmdo006,pmdo_t.pmdo007,pmdo_t.pmdo008,pmdo_t.pmdo009,",
               "        pmdo_t.pmdo010,pmdo_t.pmdo011,pmdo_t.pmdo012,pmdo_t.pmdo013,pmdo_t.pmdo014,",
               "        pmdo_t.pmdo015,pmdo_t.pmdo016,pmdo_t.pmdo017,pmdo_t.pmdo019,pmdo_t.pmdo020,",
               "        pmdo_t.pmdo021,pmdo_t.pmdo022,pmdo_t.pmdo023,pmdo_t.pmdo024,pmdo_t.pmdo025,",
               "        pmdo_t.pmdo026,pmdo_t.pmdo027,pmdo_t.pmdo028,pmdo_t.pmdo029,pmdo_t.pmdo030,",
               "        pmdo_t.pmdo031,pmdo_t.pmdo032,pmdo_t.pmdo033,pmdo_t.pmdo034,pmdo_t.pmdo035,",
               "        pmdo_t.pmdo036,pmdo_t.pmdo037,pmdo_t.pmdo038,pmdo_t.pmdo039,pmdo_t.pmdo040,",
               "        pmdo_t.pmdo200,pmdo_t.pmdo201,pmdo_t.pmdo900,pmdo_t.pmdo999,pmdo_t.pmdo041,",
               "        pmdo_t.pmdo042,pmdo_t.pmdo043,pmdo_t.pmdo044, ",
               "        pmdn_t.pmdnent,pmdn_t.pmdnsite,pmdn_t.pmdnunit,pmdn_t.pmdndocno,pmdn_t.pmdnseq,",
               "        pmdn_t.pmdn001,pmdn_t.pmdn002,pmdn_t.pmdn003,pmdn_t.pmdn004,pmdn_t.pmdn005,",
               "        pmdn_t.pmdn006,pmdn_t.pmdn007,pmdn_t.pmdn008,pmdn_t.pmdn009,pmdn_t.pmdn010,",
               "        pmdn_t.pmdn011,pmdn_t.pmdn012,pmdn_t.pmdn013,pmdn_t.pmdn014,pmdn_t.pmdn015,",
               "        pmdn_t.pmdn016,pmdn_t.pmdn017,pmdn_t.pmdn019,pmdn_t.pmdn020,pmdn_t.pmdn021,",
               "        pmdn_t.pmdn022,pmdn_t.pmdnorga,pmdn_t.pmdn023,pmdn_t.pmdn024,pmdn_t.pmdn025,",
               "        pmdn_t.pmdn026,pmdn_t.pmdn027,pmdn_t.pmdn028,pmdn_t.pmdn029,pmdn_t.pmdn030,",
               "        pmdn_t.pmdn031,pmdn_t.pmdn032,pmdn_t.pmdn033,pmdn_t.pmdn034,pmdn_t.pmdn035,",
               "        pmdn_t.pmdn036,pmdn_t.pmdn037,pmdn_t.pmdn038,pmdn_t.pmdn039,pmdn_t.pmdn040,",
               "        pmdn_t.pmdn041,pmdn_t.pmdn042,pmdn_t.pmdn043,pmdn_t.pmdn044,pmdn_t.pmdn045,",
               "        pmdn_t.pmdn046,pmdn_t.pmdn047,pmdn_t.pmdn048,pmdn_t.pmdn049,pmdn_t.pmdn050,",
               "        pmdn_t.pmdn051,pmdn_t.pmdn052,pmdn_t.pmdn053,pmdn_t.pmdn200,pmdn_t.pmdn201,",
               "        pmdn_t.pmdn202,pmdn_t.pmdn203,pmdn_t.pmdn204,pmdn_t.pmdn205,pmdn_t.pmdn206,",
               "        pmdn_t.pmdn207,pmdn_t.pmdn208,pmdn_t.pmdn209,pmdn_t.pmdn210,pmdn_t.pmdn211,",
               "        pmdn_t.pmdn212,pmdn_t.pmdn213,pmdn_t.pmdn214,pmdn_t.pmdn215,pmdn_t.pmdn216,",
               "        pmdn_t.pmdn217,pmdn_t.pmdn218,pmdn_t.pmdn219,pmdn_t.pmdn220,pmdn_t.pmdn221,",
               "        pmdn_t.pmdn222,pmdn_t.pmdn223,pmdn_t.pmdn224,pmdn_t.pmdn900,pmdn_t.pmdn999,",
               "        pmdn_t.pmdn225,pmdn_t.pmdn054,pmdn_t.pmdn055,pmdn_t.pmdn056,pmdn_t.pmdn057,",
               "        pmdn_t.pmdn226,pmdn_t.pmdn227,pmdn_t.pmdn058,pmdn_t.pmdn228",
               " FROM pmdo_t,pmdn_t,pmdl_t ",
   #161124-00048#11 mod-E
               "  WHERE pmdnent = pmdlent AND pmdndocno = pmdldocno AND pmdoent = pmdnent AND pmdodocno = pmdndocno AND pmdoseq = pmdnseq ",
               "    AND pmdoent = '",g_enterprise,"' AND pmdodocno = '",g_pmds_m.pmds006,"' ",
               "    AND pmdn045 = '1' ",             #未結案
               "    AND pmdnunit = '",g_site,"' "   #收貨據點為當前營運據點
   IF g_argv[1] MATCHES '[13]' THEN
      LET l_sql = l_sql , " AND pmdl005 NOT IN ('2','5','6') "
   END IF
   IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' THEN
      LET l_sql = l_sql , " AND pmdl005 = '2' "
   END IF
   
   IF g_argv[1] MATCHES '[9]' THEN
      LET l_sql = l_sql , " AND pmdl005 = '5' "
   END IF
       
   IF g_argv[1] = '23' OR g_argv[1] = '24' THEN
      LET l_sql = l_sql , " AND pmdl005 = '6' "
   END IF
     
   IF NOT cl_null(g_pmds_m.pmds053) THEN
      LET l_sql = l_sql , " AND pmdl051 = '",g_pmds_m.pmds053,"' "
   END IF
   IF NOT cl_null(g_pmds_m.pmds033) THEN
      LET l_sql = l_sql , " AND pmdl011 = '",g_pmds_m.pmds033,"' "
   END IF
   IF NOT cl_null(g_pmds_m.pmds037) THEN
      LET l_sql = l_sql , " AND pmdl015 = '",g_pmds_m.pmds037,"' "
   END IF
   
   #ming 20151013 add ----------(S) 
   IF NOT cl_null(g_pmds_m.pmds031) THEN 
      LET l_sql = l_sql , " AND pmdl009 = '",g_pmds_m.pmds031,"' " 
   END IF 
   #ming 20151013 add ----------(E) 
       
   PREPARE pmdo_pre1 FROM l_sql
   DECLARE pmdo_cur CURSOR FOR pmdo_pre1
   
     #SELECT pmdo_t.*,pmdn_t.* FROM pmdo_t,pmdn_t
     #  WHERE pmdoent = pmdnent AND pmdodocno = pmdndocno AND pmdoseq = pmdnseq
     #    AND pmdoent = g_enterprise AND pmdodocno = g_pmds_m.pmds006
     #    AND pmdn045 = '1'       #未結案
     #    AND pmdnunit = g_site   #收貨據點為當前營運據點
   
   #161205-00025#3---s
   CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
   IF l_success THEN
      LET l_ooba_pmdt016 = s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016','')
      
      LET l_mfg_0076 =  cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') 
   END IF 
   
	LET l_sql = " SELECT MAX(pmdt011)+1 FROM apmt520_01_tmp2 ",
               " WHERE pmdt006 = ? AND (CASE WHEN pmdt007 IS NULL THEN ' ' ELSE pmdt007 END) = ? ",
               "   AND pmdt019 = ? ",
               "   AND (CASE WHEN pmdt016 IS NULL THEN ' ' ELSE pmdt016 END) = ? ",
               "   AND (CASE WHEN pmdt017 IS NULL THEN ' ' ELSE pmdt017 END) = ? ",
               "   AND (CASE WHEN pmdt018 IS NULL THEN ' ' ELSE pmdt018 END) = ? "
   PREPARE pmdt011_pre6 FROM l_sql
   
   LET l_bas_0090 = cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0090')
   #161205-00025#3---e
       
   INITIALIZE l_pmdo.* TO NULL
   INITIALIZE l_pmdt.* TO NULL
   INITIALIZE l_pmdn.* TO NULL
   
   LET l_success = TRUE
       
   FOREACH pmdo_cur INTO l_pmdo.*,l_pmdn.*
       
         
      IF cl_null(l_pmdo.pmdo006) THEN
         LET l_pmdo.pmdo006 = 0
      END IF
      IF cl_null(l_pmdo.pmdo015) THEN
         LET l_pmdo.pmdo015 = 0
      END IF
      IF cl_null(l_pmdo.pmdo016) THEN
         LET l_pmdo.pmdo016 = 0
      END IF
      IF cl_null(l_pmdo.pmdo017) THEN
         LET l_pmdo.pmdo017 = 0
      END IF
          
      LET l_pmdt020 = 0
      SELECT SUM(pmdt020),SUM(pmdt024) INTO l_pmdt020,l_pmdt024 FROM pmdt_t,pmds_t  #remark by lixiang 20161208 add pmdt024
       WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
         AND pmdtent = g_enterprise AND pmdt001 = l_pmdo.pmdodocno
         AND pmdt002 = l_pmdo.pmdoseq AND pmdt003 = l_pmdo.pmdoseq1
         AND pmdt004 = l_pmdo.pmdoseq2
         AND pmdsstus = 'N'   
         AND pmds100 <> '4'   #151020-00006 by whitney modify
         AND pmds000 = g_pmds_m.pmds000
              
      IF cl_null(l_pmdt020) THEN
         LET l_pmdt020 = 0
      END IF
          
      #委外時，數量不可大於發料套數
      IF g_argv[1]='8' OR g_argv[1] = '20' THEN 
         SELECT pmdp003,pmdp009,pmdp010 INTO l_pmdp003,l_pmdp009,l_pmdp010 FROM pmdp_t 
          WHERE pmdpent = g_enterprise AND pmdpdocno = l_pmdo.pmdodocno AND pmdpseq = l_pmdo.pmdoseq AND ROWNUM = 1
                  
         CALL s_asft340_full_sets(l_pmdp003,l_pmdp009,l_pmdp010,g_pmds_m.pmdsdocdt) RETURNING l_success,l_sets
           
         IF l_pmdo.pmdo006 - l_pmdo.pmdo015 + l_pmdo.pmdo016 + l_pmdo.pmdo017 < l_sets THEN
            LET l_sets = l_pmdo.pmdo006 - l_pmdo.pmdo015 + l_pmdo.pmdo016 + l_pmdo.pmdo017
         END IF
         
         #161019-00046#1--s
         #委外代买料不考虑发料套数
         IF l_pmdo.pmdo003 = '8' OR l_pmdo.pmdo003 = '11' THEN   #170208-00055#1 add ‘11’ 拆件元件也不考虑发料套数
            LET l_sets = l_pmdo.pmdo006 - l_pmdo.pmdo015 + l_pmdo.pmdo016 + l_pmdo.pmdo017
         END IF
         #161019-00046#1--e
         LET l_pmdt.pmdt020 = l_sets - l_pmdt020
             
         ##其他單據上的維護的已發料數量
         #SELECT SUM(pmdv019) INTO l_pmdv019 FROM pmdv_t,pmds_t 
         #   WHERE pmdvent = pmdsent AND pmdvdocno = pmdsdocno AND pmds000 = '8' AND pmdsstus <> 'X'
         #     AND pmdvent = g_enterprise AND pmdv014 = l_pmdp003 AND pmdv015 = l_pmdp004 
         #IF cl_null(l_pmdv019) THEN
         #   LET l_pmdv019 = 0
         #END IF
         #
         #LET l_quantity = l_sets - l_pmdv019
         #
         #IF l_quantity < l_pmdt.pmdt020 THEN
         #   LET l_pmdt.pmdt020 = l_quantity
         #END IF
      ELSE
         #輸入的收貨數量不可以大於對應採購的pmdo006(需求量)-pmdo015(已收貨量)+pmdo016(驗退量)-已登打收貨單未確認量
         LET l_pmdt.pmdt020 = l_pmdo.pmdo006 - l_pmdo.pmdo015 + l_pmdo.pmdo016 + l_pmdo.pmdo017 - l_pmdt020  #收貨數量          
      END IF

      #150917-00001#3  2016/03/08  By earl add s
      #多角可續拋數量
      IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' OR
         g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
         
         CALL s_aic_carry_continue_qty(g_site,g_pmds_m.pmds053,'2',l_pmdo.pmdodocno,l_pmdo.pmdoseq,l_pmdo.pmdoseq1,l_pmdo.pmdoseq2,'','','')
         RETURNING l_chk,l_qty,l_qty_batch
         
         IF l_chk THEN
            IF l_qty < l_pmdt.pmdt020 THEN
               LET l_pmdt.pmdt020 = l_qty
            END IF
         END IF
      END IF
      #150917-00001#3  2016/03/08  By earl add e
      
      #161116-00009#1 --begin--
      #考虑到有超交率的情况，收货>采购时，可收货不可小于0,若还需超收，手动维护
      IF l_pmdt.pmdt020 < 0 THEN
         LET l_pmdt.pmdt020 = 0 
      END IF
      #161116-00009#1 --end--
      
      IF cl_null(l_pmdt.pmdt020) OR l_pmdt.pmdt020 = 0 THEN
         CONTINUE FOREACH
      END IF
          
      LET l_pmdt.pmdtent = g_enterprise
      LET l_pmdt.pmdtsite = g_site
      LET l_pmdt.pmdtdocno = g_pmds_m.pmdsdocno
      SELECT MAX(pmdtseq)+1 INTO l_pmdt.pmdtseq FROM pmdt_t
       WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
      IF cl_null(l_pmdt.pmdtseq) OR l_pmdt.pmdtseq = 0 THEN
         LET l_pmdt.pmdtseq = 1
      END IF          
          
      LET l_pmdt.pmdt001 = l_pmdo.pmdodocno    #來源單號
      LET l_pmdt.pmdt002 = l_pmdo.pmdoseq      #來源項次
      LET l_pmdt.pmdt003 = l_pmdo.pmdoseq1     #來源項序
      LET l_pmdt.pmdt004 = l_pmdo.pmdoseq2     #來源分批序
      LET l_pmdt.pmdt005 = l_pmdo.pmdo003      #子特性
      LET l_pmdt.pmdt006 = l_pmdo.pmdo001      #料件編號
      LET l_pmdt.pmdt007 = l_pmdo.pmdo002      #產品特徵
      LET l_pmdt.pmdt008 = l_pmdn.pmdn003      #包裝容器
      LET l_pmdt.pmdt009 = l_pmdn.pmdn004      #作業編號
      LET l_pmdt.pmdt010 = l_pmdn.pmdn005      #製程序
      LET l_pmdt.pmdt059 = l_pmdn.pmdn050      #備註
          
      LET l_pmdt.pmdt016 = l_pmdn.pmdn028   #庫位
      LET l_pmdt.pmdt017 = l_pmdn.pmdn029   #儲位
      IF cl_null(l_pmdt.pmdt017) THEN
         LET l_pmdt.pmdt017 = ' '
      END IF
      LET l_pmdt.pmdt018 = l_pmdn.pmdn030   #批號
      IF cl_null(l_pmdt.pmdt018) THEN
         LET l_pmdt.pmdt018 = ' '
      END IF
          
      #dorislai-20150824-add----(S)
      #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
      IF cl_null(l_pmdt.pmdt016) THEN
         #預設欄位
         #161205-00025#3---s
         #CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
         #IF l_success THEN
         IF NOT cl_null(l_ooba002) THEN
         #161205-00025#3---e
            #CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016',l_pmdt.pmdt016) RETURNING l_pmdt.pmdt016  #161205-00025#3
            LET l_pmdt.pmdt016 = l_ooba_pmdt016   #161205-00025#3
            #應用參數
            IF cl_null(l_pmdt.pmdt016) THEN
               #CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING l_pmdt.pmdt016  #161205-00025#3
               LET l_pmdt.pmdt016 = l_mfg_0076   #161205-00025#3
            END IF
         END IF          
      END IF
      #dorislai-20150824-add----(E)
      #預設料件的庫儲
      IF cl_null(l_pmdt.pmdt016) THEN
         SELECT imaf091,imaf092 INTO l_pmdt.pmdt016,l_pmdt.pmdt017
           FROM imaf_t
          WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdt.pmdt006
      END IF
      IF l_pmdt.pmdt017 IS NULL THEN
         SELECT imaf092 INTO l_pmdt.pmdt017
           FROM imaf_t
          WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdt.pmdt006
      END IF
          
      LET l_pmdt.pmdt019 = l_pmdo.pmdo004   #收貨單位
      
      #161205-00025#3---s
      #預設沖銷順序
      #LET l_sql = " SELECT MAX(pmdt011)+1 FROM pmdt_t ",
      #            " WHERE pmdtent = '",g_enterprise,"' ",
      #            "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"' ",
      #            "   AND pmdt006 = '",l_pmdt.pmdt006,"' AND pmdt007 = '",l_pmdt.pmdt007,"' ",
      #            "   AND pmdt019 = '",l_pmdt.pmdt019,"' "
      #IF NOT cl_null(l_pmdt.pmdt016) THEN
      #   LET l_sql =  l_sql , " AND pmdt016 = '",l_pmdt.pmdt016,"' "
      #END IF
      #IF NOT cl_null(l_pmdt.pmdt017) OR l_pmdt.pmdt017 = ' ' THEN
      #   LET l_sql =  l_sql , " AND pmdt017 = '",l_pmdt.pmdt017,"' "
      #END IF
      #IF NOT cl_null(l_pmdt.pmdt018) THEN
      #   LET l_sql =  l_sql , " AND pmdt018 = '",l_pmdt.pmdt018,"' "
      #END IF
      #PREPARE pmdt011_pre6 FROM l_sql
      #EXECUTE pmdt011_pre6 INTO l_pmdt.pmdt011
      IF cl_null(l_pmdt.pmdt007) THEN
        LET l_pmdt.pmdt007 = ' '
      END IF
      LET l_pmdt016 = l_pmdt.pmdt016
      LET l_pmdt017 = l_pmdt.pmdt017
      LET l_pmdt018 = l_pmdt.pmdt018
      IF cl_null(l_pmdt016) THEN
         LET l_pmdt016 = ' '
      END IF
      IF cl_null(l_pmdt017) THEN
         LET l_pmdt017 = ' '
      END IF
      IF cl_null(l_pmdt018) THEN
         LET l_pmdt018 = ' '
      END IF
      EXECUTE pmdt011_pre6 USING l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt019,l_pmdt016,l_pmdt017,l_pmdt018 INTO l_pmdt.pmdt011
      #161205-00025#3---e
          
      IF cl_null(l_pmdt.pmdt011) OR l_pmdt.pmdt011 = 0 THEN
         LET l_pmdt.pmdt011 = 1
      END IF
          
      LET l_pmdt.pmdt021 = l_pmdn.pmdn008   #參考單位
      LET l_rate = 1
      IF NOT cl_null(l_pmdt.pmdt021) THEN
         #CALL s_aimi190_get_convert(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt021) RETURNING l_flag,l_rate
         #LET l_pmdt.pmdt022 = l_pmdt.pmdt020 * l_rate   #參考數量
         CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt021,l_pmdt.pmdt020)
              RETURNING l_success,l_pmdt.pmdt022
      ELSE
         LET l_pmdt.pmdt022 = ''
      END IF
          
      #IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND apmt520_get_imaf144(l_pmdt.pmdt006) THEN   #161205-00025#3
      IF g_bas_0019 = "Y" AND apmt520_get_imaf144(l_pmdt.pmdt006) THEN  #161205-00025#3
         LET l_pmdt.pmdt023 = l_pmdn.pmdn010   #計價單位
         #160929-00038#1---s
         CALL s_apmt520_get_pmdt024(g_pmds_m.pmds000,g_pmds_m.pmdsdocno,'','',l_pmdt.pmdt001,l_pmdt.pmdt002,l_pmdt.pmdt003,l_pmdt.pmdt004,l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt023)
             RETURNING l_pmdt.pmdt024
         IF cl_null(l_pmdt.pmdt024) OR l_pmdt.pmdt024 = 0 THEN
         #160929-00038#1---e
            LET l_rate = 1
            IF NOT cl_null(l_pmdt.pmdt023) THEN
               #CALL s_aimi190_get_convert(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023) RETURNING l_flag,l_rate
               #LET l_pmdt.pmdt024 = l_pmdt.pmdt020 * l_rate   #計價數量
               CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
                   RETURNING l_success,l_pmdt.pmdt024
            ELSE
               LET l_pmdt.pmdt023 = l_pmdt.pmdt019
               LET l_pmdt.pmdt024 = l_pmdt.pmdt020
            END IF
         END IF #160929-00038#1
      END IF
          
      #整體參數未使用採購計價單位,則賦值當前的採購單位和數量
      #IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" OR (NOT apmt520_get_imaf144(l_pmdt.pmdt006)) THEN  #161205-00025#3
      IF g_bas_0019 = "N" OR (NOT apmt520_get_imaf144(l_pmdt.pmdt006)) THEN   #161205-00025#3
         LET l_pmdt.pmdt023 = l_pmdt.pmdt019
         LET l_pmdt.pmdt024 = l_pmdt.pmdt020
      END IF
          
      LET l_pmdt.pmdt025 = l_pmdn.pmdn020   #緊急度
          
      ##檢驗否
      #IF (NOT cl_null(l_pmdt.pmdt009)) AND (NOT cl_null(l_pmdt.pmdt010)) THEN
      #   SELECT qcap006 INTO l_pmdt.pmdt026 FROM qcap_t
      #     WHERE qcapent = g_enterprise AND qcapsite = g_site
      #       AND qcap001 = l_pmdt.pmdt006 AND qcap002 = g_pmds_m.pmds007
      #       AND qcap003 = l_pmdt.pmdt009 AND qcap004 = l_pmdt.pmdt010
      #       AND qcap005 = l_pmdt.pmdt007
      #ELSE
      #   SELECT qcap006 INTO l_pmdt.pmdt026 FROM qcap_t
      #     WHERE qcapent = g_enterprise AND qcapsite = g_site
      #       AND qcap001 = l_pmdt.pmdt006 AND qcap002 = g_pmds_m.pmds007
      #       AND qcap005 = l_pmdt.pmdt007
      #END IF
      #IF cl_null(l_pmdt.pmdt026) THEN
      #   LET l_pmdt.pmdt026 = 'N'
      #END IF
      #
      ##直接收貨入庫時，無需檢驗
      #IF g_argv[1] MATCHES '[34]' THEN
      #   LET l_pmdt.pmdt026 = 'N'
      #END IF
      
      LET l_pmdt.pmdt036 = l_pmdo.pmdo022   #單價
      LET l_pmdt.pmdt046 = l_pmdo.pmdo023   #稅別
      LET l_pmdt.pmdt037 = l_pmdo.pmdo024   #稅率
          
      #未稅金額、含稅金額
      IF (NOT cl_null(l_pmdt.pmdt020)) AND (NOT cl_null(l_pmdt.pmdt036)) AND (NOT cl_null(l_pmdt.pmdt046)) THEN
         CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq,l_pmdt.pmdt001,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046)
           RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039   
      END IF
      
      LET l_pmdt.pmdt040 = l_pmdn.pmdn035   #價格核決
      LET l_pmdt.pmdt041 = l_pmdn.pmdn021   #保稅否
      LET l_pmdt.pmdt042 = l_pmdn.pmdn040
      LET l_pmdt.pmdt043 = l_pmdn.pmdn041
      LET l_pmdt.pmdt044 = l_pmdn.pmdn043
      LET l_pmdt.pmdt048 = l_pmdn.pmdn042
      LET l_pmdt.pmdt045 = l_pmdn.pmdn044
      LET l_pmdt.pmdt052 = '1'              #狀態碼 '1:一般'
      LET l_pmdt.pmdt053 = 0
      LET l_pmdt.pmdt054 = 0
      LET l_pmdt.pmdt055 = 0
      LET l_pmdt.pmdt062 = 'N'              #多庫儲批收貨入庫否
      LET l_pmdt.pmdt063 = l_pmdn.pmdn053
      
      LET l_pmdt.pmdt072 = l_pmdn.pmdn036      #專案編號
      LET l_pmdt.pmdt073 = l_pmdn.pmdn037      #WBS
      LET l_pmdt.pmdt074 = l_pmdn.pmdn038      #活動編號
      
      LET l_pmdt.pmdt026 = l_pmdn.pmdn052
          
      #直接收貨入庫時，無需檢驗
      IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
         LET l_pmdt.pmdt026 = 'N'
      END IF
      
      #產品特征為null時，給空格
      IF cl_null(l_pmdt.pmdt007) THEN
         LET l_pmdt.pmdt007 = ' '
      END IF 
      
      #數量欄位賦 0
      LET l_pmdt.pmdt056 = 0  
      LET l_pmdt.pmdt057 = 0 
      LET l_pmdt.pmdt058 = 0 
      LET l_pmdt.pmdt066 = 0 
      LET l_pmdt.pmdt067 = 0 
      LET l_pmdt.pmdt068 = 0 
      LET l_pmdt.pmdt069 = 0
      
      #150901 earl add s
      #多角性質為"2:代採購、3:代採購指定供應商、4:統購統付、6:中間交易"
      #IF g_pmds_m.pmds014 MATCHES '[2346]' THEN
      #   LET l_pmdt.pmdt084 = 'N'
      #ELSE
      #   LET l_pmdt.pmdt084 = 'Y'
      #END IF
          
#      #自立應付欄位是判斷多角時是不是要自立帳款，所以在一般的採購入庫/倉退與銷售出貨/銷退流程新增時,此欄位均預設為’Y’
#      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '20' THEN
#         LET l_pmdt.pmdt084 = 'Y'
#      ELSE
#         LET l_pmdt.pmdt084 = 'N'
#      END IF
      #150901 earl add e
      
      #pmdt084給值一律給"Y"
      LET l_pmdt.pmdt084 = 'Y'
      #採購性質是VMI時，pmdt084 給'N'
      IF g_argv[1] MATCHES '[67]' AND g_pmds_m.pmds011 = '3' THEN
         LET l_pmdt.pmdt084 = 'N'
      END IF
      
      LET l_pmdt.pmdt088 = ''
      LET l_pmdt.pmdt089 = ''
      
      #若单据别对应的参数“是否依客户/厂商做库存管理”='Y'，则将供应商编号带入到此栏位
      IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' THEN
         #161205-00025#3---s
         #CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
         #IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-BAS-0090') = 'Y' THEN
         IF l_bas_0090 = 'Y' THEN
         #161205-00025#3---e
            LET l_pmdt.pmdt063 = g_pmds_m.pmds007
         END IF
      END IF
      
      #160617-00005#2---s--
      IF g_argv[1] MATCHES '[1234689]' OR g_argv[1] = '12' OR g_argv[1] = '13'  OR g_argv[1] = '20' THEN
         LET l_imaf061 = ''
         LET l_imaf062 = ''
         LET l_imaf063 = ''
         SELECT imaf061,imaf062,imaf063 INTO l_imaf061,l_imaf062,l_imaf063  
           FROM imaf_t WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdt.pmdt006
      
         IF cl_null(l_pmdt.pmdt018) AND l_imaf061 = '1' AND l_imaf062 = 'Y' AND (NOT cl_null(l_imaf063)) THEN
            CALL s_aooi390_gen_1('6',l_imaf063) RETURNING l_success,l_pmdt.pmdt018,l_oofg_return
            IF NOT l_success THEN
               LET l_pmdt.pmdt018 = ' '
            ELSE
               CALL s_aooi390_get_auto_no('6',l_pmdt.pmdt018) RETURNING l_success,l_pmdt.pmdt018
               CALL s_aooi390_oofi_upd('6',l_pmdt.pmdt018) RETURNING l_success
            END IF
         END IF
      END IF
      #160617-00005#2---e-- 
          
      INSERT INTO pmdt_t
          (pmdtent,pmdtsite,pmdtdocno,pmdtseq,
           pmdt001,pmdt002,pmdt003,pmdt004,pmdt005,pmdt006,pmdt007,pmdt009,pmdt010,pmdt025,pmdt011,pmdt019,pmdt020,pmdt021,pmdt022,
           pmdt008,pmdt023,pmdt024,pmdt036,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt041,pmdt016,pmdt017,pmdt018,pmdt063,pmdt040,pmdt051,
           pmdt052,pmdt059,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt062,pmdt056,pmdt057,pmdt058,pmdt066,pmdt067,pmdt068,pmdt069,pmdt084,
           pmdt088,pmdt089,pmdt042,pmdt043,pmdt044,pmdt045,pmdt048,
           pmdt072,pmdt073,pmdt074) 
       VALUES(l_pmdt.pmdtent,l_pmdt.pmdtsite,
              l_pmdt.pmdtdocno,l_pmdt.pmdtseq,
              l_pmdt.pmdt001,l_pmdt.pmdt002, 
              l_pmdt.pmdt003,l_pmdt.pmdt004,l_pmdt.pmdt005, 
              l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt009, 
              l_pmdt.pmdt010,l_pmdt.pmdt025,l_pmdt.pmdt011, 
              l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021, 
              l_pmdt.pmdt022,l_pmdt.pmdt008,l_pmdt.pmdt023, 
              l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046, 
              l_pmdt.pmdt037,l_pmdt.pmdt038,l_pmdt.pmdt039,l_pmdt.pmdt047, 
              l_pmdt.pmdt026,l_pmdt.pmdt041,l_pmdt.pmdt016, 
              l_pmdt.pmdt017,l_pmdt.pmdt018,l_pmdt.pmdt063,l_pmdt.pmdt040, 
              l_pmdt.pmdt051,l_pmdt.pmdt052,l_pmdt.pmdt059,
              l_pmdt.pmdt053,l_pmdt.pmdt054,l_pmdt.pmdt055,
              l_pmdt.pmdt060,l_pmdt.pmdt061,l_pmdt.pmdt062,l_pmdt.pmdt056,l_pmdt.pmdt057,l_pmdt.pmdt058,
              l_pmdt.pmdt066,l_pmdt.pmdt067,l_pmdt.pmdt068,l_pmdt.pmdt069,l_pmdt.pmdt084,l_pmdt.pmdt088,l_pmdt.pmdt089,
              l_pmdt.pmdt042,l_pmdt.pmdt043,l_pmdt.pmdt044,l_pmdt.pmdt045,l_pmdt.pmdt048,
              l_pmdt.pmdt072,l_pmdt.pmdt073,l_pmdt.pmdt074)
          
      IF SQLCA.sqlcode THEN
         LET l_success = FALSE
         EXIT FOREACH
      END IF
          
      #若單頭交易條件、幣別等資料，根據採購單號帶出
      IF cl_null(g_pmds_m.pmds031) OR cl_null(g_pmds_m.pmds032) OR cl_null(g_pmds_m.pmds033) OR cl_null(g_pmds_m.pmds037) OR cl_null(g_pmds_m.pmds012) THEN
         SELECT pmdl009,pmdl010,pmdl011,pmdl012,pmdl013,pmdl015,pmdl016,pmdl023 
             INTO g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds012
           FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = l_pmdt.pmdt001
         UPDATE pmds_t SET pmds031 = g_pmds_m.pmds031,
                           pmds032 = g_pmds_m.pmds032,
                           pmds033 = g_pmds_m.pmds033,
                           pmds034 = g_pmds_m.pmds034,
                           pmds035 = g_pmds_m.pmds035,
                           pmds037 = g_pmds_m.pmds037,
                           pmds038 = g_pmds_m.pmds038,
                           pmds012 = g_pmds_m.pmds012
            WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
      END IF
          
      #產生收貨原始需求分配明細資料
      IF NOT s_apmt520_gen_pmdv(l_pmdt.pmdtdocno,l_pmdt.pmdtseq) THEN
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      
      INITIALIZE l_pmdo.* TO NULL
      INITIALIZE l_pmdt.* TO NULL
      INITIALIZE l_pmdn.* TO NULL
      
   END FOREACH
       
   #重新計算整單的未稅、含稅總金額
   CALL s_tax_recount(g_pmds_m.pmdsdocno)
        RETURNING g_pmds_m.pmds043,g_pmds_m.pmds046,g_pmds_m.pmds044,l_xrcd113,l_xrcd114,l_xrcd115
   UPDATE pmds_t SET pmds043 = g_pmds_m.pmds043,
                     pmds044 = g_pmds_m.pmds044,
                     pmds046 = g_pmds_m.pmds046
    WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
    
   #151124-00015#1-mod-(S)
#   CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt
   CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING l_success
   #151124-00015#1-mod-(E)

   #呼叫產生匯總與檢驗狀況的Function來更新匯總與檢驗狀況明細資料
   #IF NOT s_apmt520_gen_pmdu(g_pmds_m.pmdsdocno) THEN
   #   LET l_success = FALSE
   #END IF
        
   #IF NOT l_success THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = "pmdt_t"
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #
   #   CALL s_transaction_end('N','0')
   #ELSE
   #   CALL s_transaction_end('Y','0')
   #END IF
       
END FUNCTION
#價格資訊單身填充
PRIVATE FUNCTION apmt520_b4_fill()
DEFINE l_ac4     LIKE type_t.num5
DEFINE l_pmdt002 LIKE pmdt_t.pmdt002
DEFINE l_success LIKE type_t.num5
DEFINE l_pmdt027 LIKE pmdt_t.pmdt027
DEFINE l_pmdt028 LIKE pmdt_t.pmdt028 
   #ming 20150922 add --------------(S) 
   DEFINE l_isam011     LIKE isam_t.isam011
   DEFINE l_sql         STRING
   #ming 20150922 add --------------(E) 

    CALL g_pmdt4_d.clear()  
    
    LET g_sql = "SELECT  UNIQUE pmdtseq,pmdt001,pmdt002,pmdt003,pmdt004,pmdt049,pmdt050,pmdt027,pmdt028,pmdt005,pmdt006,",
                #" '','',",   #160720-00015#1
                #160720-00015#1---s
                " (SELECT imaal003 FROM imaal_t WHERE imaalent='",g_enterprise,"' AND imaal001=pmdt006 AND imaal002='",g_dlang,"' ) imaal003,",
                " (SELECT imaal004 FROM imaal_t WHERE imaalent='",g_enterprise,"' AND imaal001=pmdt006 AND imaal002='",g_dlang,"' ) imaal004,",
                #160720-00015#1--e
                "  pmdt007,", 
                " (SELECT inaml004 FROM inaml_t WHERE inamlent = '",g_enterprise,"' AND inaml001=pmdt006 AND inaml002=pmdt007 AND inaml003='",g_dlang,"') inaml004 ,", #160720-00015#1                
                " pmdt009,pmdt010,pmdt019,",
                #" '',",  #160720-00015#1
                " (SELECT oocal003 FROM oocal_t WHERE oocalent='",g_enterprise,"' AND oocal001=pmdt019 AND oocal002='",g_dlang,"' ) T1_oocal003, ", #160720-00015#1
                " pmdt020,",
                " pmdt023,",
                #" '',",  #160720-00015#1
                " (SELECT oocal003 FROM oocal_t WHERE oocalent='",g_enterprise,"' AND oocal001=pmdt023 AND oocal002='",g_dlang,"' ) T2_oocal003, ", #160720-00015#1
                " pmdt024,pmdt040,pmdt036,pmdt046,",
                #" '',",  #160720-00015#1
                " (SELECT oodbl004 FROM oodbl_t WHERE oodblent='",g_enterprise,"' AND oodbl001='",g_ooef019,"' AND oodbl002=pmdt046 AND oodbl003='",g_dlang,"' ) oodbl004, " , #160720-00015#1
                " pmdt037,pmdt038,pmdt039,pmdt047 FROM pmdt_t", 
                " INNER JOIN pmds_t ON pmdsent = pmdtent AND pmdsdocno = pmdtdocno ",
                " WHERE pmdtent=? AND pmdtdocno=?"

    LET g_sql = g_sql, " ORDER BY pmdtseq,pmdt001,pmdt002,pmdt003,pmdt004"

    PREPARE apmt520_pb4 FROM g_sql
    DECLARE b_fill_cs4 CURSOR FOR apmt520_pb4
    
    LET l_ac4 = 1
    
    OPEN b_fill_cs4 USING g_enterprise,g_pmds_m.pmdsdocno
                                      
    FOREACH b_fill_cs4 INTO g_pmdt4_d[l_ac4].pmdtseq,g_pmdt4_d[l_ac4].pmdt001,g_pmdt4_d[l_ac4].pmdt002,g_pmdt4_d[l_ac4].pmdt003,g_pmdt4_d[l_ac4].pmdt004,
                            g_pmdt4_d[l_ac4].pmdt049,g_pmdt4_d[l_ac4].pmdt050,l_pmdt027,l_pmdt028,
                            g_pmdt4_d[l_ac4].pmdt005,g_pmdt4_d[l_ac4].pmdt006,g_pmdt4_d[l_ac4].imaal003,g_pmdt4_d[l_ac4].imaal004,
	                         g_pmdt4_d[l_ac4].pmdt007, g_pmdt4_d[l_ac4].pmdt007_desc, #160720-00015#1
	                         g_pmdt4_d[l_ac4].pmdt009,g_pmdt4_d[l_ac4].pmdt010,g_pmdt4_d[l_ac4].pmdt019, 
                            g_pmdt4_d[l_ac4].pmdt019_desc,g_pmdt4_d[l_ac4].pmdt020,g_pmdt4_d[l_ac4].pmdt023,g_pmdt4_d[l_ac4].pmdt023_desc,
                            g_pmdt4_d[l_ac4].pmdt024,g_pmdt4_d[l_ac4].pmdt040,g_pmdt4_d[l_ac4].pmdt036,g_pmdt4_d[l_ac4].pmdt046, 
                            g_pmdt4_d[l_ac4].pmdt046_desc,g_pmdt4_d[l_ac4].pmdt037,g_pmdt4_d[l_ac4].pmdt038,g_pmdt4_d[l_ac4].pmdt039,
                            g_pmdt4_d[l_ac4].pmdt047
       
	    IF SQLCA.sqlcode THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = SQLCA.sqlcode
           LET g_errparam.extend = "FOREACH:"
           LET g_errparam.popup = TRUE
           CALL cl_err()

           EXIT FOREACH
        END IF
        
        #驗退、入庫、倉退時，價格資訊頁簽的採購單號、項次等欄位，
        #需根據驗退、入庫、倉退單上的收貨單號和項次，獲取相關的採購信息
        IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
           #LET l_pmdt002 = g_pmdt4_d[l_ac4].pmdt002
           SELECT pmdt001,pmdt002,pmdt003,pmdt004 INTO g_pmdt4_d[l_ac4].pmdt001,g_pmdt4_d[l_ac4].pmdt002,g_pmdt4_d[l_ac4].pmdt003,g_pmdt4_d[l_ac4].pmdt004
              FROM pmdt_t
            WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmds006 AND pmdtseq = l_pmdt028
        END IF
        
        #160720-00015#1--s
        #CALL s_desc_get_item_desc(g_pmdt4_d[l_ac4].pmdt006) RETURNING g_pmdt4_d[l_ac4].imaal003,g_pmdt4_d[l_ac4].imaal004
        #DISPLAY BY NAME g_pmdt4_d[l_ac4].imaal003,g_pmdt4_d[l_ac4].imaal004
        
        #CALL s_feature_description(g_pmdt4_d[l_ac4].pmdt006,g_pmdt4_d[l_ac4].pmdt007) RETURNING l_success,g_pmdt4_d[l_ac4].pmdt007_desc
        #DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt007_desc
        #160720-00015#1--e
        
        #160720-00015#1--s
        #CALL s_desc_get_unit_desc(g_pmdt4_d[l_ac4].pmdt019) RETURNING g_pmdt4_d[l_ac4].pmdt019_desc
        #DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt019_desc
        #
        #CALL s_desc_get_unit_desc(g_pmdt4_d[l_ac4].pmdt023) RETURNING g_pmdt4_d[l_ac4].pmdt023_desc
        #DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt023_desc
        #
        #CALL apmt520_pmds033_ref(g_pmdt4_d[l_ac4].pmdt046) RETURNING g_pmdt4_d[l_ac4].pmdt046_desc
        #DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt046_desc 
        #160720-00015#1--e
        
      #ming 20150922 add --------------------------------(S) 
      IF NOT cl_null(g_pmdt4_d[l_ac4].pmdt050) THEN
         LET l_isam011 = ''
         SELECT isam011 INTO l_isam011
           FROM isam_t,apcb_t,apca_t 
          WHERE isament   = g_enterprise
            AND isament   = apcbent 
            AND apcbent   = apcaent 
            AND isamdocno = apcbdocno
            AND apcbdocno = apcadocno 
            AND apcastus  = 'Y'
            AND isam010   = g_pmdt4_d[l_ac4].pmdt050
         IF NOT cl_null(l_isam011) THEN
            LET g_pmdt4_d[l_ac4].isam011 = l_isam011
         END IF
      END IF
      #ming 20150922 add --------------------------------(E) 
    
       LET l_ac4 = l_ac4 + 1
       IF l_ac4 > g_max_rec AND g_error_show = 1 THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code =  9035
          LET g_errparam.extend =  ''
          LET g_errparam.popup = TRUE
          CALL cl_err()

          EXIT FOREACH
       END IF
       
    END FOREACH
    LET g_error_show = 0
    
    CALL g_pmdt4_d.deleteElement(g_pmdt4_d.getLength())
 
    FREE apmt520_pb4
 
END FUNCTION
#採購供應商檢查
PRIVATE FUNCTION apmt520_pmds007_chk(p_pmds007)
DEFINE p_pmds007    LIKE pmds_t.pmds007
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdt006    LIKE pmdt_t.pmdt006
DEFINE l_pmdt007    LIKE pmdt_t.pmdt007
DEFINE l_pmdt009    LIKE pmdt_t.pmdt009
DEFINE l_pmdt010    LIKE pmdt_t.pmdt010
DEFINE l_pmdtseq    LIKE pmdt_t.pmdtseq

       LET r_success = TRUE
       
       #160713-00001#1---s
       IF cl_null(g_pmds_m.pmdsdocno) THEN
          INITIALIZE g_errparam TO NULL 
          LET g_errparam.extend = "" 
          LET g_errparam.code   = "apm-00603" 
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
          LET r_success = FALSE
          RETURN r_success
       END IF
       #160713-00001#1---e
       
       
       IF NOT cl_null(p_pmds007) THEN 
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL
          
          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = p_pmds007
   
          #呼叫檢查存在並帶值的library
          IF NOT cl_chk_exist("v_pmaa001_1") THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
          
          #151217-00014#3 ---add (S)---
           #IF NOT cl_chk_exist("v_pmab001_1") THEN  #161207-00033#38
           IF NOT cl_chk_exist("v_pmab001_3") THEN   #161207-00033#38
              #檢查失敗時後續處理
              LET r_success = FALSE
              RETURN r_success
           END IF
          #151217-00014#3 ---add (E)---
          
          #檢核輸入的供應商是否在單據別限制範圍內，若不在限制內則不允許跟此供應商採購
          CALL s_control_chk_doc('2',g_pmds_m.pmdsdocno,p_pmds007,'','','','') RETURNING l_success,l_flag
          IF NOT l_success THEN      #处理状态
             LET r_success = FALSE
             RETURN r_success
          ELSE
             IF NOT l_flag THEN      #是否存在
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00239'
                LET g_errparam.extend = p_pmds007
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF 
          END IF
          
          DECLARE pmdt_cs CURSOR FOR
            SELECT pmdtseq,pmdt006,pmdt007,pmdt009,pmdt010 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno =  g_pmds_m.pmdsdocno
          FOREACH pmdt_cs INTO l_pmdtseq,l_pmdt006,l_pmdt007,l_pmdt009,l_pmdt010
             #收貨單在維護料號時需檢核料件AVL控管點(imaa044)設置，若是設置'2:可採購，不可收貨'時，則要檢核
             #其他收貨、無採購收貨、收貨入庫單等作業也需考慮
             IF g_argv[1] MATCHES '[123489]' OR g_argv[1] = '20' THEN
                IF NOT s_apmt520_item_avl_chk(g_pmds_m.pmdsdocdt,l_pmdtseq,l_pmdt006,l_pmdt007,l_pmdt009,l_pmdt010,p_pmds007) THEN
                   LET r_success = FALSE
                   RETURN r_success
                END IF
             END IF
          END FOREACH
       END IF 
       
       RETURN r_success
       
END FUNCTION
#根据供应商带值
PRIVATE FUNCTION apmt520_pmds007_desc()
DEFINE l_n         LIKE type_t.num5
DEFINE l_ooef016   LIKE ooef_t.ooef016
DEFINE l_success   LIKE type_t.num5
DEFINE l_controlno LIKE ooha_t.ooha001
DEFINE l_scc40     LIKE type_t.chr2
DEFINE l_oodbl004  LIKE oodbl_t.oodbl004  #稅別名稱
DEFINE l_oodb005   LIKE oodb_t.oodb005    #含稅否
DEFINE l_oodb006   LIKE oodb_t.oodb006    #稅率 
DEFINE l_oodb011   LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定
DEFINE l_pmaa086   LIKE pmaa_t.pmaa086    #預設採購員   #2015/03/03 by stellar add
DEFINE l_pmaa087   LIKE pmaa_t.pmaa087    #預設採購部門 #2015/03/03 by stellar add
DEFINE l_pmds002_o LIKE pmds_t.pmds002    #2015/03/04 by stellar add
DEFINE l_pmds003_o LIKE pmds_t.pmds003    #2015/03/04 by stellar add


      #抓取交易對象夥伴關係檔且交易類型為"1:收/付款對象"的交易對象顯示在採購單上的
      #[C:帳款供應商]，若有設置多筆收/付款交易對象時，則取有勾選主要的交易對象那一個，
      #若沒有設交易對象夥伴關係檔且交易類型為"1:收/付款對象"的交易對象時，則[C:帳款供應商]預設採購供應商
      LET g_pmds_m.pmds008 = ''
      LET g_pmds_m.pmds008_desc = ''
      SELECT pmac002 INTO g_pmds_m.pmds008 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmds_m.pmds007 AND pmac003 = '1' AND pmacstus = 'Y' AND pmac004 = 'Y'
      IF cl_null(g_pmds_m.pmds008) THEN
         SELECT pmac002 INTO g_pmds_m.pmds008 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmds_m.pmds007 AND pmac003 = '1' AND pmacstus = 'Y' AND rownum = 1
         IF cl_null(g_pmds_m.pmds008) THEN
            LET g_pmds_m.pmds008 = g_pmds_m.pmds007
         END IF
      END IF
      CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
      DISPLAY BY NAME g_pmds_m.pmds008,g_pmds_m.pmds008_desc
      
      #抓取交易對象夥伴關係檔且交易類型為"2:出貨對象"的交易對象顯示在採購單上的[C:送貨供應商]，
      #若有設置多筆出貨交易對象時，則取有勾選主要的交易對象那一個，
      #若沒有設交易對象夥伴關係檔且交易類型為"2:出貨對象"的交易對象時，則[C:送貨供應商]預設採購供應商
      LET g_pmds_m.pmds009 = ''
      LET g_pmds_m.pmds009_desc = ''
      SELECT pmac002 INTO g_pmds_m.pmds009 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmds_m.pmds007 AND pmac003 = '2' AND pmacstus = 'Y' AND pmac004 = 'Y'
      IF cl_null(g_pmds_m.pmds009) THEN
         SELECT pmac002 INTO g_pmds_m.pmds009 FROM pmac_t WHERE pmacent = g_enterprise AND pmac001 = g_pmds_m.pmds007 AND pmac003 = '2' AND pmacstus = 'Y' AND rownum = 1
         IF cl_null(g_pmds_m.pmds009) THEN
            LET g_pmds_m.pmds009 = g_pmds_m.pmds007
         END IF
      END IF
      CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
      DISPLAY BY NAME g_pmds_m.pmds009,g_pmds_m.pmds009_desc
      
      #無採購單來源時，根據採購供應商帶出相關財務資訊;倉退時，未錄入來源收貨單號，也要根據供應商帶值 
      #151221-00010#1 20160105 modify by ming -----(S) 
      #apmt531 也要能帶出財務相關資訊 
      #IF g_argv[1] MATCHES '[24]' OR ((g_argv[1] MATCHES '[137]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') AND cl_null(g_pmds_m.pmds006)) THEN
     #161012-00053#1 20161017 mod by tangyi-str- 
      #IF g_argv[1] MATCHES '[24]' OR 
      #   ((g_argv[1] MATCHES '[137]' OR g_argv[1] = '14' OR 
      #     g_argv[1] = '15' OR g_argv[1] = '26' OR 
      #     g_argv[1] = '20') AND cl_null(g_pmds_m.pmds006)) THEN
      IF g_argv[1] MATCHES '[24]' OR 
         ((g_argv[1] MATCHES '[137]' OR g_argv[1] = '14' OR     
           g_argv[1] = '15' OR g_argv[1] = '26' OR 
           g_argv[1] = '20' OR g_argv[1] = '8') AND cl_null(g_pmds_m.pmds006)) THEN
     #161012-00053#1 20161017 mod by tangyi-end- 
      #151221-00010#1 20160105 modify by ming -----(E) 
         LET l_n = 0
         LET g_pmds_m.pmds031 = ''
         LET g_pmds_m.pmds031_desc = ''
         LET g_pmds_m.pmds032 = ''
         LET g_pmds_m.pmds032_desc = ''
         LET g_pmds_m.pmds033 = ''
         LET g_pmds_m.pmds033_desc = ''
         LET g_pmds_m.pmds034 = ''
         LET g_pmds_m.pmds035 = ''
         LET g_pmds_m.pmds037 = ''
         LET g_pmds_m.pmds037_desc = ''
         LET g_pmds_m.pmds038 = ''
         LET g_pmds_m.pmds039 = ''
         LET g_pmds_m.pmds039_desc = ''
         LET g_pmds_m.pmds048 = ''
         LET g_pmds_m.pmds049 = ''
         
         #2015/03/04 by stellar add ----- (S)
         LET l_pmds002_o = g_pmds_m.pmds002
         LET l_pmds003_o = g_pmds_m.pmds003
         LET g_pmds_m.pmds002 = ''
         LET g_pmds_m.pmds002_desc = ''
         LET g_pmds_m.pmds003 = ''
         LET g_pmds_m.pmds003_desc = ''
         #2015/03/04 by stellar add ----- (E)
         
         #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
         #LET l_controlno = ''
         #CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,l_controlno
         IF cl_null(g_controlno) THEN
            CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,g_controlno
         END IF
         #IF NOT cl_null(l_controlno) THEN
         IF NOT cl_null(g_controlno) THEN
            #判斷供應商是否有設置採購控制組供應商預設條件(apmi110)，若有則抓取相關的預設條件default到採購單上
            SELECT COUNT(1) INTO l_n FROM pmal_t 
               WHERE pmalent = g_enterprise AND pmal001 = g_pmds_m.pmds007 
                 #AND pmal002 = l_controlno 
                 AND pmal002 = g_controlno 
                 AND pmalstus = 'Y'
            IF l_n > 0 THEN
               SELECT pmal006,pmal020,pmal004,pmal003,pmal021,pmal023,pmal024,pmal008 
                     ,pmal019,pmal025   #2015/03/04 by stellar add
                 INTO g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds037,g_pmds_m.pmds039,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds012
                     ,g_pmds_m.pmds002,g_pmds_m.pmds003   #2015/03/04 by stellar add
               FROM pmal_t WHERE pmalent = g_enterprise AND pmal001 = g_pmds_m.pmds007 
                             #AND pmal002 = l_controlno
                             AND pmal002 = g_controlno
                             AND pmalstus = 'Y'
            END IF
         END IF
         
         #若沒有設置採購控制組供應商預設條件資料則改抓供應商據點預設條件(apmm202)資料  
         #IF cl_null(l_controlno) OR l_n = 0 THEN
         IF cl_null(g_controlno) OR l_n = 0 THEN
            SELECT pmab037,pmab053,pmab034,pmab033,pmab054,pmab057,pmab058,pmab038
                  ,pmab031,pmab059   #2015/03/04 by stellar add
                INTO g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds037,g_pmds_m.pmds039,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds012
                    ,g_pmds_m.pmds002,g_pmds_m.pmds003   #2015/03/04 by stellar add
              FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = g_pmds_m.pmds007
              
         END IF
         
         #2015/03/04 by stellar add ----- (S)
         IF cl_null(g_pmds_m.pmds002) OR cl_null(g_pmds_m.pmds003) THEN
            LET l_pmaa086 = ''
            LET l_pmaa087 = ''
            SELECT pmaa086,pmaa087 INTO l_pmaa086,l_pmaa087
              FROM pmaa_t
             WHERE pmaaent = g_enterprise
               AND pmaa001 = g_pmds_m.pmds007
            IF cl_null(g_pmds_m.pmds002) THEN
               LET g_pmds_m.pmds002 = l_pmaa086
            END IF
            
            IF cl_null(g_pmds_m.pmds003) THEN
               LET g_pmds_m.pmds003 = l_pmaa087
            END IF
         END IF
         
         IF NOT cl_null(g_pmds_m.pmds002) AND cl_null(g_pmds_m.pmds003) THEN
            SELECT ooag003 INTO g_pmds_m.pmds003
              FROM ooag_t 
             WHERE ooagent = g_enterprise 
               AND ooag001 = g_pmds_m.pmds002
         END IF
         
         IF cl_null(g_pmds_m.pmds002) THEN
            LET g_pmds_m.pmds002 = l_pmds002_o
         END IF
         
         IF cl_null(g_pmds_m.pmds003) THEN
            LET g_pmds_m.pmds003 = l_pmds003_o
         END IF
         
         #160713-00001#1---s---
         IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
            LET g_pmds_m.pmds002 = g_user
            LET g_pmds_m.pmds003 = g_dept
         END IF
         #160713-00001#1---e---
         
         CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
         CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
         
         DISPLAY BY NAME g_pmds_m.pmds002,g_pmds_m.pmds002_desc,
                         g_pmds_m.pmds003,g_pmds_m.pmds003_desc
         #2015/03/04 by stellar add ----- (E)
         
         #取得採購通路
         LET g_pmab039 = g_pmds_m.pmds012
         #取稅率、單價含稅否
         IF NOT cl_null(g_pmds_m.pmds033) THEN
            LET l_oodb005 = ''
            LET l_oodb006 = ''
            LET l_oodb011 = ''
            CALL s_tax_chk(g_site,g_pmds_m.pmds033)
              RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
              
            IF l_success THEN
               LET g_tax_app = l_oodb011
               LET g_pmds_m.pmds034 = l_oodb006
               LET g_pmds_m.pmds035 = l_oodb005
               LET g_pmds_m.pmds033_desc = l_oodbl004
            END IF           
         END IF
    
         
         #取匯率
         IF NOT cl_null(g_pmds_m.pmds037) THEN
            #根據內外購獲取當前營運據點參數設置的汇率类型
            LET l_scc40 = ''
            IF g_pmds_m.pmds048 = '1' THEN   #內購
               LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
            END IF
            IF g_pmds_m.pmds048 = '2' THEN   #外購
               LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
            END IF
            LET l_ooef016 = ''
            SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
            IF (NOT cl_null(l_scc40)) AND (NOT cl_null(l_ooef016)) THEN
               CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmds_m.pmds037,l_ooef016,0,l_scc40) RETURNING g_pmds_m.pmds038
            END IF
         END IF
         
         CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
         DISPLAY BY NAME g_pmds_m.pmds031_desc
         
         CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
         DISPLAY BY NAME g_pmds_m.pmds032_desc
         
         CALL apmt520_pmds033_ref(g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
         DISPLAY BY NAME g_pmds_m.pmds033_desc
         
         CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
         DISPLAY BY NAME g_pmds_m.pmds037_desc
         
         CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
         DISPLAY BY NAME g_pmds_m.pmds039_desc
            
         DISPLAY BY NAME g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds037,g_pmds_m.pmds039,
                         g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds038
                         
      END IF
      
END FUNCTION
#帳款供應商檢查
PRIVATE FUNCTION apmt520_pmds008_chk()
DEFINE r_success    LIKE type_t.num5

       LET r_success = TRUE
       
       #160713-00001#1---s
       IF cl_null(g_pmds_m.pmdsdocno) THEN
          INITIALIZE g_errparam TO NULL 
          LET g_errparam.extend = "" 
          LET g_errparam.code   = "apm-00603" 
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
          LET r_success = FALSE
          RETURN r_success
       END IF
       #160713-00001#1---e
       
       
       IF NOT cl_null(g_pmds_m.pmds008) AND (g_pmds_m.pmds008 != g_pmds_m.pmds007) THEN 
          IF NOT apmt520_pmds007_chk(g_pmds_m.pmds008) THEN
              LET r_success = FALSE
              RETURN r_success
          END IF
          
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL
          #160318-00025#15 by 07900 --add-str 
          LET g_errshow = TRUE #是否開窗
          #160318-00025#15 by 07900 --add-end
          
          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = g_pmds_m.pmds007
          LET g_chkparam.arg2 = g_pmds_m.pmds008
          LET g_chkparam.arg3 = g_site
          #160318-00025#15 by 07900 --add-str 
           LET g_chkparam.err_str[1] ="axr-00049:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"
          #160318-00025#15 by 07900 --add-end 
          #呼叫檢查存在並帶值的library
          IF NOT cl_chk_exist("v_pmac002") THEN
             LET r_success = FALSE
             RETURN r_success
          END IF  
       END IF 
       RETURN r_success
       
END FUNCTION
#送貨供應商檢查
PRIVATE FUNCTION apmt520_pmds009_chk()
DEFINE r_success    LIKE type_t.num5
DEFINE l_n          LIKE type_t.num5

       LET r_success = TRUE
       
       #160713-00001#1---s
       IF cl_null(g_pmds_m.pmdsdocno) THEN
          INITIALIZE g_errparam TO NULL 
          LET g_errparam.extend = "" 
          LET g_errparam.code   = "apm-00603" 
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
          LET r_success = FALSE
          RETURN r_success
       END IF
       #160713-00001#1---e
       
       
       IF NOT cl_null(g_pmds_m.pmds009) THEN
          IF (g_pmds_m.pmds009 != g_pmds_m.pmds007) THEN 
             IF NOT apmt520_pmds007_chk(g_pmds_m.pmds009) THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
             
             #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
             INITIALIZE g_chkparam.* TO NULL
             #160318-00025#15 by 07900 --add-str 
             LET g_errshow = TRUE #是否開窗
             #160318-00025#15 by 07900 --add-end
             #設定g_chkparam.*的參數
             LET g_chkparam.arg1 = g_pmds_m.pmds007
             LET g_chkparam.arg2 = g_pmds_m.pmds009
             LET g_chkparam.arg3 = g_site
             #160318-00025#15 by 07900 --add-str 
             LET g_chkparam.err_str[1] ="axr-00049:sub-01302|apmm100|",cl_get_progname("apmm100",g_lang,"2"),"|:EXEPROGapmm100"
             #160318-00025#15 by 07900 --add-end 
             #呼叫檢查存在並帶值的library
             IF NOT cl_chk_exist("v_pmac002_2") THEN
                LET r_success = FALSE
                RETURN r_success
             END IF
          END IF
          #當收貨單頭有輸入採購單號時，則輸入的送貨供應商需存在[T:採購明細檔].[C:送貨供應商]，
          #檢核條件如下:pmdndocno = pmds006   pmdn023  = pmds009
          IF (NOT cl_null(g_pmds_m.pmds006)) AND (g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20') THEN
             LET l_n = 0
             SELECT COUNT(1) INTO l_n FROM pmdn_t 
               WHERE pmdnent = g_enterprise AND pmdndocno = g_pmds_m.pmds006 AND pmdn023 = g_pmds_m.pmds009
             IF l_n = 0 OR cl_null(l_n) THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'apm-00406'
                LET g_errparam.extend = g_pmds_m.pmds009
                LET g_errparam.popup = TRUE
                CALL cl_err()

                LET r_success = FALSE
                RETURN r_success
             END IF
             
          END IF
       END IF 
       
       RETURN r_success
       
END FUNCTION
#單位檢查
PRIVATE FUNCTION apmt520_unit_chk(p_pmdt019)
DEFINE p_pmdt019    LIKE pmdt_t.pmdt019
DEFINE r_success    LIKE type_t.num5

       LET r_success = TRUE

       IF NOT cl_null(p_pmdt019) THEN
          #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
          INITIALIZE g_chkparam.* TO NULL

          #設定g_chkparam.*的參數
          LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt006
          LET g_chkparam.arg2 = p_pmdt019

          #呼叫檢查存在並帶值的library
          IF NOT cl_chk_exist("v_imao002") THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
       RETURN r_success

END FUNCTION

#維護扣帳日期:開放單頭[C:扣帳日期]欄位維護
PRIVATE FUNCTION apmt520_upd_pmds001()
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdsmoddt  LIKE pmds_t.pmdsmoddt
DEFINE l_gzsz008    LIKE gzsz_t.gzsz008
DEFINE l_forupd_sql STRING

   LET r_success = TRUE
   LET l_gzsz008 = ''

   #160720-00015#1--mark--s---
   #在过账时调用这个function，在调用之前因为有开启cursor锁资料，无需在锁一次
   #IF g_pmds_m.pmdsdocno IS NULL THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "std-00003"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = FALSE
   #   CALL cl_err()
   #
   #   LET r_success = FALSE
   #   RETURN r_success
   #END IF
   #
   #SELECT UNIQUE pmdssite,pmds000,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003,#pmdsstus,
   #       pmds006,pmds007, 
   #       pmds008,pmds009,pmds010,pmds011,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033, 
   #       pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040,pmds041,pmds042,pmds043,pmds044,pmds046, 
   #       pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt,pmdspstid, 
   #       pmdspstdt
   #INTO g_pmds_m.pmdssite,g_pmds_m.pmds000,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds002,g_pmds_m.pmds001, 
   #    g_pmds_m.pmds003,#g_pmds_m.pmdsstus,
   #    g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009, 
   #    g_pmds_m.pmds010,g_pmds_m.pmds011,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
   #    g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
   #    g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds041, 
   #    g_pmds_m.pmds042,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp, 
   #    g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt, 
   #    g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt
   #FROM pmds_t
   #WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
   #
   #ERROR ""
   #
   #LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
   #
   #LET l_forupd_sql = "SELECT pmdssite,pmdsdocno,pmdsdocdt,pmds002,'','',pmds001,pmds003, ",
   #                   " '',pmds006,pmds007,'',pmds008,'',pmds009,'',pmds010,pmds000,pmds100,pmds011,pmds081, ",
   #                   " pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,'',pmds032,'',pmds033,'',pmds034,pmds035,pmds036,", 
   #                   " pmds037,'',pmds038,pmds039,'',pmds040,'',pmds041,pmds042,pmds043,pmds044,pmds046,pmdsownid,'', ",
   #                   " pmdsowndp,'',pmdscrtid,'',pmdscrtdp,'',pmdscrtdt,pmdsmodid,'',pmdsmoddt,pmdscnfid,'',pmdscnfdt, ",
   #                   " pmdspstid,'',pmdspstdt FROM pmds_t WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
   #
   #LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)                #轉換不同資料庫語法
   #DECLARE apmt520_cl2 CURSOR FROM l_forupd_sql
   #
   #OPEN apmt520_cl2 USING g_enterprise,g_pmds_m.pmdsdocno
   #
   #IF STATUS THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code =  STATUS
   #   LET g_errparam.extend = "OPEN apmt520_cl2:"
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #
   #   CLOSE apmt520_cl2
   #   RETURN r_success
   #END IF
   #
   ##鎖住將被更改或取消的資料
   #FETCH apmt520_cl2 INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,
   #    g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmds001,
   #    g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmds006,g_pmds_m.pmds007,
   #    g_pmds_m.pmds007_desc,g_pmds_m.pmds008,g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,
   #    g_pmds_m.pmds010,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds081,g_pmds_m.pmds045,
   #    g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds031_desc,
   #    g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,
   #    g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds039,
   #    g_pmds_m.pmds039_desc,g_pmds_m.pmds040,g_pmds_m.pmds040_desc,g_pmds_m.pmds041,g_pmds_m.pmds042,
   #    g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,
   #    g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,
   #    g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,
   #    g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,
   #    g_pmds_m.pmdspstdt
   #
   ##資料被他人LOCK, 或是sql執行時出現錯誤
   #IF SQLCA.sqlcode THEN
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = g_pmds_m.pmdsdocno
   #   LET g_errparam.popup = FALSE
   #   CALL cl_err()
   #
   #   CLOSE apmt520_cl2
   #   RETURN r_success
   #END IF
   #160720-00015#1--mark--e---
         
   LET g_pmds_m_t.pmds001 = g_pmds_m.pmds001
   
   #CALL apmt520_show()  #160720-00015#1
   
   #160604-00034#7-S
   IF NOT cl_chk_update_pstdt() THEN
      CALL cl_set_comp_entry("pmds001",FALSE)
      LET g_pmds_m.pmds001 = g_today
      DISPLAY BY NAME g_pmds_m.pmds001
   END IF   
   #160604-00034#7-E   

   INPUT BY NAME g_pmds_m.pmds001 WITHOUT DEFAULTS

      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG THEN
            LET INT_FLAG = FALSE
            LET r_success = FALSE
            #CLOSE apmt520_cl2  #160720-00015#1
            RETURN r_success
         END IF

      AFTER FIELD pmds001
         #維護的日期不可小於成本關帳日
         LET l_gzsz008 = cl_get_para(g_enterprise,g_site,'S-MFG-0031')
         IF g_pmds_m.pmds001 <= l_gzsz008 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'sub-00306'
            LET g_errparam.extend = g_pmds_m.pmds001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            #CLOSE apmt520_cl2  #160720-00015#1
            LET r_success = FALSE
            RETURN r_success
            
         END IF
         #151120-00003#1 20151124 mark by beckxie---S
         ##扣賬日期不可小於單據日期
         #IF g_pmds_m.pmds001 < g_pmds_m.pmdsdocdt THEN
         #   INITIALIZE g_errparam TO NULL
         #   LET g_errparam.code = 'axm-00267'
         #   LET g_errparam.extend = g_pmds_m.pmds001
         #   LET g_errparam.popup = TRUE
         #   CALL cl_err()
         #   LET g_pmds_m.pmds001 = g_pmds_m_t.pmds001
         #   NEXT FIELD CURRENT
         #   
         #END IF
         #151120-00003#1 20151124 mark by beckxie---E
      #維護的日期不可大於現行年月，錯誤訊息「扣帳日期大於會計年度期別，請重新輸入]

   END INPUT

   IF INT_FLAG OR g_pmds_m.pmds001 IS NULL THEN
      LET INT_FLAG = 0
      LET r_success = FALSE
      #CLOSE apmt520_cl2   #160720-00015#1
      RETURN r_success
   END IF

   LET l_pmdsmoddt = cl_get_current()

   UPDATE pmds_t SET pmds001 = g_pmds_m.pmds001,
                     pmdsmodid = g_user,
                     pmdsmoddt = l_pmdsmoddt
     WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "pmds_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      LET r_success = FALSE
      #CLOSE apmt520_cl2   #160720-00015#1
      RETURN r_success
   END IF

   #CLOSE apmt520_cl2  #160720-00015#1
   RETURN r_success
   
END FUNCTION
#稅別說明
PRIVATE FUNCTION apmt520_pmds033_ref(p_pmds033)
DEFINE p_pmds033      LIKE pmds_t.pmds033
DEFINE l_ooef019      LIKE ooef_t.ooef019
DEFINE r_oodbl004     LIKE oodbl_t.oodbl004

       LET r_oodbl004 = ''
       #SELECT ooef019 INTO l_ooef019 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site  #160720-00015#1
       #CALL s_desc_get_tax_desc(l_ooef019,p_pmds033) RETURNING r_oodbl004 #160720-00015#1
       CALL s_desc_get_tax_desc(g_ooef019,p_pmds033) RETURNING r_oodbl004  #160720-00015#1
       RETURN r_oodbl004
      
END FUNCTION

PRIVATE FUNCTION apmt520_set_no_required_b()
    
    CALL cl_set_comp_required("pmdt016,pmdt063",FALSE)
    CALL cl_set_comp_required("pmdt028",FALSE)
    CALL cl_set_comp_required("pmdt081,pmdt082",FALSE)
    
    CALL cl_set_comp_required("pmdt059",FALSE) #160815-00031#3
    
END FUNCTION

PRIVATE FUNCTION apmt520_set_required_b()
DEFINE l_imaf055  LIKE imaf_t.imaf055
DEFINE l_imaa004  LIKE imaa_t.imaa004   #160815-00031#3

   #驗退、入庫時，收貨單號必須錄入  
    #IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
    IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25'  THEN
       CALL cl_set_comp_required("pmdt028",TRUE)
       IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
          CALL cl_set_comp_required("pmdt081,pmdt082",TRUE)
       END IF
    END IF

    #161021-00018#1 add--s 仓退单，如果单头有输入收货单号，单身收货项次栏位必输
    IF g_argv[1] = '7' AND NOT cl_null(g_pmds_m.pmds006) THEN
       CALL cl_set_comp_required("pmdt028",TRUE)
    END IF
    #161021-00018#1 add--e

   LET l_imaf055 = ''
   SELECT imaf055 INTO l_imaf055 FROM imaf_t WHERE imafent = g_enterprise AND imaf001 = g_pmdt_d[l_ac].pmdt006 AND imafsite = g_site
   
   #若設定imaf055(庫存管理特徵)等於'1.必須有庫存管理特徵'時，則[C:庫存管理特徵]欄位必須輸入
   IF l_imaf055 = '1' THEN
      CALL cl_set_comp_required("pmdt063",TRUE)
   END IF
   
  #170111-00050#1 mark --begin--
  #mark掉，移到下方  
  ##收貨入庫時，庫位不可為空
  #IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
  #   CALL cl_set_comp_required("pmdt016",TRUE)
  #END IF
  #170111-00050#1 mark --end--
  
   #160815-00031#3---s
   LET l_imaa004 = ''
   SELECT imaa004 INTO l_imaa004 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_pmdt_d[l_ac].pmdt006
   IF l_imaa004 = 'E' THEN
      CALL cl_set_comp_required("pmdt059",TRUE)
   END IF
   #160815-00031#3---e
   
   #170111-00050#1 add --begin--
   #收貨入庫時，庫位不可為空
   IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
      IF l_imaa004 != 'E' THEN
         CALL cl_set_comp_required("pmdt016",TRUE)
      END IF
   END IF
  #170111-00050#1 add --end--
   
END FUNCTION
#理由碼檢查
PRIVATE FUNCTION apmt520_pmdt051_chk(p_pmdt051)
DEFINE p_pmdt051  LIKE pmdt_t.pmdt051
DEFINE l_success  LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5
DEFINE l_flag     LIKE type_t.num5

        LET r_success = TRUE

        IF NOT cl_null(p_pmdt051) THEN
           CALL s_azzi650_chk_exist(g_acc,p_pmdt051) RETURNING l_success
           IF NOT l_success THEN
               LET r_success = FALSE
               RETURN r_success
           END IF

           #s_control_chk_doc('8',pmdsdocno,pmdt051,'','','','')?用元件，
           #檢核輸入的理由碼是否在單據別限制範圍內，若不在限制內則不允許使用此理由碼
           CALL s_control_chk_doc('8',g_pmds_m.pmdsdocno,p_pmdt051,'','','','') RETURNING l_success,l_flag
           IF NOT r_success THEN
              LET r_success = FALSE
              RETURN r_success
           ELSE
              IF NOT l_flag THEN
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
        END IF
        RETURN r_success

END FUNCTION

PRIVATE FUNCTION apmt520_set_no_required()
    
    CALL cl_set_comp_required("pmds006",FALSE)
    CALL cl_set_comp_required("pmdt081,pmdt082",FALSE)
    CALL cl_set_comp_required("pmds031,pmds032,pmds033",FALSE)
    
END FUNCTION

PRIVATE FUNCTION apmt520_set_required()
DEFINE l_pmaa004         LIKE pmaa_t.pmaa004   #161207-00033#38

    #驗退、入庫時，收貨單號必須錄入  
    #IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
    IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25'  THEN
       CALL cl_set_comp_required("pmds006",TRUE)
    END IF
    
    #161207-00033#38---s
    IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '20' THEN
       IF NOT cl_null(g_pmds_m.pmds007) THEN
          SELECT pmaa004 INTO l_pmaa004 FROM pmaa_t WHERE pmaaent = g_enterprise AND pmaa001 = g_pmds_m.pmds007
          IF l_pmaa004 MATCHES '[24]' THEN   #一次性交易對象  ##內部員工
             CALL cl_set_comp_required("pmds006",TRUE)
          END IF
       END IF
    END IF
    #161207-00033#38---e
    
    IF cl_get_para(g_enterprise,g_site,'S-MFG-0001') = "Y" THEN  #是否使用品質判定功能
       CALL cl_set_comp_required("pmdt081,pmdt082",TRUE)
    END IF
    IF g_argv[1] MATCHES '[12345689]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '20' THEN
       CALL cl_set_comp_required("pmds031,pmds032,pmds033",TRUE)
    END IF
END FUNCTION

#驗退、入庫、倉退時，根據收貨單號和項次帶出相關的資料
PRIVATE FUNCTION apmt520_pmdt028_desc()
DEFINE l_pmdt020   LIKE pmdt_t.pmdt020
DEFINE l_qcba017   LIKE qcba_t.qcba017
DEFINE l_qcba023   LIKE qcba_t.qcba023
DEFINE l_success   LIKE type_t.num5
DEFINE l_rate      LIKE inaj_t.inaj014
DEFINE l_qcbc009   LIKE qcbc_t.qcbc009
DEFINE l_qcbc013   LIKE qcbc_t.qcbc013
DEFINE l_n         LIKE type_t.num5
DEFINE l_pmdt090   LIKE pmdt_t.pmdt090
DEFINE l_pmdtdocno LIKE pmdt_t.pmdtdocno
DEFINE l_pmdtseq_1 LIKE pmdt_t.pmdtseq
DEFINE l_ooba002   LIKE ooba_t.ooba002  #dorislai-20150824-add
DEFINE l_pmdt020_3 LIKE pmdt_t.pmdt020
DEFINE l_pjaa013   LIKE pjaa_t.pjaa013

       IF (NOT cl_null(g_pmds_m.pmds006)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt028)) THEN
          LET g_pmdt_d[l_ac].pmdt081 = ''
          LET g_pmdt_d[l_ac].pmdt082 = ''
          LET g_pmdt_d[l_ac].pmdt083 = ''
          LET g_pmdt_d[l_ac].pmdt005 = ''  #子特性
          LET g_pmdt_d[l_ac].pmdt019 = ''  #單位
          LET g_pmdt_d[l_ac].pmdt020 = 0   #數量
          LET g_pmdt_d[l_ac].pmdt006 = ''  #收貨料號
          LET g_pmdt_d[l_ac].pmdt007 = ''  #收貨產品特徵
          LET g_pmdt_d[l_ac].pmdt036 = 0    #單價
          LET g_pmdt_d[l_ac].pmdt046 = ''   #稅別
          LET g_pmdt_d[l_ac].pmdt037 = 0    #稅率
          LET g_pmdt_d[l_ac].pmdt008 = ''   #包裝容器
          LET g_pmdt_d[l_ac].pmdt009 = ''   #作業編號
          LET g_pmdt_d[l_ac].pmdt010 = ''   #製程序
          LET g_pmdt_d[l_ac].pmdt021 = ''   #參考單位
          LET g_pmdt_d[l_ac].pmdt022 = 0    #參考數量
          LET g_pmdt_d[l_ac].pmdt023 = ''   #計價單位
          LET g_pmdt_d[l_ac].pmdt024 = 0    #計價數量
          LET g_pmdt_d[l_ac].pmdt025 = ''   #緊急度
          LET g_pmdt_d[l_ac].pmdt016 = ''   #庫位
          LET g_pmdt_d[l_ac].pmdt017 = ''   #儲位
          LET g_pmdt_d[l_ac].pmdt018 = ''   #批號
          LET g_pmdt_d[l_ac].pmdt040 = ''   #價格類型
          LET g_pmdt_d[l_ac].pmdt041 = ''   #保稅
          LET g_pmdt_d[l_ac].pmdt059 = ''   #備註
          LET g_pmdt_d[l_ac].pmdt090 = 0
          LET g_pmdt_d[l_ac].pmdt091 = 0
          LET g_pmdt_d[l_ac].pmdt092 = 0
          LET g_pmdt_d[l_ac].pmdt093 = 0
          LET g_pmdt_d[l_ac].pmdt049 = ''
          LET g_pmdt_d[l_ac].pmdt050 = ''
          
          
          SELECT pmdt001,pmdt002,pmdt003,pmdt004,pmdt005,pmdt006,pmdt007,pmdt008,pmdt009,pmdt010,pmdt011,pmdt016,pmdt017,pmdt018,pmdt019,pmdt020,
                 pmdt021,pmdt022,pmdt023,pmdt024,pmdt025,pmdt026,pmdt036,pmdt037,pmdt038,pmdt039,pmdt040,pmdt041,
                 pmdt042,pmdt043,pmdt044,pmdt045,pmdt048,
                 pmdt046,pmdt047,NVL(pmdt053,0),NVL(pmdt054,0),NVL(pmdt055,0),pmdt062,pmdt059,pmdt088,
                 pmdt072,pmdt073,pmdt074
            INTO g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,
                 g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt008,
                 g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt011,g_pmdt_d[l_ac].pmdt016,
                 g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,
                 g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024,
                 g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt037,
                 g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt040,g_pmdt_d[l_ac].pmdt041,
                 g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt045,g_pmdt_d[l_ac].pmdt048,
                 g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,
                 g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt088,
                 g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074
             FROM pmdt_t 
             WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028
          
          #dorislai-20150824-add----(S)
          #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
          IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
             #預設欄位
             CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
             IF l_success THEN
                CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016
                #應用參數
                IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                   CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING g_pmdt_d[l_ac].pmdt016
                END IF
             END IF          
          END IF
          #dorislai-20150824-add----(E) 
          
          #若來源單據沒有倉儲批，帶出預設值
          #預設料件的庫儲
          IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
             IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                SELECT imaf091,imaf092 INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017
                  FROM imaf_t
                  WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdt_d[l_ac].pmdt006
             END IF
             IF g_pmdt_d[l_ac].pmdt017 IS NULL THEN
                SELECT imaf092 INTO g_pmdt_d[l_ac].pmdt017
                  FROM imaf_t
                  WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_pmdt_d[l_ac].pmdt006
             END IF
          END IF
          
          #2.若輸入的收貨項次需要QC檢驗，則送驗QC的量 - QC合格量 -已經登打的驗退量 
          IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN
             
             #其他單據上錄入的數量
             LET l_pmdt020 = 0
             SELECT SUM(pmdt020) INTO l_pmdt020 FROM pmdt_t,pmds_t 
                WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                  AND pmdtent = g_enterprise AND pmds006 = g_pmds_m.pmds006
                  AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                  AND pmdsstus = 'N'
                  AND pmds000 = g_pmds_m.pmds000
                  
             IF cl_null(l_pmdt020) THEN
                LET l_pmdt020 = 0
             END IF
          
             IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                SELECT COUNT(qcbcseq) INTO l_n FROM qcbc_t,qcba_t 
                   WHERE qcbcent = g_enterprise AND qcbcent  = qcbaent
                     AND qcbcsite  = g_site AND qcbcsite = qcbasite
                     AND qcbcdocno = qcbadocno 
                     AND qcba001   = g_pmds_m.pmds006
                     AND qcba002   = g_pmdt_d[l_ac].pmdt028
                     AND qcbastus  = 'Y' AND qcbc012 = '4'
                IF l_n = 1 THEN
                   SELECT qcbcdocno,qcbcseq,qcbc002 INTO g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt083
                       FROM qcbc_t,qcba_t 
                      WHERE qcbcent = g_enterprise AND qcbcent  = qcbaent
                        AND qcbcsite  = g_site AND qcbcsite = qcbasite
                        AND qcbcdocno = qcbadocno 
                        AND qcba001   = g_pmds_m.pmds006
                        AND qcba002   = g_pmdt_d[l_ac].pmdt028
                        AND qcbastus  = 'Y' AND qcbc012 = '4'
                        #AND ROWNUM =1
                END IF
               
                IF (NOT cl_null(g_pmdt_d[l_ac].pmdt081)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt082)) THEN
                   SELECT SUM(pmdt020) INTO l_pmdt020 FROM pmdt_t,pmds_t
                     WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                       AND pmdtent = g_enterprise AND pmdsstus <> 'X'
                       AND pmdt081 = g_pmdt_d[l_ac].pmdt081 AND pmdt082 = g_pmdt_d[l_ac].pmdt082
                       AND (pmdsdocno <> g_pmds_m.pmdsdocno OR pmdtseq <> g_pmdt_d[l_ac].pmdtseq)
                       AND pmds000 = g_pmds_m.pmds000
                       
                   IF cl_null(l_pmdt020) THEN
                      LET l_pmdt020 = 0
                   END IF
                   
                   SELECT qcbc005,qcbc006,qcbc007,qcbc009,qcbc013
                       INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,l_qcbc009,l_qcbc013
                     FROM qcbc_t
                     WHERE qcbcent = g_enterprise AND qcbcsite = g_site
                       AND qcbcdocno = g_pmdt_d[l_ac].pmdt081
                       AND qcbcseq = g_pmdt_d[l_ac].pmdt082
                   IF cl_null(l_qcbc009) THEN
                      LET l_qcbc009 = 0
                   END IF
                   
                   LET g_pmdt_d[l_ac].pmdt020 = l_qcbc009 - l_pmdt020
                   
                   #若QC維護的處理方式為 2.不计价 則計價數量為 0
                   IF l_qcbc013 = '2' THEN
                      LET g_pmdt_d[l_ac].pmdt024 = 0
                   ELSE
                      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                         CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                   RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                         CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                             RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                      ELSE
                         LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                         LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
                      END IF
                   END IF
                END IF
                
                LET g_pmdt_d[l_ac].pmdt062 = 'N'

             END IF
             
             #3.若輸入的收貨項次不需要QC檢驗，則收貨數量-已經登打的驗退量 - 已經登打的入庫量 
             IF g_pmdt_d[l_ac].pmdt026 = 'N' THEN
                
                #收貨單存在未過賬的入庫單上的數量
                SELECT SUM(pmdt020) INTO l_pmdt020_3 FROM pmdt_t,pmds_t
                  WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                    AND pmdtent = g_enterprise AND (pmdsstus = 'N' OR pmdsstus = 'Y')
                    AND pmds006 = g_pmds_m.pmds006
                    AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                    AND pmds000 IN ('6','12','13')
                    
                IF cl_null(l_pmdt020_3) THEN
                   LET l_pmdt020_3 = 0
                END IF
                
                LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d[l_ac].pmdt053 - g_pmdt_d[l_ac].pmdt055 - g_pmdt_d[l_ac].pmdt054 - l_pmdt020 - l_pmdt020_3
                
                IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                   CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                             RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                   CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                       RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                ELSE
                   LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                   LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
                END IF                
             END IF
          END IF
          
          IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
             IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                SELECT COUNT(qcbcseq) INTO l_n FROM qcbc_t,qcba_t 
                   WHERE qcbcent = g_enterprise AND qcbcent  = qcbaent
                     AND qcbcsite  = g_site AND qcbcsite = qcbasite
                     AND qcbcdocno = qcbadocno 
                     AND qcba001   = g_pmds_m.pmds006
                     AND qcba002   = g_pmdt_d[l_ac].pmdt028
                     AND qcbastus  = 'Y' AND qcbc012 <> '4'
                IF l_n = 1 THEN
                   SELECT qcbcdocno,qcbcseq,qcbc002 INTO g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,g_pmdt_d[l_ac].pmdt083
                       FROM qcbc_t,qcba_t 
                      WHERE qcbcent = g_enterprise AND qcbcent  = qcbaent
                        AND qcbcsite  = g_site AND qcbcsite = qcbasite
                        AND qcbcdocno = qcbadocno 
                        AND qcba001   = g_pmds_m.pmds006
                        AND qcba002   = g_pmdt_d[l_ac].pmdt028
                        AND qcbastus  = 'Y' AND qcbc012 <> '4'
                        #AND ROWNUM =1
                END IF
                
                IF (NOT cl_null(g_pmdt_d[l_ac].pmdt081)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt082)) THEN
                   SELECT SUM(pmdt020) INTO l_pmdt020 FROM pmdt_t,pmds_t
                     WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                       AND pmdtent = g_enterprise AND pmdsstus <> 'X'
                       AND pmdt081 = g_pmdt_d[l_ac].pmdt081 AND pmdt082 = g_pmdt_d[l_ac].pmdt082
                       AND (pmdsdocno <> g_pmds_m.pmdsdocno OR pmdtseq <> g_pmdt_d[l_ac].pmdtseq)
                       AND pmds000 = g_pmds_m.pmds000
                       
                   IF cl_null(l_pmdt020) THEN
                      LET l_pmdt020 = 0
                   END IF
                   
                    SELECT qcbc005,qcbc006,qcbc007,qcbc009,qcbc013
                       INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,l_qcbc009,l_qcbc013
                     FROM qcbc_t
                     WHERE qcbcent = g_enterprise AND qcbcsite = g_site
                       AND qcbcdocno = g_pmdt_d[l_ac].pmdt081
                       AND qcbcseq = g_pmdt_d[l_ac].pmdt082
                       
                   IF cl_null(l_qcbc009) THEN
                      LET l_qcbc009 = 0
                   END IF
                   
                   LET g_pmdt_d[l_ac].pmdt020 = l_qcbc009 - l_pmdt020
                   
                   #若QC維護的處理方式為 2.不计价 則計價數量為 0
                   IF l_qcbc013 = '2' THEN
                      LET g_pmdt_d[l_ac].pmdt024 = 0
                   ELSE
                      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                         CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                   RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                         CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                             RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                      ELSE
                         LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                         LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
                      END IF
                   END IF
                END IF
                
                LET g_pmdt_d[l_ac].pmdt062 = 'N'
                
             ELSE
                #其他單據上錄入的數量
                LET l_pmdt020 = 0
                SELECT SUM(pmdt020) INTO l_pmdt020 FROM pmdt_t,pmds_t 
                   WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                     AND pmdtent = g_enterprise AND pmds006 = g_pmds_m.pmds006
                     AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                     AND (pmdsstus = 'N' OR pmdsstus = 'Y')
                     AND pmds000 = g_pmds_m.pmds000
                     
                IF cl_null(l_pmdt020) THEN
                   LET l_pmdt020 = 0
                END IF
                
                #收貨單存在未確認的驗退單上的數量
                SELECT SUM(pmdt020) INTO l_pmdt020_3 FROM pmdt_t,pmds_t
                  WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                    AND pmdtent = g_enterprise AND pmdsstus = 'N'
                    AND pmds006 = g_pmds_m.pmds006
                    AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                    AND pmds000 IN ('5','10','11')
                    
                IF cl_null(l_pmdt020_3) THEN
                   LET l_pmdt020_3 = 0
                END IF
            
                LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d[l_ac].pmdt053 - g_pmdt_d[l_ac].pmdt054 - g_pmdt_d[l_ac].pmdt055 - l_pmdt020 - l_pmdt020_3
                
                IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                   #160929-00038#1---s
                   CALL s_apmt520_get_pmdt024(g_pmds_m.pmds000,g_pmds_m.pmdsdocno,g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'','','','',g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt023)
                       RETURNING g_pmdt_d[l_ac].pmdt024
                   IF cl_null(g_pmdt_d[l_ac].pmdt024) OR g_pmdt_d[l_ac].pmdt024 = 0 THEN
                   #160929-00038#1---e
                      CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                                RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                      CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                          RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                  END IF  #160929-00038#1
                ELSE
                   LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                   LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
                END IF
             END IF
          END IF

          IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
             #其他單據上錄入的數量
             LET l_pmdt020 = 0
             LET l_pmdt090 = 0
             SELECT SUM(pmdt020),SUM(pmdt090) INTO l_pmdt020,l_pmdt090 FROM pmdt_t,pmds_t 
                WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
                  AND pmdtent = g_enterprise AND pmds006 = g_pmds_m.pmds006
                  AND pmdt028 = g_pmdt_d[l_ac].pmdt028
                  #AND (pmdsstus = 'N' OR pmdsstus = 'Y')
                  AND pmdsstus <> 'X'  #modify by lixiang 20150604
                  AND pmds000 = g_pmds_m.pmds000
                  AND pmds100 <> '4'  #151020-00006 by whitney add
                  
             IF cl_null(l_pmdt020) THEN
                LET l_pmdt020 = 0
             END IF
             LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d[l_ac].pmdt054 - l_pmdt020 
             
             #借貨歸還單時，還需要減去其他單據上的借貨還價數量
             IF g_argv[1] = '26'  THEN
                IF cl_null(l_pmdt090) THEN
                   LET l_pmdt090 = 0
                END IF
                
                LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d[l_ac].pmdt020 - l_pmdt090
                
             END IF
             IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
                CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                          RETURNING l_success,g_pmdt_d[l_ac].pmdt024
                CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
                    RETURNING l_success,g_pmdt_d[l_ac].pmdt024
             ELSE
                LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
                LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
             END IF
             #倉退單，當倉退方式為'4:'價格折讓'時，數量欄位預設為0
             IF g_pmds_m.pmds100 = '4' THEN
                LET g_pmdt_d[l_ac].pmdt020 = 0
                LET g_pmdt_d[l_ac].pmdt024 = 0
             END IF
             
             #倉退是先抓收貨單自行輸入的發票號碼，抓不到，再抓isam的
             IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                CALL apmt520_get_invoice_num(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028) RETURNING g_pmdt_d[l_ac].pmdt049,g_pmdt_d[l_ac].pmdt050            
             END IF
            
          END IF
          
          IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt019)) THEN
             CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020)
                RETURNING l_success,g_pmdt_d[l_ac].pmdt020
                     
             IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
                CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                          RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022)
                    RETURNING l_success,g_pmdt_d[l_ac].pmdt022
                    
             ELSE
                LET g_pmdt_d[l_ac].pmdt022 = ''
             END IF
             
             #IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
             #   CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
             #             RETURNING l_success,g_pmdt_d[l_ac].pmdt024
             #   CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
             #       RETURNING l_success,g_pmdt_d[l_ac].pmdt024
             #ELSE
             #   LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
             #   LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
             #END IF
          END IF
          
          LET g_pmdt_d[l_ac].pmdt052 = '1'              #狀態碼 '1:一般'
          
          #非多庫儲批時，先賦值來源單據的製造批序號
          #驗退、入庫、倉退單據，賦值來源單據的製造批序號資料inao_t
          IF g_pmdt_d[l_ac].pmdt062 = 'N' AND g_pmdt_d[l_ac].pmdt020 > 0 THEN
             IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                CALL s_apmt520_upd_inao('2',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'') RETURNING l_success
                DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = p_pmdsdocno AND inaoseq = g_pmds_m.pmdsdocno AND inaoseq1 = g_pmdt_d[l_ac].pmdtseq
                IF g_pmdt_d[l_ac].pmdt026 = 'Y' THEN
                   IF NOT s_apmt520_ins_inao('2',g_pmdt_d[l_ac].pmdt081,g_pmdt_d[l_ac].pmdt082,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                      #LET r_success = FALSE
                      #RETURN r_success
                   END IF
                ELSE
                   IF NOT s_apmt520_ins_inao('2',g_pmds_m.pmds006,g_pmdt_d[l_ac].pmdt028,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                      #LET r_success = FALSE
                      #RETURN r_success
                   END IF
                END IF
             END IF
             IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                DECLARE sel_pmdt_cs CURSOR FOR
                    SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                       WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno 
                         AND pmdsent = g_enterprise 
                         AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                            OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20'))) 
                         AND pmdsstus = 'S'
                FOREACH sel_pmdt_cs INTO l_pmdtdocno,l_pmdtseq_1
                   IF NOT s_apmt520_ins_inao('2',l_pmdtdocno,l_pmdtseq_1,'',g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,1) THEN
                      #LET r_success = FALSE
                      #RETURN r_success
                   END IF
                END FOREACH
             END IF
          END IF
          
          #有專案代號且"專案庫存控管"="Y"時，自動將專案代號帶入庫存管理特徵欄位中，不可修改
          IF g_argv[1] MATCHES '[67]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
             IF NOT cl_null(g_pmdt_d[l_ac].pmdt072) THEN
                SELECT pjaa013 INTO l_pjaa013 FROM pjaa_t,pjba_t 
                   WHERE pjaaent = pjbaent AND pjaa001 = pjba000 AND pjaaent = g_enterprise AND pjba001 = g_pmdt_d[l_ac].pmdt072
                IF l_pjaa013 = 'Y' THEN
                   LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d[l_ac].pmdt072
                END IF
             END IF  
          END IF      
          
          #160224-00002#1--add--begin--
          #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
          IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
             #預設欄位
             CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
             IF l_success THEN
                CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016
                #應用參數
                IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                   CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING g_pmdt_d[l_ac].pmdt016
                END IF
             END IF          
          END IF
          #160224-00002#1--add--end--
          
          LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020 
          
          CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc2
          
          CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
          
          CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc

          CALL apmt520_pmdt008_ref(g_pmdt_d[l_ac].pmdt008) RETURNING g_pmdt_d[l_ac].pmdt008_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt008_desc
          
          CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt021_desc
          
          CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
          
          CALL apmt520_pmds033_ref(g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046_desc
          
          CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
          
          CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
          
          IF (NOT cl_null(g_pmdt_d[l_ac].pmdt020)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt036)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) THEN
             CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
               RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
             DISPLAY BY NAME g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
          END IF
          
          CALL s_desc_get_project_desc(g_pmdt_d[l_ac].pmdt072) RETURNING g_pmdt_d[l_ac].pmdt072_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt072_desc
          
          CALL s_desc_get_wbs_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073) RETURNING g_pmdt_d[l_ac].pmdt073_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt073_desc
          
          CALL s_desc_get_activity_desc(g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt074) RETURNING g_pmdt_d[l_ac].pmdt074_desc
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt074_desc
          
          DISPLAY BY NAME g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt008,
                 g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt011,g_pmdt_d[l_ac].pmdt016,
                 g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,
                 g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024,
                 g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt037,
                 g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt040,g_pmdt_d[l_ac].pmdt041,
                 #g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt045,
                 g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055,
                 g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt072,g_pmdt_d[l_ac].pmdt073,g_pmdt_d[l_ac].pmdt074
           
       END IF
       
END FUNCTION

#QC檢驗單號檢查
PRIVATE FUNCTION apmt520_pmdt081_chk(p_pmdt081)
DEFINE p_pmdt081   LIKE pmdt_t.pmdt081
DEFINE l_n         LIKE type_t.num5 
DEFINE r_success   LIKE type_t.num5

       LET r_success = TRUE
       #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
       INITIALIZE g_chkparam.* TO NULL
       
       #設定g_chkparam.*的參數
       LET g_chkparam.arg1 = p_pmdt081
   
       #呼叫檢查存在並帶值的library
       IF NOT cl_chk_exist("v_qcbadocno") THEN
          LET r_success = FALSE
          RETURN r_success
       END IF
       
       LET l_n = 0
       IF g_argv[1] MATCHES '[1389]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
          SELECT COUNT(1) INTO l_n FROM qcba_t
            WHERE qcbaent = g_enterprise AND qcbasite = g_site AND qcbadocno = p_pmdt081
              AND qcba001 = g_pmds_m.pmds006 AND qcba002 = g_pmdt_d[l_ac].pmdt002
       END IF
       IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
          SELECT COUNT(1) INTO l_n FROM qcba_t
            WHERE qcbaent = g_enterprise AND qcbasite = g_site AND qcbadocno = p_pmdt081
              AND qcba001 = g_pmds_m.pmds006 AND qcba002 = g_pmdt_d[l_ac].pmdt028
       END IF
       IF l_n = 0 OR cl_null(l_n) THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = 'apm-00453'
          LET g_errparam.extend = p_pmdt081
          LET g_errparam.popup = TRUE
          CALL cl_err()

          LET r_success = FALSE
          RETURN r_success
       END IF
       
       RETURN r_success
       
END FUNCTION

#QC判定項次檢驗
PRIVATE FUNCTION apmt520_pmdt082_chk(p_pmdt081,p_pmdt082)
DEFINE p_pmdt081   LIKE pmdt_t.pmdt081
DEFINE p_pmdt082   LIKE pmdt_t.pmdt082
DEFINE r_success   LIKE type_t.num5

       LET r_success = TRUE
       #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
       INITIALIZE g_chkparam.* TO NULL
       
       #設定g_chkparam.*的參數
       LET g_chkparam.arg1 = p_pmdt081
       LET g_chkparam.arg2 = p_pmdt082
       
       #驗退
       IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN 
          IF NOT cl_chk_exist("v_qcbcseq_2") THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
       
       #入庫
       IF g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN 
          IF NOT cl_chk_exist("v_qcbcseq_1") THEN
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF

       RETURN r_success
       

END FUNCTION

#帶出判定結果的資料
PRIVATE FUNCTION apmt520_pmdt082_desc()
DEFINE l_qcbc009     LIKE qcbc_t.qcbc009
DEFINE l_pmdt020     LIKE pmdt_t.pmdt020
DEFINE l_qcbc013     LIKE qcbc_t.qcbc013
DEFINE l_success     LIKE type_t.num5
DEFINE l_ooba002     LIKE ooba_t.ooba002  #160224-00002#1 add

     LET g_pmdt_d[l_ac].pmdt083 = ''
     LET g_pmdt_d[l_ac].pmdt016 = ''
     LET g_pmdt_d[l_ac].pmdt017 = ''
     LET g_pmdt_d[l_ac].pmdt018 = ''
     
     SELECT qcbc002,qcbc005,qcbc006,qcbc007,qcbc009,qcbc013
        INTO g_pmdt_d[l_ac].pmdt083,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,l_qcbc009,l_qcbc013
      FROM qcbc_t
      WHERE qcbcent = g_enterprise AND qcbcsite = g_site
        AND qcbcdocno = g_pmdt_d[l_ac].pmdt081
        AND qcbcseq = g_pmdt_d[l_ac].pmdt082
     
     #160224-00002#1--add--begin--
     #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
     IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
        #預設欄位
        CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_success,l_ooba002
        IF l_success THEN
           CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'pmdt016',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016
           #應用參數
           IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
              CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING g_pmdt_d[l_ac].pmdt016
           END IF
        END IF          
     END IF
     #160224-00002#1--add--end--
          
     SELECT SUM(pmdt020) INTO l_pmdt020 FROM pmdt_t,pmds_t
        WHERE pmdtent = pmdsent AND pmdtdocno = pmdsdocno
          AND pmdtent = g_enterprise AND pmdsstus <> 'X'
          AND pmdt081 = g_pmdt_d[l_ac].pmdt081 AND pmdt082 = g_pmdt_d[l_ac].pmdt082
          AND (pmdsdocno <> g_pmds_m.pmdsdocno OR pmdtseq <> g_pmdt_d[l_ac].pmdtseq)
          AND pmds000 = g_pmds_m.pmds000
          AND pmds100 <> '4'  #151020-00006 by whitney add
     
     IF cl_null(l_pmdt020) THEN
        LET l_pmdt020 = 0
     END IF
     
     LET g_pmdt_d[l_ac].pmdt020 = l_qcbc009 - l_pmdt020
     #若QC維護的處理方式為 2.不计价 則計價數量為 0
     IF l_qcbc013 = '2' THEN
        LET g_pmdt_d[l_ac].pmdt024 = 0
     ELSE
        IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND apmt520_get_imaf144(g_pmdt_d[l_ac].pmdt006) THEN
           CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt024
           CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024)
               RETURNING l_success,g_pmdt_d[l_ac].pmdt024
        ELSE
           LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
           LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
        END IF
     END IF
     
     IF (NOT cl_null(g_pmdt_d[l_ac].pmdt021)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) THEN
        CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt020)
                  RETURNING l_success,g_pmdt_d[l_ac].pmdt022
        CALL s_aooi250_take_decimals(g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022)
            RETURNING l_success,g_pmdt_d[l_ac].pmdt022
            
     ELSE
        LET g_pmdt_d[l_ac].pmdt022 = ''
     END IF
     
     LET g_pmdt_d[l_ac].pmdt062 = 'N'    
     
     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt083,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt062
     
     CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
     
     CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
          
     CALL apmt520_pmdt083_ref(g_pmdt_d[l_ac].pmdt083) RETURNING g_pmdt_d[l_ac].pmdt083_desc
     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt083_desc
     
END FUNCTION

PRIVATE FUNCTION apmt520_pmdt083_ref(p_pmdt083)
DEFINE p_pmdt083     LIKE pmdt_t.pmdt083
DEFINE r_qcaol004    LIKE qcaol_t.qcaol004

       INITIALIZE g_ref_fields TO NULL
       LET g_ref_fields[1] = p_pmdt083
       CALL ap_ref_array2(g_ref_fields,"SELECT qcaol004 FROM qcaol_t WHERE qcaolent='"||g_enterprise||"' AND qcaol001='"||g_ooef025||"' AND qcaol002=? AND qcaol003='"||g_dlang||"'","") RETURNING g_rtn_fields
       LET r_qcaol004 = '', g_rtn_fields[1] , ''
       RETURN r_qcaol004
      
END FUNCTION

#維護取回日期
PRIVATE FUNCTION apmt520_upd_pmds081()
DEFINE l_pmdsmoddt  LIKE pmds_t.pmdsmoddt
DEFINE l_forupd_sql STRING

   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   SELECT UNIQUE pmdssite,pmds000,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003,pmdsstus,pmds006,pmds007, 
        pmds008,pmds009,pmds010,pmds011,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033, 
        pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040,pmds041,pmds042,pmds043,pmds044,pmds046, 
        pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt,pmdspstid, 
        pmdspstdt
 INTO g_pmds_m.pmdssite,g_pmds_m.pmds000,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds002,g_pmds_m.pmds001, 
     g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009, 
     g_pmds_m.pmds010,g_pmds_m.pmds011,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
     g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
     g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds041, 
     g_pmds_m.pmds042,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp, 
     g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt, 
     g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt
 FROM pmds_t
 WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
 
   ERROR ""
  
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   CALL s_transaction_begin()
   
   LET l_forupd_sql = "SELECT pmdssite,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003, ",
                      " pmdsstus,pmds006,pmds007,pmds008,pmds009,pmds010,pmds000,pmds100,pmds011,pmds081, ",
                      " pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,", 
                      " pmds037,pmds038,pmds039,pmds040,pmds041,pmds042,pmds043,pmds044,pmds046 ",
                      " FROM pmds_t WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
  
   LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)                #轉換不同資料庫語法
   DECLARE apmt520_cl3 CURSOR FROM l_forupd_sql

   OPEN apmt520_cl3 USING g_enterprise,g_pmds_m.pmdsdocno
 
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt520_cl3:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt520_cl3
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH apmt520_cl3 INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,
       g_pmds_m.pmds002,g_pmds_m.pmds001,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,
       g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds081,g_pmds_m.pmds045,
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,
       g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,
       g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,
       g_pmds_m.pmds040,g_pmds_m.pmds041,g_pmds_m.pmds042,
       g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   
 
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE apmt520_cl3
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #CALL apmt520_show()  #160804-00025#1 mark
   
   #LET g_flag3 = FALSE
   #CALL apmt520_set_entry('u')    #160804-00025#1 mark
   #CALL apmt520_set_no_entry('u') #160804-00025#1 mark

   INPUT BY NAME g_pmds_m.pmds081 WITHOUT DEFAULTS

      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG THEN
            LET INT_FLAG = FALSE
            CLOSE apmt520_cl3
            CALL s_transaction_end('N','0')
            RETURN
         END IF

      AFTER FIELD pmds081
        

   END INPUT

   IF INT_FLAG OR g_pmds_m.pmds001 IS NULL THEN
      LET INT_FLAG = 0
      CLOSE apmt520_cl3
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   LET l_pmdsmoddt = cl_get_current()

   UPDATE pmds_t SET pmds081 = g_pmds_m.pmds081,
                     pmdsmodid = g_user,
                     pmdsmoddt = l_pmdsmoddt
     WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "pmds_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt520_cl3
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #sLET g_flag3 = TRUE
   
   CLOSE apmt520_cl3
   CALL s_transaction_end('Y','0')

END FUNCTION

#多庫儲批不勾選時，則也新增一筆資料到收貨/驗退/入庫/倉退單多庫儲批收貨明細檔
PRIVATE FUNCTION apmt520_ins_pmdu()
DEFINE l_pmduseq1   LIKE pmdu_t.pmduseq1
DEFINE r_success    LIKE type_t.num5
#161124-00048#11 mod-S
#DEFINE l_pmdu       RECORD LIKE pmdu_t.*
DEFINE l_pmdu RECORD  #收貨/驗退/入庫/倉退單多庫儲批收貨明細檔
       pmduent LIKE pmdu_t.pmduent, #企业编号
       pmdusite LIKE pmdu_t.pmdusite, #营运据点
       pmdudocno LIKE pmdu_t.pmdudocno, #单据编号
       pmduseq LIKE pmdu_t.pmduseq, #项次
       pmduseq1 LIKE pmdu_t.pmduseq1, #项序
       pmdu001 LIKE pmdu_t.pmdu001, #料件编号
       pmdu002 LIKE pmdu_t.pmdu002, #产品特征
       pmdu003 LIKE pmdu_t.pmdu003, #作业编号
       pmdu004 LIKE pmdu_t.pmdu004, #作业序
       pmdu005 LIKE pmdu_t.pmdu005, #库存管理特征
       pmdu006 LIKE pmdu_t.pmdu006, #库位
       pmdu007 LIKE pmdu_t.pmdu007, #储位
       pmdu008 LIKE pmdu_t.pmdu008, #批号
       pmdu009 LIKE pmdu_t.pmdu009, #单位
       pmdu010 LIKE pmdu_t.pmdu010, #数量
       pmdu011 LIKE pmdu_t.pmdu011, #参考单位
       pmdu012 LIKE pmdu_t.pmdu012, #参考数量
       pmdu013 LIKE pmdu_t.pmdu013, #允收数量
       pmdu014 LIKE pmdu_t.pmdu014, #已入库量
       pmdu015 LIKE pmdu_t.pmdu015, #已验退量
       pmdu016 LIKE pmdu_t.pmdu016, #存货备注
       pmdu017 LIKE pmdu_t.pmdu017, #有效日期
       pmdu200 LIKE pmdu_t.pmdu200, #包装单位
       pmdu201 LIKE pmdu_t.pmdu201, #包装数量
       pmdu202 LIKE pmdu_t.pmdu202  #制造日期
END RECORD
#161124-00048#11 mod-E
DEFINE l_n          LIKE type_t.num5
DEFINE l_rate       LIKE inaj_t.inaj014
DEFINE l_flag       LIKE type_t.num5
DEFINE l_success    LIKE type_t.num5
DEFINE l_pmdt020    LIKE pmdt_t.pmdt020
DEFINE l_pmdt016    LIKE pmdt_t.pmdt016
DEFINE l_pmdt017    LIKE pmdt_t.pmdt017
DEFINE l_pmdt018    LIKE pmdt_t.pmdt018
DEFINE l_pmdt081    LIKE pmdt_t.pmdt081
DEFINE l_pmdt082    LIKE pmdt_t.pmdt082
DEFINE l_pmdtdocno LIKE pmdt_t.pmdtdocno
DEFINE l_pmdtseq_1 LIKE pmdt_t.pmdtseq

      LET r_success = TRUE
     
      IF cl_null(g_pmdt_d_t.pmdtseq) THEN
         LET g_pmdt_d_t.pmdtseq = g_pmdt_d[l_ac].pmdtseq  
      END IF
      
      IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
         DELETE FROM pmdu_t
           WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno 
             AND pmduseq = g_pmdt_d_t.pmdtseq
         
         LET l_pmduseq1 = 0
         
         SELECT MAX(pmduseq1)+1 INTO l_pmduseq1 FROM pmdu_t
           WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d[l_ac].pmdtseq
         IF cl_null(l_pmduseq1) OR l_pmduseq1 = 0 THEN
            LET l_pmduseq1 = 1
         END IF
         
         #收貨單時，允收數量賦 零
         IF g_argv[1] MATCHES '[123489]' OR g_argv[1] = '23' OR g_argv[1] = '24' THEN
            LET g_pmdt_d[l_ac].pmdt053 = 0
         ELSE
            LET g_pmdt_d[l_ac].pmdt053 = g_pmdt_d[l_ac].pmdt020
         END IF
         LET g_pmdt_d[l_ac].pmdt054 = 0
         LET g_pmdt_d[l_ac].pmdt055 = 0
         
         #160119-00002#1 add -----(S) 
         #儲位、批號 若為空，給一個空格
         IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
            LET g_pmdt_d[l_ac].pmdt017 = ' '
         END IF
         IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
            LET g_pmdt_d[l_ac].pmdt018 = ' '
         END IF
        #160119-00002#1 add -----(E)

         #160512-00004#6-add-'pmdu202'、'g_pmdt_d[l_ac].pmdt219'
         INSERT INTO pmdu_t(pmduent,pmdusite,pmdudocno,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu003,pmdu004,pmdu005,
                            pmdu006,pmdu007,pmdu008,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu016,pmdu202,pmdu017)
           VALUES (g_enterprise,g_site,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,l_pmduseq1,g_pmdt_d[l_ac].pmdt006,
                   g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt009,g_pmdt_d[l_ac].pmdt010,g_pmdt_d[l_ac].pmdt063,
                   g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt019,
                   g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt021,g_pmdt_d[l_ac].pmdt022,g_pmdt_d[l_ac].pmdt053,
                   g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt088,g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089)
                   
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "pmdu_t"
            LET g_errparam.popup = FALSE
            CALL cl_err()
         
            LET r_success = FALSE
            RETURN r_success
         END IF
      ELSE
         
         LET l_n = 0
         #當前單據是否有維護多庫儲批
         SELECT COUNT(1) INTO l_n FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND pmduseq = g_pmdt_d[l_ac].pmdtseq
         IF l_n = 0 OR cl_null(l_n) THEN
            
            SELECT COUNT(1) INTO l_n FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmds006 AND pmduseq = g_pmdt_d[l_ac].pmdt028
            
            IF l_n > 0 THEN
                DELETE FROM pmdu_t
                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno 
                   AND pmduseq = g_pmdt_d[l_ac].pmdtseq
               
               LET l_pmdt020 = g_pmdt_d[l_ac].pmdt020
               #複製來源單號的多庫儲批
               #161124-00048#11 mod-S
#               DECLARE pmdu_ins CURSOR FOR
#                  SELECT * FROM pmdu_t WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmds006 AND pmduseq = g_pmdt_d[l_ac].pmdt028
               DECLARE pmdu_ins CURSOR FOR
                  SELECT pmduent,pmdusite,pmdudocno,pmduseq,pmduseq1,
                         pmdu001,pmdu002,pmdu003,pmdu004,pmdu005,
                         pmdu006,pmdu007,pmdu008,pmdu009,pmdu010,
                         pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,
                         pmdu016,pmdu017,pmdu200,pmdu201,pmdu202 
                    FROM pmdu_t 
                   WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmds006 AND pmduseq = g_pmdt_d[l_ac].pmdt028
               #161124-00048#11 mod-E
               FOREACH pmdu_ins INTO l_pmdu.*
                  LET l_pmdu.pmduent = g_enterprise
                  LET l_pmdu.pmdusite = g_site
            
                  #IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                  #    LET l_pmdu.pmdu010 = l_pmdu.pmdu014
                  #ELSE
                  #   #驗退
                  #   IF g_argv[1] MATCHES '[5]' OR g_argv[1] = '10' OR g_argv[1] = '11' THEN
                  #      LET l_pmdu.pmdu010 = l_pmdu.pmdu010 - l_pmdu.pmdu014 - l_pmdu.pmdu015
                  #   ELSE
                  #      LET l_pmdu.pmdu010 = l_pmdu.pmdu013 - l_pmdu.pmdu014 - l_pmdu.pmdu015
                  #   END IF
                  #END IF
                  IF l_pmdt020 <= l_pmdu.pmdu010 THEN
                     LET l_pmdu.pmdu010 = l_pmdt020
                     LET l_pmdt020 = 0
                  ELSE
                     LET l_pmdt020 = l_pmdt020 - l_pmdu.pmdu010
                  END IF
                  
                  IF l_pmdu.pmdu010 = 0 THEN
                     CONTINUE FOREACH
                  END IF
              
                  #入庫、驗退單有QC單維護了庫儲批時，從QC單帶入
                  IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25' THEN
                     IF (NOT cl_null(l_pmdt081)) AND (NOT cl_null(l_pmdt082)) AND (NOT cl_null(l_pmdt016)) THEN
                        LET l_pmdu.pmdu006 = g_pmdt_d[l_ac].pmdt016
                        LET l_pmdu.pmdu007 = g_pmdt_d[l_ac].pmdt017
                        LET l_pmdu.pmdu008 = g_pmdt_d[l_ac].pmdt018
                     END IF
                  END IF
              
                  LET l_pmdu.pmdu013 = l_pmdu.pmdu010
                  IF NOT cl_null(l_pmdu.pmdu011) THEN
                     #CALL s_aimi190_get_convert(l_pmdu.pmdu001,l_pmdu.pmdu009,l_pmdu.pmdu011) RETURNING l_flag,l_rate
                     #LET l_pmdu.pmdu012 = l_pmdu.pmdu010 * l_rate   #計價數量
                     CALL s_aooi250_convert_qty(l_pmdu.pmdu001,l_pmdu.pmdu009,l_pmdu.pmdu011,l_pmdu.pmdu010)
                            RETURNING l_success,l_pmdu.pmdu012
                  ELSE
                     LET l_pmdu.pmdu012 = ''
                  END IF
                  LET l_pmdu.pmdu014 = 0
                  LET l_pmdu.pmdu015 = 0
                  
                  #160119-00002#1 add -----(S) 
                  #儲位、批號 若為空，給一個空格
                  IF cl_null(l_pmdu.pmdu007) THEN
                     LET l_pmdu.pmdu007 = ' '
                  END IF
                  IF cl_null(l_pmdu.pmdu008) THEN
                     LET l_pmdu.pmdu008 = ' '
                  END IF
                  #160119-00002#1 add -----(E)

                  #160512-00004#6-add-'pmdu219'、'l_pmdu.pmdu202'
                  INSERT INTO pmdu_t(pmduent,pmdusite,pmdudocno,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu003,pmdu004,
                                   pmdu005,pmdu006,pmdu007,pmdu008,pmdu009,pmdu010,pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,pmdu016,pmdu219,pmdu017)
                   VALUES(l_pmdu.pmduent,l_pmdu.pmdusite,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,l_pmdu.pmduseq1,l_pmdu.pmdu001,l_pmdu.pmdu002,
                          l_pmdu.pmdu003,l_pmdu.pmdu004,l_pmdu.pmdu005,l_pmdu.pmdu006,l_pmdu.pmdu007,l_pmdu.pmdu008,l_pmdu.pmdu009,
                          l_pmdu.pmdu010,l_pmdu.pmdu011,l_pmdu.pmdu012,l_pmdu.pmdu013,l_pmdu.pmdu014,l_pmdu.pmdu015,l_pmdu.pmdu016,l_pmdu.pmdu202,l_pmdu.pmdu017)
                  IF SQLCA.sqlcode THEN
                     LET r_success = FALSE
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "pmdu_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     RETURN r_success
                  END IF
                  #驗退、入庫、倉退單據，賦值來源單據的製造批序號資料inao_t
                  IF g_argv[1] MATCHES '[56]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' THEN
                     IF NOT s_apmt520_ins_inao('2',l_pmdu.pmdudocno,l_pmdu.pmduseq,l_pmdu.pmduseq1,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,l_pmdu.pmduseq1) THEN
                        LET r_success = FALSE
                        RETURN r_success
                     END IF
                  END IF
                  #驗退、入庫、倉退單據，賦值來源單據的製造批序號資料inao_t
                  IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
                     DECLARE sel_pmdt_cs2 CURSOR FOR
                         SELECT pmdtdocno,pmdtseq INTO l_pmdtdocno,l_pmdtseq_1 FROM pmdt_t,pmds_t
                            WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno 
                              AND pmdsent = g_enterprise 
                              AND ((pmds006 = g_pmds_m.pmds006 AND pmdt028 = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('6','12','13'))
                                 OR (pmdsdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028 AND pmds000 IN ('3','4','20'))) 
                              AND pmdsstus = 'S'
                     FOREACH sel_pmdt_cs2 INTO l_pmdtdocno,l_pmdtseq_1
                        IF NOT s_apmt520_ins_inao('2',l_pmdtdocno,l_pmdtseq_1,l_pmdu.pmduseq1,g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,l_pmdu.pmduseq1) THEN
                           LET r_success = FALSE
                           RETURN r_success
                        END IF
                     END FOREACH
                  END IF
                  
               END FOREACH
            END IF
         END IF
      END IF
      
      RETURN r_success

END FUNCTION

#單據類型為入庫類型 時，根據收貨單號自動產生 入庫單單身資料
PRIVATE FUNCTION apmt520_receipt_gen_pmdt()
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
DEFINE l_success     LIKE type_t.num5
   
     CALL s_apmt520_gen_pmdt('1',g_pmds_m.pmdsdocno,0,'1') RETURNING l_success
     
     #重新計算整單的未稅、含稅總金額
     CALL s_tax_recount(g_pmds_m.pmdsdocno)
       RETURNING g_pmds_m.pmds043,g_pmds_m.pmds046,g_pmds_m.pmds044,l_xrcd113,l_xrcd114,l_xrcd115
     UPDATE pmds_t SET pmds043 = g_pmds_m.pmds043,
                       pmds044 = g_pmds_m.pmds044,
                       pmds046 = g_pmds_m.pmds046
        WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
     
     #151124-00015#1-mod-(S)     
#     CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt 
     CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING l_success
     #151124-00015#1-mod-(E)
        
END FUNCTION

#根據料號帶初始值
PRIVATE FUNCTION apmt520_pmdt006_desc()
   DEFINE l_n         LIKE type_t.num5
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_controlno LIKE ooha_t.ooha001
   DEFINE l_imaf158   LIKE imaf_t.imaf158 
   #ming 20151012 add ----------(S) 
   DEFINE l_pmdt037   LIKE pmdt_t.pmdt037 
   #ming 20151012 add ----------(E) 

   LET l_n = 0
   #ming 20151012 modify ----------(S) 
   #LET g_pmdt_d[l_ac].pmdt019 = ''
   #LET g_pmdt_d[l_ac].pmdt019_desc = ''
   #LET g_pmdt_d[l_ac].pmdt023 = ''
   #LET g_pmdt_d[l_ac].pmdt023_desc = ''
   #委外採購收貨入庫的單身資料，因為單身資料都是從前端而來，所以到這時不應該被改變 
   IF g_argv[1] != '20' THEN 
      LET g_pmdt_d[l_ac].pmdt019 = ''
      LET g_pmdt_d[l_ac].pmdt019_desc = ''
      LET g_pmdt_d[l_ac].pmdt023 = ''
      LET g_pmdt_d[l_ac].pmdt023_desc = ''
   END IF 
   #ming 20151012 modify ----------(E)
   
   #LET g_pmdt_d[l_ac].pmdt016 = ''
   #LET g_pmdt_d[l_ac].pmdt016_desc = ''
   #LET g_pmdt_d[l_ac].pmdt017 = ''
   #LET g_pmdt_d[l_ac].pmdt017_desc = ''

   #ming 20151012 modify ----------(S) 
   #LET g_pmdt_d[l_ac].pmdt008 = ''
   #LET g_pmdt_d[l_ac].pmdt008_desc = ''
   #委外採購收貨入庫的單身資料，因為單身資料都是從前端而來，所以到這時不應該被改變 
   IF g_argv[1] != '20' THEN 
      LET g_pmdt_d[l_ac].pmdt008 = ''
      LET g_pmdt_d[l_ac].pmdt008_desc = ''
   END IF 
   #ming 20151012 modify ----------(E) 
      
   #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
   #LET l_controlno = ''
   #CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,l_controlno
   IF cl_null(g_controlno) THEN
      CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,g_controlno
   END IF
   #IF NOT cl_null(l_controlno) THEN
   IF NOT cl_null(g_controlno) THEN
      SELECT COUNT(1) INTO l_n 
        FROM pmap_t 
       WHERE pmapent  = g_enterprise 
         AND pmapsite = g_site 
         AND pmap001  = g_pmds_m.pmds007
         #AND pmap002 = l_controlno 
         AND pmap002  = g_controlno 
         AND pmap003  = g_pmdt_d[l_ac].pmdt006 
         AND pmap004  = g_pmdt_d[l_ac].pmdt007
      #若採購料件有設置'供應商控制組料件預設條件'(apmi121)時，則需將設置的預設條件值預設到採購單對應欄位
      IF l_n > 0 THEN 
         #ming 20151012 modify ------------------------------------(S) 
         #SELECT pmap006,pmap008,pmap010
         #  INTO g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt008
         #  FROM pmap_t 
         # WHERE pmapent = g_enterprise 
         #   AND pmapsite = g_site 
         #   AND pmap001 = g_pmds_m.pmds007
         #   #AND pmap002 = l_controlno 
         #   AND pmap002 = g_controlno 
         #   AND pmap003 = g_pmdt_d[l_ac].pmdt006 
         #   AND pmap004 = g_pmdt_d[l_ac].pmdt007 
         #委外採購收貨入庫的單身資料，因為單身資料都是從前端而來，所以到這時不應該被改變 
         IF g_argv[1] != '20' THEN 
            SELECT pmap006,pmap008,pmap010
              INTO g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt008
              FROM pmap_t 
             WHERE pmapent = g_enterprise 
               AND pmapsite = g_site 
               AND pmap001 = g_pmds_m.pmds007
               AND pmap002 = g_controlno 
               AND pmap003 = g_pmdt_d[l_ac].pmdt006 
               AND pmap004 = g_pmdt_d[l_ac].pmdt007 
         END IF 
         #ming 20151012 modify ------------------------------------(E) 
      END IF
   END IF
      
   #IF cl_null(l_controlno) OR l_n = 0 THEN 
   IF cl_null(g_controlno) OR l_n = 0 THEN       
      #沒有設置'供應商控制組料件預設條件'(apmi121)才改抓料件進銷存檔預設的條件
      #ming 20151012 modify ----------(S) 
      #SELECT imaf143,imaf144,imaf157
      #  INTO g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt008
      #  FROM imaf_t
      # WHERE imafent = g_enterprise 
      #   AND imafsite = g_site 
      #   AND imaf001 = g_pmdt_d[l_ac].pmdt006 
      #委外採購收貨入庫的單身資料，因為單身資料都是從前端而來，所以到這時不應該被改變 
      IF g_argv[1] != '20' THEN 
         SELECT imaf143,imaf144,imaf157
           INTO g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt008
           FROM imaf_t
          WHERE imafent = g_enterprise 
            AND imafsite = g_site 
            AND imaf001 = g_pmdt_d[l_ac].pmdt006 
      END IF 
      #ming 20151012 modify ----------(E) 
      #倉退時，如果庫位等欄位有值，則不帶入預設值
      #IF NOT (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' AND cl_null(g_pmdt_d[l_ac].pmdt016)) THEN
      #ming 20151012 modify ----------------------(S) 
      #IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
      IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
      #ming 20151012 modify ----------------------(E)  
         #ming 20151012 modify ---------------------------------(S) 
         #SELECT imaf091,imaf092
         #  INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017
         #  FROM imaf_t
         # WHERE imafent  = g_enterprise 
         #   AND imafsite = g_site 
         #   AND imaf001  = g_pmdt_d[l_ac].pmdt006 
         IF g_argv[1] != '20' THEN 
            SELECT imaf091,imaf092
              INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017
              FROM imaf_t
             WHERE imafent  = g_enterprise 
               AND imafsite = g_site 
               AND imaf001  = g_pmdt_d[l_ac].pmdt006 
         END IF 
         #ming 20151012 modify ---------------------------------(S) 
      END IF
      IF g_pmdt_d[l_ac].pmdt017 IS NULL THEN 
         #ming 20151012 modify -----------------------------(S) 
         #SELECT imaf092 INTO g_pmdt_d[l_ac].pmdt017
         #  FROM imaf_t
         # WHERE imafent = g_enterprise 
         #   AND imafsite = g_site 
         #   AND imaf001 = g_pmdt_d[l_ac].pmdt006 
         IF g_argv[1] != '20' THEN 
            SELECT imaf092 INTO g_pmdt_d[l_ac].pmdt017
              FROM imaf_t
             WHERE imafent = g_enterprise 
               AND imafsite = g_site 
               AND imaf001 = g_pmdt_d[l_ac].pmdt006 
         END IF 
         #ming 20151012 modify -----------------------------(E) 
      END IF
        
   END IF
      
   #委外收貨的庫位、儲位，應要帶工單指定入庫倉庫、儲位，如果工單沒指定，那應該帶料件的預設庫位、儲位
   #IF g_argv[1] MATCHES '[8]' THEN
      #預設料件的庫儲 
      IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN 
         #ming 20151012 modify -------------------------------------(S) 
         #SELECT imaf091,imaf092
         #  INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017
         #  FROM imaf_t
         # WHERE imafent = g_enterprise 
         #   AND imafsite = g_site 
         #   AND imaf001 = g_pmdt_d[l_ac].pmdt006
         #CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
         #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
         #  
         #CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) RETURNING g_pmdt_d[l_ac].pmdt017_desc
         #DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc 
         IF g_argv[1] != '20' THEN 
            SELECT imaf091,imaf092
              INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017
              FROM imaf_t
             WHERE imafent = g_enterprise 
               AND imafsite = g_site 
               AND imaf001 = g_pmdt_d[l_ac].pmdt006
            CALL s_desc_get_stock_desc(g_site,g_pmdt_d[l_ac].pmdt016) 
                 RETURNING g_pmdt_d[l_ac].pmdt016_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
              
            CALL s_desc_get_locator_desc(g_site,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) 
                 RETURNING g_pmdt_d[l_ac].pmdt017_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc 
         END IF 
         #ming 20151012 modify -------------------------------------(E) 
      END IF
      IF g_pmdt_d[l_ac].pmdt017 IS NULL THEN 
         #ming 20151012 modify ------------------------------(S) 
         #SELECT imaf092 INTO g_pmdt_d[l_ac].pmdt017
         #  FROM imaf_t
         # WHERE imafent = g_enterprise 
         #   AND imafsite = g_site 
         #   AND imaf001 = g_pmdt_d[l_ac].pmdt006
         IF g_argv[1] != '20' THEN 
            SELECT imaf092 INTO g_pmdt_d[l_ac].pmdt017
              FROM imaf_t
             WHERE imafent  = g_enterprise 
               AND imafsite = g_site 
               AND imaf001  = g_pmdt_d[l_ac].pmdt006
         END IF 
         #ming 20151012 modify ------------------------------(E) 
      END IF
   #END IF
      
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
      
   #若稅別應用為2.依料件設定，呼叫應用元件帶出稅別、稅率
   IF g_tax_app = '2' AND NOT cl_null(g_pmab039) THEN
      #依料件檢核是否有依交易分類設定稅別 
      #ming 20151012 modify ----------(S) 
      #CALL s_tax_chktype(g_pmds_m.pmdssite,g_pmds_m.pmds007,g_pmdt_d[l_ac].pmdt006,'1',g_pmab039)
      #     RETURNING l_success,g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt037      
      LET l_pmdt037 = '' 
      CALL s_tax_chktype(g_pmds_m.pmdssite,g_pmds_m.pmds007,g_pmdt_d[l_ac].pmdt006,'1',g_pmab039)
           RETURNING l_success,g_pmdt_d[l_ac].pmdt046,l_pmdt037 
      
      IF g_argv[1] != '20' THEN 
         LET g_pmdt_d[l_ac].pmdt037 = l_pmdt037 
      END IF 
      #ming 20151012 modify ----------(#) 
      IF l_success THEN
         CALL s_desc_get_tax_desc1(g_site,g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
      ELSE
         #檢查失敗時後續處理
         LET g_pmdt_d[l_ac].pmdt046 = ''
         LET g_pmdt_d[l_ac].pmdt046_desc = '' 
         #ming 20151012 modify ----------------(S) 
         #LET g_pmdt_d[l_ac].pmdt037 = ''
         IF g_argv[1] != '20' THEN 
            LET g_pmdt_d[l_ac].pmdt037 = ''
         END IF 
         #ming 20151012 modify ----------------(E) 
      END IF           
   ELSE
      LET g_pmdt_d[l_ac].pmdt046 = g_pmds_m.pmds033
      #ming 20151012 modify -------------(S) 
      #LET g_pmdt_d[l_ac].pmdt037 = g_pmds_m.pmds034
      IF g_argv[1] != '20' THEN 
         LET g_pmdt_d[l_ac].pmdt037 = g_pmds_m.pmds034
      END IF 
      #ming 20151012 modify -------------(E) 
   END IF             
   DISPLAY BY NAME g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt046_desc,g_pmdt_d[l_ac].pmdt037 
      
   #[C:備品率] = [T:料件進銷存檔].[C:採購備品率]  imaf165
   #[C:參考單位] = [T:料件進銷存檔][C:參考單位]   imaf015
   #若[T:料件進銷存檔].[C:接單拆解方式(採購)]的值為'1:自動CKD'或是'2:自動SKD'時，imaf158
   #則[C:子件特性]的值預設'2:CKD'或是'3:SKD' 
   #ming 20151012 modify -------------------(S) 
   #LET g_pmdt_d[l_ac].pmdt021 = ''
   #LET g_pmdt_d[l_ac].pmdt021_desc = ''
   #LET g_pmdt_d[l_ac].pmdt005 = '1' 
   IF g_argv[1] != '20' THEN 
      LET g_pmdt_d[l_ac].pmdt021 = ''
      LET g_pmdt_d[l_ac].pmdt021_desc = ''
      #apmt531的來源單據已經有設定子件特性了，所以在通過料號之後也不應該修改掉 
      LET g_pmdt_d[l_ac].pmdt005 = '1' 
   END IF 
   #ming 20151012 modify -------------------(E) 
   
   #ming 20151012 modify -------------------(S) 
   #LET l_imaf158 = ''
   #SELECT imaf158,imaf015 INTO l_imaf158,g_pmdt_d[l_ac].pmdt021 
   #  FROM imaf_t
   # WHERE imafent = g_enterprise 
   #   AND imafsite = g_site 
   #   AND imaf001 = g_pmdt_d[l_ac].pmdt006
   #IF l_imaf158 = '1' THEN
   #   LET g_pmdt_d[l_ac].pmdt005 = '2'
   #END IF
   #IF l_imaf158 = '2' THEN
   #   LET g_pmdt_d[l_ac].pmdt005 = '3'
   #END IF 
   
   IF g_argv[1] != '20' THEN 
      LET l_imaf158 = ''
      SELECT imaf158,imaf015 INTO l_imaf158,g_pmdt_d[l_ac].pmdt021 
        FROM imaf_t
       WHERE imafent = g_enterprise 
         AND imafsite = g_site 
         AND imaf001 = g_pmdt_d[l_ac].pmdt006
      IF l_imaf158 = '1' THEN
         LET g_pmdt_d[l_ac].pmdt005 = '2'
      END IF
      IF l_imaf158 = '2' THEN
         LET g_pmdt_d[l_ac].pmdt005 = '3'
      END IF 
   END IF 
   #ming 20151012 modify -------------------(E) 
      
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt021) RETURNING g_pmdt_d[l_ac].pmdt021_desc
      
   #整體參數使用採購計價單位時:
   #[C:計價單位]=[T:料件據點進銷存檔].[C:採購計價單位] 
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  
      #ming 20151012 modify ----------(S) 
      #SELECT imaf144 INTO g_pmdt_d[l_ac].pmdt023 
      #  FROM imaf_t
      # WHERE imafent = g_enterprise 
      #   AND imafsite = g_site 
      #   AND imaf001 = g_pmdt_d[l_ac].pmdt006
      IF g_argv[1] != '20' THEN 
         SELECT imaf144 INTO g_pmdt_d[l_ac].pmdt023 
           FROM imaf_t
          WHERE imafent = g_enterprise 
            AND imafsite = g_site 
            AND imaf001 = g_pmdt_d[l_ac].pmdt006
      END IF 
      #ming 20151012 modify ----------(E) 
   END IF
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
      
   CALL apmt520_get_qcap006()
      
END FUNCTION

#在收貨單上 直接產生入庫單
PRIVATE FUNCTION apmt520_gen_warehouse_voucher()
#161124-00048#11 mod-S
#DEFINE l_pmds_m      RECORD LIKE pmds_t.*
DEFINE l_pmds_m RECORD  #收貨/入庫單頭檔
       pmdsent LIKE pmds_t.pmdsent, #企業編號
       pmdssite LIKE pmds_t.pmdssite, #營運據點
       pmdsdocno LIKE pmds_t.pmdsdocno, #單據單號
       pmdsdocdt LIKE pmds_t.pmdsdocdt, #單據日期
       pmds000 LIKE pmds_t.pmds000, #單據性質
       pmds001 LIKE pmds_t.pmds001, #扣帳日期
       pmds002 LIKE pmds_t.pmds002, #申請人員
       pmds003 LIKE pmds_t.pmds003, #申請部門
       pmds006 LIKE pmds_t.pmds006, #來源單號
       pmds007 LIKE pmds_t.pmds007, #採購供應商
       pmds008 LIKE pmds_t.pmds008, #帳款供應商
       pmds009 LIKE pmds_t.pmds009, #送貨供應商
       pmds010 LIKE pmds_t.pmds010, #供應商送貨單號
       pmds011 LIKE pmds_t.pmds011, #採購性質
       pmds012 LIKE pmds_t.pmds012, #採購通路
       pmds013 LIKE pmds_t.pmds013, #採購分類
       pmds014 LIKE pmds_t.pmds014, #多角性質
       pmds021 LIKE pmds_t.pmds021, #LC進口
       pmds022 LIKE pmds_t.pmds022, #進口日期
       pmds023 LIKE pmds_t.pmds023, #進口報單
       pmds024 LIKE pmds_t.pmds024, #進口號碼
       pmds028 LIKE pmds_t.pmds028, #一次性交易對象識別碼
       pmds031 LIKE pmds_t.pmds031, #付款條件
       pmds032 LIKE pmds_t.pmds032, #交易條件
       pmds033 LIKE pmds_t.pmds033, #稅別
       pmds034 LIKE pmds_t.pmds034, #稅率
       pmds035 LIKE pmds_t.pmds035, #單價含稅否
       pmds036 LIKE pmds_t.pmds036, #交易類型
       pmds037 LIKE pmds_t.pmds037, #幣別
       pmds038 LIKE pmds_t.pmds038, #匯率
       pmds039 LIKE pmds_t.pmds039, #取價方式
       pmds040 LIKE pmds_t.pmds040, #付款優惠條件
       pmds041 LIKE pmds_t.pmds041, #多角序號
       pmds042 LIKE pmds_t.pmds042, #整合單號
       pmds043 LIKE pmds_t.pmds043, #採購總未稅金額
       pmds044 LIKE pmds_t.pmds044, #採購總含稅金額
       pmds045 LIKE pmds_t.pmds045, #備註
       pmds046 LIKE pmds_t.pmds046, #採購總稅額
       pmds047 LIKE pmds_t.pmds047, #多角貿易中斷點
       pmds048 LIKE pmds_t.pmds048, #內外購
       pmds049 LIKE pmds_t.pmds049, #匯率計算基準
       pmds050 LIKE pmds_t.pmds050, #多角貿易已拋轉
       pmds051 LIKE pmds_t.pmds051, #出貨單號
       pmds052 LIKE pmds_t.pmds052, #供應商出貨日
       pmds053 LIKE pmds_t.pmds053, #多角流程編號
       pmds081 LIKE pmds_t.pmds081, #取回日期
       pmds100 LIKE pmds_t.pmds100, #倉退方式
       pmds101 LIKE pmds_t.pmds101, #折讓日期
       pmds102 LIKE pmds_t.pmds102, #折讓原始發票
       pmdsownid LIKE pmds_t.pmdsownid, #資料所屬者
       pmdsowndp LIKE pmds_t.pmdsowndp, #資料所有部門
       pmdscrtid LIKE pmds_t.pmdscrtid, #資料建立者
       pmdscrtdp LIKE pmds_t.pmdscrtdp, #資料建立部門
       pmdscrtdt LIKE pmds_t.pmdscrtdt, #資料創建日
       pmdsmodid LIKE pmds_t.pmdsmodid, #資料修改者
       pmdsmoddt LIKE pmds_t.pmdsmoddt, #最近修改日
       pmdscnfid LIKE pmds_t.pmdscnfid, #資料確認者
       pmdscnfdt LIKE pmds_t.pmdscnfdt, #資料確認日
       pmdspstid LIKE pmds_t.pmdspstid, #資料過帳者
       pmdspstdt LIKE pmds_t.pmdspstdt, #資料過帳日
       pmdsstus LIKE pmds_t.pmdsstus, #狀態碼
       pmds200 LIKE pmds_t.pmds200, #收貨預約單號
       pmds054 LIKE pmds_t.pmds054, #資料來源
       pmds055 LIKE pmds_t.pmds055, #來源單號
       pmds201 LIKE pmds_t.pmds201, #來源單號
       pmds202 LIKE pmds_t.pmds202, #來源類型
       pmdsunit LIKE pmds_t.pmdsunit, #應用執行組織物件
       pmds056 LIKE pmds_t.pmds056, #No use
       pmds057 LIKE pmds_t.pmds057, #整合來源
       pmds058 LIKE pmds_t.pmds058, #倒扣領料單號
       pmds103 LIKE pmds_t.pmds103 #折讓證明單開立方式
#       pmds025 LIKE pmds_t.pmds025  #保稅異動原因代碼
END RECORD
#161124-00048#11 mod-E
DEFINE l_success     LIKE type_t.num5
DEFINE l_oobn003     LIKE oobn_t.oobn003
DEFINE ls_sql        STRING
DEFINE l_pmdscrtdt   DATETIME YEAR TO SECOND
DEFINE l_pmdtseq     LIKE pmdt_t.pmdtseq
DEFINE l_n           LIKE type_t.num10
DEFINE l_prog        LIKE type_t.chr20     #作業編號 (gzzz001)
#161124-00048#11 mod-S
#DEFINE l_pmdt_s      RECORD LIKE pmdt_t.*   #來源單據 收貨單
#DEFINE l_pmdt_p      RECORD LIKE pmdt_t.*   #目的單據 入庫單
DEFINE l_pmdt_s RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
DEFINE l_pmdt_p RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
#161124-00048#11 mod-E
DEFINE l_xrcd104     LIKE xrcd_t.xrcd104
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
DEFINE l_rate        LIKE inaj_t.inaj014
DEFINE l_flag        LIKE type_t.num5
DEFINE l_pmdt020     LIKE pmdt_t.pmdt020
DEFINE r_success     LIKE type_t.num5
DEFINE l_n1          LIKE type_t.num10
DEFINE l_n2          LIKE type_t.num10

    LET r_success = TRUE
    
    IF g_pmds_m.pmdsdocno IS NULL  THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "" 
       LET g_errparam.code   = "std-00003" 
       LET g_errparam.popup  = FALSE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    IF g_pmds_m.pmdsstus <> 'Y' THEN
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #存在允收數量 > 0的單身
    #料件需QC時，允收數量- 已入庫數量 > 0
    #料件不走QC時，收貨數量（允收數量） - 已入庫量 - 已驗退量 > 0
    LET l_n1 = 0
    SELECT COUNT(1) INTO l_n1 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt053 - pmdt054 - pmdt055 ) > 0 AND pmdt026 = 'N'

    LET l_n2 = 0
    SELECT COUNT(1) INTO l_n2 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt053 - pmdt054 ) > 0 AND pmdt026 = 'Y'
    
    IF (l_n1 = 0 OR cl_null(l_n1)) AND (l_n2 = 0 OR cl_null(l_n2)) THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = g_pmds_m.pmdsdocno
       LET g_errparam.code   = 'apm-00630'
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    CALL s_transaction_begin()
   
    OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
    IF STATUS THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "OPEN apmt520_cl:" 
       LET g_errparam.code   = STATUS 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    IF NOT s_apmt520_gen_pmds('1',g_pmds_m.pmdsdocno) THEN
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    CALL s_transaction_end('Y','0')
    #INITIALIZE g_errparam TO NULL
    #LET g_errparam.code = 'apm-00596'
    #LET g_errparam.extend = ''
    #LET g_errparam.popup = TRUE
    #LET g_errparam.replace[1] = l_pmds_m.pmdsdocno
    #CALL cl_err()

    RETURN r_success
    
END FUNCTION

################################################################################
# Descriptions...: 依據取價方式抓取採購單價
# Memo...........:
# Usage..........: CALL apmt520_get_price()
# Date & Author..: 2014/08/13 By lixiang
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_get_price()
DEFINE l_pmdn042  LIKE pmdn_t.pmdn042

     IF cl_null(g_pmdt_d[l_ac].pmdt023) OR cl_null(g_pmdt_d[l_ac].pmdt024) THEN 
        LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d[l_ac].pmdt019
        LET g_pmdt_d[l_ac].pmdt024 = g_pmdt_d[l_ac].pmdt020
     END IF
     IF (NOT cl_null(g_pmds_m.pmds039)) AND (NOT cl_null(g_pmds_m.pmds007)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt006)) AND
        (NOT cl_null(g_pmds_m.pmds037)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt046)) AND (NOT cl_null(g_pmds_m.pmds031)) AND 
        (NOT cl_null(g_pmds_m.pmds032)) AND (NOT cl_null(g_pmds_m.pmds012)) AND (NOT cl_null(g_pmds_m.pmdsdocno)) AND
        (NOT cl_null(g_pmds_m.pmdsdocdt)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt023)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt024)) THEN
      
        CALL s_purchase_price_get(g_pmds_m.pmds039,g_pmds_m.pmds007,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                                  g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt046,g_pmds_m.pmds031,g_pmds_m.pmds032,
                                  g_pmds_m.pmds012,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdt023,
                                  g_pmdt_d[l_ac].pmdt024,g_site,g_pmds_m.pmds048,'1',g_pmdt_d[l_ac].pmdt009,
                                  g_pmdt_d[l_ac].pmdt010)          
              RETURNING g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt048
        
        #呼叫幣別取位應用元件對單價作取位(依單頭幣別做取位基準)
        CALL s_curr_round(g_site,g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt044,'1') RETURNING g_pmdt_d[l_ac].pmdt044
        
        LET g_pmdt_d[l_ac].pmdt036 = g_pmdt_d[l_ac].pmdt044
        LET g_pmdt_d[l_ac].pmdt045 = 0
        
        DISPLAY BY NAME g_pmdt_d[l_ac].pmdt042,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt043,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt045,g_pmdt_d[l_ac].pmdt048
     END IF                   
                     
END FUNCTION

#獲得料件是否檢驗
PRIVATE FUNCTION apmt520_get_qcap006()
DEFINE l_sql   STRING

      LET g_pmdt_d[l_ac].pmdt026 = ''
      LET l_sql = " SELECT qcap006 FROM qcap_t ",
                 " WHERE qcapent = '",g_enterprise,"' ",
                 "  AND qcapsite = '",g_site,"' ",
                 "  AND qcap001 = '",g_pmdt_d[l_ac].pmdt006,"' ",
                 "  AND qcap002 = '",g_pmds_m.pmds007,"' "
                 
      IF g_pmdt_d[l_ac].pmdt007 IS NOT NULL THEN
         LET l_sql = l_sql ," AND ( qcap005 = '",g_pmdt_d[l_ac].pmdt007,"' OR qcap005 = 'ALL') "
      END IF
      IF (NOT cl_null(g_pmdt_d[l_ac].pmdt009)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdt010)) THEN
         LET l_sql = l_sql ," AND ( qcap003 = '",g_pmdt_d[l_ac].pmdt009,"' OR qcap003 = 'ALL') AND qcap004 = '",g_pmdt_d[l_ac].pmdt010,"' "
      END IF
      
      PREPARE get_qcap FROM l_sql
      EXECUTE get_qcap INTO g_pmdt_d[l_ac].pmdt026
      FREE get_qcap
      
      IF cl_null(g_pmdt_d[l_ac].pmdt026) THEN
         #若沒有維護aqci050,再從aqci040中帶值
         SELECT imae114 INTO g_pmdt_d[l_ac].pmdt026 FROM imae_t 
             WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_pmdt_d[l_ac].pmdt006
             
      END IF
      
      IF cl_null(g_pmdt_d[l_ac].pmdt026) THEN
         LET g_pmdt_d[l_ac].pmdt026 = 'N'
      END IF
      
      #直接收貨入庫時，無需檢驗
      IF g_argv[1] MATCHES '[34]' OR g_argv[1] = '24' OR g_argv[1] = '20' THEN
         LET g_pmdt_d[l_ac].pmdt026 = 'N'
      END IF
        
      #130909-00003#58--add--begin---        
      #拆件主件之後產生入庫單後，不入庫存(要寫入庫存異動檔，但異動加減項為0)，因此檢驗否=N，只做計價使用
      IF g_argv[1] MATCHES '[8]' OR g_argv[1] = '20' OR g_pmdt_d[l_ac].pmdt005 = '10' THEN
         LET g_pmdt_d[l_ac].pmdt026 = 'N'
      END IF
      #130909-00003#58--add--end---     
END FUNCTION

#修改單價
PRIVATE FUNCTION apmt520_upd_price()
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
DEFINE l_n           LIKE type_t.num5
DEFINE l_cmd         LIKE type_t.chr1
DEFINE l_pmdt039     LIKE pmdt_t.pmdt039
DEFINE l_pmdt090     LIKE pmdt_t.pmdt090
DEFINE l_success     LIKE type_t.num5    #151124-00015#1-add

   #當前在查詢方案頁簽時，直接返回，否則程式可能會當出
   IF g_main_hidden THEN
      RETURN
   END IF
   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
 
      RETURN
   END IF
   
   #160804-00005#1---s
   #单身无资料时，直接return
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
   IF l_n = 0 OR cl_null(l_n) THEN
      RETURN
   END IF
   #160804-00005#1---e

   #CALL apmt520_show()  #160804-00005#1
   
   #CALL cl_set_comp_visible("pmdtseq,pmdt001_1,pmdt002_1,pmdt003_1,pmdt004_1,pmdt049,pmdt050,pmdt005_1,pmdt006_1,imaal003_1,imaal004_4,
   #                          pmdt007_1,pmdt007_1_desc,pmdt009_1,pmdt010_1,pmdt019_1,pmdt019_desc1,pmdt020_1,pmdt023_1,pmdt023_desc1,
   #                          pmdt024_1,pmdt040_1,pmdt036,pmdt046,pmdt046_desc1,pmdt037,pmdt038,pmdt039,pmdt047,pmdt092,pmdt093",TRUE)
   #
   
   #借貨歸還單才顯示借貨還價數量、金額等，其他作業不顯示
   IF g_argv[1] = '26' THEN
       CALL cl_set_comp_visible("pmdt092,pmdt093",TRUE)
   END IF
   
   CALL cl_set_comp_visible("page_7",TRUE)
   
   IF g_upd_price = FALSE THEN
      RETURN
   END IF
   
   #倉退單可以維護發票代碼、發票號碼等信息
   IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
      #CALL cl_set_comp_entry("pmdt049,pmdt050,pmdt036",TRUE)    #160804-00005#1
      CALL cl_set_comp_entry("pmdt049_1,pmdt050_1,pmdt036",TRUE) #160804-00005#1
   ELSE
      CALL cl_set_comp_entry("pmdt036",TRUE)
      
      CALL cl_set_comp_entry("pmdt049_1,pmdt050_1",FALSE) #160804-00005#1
   END IF
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      INPUT ARRAY g_pmdt4_d FROM s_detail4.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = FALSE, 
                  DELETE ROW = FALSE,
                  APPEND ROW = FALSE)

         BEFORE INPUT
            CALL apmt520_b4_fill()
            LET g_rec_b4 = g_pmdt4_d.getLength()
            
         BEFORE ROW
            CALL s_transaction_begin()
            LET g_rec_b4 = g_pmdt4_d.getLength()
            LET l_ac4 = ARR_CURR()
            LET g_detail_idx = l_ac4
            
            LET l_n = ARR_COUNT()
            
            OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt520_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
            
               CLOSE apmt520_cl
               RETURN
            END IF
            
            IF g_rec_b4 >= l_ac4 
               AND g_pmdt4_d[l_ac4].pmdtseq IS NOT NULL THEN
               LET l_cmd='u'
               LET g_pmdt4_d_t.* = g_pmdt4_d[l_ac4].*  #BACKUP
               LET g_pmdt4_d_o.* = g_pmdt4_d[l_ac4].*  #BACKUP
            END IF
            
            #倉退是先抓收貨單自行輸入的發票號碼，抓不到，再抓isam的
            IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
               IF cl_null(g_pmdt4_d[l_ac4].pmdt050) THEN 
                  CALL apmt520_get_invoice_num(g_pmds_m.pmdsdocno,g_pmdt4_d[l_ac4].pmdtseq,g_pmds_m.pmds006,g_pmdt_d[l_ac4].pmdt028) RETURNING g_pmdt4_d[l_ac4].pmdt049,g_pmdt4_d[l_ac4].pmdt050
                  DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt049,g_pmdt4_d[l_ac4].pmdt050
               END IF
            END IF
            
          AFTER FIELD pmdt050 
            IF NOT cl_null(g_pmdt4_d[l_ac4].pmdt050) THEN
               IF NOT apmt520_chk_pmdt050(g_pmds_m.pmdsdocno,g_pmdt4_d[l_ac4].pmdtseq,g_pmdt4_d[l_ac4].pmdt038,g_pmdt4_d[l_ac4].pmdt050) THEN
                  LET g_pmdt4_d[l_ac4].pmdt050 = g_pmdt4_d_o.pmdt050
                  NEXT FIELD CURRENT
               END IF
               DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt050
            END IF

            LET g_pmdt4_d_o.pmdt050 = g_pmdt4_d[l_ac4].pmdt050
           
          
          AFTER FIELD pmdt036
             IF NOT cl_ap_chk_range(g_pmdt4_d[l_ac4].pmdt036,"0.000","1","","","azz-00079",1) THEN
                LET g_pmdt4_d[l_ac4].pmdt036 = g_pmdt4_d_o.pmdt036
                NEXT FIELD pmdt036
             END IF
             IF NOT cl_null(g_pmdt4_d[l_ac4].pmdt036) THEN
                IF g_pmdt4_d[l_ac4].pmdt036 <> g_pmdt4_d_o.pmdt036 OR cl_null(g_pmdt4_d_o.pmdt036) THEN
                   CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt4_d[l_ac4].pmdtseq,'',g_pmdt4_d[l_ac4].pmdt024,g_pmdt4_d[l_ac4].pmdt036,g_pmdt4_d[l_ac4].pmdt046)
                     RETURNING g_pmdt4_d[l_ac4].pmdt038,g_pmdt4_d[l_ac4].pmdt047,g_pmdt4_d[l_ac4].pmdt039
                   IF g_pmdt4_d[l_ac4].pmdt005 = '9' AND g_pmdt4_d[l_ac4].pmdt036 <> 0 THEN  #樣品
                      INITIALIZE g_errparam TO NULL 
                      LET g_errparam.extend = '' 
                      LET g_errparam.code   = 'apm-00621'
                      LET g_errparam.popup  = TRUE 
                      CALL cl_err()
                      LET g_pmdt4_d[l_ac4].pmdt036 = g_pmdt4_d_o.pmdt036
                      NEXT FIELD pmdt036
                   END IF
                   
                   IF g_argv[01] = '26' THEN
                      SELECT pmdt090 INTO l_pmdt090 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt4_d[l_ac4].pmdtseq
                      IF cl_null(l_pmdt090) THEN
                         LET l_pmdt090 = 0
                      END IF
                      CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,g_pmdt4_d[l_ac4].pmdtseq,'',g_pmdt_d[l_ac].pmdt090,g_pmdt4_d[l_ac4].pmdt036,g_pmdt4_d[l_ac4].pmdt046)
                          RETURNING g_pmdt4_d[l_ac4].pmdt092,l_pmdt039,g_pmdt4_d[l_ac4].pmdt093
                     END IF
                     DISPLAY BY NAME g_pmdt4_d[l_ac4].pmdt092,g_pmdt4_d[l_ac4].pmdt093
                     
                END IF
             END IF
             LET g_pmdt4_d_o.pmdt036 = g_pmdt4_d[l_ac4].pmdt036
             
          ON ROW CHANGE
             IF INT_FLAG THEN
                INITIALIZE g_errparam TO NULL 
                LET g_errparam.extend = '' 
                LET g_errparam.code   = 9001 
                LET g_errparam.popup  = FALSE 
                CALL cl_err()
             
                LET INT_FLAG = 0
                LET g_pmdt4_d[l_ac4].* = g_pmdt4_d_t.*
                CALL s_transaction_end('N','0')
                EXIT DIALOG 
             END IF
             
             IF cl_null(g_pmdt4_d[l_ac4].pmdt092) THEN
                LET g_pmdt4_d[l_ac4].pmdt092 = 0
             END IF
             IF cl_null(g_pmdt4_d[l_ac4].pmdt093) THEN
                LET g_pmdt4_d[l_ac4].pmdt093 = 0
             END IF
             UPDATE pmdt_t SET pmdt049 = g_pmdt4_d[l_ac4].pmdt049,
                               pmdt050 = g_pmdt4_d[l_ac4].pmdt050,
                               pmdt036 = g_pmdt4_d[l_ac4].pmdt036,
                               pmdt038 = g_pmdt4_d[l_ac4].pmdt038,
                               pmdt047 = g_pmdt4_d[l_ac4].pmdt047,
                               pmdt039 = g_pmdt4_d[l_ac4].pmdt039,
                               pmdt092 = g_pmdt4_d[l_ac4].pmdt092,
                               pmdt093 = g_pmdt4_d[l_ac4].pmdt093
                WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdtseq = g_pmdt4_d[l_ac4].pmdtseq
                
             IF SQLCA.sqlcode THEN
                INITIALIZE g_errparam TO NULL 
                LET g_errparam.extend = "pmdt_t" 
                LET g_errparam.code   = SQLCA.sqlcode 
                LET g_errparam.popup  = TRUE 
                CALL cl_err()                   
                CALL s_transaction_end('N','0')
                LET g_pmdt4_d[l_ac4].* = g_pmdt4_d_t.*  
             END IF
            
          AFTER ROW
             CLOSE apmt520_cl
             CALL s_transaction_end('Y','0')
             
      END INPUT
      
      ON ACTION accept    
         ACCEPT DIALOG
         
      ON ACTION cancel      #在dialog button (放棄)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
      
   END DIALOG 

   #重新計算整單的未稅、含稅總金額
   IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
      CALL s_transaction_begin()
      CALL s_tax_recount(g_pmds_m.pmdsdocno)
        RETURNING g_pmds_m.pmds043,g_pmds_m.pmds046,g_pmds_m.pmds044,l_xrcd113,l_xrcd114,l_xrcd115
      UPDATE pmds_t SET pmds043 = g_pmds_m.pmds043,
                        pmds044 = g_pmds_m.pmds044,
                        pmds046 = g_pmds_m.pmds046
          WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
          
#      CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt #151124-00015#1-mark
      
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
      ELSE
         #
#         CALL s_transaction_end('Y','0')
         CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING l_success
         IF l_success THEN
            CALL s_transaction_end('Y','0')
         ELSE
            CALL s_transaction_end('N','0')
         END IF
      END IF
   END IF   
      
   CALL cl_set_comp_entry("pmdt049,pmdt050,pmdt036",FALSE)
   
   CLOSE apmt520_cl
   LET INT_FLAG = FALSE
   CALL apmt520_b_fill()
   
END FUNCTION

#根據倉退單 產生新的採購單
PRIVATE FUNCTION apmt520_gen_purchase()
DEFINE l_success     LIKE type_t.num5
DEFINE l_pmdldocno   LIKE pmdl_t.pmdldocno
DEFINE l_n           LIKE type_t.num5
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
DEFINE l_pmdl040     LIKE pmdl_t.pmdl040
DEFINE l_pmdl041     LIKE pmdl_t.pmdl041
DEFINE l_pmdl042     LIKE pmdl_t.pmdl042

    IF g_pmds_m.pmdsdocno IS NULL  THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "" 
       LET g_errparam.code   = "std-00003" 
       LET g_errparam.popup  = FALSE 
       CALL cl_err()
       RETURN
    END IF
    
    LET l_n = 0
    SELECT COUNT(1) INTO l_n FROM pmdl_t 
       WHERE pmdlent = g_enterprise AND pmdl008 = g_pmds_m.pmdsdocno AND pmdl007 = '7' 
         AND (pmdlstus = 'N' OR pmdlstus = 'D' OR pmdlstus = 'R')
    
    IF l_n > 0 THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = g_pmds_m.pmdsdocno
       LET g_errparam.code   = 'apm-00611'
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       RETURN
    END IF
    
    LET g_pmdldocno = ''
    
    CALL s_transaction_begin()
   
    OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
    IF STATUS THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "OPEN apmt520_cl:" 
       LET g_errparam.code   = STATUS 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       RETURN
    END IF
    
    CALL apmt520_gen_purchase_pmdl() RETURNING l_success,l_pmdldocno
    #IF NOT l_success THEN  #160810-00014#1
    IF (NOT l_success) OR cl_null(l_pmdldocno) THEN  #160810-00014#1
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       RETURN
    END IF
    
    IF NOT apmt520_gen_purchase_pmdn(l_pmdldocno) THEN
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       RETURN
    END IF
    
    #重新計算整單的未稅、含稅總金額
    CALL s_tax_recount(l_pmdldocno)
      RETURNING l_pmdl040,l_pmdl042,l_pmdl041,l_xrcd113,l_xrcd114,l_xrcd115
    UPDATE pmdl_t SET pmdl040 = l_pmdl040,
                      pmdl042 = l_pmdl042,
                      pmdl041 = l_pmdl041
      WHERE pmdlent = g_enterprise AND pmdldocno = l_pmdldocno
    
    #151124-00015#1-mod-(S)    
#    CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt
    CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING l_success
    #151124-00015#1-mod-(E)
    
    CALL s_transaction_end('Y','0')
    INITIALIZE g_errparam TO NULL
    LET g_errparam.code = 'apm-00613'
    LET g_errparam.extend = ''
    LET g_errparam.popup = TRUE
    LET g_errparam.replace[1] = l_pmdldocno
    CALL cl_err()
    
    LET g_pmdldocno = l_pmdldocno
    
    CLOSE apmt520_cl
    CALL s_transaction_end('Y','0')
    
END FUNCTION

#根據倉退單，產生採購單頭資料
PRIVATE FUNCTION apmt520_gen_purchase_pmdl()
#161124-00048#11 mod-S
#DEFINE l_pmdl_m      RECORD LIKE pmdl_t.*
DEFINE l_pmdl_m RECORD  #採購單頭檔
       pmdlent LIKE pmdl_t.pmdlent, #企业编号
       pmdlsite LIKE pmdl_t.pmdlsite, #营运据点
       pmdlunit LIKE pmdl_t.pmdlunit, #应用组织
       pmdldocno LIKE pmdl_t.pmdldocno, #采购单号
       pmdldocdt LIKE pmdl_t.pmdldocdt, #采购日期
       pmdl001 LIKE pmdl_t.pmdl001, #版次
       pmdl002 LIKE pmdl_t.pmdl002, #采购人员
       pmdl003 LIKE pmdl_t.pmdl003, #采购部门
       pmdl004 LIKE pmdl_t.pmdl004, #供应商编号
       pmdl005 LIKE pmdl_t.pmdl005, #采购性质
       pmdl006 LIKE pmdl_t.pmdl006, #多角性质
       pmdl007 LIKE pmdl_t.pmdl007, #数据源类型
       pmdl008 LIKE pmdl_t.pmdl008, #来源单号
       pmdl009 LIKE pmdl_t.pmdl009, #付款条件
       pmdl010 LIKE pmdl_t.pmdl010, #交易条件
       pmdl011 LIKE pmdl_t.pmdl011, #税种
       pmdl012 LIKE pmdl_t.pmdl012, #税率
       pmdl013 LIKE pmdl_t.pmdl013, #单价含税否
       pmdl015 LIKE pmdl_t.pmdl015, #币种
       pmdl016 LIKE pmdl_t.pmdl016, #汇率
       pmdl017 LIKE pmdl_t.pmdl017, #取价方式
       pmdl018 LIKE pmdl_t.pmdl018, #付款优惠条件
       pmdl019 LIKE pmdl_t.pmdl019, #纳入APS计算
       pmdl020 LIKE pmdl_t.pmdl020, #运送方式
       pmdl021 LIKE pmdl_t.pmdl021, #付款供应商
       pmdl022 LIKE pmdl_t.pmdl022, #送货供应商
       pmdl023 LIKE pmdl_t.pmdl023, #采购分类一
       pmdl024 LIKE pmdl_t.pmdl024, #采购分类二
       pmdl025 LIKE pmdl_t.pmdl025, #送货地址
       pmdl026 LIKE pmdl_t.pmdl026, #账款地址
       pmdl027 LIKE pmdl_t.pmdl027, #供应商连络人
       pmdl028 LIKE pmdl_t.pmdl028, #一次性交易对象识别码
       pmdl029 LIKE pmdl_t.pmdl029, #收货部门
       pmdl030 LIKE pmdl_t.pmdl030, #多角贸易已抛转
       pmdl031 LIKE pmdl_t.pmdl031, #多角序号
       pmdl032 LIKE pmdl_t.pmdl032, #最终客户
       pmdl033 LIKE pmdl_t.pmdl033, #发票类型
       pmdl040 LIKE pmdl_t.pmdl040, #采购总税前金额
       pmdl041 LIKE pmdl_t.pmdl041, #采购总含税金额
       pmdl042 LIKE pmdl_t.pmdl042, #采购总税额
       pmdl043 LIKE pmdl_t.pmdl043, #留置原因
       pmdl044 LIKE pmdl_t.pmdl044, #备注
       pmdl046 LIKE pmdl_t.pmdl046, #预付款发票开立方式
       pmdl047 LIKE pmdl_t.pmdl047, #物流结案
       pmdl048 LIKE pmdl_t.pmdl048, #账流结案
       pmdl049 LIKE pmdl_t.pmdl049, #金流结案
       pmdl050 LIKE pmdl_t.pmdl050, #多角最终站否
       pmdl051 LIKE pmdl_t.pmdl051, #多角流程编号
       pmdl052 LIKE pmdl_t.pmdl052, #最终供应商
       pmdl053 LIKE pmdl_t.pmdl053, #两角目的据点
       pmdl054 LIKE pmdl_t.pmdl054, #内外购
       pmdl055 LIKE pmdl_t.pmdl055, #汇率计算基准
       pmdl200 LIKE pmdl_t.pmdl200, #采购中心
       pmdl201 LIKE pmdl_t.pmdl201, #联络电话
       pmdl202 LIKE pmdl_t.pmdl202, #传真号码
       pmdl203 LIKE pmdl_t.pmdl203, #采购方式
       pmdl204 LIKE pmdl_t.pmdl204, #配送中心
       pmdl900 LIKE pmdl_t.pmdl900, #保留字段str
       pmdl999 LIKE pmdl_t.pmdl999, #保留字段end
       pmdlownid LIKE pmdl_t.pmdlownid, #资料所有者
       pmdlowndp LIKE pmdl_t.pmdlowndp, #资料所有部门
       pmdlcrtid LIKE pmdl_t.pmdlcrtid, #资料录入者
       pmdlcrtdp LIKE pmdl_t.pmdlcrtdp, #资料录入部门
       pmdlcrtdt LIKE pmdl_t.pmdlcrtdt, #资料创建日
       pmdlmodid LIKE pmdl_t.pmdlmodid, #资料更改者
       pmdlmoddt LIKE pmdl_t.pmdlmoddt, #最近更改日
       pmdlcnfid LIKE pmdl_t.pmdlcnfid, #资料审核者
       pmdlcnfdt LIKE pmdl_t.pmdlcnfdt, #数据审核日
       pmdlpstid LIKE pmdl_t.pmdlpstid, #资料过账者
       pmdlpstdt LIKE pmdl_t.pmdlpstdt, #资料过账日
       pmdlstus LIKE pmdl_t.pmdlstus, #状态码
       pmdl205 LIKE pmdl_t.pmdl205, #采购最终有效日
       pmdl206 LIKE pmdl_t.pmdl206, #长效期订单否
       pmdl207 LIKE pmdl_t.pmdl207, #所属品类
       pmdl208 LIKE pmdl_t.pmdl208  #电子采购单号
END RECORD
#161124-00048#11 mod-E
DEFINE l_success     LIKE type_t.num5
DEFINE r_success     LIKE type_t.num5
DEFINE l_oobn003     LIKE oobn_t.oobn003
DEFINE ls_sql        STRING
DEFINE l_pmdlcrtdt   DATETIME YEAR TO SECOND
DEFINE l_pmdnseq     LIKE pmdn_t.pmdnseq
DEFINE l_n           LIKE type_t.num5
DEFINE l_prog        LIKE type_t.chr20     #作業編號 (gzzz001)
DEFINE l_ooef016     LIKE ooef_t.ooef016
DEFINE l_scc40       LIKE type_t.chr2
DEFINE l_oodbl004    LIKE oodbl_t.oodbl004  #稅別名稱
DEFINE l_oodb005     LIKE oodb_t.oodb005    #含稅否
DEFINE l_oodb006     LIKE oodb_t.oodb006    #稅率 
DEFINE l_oodb011     LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定

    LET r_success = TRUE
    
    IF g_argv[1] MATCHES '[7]' THEN
       LET l_prog = "apmt500"
    END IF
    IF g_argv[1] = '14' THEN
       LET l_prog = "apmt501"
    END IF
    IF g_argv[1] = '15' THEN
       LET l_prog = "apmt502"
    END IF
    
    #根據收貨單別 ，獲取後置入庫單別
    CALL s_aooi210_get_doc(g_site,'','4',g_pmds_m.pmdsdocno,l_prog,'') RETURNING l_success,l_oobn003
    IF NOT l_success THEN
       CALL s_transaction_end('N','0')
       #160810-00014#1--s
       #RETURN
       LET r_success = FALSE  
       RETURN r_success,l_pmdl_m.pmdldocno
       #160810-00014#1--e
    END IF
    
    CALL s_aooi200_gen_docno(g_site,l_oobn003,g_today,l_prog) RETURNING l_success,l_pmdl_m.pmdldocno
    IF NOT l_success THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = 'apm-00003'
       LET g_errparam.extend = l_pmdl_m.pmdldocno
       LET g_errparam.popup = TRUE
       CALL cl_err()
       CALL s_transaction_end('N','0')
       #160810-00014#1--s
       #RETURN
       LET r_success = FALSE  
       RETURN r_success,l_pmdl_m.pmdldocno
       #160810-00014#1--e
    END IF

    LET l_pmdl_m.pmdlownid = g_user
    LET l_pmdl_m.pmdlowndp = g_dept
    LET l_pmdl_m.pmdlcrtid = g_user
    LET l_pmdl_m.pmdlcrtdp = g_dept 
    LET l_pmdlcrtdt = cl_get_current()
    LET l_pmdl_m.pmdlmodid = ""
    LET l_pmdl_m.pmdlmoddt = ""
    LET l_pmdl_m.pmdlstus = "N"
    
    
    LET l_pmdl_m.pmdldocdt = g_today
    LET l_pmdl_m.pmdl001 = 0
    LET l_pmdl_m.pmdl002 = g_user
    LET l_pmdl_m.pmdl003 = g_dept
    LET l_pmdl_m.pmdl004 = g_pmds_m.pmds007
    
    LET l_pmdl_m.pmdl013 = "N"
    LET l_pmdl_m.pmdl019 = "Y"
    LET l_pmdl_m.pmdl054 = "1"
    LET l_pmdl_m.pmdl055 = "1"
    LET l_pmdl_m.pmdl030 = "N"
    LET l_pmdl_m.pmdl042 = "0"
    LET l_pmdl_m.pmdl047 = "N"
    LET l_pmdl_m.pmdl048 = "N"
    LET l_pmdl_m.pmdl049 = "N"
    LET l_pmdl_m.pmdl046 = "1"
    LET l_pmdl_m.pmdl040 = "0"
    LET l_pmdl_m.pmdl041 = "0"
      
    
    #當倉退方式為'2'時產生的採購單的採購性質為'6:換貨採購單'，當倉退方式為'3'時，產生的採購單的採購性質為'1:一般採購'
    #原方式 2：仓退换货（与帐款无关） 選項已取消
    #IF g_pmds_m.pmds100 = '2' THEN
    #   LET l_pmdl_m.pmdl005 = '6'
    #END IF
    IF g_pmds_m.pmds100 = '3' THEN
       LET l_pmdl_m.pmdl005 = '1'
    END IF
    
    LET l_pmdl_m.pmdl006 = '1'
    LET l_pmdl_m.pmdl007 = '7'  #倉退單
    LET l_pmdl_m.pmdl008 = g_pmds_m.pmdsdocno
    
    #抓取交易對象聯絡人明細檔的聯絡對像識別碼顯示在採購單上的[C:供應商連絡人]，
    #若有設置多個聯絡人時，則取有勾選主要聯絡人的那一個
    SELECT pmaj002 INTO l_pmdl_m.pmdl027 FROM pmaj_t WHERE pmajent = g_enterprise AND pmaj001 = l_pmdl_m.pmdl004 AND pmajstus = 'Y' AND pmaj004 = 'Y'
    IF cl_null(l_pmdl_m.pmdl022) THEN
       SELECT pmaj002 INTO l_pmdl_m.pmdl027 FROM pmaj_t WHERE pmajent = g_enterprise AND pmaj001 = l_pmdl_m.pmdl004 AND pmajstus = 'Y' AND pmaj004 = 'Y' AND rownum = 1  
    END IF
      
    LET l_pmdl_m.pmdl009 = g_pmds_m.pmds031
    IF cl_null(l_pmdl_m.pmdl009) THEN
       SELECT pmab037 INTO l_pmdl_m.pmdl009
       FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = l_pmdl_m.pmdl004
    END IF
    
    LET l_pmdl_m.pmdl010 = g_pmds_m.pmds032
    IF cl_null(l_pmdl_m.pmdl010) THEN
       SELECT pmab053 INTO l_pmdl_m.pmdl010
       FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = l_pmdl_m.pmdl004
    END IF
    
    LET l_pmdl_m.pmdl011 = g_pmds_m.pmds033
    IF cl_null(l_pmdl_m.pmdl011) THEN
       SELECT pmab034 INTO l_pmdl_m.pmdl011
       FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = l_pmdl_m.pmdl004
    END IF
    #取稅率、單價含稅否
    IF NOT cl_null(l_pmdl_m.pmdl011) THEN
       LET l_oodb005 = ''
       LET l_oodb006 = ''
       LET l_oodb011 = ''
       CALL s_tax_chk(g_site,l_pmdl_m.pmdl011)
         RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
         
       IF l_success THEN
          LET l_pmdl_m.pmdl012 = l_oodb006
          LET l_pmdl_m.pmdl013 = l_oodb005
       END IF           
    END IF
      
    
    LET l_pmdl_m.pmdl015 = g_pmds_m.pmds037
    IF cl_null(l_pmdl_m.pmdl015) THEN
       SELECT pmab033 INTO l_pmdl_m.pmdl015
       FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = l_pmdl_m.pmdl004
    END IF
    
    LET l_pmdl_m.pmdl023 = g_pmds_m.pmds012
    IF cl_null(l_pmdl_m.pmdl023) THEN
       SELECT pmab038 INTO l_pmdl_m.pmdl023
       FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = l_pmdl_m.pmdl004
    END IF
    
    LET l_pmdl_m.pmdl021 = g_pmds_m.pmds008
    LET l_pmdl_m.pmdl022 = g_pmds_m.pmds009
    
    SELECT pmab054,pmab040,pmab039,pmab056,pmab057,pmab058
         INTO l_pmdl_m.pmdl017,l_pmdl_m.pmdl020,l_pmdl_m.pmdl024,l_pmdl_m.pmdl033,
              l_pmdl_m.pmdl054,l_pmdl_m.pmdl055
       FROM pmab_t WHERE pmabent = g_enterprise AND pmabsite = g_site AND pmab001 = l_pmdl_m.pmdl004
    
    #取匯率
    IF NOT cl_null(l_pmdl_m.pmdl015) THEN
       #根據內外購獲取當前營運據點參數設置的汇率类型
       LET l_scc40 = ''
       IF l_pmdl_m.pmdl054 = '1' THEN   #內購
          LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
       END IF
       IF l_pmdl_m.pmdl054 = '2' THEN   #外購
          LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
       END IF
       LET l_ooef016 = ''
       SELECT ooef016 INTO l_ooef016 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
       IF NOT cl_null(l_scc40) THEN
          CALL s_aooi160_get_exrate('1',g_site,g_today,l_pmdl_m.pmdl015,l_ooef016,0,l_scc40) RETURNING l_pmdl_m.pmdl016
       END IF
    END IF
    
    INSERT INTO pmdl_t (pmdlent,pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004,pmdl003, 
        pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009,pmdl010, 
        pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl023,pmdl043, 
        pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029,pmdl021,pmdl022,pmdl032,pmdl024,pmdl054, 
        pmdl055,pmdl030,pmdl031,pmdl028,pmdl042,pmdl047,pmdl048,pmdl049,pmdl046,pmdl040,pmdl041, 
        pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp,pmdlcrtdt,pmdlcnfid,pmdlcnfdt)
    VALUES (g_enterprise,g_site,l_pmdl_m.pmdldocno,l_pmdl_m.pmdl001,l_pmdl_m.pmdldocdt, 
        l_pmdl_m.pmdl002,l_pmdl_m.pmdl004,l_pmdl_m.pmdl003,l_pmdl_m.pmdlstus,l_pmdl_m.pmdl005, 
        l_pmdl_m.pmdl006,l_pmdl_m.pmdl007,l_pmdl_m.pmdl008,l_pmdl_m.pmdl027,l_pmdl_m.pmdl052, 
        l_pmdl_m.pmdl053,l_pmdl_m.pmdl009,l_pmdl_m.pmdl010,l_pmdl_m.pmdl011,l_pmdl_m.pmdl012, 
        l_pmdl_m.pmdl013,l_pmdl_m.pmdl033,l_pmdl_m.pmdl015,l_pmdl_m.pmdl016,l_pmdl_m.pmdl017, 
        l_pmdl_m.pmdl018,l_pmdl_m.pmdl019,l_pmdl_m.pmdl023,l_pmdl_m.pmdl043,l_pmdl_m.pmdl044, 
        l_pmdl_m.pmdl051,l_pmdl_m.pmdl020,l_pmdl_m.pmdl025,l_pmdl_m.pmdl026,l_pmdl_m.pmdl029, 
        l_pmdl_m.pmdl021,l_pmdl_m.pmdl022,l_pmdl_m.pmdl032,l_pmdl_m.pmdl024,l_pmdl_m.pmdl054, 
        l_pmdl_m.pmdl055,l_pmdl_m.pmdl030,l_pmdl_m.pmdl031,l_pmdl_m.pmdl028,l_pmdl_m.pmdl042, 
        l_pmdl_m.pmdl047,l_pmdl_m.pmdl048,l_pmdl_m.pmdl049,l_pmdl_m.pmdl046,l_pmdl_m.pmdl040, 
        l_pmdl_m.pmdl041,l_pmdl_m.pmdlownid,l_pmdl_m.pmdlowndp,l_pmdl_m.pmdlcrtid,l_pmdl_m.pmdlcrtdp, 
        l_pmdlcrtdt,l_pmdl_m.pmdlcnfid,l_pmdl_m.pmdlcnfdt) 
    IF SQLCA.sqlcode THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "l_pmdl_m" 
       LET g_errparam.code   = SQLCA.sqlcode 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success,''
    END IF
    
    RETURN r_success,l_pmdl_m.pmdldocno
    
END FUNCTION

#產生採購單身檔
PRIVATE FUNCTION apmt520_gen_purchase_pmdn(p_pmdldocno)
DEFINE p_pmdldocno    LIKE pmdl_t.pmdldocno
#161124-00048#11 mod-S
#DEFINE l_pmdn         RECORD LIKE pmdn_t.*
#DEFINE l_pmdt         RECORD LIKE pmdt_t.*
DEFINE l_pmdn RECORD  #採購單身明細檔
       pmdnent LIKE pmdn_t.pmdnent, #企业编号
       pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
       pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
       pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
       pmdnseq LIKE pmdn_t.pmdnseq, #项次
       pmdn001 LIKE pmdn_t.pmdn001, #料件编号
       pmdn002 LIKE pmdn_t.pmdn002, #产品特征
       pmdn003 LIKE pmdn_t.pmdn003, #包装容器
       pmdn004 LIKE pmdn_t.pmdn004, #作业编号
       pmdn005 LIKE pmdn_t.pmdn005, #作业序
       pmdn006 LIKE pmdn_t.pmdn006, #采购单位
       pmdn007 LIKE pmdn_t.pmdn007, #采购数量
       pmdn008 LIKE pmdn_t.pmdn008, #参考单位
       pmdn009 LIKE pmdn_t.pmdn009, #参考数量
       pmdn010 LIKE pmdn_t.pmdn010, #计价单位
       pmdn011 LIKE pmdn_t.pmdn011, #计价数量
       pmdn012 LIKE pmdn_t.pmdn012, #出货日期
       pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
       pmdn014 LIKE pmdn_t.pmdn014, #到库日期
       pmdn015 LIKE pmdn_t.pmdn015, #单价
       pmdn016 LIKE pmdn_t.pmdn016, #税种
       pmdn017 LIKE pmdn_t.pmdn017, #税率
       pmdn019 LIKE pmdn_t.pmdn019, #子件特性
       pmdn020 LIKE pmdn_t.pmdn020, #紧急度
       pmdn021 LIKE pmdn_t.pmdn021, #保税
       pmdn022 LIKE pmdn_t.pmdn022, #部分交货
       pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
       pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
       pmdn024 LIKE pmdn_t.pmdn024, #多交期
       pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
       pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
       pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
       pmdn028 LIKE pmdn_t.pmdn028, #收货库位
       pmdn029 LIKE pmdn_t.pmdn029, #收货储位
       pmdn030 LIKE pmdn_t.pmdn030, #收货批号
       pmdn031 LIKE pmdn_t.pmdn031, #运输方式
       pmdn032 LIKE pmdn_t.pmdn032, #取货模式
       pmdn033 LIKE pmdn_t.pmdn033, #备品率
       pmdn034 LIKE pmdn_t.pmdn034, #no use
       pmdn035 LIKE pmdn_t.pmdn035, #价格核决
       pmdn036 LIKE pmdn_t.pmdn036, #项目编号
       pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
       pmdn038 LIKE pmdn_t.pmdn038, #活动编号
       pmdn039 LIKE pmdn_t.pmdn039, #费用原因
       pmdn040 LIKE pmdn_t.pmdn040, #取价来源
       pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
       pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
       pmdn043 LIKE pmdn_t.pmdn043, #取出价格
       pmdn044 LIKE pmdn_t.pmdn044, #价差比
       pmdn045 LIKE pmdn_t.pmdn045, #行状态
       pmdn046 LIKE pmdn_t.pmdn046, #税前金额
       pmdn047 LIKE pmdn_t.pmdn047, #含税金额
       pmdn048 LIKE pmdn_t.pmdn048, #税额
       pmdn049 LIKE pmdn_t.pmdn049, #理由码
       pmdn050 LIKE pmdn_t.pmdn050, #备注
       pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
       pmdn052 LIKE pmdn_t.pmdn052, #检验否
       pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
       pmdn200 LIKE pmdn_t.pmdn200, #商品条码
       pmdn201 LIKE pmdn_t.pmdn201, #包装单位
       pmdn202 LIKE pmdn_t.pmdn202, #包装数量
       pmdn203 LIKE pmdn_t.pmdn203, #收货部门
       pmdn204 LIKE pmdn_t.pmdn204, #No Use
       pmdn205 LIKE pmdn_t.pmdn205, #要货组织
       pmdn206 LIKE pmdn_t.pmdn206, #库存量
       pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
       pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
       pmdn209 LIKE pmdn_t.pmdn209, #上月销量
       pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
       pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
       pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
       pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
       pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
       pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
       pmdn216 LIKE pmdn_t.pmdn216, #经营方式
       pmdn217 LIKE pmdn_t.pmdn217, #结算方式
       pmdn218 LIKE pmdn_t.pmdn218, #合同编号
       pmdn219 LIKE pmdn_t.pmdn219, #协议编号
       pmdn220 LIKE pmdn_t.pmdn220, #采购人员
       pmdn221 LIKE pmdn_t.pmdn221, #采购部门
       pmdn222 LIKE pmdn_t.pmdn222, #采购中心
       pmdn223 LIKE pmdn_t.pmdn223, #配送中心
       pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
       pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
       pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
       pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
       pmdn054 LIKE pmdn_t.pmdn054, #还料数量
       pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
       pmdn056 LIKE pmdn_t.pmdn056, #还价数量
       pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
       pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
       pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
       pmdn058 LIKE pmdn_t.pmdn058, #预算科目
       pmdn228 LIKE pmdn_t.pmdn228  #商品品类
END RECORD
DEFINE l_pmdt RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
#161124-00048#11 mod-E
DEFINE r_success      LIKE type_t.num5
DEFINE l_success      LIKE type_t.num5
DEFINE l_imaf171      LIKE imaf_t.imaf171
DEFINE l_imaf172      LIKE imaf_t.imaf172
DEFINE l_imaf173      LIKE imaf_t.imaf173
DEFINE l_imaf174      LIKE imaf_t.imaf174
DEFINE l_imaf175      LIKE imaf_t.imaf175
DEFINE l_time1        LIKE imaf_t.imaf171
DEFINE l_time2        LIKE imaf_t.imaf171
DEFINE l_pmdl017      LIKE pmdl_t.pmdl017
DEFINE l_pmdl004      LIKE pmdl_t.pmdl004
DEFINE l_pmdl015      LIKE pmdl_t.pmdl015
DEFINE l_pmdl009      LIKE pmdl_t.pmdl009
DEFINE l_pmdl010      LIKE pmdl_t.pmdl010
DEFINE l_pmdl023      LIKE pmdl_t.pmdl023
DEFINE l_pmdl054      LIKE pmdl_t.pmdl054
DEFINE l_pmdl020      LIKE pmdl_t.pmdl020
DEFINE l_sql          STRING
DEFINE l_pmdt001      LIKE pmdt_t.pmdt001
DEFINE l_pmdt002      LIKE pmdt_t.pmdt002
DEFINE l_pmdt003      LIKE pmdt_t.pmdt003
DEFINE l_pmdt004      LIKE pmdt_t.pmdt004
DEFINE l_pmdldocdt    LIKE pmdl_t.pmdldocdt
DEFINE l_pmdn007_t    LIKE pmdn_t.pmdn007
DEFINE l_pmdn007      LIKE pmdn_t.pmdn007

    LET r_success = TRUE
    #161124-00048#11 mod-S
#    DECLARE pur_pmdn CURSOR FOR
#        SELECT * FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno 
    DECLARE pur_pmdn CURSOR FOR
        SELECT pmdtent,pmdtsite,pmdtdocno,pmdtseq,pmdt001,
               pmdt002,pmdt003,pmdt004,pmdt005,pmdt006,
               pmdt007,pmdt008,pmdt009,pmdt010,pmdt011,
               pmdt016,pmdt017,pmdt018,pmdt019,pmdt020,
               pmdt021,pmdt022,pmdt023,pmdt024,pmdt025,
               pmdt026,pmdt027,pmdt028,pmdt036,pmdt037,
               pmdt038,pmdt039,pmdt040,pmdt041,pmdt042,
               pmdt043,pmdt044,pmdt045,pmdt046,pmdt047,
               pmdt051,pmdt052,pmdt053,pmdt054,pmdt055,
               pmdt056,pmdt057,pmdt058,pmdt059,pmdt060,
               pmdt061,pmdt062,pmdt063,pmdt064,pmdt065,
               pmdt066,pmdt067,pmdt068,pmdt069,pmdt081,
               pmdt082,pmdt083,pmdt084,pmdt085,pmdt086,
               pmdt087,pmdt088,pmdt089,pmdt900,pmdt999,
               pmdt200,pmdt201,pmdt202,pmdt203,pmdt204,
               pmdt205,pmdt206,pmdt207,pmdt208,pmdt209,
               pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga,
               pmdt070,pmdt071,pmdt214,pmdt215,pmdt048,
               pmdt216,pmdt217,pmdt090,pmdt091,pmdt092,
               pmdt093,pmdt218,pmdt219,pmdt072,pmdt073,
               pmdt074,pmdt227,pmdt049,pmdt050,pmdt075,
               pmdt220,pmdt221 
          FROM pmdt_t 
         WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno 
    #161124-00048#11 mod-E
    
    INITIALIZE l_pmdn.* TO NULL
    
    FOREACH pur_pmdn INTO l_pmdt.*
       
       LET l_pmdn.pmdndocno = p_pmdldocno
       LET l_pmdn.pmdnsite = g_site
       #項次加1
       SELECT MAX(pmdnseq)+1 INTO l_pmdn.pmdnseq FROM pmdn_t
         WHERE pmdnent = g_enterprise AND pmdndocno = p_pmdldocno
       IF cl_null(l_pmdn.pmdnseq) OR l_pmdn.pmdnseq = 0 THEN
          LET l_pmdn.pmdnseq = 1
       END IF
       
       LET l_pmdn.pmdn001 = l_pmdt.pmdt006
       LET l_pmdn.pmdn002 = l_pmdt.pmdt007
       LET l_pmdn.pmdn003 = l_pmdt.pmdt008
       LET l_pmdn.pmdn004 = l_pmdt.pmdt009
       LET l_pmdn.pmdn005 = l_pmdt.pmdt010
       LET l_pmdn.pmdn006 = l_pmdt.pmdt019
       LET l_pmdn.pmdn007 = l_pmdt.pmdt020
       
       #已轉採購單的數量
       SELECT SUM(pmdn007) INTO l_pmdn007 FROM pmdn_t,pmdl_t 
          WHERE pmdlent = pmdnent AND pmdldocno = pmdndocno AND pmdl008 = g_pmds_m.pmdsdocno
            AND pmdldocno <> p_pmdldocno AND pmdlstus <> 'X'
            
       IF cl_null(l_pmdn007) THEN
          LET l_pmdn007 = 0
       END IF
       LET l_pmdn.pmdn007 = l_pmdn.pmdn007 - l_pmdn007
       IF l_pmdn.pmdn007 = 0 THEN
          CONTINUE FOREACH
       END IF
       
       LET l_pmdn.pmdn008 = l_pmdt.pmdt021
       #LET l_pmdn.pmdn009 = l_pmdt.pmdt022
       LET l_pmdn.pmdn010 = l_pmdt.pmdt023
       #LET l_pmdn.pmdn011 = l_pmdt.pmdt024
       IF NOT cl_null(l_pmdn.pmdn006) THEN
          CALL s_aooi250_take_decimals(l_pmdn.pmdn006,l_pmdn.pmdn007)
             RETURNING l_success,l_pmdn.pmdn007
                  
          IF (NOT cl_null(l_pmdn.pmdn008)) AND (NOT cl_null(l_pmdn.pmdn001)) THEN
             CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn008,l_pmdn.pmdn007)
                       RETURNING l_success,l_pmdn.pmdn009
             CALL s_aooi250_take_decimals(l_pmdn.pmdn008,l_pmdn.pmdn009)
                 RETURNING l_success,l_pmdn.pmdn009
          END IF
          
          #IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" AND (NOT cl_null(l_pmdn.pmdn010)) AND (NOT cl_null(l_pmdn.pmdn010)) AND apmt520_get_imaf144(l_pmdn.pmdn001) THEN #161205-00025#3
          IF g_bas_0019 = "Y" AND (NOT cl_null(l_pmdn.pmdn010)) AND (NOT cl_null(l_pmdn.pmdn010)) AND apmt520_get_imaf144(l_pmdn.pmdn001) THEN   #161205-00025#3
             CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn010,l_pmdn.pmdn007)
                       RETURNING l_success,l_pmdn.pmdn011
             CALL s_aooi250_take_decimals(l_pmdn.pmdn010,l_pmdn.pmdn011)
                 RETURNING l_success,l_pmdn.pmdn011
          ELSE
             LET l_pmdn.pmdn010 = l_pmdn.pmdn006
             LET l_pmdn.pmdn011 = l_pmdn.pmdn007
          END IF
       END IF
       
       IF cl_null(l_pmdn.pmdn010) OR cl_null(l_pmdn.pmdn011) THEN
          LET l_pmdn.pmdn010 = l_pmdn.pmdn006
          LET l_pmdn.pmdn011 = l_pmdn.pmdn007
       END IF
                     
       #根據收貨單號和項次 找到原採購單的出貨、到廠、到庫日期
       SELECT pmdt001,pmdt002,pmdt003,pmdt004 INTO l_pmdt001,l_pmdt002,l_pmdt003,l_pmdt004
         FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmds006 AND pmdtseq = l_pmdt.pmdt002
       SELECT pmdo011,pmdo012,pmdo013 INTO l_pmdn.pmdn012,l_pmdn.pmdn013,l_pmdn.pmdn014
         FROM pmdo_t WHERE pmdoent = g_enterprise AND pmdodocno = l_pmdt001 
                       AND pmdoseq = l_pmdt002 AND pmdoseq1 = l_pmdt003 AND pmdoseq2 = l_pmdt004
       
       LET l_pmdn.pmdn016 = l_pmdt.pmdt046
       LET l_pmdn.pmdn017 = l_pmdt.pmdt037
       LET l_pmdn.pmdn019 = l_pmdt.pmdt005
       LET l_pmdn.pmdn020 = l_pmdt.pmdt025
       
       IF NOT cl_null(l_pmdn.pmdn014) THEN  
          LET l_imaf171 = 0
          LET l_imaf172 = 0
          LET l_imaf173 = 0
          LET l_imaf174 = 0
          LET l_imaf175 = 0
          LET l_time1 = 0
          LET l_time2 = 0
          
          SELECT imaf171,imaf172,imaf173,imaf174,imaf175 INTO l_imaf171,l_imaf172,l_imaf173,l_imaf174,l_imaf175
            FROM imaf_t 
            WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdn.pmdn001

          LET l_time1 = l_pmdn.pmdn014 - g_today         #到庫日期  - g_today
          LET l_time2 = l_imaf171+l_imaf172+l_imaf173+l_imaf174  #[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數
          
          #1.若輸入的到庫日期 - g_today >[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數時，則[C:緊急度] = '1'(一般)
          IF l_time1 >= l_time2 THEN
             LET l_pmdn.pmdn020 = '1'
          END IF
          
          #2.若輸入的到庫日期 - g_today <[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數，
          #   且到庫日期 - g_today >[T:料件據點進銷存檔].[C:嚴守交期前置時間]時，則[C:緊急度] = '2'(緊急)
          IF l_time1 < l_time2 AND l_time1 >= l_imaf175 THEN
             LET l_pmdn.pmdn020 = '2'
          END IF
          
          #3.若輸入的到庫日期 - g_today <[T:料件據點進銷存檔].[C:嚴守交期前置時間]時，則[C:緊急度] = '3'(特急)
          IF l_time1 < l_imaf175 THEN
             LET l_pmdn.pmdn020 = '3'
          END IF
       END IF
       
       LET l_pmdn.pmdn021 = l_pmdt.pmdt041
       LET l_pmdn.pmdn022 = 'N'
       LET l_pmdn.pmdnunit = g_site
       LET l_pmdn.pmdnorga = g_site
       LET l_pmdn.pmdn023 = g_pmds_m.pmds009
       LET l_pmdn.pmdn024 = 'N'
       LET l_pmdn.pmdn028 = l_pmdt.pmdt016
       LET l_pmdn.pmdn029 = l_pmdt.pmdt017
       LET l_pmdn.pmdn030 = l_pmdt.pmdt018
       LET l_pmdn.pmdn050 = l_pmdt.pmdt059
       
       SELECT pmdl020 INTO l_pmdn.pmdn031 FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = p_pmdldocno
       LET l_pmdn.pmdn032 ='1'
       
       SELECT imaf165 INTO l_pmdn.pmdn033 FROM imaf_t
         WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdn.pmdn001
       
       LET l_pmdn.pmdn035 = l_pmdt.pmdt040
       LET l_pmdn.pmdn045 = '1'
       
       
       SELECT pmdl017,pmdl004,pmdl015,pmdl009,pmdl010,pmdl023,pmdl054,pmdldocdt 
          INTO l_pmdl017,l_pmdl004,l_pmdl015,l_pmdl009,l_pmdl010,l_pmdl023,l_pmdl054,l_pmdldocdt
          FROM pmdl_t WHERE pmdlent = g_enterprise AND pmdldocno = p_pmdldocno      
       #161125-00010#1---s   
       #CALL s_apmt500_get_price(l_pmdl017,l_pmdl004,l_pmdn.pmdn001,l_pmdn.pmdn002,l_pmdl015,
       #                         l_pmdn.pmdn016,l_pmdl009,l_pmdl010,l_pmdl023,p_pmdldocno,
       #                         l_pmdldocdt,l_pmdn.pmdn010,l_pmdn.pmdn011,g_site,l_pmdl054,'1',l_pmdn.pmdn004,l_pmdn.pmdn005)
       #   RETURNING l_pmdn.pmdn040,l_pmdn.pmdn043,l_pmdn.pmdn041,l_pmdn.pmdn042   
       #
       #LET l_pmdn.pmdn015 = l_pmdn.pmdn043
       #LET l_pmdn.pmdn044 = 0
       
       SELECT pmdn015,pmdn040,pmdn043,pmdn041,pmdn042,pmdn044 
          INTO l_pmdn.pmdn015,l_pmdn.pmdn040,l_pmdn.pmdn043,l_pmdn.pmdn041,l_pmdn.pmdn042,l_pmdn.pmdn044
         FROM pmdn_t WHERE pmdnent = g_enterprise AND pmdndocno = l_pmdt001 AND pmdnseq = l_pmdt002 
       #161125-00010#1--e
  
       #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
       CALL s_apmt500_get_amount(p_pmdldocno,l_pmdn.pmdnseq,l_pmdl015,l_pmdn.pmdn011,l_pmdn.pmdn015,l_pmdn.pmdn016)
            RETURNING l_pmdn.pmdn046,l_pmdn.pmdn048,l_pmdn.pmdn047
    
    
       LET l_pmdn.pmdn052 = ''
       LET l_sql = " SELECT qcap006 FROM qcap_t ",
                  " WHERE qcapent = '",g_enterprise,"' ",
                  "  AND qcapsite = '",g_site,"' ",
                  "  AND qcap001 = '",l_pmdn.pmdn001,"' ",
                  "  AND qcap002 = '",l_pmdl004,"' "
                  
       IF l_pmdn.pmdn002 IS NOT NULL THEN
          LET l_sql = l_sql ," AND ( qcap005 = '",l_pmdn.pmdn002,"' OR qcap005 = 'ALL') "
       END IF
       IF (NOT cl_null(l_pmdn.pmdn004)) AND (NOT cl_null(l_pmdn.pmdn005)) THEN
          LET l_sql = l_sql ," AND ( qcap003 = '",l_pmdn.pmdn004,"' OR qcap003 = 'ALL' ) AND qcap004 = '",l_pmdn.pmdn005,"' "
       END IF
       
       PREPARE pur_qcap FROM l_sql
       EXECUTE pur_qcap INTO l_pmdn.pmdn052   #總筆數
       FREE pur_qcap
       
       IF cl_null(l_pmdn.pmdn052) THEN
          #若沒有維護aqci050,再從aqci040中帶值
          SELECT imae114 INTO l_pmdn.pmdn052 FROM imae_t 
              WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = l_pmdn.pmdn001
              
       END IF
       
       IF cl_null(l_pmdn.pmdn052) THEN
          LET l_pmdn.pmdn052 = 'N'
       END IF
       
       LET l_pmdn.pmdn053 = l_pmdt.pmdt063
       
       #新增採購單身明細
       INSERT INTO pmdn_t(pmdnent,pmdnsite,pmdndocno,pmdnseq,pmdn001,pmdn002,pmdn003,pmdn006,pmdn007,
                          pmdn008,pmdn009,pmdn010,pmdn011,pmdn012,pmdn013,pmdn014,pmdn015,pmdn016,
                          pmdn017,pmdn019,pmdn020,pmdn021,pmdn022,pmdn023,pmdn024,pmdn025,pmdn026,
                          pmdn027,pmdn028,pmdn029,pmdn030,pmdn031,pmdn032,pmdn033,pmdn035,pmdn040,pmdn041,pmdn042,pmdn043,pmdn044,pmdn045,
                          pmdn046,pmdn047,pmdn048,pmdnunit,pmdnorga,pmdn052,pmdn053)
         VALUES (g_enterprise,l_pmdn.pmdnsite,p_pmdldocno,l_pmdn.pmdnseq,l_pmdn.pmdn001,l_pmdn.pmdn002,
                 l_pmdn.pmdn003,l_pmdn.pmdn006,l_pmdn.pmdn007,l_pmdn.pmdn008,l_pmdn.pmdn009,
                 l_pmdn.pmdn010,l_pmdn.pmdn011,l_pmdn.pmdn012,l_pmdn.pmdn013,l_pmdn.pmdn014,
                 l_pmdn.pmdn015,l_pmdn.pmdn016,l_pmdn.pmdn017,l_pmdn.pmdn019,l_pmdn.pmdn020,
                 l_pmdn.pmdn021,l_pmdn.pmdn022,l_pmdn.pmdn023,l_pmdn.pmdn024,l_pmdn.pmdn025,
                 l_pmdn.pmdn026,l_pmdn.pmdn027,l_pmdn.pmdn028,l_pmdn.pmdn029,l_pmdn.pmdn030,l_pmdn.pmdn031,
                 l_pmdn.pmdn032,l_pmdn.pmdn033,l_pmdn.pmdn035,l_pmdn.pmdn040,l_pmdn.pmdn041,l_pmdn.pmdn042,
                 l_pmdn.pmdn043,l_pmdn.pmdn044,l_pmdn.pmdn045,
                 l_pmdn.pmdn046,l_pmdn.pmdn047,l_pmdn.pmdn048,l_pmdn.pmdnunit,l_pmdn.pmdnorga,
                 l_pmdn.pmdn052,l_pmdn.pmdn053)
       IF SQLCA.SQLcode  THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = SQLCA.sqlcode
           LET g_errparam.extend = "pmdn_t"
           LET g_errparam.popup = TRUE
           CALL cl_err()
  
           LET r_success = FALSE                 
           RETURN r_success
       END IF
       
       #新增關聯單身明細
       IF NOT apmt520_gen_purchase_pmdp(l_pmdt.*,l_pmdn.*) THEN
          LET r_success = FALSE                 
          RETURN r_success
       END IF
       
       #新增交期明細資料
       IF NOT s_apmt500_gen_pmdq(p_pmdldocno,l_pmdn.pmdnseq) THEN
          LET r_success = FALSE                 
          RETURN r_success
       END IF
       
       #新增交期明細資料
       IF NOT s_apmt500_gen_pmdo(p_pmdldocno,l_pmdn.pmdnseq) THEN
          LET r_success = FALSE                 
          RETURN r_success
       END IF
      
       INITIALIZE l_pmdn.* TO NULL
       
    END FOREACH
    
    
    RETURN r_success
    
END FUNCTION

#產生關聯單據單身檔
PRIVATE FUNCTION apmt520_gen_purchase_pmdp(p_pmdt,p_pmdn)
#161124-00048#11 mod-S
#DEFINE p_pmdt    RECORD LIKE pmdt_t.*
#DEFINE p_pmdn    RECORD LIKE pmdn_t.*
#DEFINE l_pmdp    RECORD LIKE pmdp_t.*
DEFINE p_pmdt RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
DEFINE p_pmdn RECORD  #採購單身明細檔
       pmdnent LIKE pmdn_t.pmdnent, #企业编号
       pmdnsite LIKE pmdn_t.pmdnsite, #营运据点
       pmdnunit LIKE pmdn_t.pmdnunit, #应用组织
       pmdndocno LIKE pmdn_t.pmdndocno, #采购单号
       pmdnseq LIKE pmdn_t.pmdnseq, #项次
       pmdn001 LIKE pmdn_t.pmdn001, #料件编号
       pmdn002 LIKE pmdn_t.pmdn002, #产品特征
       pmdn003 LIKE pmdn_t.pmdn003, #包装容器
       pmdn004 LIKE pmdn_t.pmdn004, #作业编号
       pmdn005 LIKE pmdn_t.pmdn005, #作业序
       pmdn006 LIKE pmdn_t.pmdn006, #采购单位
       pmdn007 LIKE pmdn_t.pmdn007, #采购数量
       pmdn008 LIKE pmdn_t.pmdn008, #参考单位
       pmdn009 LIKE pmdn_t.pmdn009, #参考数量
       pmdn010 LIKE pmdn_t.pmdn010, #计价单位
       pmdn011 LIKE pmdn_t.pmdn011, #计价数量
       pmdn012 LIKE pmdn_t.pmdn012, #出货日期
       pmdn013 LIKE pmdn_t.pmdn013, #到厂日期
       pmdn014 LIKE pmdn_t.pmdn014, #到库日期
       pmdn015 LIKE pmdn_t.pmdn015, #单价
       pmdn016 LIKE pmdn_t.pmdn016, #税种
       pmdn017 LIKE pmdn_t.pmdn017, #税率
       pmdn019 LIKE pmdn_t.pmdn019, #子件特性
       pmdn020 LIKE pmdn_t.pmdn020, #紧急度
       pmdn021 LIKE pmdn_t.pmdn021, #保税
       pmdn022 LIKE pmdn_t.pmdn022, #部分交货
       pmdnorga LIKE pmdn_t.pmdnorga, #付款据点
       pmdn023 LIKE pmdn_t.pmdn023, #送货供应商
       pmdn024 LIKE pmdn_t.pmdn024, #多交期
       pmdn025 LIKE pmdn_t.pmdn025, #收货地址编号
       pmdn026 LIKE pmdn_t.pmdn026, #账款地址编号
       pmdn027 LIKE pmdn_t.pmdn027, #供应商料号
       pmdn028 LIKE pmdn_t.pmdn028, #收货库位
       pmdn029 LIKE pmdn_t.pmdn029, #收货储位
       pmdn030 LIKE pmdn_t.pmdn030, #收货批号
       pmdn031 LIKE pmdn_t.pmdn031, #运输方式
       pmdn032 LIKE pmdn_t.pmdn032, #取货模式
       pmdn033 LIKE pmdn_t.pmdn033, #备品率
       pmdn034 LIKE pmdn_t.pmdn034, #no use
       pmdn035 LIKE pmdn_t.pmdn035, #价格核决
       pmdn036 LIKE pmdn_t.pmdn036, #项目编号
       pmdn037 LIKE pmdn_t.pmdn037, #WBS编号
       pmdn038 LIKE pmdn_t.pmdn038, #活动编号
       pmdn039 LIKE pmdn_t.pmdn039, #费用原因
       pmdn040 LIKE pmdn_t.pmdn040, #取价来源
       pmdn041 LIKE pmdn_t.pmdn041, #价格参考单号
       pmdn042 LIKE pmdn_t.pmdn042, #价格参考项次
       pmdn043 LIKE pmdn_t.pmdn043, #取出价格
       pmdn044 LIKE pmdn_t.pmdn044, #价差比
       pmdn045 LIKE pmdn_t.pmdn045, #行状态
       pmdn046 LIKE pmdn_t.pmdn046, #税前金额
       pmdn047 LIKE pmdn_t.pmdn047, #含税金额
       pmdn048 LIKE pmdn_t.pmdn048, #税额
       pmdn049 LIKE pmdn_t.pmdn049, #理由码
       pmdn050 LIKE pmdn_t.pmdn050, #备注
       pmdn051 LIKE pmdn_t.pmdn051, #留置/结案理由码
       pmdn052 LIKE pmdn_t.pmdn052, #检验否
       pmdn053 LIKE pmdn_t.pmdn053, #库存管理特征
       pmdn200 LIKE pmdn_t.pmdn200, #商品条码
       pmdn201 LIKE pmdn_t.pmdn201, #包装单位
       pmdn202 LIKE pmdn_t.pmdn202, #包装数量
       pmdn203 LIKE pmdn_t.pmdn203, #收货部门
       pmdn204 LIKE pmdn_t.pmdn204, #No Use
       pmdn205 LIKE pmdn_t.pmdn205, #要货组织
       pmdn206 LIKE pmdn_t.pmdn206, #库存量
       pmdn207 LIKE pmdn_t.pmdn207, #采购在途量
       pmdn208 LIKE pmdn_t.pmdn208, #前日销售量
       pmdn209 LIKE pmdn_t.pmdn209, #上月销量
       pmdn210 LIKE pmdn_t.pmdn210, #第一周销量
       pmdn211 LIKE pmdn_t.pmdn211, #第二周销量
       pmdn212 LIKE pmdn_t.pmdn212, #第三周销量
       pmdn213 LIKE pmdn_t.pmdn213, #第四周销量
       pmdn214 LIKE pmdn_t.pmdn214, #采购渠道
       pmdn215 LIKE pmdn_t.pmdn215, #渠道性质
       pmdn216 LIKE pmdn_t.pmdn216, #经营方式
       pmdn217 LIKE pmdn_t.pmdn217, #结算方式
       pmdn218 LIKE pmdn_t.pmdn218, #合同编号
       pmdn219 LIKE pmdn_t.pmdn219, #协议编号
       pmdn220 LIKE pmdn_t.pmdn220, #采购人员
       pmdn221 LIKE pmdn_t.pmdn221, #采购部门
       pmdn222 LIKE pmdn_t.pmdn222, #采购中心
       pmdn223 LIKE pmdn_t.pmdn223, #配送中心
       pmdn224 LIKE pmdn_t.pmdn224, #采购失效日
       pmdn900 LIKE pmdn_t.pmdn900, #保留字段str
       pmdn999 LIKE pmdn_t.pmdn999, #保留字段end
       pmdn225 LIKE pmdn_t.pmdn225, #最终收货组织
       pmdn054 LIKE pmdn_t.pmdn054, #还料数量
       pmdn055 LIKE pmdn_t.pmdn055, #还量参考数量
       pmdn056 LIKE pmdn_t.pmdn056, #还价数量
       pmdn057 LIKE pmdn_t.pmdn057, #还价参考数量
       pmdn226 LIKE pmdn_t.pmdn226, #长效期每次送货量
       pmdn227 LIKE pmdn_t.pmdn227, #补货规格说明
       pmdn058 LIKE pmdn_t.pmdn058, #预算科目
       pmdn228 LIKE pmdn_t.pmdn228  #商品品类
END RECORD
DEFINE l_pmdp RECORD  #採購關聯單據明細檔
       pmdpent LIKE pmdp_t.pmdpent, #企业编号
       pmdpsite LIKE pmdp_t.pmdpsite, #营运据点
       pmdpdocno LIKE pmdp_t.pmdpdocno, #采购单号
       pmdpseq LIKE pmdp_t.pmdpseq, #采购项次
       pmdpseq1 LIKE pmdp_t.pmdpseq1, #项序
       pmdp001 LIKE pmdp_t.pmdp001, #料件编号
       pmdp002 LIKE pmdp_t.pmdp002, #产品特征
       pmdp003 LIKE pmdp_t.pmdp003, #来源单号
       pmdp004 LIKE pmdp_t.pmdp004, #来源项次
       pmdp005 LIKE pmdp_t.pmdp005, #来源项序
       pmdp006 LIKE pmdp_t.pmdp006, #来源分批序
       pmdp007 LIKE pmdp_t.pmdp007, #来源料号
       pmdp008 LIKE pmdp_t.pmdp008, #来源产品特征
       pmdp009 LIKE pmdp_t.pmdp009, #来源作业编号
       pmdp010 LIKE pmdp_t.pmdp010, #来源作业序
       pmdp011 LIKE pmdp_t.pmdp011, #来源BOM特性
       pmdp012 LIKE pmdp_t.pmdp012, #来源生产控制组
       pmdp021 LIKE pmdp_t.pmdp021, #冲销顺序
       pmdp022 LIKE pmdp_t.pmdp022, #需求单位
       pmdp023 LIKE pmdp_t.pmdp023, #需求数量
       pmdp024 LIKE pmdp_t.pmdp024, #折合采购量
       pmdp025 LIKE pmdp_t.pmdp025, #已收货量
       pmdp026 LIKE pmdp_t.pmdp026, #已入库量
       pmdp900 LIKE pmdp_t.pmdp900, #保留字段str
       pmdp999 LIKE pmdp_t.pmdp999  #保留字段end
END RECORD
#161124-00048#11 mod-E
DEFINE r_success LIKE type_t.num5
DEFINE p_pmdn007 LIKE pmdn_t.pmdn007

    LET r_success = TRUE
    
    LET l_pmdp.pmdpdocno = p_pmdn.pmdndocno
    LET l_pmdp.pmdpseq = p_pmdn.pmdnseq
    #項序加1
    SELECT MAX(pmdpseq1)+1 INTO l_pmdp.pmdpseq1 FROM pmdp_t
      WHERE pmdpent = g_enterprise AND pmdpdocno = p_pmdn.pmdndocno AND pmdpseq = p_pmdn.pmdnseq
    IF cl_null(l_pmdp.pmdpseq1) OR l_pmdp.pmdpseq1 = 0 THEN
       LET l_pmdp.pmdpseq1 = 1
    END IF
    
    LET l_pmdp.pmdp001 = p_pmdn.pmdn001
    LET l_pmdp.pmdp002 = p_pmdn.pmdn002
    LET l_pmdp.pmdp003 = p_pmdt.pmdtdocno
    LET l_pmdp.pmdp004 = p_pmdt.pmdtseq
    
    LET l_pmdp.pmdp007 = p_pmdt.pmdt006
    LET l_pmdp.pmdp008 = p_pmdt.pmdt007
    LET l_pmdp.pmdp009 = p_pmdt.pmdt009
    LET l_pmdp.pmdp010 = p_pmdt.pmdt010
    
    LET l_pmdp.pmdp022 = p_pmdn.pmdn006
    LET l_pmdp.pmdp023 = p_pmdn.pmdn007
    LET l_pmdp.pmdp024 = p_pmdn.pmdn007
    LET l_pmdp.pmdp025 = 0
    LET l_pmdp.pmdp026 = 0
    
    SELECT MAX(pmdp021)+1 INTO l_pmdp.pmdp021 FROM pmdp_t
       WHERE pmdp001 = l_pmdp.pmdp001 AND pmdp002 = l_pmdp.pmdp002 AND pmdp022 = l_pmdp.pmdp022
         AND pmdpdocno = l_pmdp.pmdpdocno
         AND pmdpent   = g_enterprise   #160905-00007#11 Add
    IF cl_null(l_pmdp.pmdp021) OR l_pmdp.pmdp021 = 0 THEN
       LET l_pmdp.pmdp021 = 1
    END IF
          
    
    INSERT INTO pmdp_t(pmdpent,pmdpsite,pmdpdocno,pmdpseq,pmdpseq1,pmdp001,pmdp002,pmdp003,pmdp004,
                       pmdp007,pmdp008,pmdp009,pmdp010,pmdp021,pmdp022,pmdp023,pmdp024,pmdp025,pmdp026)
               VALUES (g_enterprise,g_site,l_pmdp.pmdpdocno,l_pmdp.pmdpseq,l_pmdp.pmdpseq1,l_pmdp.pmdp001,
                       l_pmdp.pmdp002,l_pmdp.pmdp003,l_pmdp.pmdp004,l_pmdp.pmdp007,l_pmdp.pmdp008,l_pmdp.pmdp009,l_pmdp.pmdp010,
                       l_pmdp.pmdp021,l_pmdp.pmdp022,l_pmdp.pmdp023,l_pmdp.pmdp024,l_pmdp.pmdp025,l_pmdp.pmdp026)
    IF SQLCA.SQLcode  THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = SQLCA.sqlcode
       LET g_errparam.extend = "pmdp_t"
       LET g_errparam.popup = TRUE
       CALL cl_err()

       LET r_success = FALSE                 
       RETURN r_success
    END IF
    
    RETURN r_success

END FUNCTION

#維護供應商出貨日
PRIVATE FUNCTION apmt520_upd_pmds052()
DEFINE l_pmdsmoddt  LIKE pmds_t.pmdsmoddt
DEFINE l_forupd_sql STRING

   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   SELECT UNIQUE pmdssite,pmds000,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003,pmdsstus,pmds006,pmds007, 
          pmds008,pmds009,pmds010,pmds011,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033, 
          pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040,pmds041,pmds042,pmds043,pmds044,pmds046, 
          pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt,pmdspstid, 
          pmdspstdt
   INTO g_pmds_m.pmdssite,g_pmds_m.pmds000,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds002,g_pmds_m.pmds001, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009, 
       g_pmds_m.pmds010,g_pmds_m.pmds011,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
       g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds041, 
       g_pmds_m.pmds042,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp, 
       g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt, 
       g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt
   FROM pmds_t
   WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
 
   ERROR ""
  
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   CALL s_transaction_begin()
   
   LET l_forupd_sql = "SELECT pmdssite,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003, ",
                      " pmdsstus,pmds006,pmds007,pmds008,pmds009,pmds010,pmds000,pmds100,pmds011,pmds081, ",
                      " pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,", 
                      " pmds037,pmds038,pmds039,pmds040,pmds041,pmds042,pmds043,pmds044,pmds046 ",
                      " FROM pmds_t WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
                      
   LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)                #轉換不同資料庫語法
   DECLARE apmt520_cl4 CURSOR FROM l_forupd_sql

   OPEN apmt520_cl4 USING g_enterprise,g_pmds_m.pmdsdocno
 
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt520_cl4:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt520_cl4
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH apmt520_cl4 INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,
       g_pmds_m.pmds002,g_pmds_m.pmds001,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,
       g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds081,g_pmds_m.pmds045,
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,
       g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,
       g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,
       g_pmds_m.pmds040,g_pmds_m.pmds041,g_pmds_m.pmds042,
       g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   
 
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE apmt520_cl4
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL apmt520_show()

   INPUT BY NAME g_pmds_m.pmds052 WITHOUT DEFAULTS

      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG THEN
            LET INT_FLAG = FALSE
            CLOSE apmt520_cl4
            CALL s_transaction_end('N','0')
            RETURN
         END IF

      AFTER FIELD pmds052
        

   END INPUT

   IF INT_FLAG OR g_pmds_m.pmds001 IS NULL THEN
      LET INT_FLAG = 0
      CLOSE apmt520_cl4
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   LET l_pmdsmoddt = cl_get_current()

   UPDATE pmds_t SET pmds052 = g_pmds_m.pmds052,
                     pmdsmodid = g_user,
                     pmdsmoddt = l_pmdsmoddt
     WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "pmds_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt520_cl4
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CLOSE apmt520_cl4
   CALL s_transaction_end('Y','0')

END FUNCTION
#取得產品特徵類別
PRIVATE FUNCTION apmt520_get_imaa005(p_enterprise,p_imaa001)
   DEFINE p_enterprise   LIKE type_t.num5,
          p_imaa001      LIKE imaa_t.imaa001
   DEFINE r_imaa005      LIKE imaa_t.imaa005

   LET r_imaa005 = ''
   SELECT imaa005 INTO r_imaa005 
     FROM imaa_t 
    WHERE imaaent = p_enterprise 
      AND imaa001 = p_imaa001
      
   RETURN r_imaa005   
   
END FUNCTION
#根據不同的參數，toolbar選擇顯示或隱藏
PRIVATE FUNCTION apmt520_act_visible_init()
DEFINE l_gzze003   LIKE gzze_t.gzze003

   #CALL cl_set_toolbaritem_visible("gen_pmdt,gen_pmdv,upd_pmds081,upd_pmds052,upd_price,gen_warehouse_voucher,gen_purchase,gen_check_back,query_check_back,query_warehouse_voucher,gen_pmdw,query_detail_aapt110_01,query_aapt110_01,gen_qc,store_in_by_qc,get_detail_price,query_qc,gen_aapp320,gen_aapp320_7,s_lot_ins",TRUE) #170118-00051#1
   CALL cl_set_toolbaritem_visible("gen_pmdt,gen_pmdv,upd_pmds081,upd_pmds052,upd_price,gen_purchase,query_check_back,query_warehouse_voucher,gen_pmdw,query_detail_aapt110_01,query_aapt110_01,gen_qc,store_in_by_qc,get_detail_price,query_qc,gen_aapp320,gen_aapp320_7,s_lot_ins",TRUE) #170118-00051#1

   CALL cl_set_toolbaritem_visible("gen_warehouse_or_check_back",TRUE)    #170118-00051#1
      
   CALL cl_set_toolbaritem_visible("gen_asft335,gen_asft340",TRUE) #151023-00018#1 add
    CALL cl_set_toolbaritem_visible("scan_barcode",TRUE)   #160831-00070#14 20161013 add by beckxie
    
   #委外入庫單下，顯示產生倒扣料
   CALL cl_set_toolbaritem_visible("gen_asft314",TRUE)  #160128-00023#1 add
   
   IF NOT (g_argv[1] MATCHES '[13]' OR g_argv[1] = '23' OR g_argv[1] = '24') THEN   #採購收貨單
      CALL cl_set_toolbaritem_visible("gen_pmdt,gen_pmdv",FALSE)
   END IF

   #驗退、倉退下顯示取回日期，取回功能
   IF NOT (g_argv[1] MATCHES '[57]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '14' OR g_argv[1] = '15') THEN
      CALL cl_set_toolbaritem_visible("upd_pmds081",FALSE)
   END IF 
   
   #驗退、倉退下隱藏供應商出貨日功能
   IF g_argv[1] MATCHES '[57]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26' THEN
      CALL cl_set_toolbaritem_visible("upd_pmds052",FALSE)
   END IF 
   
   #入庫、倉退下顯示可以修改價格
   #IF NOT (g_argv[1] MATCHES '[1346789]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15') THEN
   #   CALL cl_set_toolbaritem_visible("upd_price",FALSE)
   #END IF 
   
   IF NOT (g_argv[1] MATCHES '[3467]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' OR g_argv[1] = '20' ) THEN
      CALL cl_set_toolbaritem_visible("query_detail_aapt110_01,query_aapt110_01",FALSE)
   END IF 
   
   #收貨單 下 可以顯示產生入庫單
   IF NOT (g_argv[1] MATCHES '[1289]' OR g_argv[1] = '23') THEN
      #CALL cl_set_toolbaritem_visible("gen_warehouse_voucher,query_warehouse_voucher,gen_qc,query_qc",FALSE)  #170118-00051#1
      CALL cl_set_toolbaritem_visible("gen_warehouse_or_check_back,query_warehouse_voucher,gen_qc,query_qc",FALSE)
   END IF
   
   IF NOT (g_argv[1] MATCHES '[1289]' ) THEN
      #CALL cl_set_toolbaritem_visible("gen_check_back,query_check_back",FALSE)   #170118-00051#1
      CALL cl_set_toolbaritem_visible("query_check_back",FALSE)   #170118-00051#1
   END IF
   
   #當倉退方式為2,3時才可以執行此action產生新的一張採購單
   IF NOT (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15') THEN
      CALL cl_set_toolbaritem_visible("gen_purchase",FALSE)
   END IF
   
   #當涉及到收貨時，可以執行維護進項發票信息的action
   IF NOT (g_argv[1] MATCHES '[123489]' OR g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '20' ) THEN
      CALL cl_set_toolbaritem_visible("gen_pmdw",FALSE)
   END IF
   
   #入庫 顯示產生IQC 及 根據IQC結果重新產生入庫單身明細
   IF NOT (g_argv[1] MATCHES '[6]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '25') THEN
      CALL cl_set_toolbaritem_visible("store_in_by_qc",FALSE)
   END IF
   
   #無採購的收貨單據可以對單身進行重新取價
   IF g_argv[1] NOT MATCHES '[24]' THEN   #採購收貨單
      CALL cl_set_toolbaritem_visible("get_detail_price",FALSE)
   END IF
   
   #入庫單據性質下，顯示產生入庫單發票的action
   IF NOT (g_argv[1] MATCHES '[346]' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '20' ) THEN
      CALL cl_set_toolbaritem_visible("gen_aapp320",FALSE)
   END IF
   #倉退單發票產生按鈕顯示為 倉退單發票產生
   IF NOT (g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' OR g_argv[1] = '26') THEN
      CALL cl_set_toolbaritem_visible("gen_aapp320_7",FALSE)
   END IF
   
   #判斷據點參數若收貨單使用製造批序號時，則製造批序號頁簽可以維護(據點參數:S-BAS-0049)
   IF (g_argv[1] MATCHES '[12895]' OR g_argv[1] = '10' OR g_argv[1] = '11') AND cl_get_para(g_enterprise,g_site,'S-BAS-0049') = 'N' THEN
      CALL cl_set_toolbaritem_visible("s_lot_ins",FALSE)
   END IF  
   
   IF g_argv[1] = '23' OR g_argv[1] = '24' OR g_argv[1] = '25' OR g_argv[1] = '26' THEN
      CALL cl_set_comp_visible("page_8",FALSE)
   END IF
   
   #151023-00018#1----add---begin---
   #委外入庫單下，顯示產生報工單，工單入庫單
   IF NOT (g_argv[1] = '12' OR g_argv[1] = '20') THEN
      CALL cl_set_toolbaritem_visible("gen_asft335,gen_asft340",FALSE)
      
      #委外入庫單下，顯示產生倒扣料
      CALL cl_set_toolbaritem_visible("gen_asft314",FALSE)  #160128-00023#1 add
   END IF
   #151023-00018#1----add---end--- 
   #160831-00070#14 20161013 add by beckxie---S
   #有掃碼邏輯才開放使用
   IF g_argv[1] NOT MATCHES '[1467]' AND g_argv[1] != '12' THEN
      CALL cl_set_toolbaritem_visible("scan_barcode",FALSE)   
   END IF
   #160831-00070#14 20161013 add by beckxie---E
   #161024-00023#1 Add By Ken 161026(S)
   IF g_argv[1] != '8' THEN
      CALL cl_set_toolbaritem_visible("gen_aint701",FALSE)   
   END IF   
   #161024-00023#1 Add By Ken 161026(E)
END FUNCTION
#在收貨單上 直接產生驗退單
PRIVATE FUNCTION apmt520_gen_check_back()
#161124-00048#11 mod-S
#DEFINE l_pmds_m      RECORD LIKE pmds_t.*
DEFINE l_pmds_m RECORD  #收貨/入庫單頭檔
       pmdsent LIKE pmds_t.pmdsent, #企業編號
       pmdssite LIKE pmds_t.pmdssite, #營運據點
       pmdsdocno LIKE pmds_t.pmdsdocno, #單據單號
       pmdsdocdt LIKE pmds_t.pmdsdocdt, #單據日期
       pmds000 LIKE pmds_t.pmds000, #單據性質
       pmds001 LIKE pmds_t.pmds001, #扣帳日期
       pmds002 LIKE pmds_t.pmds002, #申請人員
       pmds003 LIKE pmds_t.pmds003, #申請部門
       pmds006 LIKE pmds_t.pmds006, #來源單號
       pmds007 LIKE pmds_t.pmds007, #採購供應商
       pmds008 LIKE pmds_t.pmds008, #帳款供應商
       pmds009 LIKE pmds_t.pmds009, #送貨供應商
       pmds010 LIKE pmds_t.pmds010, #供應商送貨單號
       pmds011 LIKE pmds_t.pmds011, #採購性質
       pmds012 LIKE pmds_t.pmds012, #採購通路
       pmds013 LIKE pmds_t.pmds013, #採購分類
       pmds014 LIKE pmds_t.pmds014, #多角性質
       pmds021 LIKE pmds_t.pmds021, #LC進口
       pmds022 LIKE pmds_t.pmds022, #進口日期
       pmds023 LIKE pmds_t.pmds023, #進口報單
       pmds024 LIKE pmds_t.pmds024, #進口號碼
       pmds028 LIKE pmds_t.pmds028, #一次性交易對象識別碼
       pmds031 LIKE pmds_t.pmds031, #付款條件
       pmds032 LIKE pmds_t.pmds032, #交易條件
       pmds033 LIKE pmds_t.pmds033, #稅別
       pmds034 LIKE pmds_t.pmds034, #稅率
       pmds035 LIKE pmds_t.pmds035, #單價含稅否
       pmds036 LIKE pmds_t.pmds036, #交易類型
       pmds037 LIKE pmds_t.pmds037, #幣別
       pmds038 LIKE pmds_t.pmds038, #匯率
       pmds039 LIKE pmds_t.pmds039, #取價方式
       pmds040 LIKE pmds_t.pmds040, #付款優惠條件
       pmds041 LIKE pmds_t.pmds041, #多角序號
       pmds042 LIKE pmds_t.pmds042, #整合單號
       pmds043 LIKE pmds_t.pmds043, #採購總未稅金額
       pmds044 LIKE pmds_t.pmds044, #採購總含稅金額
       pmds045 LIKE pmds_t.pmds045, #備註
       pmds046 LIKE pmds_t.pmds046, #採購總稅額
       pmds047 LIKE pmds_t.pmds047, #多角貿易中斷點
       pmds048 LIKE pmds_t.pmds048, #內外購
       pmds049 LIKE pmds_t.pmds049, #匯率計算基準
       pmds050 LIKE pmds_t.pmds050, #多角貿易已拋轉
       pmds051 LIKE pmds_t.pmds051, #出貨單號
       pmds052 LIKE pmds_t.pmds052, #供應商出貨日
       pmds053 LIKE pmds_t.pmds053, #多角流程編號
       pmds081 LIKE pmds_t.pmds081, #取回日期
       pmds100 LIKE pmds_t.pmds100, #倉退方式
       pmds101 LIKE pmds_t.pmds101, #折讓日期
       pmds102 LIKE pmds_t.pmds102, #折讓原始發票
       pmdsownid LIKE pmds_t.pmdsownid, #資料所屬者
       pmdsowndp LIKE pmds_t.pmdsowndp, #資料所有部門
       pmdscrtid LIKE pmds_t.pmdscrtid, #資料建立者
       pmdscrtdp LIKE pmds_t.pmdscrtdp, #資料建立部門
       pmdscrtdt LIKE pmds_t.pmdscrtdt, #資料創建日
       pmdsmodid LIKE pmds_t.pmdsmodid, #資料修改者
       pmdsmoddt LIKE pmds_t.pmdsmoddt, #最近修改日
       pmdscnfid LIKE pmds_t.pmdscnfid, #資料確認者
       pmdscnfdt LIKE pmds_t.pmdscnfdt, #資料確認日
       pmdspstid LIKE pmds_t.pmdspstid, #資料過帳者
       pmdspstdt LIKE pmds_t.pmdspstdt, #資料過帳日
       pmdsstus LIKE pmds_t.pmdsstus, #狀態碼
       pmds200 LIKE pmds_t.pmds200, #收貨預約單號
       pmds054 LIKE pmds_t.pmds054, #資料來源
       pmds055 LIKE pmds_t.pmds055, #來源單號
       pmds201 LIKE pmds_t.pmds201, #來源單號
       pmds202 LIKE pmds_t.pmds202, #來源類型
       pmdsunit LIKE pmds_t.pmdsunit, #應用執行組織物件
       pmds056 LIKE pmds_t.pmds056, #No use
       pmds057 LIKE pmds_t.pmds057, #整合來源
       pmds058 LIKE pmds_t.pmds058, #倒扣領料單號
       pmds103 LIKE pmds_t.pmds103 #折讓證明單開立方式
#       pmds025 LIKE pmds_t.pmds025  #保稅異動原因代碼
END RECORD
#161124-00048#11 mod-E
DEFINE l_success     LIKE type_t.num5
DEFINE l_oobn003     LIKE oobn_t.oobn003
DEFINE ls_sql        STRING
DEFINE l_pmdscrtdt   DATETIME YEAR TO SECOND
DEFINE l_pmdtseq     LIKE pmdt_t.pmdtseq
DEFINE l_n           LIKE type_t.num10
DEFINE l_prog        LIKE type_t.chr20     #作業編號 (gzzz001)
#161124-00048#11 mod-S
#DEFINE l_pmdt_s      RECORD LIKE pmdt_t.*   #來源單據 收貨單
#DEFINE l_pmdt_p      RECORD LIKE pmdt_t.*   #目的單據 入庫單
DEFINE l_pmdt_s RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
DEFINE l_pmdt_p RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
#161124-00048#11 mod-E
DEFINE l_xrcd104     LIKE xrcd_t.xrcd104
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
DEFINE l_rate        LIKE inaj_t.inaj014
DEFINE l_flag        LIKE type_t.num5
DEFINE l_pmdt020     LIKE pmdt_t.pmdt020
DEFINE r_success     LIKE type_t.num5
DEFINE l_n1          LIKE type_t.num10
DEFINE l_n2          LIKE type_t.num10

    LET r_success = TRUE
    
    IF g_pmds_m.pmdsdocno IS NULL  THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "" 
       LET g_errparam.code   = "std-00003" 
       LET g_errparam.popup  = FALSE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    IF g_pmds_m.pmdsstus <> 'Y' THEN
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #存在驗退數量(收貨數量-允收數量) > 0的單身
    #料件需QC時，收貨數量- 允收數量 > 0
    #料件不走QC時，收貨數量（允收數量） - 已入庫量 - 已驗退量 > 0
    LET l_n1 = 0
    SELECT COUNT(1) INTO l_n1 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt053 - pmdt054 - pmdt055 ) > 0 AND pmdt026 = 'N'

    LET l_n2 = 0
    SELECT COUNT(1) INTO l_n2 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt020 - pmdt053 ) > 0 AND pmdt026 = 'Y'
    
    
    IF (l_n1 = 0 OR cl_null(l_n1)) AND (l_n2 = 0 OR cl_null(l_n2)) THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = g_pmds_m.pmdsdocno
       LET g_errparam.code   = 'apm-00643'
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #如果需要走IQC的判斷是否有維護IQC單
    LET l_n1 = 0
    SELECT COUNT(pmdtseq) INTO l_n1 FROM pmdt_t,qcba_t 
       WHERE pmdtent=qcbaent AND pmdtdocno = qcba001 AND pmdtseq = qcba002 AND pmdt026 = 'Y' AND qcbastus = 'Y' AND pmdtdocno=g_pmds_m.pmdsdocno
    SELECT COUNT(1) INTO l_n2 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdt026 = 'N'
    IF l_n1 = 0 AND l_n2 = 0 THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = g_pmds_m.pmdsdocno
       LET g_errparam.code   = 'apm-00819'
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    CALL s_transaction_begin()
   
    OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
    IF STATUS THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "OPEN apmt520_cl:" 
       LET g_errparam.code   = STATUS 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    IF NOT s_apmt520_gen_pmds('2',g_pmds_m.pmdsdocno) THEN
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    CALL s_transaction_end('Y','0')
    #INITIALIZE g_errparam TO NULL
    #LET g_errparam.code = 'apm-00644'
    #LET g_errparam.extend = ''
    #LET g_errparam.popup = TRUE
    #LET g_errparam.replace[1] = l_pmds_m.pmdsdocno
    #CALL cl_err()
    
    RETURN r_success
    
END FUNCTION

#驗退、入庫、倉退時，檢查對應收貨單號的收貨項次
PRIVATE FUNCTION apmt520_pmdt028_chk()
DEFINE l_n          LIKE type_t.num5
DEFINE r_success    LIKE type_t.num5

        LET r_success = TRUE
       
        #驗退、入庫、倉退時，檢查對應收貨單號的收貨項次
        IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
           #1.輸入的收貨項次需存在單頭輸入的收貨單號對應的收貨明細中
           LET l_n = 0
           SELECT COUNT(1) INTO l_n FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmds006 AND pmdtseq = g_pmdt_d[l_ac].pmdt028
           IF l_n = 0 OR cl_null(l_n) THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'apm-00450'
              LET g_errparam.extend = g_pmdt_d[l_ac].pmdt028
              LET g_errparam.popup = TRUE
              CALL cl_err()

              LET r_success = FALSE
              RETURN r_success
           END IF
           
           IF NOT s_apmt520_chk_pmdt020(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,'',g_pmdt_d[l_ac].pmdt028,0,0,'',0,0) THEN
              LET r_success = FALSE
              RETURN r_success
           END IF
        END IF
               
        RETURN r_success
        
END FUNCTION

#在入庫單上，根據來源收貨單號產生IQC單
PRIVATE FUNCTION apmt520_gen_iqc()
DEFINE l_pmdsdocdt    LIKE pmds_t.pmdsdocdt
DEFINE l_pmdtseq      LIKE pmdt_t.pmdtseq
DEFINE l_success      LIKE type_t.num5
DEFINE l_start_no     LIKE pmds_t.pmdsdocno
DEFINE l_end_no       LIKE pmds_t.pmdsdocno
DEFINE l_oobn003      LIKE oobn_t.oobn003
DEFINE l_prog         LIKE type_t.chr20     #作業編號 (gzzz001)

    LET l_success = TRUE
    
    IF g_pmds_m.pmdsdocno IS NULL THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "" 
       LET g_errparam.code   = "std-00003" 
       LET g_errparam.popup  = FALSE 
       CALL cl_err()
       RETURN
    END IF
    #IF g_pmds_m.pmds006 IS NULL  THEN
    #   INITIALIZE g_errparam TO NULL 
    #   LET g_errparam.extend = "" 
    #   LET g_errparam.code   = "std-00003" 
    #   LET g_errparam.popup  = FALSE 
    #   CALL cl_err()
    #   RETURN
    #END IF
    
    IF g_pmds_m.pmdsstus NOT MATCHES '[NY]' THEN
       RETURN
    END IF
    
    CALL s_transaction_begin()
   
    OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
    IF STATUS THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "OPEN apmt520_cl:" 
       LET g_errparam.code   = STATUS 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       RETURN
    END IF
    
    LET l_prog = "aqct300"
    
    #根據收貨單別 ，獲取後置入庫單別
    CALL s_aooi210_get_doc(g_site,'','4',g_pmds_m.pmdsdocno,l_prog,'') RETURNING l_success,l_oobn003
    IF NOT l_success THEN
       CALL s_transaction_end('N','0')
       RETURN
    END IF
    
    SELECT UNIQUE pmdssite,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003,pmdsstus,
       pmds006,pmds007,pmds008,pmds009,pmds010,pmds052,pmds000,pmds100, 
       pmds011,pmds014,pmds081,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031, 
       pmds032,pmds033,pmds034,pmds035,pmds036,pmds037,pmds038,pmds039,pmds040, 
       pmds012,pmds101,pmds102,pmds048,pmds047,pmds049,pmds053,pmds041,pmds042, 
       pmds043,pmds044,pmds046,pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt, 
       pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt,pmdspstid,pmdspstdt 
     INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmdsdocdt,g_pmds_m.pmds002,g_pmds_m.pmds001,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006, 
       g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds000, 
       g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033, 
       g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039, 
       g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds048,g_pmds_m.pmds047, 
       g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds042,g_pmds_m.pmds043,g_pmds_m.pmds044, 
       g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt
    FROM pmds_t WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
    
    DECLARE gen_qc_cs CURSOR FOR
       SELECT pmdtseq FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
    FOREACH gen_qc_cs INTO l_pmdtseq
       #CALL s_aqct300_gen('1',g_pmds_m.pmdsdocno,l_pmdtseq,l_oobn003,g_pmds_m.pmdsdocdt)  #160805-00008#1
       CALL s_aqct300_gen('1',g_pmds_m.pmdsdocno,l_pmdtseq,l_oobn003,g_today)  #160805-00008#1
            RETURNING l_success,l_start_no,l_end_no
       IF NOT l_success THEN
          INITIALIZE g_errparam TO NULL 
          LET g_errparam.extend = "" 
          LET g_errparam.code   = "" 
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
          EXIT FOREACH
       END IF
    END FOREACH
    
    CLOSE apmt520_cl
    
    IF NOT l_success THEN
       CALL s_transaction_end('N','0')
    ELSE
       CALL s_transaction_end('Y','0')
       #161215-00081#1  add --begin--
       INITIALIZE g_errparam TO NULL
       IF cl_null(l_start_no) THEN
          LET g_errparam.code = 'apm-01148'
       ELSE
          LET g_errparam.code = 'ain-00399'
       END IF
       LET g_errparam.extend = ''
       LET g_errparam.popup = TRUE
       CALL cl_err()
       #161215-00081#1  add --end--
    END IF
      
    
   #161215-00081#1  add   --begin-- 
   #移到上面
   #INITIALIZE g_errparam TO NULL
   #LET g_errparam.code = 'ain-00399'
   #LET g_errparam.extend = ''
   #LET g_errparam.popup = TRUE
   #CALL cl_err()
   #161215-00081#1  add   --end--
   
END FUNCTION

#輸入的料件+產品特徵+庫存管理特徵+庫位必須存在[T:庫存明細檔]中
PRIVATE FUNCTION apmt520_chk_inag004(p_pmdt016)
DEFINE p_pmdt016   LIKE pmdt_t.pmdt016
DEFINE r_success   LIKE type_t.num5
DEFINE l_imaf055   LIKE imaf_t.imaf055  #160519-00008#16
      
      LET r_success = TRUE
      
      IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
         LET g_pmdt_d[l_ac].pmdt007 = ' '
      END IF
      #160519-00008#16-s
      SELECT imaf055 INTO l_imaf055 FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite = g_site
         AND imaf001 = g_pmdt_d[l_ac].pmdt006
      IF l_imaf055 <> '1' THEN   
      #160519-00008#16-e   
         IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
            LET g_pmdt_d[l_ac].pmdt063 = ' '
         END IF
      END IF  #160519-00008#16
      #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
      INITIALIZE g_chkparam.* TO NULL
      
      #設定g_chkparam.*的參數
      LET g_chkparam.arg1 = g_site
      LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt006
      LET g_chkparam.arg3 = g_pmdt_d[l_ac].pmdt007
      LET g_chkparam.arg4 = g_pmdt_d[l_ac].pmdt063
      LET g_chkparam.arg5 = p_pmdt016
      
      #呼叫檢查存在並帶值的library
      IF NOT cl_chk_exist("v_inag004") THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
         
      RETURN r_success
      
END FUNCTION
#輸入的料件+產品特徵+庫存管理特徵+庫位+儲位必須存在[T:庫存明細檔]中
PRIVATE FUNCTION apmt520_chk_inag005(p_pmdt016,p_pmdt017)
DEFINE p_pmdt016   LIKE pmdt_t.pmdt016
DEFINE p_pmdt017   LIKE pmdt_t.pmdt017
DEFINE r_success   LIKE type_t.num5
DEFINE l_imaf055   LIKE imaf_t.imaf055  #160519-00008#16

      LET r_success = TRUE   
      
      IF cl_null(p_pmdt017) THEN
         LET p_pmdt017 = ' '
      END IF
      #160519-00008#16-s
      SELECT imaf055 INTO l_imaf055 FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite = g_site
         AND imaf001 = g_pmdt_d[l_ac].pmdt006
      IF l_imaf055 <> '1' THEN   
      #160519-00008#16-e        
         IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
            LET g_pmdt_d[l_ac].pmdt063 = ' '
         END IF
      END IF  #160519-00008#16
      #若是倉退作業時，輸入的料件+產品特徵+庫存管理特徵+庫位必須存在[T:庫存明細檔]中
      IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
         LET g_pmdt_d[l_ac].pmdt007 = ' '
      END IF

      #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
      INITIALIZE g_chkparam.* TO NULL
      
      #設定g_chkparam.*的參數
      LET g_chkparam.arg1 = g_site
      LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt006
      LET g_chkparam.arg3 = g_pmdt_d[l_ac].pmdt007
      LET g_chkparam.arg4 = g_pmdt_d[l_ac].pmdt063
      LET g_chkparam.arg5 = p_pmdt016
      LET g_chkparam.arg6 = p_pmdt017
      
      #呼叫檢查存在並帶值的library
      IF NOT cl_chk_exist("v_inag005") THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
      RETURN r_success  
      
END FUNCTION

#儲位檢查
PRIVATE FUNCTION apmt520_pmdt017_chk()
DEFINE r_success   LIKE type_t.num5
DEFINE l_inaa007   LIKE inaa_t.inaa007  #160122-00017#1 add

      LET r_success = TRUE

      #160122-00017#1---add---begin---
      #储位管理若设置事前定义时，才需检验储位是否存在储位基本资料档中
      LET l_inaa007 = ''
      SELECT inaa007 INTO l_inaa007 FROM inaa_t WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_pmdt_d[l_ac].pmdt016
      IF l_inaa007 <> '1' THEN
         RETURN r_success  
      END IF
      #160122-00017#1--add--end-----
      
      INITIALIZE g_chkparam.* TO NULL
               
      #設定g_chkparam.*的參數
      LET g_chkparam.arg1 = g_site
      LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt016
      LET g_chkparam.arg3 = g_pmdt_d[l_ac].pmdt017

         
      #呼叫檢查存在並帶值的library
      IF NOT cl_chk_exist("v_inab002_1") THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
      ##倉退時 輸入的料件+產品特徵+庫存管理特徵+庫位+儲位必須存在[T:庫存明細檔]中
      #IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
      #   IF NOT apmt520_chk_inag005(g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017) THEN
      #      LET r_success = FALSE
      #      RETURN r_success  
      #   END IF
      #END IF
      RETURN r_success  
      
END FUNCTION

#對整個單身重新取價
PRIVATE FUNCTION apmt520_get_detail_price()
DEFINE l_forupd_sql STRING
DEFINE l_success    LIKE type_t.num5
#161124-00048#11 mod-S
#DEFINE l_pmdt       RECORD LIKE pmdt_t.*
DEFINE l_pmdt RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
#161124-00048#11 mod-E
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115 
   
   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF
   
   CALL s_transaction_begin()

   LET l_forupd_sql = "SELECT pmdssite,pmdsdocno,pmdsdocdt,pmds002,pmds001,pmds003, ",
                      " pmdsstus,pmds006,pmds007,pmds008,pmds009,pmds010,pmds000,pmds100,pmds011,pmds081, ",
                      " pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035,pmds036,", 
                      " pmds037,pmds038,pmds039,pmds040,pmds041,pmds042,pmds043,pmds044,pmds046 ",
                      " FROM pmds_t WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
                      
   LET l_forupd_sql = cl_sql_forupd(l_forupd_sql)                #轉換不同資料庫語法
   DECLARE apmt520_cl5 CURSOR FROM l_forupd_sql

   OPEN apmt520_cl5 USING g_enterprise,g_pmds_m.pmdsdocno
 
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt520_cl5:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE apmt520_cl5
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH apmt520_cl5 INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,
       g_pmds_m.pmds002,g_pmds_m.pmds001,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds006,g_pmds_m.pmds007,
       g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds081,g_pmds_m.pmds045,
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,
       g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,
       g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,
       g_pmds_m.pmds040,g_pmds_m.pmds041,g_pmds_m.pmds042,
       g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   
 
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE apmt520_cl5
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL apmt520_show()
   
   #161124-00048#11 mod-S
#   DECLARE get_price_cs CURSOR FOR
#       SELECT * FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
   DECLARE get_price_cs CURSOR FOR
       SELECT pmdtent,pmdtsite,pmdtdocno,pmdtseq,pmdt001,
              pmdt002,pmdt003,pmdt004,pmdt005,pmdt006,
              pmdt007,pmdt008,pmdt009,pmdt010,pmdt011,
              pmdt016,pmdt017,pmdt018,pmdt019,pmdt020,
              pmdt021,pmdt022,pmdt023,pmdt024,pmdt025,
              pmdt026,pmdt027,pmdt028,pmdt036,pmdt037,
              pmdt038,pmdt039,pmdt040,pmdt041,pmdt042,
              pmdt043,pmdt044,pmdt045,pmdt046,pmdt047,
              pmdt051,pmdt052,pmdt053,pmdt054,pmdt055,
              pmdt056,pmdt057,pmdt058,pmdt059,pmdt060,
              pmdt061,pmdt062,pmdt063,pmdt064,pmdt065,
              pmdt066,pmdt067,pmdt068,pmdt069,pmdt081,
              pmdt082,pmdt083,pmdt084,pmdt085,pmdt086,
              pmdt087,pmdt088,pmdt089,pmdt900,pmdt999,
              pmdt200,pmdt201,pmdt202,pmdt203,pmdt204,
              pmdt205,pmdt206,pmdt207,pmdt208,pmdt209,
              pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga,
              pmdt070,pmdt071,pmdt214,pmdt215,pmdt048,
              pmdt216,pmdt217,pmdt090,pmdt091,pmdt092,
              pmdt093,pmdt218,pmdt219,pmdt072,pmdt073,
              pmdt074,pmdt227,pmdt049,pmdt050,pmdt075,
              pmdt220,pmdt221 
         FROM pmdt_t 
        WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
   #161124-00048#11 mod-E

   CALL cl_err_collect_init()

   FOREACH get_price_cs INTO l_pmdt.*
   
      IF cl_null(l_pmdt.pmdt023) OR cl_null(l_pmdt.pmdt024) THEN 
         LET l_pmdt.pmdt023 = l_pmdt.pmdt019
         LET l_pmdt.pmdt024 = l_pmdt.pmdt020
      END IF
      
      CALL s_apmt520_get_price(g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds039,g_pmds_m.pmds007,l_pmdt.pmdt006,l_pmdt.pmdt007,
                               g_pmds_m.pmds037,l_pmdt.pmdt046,g_pmds_m.pmds031,g_pmds_m.pmds032,
                               g_pmds_m.pmds012,l_pmdt.pmdt023,
                               l_pmdt.pmdt024,g_site,g_pmds_m.pmds048,'1',l_pmdt.pmdt009,
                               l_pmdt.pmdt010)          
          RETURNING l_pmdt.pmdt042,l_pmdt.pmdt044,l_pmdt.pmdt043,l_pmdt.pmdt048

      LET l_pmdt.pmdt036 = l_pmdt.pmdt044
      LET l_pmdt.pmdt045 = 0
      
      #重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
      IF (NOT cl_null(l_pmdt.pmdt024)) AND (NOT cl_null(l_pmdt.pmdt046)) THEN
         CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq,l_pmdt.pmdt001,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046)
           RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039            
      END IF
          
      UPDATE pmdt_t SET pmdt042 = l_pmdt.pmdt042,
                        pmdt044 = l_pmdt.pmdt044,
                        pmdt043 = l_pmdt.pmdt043,
                        pmdt036 = l_pmdt.pmdt036,
                        pmdt045 = 0,
                        pmdt038 = l_pmdt.pmdt038,
                        pmdt047 = l_pmdt.pmdt047,
                        pmdt039 = l_pmdt.pmdt039,
                        pmdt048 = l_pmdt.pmdt048
       WHERE pmdtent = g_enterprise 
         AND pmdtdocno = g_pmds_m.pmdsdocno
         AND pmdtseq = l_pmdt.pmdtseq  
         
        #更新交期明細資料
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "pmdt_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
      
      END IF   
   END FOREACH
   
   CALL s_tax_recount(g_pmds_m.pmdsdocno)
     RETURNING g_pmds_m.pmds043,g_pmds_m.pmds046,g_pmds_m.pmds044,l_xrcd113,l_xrcd114,l_xrcd115
   UPDATE pmds_t SET pmds043 = g_pmds_m.pmds043,
                     pmds044 = g_pmds_m.pmds044,
                     pmds046 = g_pmds_m.pmds046
       WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
   
   #151124-00015#1-mod-(S)   
#   CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt
   CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING l_success
   ##151124-00015#1-mod-(E)
   
   CALL cl_err_collect_show()
  
   CALL s_transaction_end('Y','0')
   CLOSE apmt520_cl5
   
   CALL apmt520_b_fill() 
   

   
   
END FUNCTION

#判斷料號是否使用計價單位
PRIVATE FUNCTION apmt520_get_imaf144(p_imaf001)
DEFINE p_imaf001   LIKE imaf_t.imaf001
DEFINE l_imaf144   LIKE imaf_t.imaf144
DEFINE r_success   LIKE type_t.num5

      LET r_success = TRUE
      LET l_imaf144 = ''
      SELECT imaf144 INTO l_imaf144 FROM imaf_t WHERE imafent = g_enterprise AND imaf001 = p_imaf001 AND imafsite = g_site
      IF cl_null(l_imaf144) THEN
         LET r_success = FALSE
      END IF
      RETURN r_success
      
END FUNCTION

################################################################################
# Descriptions...: 中斷續拋否
# Memo...........:
# Usage..........: CALL apmt520_break_continue(p_pmds053)
#                  RETURNING r_success
# Input parameter: p_pmds053   多角流程代碼
#                : 
# Return code....: r_success   執行結果
#                : 
# Date & Author..: 150610 By earl
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_break_continue(p_pmds053)
   DEFINE p_pmds053   LIKE pmds_t.pmds053
   DEFINE r_success   LIKE type_t.num5
   DEFINE l_sel       RECORD
      icaa004            LIKE icaa_t.icaa004,
      icaa005            LIKE icaa_t.icaa005,
      icab003            LIKE icab_t.icab003
                      END RECORD

   LET r_success = FALSE

   IF NOT cl_null(p_pmds053) THEN
      INITIALIZE l_sel.* TO NULL
      SELECT icaa004,icaa005,
             icab003
        INTO l_sel.icaa004,l_sel.icaa005,
             l_sel.icab003
        FROM icaa_t LEFT OUTER JOIN icab_t ON icabent = icaaent AND icab001 = icaa001 AND icab002 = 0
       WHERE icaaent = g_enterprise
         AND icaa001 = p_pmds053

      IF l_sel.icaa004 = '2' AND
         l_sel.icaa005 = 'Y' AND
         l_sel.icab003 = g_site THEN

         LET r_success = TRUE
         RETURN r_success
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 多角序號檢查
# Memo...........:
# Usage..........: CALL apmt520_source_pmds041_chk(p_source,p_pmds041)
#                  RETURNING r_success
# Input parameter: p_source   來源單號
#                : p_pmds041  多角流程序號
# Return code....: r_success  執行結果
#                : 
# Date & Author..: 150610 By earl
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_source_pmds041_chk(p_source,p_pmds041)
   DEFINE p_source      LIKE pmds_t.pmds006  #來源單號
   DEFINE p_pmds041     LIKE pmds_t.pmds041

   DEFINE r_success     LIKE type_t.num5
   DEFINE l_cnt         LIKE type_t.num5

   LET r_success = TRUE

   IF NOT cl_null(p_pmds041) THEN
      #檢查初始站是否重複
      LET l_cnt = 0
      SELECT COUNT(pmdsdocno) INTO l_cnt
        FROM pmds_t
       WHERE pmdsent = g_enterprise
         AND pmds000 = g_pmds_m.pmds000
         AND pmds041 = p_pmds041
         AND pmdsdocno <> g_pmds_m.pmdsdocno
         AND pmdsstus <> 'X'
         AND pmdssite = g_site

      IF cl_null(l_cnt) THEN
         LET l_cnt = 0
      END IF
      
      IF l_cnt > 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00943'   #該"多角流程序號"已存在初始站之"入庫單"，不可重複輸入！
         LET g_errparam.extend = p_pmds041
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success
      END IF

      #檢查是否有已拋轉之逆拋入庫單
      LET l_cnt = 0
      SELECT COUNT(pmdsdocno) INTO l_cnt
        FROM pmds_t
       WHERE pmdsent = g_enterprise
         AND pmds000 IN ('3','20','6','12')     #3.採購收貨入庫,20.委外收貨入庫,6入庫單,12委外入庫
         AND pmds041 = p_pmds041
         AND pmdsstus <> 'X'
         AND pmds050 = 'Y'
         AND pmdssite = (SELECT icab003 FROM icab_t
                          WHERE icabent = g_enterprise
                            AND icab001 = pmds053
                            AND icab002 = (SELECT MAX(icab002) FROM icab_t
                                            WHERE icabent = g_enterprise
                                              AND icab001 = pmds053)
                        )
      
      #150622
      #代採購最終站無入庫單，改抓出貨單
      IF l_cnt = 0 OR cl_null(l_cnt) THEN
         SELECT COUNT(xmdkdocno) INTO l_cnt
           FROM xmdk_t
          WHERE xmdkent = g_enterprise
            AND xmdk000 = '1'
            AND xmdk035 = p_pmds041
            AND xmdkstus <> 'X'
            AND xmdk083 = 'Y'
            AND xmdksite = (SELECT icab003 FROM icab_t
                             WHERE icabent = g_enterprise
                               AND icab001 = xmdk044
                               AND icab002 = (SELECT MAX(icab002) FROM icab_t
                                               WHERE icabent = g_enterprise
                                                 AND icab001 = xmdk044)
                           )      
      END IF
      
      IF cl_null(l_cnt) THEN
         LET l_cnt = 0
      END IF

      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00944'   #該"多角流程序號"不存在已拋轉之"入庫單"，不可輸入！
         LET g_errparam.extend = p_pmds041
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success
      END IF

      IF NOT cl_null(p_source) THEN
         #檢查是否有已拋轉之入庫單，且對應相對來源單號
         LET l_cnt = 0
         
         CALL apmt520_sel_pmds041(p_source,p_pmds041) RETURNING l_cnt,p_pmds041
         
         IF cl_null(l_cnt) THEN
            LET l_cnt = 0
         END IF

         IF l_cnt = 0 THEN
            INITIALIZE g_errparam TO NULL

            LET g_errparam.code = 'axm-00654'   #該"多角流程序號"與"來源單號"不存在對應關係，不可輸入！
            LET g_errparam.extend = p_pmds041
            LET g_errparam.popup = TRUE
            CALL cl_err()

            LET r_success = FALSE
            RETURN r_success
         END IF

      END IF
   END IF

   RETURN r_success

END FUNCTION

################################################################################
# Descriptions...: 取得多角流程代碼
# Memo...........:
# Usage..........: CALL apmt520_sel_pmds041(p_source,p_pmds041)
#                  RETURNING r_success
# Input parameter: p_source  #來源單號
#                : p_pmds041 #多角流程序號
# Return code....: r_success #執行結果
#                : 
# Date & Author..: 150611 By earl
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_sel_pmds041(p_source,p_pmds041)
   DEFINE p_source  LIKE pmds_t.pmds006 #來源單號
   DEFINE p_pmds041 LIKE pmds_t.pmds041 #多角流程序號(可為Null)
   DEFINE r_cnt     LIKE type_t.num10   #符合之多角流程序號數量
   DEFINE r_pmds041 LIKE pmds_t.pmds041 #多角流程序號

   DEFINE l_sql         STRING
   DEFINE l_sql_count   STRING
   DEFINE l_sql_sel     STRING
   DEFINE l_sql_from    STRING
   DEFINE l_sql_where   STRING
   DEFINE l_pmds014 LIKE pmds_t.pmds014 #多角性質

   LET l_pmds014 = ''
   #來源收獲單
   SELECT pmds014 INTO l_pmds014
     FROM pmds_t
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = p_source
   #來源採購單
   IF cl_null(l_pmds014) THEN
      SELECT pmdl006 INTO l_pmds014
        FROM pmdl_t
       WHERE pmdlent = g_enterprise
         AND pmdldocno = p_source
   END IF

   IF l_pmds014 = '2' THEN #2:代採購
      LET l_sql_count =   "SELECT COUNT( DISTINCT a.xmdk035)"
      LET l_sql_sel =     "SELECT DISTINCT a.xmdk035"
      
      LET l_sql_from =    "  FROM xmdk_t a",
                          " WHERE a.xmdkent = ",g_enterprise,
                          "   AND a.xmdkstus <> 'X'",
                          "   AND a.xmdk083 = 'Y'",
                          #逆拋最終站
                          "   AND a.xmdksite = (SELECT icab003 FROM icab_t",
                          "                      WHERE icabent = ",g_enterprise,
                          "                        AND icab001 = a.xmdk044",
                          "                        AND icab002 = (SELECT MAX(icab002) FROM icab_t",
                          "                                        WHERE icabent = ",g_enterprise,
                          "                                          AND icab001 = a.xmdk044))",
                          #排除已續拋之單號
                          "   AND a.xmdk035 NOT IN (SELECT b.pmds041 FROM pmds_t b",
                          "                          WHERE b.pmdsent = ",g_enterprise,
                          "                            AND b.pmds000 = '",g_pmds_m.pmds000,"'",
                          "                            AND b.pmdssite = '",g_site,"'",
                          "                            AND b.pmdsdocno <> '",g_pmds_m.pmdsdocno,"'",
                          "                            AND b.pmdsstus <> 'X'",
                          "                            AND b.pmds041 IS NOT NULL)"
                          
      IF NOT cl_null(p_pmds041) THEN
         LET l_sql_from = l_sql_from," AND a.xmdk035 = '",p_pmds041,"'"
      END IF
      
      #來源採購單
      LET l_sql_where =   "   AND ((a.xmdk000 IN ('1')",
                          "          AND a.xmdk006 = (SELECT xmdadocno FROM xmda_t",
                          "                            WHERE xmdaent = ",g_enterprise,
                          "                              AND xmdasite = a.xmdksite",
                          "                              AND xmdastus <> 'X'",
                          "                              AND xmda030 = 'Y'",
                          "                              AND xmda031 = (SELECT pmdl031 FROM pmdl_t",
                          "                                              WHERE pmdlent = ",g_enterprise,
                          "                                                AND pmdldocno = '",p_source,"'",
                          "                                            )",
                          "                          )",
                          "       )",
      #來源收貨單                    
                          "    OR (a.xmdk000 IN ('1')",   #6入庫單,12委外入庫
                          "          AND a.xmdk006 = (SELECT c.xmdadocno FROM xmda_t c",
                          "                            WHERE c.xmdaent = ",g_enterprise,
                          "                              AND c.xmdasite = a.xmdksite",
                          "                              AND c.xmdastus <> 'X'",
                          "                              AND c.xmda030 = 'Y'",
                          "                              AND c.xmda031 = (SELECT d.pmds041 FROM pmds_t d",
                          "                                                WHERE d.pmdsent = ",g_enterprise,
                          "                                                  AND d.pmdsdocno = '",p_source,"'",
                          "                                              )",
                          "                           )",
                          "       ))"
      
   ELSE #3:代採購指定供應商
      LET l_sql_count =   "SELECT COUNT( DISTINCT a.pmds041)"
      LET l_sql_sel =     "SELECT DISTINCT a.pmds041"
      
      LET l_sql_from =    "  FROM pmds_t a",
                          " WHERE a.pmdsent = ",g_enterprise,
                          "   AND a.pmdsstus <> 'X'",
                          "   AND a.pmds050 = 'Y'",
                          #逆拋最終站
                          "   AND a.pmdssite = (SELECT icab003 FROM icab_t",
                          "                      WHERE icabent = ",g_enterprise,
                          "                        AND icab001 = a.pmds053",
                          "                        AND icab002 = (SELECT MAX(icab002) FROM icab_t",
                          "                                        WHERE icabent = ",g_enterprise,
                          "                                          AND icab001 = a.pmds053))",
                          #排除已續拋之單號
                          "   AND a.pmds041 NOT IN (SELECT b.pmds041 FROM pmds_t b",
                          "                          WHERE b.pmdsent = ",g_enterprise,
                          "                            AND b.pmds000 = '",g_pmds_m.pmds000,"'",
                          "                            AND b.pmdssite = '",g_site,"'",
                          "                            AND b.pmdsdocno <> '",g_pmds_m.pmdsdocno,"'",
                          "                            AND b.pmdsstus <> 'X'",
                          "                            AND b.pmds041 IS NOT NULL)"
                          
      IF NOT cl_null(p_pmds041) THEN
         LET l_sql_from = l_sql_from," AND a.pmds041 = '",p_pmds041,"'"
      END IF
      
      #來源採購單
      LET l_sql_where =   "   AND ((a.pmds000 IN ('1','8','3','20')",   #1.採購收貨8.委外收貨3.採購收貨入庫,20.委外收貨入庫
                          "          AND a.pmds006 = (SELECT pmdldocno FROM pmdl_t",
                          "                            WHERE pmdlent = ",g_enterprise,
                          "                              AND pmdlsite = a.pmdssite",
                          "                              AND pmdlstus <> 'X'",
                          "                              AND pmdl030 = 'Y'",
                          "                              AND pmdl031 = (SELECT pmdl031 FROM pmdl_t",
                          "                                              WHERE pmdlent = ",g_enterprise,
                          "                                                AND pmdldocno = '",p_source,"'",
                          "                                            )",
                          "                          )",
                          "       )",
      #來源收貨單                    
                          "    OR (a.pmds000 IN ('6','12')",   #6入庫單,12委外入庫
                          "          AND a.pmds006 = (SELECT c.pmdsdocno FROM pmds_t c",
                          "                            WHERE c.pmdsent = ",g_enterprise,
                          "                              AND c.pmdssite = a.pmdssite",
                          "                              AND c.pmdsstus <> 'X'",
                          "                              AND c.pmds050 = 'Y'",
                          "                              AND c.pmds041 = (SELECT d.pmds041 FROM pmds_t d",
                          "                                                WHERE d.pmdsent = ",g_enterprise,
                          "                                                  AND d.pmdsdocno = '",p_source,"'",
                          "                                              )",
                          "                           )",
                          "       ))"
   END IF
   
   LET r_cnt = 0
   LET r_pmds041 = p_pmds041

   IF NOT cl_null(p_source) THEN
   
      LET l_sql = l_sql_count,l_sql_from,l_sql_where

      PREPARE apmt520_aic_pre FROM l_sql
      EXECUTE apmt520_aic_pre INTO r_cnt
      
      IF cl_null(r_cnt) THEN
         LET r_cnt = 0
      END IF
      
      #若只有唯一一筆，SELECT
      IF r_cnt = 1 AND cl_null(p_pmds041) THEN
         
         LET l_sql = l_sql_sel,l_sql_from,l_sql_where
         
         PREPARE apmt520_aic_sel_pre FROM l_sql
         EXECUTE apmt520_aic_sel_pre INTO r_pmds041
         
      END IF
   END IF
   
   RETURN r_cnt,r_pmds041
END FUNCTION

################################################################################
# Descriptions...: 由多角流程代碼將續拋資料帶出
# Memo...........:
# Usage..........: CALL apmt520_default(p_pmdsdocno,p_pmds006,p_pmds053,p_pmds041)
#                  RETURNING r_success
# Input parameter: p_pmdsdocno   #單據單號
#                : p_pmds006     #來源單號
#                : p_pmds053     #多角代碼
#                : p_pmds041     #多角序號
# Return code....: 
#                : 
# Date & Author..: 150615 By earl
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_default(p_pmdsdocno,p_pmds006,p_pmds053,p_pmds041)
   DEFINE p_pmdsdocno   LIKE pmds_t.pmdsdocno
   DEFINE p_pmds006     LIKE pmds_t.pmds006
   DEFINE p_pmds053     LIKE pmds_t.pmds053
   DEFINE p_pmds041     LIKE pmds_t.pmds041
   
   DEFINE r_success     LIKE type_t.num5
   
   DEFINE l_sql         STRING
   DEFINE l_pmdssite    LIKE pmds_t.pmdssite
   DEFINE l_pmds007     LIKE pmds_t.pmds007
   DEFINE l_pmds037     LIKE pmds_t.pmds037
   DEFINE l_pmdt001     LIKE pmdt_t.pmdt001
   DEFINE l_xrcd103     LIKE xrcd_t.xrcd103
   DEFINE l_xrcd104     LIKE xrcd_t.xrcd104
   DEFINE l_xrcd105     LIKE xrcd_t.xrcd105
   DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
   DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
   DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
   DEFINE l_n           LIKE type_t.num10
   DEFINE l_pmds        RECORD
             pmds021       LIKE pmds_t.pmds021,
             pmds050       LIKE pmds_t.pmds050
                        END RECORD
   
   DEFINE l_pmdt        RECORD
             pmdtdocno     LIKE pmdt_t.pmdtdocno,
             pmdtseq       LIKE pmdt_t.pmdtseq,
             pmdt001       LIKE pmdt_t.pmdt001,
             pmdt002       LIKE pmdt_t.pmdt002,
             pmdt003       LIKE pmdt_t.pmdt003,
             pmdt004       LIKE pmdt_t.pmdt004,
             pmdt005       LIKE pmdt_t.pmdt005,
             pmdt006       LIKE pmdt_t.pmdt006,
             pmdt007       LIKE pmdt_t.pmdt007,
             pmdt008       LIKE pmdt_t.pmdt008,
             pmdt009       LIKE pmdt_t.pmdt009,
             pmdt010       LIKE pmdt_t.pmdt010,
             pmdt011       LIKE pmdt_t.pmdt011,
             
             pmdt016       LIKE pmdt_t.pmdt016,
             pmdt017       LIKE pmdt_t.pmdt017,
             pmdt018       LIKE pmdt_t.pmdt018,
             pmdt019       LIKE pmdt_t.pmdt019,
             pmdt020       LIKE pmdt_t.pmdt020,
             pmdt021       LIKE pmdt_t.pmdt021,
             pmdt022       LIKE pmdt_t.pmdt022,
             pmdt023       LIKE pmdt_t.pmdt023,
             pmdt024       LIKE pmdt_t.pmdt024,
             pmdt025       LIKE pmdt_t.pmdt025,
             pmdt026       LIKE pmdt_t.pmdt026,
             pmdt027       LIKE pmdt_t.pmdt027,
             pmdt028       LIKE pmdt_t.pmdt028,
             
             pmdt036       LIKE pmdt_t.pmdt036,
             pmdt037       LIKE pmdt_t.pmdt037,
             pmdt038       LIKE pmdt_t.pmdt038,
             pmdt039       LIKE pmdt_t.pmdt039,
             pmdt040       LIKE pmdt_t.pmdt040,
             pmdt041       LIKE pmdt_t.pmdt041,
             pmdt042       LIKE pmdt_t.pmdt042,
             pmdt043       LIKE pmdt_t.pmdt043,
             pmdt044       LIKE pmdt_t.pmdt044,
             pmdt045       LIKE pmdt_t.pmdt045,
             pmdt046       LIKE pmdt_t.pmdt046,
             pmdt047       LIKE pmdt_t.pmdt047,
             
             pmdt051       LIKE pmdt_t.pmdt051,
             pmdt052       LIKE pmdt_t.pmdt052,
             pmdt053       LIKE pmdt_t.pmdt053,
             pmdt054       LIKE pmdt_t.pmdt054,
             pmdt055       LIKE pmdt_t.pmdt055,
             pmdt056       LIKE pmdt_t.pmdt056,
             pmdt057       LIKE pmdt_t.pmdt057,
             pmdt058       LIKE pmdt_t.pmdt058,
             pmdt059       LIKE pmdt_t.pmdt059,
             pmdt060       LIKE pmdt_t.pmdt060,
             pmdt061       LIKE pmdt_t.pmdt061,
             pmdt062       LIKE pmdt_t.pmdt062,
             pmdt063       LIKE pmdt_t.pmdt063,
             pmdt064       LIKE pmdt_t.pmdt064,
             pmdt065       LIKE pmdt_t.pmdt065,
             pmdt066       LIKE pmdt_t.pmdt066,
             pmdt067       LIKE pmdt_t.pmdt067,
             pmdt068       LIKE pmdt_t.pmdt068,
             pmdt069       LIKE pmdt_t.pmdt069,
             
             pmdt081       LIKE pmdt_t.pmdt081,
             pmdt082       LIKE pmdt_t.pmdt082,
             pmdt083       LIKE pmdt_t.pmdt083,
             pmdt084       LIKE pmdt_t.pmdt084,
             pmdt085       LIKE pmdt_t.pmdt085,
             pmdt086       LIKE pmdt_t.pmdt086,
             pmdt087       LIKE pmdt_t.pmdt087,
             pmdt088       LIKE pmdt_t.pmdt088,
             pmdt219       LIKE pmdt_t.pmdt219,  #160512-00004#2-add
             pmdt089       LIKE pmdt_t.pmdt089
                        END RECORD
   
   DEFINE l_pmdu        RECORD
             pmdudocno     LIKE pmdu_t.pmdudocno,
             pmduseq       LIKE pmdu_t.pmduseq,
             pmduseq1      LIKE pmdu_t.pmduseq1,
             pmdu001       LIKE pmdu_t.pmdu001,
             pmdu002       LIKE pmdu_t.pmdu002,
             pmdu003       LIKE pmdu_t.pmdu003,
             pmdu004       LIKE pmdu_t.pmdu004,
             pmdu005       LIKE pmdu_t.pmdu005,
             pmdu006       LIKE pmdu_t.pmdu006,
             pmdu007       LIKE pmdu_t.pmdu007,
             pmdu008       LIKE pmdu_t.pmdu008,
             pmdu009       LIKE pmdu_t.pmdu009,
             pmdu010       LIKE pmdu_t.pmdu010,
             pmdu011       LIKE pmdu_t.pmdu011,
             pmdu012       LIKE pmdu_t.pmdu012,
             pmdu013       LIKE pmdu_t.pmdu013,
             pmdu014       LIKE pmdu_t.pmdu014,
             pmdu015       LIKE pmdu_t.pmdu015,
             pmdu016       LIKE pmdu_t.pmdu016,
             pmdu202       LIKE pmdu_t.pmdu202,  #160512-00004#6-add
             pmdu017       LIKE pmdu_t.pmdu017
                        END RECORD
   
   LET r_success = TRUE
   
   IF cl_null(p_pmdsdocno) OR
      cl_null(p_pmds053) OR
      cl_null(p_pmds041) THEN
      
      RETURN r_success
   END IF
   
   INITIALIZE l_pmds.* TO NULL
   
   #塞pmds_t
   LET l_pmds.pmds021 = 'N'  #LC進口
   LET l_pmds.pmds050 = 'N'  #多角贸易已抛转
   
   UPDATE pmds_t
      SET pmds021 = l_pmds.pmds021,
          pmds050 = l_pmds.pmds050
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = p_pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "UPDATE:pmds_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
   
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #SELECT icaa_t,icab_t,icac_t,icad_t,icae_t
   CALL s_aic_carry_get_ica(p_pmds053,0)
   
   #以入庫單為例
   #在打入庫單時，若料號走QC，則根據QC單的製造批序號帶入入庫單，且同時回寫對應QC單的製造批序號中的已入庫量欄位
   #             若不走QC，則根據來源收貨單的製造批序號帶入入庫單，且同事回寫收貨單的製造批序號的已入庫量欄位
   #所以入庫單在刪除，或作廢時，也需將入庫單來源單據中的已入庫量欄位更新
   IF g_argv[1] MATCHES '[567]' OR g_argv[1] = '10' OR g_argv[1] = '11' OR g_argv[1] = '12' OR g_argv[1] = '13' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
      SELECT COUNT(1) INTO l_n FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = p_pmdsdocno
      IF l_n > 0 THEN
         IF NOT s_apmt520_upd_inao('2',p_pmdsdocno,'','') THEN
            LET r_success = FALSE
            RETURN r_success
         END IF
      END IF
   END IF
      
   #先清空單身
   DELETE FROM pmdt_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = p_pmdsdocno
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE:pmdt_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF
   
   DELETE FROM pmdu_t
    WHERE pmduent = g_enterprise
      AND pmdudocno = p_pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE:pmdu_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF

   DELETE FROM pmdv_t
    WHERE pmdvent = g_enterprise
      AND pmdvdocno = p_pmdsdocno
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE:pmdv_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF
   
   DELETE FROM pmdw_t
    WHERE pmdwent = g_enterprise
      AND pmdwdocno = p_pmdsdocno
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE:pmdw_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF

   #刪除交易稅明細檔
   DELETE FROM xrcd_t
    WHERE xrcdent = g_enterprise
      AND xrcddocno = p_pmdsdocno
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE:xrcd_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #刪除inao製造批序號異動明細檔
   DELETE FROM inao_t WHERE inaoent = g_enterprise AND inaodocno = g_pmds_m.pmdsdocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE inao_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   
   #塞pmdt_t
   LET l_pmdt001 = ''
   INITIALIZE l_pmdt.* TO NULL
   
   #SELECT單頭資料
   LET l_pmdssite = ''
   LET l_pmds037 = ''
   LET l_pmds007 = ''
   
   SELECT pmdssite,
          pmds007,pmds037
     INTO l_pmdssite,
          l_pmds007,l_pmds037
     FROM pmds_t
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = p_pmdsdocno
   
   LET l_pmdt.pmdtdocno = p_pmdsdocno

   IF g_icaa.icaa003 = '2' THEN #代採購
      LET l_sql = "SELECT xmdl003,",
                  "       xmdlseq,",
                  "       xmdl004,xmdl005,",
                  "       xmdl006,xmdl007,xmdl008,xmdl009,xmdl010,",
                  "       xmdl011,xmdl012,xmdl013,xmdl014,xmdl015,",
                  "       xmdl016,xmdl017,xmdl018,xmdl019,xmdl020,",
                  "       xmdl021,xmdl022,",
                  "       xmdl052,",
                  "       xmdl087,xmdl088,xmdl086",
                  "  FROM xmdk_t,xmdl_t",
                  " WHERE xmdkent = xmdlent AND xmdlent = ",g_enterprise,
                  "   AND xmdkdocno = xmdldocno",
                  "   AND xmdkstus = 'S'",
                  "   AND xmdk035 = '",p_pmds041,"'",
                  "   AND xmdksite = (SELECT icab003 FROM icab_t",
                  "                    WHERE icabent = ",g_enterprise,
                  "                      AND icab001 = '",p_pmds053,"'",
                  "                      AND icab002 = (SELECT MAX(icab002) FROM icab_t",
                  "                                      WHERE icabent = ",g_enterprise,
                  "                                        AND icab001 = '",p_pmds053,"'))"
   ELSE  #代採購指定供應商
      LET l_sql = "SELECT pmdt001,",
                  "       pmdtseq,",
                  "       pmdt002,pmdt003,",
                  "       pmdt004,pmdt005,pmdt006,pmdt007,pmdt008,",
                  "       pmdt009,pmdt010,pmdt062,pmdt016,pmdt017,",
                  "       pmdt018,pmdt019,pmdt020,pmdt021,pmdt022,",
                  "       pmdt023,pmdt024,",
                  "       pmdt063,",
                  "       pmdt084,pmdt085,pmdt086",
                  "  FROM pmds_t,pmdt_t",
                  " WHERE pmdsent = pmdtent AND pmdtent = ",g_enterprise,
                  "   AND pmdsdocno = pmdtdocno",
                  "   AND pmdsstus = 'S'",
                  "   AND pmds041 = '",p_pmds041,"'",
                  "   AND pmdssite = (SELECT icab003 FROM icab_t",
                  "                    WHERE icabent = ",g_enterprise,
                  "                      AND icab001 = '",p_pmds053,"'",
                  "                      AND icab002 = (SELECT MAX(icab002) FROM icab_t",
                  "                                      WHERE icabent = ",g_enterprise,
                  "                                        AND icab001 = '",p_pmds053,"'))"
   END IF
   PREPARE apmt520_pmds_pre FROM l_sql
   DECLARE apmt520_pmds_cs CURSOR FOR apmt520_pmds_pre

   IF g_icaa.icaa003 = '2' THEN #代採購
      LET l_sql = "SELECT b.pmdldocno,",
                  "       pmdn015,",
                  "       pmdn016,pmdn017,pmdn020,",
                  "       pmdn021,",
                  "       pmdn035,pmdn040,",
                  "       pmdn041,pmdn043,pmdn044",
                  "  FROM xmda_t,pmdl_t b,pmdn_t",
                  " WHERE xmdaent = b.pmdlent AND b.pmdlent = pmdnent AND pmdnent = ",g_enterprise,
                  "   AND b.pmdldocno = pmdndocno",
                  "   AND xmda031 = b.pmdl031",
                  "   AND b.pmdlsite = ?",
                  "   AND xmdadocno = ?",
                  "   AND pmdnseq = ?"
   ELSE  #代採購指定供應商
      LET l_sql = "SELECT b.pmdldocno,",
                  "       pmdn015,",
                  "       pmdn016,pmdn017,pmdn020,",
                  "       pmdn021,",
                  "       pmdn035,pmdn040,",
                  "       pmdn041,pmdn043,pmdn044",
                  "  FROM pmdl_t a,pmdl_t b,pmdn_t",
                  " WHERE a.pmdlent = b.pmdlent AND b.pmdlent = pmdnent AND pmdnent = ",g_enterprise,
                  "   AND b.pmdldocno = pmdndocno",
                  "   AND a.pmdl031 = b.pmdl031",
                  "   AND b.pmdlsite = ?",
                  "   AND a.pmdldocno = ?",
                  "   AND pmdnseq = ?"
   END IF
   PREPARE apmt520_pmdl_from_pre FROM l_sql
   
   #150622
   LET l_sql = "SELECT pmdsdocno,pmdtseq",
               "  FROM pmds_t,pmdt_t",
               " WHERE pmdsent = pmdtent AND pmdtent = ",g_enterprise,
               "   AND pmdsdocno = pmdtdocno",
               "   AND pmds000 IN ('1','8')",     #1.採購收貨,8.委外收貨
               "   AND pmdssite = ?",
               "   AND pmds041 = ?",
               "   AND pmdt001 = ?",
               "   AND pmdt002 = ?",
               "   AND pmdt003 = ?",
               "   AND pmdt004 = ?"
   PREPARE apmt520_pmds_from_pre FROM l_sql
   
   IF g_icaa.icaa003 = '2' THEN #代採購
      LET l_sql = "SELECT xmdmseq1,",
                  "       xmdm001,xmdm002,xmdm003,xmdm004,xmdm005,",
                  "       xmdm006,xmdm007,xmdm008,xmdm009,xmdm010,",
                  "       xmdm011,xmdm033",
                  "  FROM xmdk_t,xmdm_t",
                  " WHERE xmdkent = xmdment AND xmdment = ",g_enterprise,
                  "   AND xmdkdocno = xmdmdocno",
                  "   AND xmdkstus = 'S'",
                  "   AND xmdk035 = '",p_pmds041,"'",
                  "   AND xmdmseq = ?",
                  "   AND xmdksite = (SELECT icab003 FROM icab_t",
                  "                    WHERE icabent = ",g_enterprise,
                  "                      AND icab001 = '",p_pmds053,"'",
                  "                      AND icab002 = (SELECT MAX(icab002) FROM icab_t",
                  "                                      WHERE icabent = ",g_enterprise,
                  "                                        AND icab001 = '",p_pmds053,"'))",
                  " ORDER BY xmdmseq1"
   ELSE  #代採購指定供應商
      LET l_sql = "SELECT pmduseq1,",
                  "       pmdu001,pmdu002,pmdu003,pmdu004,pmdu006,",
                  "       pmdu007,pmdu008,pmdu009,pmdu010,pmdu011,",
                  "       pmdu012,pmdu005",
                  "  FROM pmds_t,pmdu_t",
                  " WHERE pmdsent = pmduent AND pmduent = ",g_enterprise,
                  "   AND pmdsdocno = pmdudocno",
                  "   AND pmdsstus = 'S'",
                  "   AND pmds041 = '",p_pmds041,"'",
                  "   AND pmduseq = ?",
                  "   AND pmdssite = (SELECT icab003 FROM icab_t",
                  "                    WHERE icabent = ",g_enterprise,
                  "                      AND icab001 = '",p_pmds053,"'",
                  "                      AND icab002 = (SELECT MAX(icab002) FROM icab_t",
                  "                                      WHERE icabent = ",g_enterprise,
                  "                                        AND icab001 = '",p_pmds053,"'))",
                  " ORDER BY pmduseq1"
   END IF
   PREPARE apmt520_pmdu_pre FROM l_sql
   DECLARE apmt520_pmdu_cs CURSOR FOR apmt520_pmdu_pre

   FOREACH apmt520_pmds_cs INTO l_pmdt001,
                                l_pmdt.pmdtseq,
                                l_pmdt.pmdt002,l_pmdt.pmdt003,
                                l_pmdt.pmdt004,l_pmdt.pmdt005,l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt008,
                                l_pmdt.pmdt009,l_pmdt.pmdt010,l_pmdt.pmdt062,l_pmdt.pmdt016,l_pmdt.pmdt017,
                                l_pmdt.pmdt018,l_pmdt.pmdt019,l_pmdt.pmdt020,l_pmdt.pmdt021,l_pmdt.pmdt022,
                                l_pmdt.pmdt023,l_pmdt.pmdt024,
                                l_pmdt.pmdt063,
                                l_pmdt.pmdt084,l_pmdt.pmdt085,l_pmdt.pmdt086
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "FOREACH:apmt520_pmds_cs"
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         LET r_success = FALSE
         EXIT FOREACH
      END IF
   
      LET l_pmdt.pmdt011 = 1  #冲销顺序
      
      LET l_pmdt.pmdt053 = 0
      LET l_pmdt.pmdt054 = 0
      LET l_pmdt.pmdt055 = 0
      LET l_pmdt.pmdt056 = 0
      LET l_pmdt.pmdt057 = 0
      LET l_pmdt.pmdt058 = 0
      
      LET l_pmdt.pmdt066 = 0
      LET l_pmdt.pmdt067 = 0
      LET l_pmdt.pmdt068 = 0
      LET l_pmdt.pmdt069 = 0
            
      LET l_pmdt.pmdt063 = ' '              #庫存管理特徵
      
      #庫位、儲位
      IF NOT cl_null(l_pmdt.pmdt016) THEN
         IF cl_null(g_icad.icad004) THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = ""
            LET g_errparam.code   = 'aic-00169'   #流程代碼%1站別%2之庫位為空！
            LET g_errparam.popup  = TRUE
            LET g_errparam.replace[1] = p_pmds053
            LET g_errparam.replace[2] = 0
            
            CALL cl_err()
         
            LET r_success = FALSE
            EXIT FOREACH            
         ELSE
            LET l_pmdt.pmdt016 = g_icad.icad004     #庫位
            
            IF cl_null(g_icad.icad005) THEN
               LET l_pmdt.pmdt017 = ' '             #儲位
            ELSE
               LET l_pmdt.pmdt017 = g_icad.icad005  #儲位
            END IF
         END IF
      ELSE
         LET l_pmdt.pmdt016 = ' '             #庫位
         LET l_pmdt.pmdt017 = ' '             #儲位
      END IF
      
      #來源採購單
      IF NOT cl_null(l_pmdt001) THEN
         EXECUTE apmt520_pmdl_from_pre USING l_pmdssite,l_pmdt001,l_pmdt.pmdt002
         INTO l_pmdt.pmdt001,
              l_pmdt.pmdt036,
              l_pmdt.pmdt046,l_pmdt.pmdt037,l_pmdt.pmdt025,
              l_pmdt.pmdt041,
              l_pmdt.pmdt040,l_pmdt.pmdt042,
              l_pmdt.pmdt043,l_pmdt.pmdt044,l_pmdt.pmdt045

         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "EXECUTE:apmt520_pmdl_from_pre"
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = TRUE
            CALL cl_err()
       
            LET r_success = FALSE
            EXIT FOREACH
         END IF

      END IF
      
      #150622
      EXECUTE apmt520_pmds_from_pre USING l_pmdssite,p_pmds041,
                                          l_pmdt.pmdt001,l_pmdt.pmdt002,
                                          l_pmdt.pmdt003,l_pmdt.pmdt004
                                     INTO l_pmdt.pmdt027,l_pmdt.pmdt028
      
      IF SQLCA.sqlcode AND SQLCA.sqlcode <> 100 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "EXECUTE:apmt520_pmds_from_pre"
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
      
         LET r_success = FALSE
         EXIT FOREACH
      END IF
    
      #檢驗否
      IF g_icab.icab005 = 'Y' THEN
         IF (NOT cl_null(l_pmdt.pmdt009)) AND (NOT cl_null(l_pmdt.pmdt010)) THEN
            SELECT qcap006 INTO l_pmdt.pmdt026
              FROM qcap_t
             WHERE qcapent = g_enterprise AND qcapsite = l_pmdssite
               AND qcap001 = l_pmdt.pmdt006 AND qcap002 = l_pmds007
               AND qcap003 = l_pmdt.pmdt009 AND qcap004 = l_pmdt.pmdt010
               AND qcap005 = l_pmdt.pmdt007
         ELSE
            SELECT qcap006 INTO l_pmdt.pmdt026
              FROM qcap_t
             WHERE qcapent = g_enterprise AND qcapsite = l_pmdssite
               AND qcap001 = l_pmdt.pmdt006 AND qcap002 = l_pmds007
               AND qcap005 = l_pmdt.pmdt007
         END IF
            
         IF cl_null(l_pmdt.pmdt026) THEN
            LET l_pmdt.pmdt026 = 'N'
         END IF
      ELSE
         LET l_pmdt.pmdt026 = 'N'
      END IF

      #取得未稅金額、稅額、含稅金額
      CALL s_apmt520_get_amount(l_pmdt.pmdtdocno,l_pmdt.pmdtseq,l_pmdt.pmdt001,l_pmdt.pmdt024,l_pmdt.pmdt036,l_pmdt.pmdt046)
      RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
      #160512-00004#2-add-'pmdt219'、'l_pmdt.pmdt219'
      INSERT INTO pmdt_t (pmdtent,pmdtsite,pmdtdocno,pmdtseq,
                          pmdt001,pmdt002,pmdt003,pmdt004,pmdt005,
                          pmdt006,pmdt007,pmdt008,pmdt009,pmdt010,
                          pmdt011,
                          pmdt016,pmdt017,pmdt018,pmdt019,pmdt020,
                          pmdt021,pmdt022,pmdt023,pmdt024,pmdt025,
                          pmdt026,pmdt027,pmdt028,
                          pmdt036,pmdt037,pmdt038,pmdt039,pmdt040,
                          pmdt041,pmdt042,pmdt043,pmdt044,pmdt045,
                          pmdt046,pmdt047,
                          pmdt051,pmdt052,pmdt053,pmdt054,pmdt055,
                          pmdt056,pmdt057,pmdt058,pmdt059,pmdt060,
                          pmdt061,pmdt062,pmdt063,pmdt064,pmdt065,
                          pmdt066,pmdt067,pmdt068,pmdt069,
                          pmdt081,pmdt082,pmdt083,pmdt084,pmdt085,
                          pmdt086,pmdt087,pmdt088,pmdt219,pmdt089)
      VALUES (g_enterprise,l_pmdssite,l_pmdt.pmdtdocno,l_pmdt.pmdtseq,
              l_pmdt.pmdt001,l_pmdt.pmdt002,l_pmdt.pmdt003,l_pmdt.pmdt004,l_pmdt.pmdt005,
              l_pmdt.pmdt006,l_pmdt.pmdt007,l_pmdt.pmdt008,l_pmdt.pmdt009,l_pmdt.pmdt010,
              l_pmdt.pmdt011,
              l_pmdt.pmdt016,l_pmdt.pmdt017,l_pmdt.pmdt018,l_pmdt.pmdt019,l_pmdt.pmdt020,
              l_pmdt.pmdt021,l_pmdt.pmdt022,l_pmdt.pmdt023,l_pmdt.pmdt024,l_pmdt.pmdt025,
              l_pmdt.pmdt026,l_pmdt.pmdt027,l_pmdt.pmdt028,
              l_pmdt.pmdt036,l_pmdt.pmdt037,l_pmdt.pmdt038,l_pmdt.pmdt039,l_pmdt.pmdt040,
              l_pmdt.pmdt041,l_pmdt.pmdt042,l_pmdt.pmdt043,l_pmdt.pmdt044,l_pmdt.pmdt045,
              l_pmdt.pmdt046,l_pmdt.pmdt047,
              l_pmdt.pmdt051,l_pmdt.pmdt052,l_pmdt.pmdt053,l_pmdt.pmdt054,l_pmdt.pmdt055,
              l_pmdt.pmdt056,l_pmdt.pmdt057,l_pmdt.pmdt058,l_pmdt.pmdt059,l_pmdt.pmdt060,
              l_pmdt.pmdt061,l_pmdt.pmdt062,l_pmdt.pmdt063,l_pmdt.pmdt064,l_pmdt.pmdt065,
              l_pmdt.pmdt066,l_pmdt.pmdt067,l_pmdt.pmdt068,l_pmdt.pmdt069,
              l_pmdt.pmdt081,l_pmdt.pmdt082,l_pmdt.pmdt083,l_pmdt.pmdt084,l_pmdt.pmdt085,
              l_pmdt.pmdt086,l_pmdt.pmdt087,l_pmdt.pmdt088,l_pmdt.pmdt219,l_pmdt.pmdt089)

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "INSERT:pmdt_t"
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
            
         LET r_success = FALSE
         EXIT FOREACH
      END IF
   
      #整批產生收貨原始需求分配明細資料
      CALL s_apmt520_gen_pmdv(l_pmdt.pmdtdocno,l_pmdt.pmdtseq) RETURNING r_success
      IF NOT r_success THEN
         EXIT FOREACH
      END IF
      
      INITIALIZE l_pmdu.* TO NULL
      OPEN apmt520_pmdu_cs USING l_pmdt.pmdtseq
      FOREACH apmt520_pmdu_cs INTO l_pmdu.pmduseq1,
                                   l_pmdu.pmdu001,l_pmdu.pmdu002,l_pmdu.pmdu003,l_pmdu.pmdu004,l_pmdu.pmdu006,
                                   l_pmdu.pmdu007,l_pmdu.pmdu008,l_pmdu.pmdu009,l_pmdu.pmdu010,l_pmdu.pmdu011,
                                   l_pmdu.pmdu012,l_pmdu.pmdu005
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "FOREACH:apmt520_pmdu_cs"
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = TRUE
            CALL cl_err()
         
            LET r_success = FALSE
            EXIT FOREACH
         END IF
   
         #塞pmdu_t
         LET l_pmdu.pmdudocno = l_pmdt.pmdtdocno
         LET l_pmdu.pmduseq = l_pmdt.pmdtseq
         LET l_pmdu.pmdu013 = 0                 #允收數量
         LET l_pmdu.pmdu014 = 0                 #已入庫量
         LET l_pmdu.pmdu015 = 0                 #已驗退量
         
         LET l_pmdu.pmdu005 = ' '    #庫存管理特徵
         
         #庫位、儲位
         IF NOT cl_null(l_pmdu.pmdu006) THEN
            IF cl_null(g_icad.icad004) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ""
               LET g_errparam.code   = 'aic-00169'   #流程代碼%1站別%2之庫位為空！
               LET g_errparam.popup  = TRUE
               LET g_errparam.replace[1] = p_pmds053
               LET g_errparam.replace[2] = 0
               
               CALL cl_err()
            
               LET r_success = FALSE
               EXIT FOREACH            
            ELSE
               LET l_pmdu.pmdu006 = g_icad.icad004     #庫位
               
               IF cl_null(g_icad.icad005) THEN
                  LET l_pmdu.pmdu007 = ' '             #儲位
               ELSE
                  LET l_pmdu.pmdu007 = g_icad.icad005  #儲位
               END IF
            END IF
         ELSE
            LET l_pmdu.pmdu006 = ' '             #庫位
            LET l_pmdu.pmdu007 = ' '             #儲位
         END IF
         #160512-00004#6-add-'pmdu202','l_pmdu.pmdu202'
         INSERT INTO pmdu_t (pmduent,pmdusite,pmdudocno,pmduseq,pmduseq1,
                             pmdu001,pmdu002,pmdu003,pmdu004,pmdu005,
                             pmdu006,pmdu007,pmdu008,pmdu009,pmdu010,
                             pmdu011,pmdu012,pmdu013,pmdu014,pmdu015,
                             pmdu016,pmdu202,pmdu017)
         VALUES (g_enterprise,l_pmdssite,l_pmdu.pmdudocno,l_pmdu.pmduseq,l_pmdu.pmduseq1,
                 l_pmdu.pmdu001,l_pmdu.pmdu002,l_pmdu.pmdu003,l_pmdu.pmdu004,l_pmdu.pmdu005,
                 l_pmdu.pmdu006,l_pmdu.pmdu007,l_pmdu.pmdu008,l_pmdu.pmdu009,l_pmdu.pmdu010,
                 l_pmdu.pmdu011,l_pmdu.pmdu012,l_pmdu.pmdu013,l_pmdu.pmdu014,l_pmdu.pmdu015,
                 l_pmdu.pmdu016,l_pmdu.pmdu202,l_pmdu.pmdu017)
       
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "INSERT:pmdu_t"
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = TRUE
            CALL cl_err()         
         
            LET r_success = FALSE
            EXIT FOREACH
         END IF
      END FOREACH
      
      IF NOT r_success THEN
         EXIT FOREACH
      END IF
      
   END FOREACH

   IF NOT r_success THEN
      RETURN r_success
   ELSE
   
      #重新計算整單的未稅、含稅總金額
      CALL s_tax_recount(p_pmdsdocno)
      RETURNING l_xrcd103,l_xrcd104,l_xrcd105,
                l_xrcd113,l_xrcd114,l_xrcd115
      
      UPDATE pmds_t
         SET pmds043 = l_xrcd103,
             pmds044 = l_xrcd105,
             pmds046 = l_xrcd104
       WHERE pmdsent = g_enterprise 
         AND pmdsdocno = p_pmdsdocno
         
#      CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) #dorislai-20151113 xrcd回寫pmdt #151124-00015#1-mark
      
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "UPDATE:pmds_t"
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success
      END IF
      #151124-00015#1-add----(S)
      IF r_success THEN
         CALL apmt520_pmdt_upd(g_pmds_m.pmdsdocno) RETURNING r_success
      END IF
      #151124-00015#1-add----(E)
   END IF

   RETURN r_success

END FUNCTION

#多角流程代碼檢查
PRIVATE FUNCTION apmt520_pmds014_pmds053_chk(p_pmds014,p_pmds053)
   DEFINE p_pmds014    LIKE pmds_t.pmds014
   DEFINE p_pmds053    LIKE pmds_t.pmds053
   DEFINE r_success    LIKE type_t.num5
   
   LET r_success = TRUE
   
   IF NOT cl_null(p_pmds014) AND NOT cl_null(p_pmds053) THEN
      #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
      INITIALIZE g_chkparam.* TO NULL
      #160318-00025#15 by 07900 --add-str 
       LET g_errshow = TRUE #是否開窗
      #160318-00025#15 by 07900 --add-end
      #設定g_chkparam.*的參數
      LET g_chkparam.arg1 = p_pmds053
      LET g_chkparam.arg2 = g_site
      LET g_chkparam.arg3 = p_pmds014
      #160318-00025#15 by 07900 --add-str 
      LET g_chkparam.err_str[1] ="aic-00012:sub-01302|aici100|",cl_get_progname("aici100",g_lang,"2"),"|:EXEPROGaici100"
      #160318-00025#15 by 07900 --add-end
      IF NOT cl_chk_exist("v_icaa001_4") THEN
         LET r_success = FALSE
      END IF
   END IF
   
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 取得發票號碼
# Memo...........:
# Usage..........: CALL apmt520_get_invoice_num(p_pmdsdocno,p_pmdtseq,p_pmdt027,p_pmdt028)
#                  RETURNING r_pmdt049,r_pmdt050
# Input parameter: p_pmdt027:收貨單號
#                : p_pmdt028:收貨項次
# Return code....: r_pmdt049:發票代碼
#                : r_pmdt050:發票號碼
# Date & Author..: 2015/08/10 By lixiang
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_get_invoice_num(p_pmdsdocno,p_pmdtseq,p_pmdt027,p_pmdt028)
DEFINE p_pmdsdocno   LIKE pmds_t.pmdsdocno
DEFINE p_pmdtseq     LIKE pmdt_t.pmdtseq
DEFINE p_pmdt027     LIKE pmdt_t.pmdt027
DEFINE p_pmdt028     LIKE pmdt_t.pmdt028
DEFINE l_sql         STRING
DEFINE r_pmdt049     LIKE pmdt_t.pmdt049     #發票代碼  
DEFINE r_pmdt050     LIKE pmdt_t.pmdt050     #發票號碼  
DEFINE l_money       LIKE isam_t.isam023
DEFINE l_sum_pmdt038 LIKE pmdt_t.pmdt038
DEFINE l_pmds000     LIKE pmds_t.pmds000
   
   
   LET r_pmdt049 = ''
   LET r_pmdt050 = ''
   LET l_pmds000 = g_argv[1]

   IF cl_null(p_pmdt027) OR cl_null(p_pmdt028) THEN
      RETURN r_pmdt049,r_pmdt050
   END IF
   
   #倉退是先抓收貨單自行輸入的發票號碼，抓不到，再抓isam的
   IF g_argv[1] MATCHES '[7]' OR g_argv[1] = '14' OR g_argv[1] = '15' THEN
      SELECT pmdw009,pmdw010 INTO r_pmdt049,r_pmdt050 FROM pmdw_t
         WHERE pmdwent = g_enterprise AND pmdwdocno = p_pmdt027 AND pmdwseq = 1
      
      IF cl_null(r_pmdt050) THEN 
         #根據倉退單的來源收貨單號找到該收貨單對應的入庫單，
         LET l_sql = " SELECT isam009,isam010,(isam023-isam107) ",
                     "   FROM isam_t,apba_t,apcb_t,pmdt_t,pmds_t ",
                     "  WHERE isament   = apbaent ",
                     "    AND apba005   = apcb002 ",
                     "    AND apba006   = apcb003 ",
                     "    AND apbadocno = isamdocno ",
                     "    AND isament   = pmdsent ",
                     "    AND pmdsent   = pmdtent ",
                     "    AND pmdsdocno = pmdtdocno ",
                     "    AND apcb002   = pmdtdocno ",
                     "    AND apcb003   = pmdtseq ",
                     "    AND isament   = '",g_enterprise,"' ",
                     "    AND pmdt027   = '",p_pmdt027,"' ", 
                     "    AND pmdt028   = '",p_pmdt028,"' ",
                     "    AND isam036   = '11' ",  #發票開立  
                     "    AND isam023-isam107 > 0 "
         CASE g_argv[1]
            WHEN '7'  LET l_sql = l_sql , " AND pmds000 = '6' "   #一般入庫單
            WHEN '14' LET l_sql = l_sql , " AND pmds000 = '12' "  #委外入庫單
            WHEN '15' LET l_sql = l_sql , " AND pmds000 = '13' "  #重覆性生產入庫單
         END CASE
         
         PREPARE apmt520_isam_prep FROM l_sql
         DECLARE apmt520_isam_curs CURSOR FOR apmt520_isam_prep
       
         FOREACH apmt520_isam_curs INTO r_pmdt049,r_pmdt050,l_money
       
            LET l_sum_pmdt038 = 0
            SELECT SUM(pmdt038) INTO l_sum_pmdt038
              FROM pmds_t,pmdt_t
             WHERE pmdsent   = pmdsent
               AND pmdsdocno = pmdsdocno
               AND pmdsent   = g_enterprise
               AND (pmdsdocno != p_pmdsdocno OR pmdtseq != p_pmdtseq)   #排除自己這張單  
               AND pmdsstus  = 'Y'
               AND pmds000   = l_pmds000    #倉退單 
               AND pmdt056   = '0'
               AND pmdt050   = r_pmdt050
       
            IF cl_null(l_sum_pmdt038) THEN
               LET l_sum_pmdt038 = 0
            END IF
       
            IF l_money - l_sum_pmdt038 <=0 THEN
               LET r_pmdt049 = ''
               LET r_pmdt050 = ''
               CONTINUE FOREACH
            END IF 
            
            IF NOT cl_null(r_pmdt050) THEN
               EXIT FOREACH
            END IF
       
         END FOREACH
      END IF
   END IF

   RETURN r_pmdt049,r_pmdt050
   
END FUNCTION
################################################################################
# Descriptions...: 檢查發票欄位
# Memo...........:
# Usage..........: CALL apmt520_chk_pmdt050(p_pmdsdocno,p_pmdtseq,p_pmdt038,p_pmdt050)
#                  RETURNING r_success
# Return code....: r_success: true/false
# Date & Author..: 2015/08/11 By lixiang
# Modify.........:
##################################################################################################################################################
PRIVATE FUNCTION apmt520_chk_pmdt050(p_pmdsdocno,p_pmdtseq,p_pmdt038,p_pmdt050)
DEFINE p_pmdsdocno      LIKE pmds_t.pmdsdocno
DEFINE p_pmdtseq        LIKE pmdt_t.pmdtseq
DEFINE p_pmdt038        LIKE pmdt_t.pmdt038
DEFINE p_pmdt050        LIKE pmdt_t.pmdt050
DEFINE l_isam_money     LIKE isam_t.isam023
DEFINE l_other_pmdt038  LIKE pmdt_t.pmdt038
DEFINE r_success        LIKE type_t.num5
DEFINE l_pmds000     LIKE pmds_t.pmds000
   
   
   LET r_success = TRUE
   
   LET l_pmds000 = g_argv[1]

   #取得發票可折金額 
   LET l_isam_money = 0
   SELECT isam023-isam107 INTO l_isam_money
     FROM isam_t
    WHERE isament   = g_enterprise
      AND isam010   = p_pmdt050
      AND isam036   = '11'  #發票開立  
      AND isam023-isam107 > 0
   IF cl_null(l_isam_money) THEN
      LET l_isam_money = 0
   END IF

   #取得其他單據的銷退金額  
   LET l_other_pmdt038 = 0
   SELECT SUM(pmdt038) INTO l_other_pmdt038
     FROM pmds_t,pmdt_t
    WHERE pmdsent   = pmdsent
      AND pmdsdocno = pmdsdocno
      AND pmdsent   = g_enterprise
      AND (pmdsdocno != p_pmdsdocno OR pmdtseq != p_pmdtseq)  #排除自己這張單和本張單據上其他項次
      AND pmdsstus  = 'Y'
      AND pmds000   = l_pmds000    #倉退單 
      AND pmdt056   = '0'
      AND pmdt050   = p_pmdt050
   IF cl_null(l_other_pmdt038) THEN
      LET l_other_pmdt038 = 0
   END IF

   #151022-00013 by whitney modify start
   #銷退金額%1大於剩餘發票可折金額%2(發票可折金額%3-已折讓金額%4)
   IF l_isam_money - l_other_pmdt038 < p_pmdt038 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code  = 'axm-00698'
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = p_pmdt038
      LET g_errparam.replace[2] = l_isam_money - l_other_pmdt038
      LET g_errparam.replace[3] = l_isam_money
      LET g_errparam.replace[4] = l_other_pmdt038
      CALL cl_err()
      LET r_success = FALSE
   END IF
   #151022-00013 by whitney modify end

   RETURN r_success
   
END FUNCTION
################################################################################
# Descriptions...: 科目預算的處理
# Memo...........:
# Usage..........: CALL apmt520_detail_abg(p_type)
#                  RETURNING r_success,r_errno,r_bgaf016,r_bgae001,r_bgae001_desc
# Input parameter: p_type         1.預算項目開窗
#                                 2.預算項目檢核
#                                 3.預算項目說明
#                                 4.檢核金額
# Return code....: r_success      TRUE/FALSE
#                : r_errno        錯誤訊息
#                : r_bgaf016      錯誤處理方式
#                : r_bgae001      預算項目
#                : r_bgae001_desc 說明
# Date & Author..: 2015/08/31 By shiun
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_detail_abg(p_type)
DEFINE p_type             LIKE type_t.chr10
DEFINE r_success          LIKE type_t.num5
DEFINE r_errno            LIKE gzze_t.gzze001
DEFINE r_bgaf016          LIKE bgaf_t.bgaf016
DEFINE r_bgae001          LIKE bgae_t.bgae001
DEFINE r_bgae001_desc     LIKE type_t.chr80 
DEFINE l_success          LIKE type_t.num5
DEFINE l_slip             LIKE pmds_t.pmdsdocno
DEFINE l_imaa009          LIKE imaa_t.imaa009
DEFINE l_tran             RECORD
         act              LIKE type_t.chr10,   #[1].chr 動作
         site             LIKE ooef_t.ooef001, #[2].chr 預算組織
         dat              LIKE type_t.dat,     #[3].dat 日期
         bgae001          LIKE bgae_t.bgae001, #[4].chr 預算項目
         bgbd013          LIKE bgbd_t.bgbd013, #[5].chr 部門
         bgbd014          LIKE bgbd_t.bgbd014, #[6].chr 利潤成本中心
         bgbd015          LIKE bgbd_t.bgbd015, #[7].chr 區域
         bgbd016          LIKE bgbd_t.bgbd016, #[8].chr 交易客商
         bgbd017          LIKE bgbd_t.bgbd017, #[9].chr 收款客商
         bgbd018          LIKE bgbd_t.bgbd018, #[10].chr 客群
         bgbd019          LIKE bgbd_t.bgbd019, #[11].chr 產品類別
         bgbd020          LIKE bgbd_t.bgbd020, #[12].chr 人員
         bgbd021          LIKE bgbd_t.bgbd021, #[13].chr 專案
         bgbd022          LIKE bgbd_t.bgbd022, #[14].chr WBS
         bgbd023          LIKE bgbd_t.bgbd023, #[15].chr 經營方式
         bgbd024          LIKE bgbd_t.bgbd024, #[16].chr 自由核算項一
         bgbd025          LIKE bgbd_t.bgbd025, #[17].chr 自由核算項二
         bgbd026          LIKE bgbd_t.bgbd026, #[18].chr 自由核算項三
         bgbd027          LIKE bgbd_t.bgbd027, #[19].chr 自由核算項四
         bgbd028          LIKE bgbd_t.bgbd028, #[20].chr 自由核算項五
         bgbd029          LIKE bgbd_t.bgbd029, #[21].chr 自由核算項六
         bgbd030          LIKE bgbd_t.bgbd030, #[22].chr 自由核算項七
         bgbd031          LIKE bgbd_t.bgbd031, #[23].chr 自由核算項八
         bgbd032          LIKE bgbd_t.bgbd032, #[24].chr 自由核算項九
         bgbd033          LIKE bgbd_t.bgbd033, #[25].chr 自由核算項十
         bgbd042          LIKE bgbd_t.bgbd042, #[26].chr 渠道
         bgbd043          LIKE bgbd_t.bgbd043, #[27].chr 品牌
         used036          LIKE bgbd_t.bgbd036, #[28].chr 使用程式
         used037          LIKE bgbd_t.bgbd037, #[29].chr 使用單號 
         used038          LIKE bgbd_t.bgbd038, #[30].chr 使用項次
         sour036          LIKE bgbd_t.bgbd036, #[31].chr 轉出程式
         sour037          LIKE bgbd_t.bgbd037, #[32].chr 轉出單號
         sour038          LIKE bgbd_t.bgbd038, #[33].chr 轉出項次
         curr             LIKE ooai_t.ooai001, #[34].chr 幣別
         account          LIKE type_t.num20_6 #[35].chr 金額
                          END RECORD
DEFINE ls_js              STRING

   LET r_success = TRUE
   LET r_errno = ''
   LET r_bgaf016 = ''
   LET r_bgae001 = ''
   LET r_bgae001_desc = ''
   
   #add by lixiang 2015/12/17---begin---
   #當傳入類型的金額檢核時，但預算科目為空，則無需進行檢核，否則會出現畫面上預算科目為空，修改數量時卻一直報錯，無法繼續報錯
   IF p_type MATCHES '[24]' AND cl_null(g_pmdt_d[l_ac].pmdt075) THEN
       RETURN r_success,r_errno,r_bgaf016,r_bgae001,r_bgae001_desc
   END IF
   #add by lixiang 2015/12/17---end-----
   
   CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno)
        RETURNING l_success,l_slip
   IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-FIN-5002') = 'N' THEN
      RETURN r_success,r_errno,r_bgaf016,r_bgae001,r_bgae001_desc
   END IF
      
   SELECT imaa009 INTO l_imaa009
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdt_d[l_ac].pmdt006
   
   INITIALIZE l_tran.* TO NULL
   LET l_tran.site = g_site
   LET l_tran.dat = g_pmds_m.pmdsdocdt
   LET l_tran.bgae001 = g_pmdt_d[l_ac].pmdt075
   LET l_tran.bgbd013 = g_pmds_m.pmds003
   LET l_tran.bgbd016 = g_pmds_m.pmds007
   LET l_tran.bgbd019 = l_imaa009
   LET l_tran.bgbd020 = g_pmds_m.pmds002
   LET l_tran.bgbd021 = g_pmdt_d[l_ac].pmdt072
   LET l_tran.bgbd022 = g_pmdt_d[l_ac].pmdt073
   LET l_tran.used036 = 'apmt520'
   LET l_tran.used037 = g_pmds_m.pmdsdocno
   LET l_tran.used038 = g_pmdt_d[l_ac].pmdtseq
   LET l_tran.curr    = g_pmds_m.pmds037
   LET l_tran.account = g_pmdt_d[l_ac].pmdt038
   
   LET ls_js = util.JSON.stringify(l_tran)
   
   #1.預算項目開窗
   #2.預算項目檢核
   #3.預算項目說明
   #4.檢核金額
   
   CASE p_type
      WHEN '1'
           CALL s_abg_bgae001_query2(ls_js)
                RETURNING r_bgae001
                
           LET l_tran.bgae001 = r_bgae001
           LET ls_js = util.JSON.stringify(l_tran)
           CALL s_abg_bgae001_desc2(ls_js)
                RETURNING r_bgae001_desc
      WHEN '2'
           CALL s_abg_bgae001_chk2(ls_js)
                RETURNING r_success,r_errno
           IF r_success THEN
              CALL s_abg_bgae001_desc2(ls_js)
                   RETURNING r_bgae001_desc
           END IF
      WHEN '3'
           CALL s_abg_bgae001_desc2(ls_js)
                RETURNING r_bgae001_desc
      WHEN '4'
           CALL s_abg_bg_used_chk(ls_js)
                RETURNING r_success,r_errno,r_bgaf016
   END CASE
   
   RETURN r_success,r_errno,r_bgaf016,r_bgae001,r_bgae001_desc

END FUNCTION

################################################################################
# Descriptions...: 將xrcd金額回寫到pmdt
# Memo...........:
# Usage..........: CALL apmt520_pmdt_upd(p_xrcddocno) 
#                       RETURNING r_success
# Input parameter: p_xrcddocno    單號
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 20151113 By dorislai
# Modify.........:#151124-00015#1 By dorislai 加入回傳update是否成功
################################################################################
PRIVATE FUNCTION apmt520_pmdt_upd(p_xrcddocno)
   DEFINE l_xrcd  RECORD   
       xrcdseq LIKE xrcd_t.xrcdseq,
       xrcd103 LIKE xrcd_t.xrcd103,
       xrcd104 LIKE xrcd_t.xrcd104,
       xrcd105 LIKE xrcd_t.xrcd105
   END RECORD
   
   DEFINE r_success   LIKE type_t.num5 #151124-00015#1-add
   DEFINE p_xrcddocno LIKE xrcd_t.xrcddocno
   DEFINE p_xrcdseq   LIKE xrcd_t.xrcdseq
   DEFINE l_sql       STRING
   
   LET r_success = TRUE #151124-00015#1-add
    
   #LET l_sql = " SELECT xrcdseq,xrcd103,xrcd104,xrcd105 ",                #161109-00066#1 
   LET l_sql = " SELECT xrcdseq,SUM(xrcd103),SUM(xrcd104),SUM(xrcd105) ",  #161109-00066#1 #税别是复合税时，一个项次会产生多笔xrcd的资料
               "   FROM xrcd_t WHERE xrcddocno = '",p_xrcddocno,"'",
               "    AND xrcdent = '",g_enterprise,"' AND xrcdseq != 0 ",
               "    AND xrcdseq2 = 0 ",
               "    GROUP BY xrcdseq "   #161109-00066#1 
               #"  ORDER BY xrcd002 "      #161109-00066#1 
   PREPARE apmt520_pmdt_pre FROM l_sql
   DECLARE apmt520_pmdt_cur CURSOR FOR apmt520_pmdt_pre 
    
   FOREACH apmt520_pmdt_cur INTO l_xrcd.*
      UPDATE pmdt_t 
         SET pmdt038 = l_xrcd.xrcd103,
             pmdt047 = l_xrcd.xrcd104,
             pmdt039 = l_xrcd.xrcd105 
       WHERE pmdtent = g_enterprise
         AND pmdtdocno = p_xrcddocno
         AND pmdtseq = l_xrcd.xrcdseq
      #151124-00015#1-add----(S)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = 'FOREACH:' 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET r_success = FALSE #151124-00015#1-add
      END IF
      #151124-00015#1-add----(E)
   END FOREACH 
   
   RETURN r_success #151124-00015#1-add
END FUNCTION

################################################################################
# Descriptions...: 檢查是否為 有效日期>製造日期
# Memo...........:
# Usage..........: CALL apmt520_pmdt219_pmdt089_chk(p_pmdt219,p_pmdt089)
#                  RETURNING r_success
# Input parameter: p_pmdt219      製造日期
#                : p_pmdt089      有效日期
# Return code....: r_success      TRUE/FASLE
# Date & Author..: 2016/0618 By dorislai (#160512-00004#2)
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_pmdt219_pmdt089_chk(p_pmdt219,p_pmdt089)
   DEFINE p_pmdt219  LIKE pmdt_t.pmdt219
   DEFINE p_pmdt089  LIKE pmdt_t.pmdt089
   DEFINE r_success  LIKE type_t.num5
   
   LET r_success = TRUE
   
   IF NOT cl_null(p_pmdt219) AND NOT cl_null(p_pmdt089) THEN
      #製造日期>有效日期
      IF p_pmdt219 > p_pmdt089 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "" 
         LET g_errparam.code   = "ain-00311"  #有效日期不可以小於製造日期！
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET r_success = FALSE
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

#160831-00016#1
#单头修改税别时，更新单身相关栏位
PRIVATE FUNCTION apmt520_change_pmdt046()
DEFINE l_success         LIKE type_t.num5
DEFINE l_pmdtseq         LIKE pmdt_t.pmdtseq
DEFINE l_pmdt006         LIKE pmdt_t.pmdt006
DEFINE l_pmdt024         LIKE pmdt_t.pmdt024
DEFINE l_pmdt036         LIKE pmdt_t.pmdt036
DEFINE l_pmdt046         LIKE pmdt_t.pmdt046
DEFINE l_pmdt037         LIKE pmdt_t.pmdt037
DEFINE l_pmdt038         LIKE pmdt_t.pmdt038
DEFINE l_pmdt047         LIKE pmdt_t.pmdt047
DEFINE l_pmdt020         LIKE pmdt_t.pmdt020
DEFINE l_pmdt039         LIKE pmdt_t.pmdt039
DEFINE l_pmdt001         LIKE pmdt_t.pmdt001

      DECLARE sel_pmdt046_cs CURSOR FOR
       SELECT pmdtseq,pmdt006,pmdt020,pmdt024,pmdt036,pmdt001
         FROM pmdt_t
        WHERE pmdtent = g_enterprise
          AND pmdtdocno = g_pmds_m.pmdsdocno
 
      FOREACH sel_pmdt046_cs INTO l_pmdtseq,l_pmdt006,l_pmdt020,l_pmdt024,l_pmdt036,l_pmdt001
         IF g_tax_app = '2' AND NOT cl_null(l_pmdt006) AND NOT cl_null(g_pmab039) THEN
            CALL s_tax_by_item(g_pmds_m.pmdssite,g_pmds_m.pmds033,g_pmds_m.pmds007,l_pmdt006,'2',g_pmab039)
               RETURNING l_success,l_pmdt046,l_pmdt037 
            IF NOT l_success THEN
               #稅別檢查失敗，將稅別、稅率清空
               LET l_pmdt046 = ''
               LET l_pmdt037 = ''
            END IF                   
         ELSE
            #依正常稅率
            LET l_pmdt046 = g_pmds_m.pmds033
            LET l_pmdt037 = g_pmds_m.pmds034
         END IF
         IF cl_null(l_pmdt024) THEN
            LET l_pmdt024 = l_pmdt020
         END IF
         
         #重新計算含稅、未稅金額
         CALL s_apmt520_get_amount(g_pmds_m.pmdsdocno,l_pmdtseq,l_pmdt001,l_pmdt024,l_pmdt036,l_pmdt046)
              RETURNING l_pmdt038,l_pmdt047,l_pmdt039 
          
         UPDATE pmdt_t SET pmdt046 = l_pmdt046,
                           pmdt037 = l_pmdt037,
                           pmdt038 = l_pmdt038,
                           pmdt047 = l_pmdt047,
                           pmdt039 = l_pmdt039
          WHERE pmdtent = g_enterprise
            AND pmdtdocno = g_pmds_m.pmdsdocno
            AND pmdtseq = l_pmdtseq   

      END FOREACH
END FUNCTION

################################################################################
# Descriptions...: 掃碼前必填欄位檢查
# Memo...........:
# Usage..........: CALL apmt520_scan_chk_reqf()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success TRUE/FALSE
# Date & Author..: #160831-00070#1 20161004 add by beckxie
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_scan_chk_reqf()
   DEFINE r_success LIKE type_t.num5
   LET r_success = TRUE
   
   IF cl_null(g_pmds_m.pmdsdocno) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmdsdocno') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmdsdocdt) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmdsdocdt') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   
   IF cl_null(g_pmds_m.pmds001) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds001') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds002) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds002') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds003) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds003') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   
   
   IF cl_null(g_pmds_m.pmds007) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds007') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds008) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds008') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds009) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds009') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds011) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds011') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds014) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds014') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds021) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds021') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds031) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds031') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds032) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds032') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds033) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds033') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds034) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds034') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds035) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds035') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds036) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds036') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds037) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds037') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds039) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds039') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds047) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds047') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds048) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds048') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   IF cl_null(g_pmds_m.pmds049) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds049') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   
   IF g_prog = 'apmt520' THEN
      IF cl_null(g_pmds_m.pmds006) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds006') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF
   IF g_prog = 'apmt532' THEN
      IF cl_null(g_pmds_m.pmds054) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds054') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   
      IF cl_null(g_pmds_m.pmds057) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds057') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF
   IF g_prog = 'apmt570' THEN
      IF cl_null(g_pmds_m.pmds006) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds006') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      IF cl_null(g_pmds_m.pmds050) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds050') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      IF cl_null(g_pmds_m.pmds057) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds057') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF
   
   #160831-00070#14 20161013 add by beckxie---S
   IF g_prog = 'apmt571' THEN
      IF cl_null(g_pmds_m.pmds006) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds006') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      IF cl_null(g_pmds_m.pmds050) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds050') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      IF cl_null(g_pmds_m.pmds057) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds057') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF
   #160831-00070#14 20161013 add by beckxie---E
   
   IF g_prog = 'apmt580' THEN 
   
      IF cl_null(g_pmds_m.pmds054) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds054') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   
      IF cl_null(g_pmds_m.pmds057) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds057') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      
      IF cl_null(g_pmds_m.pmds100) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds100') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      
      IF cl_null(g_pmds_m.pmds103) THEN
         LET r_success = FALSE 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ain-00796'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmds103') #欄位名稱
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      
   END IF
   
   IF cl_null(g_pmds_m.pmdsstus) THEN
      LET r_success = FALSE 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ain-00796'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = s_get_field_name(g_prog,'pmdsstus') #欄位名稱
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 產生裝箱單主檔、明細
# Memo...........:
# Usage..........: CALL apmt520_ins_inbm(p_pmdsdocno)
#                  RETURNING r_success
# Input parameter: p_pmdsdocno    單號
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 2016/10/26 By Ken
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt520_ins_inbm(p_pmdsdocno)
DEFINE p_pmdsdocno      LIKE pmds_t.pmdsdocno
DEFINE l_sql            STRING
DEFINE l_pmdssite       LIKE pmds_t.pmdssite
DEFINE l_pmds007        LIKE pmds_t.pmds007
DEFINE l_pmdsdocno      LIKE pmds_t.pmdsdocno
DEFINE l_pmdtdocno        LIKE pmdt_t.pmdtdocno
DEFINE l_pmdtseq          LIKE pmdt_t.pmdtseq
DEFINE l_pmdt006          LIKE pmdt_t.pmdt006
DEFINE l_pmdt007          LIKE pmdt_t.pmdt007
DEFINE l_pmdt019          LIKE pmdt_t.pmdt019
DEFINE l_pmdt020          LIKE pmdt_t.pmdt020
DEFINE l_inbm           RECORD
       inbment          LIKE inbm_t.inbment,
       inbmsite         LIKE inbm_t.inbmsite,
       inbmunit         LIKE inbm_t.inbmunit,
       inbmdocno        LIKE inbm_t.inbmdocno,
       inbmdocdt        LIKE inbm_t.inbmdocdt,
       inbm001          LIKE inbm_t.inbm001,
       inbm002          LIKE inbm_t.inbm002,
       inbm003          LIKE inbm_t.inbm003,
       inbm004          LIKE inbm_t.inbm004,
       inbm005          LIKE inbm_t.inbm005,
       inbm006          LIKE inbm_t.inbm006,
       inbm007          LIKE inbm_t.inbm007,
       inbm008          LIKE inbm_t.inbm008,
       inbmstus         LIKE inbm_t.inbmstus,
       inbmownid        LIKE inbm_t.inbmownid,
       inbmowndp        LIKE inbm_t.inbmowndp,
       inbmcrtid        LIKE inbm_t.inbmcrtid,
       inbmcrtdp        LIKE inbm_t.inbmcrtdp,
       inbmcrtdt        LIKE inbm_t.inbmcrtdt
                        END RECORD
DEFINE l_inbp           RECORD
       inbpent          LIKE inbp_t.inbpent, 
       inbpsite         LIKE inbp_t.inbpsite, 
       inbpdocno        LIKE inbp_t.inbpdocno, 
       inbpseq          LIKE inbp_t.inbpseq, 
       inbp001          LIKE inbp_t.inbp001, 
       inbp002          LIKE inbp_t.inbp002, 
       inbp003          LIKE inbp_t.inbp003, 
       inbp004          LIKE inbp_t.inbp004, 
       inbp005          LIKE inbp_t.inbp005, 
       inbp006          LIKE inbp_t.inbp006, 
       inbp007          LIKE inbp_t.inbp007, 
       inbp008          LIKE inbp_t.inbp008, 
       inbp009          LIKE inbp_t.inbp009, 
       inbp010          LIKE inbp_t.inbp010, 
       inbp011          LIKE inbp_t.inbp011, 
       inbp012          LIKE inbp_t.inbp012
                        END RECORD   
DEFINE l_cnt            LIKE type_t.num10   #161208-00023#1 Add By ken 161209                     
DEFINE l_slip           STRING      #單別 
DEFINE l_success        LIKE type_t.num5
DEFINE r_success        LIKE type_t.num5

   LET r_success = TRUE
   
   INITIALIZE l_inbm.* TO NULL
   INITIALIZE l_inbp.* TO NULL   
   
   #明細資料SQL
   LET l_sql = " SELECT pmdtdocno,pmdtseq,pmdt006,pmdt007,pmdt019, ",
               "        pmdt020 ",
               "   FROM pmdt_t ",
               "  WHERE pmdtent = ",g_enterprise,
               "    AND pmdtdocno = '",p_pmdsdocno, "' ",
               "    AND pmdt005 != '8' "    #161208-00023#1 Add By ken 161209
   PREPARE apmt520_pmdt_sel_pre FROM l_sql
   DECLARE apmt520_pmdt_sel_cur CURSOR FOR apmt520_pmdt_sel_pre 
   
   #161208-00023#1 Add By ken 161209(S)
   #檢查單身是否有資料
   LET l_sql = " SELECT COUNT(1) FROM inbp_t ",
               "  WHERE inbpent = ",g_enterprise,
               "    AND inbpdocno = ? "
   PREPARE apmt520_inbp_cnt FROM l_sql               
   
   #刪除無單身的單頭資料
   LET l_sql = " DELETE FROM inbm_t ",
               "  WHERE inbment = ",g_enterprise,
               "    AND inbmdocno = ? "
   PREPARE apmt520_inbm_del FROM l_sql
   #161208-00023#1 Add By ken 161209(E)

   #明細項次+1
   LET l_sql = " SELECT MAX(inbpseq)+1 ",
               "   FROM inbp_t ",
               "  WHERE inbpent = ",g_enterprise,
               "    AND inbpdocno = ? "
   PREPARE apmt520_inbpseq_sel FROM l_sql
   
   #取商品條碼
   LET l_sql = " SELECT imay003 ",
               "   FROM imay_t ",
               "  WHERE imayent = ",g_enterprise,
               "    AND imay001 = ? ",
               "    AND imay019 = ? "
   PREPARE apmt520_imay003_sel FROM l_sql
   
   LET l_sql = " SELECT pmdssite,pmds007,pmdsdocno ",
               "   FROM pmds_t ",
               "  WHERE pmdsent = ", g_enterprise ,
               "    AND pmdsdocno = '",p_pmdsdocno,"'"
   PREPARE apmt520_pmds_sel_pre FROM l_sql
   DECLARE apmt520_pmds_sel_cur CURSOR FOR apmt520_pmds_sel_pre
   FOREACH apmt520_pmds_sel_cur INTO l_pmdssite,l_pmds007,l_pmdsdocno
     #取單別
     LET l_success = ''
     CALL s_arti200_get_def_doc_type(g_site,'aint701','2')
        RETURNING l_success,l_slip
     IF l_success = FALSE THEN
        LET r_success = FALSE
        EXIT FOREACH
     END IF 

     #取單號
     LET l_success = ''
     CALL s_aooi200_gen_docno(g_site,l_slip,g_today,'aint701')
        RETURNING l_success,l_inbm.inbmdocno
     IF l_success = FALSE THEN        
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = 'apm-00003'
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        CALL cl_err()
        LET r_success = FALSE
        EXIT FOREACH
     END IF 
               
     LET l_inbm.inbment    = g_enterprise
     LET l_inbm.inbmdocdt  = g_today    
     LET l_inbm.inbmsite   = l_pmdssite         #营运据点
     LET l_inbm.inbmunit   = l_pmdssite         #配送中心    
     LET l_inbm.inbm001    = l_pmds007          #需求对象 
     LET l_inbm.inbm002    = ''                 #需求单号
     LET l_inbm.inbm003    = '5'                #来源单据类型:5.委外采购收货单
     LET l_inbm.inbm004    = l_pmdsdocno        #来源单号:單號
     LET l_inbm.inbm005    = g_user             #装箱人员
     LET l_inbm.inbm006    = g_dept             #装箱部门
     LET l_inbm.inbm007    = ''                 #備註
     LET l_inbm.inbm008    = '3'                #需求对象类型3.供應商
     LET l_inbm.inbmstus   = 'N'
     LET l_inbm.inbmownid  = g_user              #資料所有者 
     LET l_inbm.inbmowndp  = g_dept              #資料所屬部門
     LET l_inbm.inbmcrtid  = g_user              #資料建立者 
     LET l_inbm.inbmcrtdp  = g_dept              #資料建立部門
     LET l_inbm.inbmcrtdt  = cl_get_current()    #資料創建日     
     
     INSERT INTO inbm_t(inbment,  inbmdocno, inbmsite, inbmunit, inbmdocdt, 
                        inbm001,  inbm002,   inbm003,  inbm004,  inbm005, 
                        inbm006,  inbm007,   inbm008,  
                        inbmownid,inbmowndp, inbmcrtid,inbmcrtdp,inbmcrtdt,
                        inbmstus)                      
           VALUES(l_inbm.inbment,  l_inbm.inbmdocno, l_inbm.inbmsite, l_inbm.inbmunit, l_inbm.inbmdocdt, 
                  l_inbm.inbm001,  l_inbm.inbm002,   l_inbm.inbm003,  l_inbm.inbm004,  l_inbm.inbm005, 
                  l_inbm.inbm006,  l_inbm.inbm007,   l_inbm.inbm008,  
                  l_inbm.inbmownid,l_inbm.inbmowndp, l_inbm.inbmcrtid,l_inbm.inbmcrtdp,l_inbm.inbmcrtdt,
                  l_inbm.inbmstus)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'Insert inbm_t'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH         
      END IF                 
      
      #寫明細資料
      FOREACH apmt520_pmdt_sel_cur INTO l_pmdtdocno,l_pmdtseq,l_pmdt006,l_pmdt007,l_pmdt019,l_pmdt020
         LET l_inbp.inbpent   = g_enterprise
         LET l_inbp.inbpsite  = l_inbm.inbmsite
         LET l_inbp.inbpdocno = l_inbm.inbmdocno
         EXECUTE apmt520_inbpseq_sel USING l_inbm.inbmdocno INTO l_inbp.inbpseq
         IF cl_null(l_inbp.inbpseq) THEN
            LET l_inbp.inbpseq = 1
         END IF
         LET l_inbp.inbp001   = '5'
         LET l_inbp.inbp002   = l_pmdtdocno
         LET l_inbp.inbp003   = l_pmdtseq
         EXECUTE apmt520_imay003_sel USING l_pmdt006,l_pmdt007 INTO l_inbp.inbp004  
         LET l_inbp.inbp005   = l_pmdt006
         LET l_inbp.inbp006   = l_pmdt007
         LET l_inbp.inbp007   = l_pmdt019
         LET l_inbp.inbp008   = l_pmdt020
         LET l_inbp.inbp009   = 0

         INSERT INTO inbp_t(inbpent,  inbpdocno, inbpsite, inbpseq,  inbp001,  inbp002,   
                            inbp003,  inbp004,   inbp005,  inbp006,  inbp007,   
                            inbp008,  inbp009)                      
               VALUES(l_inbp.inbpent,  l_inbp.inbpdocno, l_inbp.inbpsite, l_inbp.inbpseq,   l_inbp.inbp001,  l_inbp.inbp002,   
                      l_inbp.inbp003,  l_inbp.inbp004,   l_inbp.inbp005,  l_inbp.inbp006,  l_inbp.inbp007,   
                      l_inbp.inbp008,  l_inbp.inbp009)                      
          IF SQLCA.sqlcode THEN
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = SQLCA.sqlcode
             LET g_errparam.extend = 'Insert inbp_t'
             LET g_errparam.popup = TRUE
             CALL cl_err()
             LET r_success = FALSE
             EXIT FOREACH         
          END IF   
      END FOREACH

      #161208-00023#1 Add By ken 161209(S)
      LET l_cnt = 0
      EXECUTE apmt520_inbp_cnt USING l_inbm.inbmdocno INTO l_cnt
      IF l_cnt = 0 THEN
         EXECUTE apmt520_inbm_del USING l_inbm.inbmdocno
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'Del inbm_t'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
            EXIT FOREACH         
         END IF         
      END IF
      #161208-00023#1 Add By ken 161209(E)
   END FOREACH
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: #161101-00081#1 add
# Memo...........:
# Usage..........: CALL apmt520_get_col_default()
################################################################################
PRIVATE FUNCTION apmt520_get_col_default()

   LET g_pmds_m.pmdsdocdt = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmdsdocdt',g_pmds_m.pmdsdocdt)
   
   LET g_pmds_m.pmds001 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds001',g_pmds_m.pmds001)
   LET g_pmds_m.pmds002 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds002',g_pmds_m.pmds002)
   LET g_pmds_m.pmds003 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds003',g_pmds_m.pmds003)
   LET g_pmds_m.pmds006 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds006',g_pmds_m.pmds006)
   LET g_pmds_m.pmds007 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds007',g_pmds_m.pmds007)
   LET g_pmds_m.pmds008 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds008',g_pmds_m.pmds008)
   LET g_pmds_m.pmds009 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds009',g_pmds_m.pmds009)
   LET g_pmds_m.pmds010 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds010',g_pmds_m.pmds010)
   LET g_pmds_m.pmds052 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds052',g_pmds_m.pmds052)
   LET g_pmds_m.pmds000 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds000',g_pmds_m.pmds000)
   
  #170120-00009#1 add  --begin-- 
  #LET g_pmds_m.pmds100 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds100',g_pmds_m.pmds100)
   #委外倉退的倉退方式只能選4.倉退折讓，其他的都不能選，請在輸入時限制
   IF g_argv[1] != '14' THEN
      LET g_pmds_m.pmds100 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds100',g_pmds_m.pmds100)
   END IF
   #170120-00009#1 add  --end---
   LET g_pmds_m.pmds011 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds011',g_pmds_m.pmds011)
   LET g_pmds_m.pmds014 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds014',g_pmds_m.pmds014)
   LET g_pmds_m.pmds081 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds081',g_pmds_m.pmds081)
   LET g_pmds_m.pmds045 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds045',g_pmds_m.pmds045)
   LET g_pmds_m.pmds021 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds021',g_pmds_m.pmds021)
   LET g_pmds_m.pmds022 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds022',g_pmds_m.pmds022)
   LET g_pmds_m.pmds023 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds023',g_pmds_m.pmds023)
   LET g_pmds_m.pmds024 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds024',g_pmds_m.pmds024)
   LET g_pmds_m.pmds031 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds031',g_pmds_m.pmds031)
   LET g_pmds_m.pmds032 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds032',g_pmds_m.pmds032)
   LET g_pmds_m.pmds033 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds033',g_pmds_m.pmds033)
   LET g_pmds_m.pmds034 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds034',g_pmds_m.pmds034)
   LET g_pmds_m.pmds035 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds035',g_pmds_m.pmds035)
   LET g_pmds_m.pmds036 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds036',g_pmds_m.pmds036)
   LET g_pmds_m.pmds037 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds037',g_pmds_m.pmds037)
   LET g_pmds_m.pmds038 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds038',g_pmds_m.pmds038)
   LET g_pmds_m.pmds039 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds039',g_pmds_m.pmds039)
   LET g_pmds_m.pmds040 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds040',g_pmds_m.pmds040)
   LET g_pmds_m.pmds012 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds012',g_pmds_m.pmds012)
   LET g_pmds_m.pmds101 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds101',g_pmds_m.pmds101)
   LET g_pmds_m.pmds102 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds102',g_pmds_m.pmds102)
   LET g_pmds_m.pmds103 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds103',g_pmds_m.pmds103)
   LET g_pmds_m.pmds048 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds048',g_pmds_m.pmds048)
   LET g_pmds_m.pmds047 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds047',g_pmds_m.pmds047)
   LET g_pmds_m.pmds049 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds049',g_pmds_m.pmds049)
   LET g_pmds_m.pmds053 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds053',g_pmds_m.pmds053)
   LET g_pmds_m.pmds041 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds041',g_pmds_m.pmds041)
   LET g_pmds_m.pmds043 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds043',g_pmds_m.pmds043)
   LET g_pmds_m.pmds044 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds044',g_pmds_m.pmds044)
   LET g_pmds_m.pmds046 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds046',g_pmds_m.pmds046)
   LET g_pmds_m.pmds054 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds054',g_pmds_m.pmds054)
   LET g_pmds_m.pmds055 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds055',g_pmds_m.pmds055)
   LET g_pmds_m.pmds050 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds050',g_pmds_m.pmds050)
   LET g_pmds_m.pmds057 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds057',g_pmds_m.pmds057)
   LET g_pmds_m.pmds042 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds042',g_pmds_m.pmds042)
   LET g_pmds_m.pmds058 = s_aooi200_get_doc_default(g_site,'1',g_pmds_m.pmdsdocno,'pmds058',g_pmds_m.pmds058)
   
   CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
   CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
   CALL apmt520_pmds007_ref(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
   CALL apmt520_pmds007_ref(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
   CALL apmt520_pmds007_ref(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
   CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
   CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
   CALL apmt520_pmds033_ref(g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
   CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
   CALL s_desc_get_price_type_desc(g_pmds_m.pmds039) RETURNING g_pmds_m.pmds039_desc
   CALL s_desc_ooid001_desc(g_pmds_m.pmds040) RETURNING g_pmds_m.pmds040_desc
   CALL s_desc_get_oojdl003_desc(g_pmds_m.pmds012) RETURNING g_pmds_m.pmds012_desc
   CALL s_desc_get_icaa001_desc(g_pmds_m.pmds053) RETURNING g_pmds_m.pmds053_desc
   
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocno_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,
       g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus,
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008,g_pmds_m.pmds008_desc,
       g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds000,g_pmds_m.pmds100,
       g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,
       g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,
       g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds036,g_pmds_m.pmds037,
       g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds039_desc,g_pmds_m.pmds040,
       g_pmds_m.pmds040_desc,g_pmds_m.pmds012,g_pmds_m.pmds012_desc,g_pmds_m.pmds101,g_pmds_m.pmds102,
       g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047,g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds053_desc,
       g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,
       g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058,g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,
       g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,
       g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,
       g_pmds_m.pmdspstdt

END FUNCTION
#维护备注单身
#161031-00025#15 add
PRIVATE FUNCTION apmt520_remarks()
DEFINE l_sql      STRING

   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   LET l_sql = "SELECT pmdssite,pmdsdocno,pmdsdocdt,pmds001,pmds002,pmds003,pmdsstus, 
       pmds006,pmds007,pmds008,pmds009,pmds010,pmds052,pmds028,pmds000,pmds100,pmds011,pmds014, 
       pmds081,pmds045,pmds021,pmds022,pmds023,pmds024,pmds031,pmds032,pmds033,pmds034,pmds035, 
       pmds036,pmds037,pmds038,pmds039,pmds040,pmds012,pmds101,pmds102,pmds103,pmds048,pmds047, 
       pmds049,pmds053,pmds041,pmds043,pmds044,pmds046,pmds054,pmds055,pmds050,pmds057,pmds042,pmds058, 
       pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid, 
       pmdscnfdt,pmdspstid,pmdspstdt", 
        
                      " FROM pmds_t",
                      " WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
   LET l_sql = cl_sql_forupd(l_sql)                #轉換不同資料庫語法
   LET l_sql = cl_sql_add_mask(l_sql)              #遮蔽特定資料
   DECLARE apmt520_ooff_cl CURSOR FROM l_sql
   
   CALL s_transaction_begin()
   
   OPEN apmt520_ooff_cl USING g_enterprise,g_pmds_m.pmdsdocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN apmt520_ooff_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt520_ooff_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #鎖住將被更改的資料
   FETCH apmt520_ooff_cl INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus, 
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014, 
       g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047, 
       g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058, 
       g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid, 
       g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt
   
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      CLOSE apmt520_ooff_cl
      CALL s_transaction_end('N','0')
      RETURN 
   END IF
 
   #檢查是否允許此動作
   IF NOT apmt520_action_chk() THEN
      CLOSE apmt520_ooff_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus, 
       g_pmds_m.pmds006,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds028,g_pmds_m.pmds000,g_pmds_m.pmds100,g_pmds_m.pmds011,g_pmds_m.pmds014, 
       g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035, 
       g_pmds_m.pmds036,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds039,g_pmds_m.pmds040,g_pmds_m.pmds012,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds103,g_pmds_m.pmds048,g_pmds_m.pmds047, 
       g_pmds_m.pmds049,g_pmds_m.pmds053,g_pmds_m.pmds041,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmds054,g_pmds_m.pmds055,g_pmds_m.pmds050,g_pmds_m.pmds057,g_pmds_m.pmds042,g_pmds_m.pmds058, 
       g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid, 
       g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt
 
   LET g_detail_insert = cl_auth_detail_input("insert")
   LET g_detail_delete = cl_auth_detail_input("delete")
   
   LET g_ooff001_d = '6'   #6.單據單頭備註
   LET g_ooff002_d = g_prog   
   LET g_ooff003_d = g_pmds_m.pmdsdocno   #单号  
   LET g_ooff004_d = 0    #项次
   LET g_ooff005_d = ' '
   LET g_ooff006_d = ' '
   LET g_ooff007_d = ' '
   LET g_ooff008_d = ' '
   LET g_ooff009_d = ' '
   LET g_ooff010_d = ' '
   LET g_ooff011_d = ' '
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      SUBDIALOG aoo_aooi360_01.aooi360_01_input   #备注单身
      
      ON ACTION accept  
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄) 
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   CLOSE apmt520_ooff_cl
   
   CALL s_transaction_end('Y','0')
   
   CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身
END FUNCTION

#170118-00051#1
#產生入庫/驗退單
PRIVATE FUNCTION apmt520_gen_warehouse_or_check_back()
DEFINE l_pmds_m RECORD  #收貨/入庫單頭檔
       pmdsent LIKE pmds_t.pmdsent, #企業編號
       pmdssite LIKE pmds_t.pmdssite, #營運據點
       pmdsdocno LIKE pmds_t.pmdsdocno, #單據單號
       pmdsdocdt LIKE pmds_t.pmdsdocdt, #單據日期
       pmds000 LIKE pmds_t.pmds000, #單據性質
       pmds001 LIKE pmds_t.pmds001, #扣帳日期
       pmds002 LIKE pmds_t.pmds002, #申請人員
       pmds003 LIKE pmds_t.pmds003, #申請部門
       pmds006 LIKE pmds_t.pmds006, #來源單號
       pmds007 LIKE pmds_t.pmds007, #採購供應商
       pmds008 LIKE pmds_t.pmds008, #帳款供應商
       pmds009 LIKE pmds_t.pmds009, #送貨供應商
       pmds010 LIKE pmds_t.pmds010, #供應商送貨單號
       pmds011 LIKE pmds_t.pmds011, #採購性質
       pmds012 LIKE pmds_t.pmds012, #採購通路
       pmds013 LIKE pmds_t.pmds013, #採購分類
       pmds014 LIKE pmds_t.pmds014, #多角性質
       pmds021 LIKE pmds_t.pmds021, #LC進口
       pmds022 LIKE pmds_t.pmds022, #進口日期
       pmds023 LIKE pmds_t.pmds023, #進口報單
       pmds024 LIKE pmds_t.pmds024, #進口號碼
       pmds028 LIKE pmds_t.pmds028, #一次性交易對象識別碼
       pmds031 LIKE pmds_t.pmds031, #付款條件
       pmds032 LIKE pmds_t.pmds032, #交易條件
       pmds033 LIKE pmds_t.pmds033, #稅別
       pmds034 LIKE pmds_t.pmds034, #稅率
       pmds035 LIKE pmds_t.pmds035, #單價含稅否
       pmds036 LIKE pmds_t.pmds036, #交易類型
       pmds037 LIKE pmds_t.pmds037, #幣別
       pmds038 LIKE pmds_t.pmds038, #匯率
       pmds039 LIKE pmds_t.pmds039, #取價方式
       pmds040 LIKE pmds_t.pmds040, #付款優惠條件
       pmds041 LIKE pmds_t.pmds041, #多角序號
       pmds042 LIKE pmds_t.pmds042, #整合單號
       pmds043 LIKE pmds_t.pmds043, #採購總未稅金額
       pmds044 LIKE pmds_t.pmds044, #採購總含稅金額
       pmds045 LIKE pmds_t.pmds045, #備註
       pmds046 LIKE pmds_t.pmds046, #採購總稅額
       pmds047 LIKE pmds_t.pmds047, #多角貿易中斷點
       pmds048 LIKE pmds_t.pmds048, #內外購
       pmds049 LIKE pmds_t.pmds049, #匯率計算基準
       pmds050 LIKE pmds_t.pmds050, #多角貿易已拋轉
       pmds051 LIKE pmds_t.pmds051, #出貨單號
       pmds052 LIKE pmds_t.pmds052, #供應商出貨日
       pmds053 LIKE pmds_t.pmds053, #多角流程編號
       pmds081 LIKE pmds_t.pmds081, #取回日期
       pmds100 LIKE pmds_t.pmds100, #倉退方式
       pmds101 LIKE pmds_t.pmds101, #折讓日期
       pmds102 LIKE pmds_t.pmds102, #折讓原始發票
       pmdsownid LIKE pmds_t.pmdsownid, #資料所屬者
       pmdsowndp LIKE pmds_t.pmdsowndp, #資料所有部門
       pmdscrtid LIKE pmds_t.pmdscrtid, #資料建立者
       pmdscrtdp LIKE pmds_t.pmdscrtdp, #資料建立部門
       pmdscrtdt LIKE pmds_t.pmdscrtdt, #資料創建日
       pmdsmodid LIKE pmds_t.pmdsmodid, #資料修改者
       pmdsmoddt LIKE pmds_t.pmdsmoddt, #最近修改日
       pmdscnfid LIKE pmds_t.pmdscnfid, #資料確認者
       pmdscnfdt LIKE pmds_t.pmdscnfdt, #資料確認日
       pmdspstid LIKE pmds_t.pmdspstid, #資料過帳者
       pmdspstdt LIKE pmds_t.pmdspstdt, #資料過帳日
       pmdsstus LIKE pmds_t.pmdsstus, #狀態碼
       pmds200 LIKE pmds_t.pmds200, #收貨預約單號
       pmds054 LIKE pmds_t.pmds054, #資料來源
       pmds055 LIKE pmds_t.pmds055, #來源單號
       pmds201 LIKE pmds_t.pmds201, #來源單號
       pmds202 LIKE pmds_t.pmds202, #來源類型
       pmdsunit LIKE pmds_t.pmdsunit, #應用執行組織物件
       pmds056 LIKE pmds_t.pmds056, #No use
       pmds057 LIKE pmds_t.pmds057, #整合來源
       pmds058 LIKE pmds_t.pmds058, #倒扣領料單號
       pmds103 LIKE pmds_t.pmds103 #折讓證明單開立方式
#       pmds025 LIKE pmds_t.pmds025  #保稅異動原因代碼
END RECORD
DEFINE l_success     LIKE type_t.num5
DEFINE l_oobn003     LIKE oobn_t.oobn003
DEFINE ls_sql        STRING
DEFINE l_pmdscrtdt   DATETIME YEAR TO SECOND
DEFINE l_pmdtseq     LIKE pmdt_t.pmdtseq
DEFINE l_n           LIKE type_t.num10
DEFINE l_prog        LIKE type_t.chr20     #作業編號 (gzzz001)
#DEFINE l_pmdt_s      RECORD LIKE pmdt_t.*   #來源單據 收貨單
#DEFINE l_pmdt_p      RECORD LIKE pmdt_t.*   #目的單據 入庫單
DEFINE l_pmdt_s RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
DEFINE l_pmdt_p RECORD  #收貨/入庫單身明細檔
       pmdtent LIKE pmdt_t.pmdtent, #企业编号
       pmdtsite LIKE pmdt_t.pmdtsite, #营运据点
       pmdtdocno LIKE pmdt_t.pmdtdocno, #单据编号
       pmdtseq LIKE pmdt_t.pmdtseq, #项次
       pmdt001 LIKE pmdt_t.pmdt001, #采购单号
       pmdt002 LIKE pmdt_t.pmdt002, #采购项次
       pmdt003 LIKE pmdt_t.pmdt003, #采购项序
       pmdt004 LIKE pmdt_t.pmdt004, #采购分批序
       pmdt005 LIKE pmdt_t.pmdt005, #子件特性
       pmdt006 LIKE pmdt_t.pmdt006, #料件编号
       pmdt007 LIKE pmdt_t.pmdt007, #产品特征
       pmdt008 LIKE pmdt_t.pmdt008, #包装容器
       pmdt009 LIKE pmdt_t.pmdt009, #作业编号
       pmdt010 LIKE pmdt_t.pmdt010, #作业序
       pmdt011 LIKE pmdt_t.pmdt011, #冲销顺序
       pmdt016 LIKE pmdt_t.pmdt016, #库位
       pmdt017 LIKE pmdt_t.pmdt017, #储位
       pmdt018 LIKE pmdt_t.pmdt018, #批号
       pmdt019 LIKE pmdt_t.pmdt019, #收货/入库单位
       pmdt020 LIKE pmdt_t.pmdt020, #收货/入库数量
       pmdt021 LIKE pmdt_t.pmdt021, #参考单位
       pmdt022 LIKE pmdt_t.pmdt022, #参考数量
       pmdt023 LIKE pmdt_t.pmdt023, #计价单位
       pmdt024 LIKE pmdt_t.pmdt024, #计价数量
       pmdt025 LIKE pmdt_t.pmdt025, #紧急度
       pmdt026 LIKE pmdt_t.pmdt026, #检验否
       pmdt027 LIKE pmdt_t.pmdt027, #收货单号
       pmdt028 LIKE pmdt_t.pmdt028, #收货项次
       pmdt036 LIKE pmdt_t.pmdt036, #单价
       pmdt037 LIKE pmdt_t.pmdt037, #税率
       pmdt038 LIKE pmdt_t.pmdt038, #税前金额
       pmdt039 LIKE pmdt_t.pmdt039, #含税金额
       pmdt040 LIKE pmdt_t.pmdt040, #价格核决
       pmdt041 LIKE pmdt_t.pmdt041, #保税否
       pmdt042 LIKE pmdt_t.pmdt042, #取价来源
       pmdt043 LIKE pmdt_t.pmdt043, #价格参考单号
       pmdt044 LIKE pmdt_t.pmdt044, #取出单价
       pmdt045 LIKE pmdt_t.pmdt045, #价差比
       pmdt046 LIKE pmdt_t.pmdt046, #税种
       pmdt047 LIKE pmdt_t.pmdt047, #税额
       pmdt051 LIKE pmdt_t.pmdt051, #理由码
       pmdt052 LIKE pmdt_t.pmdt052, #状态码
       pmdt053 LIKE pmdt_t.pmdt053, #允收数量
       pmdt054 LIKE pmdt_t.pmdt054, #已入库量
       pmdt055 LIKE pmdt_t.pmdt055, #验退量
       pmdt056 LIKE pmdt_t.pmdt056, #主账套已请款数量
       pmdt057 LIKE pmdt_t.pmdt057, #账套二已请款数量
       pmdt058 LIKE pmdt_t.pmdt058, #账套三已请款数量
       pmdt059 LIKE pmdt_t.pmdt059, #备注
       pmdt060 LIKE pmdt_t.pmdt060, #供应商批号
       pmdt061 LIKE pmdt_t.pmdt061, #供应商送货数量
       pmdt062 LIKE pmdt_t.pmdt062, #多库储批收货入库
       pmdt063 LIKE pmdt_t.pmdt063, #库存管理特征
       pmdt064 LIKE pmdt_t.pmdt064, #出货单号
       pmdt065 LIKE pmdt_t.pmdt065, #出货单项次
       pmdt066 LIKE pmdt_t.pmdt066, #主账套暂估数量
       pmdt067 LIKE pmdt_t.pmdt067, #账套二暂估数量
       pmdt068 LIKE pmdt_t.pmdt068, #账套三暂估数量
       pmdt069 LIKE pmdt_t.pmdt069, #已开发票数量
       pmdt081 LIKE pmdt_t.pmdt081, #QC单号
       pmdt082 LIKE pmdt_t.pmdt082, #QC判定项次
       pmdt083 LIKE pmdt_t.pmdt083, #判定结果
       pmdt084 LIKE pmdt_t.pmdt084, #须自立AP否
       pmdt085 LIKE pmdt_t.pmdt085, #多角流程编号
       pmdt086 LIKE pmdt_t.pmdt086, #采购多角性质
       pmdt087 LIKE pmdt_t.pmdt087, #采购单开立据点
       pmdt088 LIKE pmdt_t.pmdt088, #存货备注
       pmdt089 LIKE pmdt_t.pmdt089, #有效日期
       pmdt900 LIKE pmdt_t.pmdt900, #保留字段str
       pmdt999 LIKE pmdt_t.pmdt999, #保留字段end
       pmdt200 LIKE pmdt_t.pmdt200, #商品条码
       pmdt201 LIKE pmdt_t.pmdt201, #收货包装单位
       pmdt202 LIKE pmdt_t.pmdt202, #收货包装数量
       pmdt203 LIKE pmdt_t.pmdt203, #采购组织
       pmdt204 LIKE pmdt_t.pmdt204, #采购中心
       pmdt205 LIKE pmdt_t.pmdt205, #要货组织
       pmdt206 LIKE pmdt_t.pmdt206, #预约收货单号
       pmdt207 LIKE pmdt_t.pmdt207, #预约收货项次
       pmdt208 LIKE pmdt_t.pmdt208, #采购渠道
       pmdt209 LIKE pmdt_t.pmdt209, #渠道性质
       pmdt210 LIKE pmdt_t.pmdt210, #经营方式
       pmdt211 LIKE pmdt_t.pmdt211, #结算方式
       pmdt212 LIKE pmdt_t.pmdt212, #合同编号
       pmdt213 LIKE pmdt_t.pmdt213, #协议编号
       pmdtorga LIKE pmdt_t.pmdtorga, #账务组织
       pmdt070 LIKE pmdt_t.pmdt070, #参考单号
       pmdt071 LIKE pmdt_t.pmdt071, #参考项次
       pmdt214 LIKE pmdt_t.pmdt214, #采购方式
       pmdt215 LIKE pmdt_t.pmdt215, #最终收货组织
       pmdt048 LIKE pmdt_t.pmdt048, #价格参考项次
       pmdt216 LIKE pmdt_t.pmdt216, #退货申请单号
       pmdt217 LIKE pmdt_t.pmdt217, #退货申请项次
       pmdt090 LIKE pmdt_t.pmdt090, #借货还价数量
       pmdt091 LIKE pmdt_t.pmdt091, #借货还价参考数量
       pmdt092 LIKE pmdt_t.pmdt092, #还价税前金额
       pmdt093 LIKE pmdt_t.pmdt093, #还价含税金额
       pmdt218 LIKE pmdt_t.pmdt218, #采购价
       pmdt219 LIKE pmdt_t.pmdt219, #制造日期
       pmdt072 LIKE pmdt_t.pmdt072, #项目编号
       pmdt073 LIKE pmdt_t.pmdt073, #WBS
       pmdt074 LIKE pmdt_t.pmdt074, #活动编号
       pmdt227 LIKE pmdt_t.pmdt227, #补货规格说明
       pmdt049 LIKE pmdt_t.pmdt049, #发票编号
       pmdt050 LIKE pmdt_t.pmdt050, #发票号码
       pmdt075 LIKE pmdt_t.pmdt075, #预算细项
       pmdt220 LIKE pmdt_t.pmdt220, #商品品类
       pmdt221 LIKE pmdt_t.pmdt221  #来源单据商品品类
END RECORD
DEFINE l_xrcd104     LIKE xrcd_t.xrcd104
DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
DEFINE l_rate        LIKE inaj_t.inaj014
DEFINE l_flag        LIKE type_t.num5
DEFINE l_pmdt020     LIKE pmdt_t.pmdt020
DEFINE r_success     LIKE type_t.num5
DEFINE l_n1          LIKE type_t.num10
DEFINE l_n2          LIKE type_t.num10
DEFINE l_n3          LIKE type_t.num10
DEFINE l_cnt         LIKE type_t.num10

    LET r_success = TRUE
    
    IF g_pmds_m.pmdsdocno IS NULL  THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "" 
       LET g_errparam.code   = "std-00003" 
       LET g_errparam.popup  = FALSE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    IF g_pmds_m.pmdsstus <> 'Y' THEN
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #单身全部是需QC的，判断是否有QC单
    LET l_n1 = 0
    SELECT COUNT(1) INTO l_n1 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdt026 = 'N' 
    IF l_n1 = 0 OR cl_null(l_n1) THEN
       SELECT COUNT(1) INTO l_n1 FROM qcba_t  
            WHERE qcbaent   = g_enterprise 
              AND qcbasite  = g_site 
              AND qcba001   = g_pmds_m.pmdsdocno
              AND qcbastus  = 'Y' 
       IF l_n1 = 0 OR cl_null(l_n1) THEN
          INITIALIZE g_errparam TO NULL 
          LET g_errparam.extend = g_pmds_m.pmdsdocno
          LET g_errparam.code   = 'apm-00680'
          LET g_errparam.popup  = TRUE 
          CALL cl_err()
          LET r_success = FALSE
          RETURN r_success 
       END IF
    END IF
    
    #入库单
    #存在允收數量 > 0的單身
    #料件需QC時，允收數量- 已入庫數量 > 0
    #料件不走QC時，收貨數量（允收數量） - 已入庫量 - 已驗退量 > 0
    LET l_n1 = 0
    SELECT COUNT(1) INTO l_n1 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt053 - pmdt054 - pmdt055 ) > 0 AND pmdt026 = 'N'

    LET l_n2 = 0
    SELECT COUNT(1) INTO l_n2 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt053 - pmdt054 ) > 0 AND pmdt026 = 'Y'
    
    #验退单
    #存在驗退數量(收貨數量-允收數量) > 0的單身
    #料件需QC時，收貨數量- 允收數量 > 0
    #料件不走QC時，收貨數量（允收數量） - 已入庫量 - 已驗退量 > 0
    LET l_n3 = 0
    SELECT COUNT(1) INTO l_n3 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND (pmdt020 - pmdt053 ) > 0 AND pmdt026 = 'Y'
           
    #无可入库/验退但的资料产生！
    IF (l_n1 = 0 OR cl_null(l_n1)) AND (l_n2 = 0 OR cl_null(l_n2)) AND (l_n3 = 0 OR cl_null(l_n3)) THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = g_pmds_m.pmdsdocno
       LET g_errparam.code   = 'apm-01156'
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success
    ELSE
       #只能产生入库单的时候判断
       IF ((l_n1 = 0 OR cl_null(l_n1)) AND (l_n3 = 0 OR cl_null(l_n3))) AND ( l_n2 > 0 OR l_n1 > 0 ) THEN
          #161024-00023#1 Add By Ken 161026  apmt521(S)
          IF g_argv[1] = '8' THEN   
             LET l_cnt = 0
             SELECT COUNT(1) INTO l_cnt
               FROM inbm_t
              WHERE inbment = g_enterprise
                AND inbm004 = g_pmds_m.pmdsdocno
                AND inbmstus != 'X'
             IF l_cnt > 0 THEN
                INITIALIZE g_errparam TO NULL
                LET g_errparam.code = 'ain-00807'  
                LET g_errparam.extend = g_pmds_m.pmdsdocno
                LET g_errparam.popup = TRUE
                CALL cl_err()  
                LET r_success = FALSE
                RETURN r_success                   
             END IF
          END IF     
          #161024-00023#1 Add By Ken 161026  apmt521(E)
       END IF
    END IF
    
    CALL s_transaction_begin()
   
    OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
    IF STATUS THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "OPEN apmt520_cl:" 
       LET g_errparam.code   = STATUS 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #入库单
    IF l_n1 > 0 OR l_n2 > 0  THEN
       IF NOT s_apmt520_gen_pmds('1',g_pmds_m.pmdsdocno) THEN
          CALL s_transaction_end('N','0')
          #LET r_success = FALSE
          #RETURN r_success
       END IF
    END IF
    CALL s_transaction_end('Y','0')
    
    #验退单
    #存在驗退數量(收貨數量-允收數量) > 0的單身
    #料件需QC時，收貨數量- 允收數量 > 0
    #料件不走QC時，收貨數量（允收數量） - 已入庫量 - 已驗退量 > 0
    CALL s_transaction_begin()
   
    OPEN apmt520_cl USING g_enterprise,g_pmds_m.pmdsdocno
    IF STATUS THEN
       INITIALIZE g_errparam TO NULL 
       LET g_errparam.extend = "OPEN apmt520_cl:" 
       LET g_errparam.code   = STATUS 
       LET g_errparam.popup  = TRUE 
       CALL cl_err()
       CLOSE apmt520_cl
       CALL s_transaction_end('N','0')
       LET r_success = FALSE
       RETURN r_success
    END IF
    
    #再入库单产生之后，重新抓资料，判断是否可产生验退
    #若单身都是不检验的料号，在前面就已全部先产生入库了，不会走验退
    LET l_n1 = 0
    SELECT COUNT(1) INTO l_n1 FROM pmdt_t WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno AND pmdt026 = 'Y' 
    
    #若是单身有需要检验的料号，判断aqct300中是否存在验退的资料，若没有，则也无需产生验退单
    IF l_n1 > 0 THEN
       SELECT COUNT(1) INTO l_n1 FROM qcbc_t,qcba_t  
            WHERE qcbcent   = g_enterprise AND qcbcent  = qcbaent
              AND qcbcsite  = g_site AND qcbcsite = qcbasite
              AND qcbcdocno = qcbadocno 
              AND qcba001   = g_pmds_m.pmdsdocno
              AND qcbastus  = 'Y' 
              AND qcbc012 = '4'

       IF l_n1 > 0 THEN
          IF NOT s_apmt520_gen_pmds('2',g_pmds_m.pmdsdocno) THEN
             CALL s_transaction_end('N','0')
             #LET r_success = FALSE
             #RETURN r_success
          END IF
       END IF
    END IF
    
    CALL s_transaction_end('Y','0')

    RETURN r_success
    
END FUNCTION

 
{</section>}
 
