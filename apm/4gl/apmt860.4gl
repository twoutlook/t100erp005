#該程式未解開Section, 採用最新樣板產出!
{<section id="apmt860.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0033(2017-02-07 11:14:48), PR版次:0033(2017-02-20 09:03:27)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000169
#+ Filename...: apmt860
#+ Description: 採購收貨單維護作業
#+ Creator....: 04226(2014-12-19 14:17:31)
#+ Modifier...: 02159 -SD/PR- 08171
 
{</section>}
 
{<section id="apmt860.global" >}
#應用 t01 樣板自動產生(Version:79)
#add-point:填寫註解說明 name="global.memo" 
#160201-00017#1   2016/02/02  By fionchen 產品特徵欄位若無開窗輸入反而自行手動輸入時,則無法新增至inam_t
#160314-00009#5   2016/03/17  By zhujing  各程式增加产品特征是否需要自动开窗的程式段处理
#160318-00025#21  2016/04/19  BY 07900    校验代码重复错误讯息的修改
#160604-00009#92 2016/06/23 by 08172      新增参数判断是否抛转财务单据
#160604-00009#148 2016/07/14  by 08172    采购单开窗过滤未审核和作废的单据
#160510-00043#2   2016/07/25  By 02097    T類作業在browser_fill()組SQL前,呼叫s_aooi200_filter_slip將回傳條件組進去g_wc中
#160816-00001#9   2016/08/17  By 08734    抓取理由碼改CALL sub
#160818-00017#29  2016/08/30  By 08742    删除修改未重新判断状态码
#160824-00007#15  2016/09/14  By 06814    舊值備份處理
#161006-00008#6   2016/10/18  by 06137    組織類型與職能開窗清單調整
#161228-00033#3   2017/01/03  by sakura   為了客戶DB種類的相容性:rownum寫法的改寫
#170207-00002#1   2017/02/07  by sakura   1.退廠單(apmt890):輸入單頭收貨單號會自動帶出單身資料時,需重新取合同相關資料,同單身輸入商品重取合同相關資料處理段
#                                         2.退廠單(apmt890)為批號沖減流程(單別參數:D-CIR-0001=2.先進先出3.高價優先4.低價優先、庫存批次沖減方式:E-CIR-00292.先進先出3.高價優先4.低價優先)時
#                                           (先取單別參數,取不到才取企業級參數),輸入單頭收貨單號自動帶出單身資料控卡
#                                         2.1.單身批號清空,沖減時回寫批號
#                                         2.2.與收貨單勾稽時(E-CIR-0048),清空合同及協議(勾稽會依批號抓取收貨單的資料回寫)
#170216-00026#1   2017/02/17  By 08171    修正採購方式為統採越庫時apmt860整單操作產生apmt880入庫單時，要把單身的最終收貨組織帶到apmt880
#170217-00003#1   2017/02/18  By 08171    apmt860收貨單在產生單身or手打採購單時，採購方式為統採越庫時，單身的庫位pmdt016需依原採購單單身的收貨組織取預設庫位，依入庫取預設庫順序抓取。
#                                         apmt880入庫單在產生單身or手打採購單時，若apmt860單身的庫位pmdt016為空，則需依原採購單單身的收貨組織取預設庫位，依入庫取預設庫順序抓取。
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"

#end add-point 
 
SCHEMA ds 
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_pmds_m        RECORD
       pmdssite LIKE pmds_t.pmdssite, 
   pmdssite_desc LIKE type_t.chr80, 
   pmdsdocdt LIKE pmds_t.pmdsdocdt, 
   pmds001 LIKE pmds_t.pmds001, 
   pmdsdocno LIKE pmds_t.pmdsdocno, 
   pmds200 LIKE pmds_t.pmds200, 
   pmds006 LIKE pmds_t.pmds006, 
   pmds011 LIKE pmds_t.pmds011, 
   pmds002 LIKE pmds_t.pmds002, 
   pmds002_desc LIKE type_t.chr80, 
   pmds003 LIKE pmds_t.pmds003, 
   pmds003_desc LIKE type_t.chr80, 
   pmdsstus LIKE pmds_t.pmdsstus, 
   pmds007 LIKE pmds_t.pmds007, 
   pmds007_desc LIKE type_t.chr80, 
   pmds008 LIKE pmds_t.pmds008, 
   pmds008_desc LIKE type_t.chr80, 
   pmds009 LIKE pmds_t.pmds009, 
   pmds009_desc LIKE type_t.chr80, 
   pmds010 LIKE pmds_t.pmds010, 
   pmds052 LIKE pmds_t.pmds052, 
   pmds100 LIKE pmds_t.pmds100, 
   pmds081 LIKE pmds_t.pmds081, 
   pmds045 LIKE pmds_t.pmds045, 
   pmds202 LIKE pmds_t.pmds202, 
   pmds201 LIKE pmds_t.pmds201, 
   pmds021 LIKE pmds_t.pmds021, 
   pmds022 LIKE pmds_t.pmds022, 
   pmds023 LIKE pmds_t.pmds023, 
   pmds024 LIKE pmds_t.pmds024, 
   pmds048 LIKE pmds_t.pmds048, 
   pmds049 LIKE pmds_t.pmds049, 
   pmds031 LIKE pmds_t.pmds031, 
   pmds031_desc LIKE type_t.chr80, 
   pmds032 LIKE pmds_t.pmds032, 
   pmds032_desc LIKE type_t.chr80, 
   pmds037 LIKE pmds_t.pmds037, 
   pmds037_desc LIKE type_t.chr80, 
   pmds038 LIKE pmds_t.pmds038, 
   pmds033 LIKE pmds_t.pmds033, 
   pmds033_desc LIKE type_t.chr80, 
   pmds034 LIKE pmds_t.pmds034, 
   pmds035 LIKE pmds_t.pmds035, 
   pmds101 LIKE pmds_t.pmds101, 
   pmds102 LIKE pmds_t.pmds102, 
   pmds000 LIKE pmds_t.pmds000, 
   pmds014 LIKE pmds_t.pmds014, 
   pmds043 LIKE pmds_t.pmds043, 
   pmds044 LIKE pmds_t.pmds044, 
   pmds046 LIKE pmds_t.pmds046, 
   pmdsownid LIKE pmds_t.pmdsownid, 
   pmdsownid_desc LIKE type_t.chr80, 
   pmdsowndp LIKE pmds_t.pmdsowndp, 
   pmdsowndp_desc LIKE type_t.chr80, 
   pmdscrtid LIKE pmds_t.pmdscrtid, 
   pmdscrtid_desc LIKE type_t.chr80, 
   pmdscrtdp LIKE pmds_t.pmdscrtdp, 
   pmdscrtdp_desc LIKE type_t.chr80, 
   pmdscrtdt LIKE pmds_t.pmdscrtdt, 
   pmdsmodid LIKE pmds_t.pmdsmodid, 
   pmdsmodid_desc LIKE type_t.chr80, 
   pmdsmoddt LIKE pmds_t.pmdsmoddt, 
   pmdscnfid LIKE pmds_t.pmdscnfid, 
   pmdscnfid_desc LIKE type_t.chr80, 
   pmdscnfdt LIKE pmds_t.pmdscnfdt, 
   pmdspstid LIKE pmds_t.pmdspstid, 
   pmdspstid_desc LIKE type_t.chr80, 
   pmdspstdt LIKE pmds_t.pmdspstdt
       END RECORD
 
#單身 type 宣告
PRIVATE TYPE type_g_pmdt_d        RECORD
       pmdtsite LIKE pmdt_t.pmdtsite, 
   pmdtseq LIKE pmdt_t.pmdtseq, 
   pmdt206 LIKE pmdt_t.pmdt206, 
   pmdt207 LIKE pmdt_t.pmdt207, 
   pmdt027 LIKE pmdt_t.pmdt027, 
   pmdt028 LIKE pmdt_t.pmdt028, 
   pmdt216 LIKE pmdt_t.pmdt216, 
   pmdt217 LIKE pmdt_t.pmdt217, 
   pmdt001 LIKE pmdt_t.pmdt001, 
   pmdt002 LIKE pmdt_t.pmdt002, 
   pmdt003 LIKE pmdt_t.pmdt003, 
   pmdt004 LIKE pmdt_t.pmdt004, 
   pmdo001 LIKE type_t.chr500, 
   pmdo001_desc LIKE type_t.chr500, 
   pmdo001_desc_desc LIKE type_t.chr500, 
   pmdt221 LIKE pmdt_t.pmdt221, 
   pmdt221_desc LIKE type_t.chr500, 
   pmdo002 LIKE type_t.chr500, 
   pmdo002_desc LIKE type_t.chr500, 
   pmdt005 LIKE pmdt_t.pmdt005, 
   pmdt200 LIKE pmdt_t.pmdt200, 
   pmdt006 LIKE pmdt_t.pmdt006, 
   pmdt006_desc LIKE type_t.chr500, 
   pmdt006_desc_desc LIKE type_t.chr500, 
   pmdt220 LIKE pmdt_t.pmdt220, 
   pmdt220_desc LIKE type_t.chr500, 
   pmdt007 LIKE pmdt_t.pmdt007, 
   pmdt007_desc LIKE type_t.chr500, 
   pmdt025 LIKE pmdt_t.pmdt025, 
   pmdt227 LIKE pmdt_t.pmdt227, 
   pmdt201 LIKE pmdt_t.pmdt201, 
   pmdt201_desc LIKE type_t.chr500, 
   pmdt202 LIKE pmdt_t.pmdt202, 
   pmdt019 LIKE pmdt_t.pmdt019, 
   pmdt019_desc LIKE type_t.chr500, 
   pmdt020 LIKE pmdt_t.pmdt020, 
   l_pmdo006 LIKE type_t.num20_6, 
   pmdt023 LIKE pmdt_t.pmdt023, 
   pmdt023_desc LIKE type_t.chr500, 
   pmdt024 LIKE pmdt_t.pmdt024, 
   pmdt036 LIKE pmdt_t.pmdt036, 
   pmdt218 LIKE pmdt_t.pmdt218, 
   pmdt044 LIKE pmdt_t.pmdt044, 
   pmdt046 LIKE pmdt_t.pmdt046, 
   pmdt046_desc LIKE type_t.chr500, 
   pmdt037 LIKE pmdt_t.pmdt037, 
   pmdt038 LIKE pmdt_t.pmdt038, 
   pmdt039 LIKE pmdt_t.pmdt039, 
   pmdt047 LIKE pmdt_t.pmdt047, 
   pmdt026 LIKE pmdt_t.pmdt026, 
   pmdt062 LIKE pmdt_t.pmdt062, 
   pmdt016 LIKE pmdt_t.pmdt016, 
   pmdt016_desc LIKE type_t.chr500, 
   pmdt017 LIKE pmdt_t.pmdt017, 
   pmdt017_desc LIKE type_t.chr500, 
   pmdt018 LIKE pmdt_t.pmdt018, 
   pmdt063 LIKE pmdt_t.pmdt063, 
   pmdt052 LIKE pmdt_t.pmdt052, 
   pmdt051 LIKE pmdt_t.pmdt051, 
   pmdt051_desc LIKE type_t.chr500, 
   pmdt059 LIKE pmdt_t.pmdt059, 
   pmdt203 LIKE pmdt_t.pmdt203, 
   pmdt203_desc LIKE type_t.chr500, 
   pmdt204 LIKE pmdt_t.pmdt204, 
   pmdt204_desc LIKE type_t.chr500, 
   pmdt205 LIKE pmdt_t.pmdt205, 
   pmdt205_desc LIKE type_t.chr500, 
   pmdt214 LIKE pmdt_t.pmdt214, 
   pmdt215 LIKE pmdt_t.pmdt215, 
   pmdt215_desc LIKE type_t.chr500, 
   pmdt208 LIKE pmdt_t.pmdt208, 
   pmdt208_desc LIKE type_t.chr500, 
   pmdt209 LIKE pmdt_t.pmdt209, 
   pmdt210 LIKE pmdt_t.pmdt210, 
   pmdt211 LIKE pmdt_t.pmdt211, 
   pmdt211_desc LIKE type_t.chr500, 
   pmdt212 LIKE pmdt_t.pmdt212, 
   pmdt213 LIKE pmdt_t.pmdt213, 
   pmdtorga LIKE pmdt_t.pmdtorga, 
   pmdtorga_desc LIKE type_t.chr500, 
   pmdt053 LIKE pmdt_t.pmdt053, 
   pmdt054 LIKE pmdt_t.pmdt054, 
   pmdt055 LIKE pmdt_t.pmdt055, 
   pmdt060 LIKE pmdt_t.pmdt060, 
   pmdt061 LIKE pmdt_t.pmdt061, 
   pmdt084 LIKE pmdt_t.pmdt084, 
   pmdt219 LIKE pmdt_t.pmdt219, 
   pmdt089 LIKE pmdt_t.pmdt089, 
   pmdt088 LIKE pmdt_t.pmdt088
       END RECORD
PRIVATE TYPE type_g_pmdt2_d RECORD
       pmdusite LIKE pmdu_t.pmdusite, 
   pmduseq LIKE pmdu_t.pmduseq, 
   pmduseq1 LIKE pmdu_t.pmduseq1, 
   pmdu001 LIKE pmdu_t.pmdu001, 
   pmdu001_desc LIKE type_t.chr500, 
   pmdu001_desc_desc LIKE type_t.chr500, 
   pmdu002 LIKE pmdu_t.pmdu002, 
   pmdu002_desc LIKE type_t.chr500, 
   pmdu006 LIKE pmdu_t.pmdu006, 
   pmdu006_desc LIKE type_t.chr500, 
   pmdu007 LIKE pmdu_t.pmdu007, 
   pmdu007_desc LIKE type_t.chr500, 
   pmdu008 LIKE pmdu_t.pmdu008, 
   pmdu005 LIKE pmdu_t.pmdu005, 
   pmdu200 LIKE pmdu_t.pmdu200, 
   pmdu200_desc LIKE type_t.chr500, 
   pmdu201 LIKE pmdu_t.pmdu201, 
   pmdu009 LIKE pmdu_t.pmdu009, 
   pmdu009_desc LIKE type_t.chr500, 
   pmdu010 LIKE pmdu_t.pmdu010, 
   pmdu013 LIKE pmdu_t.pmdu013, 
   pmdu014 LIKE pmdu_t.pmdu014, 
   pmdu015 LIKE pmdu_t.pmdu015, 
   pmdu202 LIKE pmdu_t.pmdu202, 
   pmdu017 LIKE pmdu_t.pmdu017, 
   pmdu016 LIKE pmdu_t.pmdu016
       END RECORD
PRIVATE TYPE type_g_pmdt3_d RECORD
       pmdvsite LIKE pmdv_t.pmdvsite, 
   pmdvseq LIKE pmdv_t.pmdvseq, 
   pmdvseq1 LIKE pmdv_t.pmdvseq1, 
   pmdv005 LIKE pmdv_t.pmdv005, 
   pmdv001 LIKE pmdv_t.pmdv001, 
   pmdv001_desc LIKE type_t.chr500, 
   pmdv001_desc_desc LIKE type_t.chr500, 
   pmdv002 LIKE pmdv_t.pmdv002, 
   pmdv002_desc LIKE type_t.chr500, 
   pmdv014 LIKE pmdv_t.pmdv014, 
   pmdv015 LIKE pmdv_t.pmdv015, 
   pmdv016 LIKE pmdv_t.pmdv016, 
   pmdv017 LIKE pmdv_t.pmdv017, 
   pmdv200 LIKE pmdv_t.pmdv200, 
   pmdv200_desc LIKE type_t.chr500, 
   pmdv201 LIKE pmdv_t.pmdv201, 
   pmdv018 LIKE pmdv_t.pmdv018, 
   pmdv018_desc LIKE type_t.chr500, 
   pmdv019 LIKE pmdv_t.pmdv019
       END RECORD
PRIVATE TYPE type_g_pmdt4_d RECORD
       pmdtseq LIKE pmdt_t.pmdtseq, 
   pmdt0011 LIKE type_t.chr20, 
   pmdt0021 LIKE type_t.num10, 
   pmdt0031 LIKE type_t.num10, 
   pmdt0041 LIKE type_t.num10, 
   pmdt0051 LIKE type_t.chr10, 
   pmdt0061 LIKE type_t.chr500, 
   pmdt0061_desc LIKE type_t.chr500, 
   pmdt0061_desc_desc LIKE type_t.chr500, 
   pmdt0071 LIKE type_t.chr500, 
   pmdt0071_desc LIKE type_t.chr500, 
   pmdt2011 LIKE type_t.chr10, 
   pmdt2011_desc LIKE type_t.chr500, 
   pmdt2021 LIKE type_t.num20_6, 
   pmdt0191 LIKE type_t.chr10, 
   pmdt0191_desc LIKE type_t.chr500, 
   pmdt0201 LIKE type_t.num20_6, 
   pmdt0231 LIKE type_t.chr10, 
   pmdt0231_desc LIKE type_t.chr500, 
   pmdt0241 LIKE type_t.num20_6, 
   pmdt0361 LIKE type_t.num20_6, 
   pmdt2181 LIKE type_t.num20_6, 
   pmdt0441 LIKE type_t.num20_6, 
   pmdt0461 LIKE type_t.chr10, 
   pmdt0461_desc LIKE type_t.chr500, 
   pmdt0371 LIKE type_t.num26_10, 
   pmdt0381 LIKE type_t.num20_6, 
   pmdt0391 LIKE type_t.num20_6, 
   pmdt0471 LIKE type_t.num20_6
       END RECORD
PRIVATE TYPE type_g_pmdt5_d RECORD
       xrcdsite LIKE xrcd_t.xrcdsite, 
   xrcdld LIKE xrcd_t.xrcdld, 
   xrcdseq LIKE xrcd_t.xrcdseq, 
   xrcd007 LIKE xrcd_t.xrcd007, 
   pmdt200 LIKE pmdt_t.pmdt200, 
   pmdt006 LIKE pmdt_t.pmdt006, 
   pmdt006_2_desc LIKE type_t.chr500, 
   pmdt006_2_desc_desc LIKE type_t.chr500, 
   pmdt007 LIKE pmdt_t.pmdt007, 
   pmdt007_2_desc LIKE type_t.chr500, 
   xrcd002 LIKE xrcd_t.xrcd002, 
   xrcd002_desc LIKE type_t.chr500, 
   xrcdseq2 LIKE xrcd_t.xrcdseq2, 
   xrcd003 LIKE xrcd_t.xrcd003, 
   xrcd006 LIKE xrcd_t.xrcd006, 
   xrcd004 LIKE xrcd_t.xrcd004, 
   xrcd104 LIKE xrcd_t.xrcd104
       END RECORD
 
 
PRIVATE TYPE type_browser RECORD
         b_statepic     LIKE type_t.chr50,
            b_pmdsdocno LIKE pmds_t.pmdsdocno,
      b_pmdsdocdt LIKE pmds_t.pmdsdocdt,
      b_pmds002 LIKE pmds_t.pmds002,
   b_pmds002_desc LIKE type_t.chr80,
      b_pmds003 LIKE pmds_t.pmds003,
   b_pmds003_desc LIKE type_t.chr80,
      b_pmds007 LIKE pmds_t.pmds007,
   b_pmds007_desc LIKE type_t.chr80,
      b_pmds008 LIKE pmds_t.pmds008,
   b_pmds008_desc LIKE type_t.chr80,
      b_pmds009 LIKE pmds_t.pmds009,
   b_pmds009_desc LIKE type_t.chr80
       END RECORD
       
#add-point:自定義模組變數(Module Variable) (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="global.variable"
DEFINE g_pmdt016             LIKE pmdt_t.pmdt016     #前單據限定庫位
DEFINE g_pmdt017             LIKE pmdt_t.pmdt017     #前單據限定儲位
DEFINE g_pmdt018             LIKE pmdt_t.pmdt018     #前單據限定批號
DEFINE g_pmdt063             LIKE pmdt_t.pmdt063     #前單據庫存管理特徵
DEFINE g_slip_wc          STRING     #160510-00043#2
#end add-point
       
#模組變數(Module Variables)
DEFINE g_pmds_m          type_g_pmds_m
DEFINE g_pmds_m_t        type_g_pmds_m
DEFINE g_pmds_m_o        type_g_pmds_m
DEFINE g_pmds_m_mask_o   type_g_pmds_m #轉換遮罩前資料
DEFINE g_pmds_m_mask_n   type_g_pmds_m #轉換遮罩後資料
 
   DEFINE g_pmdsdocno_t LIKE pmds_t.pmdsdocno
 
 
DEFINE g_pmdt_d          DYNAMIC ARRAY OF type_g_pmdt_d
DEFINE g_pmdt_d_t        type_g_pmdt_d
DEFINE g_pmdt_d_o        type_g_pmdt_d
DEFINE g_pmdt_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt_d #轉換遮罩前資料
DEFINE g_pmdt_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt_d #轉換遮罩後資料
DEFINE g_pmdt2_d          DYNAMIC ARRAY OF type_g_pmdt2_d
DEFINE g_pmdt2_d_t        type_g_pmdt2_d
DEFINE g_pmdt2_d_o        type_g_pmdt2_d
DEFINE g_pmdt2_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt2_d #轉換遮罩前資料
DEFINE g_pmdt2_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt2_d #轉換遮罩後資料
DEFINE g_pmdt3_d          DYNAMIC ARRAY OF type_g_pmdt3_d
DEFINE g_pmdt3_d_t        type_g_pmdt3_d
DEFINE g_pmdt3_d_o        type_g_pmdt3_d
DEFINE g_pmdt3_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt3_d #轉換遮罩前資料
DEFINE g_pmdt3_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt3_d #轉換遮罩後資料
DEFINE g_pmdt4_d          DYNAMIC ARRAY OF type_g_pmdt4_d
DEFINE g_pmdt4_d_t        type_g_pmdt4_d
DEFINE g_pmdt4_d_o        type_g_pmdt4_d
DEFINE g_pmdt4_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt4_d #轉換遮罩前資料
DEFINE g_pmdt4_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt4_d #轉換遮罩後資料
DEFINE g_pmdt5_d          DYNAMIC ARRAY OF type_g_pmdt5_d
DEFINE g_pmdt5_d_t        type_g_pmdt5_d
DEFINE g_pmdt5_d_o        type_g_pmdt5_d
DEFINE g_pmdt5_d_mask_o   DYNAMIC ARRAY OF type_g_pmdt5_d #轉換遮罩前資料
DEFINE g_pmdt5_d_mask_n   DYNAMIC ARRAY OF type_g_pmdt5_d #轉換遮罩後資料
 
 
DEFINE g_browser         DYNAMIC ARRAY OF type_browser
DEFINE g_browser_f       DYNAMIC ARRAY OF type_browser
 
 
DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc2_table2   STRING
 
DEFINE g_wc2_table3   STRING
 
DEFINE g_wc2_table4   STRING
 
 
 
DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING
 
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog
                                                               
DEFINE g_pagestart           LIKE type_t.num10                 
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)
DEFINE g_order               STRING                             #查詢排序欄位
                                                        
DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入
 
DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明(global.argv) name="global.argv"
########################################
#apmt860 (g_argv[1] = '1')  採購收貨單
#apmt861 (g_argv[1] = '2')  無採購收貨單
#apmt862 (g_argv[1] = '3')  採購收貨入庫單
#apmt863 (g_argv[1] = '4')  無採購收貨入庫單
#apmt870 (g_argv[1] = '5')  採購驗退單
#apmt880 (g_argv[1] = '6')  採購入庫單
#apmt890 (g_argv[1] = '7')  採購倉退單
#apmt881 (g_argv[1] = '16')  虛擬入庫單
#apmt891 (g_argv[1] = '17')  虛擬退廠單
#apmt882 (g_argv[1] = '18')  虛擬異動單   #151104-00007#1 Add By Ken 151109 加上 g_arvg[1]=18
#########################################
#end add-point
 
{</section>}
 
{<section id="apmt860.main" >}
#應用 a26 樣板自動產生(Version:7)
#+ 作業開始(主程式類型)
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"
   DEFINE l_success LIKE type_t.num5   #150308-00001#3 150309 pomelo add
   #end add-point   
   
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("apm","")
 
   #add-point:作業初始化 name="main.init"
   IF NOT cl_null(g_argv[1]) THEN
      LET g_pmds_m.pmds000 = g_argv[1]
   END IF
   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define name="main.define_sql"
            
   #end add-point
   LET g_forupd_sql = " SELECT pmdssite,'',pmdsdocdt,pmds001,pmdsdocno,pmds200,pmds006,pmds011,pmds002, 
       '',pmds003,'',pmdsstus,pmds007,'',pmds008,'',pmds009,'',pmds010,pmds052,pmds100,pmds081,pmds045, 
       pmds202,pmds201,pmds021,pmds022,pmds023,pmds024,pmds048,pmds049,pmds031,'',pmds032,'',pmds037, 
       '',pmds038,pmds033,'',pmds034,pmds035,pmds101,pmds102,pmds000,pmds014,pmds043,pmds044,pmds046, 
       pmdsownid,'',pmdsowndp,'',pmdscrtid,'',pmdscrtdp,'',pmdscrtdt,pmdsmodid,'',pmdsmoddt,pmdscnfid, 
       '',pmdscnfdt,pmdspstid,'',pmdspstdt", 
                      " FROM pmds_t",
                      " WHERE pmdsent= ? AND pmdsdocno=? FOR UPDATE"
   #add-point:SQL_define name="main.after_define_sql"
            
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt860_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT DISTINCT t0.pmdssite,t0.pmdsdocdt,t0.pmds001,t0.pmdsdocno,t0.pmds200,t0.pmds006, 
       t0.pmds011,t0.pmds002,t0.pmds003,t0.pmdsstus,t0.pmds007,t0.pmds008,t0.pmds009,t0.pmds010,t0.pmds052, 
       t0.pmds100,t0.pmds081,t0.pmds045,t0.pmds202,t0.pmds201,t0.pmds021,t0.pmds022,t0.pmds023,t0.pmds024, 
       t0.pmds048,t0.pmds049,t0.pmds031,t0.pmds032,t0.pmds037,t0.pmds038,t0.pmds033,t0.pmds034,t0.pmds035, 
       t0.pmds101,t0.pmds102,t0.pmds000,t0.pmds014,t0.pmds043,t0.pmds044,t0.pmds046,t0.pmdsownid,t0.pmdsowndp, 
       t0.pmdscrtid,t0.pmdscrtdp,t0.pmdscrtdt,t0.pmdsmodid,t0.pmdsmoddt,t0.pmdscnfid,t0.pmdscnfdt,t0.pmdspstid, 
       t0.pmdspstdt,t1.ooefl003 ,t2.ooag011 ,t3.ooefl003 ,t4.pmaal004 ,t5.pmaal004 ,t6.pmaal004 ,t7.ooibl004 , 
       t8.oocql004 ,t9.ooail003 ,t10.ooag011 ,t11.ooefl003 ,t12.ooag011 ,t13.ooefl003 ,t14.ooag011 , 
       t15.ooag011 ,t16.ooag011",
               " FROM pmds_t t0",
                              " LEFT JOIN ooefl_t t1 ON t1.ooeflent="||g_enterprise||" AND t1.ooefl001=t0.pmdssite AND t1.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t2 ON t2.ooagent="||g_enterprise||" AND t2.ooag001=t0.pmds002  ",
               " LEFT JOIN ooefl_t t3 ON t3.ooeflent="||g_enterprise||" AND t3.ooefl001=t0.pmds003 AND t3.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t4 ON t4.pmaalent="||g_enterprise||" AND t4.pmaal001=t0.pmds007 AND t4.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t5 ON t5.pmaalent="||g_enterprise||" AND t5.pmaal001=t0.pmds008 AND t5.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t6 ON t6.pmaalent="||g_enterprise||" AND t6.pmaal001=t0.pmds009 AND t6.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN ooibl_t t7 ON t7.ooiblent="||g_enterprise||" AND t7.ooibl002=t0.pmds031 AND t7.ooibl003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t8 ON t8.oocqlent="||g_enterprise||" AND t8.oocql001='238' AND t8.oocql002=t0.pmds032 AND t8.oocql003='"||g_dlang||"' ",
               " LEFT JOIN ooail_t t9 ON t9.ooailent="||g_enterprise||" AND t9.ooail001=t0.pmds037 AND t9.ooail002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t10 ON t10.ooagent="||g_enterprise||" AND t10.ooag001=t0.pmdsownid  ",
               " LEFT JOIN ooefl_t t11 ON t11.ooeflent="||g_enterprise||" AND t11.ooefl001=t0.pmdsowndp AND t11.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t12 ON t12.ooagent="||g_enterprise||" AND t12.ooag001=t0.pmdscrtid  ",
               " LEFT JOIN ooefl_t t13 ON t13.ooeflent="||g_enterprise||" AND t13.ooefl001=t0.pmdscrtdp AND t13.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t14 ON t14.ooagent="||g_enterprise||" AND t14.ooag001=t0.pmdsmodid  ",
               " LEFT JOIN ooag_t t15 ON t15.ooagent="||g_enterprise||" AND t15.ooag001=t0.pmdscnfid  ",
               " LEFT JOIN ooag_t t16 ON t16.ooagent="||g_enterprise||" AND t16.ooag001=t0.pmdspstid  ",
 
               " WHERE t0.pmdsent = " ||g_enterprise|| " AND t0.pmdsdocno = ?"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define name="main.after_refresh_sql"
   
   #end add-point
   PREPARE apmt860_master_referesh FROM g_sql
 
    
 
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
                        
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_apmt860 WITH FORM cl_ap_formpath("apm",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL apmt860_init()   
 
      #進入選單 Menu (="N")
      CALL apmt860_ui_dialog() 
      
      #add-point:畫面關閉前 name="main.before_close"
                        
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_apmt860
      
   END IF 
   
   CLOSE apmt860_cl
   
   
 
   #add-point:作業離開前 name="main.exit"
   #刪除 維護多庫儲批所需的temp table
   CALL apmt860_03_drop_temp_table()
   CALL s_aooi500_drop_temp() RETURNING l_success   #150308-00001#3 150309 pomelo add
   #150427-00001#6 150529 By pmoelo add(S)
   IF g_argv[1] MATCHES '[3467]' THEN
      CALL s_lot_auto_drop_tmp(g_prog)
   END IF
   #150427-00001#6 150529 By pomelo add(E)
   #150601-00009#1 150601 By pomelo add(S)
   IF g_argv[1] MATCHES '[12347]' THEN      
      CALL s_aooi390_drop_tmp_table()
   END IF
   #150601-00009#1 150601 By pomelo add(E)
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
 
 
 
{</section>}
 
{<section id="apmt860.init" >}
#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION apmt860_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point    
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
   DEFINE l_gzze003       LIKE gzze_t.gzze003
   DEFINE l_sql           STRING
   DEFINE l_success       LIKE type_t.num5
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"
   
   #end add-point
   
   LET g_bfill       = "Y"
   LET g_detail_idx  = 1 #第一層單身指標
   LET g_detail_idx2 = 1 #第二層單身指標
   
   #各個page指標
   LET g_detail_idx_list[1] = 1 
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
   LET g_detail_idx_list[5] = 1
 
   LET g_error_show  = 1
   LET l_ac = 1 #單身指標
      CALL cl_set_combo_scc_part('pmdsstus','13','N,Y,S,A,D,R,W,X,Z')
 
      CALL cl_set_combo_scc('pmds011','2061') 
   CALL cl_set_combo_scc('pmds100','2062') 
   CALL cl_set_combo_scc('pmds202','6814') 
   CALL cl_set_combo_scc('pmds048','2087') 
   CALL cl_set_combo_scc('pmds049','2086') 
   CALL cl_set_combo_scc('pmds000','2060') 
   CALL cl_set_combo_scc('pmds014','2053') 
   CALL cl_set_combo_scc('pmdt005','2055') 
   CALL cl_set_combo_scc('pmdt025','2036') 
   CALL cl_set_combo_scc('pmdt052','2035') 
   CALL cl_set_combo_scc('pmdt214','6014') 
   CALL cl_set_combo_scc('pmdt209','6739') 
   CALL cl_set_combo_scc('pmdt210','6013') 
   CALL cl_set_combo_scc('pmdv005','2055') 
 
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #page群組
   LET g_idx_group = om.SaxAttributes.create()
   CALL g_idx_group.addAttribute("'1','4',","1")
   CALL g_idx_group.addAttribute("'2',","1")
   CALL g_idx_group.addAttribute("'3',","1")
   CALL g_idx_group.addAttribute("'5',","1")
   CALL g_idx_group.addAttribute("","1")
 
 
   #add-point:畫面資料初始化 name="init.init"
   CALL cl_set_combo_scc('pmdt0051','2055')
   CALL cl_set_combo_scc('pmdt0401','2039')
   CALL cl_set_combo_scc('pmdu013','5073')
   CALL cl_set_combo_scc('pmdv005','2055')
   CALL cl_set_combo_scc_part('pmdt214','6014','0,1,3') 
   
   IF g_argv[1] MATCHES '[125]'THEN
      CALL cl_set_combo_scc_part('pmdsstus','13','N,Y,A,D,R,W,X')
   ELSE
      CALL cl_set_combo_scc_part('pmdsstus','13','N,Y,S,A,D,R,W,X')
   END IF
   
   #單頭隱藏的欄位
   CALL apmt860_set_comp_visible('1','')

   #單身隱藏的欄位
   CALL apmt860_set_comp_visible_b('1')
   
   #隱藏toolbar下拉中的ACTION 菜單
   CALL apmt860_act_visible_init()
   
   #計算稅額所需的temp table
   CALL s_tax_recount_tmp()
   
   #維護多庫儲批所需的temp table
   CALL apmt860_03_create_temp_table() RETURNING l_success
   
   LET g_errshow = 1
   
   #準備需要的SQL
   #160816-00001#9  2016/08/17  By 08734 Mark 
 #  LET l_sql = "SELECT gzcb004 FROM gzcb_t",
 #              " WHERE gzcb001 = '24'",
 #              "   AND gzcb002 = '",g_prog,"'"
   LET l_sql =" s_fin_get_scc_value('24',g_prog,'2')"  #160816-00001#9  2016/08/17  By 08734 add
   PREPARE apmt860_get_gzcb004 FROM l_sql
   
   CALL s_aooi500_create_temp() RETURNING l_success   #150308-00001#3 150309 pomelo add
   
   #150427-00001#6 150529 By pmoelo add(S)
   IF g_argv[1] MATCHES '[3467]' THEN
      LET l_success = ''
      CALL s_lot_auto_create_tmp(g_prog) RETURNING l_success
   END IF
   #150427-00001#6 150529 By pomelo add(E)
   #150601-00009#1 150601 By pomelo add(S)
   IF g_argv[1] MATCHES '[12347]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1] = '22'
      LET l_success = ''
      CALL s_aooi390_cre_tmp_table() RETURNING l_success
      #160310-00007#1 160314 By pomelo add(S)
      #LET l_success = ''
      #CALL s_lot_no_batch_create_tmp() RETURNING l_success
      #160310-00007#1 160314 By pomelo add(E)
   END IF
   #150601-00009#1 150601 By pomelo add(E)
   #160314-00009#5 zhujing add 2016-3-17---(S)
   #判斷據點參數若不使用產品特徵時，則產品特徵需隱藏不可以維護(據點參數:S-BAS-0036)
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036') = 'N' THEN
      CALL cl_set_comp_visible("pmdt007,pmdt007_desc",FALSE)
   END IF
   #160314-00009#5 zhujing add 2016-3-17---(E)
   CALL s_aooi200_filter_slip('pmdsdocno') RETURNING g_slip_wc    #160510-00043#2
   #end add-point
   
   #初始化搜尋條件
   CALL apmt860_default_search()
    
END FUNCTION
 
{</section>}
 
{<section id="apmt860.ui_dialog" >}
#+ 功能選單
PRIVATE FUNCTION apmt860_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_idx     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE lb_first   BOOLEAN
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE la_output  DYNAMIC ARRAY OF STRING   #報表元件鬆耦合使用
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   DEFINE l_success LIKE type_t.num5
   DEFINE l_cnt     LIKE type_t.num5
   DEFINE l_pmdt001 LIKE pmdt_t.pmdt001
   DEFINE l_pmdt002 LIKE pmdt_t.pmdt002
   DEFINE l_pmdt020 LIKE pmdt_t.pmdt020
   DEFINE l_pmdt053 LIKE pmdt_t.pmdt053
   DEFINE l_pmdt202 LIKE pmdt_t.pmdt202
   DEFINE l_b_docno LIKE pmdt_t.pmdtdocno   #前單據單號
   DEFINE l_b_seq   LIKE pmdt_t.pmdtseq     #前單據項次
   DEFINE l_sql     STRING
   DEFINE l_indr000 LIKE indr_t.indr000   #160114-00001#1 160119 By sakura add
   #end add-point
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"
   
   #end add-point
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   #因應查詢方案進行處理
   IF g_default THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   ELSE
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF
   
   #action default動作
   #應用 a42 樣板自動產生(Version:3)
   #進入程式時預設執行的動作
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL apmt860_insert()
            #add-point:ON ACTION insert name="menu.default.insert"
                                                
            #END add-point
         END IF
 
      #add-point:action default自訂 name="ui_dialog.action_default"
                        
      #end add-point
      OTHERWISE
   END CASE
 
 
 
   
   LET lb_first = TRUE
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"
   LET l_sql = "SELECT pmdtsite,pmdtseq,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216,pmdt217,pmdt001, 
       pmdt002,pmdt003,pmdt004,pmdt005,pmdt200,pmdt006,pmdt007,pmdt025,pmdt201,pmdt202,pmdt019,pmdt020, 
       pmdt023,pmdt024,pmdt036,pmdt218,pmdt044,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt062, 
       pmdt016,pmdt017,pmdt018,pmdt063,pmdt052,pmdt051,pmdt059,pmdt203,pmdt204,pmdt205,pmdt214,pmdt215, 
       pmdt208,pmdt209,pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061, 
       pmdt084,pmdt219,pmdt089,pmdt088,pmdtseq FROM pmdt_t WHERE pmdtent=? AND pmdtdocno=? AND pmdtseq=? FOR UPDATE"
   LET l_sql = cl_sql_forupd(l_sql)
   LET l_sql = cl_sql_add_mask(l_sql)
   DECLARE apmt860_price CURSOR FROM l_sql
   
   CALL cl_set_comp_visible("page_6,page_7",FALSE)      #價格頁籤
   #end add-point
   
   WHILE TRUE 
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_pmds_m.* TO NULL
         CALL g_pmdt_d.clear()
         CALL g_pmdt2_d.clear()
         CALL g_pmdt3_d.clear()
         CALL g_pmdt4_d.clear()
         CALL g_pmdt5_d.clear()
 
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL apmt860_init()
      END IF
   
      CALL lib_cl_dlg.cl_dlg_before_display()
            
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
         #左側瀏覽頁簽
         DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)
            BEFORE ROW
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE
         
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF 
               
               CALL apmt860_fetch('') # reload data
               LET l_ac = 1
               CALL apmt860_ui_detailshow() #Setting the current row 
         
               CALL apmt860_idx_chk()
               #NEXT FIELD pmdtseq
         
               ON ACTION qbefield_user   #欄位隱藏設定 
                  LET g_action_choice="qbefield_user"
                  CALL cl_ui_qbefield_user()
         END DISPLAY
    
         DISPLAY ARRAY g_pmdt_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt860_idx_chk()
               #確定當下選擇的筆數
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[1] = l_ac
               CALL g_idx_group.addAttribute("'1','4',",l_ac)
               
               #add-point:page1, before row動作 name="ui_dialog.page1.before_row"
               #150416-00001#1 150724 by sakura add(S)
               CALL apmt860_set_act_visible_b()
               CALL apmt860_set_act_no_visible_b()
               #150416-00001#1 150724 by sakura add(E)                                                            
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1','4',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_current_page = 1
               #顯示單身筆數
               CALL apmt860_idx_chk()
               #add-point:page1自定義行為 name="ui_dialog.page1.before_display"
               IF cl_null(g_action_choice) OR NOT(g_action_choice = "query_price" OR g_action_choice = "upd_price") THEN
                  CALL cl_set_comp_visible("page_7,page_6",FALSE)   #價格/交易稅頁籤
               END IF
               #end add-point
               
            #自訂ACTION(detail_show,page_1)
            
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_detail_aapt110_01
            LET g_action_choice="query_detail_aapt110_01"
            IF cl_auth_chk_act("query_detail_aapt110_01") THEN
               
               #add-point:ON ACTION query_detail_aapt110_01 name="menu.detail_show.page1.query_detail_aapt110_01"
               #明細發票查詢
               IF (NOT cl_null(g_pmds_m.pmdsdocno)) AND NOT (g_pmds_m.pmdsstus = 'X') THEN
                  CALL aapt110_01(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmt860_02
            LET g_action_choice="open_apmt860_02"
            IF cl_auth_chk_act("open_apmt860_02") THEN
               
               #add-point:ON ACTION open_apmt860_02 name="menu.detail_show.page1.open_apmt860_02"
               IF (NOT cl_null(g_pmds_m.pmdsdocno)) AND (NOT cl_null(g_pmdt_d[l_ac].pmdtseq)) THEN
                  CALL apmt860_02(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
                  CALL apmt860_b_fill()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmt860_03
            LET g_action_choice="open_apmt860_03"
            IF cl_auth_chk_act("open_apmt860_03") THEN
               
               #add-point:ON ACTION open_apmt860_03 name="menu.detail_show.page1.open_apmt860_03"
               #1.單身是否有資料
               LET l_cnt = 0
               SELECT COUNT(pmdtseq) INTO l_cnt
                 FROM pmdt_t
                WHERE pmdtent = g_enterprise
                  AND pmdtdocno = g_pmds_m.pmdsdocno
               
               #2.單身有資料
               IF l_cnt >= 1 THEN
                  LET l_b_docno = ''
                  LET l_b_seq = ''
                  CALL apmt860_get_before_docno() RETURNING l_b_docno,l_b_seq
                  LET l_pmdt020 = 0
                  IF g_argv[1] MATCHES '[567]' THEN
                     LET l_pmdt001 = g_pmdt_d[l_ac].pmdt027
                     LET l_pmdt002 = g_pmdt_d[l_ac].pmdt028
                  ELSE
                     LET l_pmdt001 = g_pmdt_d[l_ac].pmdt001
                     LET l_pmdt002 = g_pmdt_d[l_ac].pmdt002
                  END IF
                  IF NOT cl_null(l_pmdt001) AND NOT cl_null(l_pmdt002) THEN
                     CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000,   g_pmdt_d[l_ac].pmdtsite,
                                                g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,
                                                l_pmdt001,               l_pmdt002,
                                                g_pmdt_d[l_ac].pmdt003,  g_pmdt_d[l_ac].pmdt004,
                                                g_pmdt_d[l_ac].pmdt006,  g_pmdt_d[l_ac].pmdt206,
                                                g_pmdt_d[l_ac].pmdt207,  0)
                        RETURNING l_success,l_pmdt020
                  END IF
                  IF g_argv[1] MATCHES '[24]' THEN
                     LET l_pmdt020 = g_pmdt_d[l_ac].pmdt020
                  END IF
                  CALL s_transaction_begin()
                  CALL apmt860_03(g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,    #單號、項次
                                  g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006,    #營運據點、商品編號
                                  g_pmdt_d[l_ac].pmdt007,  g_pmdt_d[l_ac].pmdt019,    #產品特徵、收貨/入庫單位
                                  g_pmdt_d[l_ac].pmdt020,  g_pmdt_d[l_ac].pmdt026,    #收貨/入庫數量、檢驗
                                  g_pmdt_d[l_ac].pmdt053,  g_pmdt_d[l_ac].pmdt201,    #允收數量、包裝單位
                                  g_pmdt_d[l_ac].pmdt202,  g_pmdt_d[l_ac].pmdt001,    #包裝數量、訂單單號
                                  g_pmdt_d[l_ac].pmdt002,  l_pmdt020,                 #訂單項次、可輸入的最大數量
                                  l_b_docno,               l_b_seq,                   #前單據單號、前單據項次
                                  g_pmdt_d[l_ac].pmdt214)                             #採購方式 #160304-00027#1 160307 By pomelo add
                     RETURNING l_success,l_pmdt020,l_pmdt053,l_pmdt202
                  IF l_success = FALSE THEN
                     CALL s_transaction_end('N','0')
                  ELSE
                     CALL apmt860_upd_detail(l_pmdt020,l_pmdt053,l_pmdt202)
                        RETURNING l_success
                     IF l_success THEN
                        CALL s_transaction_end('Y','0')
                     ELSE
                        CALL s_transaction_end('N','0')
                     END IF
                  END IF
                  CALL apmt860_b_fill()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION detail_qrystr
               MENU "" ATTRIBUTE(STYLE="popup")
                  #add-point:ON ACTION detail_qrystr相關動作 name="menu.detail_show.page1_sub.detail_qrystr"
                  #150416-00001#1 150818 by sakura add(S)
                  BEFORE MENU
                    IF g_detail_idx = 0 THEN
                       HIDE OPTION "prog_apmt840"
                       HIDE OPTION "prog_aint530"
                       EXIT MENU
                    ELSE
                       IF g_argv[1] = '7' THEN #退廠
                          IF cl_null(g_pmdt_d[g_detail_idx].pmdt216) THEN
                             HIDE OPTION "prog_aint530"
                          END IF
                          IF cl_null(g_pmdt_d[g_detail_idx].pmdt001) THEN
                             HIDE OPTION "prog_apmt840"
                          END IF
                          IF cl_null(g_pmdt_d[g_detail_idx].pmdt216) AND cl_null(g_pmdt_d[g_detail_idx].pmdt001) THEN
                             EXIT MENU
                          END IF
                       ELSE
                          HIDE OPTION "prog_aint530"
                          IF cl_null(g_pmdt_d[g_detail_idx].pmdt001) THEN
                             HIDE OPTION "prog_apmt840"
                             EXIT MENU
                          END IF                       
                       END IF
                    END IF                                         
                  #150416-00001#1 150818 by sakura add(E)
                  #END add-point
                                 #應用 a43 樣板自動產生(Version:4)
               ON ACTION prog_aint530
                  LET g_action_choice="prog_aint530"
                  IF cl_auth_chk_act("prog_aint530") THEN
                     
                     #add-point:ON ACTION prog_aint530 name="menu.detail_show.page1_sub.prog_aint530"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               INITIALIZE la_param.* TO NULL
               LET la_param.prog     = 'aint530'
               LET la_param.param[1] = g_pmdt_d[g_detail_idx].pmdt216

               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
 


                     #END add-point
                     
                  END IF
 
 
 
               #應用 a43 樣板自動產生(Version:4)
               ON ACTION prog_apmt840
                  LET g_action_choice="prog_apmt840"
                  IF cl_auth_chk_act("prog_apmt840") THEN
                     
                     #add-point:ON ACTION prog_apmt840 name="menu.detail_show.page1_sub.prog_apmt840"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               INITIALIZE la_param.* TO NULL
               LET la_param.prog     = 'apmt840'
               LET la_param.param[1] = g_pmdt_d[g_detail_idx].pmdt001

               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
 


                     #END add-point
                     
                  END IF
 
 
 
 
               END MENU
 
 
 
               #add-point:ON ACTION detail_qrystr name="menu.detail_show.page1.detail_qrystr"
               
               #END add-point
 
 
 
 
               
            #add-point:page1自定義行為 name="ui_dialog.page1.action"
                                                
            #end add-point
               
         END DISPLAY
        
         #第一階單身段落
         DISPLAY ARRAY g_pmdt2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt860_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[2] = l_ac
               CALL g_idx_group.addAttribute("'2',",l_ac)
               
               #add-point:page2, before row動作 name="ui_dialog.body2.before_row"
               IF cl_null(g_action_choice) OR NOT(g_action_choice = "query_price" OR g_action_choice = "upd_price") THEN
                  CALL cl_set_comp_visible("page_7,page_6",FALSE)   #價格/交易稅頁籤
               END IF
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_current_page = 2
               #顯示單身筆數
               CALL apmt860_idx_chk()
               #add-point:page2自定義行為 name="ui_dialog.body2.before_display"
                                                            
               #end add-point
      
            #自訂ACTION(detail_show,page_2)
            
         
            #add-point:page2自定義行為 name="ui_dialog.body2.action"
                                                
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdt3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt860_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[3] = l_ac
               CALL g_idx_group.addAttribute("'3',",l_ac)
               
               #add-point:page3, before row動作 name="ui_dialog.body3.before_row"
               #151125-00007#1(S)
               CALL apmt860_set_act_visible_b()
               CALL apmt860_set_act_no_visible_b()
               #151125-00007#1(E)
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 3
               #顯示單身筆數
               CALL apmt860_idx_chk()
               #add-point:page3自定義行為 name="ui_dialog.body3.before_display"
               IF cl_null(g_action_choice) OR NOT(g_action_choice = "query_price" OR g_action_choice = "upd_price") THEN
                  CALL cl_set_comp_visible("page_7,page_6",FALSE)   #價格/交易稅頁籤
               END IF
               #end add-point
      
            #自訂ACTION(detail_show,page_3)
            
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION detail_qrystr
               MENU "" ATTRIBUTE(STYLE="popup")
                  #add-point:ON ACTION detail_qrystr相關動作 name="menu.detail_show.page3_sub.detail_qrystr"
                  #151125-00007#1(S)
                  BEFORE MENU
                    IF g_detail_idx = 0 THEN
                       HIDE OPTION "prog_apmt830"
                       EXIT MENU
                    END IF
                  #151125-00007#1(E)                    
                  #END add-point
                                 #應用 a43 樣板自動產生(Version:4)
               ON ACTION prog_apmt830
                  LET g_action_choice="prog_apmt830"
                  IF cl_auth_chk_act("prog_apmt830") THEN
                     
                     #add-point:ON ACTION prog_apmt830 name="menu.detail_show.page3_sub.prog_apmt830"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               INITIALIZE la_param.* TO NULL
               LET la_param.prog = 'apmt830'
               LET la_param.param[1] = g_pmdt3_d[g_detail_idx].pmdv014
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
 


                     #END add-point
                     
                  END IF
 
 
 
 
               END MENU
 
 
 
               #add-point:ON ACTION detail_qrystr name="menu.detail_show.page3.detail_qrystr"
               
               #END add-point
 
 
 
 
         
            #add-point:page3自定義行為 name="ui_dialog.body3.action"
                                                
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdt4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt860_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[4] = l_ac
               CALL g_idx_group.addAttribute("'5',",l_ac)
               
               #add-point:page4, before row動作 name="ui_dialog.body4.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'5',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_current_page = 4
               #顯示單身筆數
               CALL apmt860_idx_chk()
               #add-point:page4自定義行為 name="ui_dialog.body4.before_display"
               IF cl_null(g_action_choice) OR NOT(g_action_choice = "query_price" OR g_action_choice = "upd_price") THEN
                  CALL cl_set_comp_visible("page_7,page_6",FALSE)   #價格/交易稅頁籤
               END IF
               #end add-point
      
            #自訂ACTION(detail_show,page_4)
            
         
            #add-point:page4自定義行為 name="ui_dialog.body4.action"
            
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_pmdt5_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL apmt860_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail5")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[5] = l_ac
               CALL g_idx_group.addAttribute("",l_ac)
               
               #add-point:page5, before row動作 name="ui_dialog.body5.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue(""))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail5")
               LET g_current_page = 5
               #顯示單身筆數
               CALL apmt860_idx_chk()
               #add-point:page5自定義行為 name="ui_dialog.body5.before_display"
               IF cl_null(g_action_choice) OR NOT(g_action_choice = "query_price" OR g_action_choice = "upd_price")THEN
                  CALL cl_set_comp_visible("page_7,page_6",FALSE)   #價格/交易稅頁籤
               END IF
               #end add-point
      
            #自訂ACTION(detail_show,page_5)
            
         
            #add-point:page5自定義行為 name="ui_dialog.body5.action"
            
            #end add-point
         
         END DISPLAY
 
         
 
         
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
                        
         #end add-point
         
         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
         SUBDIALOG lib_cl_dlg.cl_dlg_relateapps
      
         BEFORE DIALOG
            #先填充browser資料
            CALL apmt860_browser_fill("")
            CALL cl_notice()
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               LET g_current_idx = g_current_row
            END IF
            
            #確保g_current_idx位於正常區間內
            #小於,等於0則指到第1筆
            IF g_current_idx <= 0 THEN
               LET g_current_idx = 1
            END IF
            #超過最大筆數則指到最後1筆
            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF 
            
            LET g_current_sw = TRUE
            LET g_current_row = g_current_idx #目前指標
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL apmt860_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL apmt860_ui_detailshow() #Setting the current row 
            
            #筆數顯示
            LET g_current_page = 1
            CALL apmt860_idx_chk()
            CALL cl_ap_performance_cal()
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            #150608-00012#3 Add By Ken 150629(S)
            CALL apmt860_set_act_visible()
            CALL apmt860_set_act_no_visible()            
            #150608-00012#3 Add By Ken 150629(E)
            #end add-point
 
         #add-point:ui_dialog段more_action name="ui_dialog.more_action"
         
         #end add-point
 
         #狀態碼切換
         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL apmt860_statechange()
            #根據資料狀態切換action狀態
            CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
            CALL apmt860_set_act_visible()   
            CALL apmt860_set_act_no_visible()
            IF NOT (g_pmds_m.pmdsdocno IS NULL
 
              ) THEN
               #組合條件
               LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                                  " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
               #填到對應位置
               CALL apmt860_browser_fill("")
            END IF
         #應用 a32 樣板自動產生(Version:3)
         #簽核狀況
         ON ACTION bpm_status
            #查詢簽核狀況, 統一建立HyperLink
            CALL cl_bpm_status()
            #add-point:ON ACTION bpm_status name="menu.bpm_status"
            
            #END add-point
 
 
 
          
         #查詢方案選擇 
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
               INITIALIZE g_wc2_table4 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "pmds_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdt_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdu_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdv_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "xrcd_t" 
                        LET g_wc2_table4 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
                  OR NOT cl_null(g_wc2_table4)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
                  IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
 
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               CALL apmt860_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF
         
         #查詢方案選擇
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
               INITIALIZE g_wc2_table4 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "pmds_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdt_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "pmdu_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "pmdv_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "xrcd_t" 
                        LET g_wc2_table4 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
                  OR NOT cl_null(g_wc2_table4)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
                  IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL apmt860_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "" 
                     LET g_errparam.code = "-100" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL apmt860_fetch("F")
                  END IF
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()
          
         #應用 a49 樣板自動產生(Version:4)
            #過濾瀏覽頁資料
            ON ACTION filter
               LET g_action_choice = "fetch"
               #add-point:filter action name="ui_dialog.action.filter"
               
               #end add-point
               CALL apmt860_filter()
               EXIT DIALOG
 
 
 
         
         ON ACTION first
            LET g_action_choice = "fetch"
            CALL apmt860_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt860_idx_chk()
            
         ON ACTION previous
            LET g_action_choice = "fetch"
            CALL apmt860_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt860_idx_chk()
            
         ON ACTION jump
            LET g_action_choice = "fetch"
            CALL apmt860_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt860_idx_chk()
            
         ON ACTION next
            LET g_action_choice = "fetch"
            CALL apmt860_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt860_idx_chk()
            
         ON ACTION last
            LET g_action_choice = "fetch"
            CALL apmt860_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL apmt860_idx_chk()
          
         #excel匯出功能          
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               #browser
               CALL g_export_node.clear()
               IF g_main_hidden = 1 THEN
                  LET g_export_node[1] = base.typeInfo.create(g_browser)
                  LET g_export_id[1]   = "s_browse"
                  CALL cl_export_to_excel()
               #非browser
               ELSE
                  LET g_export_node[1] = base.typeInfo.create(g_pmdt_d)
                  LET g_export_id[1]   = "s_detail1"
                  LET g_export_node[2] = base.typeInfo.create(g_pmdt2_d)
                  LET g_export_id[2]   = "s_detail2"
                  LET g_export_node[3] = base.typeInfo.create(g_pmdt3_d)
                  LET g_export_id[3]   = "s_detail3"
                  LET g_export_node[4] = base.typeInfo.create(g_pmdt4_d)
                  LET g_export_id[4]   = "s_detail4"
                  LET g_export_node[5] = base.typeInfo.create(g_pmdt5_d)
                  LET g_export_id[5]   = "s_detail5"
 
                  #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
                  
                  #END add-point
                  CALL cl_export_to_excel_getpage()
                  CALL cl_export_to_excel()
               END IF
            END IF
        
         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
    
         #主頁摺疊
         ON ACTION mainhidden       
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
               CALL cl_notice()
            END IF
            
         #瀏覽頁折疊
         ON ACTION worksheethidden   
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF
            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD pmdtseq
            END IF
       
         #單頭摺疊，可利用hot key "Alt-s"開啟/關閉單頭
         ON ACTION controls     
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF
    
         
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_pmdw
            LET g_action_choice="gen_pmdw"
            IF cl_auth_chk_act("gen_pmdw") THEN
               
               #add-point:ON ACTION gen_pmdw name="menu.gen_pmdw"
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL apmt860_04(g_pmds_m.pmdsdocno)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL apmt860_modify()
               #add-point:ON ACTION modify name="menu.modify"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL apmt860_modify()
               #add-point:ON ACTION modify_detail name="menu.modify_detail"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_price
            LET g_action_choice="query_price"
            IF cl_auth_chk_act("query_price") THEN
               
               #add-point:ON ACTION query_price name="menu.query_price"
               CALL cl_set_comp_visible("page_7,page_6",TRUE)   #價格/交易稅頁籤
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION demo
            LET g_action_choice="demo"
            IF cl_auth_chk_act("demo") THEN
               
               #add-point:ON ACTION demo name="menu.demo"
               CALL aooi360_02('6',g_prog,g_pmds_m.pmdsdocno,'','','','','','','','','')
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_purchase
            LET g_action_choice="gen_purchase"
            IF cl_auth_chk_act("gen_purchase") THEN
               
               #add-point:ON ACTION gen_purchase name="menu.gen_purchase"
               CALL cl_err_collect_init()
               CALL apmt860_gen_po()
               CALL cl_err_collect_show()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION upd_pmds052
            LET g_action_choice="upd_pmds052"
            IF cl_auth_chk_act("upd_pmds052") THEN
               
               #add-point:ON ACTION upd_pmds052 name="menu.upd_pmds052"
               CALL apmt860_upd_pmds052()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION upd_pmds081
            LET g_action_choice="upd_pmds081"
            IF cl_auth_chk_act("upd_pmds081") THEN
               
               #add-point:ON ACTION upd_pmds081 name="menu.upd_pmds081"
               CALL apmt860_upd_pmds081()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL apmt860_delete()
               #add-point:ON ACTION delete name="menu.delete"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL apmt860_insert()
               #add-point:ON ACTION insert name="menu.insert"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_aapt110_01
            LET g_action_choice="query_aapt110_01"
            IF cl_auth_chk_act("query_aapt110_01") THEN
               
               #add-point:ON ACTION query_aapt110_01 name="menu.query_aapt110_01"
               #發票訊息查詢
               IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                  CALL aapt110_01(g_pmds_m.pmdsdocno,0)
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION open_apmt860_01
            LET g_action_choice="open_apmt860_01"
            IF cl_auth_chk_act("open_apmt860_01") THEN
               
               #add-point:ON ACTION open_apmt860_01 name="menu.open_apmt860_01"
               #產生收貨明細單身
               IF cl_null(g_pmds_m.pmds200) THEN
                  IF NOT cl_null(g_pmds_m.pmdsdocno) THEN
                     LET l_success = ''
                     CALL apmt860_01(g_pmds_m.pmdsdocno) RETURNING l_success
                     CALL apmt860_b_fill()
                  END IF
               ELSE
                  #是否根據單頭預約收貨單號自動產生單身？
                  IF cl_ask_confirm('apm-00744') THEN
                     CALL s_transaction_begin()
                     LET l_success = ''
                     IF apmt860_gen_detail2('2') THEN
                        CALL s_transaction_end('Y','0')
                     ELSE
                        CALL s_transaction_end('N','0')
                     END IF
                     CALL apmt860_b_fill()
                  END IF
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output name="menu.output"
               #CALL apmr520_g01("pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'",'Y','Y')
               LET g_rep_wc = "pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'"               
               #END add-point
               &include "erp/apm/apmt860_rep.4gl"
               #add-point:ON ACTION output.after name="menu.after_output"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION quickprint
            LET g_action_choice="quickprint"
            IF cl_auth_chk_act("quickprint") THEN
               
               #add-point:ON ACTION quickprint name="menu.quickprint"
               #CALL apmr520_g01("pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'",'Y','Y')
               LET g_rep_wc = "pmdsent ="|| g_enterprise ||" AND pmdsdocno ='"|| g_pmds_m.pmdsdocno||"'"               
               #END add-point
               &include "erp/apm/apmt860_rep.4gl"
               #add-point:ON ACTION quickprint.after name="menu.after_quickprint"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL apmt860_reproduce()
               #add-point:ON ACTION reproduce name="menu.reproduce"
                                                            
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION batch_price
            LET g_action_choice="batch_price"
            IF cl_auth_chk_act("batch_price") THEN
               
               #add-point:ON ACTION batch_price name="menu.batch_price"
               #150506-00032#10 150527 by sakura add---STR
               #批次重新取價
               IF cl_ask_confirm('apm-00925') THEN #是否執行批次重新取價
                  CALL cl_err_collect_init()
                  CALL s_transaction_begin()
                  IF s_apm_price_batch_price('1',g_pmds_m.pmdsdocno) THEN
                     CALL s_transaction_end('Y','1')
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
                  CALL cl_err_collect_show()
                  CALL apmt860_b_fill()
               END IF
               #150506-00032#10 150527 by sakura add---END  
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_apmt880_apmt870
            LET g_action_choice="gen_apmt880_apmt870"
            IF cl_auth_chk_act("gen_apmt880_apmt870") THEN
               
               #add-point:ON ACTION gen_apmt880_apmt870 name="menu.gen_apmt880_apmt870"
               CALL cl_err_collect_init()
               CALL apmt860_gen_apmt880_apmt870()
               CALL cl_err_collect_show()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL apmt860_query()
               #add-point:ON ACTION query name="menu.query"
                                                            
               #END add-point
               #應用 a59 樣板自動產生(Version:3)  
               CALL g_curr_diag.setCurrentRow("s_detail1",1)
               CALL g_curr_diag.setCurrentRow("s_detail2",1)
               CALL g_curr_diag.setCurrentRow("s_detail3",1)
               CALL g_curr_diag.setCurrentRow("s_detail4",1)
               CALL g_curr_diag.setCurrentRow("s_detail5",1)
 
 
 
 
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION gen_aint510
            LET g_action_choice="gen_aint510"
            IF cl_auth_chk_act("gen_aint510") THEN
               
               #add-point:ON ACTION gen_aint510 name="menu.gen_aint510"
               #160503-00033#1 Add By Ken 160506(S)
               IF NOT apmt860_aint510_chk(g_pmds_m.pmdsdocno) THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = 'apm-01109' 
                  LET g_errparam.popup  = TRUE 
                  LET g_errparam.replace[1] = g_pmds_m.pmdsdocno
                  CALL cl_err()                  
               ELSE
               #160503-00033#1 Add By Ken 160506(E)
                  CALL cl_err_collect_init()
                  CALL s_transaction_begin()
                  IF s_aint510_gen('2',g_pmds_m.pmdsdocno) THEN
                     CALL s_transaction_end('Y','0')
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
                  CALL cl_err_collect_show()
               END IF
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_apmt880
            LET g_action_choice="query_apmt880"
            IF cl_auth_chk_act("query_apmt880") THEN
               
               #add-point:ON ACTION query_apmt880 name="menu.query_apmt880"
               #查詢入庫單
               CALL apmt860_query_docno('6')
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query_apmt870
            LET g_action_choice="query_apmt870"
            IF cl_auth_chk_act("query_apmt870") THEN
               
               #add-point:ON ACTION query_apmt870 name="menu.query_apmt870"
               #查詢驗退單
               CALL apmt860_query_docno('5')
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION upd_price
            LET g_action_choice="upd_price"
            IF cl_auth_chk_act("upd_price") THEN
               
               #add-point:ON ACTION upd_price name="menu.upd_price"
               CALL cl_set_comp_visible("page_7,page_6",TRUE)   #價格/交易稅頁籤
               CALL apmt860_upd_price()
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_apmt859
            LET g_action_choice="prog_apmt859"
            IF cl_auth_chk_act("prog_apmt859") THEN
               
               #add-point:ON ACTION prog_apmt859 name="menu.prog_apmt859"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               INITIALIZE la_param.* TO NULL
               LET la_param.prog     = 'apmt859'
               LET la_param.param[1] = g_pmds_m.pmds200

               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
 


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_apmt840
            LET g_action_choice="prog_apmt840"
            IF cl_auth_chk_act("prog_apmt840") THEN
               
               #add-point:ON ACTION prog_apmt840 name="menu.prog_apmt840"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               INITIALIZE la_param.* TO NULL
               #150416-00001#1 150818 by sakura add(S)
               CASE
                 WHEN g_pmds_m.pmds000 = '5' 
                   OR g_pmds_m.pmds000 = '6'
                   OR g_pmds_m.pmds000 = '7'
                   LET la_param.prog = 'apmt860'
                 OTHERWISE
                   LET la_param.prog = 'apmt840'                   
               END CASE
               #150416-00001#1 150818 by sakura add(E)
               LET la_param.param[1] = g_pmds_m.pmds006

               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
 


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_pmds002
            LET g_action_choice="prog_pmds002"
            IF cl_auth_chk_act("prog_pmds002") THEN
               
               #add-point:ON ACTION prog_pmds002 name="menu.prog_pmds002"
               #+ 此段落由子樣板a45產生
               CALL cl_user_contact("aooi130", "ooag_t", "ooag002", "ooag001",g_pmds_m.pmds002)


               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION prog_aint801
            LET g_action_choice="prog_aint801"
            IF cl_auth_chk_act("prog_aint801") THEN
               
               #add-point:ON ACTION prog_aint801 name="menu.prog_aint801"
               #應用 a41 樣板自動產生(Version:2)
               #使用JSON格式組合參數與作業編號(串查)
               INITIALIZE la_param.* TO NULL
               #160114-00001#1 160119 By sakura(S)
               CASE g_argv[1]
                 WHEN '7'   #採購退廠維護作業
                   #160509-00007#1 160510 by sakura add(S)
                   CASE g_pmds_m.pmds202
                     WHEN '2'
                       LET la_param.prog = 'aint530'
                     WHEN '3'
                       LET la_param.prog = 'artt460'
                     OTHERWISE
                       EXIT DIALOG
                   END CASE
                   #160509-00007#1 160510 by sakura add(E)
                 WHEN '18'  #虛擬入庫單
                   LET l_indr000 = ''
                   SELECT indr000 INTO l_indr000
                     FROM indr_t 
                    WHERE indrent = g_enterprise
                      AND indrdocno = g_pmds_m.pmds201
                   IF cl_null(l_indr000) THEN
                      LET l_cnt = 0
                      SELECT COUNT(prgadocno) INTO l_cnt
                        FROM prga_t
                       WHERE prgaent = g_enterprise
                         AND prgadocno = g_pmds_m.pmds201
                      IF l_cnt > 0 THEN
                         LET la_param.prog = 'aprt602'
                      ELSE
                         EXIT DIALOG
                      END IF
                   ELSE
                      CASE l_indr000
                        WHEN '1'
                          LET la_param.prog = 'aint801' 
                        WHEN '2'
                          LET la_param.prog = 'aint802'
                        OTHERWISE
                          EXIT DIALOG
                      END CASE
                   END IF
               END CASE
               #160114-00001#1 160119 By sakura(E)
               LET la_param.param[1] = g_pmds_m.pmds201
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun_wait(ls_js)
 


               #END add-point
               
            END IF
 
 
 
 
         
         #應用 a46 樣板自動產生(Version:3)
         #新增相關文件
         ON ACTION related_document
            CALL apmt860_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"
               
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL apmt860_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"
            
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL apmt860_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"
            
            #END add-point
            CALL cl_user_overview_follow(g_pmds_m.pmdsdocdt)
 
 
 
         
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
    
         #交談指令共用ACTION
         &include "common_action.4gl" 
            CONTINUE DIALOG
      END DIALOG
 
      #(ver:79) ---add start---
      #add-point:ui_dialog段 after dialog name="ui_dialog.exit_dialog"
      
      #end add-point
      #(ver:79) --- add end ---
    
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         EXIT WHILE
      END IF
    
   END WHILE    
      
   CALL cl_set_act_visible("accept,cancel", TRUE)
    
END FUNCTION
 
{</section>}
 
{<section id="apmt860.browser_fill" >}
#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION apmt860_browser_fill(ps_page_action)
   #add-point:browser_fill段define(客製用) name="browser_fill.define_customerization"
   
   #end add-point  
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   #add-point:browser_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="browser_fill.define"
            
   #end add-point    
   
   #add-point:Function前置處理 name="browser_fill.before_browser_fill"
   
   #end add-point
   
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
 
   #add-point:browser_fill,foreach前 name="browser_fill.before_foreach"
   IF cl_null(g_wc) THEN
      LET g_wc = " pmdssite = '",g_site,"' "
   ELSE
      LET g_wc = g_wc," AND pmdssite = '",g_site,"' "
   END IF
   
   LET g_wc = g_wc," AND pmds000 = '", g_argv[1], "' "
   #160510-00043#2--(S)
   IF NOT cl_null(g_slip_wc) THEN
      LET g_wc = g_wc," AND ",g_slip_wc
   END IF   
   #160510-00043#2--(E)
   LET l_wc  = g_wc.trim()     
   #end add-point
   
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT DISTINCT pmdsdocno ",
                      " FROM pmds_t ",
                      " ",
                      " LEFT JOIN pmdt_t ON pmdtent = pmdsent AND pmdsdocno = pmdtdocno ", "  ",
                      #add-point:browser_fill段sql(pmdt_t1) name="browser_fill.cnt.join.}"
                      
                      #end add-point
                      " LEFT JOIN pmdu_t ON pmduent = pmdsent AND pmdsdocno = pmdudocno", "  ",
                      #add-point:browser_fill段sql(pmdu_t1) name="browser_fill.cnt.join.pmdu_t1"
                      
                      #end add-point
 
                      " LEFT JOIN pmdv_t ON pmdvent = pmdsent AND pmdsdocno = pmdvdocno", "  ",
                      #add-point:browser_fill段sql(pmdv_t1) name="browser_fill.cnt.join.pmdv_t1"
                      
                      #end add-point
 
                      " LEFT JOIN xrcd_t ON xrcdent = pmdsent AND pmdsdocno = xrcddocno", "  ",
                      #add-point:browser_fill段sql(xrcd_t1) name="browser_fill.cnt.join.xrcd_t1"
                      
                      #end add-point
 
 
 
                      " ", 
                      " ", 
                      " ",                      
 
                      " ",                      
 
                      " ",                      
 
 
 
                      " WHERE pmdsent = " ||g_enterprise|| " AND pmdtent = " ||g_enterprise|| " AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("pmds_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT DISTINCT pmdsdocno ",
                      " FROM pmds_t ", 
                      "  ",
                      "  ",
                      " WHERE pmdsent = " ||g_enterprise|| " AND ",l_wc CLIPPED, cl_sql_add_filter("pmds_t")
   END IF
   
   #add-point:browser_fill,cnt wc name="browser_fill.cnt_sqlwc"
   
   #end add-point
   
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   
   #add-point:browser_fill,count前 name="browser_fill.before_count"
            
   #end add-point
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE header_cnt_pre FROM g_sql
      EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
      FREE header_cnt_pre
   END IF
    
   IF g_browser_cnt > g_max_browse THEN
      IF g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_browser_cnt
         LET g_errparam.code = 9035 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
      END IF
      LET g_browser_cnt = g_max_browse
   END IF
   
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN
      #清除畫面
      CLEAR FORM                
      INITIALIZE g_pmds_m.* TO NULL
      CALL g_pmdt_d.clear()        
      CALL g_pmdt2_d.clear() 
      CALL g_pmdt3_d.clear() 
      CALL g_pmdt4_d.clear() 
      CALL g_pmdt5_d.clear() 
 
      #add-point:browser_fill g_add_browse段額外處理 name="browser_fill.add_browse.other"
      
      #end add-point   
      CALL g_browser.clear()
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1" 
      LET g_cnt = g_current_idx
   END IF
 
   #依照t0.pmdsdocno,t0.pmdsdocdt,t0.pmds002,t0.pmds003,t0.pmds007,t0.pmds008,t0.pmds009 Browser欄位定義(取代原本bs_sql功能)
   #考量到單身可能下條件, 所以此處需join單身所有table
   #DISTINCT是為了避免在join時出現重複的資料(如果不加DISTINCT則須在程式中過濾)
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.pmdsstus,t0.pmdsdocno,t0.pmdsdocdt,t0.pmds002,t0.pmds003,t0.pmds007, 
          t0.pmds008,t0.pmds009,t1.ooag011 ,t2.ooefl003 ,t3.pmaal004 ,t4.pmaal004 ,t5.pmaal004 ",
                  " FROM pmds_t t0",
                  "  ",
                  "  LEFT JOIN pmdt_t ON pmdtent = pmdsent AND pmdsdocno = pmdtdocno ", "  ", 
                  #add-point:browser_fill段sql(pmdt_t1) name="browser_fill.join.pmdt_t1"
                  
                  #end add-point
                  "  LEFT JOIN pmdu_t ON pmduent = pmdsent AND pmdsdocno = pmdudocno", "  ", 
                  #add-point:browser_fill段sql(pmdu_t1) name="browser_fill.join.pmdu_t1"
                  
                  #end add-point
 
                  "  LEFT JOIN pmdv_t ON pmdvent = pmdsent AND pmdsdocno = pmdvdocno", "  ", 
                  #add-point:browser_fill段sql(pmdv_t1) name="browser_fill.join.pmdv_t1"
                  
                  #end add-point
 
                  "  LEFT JOIN xrcd_t ON xrcdent = pmdsent AND pmdsdocno = xrcddocno", "  ", 
                  #add-point:browser_fill段sql(xrcd_t1) name="browser_fill.join.xrcd_t1"
                  
                  #end add-point
 
 
 
                  " ", 
                  " ",                      
 
                  " ",                      
 
                  " ",                      
 
 
 
                                 " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmds002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmds003 AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t3 ON t3.pmaalent="||g_enterprise||" AND t3.pmaal001=t0.pmds007 AND t3.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t4 ON t4.pmaalent="||g_enterprise||" AND t4.pmaal001=t0.pmds008 AND t4.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t5 ON t5.pmaalent="||g_enterprise||" AND t5.pmaal001=t0.pmds009 AND t5.pmaal002='"||g_dlang||"' ",
 
                  " WHERE t0.pmdsent = " ||g_enterprise|| " AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("pmds_t")
   ELSE
      #單身無輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.pmdsstus,t0.pmdsdocno,t0.pmdsdocdt,t0.pmds002,t0.pmds003,t0.pmds007, 
          t0.pmds008,t0.pmds009,t1.ooag011 ,t2.ooefl003 ,t3.pmaal004 ,t4.pmaal004 ,t5.pmaal004 ",
                  " FROM pmds_t t0",
                  "  ",
                                 " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.pmds002  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.pmds003 AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t3 ON t3.pmaalent="||g_enterprise||" AND t3.pmaal001=t0.pmds007 AND t3.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t4 ON t4.pmaalent="||g_enterprise||" AND t4.pmaal001=t0.pmds008 AND t4.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN pmaal_t t5 ON t5.pmaalent="||g_enterprise||" AND t5.pmaal001=t0.pmds009 AND t5.pmaal002='"||g_dlang||"' ",
 
                  " WHERE t0.pmdsent = " ||g_enterprise|| " AND ",l_wc, cl_sql_add_filter("pmds_t")
   END IF
   #add-point:browser_fill,sql wc name="browser_fill.fill_sqlwc"
   
   #end add-point
   LET g_sql = g_sql, " ORDER BY pmdsdocno ",g_order
 
   #add-point:browser_fill,before_prepare name="browser_fill.before_prepare"
            
   #end add-point
        
   #LET g_sql = cl_sql_add_tabid(g_sql,"pmds_t") #WC重組
   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE browse_pre FROM g_sql
      DECLARE browse_cur CURSOR FOR browse_pre
      
      #add-point:browser_fill段open cursor name="browser_fill.open"
            
      #end add-point
      
      FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_pmdsdocno,g_browser[g_cnt].b_pmdsdocdt, 
          g_browser[g_cnt].b_pmds002,g_browser[g_cnt].b_pmds003,g_browser[g_cnt].b_pmds007,g_browser[g_cnt].b_pmds008, 
          g_browser[g_cnt].b_pmds009,g_browser[g_cnt].b_pmds002_desc,g_browser[g_cnt].b_pmds003_desc, 
          g_browser[g_cnt].b_pmds007_desc,g_browser[g_cnt].b_pmds008_desc,g_browser[g_cnt].b_pmds009_desc 
 
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "Foreach:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         #add-point:browser_fill段reference name="browser_fill.reference"
                        
         #end add-point
      
         #遮罩相關處理
         CALL apmt860_browser_mask()
      
               #應用 a24 樣板自動產生(Version:3)
      #browser顯示圖片
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         WHEN "S"
            LET g_browser[g_cnt].b_statepic = "stus/16/posted.png"
         WHEN "A"
            LET g_browser[g_cnt].b_statepic = "stus/16/approved.png"
         WHEN "D"
            LET g_browser[g_cnt].b_statepic = "stus/16/withdraw.png"
         WHEN "R"
            LET g_browser[g_cnt].b_statepic = "stus/16/rejection.png"
         WHEN "W"
            LET g_browser[g_cnt].b_statepic = "stus/16/signing.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/invalid.png"
         WHEN "Z"
            LET g_browser[g_cnt].b_statepic = "stus/16/unposted.png"
         
      END CASE
 
 
 
         LET g_cnt = g_cnt + 1
         IF g_cnt > g_max_browse THEN
            EXIT FOREACH
         END IF
         
      END FOREACH
      FREE browse_pre
   END IF
   
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   
   IF cl_null(g_browser[g_cnt].b_pmdsdocno) THEN
      CALL g_browser.deleteElement(g_cnt)
   END IF
   
   LET g_header_cnt  = g_browser.getLength()
   LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
 
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
 
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
                  
   
   #add-point:browser_fill段結束前 name="browser_fill.after"
            
   #end add-point   
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.ui_headershow" >}
#+ 單頭資料重新顯示
PRIVATE FUNCTION apmt860_ui_headershow()
   #add-point:ui_headershow段define(客製用) name="ui_headershow.define_customerization"
   
   #end add-point  
   #add-point:ui_headershow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_headershow.define"
            
   #end add-point      
   
   #add-point:Function前置處理  name="ui_headershow.pre_function"
   
   #end add-point
   
   LET g_pmds_m.pmdsdocno = g_browser[g_current_idx].b_pmdsdocno   
 
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
       g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
       g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
       g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
       g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc 
 
   
   CALL apmt860_pmds_t_mask()
   CALL apmt860_show()
      
END FUNCTION
 
{</section>}
 
{<section id="apmt860.ui_detailshow" >}
#+ 單身資料重新顯示
PRIVATE FUNCTION apmt860_ui_detailshow()
   #add-point:ui_detailshow段define(客製用) name="ui_detailshow.define_customerization"
   
   #end add-point    
   #add-point:ui_detailshow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_detailshow.define"
            
   #end add-point    
 
   #add-point:Function前置處理 name="ui_detailshow.before"
            
   #end add-point    
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail3",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail4",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail5",g_detail_idx)
 
   END IF
   
   #add-point:ui_detailshow段after name="ui_detailshow.after"
            
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.ui_browser_refresh" >}
#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION apmt860_ui_browser_refresh()
   #add-point:ui_browser_refresh段define(客製用) name="ui_browser_refresh.define_customerization"
   
   #end add-point    
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_browser_refresh.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="ui_browser_refresh.pre_function"
   
   #end add-point
   
   LET g_browser_cnt = g_browser.getLength()
   LET g_header_cnt  = g_browser.getLength()
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_pmdsdocno = g_pmds_m.pmdsdocno 
 
         THEN
         CALL g_browser.deleteElement(l_i)
         EXIT FOR
      END IF
   END FOR
   LET g_browser_cnt = g_browser_cnt - 1
   LET g_header_cnt = g_header_cnt - 1
    
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
      CLEAR FORM
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
   
   #add-point:ui_browser_refresh段after name="ui_browser_refresh.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.construct" >}
#+ QBE資料查詢
PRIVATE FUNCTION apmt860_construct()
   #add-point:cs段define(客製用) name="cs.define_customerization"
   
   #end add-point    
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   DEFINE la_wc       DYNAMIC ARRAY OF RECORD
          tableid     STRING,
          wc          STRING
          END RECORD
   DEFINE li_idx      LIKE type_t.num10
   #add-point:cs段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="cs.define"
   DEFINE  l_acc                 LIKE gzcb_t.gzcb004
   #end add-point    
   
   #add-point:Function前置處理  name="cs.pre_function"
   
   #end add-point
    
   #清除畫面
   CLEAR FORM                
   INITIALIZE g_pmds_m.* TO NULL
   CALL g_pmdt_d.clear()        
   CALL g_pmdt2_d.clear() 
   CALL g_pmdt3_d.clear() 
   CALL g_pmdt4_d.clear() 
   CALL g_pmdt5_d.clear() 
 
   
   LET g_action_choice = ""
    
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc2_table2 TO NULL
 
   INITIALIZE g_wc2_table3 TO NULL
 
   INITIALIZE g_wc2_table4 TO NULL
 
 
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段開始前 name="cs.before_construct"
            
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON pmdssite,pmdsdocdt,pmds001,pmdsdocno,pmds200,pmds006,pmds011,pmds002, 
          pmds003,pmdsstus,pmds007,pmds008,pmds009,pmds010,pmds052,pmds100,pmds081,pmds045,pmds202,pmds201, 
          pmds021,pmds022,pmds023,pmds024,pmds048,pmds049,pmds031,pmds032,pmds037,pmds038,pmds033,pmds034, 
          pmds035,pmds101,pmds102,pmds000,pmds014,pmds043,pmds044,pmds046,pmdsownid,pmdsowndp,pmdscrtid, 
          pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt,pmdspstid,pmdspstdt
 
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.head.before_construct"
                                                
            #end add-point 
            
         #公用欄位開窗相關處理
         #應用 a11 樣板自動產生(Version:3)
         #共用欄位查詢處理  
         ##----<<pmdscrtdt>>----
         AFTER FIELD pmdscrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
         #----<<pmdsmoddt>>----
         AFTER FIELD pmdsmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmdscnfdt>>----
         AFTER FIELD pmdscnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<pmdspstdt>>----
         AFTER FIELD pmdspstdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
 
 
            
         #一般欄位開窗相關處理    
                  #Ctrlp:construct.c.pmdssite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdssite
            #add-point:ON ACTION controlp INFIELD pmdssite name="construct.c.pmdssite"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   #LET g_qryparam.arg1 = s_aooi500_q_where(g_prog,'pmdssite',g_site,'c') #150308-00001#3 150309 pomelo add 'c'  151207-00021#1 160105 By pomelo mark
			   LET g_qryparam.where = s_aooi500_q_where(g_prog,'pmdssite',g_site,'c') #151207-00021#1 160105 By pomelo add
            CALL q_ooef001_24()
            DISPLAY g_qryparam.return1 TO pmdssite
            NEXT FIELD pmdssite
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdssite
            #add-point:BEFORE FIELD pmdssite name="construct.b.pmdssite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdssite
            
            #add-point:AFTER FIELD pmdssite name="construct.a.pmdssite"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocdt
            #add-point:BEFORE FIELD pmdsdocdt name="construct.b.pmdsdocdt"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocdt
            
            #add-point:AFTER FIELD pmdsdocdt name="construct.a.pmdsdocdt"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocdt
            #add-point:ON ACTION controlp INFIELD pmdsdocdt name="construct.c.pmdsdocdt"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds001
            #add-point:BEFORE FIELD pmds001 name="construct.b.pmds001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds001
            
            #add-point:AFTER FIELD pmds001 name="construct.a.pmds001"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds001
            #add-point:ON ACTION controlp INFIELD pmds001 name="construct.c.pmds001"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdsdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocno
            #add-point:ON ACTION controlp INFIELD pmdsdocno name="construct.c.pmdsdocno"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_argv[1]          #單據類型
			   #160510-00043#2--(S)
            IF NOT cl_null(g_slip_wc) THEN
               LET g_qryparam.where = g_slip_wc
            END IF   
            #160510-00043#2--(E)
            CALL q_pmdsdocno()                       #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsdocno  #顯示到畫面上
            NEXT FIELD pmdsdocno                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocno
            #add-point:BEFORE FIELD pmdsdocno name="construct.b.pmdsdocno"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocno
            
            #add-point:AFTER FIELD pmdsdocno name="construct.a.pmdsdocno"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds200
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds200
            #add-point:ON ACTION controlp INFIELD pmds200 name="construct.c.pmds200"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = '1'
            CALL q_pmeldocno_1()                   #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds200  #顯示到畫面上
            NEXT FIELD pmds200                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds200
            #add-point:BEFORE FIELD pmds200 name="construct.b.pmds200"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds200
            
            #add-point:AFTER FIELD pmds200 name="construct.a.pmds200"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds006
            #add-point:ON ACTION controlp INFIELD pmds006 name="construct.c.pmds006"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   #採購收貨時開窗開採購單號
			   IF g_argv[1] MATCHES '[13]' THEN
			      LET g_qryparam.where = " pmdl005 = '1' AND pmdl006 = '1'"    
               CALL q_pmdldocno_1()
            END IF
            #驗退、入庫時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()
            END IF
            DISPLAY g_qryparam.return1 TO pmds006  #顯示到畫面上
            NEXT FIELD pmds006                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds006
            #add-point:BEFORE FIELD pmds006 name="construct.b.pmds006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds006
            
            #add-point:AFTER FIELD pmds006 name="construct.a.pmds006"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds011
            #add-point:BEFORE FIELD pmds011 name="construct.b.pmds011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds011
            
            #add-point:AFTER FIELD pmds011 name="construct.a.pmds011"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds011
            #add-point:ON ACTION controlp INFIELD pmds011 name="construct.c.pmds011"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds002
            #add-point:ON ACTION controlp INFIELD pmds002 name="construct.c.pmds002"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                       #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds002  #顯示到畫面上
            NEXT FIELD pmds002                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds002
            #add-point:BEFORE FIELD pmds002 name="construct.b.pmds002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds002
            
            #add-point:AFTER FIELD pmds002 name="construct.a.pmds002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds003
            #add-point:ON ACTION controlp INFIELD pmds003 name="construct.c.pmds003"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds003  #顯示到畫面上

            NEXT FIELD pmds003                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds003
            #add-point:BEFORE FIELD pmds003 name="construct.b.pmds003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds003
            
            #add-point:AFTER FIELD pmds003 name="construct.a.pmds003"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsstus
            #add-point:BEFORE FIELD pmdsstus name="construct.b.pmdsstus"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsstus
            
            #add-point:AFTER FIELD pmdsstus name="construct.a.pmdsstus"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsstus
            #add-point:ON ACTION controlp INFIELD pmdsstus name="construct.c.pmdsstus"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds007
            #add-point:ON ACTION controlp INFIELD pmds007 name="construct.c.pmds007"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmaa001_3()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds007  #顯示到畫面上

            NEXT FIELD pmds007                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds007
            #add-point:BEFORE FIELD pmds007 name="construct.b.pmds007"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds007
            
            #add-point:AFTER FIELD pmds007 name="construct.a.pmds007"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds008
            #add-point:ON ACTION controlp INFIELD pmds008 name="construct.c.pmds008"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " pmac003 = '1' "  #付款
            CALL q_pmac002_2()                            #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds008  #顯示到畫面上

            NEXT FIELD pmds008                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds008
            #add-point:BEFORE FIELD pmds008 name="construct.b.pmds008"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds008
            
            #add-point:AFTER FIELD pmds008 name="construct.a.pmds008"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds009
            #add-point:ON ACTION controlp INFIELD pmds009 name="construct.c.pmds009"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " pmac003 = '2' "  #
            CALL q_pmac002_2()                            #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds009  #顯示到畫面上

            NEXT FIELD pmds009                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds009
            #add-point:BEFORE FIELD pmds009 name="construct.b.pmds009"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds009
            
            #add-point:AFTER FIELD pmds009 name="construct.a.pmds009"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds010
            #add-point:BEFORE FIELD pmds010 name="construct.b.pmds010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds010
            
            #add-point:AFTER FIELD pmds010 name="construct.a.pmds010"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds010
            #add-point:ON ACTION controlp INFIELD pmds010 name="construct.c.pmds010"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds052
            #add-point:BEFORE FIELD pmds052 name="construct.b.pmds052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds052
            
            #add-point:AFTER FIELD pmds052 name="construct.a.pmds052"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds052
            #add-point:ON ACTION controlp INFIELD pmds052 name="construct.c.pmds052"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds100
            #add-point:BEFORE FIELD pmds100 name="construct.b.pmds100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds100
            
            #add-point:AFTER FIELD pmds100 name="construct.a.pmds100"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds100
            #add-point:ON ACTION controlp INFIELD pmds100 name="construct.c.pmds100"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds081
            #add-point:BEFORE FIELD pmds081 name="construct.b.pmds081"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds081
            
            #add-point:AFTER FIELD pmds081 name="construct.a.pmds081"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds081
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds081
            #add-point:ON ACTION controlp INFIELD pmds081 name="construct.c.pmds081"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds045
            #add-point:BEFORE FIELD pmds045 name="construct.b.pmds045"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds045
            
            #add-point:AFTER FIELD pmds045 name="construct.a.pmds045"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds045
            #add-point:ON ACTION controlp INFIELD pmds045 name="construct.c.pmds045"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds202
            #add-point:BEFORE FIELD pmds202 name="construct.b.pmds202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds202
            
            #add-point:AFTER FIELD pmds202 name="construct.a.pmds202"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds202
            #add-point:ON ACTION controlp INFIELD pmds202 name="construct.c.pmds202"
            
            #END add-point
 
 
         #Ctrlp:construct.c.pmds201
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds201
            #add-point:ON ACTION controlp INFIELD pmds201 name="construct.c.pmds201"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_indmdocno_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds201  #顯示到畫面上
            NEXT FIELD pmds201                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds201
            #add-point:BEFORE FIELD pmds201 name="construct.b.pmds201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds201
            
            #add-point:AFTER FIELD pmds201 name="construct.a.pmds201"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds021
            #add-point:BEFORE FIELD pmds021 name="construct.b.pmds021"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds021
            
            #add-point:AFTER FIELD pmds021 name="construct.a.pmds021"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds021
            #add-point:ON ACTION controlp INFIELD pmds021 name="construct.c.pmds021"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds022
            #add-point:BEFORE FIELD pmds022 name="construct.b.pmds022"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds022
            
            #add-point:AFTER FIELD pmds022 name="construct.a.pmds022"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds022
            #add-point:ON ACTION controlp INFIELD pmds022 name="construct.c.pmds022"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds023
            #add-point:BEFORE FIELD pmds023 name="construct.b.pmds023"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds023
            
            #add-point:AFTER FIELD pmds023 name="construct.a.pmds023"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds023
            #add-point:ON ACTION controlp INFIELD pmds023 name="construct.c.pmds023"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds024
            #add-point:BEFORE FIELD pmds024 name="construct.b.pmds024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds024
            
            #add-point:AFTER FIELD pmds024 name="construct.a.pmds024"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds024
            #add-point:ON ACTION controlp INFIELD pmds024 name="construct.c.pmds024"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds048
            #add-point:BEFORE FIELD pmds048 name="construct.b.pmds048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds048
            
            #add-point:AFTER FIELD pmds048 name="construct.a.pmds048"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds048
            #add-point:ON ACTION controlp INFIELD pmds048 name="construct.c.pmds048"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds049
            #add-point:BEFORE FIELD pmds049 name="construct.b.pmds049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds049
            
            #add-point:AFTER FIELD pmds049 name="construct.a.pmds049"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds049
            #add-point:ON ACTION controlp INFIELD pmds049 name="construct.c.pmds049"
            
            #END add-point
 
 
         #Ctrlp:construct.c.pmds031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds031
            #add-point:ON ACTION controlp INFIELD pmds031 name="construct.c.pmds031"
            #此段落由子樣板a08產生
            #開窗c段
		    	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
		    	LET g_qryparam.reqry = FALSE
            CALL q_pmad002_2()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds031  #顯示到畫面上
            NEXT FIELD pmds031                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds031
            #add-point:BEFORE FIELD pmds031 name="construct.b.pmds031"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds031
            
            #add-point:AFTER FIELD pmds031 name="construct.a.pmds031"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds032
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds032
            #add-point:ON ACTION controlp INFIELD pmds032 name="construct.c.pmds032"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = "238"
            CALL q_oocq002()                       #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds032  #顯示到畫面上
            NEXT FIELD pmds032                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds032
            #add-point:BEFORE FIELD pmds032 name="construct.b.pmds032"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds032
            
            #add-point:AFTER FIELD pmds032 name="construct.a.pmds032"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds037
            #add-point:ON ACTION controlp INFIELD pmds037 name="construct.c.pmds037"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
		   	LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_site
            CALL q_ooaj002_1()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds037  #顯示到畫面上
            NEXT FIELD pmds037                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds037
            #add-point:BEFORE FIELD pmds037 name="construct.b.pmds037"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds037
            
            #add-point:AFTER FIELD pmds037 name="construct.a.pmds037"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds038
            #add-point:BEFORE FIELD pmds038 name="construct.b.pmds038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds038
            
            #add-point:AFTER FIELD pmds038 name="construct.a.pmds038"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds038
            #add-point:ON ACTION controlp INFIELD pmds038 name="construct.c.pmds038"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmds033
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds033
            #add-point:ON ACTION controlp INFIELD pmds033 name="construct.c.pmds033"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_oodb002_2()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmds033  #顯示到畫面上
            NEXT FIELD pmds033                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds033
            #add-point:BEFORE FIELD pmds033 name="construct.b.pmds033"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds033
            
            #add-point:AFTER FIELD pmds033 name="construct.a.pmds033"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds034
            #add-point:BEFORE FIELD pmds034 name="construct.b.pmds034"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds034
            
            #add-point:AFTER FIELD pmds034 name="construct.a.pmds034"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds034
            #add-point:ON ACTION controlp INFIELD pmds034 name="construct.c.pmds034"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds035
            #add-point:BEFORE FIELD pmds035 name="construct.b.pmds035"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds035
            
            #add-point:AFTER FIELD pmds035 name="construct.a.pmds035"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds035
            #add-point:ON ACTION controlp INFIELD pmds035 name="construct.c.pmds035"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds101
            #add-point:BEFORE FIELD pmds101 name="construct.b.pmds101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds101
            
            #add-point:AFTER FIELD pmds101 name="construct.a.pmds101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds101
            #add-point:ON ACTION controlp INFIELD pmds101 name="construct.c.pmds101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds102
            #add-point:BEFORE FIELD pmds102 name="construct.b.pmds102"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds102
            
            #add-point:AFTER FIELD pmds102 name="construct.a.pmds102"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds102
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds102
            #add-point:ON ACTION controlp INFIELD pmds102 name="construct.c.pmds102"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds000
            #add-point:BEFORE FIELD pmds000 name="construct.b.pmds000"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds000
            
            #add-point:AFTER FIELD pmds000 name="construct.a.pmds000"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds000
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds000
            #add-point:ON ACTION controlp INFIELD pmds000 name="construct.c.pmds000"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds014
            #add-point:BEFORE FIELD pmds014 name="construct.b.pmds014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds014
            
            #add-point:AFTER FIELD pmds014 name="construct.a.pmds014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds014
            #add-point:ON ACTION controlp INFIELD pmds014 name="construct.c.pmds014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds043
            #add-point:BEFORE FIELD pmds043 name="construct.b.pmds043"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds043
            
            #add-point:AFTER FIELD pmds043 name="construct.a.pmds043"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds043
            #add-point:ON ACTION controlp INFIELD pmds043 name="construct.c.pmds043"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds044
            #add-point:BEFORE FIELD pmds044 name="construct.b.pmds044"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds044
            
            #add-point:AFTER FIELD pmds044 name="construct.a.pmds044"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds044
            #add-point:ON ACTION controlp INFIELD pmds044 name="construct.c.pmds044"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds046
            #add-point:BEFORE FIELD pmds046 name="construct.b.pmds046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds046
            
            #add-point:AFTER FIELD pmds046 name="construct.a.pmds046"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmds046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds046
            #add-point:ON ACTION controlp INFIELD pmds046 name="construct.c.pmds046"
            
            #END add-point
 
 
         #Ctrlp:construct.c.pmdsownid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsownid
            #add-point:ON ACTION controlp INFIELD pmdsownid name="construct.c.pmdsownid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsownid  #顯示到畫面上

            NEXT FIELD pmdsownid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsownid
            #add-point:BEFORE FIELD pmdsownid name="construct.b.pmdsownid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsownid
            
            #add-point:AFTER FIELD pmdsownid name="construct.a.pmdsownid"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdsowndp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsowndp
            #add-point:ON ACTION controlp INFIELD pmdsowndp name="construct.c.pmdsowndp"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsowndp  #顯示到畫面上

            NEXT FIELD pmdsowndp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsowndp
            #add-point:BEFORE FIELD pmdsowndp name="construct.b.pmdsowndp"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsowndp
            
            #add-point:AFTER FIELD pmdsowndp name="construct.a.pmdsowndp"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdscrtid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdscrtid
            #add-point:ON ACTION controlp INFIELD pmdscrtid name="construct.c.pmdscrtid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdscrtid  #顯示到畫面上

            NEXT FIELD pmdscrtid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscrtid
            #add-point:BEFORE FIELD pmdscrtid name="construct.b.pmdscrtid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdscrtid
            
            #add-point:AFTER FIELD pmdscrtid name="construct.a.pmdscrtid"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.pmdscrtdp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdscrtdp
            #add-point:ON ACTION controlp INFIELD pmdscrtdp name="construct.c.pmdscrtdp"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdscrtdp  #顯示到畫面上

            NEXT FIELD pmdscrtdp                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscrtdp
            #add-point:BEFORE FIELD pmdscrtdp name="construct.b.pmdscrtdp"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdscrtdp
            
            #add-point:AFTER FIELD pmdscrtdp name="construct.a.pmdscrtdp"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscrtdt
            #add-point:BEFORE FIELD pmdscrtdt name="construct.b.pmdscrtdt"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdsmodid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsmodid
            #add-point:ON ACTION controlp INFIELD pmdsmodid name="construct.c.pmdsmodid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdsmodid  #顯示到畫面上

            NEXT FIELD pmdsmodid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsmodid
            #add-point:BEFORE FIELD pmdsmodid name="construct.b.pmdsmodid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsmodid
            
            #add-point:AFTER FIELD pmdsmodid name="construct.a.pmdsmodid"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsmoddt
            #add-point:BEFORE FIELD pmdsmoddt name="construct.b.pmdsmoddt"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdscnfid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdscnfid
            #add-point:ON ACTION controlp INFIELD pmdscnfid name="construct.c.pmdscnfid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdscnfid  #顯示到畫面上

            NEXT FIELD pmdscnfid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscnfid
            #add-point:BEFORE FIELD pmdscnfid name="construct.b.pmdscnfid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdscnfid
            
            #add-point:AFTER FIELD pmdscnfid name="construct.a.pmdscnfid"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdscnfdt
            #add-point:BEFORE FIELD pmdscnfdt name="construct.b.pmdscnfdt"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.pmdspstid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdspstid
            #add-point:ON ACTION controlp INFIELD pmdspstid name="construct.c.pmdspstid"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdspstid  #顯示到畫面上

            NEXT FIELD pmdspstid                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdspstid
            #add-point:BEFORE FIELD pmdspstid name="construct.b.pmdspstid"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdspstid
            
            #add-point:AFTER FIELD pmdspstid name="construct.a.pmdspstid"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdspstdt
            #add-point:BEFORE FIELD pmdspstdt name="construct.b.pmdspstdt"
                                                
            #END add-point
 
 
 
         
      END CONSTRUCT
 
      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON pmdtsite,pmdtseq,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216,pmdt217,pmdt001, 
          pmdt002,pmdt003,pmdt004,pmdo001,pmdt221,pmdo002,pmdt005,pmdt200,pmdt006,pmdt220,pmdt007,pmdt025, 
          pmdt227,pmdt201,pmdt202,pmdt019,pmdt020,pmdt023,pmdt024,pmdt036,pmdt218,pmdt044,pmdt046,pmdt037, 
          pmdt038,pmdt039,pmdt047,pmdt026,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt052,pmdt051,pmdt059, 
          pmdt203,pmdt204,pmdt205,pmdt214,pmdt215,pmdt208,pmdt209,pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga, 
          pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt084,pmdt219,pmdt089,pmdt088
           FROM s_detail1[1].pmdtsite,s_detail1[1].pmdtseq,s_detail1[1].pmdt206,s_detail1[1].pmdt207, 
               s_detail1[1].pmdt027,s_detail1[1].pmdt028,s_detail1[1].pmdt216,s_detail1[1].pmdt217,s_detail1[1].pmdt001, 
               s_detail1[1].pmdt002,s_detail1[1].pmdt003,s_detail1[1].pmdt004,s_detail1[1].pmdo001,s_detail1[1].pmdt221, 
               s_detail1[1].pmdo002,s_detail1[1].pmdt005,s_detail1[1].pmdt200,s_detail1[1].pmdt006,s_detail1[1].pmdt220, 
               s_detail1[1].pmdt007,s_detail1[1].pmdt025,s_detail1[1].pmdt227,s_detail1[1].pmdt201,s_detail1[1].pmdt202, 
               s_detail1[1].pmdt019,s_detail1[1].pmdt020,s_detail1[1].pmdt023,s_detail1[1].pmdt024,s_detail1[1].pmdt036, 
               s_detail1[1].pmdt218,s_detail1[1].pmdt044,s_detail1[1].pmdt046,s_detail1[1].pmdt037,s_detail1[1].pmdt038, 
               s_detail1[1].pmdt039,s_detail1[1].pmdt047,s_detail1[1].pmdt026,s_detail1[1].pmdt062,s_detail1[1].pmdt016, 
               s_detail1[1].pmdt017,s_detail1[1].pmdt018,s_detail1[1].pmdt063,s_detail1[1].pmdt052,s_detail1[1].pmdt051, 
               s_detail1[1].pmdt059,s_detail1[1].pmdt203,s_detail1[1].pmdt204,s_detail1[1].pmdt205,s_detail1[1].pmdt214, 
               s_detail1[1].pmdt215,s_detail1[1].pmdt208,s_detail1[1].pmdt209,s_detail1[1].pmdt210,s_detail1[1].pmdt211, 
               s_detail1[1].pmdt212,s_detail1[1].pmdt213,s_detail1[1].pmdtorga,s_detail1[1].pmdt053, 
               s_detail1[1].pmdt054,s_detail1[1].pmdt055,s_detail1[1].pmdt060,s_detail1[1].pmdt061,s_detail1[1].pmdt084, 
               s_detail1[1].pmdt219,s_detail1[1].pmdt089,s_detail1[1].pmdt088
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body.before_construct"
                                                
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtsite
            #add-point:BEFORE FIELD pmdtsite name="construct.b.page1.pmdtsite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtsite
            
            #add-point:AFTER FIELD pmdtsite name="construct.a.page1.pmdtsite"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdtsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtsite
            #add-point:ON ACTION controlp INFIELD pmdtsite name="construct.c.page1.pmdtsite"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtseq
            #add-point:BEFORE FIELD pmdtseq name="construct.b.page1.pmdtseq"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtseq
            
            #add-point:AFTER FIELD pmdtseq name="construct.a.page1.pmdtseq"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdtseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtseq
            #add-point:ON ACTION controlp INFIELD pmdtseq name="construct.c.page1.pmdtseq"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt206
            #add-point:BEFORE FIELD pmdt206 name="construct.b.page1.pmdt206"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt206
            
            #add-point:AFTER FIELD pmdt206 name="construct.a.page1.pmdt206"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt206
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt206
            #add-point:ON ACTION controlp INFIELD pmdt206 name="construct.c.page1.pmdt206"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt207
            #add-point:BEFORE FIELD pmdt207 name="construct.b.page1.pmdt207"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt207
            
            #add-point:AFTER FIELD pmdt207 name="construct.a.page1.pmdt207"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt207
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt207
            #add-point:ON ACTION controlp INFIELD pmdt207 name="construct.c.page1.pmdt207"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt027
            #add-point:BEFORE FIELD pmdt027 name="construct.b.page1.pmdt027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt027
            
            #add-point:AFTER FIELD pmdt027 name="construct.a.page1.pmdt027"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt027
            #add-point:ON ACTION controlp INFIELD pmdt027 name="construct.c.page1.pmdt027"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			
            #驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            DISPLAY g_qryparam.return1 TO pmdt027  #顯示到畫面上
            NEXT FIELD pmdt027                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt028
            #add-point:BEFORE FIELD pmdt028 name="construct.b.page1.pmdt028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt028
            
            #add-point:AFTER FIELD pmdt028 name="construct.a.page1.pmdt028"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt028
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt028
            #add-point:ON ACTION controlp INFIELD pmdt028 name="construct.c.page1.pmdt028"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt216
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt216
            #add-point:ON ACTION controlp INFIELD pmdt216 name="construct.c.page1.pmdt216"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_indmdocno_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt216  #顯示到畫面上
            NEXT FIELD pmdt216                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt216
            #add-point:BEFORE FIELD pmdt216 name="construct.b.page1.pmdt216"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt216
            
            #add-point:AFTER FIELD pmdt216 name="construct.a.page1.pmdt216"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt217
            #add-point:BEFORE FIELD pmdt217 name="construct.b.page1.pmdt217"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt217
            
            #add-point:AFTER FIELD pmdt217 name="construct.a.page1.pmdt217"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt217
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt217
            #add-point:ON ACTION controlp INFIELD pmdt217 name="construct.c.page1.pmdt217"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt001
            #add-point:ON ACTION controlp INFIELD pmdt001 name="construct.c.page1.pmdt001"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.where = " pmdl005 = '1' AND pmdl006 = '1'"
            CALL q_pmdldocno_1()
            DISPLAY g_qryparam.return1 TO pmdt001
            NEXT FIELD pmdt001
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt001
            #add-point:BEFORE FIELD pmdt001 name="construct.b.page1.pmdt001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt001
            
            #add-point:AFTER FIELD pmdt001 name="construct.a.page1.pmdt001"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt002
            #add-point:BEFORE FIELD pmdt002 name="construct.b.page1.pmdt002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt002
            
            #add-point:AFTER FIELD pmdt002 name="construct.a.page1.pmdt002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt002
            #add-point:ON ACTION controlp INFIELD pmdt002 name="construct.c.page1.pmdt002"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt003
            #add-point:BEFORE FIELD pmdt003 name="construct.b.page1.pmdt003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt003
            
            #add-point:AFTER FIELD pmdt003 name="construct.a.page1.pmdt003"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt003
            #add-point:ON ACTION controlp INFIELD pmdt003 name="construct.c.page1.pmdt003"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt004
            #add-point:BEFORE FIELD pmdt004 name="construct.b.page1.pmdt004"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt004
            
            #add-point:AFTER FIELD pmdt004 name="construct.a.page1.pmdt004"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt004
            #add-point:ON ACTION controlp INFIELD pmdt004 name="construct.c.page1.pmdt004"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo001
            #add-point:BEFORE FIELD pmdo001 name="construct.b.page1.pmdo001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo001
            
            #add-point:AFTER FIELD pmdo001 name="construct.a.page1.pmdo001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdo001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo001
            #add-point:ON ACTION controlp INFIELD pmdo001 name="construct.c.page1.pmdo001"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt221
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt221
            #add-point:ON ACTION controlp INFIELD pmdt221 name="construct.c.page1.pmdt221"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_rtax001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt221  #顯示到畫面上
            NEXT FIELD pmdt221                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt221
            #add-point:BEFORE FIELD pmdt221 name="construct.b.page1.pmdt221"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt221
            
            #add-point:AFTER FIELD pmdt221 name="construct.a.page1.pmdt221"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo002
            #add-point:BEFORE FIELD pmdo002 name="construct.b.page1.pmdo002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo002
            
            #add-point:AFTER FIELD pmdo002 name="construct.a.page1.pmdo002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdo002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo002
            #add-point:ON ACTION controlp INFIELD pmdo002 name="construct.c.page1.pmdo002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt005
            #add-point:BEFORE FIELD pmdt005 name="construct.b.page1.pmdt005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt005
            
            #add-point:AFTER FIELD pmdt005 name="construct.a.page1.pmdt005"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt005
            #add-point:ON ACTION controlp INFIELD pmdt005 name="construct.c.page1.pmdt005"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt200
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt200
            #add-point:ON ACTION controlp INFIELD pmdt200 name="construct.c.page1.pmdt200"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_imay003_6()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt200  #顯示到畫面上
            NEXT FIELD pmdt200                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt200
            #add-point:BEFORE FIELD pmdt200 name="construct.b.page1.pmdt200"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt200
            
            #add-point:AFTER FIELD pmdt200 name="construct.a.page1.pmdt200"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt006
            #add-point:ON ACTION controlp INFIELD pmdt006 name="construct.c.page1.pmdt006"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = 'ALL'
            CALL q_imaf001_18()
            DISPLAY g_qryparam.return1 TO pmdt006
            NEXT FIELD pmdt006
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt006
            #add-point:BEFORE FIELD pmdt006 name="construct.b.page1.pmdt006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt006
            
            #add-point:AFTER FIELD pmdt006 name="construct.a.page1.pmdt006"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt220
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt220
            #add-point:ON ACTION controlp INFIELD pmdt220 name="construct.c.page1.pmdt220"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_rtax001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt220  #顯示到畫面上
            NEXT FIELD pmdt220                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt220
            #add-point:BEFORE FIELD pmdt220 name="construct.b.page1.pmdt220"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt220
            
            #add-point:AFTER FIELD pmdt220 name="construct.a.page1.pmdt220"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt007
            #add-point:BEFORE FIELD pmdt007 name="construct.b.page1.pmdt007"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt007
            
            #add-point:AFTER FIELD pmdt007 name="construct.a.page1.pmdt007"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt007
            #add-point:ON ACTION controlp INFIELD pmdt007 name="construct.c.page1.pmdt007"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt025
            #add-point:BEFORE FIELD pmdt025 name="construct.b.page1.pmdt025"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt025
            
            #add-point:AFTER FIELD pmdt025 name="construct.a.page1.pmdt025"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt025
            #add-point:ON ACTION controlp INFIELD pmdt025 name="construct.c.page1.pmdt025"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt227
            #add-point:BEFORE FIELD pmdt227 name="construct.b.page1.pmdt227"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt227
            
            #add-point:AFTER FIELD pmdt227 name="construct.a.page1.pmdt227"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt227
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt227
            #add-point:ON ACTION controlp INFIELD pmdt227 name="construct.c.page1.pmdt227"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt201
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt201
            #add-point:ON ACTION controlp INFIELD pmdt201 name="construct.c.page1.pmdt201"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt201  #顯示到畫面上
            NEXT FIELD pmdt201                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt201
            #add-point:BEFORE FIELD pmdt201 name="construct.b.page1.pmdt201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt201
            
            #add-point:AFTER FIELD pmdt201 name="construct.a.page1.pmdt201"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt202
            #add-point:BEFORE FIELD pmdt202 name="construct.b.page1.pmdt202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt202
            
            #add-point:AFTER FIELD pmdt202 name="construct.a.page1.pmdt202"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt202
            #add-point:ON ACTION controlp INFIELD pmdt202 name="construct.c.page1.pmdt202"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt019
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt019
            #add-point:ON ACTION controlp INFIELD pmdt019 name="construct.c.page1.pmdt019"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt019  #顯示到畫面上

            NEXT FIELD pmdt019                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt019
            #add-point:BEFORE FIELD pmdt019 name="construct.b.page1.pmdt019"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt019
            
            #add-point:AFTER FIELD pmdt019 name="construct.a.page1.pmdt019"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt020
            #add-point:BEFORE FIELD pmdt020 name="construct.b.page1.pmdt020"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt020
            
            #add-point:AFTER FIELD pmdt020 name="construct.a.page1.pmdt020"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt020
            #add-point:ON ACTION controlp INFIELD pmdt020 name="construct.c.page1.pmdt020"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt023
            #add-point:ON ACTION controlp INFIELD pmdt023 name="construct.c.page1.pmdt023"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt023  #顯示到畫面上

            NEXT FIELD pmdt023                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt023
            #add-point:BEFORE FIELD pmdt023 name="construct.b.page1.pmdt023"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt023
            
            #add-point:AFTER FIELD pmdt023 name="construct.a.page1.pmdt023"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt024
            #add-point:BEFORE FIELD pmdt024 name="construct.b.page1.pmdt024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt024
            
            #add-point:AFTER FIELD pmdt024 name="construct.a.page1.pmdt024"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt024
            #add-point:ON ACTION controlp INFIELD pmdt024 name="construct.c.page1.pmdt024"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt036
            #add-point:BEFORE FIELD pmdt036 name="construct.b.page1.pmdt036"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt036
            
            #add-point:AFTER FIELD pmdt036 name="construct.a.page1.pmdt036"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt036
            #add-point:ON ACTION controlp INFIELD pmdt036 name="construct.c.page1.pmdt036"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt218
            #add-point:BEFORE FIELD pmdt218 name="construct.b.page1.pmdt218"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt218
            
            #add-point:AFTER FIELD pmdt218 name="construct.a.page1.pmdt218"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt218
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt218
            #add-point:ON ACTION controlp INFIELD pmdt218 name="construct.c.page1.pmdt218"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt044
            #add-point:BEFORE FIELD pmdt044 name="construct.b.page1.pmdt044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt044
            
            #add-point:AFTER FIELD pmdt044 name="construct.a.page1.pmdt044"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt044
            #add-point:ON ACTION controlp INFIELD pmdt044 name="construct.c.page1.pmdt044"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt046
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt046
            #add-point:ON ACTION controlp INFIELD pmdt046 name="construct.c.page1.pmdt046"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oodb002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt046  #顯示到畫面上

            NEXT FIELD pmdt046                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt046
            #add-point:BEFORE FIELD pmdt046 name="construct.b.page1.pmdt046"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt046
            
            #add-point:AFTER FIELD pmdt046 name="construct.a.page1.pmdt046"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt037
            #add-point:BEFORE FIELD pmdt037 name="construct.b.page1.pmdt037"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt037
            
            #add-point:AFTER FIELD pmdt037 name="construct.a.page1.pmdt037"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt037
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt037
            #add-point:ON ACTION controlp INFIELD pmdt037 name="construct.c.page1.pmdt037"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt038
            #add-point:BEFORE FIELD pmdt038 name="construct.b.page1.pmdt038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt038
            
            #add-point:AFTER FIELD pmdt038 name="construct.a.page1.pmdt038"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt038
            #add-point:ON ACTION controlp INFIELD pmdt038 name="construct.c.page1.pmdt038"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt039
            #add-point:BEFORE FIELD pmdt039 name="construct.b.page1.pmdt039"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt039
            
            #add-point:AFTER FIELD pmdt039 name="construct.a.page1.pmdt039"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt039
            #add-point:ON ACTION controlp INFIELD pmdt039 name="construct.c.page1.pmdt039"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt047
            #add-point:BEFORE FIELD pmdt047 name="construct.b.page1.pmdt047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt047
            
            #add-point:AFTER FIELD pmdt047 name="construct.a.page1.pmdt047"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt047
            #add-point:ON ACTION controlp INFIELD pmdt047 name="construct.c.page1.pmdt047"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt026
            #add-point:BEFORE FIELD pmdt026 name="construct.b.page1.pmdt026"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt026
            
            #add-point:AFTER FIELD pmdt026 name="construct.a.page1.pmdt026"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt026
            #add-point:ON ACTION controlp INFIELD pmdt026 name="construct.c.page1.pmdt026"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt062
            #add-point:BEFORE FIELD pmdt062 name="construct.b.page1.pmdt062"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt062
            
            #add-point:AFTER FIELD pmdt062 name="construct.a.page1.pmdt062"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt062
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt062
            #add-point:ON ACTION controlp INFIELD pmdt062 name="construct.c.page1.pmdt062"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt016
            #add-point:ON ACTION controlp INFIELD pmdt016 name="construct.c.page1.pmdt016"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inaa001_2()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt016  #顯示到畫面上
            NEXT FIELD pmdt016                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt016
            #add-point:BEFORE FIELD pmdt016 name="construct.b.page1.pmdt016"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt016
            
            #add-point:AFTER FIELD pmdt016 name="construct.a.page1.pmdt016"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt017
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt017
            #add-point:ON ACTION controlp INFIELD pmdt017 name="construct.c.page1.pmdt017"
                                                            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_inab002_3()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt017  #顯示到畫面上

            NEXT FIELD pmdt017                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt017
            #add-point:BEFORE FIELD pmdt017 name="construct.b.page1.pmdt017"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt017
            
            #add-point:AFTER FIELD pmdt017 name="construct.a.page1.pmdt017"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt018
            #add-point:BEFORE FIELD pmdt018 name="construct.b.page1.pmdt018"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt018
            
            #add-point:AFTER FIELD pmdt018 name="construct.a.page1.pmdt018"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt018
            #add-point:ON ACTION controlp INFIELD pmdt018 name="construct.c.page1.pmdt018"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt063
            #add-point:BEFORE FIELD pmdt063 name="construct.b.page1.pmdt063"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt063
            
            #add-point:AFTER FIELD pmdt063 name="construct.a.page1.pmdt063"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt063
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt063
            #add-point:ON ACTION controlp INFIELD pmdt063 name="construct.c.page1.pmdt063"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt052
            #add-point:BEFORE FIELD pmdt052 name="construct.b.page1.pmdt052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt052
            
            #add-point:AFTER FIELD pmdt052 name="construct.a.page1.pmdt052"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt052
            #add-point:ON ACTION controlp INFIELD pmdt052 name="construct.c.page1.pmdt052"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt051
            #add-point:ON ACTION controlp INFIELD pmdt051 name="construct.c.page1.pmdt051"
            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   
			   LET l_acc = ''
            EXECUTE apmt860_get_gzcb004 INTO l_acc
            
			   LET g_qryparam.arg1 = l_acc
            CALL q_oocq002()                       #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt051  #顯示到畫面上
            NEXT FIELD pmdt051                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt051
            #add-point:BEFORE FIELD pmdt051 name="construct.b.page1.pmdt051"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt051
            
            #add-point:AFTER FIELD pmdt051 name="construct.a.page1.pmdt051"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt059
            #add-point:BEFORE FIELD pmdt059 name="construct.b.page1.pmdt059"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt059
            
            #add-point:AFTER FIELD pmdt059 name="construct.a.page1.pmdt059"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt059
            #add-point:ON ACTION controlp INFIELD pmdt059 name="construct.c.page1.pmdt059"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt203
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt203
            #add-point:ON ACTION controlp INFIELD pmdt203 name="construct.c.page1.pmdt203"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = s_aooi500_q_where(g_prog,'pmdt203',g_site,'c')    #161006-00008#6 Add By Ken 161018
            CALL q_ooef001_24()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt203  #顯示到畫面上
            NEXT FIELD pmdt203                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt203
            #add-point:BEFORE FIELD pmdt203 name="construct.b.page1.pmdt203"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt203
            
            #add-point:AFTER FIELD pmdt203 name="construct.a.page1.pmdt203"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt204
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt204
            #add-point:ON ACTION controlp INFIELD pmdt204 name="construct.c.page1.pmdt204"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = s_aooi500_q_where(g_prog,'pmdt204',g_site,'c')    #161006-00008#6 Add By Ken 161018
            CALL q_ooef001_24()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt204  #顯示到畫面上
            NEXT FIELD pmdt204                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt204
            #add-point:BEFORE FIELD pmdt204 name="construct.b.page1.pmdt204"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt204
            
            #add-point:AFTER FIELD pmdt204 name="construct.a.page1.pmdt204"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt205
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt205
            #add-point:ON ACTION controlp INFIELD pmdt205 name="construct.c.page1.pmdt205"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = s_aooi500_q_where(g_prog,'pmdt205',g_site,'c')    #161006-00008#6 Add By Ken 161018
            CALL q_ooef001_24()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt205  #顯示到畫面上
            NEXT FIELD pmdt205                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt205
            #add-point:BEFORE FIELD pmdt205 name="construct.b.page1.pmdt205"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt205
            
            #add-point:AFTER FIELD pmdt205 name="construct.a.page1.pmdt205"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt214
            #add-point:BEFORE FIELD pmdt214 name="construct.b.page1.pmdt214"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt214
            
            #add-point:AFTER FIELD pmdt214 name="construct.a.page1.pmdt214"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt214
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt214
            #add-point:ON ACTION controlp INFIELD pmdt214 name="construct.c.page1.pmdt214"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt215
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt215
            #add-point:ON ACTION controlp INFIELD pmdt215 name="construct.c.page1.pmdt215"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            IF s_aooi500_setpoint(g_prog,'pmdt215') THEN
               LET g_qryparam.where = s_aooi500_q_where(g_prog,'pmdt215',g_site,'c')
               CALL q_ooef001_24()
            ELSE
               LET g_qryparam.where = " ooef211 = 'Y'"
               CALL q_ooef001()
            END IF
            DISPLAY g_qryparam.return1 TO pmdt215  #顯示到畫面上
            NEXT FIELD pmdt215                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt215
            #add-point:BEFORE FIELD pmdt215 name="construct.b.page1.pmdt215"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt215
            
            #add-point:AFTER FIELD pmdt215 name="construct.a.page1.pmdt215"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt208
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt208
            #add-point:ON ACTION controlp INFIELD pmdt208 name="construct.c.page1.pmdt208"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_oojd001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt208  #顯示到畫面上
            NEXT FIELD pmdt208                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt208
            #add-point:BEFORE FIELD pmdt208 name="construct.b.page1.pmdt208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt208
            
            #add-point:AFTER FIELD pmdt208 name="construct.a.page1.pmdt208"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt209
            #add-point:BEFORE FIELD pmdt209 name="construct.b.page1.pmdt209"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt209
            
            #add-point:AFTER FIELD pmdt209 name="construct.a.page1.pmdt209"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt209
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt209
            #add-point:ON ACTION controlp INFIELD pmdt209 name="construct.c.page1.pmdt209"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt210
            #add-point:BEFORE FIELD pmdt210 name="construct.b.page1.pmdt210"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt210
            
            #add-point:AFTER FIELD pmdt210 name="construct.a.page1.pmdt210"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt210
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt210
            #add-point:ON ACTION controlp INFIELD pmdt210 name="construct.c.page1.pmdt210"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt211
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt211
            #add-point:ON ACTION controlp INFIELD pmdt211 name="construct.c.page1.pmdt211"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_staa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt211  #顯示到畫面上
            NEXT FIELD pmdt211                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt211
            #add-point:BEFORE FIELD pmdt211 name="construct.b.page1.pmdt211"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt211
            
            #add-point:AFTER FIELD pmdt211 name="construct.a.page1.pmdt211"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt212
            #add-point:BEFORE FIELD pmdt212 name="construct.b.page1.pmdt212"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt212
            
            #add-point:AFTER FIELD pmdt212 name="construct.a.page1.pmdt212"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt212
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt212
            #add-point:ON ACTION controlp INFIELD pmdt212 name="construct.c.page1.pmdt212"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page1.pmdt213
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt213
            #add-point:ON ACTION controlp INFIELD pmdt213 name="construct.c.page1.pmdt213"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_star001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdt213  #顯示到畫面上
            NEXT FIELD pmdt213                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt213
            #add-point:BEFORE FIELD pmdt213 name="construct.b.page1.pmdt213"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt213
            
            #add-point:AFTER FIELD pmdt213 name="construct.a.page1.pmdt213"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdtorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtorga
            #add-point:ON ACTION controlp INFIELD pmdtorga name="construct.c.page1.pmdtorga"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdtorga  #顯示到畫面上
            NEXT FIELD pmdtorga                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtorga
            #add-point:BEFORE FIELD pmdtorga name="construct.b.page1.pmdtorga"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtorga
            
            #add-point:AFTER FIELD pmdtorga name="construct.a.page1.pmdtorga"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt053
            #add-point:BEFORE FIELD pmdt053 name="construct.b.page1.pmdt053"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt053
            
            #add-point:AFTER FIELD pmdt053 name="construct.a.page1.pmdt053"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt053
            #add-point:ON ACTION controlp INFIELD pmdt053 name="construct.c.page1.pmdt053"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt054
            #add-point:BEFORE FIELD pmdt054 name="construct.b.page1.pmdt054"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt054
            
            #add-point:AFTER FIELD pmdt054 name="construct.a.page1.pmdt054"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt054
            #add-point:ON ACTION controlp INFIELD pmdt054 name="construct.c.page1.pmdt054"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt055
            #add-point:BEFORE FIELD pmdt055 name="construct.b.page1.pmdt055"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt055
            
            #add-point:AFTER FIELD pmdt055 name="construct.a.page1.pmdt055"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt055
            #add-point:ON ACTION controlp INFIELD pmdt055 name="construct.c.page1.pmdt055"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt060
            #add-point:BEFORE FIELD pmdt060 name="construct.b.page1.pmdt060"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt060
            
            #add-point:AFTER FIELD pmdt060 name="construct.a.page1.pmdt060"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt060
            #add-point:ON ACTION controlp INFIELD pmdt060 name="construct.c.page1.pmdt060"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt061
            #add-point:BEFORE FIELD pmdt061 name="construct.b.page1.pmdt061"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt061
            
            #add-point:AFTER FIELD pmdt061 name="construct.a.page1.pmdt061"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt061
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt061
            #add-point:ON ACTION controlp INFIELD pmdt061 name="construct.c.page1.pmdt061"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt084
            #add-point:BEFORE FIELD pmdt084 name="construct.b.page1.pmdt084"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt084
            
            #add-point:AFTER FIELD pmdt084 name="construct.a.page1.pmdt084"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt084
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt084
            #add-point:ON ACTION controlp INFIELD pmdt084 name="construct.c.page1.pmdt084"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt219
            #add-point:BEFORE FIELD pmdt219 name="construct.b.page1.pmdt219"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt219
            
            #add-point:AFTER FIELD pmdt219 name="construct.a.page1.pmdt219"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt219
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt219
            #add-point:ON ACTION controlp INFIELD pmdt219 name="construct.c.page1.pmdt219"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt089
            #add-point:BEFORE FIELD pmdt089 name="construct.b.page1.pmdt089"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt089
            
            #add-point:AFTER FIELD pmdt089 name="construct.a.page1.pmdt089"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt089
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt089
            #add-point:ON ACTION controlp INFIELD pmdt089 name="construct.c.page1.pmdt089"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt088
            #add-point:BEFORE FIELD pmdt088 name="construct.b.page1.pmdt088"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt088
            
            #add-point:AFTER FIELD pmdt088 name="construct.a.page1.pmdt088"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.pmdt088
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt088
            #add-point:ON ACTION controlp INFIELD pmdt088 name="construct.c.page1.pmdt088"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
      
      CONSTRUCT g_wc2_table2 ON pmduseq,pmdu001,pmdu002,pmdu006,pmdu007,pmdu008,pmdu005,pmdu200,pmdu201, 
          pmdu009,pmdu010,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016
           FROM s_detail2[1].pmduseq,s_detail2[1].pmdu001,s_detail2[1].pmdu002,s_detail2[1].pmdu006, 
               s_detail2[1].pmdu007,s_detail2[1].pmdu008,s_detail2[1].pmdu005,s_detail2[1].pmdu200,s_detail2[1].pmdu201, 
               s_detail2[1].pmdu009,s_detail2[1].pmdu010,s_detail2[1].pmdu013,s_detail2[1].pmdu014,s_detail2[1].pmdu015, 
               s_detail2[1].pmdu202,s_detail2[1].pmdu017,s_detail2[1].pmdu016
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body2.before_construct"
 
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 2)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmduseq
            #add-point:BEFORE FIELD pmduseq name="construct.b.page2.pmduseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmduseq
            
            #add-point:AFTER FIELD pmduseq name="construct.a.page2.pmduseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmduseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmduseq
            #add-point:ON ACTION controlp INFIELD pmduseq name="construct.c.page2.pmduseq"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu001
            #add-point:ON ACTION controlp INFIELD pmdu001 name="construct.c.page2.pmdu001"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_imaf001_15()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu001  #顯示到畫面上

            NEXT FIELD pmdu001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu001
            #add-point:BEFORE FIELD pmdu001 name="construct.b.page2.pmdu001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu001
            
            #add-point:AFTER FIELD pmdu001 name="construct.a.page2.pmdu001"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu002
            #add-point:BEFORE FIELD pmdu002 name="construct.b.page2.pmdu002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu002
            
            #add-point:AFTER FIELD pmdu002 name="construct.a.page2.pmdu002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu002
            #add-point:ON ACTION controlp INFIELD pmdu002 name="construct.c.page2.pmdu002"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu006
            #add-point:ON ACTION controlp INFIELD pmdu006 name="construct.c.page2.pmdu006"
                                                            #此段落由子樣板a08產生
            #開窗c段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu006  #顯示到畫面上

            NEXT FIELD pmdu006                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu006
            #add-point:BEFORE FIELD pmdu006 name="construct.b.page2.pmdu006"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu006
            
            #add-point:AFTER FIELD pmdu006 name="construct.a.page2.pmdu006"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu007
            #add-point:ON ACTION controlp INFIELD pmdu007 name="construct.c.page2.pmdu007"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inab002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu007  #顯示到畫面上

            NEXT FIELD pmdu007                     #返回原欄位

                                    
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu007
            #add-point:BEFORE FIELD pmdu007 name="construct.b.page2.pmdu007"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu007
            
            #add-point:AFTER FIELD pmdu007 name="construct.a.page2.pmdu007"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu008
            #add-point:BEFORE FIELD pmdu008 name="construct.b.page2.pmdu008"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu008
            
            #add-point:AFTER FIELD pmdu008 name="construct.a.page2.pmdu008"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu008
            #add-point:ON ACTION controlp INFIELD pmdu008 name="construct.c.page2.pmdu008"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu005
            #add-point:BEFORE FIELD pmdu005 name="construct.b.page2.pmdu005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu005
            
            #add-point:AFTER FIELD pmdu005 name="construct.a.page2.pmdu005"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu005
            #add-point:ON ACTION controlp INFIELD pmdu005 name="construct.c.page2.pmdu005"
 
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu200
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu200
            #add-point:ON ACTION controlp INFIELD pmdu200 name="construct.c.page2.pmdu200"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu200  #顯示到畫面上
            NEXT FIELD pmdu200                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu200
            #add-point:BEFORE FIELD pmdu200 name="construct.b.page2.pmdu200"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu200
            
            #add-point:AFTER FIELD pmdu200 name="construct.a.page2.pmdu200"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu201
            #add-point:BEFORE FIELD pmdu201 name="construct.b.page2.pmdu201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu201
            
            #add-point:AFTER FIELD pmdu201 name="construct.a.page2.pmdu201"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu201
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu201
            #add-point:ON ACTION controlp INFIELD pmdu201 name="construct.c.page2.pmdu201"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.pmdu009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu009
            #add-point:ON ACTION controlp INFIELD pmdu009 name="construct.c.page2.pmdu009"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdu009  #顯示到畫面上

            NEXT FIELD pmdu009                     #返回原欄位

                                    
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu009
            #add-point:BEFORE FIELD pmdu009 name="construct.b.page2.pmdu009"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu009
            
            #add-point:AFTER FIELD pmdu009 name="construct.a.page2.pmdu009"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu010
            #add-point:BEFORE FIELD pmdu010 name="construct.b.page2.pmdu010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu010
            
            #add-point:AFTER FIELD pmdu010 name="construct.a.page2.pmdu010"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu010
            #add-point:ON ACTION controlp INFIELD pmdu010 name="construct.c.page2.pmdu010"
 
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu013
            #add-point:BEFORE FIELD pmdu013 name="construct.b.page2.pmdu013"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu013
            
            #add-point:AFTER FIELD pmdu013 name="construct.a.page2.pmdu013"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu013
            #add-point:ON ACTION controlp INFIELD pmdu013 name="construct.c.page2.pmdu013"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu014
            #add-point:BEFORE FIELD pmdu014 name="construct.b.page2.pmdu014"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu014
            
            #add-point:AFTER FIELD pmdu014 name="construct.a.page2.pmdu014"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu014
            #add-point:ON ACTION controlp INFIELD pmdu014 name="construct.c.page2.pmdu014"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu015
            #add-point:BEFORE FIELD pmdu015 name="construct.b.page2.pmdu015"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu015
            
            #add-point:AFTER FIELD pmdu015 name="construct.a.page2.pmdu015"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu015
            #add-point:ON ACTION controlp INFIELD pmdu015 name="construct.c.page2.pmdu015"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu202
            #add-point:BEFORE FIELD pmdu202 name="construct.b.page2.pmdu202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu202
            
            #add-point:AFTER FIELD pmdu202 name="construct.a.page2.pmdu202"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu202
            #add-point:ON ACTION controlp INFIELD pmdu202 name="construct.c.page2.pmdu202"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu017
            #add-point:BEFORE FIELD pmdu017 name="construct.b.page2.pmdu017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu017
            
            #add-point:AFTER FIELD pmdu017 name="construct.a.page2.pmdu017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu017
            #add-point:ON ACTION controlp INFIELD pmdu017 name="construct.c.page2.pmdu017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdu016
            #add-point:BEFORE FIELD pmdu016 name="construct.b.page2.pmdu016"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdu016
            
            #add-point:AFTER FIELD pmdu016 name="construct.a.page2.pmdu016"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.pmdu016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdu016
            #add-point:ON ACTION controlp INFIELD pmdu016 name="construct.c.page2.pmdu016"
                                                
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table3 ON pmdvseq,pmdvseq1,pmdv005,pmdv001,pmdv002,pmdv014,pmdv015,pmdv016,pmdv017, 
          pmdv200,pmdv201,pmdv018,pmdv019
           FROM s_detail3[1].pmdvseq,s_detail3[1].pmdvseq1,s_detail3[1].pmdv005,s_detail3[1].pmdv001, 
               s_detail3[1].pmdv002,s_detail3[1].pmdv014,s_detail3[1].pmdv015,s_detail3[1].pmdv016,s_detail3[1].pmdv017, 
               s_detail3[1].pmdv200,s_detail3[1].pmdv201,s_detail3[1].pmdv018,s_detail3[1].pmdv019
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body3.before_construct"
 
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 3)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdvseq
            #add-point:BEFORE FIELD pmdvseq name="construct.b.page3.pmdvseq"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdvseq
            
            #add-point:AFTER FIELD pmdvseq name="construct.a.page3.pmdvseq"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdvseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdvseq
            #add-point:ON ACTION controlp INFIELD pmdvseq name="construct.c.page3.pmdvseq"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdvseq1
            #add-point:BEFORE FIELD pmdvseq1 name="construct.b.page3.pmdvseq1"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdvseq1
            
            #add-point:AFTER FIELD pmdvseq1 name="construct.a.page3.pmdvseq1"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdvseq1
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdvseq1
            #add-point:ON ACTION controlp INFIELD pmdvseq1 name="construct.c.page3.pmdvseq1"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv005
            #add-point:BEFORE FIELD pmdv005 name="construct.b.page3.pmdv005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv005
            
            #add-point:AFTER FIELD pmdv005 name="construct.a.page3.pmdv005"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv005
            #add-point:ON ACTION controlp INFIELD pmdv005 name="construct.c.page3.pmdv005"
                                                
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdv001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv001
            #add-point:ON ACTION controlp INFIELD pmdv001 name="construct.c.page3.pmdv001"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_imaf001_15()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdv001  #顯示到畫面上
            NEXT FIELD pmdv001                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv001
            #add-point:BEFORE FIELD pmdv001 name="construct.b.page3.pmdv001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv001
            
            #add-point:AFTER FIELD pmdv001 name="construct.a.page3.pmdv001"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv002
            #add-point:BEFORE FIELD pmdv002 name="construct.b.page3.pmdv002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv002
            
            #add-point:AFTER FIELD pmdv002 name="construct.a.page3.pmdv002"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv002
            #add-point:ON ACTION controlp INFIELD pmdv002 name="construct.c.page3.pmdv002"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv014
            #add-point:BEFORE FIELD pmdv014 name="construct.b.page3.pmdv014"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv014
            
            #add-point:AFTER FIELD pmdv014 name="construct.a.page3.pmdv014"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv014
            #add-point:ON ACTION controlp INFIELD pmdv014 name="construct.c.page3.pmdv014"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv015
            #add-point:BEFORE FIELD pmdv015 name="construct.b.page3.pmdv015"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv015
            
            #add-point:AFTER FIELD pmdv015 name="construct.a.page3.pmdv015"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv015
            #add-point:ON ACTION controlp INFIELD pmdv015 name="construct.c.page3.pmdv015"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv016
            #add-point:BEFORE FIELD pmdv016 name="construct.b.page3.pmdv016"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv016
            
            #add-point:AFTER FIELD pmdv016 name="construct.a.page3.pmdv016"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv016
            #add-point:ON ACTION controlp INFIELD pmdv016 name="construct.c.page3.pmdv016"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv017
            #add-point:BEFORE FIELD pmdv017 name="construct.b.page3.pmdv017"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv017
            
            #add-point:AFTER FIELD pmdv017 name="construct.a.page3.pmdv017"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv017
            #add-point:ON ACTION controlp INFIELD pmdv017 name="construct.c.page3.pmdv017"
                                                
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv200
            #add-point:BEFORE FIELD pmdv200 name="construct.b.page3.pmdv200"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv200
            
            #add-point:AFTER FIELD pmdv200 name="construct.a.page3.pmdv200"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv200
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv200
            #add-point:ON ACTION controlp INFIELD pmdv200 name="construct.c.page3.pmdv200"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv201
            #add-point:BEFORE FIELD pmdv201 name="construct.b.page3.pmdv201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv201
            
            #add-point:AFTER FIELD pmdv201 name="construct.a.page3.pmdv201"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv201
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv201
            #add-point:ON ACTION controlp INFIELD pmdv201 name="construct.c.page3.pmdv201"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page3.pmdv018
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv018
            #add-point:ON ACTION controlp INFIELD pmdv018 name="construct.c.page3.pmdv018"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO pmdv018  #顯示到畫面上
            NEXT FIELD pmdv018                     #返回原欄位


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv018
            #add-point:BEFORE FIELD pmdv018 name="construct.b.page3.pmdv018"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv018
            
            #add-point:AFTER FIELD pmdv018 name="construct.a.page3.pmdv018"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdv019
            #add-point:BEFORE FIELD pmdv019 name="construct.b.page3.pmdv019"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdv019
            
            #add-point:AFTER FIELD pmdv019 name="construct.a.page3.pmdv019"
                                                
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.pmdv019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdv019
            #add-point:ON ACTION controlp INFIELD pmdv019 name="construct.c.page3.pmdv019"
                                                
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table4 ON xrcdsite,xrcdld,xrcdseq,xrcd007,pmdt200_2,pmdt006_2,pmdt007_2,pmdt007_2_desc, 
          xrcd002,xrcd002_desc,xrcdseq2,xrcd003,xrcd006,xrcd004,xrcd104
           FROM s_detail5[1].xrcdsite,s_detail5[1].xrcdld,s_detail5[1].xrcdseq,s_detail5[1].xrcd007, 
               s_detail5[1].pmdt200_2,s_detail5[1].pmdt006_2,s_detail5[1].pmdt007_2,s_detail5[1].pmdt007_2_desc, 
               s_detail5[1].xrcd002,s_detail5[1].xrcd002_desc,s_detail5[1].xrcdseq2,s_detail5[1].xrcd003, 
               s_detail5[1].xrcd006,s_detail5[1].xrcd004,s_detail5[1].xrcd104
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body4.before_construct"
            
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 4)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdsite
            #add-point:BEFORE FIELD xrcdsite name="construct.b.page5.xrcdsite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdsite
            
            #add-point:AFTER FIELD xrcdsite name="construct.a.page5.xrcdsite"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcdsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdsite
            #add-point:ON ACTION controlp INFIELD xrcdsite name="construct.c.page5.xrcdsite"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdld
            #add-point:BEFORE FIELD xrcdld name="construct.b.page5.xrcdld"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdld
            
            #add-point:AFTER FIELD xrcdld name="construct.a.page5.xrcdld"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcdld
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdld
            #add-point:ON ACTION controlp INFIELD xrcdld name="construct.c.page5.xrcdld"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdseq
            #add-point:BEFORE FIELD xrcdseq name="construct.b.page5.xrcdseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdseq
            
            #add-point:AFTER FIELD xrcdseq name="construct.a.page5.xrcdseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcdseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdseq
            #add-point:ON ACTION controlp INFIELD xrcdseq name="construct.c.page5.xrcdseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd007
            #add-point:BEFORE FIELD xrcd007 name="construct.b.page5.xrcd007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd007
            
            #add-point:AFTER FIELD xrcd007 name="construct.a.page5.xrcd007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcd007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd007
            #add-point:ON ACTION controlp INFIELD xrcd007 name="construct.c.page5.xrcd007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt200_2
            #add-point:BEFORE FIELD pmdt200_2 name="construct.b.page5.pmdt200_2"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt200_2
            
            #add-point:AFTER FIELD pmdt200_2 name="construct.a.page5.pmdt200_2"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.pmdt200_2
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt200_2
            #add-point:ON ACTION controlp INFIELD pmdt200_2 name="construct.c.page5.pmdt200_2"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt006_2
            #add-point:BEFORE FIELD pmdt006_2 name="construct.b.page5.pmdt006_2"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt006_2
            
            #add-point:AFTER FIELD pmdt006_2 name="construct.a.page5.pmdt006_2"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.pmdt006_2
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt006_2
            #add-point:ON ACTION controlp INFIELD pmdt006_2 name="construct.c.page5.pmdt006_2"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt007_2
            #add-point:BEFORE FIELD pmdt007_2 name="construct.b.page5.pmdt007_2"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt007_2
            
            #add-point:AFTER FIELD pmdt007_2 name="construct.a.page5.pmdt007_2"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.pmdt007_2
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt007_2
            #add-point:ON ACTION controlp INFIELD pmdt007_2 name="construct.c.page5.pmdt007_2"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt007_2_desc
            #add-point:BEFORE FIELD pmdt007_2_desc name="construct.b.page5.pmdt007_2_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt007_2_desc
            
            #add-point:AFTER FIELD pmdt007_2_desc name="construct.a.page5.pmdt007_2_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.pmdt007_2_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt007_2_desc
            #add-point:ON ACTION controlp INFIELD pmdt007_2_desc name="construct.c.page5.pmdt007_2_desc"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page5.xrcd002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd002
            #add-point:ON ACTION controlp INFIELD xrcd002 name="construct.c.page5.xrcd002"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_oodb002_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xrcd002  #顯示到畫面上
            NEXT FIELD xrcd002                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd002
            #add-point:BEFORE FIELD xrcd002 name="construct.b.page5.xrcd002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd002
            
            #add-point:AFTER FIELD xrcd002 name="construct.a.page5.xrcd002"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd002_desc
            #add-point:BEFORE FIELD xrcd002_desc name="construct.b.page5.xrcd002_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd002_desc
            
            #add-point:AFTER FIELD xrcd002_desc name="construct.a.page5.xrcd002_desc"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcd002_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd002_desc
            #add-point:ON ACTION controlp INFIELD xrcd002_desc name="construct.c.page5.xrcd002_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcdseq2
            #add-point:BEFORE FIELD xrcdseq2 name="construct.b.page5.xrcdseq2"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcdseq2
            
            #add-point:AFTER FIELD xrcdseq2 name="construct.a.page5.xrcdseq2"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcdseq2
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcdseq2
            #add-point:ON ACTION controlp INFIELD xrcdseq2 name="construct.c.page5.xrcdseq2"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd003
            #add-point:BEFORE FIELD xrcd003 name="construct.b.page5.xrcd003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd003
            
            #add-point:AFTER FIELD xrcd003 name="construct.a.page5.xrcd003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcd003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd003
            #add-point:ON ACTION controlp INFIELD xrcd003 name="construct.c.page5.xrcd003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd006
            #add-point:BEFORE FIELD xrcd006 name="construct.b.page5.xrcd006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd006
            
            #add-point:AFTER FIELD xrcd006 name="construct.a.page5.xrcd006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcd006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd006
            #add-point:ON ACTION controlp INFIELD xrcd006 name="construct.c.page5.xrcd006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd004
            #add-point:BEFORE FIELD xrcd004 name="construct.b.page5.xrcd004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd004
            
            #add-point:AFTER FIELD xrcd004 name="construct.a.page5.xrcd004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcd004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd004
            #add-point:ON ACTION controlp INFIELD xrcd004 name="construct.c.page5.xrcd004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xrcd104
            #add-point:BEFORE FIELD xrcd104 name="construct.b.page5.xrcd104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xrcd104
            
            #add-point:AFTER FIELD xrcd104 name="construct.a.page5.xrcd104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page5.xrcd104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xrcd104
            #add-point:ON ACTION controlp INFIELD xrcd104 name="construct.c.page5.xrcd104"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
 
      
 
      
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令) name="cs.add_cs"
                        
      #end add-point
 
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段b_dialog name="cs.b_dialog"
         LET g_pmdt_d[1].pmdtseq = ""
         DISPLAY ARRAY g_pmdt_d TO s_detail1.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY  
         LET g_pmdt2_d[1].pmduseq1 = ""
         DISPLAY ARRAY g_pmdt2_d TO s_detail2.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY  
         LET g_pmdt3_d[1].pmdvseq1 = ""
         DISPLAY ARRAY g_pmdt3_d TO s_detail3.*
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY    
         
         #end add-point  
 
      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
         IF NOT cl_null(ls_wc) THEN
            CALL util.JSON.parse(ls_wc, la_wc)
            INITIALIZE g_wc, g_wc2, g_wc2_table1, g_wc2_extend TO NULL
            INITIALIZE g_wc2_table2 TO NULL
 
            INITIALIZE g_wc2_table3 TO NULL
 
            INITIALIZE g_wc2_table4 TO NULL
 
 
            FOR li_idx = 1 TO la_wc.getLength()
               CASE
                  WHEN la_wc[li_idx].tableid = "pmds_t" 
                     LET g_wc = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "pmdt_t" 
                     LET g_wc2_table1 = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "pmdu_t" 
                     LET g_wc2_table2 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "pmdv_t" 
                     LET g_wc2_table3 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "xrcd_t" 
                     LET g_wc2_table4 = la_wc[li_idx].wc
 
 
               END CASE
            END FOR
         END IF
    
      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   IF g_wc2_table2 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
   END IF
 
   IF g_wc2_table3 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
   END IF
 
   IF g_wc2_table4 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
   END IF
 
 
 
 
   
   #add-point:cs段結束前 name="cs.after_construct"
   CALL cl_set_comp_visible("page_7,page_6",FALSE)   #價格/交易稅頁籤
   #end add-point    
 
   IF INT_FLAG THEN
      RETURN
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.filter" >}
#應用 a50 樣板自動產生(Version:8)
#+ filter過濾功能
PRIVATE FUNCTION apmt860_filter()
   #add-point:filter段define name="filter.define_customerization"
   
   #end add-point   
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="filter.pre_function"
   
   #end add-point
   
   #切換畫面
   IF NOT g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF   
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter.trim()
   LET g_wc_t = g_wc
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter_t, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON pmdsdocno,pmdsdocdt,pmds002,pmds003,pmds007,pmds008,pmds009
                          FROM s_browse[1].b_pmdsdocno,s_browse[1].b_pmdsdocdt,s_browse[1].b_pmds002, 
                              s_browse[1].b_pmds003,s_browse[1].b_pmds007,s_browse[1].b_pmds008,s_browse[1].b_pmds009 
 
 
         BEFORE CONSTRUCT
               DISPLAY apmt860_filter_parser('pmdsdocno') TO s_browse[1].b_pmdsdocno
            DISPLAY apmt860_filter_parser('pmdsdocdt') TO s_browse[1].b_pmdsdocdt
            DISPLAY apmt860_filter_parser('pmds002') TO s_browse[1].b_pmds002
            DISPLAY apmt860_filter_parser('pmds003') TO s_browse[1].b_pmds003
            DISPLAY apmt860_filter_parser('pmds007') TO s_browse[1].b_pmds007
            DISPLAY apmt860_filter_parser('pmds008') TO s_browse[1].b_pmds008
            DISPLAY apmt860_filter_parser('pmds009') TO s_browse[1].b_pmds009
      
         #add-point:filter段cs_ctrl name="filter.cs_ctrl"
         
         #end add-point
      
      END CONSTRUCT
 
      #add-point:filter段add_cs name="filter.add_cs"
                        
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog name="filter.b_dialog"
                                    
         #end add-point  
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
      LET g_wc = g_wc , g_wc_filter
   ELSE
      LET g_wc_filter = g_wc_filter_t
      LET g_wc = g_wc_t
   END IF
 
      CALL apmt860_filter_show('pmdsdocno')
   CALL apmt860_filter_show('pmdsdocdt')
   CALL apmt860_filter_show('pmds002')
   CALL apmt860_filter_show('pmds003')
   CALL apmt860_filter_show('pmds007')
   CALL apmt860_filter_show('pmds008')
   CALL apmt860_filter_show('pmds009')
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.filter_parser" >}
#+ filter過濾功能
PRIVATE FUNCTION apmt860_filter_parser(ps_field)
   #add-point:filter段define name="filter_parser.define_customerization"
   
   #end add-point    
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter_parser.define"
            
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.filter_show" >}
#+ 顯示過濾條件
PRIVATE FUNCTION apmt860_filter_show(ps_field)
   DEFINE ps_field         STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.b_", ps_field
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = apmt860_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.query" >}
#+ 資料查詢QBE功能準備
PRIVATE FUNCTION apmt860_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point   
   DEFINE ls_wc STRING
   #add-point:query段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF   
   
   LET ls_wc = g_wc
   
   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()       
   CALL g_pmdt_d.clear()
   CALL g_pmdt2_d.clear()
   CALL g_pmdt3_d.clear()
   CALL g_pmdt4_d.clear()
   CALL g_pmdt5_d.clear()
 
   
   #add-point:query段other name="query.other"
            
   #end add-point   
   
   DISPLAY '' TO FORMONLY.idx
   DISPLAY '' TO FORMONLY.cnt
   DISPLAY '' TO FORMONLY.b_index
   DISPLAY '' TO FORMONLY.b_count
   DISPLAY '' TO FORMONLY.h_index
   DISPLAY '' TO FORMONLY.h_count
   
   CALL apmt860_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      #LET g_wc = ls_wc
      LET g_wc = " 1=2"
      CALL apmt860_browser_fill("")
      CALL apmt860_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化 
   LET g_detail_cnt  = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   LET g_detail_idx_list[1] = 1
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
   LET g_detail_idx_list[5] = 1
 
   LET g_error_show  = 1
   LET g_wc_filter   = ""
   LET l_ac = 1
   CALL FGL_SET_ARR_CURR(1)
      CALL apmt860_filter_show('pmdsdocno')
   CALL apmt860_filter_show('pmdsdocdt')
   CALL apmt860_filter_show('pmds002')
   CALL apmt860_filter_show('pmds003')
   CALL apmt860_filter_show('pmds007')
   CALL apmt860_filter_show('pmds008')
   CALL apmt860_filter_show('pmds009')
   CALL apmt860_browser_fill("F")
         
   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "-100" 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
   ELSE
      CALL apmt860_fetch("F") 
      #顯示單身筆數
      CALL apmt860_idx_chk()
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.fetch" >}
#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION apmt860_fetch(p_flag)
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point    
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fetch.define"
   DEFINE l_current_idx_t LIKE type_t.num10

   LET l_current_idx_t = g_current_idx
   #end add-point    
   
   #add-point:Function前置處理  name="fetch.pre_function"
   
   #end add-point
   
   IF g_browser_cnt = 0 THEN
      RETURN
   END IF
 
   #清空第二階單身
 
   
   CALL cl_ap_performance_next_start()
   CASE p_flag
      WHEN 'F' 
         LET g_current_idx = 1
      WHEN 'L'  
         LET g_current_idx = g_browser.getLength()              
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         LET g_no_ask = FALSE  
   END CASE 
 
   CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引
   
   LET g_current_row = g_current_idx
   LET g_detail_cnt = g_header_cnt                  
   
   #單身總筆數顯示
   IF g_detail_cnt > 0 THEN
      #若單身有資料時, idx至少為1
      IF g_detail_idx <= 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx  
   ELSE
      LET g_detail_idx = 0
      DISPLAY '' TO FORMONLY.idx    
   END IF
   
   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )
 
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #避免超出browser資料筆數上限
   IF g_current_idx > g_browser.getLength() THEN
      LET g_browser_idx = g_browser.getLength()
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_pmds_m.pmdsdocno = g_browser[g_current_idx].b_pmdsdocno
 
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
       g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
       g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
       g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
       g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc 
 
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt860_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt860_set_act_visible()   
   CALL apmt860_set_act_no_visible()
   
   #add-point:fetch段action控制 name="fetch.action_control"
   CALL apmt860_set_comp_visible('1','u')         #150818-00010#1 150818 By pomelo add
   CALL apmt860_set_comp_visible_b('2')
   IF g_pmds_m.pmdsstus NOT MATCHES "[NDR]" THEN   # N未確認/D抽單/R已拒絕允許修改
      CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)
   END IF
   #end add-point  
   
   
   
   #add-point:fetch結束前 name="fetch.after"
   IF g_current_idx <> l_current_idx_t THEN
      CALL cl_set_comp_visible("page_7,page_6",FALSE)      #價格頁籤
   END IF
   #end add-point
   
   #保存單頭舊值
   LET g_pmds_m_t.* = g_pmds_m.*
   LET g_pmds_m_o.* = g_pmds_m.*
   
   LET g_data_owner = g_pmds_m.pmdsownid      
   LET g_data_dept  = g_pmds_m.pmdsowndp
   
   #重新顯示   
   CALL apmt860_show()
 
   #應用 a56 樣板自動產生(Version:3)
   #檢查此單據是否需顯示BPM簽核狀況按鈕 
   IF cl_bpm_chk() THEN
      CALL cl_set_act_visible("bpm_status",TRUE)
   ELSE
      CALL cl_set_act_visible("bpm_status",FALSE)
   END IF
 
 
 
 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.insert" >}
#+ 資料新增
PRIVATE FUNCTION apmt860_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"
   
   #end add-point    
   #add-point:insert段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"
   DEFINE l_success  LIKE type_t.num5
   DEFINE l_doctype  LIKE rtai_t.rtai004
   #end add-point    
   
   #add-point:Function前置處理  name="insert.pre_function"
   
   #end add-point
   
   #清畫面欄位內容
   CLEAR FORM                    
   CALL g_pmdt_d.clear()   
   CALL g_pmdt2_d.clear()  
   CALL g_pmdt3_d.clear()  
   CALL g_pmdt4_d.clear()  
   CALL g_pmdt5_d.clear()  
 
 
   INITIALIZE g_pmds_m.* TO NULL             #DEFAULT 設定
   
   LET g_pmdsdocno_t = NULL
 
   
   LET g_master_insert = FALSE
   
   #add-point:insert段before name="insert.before"
   
   #end add-point    
   
   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_pmds_m.pmdsownid = g_user
      LET g_pmds_m.pmdsowndp = g_dept
      LET g_pmds_m.pmdscrtid = g_user
      LET g_pmds_m.pmdscrtdp = g_dept 
      LET g_pmds_m.pmdscrtdt = cl_get_current()
      LET g_pmds_m.pmdsmodid = g_user
      LET g_pmds_m.pmdsmoddt = cl_get_current()
      LET g_pmds_m.pmdsstus = 'N'
 
 
 
 
      #append欄位給值
      
     
      #一般欄位給值
            LET g_pmds_m.pmds011 = "1"
      LET g_pmds_m.pmds021 = "N"
      LET g_pmds_m.pmds048 = "1"
      LET g_pmds_m.pmds049 = "1"
      LET g_pmds_m.pmds014 = "1"
      LET g_pmds_m.pmds043 = "0"
      LET g_pmds_m.pmds044 = "0"
      LET g_pmds_m.pmds046 = "0"
 
  
      #add-point:單頭預設值 name="insert.default"
      #營運據點
      LET g_pmds_m.pmdssite = g_site
      CALL s_desc_get_department_desc(g_pmds_m.pmdssite)
         RETURNING g_pmds_m.pmdssite_desc
      DISPLAY BY NAME g_pmds_m.pmdssite_desc
      
      #單據日期
      LET g_pmds_m.pmdsdocdt = g_today
      
      #扣帳日期
      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN   #add by yangxf g_argv[1] = '22'
         LET g_pmds_m.pmds001 = g_today
      END IF
      
      #單別
      CALL s_arti200_get_def_doc_type(g_pmds_m.pmdssite,g_prog,'1')
         RETURNING l_success,l_doctype
      LET g_pmds_m.pmdsdocno = l_doctype
      
      #單據性質
      LET g_pmds_m.pmds000 = g_argv[1]
      
      #申請人員
      LET g_pmds_m.pmds002 = g_user
      CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
      DISPLAY BY NAME g_pmds_m.pmds002_desc
      
      #申請部門
      LET g_pmds_m.pmds003 = g_dept
      CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
      DISPLAY BY NAME g_pmds_m.pmds003_desc
      
      #倉退方式
      #當登入的程式為採購倉退單時，才給予預設值
      IF g_argv[1] = '7' THEN
         LET g_pmds_m.pmds100 = '1'
         LET g_pmds_m.pmds202 = '1'      #150505-00009#1 add by huangtao
      END IF
      
      LET g_pmds_m_t.*  = g_pmds_m.* 
      LET g_pmds_m_o.*  = g_pmds_m.* 
      #end add-point 
      
      #保存單頭舊值(用於資料輸入錯誤還原預設值時使用)
      LET g_pmds_m_t.* = g_pmds_m.*
      LET g_pmds_m_o.* = g_pmds_m.*
      
      #顯示狀態(stus)圖片
            #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmds_m.pmdsstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
 
 
 
    
      CALL apmt860_input("a")
      
      #add-point:單頭輸入後 name="insert.after_insert"
      
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
      END IF
      
      IF NOT g_master_insert THEN
         DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
         DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
         INITIALIZE g_pmds_m.* TO NULL
         INITIALIZE g_pmdt_d TO NULL
         INITIALIZE g_pmdt2_d TO NULL
         INITIALIZE g_pmdt3_d TO NULL
         INITIALIZE g_pmdt4_d TO NULL
         INITIALIZE g_pmdt5_d TO NULL
 
         #add-point:取消新增後 name="insert.cancel"
         
         #end add-point 
         CALL apmt860_show()
         RETURN
      END IF
      
      LET INT_FLAG = 0
      #CALL g_pmdt_d.clear()
      #CALL g_pmdt2_d.clear()
      #CALL g_pmdt3_d.clear()
      #CALL g_pmdt4_d.clear()
      #CALL g_pmdt5_d.clear()
 
 
      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE
        
   END WHILE
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt860_set_act_visible()   
   CALL apmt860_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                      " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
                      
   #add-point:組合新增資料的條件後 name="insert.after.add_browse"
   
   #end add-point
      
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL apmt860_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   CLOSE apmt860_cl
   
   CALL apmt860_idx_chk()
   
   #撈取異動後的資料(主要是帶出reference)
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
       g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
       g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
       g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
       g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc 
 
   
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt860_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdssite_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003, 
       g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052, 
       g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031, 
       g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds037,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046, 
       g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid, 
       g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid, 
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
   
   #add-point:新增結束後 name="insert.after"
   
   #end add-point 
   
   LET g_data_owner = g_pmds_m.pmdsownid      
   LET g_data_dept  = g_pmds_m.pmdsowndp
   
   #功能已完成,通報訊息中心
   CALL apmt860_msgcentre_notify('insert')
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.modify" >}
#+ 資料修改
PRIVATE FUNCTION apmt860_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"
   
   #end add-point    
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   DEFINE l_wc2_table1          STRING
   DEFINE l_wc2_table2   STRING
 
   DEFINE l_wc2_table3   STRING
 
   DEFINE l_wc2_table4   STRING
 
 
 
   #add-point:modify段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="modify.pre_function"
   
   #end add-point
   
   #保存單頭舊值
   LET g_pmds_m_t.* = g_pmds_m.*
   LET g_pmds_m_o.* = g_pmds_m.*
   
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   ERROR ""
  
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   CALL s_transaction_begin()
   
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt860_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
       g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
       g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
       g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
       g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc 
 
   
   #檢查是否允許此動作
   IF NOT apmt860_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt860_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   
   
   #add-point:modify段show之前 name="modify.before_show"
   
   #end add-point  
   
   #LET l_wc2_table1 = g_wc2_table1
   #LET g_wc2_table1 = " 1=1"
   #LET l_wc2_table2 = g_wc2_table2
   #LET l_wc2_table2 = " 1=1"
 
   #LET l_wc2_table3 = g_wc2_table3
   #LET l_wc2_table3 = " 1=1"
 
   #LET l_wc2_table4 = g_wc2_table4
   #LET l_wc2_table4 = " 1=1"
 
 
 
   
   CALL apmt860_show()
   #add-point:modify段show之後 name="modify.after_show"
   
   #end add-point
   
   #LET g_wc2_table1 = l_wc2_table1
   #LET  g_wc2_table2 = l_wc2_table2 
 
   #LET  g_wc2_table3 = l_wc2_table3 
 
   #LET  g_wc2_table4 = l_wc2_table4 
 
 
 
    
   WHILE TRUE
      LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
      
      #寫入修改者/修改日期資訊(單頭)
      LET g_pmds_m.pmdsmodid = g_user 
LET g_pmds_m.pmdsmoddt = cl_get_current()
LET g_pmds_m.pmdsmodid_desc = cl_get_username(g_pmds_m.pmdsmodid)
      
      #add-point:modify段修改前 name="modify.before_input"
      #「D抽單 / R已拒絕」狀況碼更改資料後，需還原為「N未確認」
      IF g_pmds_m.pmdsstus MATCHES "[DR]" THEN
         LET g_pmds_m.pmdsstus = "N"
      END IF                        
      #end add-point
      
      #欄位更改
      LET g_loc = 'n'
      LET g_update = FALSE
      LET g_master_commit = "N"
      CALL apmt860_input("u")
      LET g_loc = 'n'
 
      #add-point:modify段修改後 name="modify.after_input"
                        
      #end add-point
      
      IF g_update OR NOT INT_FLAG THEN
         #若有modid跟moddt則進行update
         UPDATE pmds_t SET (pmdsmodid,pmdsmoddt) = (g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt)
          WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmdsdocno_t
 
      END IF
    
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         #若單頭無commit則還原
         IF g_master_commit = "N" THEN
            LET g_pmds_m.* = g_pmds_m_t.*
            CALL apmt860_show()
         END IF
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code = 9001 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN
      END IF 
                  
      #若單頭key欄位有變更
      IF g_pmds_m.pmdsdocno != g_pmds_m_t.pmdsdocno
 
      THEN
         CALL s_transaction_begin()
         
         #add-point:單身fk修改前 name="modify.body.b_fk_update"
                                    
         #end add-point
         
         #更新單身key值
         UPDATE pmdt_t SET pmdtdocno = g_pmds_m.pmdsdocno
 
          WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m_t.pmdsdocno
 
            
         #add-point:單身fk修改中 name="modify.body.m_fk_update"
                                    
         #end add-point
 
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdt_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #add-point:單身fk修改後 name="modify.body.a_fk_update"
                                    
         #end add-point
         
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update2"
                                    
         #end add-point
         
         UPDATE pmdu_t
            SET pmdudocno = g_pmds_m.pmdsdocno
 
          WHERE pmduent = g_enterprise AND
                pmdudocno = g_pmdsdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update2"
                                    
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdu_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update2"
                                    
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update3"
                                    
         #end add-point
         
         UPDATE pmdv_t
            SET pmdvdocno = g_pmds_m.pmdsdocno
 
          WHERE pmdvent = g_enterprise AND
                pmdvdocno = g_pmdsdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update3"
                                    
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "pmdv_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update3"
                                    
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update4"
         
         #end add-point
         
         UPDATE xrcd_t
            SET xrcddocno = g_pmds_m.pmdsdocno
 
          WHERE xrcdent = g_enterprise AND
                xrcddocno = g_pmdsdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update4"
         
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "xrcd_t" 
            #   LET g_errparam.code = "std-00009" 
            #   LET g_errparam.popup = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.SQLCODE #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update4"
         
         #end add-point
 
 
         
 
         
         #UPDATE 多語言table key值
         
         
         
         
         
 
         CALL s_transaction_end('Y','0')
      END IF
    
      EXIT WHILE
   END WHILE
 
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt860_set_act_visible()   
   CALL apmt860_set_act_no_visible()
 
   #組合新增資料的條件
   LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                      " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
   #填到對應位置
   CALL apmt860_browser_fill("")
 
   CLOSE apmt860_cl
   
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL apmt860_msgcentre_notify('modify')
 
END FUNCTION 
 
{</section>}
 
{<section id="apmt860.input" >}
#+ 資料輸入
PRIVATE FUNCTION apmt860_input(p_cmd)
   #add-point:input段define(客製用) name="input.define_customerization"
   
   #end add-point  
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num10                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num10                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num10
   DEFINE  l_i                   LIKE type_t.num10
   DEFINE  l_ac_t                LIKE type_t.num10
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num10
   DEFINE  li_reproduce_target   LIKE type_t.num10
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   #add-point:input段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="input.define"
   DEFINE  l_where               STRING
   DEFINE  l_success             LIKE type_t.num5
   DEFINE  l_set_entry           LIKE type_t.num5
   DEFINE  l_pmdt020             LIKE pmdt_t.pmdt020
   DEFINE  l_gzsz008             LIKE gzsz_t.gzsz008
   DEFINE  l_acc                 LIKE gzcb_t.gzcb004
   DEFINE  l_b_docno             LIKE pmdt_t.pmdtdocno   #前單據單號
   DEFINE  l_b_seq               LIKE pmdt_t.pmdtseq     #前單據項次
   DEFINE  l_inaa007             LIKE inaa_t.inaa007     #庫位是否做儲位控管
   DEFINE  l_imaa005             LIKE imaa_t.imaa005
   DEFINE  l_imaf055             LIKE imaf_t.imaf055
   DEFINE  l_imaf061             LIKE imaf_t.imaf061
   DEFINE  l_sql                 STRING
   DEFINE  l_ooef004             LIKE ooef_t.ooef004
   DEFINE  l_ooef016             LIKE ooef_t.ooef016
   DEFINE  l_scc40               LIKE type_t.chr2
   DEFINE  l_auto_detail         LIKE type_t.chr1      #記錄進到單身是否已有詢問過自動產生單身
   DEFINE  l_pmdt089             LIKE pmdt_t.pmdt089
   DEFINE  l_pmdt219             LIKE pmdt_t.pmdt219   #160615-00028#3 Add By Ken 160623 製造日期
   DEFINE  l_pmdt                RECORD
           pmdtsite              LIKE pmdt_t.pmdtsite,
           pmdtseq               LIKE pmdt_t.pmdtseq,
           pmdt206               LIKE pmdt_t.pmdt206,
           pmdt207               LIKE pmdt_t.pmdt207,
           pmdt027               LIKE pmdt_t.pmdt027,
           pmdt028               LIKE pmdt_t.pmdt028,
           pmdt001               LIKE pmdt_t.pmdt001,
           pmdt002               LIKE pmdt_t.pmdt002,
           pmdt003               LIKE pmdt_t.pmdt003,
           pmdt004               LIKE pmdt_t.pmdt004,
           pmdt005               LIKE pmdt_t.pmdt005,
           pmdt200               LIKE pmdt_t.pmdt200,
           pmdt006               LIKE pmdt_t.pmdt006,
           pmdt007               LIKE pmdt_t.pmdt007,
           pmdt025               LIKE pmdt_t.pmdt025,
           pmdt201               LIKE pmdt_t.pmdt201,
           pmdt202               LIKE pmdt_t.pmdt202,
           pmdt019               LIKE pmdt_t.pmdt019,
           pmdt020               LIKE pmdt_t.pmdt020,
           pmdt023               LIKE pmdt_t.pmdt023,
           pmdt024               LIKE pmdt_t.pmdt024,
           pmdt036               LIKE pmdt_t.pmdt036,
           pmdt218               LIKE pmdt_t.pmdt218,
           pmdt044               LIKE pmdt_t.pmdt044,
           pmdt046               LIKE pmdt_t.pmdt046,
           pmdt037               LIKE pmdt_t.pmdt037,
           pmdt038               LIKE pmdt_t.pmdt038,
           pmdt039               LIKE pmdt_t.pmdt039,
           pmdt047               LIKE pmdt_t.pmdt047,
           pmdt026               LIKE pmdt_t.pmdt026,
           pmdt062               LIKE pmdt_t.pmdt062,
           pmdt016               LIKE pmdt_t.pmdt016,
           pmdt017               LIKE pmdt_t.pmdt017,
           pmdt018               LIKE pmdt_t.pmdt018,
           pmdt052               LIKE pmdt_t.pmdt052,
           pmdt051               LIKE pmdt_t.pmdt051,
           pmdt059               LIKE pmdt_t.pmdt059,
           pmdt063               LIKE pmdt_t.pmdt063,
           pmdt203               LIKE pmdt_t.pmdt203,
           pmdt204               LIKE pmdt_t.pmdt204,
           pmdt205               LIKE pmdt_t.pmdt205,
           pmdt208               LIKE pmdt_t.pmdt208,
           pmdt209               LIKE pmdt_t.pmdt209,
           pmdt210               LIKE pmdt_t.pmdt210,
           pmdt211               LIKE pmdt_t.pmdt211,
           pmdt212               LIKE pmdt_t.pmdt212,
           pmdt213               LIKE pmdt_t.pmdt213,
           pmdtorga              LIKE pmdt_t.pmdtorga,
           pmdt053               LIKE pmdt_t.pmdt053,
           pmdt054               LIKE pmdt_t.pmdt054,
           pmdt055               LIKE pmdt_t.pmdt055,
           pmdt060               LIKE pmdt_t.pmdt060,
           pmdt061               LIKE pmdt_t.pmdt061,
           pmdt084               LIKE pmdt_t.pmdt084,
           pmdt088               LIKE pmdt_t.pmdt088,
           pmdt089               LIKE pmdt_t.pmdt089,
           pmdt219               LIKE pmdt_t.pmdt219,
           pmdt227               LIKE pmdt_t.pmdt227  #補貨規格說明    150710-00016#7 Add By Ken 150713
                                 END RECORD
   DEFINE  l_pmdtseq             LIKE pmdt_t.pmdtseq
   DEFINE  l_inam                DYNAMIC ARRAY OF RECORD   #記錄產品特徵
            inam001              LIKE inam_t.inam001,
            inam002              LIKE inam_t.inam002,
            inam004              LIKE inam_t.inam004
                                 END RECORD
   DEFINE  r_success             LIKE type_t.num5
   #150601-00009#1 150601 By pomelo add(S)
   DEFINE  l_imaf062             LIKE imaf_t.imaf062
   DEFINE  l_imaf063             LIKE imaf_t.imaf063
   DEFINE  l_oofg_return         DYNAMIC ARRAY OF RECORD #自動編碼使用
           oofg019               LIKE oofg_t.oofg019,    #field
           oofg020               LIKE oofg_t.oofg020     #value
                                 END RECORD
   #150601-00009#1 150601 By pomelo add(E)
   DEFINE l_stboacti             LIKE stbo_t.stboacti    #Add By Ken 151028 #151027-00013#1
   #end add-point  
   
   #add-point:Function前置處理  name="input.pre_function"
   
   #end add-point
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdssite_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003, 
       g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052, 
       g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031, 
       g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds037,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046, 
       g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid, 
       g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid, 
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql name="input.define_sql"
   LET l_auto_detail = 'Y'
   #end add-point 
   LET g_forupd_sql = "SELECT pmdtsite,pmdtseq,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216,pmdt217,pmdt001, 
       pmdt002,pmdt003,pmdt004,pmdt221,pmdt005,pmdt200,pmdt006,pmdt220,pmdt007,pmdt025,pmdt227,pmdt201, 
       pmdt202,pmdt019,pmdt020,pmdt023,pmdt024,pmdt036,pmdt218,pmdt044,pmdt046,pmdt037,pmdt038,pmdt039, 
       pmdt047,pmdt026,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt052,pmdt051,pmdt059,pmdt203,pmdt204, 
       pmdt205,pmdt214,pmdt215,pmdt208,pmdt209,pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga,pmdt053,pmdt054, 
       pmdt055,pmdt060,pmdt061,pmdt084,pmdt219,pmdt089,pmdt088,pmdtseq FROM pmdt_t WHERE pmdtent=? AND  
       pmdtdocno=? AND pmdtseq=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql"
            
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt860_bcl CURSOR FROM g_forupd_sql
   
   #add-point:input段define_sql name="input.define_sql2"
            
   #end add-point    
   LET g_forupd_sql = "SELECT pmdusite,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu006,pmdu007,pmdu008,pmdu005, 
       pmdu200,pmdu201,pmdu009,pmdu010,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016 FROM pmdu_t WHERE  
       pmduent=? AND pmdudocno=? AND pmduseq=? AND pmduseq1=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql2"
            
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt860_bcl2 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql3"
            
   #end add-point    
   LET g_forupd_sql = "SELECT pmdvsite,pmdvseq,pmdvseq1,pmdv005,pmdv001,pmdv002,pmdv014,pmdv015,pmdv016, 
       pmdv017,pmdv200,pmdv201,pmdv018,pmdv019 FROM pmdv_t WHERE pmdvent=? AND pmdvdocno=? AND pmdvseq=?  
       AND pmdvseq1=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql3"
            
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt860_bcl3 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql4"
   
   #end add-point    
   LET g_forupd_sql = "SELECT xrcdsite,xrcdld,xrcdseq,xrcd007,xrcd002,xrcdseq2,xrcd003,xrcd006,xrcd004, 
       xrcd104 FROM xrcd_t WHERE xrcdent=? AND xrcddocno=? AND xrcdld=? AND xrcdseq=? AND xrcdseq2=?  
       AND xrcd007=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql4"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE apmt860_bcl4 CURSOR FROM g_forupd_sql
 
 
   
 
 
   #add-point:input段define_sql name="input.other_sql"
            
   #end add-point 
 
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL apmt860_set_entry(p_cmd)
   #add-point:set_entry後 name="input.after_set_entry"
   CALL apmt860_set_no_required()
   CALL apmt860_set_required()   
   #end add-point
   CALL apmt860_set_no_entry(p_cmd)
 
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200, 
       g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007, 
       g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081, 
       g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
       g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037, 
       g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102, 
       g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   
   LET lb_reproduce = FALSE
   LET l_ac_t = 1
   
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
   
   #add-point:資料輸入前 name="input.before_input"
   
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
{</section>}
 
{<section id="apmt860.input.head" >}
      #單頭段
      INPUT BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200, 
          g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007, 
          g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081, 
          g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023, 
          g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037, 
          g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102, 
          g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION(master_input)
         
     
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt860_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt860_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            CALL apmt860_set_entry(p_cmd)
            #add-point:資料輸入前 name="input.m.before_input"
            CALL apmt860_set_comp_visible('2',p_cmd)    #150818-00010#1 150818 By pomelo
            #end add-point
            CALL apmt860_set_no_entry(p_cmd)
    
                  #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdssite
            
            #add-point:AFTER FIELD pmdssite name="input.a.pmdssite"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdssite
            #add-point:BEFORE FIELD pmdssite name="input.b.pmdssite"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdssite
            #add-point:ON CHANGE pmdssite name="input.g.pmdssite"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocdt
            #add-point:BEFORE FIELD pmdsdocdt name="input.b.pmdsdocdt"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocdt
            
            #add-point:AFTER FIELD pmdsdocdt name="input.a.pmdsdocdt"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdsdocdt
            #add-point:ON CHANGE pmdsdocdt name="input.g.pmdsdocdt"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds001
            #add-point:BEFORE FIELD pmds001 name="input.b.pmds001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds001
            
            #add-point:AFTER FIELD pmds001 name="input.a.pmds001"
            IF NOT cl_null(g_pmds_m.pmds001) THEN
               IF g_pmds_m.pmds001 != g_pmds_m_o.pmds001 OR cl_null(g_pmds_m_o.pmds001) THEN
                  #151120-00003#1 20151125 mark by beckxie--S
                  ##扣帳日期不可以小於輸入的單據日期
                  #IF g_pmds_m.pmds001 < g_pmds_m.pmdsdocdt THEN
                  #   INITIALIZE g_errparam TO NULL
                  #   LET g_errparam.code = 'apm-00783'
                  #   LET g_errparam.extend = ""
                  #   LET g_errparam.popup = TRUE
                  #   CALL cl_err()
                  #   LET g_pmds_m.pmds001 = g_pmds_m_o.pmds001
                  #   NEXT FIELD CURRENT
                  #END IF
                  #151120-00003#1 20151125 mark by beckxie---E
                  
                  #維護的日期不可小於成本關帳日
                  LET l_gzsz008 = cl_get_para(g_enterprise,g_pmds_m.pmdssite,'S-MFG-0031')
                  IF g_pmds_m.pmds001 <= l_gzsz008 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'sub-00306'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_pmds_m.pmds001 = g_pmds_m_o.pmds001
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmds_m_o.pmds001 = g_pmds_m.pmds001
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds001
            #add-point:ON CHANGE pmds001 name="input.g.pmds001"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsdocno
            #add-point:BEFORE FIELD pmdsdocno name="input.b.pmdsdocno"
            LET l_ooef004 = ''
            SELECT ooef004 INTO l_ooef004
              FROM ooef_t
             WHERE ooefent = g_enterprise
               AND ooef001 = g_pmds_m.pmdssite
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsdocno
            
            #add-point:AFTER FIELD pmdsdocno name="input.a.pmdsdocno"
            IF  NOT cl_null(g_pmds_m.pmdsdocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmds_m.pmdsdocno != g_pmdsdocno_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmds_t WHERE "||"pmdsent = '" ||g_enterprise|| "' AND "||"pmdsdocno = '"||g_pmds_m.pmdsdocno ||"'",'std-00004',0) THEN 
                     LET g_pmds_m.pmdsdocno = g_pmdsdocno_t
                     NEXT FIELD CURRENT
                  END IF
                  
                  IF NOT s_aooi200_chk_slip(g_pmds_m.pmdssite,'',g_pmds_m.pmdsdocno,g_prog) THEN
                     LET g_pmds_m.pmdsdocno = g_pmdsdocno_t
                     NEXT FIELD CURRENT
                  END IF
               END IF
               
               #150818-00010#1 150818 By pomelo add(S)
               IF g_pmds_m.pmdsdocno != g_pmds_m_o.pmdsdocno OR cl_null(g_pmds_m_o.pmdsdocno) THEN
                  IF NOT apmt860_chk_lot(p_cmd) THEN
                     LET g_pmds_m.pmds006 = ''
                  END IF
               END IF
               #150818-00010#1 150818 By pomelo add(E)
            END IF
            CALL apmt860_set_entry(p_cmd)
            CALL apmt860_set_no_entry(p_cmd)
            #150818-00010#1 150818 By pomelo add(S)
            CALL apmt860_set_comp_visible('2',p_cmd)
            LET g_pmds_m_o.pmdsdocno = g_pmds_m.pmdsdocno
            #150818-00010#1 150818 By pomelo add(E)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdsdocno
            #add-point:ON CHANGE pmdsdocno name="input.g.pmdsdocno"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds200
            
            #add-point:AFTER FIELD pmds200 name="input.a.pmds200"
            IF NOT cl_null(g_pmds_m.pmds200) THEN
               IF g_pmds_m.pmds200 != g_pmds_m_o.pmds200 OR cl_null(g_pmds_m_o.pmds200) THEN
                  IF NOT apmt860_pmds200_chk() THEN
                     LET g_pmds_m.pmds200 = g_pmds_m_o.pmds200
                     NEXT FIELD CURRENT
                  END IF
                  CALL apmt860_pmds200_default()
               END IF
            END IF
            LET g_pmds_m_o.pmds200 = g_pmds_m.pmds200
            CALL apmt860_set_entry(p_cmd)
            CALL apmt860_set_no_entry(p_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds200
            #add-point:BEFORE FIELD pmds200 name="input.b.pmds200"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds200
            #add-point:ON CHANGE pmds200 name="input.g.pmds200"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds006
            
            #add-point:AFTER FIELD pmds006 name="input.a.pmds006"
            IF NOT cl_null(g_pmds_m.pmds006) THEN 
               IF g_pmds_m.pmds006 != g_pmds_m_o.pmds006 OR cl_null(g_pmds_m_o.pmds006) THEN
                  IF NOT apmt860_pmds006_chk(g_pmds_m.pmds006) THEN
                     LET g_pmds_m.pmds006 = g_pmds_m_o.pmds006
                     NEXT FIELD CURRENT
                  END IF
                  #帶出來源單據資料
                  CALL apmt860_pmds006_default()
               END IF
            END IF
            LET g_pmds_m_o.pmds006 = g_pmds_m.pmds006
            CALL apmt860_set_entry(p_cmd)
            CALL apmt860_set_no_required()
            CALL apmt860_set_required()               
            CALL apmt860_set_no_entry(p_cmd)            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds006
            #add-point:BEFORE FIELD pmds006 name="input.b.pmds006"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds006
            #add-point:ON CHANGE pmds006 name="input.g.pmds006"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds011
            #add-point:BEFORE FIELD pmds011 name="input.b.pmds011"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds011
            
            #add-point:AFTER FIELD pmds011 name="input.a.pmds011"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds011
            #add-point:ON CHANGE pmds011 name="input.g.pmds011"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds002
            
            #add-point:AFTER FIELD pmds002 name="input.a.pmds002"
            LET g_pmds_m.pmds002_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds002_desc
            IF NOT cl_null(g_pmds_m.pmds002) THEN 
               #IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_pmds_m.pmds002 != g_pmds_m_t.pmds002 OR cl_null(g_pmds_m_t.pmds002))) THEN   #160824-00007#15 20160914 mark by beckxie
               IF g_pmds_m.pmds002 != g_pmds_m_o.pmds002 OR cl_null(g_pmds_m_o.pmds002) THEN   #160824-00007#15 20160914 add by beckxie
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmds002
                  #160318-00025#21  by 07900 --add-str
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"
                  #160318-00025#21  by 07900 --add-end 
                  IF cl_chk_exist("v_ooag001") THEN
                     #部門
                     SELECT ooag003 INTO g_pmds_m.pmds003
                       FROM ooag_t
                      WHERE ooagent = g_enterprise
                        AND ooag001 = g_pmds_m.pmds002
			            CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
                     DISPLAY BY NAME g_pmds_m.pmds003_desc
                  ELSE
                     #檢查失敗時後續處理
                     #LET g_pmds_m.pmds002 = g_pmds_m_t.pmds002   #160824-00007#15 20160914 mark by beckxie
                     LET g_pmds_m.pmds002 = g_pmds_m_o.pmds002    #160824-00007#15 20160914 add by beckxie
                     CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
                     DISPLAY BY NAME g_pmds_m.pmds002_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            LET g_pmds_m_o.pmds003 = g_pmds_m.pmds003
            CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
            DISPLAY BY NAME g_pmds_m.pmds002_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds002
            #add-point:BEFORE FIELD pmds002 name="input.b.pmds002"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds002
            #add-point:ON CHANGE pmds002 name="input.g.pmds002"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds003
            
            #add-point:AFTER FIELD pmds003 name="input.a.pmds003"
            LET g_pmds_m.pmds003_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds003_desc
            IF NOT cl_null(g_pmds_m.pmds003) THEN
               IF g_pmds_m.pmds003 != g_pmds_m_o.pmds003 OR cl_null(g_pmds_m_o.pmds003) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmds003
                  LET g_chkparam.arg2 = g_pmds_m.pmdsdocdt
                  #160318-00025#21  by 07900 --add-str
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aoo-00029:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
                 #160318-00025#21  by 07900 --add-end
                  IF NOT cl_chk_exist("v_ooeg001") THEN
                     LET g_pmds_m.pmds003 = g_pmds_m_o.pmds003
                     CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
                     DISPLAY BY NAME g_pmds_m.pmds003_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF 
            CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
            DISPLAY BY NAME g_pmds_m.pmds003_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds003
            #add-point:BEFORE FIELD pmds003 name="input.b.pmds003"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds003
            #add-point:ON CHANGE pmds003 name="input.g.pmds003"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdsstus
            #add-point:BEFORE FIELD pmdsstus name="input.b.pmdsstus"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdsstus
            
            #add-point:AFTER FIELD pmdsstus name="input.a.pmdsstus"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdsstus
            #add-point:ON CHANGE pmdsstus name="input.g.pmdsstus"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds007
            
            #add-point:AFTER FIELD pmds007 name="input.a.pmds007"
            LET g_pmds_m.pmds007_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds007_desc
            IF NOT cl_null(g_pmds_m.pmds007) THEN
               IF g_pmds_m.pmds007 != g_pmds_m_o.pmds007 OR cl_null(g_pmds_m_o.pmds007) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmds007
                  IF NOT cl_chk_exist("v_pmaa001_1") THEN
                     LET g_pmds_m.pmds007 = g_pmds_m_o.pmds007
                     CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
                     DISPLAY BY NAME g_pmds_m.pmds007_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #Add By Ken 151028 #151027-00013#1(S)   #取合約的進項稅別
                  IF g_argv[1] MATCHES '[247]' OR g_argv[1] = '22' THEN 
                     CALL s_apmt860_get_stan007(g_pmds_m.pmds007,g_pmds_m.pmdssite)
                        RETURNING l_success,g_pmds_m.pmds033,l_stboacti
                     IF NOT l_success THEN
                        INITIALIZE g_errparam TO NULL
                        IF l_stboacti = 'N' THEN
                           LET g_errparam.code = 'apm-01034'
                           LET g_errparam.extend = ""
                           LET g_errparam.replace[1] = g_pmds_m.pmdssite  
                           LET g_errparam.popup = TRUE                                       
                        ELSE
                           IF g_argv[1] MATCHES '[24]' THEN
                              LET g_errparam.code = 'apm-01028'                              
                           ELSE
                              LET g_errparam.code = 'apm-01029'
                           END IF
                           LET g_errparam.extend = ""
                           LET g_errparam.replace[1] = g_pmds_m.pmds007
                           LET g_errparam.replace[2] = g_pmds_m.pmdssite
                           LET g_errparam.replace[3] = ''        
                           LET g_errparam.popup = TRUE                        
                        END IF

                        CALL cl_err()  
                        LET g_pmds_m.pmds007 = g_pmds_m_o.pmds007
                        CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
                        DISPLAY BY NAME g_pmds_m.pmds007_desc                     
                        NEXT FIELD CURRENT 
                     END IF
                  END IF
                  #Add By Ken 151028 #151027-00013#1(E)                   
                  
                  #如果供應商有修改，根據供應商帶值
                  CALL apmt860_pmds007_default() 
                                     
               END IF
               #供应商生命周期的判断  2015/03/19  geza
               #CALL s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'2',g_pmds_m.pmds007) RETURNING r_success          #150719 by dongsz mark               CALL s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'1',g_pmdt_d[l_ac].pmdo001,    #150719 by dongsz add
                CALL s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'2',g_pmds_m.pmds007,'','') RETURNING r_success    #150719 by dongsz add
          
               IF r_success = FALSE THEN 
                  NEXT FIELD CURRENT
               END IF
               
            END IF
            LET g_pmds_m_o.pmds007 = g_pmds_m.pmds007
            CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
            DISPLAY BY NAME g_pmds_m.pmds007_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds007
            #add-point:BEFORE FIELD pmds007 name="input.b.pmds007"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds007
            #add-point:ON CHANGE pmds007 name="input.g.pmds007"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds008
            
            #add-point:AFTER FIELD pmds008 name="input.a.pmds008"
            LET g_pmds_m.pmds008_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds008_desc
            IF NOT cl_null(g_pmds_m.pmds008) THEN
               IF g_pmds_m.pmds008 != g_pmds_m_o.pmds008 OR cl_null(g_pmds_m_o.pmds008) THEN
                  IF NOT s_adb_chk_pmac002('2',g_pmds_m.pmds007,g_pmds_m.pmds008,'1') THEN
                     LET g_pmds_m.pmds008 = g_pmds_m_o.pmds008
                     CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
                     DISPLAY BY NAME g_pmds_m.pmds008_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmds_m_o.pmds008 = g_pmds_m.pmds008
            CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
            DISPLAY BY NAME g_pmds_m.pmds008_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds008
            #add-point:BEFORE FIELD pmds008 name="input.b.pmds008"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds008
            #add-point:ON CHANGE pmds008 name="input.g.pmds008"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds009
            
            #add-point:AFTER FIELD pmds009 name="input.a.pmds009"
            LET g_pmds_m.pmds009_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds009_desc 
            IF NOT cl_null(g_pmds_m.pmds009) THEN 
               IF g_pmds_m.pmds009 != g_pmds_m_o.pmds009 OR cl_null(g_pmds_m_o.pmds009) THEN
                  IF NOT s_adb_chk_pmac002('2',g_pmds_m.pmds007,g_pmds_m.pmds009,'2') THEN
                     LET g_pmds_m.pmds009 = g_pmds_m_o.pmds009
                     CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
                     DISPLAY BY NAME g_pmds_m.pmds009_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmds_m_o.pmds009 = g_pmds_m.pmds009
            CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
            DISPLAY BY NAME g_pmds_m.pmds009_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds009
            #add-point:BEFORE FIELD pmds009 name="input.b.pmds009"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds009
            #add-point:ON CHANGE pmds009 name="input.g.pmds009"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds010
            #add-point:BEFORE FIELD pmds010 name="input.b.pmds010"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds010
            
            #add-point:AFTER FIELD pmds010 name="input.a.pmds010"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds010
            #add-point:ON CHANGE pmds010 name="input.g.pmds010"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds052
            #add-point:BEFORE FIELD pmds052 name="input.b.pmds052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds052
            
            #add-point:AFTER FIELD pmds052 name="input.a.pmds052"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds052
            #add-point:ON CHANGE pmds052 name="input.g.pmds052"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds100
            #add-point:BEFORE FIELD pmds100 name="input.b.pmds100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds100
            
            #add-point:AFTER FIELD pmds100 name="input.a.pmds100"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds100
            #add-point:ON CHANGE pmds100 name="input.g.pmds100"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds081
            #add-point:BEFORE FIELD pmds081 name="input.b.pmds081"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds081
            
            #add-point:AFTER FIELD pmds081 name="input.a.pmds081"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds081
            #add-point:ON CHANGE pmds081 name="input.g.pmds081"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds045
            #add-point:BEFORE FIELD pmds045 name="input.b.pmds045"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds045
            
            #add-point:AFTER FIELD pmds045 name="input.a.pmds045"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds045
            #add-point:ON CHANGE pmds045 name="input.g.pmds045"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds202
            #add-point:BEFORE FIELD pmds202 name="input.b.pmds202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds202
            
            #add-point:AFTER FIELD pmds202 name="input.a.pmds202"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds202
            #add-point:ON CHANGE pmds202 name="input.g.pmds202"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds201
            #add-point:BEFORE FIELD pmds201 name="input.b.pmds201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds201
            
            #add-point:AFTER FIELD pmds201 name="input.a.pmds201"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds201
            #add-point:ON CHANGE pmds201 name="input.g.pmds201"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds021
            #add-point:BEFORE FIELD pmds021 name="input.b.pmds021"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds021
            
            #add-point:AFTER FIELD pmds021 name="input.a.pmds021"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds021
            #add-point:ON CHANGE pmds021 name="input.g.pmds021"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds022
            #add-point:BEFORE FIELD pmds022 name="input.b.pmds022"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds022
            
            #add-point:AFTER FIELD pmds022 name="input.a.pmds022"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds022
            #add-point:ON CHANGE pmds022 name="input.g.pmds022"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds023
            #add-point:BEFORE FIELD pmds023 name="input.b.pmds023"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds023
            
            #add-point:AFTER FIELD pmds023 name="input.a.pmds023"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds023
            #add-point:ON CHANGE pmds023 name="input.g.pmds023"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds024
            #add-point:BEFORE FIELD pmds024 name="input.b.pmds024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds024
            
            #add-point:AFTER FIELD pmds024 name="input.a.pmds024"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds024
            #add-point:ON CHANGE pmds024 name="input.g.pmds024"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds048
            #add-point:BEFORE FIELD pmds048 name="input.b.pmds048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds048
            
            #add-point:AFTER FIELD pmds048 name="input.a.pmds048"
            #取匯率
            IF NOT cl_null(g_pmds_m.pmds037) THEN
               #根據內外購獲取當前營運據點參數設置的汇率类型
               LET l_scc40 = ''
               IF g_pmds_m.pmds048 = '1' THEN   #內購
                  LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
               END IF
               IF g_pmds_m.pmds048 = '2' THEN   #外購
                  LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
               END IF
               LET l_ooef016 = ''
               SELECT ooef016 INTO l_ooef016
                 FROM ooef_t
                WHERE ooefent = g_enterprise
                  AND ooef001 = g_pmds_m.pmdssite
               IF (NOT cl_null(l_scc40)) AND (NOT cl_null(l_ooef016)) THEN
                  CALL s_aooi160_get_exrate('1',g_pmds_m.pmdssite,g_today,g_pmds_m.pmds037,l_ooef016,0,l_scc40) RETURNING g_pmds_m.pmds038
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds048
            #add-point:ON CHANGE pmds048 name="input.g.pmds048"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds049
            #add-point:BEFORE FIELD pmds049 name="input.b.pmds049"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds049
            
            #add-point:AFTER FIELD pmds049 name="input.a.pmds049"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds049
            #add-point:ON CHANGE pmds049 name="input.g.pmds049"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds031
            
            #add-point:AFTER FIELD pmds031 name="input.a.pmds031"
            LET g_pmds_m.pmds031_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds031_desc
            IF NOT cl_null(g_pmds_m.pmds031) THEN
               IF g_pmds_m.pmds031 != g_pmds_m_o.pmds031 OR cl_null(g_pmds_m_o.pmds031) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmds007
                  LET g_chkparam.arg2 = g_pmds_m.pmds031
                  IF NOT cl_chk_exist("v_pmad002_1") THEN
                     LET g_pmds_m.pmds031 = g_pmds_m_o.pmds031
                     CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
                     DISPLAY BY NAME g_pmds_m.pmds031_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmds_m_o.pmds031 = g_pmds_m.pmds031
            CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
            DISPLAY BY NAME g_pmds_m.pmds031_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds031
            #add-point:BEFORE FIELD pmds031 name="input.b.pmds031"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds031
            #add-point:ON CHANGE pmds031 name="input.g.pmds031"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds032
            
            #add-point:AFTER FIELD pmds032 name="input.a.pmds032"
            LET g_pmds_m.pmds032_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds032_desc
            IF NOT cl_null(g_pmds_m.pmds032) THEN 
               IF g_pmds_m.pmds032 != g_pmds_m_o.pmds032 OR cl_null(g_pmds_m_o.pmds032) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmds032
                  #160318-00025#21  by 07900 --add-str
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="apm-00070:sub-01302|apmi012|",cl_get_progname("apmi012",g_lang,"2"),"|:EXEPROGapmi012"
                 #160318-00025#21  by 07900 --add-end
                  IF NOT cl_chk_exist("v_oocq002_238") THEN
                     LET g_pmds_m.pmds032 = g_pmds_m_o.pmds032
                     CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
                     DISPLAY BY NAME g_pmds_m.pmds032_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmds_m_o.pmds032 = g_pmds_m.pmds032
            CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
            DISPLAY BY NAME g_pmds_m.pmds032_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds032
            #add-point:BEFORE FIELD pmds032 name="input.b.pmds032"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds032
            #add-point:ON CHANGE pmds032 name="input.g.pmds032"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds037
            
            #add-point:AFTER FIELD pmds037 name="input.a.pmds037"
            LET g_pmds_m.pmds037_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds037_desc
            IF NOT cl_null(g_pmds_m.pmds037) THEN
               IF g_pmds_m.pmds037 != g_pmds_m_o.pmds037 OR cl_null(g_pmds_m_o.pmds037) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmdssite
                  LET g_chkparam.arg2 = g_pmds_m.pmds037                  
                  #160318-00025#21  by 07900 --add-str
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aoo-00176:sub-01302|aooi150|",cl_get_progname("aooi150",g_lang,"2"),"|:EXEPROGaooi150"
                 #160318-00025#21  by 07900 --add-end
                  IF cl_chk_exist("v_ooaj002") THEN
                     #取匯率
                     CALL s_apmt840_pmdl016_default(g_pmds_m.pmdssite,g_pmds_m.pmds037,g_pmds_m.pmds048)
                        RETURNING g_pmds_m.pmds038
                     DISPLAY BY NAME g_pmds_m.pmds038
                  ELSE
                     LET g_pmds_m.pmds037 = g_pmds_m_o.pmds037
                     CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
                     DISPLAY BY NAME g_pmds_m.pmds037_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmds_m_o.pmds037 = g_pmds_m.pmds037
            LET g_pmds_m_o.pmds038 = g_pmds_m.pmds038
            CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
            DISPLAY BY NAME g_pmds_m.pmds037_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds037
            #add-point:BEFORE FIELD pmds037 name="input.b.pmds037"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds037
            #add-point:ON CHANGE pmds037 name="input.g.pmds037"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds038
            #add-point:BEFORE FIELD pmds038 name="input.b.pmds038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds038
            
            #add-point:AFTER FIELD pmds038 name="input.a.pmds038"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds038
            #add-point:ON CHANGE pmds038 name="input.g.pmds038"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds033
            
            #add-point:AFTER FIELD pmds033 name="input.a.pmds033"
            LET g_pmds_m.pmds033_desc = ''
            DISPLAY BY NAME g_pmds_m.pmds033_desc
            IF NOT cl_null(g_pmds_m.pmds033) THEN
               IF g_pmds_m.pmds033 != g_pmds_m_o.pmds033 OR cl_null(g_pmds_m_o.pmds033) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmds_m.pmdssite
                  LET g_chkparam.arg2 = g_pmds_m.pmds033
                  #160318-00025#21  by 07900 --add-str
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aoo-00223:sub-01302|aooi610|",cl_get_progname("aooi610",g_lang,"2"),"|:EXEPROGaooi610"
                  #160318-00025#21  by 07900 --add-end
                  IF NOT cl_chk_exist("v_oodb002") THEN
                     LET g_pmds_m.pmds033 = g_pmds_m_o.pmds033
                     CALL s_desc_get_tax_desc1(g_pmds_m.pmdssite,g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
                     DISPLAY BY NAME g_pmds_m.pmds033_desc
                     NEXT FIELD CURRENT
                  END IF
                  CALL s_adb_oodb002_default(g_pmds_m.pmdssite,g_pmds_m.pmds033)
                     RETURNING g_pmds_m.pmds035,g_pmds_m.pmds034
                  DISPLAY BY NAME g_pmds_m.pmds035,g_pmds_m.pmds034
               END IF
            END IF
            LET g_pmds_m_o.pmds033 = g_pmds_m.pmds033
            LET g_pmds_m_o.pmds034 = g_pmds_m.pmds034
            LET g_pmds_m_o.pmds035 = g_pmds_m.pmds035
            CALL s_desc_get_tax_desc1(g_pmds_m.pmdssite,g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
            DISPLAY BY NAME g_pmds_m.pmds033_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds033
            #add-point:BEFORE FIELD pmds033 name="input.b.pmds033"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds033
            #add-point:ON CHANGE pmds033 name="input.g.pmds033"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds034
            #add-point:BEFORE FIELD pmds034 name="input.b.pmds034"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds034
            
            #add-point:AFTER FIELD pmds034 name="input.a.pmds034"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds034
            #add-point:ON CHANGE pmds034 name="input.g.pmds034"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds035
            #add-point:BEFORE FIELD pmds035 name="input.b.pmds035"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds035
            
            #add-point:AFTER FIELD pmds035 name="input.a.pmds035"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds035
            #add-point:ON CHANGE pmds035 name="input.g.pmds035"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds101
            #add-point:BEFORE FIELD pmds101 name="input.b.pmds101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds101
            
            #add-point:AFTER FIELD pmds101 name="input.a.pmds101"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds101
            #add-point:ON CHANGE pmds101 name="input.g.pmds101"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds102
            #add-point:BEFORE FIELD pmds102 name="input.b.pmds102"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds102
            
            #add-point:AFTER FIELD pmds102 name="input.a.pmds102"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds102
            #add-point:ON CHANGE pmds102 name="input.g.pmds102"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds000
            #add-point:BEFORE FIELD pmds000 name="input.b.pmds000"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds000
            
            #add-point:AFTER FIELD pmds000 name="input.a.pmds000"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds000
            #add-point:ON CHANGE pmds000 name="input.g.pmds000"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds014
            #add-point:BEFORE FIELD pmds014 name="input.b.pmds014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds014
            
            #add-point:AFTER FIELD pmds014 name="input.a.pmds014"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds014
            #add-point:ON CHANGE pmds014 name="input.g.pmds014"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds043
            #add-point:BEFORE FIELD pmds043 name="input.b.pmds043"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds043
            
            #add-point:AFTER FIELD pmds043 name="input.a.pmds043"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds043
            #add-point:ON CHANGE pmds043 name="input.g.pmds043"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds044
            #add-point:BEFORE FIELD pmds044 name="input.b.pmds044"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds044
            
            #add-point:AFTER FIELD pmds044 name="input.a.pmds044"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds044
            #add-point:ON CHANGE pmds044 name="input.g.pmds044"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmds046
            #add-point:BEFORE FIELD pmds046 name="input.b.pmds046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmds046
            
            #add-point:AFTER FIELD pmds046 name="input.a.pmds046"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmds046
            #add-point:ON CHANGE pmds046 name="input.g.pmds046"
            
            #END add-point 
 
 
 #欄位檢查
                  #Ctrlp:input.c.pmdssite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdssite
            #add-point:ON ACTION controlp INFIELD pmdssite name="input.c.pmdssite"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmdsdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocdt
            #add-point:ON ACTION controlp INFIELD pmdsdocdt name="input.c.pmdsdocdt"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds001
            #add-point:ON ACTION controlp INFIELD pmds001 name="input.c.pmds001"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmdsdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsdocno
            #add-point:ON ACTION controlp INFIELD pmdsdocno name="input.c.pmdsdocno"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmdsdocno
            
            #給予arg
            LET g_qryparam.arg1 = l_ooef004
            LET g_qryparam.arg2 = g_prog

            CALL q_ooba002_1()
            LET g_pmds_m.pmdsdocno = g_qryparam.return1
            DISPLAY g_pmds_m.pmdsdocno TO pmdsdocno
            NEXT FIELD pmdsdocno
            #END add-point
 
 
         #Ctrlp:input.c.pmds200
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds200
            #add-point:ON ACTION controlp INFIELD pmds200 name="input.c.pmds200"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds200             #給予default值

            #給予arg
            LET g_qryparam.arg1 = '1'
            LET g_qryparam.arg2 = g_site
            
            #當採購收貨入庫單時，收貨預約單的資料對應到採購單，不可以檢驗 = 'Y'的資料
            IF g_argv[1] = '3' THEN
               LET g_qryparam.where = "  NOT EXISTS (SELECT 1",
                                      "                FROM pmdn_t",
                                      "               WHERE pmdnent = pmelent",
                                      "                 AND pmdndocno = pmel001",
                                      "                 AND pmdn052 = 'Y')"
            END IF
            
            CALL q_pmeldocno_1()
            LET g_pmds_m.pmds200 = g_qryparam.return1 
            DISPLAY g_pmds_m.pmds200 TO pmds200
            NEXT FIELD pmds200
            #END add-point
 
 
         #Ctrlp:input.c.pmds006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds006
            #add-point:ON ACTION controlp INFIELD pmds006 name="input.c.pmds006"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds006
            
            #採購收貨時開窗開採購單號
			   IF g_argv[1] MATCHES '[13]' THEN
			      CALL q_pmdldocno_8()
            END IF
            #驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()
            END IF
            LET g_pmds_m.pmds006 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds006 TO pmds006
            NEXT FIELD pmds006
            #END add-point
 
 
         #Ctrlp:input.c.pmds011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds011
            #add-point:ON ACTION controlp INFIELD pmds011 name="input.c.pmds011"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds002
            #add-point:ON ACTION controlp INFIELD pmds002 name="input.c.pmds002"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds002
            
            #給予arg
            CALL q_ooag001()
            LET g_pmds_m.pmds002 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds002 TO pmds002
            CALL s_desc_get_person_desc(g_pmds_m.pmds002) RETURNING g_pmds_m.pmds002_desc
            DISPLAY BY NAME g_pmds_m.pmds002_desc
            NEXT FIELD pmds002
            #END add-point
 
 
         #Ctrlp:input.c.pmds003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds003
            #add-point:ON ACTION controlp INFIELD pmds003 name="input.c.pmds003"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		   	LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds003
            
            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmdsdocdt
            CALL q_ooeg001()
            LET g_pmds_m.pmds003 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds003 TO pmds003
            CALL s_desc_get_department_desc(g_pmds_m.pmds003) RETURNING g_pmds_m.pmds003_desc
            DISPLAY BY NAME g_pmds_m.pmds003_desc
            NEXT FIELD pmds003
            #END add-point
 
 
         #Ctrlp:input.c.pmdsstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdsstus
            #add-point:ON ACTION controlp INFIELD pmdsstus name="input.c.pmdsstus"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds007
            #add-point:ON ACTION controlp INFIELD pmds007 name="input.c.pmds007"
            #此段落由子樣板a07產生            
            #開窗i段
		   	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds007
            
            #給予arg
            CALL q_pmaa001_3()
            LET g_pmds_m.pmds007 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds007 TO pmds007
            CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
            DISPLAY BY NAME g_pmds_m.pmds007_desc
            NEXT FIELD pmds007
            #END add-point
 
 
         #Ctrlp:input.c.pmds008
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds008
            #add-point:ON ACTION controlp INFIELD pmds008 name="input.c.pmds008"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds008
            
            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmds007
            LET g_qryparam.where = " pmac003 = '1' "  #付款
            
            CALL q_pmac002_2()
            LET g_pmds_m.pmds008 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds008 TO pmds008
            CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
            DISPLAY BY NAME g_pmds_m.pmds008_desc
            NEXT FIELD pmds008
            #END add-point
 
 
         #Ctrlp:input.c.pmds009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds009
            #add-point:ON ACTION controlp INFIELD pmds009 name="input.c.pmds009"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds009
            
            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmds007
            LET g_qryparam.where = " pmac003 = '2' "  #送貨對象
            
            CALL q_pmac002_2()
            LET g_pmds_m.pmds009 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds009 TO pmds009
            CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
            DISPLAY BY NAME g_pmds_m.pmds009_desc
            NEXT FIELD pmds009
            #END add-point
 
 
         #Ctrlp:input.c.pmds010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds010
            #add-point:ON ACTION controlp INFIELD pmds010 name="input.c.pmds010"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds052
            #add-point:ON ACTION controlp INFIELD pmds052 name="input.c.pmds052"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds100
            #add-point:ON ACTION controlp INFIELD pmds100 name="input.c.pmds100"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds081
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds081
            #add-point:ON ACTION controlp INFIELD pmds081 name="input.c.pmds081"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds045
            #add-point:ON ACTION controlp INFIELD pmds045 name="input.c.pmds045"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds202
            #add-point:ON ACTION controlp INFIELD pmds202 name="input.c.pmds202"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds201
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds201
            #add-point:ON ACTION controlp INFIELD pmds201 name="input.c.pmds201"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds021
            #add-point:ON ACTION controlp INFIELD pmds021 name="input.c.pmds021"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds022
            #add-point:ON ACTION controlp INFIELD pmds022 name="input.c.pmds022"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds023
            #add-point:ON ACTION controlp INFIELD pmds023 name="input.c.pmds023"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds024
            #add-point:ON ACTION controlp INFIELD pmds024 name="input.c.pmds024"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds048
            #add-point:ON ACTION controlp INFIELD pmds048 name="input.c.pmds048"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds049
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds049
            #add-point:ON ACTION controlp INFIELD pmds049 name="input.c.pmds049"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds031
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds031
            #add-point:ON ACTION controlp INFIELD pmds031 name="input.c.pmds031"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds031
            
            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmds007
            CALL q_pmad002_2()
            LET g_pmds_m.pmds031 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds031 TO pmds031
            CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
            DISPLAY BY NAME g_pmds_m.pmds031_desc
            NEXT FIELD pmds031
            #END add-point
 
 
         #Ctrlp:input.c.pmds032
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds032
            #add-point:ON ACTION controlp INFIELD pmds032 name="input.c.pmds032"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds032
            
            #給予arg
            LET g_qryparam.arg1 = "238"
            CALL q_oocq002()
            LET g_pmds_m.pmds032 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds032 TO pmds032
            CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
            DISPLAY BY NAME g_pmds_m.pmds032_desc
            NEXT FIELD pmds032
            #END add-point
 
 
         #Ctrlp:input.c.pmds037
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds037
            #add-point:ON ACTION controlp INFIELD pmds037 name="input.c.pmds037"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds037
            
            #給予arg
            LET g_qryparam.arg1 = g_pmds_m.pmdssite
            CALL q_ooaj002_1()
            LET g_pmds_m.pmds037 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds037 TO pmds037
            CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
            DISPLAY BY NAME g_pmds_m.pmds037_desc
            NEXT FIELD pmds037
            #END add-point
 
 
         #Ctrlp:input.c.pmds038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds038
            #add-point:ON ACTION controlp INFIELD pmds038 name="input.c.pmds038"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds033
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds033
            #add-point:ON ACTION controlp INFIELD pmds033 name="input.c.pmds033"
            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmds_m.pmds033
            
            #給予arg
            CALL q_oodb002_2()
            LET g_pmds_m.pmds033 = g_qryparam.return1
            DISPLAY g_pmds_m.pmds033 TO pmds033
            CALL s_desc_get_tax_desc1(g_pmds_m.pmdssite,g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
            DISPLAY BY NAME g_pmds_m.pmds033_desc
            NEXT FIELD pmds033
            #END add-point
 
 
         #Ctrlp:input.c.pmds034
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds034
            #add-point:ON ACTION controlp INFIELD pmds034 name="input.c.pmds034"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds035
            #add-point:ON ACTION controlp INFIELD pmds035 name="input.c.pmds035"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds101
            #add-point:ON ACTION controlp INFIELD pmds101 name="input.c.pmds101"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds102
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds102
            #add-point:ON ACTION controlp INFIELD pmds102 name="input.c.pmds102"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds000
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds000
            #add-point:ON ACTION controlp INFIELD pmds000 name="input.c.pmds000"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds014
            #add-point:ON ACTION controlp INFIELD pmds014 name="input.c.pmds014"
            
            #END add-point
 
 
         #Ctrlp:input.c.pmds043
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds043
            #add-point:ON ACTION controlp INFIELD pmds043 name="input.c.pmds043"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds044
            #add-point:ON ACTION controlp INFIELD pmds044 name="input.c.pmds044"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.pmds046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmds046
            #add-point:ON ACTION controlp INFIELD pmds046 name="input.c.pmds046"
            
            #END add-point
 
 
 #欄位開窗
            
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
 
            #CALL cl_err_collect_show()      #錯誤訊息統整顯示
            #CALL cl_showmsg()
            DISPLAY BY NAME g_pmds_m.pmdsdocno
                        
            #add-point:單頭INPUT後 name="input.head.after_input"
            IF cl_null(g_pmds_m.pmds006) AND g_pmds_m.pmds100 = '2' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'apm-00656'
               LET g_errparam.extend = g_pmds_m.pmdsdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD pmds100
            END IF
          
            #end add-point
                        
            IF p_cmd <> 'u' THEN
    
               CALL s_transaction_begin()
               
               #add-point:單頭新增前 name="input.head.b_insert"
               CALL s_aooi200_gen_docno(g_site,g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_prog) RETURNING l_success,g_pmds_m.pmdsdocno
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00003'
                  LET g_errparam.extend = g_pmds_m.pmdsdocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  NEXT FIELD pmdsdocno
               END IF                
               #end add-point
               
               INSERT INTO pmds_t (pmdsent,pmdssite,pmdsdocdt,pmds001,pmdsdocno,pmds200,pmds006,pmds011, 
                   pmds002,pmds003,pmdsstus,pmds007,pmds008,pmds009,pmds010,pmds052,pmds100,pmds081, 
                   pmds045,pmds202,pmds201,pmds021,pmds022,pmds023,pmds024,pmds048,pmds049,pmds031,pmds032, 
                   pmds037,pmds038,pmds033,pmds034,pmds035,pmds101,pmds102,pmds000,pmds014,pmds043,pmds044, 
                   pmds046,pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid, 
                   pmdscnfdt,pmdspstid,pmdspstdt)
               VALUES (g_enterprise,g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
                   g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds003, 
                   g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
                   g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202, 
                   g_pmds_m.pmds201,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024, 
                   g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037, 
                   g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101, 
                   g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044, 
                   g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
                   g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
                   g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt) 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "g_pmds_m:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭新增中 name="input.head.m_insert"
                                                            
               #end add-point
               
               
               
               
               #add-point:單頭新增後 name="input.head.a_insert"
               LET l_cnt = 0
               SELECT COUNT(pmdtseq) INTO l_cnt
                 FROM pmdt_t
                WHERE pmdtent = g_enterprise
                  AND pmdtdocno = g_pmds_m.pmdsdocno
               IF l_cmd_t = 'a' AND l_cnt = 0 THEN
                  CALL s_transaction_end('Y','0')
                  IF cl_null(g_pmds_m.pmds006) AND cl_null(g_pmds_m.pmds200) AND
                     g_argv[1] MATCHES '[13]'  THEN
                     #是否執行產生收貨明細單身子程式?
                     IF cl_ask_confirm('apm-00818') THEN
                        LET l_success = ''
                        CALL apmt860_01(g_pmds_m.pmdsdocno) RETURNING l_success
                     ELSE
                        LET l_auto_detail = 'N'
                     END IF
                  ELSE
                     CALL s_transaction_begin()
                     #採購收貨單、採購收貨入庫單，由採購單產生單身
                     IF g_argv[1] MATCHES '[13]' THEN
                        IF NOT cl_null(g_pmds_m.pmds006) AND cl_null(g_pmds_m.pmds200) THEN
                           #是否根據單頭採購單號自動產生單身？
                           IF cl_ask_confirm('apm-00384') THEN
                              LET l_success = ''
                              CALL apmt860_gen_detail() RETURNING l_success
                           ELSE
                              LET l_auto_detail = 'N'
                           END IF
                        END IF
                        IF NOT cl_null(g_pmds_m.pmds200) THEN
                           #是否根據單頭預約收貨單號自動產生單身？
                           IF cl_ask_confirm('apm-00744') THEN
                              LET l_success = ''
                              CALL apmt860_gen_detail2('1') RETURNING l_success
                           ELSE
                              LET l_auto_detail = 'N'
                           END IF
                        END IF
                     END IF
                     #採購驗退單、採購入庫單、採購倉退單，由出貨單產生單身
                     IF g_argv[1] MATCHES '[567]' AND NOT cl_null(g_pmds_m.pmds006) THEN
                        #是否根據單頭出貨單單號自動產生單身？
                        IF cl_ask_confirm('apm-00740') THEN
                           LET l_success = ''
                           CALL apmt860_gen_detail1() RETURNING l_success
                        ELSE
                           LET l_auto_detail = 'N'
                        END IF
                     END IF
                  END IF
                  
                  IF l_success THEN
                     CALL s_transaction_end('Y','0')
                     LET l_auto_detail = 'N'   #170207-00002#1 170207 by sakura add
                  ELSE
                     CALL s_transaction_end('N','0')
                     LET l_auto_detail = 'N'   #170207-00002#1 170207 by sakura add
                  END IF
                  CALL apmt860_b_fill()
               END IF
               #end add-point
               CALL s_transaction_end('Y','0') 
               
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL apmt860_detail_reproduce()
                  #因應特定程式需求, 重新刷新單身資料
                  CALL apmt860_b_fill()
                  CALL apmt860_b_fill2('0')
               END IF
               
               #add-point:單頭新增後 name="input.head.a_insert2"
               
               #end add-point
               
               LET g_master_insert = TRUE
               
               LET p_cmd = 'u'
            ELSE
               CALL s_transaction_begin()
            
               #add-point:單頭修改前 name="input.head.b_update"
                                                            
               #end add-point
               
               #將遮罩欄位還原
               CALL apmt860_pmds_t_mask_restore('restore_mask_o')
               
               UPDATE pmds_t SET (pmdssite,pmdsdocdt,pmds001,pmdsdocno,pmds200,pmds006,pmds011,pmds002, 
                   pmds003,pmdsstus,pmds007,pmds008,pmds009,pmds010,pmds052,pmds100,pmds081,pmds045, 
                   pmds202,pmds201,pmds021,pmds022,pmds023,pmds024,pmds048,pmds049,pmds031,pmds032,pmds037, 
                   pmds038,pmds033,pmds034,pmds035,pmds101,pmds102,pmds000,pmds014,pmds043,pmds044,pmds046, 
                   pmdsownid,pmdsowndp,pmdscrtid,pmdscrtdp,pmdscrtdt,pmdsmodid,pmdsmoddt,pmdscnfid,pmdscnfdt, 
                   pmdspstid,pmdspstdt) = (g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
                   g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds003, 
                   g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
                   g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202, 
                   g_pmds_m.pmds201,g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024, 
                   g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037, 
                   g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101, 
                   g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044, 
                   g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
                   g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
                   g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt)
                WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmdsdocno_t
 
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmds_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE 
                  LET g_errparam.popup = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭修改中 name="input.head.m_update"
                                                            
               #end add-point
               
               
               
               
               #將遮罩欄位進行遮蔽
               CALL apmt860_pmds_t_mask_restore('restore_mask_n')
               
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_pmds_m_t)
               LET g_log2 = util.JSON.stringify(g_pmds_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
               
               #add-point:單頭修改後 name="input.head.a_update"
                                                            
               #end add-point
            END IF
            
            LET g_master_commit = "Y"
            LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
            
      END INPUT
   
 
{</section>}
 
{<section id="apmt860.input.body" >}
   
      #Page1 預設值產生於此處
      INPUT ARRAY g_pmdt_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_pmdt_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL apmt860_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1','4',"))
            END IF
            LET g_loc = 'm'
            LET g_rec_b = g_pmdt_d.getLength()
            #add-point:資料輸入前 name="input.d.before_input"
            #單身欄位隱藏
            CALL apmt860_set_comp_visible_b('2')
            LET l_cnt = 0
            SELECT COUNT(pmdtseq) INTO l_cnt
              FROM pmdt_t
             WHERE pmdtent = g_enterprise
               AND pmdtdocno = g_pmds_m.pmdsdocno
            IF l_cnt = 0 AND l_auto_detail = 'Y' THEN
               CALL s_transaction_end('Y','0')
               IF cl_null(g_pmds_m.pmds006) AND cl_null(g_pmds_m.pmds200) AND
                  g_argv[1] MATCHES '[13]' THEN
                  #是否執行產生收貨明細單身子程式?
                  IF cl_ask_confirm('apm-00818') THEN
                     LET l_success = ''
                     CALL apmt860_01(g_pmds_m.pmdsdocno) RETURNING l_success
                  END IF
               ELSE
                  CALL s_transaction_begin()
                  #採購收貨單、採購收貨入庫單，由採購單產生單身
                  IF g_argv[1] MATCHES '[13]' THEN
                     IF NOT cl_null(g_pmds_m.pmds006) AND cl_null(g_pmds_m.pmds200) THEN
                        #是否根據單頭採購單號自動產生單身？
                        IF cl_ask_confirm('apm-00384') THEN
                           LET l_success = ''
                           CALL apmt860_gen_detail() RETURNING l_success
                        END IF
                     END IF
                     
                     IF NOT cl_null(g_pmds_m.pmds200) THEN
                        #是否根據單頭預約收貨單號自動產生單身？
                        IF cl_ask_confirm('apm-00744') THEN
                           LET l_success = ''
                           CALL apmt860_gen_detail2('1') RETURNING l_success
                        END IF
                     END IF
                  END IF
                  #採購驗退單、採購入庫單、採購倉退單，由出貨單產生單身
                  IF g_argv[1] MATCHES '[567]' AND NOT cl_null(g_pmds_m.pmds006) THEN
                     #是否根據單頭出貨單單號自動產生單身？
                     IF cl_ask_confirm('apm-00740') THEN
                        LET l_success = ''
                        CALL apmt860_gen_detail1() RETURNING l_success
                     END IF
                  END IF
                  IF g_argv[1]='4' THEN 
                    IF cl_ask_confirm('axm-00013') THEN
                     #单据编号/单据日期/营运组织
                       CALL apmt860_06(g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt,g_pmds_m.pmdssite)
                       CALL apmt860_b_fill()
                       LET INT_FLAG = 0   #150407-00020#1 Add By Ken 151211
                    END IF
                 END IF 
               END IF
               
               IF l_success THEN
                  CALL s_transaction_end('Y','0')
               ELSE
                  CALL s_transaction_end('N','0')
               END IF
               CALL apmt860_b_fill()
               LET l_auto_detail = 'Y'
            END IF
            #end add-point
         
         BEFORE ROW
            #add-point:modify段before row2 name="input.body.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_detail_idx_list[1] = l_ac
            LET g_current_page = 1
            
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
            IF SQLCA.SQLCODE THEN   #(ver:78)
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt860_cl:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
               LET g_errparam.popup = TRUE 
               CLOSE apmt860_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_pmdt_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_pmdt_d[l_ac].pmdtseq IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_pmdt_d_t.* = g_pmdt_d[l_ac].*  #BACKUP
               LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*  #BACKUP
               CALL apmt860_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body.after_set_entry_b"
               CALL apmt860_set_no_required_b()
               CALL apmt860_set_required_b()
               
               #取前單據單號、前單據項次
               LET l_b_docno = ''
               LET l_b_seq = ''
               CALL apmt860_get_before_docno() RETURNING l_b_docno,l_b_seq
               
               #取前單據限定庫位、限定儲位、限定批號、庫存管理特徵
               LET g_pmdt016 = ''
               LET g_pmdt017 = ''
               LET g_pmdt018 = ''
               LET g_pmdt063 = ''
               CALL s_apmt860_before_docno_data(g_pmds_m.pmdsdocno,l_b_docno,l_b_seq)
                  RETURNING g_pmdt016,g_pmdt017,g_pmdt018,g_pmdt063
               #end add-point  
               CALL apmt860_set_no_entry_b(l_cmd)
               IF NOT apmt860_lock_b("pmdt_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt860_bcl INTO g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt206, 
                      g_pmdt_d[l_ac].pmdt207,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt216, 
                      g_pmdt_d[l_ac].pmdt217,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003, 
                      g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt221,g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt200, 
                      g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt220,g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt025, 
                      g_pmdt_d[l_ac].pmdt227,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt202,g_pmdt_d[l_ac].pmdt019, 
                      g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024,g_pmdt_d[l_ac].pmdt036, 
                      g_pmdt_d[l_ac].pmdt218,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt046,g_pmdt_d[l_ac].pmdt037, 
                      g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt026, 
                      g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018, 
                      g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051,g_pmdt_d[l_ac].pmdt059, 
                      g_pmdt_d[l_ac].pmdt203,g_pmdt_d[l_ac].pmdt204,g_pmdt_d[l_ac].pmdt205,g_pmdt_d[l_ac].pmdt214, 
                      g_pmdt_d[l_ac].pmdt215,g_pmdt_d[l_ac].pmdt208,g_pmdt_d[l_ac].pmdt209,g_pmdt_d[l_ac].pmdt210, 
                      g_pmdt_d[l_ac].pmdt211,g_pmdt_d[l_ac].pmdt212,g_pmdt_d[l_ac].pmdt213,g_pmdt_d[l_ac].pmdtorga, 
                      g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt060, 
                      g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt084,g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt089, 
                      g_pmdt_d[l_ac].pmdt088,g_pmdt4_d[l_ac].pmdtseq
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_pmdt_d_t.pmdtseq,":",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_pmdt_d_mask_o[l_ac].* =  g_pmdt_d[l_ac].*
                  CALL apmt860_pmdt_t_mask()
                  LET g_pmdt_d_mask_n[l_ac].* =  g_pmdt_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL apmt860_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body.before_row"
                                               
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
 
            #其他table進行lock
            
 
 
        
         BEFORE INSERT  
            
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_pmdt_d[l_ac].* TO NULL 
            INITIALIZE g_pmdt_d_t.* TO NULL 
            INITIALIZE g_pmdt_d_o.* TO NULL 
            #公用欄位給值(單身)
            
            #自定義預設值
                  LET g_pmdt_d[l_ac].pmdt207 = "0"
      LET g_pmdt_d[l_ac].pmdt217 = "0"
      LET g_pmdt_d[l_ac].pmdt005 = "1"
      LET g_pmdt_d[l_ac].pmdt025 = "1"
      LET g_pmdt_d[l_ac].pmdt036 = "0"
      LET g_pmdt_d[l_ac].pmdt218 = "0"
      LET g_pmdt_d[l_ac].pmdt044 = "0"
      LET g_pmdt_d[l_ac].pmdt038 = "0"
      LET g_pmdt_d[l_ac].pmdt039 = "0"
      LET g_pmdt_d[l_ac].pmdt047 = "0"
      LET g_pmdt_d[l_ac].pmdt026 = "N"
      LET g_pmdt_d[l_ac].pmdt062 = "N"
      LET g_pmdt_d[l_ac].pmdt052 = "1"
      LET g_pmdt_d[l_ac].pmdt209 = "1"
      LET g_pmdt_d[l_ac].pmdt210 = "1"
      LET g_pmdt_d[l_ac].pmdt053 = "0"
      LET g_pmdt_d[l_ac].pmdt054 = "0"
      LET g_pmdt_d[l_ac].pmdt055 = "0"
      LET g_pmdt_d[l_ac].pmdt061 = "0"
      LET g_pmdt_d[l_ac].pmdt084 = "N"
 
            #add-point:modify段before備份 name="input.body.insert.before_bak"
            #確保在單身有資料的時候插入一筆，有開啟transaction
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            
            #項次
            SELECT COALESCE(MAX(pmdtseq),0)+1
              INTO g_pmdt_d[l_ac].pmdtseq
              FROM pmdt_t
             WHERE pmdtent = g_enterprise
               AND pmdtdocno = g_pmds_m.pmdsdocno
            
            #營運據點
            LET g_pmdt_d[l_ac].pmdtsite = g_pmds_m.pmdssite
            
            #當單頭來源單號不為空時
            IF NOT cl_null(g_pmds_m.pmds006) THEN
               #採購收貨單 採購收貨入庫單時
               #單頭來源單不為空時，單身採購單號預設單頭的來源單號
               IF g_argv[1] MATCHES '[13]' THEN
                  LET g_pmdt_d[l_ac].pmdt001 = g_pmds_m.pmds006
               END IF
                  
               #採購驗退單、採購入庫單、採購倉退單時
               #單頭來源單不為空時，單身出貨單號預設單頭的來源單號
               IF g_argv[1] MATCHES '[567]' THEN
                  LET g_pmdt_d[l_ac].pmdt027 = g_pmds_m.pmds006
               END IF
            END IF
            
            #無採購單來源時
            IF g_argv[1] MATCHES '[24]' THEN
               #LET g_pmdt_d[l_ac].pmdtorga = g_pmds_m.pmdssite  #帳務組織
               #LET g_pmdt_d[l_ac].pmdt046 = g_pmds_m.pmds033    #稅別
               #LET g_pmdt_d[l_ac].pmdt037 = g_pmds_m.pmds034    #稅率
               #CALL s_desc_get_tax_desc1(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046)
               #   RETURNING g_pmdt_d[l_ac].pmdt046_desc
            END IF
            
            #如前單據沒有有預設庫位
            IF cl_null(g_pmdt016) THEN
               #庫位預設
               #CALL s_apmt860_inv_def(g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt006)
               #   RETURNING g_pmdt_d[l_ac].pmdt016
               #150520-00016#16 150527 By pomelo add(S)
               #當為 (無)採購收貨入庫單、採購入庫單 預設倉庫
               IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN     #modify by yangxf g_argv[1] = '22'          
                  IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
                     LET g_pmdt_d[l_ac].pmdt016 = s_apmt860_warehouse_default(g_site,g_pmdt_d[l_ac].pmdt006)
                  END IF
               END IF
               #150520-00016#16 150527 By pomelo add(E)
            ELSE
               LET g_pmdt_d[l_ac].pmdt016 = g_pmdt016
            END IF
            
            #庫存名稱
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING g_pmdt_d[l_ac].pmdt016_desc
               
            #如前單據沒有有預設儲位
            IF cl_null(g_pmdt017) THEN
              #CALL s_apmt860_get_inaa007(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt017)   #160426-00021#1 160503 by lori mark
               CALL s_apmt860_get_inaa007(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016)   #160426-00021#1 160503 by lori add
                  RETURNING l_inaa007
               IF l_inaa007 = '5' THEN
                  LET g_pmdt_d[l_ac].pmdt017 = ' '
               END IF
            ELSE
               LET g_pmdt_d[l_ac].pmdt017 = g_pmdt017
            END IF
            
            #庫存批號控管方式
            LET l_imaf055 = ''
            LET l_imaf061 = ''
            CALL s_apmt860_get_imaf(g_pmdt_d[l_ac].pmdt006) RETURNING l_imaf055,l_imaf061
            
            #如前單據沒有預設批號
            IF cl_null(g_pmdt018) THEN
               IF l_imaf061 = '2' THEN
                  LET g_pmdt_d[l_ac].pmdt018 = ' '
               END IF
            ELSE
               LET g_pmdt_d[l_ac].pmdt018 = g_pmdt018
            END IF
            
            #如前單據沒有預設庫存管理特徵
            IF cl_null(g_pmdt063) THEN
               IF l_imaf055 = '2' THEN
                  LET g_pmdt_d[l_ac].pmdt063 = ' '
               END IF
            ELSE
               LET g_pmdt_d[l_ac].pmdt063 = g_pmdt063
            END IF
            
            #倉退單，當倉退方式為'4:'價格折讓'時，數量欄位預設為0且不可以維護
            IF g_argv[1] = '7' AND g_pmds_m.pmds100 = '4' THEN
               LET g_pmdt_d[l_ac].pmdt020 = 0
               LET g_pmdt_d[l_ac].pmdt202 = 0
            END IF
            #150514-00020#1 By pomelo add(S)
            #須自立AP否
            IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN     #modify by yangxf add g_argv[1] = '22'
               LET g_pmdt_d[l_ac].pmdt084 = 'Y'
            ELSE
               LET g_pmdt_d[l_ac].pmdt084 = 'N'
            END IF
            #150514-00020#1 By pomelo add(E)
            
            #150714-00016#1 150714 By pomelo mark(S)
            ##製造日期
            #LET g_pmdt_d[l_ac].pmdt219 = g_pmds_m.pmdsdocdt
            ##有效日期
            #LET l_success = ''
            #LET l_pmdt089 = ''
            #IF g_argv[1] !='22' THEN   #add by yangxf 
            #   CALL s_lot_out_effdate(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
            #                          g_pmdt_d[l_ac].pmdt219,  g_pmdt_d[l_ac].pmdt018)
            #      RETURNING l_success,l_pmdt089
            #   IF l_success THEN
            #      LET g_pmdt_d[l_ac].pmdt089 = l_pmdt089
            #   END IF
            #END IF      #add by yangxf 
            #150714-00016#1 150714 By poemlo mark(E)
            #end add-point
            LET g_pmdt_d_t.* = g_pmdt_d[l_ac].*     #新輸入資料
            LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL apmt860_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body.insert.after_set_entry_b"
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
                                                   
            #end add-point
            CALL apmt860_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_pmdt_d[li_reproduce_target].* = g_pmdt_d[li_reproduce].*
               LET g_pmdt4_d[li_reproduce_target].* = g_pmdt4_d[li_reproduce].*
 
               LET g_pmdt_d[li_reproduce_target].pmdtseq = NULL
 
            END IF
            
 
 
            #add-point:modify段before insert name="input.body.before_insert"
 
            #end add-point  
  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身新增 name="input.body.b_a_insert"
                                                
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM pmdt_t 
             WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
 
               AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身新增前 name="input.body.b_insert"
               #產品特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               #儲位
               IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET g_pmdt_d[l_ac].pmdt017 = ' '
               END IF
               #批號
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_pmdt_d[l_ac].pmdt018 = ' '
                  #150601-00009#1 150601 By pomelo add(S)
                  #當為(無)採購收貨單 (無)採購收貨入庫單 且 非多庫儲批
                  IF g_argv[1] MATCHES '[1234]' AND g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                     LET l_success = ''
                     CALL s_lot_out_get_batch_no(g_pmdt_d[l_ac].pmdt006)
                        RETURNING l_success,g_pmdt_d[l_ac].pmdt018
                     IF l_success = FALSE THEN
                        CALL s_transaction_end('N','0')
                           CANCEL INSERT
                     END IF
                  END IF
                  #150601-00009#1 150601 By pomelo add(E)
               END IF
               #庫存管理特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_pmdt_d[l_ac].pmdt063 = ' '
               END IF
               #end add-point
            
               #同步新增到同層的table
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmds_m.pmdsdocno
               LET gs_keys[2] = g_pmdt_d[g_detail_idx].pmdtseq
               CALL apmt860_insert_b('pmdt_t',gs_keys,"'1'")
                           
               #add-point:單身新增後 name="input.body.a_insert"
                                         
               #end add-point
            ELSE    
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code = "std-00006" 
               LET g_errparam.popup = TRUE 
               INITIALIZE g_pmdt_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE 
               LET g_errparam.popup = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL apmt860_b_fill()
               #資料多語言用-增/改
               
               #add-point:input段-after_insert name="input.body.a_insert2"
               #新增多庫儲批收貨明細檔
               IF NOT s_apmt860_ins_pmdu(g_pmds_m.pmds000,      g_pmds_m.pmdsdocno,    g_pmdt_d[l_ac].pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                                         g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                                         g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,
                                         g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt027,
                                         g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,
                                         g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt063,
                                         g_pmdt_d[l_ac].pmdt088,g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt201,
                                         g_pmdt_d[l_ac].pmdt202,g_pmdt_d[l_ac].pmdt219) THEN
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               END IF
               #產生原始需求分配明細
               IF NOT s_apmt860_gen_pmdv(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq) THEN
                  CALL s_transaction_end('N','0')                    
                  CANCEL INSERT
               END IF
               #無採購單來源時
               IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN   #add by yangxf g_argv[1] = '22'
               
                  INITIALIZE l_pmdt.* TO NULL               
                  SELECT pmdtsite, pmdtseq, pmdt206, pmdt207, pmdt027,
                         pmdt028,  pmdt001, pmdt002, pmdt003, pmdt004,
                         pmdt005,  pmdt200, pmdt006, pmdt007, pmdt025,
                         pmdt201,  pmdt202, pmdt019, pmdt020, pmdt023,
                         pmdt024,  pmdt036, pmdt218, pmdt044, pmdt046,
                         pmdt037,  pmdt038, pmdt039, pmdt047, pmdt026,
                         pmdt062,  pmdt016, pmdt017, pmdt018, pmdt052,
                         pmdt051,  pmdt059, pmdt063,
                         pmdt203,  pmdt204, pmdt205, pmdt208, pmdt209,
                         pmdt210,  pmdt211, pmdt212, pmdt213, pmdtorga,
                         pmdt053,  pmdt054, pmdt055, pmdt060, pmdt061,
                         pmdt084,  pmdt088, pmdt089, pmdt219, pmdt227   #補貨規格說明  150710-00016#7 Add By Ken 150713
                    INTO l_pmdt.pmdtsite, l_pmdt.pmdtseq, l_pmdt.pmdt206, l_pmdt.pmdt207, l_pmdt.pmdt027,
                         l_pmdt.pmdt028,  l_pmdt.pmdt001, l_pmdt.pmdt002, l_pmdt.pmdt003, l_pmdt.pmdt004,
                         l_pmdt.pmdt005,  l_pmdt.pmdt200, l_pmdt.pmdt006, l_pmdt.pmdt007, l_pmdt.pmdt025,
                         l_pmdt.pmdt201,  l_pmdt.pmdt202, l_pmdt.pmdt019, l_pmdt.pmdt020, l_pmdt.pmdt023,
                         l_pmdt.pmdt024,  l_pmdt.pmdt036, l_pmdt.pmdt218, l_pmdt.pmdt044, l_pmdt.pmdt046,
                         l_pmdt.pmdt037,  l_pmdt.pmdt038, l_pmdt.pmdt039, l_pmdt.pmdt047, l_pmdt.pmdt026, l_pmdt.pmdt062,
                         l_pmdt.pmdt016,  l_pmdt.pmdt017, l_pmdt.pmdt018, l_pmdt.pmdt052, l_pmdt.pmdt051,
                         l_pmdt.pmdt059,  l_pmdt.pmdt063,
                         l_pmdt.pmdt203,  l_pmdt.pmdt204, l_pmdt.pmdt205, l_pmdt.pmdt208, l_pmdt.pmdt209,
                         l_pmdt.pmdt210,  l_pmdt.pmdt211, l_pmdt.pmdt212, l_pmdt.pmdt213, l_pmdt.pmdtorga,
                         l_pmdt.pmdt053,  l_pmdt.pmdt054, l_pmdt.pmdt055, l_pmdt.pmdt060, l_pmdt.pmdt061,
                         l_pmdt.pmdt084,  l_pmdt.pmdt088, l_pmdt.pmdt089, l_pmdt.pmdt219, l_pmdt.pmdt227  #補貨規格說明 150710-00016#7 Add By Ken 150713
                    FROM pmdt_t 
                   WHERE pmdtent = g_enterprise
                     AND pmdtdocno = g_pmds_m.pmdsdocno
                     AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
                  
                  IF l_inam.getLength() > 1 THEN  #因為第一筆資料已呈現在畫面並寫入DB, 從第二筆開始處理
                     LET l_pmdtseq = ''
                     SELECT MAX(pmdtseq) INTO l_pmdtseq
                       FROM pmdt_t
                      WHERE pmdtent   = g_enterprise
                        AND pmdtdocno = g_pmds_m.pmdsdocno
                     
                     FOR l_i = 2 TO l_inam.getLength() 
                        IF cl_null(l_pmdtseq) OR l_pmdtseq = 0 THEN
                           LET l_pmdtseq = 1
                        ELSE
                           LET l_pmdtseq = l_pmdtseq + 1
                        END IF
                        
                        LET l_pmdt.pmdtseq = l_pmdtseq
                        LET l_pmdt.pmdt007 = l_inam[l_i].inam002
                        LET l_pmdt.pmdt020 = l_inam[l_i].inam004
                        
                        #由收貨數量轉換成包裝數量
                        CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt201,l_pmdt.pmdt020)
                           RETURNING l_success,l_pmdt.pmdt202
                        
                        #由收貨數量轉換成計價數量
                        CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
                           RETURNING l_success,l_pmdt.pmdt024
                        
                        #取得未稅金額、稅額、含稅金額
                        CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno, l_pmdt.pmdtseq,
                                                  l_pmdt.pmdt001,     g_pmds_m.pmdssite,
                                                  g_pmds_m.pmds037,   l_pmdt.pmdt024,
                                                  l_pmdt.pmdt036,     l_pmdt.pmdt046)
                           RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
                        
                        #150601-00009#1 150601 By pomelo add(S)
                        #當為(無)採購收貨單 (無)採購收貨入庫單 且 非多庫儲批
                        IF g_argv[1] MATCHES '[1234]' AND l_pmdt.pmdt062 = 'N' THEN
                           LET l_success = ''
                           CALL s_lot_out_get_batch_no(l_pmdt.pmdt006)
                              RETURNING l_success,l_pmdt.pmdt018
                           IF l_success = FALSE THEN
                              CALL s_transaction_end('N','0')
                              CANCEL INSERT
                           END IF
                        END IF
                        #150601-00009#1 150601 By pomelo add(E)
                        
                        #Insert pmdt_t   
                        INSERT INTO pmdt_t (pmdtent, pmdtsite, pmdtdocno, pmdtseq,
                                            pmdt206, pmdt207,  pmdt027,   pmdt028,
                                            pmdt001, pmdt002,  pmdt003,   pmdt004,
                                            pmdt005, pmdt200,  pmdt006,   pmdt007,
                                            pmdt025, pmdt201,  pmdt202,   pmdt019,
                                            pmdt020, pmdt023,  pmdt024,   pmdt036,
                                            pmdt218, pmdt044,  pmdt046,   pmdt037,
                                            pmdt038, pmdt039,  pmdt047,   pmdt026,
                                            pmdt062, pmdt016,  pmdt017,   pmdt018,
                                            pmdt063, pmdt052,  pmdt051,   pmdt059,
                                            pmdt203, pmdt204,  pmdt205,   pmdt208,
                                            pmdt209, pmdt210,  pmdt211,   pmdt212,
                                            pmdt213, pmdtorga, pmdt053,   pmdt054,
                                            pmdt055, pmdt060,  pmdt061,   pmdt084,
                                            pmdt088, pmdt089,  pmdt219,   pmdt227)  #補貨規格說明 150710-00016#7 Add By Ken 150713
                           VALUES(g_enterprise,   l_pmdt.pmdtsite, g_pmds_m.pmdsdocno, l_pmdt.pmdtseq,
                                  l_pmdt.pmdt206, l_pmdt.pmdt207,  l_pmdt.pmdt027,     l_pmdt.pmdt028,
                                  l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,     l_pmdt.pmdt004,
                                  l_pmdt.pmdt005, l_pmdt.pmdt200,  l_pmdt.pmdt006,     l_pmdt.pmdt007,
                                  l_pmdt.pmdt025, l_pmdt.pmdt201,  l_pmdt.pmdt202,     l_pmdt.pmdt019,
                                  l_pmdt.pmdt020, l_pmdt.pmdt023,  l_pmdt.pmdt024,     l_pmdt.pmdt036,
                                  l_pmdt.pmdt218, l_pmdt.pmdt044,  l_pmdt.pmdt046,     l_pmdt.pmdt037,
                                  l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt047,     l_pmdt.pmdt026,
                                  l_pmdt.pmdt062, l_pmdt.pmdt016,  l_pmdt.pmdt017,     l_pmdt.pmdt018,
                                  l_pmdt.pmdt063, l_pmdt.pmdt052,  l_pmdt.pmdt051,     l_pmdt.pmdt059,
                                  l_pmdt.pmdt203, l_pmdt.pmdt204,  l_pmdt.pmdt205,     l_pmdt.pmdt208,
                                  l_pmdt.pmdt209, l_pmdt.pmdt210,  l_pmdt.pmdt211,     l_pmdt.pmdt212,
                                  l_pmdt.pmdt213, l_pmdt.pmdtorga, l_pmdt.pmdt053,     l_pmdt.pmdt054,
                                  l_pmdt.pmdt055, l_pmdt.pmdt060,  l_pmdt.pmdt061,     l_pmdt.pmdt084,
                                  l_pmdt.pmdt088, l_pmdt.pmdt089,  l_pmdt.pmdt219,     l_pmdt.pmdt227)   #補貨規格說明 150710-00016#7 Add By Ken 150713
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "Ins pmdt_t"
                           LET g_errparam.popup = FALSE
                           CALL cl_err()
                           CALL s_transaction_end('N','0')                    
                           CANCEL INSERT
                        END IF
                        #新增多庫儲批收貨明細檔
                        IF NOT s_apmt860_ins_pmdu(g_pmds_m.pmds000, g_pmds_m.pmdsdocno, l_pmdt.pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                                                 l_pmdt.pmdtseq,    l_pmdt.pmdt006,     l_pmdt.pmdt007,
                                                 l_pmdt.pmdt016,    l_pmdt.pmdt017,     l_pmdt.pmdt018,
                                                 l_pmdt.pmdt019,    l_pmdt.pmdt020,     l_pmdt.pmdt027,
                                                 l_pmdt.pmdt028,    l_pmdt.pmdt053,     l_pmdt.pmdt054,
                                                 l_pmdt.pmdt055,    l_pmdt.pmdt062,     l_pmdt.pmdt063,
                                                 l_pmdt.pmdt088,    l_pmdt.pmdt089,     l_pmdt.pmdt201,
                                                 l_pmdt.pmdt202,    l_pmdt.pmdt219) THEN
                           CALL s_transaction_end('N','0')                    
                           CANCEL INSERT
                        END IF
                     END FOR
                     LET g_rec_b = l_inam.getLength() - 1
                     CALL apmt860_b_fill()
                  END IF
                  CALL l_inam.clear()
               END IF                                 
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身刪除後(=d) name="input.body.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code = -263 
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身刪除前 name="input.body.b_delete"
               #更新自動編碼最大流水號檔
               IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  IF NOT s_aooi390_oofi_del('6',g_pmdt_d[l_ac].pmdt018) THEN
                     CANCEL DELETE
                  END IF
               END IF
               #end add-point 
               
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_pmds_m.pmdsdocno
 
               LET gs_keys[gs_keys.getLength()+1] = g_pmdt_d_t.pmdtseq
 
            
               #刪除同層單身
               IF NOT apmt860_delete_b('pmdt_t',gs_keys,"'1'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt860_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT apmt860_key_delete_b(gs_keys,'pmdt_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE apmt860_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
 
               
               #add-point:單身刪除中 name="input.body.m_delete"
                                                            
               #end add-point 
               
               CALL s_transaction_end('Y','0')
               CLOSE apmt860_bcl
            
               LET g_rec_b = g_rec_b-1
               #add-point:單身刪除後 name="input.body.a_delete"
               DELETE FROM pmdu_t
                 WHERE pmduent = g_enterprise AND pmdudocno = g_pmds_m.pmdsdocno AND
                       pmduseq = g_pmdt_d_t.pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmdu_t" 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE 
               END IF
               DELETE FROM pmdv_t
                 WHERE pmdvent = g_enterprise AND pmdvdocno = g_pmds_m.pmdsdocno AND
                       pmdvseq = g_pmdt_d_t.pmdtseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "pmdv_t" 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
               
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE 
               END IF
               #end add-point
               LET l_count = g_pmdt_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body.after_delete"
                                                
               #end add-point
            END IF
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_pmdt_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtsite
            #add-point:BEFORE FIELD pmdtsite name="input.b.page1.pmdtsite"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtsite
            
            #add-point:AFTER FIELD pmdtsite name="input.a.page1.pmdtsite"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdtsite
            #add-point:ON CHANGE pmdtsite name="input.g.page1.pmdtsite"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtseq
            #add-point:BEFORE FIELD pmdtseq name="input.b.page1.pmdtseq"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtseq
            
            #add-point:AFTER FIELD pmdtseq name="input.a.page1.pmdtseq"
                                                            #此段落由子樣板a05產生
            IF  g_pmds_m.pmdsdocno IS NOT NULL AND g_pmdt_d[l_ac].pmdtseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_pmds_m.pmdsdocno != g_pmdsdocno_t OR g_pmdt_d[l_ac].pmdtseq != g_pmdt_d_t.pmdtseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM pmdt_t WHERE "||"pmdtent = '" ||g_enterprise|| "' AND "||"pmdtdocno = '"||g_pmds_m.pmdsdocno ||"' AND "|| "pmdtseq = '"||g_pmdt_d[l_ac].pmdtseq ||"'",'std-00004',0) THEN 
                     LET g_pmdt_d[l_ac].pmdtseq = g_pmdt_d_t.pmdtseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdtseq
            #add-point:ON CHANGE pmdtseq name="input.g.page1.pmdtseq"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt206
            #add-point:BEFORE FIELD pmdt206 name="input.b.page1.pmdt206"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt206
            
            #add-point:AFTER FIELD pmdt206 name="input.a.page1.pmdt206"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt206
            #add-point:ON CHANGE pmdt206 name="input.g.page1.pmdt206"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt207
            #add-point:BEFORE FIELD pmdt207 name="input.b.page1.pmdt207"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt207
            
            #add-point:AFTER FIELD pmdt207 name="input.a.page1.pmdt207"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt207
            #add-point:ON CHANGE pmdt207 name="input.g.page1.pmdt207"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt027
            #add-point:BEFORE FIELD pmdt027 name="input.b.page1.pmdt027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt027
            
            #add-point:AFTER FIELD pmdt027 name="input.a.page1.pmdt027"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt027
            #add-point:ON CHANGE pmdt027 name="input.g.page1.pmdt027"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt028
            #add-point:BEFORE FIELD pmdt028 name="input.b.page1.pmdt028"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt028
            
            #add-point:AFTER FIELD pmdt028 name="input.a.page1.pmdt028"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt028)  THEN
               IF g_pmdt_d[l_ac].pmdt028 != g_pmdt_d_o.pmdt028 OR cl_null(g_pmdt_d_o.pmdt028) THEN 
                  IF NOT apmt860_pmdt028_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt028 = g_pmdt_d_o.pmdt028
                     NEXT FIELD CURRENT
                  END IF
                  #CALL apmt860_pmdt028_default()   #170207-00002#1 170207 by sakura mark
                  #170207-00002#1 170207 by sakura add(S)
                  CALL apmt860_pmdt028_default() RETURNING l_success
                  IF NOT l_success THEN
                     NEXT FIELD CURRENT
                  END IF
                  #170207-00002#1 170207 by sakura add(E)
               END IF
            END IF
            
            #160630-00026#2 Add BY Ken 160630(S)
            IF g_argv[1] = '7' AND cl_null(g_pmdt_d[l_ac].pmdt028) AND NOT cl_null(g_pmds_m.pmds006) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "apm-01116"
               LET g_errparam.extend = ""
               LET g_errparam.popup = TRUE
               CALL cl_err() 
               NEXT FIELD CURRENT               
            END IF
            #160630-00026#2 Add BY Ken 160630(E)
            
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            LET g_pmdt_d_o.pmdt028 = g_pmdt_d[l_ac].pmdt028
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt028
            #add-point:ON CHANGE pmdt028 name="input.g.page1.pmdt028"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt216
            #add-point:BEFORE FIELD pmdt216 name="input.b.page1.pmdt216"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt216
            
            #add-point:AFTER FIELD pmdt216 name="input.a.page1.pmdt216"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt216
            #add-point:ON CHANGE pmdt216 name="input.g.page1.pmdt216"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt217
            #add-point:BEFORE FIELD pmdt217 name="input.b.page1.pmdt217"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt217
            
            #add-point:AFTER FIELD pmdt217 name="input.a.page1.pmdt217"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt217
            #add-point:ON CHANGE pmdt217 name="input.g.page1.pmdt217"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt001
            #add-point:BEFORE FIELD pmdt001 name="input.b.page1.pmdt001"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt001
            
            #add-point:AFTER FIELD pmdt001 name="input.a.page1.pmdt001"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt001) THEN
               IF g_pmdt_d[l_ac].pmdt001 != g_pmdt_d_o.pmdt001 OR cl_null(g_pmdt_d_o.pmdt001) THEN 
                  IF NOT apmt860_pmdt001_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt001 = g_pmdt_d_o.pmdt001
                     LET g_pmdt_d[l_ac].pmdt002 = g_pmdt_d_o.pmdt002
                     LET g_pmdt_d[l_ac].pmdt003 = g_pmdt_d_o.pmdt003
                     LET g_pmdt_d[l_ac].pmdt004 = g_pmdt_d_o.pmdt004
                     NEXT FIELD CURRENT
                  END IF
                  #帶出採購單號預設值
                  CALL apmt860_pmdt001_default()
               END IF
            END IF
            LET g_pmdt_d_o.pmdt001 = g_pmdt_d[l_ac].pmdt001
            LET g_pmdt_d_o.pmdt002 = g_pmdt_d[l_ac].pmdt002
            LET g_pmdt_d_o.pmdt003 = g_pmdt_d[l_ac].pmdt003
            LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)        
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt001
            #add-point:ON CHANGE pmdt001 name="input.g.page1.pmdt001"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt002
            #add-point:BEFORE FIELD pmdt002 name="input.b.page1.pmdt002"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt002
            
            #add-point:AFTER FIELD pmdt002 name="input.a.page1.pmdt002"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt002)  THEN
               IF g_pmdt_d[l_ac].pmdt002 != g_pmdt_d_o.pmdt002 OR cl_null(g_pmdt_d_o.pmdt002) THEN 
                  IF NOT apmt860_pmdt002_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt002 = g_pmdt_d_o.pmdt002
                     LET g_pmdt_d[l_ac].pmdt003 = g_pmdt_d_o.pmdt003
                     LET g_pmdt_d[l_ac].pmdt004 = g_pmdt_d_o.pmdt004
                     NEXT FIELD CURRENT
                  END IF
                  
                  #帶出採購單號+採購項次預設值
                  CALL apmt860_pmdt002_default()

               END IF
            END IF
            LET g_pmdt_d_o.pmdt002 = g_pmdt_d[l_ac].pmdt002
            LET g_pmdt_d_o.pmdt003 = g_pmdt_d[l_ac].pmdt003
            LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)       
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt002
            #add-point:ON CHANGE pmdt002 name="input.g.page1.pmdt002"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt003
            #add-point:BEFORE FIELD pmdt003 name="input.b.page1.pmdt003"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt003
            
            #add-point:AFTER FIELD pmdt003 name="input.a.page1.pmdt003"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt003) THEN
               IF g_pmdt_d[l_ac].pmdt003 != g_pmdt_d_o.pmdt003 OR cl_null(g_pmdt_d_o.pmdt003) THEN 
                  
                  IF NOT apmt860_pmdt003_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt003 = g_pmdt_d_o.pmdt003
                     LET g_pmdt_d[l_ac].pmdt004 = g_pmdt_d_o.pmdt004
                     NEXT FIELD CURRENT
                  END IF
                  
                  #帶出採購單號+採購項次+採購項序預設值
                  CALL apmt860_pmdt003_default()
                  
               END IF
            END IF
            LET g_pmdt_d_o.pmdt003 = g_pmdt_d[l_ac].pmdt003
            LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)         
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt003
            #add-point:ON CHANGE pmdt003 name="input.g.page1.pmdt003"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt004
            #add-point:BEFORE FIELD pmdt004 name="input.b.page1.pmdt004"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt004
            
            #add-point:AFTER FIELD pmdt004 name="input.a.page1.pmdt004"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt004)  THEN
               IF g_pmdt_d[l_ac].pmdt004 != g_pmdt_d_o.pmdt004 OR cl_null(g_pmdt_d_o.pmdt004) THEN 
                 
                  IF NOT apmt860_pmdt004_chk() THEN
                     LET g_pmdt_d[l_ac].pmdt004 = g_pmdt_d_o.pmdt004
                     NEXT FIELD CURRENT
                  END IF
                  
                  #帶出採購單號+採購項次+採購項序預設值
                  CALL apmt860_pmdt004_default()
               END IF
            END IF
            
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            LET g_pmdt_d_o.pmdt004 = g_pmdt_d[l_ac].pmdt004                   
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt004
            #add-point:ON CHANGE pmdt004 name="input.g.page1.pmdt004"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo001
            
            #add-point:AFTER FIELD pmdo001 name="input.a.page1.pmdo001"
            #采购商品生命周期的判断  2015/03/19  geza
            IF NOT cl_null(g_pmdt_d[l_ac].pmdo001) THEN                   
              #CALL s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'1',g_pmdt_d[l_ac].pmdo001) RETURNING r_success   #150719 by dongsz mark
               CALL s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'1',g_pmdt_d[l_ac].pmdo001,    #150719 by dongsz add
                                     g_pmds_m.pmds007,g_pmds_m.pmdsdocdt)                    #150719 by dongsz add
                  RETURNING r_success                                                        #150719 by dongsz add
               IF r_success = FALSE THEN 
                  NEXT FIELD CURRENT
               END IF
            END IF         
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdo001
            CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdo001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdo001_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo001
            #add-point:BEFORE FIELD pmdo001 name="input.b.page1.pmdo001"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdo001
            #add-point:ON CHANGE pmdo001 name="input.g.page1.pmdo001"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdo002
            
            #add-point:AFTER FIELD pmdo002 name="input.a.page1.pmdo002"


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdo002
            #add-point:BEFORE FIELD pmdo002 name="input.b.page1.pmdo002"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdo002
            #add-point:ON CHANGE pmdo002 name="input.g.page1.pmdo002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt005
            #add-point:BEFORE FIELD pmdt005 name="input.b.page1.pmdt005"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt005
            
            #add-point:AFTER FIELD pmdt005 name="input.a.page1.pmdt005"
            IF g_pmdt_d[l_ac].pmdt005 = '9' THEN  #樣品
               LET g_pmdt_d[l_ac].pmdt001 = ''
               LET g_pmdt_d[l_ac].pmdt002 = ''
               LET g_pmdt_d[l_ac].pmdt003 = ''
               LET g_pmdt_d[l_ac].pmdt004 = ''
#               LET g_pmdt_d[l_ac].pmdt036 = 0
#               LET g_pmdt_d[l_ac].pmdt038 = 0
#               LET g_pmdt_d[l_ac].pmdt039 = 0
#               LET g_pmdt_d[l_ac].pmdt047 = 0
            END IF
            
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt005
            #add-point:ON CHANGE pmdt005 name="input.g.page1.pmdt005"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt200
            
            #add-point:AFTER FIELD pmdt200 name="input.a.page1.pmdt200"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt200) THEN 
               IF g_pmdt_d[l_ac].pmdt200 != g_pmdt_d_o.pmdt200 OR cl_null(g_pmdt_d_o.pmdt200) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt200
                  IF NOT cl_chk_exist("v_imay003_1") THEN
                     LET g_pmdt_d[l_ac].pmdt200 = g_pmdt_d_o.pmdt200
                     NEXT FIELD CURRENT
                  END IF
                  CALL s_apmt840_get_imay001(g_pmdt_d[l_ac].pmdt200) RETURNING g_pmdt_d[l_ac].pmdt006
                  IF NOT apmt860_pmdt006_chk(g_pmdt_d[l_ac].pmdt006) THEN
                     LET g_pmdt_d[l_ac].pmdt200 = g_pmdt_d_o.pmdt200
                     LET g_pmdt_d[l_ac].pmdt006 = g_pmdt_d_o.pmdt006
                     CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006)
                        RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
                     NEXT FIELD CURRENT
                  END IF
                  #150930-00013#1 Add By Ken 151007(S)  
                  #CALL apmt860_pmdt006_default('1')
                  IF NOT apmt860_pmdt006_default('1') THEN
                     NEXT FIELD CURRENT
                  END IF
                  #150930-00013#1 Add By Ken 151007(E)                  
               END IF
      
            END IF
            LET g_pmdt_d_o.pmdt200 = g_pmdt_d[l_ac].pmdt200
            LET g_pmdt_d_o.pmdt006 = g_pmdt_d[l_ac].pmdt006
            CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt200
            #add-point:BEFORE FIELD pmdt200 name="input.b.page1.pmdt200"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt200
            #add-point:ON CHANGE pmdt200 name="input.g.page1.pmdt200"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt006
            
            #add-point:AFTER FIELD pmdt006 name="input.a.page1.pmdt006"
            LET g_pmdt_d[l_ac].pmdt006_desc = ''
            LET g_pmdt_d[l_ac].pmdt006_desc_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt006) THEN
               IF g_pmdt_d[l_ac].pmdt006 != g_pmdt_d_o.pmdt006 OR cl_null(g_pmdt_d_o.pmdt006) THEN 
                  IF NOT apmt860_pmdt006_chk(g_pmdt_d[l_ac].pmdt006) THEN
                     LET g_pmdt_d[l_ac].pmdt006 = g_pmdt_d_o.pmdt006
                     CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006)
                        RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
                     NEXT FIELD CURRENT
                  END IF
                  #150930-00013#1 Add By Ken 151007(S)  
                  #CALL apmt860_pmdt006_default('2')
                  IF NOT apmt860_pmdt006_default('2') THEN
                     NEXT FIELD CURRENT
                  END IF
                  #150930-00013#1 Add By Ken 151007(E)                   
               END IF
            END IF

            #160630-00026#1 160630 by lori add---(S)
            CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006)
               RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
            #160630-00026#1 160630 by lori add---(E)
            
            LET g_pmdt_d_o.pmdt006 = g_pmdt_d[l_ac].pmdt006
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt006
            #add-point:BEFORE FIELD pmdt006 name="input.b.page1.pmdt006"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt006
            #add-point:ON CHANGE pmdt006 name="input.g.page1.pmdt006"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt007
            
            #add-point:AFTER FIELD pmdt007 name="input.a.page1.pmdt007"
            LET g_pmdt_d[l_ac].pmdt007_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
            
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt007) THEN
               IF g_pmdt_d[l_ac].pmdt007 != g_pmdt_d_o.pmdt007 OR cl_null(g_pmdt_d_o.pmdt007) THEN 
                  IF NOT s_feature_check(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) THEN
                     LET g_pmdt_d[l_ac].pmdt007 = g_pmdt_d_o.pmdt007
                     CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007)
                        RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                     NEXT FIELD CURRENT
                  END IF
                  #160201-00017#1 add start ------------------------
                  IF NOT s_feature_direct_input(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_pmdt_d_o.pmdt007,g_pmds_m.pmdsdocno,g_pmds_m.pmdssite) THEN
                     NEXT FIELD CURRENT
                  END IF
                  #160201-00017#1 add end   ------------------------   
                  IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN #未稅金額、含稅金額  #add by yangxf g_argv[1] = '22'
                     #數量轉換
                     CALL apmt860_num_change()
                     
                     #取得未稅金額、稅額、含稅金額
                     CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                               g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                               g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                               g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                        RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                  END IF
                  
                  IF g_argv[1] = '7' THEN
                     #庫位、儲位、批號、庫存管理特徵 清空
                     LET g_pmdt_d[l_ac].pmdt016 = ''
                     LET g_pmdt_d[l_ac].pmdt016_desc = ''
                     LET g_pmdt_d[l_ac].pmdt017 = ' '
                     LET g_pmdt_d[l_ac].pmdt017_desc = ''
                     LET g_pmdt_d[l_ac].pmdt018 = ' '
                     LET g_pmdt_d[l_ac].pmdt063 = ' '
                  END IF
               END IF
            END IF
            LET g_pmdt_d_o.pmdt007 = g_pmdt_d[l_ac].pmdt007
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt007
            #add-point:BEFORE FIELD pmdt007 name="input.b.page1.pmdt007"
            #160314-00009#5   add by zhujing 2016-3-17-----(S)
            IF s_feature_auto_chk(g_pmdt_d[l_ac].pmdt006) AND cl_null(g_pmdt_d[l_ac].pmdt007) AND NOT cl_null(g_pmdt_d[l_ac].pmdt006)THEN
               IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN  #無採購(來源)單據時，和正常新增一樣  #add by yangxf g_argv[1] = '22'
                  IF l_cmd = 'a' THEN            
                     CALL l_inam.clear()            
                     CALL s_feature(l_cmd,g_pmdt_d[l_ac].pmdt006,'','',g_site,g_pmds_m.pmdsdocno)
                        RETURNING l_success,l_inam
                     LET g_pmdt_d[l_ac].pmdt007 = l_inam[1].inam002
                     LET g_pmdt_d[l_ac].pmdt020 = l_inam[1].inam004
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt020
                     
                  END IF
               ELSE
                  CALL s_feature_single(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_site,g_pmds_m.pmdsdocno)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt007
                  CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007
               END IF   
            END IF
            #160314-00009#5   add by zhujing 2016-3-17-----(E)
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt007
            #add-point:ON CHANGE pmdt007 name="input.g.page1.pmdt007"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt025
            #add-point:BEFORE FIELD pmdt025 name="input.b.page1.pmdt025"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt025
            
            #add-point:AFTER FIELD pmdt025 name="input.a.page1.pmdt025"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt025
            #add-point:ON CHANGE pmdt025 name="input.g.page1.pmdt025"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt227
            #add-point:BEFORE FIELD pmdt227 name="input.b.page1.pmdt227"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt227
            
            #add-point:AFTER FIELD pmdt227 name="input.a.page1.pmdt227"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt227
            #add-point:ON CHANGE pmdt227 name="input.g.page1.pmdt227"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt201
            
            #add-point:AFTER FIELD pmdt201 name="input.a.page1.pmdt201"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt201
            CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt201_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt201_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt201
            #add-point:BEFORE FIELD pmdt201 name="input.b.page1.pmdt201"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt201
            #add-point:ON CHANGE pmdt201 name="input.g.page1.pmdt201"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt202
            #add-point:BEFORE FIELD pmdt202 name="input.b.page1.pmdt202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt202
            
            #add-point:AFTER FIELD pmdt202 name="input.a.page1.pmdt202"
            #160630-00001#1 Add By ken 160630(S)加包裝數量需>=0
            IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt202,"0.000","1","","","azz-00079",1) THEN
               NEXT FIELD pmdt202
            END IF             
            #160630-00001#1 Add By ken 160630(E)加包裝數量需>=0            
            
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt202)  THEN 
               IF g_pmdt_d[l_ac].pmdt202 != g_pmdt_d_o.pmdt202 OR cl_null(g_pmdt_d_o.pmdt202) THEN
                  #檢查輸入的包裝數量是否正確
                  IF NOT apmt860_chk_num('1') THEN
                     LET g_pmdt_d[l_ac].pmdt202 = g_pmdt_d_o.pmdt202
                     NEXT FIELD CURRENT
                  END IF
                  #數量轉換
                  CALL apmt860_num_change()
                  
                  #多庫儲批數量確認
                  CALL apmt860_for_apmt860_03()
                  
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF
            END IF
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020
            LET g_pmdt_d_o.pmdt053 = g_pmdt_d[l_ac].pmdt053
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202
            LET g_pmdt_d_o.pmdt062 = g_pmdt_d[l_ac].pmdt062
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt202
            #add-point:ON CHANGE pmdt202 name="input.g.page1.pmdt202"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt019
            
            #add-point:AFTER FIELD pmdt019 name="input.a.page1.pmdt019"
            LET g_pmdt_d[l_ac].pmdt019_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt019_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt019) THEN
               IF g_pmdt_d[l_ac].pmdt019 != g_pmdt_d_o.pmdt019 OR cl_null(g_pmdt_d_o.pmdt019) THEN
                  IF NOT apmt860_unit_chk(g_pmdt_d[l_ac].pmdt019) THEN
                     LET g_pmdt_d[l_ac].pmdt019 = g_pmdt_d_o.pmdt019
                     CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019)
                        RETURNING g_pmdt_d[l_ac].pmdt019_desc
                     NEXT FIELD CURRENT
                  END IF
                  CALL apmt860_num_change()
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                  
               END IF
            END IF
            LET g_pmdt_d_o.pmdt019 = g_pmdt_d[l_ac].pmdt019
            LET g_pmdt_d_o.pmdt024 = g_pmdt_d[l_ac].pmdt024
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt019
            #add-point:BEFORE FIELD pmdt019 name="input.b.page1.pmdt019"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt019
            #add-point:ON CHANGE pmdt019 name="input.g.page1.pmdt019"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt020
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt020,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD pmdt020
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdt020 name="input.a.page1.pmdt020"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt020)  THEN 
               IF g_pmdt_d[l_ac].pmdt020 != g_pmdt_d_o.pmdt020 OR cl_null(g_pmdt_d_o.pmdt020) THEN
                  #檢查輸入的包裝數量是否正確
                  IF NOT apmt860_chk_num('2') THEN
                     LET g_pmdt_d[l_ac].pmdt020 = g_pmdt_d_o.pmdt020
                     NEXT FIELD CURRENT
                  END IF
                  #數量轉換
                  CALL apmt860_num_change()
                  
                  #多庫儲批數量確認
                  CALL apmt860_for_apmt860_03()
                  
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
                  
               END IF
            END IF
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020
            LET g_pmdt_d_o.pmdt053 = g_pmdt_d[l_ac].pmdt053
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202
            LET g_pmdt_d_o.pmdt062 = g_pmdt_d[l_ac].pmdt062
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt020
            #add-point:BEFORE FIELD pmdt020 name="input.b.page1.pmdt020"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt020
            #add-point:ON CHANGE pmdt020 name="input.g.page1.pmdt020"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt023
            
            #add-point:AFTER FIELD pmdt023 name="input.a.page1.pmdt023"
            LET g_pmdt_d[l_ac].pmdt023_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt023_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt023) THEN
               IF g_pmdt_d[l_ac].pmdt023 != g_pmdt_d_o.pmdt023 OR cl_null(g_pmdt_d_o.pmdt023) THEN
               IF NOT apmt860_unit_chk(g_pmdt_d[l_ac].pmdt023) THEN
                     LET g_pmdt_d[l_ac].pmdt023 = g_pmdt_d_o.pmdt023
                     CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023)
                        RETURNING g_pmdt_d[l_ac].pmdt023_desc
                     NEXT FIELD CURRENT
                  END IF
                  CALL apmt860_num_change()
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF
            END IF
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020
            LET g_pmdt_d_o.pmdt023 = g_pmdt_d[l_ac].pmdt023
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt023
            #add-point:BEFORE FIELD pmdt023 name="input.b.page1.pmdt023"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt023
            #add-point:ON CHANGE pmdt023 name="input.g.page1.pmdt023"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt024
            #add-point:BEFORE FIELD pmdt024 name="input.b.page1.pmdt024"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt024
            
            #add-point:AFTER FIELD pmdt024 name="input.a.page1.pmdt024"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt024
            #add-point:ON CHANGE pmdt024 name="input.g.page1.pmdt024"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt036
            #add-point:BEFORE FIELD pmdt036 name="input.b.page1.pmdt036"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt036
            
            #add-point:AFTER FIELD pmdt036 name="input.a.page1.pmdt036"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt036) THEN
               #add by yangxf ---start----
               IF g_pmds_m.pmds000 != '22' THEN 
                  IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt036,"0.000","1","","","azz-00079",1) THEN
                     NEXT FIELD pmdt036
                  END IF 
               END IF 
               #add by yangxf -----end-----
               IF g_pmdt_d[l_ac].pmdt036 != g_pmdt_d_o.pmdt036 OR cl_null(g_pmdt_d_o.pmdt036) THEN
                   IF g_pmds_m.pmds000 != '22' THEN    #add by yangxf
                      #150506-00032#10 150527 by sakura add---STR
                      #單價容差率控卡
                      IF NOT s_apm_price_get_stan025_chk(g_pmdt_d[l_ac].pmdt212,g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt044) THEN
                         LET g_pmdt_d[l_ac].pmdt036 = g_pmdt_d_o.pmdt036
                         NEXT FIELD CURRENT                   
                      END IF 
                      #150506-00032#10 150527 by sakura add---END        
                  END IF    #add by yangxf                         
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF
            END IF
            LET g_pmdt_d_o.pmdt036 = g_pmdt_d[l_ac].pmdt036
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt036
            #add-point:ON CHANGE pmdt036 name="input.g.page1.pmdt036"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt218
            #add-point:BEFORE FIELD pmdt218 name="input.b.page1.pmdt218"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt218
            
            #add-point:AFTER FIELD pmdt218 name="input.a.page1.pmdt218"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt218
            #add-point:ON CHANGE pmdt218 name="input.g.page1.pmdt218"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt044
            #add-point:BEFORE FIELD pmdt044 name="input.b.page1.pmdt044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt044
            
            #add-point:AFTER FIELD pmdt044 name="input.a.page1.pmdt044"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt044
            #add-point:ON CHANGE pmdt044 name="input.g.page1.pmdt044"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt046
            
            #add-point:AFTER FIELD pmdt046 name="input.a.page1.pmdt046"
 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt046
            #add-point:BEFORE FIELD pmdt046 name="input.b.page1.pmdt046"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt046
            #add-point:ON CHANGE pmdt046 name="input.g.page1.pmdt046"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt037
            #add-point:BEFORE FIELD pmdt037 name="input.b.page1.pmdt037"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt037
            
            #add-point:AFTER FIELD pmdt037 name="input.a.page1.pmdt037"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt037
            #add-point:ON CHANGE pmdt037 name="input.g.page1.pmdt037"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt038
            #add-point:BEFORE FIELD pmdt038 name="input.b.page1.pmdt038"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt038
            
            #add-point:AFTER FIELD pmdt038 name="input.a.page1.pmdt038"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt038
            #add-point:ON CHANGE pmdt038 name="input.g.page1.pmdt038"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt039
            #add-point:BEFORE FIELD pmdt039 name="input.b.page1.pmdt039"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt039
            
            #add-point:AFTER FIELD pmdt039 name="input.a.page1.pmdt039"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt039
            #add-point:ON CHANGE pmdt039 name="input.g.page1.pmdt039"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt047
            #add-point:BEFORE FIELD pmdt047 name="input.b.page1.pmdt047"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt047
            
            #add-point:AFTER FIELD pmdt047 name="input.a.page1.pmdt047"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt047
            #add-point:ON CHANGE pmdt047 name="input.g.page1.pmdt047"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt026
            #add-point:BEFORE FIELD pmdt026 name="input.b.page1.pmdt026"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt026
            
            #add-point:AFTER FIELD pmdt026 name="input.a.page1.pmdt026"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt026
            #add-point:ON CHANGE pmdt026 name="input.g.page1.pmdt026"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt062
            #add-point:BEFORE FIELD pmdt062 name="input.b.page1.pmdt062"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt062
            
            #add-point:AFTER FIELD pmdt062 name="input.a.page1.pmdt062"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt062) THEN
               IF g_pmdt_d[l_ac].pmdt062 != g_pmdt_d_o.pmdt062 OR cl_null(g_pmdt_d[l_ac].pmdt062) THEN
                  #多庫儲批數量確認
                  CALL apmt860_for_apmt860_03()
                  
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF
            END IF
            LET g_pmdt_d_o.pmdt062 = g_pmdt_d[l_ac].pmdt062   #多庫儲批
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020   #出貨數量
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202   #包裝數量
            LET g_pmdt_d_o.pmdt053 = g_pmdt_d[l_ac].pmdt053   #允收數量
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016   #庫位
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017   #儲位
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018   #批號
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063   #庫存管理特徵
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt062
            #add-point:ON CHANGE pmdt062 name="input.g.page1.pmdt062"
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt016
            
            #add-point:AFTER FIELD pmdt016 name="input.a.page1.pmdt016"
            LET g_pmdt_d[l_ac].pmdt016_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
            IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
               LET g_pmdt_d[l_ac].pmdt017 = ''
               LET g_pmdt_d[l_ac].pmdt017_desc = ''
            ELSE
               IF g_pmdt_d[l_ac].pmdt016 != g_pmdt_d_o.pmdt016 OR cl_null(g_pmdt_d_o.pmdt016) THEN
                  IF apmt860_chk_pmdt016() THEN
                     CALL s_apmt860_get_inaa007(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016)
                        RETURNING l_inaa007
                     IF l_inaa007 = '5' THEN
                        LET g_pmdt_d[l_ac].pmdt017 = ' '
                     END IF
                  ELSE
                     LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                     LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                     LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                     LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
                     #庫位
                     CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
                        RETURNING g_pmdt_d[l_ac].pmdt016_desc
                     #儲位
                     CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
                        RETURNING g_pmdt_d[l_ac].pmdt017_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING  g_pmdt_d[l_ac].pmdt016_desc
            CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING  g_pmdt_d[l_ac].pmdt017_desc
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt016
            #add-point:BEFORE FIELD pmdt016 name="input.b.page1.pmdt016"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt016
            #add-point:ON CHANGE pmdt016 name="input.g.page1.pmdt016"
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt017
            
            #add-point:AFTER FIELD pmdt017 name="input.a.page1.pmdt017"
            LET g_pmdt_d[l_ac].pmdt017_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            IF g_pmdt_d[l_ac].pmdt017 IS NOT NULL THEN
               IF g_pmdt_d[l_ac].pmdt017 != g_pmdt_d_o.pmdt017 OR cl_null(g_pmdt_d_o.pmdt017) THEN
                  IF NOT apmt860_chk_pmdt017() THEN
                     LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                     LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                     LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                     LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
                     #庫位
                     CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
                        RETURNING  g_pmdt_d[l_ac].pmdt016_desc
                     #儲位
                     CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
                        RETURNING  g_pmdt_d[l_ac].pmdt017_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING  g_pmdt_d[l_ac].pmdt016_desc
            CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING  g_pmdt_d[l_ac].pmdt017_desc
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt017
            #add-point:BEFORE FIELD pmdt017 name="input.b.page1.pmdt017"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt017
            #add-point:ON CHANGE pmdt017 name="input.g.page1.pmdt017"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt018
            #add-point:BEFORE FIELD pmdt018 name="input.b.page1.pmdt018"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt018
            
            #add-point:AFTER FIELD pmdt018 name="input.a.page1.pmdt018"
            IF g_pmdt_d[l_ac].pmdt018 IS NOT NULL THEN
               IF g_pmdt_d[l_ac].pmdt018 != g_pmdt_d_o.pmdt018 OR cl_null(g_pmdt_d_o.pmdt018) THEN
                  IF NOT apmt860_chk_pmdt018() THEN
                     LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                     LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                     LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                     LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
                     #庫位
                     CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
                        RETURNING  g_pmdt_d[l_ac].pmdt016_desc
                     #儲位
                     CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
                        RETURNING  g_pmdt_d[l_ac].pmdt017_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               
               IF g_pmds_m.pmds000 MATCHES '[12346]' AND NOT cl_null(g_pmdt_d[l_ac].pmdt219) THEN
                  LET l_success = ''
                  LET l_pmdt089 = ''
                  CALL s_lot_out_effdate(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                                         g_pmdt_d[l_ac].pmdt219,  g_pmdt_d[l_ac].pmdt018)
                     RETURNING l_success,l_pmdt089
                  IF l_success THEN
                     LET g_pmdt_d[l_ac].pmdt089 = l_pmdt089
                  END IF
                  #160615-00028#3 Add By ken 160623(S)
                  CALL s_apmt860_pmdt219_get(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                                            g_pmdt_d[l_ac].pmdt089,  g_pmdt_d[l_ac].pmdt018)
                     RETURNING l_success,l_pmdt219
                  IF l_success THEN
                     LET g_pmdt_d[l_ac].pmdt219 = l_pmdt219
                  END IF
                  #160615-00028#3 Add By ken 160623(E)                  
               END IF
            END IF
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING  g_pmdt_d[l_ac].pmdt016_desc
            CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING  g_pmdt_d[l_ac].pmdt017_desc
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063
            LET g_pmdt_d_o.pmdt089 = g_pmdt_d[l_ac].pmdt089
            LET g_pmdt_d_o.pmdt219 = g_pmdt_d[l_ac].pmdt219
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt018
            #add-point:ON CHANGE pmdt018 name="input.g.page1.pmdt018"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt063
            #add-point:BEFORE FIELD pmdt063 name="input.b.page1.pmdt063"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt063
            
            #add-point:AFTER FIELD pmdt063 name="input.a.page1.pmdt063"
            IF g_pmdt_d[l_ac].pmdt063 IS NOT NULL THEN
               IF g_pmdt_d[l_ac].pmdt063 != g_pmdt_d_o.pmdt063 OR cl_null(g_pmdt_d_o.pmdt063) THEN
                  IF NOT apmt860_chk_pmdt018() THEN                     
                     LET g_pmdt_d[l_ac].pmdt016 = g_pmdt_d_o.pmdt016
                     LET g_pmdt_d[l_ac].pmdt017 = g_pmdt_d_o.pmdt017
                     LET g_pmdt_d[l_ac].pmdt018 = g_pmdt_d_o.pmdt018
                     LET g_pmdt_d[l_ac].pmdt063 = g_pmdt_d_o.pmdt063
                     #庫位
                     CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
                        RETURNING g_pmdt_d[l_ac].pmdt016_desc
                     #儲位
                     CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
                        RETURNING g_pmdt_d[l_ac].pmdt017_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING g_pmdt_d[l_ac].pmdt016_desc
            CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING g_pmdt_d[l_ac].pmdt017_desc
            LET g_pmdt_d_o.pmdt016 = g_pmdt_d[l_ac].pmdt016
            LET g_pmdt_d_o.pmdt017 = g_pmdt_d[l_ac].pmdt017
            LET g_pmdt_d_o.pmdt018 = g_pmdt_d[l_ac].pmdt018
            LET g_pmdt_d_o.pmdt063 = g_pmdt_d[l_ac].pmdt063
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt063
            #add-point:ON CHANGE pmdt063 name="input.g.page1.pmdt063"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt052
            #add-point:BEFORE FIELD pmdt052 name="input.b.page1.pmdt052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt052
            
            #add-point:AFTER FIELD pmdt052 name="input.a.page1.pmdt052"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt052
            #add-point:ON CHANGE pmdt052 name="input.g.page1.pmdt052"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt051
            
            #add-point:AFTER FIELD pmdt051 name="input.a.page1.pmdt051"
            LET g_pmdt_d[l_ac].pmdt051_desc = ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt051_desc
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt051) THEN
               IF g_pmdt_d[l_ac].pmdt051 != g_pmdt_d_o.pmdt051 OR cl_null(g_pmdt_d_o.pmdt051) THEN
                  IF NOT s_azzi650_chk_exist(l_acc,g_pmdt_d[l_ac].pmdt051) THEN
                     LET g_pmdt_d[l_ac].pmdt051 = g_pmdt_d_o.pmdt051               
                     CALL s_desc_get_acc_desc(l_acc,g_pmdt_d[l_ac].pmdt051)
                        RETURNING g_pmdt_d[l_ac].pmdt051_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_pmdt_d_o.pmdt051 = g_pmdt_d[l_ac].pmdt051
            CALL s_desc_get_acc_desc(l_acc,g_pmdt_d[l_ac].pmdt051)
               RETURNING g_pmdt_d[l_ac].pmdt051_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt051
            #add-point:BEFORE FIELD pmdt051 name="input.b.page1.pmdt051"
            LET l_acc = ''
            EXECUTE apmt860_get_gzcb004 INTO l_acc
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt051
            #add-point:ON CHANGE pmdt051 name="input.g.page1.pmdt051"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt059
            #add-point:BEFORE FIELD pmdt059 name="input.b.page1.pmdt059"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt059
            
            #add-point:AFTER FIELD pmdt059 name="input.a.page1.pmdt059"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt059
            #add-point:ON CHANGE pmdt059 name="input.g.page1.pmdt059"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt203
            
            #add-point:AFTER FIELD pmdt203 name="input.a.page1.pmdt203"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt203
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt203_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt203_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt203
            #add-point:BEFORE FIELD pmdt203 name="input.b.page1.pmdt203"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt203
            #add-point:ON CHANGE pmdt203 name="input.g.page1.pmdt203"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt204
            
            #add-point:AFTER FIELD pmdt204 name="input.a.page1.pmdt204"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt204
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt204_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt204_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt204
            #add-point:BEFORE FIELD pmdt204 name="input.b.page1.pmdt204"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt204
            #add-point:ON CHANGE pmdt204 name="input.g.page1.pmdt204"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt205
            
            #add-point:AFTER FIELD pmdt205 name="input.a.page1.pmdt205"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt205
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt205_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt205_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt205
            #add-point:BEFORE FIELD pmdt205 name="input.b.page1.pmdt205"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt205
            #add-point:ON CHANGE pmdt205 name="input.g.page1.pmdt205"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt214
            #add-point:BEFORE FIELD pmdt214 name="input.b.page1.pmdt214"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt214
            
            #add-point:AFTER FIELD pmdt214 name="input.a.page1.pmdt214"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt214
            #add-point:ON CHANGE pmdt214 name="input.g.page1.pmdt214"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt215
            
            #add-point:AFTER FIELD pmdt215 name="input.a.page1.pmdt215"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt215
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt215_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt215_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt215
            #add-point:BEFORE FIELD pmdt215 name="input.b.page1.pmdt215"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt215
            #add-point:ON CHANGE pmdt215 name="input.g.page1.pmdt215"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt208
            
            #add-point:AFTER FIELD pmdt208 name="input.a.page1.pmdt208"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt208
            CALL ap_ref_array2(g_ref_fields,"SELECT oojdl003 FROM oojdl_t WHERE oojdlent='"||g_enterprise||"' AND oojdl001=? AND oojdl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt208_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt208_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt208
            #add-point:BEFORE FIELD pmdt208 name="input.b.page1.pmdt208"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt208
            #add-point:ON CHANGE pmdt208 name="input.g.page1.pmdt208"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt209
            #add-point:BEFORE FIELD pmdt209 name="input.b.page1.pmdt209"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt209
            
            #add-point:AFTER FIELD pmdt209 name="input.a.page1.pmdt209"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt209
            #add-point:ON CHANGE pmdt209 name="input.g.page1.pmdt209"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt210
            #add-point:BEFORE FIELD pmdt210 name="input.b.page1.pmdt210"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt210
            
            #add-point:AFTER FIELD pmdt210 name="input.a.page1.pmdt210"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt210
            #add-point:ON CHANGE pmdt210 name="input.g.page1.pmdt210"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt211
            
            #add-point:AFTER FIELD pmdt211 name="input.a.page1.pmdt211"
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt211
            CALL ap_ref_array2(g_ref_fields,"SELECT staal003 FROM staal_t WHERE staalent='"||g_enterprise||"' AND staal001=? AND staal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_pmdt_d[l_ac].pmdt211_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt211_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt211
            #add-point:BEFORE FIELD pmdt211 name="input.b.page1.pmdt211"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt211
            #add-point:ON CHANGE pmdt211 name="input.g.page1.pmdt211"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt212
            #add-point:BEFORE FIELD pmdt212 name="input.b.page1.pmdt212"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt212
            
            #add-point:AFTER FIELD pmdt212 name="input.a.page1.pmdt212"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt212
            #add-point:ON CHANGE pmdt212 name="input.g.page1.pmdt212"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt213
            #add-point:BEFORE FIELD pmdt213 name="input.b.page1.pmdt213"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt213
            
            #add-point:AFTER FIELD pmdt213 name="input.a.page1.pmdt213"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt213
            #add-point:ON CHANGE pmdt213 name="input.g.page1.pmdt213"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdtorga
            
            #add-point:AFTER FIELD pmdtorga name="input.a.page1.pmdtorga"
 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdtorga
            #add-point:BEFORE FIELD pmdtorga name="input.b.page1.pmdtorga"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdtorga
            #add-point:ON CHANGE pmdtorga name="input.g.page1.pmdtorga"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt053
            #add-point:BEFORE FIELD pmdt053 name="input.b.page1.pmdt053"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt053
            
            #add-point:AFTER FIELD pmdt053 name="input.a.page1.pmdt053"
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt053)  THEN 
               IF g_pmdt_d[l_ac].pmdt053 != g_pmdt_d_o.pmdt053 OR cl_null(g_pmdt_d_o.pmdt053) THEN
                  IF g_pmdt_d[l_ac].pmdt053 < 0 OR g_pmdt_d[l_ac].pmdt053 > g_pmdt_d[l_ac].pmdt020 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "apm-00745"
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_pmdt_d[l_ac].pmdt053 = g_pmdt_d_o.pmdt053
                     NEXT FIELD CURRENT
                  END IF 
                  #多庫儲批數量確認
                  CALL apmt860_for_apmt860_03()
                  
                  #取得未稅金額、稅額、含稅金額
                  CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                                            g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                                            g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                                            g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
                     RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
               END IF
            END IF
            LET g_pmdt_d_o.pmdt020 = g_pmdt_d[l_ac].pmdt020
            LET g_pmdt_d_o.pmdt053 = g_pmdt_d[l_ac].pmdt053
            LET g_pmdt_d_o.pmdt202 = g_pmdt_d[l_ac].pmdt202
            LET g_pmdt_d_o.pmdt062 = g_pmdt_d[l_ac].pmdt062
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt053
            #add-point:ON CHANGE pmdt053 name="input.g.page1.pmdt053"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt054
            #add-point:BEFORE FIELD pmdt054 name="input.b.page1.pmdt054"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt054
            
            #add-point:AFTER FIELD pmdt054 name="input.a.page1.pmdt054"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt054
            #add-point:ON CHANGE pmdt054 name="input.g.page1.pmdt054"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt055
            #add-point:BEFORE FIELD pmdt055 name="input.b.page1.pmdt055"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt055
            
            #add-point:AFTER FIELD pmdt055 name="input.a.page1.pmdt055"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt055
            #add-point:ON CHANGE pmdt055 name="input.g.page1.pmdt055"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt060
            #add-point:BEFORE FIELD pmdt060 name="input.b.page1.pmdt060"
                                                
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt060
            
            #add-point:AFTER FIELD pmdt060 name="input.a.page1.pmdt060"
                                                
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt060
            #add-point:ON CHANGE pmdt060 name="input.g.page1.pmdt060"
                                                
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt061
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_pmdt_d[l_ac].pmdt061,"0","0","","","azz-00079",1) THEN
               NEXT FIELD pmdt061
            END IF 
 
 
 
            #add-point:AFTER FIELD pmdt061 name="input.a.page1.pmdt061"
                                                
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt061
            #add-point:BEFORE FIELD pmdt061 name="input.b.page1.pmdt061"
                                                
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt061
            #add-point:ON CHANGE pmdt061 name="input.g.page1.pmdt061"
                                                
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt084
            #add-point:BEFORE FIELD pmdt084 name="input.b.page1.pmdt084"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt084
            
            #add-point:AFTER FIELD pmdt084 name="input.a.page1.pmdt084"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt084
            #add-point:ON CHANGE pmdt084 name="input.g.page1.pmdt084"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt219
            #add-point:BEFORE FIELD pmdt219 name="input.b.page1.pmdt219"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt219
            
            #add-point:AFTER FIELD pmdt219 name="input.a.page1.pmdt219"
           
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt219) THEN
               IF g_pmdt_d[l_ac].pmdt219 != g_pmdt_d_o.pmdt219 OR cl_null(g_pmdt_d_o.pmdt219) THEN
                  #IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN   ##150613 by lori mark
                     #150826-00026#13 20150902 s983961--add(s)                 
                     IF (g_pmdt_d[l_ac].pmdt219 > g_today+3650) OR (g_pmdt_d[l_ac].pmdt219 < g_today-3650) THEN        
                        IF (g_pmdt_d[l_ac].pmdt219 > g_today+36500) OR (g_pmdt_d[l_ac].pmdt219 < g_today-36500) THEN        
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = "apm-00995"
                           LET g_errparam.extend = ""
                           LET g_errparam.popup = FALSE
                           CALL cl_err()
                           NEXT FIELD CURRENT
                        ELSE
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = "apm-00995"
                           LET g_errparam.extend = ""
                           LET g_errparam.popup = FALSE
                           CALL cl_err()
                           LET g_pmdt_d_o.pmdt219 = g_pmdt_d[l_ac].pmdt219
                           NEXT FIELD CURRENT
                        END IF
                     END IF  
                     #150826-00026#13 20150902 s983961--add(e)     
                     IF cl_null(g_pmdt_d[l_ac].pmdt089) THEN   #160615-00028#3 Add By Ken 160623 加上 有效日期為空時才用製造日期往後推算
                        LET l_success = ''
                        LET l_pmdt089 = ''
                        CALL s_lot_out_effdate(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                                               g_pmdt_d[l_ac].pmdt219,  g_pmdt_d[l_ac].pmdt018)
                        RETURNING l_success,l_pmdt089
                        IF l_success THEN
                           LET g_pmdt_d[l_ac].pmdt089 = l_pmdt089
                        END IF
                     END IF                                    #160615-00028#3 Add By Ken 160623 加上 有效日期為空時才用製造日期往後推算
                  #END IF                                        ##150613 by lori mark
               END IF
            END IF
            LET g_pmdt_d_o.pmdt219 = g_pmdt_d[l_ac].pmdt219
            LET g_pmdt_d_o.pmdt089 = g_pmdt_d[l_ac].pmdt089
            CALL apmt860_set_entry_b(l_cmd)
            CALL apmt860_set_no_required_b()
            CALL apmt860_set_required_b()
            CALL apmt860_set_no_entry_b(l_cmd)
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt219
            #add-point:ON CHANGE pmdt219 name="input.g.page1.pmdt219"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt089
            #add-point:BEFORE FIELD pmdt089 name="input.b.page1.pmdt089"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt089
            
            #add-point:AFTER FIELD pmdt089 name="input.a.page1.pmdt089"
            #150826-00026#13 20150902 s983961--add(s)                 
            IF NOT cl_null(g_pmdt_d[l_ac].pmdt089) THEN
               IF g_pmdt_d[l_ac].pmdt089 != g_pmdt_d_o.pmdt089 OR cl_null(g_pmdt_d_o.pmdt089) THEN  
                  IF (g_pmdt_d[l_ac].pmdt089 > g_today+3650) OR (g_pmdt_d[l_ac].pmdt089 < g_today-3650) THEN        
                     IF (g_pmdt_d[l_ac].pmdt089 > g_today+36500) OR (g_pmdt_d[l_ac].pmdt089 < g_today-36500) THEN        
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = "apm-00995"
                        LET g_errparam.extend = ""
                        LET g_errparam.popup = FALSE
                        CALL cl_err()
                        NEXT FIELD CURRENT
                     ELSE 
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = "apm-00995"
                        LET g_errparam.extend = ""
                        LET g_errparam.popup = FALSE
                        CALL cl_err()
                        LET g_pmdt_d_o.pmdt089 = g_pmdt_d[l_ac].pmdt089
                     NEXT FIELD CURRENT
                     END IF
                  END IF
                  #160615-00028#3 Add By ken 160623(S)
                  IF cl_null(g_pmdt_d[l_ac].pmdt219) THEN
                     CALL s_apmt860_pmdt219_get(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                                               g_pmdt_d[l_ac].pmdt089,  g_pmdt_d[l_ac].pmdt018)
                        RETURNING l_success,l_pmdt219
                     IF l_success THEN
                        LET g_pmdt_d[l_ac].pmdt219 = l_pmdt219
                     END IF
                  END IF
                  #160615-00028#3 Add By ken 160623(E)
               END IF
            END IF               
            LET g_pmdt_d_o.pmdt089 = g_pmdt_d[l_ac].pmdt089
            #150826-00026#13 20150902 s983961--add(e)    
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt089
            #add-point:ON CHANGE pmdt089 name="input.g.page1.pmdt089"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD pmdt088
            #add-point:BEFORE FIELD pmdt088 name="input.b.page1.pmdt088"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD pmdt088
            
            #add-point:AFTER FIELD pmdt088 name="input.a.page1.pmdt088"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE pmdt088
            #add-point:ON CHANGE pmdt088 name="input.g.page1.pmdt088"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page1.pmdtsite
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtsite
            #add-point:ON ACTION controlp INFIELD pmdtsite name="input.c.page1.pmdtsite"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdtseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtseq
            #add-point:ON ACTION controlp INFIELD pmdtseq name="input.c.page1.pmdtseq"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt206
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt206
            #add-point:ON ACTION controlp INFIELD pmdt206 name="input.c.page1.pmdt206"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt207
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt207
            #add-point:ON ACTION controlp INFIELD pmdt207 name="input.c.page1.pmdt207"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt027
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt027
            #add-point:ON ACTION controlp INFIELD pmdt027 name="input.c.page1.pmdt027"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt027             #給予default值
            
            #驗退、入庫、倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[56]' THEN
               LET g_qryparam.arg1 = "('1','2')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            #倉退時開窗開收貨單號
            IF g_argv[1] MATCHES '[7]' THEN
               LET g_qryparam.arg1 = "('1','2','3','4')"
               CALL q_pmdsdocno()                           #呼叫開窗
            END IF
            
            LET g_pmdt_d[l_ac].pmdt027 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt027 TO pmdt027              #顯示到畫面上

            NEXT FIELD pmdt027                          #返回原欄位

            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt028
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt028
            #add-point:ON ACTION controlp INFIELD pmdt028 name="input.c.page1.pmdt028"
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt028             #給予default值
            
            #驗退、入庫、倉退時開窗開收貨單號對應的項次
            IF g_argv[1] MATCHES '[567]' THEN
               LET g_qryparam.arg1 = g_pmds_m.pmds006
               CALL q_pmdtseq()                           #呼叫開窗
               LET g_pmdt_d[l_ac].pmdt028 = g_qryparam.return1              #將開窗取得的值回傳到變數
               DISPLAY g_pmdt_d[l_ac].pmdt028 TO pmdt028              #顯示到畫面上
            END IF
            
            NEXT FIELD pmdt028                          #返回原欄位
                               
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt216
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt216
            #add-point:ON ACTION controlp INFIELD pmdt216 name="input.c.page1.pmdt216"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt217
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt217
            #add-point:ON ACTION controlp INFIELD pmdt217 name="input.c.page1.pmdt217"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt001
            #add-point:ON ACTION controlp INFIELD pmdt001 name="input.c.page1.pmdt001"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt001
            
			   LET l_where = " 1=1"
			   
			   #採購供應商
			   IF NOT cl_null(g_pmds_m.pmds007) THEN
			      LET l_where = l_where," AND pmdl004 = '",g_pmds_m.pmds007,"'"
			   END IF
			   
			   #帳款供應商
			   IF NOT cl_null(g_pmds_m.pmds008) THEN
			      LET l_where = l_where," AND pmdl021 = '",g_pmds_m.pmds008,"'"
			   END IF
			   
			   #代送商
			   IF NOT cl_null(g_pmds_m.pmds009) THEN
			      LET l_where = l_where," AND pmdl022 = '",g_pmds_m.pmds009,"'"
			   END IF
			   
            #採購收貨時開窗開採購單號
			   IF g_argv[1] MATCHES '[3]' THEN
			      LET l_where = l_where," AND pmdn052 = 'N'"
            END IF
            LET g_qryparam.where = l_where
            CALL q_pmdldocno_8()
            LET g_pmdt_d[l_ac].pmdt001 = g_qryparam.return1
            DISPLAY g_pmdt_d[l_ac].pmdt001 TO pmdt001
            NEXT FIELD pmdt001
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt002
            #add-point:ON ACTION controlp INFIELD pmdt002 name="input.c.page1.pmdt002"
			   
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt003
            #add-point:ON ACTION controlp INFIELD pmdt003 name="input.c.page1.pmdt003"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt004
            #add-point:ON ACTION controlp INFIELD pmdt004 name="input.c.page1.pmdt004"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdo001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo001
            #add-point:ON ACTION controlp INFIELD pmdo001 name="input.c.page1.pmdo001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdo002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdo002
            #add-point:ON ACTION controlp INFIELD pmdo002 name="input.c.page1.pmdo002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt005
            #add-point:ON ACTION controlp INFIELD pmdt005 name="input.c.page1.pmdt005"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt200
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt200
            #add-point:ON ACTION controlp INFIELD pmdt200 name="input.c.page1.pmdt200"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt200
            
            #給予arg
            LET g_qryparam.where = " EXISTS (SELECT 1 FROM rtdx_t,imaf_t",
                                   "          WHERE rtdxent = ",g_enterprise,
                                   "            AND rtdxsite = '",g_pmdt_d[l_ac].pmdtsite,"'",
                                   "            AND rtdx001 = imaa001",
                                   "            AND rtdxstus = 'Y'",
                                   "            AND imafent = rtdxent",
                                   "            AND imafsite = rtdxsite",
                                   "            AND imaf001 = rtdx001",
                                   "            AND imafstus = 'Y'",
                                   "            AND imaf153 = '",g_pmds_m.pmds007,"')"
            IF g_argv[1] = '4' OR g_argv[1] = '22' THEN   #add by yangxf g_argv[1] = '22'
               LET g_qryparam.where = g_qryparam.where,
                                      " AND EXISTS(SELECT 1 FROM rtax_t",
                                      "             WHERE rtaxent = ",g_enterprise,
                                      "               AND rtax001 = imaa009",
                                      "               AND rtaxstus = 'Y'",
                                      "               AND rtax009 = 'N')"
            END IF
            CALL q_imay003_6()
            LET g_pmdt_d[l_ac].pmdt200 = g_qryparam.return1
            DISPLAY g_pmdt_d[l_ac].pmdt200 TO pmdt200
            NEXT FIELD pmdt200
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt006
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt006
            #add-point:ON ACTION controlp INFIELD pmdt006 name="input.c.page1.pmdt006"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt006
            
            #給予arg
            LET g_qryparam.arg1 = 'ALL'
            LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdtsite
            LET g_qryparam.arg3 = g_pmds_m.pmds007
            LET l_where = ''
            IF g_argv[1] = '4' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1] = '22'
               LET l_where = l_where,
                             " EXISTS(SELECT 1 FROM rtax_t",
                             "         WHERE rtaxent = ",g_enterprise,
                             "           AND rtax001 = imaa009",
                             "           AND rtaxstus = 'Y'",
                             "           AND rtax009 = 'N')"
            END IF
            LET g_qryparam.where = l_where
            CALL q_imaf001_19()
            LET g_pmdt_d[l_ac].pmdt006 = g_qryparam.return1
            DISPLAY g_pmdt_d[l_ac].pmdt006 TO pmdt006
            CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006) RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
            NEXT FIELD pmdt006
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt007
            #add-point:ON ACTION controlp INFIELD pmdt007 name="input.c.page1.pmdt007"
            LET l_imaa005 = ''
            CALL apmt860_get_imaa005(g_pmdt_d[l_ac].pmdt006)
               RETURNING l_imaa005
               
            IF NOT cl_null(l_imaa005) THEN
               IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN  #無採購(來源)單據時，和正常新增一樣  #add by yangxf g_argv[1] = '22'
                  IF l_cmd = 'a' THEN            
                     CALL l_inam.clear()            
                     CALL s_feature(l_cmd,g_pmdt_d[l_ac].pmdt006,'','',g_site,g_pmds_m.pmdsdocno)
                        RETURNING l_success,l_inam
                     LET g_pmdt_d[l_ac].pmdt007 = l_inam[1].inam002
                     LET g_pmdt_d[l_ac].pmdt020 = l_inam[1].inam004
                     DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt020
                     
                  END IF
               ELSE
                  CALL s_feature_single(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_site,g_pmds_m.pmdsdocno)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt007
                  CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007
               END IF
               
               IF l_cmd = 'u' THEN
                  CALL s_feature_single(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,g_site,g_pmds_m.pmdsdocno)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt007
                  CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007) RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007_desc
                  DISPLAY BY NAME g_pmdt_d[l_ac].pmdt007
               END IF
            END IF                                       
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt025
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt025
            #add-point:ON ACTION controlp INFIELD pmdt025 name="input.c.page1.pmdt025"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt227
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt227
            #add-point:ON ACTION controlp INFIELD pmdt227 name="input.c.page1.pmdt227"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt201
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt201
            #add-point:ON ACTION controlp INFIELD pmdt201 name="input.c.page1.pmdt201"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt202
            #add-point:ON ACTION controlp INFIELD pmdt202 name="input.c.page1.pmdt202"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt019
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt019
            #add-point:ON ACTION controlp INFIELD pmdt019 name="input.c.page1.pmdt019"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt019
            
            #給予arg
            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
            CALL q_imao002()
            LET g_pmdt_d[l_ac].pmdt019 = g_qryparam.return1
            DISPLAY g_pmdt_d[l_ac].pmdt019 TO pmdt019
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
            NEXT FIELD pmdt019
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt020
            #add-point:ON ACTION controlp INFIELD pmdt020 name="input.c.page1.pmdt020"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt023
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt023
            #add-point:ON ACTION controlp INFIELD pmdt023 name="input.c.page1.pmdt023"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt023
            
            #給予arg
            LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt006
            CALL q_imao002()
            LET g_pmdt_d[l_ac].pmdt023 = g_qryparam.return1
            DISPLAY g_pmdt_d[l_ac].pmdt023 TO pmdt023
            CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
            NEXT FIELD pmdt023
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt024
            #add-point:ON ACTION controlp INFIELD pmdt024 name="input.c.page1.pmdt024"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt036
            #add-point:ON ACTION controlp INFIELD pmdt036 name="input.c.page1.pmdt036"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt218
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt218
            #add-point:ON ACTION controlp INFIELD pmdt218 name="input.c.page1.pmdt218"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt044
            #add-point:ON ACTION controlp INFIELD pmdt044 name="input.c.page1.pmdt044"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt046
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt046
            #add-point:ON ACTION controlp INFIELD pmdt046 name="input.c.page1.pmdt046"
                                                #此段落由子樣板a07產生            
            #開窗i段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt046             #給予default值

            #給予arg

            CALL q_oodb002_2()                                #呼叫開窗

            LET g_pmdt_d[l_ac].pmdt046 = g_qryparam.return1              #將開窗取得的值回傳到變數

            DISPLAY g_pmdt_d[l_ac].pmdt046 TO pmdt046              #顯示到畫面上

            NEXT FIELD pmdt046                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt037
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt037
            #add-point:ON ACTION controlp INFIELD pmdt037 name="input.c.page1.pmdt037"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt038
            #add-point:ON ACTION controlp INFIELD pmdt038 name="input.c.page1.pmdt038"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt039
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt039
            #add-point:ON ACTION controlp INFIELD pmdt039 name="input.c.page1.pmdt039"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt047
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt047
            #add-point:ON ACTION controlp INFIELD pmdt047 name="input.c.page1.pmdt047"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt026
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt026
            #add-point:ON ACTION controlp INFIELD pmdt026 name="input.c.page1.pmdt026"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt062
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt062
            #add-point:ON ACTION controlp INFIELD pmdt062 name="input.c.page1.pmdt062"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt016
            #add-point:ON ACTION controlp INFIELD pmdt016 name="input.c.page1.pmdt016"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt016
            
            #150617-00021#1 151214 By pomelo add(S)
            LET l_success = ''
            LET l_set_entry = ''
            IF g_argv[1] = '7' AND NOT cl_null(g_pmdt_d[l_ac].pmdt006) THEN
               CALL s_lot_out_entry('-1',g_pmds_m.pmdsdocno,g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt006) 
                  RETURNING l_success,l_set_entry
               
               LET l_success = ''
               IF NOT apmt860_chk_lot(p_cmd) AND NOT l_set_entry THEN
                  LET l_success = TRUE
               ELSE
                  LET l_success = FALSE
               END IF
            END IF
            #150617-00021#1 151214 By pomelo add(E)
            
            #給予arg
            #倉退時，開庫存檔
            #IF g_argv[1] = '7' THEN   #150617-00021#1 151214 By pomelo mark
            IF NOT l_success THEN      #150617-00021#1 151214 By pomelo add
               LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.default3 = g_pmdt_d[l_ac].pmdt018
               LET g_qryparam.default4 = g_pmdt_d[l_ac].pmdt063
               LET g_qryparam.arg1 = g_pmds_m.pmdssite        #營運據點
               LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdt006   #商品編號
               #產品特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               LET g_qryparam.arg3 = g_pmdt_d[l_ac].pmdt007
               
               #庫存管理特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_qryparam.arg4 = ''
               ELSE
                  LET g_qryparam.arg4 = g_pmdt_d[l_ac].pmdt063
               END IF
               LET g_qryparam.arg5 = ''   #庫位               
               #儲位
               IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET g_qryparam.arg6 = ''
               ELSE
                  LET g_qryparam.arg6 = g_pmdt_d[l_ac].pmdt017
               END IF
               
               #批號
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_qryparam.arg7 = ''
               ELSE
                  LET g_qryparam.arg7 = g_pmdt_d[l_ac].pmdt018
               END IF
               
               LET g_qryparam.where = s_inaa_ctrlp(g_pmdt_d[l_ac].pmdt210)    #150518-00001#3--add by dongsz
               CALL q_inag004_19()
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1   #庫位
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return2   #儲位
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return3   #批號
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return4   #庫存管理特徵
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063
            ELSE
               LET g_qryparam.where = s_inaa_ctrlp(g_pmdt_d[l_ac].pmdt210)    #150518-00001#3--add by dongsz
               CALL q_inaa001_15()
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016
            END IF
            #庫位
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING g_pmdt_d[l_ac].pmdt016_desc
            #儲位
            CALL s_desc_get_locator_desc(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING g_pmdt_d[l_ac].pmdt017_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc,g_pmdt_d[l_ac].pmdt017_desc
            NEXT FIELD pmdt016
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt017
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt017
            #add-point:ON ACTION controlp INFIELD pmdt017 name="input.c.page1.pmdt017"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            
            #倉退時，開庫存檔
            IF g_argv[1] = '7' THEN
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt016
               LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.default3 = g_pmdt_d[l_ac].pmdt018
               LET g_qryparam.default4 = g_pmdt_d[l_ac].pmdt063
               LET g_qryparam.arg1 = g_pmds_m.pmdssite        #營運據點
               LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdt006   #商品編號
               #產品特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               LET g_qryparam.arg3 = g_pmdt_d[l_ac].pmdt007
               
               #庫存管理特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_qryparam.arg4 = ''
               ELSE
                  LET g_qryparam.arg4 = g_pmdt_d[l_ac].pmdt063
               END IF
               
               LET g_qryparam.arg5 = g_pmdt_d[l_ac].pmdt016   #庫位
               LET g_qryparam.arg6 = ''   #儲位
               #批號
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_qryparam.arg7 = ''
               ELSE
                  LET g_qryparam.arg7 = g_pmdt_d[l_ac].pmdt018
               END IF               
               CALL q_inag004_19()
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1   #庫位
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return2   #儲位
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return3   #批號
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return4   #庫存管理特徵
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063
            ELSE
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.arg1 = g_pmdt_d[l_ac].pmdt016
               CALL q_inab002_3()
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return1
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017
            END IF
            #庫位
            CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
               RETURNING g_pmdt_d[l_ac].pmdt016_desc
            #儲位
            CALL s_desc_get_locator_desc(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING g_pmdt_d[l_ac].pmdt017_desc
            DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc,g_pmdt_d[l_ac].pmdt017_desc
            NEXT FIELD pmdt017
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt018
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt018
            #add-point:ON ACTION controlp INFIELD pmdt018 name="input.c.page1.pmdt018"
            #此段落由子樣板a07產生            
            #開窗i段
            
            #倉退時，開庫存檔的窗
            IF g_argv[1] = '7' THEN
			      INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
			      LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt016
               LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.default3 = g_pmdt_d[l_ac].pmdt018
               LET g_qryparam.default4 = g_pmdt_d[l_ac].pmdt063
               LET g_qryparam.arg1 = g_pmds_m.pmdssite        #營運據點
               LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdt006   #商品編號
               #產品特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               LET g_qryparam.arg3 = g_pmdt_d[l_ac].pmdt007
               
               #庫存管理特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_qryparam.arg4 = ''
               ELSE
                  LET g_qryparam.arg4 = g_pmdt_d[l_ac].pmdt063
               END IF
               
               LET g_qryparam.arg5 = g_pmdt_d[l_ac].pmdt016   #庫位
               #儲位
               IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET g_qryparam.arg6 = ''
               ELSE
                  LET g_qryparam.arg6 = g_pmdt_d[l_ac].pmdt017
               END IF
               
               #批號
               LET g_qryparam.arg7 = ''
               CALL q_inag004_19()
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1   #庫位
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return2   #儲位
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return3   #批號
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return4   #庫存管理特徵
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063
               #庫位
               CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
                  RETURNING g_pmdt_d[l_ac].pmdt016_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
               #儲位
               CALL s_desc_get_locator_desc(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
                  RETURNING g_pmdt_d[l_ac].pmdt017_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            END IF
            NEXT FIELD pmdt018
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt063
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt063
            #add-point:ON ACTION controlp INFIELD pmdt063 name="input.c.page1.pmdt063"
            #倉退時，開庫存檔的窗
            IF g_argv[1] = '7' THEN
			      INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
			      LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt016
               LET g_qryparam.default2 = g_pmdt_d[l_ac].pmdt017
               LET g_qryparam.default3 = g_pmdt_d[l_ac].pmdt018
               LET g_qryparam.default4 = g_pmdt_d[l_ac].pmdt063
               LET g_qryparam.arg1 = g_pmds_m.pmdssite        #營運據點
               LET g_qryparam.arg2 = g_pmdt_d[l_ac].pmdt006   #商品編號
               #產品特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               LET g_qryparam.arg3 = g_pmdt_d[l_ac].pmdt007
               
               #庫存管理特徵
               LET g_qryparam.arg4 = ''
               
               LET g_qryparam.arg5 = g_pmdt_d[l_ac].pmdt016   #庫位
               #儲位
               IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET g_qryparam.arg6 = ''
               ELSE
                  LET g_qryparam.arg6 = g_pmdt_d[l_ac].pmdt017
               END IF
               
               #批號
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_qryparam.arg7 = ''
               ELSE
                  LET g_qryparam.arg7 = g_pmdt_d[l_ac].pmdt018
               END IF  
               CALL q_inag004_19()
               LET g_pmdt_d[l_ac].pmdt016 = g_qryparam.return1   #庫位
               LET g_pmdt_d[l_ac].pmdt017 = g_qryparam.return2   #儲位
               LET g_pmdt_d[l_ac].pmdt018 = g_qryparam.return3   #批號
               LET g_pmdt_d[l_ac].pmdt063 = g_qryparam.return4   #庫存管理特徵
               DISPLAY g_pmdt_d[l_ac].pmdt016 TO pmdt016
               DISPLAY g_pmdt_d[l_ac].pmdt017 TO pmdt017
               DISPLAY g_pmdt_d[l_ac].pmdt018 TO pmdt018
               DISPLAY g_pmdt_d[l_ac].pmdt063 TO pmdt063
               #庫位
               CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
                  RETURNING g_pmdt_d[l_ac].pmdt016_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt016_desc
               #儲位
               CALL s_desc_get_locator_desc(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
                  RETURNING g_pmdt_d[l_ac].pmdt017_desc
               DISPLAY BY NAME g_pmdt_d[l_ac].pmdt017_desc
            END IF
            NEXT FIELD pmdt063
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt052
            #add-point:ON ACTION controlp INFIELD pmdt052 name="input.c.page1.pmdt052"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt051
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt051
            #add-point:ON ACTION controlp INFIELD pmdt051 name="input.c.page1.pmdt051"
            #此段落由子樣板a07產生            
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		   	LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_pmdt_d[l_ac].pmdt051
            
            #給予arg
            LET g_qryparam.arg1 = l_acc
            CALL q_oocq002()
            LET g_pmdt_d[l_ac].pmdt051 = g_qryparam.return1
            DISPLAY g_pmdt_d[l_ac].pmdt051 TO pmdt051
            CALL s_desc_get_acc_desc(l_acc,g_pmdt_d[l_ac].pmdt051)
               RETURNING g_pmdt_d[l_ac].pmdt051_desc
            NEXT FIELD pmdt051
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt059
            #add-point:ON ACTION controlp INFIELD pmdt059 name="input.c.page1.pmdt059"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt203
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt203
            #add-point:ON ACTION controlp INFIELD pmdt203 name="input.c.page1.pmdt203"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt204
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt204
            #add-point:ON ACTION controlp INFIELD pmdt204 name="input.c.page1.pmdt204"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt205
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt205
            #add-point:ON ACTION controlp INFIELD pmdt205 name="input.c.page1.pmdt205"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt214
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt214
            #add-point:ON ACTION controlp INFIELD pmdt214 name="input.c.page1.pmdt214"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt215
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt215
            #add-point:ON ACTION controlp INFIELD pmdt215 name="input.c.page1.pmdt215"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt208
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt208
            #add-point:ON ACTION controlp INFIELD pmdt208 name="input.c.page1.pmdt208"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt209
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt209
            #add-point:ON ACTION controlp INFIELD pmdt209 name="input.c.page1.pmdt209"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt210
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt210
            #add-point:ON ACTION controlp INFIELD pmdt210 name="input.c.page1.pmdt210"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt211
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt211
            #add-point:ON ACTION controlp INFIELD pmdt211 name="input.c.page1.pmdt211"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt212
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt212
            #add-point:ON ACTION controlp INFIELD pmdt212 name="input.c.page1.pmdt212"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt213
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt213
            #add-point:ON ACTION controlp INFIELD pmdt213 name="input.c.page1.pmdt213"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdtorga
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdtorga
            #add-point:ON ACTION controlp INFIELD pmdtorga name="input.c.page1.pmdtorga"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt053
            #add-point:ON ACTION controlp INFIELD pmdt053 name="input.c.page1.pmdt053"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt054
            #add-point:ON ACTION controlp INFIELD pmdt054 name="input.c.page1.pmdt054"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt055
            #add-point:ON ACTION controlp INFIELD pmdt055 name="input.c.page1.pmdt055"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt060
            #add-point:ON ACTION controlp INFIELD pmdt060 name="input.c.page1.pmdt060"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt061
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt061
            #add-point:ON ACTION controlp INFIELD pmdt061 name="input.c.page1.pmdt061"
                                                
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt084
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt084
            #add-point:ON ACTION controlp INFIELD pmdt084 name="input.c.page1.pmdt084"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt219
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt219
            #add-point:ON ACTION controlp INFIELD pmdt219 name="input.c.page1.pmdt219"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt089
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt089
            #add-point:ON ACTION controlp INFIELD pmdt089 name="input.c.page1.pmdt089"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.pmdt088
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD pmdt088
            #add-point:ON ACTION controlp INFIELD pmdt088 name="input.c.page1.pmdt088"
            
            #END add-point
 
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code = 9001 
               LET g_errparam.popup = FALSE 
               CLOSE apmt860_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = g_pmdt_d[l_ac].pmdtseq 
               LET g_errparam.code = -263 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
            ELSE
            
               #add-point:單身修改前 name="input.body.b_update"
               #產品特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
                  LET g_pmdt_d[l_ac].pmdt007 = ' '
               END IF
               #儲位
               IF cl_null(g_pmdt_d[l_ac].pmdt017) THEN
                  LET g_pmdt_d[l_ac].pmdt017 = ' '
               END IF
               #批號
               IF cl_null(g_pmdt_d[l_ac].pmdt018) THEN
                  LET g_pmdt_d[l_ac].pmdt018 = ' '
               END IF
               
               #批號
               #151012-00002#1 151012 By pomelo add(S)
               IF g_argv[1] MATCHES '[1234]' AND cl_null(g_pmdt_d[l_ac].pmdt018) AND
                  g_pmdt_d[l_ac].pmdt062 = 'N'THEN
                  LET l_success = ''
                  CALL s_lot_out_get_batch_no(g_pmdt_d[l_ac].pmdt006)
                     RETURNING l_success,g_pmdt_d[l_ac].pmdt018
                  IF l_success = FALSE THEN
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               #151012-00002#1 151012 By pomelo add(E)
               
               #庫存管理特徵
               IF cl_null(g_pmdt_d[l_ac].pmdt063) THEN
                  LET g_pmdt_d[l_ac].pmdt063 = ' '
               END IF
               #end add-point
               
               #寫入修改者/修改日期資訊(單身)
               
      
               #將遮罩欄位還原
               CALL apmt860_pmdt_t_mask_restore('restore_mask_o')
      
               UPDATE pmdt_t SET (pmdtdocno,pmdtsite,pmdtseq,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216, 
                   pmdt217,pmdt001,pmdt002,pmdt003,pmdt004,pmdt221,pmdt005,pmdt200,pmdt006,pmdt220,pmdt007, 
                   pmdt025,pmdt227,pmdt201,pmdt202,pmdt019,pmdt020,pmdt023,pmdt024,pmdt036,pmdt218,pmdt044, 
                   pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063, 
                   pmdt052,pmdt051,pmdt059,pmdt203,pmdt204,pmdt205,pmdt214,pmdt215,pmdt208,pmdt209,pmdt210, 
                   pmdt211,pmdt212,pmdt213,pmdtorga,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt084, 
                   pmdt219,pmdt089,pmdt088) = (g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq, 
                   g_pmdt_d[l_ac].pmdt206,g_pmdt_d[l_ac].pmdt207,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028, 
                   g_pmdt_d[l_ac].pmdt216,g_pmdt_d[l_ac].pmdt217,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002, 
                   g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt221,g_pmdt_d[l_ac].pmdt005, 
                   g_pmdt_d[l_ac].pmdt200,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt220,g_pmdt_d[l_ac].pmdt007, 
                   g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt227,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt202, 
                   g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024, 
                   g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt218,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt046, 
                   g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047, 
                   g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017, 
                   g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051, 
                   g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt203,g_pmdt_d[l_ac].pmdt204,g_pmdt_d[l_ac].pmdt205, 
                   g_pmdt_d[l_ac].pmdt214,g_pmdt_d[l_ac].pmdt215,g_pmdt_d[l_ac].pmdt208,g_pmdt_d[l_ac].pmdt209, 
                   g_pmdt_d[l_ac].pmdt210,g_pmdt_d[l_ac].pmdt211,g_pmdt_d[l_ac].pmdt212,g_pmdt_d[l_ac].pmdt213, 
                   g_pmdt_d[l_ac].pmdtorga,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055, 
                   g_pmdt_d[l_ac].pmdt060,g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt084,g_pmdt_d[l_ac].pmdt219, 
                   g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt088)
                WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno 
 
                  AND pmdtseq = g_pmdt_d_t.pmdtseq #項次   
 
                  
               #add-point:單身修改中 name="input.body.m_update"
                                                            
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdt_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.SQLCODE #其他錯誤
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*  
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()                   
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_pmds_m.pmdsdocno
               LET gs_keys_bak[1] = g_pmdsdocno_t
               LET gs_keys[2] = g_pmdt_d[g_detail_idx].pmdtseq
               LET gs_keys_bak[2] = g_pmdt_d_t.pmdtseq
               CALL apmt860_update_b('pmdt_t',gs_keys,gs_keys_bak,"'1'")
               END CASE
 
               #將遮罩欄位進行遮蔽
               CALL apmt860_pmdt_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT(g_pmdt_d[g_detail_idx].pmdtseq = g_pmdt_d_t.pmdtseq 
 
                  ) THEN
                  LET gs_keys[01] = g_pmds_m.pmdsdocno
 
                  LET gs_keys[gs_keys.getLength()+1] = g_pmdt_d_t.pmdtseq
 
                  CALL apmt860_key_update_b(gs_keys,'pmdt_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_pmds_m),util.JSON.stringify(g_pmdt_d_t)
               LET g_log2 = util.JSON.stringify(g_pmds_m),util.JSON.stringify(g_pmdt_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身修改後 name="input.body.a_update"
               #產生原始需求分配明細
               IF NOT s_apmt860_gen_pmdv(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq) THEN
                  CALL s_transaction_end('N','0')
               END IF
               
               #多庫儲批由'Y' 改成'N' 或 商品編號有修改，則須新增一筆資料到多庫儲批單身
               IF (g_pmdt_d[l_ac].pmdt062 != g_pmdt_d_t.pmdt062 AND
                  g_pmdt_d[l_ac].pmdt062 = 'N') OR
                  (g_pmdt_d[l_ac].pmdt006 != g_pmdt_d_t.pmdt006)THEN
                  IF NOT s_apmt860_ins_pmdu(g_pmds_m.pmds000,      g_pmds_m.pmdsdocno,    g_pmdt_d[l_ac].pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                                            g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                                            g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,
                                            g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt027,
                                            g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,
                                            g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt063,
                                            g_pmdt_d[l_ac].pmdt088,g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt201,
                                            g_pmdt_d[l_ac].pmdt202,g_pmdt_d[l_ac].pmdt219) THEN
                     LET g_pmdt_d[l_ac].* = g_pmdt_d_t.*                     
                     CALL s_transaction_end('N','0')
                  END IF
               ELSE
                  #多庫儲批為'N'，則更新相關欄位
                  IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
                     UPDATE pmdu_t SET pmduseq = g_pmdt_d[l_ac].pmdtseq,
                                       pmdu001 = g_pmdt_d[l_ac].pmdt006,
                                       pmdu002 = g_pmdt_d[l_ac].pmdt007,
                                       pmdu005 = g_pmdt_d[l_ac].pmdt063,
                                       pmdu006 = g_pmdt_d[l_ac].pmdt016,
                                       pmdu007 = g_pmdt_d[l_ac].pmdt017,
                                       pmdu008 = g_pmdt_d[l_ac].pmdt018,
                                       pmdu009 = g_pmdt_d[l_ac].pmdt019,
                                       pmdu010 = g_pmdt_d[l_ac].pmdt020,
                                       pmdu013 = g_pmdt_d[l_ac].pmdt053,
                                       pmdu016 = g_pmdt_d[l_ac].pmdt088,
                                       pmdu017 = g_pmdt_d[l_ac].pmdt089,
                                       pmdu201 = g_pmdt_d[l_ac].pmdt202,
                                       pmdu202 = g_pmdt_d[l_ac].pmdt219
                      WHERE pmduent = g_enterprise
                        AND pmdudocno = g_pmds_m.pmdsdocno
                        AND pmduseq = g_pmdt_d_t.pmdtseq
                  ELSE
                     UPDATE pmdu_t SET pmduseq = g_pmdt_d[l_ac].pmdtseq,
                                       pmdu001 = g_pmdt_d[l_ac].pmdt006,
                                       pmdu002 = g_pmdt_d[l_ac].pmdt007
                      WHERE pmduent = g_enterprise
                        AND pmdudocno = g_pmds_m.pmdsdocno
                        AND pmduseq = g_pmdt_d_t.pmdtseq
                     #若有修改到存貨備註時，需開窗詢問是否同步更新[T:多庫儲批明細檔].[C:存貨備註]
                     IF ( (g_pmdt_d[l_ac].pmdt088 != g_pmdt_d_t.pmdt088) OR
                          ( (NOT cl_null(g_pmdt_d[l_ac].pmdt088)) AND cl_null(g_pmdt_d_t.pmdt088) ) OR
                          ( (NOT cl_null(g_pmdt_d_t.pmdt088)) AND cl_null(g_pmdt_d[l_ac].pmdt088) ) ) THEN
                        IF cl_ask_confirm('apm-00645') THEN
                           UPDATE pmdu_t
                              SET pmdu016 = g_pmdt_d[l_ac].pmdt088
                            WHERE pmduent = g_enterprise
                              AND pmdudocno = g_pmds_m.pmdsdocno
                              AND pmduseq = g_pmdt_d_t.pmdtseq     #項次
                        END IF
                     END IF
                  END IF
               END IF
               #CALL apmt860_b_fill()   #151207-00021#6 160106 By pomelo mark
               #end add-point
 
            END IF
            
         AFTER ROW
            #add-point:單身after_row name="input.body.after_row"
                                                
            #end add-point
            CALL apmt860_unlock_b("pmdt_t","'1'")
            CALL s_transaction_end('Y','0')
            #其他table進行unlock
            #add-point:單身after_row2 name="input.body.after_row2"
            
            #end add-point
              
         AFTER INPUT
            #add-point:input段after input  name="input.body.after_input"
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            
            #更新單頭未稅、含稅、稅額
            LET l_success = ''
            CALL s_apmt860_upd_pmds(g_pmds_m.pmdsdocno)
               RETURNING l_success,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
            IF l_success THEN
               CALL s_transaction_end('Y','0')
            ELSE
               CALL s_transaction_end('N','0')
            END IF
            CALL apmt860_b_fill()   #150728-00004#1 20150728 add by beckxie
            #end add-point 
    
         ON ACTION controlo    
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_pmdt_d[li_reproduce_target].* = g_pmdt_d[li_reproduce].*
               LET g_pmdt4_d[li_reproduce_target].* = g_pmdt4_d[li_reproduce].*
 
               LET g_pmdt_d[li_reproduce_target].pmdtseq = NULL
 
            ELSE
               CALL FGL_SET_ARR_CURR(g_pmdt_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_pmdt_d.getLength()+1
            END IF
            
         #ON ACTION cancel
         #   LET INT_FLAG = 1
         #   LET g_detail_idx = 1
         #   EXIT DIALOG 
 
      END INPUT
      
 
      
 
      DISPLAY ARRAY g_pmdt2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt860_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail2")
            LET g_detail_idx = l_ac
            
            #add-point:page2, before row動作 name="input.body2.before_row"
                                                
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail2")
            CALL apmt860_idx_chk()
            LET g_current_page = 2
      
         #add-point:page2自定義行為 name="input.body2.action"
         
         #end add-point
      
      END DISPLAY
      DISPLAY ARRAY g_pmdt3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt860_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            LET g_detail_idx = l_ac
            
            #add-point:page3, before row動作 name="input.body3.before_row"
                                                
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            CALL apmt860_idx_chk()
            LET g_current_page = 3
      
         #add-point:page3自定義行為 name="input.body3.action"
         
         #end add-point
      
      END DISPLAY
      DISPLAY ARRAY g_pmdt4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt860_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail4")
            LET g_detail_idx = l_ac
            
            #add-point:page4, before row動作 name="input.body4.before_row"
            
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'5',"))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail4")
            CALL apmt860_idx_chk()
            LET g_current_page = 4
      
         #add-point:page4自定義行為 name="input.body4.action"
         
         #end add-point
      
      END DISPLAY
      DISPLAY ARRAY g_pmdt5_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b)  
    
         BEFORE ROW
            CALL apmt860_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail5")
            LET g_detail_idx = l_ac
            
            #add-point:page5, before row動作 name="input.body5.before_row"
            
            #end add-point
            
         BEFORE DISPLAY
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue(""))
            END IF
            LET g_loc = 'm'
            LET l_ac = DIALOG.getCurrentRow("s_detail5")
            CALL apmt860_idx_chk()
            LET g_current_page = 5
      
         #add-point:page5自定義行為 name="input.body5.action"
         
         #end add-point
      
      END DISPLAY
 
 
 
{</section>}
 
{<section id="apmt860.input.other" >}
      
      #add-point:自定義input name="input.more_input"
 
      #end add-point
    
      BEFORE DIALOG 
         #CALL cl_err_collect_init()    
         #add-point:input段before dialog name="input.before_dialog"
                          
         #end add-point    
         #重新導回資料到正確位置上
         CALL DIALOG.setCurrentRow("s_detail1",g_idx_group.getValue("'1','4',"))      
         CALL DIALOG.setCurrentRow("s_detail2",g_idx_group.getValue("'2',"))
         CALL DIALOG.setCurrentRow("s_detail3",g_idx_group.getValue("'3',"))
         CALL DIALOG.setCurrentRow("s_detail4",g_idx_group.getValue("'5',"))
         CALL DIALOG.setCurrentRow("s_detail5",g_idx_group.getValue(""))
 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            #add-point:input段next_field name="input.next_field"
            NEXT FIELD pmdssite
            #end add-point  
            NEXT FIELD pmdsdocno
         ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD pmdtsite
               WHEN "s_detail2"
                  NEXT FIELD pmdusite
               WHEN "s_detail3"
                  NEXT FIELD pmdvsite
               WHEN "s_detail4"
                  NEXT FIELD pmdtseq_4
               WHEN "s_detail5"
                  NEXT FIELD xrcdsite
 
               #add-point:input段modify_detail  name="input.modify_detail.other"
               
               #end add-point  
            END CASE
         END IF
      
      AFTER DIALOG
         #add-point:input段after_dialog name="input.after_dialog"
         
         #end add-point    
         
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept  name="input.accept"
         
         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         #add-point:input段cancel name="input.cancel"
         
         #end add-point  
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
         LET g_detail_idx_list[5] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
         CALL g_curr_diag.setCurrentRow("s_detail4",1)
         CALL g_curr_diag.setCurrentRow("s_detail5",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         #add-point:input段close name="input.close"
         
         #end add-point  
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         #add-point:input段exit name="input.exit"
         
         #end add-point
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
         LET g_detail_idx_list[5] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
         CALL g_curr_diag.setCurrentRow("s_detail4",1)
         CALL g_curr_diag.setCurrentRow("s_detail5",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   #add-point:input段after input  name="input.after_input"
   
   #end add-point    
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.show" >}
#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION apmt860_show()
   #add-point:show段define(客製用) name="show.define_customerization"
   
   #end add-point  
   DEFINE l_ac_t    LIKE type_t.num10
   #add-point:show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show.define"
   DEFINE l_success LIKE type_t.num5
   DEFINE l_ooba002 LIKE ooba_t.ooba002
   #end add-point  
   
   #add-point:Function前置處理 name="show.before"
            
   #end add-point
   
   
   
   IF g_bfill = "Y" THEN
      CALL apmt860_b_fill() #單身填充
      CALL apmt860_b_fill2('0') #單身填充
   END IF
     
   #帶出公用欄位reference值
   #應用 a12 樣板自動產生(Version:4)
 
 
 
   
   #顯示followup圖示
   #應用 a48 樣板自動產生(Version:3)
   CALL apmt860_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   CALL apmt860_set_comp_visible('2','u')    #150818-00010#1 150818 By pomelo add
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:show段reference name="show.head.reference"
   #稅別
   CALL s_desc_get_tax_desc1(g_pmds_m.pmdssite,g_pmds_m.pmds033)
      RETURNING g_pmds_m.pmds033_desc
   #end add-point
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt860_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdssite_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003, 
       g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052, 
       g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031, 
       g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds037,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046, 
       g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid, 
       g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid, 
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmds_m.pmdsstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
 
 
 
   
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_pmdt_d.getLength()
      #add-point:show段單身reference name="show.body.reference"
      
      #end add-point
   END FOR
   
   FOR l_ac = 1 TO g_pmdt2_d.getLength()
      #add-point:show段單身reference name="show.body2.reference"
 
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdt3_d.getLength()
      #add-point:show段單身reference name="show.body3.reference"
     
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdt4_d.getLength()
      #add-point:show段單身reference name="show.body4.reference"
      
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_pmdt5_d.getLength()
      #add-point:show段單身reference name="show.body5.reference"
      
      #end add-point
   END FOR
 
   
    
   
   #add-point:show段other name="show.other"
     
   #end add-point  
   
   LET l_ac = l_ac_t
   
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()     
 
   CALL apmt860_detail_show()
 
   #add-point:show段之後 name="show.after"
            
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.detail_show" >}
#+ 第二階單身reference
PRIVATE FUNCTION apmt860_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point  
   #add-point:detail_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
            
   #end add-point  
   
   #add-point:Function前置處理 name="detail_show.before"
            
   #end add-point
   
   #add-point:detail_show段之後 name="detail_show.after"
            
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.reproduce" >}
#+ 資料複製
PRIVATE FUNCTION apmt860_reproduce()
   #add-point:reproduce段define(客製用) name="reproduce.define_customerization"
   
   #end add-point   
   DEFINE l_newno     LIKE pmds_t.pmdsdocno 
   DEFINE l_oldno     LIKE pmds_t.pmdsdocno 
 
   DEFINE l_master    RECORD LIKE pmds_t.* #此變數樣板目前無使用
   DEFINE l_detail    RECORD LIKE pmdt_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE pmdu_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE pmdv_t.* #此變數樣板目前無使用
 
   DEFINE l_detail4    RECORD LIKE xrcd_t.* #此變數樣板目前無使用
 
 
 
   DEFINE l_cnt       LIKE type_t.num10
   #add-point:reproduce段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="reproduce.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="reproduce.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET g_master_insert = FALSE
   
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
    
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
    
   LET g_pmds_m.pmdsdocno = ""
 
 
   CALL cl_set_head_visible("","YES")
 
   #公用欄位給予預設值
   #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_pmds_m.pmdsownid = g_user
      LET g_pmds_m.pmdsowndp = g_dept
      LET g_pmds_m.pmdscrtid = g_user
      LET g_pmds_m.pmdscrtdp = g_dept 
      LET g_pmds_m.pmdscrtdt = cl_get_current()
      LET g_pmds_m.pmdsmodid = g_user
      LET g_pmds_m.pmdsmoddt = cl_get_current()
      LET g_pmds_m.pmdsstus = 'N'
 
 
 
   
   CALL s_transaction_begin()
   
   #add-point:複製輸入前 name="reproduce.head.b_input"
            
   #end add-point
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_pmds_m.pmdsstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
 
 
 
   
   #清空key欄位的desc
   
   
   CALL apmt860_input("r")
   
   IF INT_FLAG AND NOT g_master_insert THEN
      LET INT_FLAG = 0
      DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
      DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
      LET INT_FLAG = 0
      INITIALIZE g_pmds_m.* TO NULL
      INITIALIZE g_pmdt_d TO NULL
      INITIALIZE g_pmdt2_d TO NULL
      INITIALIZE g_pmdt3_d TO NULL
      INITIALIZE g_pmdt4_d TO NULL
      INITIALIZE g_pmdt5_d TO NULL
 
      #add-point:複製取消後 name="reproduce.cancel"
      
      #end add-point
      CALL apmt860_show()
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = '' 
      LET g_errparam.code = 9001 
      LET g_errparam.popup = FALSE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL apmt860_set_act_visible()   
   CALL apmt860_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " pmdsent = " ||g_enterprise|| " AND",
                      " pmdsdocno = '", g_pmds_m.pmdsdocno, "' "
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL apmt860_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   #add-point:完成複製段落後 name="reproduce.after_reproduce"
            
   #end add-point
   
   CALL apmt860_idx_chk()
   
   LET g_data_owner = g_pmds_m.pmdsownid      
   LET g_data_dept  = g_pmds_m.pmdsowndp
   
   #功能已完成,通報訊息中心
   CALL apmt860_msgcentre_notify('reproduce')
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.detail_reproduce" >}
#+ 單身自動複製
PRIVATE FUNCTION apmt860_detail_reproduce()
   #add-point:delete段define(客製用) name="detail_reproduce.define_customerization"
   
   #end add-point    
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE pmdt_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE pmdu_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE pmdv_t.* #此變數樣板目前無使用
 
   DEFINE l_detail4    RECORD LIKE xrcd_t.* #此變數樣板目前無使用
 
 
 
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_reproduce.define"
            
   #end add-point    
   
   #add-point:Function前置處理  name="detail_reproduce.pre_function"
   
   #end add-point
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE apmt860_detail
   
   #add-point:單身複製前1 name="detail_reproduce.body.table1.b_insert"
            
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdt_t
    WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmdsdocno_t
 
    INTO TEMP apmt860_detail
 
   #將key修正為調整後   
   UPDATE apmt860_detail 
      #更新key欄位
      SET pmdtdocno = g_pmds_m.pmdsdocno
 
      #更新共用欄位
      
 
   #add-point:單身修改前 name="detail_reproduce.body.table1.b_update"
   
   #end add-point                                       
  
   #將資料塞回原table   
   INSERT INTO pmdt_t SELECT * FROM apmt860_detail
   
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "reproduce:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE 
      LET g_errparam.popup = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #add-point:單身複製中1 name="detail_reproduce.body.table1.m_insert"
            
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt860_detail
   
   #add-point:單身複製後1 name="detail_reproduce.body.table1.a_insert"
            
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table2.b_insert"
            
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdu_t 
    WHERE pmduent = g_enterprise AND pmdudocno = g_pmdsdocno_t
 
    INTO TEMP apmt860_detail
 
   #將key修正為調整後   
   UPDATE apmt860_detail SET pmdudocno = g_pmds_m.pmdsdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table2.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdu_t SELECT * FROM apmt860_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table2.m_insert"
            
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt860_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table2.a_insert"
            
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table3.b_insert"
            
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM pmdv_t 
    WHERE pmdvent = g_enterprise AND pmdvdocno = g_pmdsdocno_t
 
    INTO TEMP apmt860_detail
 
   #將key修正為調整後   
   UPDATE apmt860_detail SET pmdvdocno = g_pmds_m.pmdsdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table3.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO pmdv_t SELECT * FROM apmt860_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table3.m_insert"
            
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt860_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table3.a_insert"
            
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table4.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM xrcd_t 
    WHERE xrcdent = g_enterprise AND xrcddocno = g_pmdsdocno_t
 
    INTO TEMP apmt860_detail
 
   #將key修正為調整後   
   UPDATE apmt860_detail SET xrcddocno = g_pmds_m.pmdsdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table4.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO xrcd_t SELECT * FROM apmt860_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table4.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE apmt860_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table4.a_insert"
   
   #end add-point
 
 
   
 
   
   #多語言複製段落
   
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.delete" >}
#+ 資料刪除
PRIVATE FUNCTION apmt860_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"
   
   #end add-point     
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
            
   #end add-point     
   
   #add-point:Function前置處理  name="delete.pre_function"
   
   #end add-point
   
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code = "std-00003" 
      LET g_errparam.popup = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   
   
   CALL s_transaction_begin()
 
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF SQLCA.SQLCODE THEN   #(ver:78)
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt860_cl:",SQLERRMESSAGE 
      LET g_errparam.code = SQLCA.SQLCODE   #(ver:78)
      LET g_errparam.popup = TRUE 
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
       g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
       g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
       g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
       g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc 
 
   
   
   #檢查是否允許此動作
   IF NOT apmt860_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_pmds_m_mask_o.* =  g_pmds_m.*
   CALL apmt860_pmds_t_mask()
   LET g_pmds_m_mask_n.* =  g_pmds_m.*
   
   CALL apmt860_show()
   
   #add-point:delete段before ask name="delete.before_ask"
   
   #end add-point 
 
   IF cl_ask_del_master() THEN              #確認一下
   
      #add-point:單頭刪除前 name="delete.head.b_delete"
                        
      #end add-point   
      
      #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL apmt860_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
  
  
      #資料備份
      LET g_pmdsdocno_t = g_pmds_m.pmdsdocno
 
 
      DELETE FROM pmds_t
       WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
 
       
      #add-point:單頭刪除中 name="delete.head.m_delete"
                        
      #end add-point
       
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_pmds_m.pmdsdocno,":",SQLERRMESSAGE  
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF
      
      #add-point:單頭刪除後 name="delete.head.a_delete"
      IF NOT s_aooi200_del_docno(g_pmds_m.pmdsdocno,g_pmds_m.pmdsdocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF                  
      #end add-point
  
      #add-point:單身刪除前 name="delete.body.b_delete"
                        
      #end add-point
      
      DELETE FROM pmdt_t
       WHERE pmdtent = g_enterprise AND pmdtdocno = g_pmds_m.pmdsdocno
 
 
      #add-point:單身刪除中 name="delete.body.m_delete"
                        
      #end add-point
         
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF    
 
      #add-point:單身刪除後 name="delete.body.a_delete"
                        
      #end add-point
      
            
                                                               
      #add-point:單身刪除前 name="delete.body.b_delete2"
                        
      #end add-point
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise AND
             pmdudocno = g_pmds_m.pmdsdocno
      #add-point:單身刪除中 name="delete.body.m_delete2"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete2"
                        
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete3"
                        
      #end add-point
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise AND
             pmdvdocno = g_pmds_m.pmdsdocno
      #add-point:單身刪除中 name="delete.body.m_delete3"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete3"
      CALL g_pmdt4_d.clear()

      IF NOT s_aooi360_del('6',g_prog,g_pmds_m.pmdsdocno,'','','','','','','','','4') THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete4"
      
      #end add-point
      DELETE FROM xrcd_t
       WHERE xrcdent = g_enterprise AND
             xrcddocno = g_pmds_m.pmdsdocno
      #add-point:單身刪除中 name="delete.body.m_delete4"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete4"
      
      #end add-point
 
 
 
 
      
      #修改歷程記錄(刪除)
      LET g_log1 = util.JSON.stringify(g_pmds_m)   #(ver:78)
      IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:78)
         CLOSE apmt860_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
             
      CLEAR FORM
      CALL g_pmdt_d.clear() 
      CALL g_pmdt2_d.clear()       
      CALL g_pmdt3_d.clear()       
      CALL g_pmdt4_d.clear()       
      CALL g_pmdt5_d.clear()       
 
     
      CALL apmt860_ui_browser_refresh()  
      #CALL apmt860_ui_headershow()  
      #CALL apmt860_ui_detailshow()
 
      #add-point:多語言刪除 name="delete.lang.before_delete"
      
      #end add-point
      
      #單頭多語言刪除
      
      
      #單身多語言刪除
      
      
      
      
      
 
   
      #add-point:多語言刪除 name="delete.lang.delete"
      
      #end add-point
      
      IF g_browser_cnt > 0 THEN 
         #CALL apmt860_browser_fill("")
         CALL apmt860_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
         DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
      ELSE
         CLEAR FORM
      END IF
      
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
 
   CLOSE apmt860_cl
 
   #功能已完成,通報訊息中心
   CALL apmt860_msgcentre_notify('delete')
    
END FUNCTION
 
{</section>}
 
{<section id="apmt860.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION apmt860_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point     
   DEFINE p_wc2      STRING
   DEFINE li_idx     LIKE type_t.num10
   #add-point:b_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   DEFINE l_success  LIKE type_t.num5  
   DEFINE l_sql      STRING
   DEFINE l_acc      LIKE gzcb_t.gzcb004
   #end add-point     
   
   #add-point:Function前置處理  name="b_fill.pre_function"
   
   #end add-point
   
   #清空第一階單身
   CALL g_pmdt_d.clear()
   CALL g_pmdt2_d.clear()
   CALL g_pmdt3_d.clear()
   CALL g_pmdt4_d.clear()
   CALL g_pmdt5_d.clear()
 
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"
   LET l_sql = "SELECT pmdt200,pmdt006,imaal003,imaal004,pmdt007",
               "  FROM pmdt_t",
               "  LEFT OUTER JOIN imaal_t ON pmdtent = imaalent AND pmdt006 = imaal001 AND imaal002 = '",g_dlang,"'",
               " WHERE pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'",
               "   AND pmdtseq = ?"
   PREPARE apmt860_pmdt FROM l_sql
   
   LET l_acc = ''
   EXECUTE apmt860_get_gzcb004 INTO l_acc
   
   #150521-00012#1 150601 By pomelo add(S)
   LET l_sql = "SELECT pmdo006",
               "  FROM pmdo_t",
               " WHERE pmdoent = ",g_enterprise,
               "   AND pmdodocno = ?",
               "   AND pmdoseq = ?",
               "   AND pmdoseq1 = ?",
               "   AND pmdoseq2 = ?"
   PREPARE apmt860_get_pmdo006 FROM l_sql
   #150521-00012#1 150601 By pomelo add(E)
   
   #151207-00021#6 160106 By pomelo add(S)
   LET l_sql = "SELECT oodbl004",
               "  FROM oodbl_t,ooef_t",
               " WHERE oodblent = ",g_enterprise,
               "   AND ooefent = oodblent",
               "   AND ooef001  = ?",
               "   AND ooef019  = oodbl001",
               "   AND oodbl002 = ?",
               "   AND oodbl003 = '",g_dlang,"'"
   PREPARE apmt860_get_oodbl004 FROM l_sql
   #151207-00021#6 160106 By pomelo add(E)
   #end add-point
   
   #判斷是否填充
   IF apmt860_fill_chk(1) THEN
      #切換上下筆時不重組SQL
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
      #add-point:b_fill段long_sql_if name="b_fill.long_sql_if"
      
      #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdtsite,pmdtseq,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216,pmdt217, 
             pmdt001,pmdt002,pmdt003,pmdt004,pmdt221,pmdt005,pmdt200,pmdt006,pmdt220,pmdt007,pmdt025, 
             pmdt227,pmdt201,pmdt202,pmdt019,pmdt020,pmdt023,pmdt024,pmdt036,pmdt218,pmdt044,pmdt046, 
             pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt052, 
             pmdt051,pmdt059,pmdt203,pmdt204,pmdt205,pmdt214,pmdt215,pmdt208,pmdt209,pmdt210,pmdt211, 
             pmdt212,pmdt213,pmdtorga,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt084,pmdt219,pmdt089, 
             pmdt088,pmdtseq ,t3.rtaxl003 ,t4.imaal003 ,t5.imaal004 ,t6.rtaxl003 ,t7.oocal003 ,t8.oocal003 , 
             t9.oocal003 ,t10.inayl003 ,t11.ooefl003 ,t12.ooefl003 ,t13.ooefl003 ,t14.ooefl003 ,t15.oojdl003 , 
             t16.staal003 ,t17.ooefl003 FROM pmdt_t",   
                     " INNER JOIN pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = pmdtdocno ",
 
                     #"",
                     
                     "",
                     #下層單身所需的join條件
 
                                    " LEFT JOIN rtaxl_t t3 ON t3.rtaxlent="||g_enterprise||" AND t3.rtaxl001=pmdt221 AND t3.rtaxl002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t4 ON t4.imaalent="||g_enterprise||" AND t4.imaal001=pmdt006 AND t4.imaal002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t5 ON t5.imaalent="||g_enterprise||" AND t5.imaal001=pmdt006 AND t5.imaal002='"||g_dlang||"' ",
               " LEFT JOIN rtaxl_t t6 ON t6.rtaxlent="||g_enterprise||" AND t6.rtaxl001=pmdt220 AND t6.rtaxl002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t7 ON t7.oocalent="||g_enterprise||" AND t7.oocal001=pmdt201 AND t7.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t8 ON t8.oocalent="||g_enterprise||" AND t8.oocal001=pmdt019 AND t8.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t9 ON t9.oocalent="||g_enterprise||" AND t9.oocal001=pmdt023 AND t9.oocal002='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t10 ON t10.inaylent="||g_enterprise||" AND t10.inayl001=pmdt016 AND t10.inayl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t11 ON t11.ooeflent="||g_enterprise||" AND t11.ooefl001=pmdt203 AND t11.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t12 ON t12.ooeflent="||g_enterprise||" AND t12.ooefl001=pmdt204 AND t12.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t13 ON t13.ooeflent="||g_enterprise||" AND t13.ooefl001=pmdt205 AND t13.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t14 ON t14.ooeflent="||g_enterprise||" AND t14.ooefl001=pmdt215 AND t14.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN oojdl_t t15 ON t15.oojdlent="||g_enterprise||" AND t15.oojdl001=pmdt208 AND t15.oojdl002='"||g_dlang||"' ",
               " LEFT JOIN staal_t t16 ON t16.staalent="||g_enterprise||" AND t16.staal001=pmdt211 AND t16.staal002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t17 ON t17.ooeflent="||g_enterprise||" AND t17.ooefl001=pmdtorga AND t17.ooefl002='"||g_dlang||"' ",
 
                     " WHERE pmdtent=? AND pmdtdocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段sql_before name="b_fill.body.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdt_t.pmdtseq"
         
         #add-point:單身填充控制 name="b_fill.sql"
                        
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt860_pb FROM g_sql
         DECLARE b_fill_cs CURSOR FOR apmt860_pb
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
   #  OPEN b_fill_cs USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq, 
          g_pmdt_d[l_ac].pmdt206,g_pmdt_d[l_ac].pmdt207,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028, 
          g_pmdt_d[l_ac].pmdt216,g_pmdt_d[l_ac].pmdt217,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002, 
          g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt221,g_pmdt_d[l_ac].pmdt005, 
          g_pmdt_d[l_ac].pmdt200,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt220,g_pmdt_d[l_ac].pmdt007, 
          g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt227,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt202, 
          g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024, 
          g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt218,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt046, 
          g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047, 
          g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017, 
          g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051, 
          g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt203,g_pmdt_d[l_ac].pmdt204,g_pmdt_d[l_ac].pmdt205, 
          g_pmdt_d[l_ac].pmdt214,g_pmdt_d[l_ac].pmdt215,g_pmdt_d[l_ac].pmdt208,g_pmdt_d[l_ac].pmdt209, 
          g_pmdt_d[l_ac].pmdt210,g_pmdt_d[l_ac].pmdt211,g_pmdt_d[l_ac].pmdt212,g_pmdt_d[l_ac].pmdt213, 
          g_pmdt_d[l_ac].pmdtorga,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055, 
          g_pmdt_d[l_ac].pmdt060,g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt084,g_pmdt_d[l_ac].pmdt219, 
          g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt088,g_pmdt4_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt221_desc, 
          g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc,g_pmdt_d[l_ac].pmdt220_desc,g_pmdt_d[l_ac].pmdt201_desc, 
          g_pmdt_d[l_ac].pmdt019_desc,g_pmdt_d[l_ac].pmdt023_desc,g_pmdt_d[l_ac].pmdt016_desc,g_pmdt_d[l_ac].pmdt203_desc, 
          g_pmdt_d[l_ac].pmdt204_desc,g_pmdt_d[l_ac].pmdt205_desc,g_pmdt_d[l_ac].pmdt215_desc,g_pmdt_d[l_ac].pmdt208_desc, 
          g_pmdt_d[l_ac].pmdt211_desc,g_pmdt_d[l_ac].pmdtorga_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
         #150521-00012#1 150601 By pomelo add(S)
         EXECUTE apmt860_get_pmdo006 USING g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,
                                           g_pmdt_d[l_ac].pmdt003,g_pmdt_d[l_ac].pmdt004
            INTO g_pmdt_d[l_ac].l_pmdo006
         #150521-00012#1 150601 By pomelo add(E)
         
         #產品特徵
         IF NOT cl_null(g_pmdt_d[l_ac].pmdt007) THEN   #151207-00021#6 151231 By pomelo add
            CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007)
               RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
         END IF  #151207-00021#6 151231 By pomelo add
         
         #稅別
         #151207-00021#6 160106 By pomelo mark(S)
         #CALL s_desc_get_tax_desc1(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046)
         #   RETURNING g_pmdt_d[l_ac].pmdt046_desc
         #151207-00021#6 160106 By pomelo mark(E)
         #151207-00021#6 160106 By pomelo add(S)
         IF NOT cl_null(g_pmdt_d[l_ac].pmdt046) THEN
            EXECUTE apmt860_get_oodbl004 USING g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046
               INTO g_pmdt_d[l_ac].pmdt046_desc
         END IF
         #151207-00021#6 160106 By pomelo add(E)
         
         #儲位
         IF NOT cl_null(g_pmdt_d[l_ac].pmdt007) THEN   #151207-00021#6 151231 By pomelo add
            CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
               RETURNING g_pmdt_d[l_ac].pmdt017_desc
         END IF    #151207-00021#6 151231 By pomelo add
         
         #理由碼
         IF NOT cl_null(g_pmdt_d[l_ac].pmdt051) THEN   #151207-00021#6 151231 By pomelo add
            CALL s_desc_get_acc_desc(l_acc,g_pmdt_d[l_ac].pmdt051)
               RETURNING g_pmdt_d[l_ac].pmdt051_desc
         END IF  #151207-00021#6 151231 By pomelo add
            
         LET g_pmdt_d[l_ac].pmdo001 = g_pmdt_d[l_ac].pmdt006
         LET g_pmdt_d[l_ac].pmdo001_desc = g_pmdt_d[l_ac].pmdt006_desc
         LET g_pmdt_d[l_ac].pmdo001_desc_desc = g_pmdt_d[l_ac].pmdt006_desc_desc
         LET g_pmdt_d[l_ac].pmdo002 = g_pmdt_d[l_ac].pmdt007
         LET g_pmdt_d[l_ac].pmdo002_desc = g_pmdt_d[l_ac].pmdt007_desc
         LET g_pmdt4_d[l_ac].pmdt0461_desc = g_pmdt_d[l_ac].pmdt046_desc
         
         LET g_pmdt4_d[l_ac].pmdt0011 = g_pmdt_d[l_ac].pmdt001    #採購單號
         LET g_pmdt4_d[l_ac].pmdt0021 = g_pmdt_d[l_ac].pmdt002    #採購項次
         LET g_pmdt4_d[l_ac].pmdt0031 = g_pmdt_d[l_ac].pmdt003    #採購項序
         LET g_pmdt4_d[l_ac].pmdt0041 = g_pmdt_d[l_ac].pmdt004    #採購分批序
         LET g_pmdt4_d[l_ac].pmdt0051 = g_pmdt_d[l_ac].pmdt005    #子件特性
         LET g_pmdt4_d[l_ac].pmdt0061 = g_pmdt_d[l_ac].pmdt006    #商品編號
         LET g_pmdt4_d[l_ac].pmdt0061_desc = g_pmdt_d[l_ac].pmdt006_desc
         LET g_pmdt4_d[l_ac].pmdt0061_desc_desc = g_pmdt_d[l_ac].pmdt006_desc_desc
         LET g_pmdt4_d[l_ac].pmdt0071 = g_pmdt_d[l_ac].pmdt007    #產品特徵
         LET g_pmdt4_d[l_ac].pmdt0071_desc = g_pmdt_d[l_ac].pmdt007_desc
         LET g_pmdt4_d[l_ac].pmdt2011 = g_pmdt_d[l_ac].pmdt201    #包裝單位
         LET g_pmdt4_d[l_ac].pmdt2011_desc = g_pmdt_d[l_ac].pmdt201_desc
         LET g_pmdt4_d[l_ac].pmdt2021 = g_pmdt_d[l_ac].pmdt202    #包裝數量
         LET g_pmdt4_d[l_ac].pmdt0191 = g_pmdt_d[l_ac].pmdt019    #收貨/入庫單位
         LET g_pmdt4_d[l_ac].pmdt0191_desc = g_pmdt_d[l_ac].pmdt019_desc
         LET g_pmdt4_d[l_ac].pmdt0201 = g_pmdt_d[l_ac].pmdt020    #收貨/入庫數量
         LET g_pmdt4_d[l_ac].pmdt0231 = g_pmdt_d[l_ac].pmdt023    #計價單位
         LET g_pmdt4_d[l_ac].pmdt0231_desc = g_pmdt_d[l_ac].pmdt023_desc
         LET g_pmdt4_d[l_ac].pmdt0241 = g_pmdt_d[l_ac].pmdt024    #計價數量
         LET g_pmdt4_d[l_ac].pmdt0361 = g_pmdt_d[l_ac].pmdt036    #單價
         LET g_pmdt4_d[l_ac].pmdt2181 = g_pmdt_d[l_ac].pmdt218    #採購價
         LET g_pmdt4_d[l_ac].pmdt0441 = g_pmdt_d[l_ac].pmdt044    #取出單價
         LET g_pmdt4_d[l_ac].pmdt0461 = g_pmdt_d[l_ac].pmdt046    #稅別
         LET g_pmdt4_d[l_ac].pmdt0461_desc = g_pmdt_d[l_ac].pmdt046_desc
         LET g_pmdt4_d[l_ac].pmdt0371 = g_pmdt_d[l_ac].pmdt037    #稅率
         LET g_pmdt4_d[l_ac].pmdt0381 = g_pmdt_d[l_ac].pmdt038    #未稅金額
         LET g_pmdt4_d[l_ac].pmdt0391 = g_pmdt_d[l_ac].pmdt039    #含稅金額
         LET g_pmdt4_d[l_ac].pmdt0471 = g_pmdt_d[l_ac].pmdt047    #稅額
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_ac
               LET g_errparam.code = 9035 
               LET g_errparam.popup = TRUE 
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
    
   #判斷是否填充
   IF apmt860_fill_chk(2) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body2.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdusite,pmduseq,pmduseq1,pmdu001,pmdu002,pmdu006,pmdu007,pmdu008, 
             pmdu005,pmdu200,pmdu201,pmdu009,pmdu010,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016 , 
             t18.imaal003 ,t19.imaal004 ,t20.inayl003 ,t21.oocal003 ,t22.oocal003 FROM pmdu_t",   
                     " INNER JOIN  pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = pmdudocno ",
 
                     "",
                     
                                    " LEFT JOIN imaal_t t18 ON t18.imaalent="||g_enterprise||" AND t18.imaal001=pmdu001 AND t18.imaal002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t19 ON t19.imaalent="||g_enterprise||" AND t19.imaal001=pmdu001 AND t19.imaal002='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t20 ON t20.inaylent="||g_enterprise||" AND t20.inayl001=pmdu006 AND t20.inayl002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t21 ON t21.oocalent="||g_enterprise||" AND t21.oocal001=pmdu200 AND t21.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t22 ON t22.oocalent="||g_enterprise||" AND t22.oocal001=pmdu009 AND t22.oocal002='"||g_dlang||"' ",
 
                     " WHERE pmduent=? AND pmdudocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body2.fill_sql"
                        
         #end add-point
         IF NOT cl_null(g_wc2_table2) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdu_t.pmduseq,pmdu_t.pmduseq1"
         
         #add-point:單身填充控制 name="b_fill.sql2"
                        
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt860_pb2 FROM g_sql
         DECLARE b_fill_cs2 CURSOR FOR apmt860_pb2
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs2 USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs2 USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt2_d[l_ac].pmdusite,g_pmdt2_d[l_ac].pmduseq, 
          g_pmdt2_d[l_ac].pmduseq1,g_pmdt2_d[l_ac].pmdu001,g_pmdt2_d[l_ac].pmdu002,g_pmdt2_d[l_ac].pmdu006, 
          g_pmdt2_d[l_ac].pmdu007,g_pmdt2_d[l_ac].pmdu008,g_pmdt2_d[l_ac].pmdu005,g_pmdt2_d[l_ac].pmdu200, 
          g_pmdt2_d[l_ac].pmdu201,g_pmdt2_d[l_ac].pmdu009,g_pmdt2_d[l_ac].pmdu010,g_pmdt2_d[l_ac].pmdu013, 
          g_pmdt2_d[l_ac].pmdu014,g_pmdt2_d[l_ac].pmdu015,g_pmdt2_d[l_ac].pmdu202,g_pmdt2_d[l_ac].pmdu017, 
          g_pmdt2_d[l_ac].pmdu016,g_pmdt2_d[l_ac].pmdu001_desc,g_pmdt2_d[l_ac].pmdu001_desc_desc,g_pmdt2_d[l_ac].pmdu006_desc, 
          g_pmdt2_d[l_ac].pmdu200_desc,g_pmdt2_d[l_ac].pmdu009_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill2.fill"
         #產品特徵
         IF NOT cl_null(g_pmdt2_d[l_ac].pmdu002) THEN  #151207-00021#6 151231 By pomelo add
            CALL s_feature_description(g_pmdt2_d[l_ac].pmdu001,g_pmdt2_d[l_ac].pmdu002)
               RETURNING l_success,g_pmdt2_d[l_ac].pmdu002_desc
         END IF   #151207-00021#6 151231 By pomelo add
         
         #儲位
         IF NOT cl_null(g_pmdt2_d[l_ac].pmdu007) THEN  #151207-00021#6 151231 By pomelo add
            CALL s_desc_get_locator_desc(g_pmdt2_d[l_ac].pmdusite,g_pmdt2_d[l_ac].pmdu006,g_pmdt2_d[l_ac].pmdu007)
               RETURNING g_pmdt2_d[l_ac].pmdu007_desc
         END IF   #151207-00021#6 151231 By pomelo add
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF apmt860_fill_chk(3) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body3.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT pmdvsite,pmdvseq,pmdvseq1,pmdv005,pmdv001,pmdv002,pmdv014,pmdv015, 
             pmdv016,pmdv017,pmdv200,pmdv201,pmdv018,pmdv019 ,t23.imaal003 ,t24.imaal004 ,t25.oocal003 , 
             t26.oocal003 FROM pmdv_t",   
                     " INNER JOIN  pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = pmdvdocno ",
 
                     "",
                     
                                    " LEFT JOIN imaal_t t23 ON t23.imaalent="||g_enterprise||" AND t23.imaal001=pmdv001 AND t23.imaal002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t24 ON t24.imaalent="||g_enterprise||" AND t24.imaal001=pmdv001 AND t24.imaal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t25 ON t25.oocalent="||g_enterprise||" AND t25.oocal001=pmdv200 AND t25.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t26 ON t26.oocalent="||g_enterprise||" AND t26.oocal001=pmdv018 AND t26.oocal002='"||g_dlang||"' ",
 
                     " WHERE pmdvent=? AND pmdvdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body3.fill_sql"
                        
         #end add-point
         IF NOT cl_null(g_wc2_table3) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY pmdv_t.pmdvseq,pmdv_t.pmdvseq1"
         
         #add-point:單身填充控制 name="b_fill.sql3"
                        
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt860_pb3 FROM g_sql
         DECLARE b_fill_cs3 CURSOR FOR apmt860_pb3
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs3 USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs3 USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt3_d[l_ac].pmdvsite,g_pmdt3_d[l_ac].pmdvseq, 
          g_pmdt3_d[l_ac].pmdvseq1,g_pmdt3_d[l_ac].pmdv005,g_pmdt3_d[l_ac].pmdv001,g_pmdt3_d[l_ac].pmdv002, 
          g_pmdt3_d[l_ac].pmdv014,g_pmdt3_d[l_ac].pmdv015,g_pmdt3_d[l_ac].pmdv016,g_pmdt3_d[l_ac].pmdv017, 
          g_pmdt3_d[l_ac].pmdv200,g_pmdt3_d[l_ac].pmdv201,g_pmdt3_d[l_ac].pmdv018,g_pmdt3_d[l_ac].pmdv019, 
          g_pmdt3_d[l_ac].pmdv001_desc,g_pmdt3_d[l_ac].pmdv001_desc_desc,g_pmdt3_d[l_ac].pmdv200_desc, 
          g_pmdt3_d[l_ac].pmdv018_desc   #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill3.fill"
                                    
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF apmt860_fill_chk(4) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body4.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT xrcdsite,xrcdld,xrcdseq,xrcd007,xrcd002,xrcdseq2,xrcd003,xrcd006, 
             xrcd004,xrcd104  FROM xrcd_t",   
                     " INNER JOIN  pmds_t ON pmdsent = " ||g_enterprise|| " AND pmdsdocno = xrcddocno ",
 
                     "",
                     
                     
                     " WHERE xrcdent=? AND xrcddocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body4.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table4) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table4 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY xrcd_t.xrcdld,xrcd_t.xrcdseq,xrcd_t.xrcdseq2,xrcd_t.xrcd007"
         
         #add-point:單身填充控制 name="b_fill.sql4"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE apmt860_pb4 FROM g_sql
         DECLARE b_fill_cs4 CURSOR FOR apmt860_pb4
      END IF
    
      LET l_ac = 1
      
   #  OPEN b_fill_cs4 USING g_enterprise,g_pmds_m.pmdsdocno   #(ver:78)
                                               
      FOREACH b_fill_cs4 USING g_enterprise,g_pmds_m.pmdsdocno INTO g_pmdt5_d[l_ac].xrcdsite,g_pmdt5_d[l_ac].xrcdld, 
          g_pmdt5_d[l_ac].xrcdseq,g_pmdt5_d[l_ac].xrcd007,g_pmdt5_d[l_ac].xrcd002,g_pmdt5_d[l_ac].xrcdseq2, 
          g_pmdt5_d[l_ac].xrcd003,g_pmdt5_d[l_ac].xrcd006,g_pmdt5_d[l_ac].xrcd004,g_pmdt5_d[l_ac].xrcd104  
            #(ver:78)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill4.fill"
         EXECUTE apmt860_pmdt USING g_pmdt5_d[l_ac].xrcdseq
            INTO g_pmdt5_d[l_ac].pmdt200,g_pmdt5_d[l_ac].pmdt006,
                 g_pmdt5_d[l_ac].pmdt006_2_desc,
                 g_pmdt5_d[l_ac].pmdt006_2_desc_desc,
                 g_pmdt5_d[l_ac].pmdt007
         
         #產品特徵
         IF NOT cl_null(g_pmdt5_d[l_ac].pmdt007) THEN   #151207-00021#6 151231 By pomelo add
            CALL s_feature_description(g_pmdt5_d[l_ac].pmdt006,g_pmdt5_d[l_ac].pmdt007)
               RETURNING l_success,g_pmdt5_d[l_ac].pmdt007_2_desc
         END IF   #151207-00021#6 151231 By pomelo add
         
         #稅別
         #151207-00021#6 160106 By pomelo mark(S)
         #CALL s_desc_get_tax_desc1(g_pmdt5_d[l_ac].xrcdsite,g_pmdt5_d[l_ac].xrcd002)
         #      RETURNING g_pmdt5_d[l_ac].xrcd002_desc
         #151207-00021#6 160106 By pomelo mark(E)
         #151207-00021#6 160106 By pomelo add(S)
         IF NOT cl_null(g_pmdt_d[l_ac].pmdt046) THEN
            EXECUTE apmt860_get_oodbl004 USING g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046
               INTO g_pmdt_d[l_ac].pmdt046_desc
         END IF
         #151207-00021#6 160106 By pomelo add(E)
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code = 9035 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
 
   
   #add-point:browser_fill段其他table處理 name="browser_fill.other_fill"
     
   #end add-point
   
   CALL g_pmdt_d.deleteElement(g_pmdt_d.getLength())
   CALL g_pmdt2_d.deleteElement(g_pmdt2_d.getLength())
   CALL g_pmdt3_d.deleteElement(g_pmdt3_d.getLength())
   CALL g_pmdt4_d.deleteElement(g_pmdt4_d.getLength())
   CALL g_pmdt5_d.deleteElement(g_pmdt5_d.getLength())
 
   
 
   LET l_ac = g_cnt
   LET g_cnt = 0  
   
   FREE apmt860_pb
   FREE apmt860_pb2
 
   FREE apmt860_pb3
 
   FREE apmt860_pb4
 
 
   
   LET li_idx = l_ac
   
   #遮罩相關處理
   FOR l_ac = 1 TO g_pmdt_d.getLength()
      LET g_pmdt_d_mask_o[l_ac].* =  g_pmdt_d[l_ac].*
      CALL apmt860_pmdt_t_mask()
      LET g_pmdt_d_mask_n[l_ac].* =  g_pmdt_d[l_ac].*
   END FOR
   
   LET g_pmdt2_d_mask_o.* =  g_pmdt2_d.*
   FOR l_ac = 1 TO g_pmdt2_d.getLength()
      LET g_pmdt2_d_mask_o[l_ac].* =  g_pmdt2_d[l_ac].*
      CALL apmt860_pmdu_t_mask()
      LET g_pmdt2_d_mask_n[l_ac].* =  g_pmdt2_d[l_ac].*
   END FOR
   LET g_pmdt3_d_mask_o.* =  g_pmdt3_d.*
   FOR l_ac = 1 TO g_pmdt3_d.getLength()
      LET g_pmdt3_d_mask_o[l_ac].* =  g_pmdt3_d[l_ac].*
      CALL apmt860_pmdv_t_mask()
      LET g_pmdt3_d_mask_n[l_ac].* =  g_pmdt3_d[l_ac].*
   END FOR
   LET g_pmdt4_d_mask_o.* =  g_pmdt4_d.*
   FOR l_ac = 1 TO g_pmdt4_d.getLength()
      LET g_pmdt4_d_mask_o[l_ac].* =  g_pmdt4_d[l_ac].*
      CALL apmt860_pmdt_t_mask()
      LET g_pmdt4_d_mask_n[l_ac].* =  g_pmdt4_d[l_ac].*
   END FOR
   LET g_pmdt5_d_mask_o.* =  g_pmdt5_d.*
   FOR l_ac = 1 TO g_pmdt5_d.getLength()
      LET g_pmdt5_d_mask_o[l_ac].* =  g_pmdt5_d[l_ac].*
      CALL apmt860_xrcd_t_mask()
      LET g_pmdt5_d_mask_n[l_ac].* =  g_pmdt5_d[l_ac].*
   END FOR
 
   
   LET l_ac = li_idx
   
   CALL cl_ap_performance_next_end()
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.delete_b" >}
#+ 刪除單身後其他table連動
PRIVATE FUNCTION apmt860_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"
            
   #end add-point     
   
   #add-point:Function前置處理  name="delete_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1','4',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete"
                        
      #end add-point    
      DELETE FROM pmdt_t
       WHERE pmdtent = g_enterprise AND
         pmdtdocno = ps_keys_bak[1] AND pmdtseq = ps_keys_bak[2]
      #add-point:delete_b段刪除中 name="delete_b.m_delete"
                        
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = ":",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_pmdt_d.deleteElement(li_idx) 
      END IF 
      IF ps_page <> "'4'" THEN 
         CALL g_pmdt4_d.deleteElement(li_idx) 
      END IF 
 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete2"
                        
      #end add-point    
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise AND
             pmdudocno = ps_keys_bak[1] AND pmduseq = ps_keys_bak[2] AND pmduseq1 = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete2"
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise AND
         pmdudocno = ps_keys_bak[1] AND pmduseq = ps_keys_bak[2]                  
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_pmdt2_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete2"
                        
      #end add-point    
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete3"
                        
      #end add-point    
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise AND
             pmdvdocno = ps_keys_bak[1] AND pmdvseq = ps_keys_bak[2] AND pmdvseq1 = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete3"
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise AND
         pmdvdocno = ps_keys_bak[1] AND pmdvseq = ps_keys_bak[2]                  
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_pmdt3_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete3"
                        
      #end add-point    
   END IF
 
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete4"
      
      #end add-point    
      DELETE FROM xrcd_t
       WHERE xrcdent = g_enterprise AND
             xrcddocno = ps_keys_bak[1] AND xrcdld = ps_keys_bak[2] AND xrcdseq = ps_keys_bak[3] AND xrcdseq2 = ps_keys_bak[4] AND xrcd007 = ps_keys_bak[5]
      #add-point:delete_b段刪除中 name="delete_b.m_delete4"
      
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'5'" THEN 
         CALL g_pmdt5_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete4"
      
      #end add-point    
   END IF
 
 
   
 
   
   #add-point:delete_b段other name="delete_b.other"
            
   #end add-point  
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.insert_b" >}
#+ 新增單身後其他table連動
PRIVATE FUNCTION apmt860_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:insert_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"
            
   #end add-point     
   
   #add-point:Function前置處理  name="insert_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1','4',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert"
 
      #end add-point 
      INSERT INTO pmdt_t
                  (pmdtent,
                   pmdtdocno,
                   pmdtseq
                   ,pmdtsite,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216,pmdt217,pmdt001,pmdt002,pmdt003,pmdt004,pmdt221,pmdt005,pmdt200,pmdt006,pmdt220,pmdt007,pmdt025,pmdt227,pmdt201,pmdt202,pmdt019,pmdt020,pmdt023,pmdt024,pmdt036,pmdt218,pmdt044,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt052,pmdt051,pmdt059,pmdt203,pmdt204,pmdt205,pmdt214,pmdt215,pmdt208,pmdt209,pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt084,pmdt219,pmdt089,pmdt088) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2]
                   ,g_pmdt_d[g_detail_idx].pmdtsite,g_pmdt_d[g_detail_idx].pmdt206,g_pmdt_d[g_detail_idx].pmdt207, 
                       g_pmdt_d[g_detail_idx].pmdt027,g_pmdt_d[g_detail_idx].pmdt028,g_pmdt_d[g_detail_idx].pmdt216, 
                       g_pmdt_d[g_detail_idx].pmdt217,g_pmdt_d[g_detail_idx].pmdt001,g_pmdt_d[g_detail_idx].pmdt002, 
                       g_pmdt_d[g_detail_idx].pmdt003,g_pmdt_d[g_detail_idx].pmdt004,g_pmdt_d[g_detail_idx].pmdt221, 
                       g_pmdt_d[g_detail_idx].pmdt005,g_pmdt_d[g_detail_idx].pmdt200,g_pmdt_d[g_detail_idx].pmdt006, 
                       g_pmdt_d[g_detail_idx].pmdt220,g_pmdt_d[g_detail_idx].pmdt007,g_pmdt_d[g_detail_idx].pmdt025, 
                       g_pmdt_d[g_detail_idx].pmdt227,g_pmdt_d[g_detail_idx].pmdt201,g_pmdt_d[g_detail_idx].pmdt202, 
                       g_pmdt_d[g_detail_idx].pmdt019,g_pmdt_d[g_detail_idx].pmdt020,g_pmdt_d[g_detail_idx].pmdt023, 
                       g_pmdt_d[g_detail_idx].pmdt024,g_pmdt_d[g_detail_idx].pmdt036,g_pmdt_d[g_detail_idx].pmdt218, 
                       g_pmdt_d[g_detail_idx].pmdt044,g_pmdt_d[g_detail_idx].pmdt046,g_pmdt_d[g_detail_idx].pmdt037, 
                       g_pmdt_d[g_detail_idx].pmdt038,g_pmdt_d[g_detail_idx].pmdt039,g_pmdt_d[g_detail_idx].pmdt047, 
                       g_pmdt_d[g_detail_idx].pmdt026,g_pmdt_d[g_detail_idx].pmdt062,g_pmdt_d[g_detail_idx].pmdt016, 
                       g_pmdt_d[g_detail_idx].pmdt017,g_pmdt_d[g_detail_idx].pmdt018,g_pmdt_d[g_detail_idx].pmdt063, 
                       g_pmdt_d[g_detail_idx].pmdt052,g_pmdt_d[g_detail_idx].pmdt051,g_pmdt_d[g_detail_idx].pmdt059, 
                       g_pmdt_d[g_detail_idx].pmdt203,g_pmdt_d[g_detail_idx].pmdt204,g_pmdt_d[g_detail_idx].pmdt205, 
                       g_pmdt_d[g_detail_idx].pmdt214,g_pmdt_d[g_detail_idx].pmdt215,g_pmdt_d[g_detail_idx].pmdt208, 
                       g_pmdt_d[g_detail_idx].pmdt209,g_pmdt_d[g_detail_idx].pmdt210,g_pmdt_d[g_detail_idx].pmdt211, 
                       g_pmdt_d[g_detail_idx].pmdt212,g_pmdt_d[g_detail_idx].pmdt213,g_pmdt_d[g_detail_idx].pmdtorga, 
                       g_pmdt_d[g_detail_idx].pmdt053,g_pmdt_d[g_detail_idx].pmdt054,g_pmdt_d[g_detail_idx].pmdt055, 
                       g_pmdt_d[g_detail_idx].pmdt060,g_pmdt_d[g_detail_idx].pmdt061,g_pmdt_d[g_detail_idx].pmdt084, 
                       g_pmdt_d[g_detail_idx].pmdt219,g_pmdt_d[g_detail_idx].pmdt089,g_pmdt_d[g_detail_idx].pmdt088) 
 
      #add-point:insert_b段資料新增中 name="insert_b.m_insert"
                        
      #end add-point 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_pmdt_d.insertElement(li_idx) 
      END IF 
      IF ps_page <> "'4'" THEN 
         CALL g_pmdt4_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert"
      #數量欄位賦 0
      UPDATE pmdt_t  
       SET pmdt056 = 0,
           pmdt057 = 0,
           pmdt058 = 0,
           pmdt066 = 0,
           pmdt067 = 0,
           pmdt068 = 0,
           pmdt069 = 0 
        WHERE pmdtent = g_enterprise AND pmdtdocno = ps_keys[1] AND pmdtseq = ps_keys[2]           
      #end add-point 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert2"
                        
      #end add-point 
      INSERT INTO pmdu_t
                  (pmduent,
                   pmdudocno,
                   pmduseq,pmduseq1
                   ,pmdusite,pmdu001,pmdu002,pmdu006,pmdu007,pmdu008,pmdu005,pmdu200,pmdu201,pmdu009,pmdu010,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_pmdt2_d[g_detail_idx].pmdusite,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002, 
                       g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008, 
                       g_pmdt2_d[g_detail_idx].pmdu005,g_pmdt2_d[g_detail_idx].pmdu200,g_pmdt2_d[g_detail_idx].pmdu201, 
                       g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,g_pmdt2_d[g_detail_idx].pmdu013, 
                       g_pmdt2_d[g_detail_idx].pmdu014,g_pmdt2_d[g_detail_idx].pmdu015,g_pmdt2_d[g_detail_idx].pmdu202, 
                       g_pmdt2_d[g_detail_idx].pmdu017,g_pmdt2_d[g_detail_idx].pmdu016)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert2"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_pmdt2_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert2"
                        
      #end add-point
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert3"
                        
      #end add-point 
      INSERT INTO pmdv_t
                  (pmdvent,
                   pmdvdocno,
                   pmdvseq,pmdvseq1
                   ,pmdvsite,pmdv005,pmdv001,pmdv002,pmdv014,pmdv015,pmdv016,pmdv017,pmdv200,pmdv201,pmdv018,pmdv019) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_pmdt3_d[g_detail_idx].pmdvsite,g_pmdt3_d[g_detail_idx].pmdv005,g_pmdt3_d[g_detail_idx].pmdv001, 
                       g_pmdt3_d[g_detail_idx].pmdv002,g_pmdt3_d[g_detail_idx].pmdv014,g_pmdt3_d[g_detail_idx].pmdv015, 
                       g_pmdt3_d[g_detail_idx].pmdv016,g_pmdt3_d[g_detail_idx].pmdv017,g_pmdt3_d[g_detail_idx].pmdv200, 
                       g_pmdt3_d[g_detail_idx].pmdv201,g_pmdt3_d[g_detail_idx].pmdv018,g_pmdt3_d[g_detail_idx].pmdv019) 
 
      #add-point:insert_b段資料新增中 name="insert_b.m_insert3"
                        
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_pmdt3_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert3"
                        
      #end add-point
   END IF
 
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert4"
      
      #end add-point 
      INSERT INTO xrcd_t
                  (xrcdent,
                   xrcddocno,
                   xrcdld,xrcdseq,xrcdseq2,xrcd007
                   ,xrcdsite,xrcd002,xrcd003,xrcd006,xrcd004,xrcd104) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5]
                   ,g_pmdt5_d[g_detail_idx].xrcdsite,g_pmdt5_d[g_detail_idx].xrcd002,g_pmdt5_d[g_detail_idx].xrcd003, 
                       g_pmdt5_d[g_detail_idx].xrcd006,g_pmdt5_d[g_detail_idx].xrcd004,g_pmdt5_d[g_detail_idx].xrcd104) 
 
      #add-point:insert_b段資料新增中 name="insert_b.m_insert4"
      
      #end add-point
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'5'" THEN 
         CALL g_pmdt5_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert4"
      
      #end add-point
   END IF
 
 
   
 
   
   #add-point:insert_b段other name="insert_b.other"
            
   #end add-point     
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.update_b" >}
#+ 修改單身後其他table連動
PRIVATE FUNCTION apmt860_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"
   
   #end add-point   
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="update_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE   
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
   #判斷是否是同一群組的table
   LET ls_group = "'1','4',"
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdt_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update"
      #儲位、批號 若為空，給一個空格
      IF cl_null(g_pmdt_d[g_detail_idx].pmdt017) THEN
         LET g_pmdt_d[g_detail_idx].pmdt017 = ' '
      END IF 

      IF cl_null(g_pmdt_d[g_detail_idx].pmdt018) THEN
         LET g_pmdt_d[g_detail_idx].pmdt018 = ' '
      END IF   

      #整體參數未使用採購計價單位,則賦值當前的採購單位和數量
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "N" THEN
         LET g_pmdt_d[g_detail_idx].pmdt023 = g_pmdt_d[g_detail_idx].pmdt019
         LET g_pmdt_d[g_detail_idx].pmdt024 = g_pmdt_d[g_detail_idx].pmdt020
      END IF
      #end add-point 
      
      #將遮罩欄位還原
      CALL apmt860_pmdt_t_mask_restore('restore_mask_o')
               
      UPDATE pmdt_t 
         SET (pmdtdocno,
              pmdtseq
              ,pmdtsite,pmdt206,pmdt207,pmdt027,pmdt028,pmdt216,pmdt217,pmdt001,pmdt002,pmdt003,pmdt004,pmdt221,pmdt005,pmdt200,pmdt006,pmdt220,pmdt007,pmdt025,pmdt227,pmdt201,pmdt202,pmdt019,pmdt020,pmdt023,pmdt024,pmdt036,pmdt218,pmdt044,pmdt046,pmdt037,pmdt038,pmdt039,pmdt047,pmdt026,pmdt062,pmdt016,pmdt017,pmdt018,pmdt063,pmdt052,pmdt051,pmdt059,pmdt203,pmdt204,pmdt205,pmdt214,pmdt215,pmdt208,pmdt209,pmdt210,pmdt211,pmdt212,pmdt213,pmdtorga,pmdt053,pmdt054,pmdt055,pmdt060,pmdt061,pmdt084,pmdt219,pmdt089,pmdt088) 
              = 
             (ps_keys[1],ps_keys[2]
              ,g_pmdt_d[g_detail_idx].pmdtsite,g_pmdt_d[g_detail_idx].pmdt206,g_pmdt_d[g_detail_idx].pmdt207, 
                  g_pmdt_d[g_detail_idx].pmdt027,g_pmdt_d[g_detail_idx].pmdt028,g_pmdt_d[g_detail_idx].pmdt216, 
                  g_pmdt_d[g_detail_idx].pmdt217,g_pmdt_d[g_detail_idx].pmdt001,g_pmdt_d[g_detail_idx].pmdt002, 
                  g_pmdt_d[g_detail_idx].pmdt003,g_pmdt_d[g_detail_idx].pmdt004,g_pmdt_d[g_detail_idx].pmdt221, 
                  g_pmdt_d[g_detail_idx].pmdt005,g_pmdt_d[g_detail_idx].pmdt200,g_pmdt_d[g_detail_idx].pmdt006, 
                  g_pmdt_d[g_detail_idx].pmdt220,g_pmdt_d[g_detail_idx].pmdt007,g_pmdt_d[g_detail_idx].pmdt025, 
                  g_pmdt_d[g_detail_idx].pmdt227,g_pmdt_d[g_detail_idx].pmdt201,g_pmdt_d[g_detail_idx].pmdt202, 
                  g_pmdt_d[g_detail_idx].pmdt019,g_pmdt_d[g_detail_idx].pmdt020,g_pmdt_d[g_detail_idx].pmdt023, 
                  g_pmdt_d[g_detail_idx].pmdt024,g_pmdt_d[g_detail_idx].pmdt036,g_pmdt_d[g_detail_idx].pmdt218, 
                  g_pmdt_d[g_detail_idx].pmdt044,g_pmdt_d[g_detail_idx].pmdt046,g_pmdt_d[g_detail_idx].pmdt037, 
                  g_pmdt_d[g_detail_idx].pmdt038,g_pmdt_d[g_detail_idx].pmdt039,g_pmdt_d[g_detail_idx].pmdt047, 
                  g_pmdt_d[g_detail_idx].pmdt026,g_pmdt_d[g_detail_idx].pmdt062,g_pmdt_d[g_detail_idx].pmdt016, 
                  g_pmdt_d[g_detail_idx].pmdt017,g_pmdt_d[g_detail_idx].pmdt018,g_pmdt_d[g_detail_idx].pmdt063, 
                  g_pmdt_d[g_detail_idx].pmdt052,g_pmdt_d[g_detail_idx].pmdt051,g_pmdt_d[g_detail_idx].pmdt059, 
                  g_pmdt_d[g_detail_idx].pmdt203,g_pmdt_d[g_detail_idx].pmdt204,g_pmdt_d[g_detail_idx].pmdt205, 
                  g_pmdt_d[g_detail_idx].pmdt214,g_pmdt_d[g_detail_idx].pmdt215,g_pmdt_d[g_detail_idx].pmdt208, 
                  g_pmdt_d[g_detail_idx].pmdt209,g_pmdt_d[g_detail_idx].pmdt210,g_pmdt_d[g_detail_idx].pmdt211, 
                  g_pmdt_d[g_detail_idx].pmdt212,g_pmdt_d[g_detail_idx].pmdt213,g_pmdt_d[g_detail_idx].pmdtorga, 
                  g_pmdt_d[g_detail_idx].pmdt053,g_pmdt_d[g_detail_idx].pmdt054,g_pmdt_d[g_detail_idx].pmdt055, 
                  g_pmdt_d[g_detail_idx].pmdt060,g_pmdt_d[g_detail_idx].pmdt061,g_pmdt_d[g_detail_idx].pmdt084, 
                  g_pmdt_d[g_detail_idx].pmdt219,g_pmdt_d[g_detail_idx].pmdt089,g_pmdt_d[g_detail_idx].pmdt088)  
 
         WHERE pmdtent = g_enterprise AND pmdtdocno = ps_keys_bak[1] AND pmdtseq = ps_keys_bak[2]
      #add-point:update_b段修改中 name="update_b.m_update"
                        
      #end add-point   
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdt_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdt_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
 
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt860_pmdt_t_mask_restore('restore_mask_n')
               
      #add-point:update_b段修改後 name="update_b.after_update"
                        
      #end add-point  
   END IF
   
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
   
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdu_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update2"
                        
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt860_pmdu_t_mask_restore('restore_mask_o')
               
      UPDATE pmdu_t 
         SET (pmdudocno,
              pmduseq,pmduseq1
              ,pmdusite,pmdu001,pmdu002,pmdu006,pmdu007,pmdu008,pmdu005,pmdu200,pmdu201,pmdu009,pmdu010,pmdu013,pmdu014,pmdu015,pmdu202,pmdu017,pmdu016) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_pmdt2_d[g_detail_idx].pmdusite,g_pmdt2_d[g_detail_idx].pmdu001,g_pmdt2_d[g_detail_idx].pmdu002, 
                  g_pmdt2_d[g_detail_idx].pmdu006,g_pmdt2_d[g_detail_idx].pmdu007,g_pmdt2_d[g_detail_idx].pmdu008, 
                  g_pmdt2_d[g_detail_idx].pmdu005,g_pmdt2_d[g_detail_idx].pmdu200,g_pmdt2_d[g_detail_idx].pmdu201, 
                  g_pmdt2_d[g_detail_idx].pmdu009,g_pmdt2_d[g_detail_idx].pmdu010,g_pmdt2_d[g_detail_idx].pmdu013, 
                  g_pmdt2_d[g_detail_idx].pmdu014,g_pmdt2_d[g_detail_idx].pmdu015,g_pmdt2_d[g_detail_idx].pmdu202, 
                  g_pmdt2_d[g_detail_idx].pmdu017,g_pmdt2_d[g_detail_idx].pmdu016) 
         WHERE pmduent = g_enterprise AND pmdudocno = ps_keys_bak[1] AND pmduseq = ps_keys_bak[2] AND pmduseq1 = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update2"
                        
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdu_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdu_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt860_pmdu_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update2"
                        
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "pmdv_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update3"
                        
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt860_pmdv_t_mask_restore('restore_mask_o')
               
      UPDATE pmdv_t 
         SET (pmdvdocno,
              pmdvseq,pmdvseq1
              ,pmdvsite,pmdv005,pmdv001,pmdv002,pmdv014,pmdv015,pmdv016,pmdv017,pmdv200,pmdv201,pmdv018,pmdv019) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_pmdt3_d[g_detail_idx].pmdvsite,g_pmdt3_d[g_detail_idx].pmdv005,g_pmdt3_d[g_detail_idx].pmdv001, 
                  g_pmdt3_d[g_detail_idx].pmdv002,g_pmdt3_d[g_detail_idx].pmdv014,g_pmdt3_d[g_detail_idx].pmdv015, 
                  g_pmdt3_d[g_detail_idx].pmdv016,g_pmdt3_d[g_detail_idx].pmdv017,g_pmdt3_d[g_detail_idx].pmdv200, 
                  g_pmdt3_d[g_detail_idx].pmdv201,g_pmdt3_d[g_detail_idx].pmdv018,g_pmdt3_d[g_detail_idx].pmdv019)  
 
         WHERE pmdvent = g_enterprise AND pmdvdocno = ps_keys_bak[1] AND pmdvseq = ps_keys_bak[2] AND pmdvseq1 = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update3"
                        
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdv_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "pmdv_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt860_pmdv_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update3"
                        
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "xrcd_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update4"
      
      #end add-point  
      
      #將遮罩欄位還原
      CALL apmt860_xrcd_t_mask_restore('restore_mask_o')
               
      UPDATE xrcd_t 
         SET (xrcddocno,
              xrcdld,xrcdseq,xrcdseq2,xrcd007
              ,xrcdsite,xrcd002,xrcd003,xrcd006,xrcd004,xrcd104) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5]
              ,g_pmdt5_d[g_detail_idx].xrcdsite,g_pmdt5_d[g_detail_idx].xrcd002,g_pmdt5_d[g_detail_idx].xrcd003, 
                  g_pmdt5_d[g_detail_idx].xrcd006,g_pmdt5_d[g_detail_idx].xrcd004,g_pmdt5_d[g_detail_idx].xrcd104)  
 
         WHERE xrcdent = g_enterprise AND xrcddocno = ps_keys_bak[1] AND xrcdld = ps_keys_bak[2] AND xrcdseq = ps_keys_bak[3] AND xrcdseq2 = ps_keys_bak[4] AND xrcd007 = ps_keys_bak[5]
      #add-point:update_b段修改中 name="update_b.m_update4"
      
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "xrcd_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "xrcd_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE 
            LET g_errparam.popup = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL apmt860_xrcd_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update4"
      
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
 
   
 
   
   #add-point:update_b段other name="update_b.other"
            
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.key_update_b" >}
#+ 上層單身key欄位變動後, 連帶修正下層單身key欄位
PRIVATE FUNCTION apmt860_key_update_b(ps_keys_bak,ps_table)
   #add-point:update_b段define(客製用) name="key_update_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_key       DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_update_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_update_b.pre_function"
   
   #end add-point
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.key_delete_b" >}
#+ 上層單身刪除後, 連帶刪除下層單身key欄位
PRIVATE FUNCTION apmt860_key_delete_b(ps_keys_bak,ps_table)
   #add-point:delete_b段define(客製用) name="key_delete_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_delete_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_delete_b.pre_function"
   
   #end add-point
   
 
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.lock_b" >}
#+ 連動lock其他單身table資料
PRIVATE FUNCTION apmt860_lock_b(ps_table,ps_page)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"
   
   #end add-point   
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"
            
   #end add-point   
   
   #add-point:Function前置處理  name="lock_b.pre_function"
   
   #end add-point
    
   #先刷新資料
   #CALL apmt860_b_fill()
   
   #鎖定整組table
   #LET ls_group = "'1','4',"
   #僅鎖定自身table
   LET ls_group = "pmdt_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN apmt860_bcl USING g_enterprise,
                                       g_pmds_m.pmdsdocno,g_pmdt_d[g_detail_idx].pmdtseq     
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt860_bcl:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
                                    
   #鎖定整組table
   #LET ls_group = "'2',"
   #僅鎖定自身table
   LET ls_group = "pmdu_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt860_bcl2 USING g_enterprise,
                                             g_pmds_m.pmdsdocno,g_pmdt2_d[g_detail_idx].pmduseq,g_pmdt2_d[g_detail_idx].pmduseq1 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt860_bcl2:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'3',"
   #僅鎖定自身table
   LET ls_group = "pmdv_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt860_bcl3 USING g_enterprise,
                                             g_pmds_m.pmdsdocno,g_pmdt3_d[g_detail_idx].pmdvseq,g_pmdt3_d[g_detail_idx].pmdvseq1 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt860_bcl3:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'5',"
   #僅鎖定自身table
   LET ls_group = "xrcd_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN apmt860_bcl4 USING g_enterprise,
                                             g_pmds_m.pmdsdocno,g_pmdt5_d[g_detail_idx].xrcdld,g_pmdt5_d[g_detail_idx].xrcdseq, 
                                                 g_pmdt5_d[g_detail_idx].xrcdseq2,g_pmdt5_d[g_detail_idx].xrcd007 
 
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt860_bcl4:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
 
   
 
   
   #add-point:lock_b段other name="lock_b.other"
   LET ls_group = "pmdt_t1"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN apmt860_price USING g_enterprise,g_pmds_m.pmdsdocno,g_pmdt4_d[g_detail_idx].pmdtseq     
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apmt860_pmdt" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
   #end add-point  
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.unlock_b" >}
#+ 連動unlock其他單身table資料
PRIVATE FUNCTION apmt860_unlock_b(ps_table,ps_page)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"
   
   #end add-point  
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"
            
   #end add-point  
   
   #add-point:Function前置處理  name="unlock_b.pre_function"
   
   #end add-point
    
   LET ls_group = "'1','4',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt860_bcl
   END IF
   
   LET ls_group = "'2',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt860_bcl2
   END IF
 
   LET ls_group = "'3',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt860_bcl3
   END IF
 
   LET ls_group = "'5',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt860_bcl4
   END IF
 
 
   
 
 
   #add-point:unlock_b段other name="unlock_b.other"
   LET ls_group = "pmdt_t1"
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE apmt860_pmdt
   END IF
   #end add-point  
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_entry" >}
#+ 單頭欄位開啟設定
PRIVATE FUNCTION apmt860_set_entry(p_cmd)
   #add-point:set_entry段define(客製用) name="set_entry.define_customerization"
   
   #end add-point       
   DEFINE p_cmd   LIKE type_t.chr1  
   #add-point:set_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry.define"
            
   #end add-point       
   
   #add-point:Function前置處理  name="set_entry.pre_function"
   
   #end add-point
   
   CALL cl_set_comp_entry("pmdsdocno",TRUE)
   
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("pmdsdocno",TRUE)
      CALL cl_set_comp_entry("pmdsdocdt",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry段欄位控制 name="set_entry.field_control"
      CALL cl_set_comp_entry("pmdsdocdt",TRUE)
      #end add-point  
   END IF
   
   #add-point:set_entry段欄位控制後 name="set_entry.after_control"
   CALL cl_set_comp_entry("pmds007",TRUE)   #採購供應商
   CALL cl_set_comp_entry("pmds008",TRUE)   #帳款供應商
   CALL cl_set_comp_entry("pmds009",TRUE)   #送貨供應商
   CALL cl_set_comp_entry("pmds048",TRUE)   #內外購
   CALL cl_set_comp_entry("pmds049",TRUE)   #匯率計算基準
   CALL cl_set_comp_entry("pmds031",TRUE)   #付款條件
   CALL cl_set_comp_entry("pmds032",TRUE)   #交易條件
   CALL cl_set_comp_entry("pmds037",TRUE)   #幣別
   CALL cl_set_comp_entry("pmds033",TRUE)   #稅別
   CALL cl_set_comp_entry("pmds200",TRUE)   #預約收貨單
   CALL cl_set_comp_entry("pmds006",TRUE)   #來源單號
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_no_entry" >}
#+ 單頭欄位關閉設定
PRIVATE FUNCTION apmt860_set_no_entry(p_cmd)
   #add-point:set_no_entry段define(客製用) name="set_no_entry.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry.define"
   DEFINE l_cnt   LIKE type_t.num5
   #end add-point     
   
   #add-point:Function前置處理  name="set_no_entry.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("pmdsdocno",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry段欄位控制 name="set_no_entry.field_control"
      CALL cl_set_comp_entry("pmdsdocdt",FALSE)
      #end add-point 
   END IF 
   
   IF p_cmd = 'u' THEN  #docno,ld欄位確認是絕對關閉
      CALL cl_set_comp_entry("pmdsdocno",FALSE)
   END IF 
 
#  IF p_cmd = 'u' THEN  #docdt欄位依照設定關閉(FALSE則為設定不同意修正) #(ver:78)
      IF NOT cl_chk_update_docdt() THEN
         CALL cl_set_comp_entry("pmdsdocdt",FALSE)
      END IF
#  END IF 
   
   #add-point:set_no_entry段欄位控制後 name="set_no_entry.after_control"
   #當收貨預約單號有值
   #來源單號(pmds006) 採購供應商(pmds007) 送貨供應商(pmds008)不可維護
   IF NOT cl_null(g_pmds_m.pmds200) THEN
      CALL cl_set_comp_entry("pmds006",FALSE)   #來源單號
      CALL cl_set_comp_entry("pmds007",FALSE)   #採購供應商
      CALL cl_set_comp_entry("pmds009",FALSE)   #送貨供應商
   END IF
   
   #當來源單號有值
   IF NOT cl_null(g_pmds_m.pmds006) THEN
      CALL cl_set_comp_entry("pmds007",FALSE)   #採購供應商
      CALL cl_set_comp_entry("pmds008",FALSE)   #帳款供應商
      CALL cl_set_comp_entry("pmds009",FALSE)   #送貨供應商
   END IF
   
   LET l_cnt = 0
   SELECT COUNT(pmdtseq) INTO l_cnt
     FROM pmdt_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmds_m.pmdsdocno
   
   IF l_cnt >= 1 THEN
      CALL cl_set_comp_entry("pmds200",FALSE)   #預約收貨單
      CALL cl_set_comp_entry("pmds006",FALSE)   #來源單號
      CALL cl_set_comp_entry("pmds007",FALSE)   #採購供應商
      CALL cl_set_comp_entry("pmds008",FALSE)   #帳款供應商
      CALL cl_set_comp_entry("pmds009",FALSE)   #送貨供應商
      CALL cl_set_comp_entry("pmds048",FALSE)   #內外購
      CALL cl_set_comp_entry("pmds049",FALSE)   #匯率計算基準
      CALL cl_set_comp_entry("pmds031",FALSE)   #付款條件
      CALL cl_set_comp_entry("pmds032",FALSE)   #交易條件
      CALL cl_set_comp_entry("pmds037",FALSE)   #幣別
      CALL cl_set_comp_entry("pmds033",FALSE)   #稅別
   END IF  
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_entry_b" >}
#+ 單身欄位開啟設定
PRIVATE FUNCTION apmt860_set_entry_b(p_cmd)
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
            
   #end add-point     
   
   #add-point:Function前置處理  name="set_entry_b.pre_function"
   
   #end add-point
    
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("",TRUE)
      #add-point:set_entry段欄位控制 name="set_entry_b.field_control"
      
      #end add-point  
   END IF
   
   #add-point:set_entry_b段 name="set_entry_b.set_entry_b"
   CALL cl_set_comp_entry("pmdt001",TRUE)   #採購單號
   CALL cl_set_comp_entry("pmdt002",TRUE)   #採購項次
   CALL cl_set_comp_entry("pmdt003",TRUE)   #採購項序
   CALL cl_set_comp_entry("pmdt004",TRUE)   #採購分批序
   CALL cl_set_comp_entry("pmdt028",TRUE)   #收貨項次
   CALL cl_set_comp_entry("pmdt200",TRUE)   #商品條碼
   CALL cl_set_comp_entry("pmdt006",TRUE)   #商品編號
   CALL cl_set_comp_entry("pmdt007",TRUE)   #產品特徵
   #CALL cl_set_comp_entry("pmdt019",TRUE)   #收貨單位
   #CALL cl_set_comp_entry("pmdt023",TRUE)   #計價單位
   CALL cl_set_comp_entry("pmdt016",TRUE)   #庫位
   CALL cl_set_comp_entry("pmdt017",TRUE)   #儲位
   CALL cl_set_comp_entry("pmdt018",TRUE)   #批號
   CALL cl_set_comp_entry("pmdt063",TRUE)   #庫存管理特徵
   CALL cl_set_comp_entry("pmdt062",TRUE)   #多庫儲批
   CALL cl_set_comp_entry("pmdt020",TRUE)   #收貨數量
   CALL cl_set_comp_entry("pmdt202",TRUE)   #包裝數量
   CALL cl_set_comp_entry("pmdt053",TRUE)   #允收數量
   CALL cl_set_comp_entry("pmdt089",TRUE)   #有效日期
   CALL cl_set_comp_entry("pmdt219",TRUE)   #製造日期
   CALL cl_set_comp_entry("pmdt036",TRUE)   #單價 #150506-00032#10 150527 by sakura add
   CALL cl_set_comp_entry("pmdt220",TRUE)   #151202-00010#1 s983961--add
   CALL cl_set_comp_entry("pmdt221",TRUE)   #151202-00010#1 s983961--add
   #end add-point  
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_no_entry_b" >}
#+ 單身欄位關閉設定
PRIVATE FUNCTION apmt860_set_no_entry_b(p_cmd)
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"
   
   #end add-point    
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   DEFINE l_imaa005   LIKE imaa_t.imaa005
   DEFINE l_pmdn028   LIKE pmdn_t.pmdn028
   DEFINE l_pmdn029   LIKE pmdn_t.pmdn029
   DEFINE l_pmdn030   LIKE pmdn_t.pmdn030
   DEFINE l_imaf055   LIKE imaf_t.imaf055
   DEFINE l_imaf061   LIKE imaf_t.imaf061
   DEFINE l_pmdt016   LIKE pmdt_t.pmdt016
   DEFINE l_pmdt017   LIKE pmdt_t.pmdt017
   DEFINE l_pmdt018   LIKE pmdt_t.pmdt018
   DEFINE l_inaa007   LIKE inaa_t.inaa007
   DEFINE l_success   LIKE type_t.num5
   DEFINE l_set_entry LIKE type_t.num5
   DEFINE l_stan024   LIKE stan_t.stan024   #150506-00032#10 150527 by sakura add   
   DEFINE l_type      LIKE type_t.num5      #150427-00001#5 150514 by lori522612 add 
   #end add-point    
   
   #add-point:Function前置處理  name="set_no_entry_b.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"
      
      #end add-point 
   END IF 
   
   #add-point:set_no_entry_b段 name="set_no_entry_b.set_no_entry_b"
   #1.收貨預約單號
   IF NOT cl_null(g_pmds_m.pmds200) THEN
      CALL cl_set_comp_entry("pmdt001",FALSE)   #採購單號
      CALL cl_set_comp_entry("pmdt002",FALSE)   #採購項次
      CALL cl_set_comp_entry("pmdt003",FALSE)   #採購項序
      CALL cl_set_comp_entry("pmdt004",FALSE)   #採購分批序
   END IF
   
   #2.收貨項次
   IF g_argv[1] MATCHES '[1234]' OR cl_null(g_pmds_m.pmds006) OR g_argv[1] = '22' THEN  #add by yangxf g_argv[1] = '22'
      CALL cl_set_comp_entry("pmdt028",FALSE)   #收貨項次
      CALL cl_set_comp_entry("pmdt220,pmdt221",FALSE)   #收貨項次
   END IF
   
   #3.採購單號
   IF NOT cl_null(g_pmds_m.pmds006) THEN
      CALL cl_set_comp_entry("pmdt001",FALSE)   #採購單號
   END IF
   
   # 3-1.當單身採購單號有值
   IF NOT cl_null(g_pmdt_d[l_ac].pmdt001) THEN
      CALL cl_set_comp_entry("pmdt200",FALSE)   #商品條碼
      CALL cl_set_comp_entry("pmdt006",FALSE)   #商品編號
      CALL cl_set_comp_entry("pmdt007",FALSE)   #產品特徵
      #CALL cl_set_comp_entry("pmdt019",FALSE)   #收貨單位
      #CALL cl_set_comp_entry("pmdt023",FALSE)   #計價單位
   END IF
   
   
   #4.當料件有使用產品特徵功能時此欄位才可輸入
   LET l_imaa005  = ''
   SELECT imaa005 INTO l_imaa005
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdt_d[l_ac].pmdt006
   IF cl_null(l_imaa005) THEN
      CALL cl_set_comp_entry("pmdt007",FALSE)
   END IF
      
   #6.單前單據有限定庫位、儲位、批號
   # 6-1.當前單據有限定庫位，庫位欄位不可以維護
   IF g_pmds_m.pmds000 = '3' AND g_pmdt_d[l_ac].pmdt214 MATCHES '[012]' THEN  #160304-00027#1 160307 By pomelo add
      IF NOT cl_null(g_pmdt016) AND g_pmds_m.pmds000 MATCHES '[123456]' THEN
         CALL cl_set_comp_entry("pmdt016",FALSE)
      END IF
      
      # 6-2.當前單據有限定儲位 或 庫位為空，儲位欄位不可以維護
      IF (NOT cl_null(g_pmdt017) AND g_pmds_m.pmds000 MATCHES '[123456]') OR
         cl_null(g_pmdt_d[l_ac].pmdt016) THEN
         CALL cl_set_comp_entry("pmdt017",FALSE)
      END IF
   END IF #160304-00027#1 160307 By pomelo add
   
   # 6-3.當前單據有限定批號 或 儲位為空，批號欄位不可以維護
   IF (NOT cl_null(g_pmdt018) AND g_pmds_m.pmds000 MATCHES '[123456]') OR
      cl_null(g_pmdt_d[l_ac].pmdt017) THEN
      CALL cl_set_comp_entry("pmdt018",FALSE)
   END IF
   
   # 6-4.當前單據有庫存管理特徵，庫存管理特徵欄位不可維護
   IF NOT cl_null(g_pmdt063) AND g_pmds_m.pmds000 MATCHES '[123456]' THEN
      CALL cl_set_comp_entry("pmdt063",FALSE)
   END IF
      
   # 6-5.當多庫儲批 = 'Y'，限定庫位、儲位、批號、庫存管理特徵 不可以輸入
   IF g_pmdt_d[l_ac].pmdt062 = 'Y' THEN
      CALL cl_set_comp_entry("pmdt016",FALSE)    #庫位
      CALL cl_set_comp_entry("pmdt017",FALSE)    #儲位
      CALL cl_set_comp_entry("pmdt018",FALSE)    #批號
      CALL cl_set_comp_entry("pmdt063",FALSE)    #庫存管理特徵
      CALL cl_set_comp_entry("pmdt089",FALSE)    #有效日期
      CALL cl_set_comp_entry("pmdt219",FALSE)    #製造日期
   END IF
   
   # 6-6.當為採購驗退單 且 有來源出貨單號時
   #     庫位、儲位、批號、庫存管理特徵 不可以輸入
   IF g_argv[1] MATCHES '[5]' AND NOT cl_null(g_pmdt_d[l_ac].pmdt027) THEN
      CALL cl_set_comp_entry("pmdt016",FALSE)    #庫位
      CALL cl_set_comp_entry("pmdt017",FALSE)    #儲位
      CALL cl_set_comp_entry("pmdt018",FALSE)    #批號
      CALL cl_set_comp_entry("pmdt063",FALSE)    #庫存管理特徵
      CALL cl_set_comp_entry("pmdt062",FALSE)    #多庫儲批
   END IF
   
   # 6-7.若該庫位設置不做儲位管理時，則儲位欄位不可以維護
    IF NOT cl_null(g_pmdt_d[l_ac].pmdt016) THEN
       LET l_inaa007 = ''
       CALL s_apmt860_get_inaa007(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016)
          RETURNING l_inaa007
       IF l_inaa007 = '5' THEN  
          CALL cl_set_comp_entry("pmdt017",FALSE)
       END IF
    END IF
    
    # 6-8.庫存批號控管方式 = 2.不可有批號 才可以輸入
    LET l_imaf055 = ''
    LET l_imaf061 = ''
    CALL s_apmt860_get_imaf(g_pmdt_d[l_ac].pmdt006) RETURNING l_imaf055,l_imaf061
    #150427-00001#8 1500601 by lori522612 mark and add---(S)
    #IF l_imaf061 = '2' THEN
    #   CALL cl_set_comp_entry("pmdt018",FALSE)
    #END IF
    LET l_success = ''  
    LET l_set_entry = ''
    
    CASE 
       WHEN g_argv[1] MATCHES '[7]'       #出項
          LET l_type = -1
       WHEN g_argv[1] MATCHES '[12346]' OR g_argv[1] = '22'  #入項  #add by yangxf g_argv[1] = '22'
          LET l_type = 1
    END CASE
    IF g_argv[1] != '22' THEN #add by yangxf g_argv[1] = '22'
       CALL s_lot_out_entry(l_type,g_pmds_m.pmdsdocno,g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt006) 
          RETURNING l_success,l_set_entry
       IF l_success THEN
          CALL cl_set_comp_entry("pmdt018",l_set_entry) 
       END IF    
    END IF   #add by yangxf g_argv[1] = '22'
    #150427-00001#8 1500601 by lori522612 mark and add---(E)

    # 6-8.庫存管理特徵= 2.不可有庫存管理特徵，不可輸入
    IF l_imaf055 = '2' THEN
       CALL cl_set_comp_entry("pmdt063",FALSE)
    END IF

   #7.入庫、驗退、倉退時，來源單據有維護庫儲批 則，不可再修改
   IF g_argv[1] MATCHES '[567]'  THEN
      CALL cl_set_comp_entry("pmdt001",FALSE)   #採購單號
      CALL cl_set_comp_entry("pmdt002",FALSE)   #採購項次
      CALL cl_set_comp_entry("pmdt003",FALSE)   #採購項序
      CALL cl_set_comp_entry("pmdt004",FALSE)   #採購分批序
   END IF
   
   #8.倉退單，當倉退方式為'4:'價格折讓'時，數量欄位預設為0且不可以維護
   IF g_argv[1] = '7' AND g_pmds_m.pmds100 = '4' THEN
      CALL cl_set_comp_entry("pmdt020",FALSE)   #收貨數量
      CALL cl_set_comp_entry("pmdt202",FALSE)   #包裝數量
   END IF

   #9.當採購數量有值，包裝數量不可以維護
   IF NOT cl_null(g_pmdt_d[l_ac].pmdt020) THEN
      CALL cl_set_comp_entry("pmdt202",FALSE)   #包裝數量
   END IF
   
   #10.當為(無)採購收貨單 (無)採購收貨入庫單時
   #檢驗 = 'N'，允收數量不可以維護
   IF (g_argv[1] MATCHES '[1234]' OR g_argv[1] = '22') AND g_pmdt_d[l_ac].pmdt026 = 'N' THEN   #add by yangxf g_argv[1] = '22'
      CALL cl_set_comp_entry("pmdt053",FALSE)   #允收數量
   END IF
   
   #11.當為(無)採購收貨單 (無)採購收貨入庫單 採購入庫單時
   # 批號不為空時，依照商品是否維護有效日期
   #IF g_argv[1] MATCHES '[12346]' AND NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN    ##150613 by lori mark
   IF g_argv[1] MATCHES '[12346]' THEN                         ##150613 by lori add  
      LET l_success = ''
      LET l_set_entry = ''
      CALL s_lot_out_effdate_entry(g_pmds_m.pmdssite,      g_pmdt_d[l_ac].pmdt006,
                                   g_pmdt_d[l_ac].pmdt007, g_pmdt_d[l_ac].pmdt018)
         RETURNING l_success,l_set_entry
      IF l_success THEN
         CALL cl_set_comp_entry("pmdt089",l_set_entry)
         CALL cl_set_comp_entry("pmdt219",l_set_entry)   #160615-00028#3 Add By Ken 160623
      END IF
   END IF
   
   #150506-00032#10 150527 by sakura add---STR
   #合約:採購價格允許人工修改 = 'N',單價不可以維護
   SELECT stan024 INTO l_stan024
     FROM stan_t
    WHERE stanent = g_enterprise
      AND stan001 = g_pmdt_d[l_ac].pmdt212    
   IF (g_argv[1] MATCHES '[24]' OR g_argv[1] = '22') AND l_stan024 = 'N' THEN   #add by yangxf g_argv[1] = '22'
      CALL cl_set_comp_entry("pmdt036",FALSE)  #單價
   END IF
   #150506-00032#10 150527 by sakura add---END
    #add by yangxf ---start---
    IF g_argv[1] = '22' THEN 
       CALL cl_set_comp_entry("pmdt018,pmdt036",TRUE) 
    END IF 
    #add by yangxf ---end----
   
   #來源商品品類   
   #151202-00010#1 s983961--add(s)      
   IF NOT g_argv[1] MATCHES '[13]' THEN    
      CALL cl_set_comp_visible("pmdt221,pmdt221_desc",FALSE)
   END IF       
   #end add-point     
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_act_visible" >}
#+ 單頭權限開啟
PRIVATE FUNCTION apmt860_set_act_visible()
   #add-point:set_act_visible段define(客製用) name="set_act_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible.define"
   
   #end add-point   
   #add-point:set_act_visible段 name="set_act_visible.set_act_visible"
   #基本操作action
   CALL cl_set_act_visible("modify",TRUE)               #修改
   CALL cl_set_act_visible("delete",TRUE)               #刪除
   CALL cl_set_act_visible("modify_detail",TRUE)        #修改單身
   CALL cl_set_act_visible("reproduce",TRUE)            #複製
   
   #整單明細action
   CALL cl_set_act_visible("upd_price",TRUE)            #價格變更
   CALL cl_set_act_visible("batch_price",TRUE)          #批次重新取價 #150506-00032#10 150527 by sakura add
   CALL cl_set_act_visible("open_apmt860_01",TRUE)      #產生收貨明細單身
   CALL cl_set_act_visible("gen_apmt880_apmt870",TRUE)  #產生入庫/驗退單
   CALL cl_set_act_visible("gen_purchase",TRUE)         #產生採購單
   CALL cl_set_act_visible("gen_aint510",TRUE)          #產生調撥單
   CALL cl_set_act_visible("upd_pmds052",TRUE)          #維護供應商出貨單
   CALL cl_set_act_visible("query_apmt880",TRUE)        #查詢入庫單
   CALL cl_set_act_visible("query_apmt870",TRUE)        #查詢驗退單
   CALL apmt860_set_act_visible_b()
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_act_no_visible" >}
#+ 單頭權限關閉
PRIVATE FUNCTION apmt860_set_act_no_visible()
   #add-point:set_act_no_visible段define(客製用) name="set_act_no_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible.define"
   DEFINE l_cnt            LIKE type_t.num5
   DEFINE l_aint510_cnt    LIKE type_t.num5
   #end add-point   
   #add-point:set_act_no_visible段 name="set_act_no_visible.set_act_no_visible"
   #1.單身沒有資料
   LET l_cnt = 0
   SELECT COUNT(pmdtseq) INTO l_cnt
     FROM pmdt_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmds_m.pmdsdocno
   IF l_cnt = 0 THEN
      CALL cl_set_act_visible("upd_price",FALSE)            #價格變更
      CALL cl_set_act_visible("batch_price",FALSE)          #批次重新取價 #150506-00032#10 150527 by sakura add
   END IF
   
   #2.單據狀態不為N未確認/D抽單/R已拒絕
   IF g_pmds_m.pmdsstus NOT MATCHES '[NDR]' THEN
      CALL cl_set_act_visible("modify",FALSE)               #修改
      CALL cl_set_act_visible("delete",FALSE)               #刪除
      CALL cl_set_act_visible("modify_detail",FALSE)        #修改單身
      CALL cl_set_act_visible("reproduce",FALSE)            #複製
      CALL cl_set_act_visible("upd_price",FALSE)            #價格變更
      CALL cl_set_act_visible("batch_price",FALSE)          #批次重新取價 #150506-00032#10 150527 by sakura add 
      CALL cl_set_act_visible("upd_pmds052",FALSE)          #維護供應商出貨單
      CALL cl_set_act_visible("open_apmt860_01",FALSE)      #產生收貨明細單身
   END IF
   
   #3.當無採購收貨(入庫)單，才提供複製功能
   IF g_argv[1] NOT MATCHES '[24]' OR g_argv[1] = '22' THEN #add by yangxf add g_argv[1] = '22'
      CALL cl_set_act_visible("reproduce",FALSE)            #複製
   END IF
   
   #4.當單據狀態為作廢
   IF g_pmds_m.pmdsstus = 'X' THEN
      CALL cl_set_act_visible("upd_pmds081",FALSE)          #取回
   END IF
   
   #5.當(無)採購收貨單 且 單據狀態 = 'Y'，才可以產生入庫/驗退單
   IF NOT(g_argv[1] MATCHES '[12]' AND g_pmds_m.pmdsstus = 'Y') THEN
      CALL cl_set_act_visible("gen_apmt880_apmt870",FALSE)  #產生入庫/驗退單
   END IF
   
   #6.當採購倉退單 且 單據狀態 = 'S' 且 倉退方式 = 3.倉退產生新採購單收貨
   #  才可以產生採購單
   IF NOT(g_argv[1] = '7' AND g_pmds_m.pmdsstus = 'S'
      AND g_pmds_m.pmds100 = '3') THEN
      CALL cl_set_act_visible("gen_purchase",FALSE)         #產生採購單
   END IF
   
   #7.當採購(收貨)入庫單 且 單身採購性質 = 3.統採越庫，才可以產生調撥單
   LET l_cnt = 0
   SELECT COUNT(pmdtseq) INTO l_cnt
     FROM pmdt_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmds_m.pmdsdocno
      AND pmdt214 = '3'
   LET l_aint510_cnt = 0
   SELECT COUNT(inddseq) INTO l_aint510_cnt
     FROM indc_t,indd_t
    WHERE indcent = inddent
      AND indcdocno = indddocno
      AND inddent = g_enterprise
      AND indd101 = g_pmds_m.pmdsdocno
      AND indcstus != 'X'
   #IF g_argv[1] MATCHES '[36]' AND l_cnt = 0 AND   #160324-00015#1 160325 By pomelo mark
   IF g_argv[1] MATCHES '[36]' AND l_cnt >= 1 AND   #160324-00015#1 160325 By pomelo add
      l_aint510_cnt >= 1 AND g_pmds_m.pmdsstus = 'S' THEN
      CALL cl_set_act_visible("gen_aint510",FALSE)          #產生調撥單
   END IF
   
   #8.當(無)採購收貨單 且 已拋轉採購入庫單
   IF NOT (g_argv[1] MATCHES '[12]' AND 
      NOT s_apmt860_cnt_turn_docno('6',g_pmds_m.pmdsdocno)) THEN
      CALL cl_set_act_visible("query_apmt880",FALSE)        #查詢入庫單
   END IF
   
   #9.當(無)採購收貨單 且 已拋轉採購驗退單
   IF NOT (g_argv[1] MATCHES '[12]' AND 
      NOT s_apmt860_cnt_turn_docno('5',g_pmds_m.pmdsdocno)) THEN
      CALL cl_set_act_visible("query_apmt870",FALSE)        #查詢驗退單
   END IF
   
   #150506-00032#10 150527 by sakura add---STR
   #合約採購價格允許人工修改 = 'N',則不能維護[變更單價]
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt
    FROM stan_t
   WHERE stanent = g_enterprise
     AND stan024 = 'Y'
     AND stan001 IN (SELECT DISTINCT pmdt212 
                       FROM pmdt_t 
                      WHERE pmdtent = g_enterprise
                        AND pmdtdocno = g_pmds_m.pmdsdocno)
   IF l_cnt = 0 THEN
      CALL cl_set_act_visible("upd_price",FALSE) #價格變更
   END IF  
   #當為採購退廠單且有來源(收貨單)時,則不能維護[變更單價]
   IF g_argv[1] = '7' AND NOT cl_null(g_pmds_m.pmds006) THEN
      CALL cl_set_act_visible("upd_price",FALSE) #價格變更
   END IF   
   #150506-00032#10 150527 by sakura add---END
   
   #150608-00012#3 Add By Ken 150627(S)
   #apmt881、apmt891 只能查詢
   #IF (g_argv[1] = '16') OR (g_argv[1] = '17') THEN   
   IF (g_argv[1] = '16') OR (g_argv[1] = '17') OR (g_argv[1] = '18') THEN #151104-00007#1 Add By Ken 151109 加上 g_arvg[1]=18
      CALL cl_set_act_visible("insert",FALSE)               #新增
      CALL cl_set_act_visible("modify",FALSE)               #修改
      CALL cl_set_act_visible("delete",FALSE)               #刪除
      CALL cl_set_act_visible("modify_detail",FALSE)        #修改單身
      CALL cl_set_act_visible("reproduce",FALSE)            #複製  
      CALL cl_set_act_visible("statechange",FALSE)         #狀態
   END IF      
   #150608-00012#3 Add By Ken 150627(E)
   
   CALL apmt860_set_act_no_visible_b()
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_act_visible_b" >}
#+ 單身權限開啟
PRIVATE FUNCTION apmt860_set_act_visible_b()
   #add-point:set_act_visible_b段define(客製用) name="set_act_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible_b.define"
   
   #end add-point   
   #add-point:set_act_visible_b段 name="set_act_visible_b.set_act_visible_b"

   #明細明細action
   CALL cl_set_act_visible("open_apmt860_03",TRUE)         #維護多庫儲批資料
   CALL cl_set_act_visible("open_apmt860_02",TRUE)         #重新產生原始需求分配
   CALL cl_set_act_visible("query_detail_aapt110_01",TRUE) #明細發票查詢
   #CALL cl_set_act_visible("detail_qrystr",TRUE)           #150416-00001#1 150724 by sakura add   #151125-00007#1 mark
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.set_act_no_visible_b" >}
#+ 單身權限關閉
PRIVATE FUNCTION apmt860_set_act_no_visible_b()
   #add-point:set_act_no_visible_b段define(客製用) name="set_act_no_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible_b.define"
   DEFINE l_cnt          LIKE type_t.num5
   #end add-point   
   #add-point:set_act_no_visible_b段 name="set_act_no_visible_b.set_act_no_visible_b"
   #單身沒資料的時候
   LET l_cnt = 0
   SELECT COUNT(pmdtseq) INTO l_cnt
     FROM pmdt_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmds_m.pmdsdocno
   IF l_cnt = 0 THEN
      CALL cl_set_act_visible("open_apmt860_03",FALSE)         #維護多庫儲批資料
      CALL cl_set_act_visible("open_apmt860_02",FALSE)         #重新產生原始需求分配
      CALL cl_set_act_visible("query_detail_aapt110_01",FALSE) #明細發票查詢
   #151125-00007#1 mark(S)
   ##150416-00001#1 150724 by sakura add(S)   
   #   CALL cl_set_act_visible("detail_qrystr",FALSE)
   #ELSE
   #   IF g_argv[1] = '7' THEN
   #      IF cl_null(g_pmdt_d[g_detail_idx].pmdt216) AND cl_null(g_pmdt_d[g_detail_idx].pmdt001) THEN
   #         CALL cl_set_act_visible("detail_qrystr",FALSE)
   #      END IF
   #   ELSE
   #      IF cl_null(g_pmdt_d[g_detail_idx].pmdt001) THEN
   #         CALL cl_set_act_visible("detail_qrystr",FALSE)
   #      END IF      
   #   END IF
   ##150416-00001#1 150724 by sakura add(E)
   #151125-00007#1 mark(E)
   END IF 
   #單據狀態不為N.未確認
   IF g_pmds_m.pmdsstus != 'N' THEN
      CALL cl_set_act_visible("open_apmt860_03",FALSE)      #維護多庫儲批資料
      CALL cl_set_act_visible("open_apmt860_02",FALSE)      #重新產生原始需求分配
   END IF
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.default_search" >}
#+ 外部參數搜尋
PRIVATE FUNCTION apmt860_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"
   
   #end add-point  
   DEFINE li_idx     LIKE type_t.num10
   DEFINE li_cnt     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
            
   #end add-point  
   
   #add-point:Function前置處理 name="default_search.before"
            
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " pmdsdocno = '", g_argv[02], "' AND "
   END IF
   
 
   
   #add-point:default_search段after sql name="default_search.after_sql"
   #傳單號範圍至apmt860,一次查詢可查詢出多個單號資料
   IF NOT cl_null(g_argv[03]) THEN
      LET ls_wc = ls_wc , g_argv[03], " AND "
   END IF
   #end add-point  
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      #若無外部參數則預設為1=2
      LET g_default = FALSE
      
      #預設查詢條件
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc2_table2 TO NULL
 
         INITIALIZE g_wc2_table3 TO NULL
 
         INITIALIZE g_wc2_table4 TO NULL
 
 
         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "pmds_t" 
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "pmdt_t" 
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "pmdu_t" 
                  LET g_wc2_table2 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "pmdv_t" 
                  LET g_wc2_table3 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "xrcd_t" 
                  LET g_wc2_table4 = la_wc[li_idx].wc
 
 
               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
            OR NOT cl_null(g_wc2_table2)
 
            OR NOT cl_null(g_wc2_table3)
 
            OR NOT cl_null(g_wc2_table4)
 
 
            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
            END IF
 
            IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
            END IF
 
            IF g_wc2_table4 <> " 1=1" AND NOT cl_null(g_wc2_table4) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table4
            END IF
 
 
            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF
         
            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
    
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
   END IF
   
   #add-point:default_search段結束前 name="default_search.after"
   IF NOT cl_null(g_argv[01]) THEN
      LET g_wc = g_wc , " AND pmds000 = '", g_argv[01], "' "
   END IF
   #end add-point  
 
   IF g_wc.getIndexOf(" 1=2", 1) THEN
      LET g_default = TRUE
   END IF
 
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.state_change" >}
   #應用 a09 樣板自動產生(Version:17)
#+ 確認碼變更 
PRIVATE FUNCTION apmt860_statechange()
   #add-point:statechange段define(客製用) name="statechange.define_customerization"
   
   #end add-point  
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="statechange.define"
   DEFINE l_success LIKE type_t.num5 
   #add by geza 20151202(S)  
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD       
   DEFINE ls_js      STRING
   DEFINE ls_js1     STRING    
   DEFINE l_comp       LIKE ooef_t.ooef001
   DEFINE g_glaa003    LIKE glaa_t.glaa003
   DEFINE g_glaa024    LIKE glaa_t.glaa024
   DEFINE l_stbasite   LIKE stba_t.stbasite
   DEFINE l_ooba002    LIKE ooba_t.ooba002
   DEFINE l_ooba002_1  LIKE ooba_t.ooba002
   DEFINE g_ld         LIKE apca_t.apcald
   DEFINE l_errno        LIKE type_t.chr100
   #add by geza 20151202(E)
   #add by 08172
   DEFINE   l_ooac002      LIKE ooac_t.ooac002
   DEFINE   l_ooac004      LIKE ooac_t.ooac004
   DEFINE   l_flag1        LIKE type_t.num5 
   #add by 08172   
   #end add-point  
   
   #add-point:Function前置處理 name="statechange.before"
   IF g_pmds_m.pmdsstus = 'X' THEN
      RETURN
   END IF
   #end add-point  
   
   ERROR ""     #清空畫面右下側ERROR區塊
 
   IF g_pmds_m.pmdsdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   CALL s_transaction_begin()
   
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt860_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
       g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
       g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
       g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
       g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp, 
       g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc, 
       g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc, 
       g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc, 
       g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc 
 
   
 
   #檢查是否允許此動作
   IF NOT apmt860_action_chk() THEN
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdssite_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
       g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds002_desc,g_pmds_m.pmds003, 
       g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds007_desc,g_pmds_m.pmds008, 
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010,g_pmds_m.pmds052, 
       g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201,g_pmds_m.pmds021, 
       g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031, 
       g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds037,g_pmds_m.pmds037_desc, 
       g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101, 
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046, 
       g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid, 
       g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid, 
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt, 
       g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt
 
   CASE g_pmds_m.pmdsstus
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      WHEN "S"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "D"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      WHEN "W"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
      WHEN "X"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
      WHEN "Z"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
      
   END CASE
 
   #add-point:資料刷新後 name="statechange.after_refresh"
   
   #end add-point
 
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_pmds_m.pmdsstus
            
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "Y"
               HIDE OPTION "confirmed"
            WHEN "S"
               HIDE OPTION "posted"
            WHEN "A"
               HIDE OPTION "approved"
            WHEN "D"
               HIDE OPTION "withdraw"
            WHEN "R"
               HIDE OPTION "rejection"
            WHEN "W"
               HIDE OPTION "signing"
            WHEN "X"
               HIDE OPTION "invalid"
            WHEN "Z"
               HIDE OPTION "unposted"
         END CASE
     
      #add-point:menu前 name="statechange.before_menu"
      CALL cl_set_act_visible("confirmed",TRUE)     #確認
      CALL cl_set_act_visible("unconfirmed",TRUE)   #取消確認
      CALL cl_set_act_visible("posted",TRUE)        #過帳
      CALL cl_set_act_visible("unposted",TRUE)      #取消過帳
      CALL cl_set_act_visible("invalid",TRUE)       #作廢
      CALL cl_set_act_visible("signing,withdraw",FALSE)
      
      #入庫單、倉退單才有過賬功能
      IF g_argv[1] MATCHES '[125]'THEN
         CALL cl_set_act_visible("posted",FALSE)     #過帳
         CALL cl_set_act_visible("unposted",FALSE)   #取消過帳
      END IF
      
      CASE g_pmds_m.pmdsstus
         WHEN "N"
            CALL cl_set_act_visible("unconfirmed",FALSE)   #取消確認
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
            #需提交至BPM時，則顯示「提交」功能並隱藏「確認」功能
            IF cl_bpm_chk() THEN
               CALL cl_set_act_visible("signing",TRUE)
               CALL cl_set_act_visible("confirmed",FALSE)
            END IF
         WHEN "R"    #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed,hold",FALSE)
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
         WHEN "D"    #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed,hold",FALSE)
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
         WHEN "X"
            CALL cl_set_act_visible("confirmed",FALSE)     #確認
            CALL cl_set_act_visible("unconfirmed",FALSE)   #取消確認
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
            CALL cl_set_act_visible("invalid",FALSE)       #作廢
            
         WHEN "Y"
            CALL cl_set_act_visible("confirmed",FALSE)     #確認
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
            CALL cl_set_act_visible("invalid",FALSE)       #作廢
            
         WHEN "S"
            CALL cl_set_act_visible("confirmed",FALSE)     #確認
            CALL cl_set_act_visible("unconfirmed",FALSE)   #取消確認
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("invalid",FALSE)       #作廢
         WHEN "W"    #只能顯示抽單;其餘應用功能皆隱藏
            CALL cl_set_act_visible("withdraw",TRUE)
            CALL cl_set_act_visible("unconfirmed,invalid,confirmed,hold",FALSE)
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
         WHEN "A"    #只能顯示確認; 其餘應用功能皆隱藏
            CALL cl_set_act_visible("confirmed",TRUE)
            CALL cl_set_act_visible("unconfirmed,invalid,hold",FALSE)
            CALL cl_set_act_visible("posted",FALSE)        #過帳
            CALL cl_set_act_visible("unposted",FALSE)      #取消過帳
      END CASE                  
      #end add-point
      
      #應用 a36 樣板自動產生(Version:5)
      #提交
      ON ACTION signing
         IF cl_auth_chk_act("signing") THEN
            IF NOT apmt860_send() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE apmt860_cl
            RETURN
         END IF
    
      #抽單
      ON ACTION withdraw
         IF cl_auth_chk_act("withdraw") THEN
            IF NOT apmt860_draw_out() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE apmt860_cl
            RETURN
         END IF
 
 
 
	  
      ON ACTION unconfirmed
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制 name="statechange.unconfirmed"
 
            #end add-point
         END IF
         EXIT MENU
      ON ACTION confirmed
         IF cl_auth_chk_act("confirmed") THEN
            LET lc_state = "Y"
            #add-point:action控制 name="statechange.confirmed"
                  
            #end add-point
         END IF
         EXIT MENU
      ON ACTION posted
         IF cl_auth_chk_act("posted") THEN
            LET lc_state = "S"
            #add-point:action控制 name="statechange.posted"
     
            #end add-point
         END IF
         EXIT MENU
      ON ACTION approved
         IF cl_auth_chk_act("approved") THEN
            LET lc_state = "A"
            #add-point:action控制 name="statechange.approved"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION withdraw
      #   IF cl_auth_chk_act("withdraw") THEN
      #      LET lc_state = "D"
      #      #add-point:action控制 name="statechange.withdraw"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION rejection
         IF cl_auth_chk_act("rejection") THEN
            LET lc_state = "R"
            #add-point:action控制 name="statechange.rejection"
            
            #end add-point
         END IF
         EXIT MENU
      #ON ACTION signing
      #   IF cl_auth_chk_act("signing") THEN
      #      LET lc_state = "W"
      #      #add-point:action控制 name="statechange.signing"
      #      
      #      #end add-point
      #   END IF
      #   EXIT MENU
      ON ACTION invalid
         IF cl_auth_chk_act("invalid") THEN
            LET lc_state = "X"
            #add-point:action控制 name="statechange.invalid"
                    
            #end add-point
         END IF
         EXIT MENU
      ON ACTION unposted
         IF cl_auth_chk_act("unposted") THEN
            LET lc_state = "Z"
            #add-point:action控制 name="statechange.unposted"
            LET lc_state = "Y"
            #end add-point
         END IF
         EXIT MENU
 
      #add-point:stus控制 name="statechange.more_control"
      #ON ACTION unposted
      #   IF cl_auth_chk_act("posted") THEN
      #      LET lc_state = "Y"
      #   END IF
      #   EXIT MENU
      #end add-point
      
   END MENU
   
   #確認被選取的狀態碼在清單中
   IF (lc_state <> "N" 
      AND lc_state <> "Y"
      AND lc_state <> "S"
      AND lc_state <> "A"
      AND lc_state <> "D"
      AND lc_state <> "R"
      AND lc_state <> "W"
      AND lc_state <> "X"
      AND lc_state <> "Z"
      ) OR 
      g_pmds_m.pmdsstus = lc_state OR cl_null(lc_state) THEN
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #add-point:stus修改前 name="statechange.b_update"
   CALL cl_err_collect_init()
   CALL s_transaction_begin()
   
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN apmt860_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN 
   END IF
   
   IF lc_state = 'Y' THEN
      IF g_pmds_m.pmdsstus = 'N'  OR
         g_pmds_m.pmdsstus = 'A' OR
         g_pmds_m.pmdsstus = 'D' OR
         g_pmds_m.pmdsstus = 'R' THEN
         CALL s_apmt860_conf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
         IF NOT l_success THEN
            CALL s_transaction_end('N','0')
            CALL cl_err_collect_show()
            RETURN
         ELSE
            IF NOT cl_ask_confirm('aim-00108') THEN
               CALL s_transaction_end('Y','0')
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_apmt860_conf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
               IF NOT l_success THEN
                  CALL s_transaction_end('N','0')
                  CALL cl_err_collect_show()
                  RETURN
               ELSE
                  CALL s_transaction_end('Y','0')
                  CALL cl_err_collect_show()
               END IF
            END IF
         END IF
      END IF
      
      IF g_pmds_m.pmdsstus = 'S' THEN
         IF NOT s_apmt860_unpost_chk(g_pmds_m.pmdsdocno) THEN
            CALL s_transaction_end('N','0')
            CALL cl_err_collect_show()
            RETURN
         ELSE
            IF NOT cl_ask_confirm('sub-00361') THEN
               CALL s_transaction_end('Y','0')
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_transaction_begin()
               IF NOT s_apmt860_unpost_upd(g_pmds_m.pmdsdocno) THEN
                  CALL s_transaction_end('N','0')
                  CALL cl_err_collect_show()
                  RETURN
               ELSE
                  CALL s_transaction_end('Y','0')
                  CALL cl_err_collect_show()                  
               END IF
            END IF
         END IF
      END IF
   END IF
   IF lc_state = 'S' THEN
      IF NOT s_apmt860_posted_chk(g_pmds_m.pmdsdocno) THEN
         CALL s_transaction_end('N','0')
         CALL cl_err_collect_show()
         RETURN
      ELSE
         IF NOT cl_ask_confirm('sub-00232') THEN
            CALL s_transaction_end('Y','0')
            CALL cl_err_collect_show()
            RETURN
         ELSE
            #簽收日期
           CALL cl_err_collect_show()
           IF NOT apmt860_upd_pmds001() THEN
              CALL s_transaction_end('N','0')
              RETURN
           END IF
           CALL cl_err_collect_init()
            CALL s_transaction_begin()
            IF NOT s_apmt860_posted_upd(g_pmds_m.pmdsdocno) THEN
               CALL s_transaction_end('N','0')
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_transaction_end('Y','0')
               CALL cl_err_collect_show()
               #160604-00009#92 -s by 08172
               CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno) RETURNING l_flag1,l_ooac002
               CALL cl_get_doc_para(g_enterprise,g_site,l_ooac002,'E-CIR-0066') RETURNING l_ooac004
               IF l_ooac004='Y' THEN
               #160604-00009#92 -e by 08172
                  #add by geza 20151202(S)   
                  #调用aapp131生成aapt320暂估单
                  INITIALIZE la_param.* TO NULL 
                  LET la_param.prog = "aapp131"
                  LET la_param.param[1] = 'Y'  
                  LET la_param.param[2] = " stbc004 = '",g_pmds_m.pmdsdocno,"' "
                  LET la_param.param[3] = g_pmds_m.pmdssite 
                  CALL s_fin_orga_get_comp_ld(g_pmds_m.pmdssite) RETURNING l_success,l_errno,l_comp,g_ld
                  LET la_param.param[4] = g_ld
                  LET la_param.param[5] = ''
                  LET la_param.param[6] = ''
                  LET la_param.param[7] = '1'
                  LET la_param.param[8] = '1'   
                  #抓取含发票单别
                  CALL s_ld_sel_glaa(g_ld,'glaa003|glaa024') RETURNING l_success,g_glaa003,g_glaa024
                  #161228-00033#3 by sakura mark(S)
                  #SELECT DISTINCT ooba002 INTO l_ooba002 
                  #  FROM ooba_t 
                  #  LEFT OUTER JOIN ooac_t 
                  #    ON ooacent = oobaent 
                  #   AND ooac001 = ooba001 
                  #   AND ooac002 = ooba002 
                  # WHERE oobaent = g_enterprise
                  #   AND ooba002 IN (SELECT oobl001 
                  #                     FROM oobl_t 
                  #                    WHERE ooblent = g_enterprise
                  #                      AND oobl002 = 'aapt320')
                  #   AND oobastus = 'Y' 
                  #   AND ooba001 =  g_glaa024
                  #   AND ooac003 = 'E-FINC1001' 
                  #   AND ooac004 = 'Y' 
                  #   AND rownum = 1 
                  # ORDER BY ooba002
                  #161228-00033#3 by sakura mark(E)
                  #161228-00033#3 by sakura add(S)
                  LET l_ooba002 = ''
                  LET g_sql = "SELECT DISTINCT ooba002 ",
                              "  FROM ooba_t ",
                              "  LEFT OUTER JOIN ooac_t ", 
                              "    ON ooacent = oobaent ", 
                              "   AND ooac001 = ooba001 ", 
                              "   AND ooac002 = ooba002 ", 
                              " WHERE oobaent = ",g_enterprise,
                              "   AND ooba002 IN (SELECT oobl001 ", 
                              "                     FROM oobl_t ",
                              "                    WHERE ooblent = ",g_enterprise,
                              "                      AND oobl002 = 'aapt320') ",
                              "   AND oobastus = 'Y' ",
                              "   AND ooba001 =  '",g_glaa024,"'",
                              "   AND ooac003 = 'E-FINC1001' ", 
                              "   AND ooac004 = 'Y' ",
                              " ORDER BY ooba002 "
                  PREPARE apmt860_sel_ooba002_pre FROM g_sql
                  DECLARE apmt860_sel_ooba002_cur SCROLL CURSOR FOR apmt860_sel_ooba002_pre   
                  OPEN apmt860_sel_ooba002_cur   
                  FETCH FIRST apmt860_sel_ooba002_cur INTO l_ooba002
                  CLOSE apmt860_sel_ooba002_cur               
                  FREE apmt860_sel_ooba002_pre                               
                  #161228-00033#3 by sakura add(E) 
                  LET la_param.param[9] = l_ooba002
                  #161228-00033#3 by sakura mark(S)
                  ##抓取不含发票单别 
                  #SELECT DISTINCT ooba002 INTO l_ooba002_1 
                  #  FROM ooba_t 
                  #  LEFT OUTER JOIN ooac_t 
                  #    ON ooacent = oobaent 
                  #   AND ooac001 = ooba001 
                  #   AND ooac002 = ooba002 
                  # WHERE oobaent = g_enterprise
                  #   AND ooba002 IN (SELECT oobl001 
                  #                     FROM oobl_t 
                  #                    WHERE ooblent = g_enterprise
                  #                      AND oobl002 = 'aapt320')
                  #   AND oobastus = 'Y' 
                  #   AND ooba001 =  g_glaa024
                  #   AND ooac003 = 'E-FINC1001' 
                  #   AND ooac004 = 'N' 
                  #   AND rownum = 1 
                  # ORDER BY ooba002
                  #161228-00033#3 by sakura mark(E)
                  #161228-00033#3 by sakura add(S)
                  #抓取不含发票单别 
                  LET l_ooba002_1 = ''
                  LET g_sql ="SELECT DISTINCT ooba002 ", 
                             "  FROM ooba_t ",
                             "  LEFT OUTER JOIN ooac_t ", 
                             "    ON ooacent = oobaent ", 
                             "   AND ooac001 = ooba001 ", 
                             "   AND ooac002 = ooba002 ", 
                             " WHERE oobaent = ",g_enterprise,
                             "   AND ooba002 IN (SELECT oobl001 ", 
                             "                     FROM oobl_t ",
                             "                    WHERE ooblent = ",g_enterprise,
                             "                      AND oobl002 = 'aapt320')",
                             "   AND oobastus = 'Y' ",
                             "   AND ooba001 = '",g_glaa024,"'",
                             "   AND ooac003 = 'E-FINC1001' ",
                             "   AND ooac004 = 'N' ",
                             " ORDER BY ooba002 "
                  PREPARE apmt860_sel_ooba002_1_pre FROM g_sql
                  DECLARE apmt860_sel_ooba002_1_cur SCROLL CURSOR FOR apmt860_sel_ooba002_1_pre   
                  OPEN apmt860_sel_ooba002_1_cur   
                  FETCH FIRST apmt860_sel_ooba002_1_cur INTO l_ooba002_1
                  CLOSE apmt860_sel_ooba002_1_cur               
                  FREE apmt860_sel_ooba002_1_pre                               
                  #161228-00033#3 by sakura add(E)                  
                  LET la_param.param[10] = l_ooba002_1 
                  LET la_param.param[11] = ''   
                  LET la_param.param[12] = g_pmds_m.pmdsdocdt                      
                  LET ls_js = util.JSON.stringify(la_param)
                  CALL cl_cmdrun_wait(ls_js)
                  #add by geza 20151202(E)
               END IF
            END IF
         END IF
      END IF
   END IF
   
   IF lc_state = 'X' THEN
      CALL s_apmt860_invalid_chk(g_pmds_m.pmdsdocno) RETURNING l_success
      IF NOT l_success THEN
         CALL s_transaction_end('N','0')
         CALL cl_err_collect_show()
         RETURN
      ELSE
         IF NOT cl_ask_confirm('aim-00109') THEN
            CALL s_transaction_end('Y','0')
            CALL cl_err_collect_show()
            RETURN
         ELSE
            CALL s_transaction_begin()
            CALL s_apmt860_invalid_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            IF NOT l_success THEN
               CALL s_transaction_end('N','0')
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_transaction_end('Y','0')
               CALL cl_err_collect_show()
            END IF
         END IF
      END IF
   END IF

   IF lc_state = 'N' THEN
      CALL s_apmt860_unconf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
      IF NOT l_success THEN
         CALL s_transaction_end('N','0')
         CALL cl_err_collect_show()
         RETURN
      ELSE
         IF NOT cl_ask_confirm('aim-00110') THEN
            CALL s_transaction_end('Y','0')
            CALL cl_err_collect_show()
            RETURN
         ELSE
            CALL s_transaction_begin()
            CALL s_apmt860_unconf_upd(g_pmds_m.pmdsdocno) RETURNING l_success
            IF NOT l_success THEN
               CALL s_transaction_end('N','0')
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_transaction_end('Y','0')
               CALL cl_err_collect_show()
            END IF
         END IF
      END IF
   END IF
   #end add-point
   
   LET g_pmds_m.pmdsmodid = g_user
   LET g_pmds_m.pmdsmoddt = cl_get_current()
   LET g_pmds_m.pmdsstus = lc_state
   
   #異動狀態碼欄位/修改人/修改日期
   UPDATE pmds_t 
      SET (pmdsstus,pmdsmodid,pmdsmoddt) 
        = (g_pmds_m.pmdsstus,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt)     
    WHERE pmdsent = g_enterprise AND pmdsdocno = g_pmds_m.pmdsdocno
 
    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")
         
      END CASE
    
      #撈取異動後的資料
      EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt, 
          g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002, 
          g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010, 
          g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
          g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
          g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034, 
          g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
          g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid, 
          g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid, 
          g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc, 
          g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc,g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc, 
          g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc, 
          g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc, 
          g_pmds_m.pmdspstid_desc
      
      #將資料顯示到畫面上
      DISPLAY BY NAME g_pmds_m.pmdssite,g_pmds_m.pmdssite_desc,g_pmds_m.pmdsdocdt,g_pmds_m.pmds001,g_pmds_m.pmdsdocno, 
          g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,g_pmds_m.pmds002_desc, 
          g_pmds_m.pmds003,g_pmds_m.pmds003_desc,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds007_desc, 
          g_pmds_m.pmds008,g_pmds_m.pmds008_desc,g_pmds_m.pmds009,g_pmds_m.pmds009_desc,g_pmds_m.pmds010, 
          g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds202,g_pmds_m.pmds201, 
          g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049, 
          g_pmds_m.pmds031,g_pmds_m.pmds031_desc,g_pmds_m.pmds032,g_pmds_m.pmds032_desc,g_pmds_m.pmds037, 
          g_pmds_m.pmds037_desc,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds033_desc,g_pmds_m.pmds034, 
          g_pmds_m.pmds035,g_pmds_m.pmds101,g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043, 
          g_pmds_m.pmds044,g_pmds_m.pmds046,g_pmds_m.pmdsownid,g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp, 
          g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdp_desc, 
          g_pmds_m.pmdscrtdt,g_pmds_m.pmdsmodid,g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid, 
          g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,g_pmds_m.pmdspstid_desc,g_pmds_m.pmdspstdt 
 
   END IF
 
   #add-point:stus修改後 name="statechange.a_update"
   CALL apmt860_fetch('')  #重新加載action         
   #end add-point
 
   #add-point:statechange段結束前 name="statechange.after"
            
   #end add-point  
 
   CLOSE apmt860_cl
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL apmt860_msgcentre_notify('statechange:'||lc_state)
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt860.idx_chk" >}
#+ 顯示正確的單身資料筆數
PRIVATE FUNCTION apmt860_idx_chk()
   #add-point:idx_chk段define(客製用) name="idx_chk.define_customerization"
   
   #end add-point  
   #add-point:idx_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="idx_chk.define"
            
   #end add-point  
   
   #add-point:Function前置處理  name="idx_chk.pre_function"
   
   #end add-point
   
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_pmdt_d.getLength() THEN
         LET g_detail_idx = g_pmdt_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt_d.getLength() TO FORMONLY.cnt
   END IF
   
   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail2")
      IF g_detail_idx > g_pmdt2_d.getLength() THEN
         LET g_detail_idx = g_pmdt2_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt2_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt2_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail3")
      IF g_detail_idx > g_pmdt3_d.getLength() THEN
         LET g_detail_idx = g_pmdt3_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt3_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt3_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 4 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail4")
      IF g_detail_idx > g_pmdt4_d.getLength() THEN
         LET g_detail_idx = g_pmdt4_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt4_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt4_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 5 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail5")
      IF g_detail_idx > g_pmdt5_d.getLength() THEN
         LET g_detail_idx = g_pmdt5_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_pmdt5_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_pmdt5_d.getLength() TO FORMONLY.cnt
   END IF
 
   
   #add-point:idx_chk段other name="idx_chk.other"
            
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.b_fill2" >}
#+ 單身陣列填充2
PRIVATE FUNCTION apmt860_b_fill2(pi_idx)
   #add-point:b_fill2段define(客製用) name="b_fill2.define_customerization"
   
   #end add-point
   DEFINE pi_idx                 LIKE type_t.num10
   DEFINE li_ac                  LIKE type_t.num10
   DEFINE li_detail_idx_tmp      LIKE type_t.num10
   DEFINE ls_chk                 LIKE type_t.chr1
   #add-point:b_fill2段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill2.define"
            
   #end add-point
   
   #add-point:Function前置處理  name="b_fill2.pre_function"
   
   #end add-point
   
   LET li_ac = l_ac 
   
   IF g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   LET li_detail_idx_tmp = g_detail_idx
   
 
      
 
      
   #add-point:單身填充後 name="b_fill2.after_fill"
            
   #end add-point
    
   LET l_ac = li_ac
   
   CALL apmt860_detail_show()
   
   LET g_detail_idx = li_detail_idx_tmp
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.fill_chk" >}
#+ 單身填充確認
PRIVATE FUNCTION apmt860_fill_chk(ps_idx)
   #add-point:fill_chk段define(客製用) name="fill_chk.define_customerization"
   
   #end add-point
   DEFINE ps_idx        LIKE type_t.chr10
   #add-point:fill_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fill_chk.define"
            
   #end add-point
   
   #add-point:Function前置處理 name="fill_chk.before_chk"
   
   #end add-point
   
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
 
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND 
      (cl_null(g_wc2_table2) OR g_wc2_table2.trim() = '1=1')  AND 
      (cl_null(g_wc2_table3) OR g_wc2_table3.trim() = '1=1')  AND 
      (cl_null(g_wc2_table4) OR g_wc2_table4.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"
                        
      #end add-point
      RETURN TRUE
   END IF
   
   #add-point:fill_chk段after_chk name="fill_chk.after_chk"
   
   #end add-point
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="apmt860.status_show" >}
PRIVATE FUNCTION apmt860_status_show()
   #add-point:status_show段define(客製用) name="status_show.define_customerization"
   
   #end add-point
   #add-point:status_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="status_show.define"
   
   #end add-point
   
   #add-point:status_show段status_show name="status_show.status_show"
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="apmt860.mask_functions" >}
&include "erp/apm/apmt860_mask.4gl"
 
{</section>}
 
{<section id="apmt860.signature" >}
   #應用 a39 樣板自動產生(Version:10)
#+ BPM提交
PRIVATE FUNCTION apmt860_send()
   #add-point:send段define(客製用) name="send.define_customerization"
   
   #end add-point 
   #add-point:send段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="send.define"
   DEFINE l_success  LIKE type_t.chr2
   #end add-point 
   
   #add-point:Function前置處理  name="send.pre_function"
   
   #end add-point
   
   #依據單據個數，需要指定所有單身條件為" 1=1"  (單身有幾個就要設幾個)
   LET g_wc2_table1 = " 1=1"
   LET g_wc2_table2 = " 1=1"
   LET g_wc2_table3 = " 1=1"
   LET g_wc2_table4 = " 1=1"
 
 
   CALL apmt860_show()
   CALL apmt860_set_pk_array()
   
   #add-point: 初始化的ADP name="send.before_send"
   CALL s_apmt860_conf_chk(g_pmds_m.pmdsdocno) RETURNING l_success
   IF NOT l_success THEN
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN FALSE
   END IF
   #end add-point
   
   #公用變數初始化
   CALL cl_bpm_data_init()
                  
   #依照主檔/單身個數產生 CALL cl_bpm_set_master_data() / cl_bpm_set_detail_data() 
   #單頭固定為 CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(xxxx)) 傳入參數: (1)單頭陣列  ; 回傳值: 無
   CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(g_pmds_m))
                              
   #單身固定為 CALL cl_bpm_set_detail_data(s_detailX, util.JSONArray.fromFGL(xxxx)) 傳入參數: (1)單身SR名稱  (2)單身陣列  ; 回傳值: 無
   CALL cl_bpm_set_detail_data("s_detail1", util.JSONArray.fromFGL(g_pmdt_d))
   CALL cl_bpm_set_detail_data("s_detail2", util.JSONArray.fromFGL(g_pmdt2_d))
   CALL cl_bpm_set_detail_data("s_detail3", util.JSONArray.fromFGL(g_pmdt3_d))
   CALL cl_bpm_set_detail_data("s_detail4", util.JSONArray.fromFGL(g_pmdt4_d))
   CALL cl_bpm_set_detail_data("s_detail5", util.JSONArray.fromFGL(g_pmdt5_d))
 
 
   # cl_bpm_cli() 裡有包含以前的aws_condition()=>送簽資料檢核和更新單據狀況碼為'W'
   # cl_bpm_cli() 傳入參數:無  ;  回傳值: 0 開單失敗; 1 開單成功
 
   #add-point: 提交前的ADP name="send.before_cli"
   
   #end add-point
 
   #開單失敗
   IF NOT cl_bpm_cli() THEN 
      RETURN FALSE
   END IF
 
   #add-point: 提交後的ADP name="send.after_send"
   
   #end add-point
 
   #此段落不需要刪除資料,但是否需要refresh圖片樣式???
   #CALL apmt860_ui_browser_refresh()
 
   #重新指定此筆單據資料狀態圖片=>送簽中
   LET g_browser[g_current_idx].b_statepic = "stus/16/signing.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL apmt860_ui_headershow()
   CALL apmt860_ui_detailshow()
 
   RETURN TRUE
   
END FUNCTION
 
 
 
#應用 a40 樣板自動產生(Version:9)
#+ BPM抽單
PRIVATE FUNCTION apmt860_draw_out()
   #add-point:draw段define name="draw.define_customerization"
   
   #end add-point
   #add-point:draw段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="draw.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="draw.pre_function"
   
   #end add-point
   
   #抽單失敗
   IF NOT cl_bpm_draw_out() THEN 
      RETURN FALSE
   END IF    
          
   #重新指定此筆單據資料狀態圖片=>抽單
   LET g_browser[g_current_idx].b_statepic = "stus/16/draw_out.png"
 
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL apmt860_ui_headershow()  
   CALL apmt860_ui_detailshow()
 
   #add-point:Function後置處理  name="draw.after_function"
   
   #end add-point
 
   RETURN TRUE
   
END FUNCTION
 
 
 
 
 
{</section>}
 
{<section id="apmt860.set_pk_array" >}
   #應用 a51 樣板自動產生(Version:8)
#+ 給予pk_array內容
PRIVATE FUNCTION apmt860_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point  
   
   #若l_ac<=0代表沒有資料
   IF l_ac <= 0 THEN
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_pmds_m.pmdsdocno
   LET g_pk_array[1].column = 'pmdsdocno'
 
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point  
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt860.other_dialog" readonly="Y" >}
   
 
{</section>}
 
{<section id="apmt860.msgcentre_notify" >}
#應用 a66 樣板自動產生(Version:6)
PRIVATE FUNCTION apmt860_msgcentre_notify(lc_state)
   #add-point:msgcentre_notify段define name="msgcentre_notify.define_customerization"
   
   #end add-point   
   DEFINE lc_state LIKE type_t.chr80
   #add-point:msgcentre_notify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="msgcentre_notify.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="msgcentre_notify.pre_function"
   
   #end add-point
   
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = lc_state
 
   #PK資料填寫
   CALL apmt860_set_pk_array()
   #單頭資料填寫
   LET g_msgparam.data[1] = util.JSON.stringify(g_pmds_m)
 
   #add-point:msgcentre其他通知 name="msgcentre_notify.process"
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="apmt860.action_chk" >}
#+ 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
PRIVATE FUNCTION apmt860_action_chk()
   #add-point:action_chk段define(客製用) name="action_chk.define_customerization"
   
   #end add-point
   #add-point:action_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="action_chk.define"
   
   #end add-point
   
   #add-point:action_chk段action_chk name="action_chk.action_chk"
   #160818-00017#29 add-S
   SELECT pmdsstus  INTO g_pmds_m.pmdsstus
     FROM pmds_t
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = g_pmds_m.pmdsdocno

  IF(g_action_choice="modify" OR g_action_choice="delete" OR g_action_choice="modify_detail")  THEN
     LET g_errno = NULL
     CASE g_pmds_m.pmdsstus
        WHEN 'W'
           LET g_errno = 'sub-00180'
        WHEN 'X'
           LET g_errno = 'sub-00229'
        WHEN 'Y'
           LET g_errno = 'sub-00178'
        WHEN 'S'
           LET g_errno = 'sub-00230'
        WHEN 'Z'
           LET g_errno = 'sub-01351'
     END CASE

     IF NOT cl_null(g_errno) THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = g_errno
        LET g_errparam.extend = g_pmds_m.pmdsdocno
        LET g_errparam.popup = TRUE
        CALL cl_err()
        LET g_errno = NULL
        CALL apmt860_set_act_visible()
        CALL apmt860_set_act_no_visible()
        CALL apmt860_show()
        RETURN FALSE
     END IF
   END IF
   #160818-00017#29 add-E
   #end add-point
      
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="apmt860.other_function" readonly="Y" >}

################################################################################
# Descriptions...: 單頭欄位隱藏
# Memo...........:
# Usage..........: CALL apmt860_set_comp_visible(p_type,p_cmd)
# Input parameter: p_type        1.程式一進入的欄位隱藏
#                :               2.因欄位值而變動
#                : p_cmd         a：新增 u：修改
# Return code....: 無
# Date & Author..: 2014/12/23 By pomelo
# Modify.........: 150818-00010#1 150818 By pomelo 增加參數，及欄位隱藏控管
################################################################################
PUBLIC FUNCTION apmt860_set_comp_visible(p_type,p_cmd)
#150818-00010#1 150818 By pomelo add(S)
DEFINE p_type               LIKE type_t.chr1   
DEFINE p_cmd                LIKE type_t.chr1  
#150818-00010#1 150818 By pomelo add(E)
###########################################
#單據性質 g_argv[1]
#pmds000 = '1'   apmt860 採購收貨單
#pmds000 = '2'   apmt861 無採購收貨單
#pmds000 = '3'   apmt862 採購收貨入庫單
#pmds000 = '4'   apmt863 無採購收貨入庫單
#pmds000 = '5'   apmt870 採購驗退單
#pmds000 = '6'   apmt880 採購入庫單
#pmds000 = '7'   apmt890 採購倉退單
#pmds000 = '16'  apmt881 虛擬入庫單
#pmds000 = '17'  apmt891 虛擬退廠單
#pmds000 = '18'  apmt882 虛擬異動單   #151104-00007#1 Add By Ken 151109 加上 pmds000 = '18'
###########################################

   #150818-00010#1 150818 By pomelo add(S)
   CASE p_type
      WHEN '1'
   #150818-00010#1 150818 By pomelo add(E)
         #扣帳日期
         IF g_argv[1] MATCHES '[125]' THEN
            CALL cl_set_comp_visible("lbl_pmds001,pmds001",FALSE)
         END IF
         
         #收貨預約單號
         IF g_argv[1] MATCHES '[24567]' OR g_argv[1] = '22' THEN  #151109-00007#1 Add By Ken 151109 加上 g_argv[1]=22條件
           #CALL cl_set_comp_visible("lbl_pmds200,pmds200",FALSE)   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_apmt859,pmds200",FALSE)  #150416-00001#1 150818 by sakura add
         END IF
         
         #來源單號
         IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
           #CALL cl_set_comp_visible("lbl_pmds006,pmds006",FALSE)    #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_apmt840,pmds006",FALSE)   #150416-00001#1 150818 by sakura add
         END IF
         
         #供應商出貨日
         IF g_argv[1] MATCHES '[567]' THEN
            CALL cl_set_comp_visible("lbl_pmds052,pmds052",FALSE)
         END IF
         
         #倉退方式
         IF g_argv[1] MATCHES '[123456]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("lbl_pmds100,pmds100",FALSE)
         END IF
         
         #取回日期
         IF g_argv[1] MATCHES '[12346]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("lbl_pmds081,pmds081",FALSE)
         END IF
         
         #20150318--dongsz--add--str---
         #退貨申請單號
         IF g_argv[1] MATCHES '[123456]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            #CALL cl_set_comp_visible("lbl_pmds201,pmds201",FALSE)   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_aint801,pmds201",FALSE)   #150416-00001#1 150818 by sakura add
         END IF
         #20150318--dongsz--add--end---
         
         #財務資訊頁籤
         IF g_argv[1] MATCHES '[1356]' THEN
            CALL cl_set_comp_visible("page_5",FALSE)
         END IF
         
         #折讓日期
         IF g_argv[1] MATCHES '[123456]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("lbl_pmds101,pmds101",FALSE)
         END IF
         
         #折讓原始發票
         IF g_argv[1] MATCHES '[123456]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("lbl_pmds102,pmds102",FALSE)
         END IF
         
         #過帳異動資訊
         IF g_argv[1] MATCHES '[125]' THEN
            CALL cl_set_comp_visible("lbl_pmdspstid,pmdspstid",FALSE)  #資料過帳者
            CALL cl_set_comp_visible("lbl_pmdspstdt,pmdspstdt",FALSE)  #資料過帳日
         END IF
         
         #############150505-00009#1  add by huangtao
         #來源性質
         IF g_argv[1] NOT MATCHES '[7]' THEN
            CALL cl_set_comp_visible("lbl_pmds202,pmds202",FALSE)
         END IF  
         ##############
         
         #150608-00012#3 Add By Ken 150628(S) 虛擬入庫單
         IF g_argv[1] = '16' THEN
           #CALL cl_set_comp_visible("lbl_pmds200,pmds200",FALSE)      #收貨預約單號   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_apmt859,pmds200",FALSE)     #收貨預約單號   #150416-00001#1 150818 by sakura add
            CALL cl_set_comp_visible("lbl_pmds100,pmds100",FALSE)      #倉退方式
            CALL cl_set_comp_visible("lbl_pmds081,pmds081",FALSE)      #取回日期
           #CALL cl_set_comp_visible("lbl_pmds201,pmds201",FALSE)      #退貨申請單號   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_aint801,pmds201",FALSE)     #退貨申請單號   #150416-00001#1 150818 by sakura add
            CALL cl_set_comp_visible("page_5",FALSE)                   #財務資訊頁籤
            CALL cl_set_comp_visible("lbl_pmds101,pmds101",FALSE)      #折讓日期
            CALL cl_set_comp_visible("lbl_pmds102,pmds102",FALSE)      #折讓原始發票
            CALL cl_set_comp_visible("lbl_pmds202,pmds202",FALSE)      #來源性質
           #CALL cl_set_comp_visible("lbl_pmds006,pmds006",FALSE)      #來源單號(採購單號)   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_apmt840,pmds006",FALSE)     #來源單號(採購單號)   #150416-00001#1 150818 by sakura add
         END IF
         #150608-00012#3 Add By Ken 150628(E) 虛擬入庫單
         
         #150608-00012#4 Add By Ken 150628(S) 虛擬退廠單
         IF g_argv[1] = '17' THEN
            CALL cl_set_comp_visible("lbl_pmds200,pmds200",FALSE)      #收貨預約單號   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_apmt859,pmds200",FALSE)     #收貨預約單號   #150416-00001#1 150818 by sakura add
            CALL cl_set_comp_visible("lbl_pmds052,pmds052",FALSE)      #供應商出貨日
           #CALL cl_set_comp_visible("lbl_pmds006,pmds006",FALSE)      #來源單號(採購單號)   #150416-00001#1 150818 by sakura mark
            CALL cl_set_comp_visible("prog_apmt840,pmds006",FALSE)     #來源單號(採購單號)   #150416-00001#1 150818 by sakura add
         END IF
         #150608-00012#4 Add By Ken 150628(E) 虛擬退廠單
         
         #151104-00007#1 Add By Ken 151109(S) 虛擬異動單
         IF g_argv[1] = '18' THEN
            CALL cl_set_comp_visible("prog_apmt859,pmds200",FALSE)     #收貨預約單號   
            CALL cl_set_comp_visible("prog_apmt840,pmds006",FALSE)     #來源單號(採購單號)   
            #CALL cl_set_comp_visible("lbl_pmds100,pmds100",FALSE)      #倉退方式
            CALL cl_set_comp_visible("lbl_pmds081,pmds081",FALSE)      #取回日期  
            #CALL cl_set_comp_visible("page_5",FALSE)                   #財務資訊頁籤            
         END IF
         #151104-00007#1 Add By Ken 151109(E) 虛擬異動單
         
   #150818-00010#1 150818 By pomelo add(S)
      #160604-00009#97 160624 by sakura mark(S)
      #WHEN '2'
      #   IF apmt860_chk_lot(p_cmd) THEN
      #      CALL cl_set_comp_visible("prog_apmt840,pmds006",TRUE)       #採購單號
      #   ELSE
      #      CALL cl_set_comp_visible("prog_apmt840,pmds006",FALSE)      #採購單號
      #   END IF
      #160604-00009#97 160624 by sakura mark(E)
   END CASE
   #150818-00010#1 150818 By pomelo add(E)
   
END FUNCTION

################################################################################
# Descriptions...: 單身欄位隱藏
# Memo...........:
# Usage..........: CALL apmt860_set_comp_visible_b(p_type)
# Input parameter: p_type        1.程式一進入的欄位隱藏
#                :               2.因欄位值而變動
# Return code....: 無
# Date & Author..: 2014/12/23 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_set_comp_visible_b(p_type)
DEFINE p_type           LIKE type_t.chr1

   CASE p_type
      WHEN '1'
         IF g_argv[1] MATCHES '[24567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("pmdt207",FALSE)           #預約收貨項次
            CALL cl_set_comp_visible("pmdo001",FALSE)           #採購商品編號
            CALL cl_set_comp_visible("pmdo001_desc",FALSE)      #採購商品品名
            CALL cl_set_comp_visible("pmdo001_desc_desc",FALSE) #採購商品規格
            CALL cl_set_comp_visible("pmdo002",FALSE)           #採購產品特徵
            CALL cl_set_comp_visible("pmdo002_desc",FALSE)      #採購產品特徵說明
            CALL cl_set_comp_visible("pmdt203",FALSE)           #採購組織
            CALL cl_set_comp_visible("pmdt203_desc",FALSE)      #採購組織說明
            CALL cl_set_comp_visible("pmdt204",FALSE)           #採購中心
            CALL cl_set_comp_visible("pmdt204_desc",FALSE)      #採購中心說明
            CALL cl_set_comp_visible("pmdt205",FALSE)           #要貨組織
            CALL cl_set_comp_visible("pmdt205_desc",FALSE)      #要貨組織說明
            CALL cl_set_comp_visible("pmdt208",FALSE)           #採購渠道
            CALL cl_set_comp_visible("pmdt208_desc",FALSE)      #採購渠道說明
            CALL cl_set_comp_visible("pmdt209",FALSE)           #渠道性質
         END IF
         
         #收貨項次
         IF g_argv[1] MATCHES '[1234]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("pmdt028",FALSE)
         END IF
         
         #20150318--dongsz--add--str---
         #退貨申請單號和項次
         IF g_argv[1] MATCHES '[123456]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("pmdt216,pmdt217",FALSE)
         END IF
         #20150318--dongsz--add--end---
         
         #無採購收貨(入庫)單
         IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("pmdt001",FALSE)       #採購單號
            CALL cl_set_comp_visible("pmdt002",FALSE)       #採購項次
            CALL cl_set_comp_visible("pmdt003",FALSE)       #採購項序
            CALL cl_set_comp_visible("pmdt004",FALSE)       #採購分批序
            CALL cl_set_comp_visible("pmdt214",FALSE)       #採購方式
            CALL cl_set_comp_visible("pmdt215",FALSE)       #最終收貨組織
            CALL cl_set_comp_visible("pmdt215_desc",FALSE)  #最終收貨組織說明
            CALL cl_set_comp_visible("page_7",FALSE)        #價格資訊
            CALL cl_set_comp_visible("l_pmdo006",FALSE)     #採購數量
            CALL cl_set_comp_visible("pmdt218",FALSE)       #採購價
         END IF
         
         #單價、稅別、稅率、未稅金額、稅額、含稅金額
         IF g_argv[1] MATCHES '[13567]' THEN
            CALL cl_set_comp_visible("pmdt036",FALSE)
            CALL cl_set_comp_visible("pmdt046",FALSE)
            CALL cl_set_comp_visible("pmdt046_desc",FALSE)
            CALL cl_set_comp_visible("pmdt037",FALSE)
            CALL cl_set_comp_visible("pmdt038",FALSE)
            CALL cl_set_comp_visible("pmdt039",FALSE)
            CALL cl_set_comp_visible("pmdt047",FALSE)
            CALL cl_set_comp_visible("pmdt218",FALSE)
            CALL cl_set_comp_visible("pmdt044",FALSE)
         END IF
         
         IF g_argv[1] MATCHES '[567]' THEN
            CALL cl_set_comp_visible("pmdt025",FALSE)   #緊急度
            CALL cl_set_comp_visible("pmdt026",FALSE)   #檢驗
            CALL cl_set_comp_visible("pmdt060",FALSE)   #供應商批號
            CALL cl_set_comp_visible("pmdt061",FALSE)   #供應商送貨數量
            #多庫儲批頁籤
            CALL cl_set_comp_visible("pmdu013",FALSE)   #允收數量
            CALL cl_set_comp_visible("pmdu014",FALSE)   #已入庫量
            CALL cl_set_comp_visible("pmdu015",FALSE)   #已驗退量
         END IF
         
         IF g_argv[1] MATCHES '[34567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("pmdt053",FALSE)   #允收數量
            CALL cl_set_comp_visible("pmdt055",FALSE)   #驗退數量
         END IF
         
         #原始需求分配明細
         IF g_argv[1] MATCHES '[2457]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            CALL cl_set_comp_visible("page_4",FALSE)
         END IF
         
         IF g_argv[1] MATCHES '[57]' THEN
            CALL cl_set_comp_visible("pmdt219",FALSE)   #製造日期
            CALL cl_set_comp_visible("pmdt089",FALSE)   #有效日期
            #多庫儲批頁籤
            CALL cl_set_comp_visible("pmdu202",FALSE)   #製造日期
            CALL cl_set_comp_visible("pmdu017",FALSE)   #有效日期
         END IF
         
         #150608-00012#3 Add By Ken 150628(S) 虛擬入庫單
         IF g_argv[1] = '16' THEN
            #收貨明細頁籤
            CALL cl_set_comp_visible("pmdt207",FALSE)           #預約收貨項次
            CALL cl_set_comp_visible("pmdt028",FALSE)           #收貨項次
            CALL cl_set_comp_visible("pmdt216,pmdt217",FALSE)   #退貨申請單號和項次            
            CALL cl_set_comp_visible("pmdt001",FALSE)           #採購單號
            CALL cl_set_comp_visible("pmdt002",FALSE)           #採購項次
            CALL cl_set_comp_visible("pmdt003",FALSE)           #採購項序
            CALL cl_set_comp_visible("pmdt004",FALSE)           #採購分批序
            CALL cl_set_comp_visible("pmdo001",FALSE)           #採購商品編號
            CALL cl_set_comp_visible("pmdo001_desc",FALSE)      #採購商品品名
            CALL cl_set_comp_visible("pmdo001_desc_desc",FALSE) #採購商品規格
            CALL cl_set_comp_visible("pmdo002",FALSE)           #採購產品特徵
            CALL cl_set_comp_visible("pmdo002_desc",FALSE)      #採購產品特徵說明  
            CALL cl_set_comp_visible("l_pmdo006",FALSE)         #採購數量            

            CALL cl_set_comp_visible("pmdt036",FALSE)           #單價
            CALL cl_set_comp_visible("pmdt046",FALSE)           #稅別
            CALL cl_set_comp_visible("pmdt046_desc",FALSE)      #稅別說明
            CALL cl_set_comp_visible("pmdt037",FALSE)           #稅率
            CALL cl_set_comp_visible("pmdt038",FALSE)           #未稅金額
            CALL cl_set_comp_visible("pmdt039",FALSE)           #含稅金額
            CALL cl_set_comp_visible("pmdt047",FALSE)           #稅額
            CALL cl_set_comp_visible("pmdt218",FALSE)           #採購價
            CALL cl_set_comp_visible("pmdt044",FALSE)           #取出單價
            CALL cl_set_comp_visible("pmdt053",FALSE)           #允收數量
            CALL cl_set_comp_visible("pmdt055",FALSE)           #驗退數量
            
            #價格資訊頁籤
            CALL cl_set_comp_visible('pmdt0011',FALSE)          #採購單號
            CALL cl_set_comp_visible('pmdt0021',FALSE)          #採購項次
            CALL cl_set_comp_visible('pmdt0031',FALSE)          #採購項序
            CALL cl_set_comp_visible('pmdt0041',FALSE)          #採購分批序
            
            CALL cl_set_comp_visible("page_4",FALSE)            #原始需求分配明細
            
         END IF
         #150608-00012#3 Add By Ken 150628(E) 虛擬入庫單

         #150608-00012#4 Add By Ken 150628(S) 虛擬退廠單
         IF g_argv[1] = '17' THEN
            CALL cl_set_comp_visible("pmdt207",FALSE)           #預約收貨項次
            CALL cl_set_comp_visible("pmdt001",FALSE)           #採購單號
            CALL cl_set_comp_visible("pmdt002",FALSE)           #採購項次
            CALL cl_set_comp_visible("pmdt003",FALSE)           #採購項序
            CALL cl_set_comp_visible("pmdt004",FALSE)           #採購分批序
            CALL cl_set_comp_visible("pmdo001",FALSE)           #採購商品編號
            CALL cl_set_comp_visible("pmdo001_desc",FALSE)      #採購商品品名
            CALL cl_set_comp_visible("pmdo001_desc_desc",FALSE) #採購商品規格
            CALL cl_set_comp_visible("pmdo002",FALSE)           #採購產品特徵
            CALL cl_set_comp_visible("pmdo002_desc",FALSE)      #採購產品特徵說明
            CALL cl_set_comp_visible("l_pmdo006",FALSE)         #採購數量
            CALL cl_set_comp_visible("pmdt203",FALSE)           #採購組織
            CALL cl_set_comp_visible("pmdt203_desc",FALSE)      #採購組織說明
            CALL cl_set_comp_visible("pmdt204",FALSE)           #採購中心
            CALL cl_set_comp_visible("pmdt204_desc",FALSE)      #採購中心說明
            CALL cl_set_comp_visible("pmdt205",FALSE)           #要貨組織
            CALL cl_set_comp_visible("pmdt205_desc",FALSE)      #要貨組織說明
            CALL cl_set_comp_visible("pmdt208",FALSE)           #採購渠道
            CALL cl_set_comp_visible("pmdt208_desc",FALSE)      #採購渠道說明
            CALL cl_set_comp_visible("pmdt209",FALSE)           #渠道性質
 
            #、稅別、稅率、未稅金額、稅額、含稅金額
            CALL cl_set_comp_visible("pmdt036",FALSE)           #單價
            CALL cl_set_comp_visible("pmdt046",FALSE)           #稅別
            CALL cl_set_comp_visible("pmdt046_desc",FALSE)      #稅別說明
            CALL cl_set_comp_visible("pmdt037",FALSE)           #稅率
            CALL cl_set_comp_visible("pmdt038",FALSE)           #未稅金額
            CALL cl_set_comp_visible("pmdt039",FALSE)           #含稅金額
            CALL cl_set_comp_visible("pmdt047",FALSE)           #稅額
            CALL cl_set_comp_visible("pmdt218",FALSE)           #採購價
            CALL cl_set_comp_visible("pmdt044",FALSE)           #取出單價
            
            CALL cl_set_comp_visible("pmdt025",FALSE)           #緊急度
            CALL cl_set_comp_visible("pmdt026",FALSE)           #檢驗
            CALL cl_set_comp_visible("pmdt060",FALSE)           #供應商批號
            CALL cl_set_comp_visible("pmdt061",FALSE)           #供應商送貨數量
            #多庫儲批頁籤                                       
            CALL cl_set_comp_visible("pmdu013",FALSE)           #允收數量
            CALL cl_set_comp_visible("pmdu014",FALSE)           #已入庫量
            CALL cl_set_comp_visible("pmdu015",FALSE)           #已驗退量
                                                                
            CALL cl_set_comp_visible("pmdt053",FALSE)           #允收數量
            CALL cl_set_comp_visible("pmdt055",FALSE)           #驗退數量
            #原始需求分配明細                                    
            CALL cl_set_comp_visible("page_4",FALSE)            
            CALL cl_set_comp_visible("pmdt219",FALSE)           #製造日期
            CALL cl_set_comp_visible("pmdt089",FALSE)           #有效日期
            #多庫儲批頁籤                                        
            CALL cl_set_comp_visible("pmdu202",FALSE)           #製造日期
            CALL cl_set_comp_visible("pmdu017",FALSE)           #有效日期
            
            #價格資訊頁籤
            CALL cl_set_comp_visible('pmdt0011',FALSE)          #採購單號
            CALL cl_set_comp_visible('pmdt0021',FALSE)          #採購項次
            CALL cl_set_comp_visible('pmdt0031',FALSE)          #採購項序
            CALL cl_set_comp_visible('pmdt0041',FALSE)          #採購分批序            
         END IF
         #150608-00012#4 Add By Ken 150628(E) 虛擬退廠單
         
         #151104-00007#1 Add By Ken 151110(S) 虛擬異動單
         IF g_argv[1] = '18' THEN
            CALL cl_set_comp_visible("pmdt207",FALSE)           #預約收貨項次
            CALL cl_set_comp_visible("pmdt001",FALSE)           #採購單號
            CALL cl_set_comp_visible("pmdt002",FALSE)           #採購項次
            CALL cl_set_comp_visible("pmdt003",FALSE)           #採購項序
            CALL cl_set_comp_visible("pmdt004",FALSE)           #採購分批序
            CALL cl_set_comp_visible("pmdt005",FALSE)           #子件特性
            CALL cl_set_comp_visible("pmdo001",FALSE)           #採購商品編號
            CALL cl_set_comp_visible("pmdo001_desc",FALSE)      #採購商品品名
            CALL cl_set_comp_visible("pmdo001_desc_desc",FALSE) #採購商品規格
            CALL cl_set_comp_visible("pmdo002",FALSE)           #採購產品特徵
            CALL cl_set_comp_visible("pmdo002_desc",FALSE)      #採購產品特徵說明
            CALL cl_set_comp_visible("l_pmdo006",FALSE)         #採購數量    
            CALL cl_set_comp_visible("pmdt028",FALSE)           #收貨項次
            CALL cl_set_comp_visible("pmdt216,pmdt217",FALSE)   #退貨申請單號和項次                                    
            CALL cl_set_comp_visible("pmdt025",FALSE)           #緊急度
            #、稅別、稅率、未稅金額、稅額、含稅金額
            CALL cl_set_comp_visible("pmdt036",FALSE)           #單價
            CALL cl_set_comp_visible("pmdt046",FALSE)           #稅別
            CALL cl_set_comp_visible("pmdt046_desc",FALSE)      #稅別說明
            CALL cl_set_comp_visible("pmdt037",FALSE)           #稅率
            CALL cl_set_comp_visible("pmdt038",FALSE)           #未稅金額
            CALL cl_set_comp_visible("pmdt039",FALSE)           #含稅金額
            CALL cl_set_comp_visible("pmdt047",FALSE)           #稅額
            CALL cl_set_comp_visible("pmdt218",FALSE)           #採購價
            CALL cl_set_comp_visible("pmdt044",FALSE)           #取出單價            
            #多庫儲批頁籤
            CALL cl_set_comp_visible("pmdt053",FALSE)           #允收數量
            CALL cl_set_comp_visible("pmdt055",FALSE)           #驗退數量
            #價格資訊頁籤
            CALL cl_set_comp_visible('pmdt0011',FALSE)          #採購單號
            CALL cl_set_comp_visible('pmdt0021',FALSE)          #採購項次
            CALL cl_set_comp_visible('pmdt0031',FALSE)          #採購項序
            CALL cl_set_comp_visible('pmdt0041',FALSE)          #採購分批序      
            CALL cl_set_comp_visible("page_4",FALSE)            #原始需求分配明細            
         END IF         
         #151104-00007#1 Add By Ken 151110(E) 虛擬異動單
         
         #來源商品品類   
         #151202-00010#1 s983961--add(S)
         IF NOT g_argv[1] MATCHES '[13]' THEN    
            CALL cl_set_comp_visible("pmdt221,pmdt221_desc",FALSE)
         END IF         
         #151202-00010#1 s983961--add(E) 
         
      WHEN '2'
         #預約收貨項次
         IF cl_null(g_pmds_m.pmds200) THEN
            CALL cl_set_comp_visible("pmdt207",FALSE)
         END IF
         
         #當為採購倉退單 且 單頭收貨單號為空
         IF g_pmds_m.pmds000 = '7' AND cl_null(g_pmds_m.pmds006) AND
            cl_null(g_pmds_m.pmds201) THEN
            CALL cl_set_comp_visible("pmdt028",FALSE)
            CALL cl_set_comp_visible("pmdt001",FALSE)
            CALL cl_set_comp_visible("pmdt002",FALSE)
            CALL cl_set_comp_visible("pmdt003",FALSE)
            CALL cl_set_comp_visible("pmdt004",FALSE)
            CALL cl_set_comp_visible("pmdt0011",FALSE)
            CALL cl_set_comp_visible("pmdt0021",FALSE)
            CALL cl_set_comp_visible("pmdt0031",FALSE)
            CALL cl_set_comp_visible("pmdt0041",FALSE)
         #160705-00025#1 160706 by sakura add(S)
         ELSE
            CALL cl_set_comp_visible("pmdt028",TRUE)
         #160705-00025#1 160706 by sakura add(E)
         END IF
   END CASE
END FUNCTION

################################################################################
# Descriptions...: 收貨預約單號 帶出單頭資料
# Memo...........:
# Usage..........: CALL apmt860_pmds200_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/23 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmds200_default()

   SELECT pmel006,pmel007,pmel001
     INTO g_pmds_m.pmds007,g_pmds_m.pmds009,g_pmds_m.pmds006
     FROM pmel_t
    WHERE pmelent = g_enterprise
      AND pmeldocno = g_pmds_m.pmds200
   
   IF NOT cl_null(g_pmds_m.pmds006) THEN
      SELECT pmdl021 INTO g_pmds_m.pmds008
        FROM pmdl_t
       WHERE pmdlent = g_enterprise
         AND pmdldocno = g_pmds_m.pmds006
   END IF
   
   #採購供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds007)
      RETURNING g_pmds_m.pmds007_desc
      
   #送貨供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds009)
      RETURNING g_pmds_m.pmds009_desc
   
   #帳款供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds008)
      RETURNING g_pmds_m.pmds008_desc
      
   DISPLAY BY NAME g_pmds_m.pmds007,g_pmds_m.pmds007_desc,
                   g_pmds_m.pmds008,g_pmds_m.pmds008_desc,
                   g_pmds_m.pmds009,g_pmds_m.pmds009_desc,
                   g_pmds_m.pmds006
   
   #帶出來源單據資料
   CALL apmt860_pmds006_default()
END FUNCTION

################################################################################
# Descriptions...: 來源單號檢查
# Memo...........: 採購收貨、採購收貨入庫時，根據採購單單號帶值
#                : 驗退、入庫、倉退時，根據收貨單單號帶值
# Usage..........: CALL apmt860_pmds006_chk(p_pmds006)
#                :    RETURNING r_success
# Input parameter: p_pmds006      來源單號
# Return code....: r_success      True/False
# Date & Author..: 2014/12/24 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmds006_chk(p_pmds006)
DEFINE p_pmds006   LIKE pmds_t.pmds006    #來源單號
DEFINE r_success   LIKE type_t.num5
DEFINE l_pmdl005   LIKE pmdl_t.pmdl005
DEFINE l_pmdl006   LIKE pmdl_t.pmdl006
DEFINE l_pmdldocdt LIKE pmdl_t.pmdldocdt
DEFINE l_success   LIKE type_t.num5
DEFINE l_ooba002   LIKE ooba_t.ooba002
DEFINE l_cnt       LIKE type_t.num5

   LET r_success = TRUE
   IF cl_null(p_pmds006) THEN
      RETURN r_success
   END IF
   
   LET l_pmdl005 = ''
   LET l_pmdl006 = ''
   LET l_pmdldocdt = ''
   SELECT pmdl005,pmdl006,pmdldocdt
     INTO l_pmdl005,l_pmdl006,l_pmdldocdt
     FROM pmdl_t
    WHERE pmdlent = g_enterprise
      AND pmdldocno = p_pmds006
           
   #採購收貨、採購收貨入庫時採購採購單號
   IF g_argv[1] MATCHES '[13]' THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = p_pmds006
      IF NOT cl_chk_exist("v_pmdldocno_4") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #採購日期不可晚於收貨單上的收貨日期！
      IF g_pmds_m.pmdsdocdt < l_pmdldocdt THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00650'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
               
      #輸入採購單號的採購明細必須有一筆以上的送貨據點(pmdnunit)與g_site一樣的資料才可以
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt
        FROM pmdn_t 
       WHERE pmdnent = g_enterprise
         AND pmdndocno = p_pmds006
         AND pmdnunit = g_pmds_m.pmdssite
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00715'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #輸入採購單號的採購明細必須有一筆以上的 送貨據點=當前收貨據點 的行狀態(pmdn045)為1.一般！
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt
        FROM pmdn_t 
       WHERE pmdnent = g_enterprise
         AND pmdndocno = p_pmds006
         AND pmdnunit = g_pmds_m.pmdssite
         AND pmdn045 = '1'
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00716'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #輸入的採購單有產生非作廢的預約單時，必須由預約單輸入
      LET l_cnt = 0
      SELECT COUNT(pmemseq) INTO l_cnt
        FROM pmel_t,pmem_t
       WHERE pmelent = pmement
         AND pmeldocno = pmemdocno
         AND pmelstus != 'X'
         AND pmelent = g_enterprise
         AND pmem001 = p_pmds006
      IF l_cnt >= 1 THEN
         #此採購單有存在未作廢的採購預約單，不允許直接輸入採購單必須收預單進行收貨！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00850'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #採購收貨
   IF g_argv[1] = '1' THEN
      LET l_cnt = 0
      SELECT COUNT(pmdndocno) INTO l_cnt
        FROM pmdl_t,pmdn_t,pmdo_t
        #150814-00005#1 By 150817 By pomelo mark(S) 效能調整
        #LEFT OUTER JOIN (SELECT pmdtent, pmdt001, pmdt002, pmdt003,
        #                        pmdt004, COALESCE(SUM(pmdt020),0) sumpmdt020
        #                   FROM pmds_t, pmdt_t
        #                  WHERE pmdsent = pmdtent
        #                    AND pmdsdocno = pmdtdocno
        #                    AND pmdsent = g_enterprise
        #                    AND (pmds000 = '1' OR pmds000 = '3')
        #                    AND pmdsstus != 'X'
        #                    AND pmdsstus != 'Y'
        #                  GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004) d
        #  ON d.pmdtent = pmdoent
        # AND d.pmdt001 = pmdodocno
        # AND d.pmdt002 = pmdoseq
        # AND d.pmdt003 = pmdoseq1
        # AND d.pmdt004 = pmdoseq2
        #150814-00005#1 By 150817 By pomelo mark(E) 效能調整
       WHERE pmdlent = pmdnent
         AND pmdldocno = pmdndocno
         AND pmdoent = pmdnent
         AND pmdodocno = pmdndocno
         AND pmdoseq = pmdnseq
         AND pmdoent = g_enterprise
         AND pmdodocno = p_pmds006
         AND ( pmdl206 = 'Y'
          OR  (pmdl206 = 'N'
         AND   0 < (COALESCE(pmdo006,0) - COALESCE(pmdo015,0) +
                    COALESCE(pmdo016,0) + COALESCE(pmdo017,0) -
                    COALESCE((SELECT COALESCE (SUM (pmdt020), 0)
                                FROM pmds_t,pmdt_t
                               WHERE pmdsent = pmdtent
                                 AND pmdsdocno = pmdtdocno
                                 AND pmdsent = g_enterprise
                                 AND (pmds000 = '1' OR pmds000 = '3')
                                 AND pmdsstus NOT IN ('X','Y')
                                 AND pmdtent = pmdoent
                                 AND pmdt001 = pmdodocno
                                 AND pmdt002 = pmdoseq
                                 AND pmdt003 = pmdoseq1
                                 AND pmdt004 = pmdoseq2
                            GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004),0))))
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00757'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #採購收貨入庫
   IF g_argv[1] = '3' THEN
      #輸入採購單號的採購明細必須有一筆以上的 送貨據點=當前收貨據點 沒有檢驗的資料，才可以直接入庫
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt
        FROM pmdn_t 
       WHERE pmdnent = g_enterprise
         AND pmdndocno = p_pmds006
         AND pmdnunit = g_pmds_m.pmdssite
         AND pmdn052 = 'N'
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00717'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      LET l_cnt = 0
      SELECT COUNT(pmdndocno) INTO l_cnt
        FROM pmdl_t,pmdn_t,pmdo_t
        #150814-00005#1 By 150817 By pomelo mark(S) 效能調整
        #LEFT OUTER JOIN (SELECT pmdtent, pmdt001, pmdt002, pmdt003,
        #                        pmdt004, COALESCE(SUM(pmdt020),0) sumpmdt020
        #                   FROM pmds_t, pmdt_t
        #                  WHERE pmdsent = pmdtent
        #                    AND pmdsdocno = pmdtdocno
        #                    AND pmdsent = g_enterprise
        #                    AND (pmds000 = '1' OR pmds000 = '3')
        #                    AND pmdsstus != 'X' 
        #                    AND pmdsstus != 'Y'
        #                    AND pmdsstus != 'S'
        #                  GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004) d
        #  ON d.pmdtent = pmdoent
        # AND d.pmdt001 = pmdodocno
        # AND d.pmdt002 = pmdoseq
        # AND d.pmdt003 = pmdoseq1
        # AND d.pmdt004 = pmdoseq2
        #150814-00005#1 By 150817 By pomelo mark(E) 效能調整
       WHERE pmdoent = pmdnent
         AND pmdodocno = pmdndocno
         AND pmdoseq = pmdnseq
         AND pmdoent = g_enterprise
         AND pmdodocno = p_pmds006
         AND ( pmdl206 = 'Y'
          OR  (pmdl206 = 'N'
         AND   0 < (COALESCE(pmdo006,0) - COALESCE(pmdo015,0) +
                    COALESCE(pmdo016,0) + COALESCE(pmdo017,0) -
                    COALESCE((SELECT COALESCE (SUM (pmdt020), 0)
                                FROM pmds_t,pmdt_t
                               WHERE pmdsent = pmdtent
                                 AND pmdsdocno = pmdtdocno
                                 AND pmdsent = g_enterprise
                                 AND (pmds000 = '1' OR pmds000 = '3')
                                 AND pmdsstus NOT IN ('X','Y','S')
                                 AND pmdtent = pmdoent
                                 AND pmdt001 = pmdodocno
                                 AND pmdt002 = pmdoseq
                                 AND pmdt003 = pmdoseq1
                                 AND pmdt004 = pmdoseq2
                            GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004),0))))
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00758'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #150506-00011#1 150525 By pomelo(S)
   #當採購收貨單 或 採購收貨入庫單，收貨的次數
   IF g_argv[1] MATCHES '[13]' THEN
      LET l_cnt = 0
      SELECT COUNT (pmdldocno) INTO l_cnt
        FROM pmdl_t,pmab_t,pmdn_t,pmdo_t
        LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT (pmdt001) cnt
                           FROM pmds_t,pmdt_t
                          WHERE pmdsent = pmdtent
                            AND pmdsdocno = pmdtdocno
                            AND pmdsstus != 'X'
                            AND (pmds000 = '1' OR pmds000 = '3')
                          GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)
          ON pmdoent = pmdtent
         AND pmdodocno = pmdt001
         AND pmdoseq = pmdt002
         AND pmdoseq1 = pmdt003
         AND pmdoseq2 = pmdt004
       WHERE pmdlent = pmdnent
         AND pmdldocno = pmdndocno
         AND pmdnent = pmdoent
         AND pmdndocno = pmdodocno
         AND pmdnseq = pmdoseq
         AND pmabent = pmdlent
         AND pmabsite = 'ALL'
         AND pmab001 = pmdl004
         AND (COALESCE (pmdl206, 'N') = 'Y' 
          OR  ((pmdn022 = 'Y'
         AND   (COALESCE (pmab050, 0) >= 1
         AND    COALESCE (pmdl206, 'N') = 'N'
         AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)
          OR    COALESCE (pmab050, 0) = 0))
          OR   (pmdn022 = 'N' AND COALESCE (cnt,0) = 0)))
         AND pmdlent = g_enterprise
         AND pmdldocno = p_pmds006
      #輸入採購單號的採購明細必須有一筆以上 未達收貨次數！
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00905'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   #150506-00011#1 150525 By pomelo(E)
   
   #驗退時檢查(採購收貨單 無採購收貨單)單號
   IF g_argv[1] = '5' THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = p_pmds006
      IF NOT cl_chk_exist("v_pmdsdocno_8") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #(無)採購收貨單單身沒有任何一筆有可以登打的驗退量！
      LET l_cnt = 0
      SELECT COUNT(pmdtdocno) INTO l_cnt
        FROM pmdt_t a
        #150814-00005#1 By 150817 By pomelo mark(S) 效能調整
        #LEFT OUTER JOIN(SELECT c.pmdtent, c.pmdt027, c.pmdt028,
        #                       COALESCE(SUM(c.pmdt020),0) sumpmdt020
        #                  FROM pmds_t b, pmdt_t c
        #                 WHERE b.pmdsent = c.pmdtent
        #                   AND b.pmdsdocno = c.pmdtdocno
        #                   AND b.pmds000 = '5'
        #                   AND b.pmdsstus != 'X'
        #                 GROUP BY c.pmdtent, c.pmdt027, c.pmdt028) d
        #  ON a.pmdtent = d.pmdtent
        # AND a.pmdtdocno = d.pmdt027
        # AND a.pmdtseq =  d.pmdt028
        #150814-00005#1 By 150817 By pomelo mark(E) 效能調整
       WHERE a.pmdtent = g_enterprise
         AND a.pmdtdocno = p_pmds006
         AND 0 < (COALESCE(a.pmdt020,0) - COALESCE(a.pmdt053,0) -
                  COALESCE((SELECT COALESCE(SUM(c.pmdt020),0)
                              FROM pmds_t b, pmdt_t c
                             WHERE b.pmdsent = c.pmdtent
                               AND b.pmdsdocno = c.pmdtdocno
                               AND b.pmds000 = '5'
                               AND b.pmdsstus != 'X'
                               AND a.pmdtent = c.pmdtent
                               AND a.pmdtdocno = c.pmdt027
                               AND a.pmdtseq = c.pmdt028
                             GROUP BY c.pmdtent, c.pmdt027, c.pmdt028),0))
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00720'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
      
   #入庫時檢查收貨單號
   IF g_argv[1] = '6' THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = p_pmds006
      IF NOT cl_chk_exist("v_pmdsdocno_8") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      LET l_cnt = 0
      SELECT COUNT(pmdtdocno) INTO l_cnt
        FROM pmdt_t a
        #150814-00005#1 By 150817 By pomelo mark(S) 效能調整
        #LEFT OUTER JOIN(SELECT c.pmdtent, c.pmdt027, c.pmdt028,
        #                       COALESCE(SUM(c.pmdt020),0) sumpmdt020
        #                  FROM pmds_t b, pmdt_t c
        #                 WHERE b.pmdsent = c.pmdtent
        #                   AND b.pmdsdocno = c.pmdtdocno
        #                   AND b.pmds000 = '6'
        #                   AND b.pmdsstus != 'X'
        #                   AND b.pmdsstus != 'S'
        #                 GROUP BY c.pmdtent, c.pmdt027, c.pmdt028) d
        #  ON a.pmdtent = d.pmdtent
        # AND a.pmdtdocno = d.pmdt027
        # AND a.pmdtseq =  d.pmdt028
        #150814-00005#1 By 150817 By pomelo mark(E) 效能調整
       WHERE a.pmdtent = g_enterprise
         AND a.pmdtdocno = p_pmds006
         AND 0 < (COALESCE(a.pmdt053,0) -
                  COALESCE(((SELECT COALESCE(SUM(c.pmdt020),0)
                               FROM pmds_t b, pmdt_t c
                              WHERE b.pmdsent = c.pmdtent
                                AND b.pmdsdocno = c.pmdtdocno
                                AND b.pmds000 = '6'
                                AND a.pmdtent = c.pmdtent
                                AND a.pmdtdocno = c.pmdt027
                                AND a.pmdtseq = c.pmdt028
                                AND b.pmdsstus NOT IN ('X','S')
                              GROUP BY c.pmdtent, c.pmdt027, c.pmdt028)),0))
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00630'
         LET g_errparam.extend = p_pmds006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
      
   #倉退時檢查收貨單號
   IF g_argv[1] MATCHES '[7]' THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = p_pmds006
      LET g_chkparam.where = " pmds000 IN ('1','2','3','4') "
      IF NOT cl_chk_exist("v_pmdsdocno_6") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 帶出來源單據的資料
# Memo...........: 採購收貨、採購收貨入庫時，根據採購單單號帶值
#                : 驗退、入庫、倉退時，根據收貨單單號帶值
# Usage..........: CALL apmt860_pmds006_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/24 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmds006_default()

   #採購收貨、採購收貨入庫時，根據採購單單號帶值
   IF g_argv[1] MATCHES '[13]' THEN
      #將採購單頭上的欄位值預設到收貨單單頭的相關欄位上
      SELECT pmdl004,pmdl021,pmdl022,pmdl005,
             pmdl006,pmdl009,pmdl010,pmdl011,
             pmdl012,pmdl013,pmdl015,pmdl016,
             pmdl054,pmdl055
        INTO g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds011,
             g_pmds_m.pmds014,g_pmds_m.pmds031,g_pmds_m.pmds032,g_pmds_m.pmds033,
             g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds037,g_pmds_m.pmds038,
             g_pmds_m.pmds048,g_pmds_m.pmds049
        FROM pmdl_t
       WHERE pmdlent = g_enterprise
         AND pmdldocno = g_pmds_m.pmds006
   END IF
   
   #驗退、入庫、倉退時，根據收貨單單號帶值
   IF g_argv[1] MATCHES '[567]' THEN
      SELECT pmds007,pmds008,pmds009,pmds010,
             pmds011,pmds014,pmds021,pmds022,
             pmds023,pmds024,pmds031,pmds032,
             pmds033,pmds034,pmds035,#pmds036,
             pmds037,pmds038,pmds048,pmds049,
             pmds052
        INTO g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,
             g_pmds_m.pmds011,g_pmds_m.pmds014,g_pmds_m.pmds021,g_pmds_m.pmds022,
             g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,
             g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,#g_pmds_m.pmds036,
             g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds048,g_pmds_m.pmds049,
             g_pmds_m.pmds052
        FROM pmds_t
       WHERE pmdsent = g_enterprise
         AND pmdsdocno = g_pmds_m.pmds006
   END IF
   
   #採購供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds007) RETURNING g_pmds_m.pmds007_desc
   
   #帳款供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc
   
   #送貨供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
   
   #付款條件
   CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
   
   #交易條件
   CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
   
   #稅別
   CALL s_desc_get_tax_desc1(g_site,g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
   
   #幣別
   CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
   
   DISPLAY BY NAME g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,
                   g_pmds_m.pmds010,g_pmds_m.pmds011,g_pmds_m.pmds014,
                   g_pmds_m.pmds021,g_pmds_m.pmds022,g_pmds_m.pmds023,
                   g_pmds_m.pmds024,g_pmds_m.pmds031,g_pmds_m.pmds032,
                   g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,
                   #g_pmds_m.pmds036,
                   g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds048,
                   g_pmds_m.pmds049,g_pmds_m.pmds052,g_pmds_m.pmds007_desc,
                   g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,
                   g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,
                   g_pmds_m.pmds033_desc,g_pmds_m.pmds037_desc
END FUNCTION

################################################################################
# Descriptions...: 由供應商帶出其他欄位預設值
# Memo...........: 當為下面作業時，供應商才可以維護，才需要帶出其他欄位預設值
#                : (1) apmt861 無採購收貨單
#                : (2) apmt863 無採購收貨入庫單
#                : (3) apmt890 採購倉退單
# Usage..........: CALL apmt860_pmds007_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/25 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmds007_default()

   #當無採購收貨單、無採購收貨入庫單、倉退單
   #才需要預帶出
   IF g_argv[1] MATCHES '[247]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      #SELECT pmab037, pmab053, pmab034,  #Mark By Ken 151028 #151027-00013#1
      SELECT pmab037, pmab053,            #Add By Ken 151028 #151027-00013#1
             pmab033, pmab057, pmab058
        #INTO g_pmds_m.pmds031, g_pmds_m.pmds032, g_pmds_m.pmds033,  #Mark By Ken 151028 #151027-00013#1
        INTO g_pmds_m.pmds031, g_pmds_m.pmds032,                     #Add By Ken 151028 #151027-00013#1
             g_pmds_m.pmds037, g_pmds_m.pmds048, g_pmds_m.pmds049
        FROM pmab_t
       WHERE pmabent = g_enterprise
         AND pmabsite = 'ALL'
         AND pmab001 = g_pmds_m.pmds007                    
         
      #取單價含稅、稅率
      IF NOT cl_null(g_pmds_m.pmds033) THEN
         CALL s_adb_oodb002_default(g_pmds_m.pmdssite,g_pmds_m.pmds033)
            RETURNING g_pmds_m.pmds035,g_pmds_m.pmds034
      END IF
      
      #取匯率
      CALL s_apmt840_pmdl016_default(g_pmds_m.pmdssite,g_pmds_m.pmds037,g_pmds_m.pmds048)
         RETURNING g_pmds_m.pmds038
      
      #付款條件
      CALL s_desc_get_ooib002_desc(g_pmds_m.pmds031) RETURNING g_pmds_m.pmds031_desc
      
      #交易條件
      CALL s_desc_get_acc_desc('238',g_pmds_m.pmds032) RETURNING g_pmds_m.pmds032_desc
      
      #稅別
      CALL s_desc_get_tax_desc1(g_pmds_m.pmdssite,g_pmds_m.pmds033) RETURNING g_pmds_m.pmds033_desc
      
      #幣別
      CALL s_desc_get_currency_desc(g_pmds_m.pmds037) RETURNING g_pmds_m.pmds037_desc
   END IF
   
   #帳款供應商(pmds008)依供應商編號抓取pmac_t 且 交易類型 = 1.收/付款對象 且 勾主要
   LET g_pmds_m.pmds008 = ''
   LET g_pmds_m.pmds008_desc = ''
   CALL s_adb_get_pmac002(g_pmds_m.pmds007,'1','') RETURNING g_pmds_m.pmds008
   
   #送貨供應商(pmds009)依供應商編號抓取pmac_t 且 交易類型 = 2:出貨對象 且 勾主要
   LET g_pmds_m.pmds009 = ''
   LET g_pmds_m.pmds009_desc = ''
   CALL s_adb_get_pmac002(g_pmds_m.pmds007,'2','') RETURNING g_pmds_m.pmds009
   
   #帳款供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds008) RETURNING g_pmds_m.pmds008_desc

   #送貨供應商
   CALL s_desc_get_trading_partner_abbr_desc(g_pmds_m.pmds009) RETURNING g_pmds_m.pmds009_desc
   
   DISPLAY BY NAME g_pmds_m.pmds031, g_pmds_m.pmds032, g_pmds_m.pmds033,
                   g_pmds_m.pmds034, g_pmds_m.pmds035, g_pmds_m.pmds037,
                   g_pmds_m.pmds038, g_pmds_m.pmds048, g_pmds_m.pmds049,
                   g_pmds_m.pmds008, g_pmds_m.pmds009,
                   g_pmds_m.pmds031_desc, g_pmds_m.pmds032_desc,
                   g_pmds_m.pmds033_desc, g_pmds_m.pmds037_desc,
                   g_pmds_m.pmds008_desc, g_pmds_m.pmds009_desc
   
   LET g_pmds_m_o.pmds031 = g_pmds_m.pmds031
   LET g_pmds_m_o.pmds032 = g_pmds_m.pmds032
   LET g_pmds_m_o.pmds033 = g_pmds_m.pmds033
   LET g_pmds_m_o.pmds034 = g_pmds_m.pmds034
   LET g_pmds_m_o.pmds035 = g_pmds_m.pmds035
   LET g_pmds_m_o.pmds037 = g_pmds_m.pmds037
   LET g_pmds_m_o.pmds038 = g_pmds_m.pmds038
   LET g_pmds_m_o.pmds048 = g_pmds_m.pmds048
   LET g_pmds_m_o.pmds049 = g_pmds_m.pmds049
   LET g_pmds_m_o.pmds008 = g_pmds_m.pmds008
   LET g_pmds_m_o.pmds009 = g_pmds_m.pmds009

END FUNCTION

################################################################################
# Descriptions...: 單頭必要輸入欄位關閉
# Memo...........: 
# Usage..........: CALL apmt860_set_no_required()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/25 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_set_no_required()
   
   CALL cl_set_comp_required("pmds006",FALSE)   #來源單號
   CALL cl_set_comp_required("pmds031",FALSE)   #付款條件
   CALL cl_set_comp_required("pmds032",FALSE)   #交易條件
   CALL cl_set_comp_required("pmds033",FALSE)   #稅別
   
END FUNCTION

################################################################################
# Descriptions...: 單頭必要輸入欄位開啟
# Memo...........: 
# Usage..........: CALL apmt860_set_required()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/25 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_set_required()
   #驗退、入庫時，收貨單號必須錄入  
   IF g_argv[1] MATCHES '[56]' THEN
      CALL cl_set_comp_required("pmds006",TRUE)
   END IF
   
   #無採購收貨單、無採購收貨入庫單、採購驗退單、採購入庫單
   #付款條件、交易條件、稅別必須輸入
   IF g_argv[1] MATCHES '[123456]' THEN
      CALL cl_set_comp_required("pmds031",TRUE)   #付款條件
      CALL cl_set_comp_required("pmds032",TRUE)   #交易條件
      CALL cl_set_comp_required("pmds033",TRUE)   #稅別
   END IF
END FUNCTION

################################################################################
# Descriptions...: 單身採購單號檢查
# Memo...........: 
# Usage..........: CALL apmt860_pmdt001_chk()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/25 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt001_chk()
DEFINE l_pmdl         RECORD
       pmdl004        LIKE pmdl_t.pmdl004,  #採購供應商
       pmdl005        LIKE pmdl_t.pmdl005,  #採購性質
       pmdl006        LIKE pmdl_t.pmdl006,  #交易性質
       pmdl010        LIKE pmdl_t.pmdl010,  #交易條件
       pmdl021        LIKE pmdl_t.pmdl021,  #帳款供應商
       pmdl022        LIKE pmdl_t.pmdl022   #代送商
                      END RECORD
DEFINE l_pmdl006      LIKE pmdl_t.pmdl006   #交易性質
DEFINE l_pmdl010      LIKE pmdl_t.pmdl010   #交易條件
DEFINE l_cnt          LIKE type_t.num5
DEFINE r_success      LIKE type_t.num5

   LET r_success = TRUE
       
   IF NOT apmt860_pmds006_chk(g_pmdt_d[l_ac].pmdt001) THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
      
   #輸入的採購單的採購性質要跟單頭的一致
   INITIALIZE l_pmdl.* TO NULL
   SELECT pmdl004, pmdl005, pmdl006,
          pmdl010, pmdl021, pmdl022
     INTO l_pmdl.pmdl004, l_pmdl.pmdl005, l_pmdl.pmdl006,
          l_pmdl.pmdl010, l_pmdl.pmdl021, l_pmdl.pmdl022
     FROM pmdl_t
    WHERE pmdlent = g_enterprise
      AND pmdldocno = g_pmdt_d[l_ac].pmdt001
   
   #採購性質
   IF l_pmdl.pmdl005 <> g_pmds_m.pmds011 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00723'
      LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #採購供應商
   IF l_pmdl.pmdl004 <> g_pmds_m.pmds007 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00730'
      LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #帳款供應商
   IF l_pmdl.pmdl021 <> g_pmds_m.pmds008 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00731'
      LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #代送商
   IF l_pmdl.pmdl022 <> g_pmds_m.pmds009 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00732'
      LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   LET l_pmdl006 = ''
   LET l_pmdl010 = ''
   LET l_cnt = 0
   SELECT pmdl006,pmdl010,COUNT(pmdldocno)
     INTO l_pmdl006,l_pmdl010,l_cnt
     FROM pmdt_t, pmdl_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmds_m.pmdsdocno
      AND pmdtent = pmdlent
      AND pmdt001 = pmdldocno
    GROUP BY pmdl006,pmdl010
   
   IF l_cnt >= 1 AND NOT cl_null(l_cnt) THEN
      #輸入的採購單的多角性質需一致，不可不同收貨項次對應採購單的多角性質不一致
      IF l_pmdl.pmdl006 <> l_pmdl006 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00724'
         LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2014/12/26 暫時拿掉
      #輸入的採購單號的交易條件與其他項次對應採購單的交易條件不一致！
      #IF l_pmdl.pmdl010 <> l_pmdl010 THEN
      #   INITIALIZE g_errparam TO NULL
      #   LET g_errparam.code = 'apm-00725'
      #   LET g_errparam.extend = g_pmdt_d[l_ac].pmdt001
      #   LET g_errparam.popup = TRUE
      #   CALL cl_err()
      #   LET r_success = FALSE
      #   RETURN r_success
      #END IF
   END IF
   
   RETURN r_success
       
END FUNCTION

################################################################################
# Descriptions...: 採購單項次是否有存在
# Memo...........: 
# Usage..........: CALL apmt860_pmdt001_chk()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt002_chk()
DEFINE r_success    LIKE type_t.num5
DEFINE l_cnt        LIKE type_t.num5
DEFINE l_pmdn045    LIKE pmdn_t.pmdn045
DEFINE l_pmdn052    LIKE pmdn_t.pmdn052
DEFINE l_pmdnunit   LIKE pmdn_t.pmdnunit   #160426-00018#1 160503 by lori add

   LET r_success = TRUE
   
   #採購收貨、採購收貨入庫時，檢查對應採購單號的採購項次
   IF g_argv[1] MATCHES '[13]' THEN
      #輸入的採購單號+採購項次必須存在pmdo_t中
      LET l_cnt = 0
      LET l_pmdn045 = ''
      LET l_pmdn052 = ''
      LET l_pmdnunit = ''                                 #160426-00018#1 160503 by lori add 
      SELECT pmdn045,pmdn052,pmdnunit, COUNT(pmdodocno)   #160426-00018#1 160503 by lori add pmdnunit
        INTO l_pmdn045,l_pmdn052,l_pmdnunit,l_cnt         #160426-00018#1 160503 by lori add pmdnunit
        FROM pmdn_t, pmdo_t
       WHERE pmdnent = pmdoent
         AND pmdndocno = pmdodocno
         AND pmdnseq = pmdoseq
         AND pmdnent = g_enterprise
         AND pmdndocno = g_pmdt_d[l_ac].pmdt001
         AND pmdnseq = g_pmdt_d[l_ac].pmdt002
       GROUP BY pmdn045,pmdn052,pmdnunit                  #160426-00018#1 160503 by lori add pmdnunit
      
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.SQLCODE
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      IF l_cnt = 0 OR cl_null(l_cnt) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00726'
         LET g_errparam.extend = g_pmdt_d[l_ac].pmdt002
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      IF l_pmdn045 != '1' OR cl_null(l_pmdn045) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00727'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
      END IF
      
      IF l_pmdn052 = 'Y' AND g_argv[1] = '3' THEN
         #此採購單的商品編號對應商品品類需要檢驗，只可以在採購收貨單輸入此採購單項次！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "apm-00946"
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF

      #160426-00018#1 160503 by lori add---(S)
      IF l_pmdnunit <> g_pmds_m.pmdssite THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-01106'
         LET g_errparam.extend = ''
         LET g_errparam.replace[1] = g_pmdt_d[l_ac].pmdt001
         LET g_errparam.replace[2] = g_pmdt_d[l_ac].pmdt002
         LET g_errparam.replace[3] = l_pmdnunit
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      #160426-00018#1 160503 by lori add---(E)
      
      #150506-00011#1 150525 By pomelo add(S)
      LET l_cnt = 0
      SELECT COUNT (pmdldocno) INTO l_cnt
        FROM pmdl_t,pmab_t,pmdn_t,pmdo_t
        LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT (pmdt001) cnt
                           FROM pmds_t,pmdt_t
                          WHERE pmdsent = pmdtent
                            AND pmdsdocno = pmdtdocno
                            AND pmdsstus != 'X'
                            AND (pmds000 = '1' OR pmds000 = '3')
                          GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)
          ON pmdoent = pmdtent
         AND pmdodocno = pmdt001
         AND pmdoseq = pmdt002
         AND pmdoseq1 = pmdt003
         AND pmdoseq2 = pmdt004
       WHERE pmdlent = pmdnent
         AND pmdldocno = pmdndocno
         AND pmdnent = pmdoent
         AND pmdndocno = pmdodocno
         AND pmdnseq = pmdoseq
         AND pmabent = pmdlent
         AND pmabsite = 'ALL'
         AND pmab001 = pmdl004
         AND ( (pmdn022 = 'Y'
         AND   (COALESCE (pmab050, 0) >= 1
         AND    COALESCE (pmdl206, 'N') = 'N'
         AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)
          OR    COALESCE (pmab050, 0) = 0))
          OR   (pmdn022 = 'N' AND COALESCE(cnt,0) = 0))
         AND pmdoent = g_enterprise
         AND pmdodocno = g_pmdt_d[l_ac].pmdt001
         AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      IF l_cnt = 0 THEN
         #輸入採購單號+採購項次 已達收貨次數！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00908'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      #150506-00011#1 150525 By pomelo add(E)
   END IF

   RETURN r_success
        
END FUNCTION

################################################################################
# Descriptions...: 採購單項序是否有存在
# Memo...........:
# Usage..........: CALL apmt860_pmdt003_chk()
#                :    RETURNING r_success
# Input parameter: 無
# Return code....: r_success      True/False
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt003_chk()
DEFINE r_success   LIKE type_t.num5
DEFINE l_cnt       LIKE type_t.num5

   LET r_success = TRUE
   LET l_cnt = 0
   SELECT COUNT(pmdodocno) INTO l_cnt
     FROM pmdo_t
    WHERE pmdoent = g_enterprise
      AND pmdodocno = g_pmdt_d[l_ac].pmdt001
      AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
      
   IF l_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00728'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 採購單項序是否有存在
# Memo...........:
# Usage..........: CALL apmt860_pmdt004_chk()
#                :    RETURNING r_success
# Input parameter: 無
# Return code....: r_success      True/False
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt004_chk()
DEFINE r_success   LIKE type_t.num5
DEFINE l_cnt       LIKE type_t.num5

   LET r_success = TRUE
   LET l_cnt = 0

   SELECT COUNT(pmdodocno) INTO l_cnt
     FROM pmdo_t 
    WHERE pmdoent = g_enterprise
      AND pmdodocno = g_pmdt_d[l_ac].pmdt001
      AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
      AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
   IF l_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00729'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #150506-00011#1 150525 By pomelo add(S)
   LET l_cnt = 0
   SELECT COUNT (pmdldocno) INTO l_cnt
     FROM pmdl_t,pmab_t,pmdn_t,pmdo_t
     LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT (pmdt001) cnt
                        FROM pmds_t,pmdt_t
                       WHERE pmdsent = pmdtent
                         AND pmdsdocno = pmdtdocno
                         AND pmdsstus != 'X'
                         AND (pmds000 = '1' OR pmds000 = '3')
                       GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)
       ON pmdoent = pmdtent
      AND pmdodocno = pmdt001
      AND pmdoseq = pmdt002
      AND pmdoseq1 = pmdt003
      AND pmdoseq2 = pmdt004
    WHERE pmdlent = pmdnent
      AND pmdldocno = pmdndocno
      AND pmdnent = pmdoent
      AND pmdndocno = pmdodocno
      AND pmdnseq = pmdoseq
      AND pmabent = pmdlent
      AND pmabsite = 'ALL'
      AND pmab001 = pmdl004
      AND (COALESCE (pmdl206, 'N') = 'Y' 
       OR  ((pmdn022 = 'Y'
      AND   (COALESCE (pmab050, 0) >= 1
      AND    COALESCE (pmdl206, 'N') = 'N'
      AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)
       OR    COALESCE (pmab050, 0) = 0))
       OR   (pmdn022 = 'N' AND COALESCE (cnt, 0) = 0)))
      AND pmdoent = g_enterprise
      AND pmdodocno = g_pmdt_d[l_ac].pmdt001
      AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
      AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
   IF l_cnt = 0 THEN
      #輸入採購單號+採購項次+採購項序+採購分批序 已達收貨次數！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00907'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150506-00011#1 150525 By pomelo add(E)
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 預設採購項次
# Memo...........: 當採購單號的採購項次只有一筆時，預設值出來
# Usage..........: CALL apmt860_pmdt001_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt001_default()
DEFINE l_cnt       LIKE type_t.num5

   #讓欄位值先清空
   LET g_pmdt_d[l_ac].pmdt002 = ''
   LET g_pmdt_d[l_ac].pmdt003 = ''
   LET g_pmdt_d[l_ac].pmdt004 = ''

   LET l_cnt = 0
   SELECT COUNT(pmdndocno) INTO l_cnt
      FROM pmdn_t
     WHERE pmdnent = g_enterprise
       AND pmdndocno = g_pmdt_d[l_ac].pmdt001
   
   IF l_cnt = 1 THEN
      SELECT pmdnseq INTO g_pmdt_d[l_ac].pmdt002
        FROM pmdn_t
       WHERE pmdnent = g_enterprise
         AND pmdndocno = g_pmdt_d[l_ac].pmdt001
      
       
      #150506-00011#1 150525 By pomelo add(S)
      LET l_cnt = 0
      SELECT COUNT (pmdldocno) INTO l_cnt
        FROM pmdl_t,pmab_t,pmdn_t,pmdo_t
        LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT (pmdt001) cnt
                           FROM pmds_t,pmdt_t
                          WHERE pmdsent = pmdtent
                            AND pmdsdocno = pmdtdocno
                            AND pmdsstus != 'X'
                            AND (pmds000 = '1' OR pmds000 = '3')
                          GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)
          ON pmdoent = pmdtent
         AND pmdodocno = pmdt001
         AND pmdoseq = pmdt002
         AND pmdoseq1 = pmdt003
         AND pmdoseq2 = pmdt004
       WHERE pmdlent = pmdnent
         AND pmdldocno = pmdndocno
         AND pmdnent = pmdoent
         AND pmdndocno = pmdodocno
         AND pmdnseq = pmdoseq
         AND pmabent = pmdlent
         AND pmabsite = 'ALL'
         AND pmab001 = pmdl004
         AND ( (pmdn022 = 'Y'
         AND   (COALESCE (pmab050, 0) >= 1
         AND    COALESCE (pmdl206, 'N') = 'N'
         AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)
          OR    COALESCE (pmab050, 0) = 0))
          OR   (pmdn022 = 'N' AND COALESCE (cnt,0) = 0))
         AND pmdoent = g_enterprise
         AND pmdodocno = g_pmdt_d[l_ac].pmdt001
         AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      IF l_cnt = 0 THEN
         LET g_pmdt_d[l_ac].pmdt002 = ''
         RETURN 
      END IF
      #150506-00011#1 150525 By pomelo add(E)
      CALL apmt860_pmdt002_default()
   END IF
END FUNCTION

################################################################################
# Descriptions...: 預設採購項序
# Memo...........: 當採購單號+採購項次的採購項序只有一筆時，預設值出來
# Usage..........: CALL apmt860_pmdt002_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt002_default()
DEFINE l_cnt       LIKE type_t.num5

   #讓欄位值先清空
   LET g_pmdt_d[l_ac].pmdt003 = ''
   LET g_pmdt_d[l_ac].pmdt004 = ''

   LET l_cnt = 0
   SELECT COUNT(pmdodocno) INTO l_cnt
      FROM pmdo_t
     WHERE pmdoent = g_enterprise
       AND pmdodocno = g_pmdt_d[l_ac].pmdt001
       AND pmdoseq = g_pmdt_d[l_ac].pmdt002
       
   IF l_cnt = 1 THEN
      SELECT pmdoseq1 INTO g_pmdt_d[l_ac].pmdt003
        FROM pmdo_t
       WHERE pmdoent = g_enterprise
         AND pmdodocno = g_pmdt_d[l_ac].pmdt001
         AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      
      CALL apmt860_pmdt003_default()
   END IF
END FUNCTION

################################################################################
# Descriptions...: 預設採購分批序
# Memo...........: 當採購單號+採購項次+採購項序的採購分批序只有一筆時，預設值出來
# Usage..........: CALL apmt860_pmdt003_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt003_default()
DEFINE l_cnt       LIKE type_t.num5

   #讓欄位值先清空
   LET g_pmdt_d[l_ac].pmdt004 = ''

   LET l_cnt = 0
   SELECT COUNT(pmdodocno) INTO l_cnt
      FROM pmdo_t
     WHERE pmdoent = g_enterprise
       AND pmdodocno = g_pmdt_d[l_ac].pmdt001
       AND pmdoseq = g_pmdt_d[l_ac].pmdt002
       AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
       
   IF l_cnt = 1 THEN
      SELECT pmdoseq2 INTO g_pmdt_d[l_ac].pmdt004
        FROM pmdo_t
       WHERE pmdoent = g_enterprise
         AND pmdodocno = g_pmdt_d[l_ac].pmdt001
         AND pmdoseq = g_pmdt_d[l_ac].pmdt002
         AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
         
      CALL apmt860_pmdt004_default()
   END IF
END FUNCTION

################################################################################
# Descriptions...: 帶出採購單的相關資訊
# Memo...........:
# Usage..........: CALL apmt860_pmdt004_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/26 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt004_default()
DEFINE l_pmdt      RECORD
       pmdt005     LIKE pmdt_t.pmdt005,    #子件特性
       pmdt006     LIKE pmdt_t.pmdt006,    #商品編號
       pmdt007     LIKE pmdt_t.pmdt007,    #產品特徵
       pmdt016     LIKE pmdt_t.pmdt016,    #庫位
       pmdt017     LIKE pmdt_t.pmdt017,    #儲位
       pmdt018     LIKE pmdt_t.pmdt018,    #批號
       pmdt019     LIKE pmdt_t.pmdt019,    #收貨單位
       pmdt020     LIKE pmdt_t.pmdt020,    #收貨數量
       pmdt023     LIKE pmdt_t.pmdt023,    #計價單位
       pmdt024     LIKE pmdt_t.pmdt024,    #計價數量
       pmdt025     LIKE pmdt_t.pmdt025,    #緊急度
       pmdt026     LIKE pmdt_t.pmdt026,    #檢驗否
       pmdt036     LIKE pmdt_t.pmdt036,    #單價
       pmdt037     LIKE pmdt_t.pmdt037,    #稅率
       pmdt044     LIKE pmdt_t.pmdt044,    #取出單價        #150513 By pomelo add
       pmdt046     LIKE pmdt_t.pmdt046,    #稅別
       pmdt063     LIKE pmdt_t.pmdt063,    #庫存管理特徵
       pmdt200     LIKE pmdt_t.pmdt200,    #商品條碼
       pmdt201     LIKE pmdt_t.pmdt201,    #包裝單位
       pmdt202     LIKE pmdt_t.pmdt202,    #包裝數量
       pmdt203     LIKE pmdt_t.pmdt203,    #採購組織
       pmdt204     LIKE pmdt_t.pmdt204,    #採購中心
       pmdt205     LIKE pmdt_t.pmdt205,    #要貨組織
       pmdt208     LIKE pmdt_t.pmdt208,    #採購渠道
       pmdt209     LIKE pmdt_t.pmdt209,    #渠道性質
       pmdt210     LIKE pmdt_t.pmdt210,    #經營方式
       pmdt211     LIKE pmdt_t.pmdt211,    #結算方式
       pmdt212     LIKE pmdt_t.pmdt212,    #協議編號
       pmdt213     LIKE pmdt_t.pmdt213,    #合約編號
       pmdt214     LIKE pmdt_t.pmdt214,    #採購方式
       pmdt215     LIKE pmdt_t.pmdt215,    #最終收貨組織
       pmdt218     LIKE pmdt_t.pmdt218,    #取出單價        #150513 By pomelo add
       pmdtorga    LIKE pmdt_t.pmdtorga,   #帳務組織
       pmdt227     LIKE pmdt_t.pmdt227     #補貨規格說明  150710-00016#7 Add By Ken 150713 
                   END RECORD
DEFINE l_success   LIKE type_t.num5
DEFINE l_pmdt020   LIKE pmdt_t.pmdt020     #可登打的數量
DEFINE l_pmdo006   LIKE pmdo_t.pmdo006     #分批採購數量
DEFINE l_imaa149   LIKE imaa_t.imaa149     #臨期控管方式  150714-00016#1 150714 By pomelo add
DEFINE l_imaa102        LIKE imaa_t.imaa102   #保質期(月)    #160604-00009#96 Add By Ken 160623
DEFINE l_imaa103        LIKE imaa_t.imaa103   #保質期(日)    #160604-00009#96 Add By Ken 160623
DEFINE l_pmdt219        LIKE pmdt_t.pmdt219   #製造日期      #160604-00009#96 Add By Ken 160623

   INITIALIZE l_pmdt.* TO NULL
   SELECT pmdo003, pmdo001,  pmdo002, pmdn028,
          pmdn029, pmdn030,  pmdo004, pmdn010,
          pmdn020, pmdn052,  pmdn015, pmdn015,
          pmdn043, pmdn017,  pmdn016, pmdn200,
          pmdn201, pmdnsite, pmdn222, pmdn205,
          pmdn214, pmdn215,  pmdn216, pmdn217,
          pmdn218, pmdn219,  pmdl203, pmdn225,
          pmdn053, pmdnorga, pmdo006, pmdn227  #150710-00016#7 Add By Ken 150713 加帶補貨規格說明
     INTO l_pmdt.pmdt005, l_pmdt.pmdt006, l_pmdt.pmdt007, l_pmdt.pmdt016,
          l_pmdt.pmdt017, l_pmdt.pmdt018, l_pmdt.pmdt019, l_pmdt.pmdt023,
          l_pmdt.pmdt025, l_pmdt.pmdt026, l_pmdt.pmdt036, l_pmdt.pmdt218,
          l_pmdt.pmdt044, l_pmdt.pmdt037, l_pmdt.pmdt046, l_pmdt.pmdt200,
          l_pmdt.pmdt201, l_pmdt.pmdt203, l_pmdt.pmdt204, l_pmdt.pmdt205,
          l_pmdt.pmdt208, l_pmdt.pmdt209, l_pmdt.pmdt210, l_pmdt.pmdt211,
          l_pmdt.pmdt212, l_pmdt.pmdt213, l_pmdt.pmdt214, l_pmdt.pmdt215,
          l_pmdt.pmdt063, l_pmdt.pmdtorga,l_pmdo006     , l_pmdt.pmdt227  #150710-00016#7 Add By Ken 150713 加帶補貨規格說明
     FROM pmdl_t,pmab_t,pmdn_t, pmdo_t
     LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT (pmdt001) cnt
                        FROM pmds_t,pmdt_t
                       WHERE pmdsent = pmdtent
                         AND pmdsdocno = pmdtdocno
                         AND pmdsstus != 'X'
                         AND (pmds000 = '1' OR pmds000 = '3')
                       GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)
       ON pmdoent = pmdtent
      AND pmdodocno = pmdt001
      AND pmdoseq = pmdt002
      AND pmdoseq1 = pmdt003
      AND pmdoseq2 = pmdt004
    WHERE pmdlent = pmdnent
      AND pmdldocno = pmdndocno
      AND pmdnent = pmdoent
      AND pmdndocno = pmdodocno
      AND pmdnseq = pmdoseq
      AND pmdoent = g_enterprise
      AND pmdodocno = g_pmdt_d[l_ac].pmdt001
      AND pmdoseq = g_pmdt_d[l_ac].pmdt002
      AND pmdoseq1 = g_pmdt_d[l_ac].pmdt003
      AND pmdoseq2 = g_pmdt_d[l_ac].pmdt004
      AND pmabsite = 'ALL'
      AND pmab001 = pmdl004
      AND (COALESCE (pmdl206, 'N') = 'Y' 
       OR  ((pmdn022 = 'Y'
      AND   (COALESCE (pmab050, 0) >= 1
      AND    COALESCE (pmdl206, 'N') = 'N'
      AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)
       OR    COALESCE (pmab050, 0) = 0))
       OR   (pmdn022 = 'N' AND COALESCE(cnt,0) = 0)))
   
   IF cl_get_para(g_enterprise,'','E-CIR-0041') = 'Y' THEN
      LET l_success = ''
      LET l_pmdt020 = 0
      CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000,   g_pmdt_d[l_ac].pmdtsite,
                                 g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,
                                 g_pmdt_d[l_ac].pmdt001,  g_pmdt_d[l_ac].pmdt002,
                                 g_pmdt_d[l_ac].pmdt003,  g_pmdt_d[l_ac].pmdt004,
                                 g_pmdt_d[l_ac].pmdt006,  g_pmdt_d[l_ac].pmdt206,
                                 g_pmdt_d[l_ac].pmdt207,  0)
         RETURNING l_success,l_pmdt020
      LET g_pmdt_d[l_ac].pmdt020  = l_pmdt020       #收貨數量
      LET g_pmdt_d[l_ac].pmdt202  = 0               #包裝數量
   END IF
   
   #151202-00010#2 s983961--add(s)
   #商品品類編號 
    SELECT imaa009,rtaxl003 INTO g_pmdt_d[l_ac].pmdt220,g_pmdt_d[l_ac].pmdt220_desc
      FROM imaa_t
      LEFT OUTER JOIN rtaxl_t ON rtaxlent = g_enterprise AND rtaxl001 = imaa009 AND rtaxl002 = g_dlang
     WHERE imaaent = g_enterprise
       AND imaa001 = l_pmdt.pmdt006
    #151202-00010#2 s983961--add(e)
    
    #170217-00003#1 2017/02/18 By 08171 --s add
    #當為 採購收貨單 & 統採越庫時，預設倉庫
    IF g_argv[1] = '1' AND l_pmdt.pmdt214 = '3' THEN
       LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)    
    END IF
    #170217-00003#1 2017/02/18 By 08171 --e add
   
   LET g_pmdt_d[l_ac].pmdt005  = l_pmdt.pmdt005     #子件特性
   LET g_pmdt_d[l_ac].pmdt006  = l_pmdt.pmdt006     #商品編號
   LET g_pmdt_d[l_ac].pmdt007  = l_pmdt.pmdt007     #產品特徵
   LET g_pmdt_d[l_ac].pmdt016  = l_pmdt.pmdt016     #庫位
   LET g_pmdt_d[l_ac].pmdt017  = l_pmdt.pmdt017     #儲位
   LET g_pmdt_d[l_ac].pmdt018  = l_pmdt.pmdt018     #批號
   LET g_pmdt_d[l_ac].pmdt019  = l_pmdt.pmdt019     #收貨單位
   LET g_pmdt_d[l_ac].pmdt023  = l_pmdt.pmdt023     #計價單位
   LET g_pmdt_d[l_ac].pmdt024  = 0                  #計價數量
   LET g_pmdt_d[l_ac].pmdt025  = l_pmdt.pmdt025     #緊急度
   LET g_pmdt_d[l_ac].pmdt026  = l_pmdt.pmdt026     #檢驗否
   LET g_pmdt_d[l_ac].pmdt036  = l_pmdt.pmdt036     #單價
   LET g_pmdt_d[l_ac].pmdt037  = l_pmdt.pmdt037     #稅率
   LET g_pmdt_d[l_ac].pmdt044  = l_pmdt.pmdt044     #取出單價
   LET g_pmdt_d[l_ac].pmdt046  = l_pmdt.pmdt046     #稅別
   LET g_pmdt_d[l_ac].pmdt053  = l_pmdt020          #允收數量
   LET g_pmdt_d[l_ac].pmdt063  = l_pmdt.pmdt063     #庫存管理特徵
   LET g_pmdt_d[l_ac].pmdt200  = l_pmdt.pmdt200     #商品條碼
   LET g_pmdt_d[l_ac].pmdt201  = l_pmdt.pmdt201     #包裝單位
   LET g_pmdt_d[l_ac].pmdt203  = l_pmdt.pmdt203     #採購組織
   LET g_pmdt_d[l_ac].pmdt204  = l_pmdt.pmdt204     #採購中心
   LET g_pmdt_d[l_ac].pmdt205  = l_pmdt.pmdt205     #要貨組織
   LET g_pmdt_d[l_ac].pmdt208  = l_pmdt.pmdt208     #採購渠道
   LET g_pmdt_d[l_ac].pmdt209  = l_pmdt.pmdt209     #渠道性質
   LET g_pmdt_d[l_ac].pmdt210  = l_pmdt.pmdt210     #經營方式
   LET g_pmdt_d[l_ac].pmdt211  = l_pmdt.pmdt211     #結算方式
   LET g_pmdt_d[l_ac].pmdt212  = l_pmdt.pmdt212     #協議編號
   LET g_pmdt_d[l_ac].pmdt213  = l_pmdt.pmdt213     #合約編號
   LET g_pmdt_d[l_ac].pmdt214  = l_pmdt.pmdt214     #採購方式
   LET g_pmdt_d[l_ac].pmdt215  = l_pmdt.pmdt215     #最終收貨組織
   LET g_pmdt_d[l_ac].pmdt218  = l_pmdt.pmdt218     #採購價
   LET g_pmdt_d[l_ac].pmdtorga = l_pmdt.pmdtorga    #帳務組織
   LET g_pmdt_d[l_ac].pmdt227  = l_pmdt.pmdt227     #補貨規格說明    150710-00016#7 Add By Ken 150713 
   
   
   #160604-00009#96 Add By Ken 160623(S)   制造(有效)日期给默认值:如保質期(月、日)都沒設定的話 默认给系统日期
   SELECT COALESCE(imaa102,0),COALESCE(imaa103,0) 
     INTO l_imaa102,l_imaa103
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdt_d[l_ac].pmdt006
   IF (l_imaa102 = 0) AND (l_imaa103 = 0) THEN
      LET g_pmdt_d[l_ac].pmdt219 = g_today 
      LET g_pmdt_d[l_ac].pmdt089 = g_today 
   ELSE
      LET g_pmdt_d[l_ac].pmdt219 = ''
      LET g_pmdt_d[l_ac].pmdt089 = ''   
   END IF
   #160604-00009#96 Add By Ken 160623(E) 
   
   #150714-00016#1 By pomelo add(S)
   LET l_imaa149 = s_apmt860_get_imaa149(g_pmdt_d[l_ac].pmdt006)
   IF l_imaa149 MATCHES '[23]' AND NOT cl_null(l_imaa149) THEN
      LET g_pmdt_d[l_ac].pmdt219 = g_today
   #150714-00016#1 By pomelo add(E)
      CALL s_lot_out_effdate(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                             g_pmdt_d[l_ac].pmdt219,  g_pmdt_d[l_ac].pmdt018)
         RETURNING l_success,g_pmdt_d[l_ac].pmdt089
         
      #160615-00028#3 Add By ken 160623(S)
      CALL s_apmt860_pmdt219_get(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                                g_pmdt_d[l_ac].pmdt089,  g_pmdt_d[l_ac].pmdt018)
         RETURNING l_success,l_pmdt219
      IF l_success THEN
         LET g_pmdt_d[l_ac].pmdt219 = l_pmdt219
      END IF
      #160615-00028#3 Add By ken 160623(E)         
   END IF    #150714-00016#1 By pomelo add
   
   
   
   #單位間的轉換數量
   CALL apmt860_num_change()
   
   #取得未稅金額、稅額、含稅金額
   CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                             g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                             g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                             g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
      RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
   
   #商品編號
   CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006)
      RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
   
   #產品特徵
   CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007)
     RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
   
   #庫位
   CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
   
   #儲位
   CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
      RETURNING g_pmdt_d[l_ac].pmdt017_desc
   
   #收貨單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
   
   #計價單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
   
   #稅別
   CALL s_desc_get_tax_desc1(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
   
   #包裝單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt201) RETURNING g_pmdt_d[l_ac].pmdt201_desc
   
   #採購組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt203) RETURNING g_pmdt_d[l_ac].pmdt203_desc
   
   #採購中心
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt204) RETURNING g_pmdt_d[l_ac].pmdt204_desc
   
   #要貨組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt205) RETURNING g_pmdt_d[l_ac].pmdt205_desc
   
   #最終收貨組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt215) RETURNING g_pmdt_d[l_ac].pmdt215_desc
   
   #採購渠道
   CALL s_desc_get_oojdl003_desc(g_pmdt_d[l_ac].pmdt208) RETURNING g_pmdt_d[l_ac].pmdt208_desc
   
   #結算方式
   CALL apmt860_pmdt211_ref()
   
   #帳務組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdtorga) RETURNING g_pmdt_d[l_ac].pmdtorga_desc
   
   LET g_pmdt_d[l_ac].pmdo001 = g_pmdt_d[l_ac].pmdt006
   LET g_pmdt_d[l_ac].pmdo001_desc = g_pmdt_d[l_ac].pmdt006_desc
   LET g_pmdt_d[l_ac].pmdo001_desc_desc = g_pmdt_d[l_ac].pmdt006_desc_desc
   LET g_pmdt_d[l_ac].pmdo002 = g_pmdt_d[l_ac].pmdt007
   LET g_pmdt_d[l_ac].pmdo002_desc = g_pmdt_d[l_ac].pmdt007_desc
   LET g_pmdt_d[l_ac].l_pmdo006 = l_pmdo006
   
   #取前單據限定庫位、限定儲位、限定批號、庫存管理特徵
   LET g_pmdt016 = l_pmdt.pmdt016
   LET g_pmdt017 = l_pmdt.pmdt017
   LET g_pmdt018 = l_pmdt.pmdt018
   LET g_pmdt063 = l_pmdt.pmdt063
  
   #151202-00010#2 s983961--add(s)
   #來源商品品類編號 
   IF g_argv[1] MATCHES '[13]' THEN
   #  SELECT imaa009,rtaxl003 INTO g_pmdt_d[l_ac].pmdt221,g_pmdt_d[l_ac].pmdt221_desc
   #    FROM imaa_t
   #    LEFT OUTER JOIN rtaxl_t ON rtaxlent = g_enterprise AND rtaxl001 = imaa009 AND rtaxl002 = g_dlang
   #   WHERE imaaent = g_enterprise
   #     AND imaa001 = g_pmdt_d[l_ac].pmdo001 
      SELECT pmdn228,rtaxl003 INTO g_pmdt_d[l_ac].pmdt221,g_pmdt_d[l_ac].pmdt221_desc
        FROM pmdn_t
        LEFT OUTER JOIN rtaxl_t ON rtaxlent = g_enterprise AND rtaxl001 = pmdn001 AND rtaxl002 = g_dlang
       WHERE pmdnent = g_enterprise
         AND pmdndocno = g_pmdt_d[l_ac].pmdt001 
         AND pmdnseq = g_pmdt_d[l_ac].pmdt002  
   END IF   
   #151202-00010#2 s983961--add(e)
END FUNCTION

################################################################################
# Descriptions...: 單位間的轉換數量
# Memo...........: 當收貨數量為空，由包裝數量轉換成收貨數量及計價數量
#                : 當收貨數量有值，由收貨數量轉換成包裝數量及計價數量
# Usage..........: CALL apmt860_num_change()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/27 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_num_change()
DEFINE l_success        LIKE type_t.num5

   #當包裝單位或收貨單位都為空，表示無法轉換
   IF cl_null(g_pmdt_d[l_ac].pmdt201) OR cl_null(g_pmdt_d[l_ac].pmdt019) THEN
      RETURN
   END IF

   #當收貨數量為空
   IF cl_null(g_pmdt_d[l_ac].pmdt020) THEN
      #當包裝數量為空
      IF cl_null(g_pmdt_d[l_ac].pmdt202) THEN
         RETURN
      ELSE
         #當收貨數量為空，由包裝數量轉換成收貨數量
         CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt202)
            RETURNING l_success,g_pmdt_d[l_ac].pmdt020
      END IF
   ELSE
      #當收貨數量有值，由收貨數量轉換成包裝數量
      CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success,g_pmdt_d[l_ac].pmdt202
   END IF

   #計算計價數量
   IF NOT cl_null(g_pmdt_d[l_ac].pmdt023) THEN
      CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success,g_pmdt_d[l_ac].pmdt024
   END IF

   #允收數量
   #當(無)採購收貨單、(無)採購收貨入庫單
   # 檢驗 = 'N' 或 允收數量為空 或 (檢驗 = 'Y' 且 允收數量 > 收貨數量)
   IF g_argv[1] MATCHES '[1234]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      IF cl_null(g_pmdt_d[l_ac].pmdt053) OR
         g_pmdt_d[l_ac].pmdt026 = 'N' OR 
         (g_pmdt_d[l_ac].pmdt026 = 'Y' AND
          g_pmdt_d[l_ac].pmdt053 > g_pmdt_d[l_ac].pmdt020) THEN
         LET g_pmdt_d[l_ac].pmdt053 = g_pmdt_d[l_ac].pmdt020
      END IF
   END IF
   
   #驗退數量 當(無)採購收貨單 且 驗退 = 'Y'
   CALL apmt860_pmdt055_default()
END FUNCTION

################################################################################
# Descriptions...: 結算方式
# Memo...........:
# Usage..........: CALL apmt860_pmdt211_ref()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/27 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt211_ref()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_pmdt_d[l_ac].pmdt211
   CALL ap_ref_array2(g_ref_fields,"SELECT staal003 FROM staal_t WHERE staalent='"||g_enterprise||"' AND staal001=? AND staal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_pmdt_d[l_ac].pmdt211_desc = '', g_rtn_fields[1] , ''
END FUNCTION

################################################################################
# Descriptions...: 準備產生單號需要的sql
# Memo...........:
# Usage..........: CALL apmt860_gen_detail_pre()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2014/12/29 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_gen_detail_pre()
DEFINE l_sql        STRING

   #計算項次對大值
   LET l_sql = "SELECT COALESCE(MAX(pmdtseq),0)+1",
               "  FROM pmdt_t",
               " WHERE pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'"
   PREPARE apmt860_max_seq FROM l_sql
END FUNCTION

################################################################################
# Descriptions...: 根據單頭採購單號，自動產生單身
# Memo...........: 程式：採購收貨單、採購收貨入庫單
# Usage..........: CALL apmt860_gen_detail()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success      True/False
# Date & Author..: 2014/12/29 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_gen_detail()
DEFINE r_success        LIKE type_t.num5
DEFINE l_sql            STRING
DEFINE l_success        LIKE type_t.num5
DEFINE l_pmdt020        LIKE pmdt_t.pmdt020
DEFINE l_xrcd103        LIKE xrcd_t.xrcd103
DEFINE l_xrcd104        LIKE xrcd_t.xrcd104
DEFINE l_xrcd105        LIKE xrcd_t.xrcd105
DEFINE l_xrcd113        LIKE xrcd_t.xrcd113
DEFINE l_xrcd114        LIKE xrcd_t.xrcd114
DEFINE l_xrcd115        LIKE xrcd_t.xrcd115
DEFINE l_pmdt089        LIKE pmdt_t.pmdt089
DEFINE l_imaa149        LIKE imaa_t.imaa149     #臨期控管方式  150714-00016#1 150714 By pomelo add
DEFINE l_pmdt           RECORD
       pmdtent          LIKE pmdt_t.pmdtent,    #企業編號
       pmdtsite         LIKE pmdt_t.pmdtsite,   #營運據點
       pmdtdocno        LIKE pmdt_t.pmdtdocno,  #單據編號
       pmdtseq          LIKE pmdt_t.pmdtseq,    #項次
       pmdt001          LIKE pmdt_t.pmdt001,    #採購單號
       pmdt002          LIKE pmdt_t.pmdt002,    #採購項次
       pmdt003          LIKE pmdt_t.pmdt003,    #採購項序
       pmdt004          LIKE pmdt_t.pmdt004,    #採購分批序
       pmdt005          LIKE pmdt_t.pmdt005,    #子件特性
       pmdt006          LIKE pmdt_t.pmdt006,    #料件編號
       pmdt007          LIKE pmdt_t.pmdt007,    #產品特徵
       pmdt016          LIKE pmdt_t.pmdt016,    #庫位
       pmdt017          LIKE pmdt_t.pmdt017,    #儲位
       pmdt018          LIKE pmdt_t.pmdt018,    #批號
       pmdt019          LIKE pmdt_t.pmdt019,    #收貨/入庫單位
       pmdt020          LIKE pmdt_t.pmdt020,    #收貨/入庫數量
       pmdt023          LIKE pmdt_t.pmdt023,    #計價單位
       pmdt024          LIKE pmdt_t.pmdt024,    #計價數量
       pmdt025          LIKE pmdt_t.pmdt025,    #緊急度
       pmdt026          LIKE pmdt_t.pmdt026,    #檢驗否
       pmdt027          LIKE pmdt_t.pmdt027,    #收貨單號
       pmdt028          LIKE pmdt_t.pmdt028,    #收貨項次
       pmdt036          LIKE pmdt_t.pmdt036,    #單價
       pmdt037          LIKE pmdt_t.pmdt037,    #稅率
       pmdt038          LIKE pmdt_t.pmdt038,    #未稅金額
       pmdt039          LIKE pmdt_t.pmdt039,    #含稅金額
       pmdt044          LIKE pmdt_t.pmdt044,    #取出單價        #150513 By pomelo add
       pmdt046          LIKE pmdt_t.pmdt046,    #稅別
       pmdt047          LIKE pmdt_t.pmdt047,    #稅額
       pmdt051          LIKE pmdt_t.pmdt051,    #理由碼
       pmdt052          LIKE pmdt_t.pmdt052,    #狀態碼
       pmdt053          LIKE pmdt_t.pmdt053,    #允收數量
       pmdt054          LIKE pmdt_t.pmdt054,    #已入庫量
       pmdt055          LIKE pmdt_t.pmdt055,    #驗退量
       pmdt062          LIKE pmdt_t.pmdt062,    #多庫儲批收貨入庫
       pmdt063          LIKE pmdt_t.pmdt063,    #庫存管理特徵
       pmdt084          LIKE pmdt_t.pmdt084,    #須自立AP否
       pmdt088          LIKE pmdt_t.pmdt088,    #存貨備註
       pmdt089          LIKE pmdt_t.pmdt089,    #有效日期
       pmdt200          LIKE pmdt_t.pmdt200,    #商品條碼
       pmdt201          LIKE pmdt_t.pmdt201,    #收貨包裝單位
       pmdt202          LIKE pmdt_t.pmdt202,    #收貨包裝數量
       pmdt203          LIKE pmdt_t.pmdt203,    #採購組織
       pmdt204          LIKE pmdt_t.pmdt204,    #採購中心
       pmdt205          LIKE pmdt_t.pmdt205,    #要貨組織
       pmdt206          LIKE pmdt_t.pmdt206,    #預約收貨單號
       pmdt207          LIKE pmdt_t.pmdt207,    #預約收貨項次
       pmdt208          LIKE pmdt_t.pmdt208,    #採購渠道
       pmdt209          LIKE pmdt_t.pmdt209,    #渠道性質
       pmdt210          LIKE pmdt_t.pmdt210,    #經營方式
       pmdt211          LIKE pmdt_t.pmdt211,    #結算方式
       pmdt212          LIKE pmdt_t.pmdt212,    #合約編號
       pmdt213          LIKE pmdt_t.pmdt213,    #協議編號
       pmdt214          LIKE pmdt_t.pmdt214,    #採購方式
       pmdt215          LIKE pmdt_t.pmdt215,    #最終收貨組織
       pmdt218          LIKE pmdt_t.pmdt218,    #採購價        #150513 By pomelo add
       pmdt219          LIKE pmdt_t.pmdt219,    #製造日期
       pmdtorga         LIKE pmdt_t.pmdtorga,   #帳務組織
       pmdt227          LIKE pmdt_t.pmdt227     #補貨規格說明    150710-00016#7 Add By Ken 150713 
                        END RECORD
DEFINE l_pmdt220        LIKE pmdt_t.pmdt220     #商品品類     151202-00010#2 s983961--add
DEFINE l_pmdt221        LIKE pmdt_t.pmdt221     #來源商品品類  151202-00010#2 s983961--add
DEFINE l_imaa102        LIKE imaa_t.imaa102   #保質期(月)    #160604-00009#96 Add By Ken 160623
DEFINE l_imaa103        LIKE imaa_t.imaa103   #保質期(日)    #160604-00009#96 Add By Ken 160623
DEFINE l_pmdt219        LIKE pmdt_t.pmdt219   #製造日期      #160604-00009#96 Add By Ken 160623

   LET r_success = TRUE
   CALL cl_err_collect_init()
   
   CALL apmt860_gen_detail_pre()
   LET l_sql = "SELECT pmdnent,  pmdnunit, pmdndocno, pmdnseq,",
               "       pmdoseq1, pmdoseq2, pmdn019,   pmdn001,",
               "       pmdn002,  pmdn028,  pmdn029,   pmdn030,",
               "       pmdo004,  pmdn010,  pmdn020,   pmdn052,",
               "       pmdn015,  pmdn017,  pmdn043,   pmdn016,",
               "       pmdn053,  pmdn200,  pmdn201,   pmdnsite,",
               "       pmdn222,  pmdn205,  pmdn214,   pmdn215,",
               "       pmdn216,  pmdn217,  pmdn218,   pmdn219,",
               "       pmdl203,  pmdn225,  pmdn015,   pmdnorga,",
               "       pmdn227 ",  #補貨規格說明    150710-00016#7 Add By Ken 150713 
               "  FROM pmdl_t,pmab_t,pmdn_t, pmdo_t",
               "  LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT(pmdt001) cnt",
               "                     FROM pmds_t, pmdt_t",
               "                    WHERE pmdsent = pmdtent",
               "                      AND pmdsdocno = pmdtdocno",
               "                      AND pmdsstus != 'X'",
               "                      AND (pmds000 = '1' OR pmds000 = '3')",
               "                    GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)",
               "    ON pmdoent = pmdtent",
               "   AND pmdodocno = pmdt001",
               "   AND pmdoseq = pmdt002",
               "   AND pmdoseq1 = pmdt003",
               "   AND pmdoseq2 = pmdt004",
               " WHERE pmdlent = pmdnent",
               "   AND pmdldocno = pmdndocno",
               "   AND pmdnent = pmdoent",
               "   AND pmdndocno = pmdodocno",
               "   AND pmdnseq = pmdoseq",
               "   AND pmdoent = ",g_enterprise,
               "   AND pmdodocno = '",g_pmds_m.pmds006,"'",
               "   AND pmdn045 = '1'",
               "   AND pmdnunit = '",g_pmds_m.pmdssite,"'",
               "   AND pmabent = pmdlent",
               "   AND pmabsite = 'ALL'",
               "   AND pmab001 = pmdl004",
               "   AND (COALESCE (pmdl206, 'N') = 'Y'",
               "    OR  ((pmdn022 = 'Y'",
               "   AND   (COALESCE (pmab050, 0) >= 1",
               "   AND    COALESCE (pmdl206, 'N') = 'N'",
               "   AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)",
               "    OR    COALESCE (pmab050, 0) = 0))",
               "    OR   (pmdn022 = 'N' AND COALESCE(cnt,0) = 0)))"
   
   IF g_argv[1] = '3' THEN
      LET l_sql = l_sql," AND pmdn052 = 'N'"
   END IF
   LET l_sql = l_sql," ORDER BY pmdnseq"
   
   PREPARE apmt860_gen_detail_pre FROM l_sql
   DECLARE apmt860_gen_detail_cs CURSOR FOR apmt860_gen_detail_pre
   
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_detail_cs
      INTO l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdt001, l_pmdt.pmdt002,
           l_pmdt.pmdt003, l_pmdt.pmdt004,  l_pmdt.pmdt005, l_pmdt.pmdt006,
           l_pmdt.pmdt007, l_pmdt.pmdt016,  l_pmdt.pmdt017, l_pmdt.pmdt018,
           l_pmdt.pmdt019, l_pmdt.pmdt023,  l_pmdt.pmdt025, l_pmdt.pmdt026,
           l_pmdt.pmdt036, l_pmdt.pmdt037,  l_pmdt.pmdt044, l_pmdt.pmdt046,
           l_pmdt.pmdt063, l_pmdt.pmdt200,  l_pmdt.pmdt201, l_pmdt.pmdt203,
           l_pmdt.pmdt204, l_pmdt.pmdt205,  l_pmdt.pmdt208, l_pmdt.pmdt209,
           l_pmdt.pmdt210, l_pmdt.pmdt211,  l_pmdt.pmdt212, l_pmdt.pmdt213,
           l_pmdt.pmdt214, l_pmdt.pmdt215,  l_pmdt.pmdt218, l_pmdt.pmdtorga,
           l_pmdt.pmdt227   #補貨規格說明    150710-00016#7 Add By Ken 150713 
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
      END IF
      
      #單號
      LET l_pmdt.pmdtdocno = g_pmds_m.pmdsdocno
      
      #項次
      EXECUTE apmt860_max_seq INTO l_pmdt.pmdtseq
      
      #收貨數量
      IF cl_get_para(g_enterprise,'','E-CIR-0041') = 'Y' THEN
         LET l_success = ''
         LET l_pmdt020 = 0
         CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000, l_pmdt.pmdtsite, 
                                    g_pmds_m.pmdsdocno,    l_pmdt.pmdtseq,
                                    l_pmdt.pmdt001,        l_pmdt.pmdt002,
                                    l_pmdt.pmdt003,        l_pmdt.pmdt004,
                                    l_pmdt.pmdt006,        l_pmdt.pmdt206,
                                    l_pmdt.pmdt207,        0)
            RETURNING l_success,l_pmdt020
         IF l_pmdt020 <= 0 THEN
            CONTINUE FOREACH
         ELSE
            LET l_pmdt.pmdt020 = l_pmdt020
         END IF
      ELSE
         LET l_pmdt.pmdt020 = 0
      END IF
      
      #檢查單身的包裝單位必須要有值
      IF cl_null(l_pmdt.pmdt201) THEN
         #採購單單身的包裝單位為空！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00739'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CONTINUE FOREACH
      END IF
      
      #由收貨數量轉換成包裝數量
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt201,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt202

      #由收貨數量轉換成計價數量
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt024
      
      #150520-00016#16 150527 By pomelo add(S)
      #當為 採購收貨入庫單 預設倉庫
      IF g_argv[1] = '3' THEN
         #160304-00027#1 160307 By pomelo add(S)
         IF l_pmdt.pmdt214 = '3' THEN
            LET l_pmdt.pmdt016 = ''
            LET l_pmdt.pmdt017 = ''
         END IF
         #160304-00027#1 160307 By pomelo add(E)
         IF cl_null(l_pmdt.pmdt016) THEN
            LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)
         END IF
      END IF
      #150520-00016#16 150527 By pomelo add(E)
      
      #170217-00003#1 2017/02/18 By 08171 --s add
      #當為 採購收貨單 & 統採越庫時，預設倉庫
      IF g_argv[1] = '1' AND l_pmdt.pmdt214 = '3' THEN
         LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)      
      END IF
      #170217-00003#1 2017/02/18 By 08171 --e add
      
      LET l_pmdt.pmdt052 = '1'               #狀態碼
      LET l_pmdt.pmdt053 = l_pmdt.pmdt020    #允收數量
      LET l_pmdt.pmdt054 = 0                 #已入庫量
      LET l_pmdt.pmdt055 = 0                 #驗退量
      LET l_pmdt.pmdt062 = 'N'               #多庫儲批收貨入庫
      
      #須自立AP否
      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
         LET l_pmdt.pmdt084 = 'Y'
      ELSE
         LET l_pmdt.pmdt084 = 'N'
      END IF
      
      #160604-00009#96 Add By Ken 160623(S)   制造(有效)日期给默认值:如保質期(月、日)都沒設定的話 默认给系统日期
      SELECT COALESCE(imaa102,0),COALESCE(imaa103,0) 
        INTO l_imaa102,l_imaa103
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_pmdt.pmdt006
      IF (l_imaa102 = 0) AND (l_imaa103 = 0) THEN
         LET l_pmdt.pmdt219 = g_today 
         LET l_pmdt.pmdt089 = g_today 
      ELSE
         LET l_pmdt.pmdt219 = ''
         LET l_pmdt.pmdt089 = ''   
      END IF
      #160604-00009#96 Add By Ken 160623(E)       
      
      #150714-00016#1 150714 By pomelo add(S)
      LET l_imaa149 = s_apmt860_get_imaa149(l_pmdt.pmdt006)
      IF l_imaa149 MATCHES '[23]' AND NOT cl_null(l_imaa149) THEN
      #150714-00016#1 150714 By pomelo add(E)
         LET l_pmdt.pmdt219 = g_pmds_m.pmdsdocdt#製造日期
         #有效日期
         LET l_success = ''
         LET l_pmdt089 = ''
         IF g_argv[1] != '22' THEN    #add by yangxf
            CALL s_lot_out_effdate(l_pmdt.pmdtsite, l_pmdt.pmdt006, l_pmdt.pmdt007,
                                   l_pmdt.pmdt219,  l_pmdt.pmdt018)
               RETURNING l_success,l_pmdt089
            IF l_success THEN
               LET l_pmdt.pmdt089 = l_pmdt089
            END IF
            
            #160615-00028#3 Add By ken 160623(S)
            CALL s_apmt860_pmdt219_get(l_pmdt.pmdtsite, l_pmdt.pmdt006, l_pmdt.pmdt007,
                                       l_pmdt.pmdt089,  l_pmdt.pmdt018)
               RETURNING l_success,l_pmdt219
            IF l_success THEN
               LET l_pmdt.pmdt219 = l_pmdt219
            END IF
            #160615-00028#3 Add By ken 160623(E)  
            
         END IF    #add by yangxf
      END IF   #150714-00016#1 150714 By pomelo add
      
      #取得未稅金額、稅額、含稅金額
      CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq,
                                l_pmdt.pmdt001,g_pmds_m.pmdssite,
                                g_pmds_m.pmds037,l_pmdt.pmdt024,
                                l_pmdt.pmdt036,l_pmdt.pmdt046)
         RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
      #150601-00009#1 150601 By pomelo add(S)
      #當為(無)採購收貨單 (無)採購收貨入庫單 且 非多庫儲批
      IF g_argv[1] MATCHES '[1234]' AND l_pmdt.pmdt062 = 'N' THEN
         LET l_success = ''
         CALL s_lot_out_get_batch_no(l_pmdt.pmdt006)
            RETURNING l_success,l_pmdt.pmdt018
         IF l_success = FALSE THEN
            LET r_success = FALSE
            RETURN r_success
         END IF
      END IF
      #150601-00009#1 150601 By pomelo add(E)
      
      #151202-00010#2 s983961--add(s)
      #商品品類編號 
      SELECT imaa009 INTO l_pmdt220
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_pmdt.pmdt006  
      #來源商品品類編號
      SELECT pmdn228 INTO l_pmdt221
        FROM pmdn_t
       WHERE pmdnent = g_enterprise
         AND pmdndocno = l_pmdt.pmdt001
         AND pmdnseq = l_pmdt.pmdt002         
      #151202-00010#2 s983961--add(e)
      
      INSERT INTO pmdt_t(pmdtent, pmdtsite, pmdtdocno, pmdtseq,
                         pmdt001, pmdt002,  pmdt003,   pmdt004,
                         pmdt005, pmdt006,  pmdt007,   pmdt016,
                         pmdt017, pmdt018,  pmdt019,   pmdt020,
                         pmdt023, pmdt024,  pmdt025,   pmdt026,
                         pmdt027, pmdt028,  pmdt036,   pmdt037,
                         pmdt038, pmdt039,  pmdt044,   pmdt046,
                         pmdt047, pmdt051,  pmdt052,   pmdt053,
                         pmdt054, pmdt055,  pmdt062,   pmdt063,
                         pmdt084, pmdt088,  pmdt089,   pmdt200,
                         pmdt201, pmdt202,  pmdt203,   pmdt204,
                         pmdt205, pmdt208,  pmdt209,   pmdt210,
                         pmdt211, pmdt212,  pmdt213,   pmdt214,
                         pmdt215, pmdt218,  pmdt219,   pmdtorga,
                         pmdt227, pmdt220,  pmdt221)   #補貨規格說明    150710-00016#7 Add By Ken 150713      #151202-00010#2 s983961--add pmdt220,pmdt221
         VALUES(l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
                l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
                l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
                l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
                l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
                l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
                l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt044,   l_pmdt.pmdt046,
                l_pmdt.pmdt047, l_pmdt.pmdt051,  l_pmdt.pmdt052,   l_pmdt.pmdt053,
                l_pmdt.pmdt054, l_pmdt.pmdt055,  l_pmdt.pmdt062,   l_pmdt.pmdt063,
                l_pmdt.pmdt084, l_pmdt.pmdt088,  l_pmdt.pmdt089,   l_pmdt.pmdt200,
                l_pmdt.pmdt201, l_pmdt.pmdt202,  l_pmdt.pmdt203,   l_pmdt.pmdt204,
                l_pmdt.pmdt205, l_pmdt.pmdt208,  l_pmdt.pmdt209,   l_pmdt.pmdt210,
                l_pmdt.pmdt211, l_pmdt.pmdt212,  l_pmdt.pmdt213,   l_pmdt.pmdt214,
                l_pmdt.pmdt215, l_pmdt.pmdt218,  l_pmdt.pmdt219,   l_pmdt.pmdtorga,
                l_pmdt.pmdt227, l_pmdt220,       l_pmdt221)  #補貨規格說明    150710-00016#7 Add By Ken 150713  #151202-00010#2 s983961--add pmdt220,pmdt221
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      #產生多庫儲批資料
      CALL s_apmt860_ins_pmdu(g_pmds_m.pmds000, g_pmds_m.pmdsdocno, l_pmdt.pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                              l_pmdt.pmdtseq,   l_pmdt.pmdt006,     l_pmdt.pmdt007,
                              l_pmdt.pmdt016,   l_pmdt.pmdt017,     l_pmdt.pmdt018,
                              l_pmdt.pmdt019,   l_pmdt.pmdt020,     l_pmdt.pmdt027,
                              l_pmdt.pmdt028,   l_pmdt.pmdt053,     l_pmdt.pmdt054,
                              l_pmdt.pmdt055,   l_pmdt.pmdt062,     l_pmdt.pmdt063,
                              l_pmdt.pmdt088,   l_pmdt.pmdt089,     l_pmdt.pmdt201,
                              l_pmdt.pmdt202,   l_pmdt.pmdt219) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #產生原始需求分配明細
      CALL s_apmt860_gen_pmdv(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      INITIALIZE l_pmdt.* TO NULL
   END FOREACH
   
   #重新計算整單的未稅、含稅總金額
   LET l_success = ''
   CALL s_apmt860_upd_pmds(g_pmds_m.pmdsdocno)
      RETURNING l_success,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   CALL cl_err_collect_show()
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 根據單頭收貨單號，自動產生單身
# Memo...........: 程式：採購驗退單、採購入庫單、採購倉退單
# Usage..........: CALL apmt860_gen_detail1()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success      True/False
# Date & Author..: 2014/12/29 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_gen_detail1()
DEFINE r_success        LIKE type_t.num5
DEFINE l_sql            STRING
DEFINE l_success        LIKE type_t.num5
DEFINE l_pmdt020        LIKE pmdt_t.pmdt020
DEFINE l_xrcd103        LIKE xrcd_t.xrcd103
DEFINE l_xrcd104        LIKE xrcd_t.xrcd104
DEFINE l_xrcd105        LIKE xrcd_t.xrcd105
DEFINE l_xrcd113        LIKE xrcd_t.xrcd113
DEFINE l_xrcd114        LIKE xrcd_t.xrcd114
DEFINE l_xrcd115        LIKE xrcd_t.xrcd115
DEFINE l_pmdtseq        LIKE pmdt_t.pmdtseq     #項次
DEFINE l_pmdt089        LIKE pmdt_t.pmdt219     #有效日期
DEFINE l_pmdt           RECORD
       pmdtent          LIKE pmdt_t.pmdtent,    #企業編號
       pmdtsite         LIKE pmdt_t.pmdtsite,   #營運據點
       pmdtdocno        LIKE pmdt_t.pmdtdocno,  #單據編號
       pmdtseq          LIKE pmdt_t.pmdtseq,    #項次
       pmdt001          LIKE pmdt_t.pmdt001,    #採購單號
       pmdt002          LIKE pmdt_t.pmdt002,    #採購項次
       pmdt003          LIKE pmdt_t.pmdt003,    #採購項序
       pmdt004          LIKE pmdt_t.pmdt004,    #採購分批序
       pmdt005          LIKE pmdt_t.pmdt005,    #子件特性
       pmdt006          LIKE pmdt_t.pmdt006,    #料件編號
       pmdt007          LIKE pmdt_t.pmdt007,    #產品特徵
       pmdt016          LIKE pmdt_t.pmdt016,    #庫位
       pmdt017          LIKE pmdt_t.pmdt017,    #儲位
       pmdt018          LIKE pmdt_t.pmdt018,    #批號
       pmdt019          LIKE pmdt_t.pmdt019,    #收貨/入庫單位
       pmdt020          LIKE pmdt_t.pmdt020,    #收貨/入庫數量
       pmdt023          LIKE pmdt_t.pmdt023,    #計價單位
       pmdt024          LIKE pmdt_t.pmdt024,    #計價數量
       pmdt025          LIKE pmdt_t.pmdt025,    #緊急度
       pmdt026          LIKE pmdt_t.pmdt026,    #檢驗否
       pmdt027          LIKE pmdt_t.pmdt027,    #收貨單號
       pmdt028          LIKE pmdt_t.pmdt028,    #收貨項次
       pmdt036          LIKE pmdt_t.pmdt036,    #單價
       pmdt037          LIKE pmdt_t.pmdt037,    #稅率
       pmdt038          LIKE pmdt_t.pmdt038,    #未稅金額
       pmdt039          LIKE pmdt_t.pmdt039,    #含稅金額
       pmdt044          LIKE pmdt_t.pmdt044,    #取出單價
       pmdt046          LIKE pmdt_t.pmdt046,    #稅別
       pmdt047          LIKE pmdt_t.pmdt047,    #稅額
       pmdt051          LIKE pmdt_t.pmdt051,    #理由碼
       pmdt052          LIKE pmdt_t.pmdt052,    #狀態碼
       pmdt053          LIKE pmdt_t.pmdt053,    #允收數量
       pmdt054          LIKE pmdt_t.pmdt054,    #已入庫量
       pmdt055          LIKE pmdt_t.pmdt055,    #驗退量
       pmdt062          LIKE pmdt_t.pmdt062,    #多庫儲批收貨入庫
       pmdt063          LIKE pmdt_t.pmdt063,    #庫存管理特徵
       pmdt084          LIKE pmdt_t.pmdt084,    #須自立AP否
       pmdt088          LIKE pmdt_t.pmdt088,    #存貨備註
       pmdt089          LIKE pmdt_t.pmdt089,    #有效日期
       pmdt200          LIKE pmdt_t.pmdt200,    #商品條碼
       pmdt201          LIKE pmdt_t.pmdt201,    #收貨包裝單位
       pmdt202          LIKE pmdt_t.pmdt202,    #收貨包裝數量
       pmdt203          LIKE pmdt_t.pmdt203,    #採購組織
       pmdt204          LIKE pmdt_t.pmdt204,    #採購中心
       pmdt205          LIKE pmdt_t.pmdt205,    #要貨組織
       pmdt206          LIKE pmdt_t.pmdt206,    #預約收貨單號
       pmdt207          LIKE pmdt_t.pmdt207,    #預約收貨項次
       pmdt208          LIKE pmdt_t.pmdt208,    #採購渠道
       pmdt209          LIKE pmdt_t.pmdt209,    #渠道性質
       pmdt210          LIKE pmdt_t.pmdt210,    #經營方式
       pmdt211          LIKE pmdt_t.pmdt211,    #結算方式
       pmdt212          LIKE pmdt_t.pmdt212,    #合約編號
       pmdt213          LIKE pmdt_t.pmdt213,    #協議編號
       pmdt214          LIKE pmdt_t.pmdt214,    #採購方式
       pmdt215          LIKE pmdt_t.pmdt215,    #最終收貨組織
       pmdt218          LIKE pmdt_t.pmdt218,    #採購價
       pmdt219          LIKE pmdt_t.pmdt219,    #製造日期
       pmdtorga         LIKE pmdt_t.pmdtorga,   #帳務組織
       pmdt227          LIKE pmdt_t.pmdt227     #補貨規格說明    150710-00016#7 Add By Ken 150713
                        END RECORD
DEFINE l_pmdt220        LIKE pmdt_t.pmdt220     #商品品類     151202-00010#2 s983961--add
#170207-00002#1 170207 by sakura add(S)
DEFINE l_para_apmt890   LIKE gzcb_t.gzcb002     #退廠單批號自動沖減與收貨單掛勾
DEFINE l_rtdx028        LIKE rtdx_t.rtdx028     #採購中心
DEFINE l_ooag001        LIKE ooag_t.ooag001     #採購人員
DEFINE l_ooef001        LIKE ooef_t.ooef001     #採購部門
#170207-00002#1 170207 by sakura add(E)

   LET r_success = TRUE
   CALL cl_err_collect_init()
   
   CALL apmt860_gen_detail_pre()
   LET l_sql = "SELECT pmdtent, pmdtsite, pmdtseq, pmdt001,",
               "       pmdt002, pmdt003,  pmdt004, pmdt005,",
               "       pmdt006, pmdt007,  pmdt016, pmdt017,",
               "       pmdt018, pmdt019,  pmdt023, pmdt025,",
               "       pmdt026, pmdt036,  pmdt037, pmdt044,",
               "       pmdt046, pmdt062,  pmdt063, pmdt089,",
               "       pmdt200, pmdt201,  pmdt203, pmdt204,",
               "       pmdt205, pmdt208,  pmdt209, pmdt210,",
               "       pmdt211, pmdt212,  pmdt213, pmdt214,",
               "       pmdt215, pmdt219,  pmdtorga,pmdt227 ", #補貨規格說明 150710-00016#7 Add By Ken 150713
               "  FROM pmds_t, pmdt_t",
               " WHERE pmdsent = pmdtent",
               "   AND pmdsdocno = pmdtdocno",
               "   AND pmdsent = ",g_enterprise,
               "   AND pmdsdocno = '",g_pmds_m.pmds006,"'",
               "   AND pmdt052 = '1'",
               " ORDER BY pmdtseq"
   
   PREPARE apmt860_gen_detail_pre1 FROM l_sql
   DECLARE apmt860_gen_detail_cs1 CURSOR FOR apmt860_gen_detail_pre1
   
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_detail_cs1
      INTO l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdtseq,      l_pmdt.pmdt001,
           l_pmdt.pmdt002, l_pmdt.pmdt003,  l_pmdt.pmdt004, l_pmdt.pmdt005,
           l_pmdt.pmdt006, l_pmdt.pmdt007,  l_pmdt.pmdt016, l_pmdt.pmdt017,
           l_pmdt.pmdt018, l_pmdt.pmdt019,  l_pmdt.pmdt023, l_pmdt.pmdt025,
           l_pmdt.pmdt026, l_pmdt.pmdt036,  l_pmdt.pmdt037, l_pmdt.pmdt044,
           l_pmdt.pmdt046, l_pmdt.pmdt062,  l_pmdt.pmdt063, l_pmdt.pmdt089,
           l_pmdt.pmdt200, l_pmdt.pmdt201,  l_pmdt.pmdt203, l_pmdt.pmdt204,
           l_pmdt.pmdt205, l_pmdt.pmdt208,  l_pmdt.pmdt209, l_pmdt.pmdt210,
           l_pmdt.pmdt211, l_pmdt.pmdt212,  l_pmdt.pmdt213, l_pmdt.pmdt214,
           l_pmdt.pmdt215, l_pmdt.pmdt219,  l_pmdt.pmdtorga,l_pmdt.pmdt227  #補貨規格說明  150710-00016#7 Add By Ken 150713
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
      END IF
      
      #單號
      LET l_pmdt.pmdtdocno = g_pmds_m.pmdsdocno
      
      #項次
      EXECUTE apmt860_max_seq INTO l_pmdt.pmdtseq
      
      #收貨數量
      LET l_success = ''
      LET l_pmdt020 = 0
      CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000, l_pmdt.pmdtsite,
                                 g_pmds_m.pmdsdocno,    l_pmdt.pmdtseq,
                                 g_pmds_m.pmds006,      l_pmdtseq,
                                 l_pmdt.pmdt003,        l_pmdt.pmdt004,
                                 l_pmdt.pmdt006,        l_pmdt.pmdt206,
                                 l_pmdt.pmdt207,        0)
         RETURNING l_success,l_pmdt020
      IF l_pmdt020 <= 0 THEN
         CONTINUE FOREACH
      ELSE
         LET l_pmdt.pmdt020 = l_pmdt020
      END IF
      
      #檢查單身的包裝單位必須要有值
      IF cl_null(l_pmdt.pmdt201) THEN
         #採購單單身的包裝單位為空！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00741'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CONTINUE FOREACH
      END IF
      
      #170207-00002#1 170207 by sakura add(S)
      IF g_argv[1] MATCHES '[7]' THEN
         #為退廠單輸入單頭收貨單號，需重新取"合同"、"協議"(因能快速帶出單身資料,但有可能對應的"合同"、"協議"已改變了)
         LET l_sql = "SELECT star008",   #採購中心
                     "  FROM star_t,stas_t",
                     " WHERE starent = stasent",
                     "   AND starsite = stassite",
                     "   AND star001 = stas001",
                     "   AND starent = ",g_enterprise,
                     "   AND star003 = '",g_pmds_m.pmds007,"'",   #採購供應商
                     "   AND starstus = 'Y'",
                     "   AND starsite = '",g_site,"'",
                     "   AND stas003 = '",l_pmdt.pmdt006,"'",   #商品
                     " ORDER BY star002 DESC"
         PREPARE apmt860_get_star008_pre2 FROM l_sql
         DECLARE apmt860_get_star008_cs2 SCROLL CURSOR FOR apmt860_get_star008_pre2
         OPEN apmt860_get_star008_cs2
         FETCH FIRST apmt860_get_star008_cs2 INTO l_rtdx028
         CALL s_apmt840_get_pact(l_rtdx028,g_pmds_m.pmds037,g_pmds_m.pmds007,g_pmds_m.pmdsdocdt,l_pmdt.pmdt006,g_site)
            RETURNING l_pmdt.pmdtorga, l_pmdt.pmdt019, l_pmdt.pmdt023,
                      l_pmdt.pmdt044,  l_pmdt.pmdt046, l_pmdt.pmdt037,
                      l_pmdt.pmdt210,  l_pmdt.pmdt211, l_pmdt.pmdt212,
                      l_pmdt.pmdt213,  l_ooag001,      l_ooef001
         #檢查合約、協議
         IF cl_null(l_pmdt.pmdt212) OR cl_null(l_pmdt.pmdt213) THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'apm-01154'
            LET g_errparam.extend = ''
            LET g_errparam.popup = TRUE
            LET g_errparam.replace[1] = g_pmds_m.pmds006
            LET g_errparam.replace[2] = l_pmdtseq
            CALL cl_err()
            CONTINUE FOREACH
         END IF
         #為批號沖減流程,批號清空
         IF NOT apmt860_chk_lot('a') THEN
            LET l_pmdt.pmdt018 = ''
            
            #退廠單批號自動沖減與收貨單掛勾參數
            CALL cl_get_para(g_enterprise,'','E-CIR-0048') RETURNING l_para_apmt890
            IF cl_null(l_para_apmt890) THEN
               LET l_para_apmt890 = 'N'
            END IF
            #與收貨單掛勾則清空合同、協議
            IF l_para_apmt890 = 'Y' THEN
               LET l_pmdt.pmdt212 = ''
               LET l_pmdt.pmdt213 = ''
            END IF
         END IF         
      END IF      
      #170207-00002#1 170207 by sakura add(E)      
      
      #由收貨數量轉換成包裝數量
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt201,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt202

      #由收貨數量轉換成計價數量
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt024
      
      LET l_pmdt.pmdt027 = g_pmds_m.pmds006  #出貨單號
      LET l_pmdt.pmdt028 = l_pmdtseq         #出貨項次
      LET l_pmdt.pmdt052 = '1'               #狀態碼
      LET l_pmdt.pmdt053 = l_pmdt.pmdt020    #允收數量
      LET l_pmdt.pmdt054 = 0                 #已入庫量
      LET l_pmdt.pmdt055 = 0                 #驗退量
      
      #150611-00034#1 150701 By pomelo add(S)
      #多庫儲批
      IF g_pmds_m.pmds000 = '7' THEN
         LET l_pmdt.pmdt062  = 'N'
      END IF
      #150611-00034#1 150701 By pomelo add(E)
      
      #150520-00016#16 150527 By pomelo add(S)
      #當為 採購入庫單 預設倉庫
      IF g_argv[1] = '[67]' THEN
         IF cl_null(l_pmdt.pmdt016) THEN
            LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)
         END IF       
      END IF
      #150520-00016#16 150527 By pomelo add(E)   
      
      #170217-00003#1 2017/02/18 By 08171 --s add
      #當為 採購入庫單 且採購收貨單上庫位為空
      IF g_argv[1] = '6' AND cl_null(l_pmdt.pmdt016) THEN
         LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)
      END IF
      #170217-00003#1 2017/02/18 By 08171 --e add
      
      #須自立AP否
      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
         LET l_pmdt.pmdt084 = 'Y'
      ELSE
         LET l_pmdt.pmdt084 = 'N'
      END IF
      
      #取得未稅金額、稅額、含稅金額
      CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq,
                                l_pmdt.pmdt001,g_pmds_m.pmdssite,
                                g_pmds_m.pmds037,l_pmdt.pmdt024,
                                l_pmdt.pmdt036,l_pmdt.pmdt046)
         RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
      
      #151202-00010#2 s983961--add(s)
      #商品品類編號 
      SELECT imaa009 INTO l_pmdt220
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_pmdt.pmdt006  
      #151202-00010#2 s983961--add(e)
      
      #170207-00002#1 170207 by sakura mark(S)
      ##160604-00009#97 160624 by sakura add(S)
      #IF g_argv[1] MATCHES '[7]' THEN
      #   #為退廠自動帶出單身時，不帶出批號、合約
      #   LET l_pmdt.pmdt018 = ''
      #   LET l_pmdt.pmdt212 = ''
      #END IF
      ##160604-00009#97 160624 by sakura add(E)
      #170207-00002#1 170207 by sakura mark(E)
      
      INSERT INTO pmdt_t(pmdtent, pmdtsite, pmdtdocno, pmdtseq,
                         pmdt001, pmdt002,  pmdt003,   pmdt004,
                         pmdt005, pmdt006,  pmdt007,   pmdt016,
                         pmdt017, pmdt018,  pmdt019,   pmdt020,
                         pmdt023, pmdt024,  pmdt025,   pmdt026,
                         pmdt027, pmdt028,  pmdt036,   pmdt037,
                         pmdt038, pmdt039,  pmdt046,   pmdt047,
                         pmdt051, pmdt052,  pmdt053,   pmdt054,
                         pmdt055, pmdt062,  pmdt063,   pmdt084,
                         pmdt088, pmdt089,  pmdt200,   pmdt201,
                         pmdt202, pmdt203,  pmdt204,   pmdt205,
                         pmdt208, pmdt209,  pmdt210,   pmdt211,
                         pmdt212, pmdt213,  pmdt214,   pmdt215,
                         pmdt219, pmdtorga, pmdt227,   pmdt220)  #補貨規格說明  150710-00016#7 Add By Ken 150713   #151202-00010#2 s983961--add  pmdt220
         VALUES(l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
                l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
                l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
                l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
                l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
                l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
                l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt046,   l_pmdt.pmdt047,
                l_pmdt.pmdt051, l_pmdt.pmdt052,  l_pmdt.pmdt053,   l_pmdt.pmdt054,
                l_pmdt.pmdt055, l_pmdt.pmdt062,  l_pmdt.pmdt063,   l_pmdt.pmdt084,
                l_pmdt.pmdt088, l_pmdt.pmdt089,  l_pmdt.pmdt200,   l_pmdt.pmdt201,
                l_pmdt.pmdt202, l_pmdt.pmdt203,  l_pmdt.pmdt204,   l_pmdt.pmdt205,
                l_pmdt.pmdt208, l_pmdt.pmdt209,  l_pmdt.pmdt210,   l_pmdt.pmdt211,
                l_pmdt.pmdt212, l_pmdt.pmdt213,  l_pmdt.pmdt214,   l_pmdt.pmdt215,
                l_pmdt.pmdt219, l_pmdt.pmdtorga, l_pmdt.pmdt227,   l_pmdt220)  #補貨規格說明  150710-00016#7 Add By Ken 150713  #151202-00010#2 s983961--add  l_pmdt220
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      #產生多庫儲批資料
      CALL s_apmt860_ins_pmdu(g_pmds_m.pmds000, g_pmds_m.pmdsdocno, l_pmdt.pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                              l_pmdt.pmdtseq,   l_pmdt.pmdt006,     l_pmdt.pmdt007,
                              l_pmdt.pmdt016,   l_pmdt.pmdt017,     l_pmdt.pmdt018,
                              l_pmdt.pmdt019,   l_pmdt.pmdt020,     l_pmdt.pmdt027,
                              l_pmdt.pmdt028,   l_pmdt.pmdt053,     l_pmdt.pmdt054,
                              l_pmdt.pmdt055,   l_pmdt.pmdt062,     l_pmdt.pmdt063,
                              l_pmdt.pmdt088,   l_pmdt.pmdt089,     l_pmdt.pmdt201,
                              l_pmdt.pmdt202,   l_pmdt.pmdt219) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #產生原始需求分配明細
      CALL s_apmt860_gen_pmdv(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      INITIALIZE l_pmdt.* TO NULL
   END FOREACH
   
   #重新計算整單的未稅、含稅總金額
   LET l_success = ''
   CALL s_apmt860_upd_pmds(g_pmds_m.pmdsdocno)
      RETURNING l_success,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   CALL cl_err_collect_show()
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 根據單頭收貨預約單號，自動產生單身
# Memo...........: 程式：採購收貨單、採購收貨入庫單
# Usage..........: CALL apmt860_gen_detail2(p_type)
#                  RETURNING r_success
# Input parameter: p_type         1.自動產生單身
#                :                2.刪除單身 重新產生單身
# Return code....: r_success      True/False
# Date & Author..: 2014/12/29 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_gen_detail2(p_type)
DEFINE p_type           LIKE type_t.chr1
DEFINE r_success        LIKE type_t.num5
DEFINE l_sql            STRING
DEFINE l_success        LIKE type_t.num5
DEFINE l_pmdt020        LIKE pmdt_t.pmdt020
DEFINE l_pmdt089        LIKE pmdt_t.pmdt089
DEFINE l_imaa149        LIKE imaa_t.imaa149     #臨期控管方式  150714-00016#1 150714 By pomelo add
DEFINE l_pmdt           RECORD
       pmdtent          LIKE pmdt_t.pmdtent,    #企業編號
       pmdtsite         LIKE pmdt_t.pmdtsite,   #營運據點
       pmdtdocno        LIKE pmdt_t.pmdtdocno,  #單據編號
       pmdtseq          LIKE pmdt_t.pmdtseq,    #項次
       pmdt001          LIKE pmdt_t.pmdt001,    #採購單號
       pmdt002          LIKE pmdt_t.pmdt002,    #採購項次
       pmdt003          LIKE pmdt_t.pmdt003,    #採購項序
       pmdt004          LIKE pmdt_t.pmdt004,    #採購分批序
       pmdt005          LIKE pmdt_t.pmdt005,    #子件特性
       pmdt006          LIKE pmdt_t.pmdt006,    #料件編號
       pmdt007          LIKE pmdt_t.pmdt007,    #產品特徵
       pmdt016          LIKE pmdt_t.pmdt016,    #庫位
       pmdt017          LIKE pmdt_t.pmdt017,    #儲位
       pmdt018          LIKE pmdt_t.pmdt018,    #批號
       pmdt019          LIKE pmdt_t.pmdt019,    #收貨/入庫單位
       pmdt020          LIKE pmdt_t.pmdt020,    #收貨/入庫數量
       pmdt023          LIKE pmdt_t.pmdt023,    #計價單位
       pmdt024          LIKE pmdt_t.pmdt024,    #計價數量
       pmdt025          LIKE pmdt_t.pmdt025,    #緊急度
       pmdt026          LIKE pmdt_t.pmdt026,    #檢驗否
       pmdt027          LIKE pmdt_t.pmdt027,    #收貨單號
       pmdt028          LIKE pmdt_t.pmdt028,    #收貨項次
       pmdt036          LIKE pmdt_t.pmdt036,    #單價
       pmdt037          LIKE pmdt_t.pmdt037,    #稅率
       pmdt038          LIKE pmdt_t.pmdt038,    #未稅金額
       pmdt039          LIKE pmdt_t.pmdt039,    #含稅金額
       pmdt044          LIKE pmdt_t.pmdt044,    #取出單價
       pmdt046          LIKE pmdt_t.pmdt046,    #稅別
       pmdt047          LIKE pmdt_t.pmdt047,    #稅額
       pmdt051          LIKE pmdt_t.pmdt051,    #理由碼
       pmdt052          LIKE pmdt_t.pmdt052,    #狀態碼
       pmdt053          LIKE pmdt_t.pmdt053,    #允收數量
       pmdt054          LIKE pmdt_t.pmdt054,    #已入庫量
       pmdt055          LIKE pmdt_t.pmdt055,    #驗退量
       pmdt062          LIKE pmdt_t.pmdt062,    #多庫儲批收貨入庫
       pmdt063          LIKE pmdt_t.pmdt063,    #庫存管理特徵
       pmdt084          LIKE pmdt_t.pmdt084,    #須自立AP否
       pmdt088          LIKE pmdt_t.pmdt088,    #存貨備註
       pmdt089          LIKE pmdt_t.pmdt089,    #製造日期
       pmdt200          LIKE pmdt_t.pmdt200,    #商品條碼
       pmdt201          LIKE pmdt_t.pmdt201,    #收貨包裝單位
       pmdt202          LIKE pmdt_t.pmdt202,    #收貨包裝數量
       pmdt203          LIKE pmdt_t.pmdt203,    #採購組織
       pmdt204          LIKE pmdt_t.pmdt204,    #採購中心
       pmdt205          LIKE pmdt_t.pmdt205,    #要貨組織
       pmdt206          LIKE pmdt_t.pmdt206,    #預約收貨單號
       pmdt207          LIKE pmdt_t.pmdt207,    #預約收貨項次
       pmdt208          LIKE pmdt_t.pmdt208,    #採購渠道
       pmdt209          LIKE pmdt_t.pmdt209,    #渠道性質
       pmdt210          LIKE pmdt_t.pmdt210,    #經營方式
       pmdt211          LIKE pmdt_t.pmdt211,    #結算方式
       pmdt212          LIKE pmdt_t.pmdt212,    #合約編號
       pmdt213          LIKE pmdt_t.pmdt213,    #協議編號
       pmdt214          LIKE pmdt_t.pmdt214,    #採購方式
       pmdt215          LIKE pmdt_t.pmdt215,    #最終收貨組織
       pmdt218          LIKE pmdt_t.pmdt218,    #採購價
       pmdt219          LIKE pmdt_t.pmdt219,    #製造日期
       pmdtorga         LIKE pmdt_t.pmdtorga,   #帳務組織
       pmdt227          LIKE pmdt_t.pmdt227     #補貨規格說明 150710-00016#7 Add By Ken 150713
                        END RECORD
DEFINE l_pmdt220        LIKE pmdt_t.pmdt220     #商品品類     151202-00010#2 s983961--add
DEFINE l_pmdt221        LIKE pmdt_t.pmdt221     #來源商品品類  151202-00010#2 s983961--add
DEFINE l_imaa102        LIKE imaa_t.imaa102   #保質期(月)    #160604-00009#96 Add By Ken 160623
DEFINE l_imaa103        LIKE imaa_t.imaa103   #保質期(日)    #160604-00009#96 Add By Ken 160623
DEFINE l_pmdt219        LIKE pmdt_t.pmdt219   #製造日期      #160604-00009#96 Add By Ken 160623

   LET r_success = TRUE
   CALL cl_err_collect_init()
   
   #當異動類型 = '2'，需要刪除單身後 重新產生
   IF p_type = '2' THEN
      #收貨/入庫單身明細檔
      DELETE FROM pmdt_t
       WHERE pmdtent = g_enterprise
         AND pmdtdocno = g_pmds_m.pmdsdocno
      
      #收貨/驗退/入庫/倉退單多庫儲批收貨明細檔
      DELETE FROM pmdu_t
       WHERE pmduent = g_enterprise
         AND pmdudocno = g_pmds_m.pmdsdocno
         
      #收貨/入庫需求分配明細檔
      DELETE FROM pmdv_t
       WHERE pmdvent = g_enterprise
         AND pmdvdocno = g_pmds_m.pmdsdocno
      
      #交易稅明細檔
      DELETE FROM xrcd_t
       WHERE xrcdent = g_enterprise
         AND xrcddocno = g_pmds_m.pmdsdocno
   END IF
   
   CALL apmt860_gen_detail_pre()
   LET l_sql = "SELECT pmdnent, pmdnunit,  pmdndocno, pmdnseq,",
               "       pmem003, pmem004,   pmdn019,   pmdn001,",
               "       pmdn002, pmdn028,   pmdn029,   pmdn030,",
               "       pmem011, pmdn010,   pmdn020,   pmdn052,",
               "       pmdn015, pmdn017,   pmdn043,   pmdn016,",
               "       pmdn053, pmdn200,   pmdn201,   pmdnsite,",
               "       pmdn222, pmdn205,   pmemdocno, pmemseq,",
               "       pmdn214, pmdn215,   pmdn216,   pmdn217,",
               "       pmdn218, pmdn219,   pmdl203,   pmdn225,",
               "       pmdn015, pmdnorga,  pmdn227",  #補貨規格說明 150710-00016#7 Add By Ken 150713
               "  FROM pmdl_t,pmab_t,pmdn_t, pmem_t",
               "  LEFT OUTER JOIN (SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT(pmdt001) cnt",
               "                     FROM pmds_t, pmdt_t",
               "                    WHERE pmdsent = pmdtent",
               "                      AND pmdsdocno = pmdtdocno",
               "                      AND pmdsstus != 'X'",
               "                      AND (pmds000 = '1' OR pmds000 = '3')",
               "                    GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)",
               "    ON pmement = pmdtent",
               "   AND pmem001 = pmdt001",
               "   AND pmem002 = pmdt002",
               "   AND pmem003 = pmdt003",
               "   AND pmem004 = pmdt004",
               " WHERE pmdlent = pmdnent",
               "   AND pmdldocno = pmdndocno",
               "   AND pmement = pmdnent",
               "   AND pmem001  = pmdndocno",
               "   AND pmem002 = pmdnseq",
               "   AND pmement = ",g_enterprise,
               "   AND pmemdocno = '",g_pmds_m.pmds200,"'",
               "   AND pmdl021 = '",g_pmds_m.pmds008,"'",
               "   AND pmabent = pmdlent",
               "   AND pmabsite = 'ALL'",
               "   AND pmab001 = pmdl004",
               "   AND (COALESCE (pmdl206, 'N') = 'Y'",
               "    OR  ((pmdn022 = 'Y'",
               "   AND   (COALESCE (pmab050, 0) >= 1",
               "   AND    COALESCE (pmdl206, 'N') = 'N'",
               "   AND    COALESCE (pmab050, 0) > COALESCE (cnt, 0)",
               "    OR    COALESCE (pmab050, 0) = 0))",
               "    OR   (pmdn022 = 'N' AND COALESCE(cnt,0) = 0)))",
               " ORDER BY pmemseq"
   
   PREPARE apmt860_gen_detail_pre2 FROM l_sql
   DECLARE apmt860_gen_detail_cs2 CURSOR FOR apmt860_gen_detail_pre2
   
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_detail_cs2
      INTO l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdt001, l_pmdt.pmdt002,
           l_pmdt.pmdt003, l_pmdt.pmdt004,  l_pmdt.pmdt005, l_pmdt.pmdt006,
           l_pmdt.pmdt007, l_pmdt.pmdt016,  l_pmdt.pmdt017, l_pmdt.pmdt018,
           l_pmdt.pmdt019, l_pmdt.pmdt023,  l_pmdt.pmdt025, l_pmdt.pmdt026,
           l_pmdt.pmdt036, l_pmdt.pmdt037,  l_pmdt.pmdt044, l_pmdt.pmdt046,
           l_pmdt.pmdt063, l_pmdt.pmdt200,  l_pmdt.pmdt201, l_pmdt.pmdt203,
           l_pmdt.pmdt204, l_pmdt.pmdt205,  l_pmdt.pmdt206, l_pmdt.pmdt207,
           l_pmdt.pmdt208, l_pmdt.pmdt209,  l_pmdt.pmdt210, l_pmdt.pmdt211,
           l_pmdt.pmdt212, l_pmdt.pmdt213,  l_pmdt.pmdt214, l_pmdt.pmdt215,
           l_pmdt.pmdt218, l_pmdt.pmdtorga, l_pmdt.pmdt227  #補貨規格說明 150710-00016#7 Add By Ken 150713
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
      END IF
      
      #單號
      LET l_pmdt.pmdtdocno = g_pmds_m.pmdsdocno
      
      #項次
      EXECUTE apmt860_max_seq INTO l_pmdt.pmdtseq
      
      #收貨數量
      IF cl_get_para(g_enterprise,'','E-CIR-0041') = 'Y' THEN
         LET l_success = ''
         LET l_pmdt020 = 0
         CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000, l_pmdt.pmdtsite,
                                    g_pmds_m.pmdsdocno,    l_pmdt.pmdtseq,
                                    l_pmdt.pmdt001,        l_pmdt.pmdt002,
                                    l_pmdt.pmdt003,        l_pmdt.pmdt004,
                                    l_pmdt.pmdt006,        l_pmdt.pmdt206,
                                    l_pmdt.pmdt207,        0)
            RETURNING l_success,l_pmdt020
         IF l_pmdt020 <= 0 THEN
            CONTINUE FOREACH
         ELSE
            LET l_pmdt.pmdt020 = l_pmdt020
         END IF
      ELSE
         LET l_pmdt.pmdt020 = 0
      END IF
      
      #檢查單身的包裝單位必須要有值
      IF cl_null(l_pmdt.pmdt201) THEN
         #採購單單身的包裝單位為空！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00739'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CONTINUE FOREACH
      END IF
      
      #由收貨數量轉換成包裝數量
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt201,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt202

      #由收貨數量轉換成計價數量
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt024
      
      #150520-00016#16 150527 By pomelo add(S)
      #當為 採購收貨入庫單 預設倉庫
      IF g_argv[1] = '3' THEN
         #160304-00027#1 160307 By pomelo add(S)
         IF l_pmdt.pmdt214 = '3' THEN
            LET l_pmdt.pmdt016 = ''
            LET l_pmdt.pmdt017 = ''
         END IF
         #160304-00027#1 160307 By pomelo add(E)
         IF cl_null(l_pmdt.pmdt016) THEN
            LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)
         END IF
      END IF
      #150520-00016#16 150527 By pomelo add(E)
      
      LET l_pmdt.pmdt052 = '1'               #狀態碼
      LET l_pmdt.pmdt053 = l_pmdt.pmdt020    #允收數量
      LET l_pmdt.pmdt054 = 0                 #已入庫量
      LET l_pmdt.pmdt055 = 0                 #驗退量
      LET l_pmdt.pmdt062 = 'N'               #多庫儲批收貨入庫
      
      #須自立AP否
      IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
         LET l_pmdt.pmdt084 = 'Y'
      ELSE
         LET l_pmdt.pmdt084 = 'N'
      END IF
      
      #160604-00009#96 Add By Ken 160623(S)   制造(有效)日期给默认值:如保質期(月、日)都沒設定的話 默认给系统日期
      SELECT COALESCE(imaa102,0),COALESCE(imaa103,0) 
        INTO l_imaa102,l_imaa103
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_pmdt.pmdt006
      IF (l_imaa102 = 0) AND (l_imaa103 = 0) THEN
         LET l_pmdt.pmdt219 = g_today 
         LET l_pmdt.pmdt089 = g_today 
      ELSE
         LET l_pmdt.pmdt219 = ''
         LET l_pmdt.pmdt089 = ''   
      END IF
      #160604-00009#96 Add By Ken 160623(E)       
      
      #150714-00016#1 150714 By pomelo add(S)
      LET l_imaa149 = s_apmt860_get_imaa149(l_pmdt.pmdt006)
      IF l_imaa149 MATCHES '[23]' AND NOT cl_null(l_imaa149) THEN
      #150714-00016#1 150714 By pomelo add(E)
         LET l_pmdt.pmdt219 = g_pmds_m.pmdsdocdt#製造日期
         #有效日期
         LET l_success = ''
         LET l_pmdt089 = ''
         CALL s_lot_out_effdate(l_pmdt.pmdtsite, l_pmdt.pmdt006, l_pmdt.pmdt007,
                                l_pmdt.pmdt219,  l_pmdt.pmdt018)
            RETURNING l_success,l_pmdt089
         IF l_success THEN
            LET l_pmdt.pmdt089 = l_pmdt089
         END IF
         
         #160615-00028#3 Add By ken 160623(S)
         CALL s_apmt860_pmdt219_get(l_pmdt.pmdtsite, l_pmdt.pmdt006, l_pmdt.pmdt007,
                                    l_pmdt.pmdt089,  l_pmdt.pmdt018)
            RETURNING l_success,l_pmdt219
         IF l_success THEN
            LET l_pmdt.pmdt219 = l_pmdt219
         END IF
         #160615-00028#3 Add By ken 160623(E) 
         
      END IF     #150714-00016#1 150714 By pomelo add
      
      #取得未稅金額、稅額、含稅金額
      CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq,
                                l_pmdt.pmdt001,g_pmds_m.pmdssite,
                                g_pmds_m.pmds037,l_pmdt.pmdt024,
                                l_pmdt.pmdt036,l_pmdt.pmdt046)
         RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
      
      #150601-00009#1 150601 By pomelo add(S)
      #當為(無)採購收貨單 (無)採購收貨入庫單 且 非多庫儲批
      IF g_argv[1] MATCHES '[1234]' AND l_pmdt.pmdt062 = 'N' THEN
         LET l_success = ''
         CALL s_lot_out_get_batch_no(l_pmdt.pmdt006)
            RETURNING l_success,l_pmdt.pmdt018
         IF l_success = FALSE THEN
            LET r_success = FALSE
            RETURN r_success
         END IF
      END IF
      #150601-00009#1 150601 By pomelo add(E)
      
      #151202-00010#2 s983961--add(s)
      #來源商品品類編號/商品品類編號 
      SELECT imaa009 INTO l_pmdt220
        FROM imaa_t
       WHERE imaaent = g_enterprise
         AND imaa001 = l_pmdt.pmdt006 
      #來源商品品類編號
      SELECT pmdn228 INTO l_pmdt221
        FROM pmdn_t
       WHERE pmdnent = g_enterprise
         AND pmdndocno = l_pmdt.pmdt001
         AND pmdnseq = l_pmdt.pmdt002             
      #151202-00010#2 s983961--add(e)
      
      INSERT INTO pmdt_t(pmdtent, pmdtsite, pmdtdocno, pmdtseq,
                         pmdt001, pmdt002,  pmdt003,   pmdt004,
                         pmdt005, pmdt006,  pmdt007,   pmdt016,
                         pmdt017, pmdt018,  pmdt019,   pmdt020,
                         pmdt023, pmdt024,  pmdt025,   pmdt026,
                         pmdt027, pmdt028,  pmdt036,   pmdt037,
                         pmdt038, pmdt039,  pmdt044,   pmdt046,
                         pmdt047, pmdt051,  pmdt052,   pmdt053,
                         pmdt054, pmdt055,  pmdt062,   pmdt063,
                         pmdt084, pmdt088,  pmdt089,   pmdt200,
                         pmdt201, pmdt202,  pmdt203,   pmdt204,
                         pmdt205, pmdt206,  pmdt207,   pmdt208,
                         pmdt209, pmdt210,  pmdt211,   pmdt212,
                         pmdt213, pmdt214,  pmdt215,   pmdt218,
                         pmdt219, pmdtorga, pmdt227,   pmdt220,  pmdt221)   #補貨規格說明  150710-00016#7 Add By Ken 150713    #151202-00010#2 s983961--add pmdt220/221
         VALUES(l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
                l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
                l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
                l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
                l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
                l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
                l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt044,   l_pmdt.pmdt046,
                l_pmdt.pmdt047, l_pmdt.pmdt051,  l_pmdt.pmdt052,   l_pmdt.pmdt053,
                l_pmdt.pmdt054, l_pmdt.pmdt055,  l_pmdt.pmdt062,   l_pmdt.pmdt063,
                l_pmdt.pmdt084, l_pmdt.pmdt088,  l_pmdt.pmdt089,   l_pmdt.pmdt200,
                l_pmdt.pmdt201, l_pmdt.pmdt202,  l_pmdt.pmdt203,   l_pmdt.pmdt204,
                l_pmdt.pmdt205, l_pmdt.pmdt206,  l_pmdt.pmdt207,   l_pmdt.pmdt208,
                l_pmdt.pmdt209, l_pmdt.pmdt210,  l_pmdt.pmdt211,   l_pmdt.pmdt212,
                l_pmdt.pmdt213, l_pmdt.pmdt214,  l_pmdt.pmdt215,   l_pmdt.pmdt218,
                l_pmdt.pmdt219, l_pmdt.pmdtorga, l_pmdt.pmdt227,   l_pmdt220,        l_pmdt221)   #補貨規格說明 150710-00016#7 Add By Ken 150713   #151202-00010#2 s983961--add l_pmdt220/221
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      #產生多庫儲批資料
      CALL s_apmt860_ins_pmdu(g_pmds_m.pmds000, g_pmds_m.pmdsdocno, l_pmdt.pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                              l_pmdt.pmdtseq,   l_pmdt.pmdt006,     l_pmdt.pmdt007,
                              l_pmdt.pmdt016,   l_pmdt.pmdt017,     l_pmdt.pmdt018,
                              l_pmdt.pmdt019,   l_pmdt.pmdt020,     l_pmdt.pmdt027,
                              l_pmdt.pmdt028,   l_pmdt.pmdt053,     l_pmdt.pmdt054,
                              l_pmdt.pmdt055,   l_pmdt.pmdt062,     l_pmdt.pmdt063,
                              l_pmdt.pmdt088,   l_pmdt.pmdt089,     l_pmdt.pmdt201,
                              l_pmdt.pmdt202,   l_pmdt.pmdt219) RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #產生原始需求分配明細
      CALL s_apmt860_gen_pmdv(g_pmds_m.pmdsdocno,l_pmdt.pmdtseq)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      INITIALIZE l_pmdt.* TO NULL
   END FOREACH
   
   #重新計算整單的未稅、含稅總金額
   LET l_success = ''
   CALL s_apmt860_upd_pmds(g_pmds_m.pmdsdocno)
      RETURNING l_success,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   CALL cl_err_collect_show()
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 確認輸入的包裝數量或收貨數量
# Memo...........: 當單身採購單號為空表示為自己輸入商品編號
#                : 程式為 無採購收貨(入庫)單 或 採購倉退單直接退商品
# Usage..........: CALL apmt860_chk_num(p_type)
#                :    RETURNING r_success
# Input parameter: p_type         1.檢查包裝數量
#                :                2.檢查出貨/入庫數量
# Return code....: r_success      True/False
# Date & Author..: 2014/12/29 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_chk_num(p_type)
DEFINE p_type           LIKE type_t.num5
DEFINE r_success        LIKE type_t.num5
DEFINE l_success        LIKE type_t.num5
DEFINE l_pmdt020        LIKE pmdt_t.pmdt020
DEFINE l_change         LIKE pmdt_t.pmdt020
DEFINE l_pmdt001        LIKE pmdt_t.pmdt001
DEFINE l_pmdt002        LIKE pmdt_t.pmdt002
DEFINE l_chk_inag       LIKE type_t.num5        #是否要檢查庫存明細資料

   LET r_success = TRUE
   LET l_chk_inag = FALSE
   
   #1.採購驗退單、採購入庫單、採購倉退單
   #    前單據為出貨單
   #  Else
   #    前單據為採購單
   IF g_argv[1] MATCHES '[567]' THEN
      LET l_pmdt001 = g_pmdt_d[l_ac].pmdt027
      LET l_pmdt002 = g_pmdt_d[l_ac].pmdt028
   ELSE
      LET l_pmdt001 = g_pmdt_d[l_ac].pmdt001
      LET l_pmdt002 = g_pmdt_d[l_ac].pmdt002
   END IF
   
   #2.當單身採購單號為空表示為自己輸入商品編號
   #  程式為 無採購收貨(入庫)單 或 採購倉退單直接退商品
   IF cl_null(g_pmdt_d[l_ac].pmdt001) AND cl_null(g_pmdt_d[l_ac].pmdt027) THEN
      #2-1.檢查包裝數量
      IF p_type = '1' THEN
         IF g_pmdt_d[l_ac].pmdt202 <= 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = "apm-00747"
            LET g_errparam.extend = ""
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
            RETURN r_success
         END IF
         LET l_chk_inag = TRUE
      ELSE
      #2-2.檢查出貨數量
         IF g_pmdt_d[l_ac].pmdt020 <= 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = "apm-00748"
            LET g_errparam.extend = ""
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
            RETURN r_success
         END IF
         LET l_chk_inag = TRUE
      END IF
   ELSE
   #3.當有採購單號
      #3-1.檢查包裝數量
      IF p_type = '1' THEN
         LET l_success = ''
         LET l_change = 0
         CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt202)
            RETURNING l_success,l_change
         
         LET l_success = ''
         LET l_pmdt020 = ''
         CALL s_apmt860_chk_pmdt020('2', g_pmds_m.pmds000, g_pmdt_d[l_ac].pmdtsite,
                     g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,
                     l_pmdt001,               l_pmdt002,
                     g_pmdt_d[l_ac].pmdt003,  g_pmdt_d[l_ac].pmdt004,
                     g_pmdt_d[l_ac].pmdt006,  g_pmdt_d[l_ac].pmdt206,
                     g_pmdt_d[l_ac].pmdt207,  l_change)
            RETURNING l_success,l_pmdt020
         IF l_success = FALSE THEN
            LET r_success = FALSE
         END IF
      ELSE
      #3-2.檢查出貨數量
         LET l_change = g_pmdt_d[l_ac].pmdt020
         LET l_success = ''
         LET l_pmdt020 = ''
         CALL s_apmt860_chk_pmdt020('2', g_pmds_m.pmds000, g_pmdt_d[l_ac].pmdtsite,
                     g_pmds_m.pmdsdocno,     g_pmdt_d[l_ac].pmdtseq,
                     l_pmdt001,              l_pmdt002,
                     g_pmdt_d[l_ac].pmdt003, g_pmdt_d[l_ac].pmdt004,
                     g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt206,
                     g_pmdt_d[l_ac].pmdt207, l_change)
            RETURNING l_success,l_pmdt020
         IF l_success = FALSE THEN
            LET r_success = FALSE
         END IF
      END IF
   END IF
   
   #4.倉退時 輸入的商品編號+產品特徵+庫存管理特徵+庫位+儲位必須存在[T:庫存明細檔]中
   #  庫存量要夠
   IF g_pmds_m.pmds000 = '7' AND l_chk_inag THEN
      LET l_success = ''
      CALL s_apmt860_chk_inag(g_pmds_m.pmdssite,      g_pmdt_d[l_ac].pmdt006,
                              g_pmdt_d[l_ac].pmdt007, ' ',
                              g_pmdt_d[l_ac].pmdt016, g_pmdt_d[l_ac].pmdt017,
                              g_pmdt_d[l_ac].pmdt018, g_pmdt_d[l_ac].pmdt019,
                              g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 商品編號檢查
# Memo...........:
# Usage..........: CALL apmt860_pmdt006_chk(p_pmdt006)
#                :    RETURNING r_success
# Input parameter: p_pmdt006      商品編號
# Return code....: r_success      True/False
# Date & Author..: 2014/12/30 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt006_chk(p_pmdt006)
DEFINE p_pmdt006     LIKE pmdt_t.pmdt006
DEFINE r_success     LIKE type_t.num5
DEFINE l_rtax009     LIKE rtax_t.rtax009
DEFINE l_rtdx028     LIKE rtdx_t.rtdx028   #採購中心
DEFINE l_success     LIKE type_t.num5
DEFINE l_errno       LIKE type_t.chr10
DEFINE l_sql         STRING

   LET r_success = TRUE
   
   IF NOT cl_null(p_pmdt006) THEN 
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = p_pmdt006
      LET g_chkparam.arg2 = 'ALL'
      IF cl_chk_exist("v_imaf001_15") THEN
         INITIALIZE g_chkparam.* TO NULL
         LET g_chkparam.arg1 = p_pmdt006
         LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdtsite
         IF NOT cl_chk_exist("v_rtdx001") THEN
            LET r_success = FALSE
            RETURN r_success
         END IF
         
         #當無採購收貨入庫單時，才需要檢查商品品類是否需要檢驗
         IF g_argv[1] = '4' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
            LET l_rtax009 = ''
            SELECT rtax009 INTO l_rtax009
              FROM rtax_t,imaa_t
             WHERE rtaxent = imaaent
               AND rtax001 = imaa009
               AND imaaent = g_enterprise
               AND imaa001 = p_pmdt006
            IF l_rtax009 = 'Y' THEN
               #此商品編號對應的商品品類需要檢驗，只可以在採購收貨單輸入此商品編號！
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "apm-00803"
               LET g_errparam.extend = ""
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF
         END IF
         
         #商品生命周期的判断  2015/03/19  geza
         #150909 s983961 mark and mod(s)
         #IF NOT s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'1',g_pmdt_d[l_ac].pmdt006,'','') THEN   #150719 by dongsz mark       
         #IF NOT s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'1',g_pmdt_d[l_ac].pmdo001,        #150719 by dongsz add
         #                        g_pmds_m.pmds007,g_pmds_m.pmdsdocdt) THEN                   #150719 by dongsz add  
         IF NOT s_life_cycle_chk(g_prog,g_pmds_m.pmdssite,'1',g_pmdt_d[l_ac].pmdt006,
                                 g_pmds_m.pmds007,g_pmds_m.pmdsdocdt) THEN    
         #150909 s983961 mark and mod(e)           
            LET r_success = FALSE
            RETURN r_success
         END IF
         
         #採購中心
         #150520-00017#1 150526 By pomelo add(S)
         ##150703 By pomelo mark(S)
         #LET l_rtdx028 = ''
         #SELECT rtdx028 INTO l_rtdx028
         #  FROM rtdx_t
         # WHERE rtdxent = g_enterprise
         #   AND rtdxsite = g_site
         #   AND rtdx001 = g_pmdt_d[l_ac].pmdt006
         ##150703 By pomelo mark(E)
         ##150703 By pomelo add(S)
         LET l_sql = "SELECT star008",
                     "  FROM star_t,stas_t",
                     " WHERE starent = stasent",
                     "   AND starsite = stassite",
                     "   AND star001 = stas001",
                     "   AND starent = ",g_enterprise,
                     "   AND star003 = '",g_pmds_m.pmds007,"'",
                     "   AND starstus = 'Y'",
                     "   AND starsite = '",g_site,"'",
                     "   AND stas003 = '",g_pmdt_d[l_ac].pmdt006,"'",   #160322-00033#1 160325 By pomelo add
                     " ORDER BY star002 DESC"
         PREPARE apmt860_get_star008_pre FROM l_sql
         DECLARE apmt860_get_star008_cs SCROLL CURSOR FOR apmt860_get_star008_pre
         OPEN apmt860_get_star008_cs
         FETCH FIRST apmt860_get_star008_cs INTO l_rtdx028
         ##150703 By pomelo add(E)
         IF cl_null(l_rtdx028) THEN
            #此營運據點%1+商品編號%2+供應商%3 取得有效採購協議最大版次的採購中心為空！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'apm-00968'
            LET g_errparam.extend = ""
            LET g_errparam.popup = TRUE
            LET g_errparam.replace[1] = g_site
            LET g_errparam.replace[2] = g_pmdt_d[l_ac].pmdt006
            LET g_errparam.replace[3] = g_pmds_m.pmds007
            CALL cl_err()
            LET r_success = FALSE
            RETURN r_success
         END IF
         LET l_success = ''
         LET l_errno = ''
         CALL s_apmt840_chk_pact_curr(l_rtdx028,g_pmds_m.pmds007,g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdt006,g_pmds_m.pmds037,g_pmds_m.pmdssite)
            RETURNING l_success,l_errno
         IF l_success = FALSE THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = l_errno
            LET g_errparam.extend = ""
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success = FALSE
            RETURN r_success
         END IF
         #150520-00017#1 150526 By pomelo add(E)
      ELSE
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 商品編號帶出預設值
# Memo...........:
# Usage..........: CALL apmt860_pmdt006_default(p_type)
# Input parameter: p_type        類型 1.商品條碼 2.商品編號
# Return code....: 無
# Date & Author..: 2014/12/30 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt006_default(p_type)
DEFINE p_type           LIKE type_t.chr1
DEFINE l_success        LIKE type_t.num5
DEFINE l_rtdx002        LIKE rtdx_t.rtdx002
DEFINE l_imaa014        LIKE imaa_t.imaa014
DEFINE l_rtdx028        LIKE rtdx_t.rtdx028   #採購中心
DEFINE l_ooag001        LIKE ooag_t.ooag001
DEFINE l_ooef001        LIKE ooef_t.ooef001
DEFINE l_sql            STRING
#150710-00016#7 Add By Ken 150713(S)
DEFINE l_sys2           LIKE type_t.num5      #補貨規格的參數  
DEFINE l_imaz004        LIKE imaz_t.imaz004   #包裝單位
DEFINE l_imaz006        LIKE imaz_t.imaz006   #補貨規格說明
#150710-00016#7 Add By Ken 150713(E)
DEFINE l_oodb011        LIKE oodb_t.oodb011   #稅別應用 #150930-00013#1 Add By Ken 151007
DEFINE l_imaa149        LIKE imaa_t.imaa149   #臨期控管方式  #160604-00009#96 Add By Ken 160623
DEFINE l_imaa102        LIKE imaa_t.imaa102   #保質期(月)    #160604-00009#96 Add By Ken 160623
DEFINE l_imaa103        LIKE imaa_t.imaa103   #保質期(日)    #160604-00009#96 Add By Ken 160623 
DEFINE l_pmdt219        LIKE pmdt_t.pmdt219   #製造日期      #160604-00009#96 Add By Ken 160623
DEFINE r_success        LIKE type_t.num5      #回傳值   #150930-00013#1 Add By Ken 151007


   LET r_success = TRUE   #150930-00013#1 Add By Ken 151007

   #檢驗
   CALL s_apmt840_get_rtax009(g_pmdt_d[l_ac].pmdt006)
      RETURNING g_pmdt_d[l_ac].pmdt026
   
   #150312-00002#2 Modify-S By Ken 150319 原rtdx030改抓imaa107，原rtdx033改抓imaa106
   #取的門店清單中的採購單位、計價單位
   #SELECT rtdx002#,rtdx030,rtdx033
   #  INTO l_rtdx002#,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023
   #  FROM rtdx_t
   # WHERE rtdxent = g_enterprise
   #   AND rtdxsite = g_pmdt_d[l_ac].pmdtsite
   #   AND rtdx001 = g_pmdt_d[l_ac].pmdt006
   
   LET l_imaa014 = ''
   SELECT imaa107,imaa106,imaa014
     INTO g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,l_imaa014
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdt_d[l_ac].pmdt006
   #150312-00002#2 Modify-E   
   
   #輸入商品編號的時候，需要重新帶出商品條碼
   IF p_type = '2' THEN
      LET g_pmdt_d[l_ac].pmdt200 = l_imaa014
   END IF
   
   #150710-00016#7 Add By Ken 150713(S) 取商品符合補貨規格的包裝單位、補貨規格說明   
   IF g_argv[1] MATCHES '[247]' OR g_argv[1] ='22' THEN #無採購收貨、無採購收貨入庫單、退廠單時 #add by geza 20150811 add g_argv[1] ='22'
      LET g_pmdt_d[l_ac].pmdt227 = ''
      CALL cl_get_para(g_enterprise,g_pmds_m.pmdssite,'S-CIR-1002') RETURNING l_sys2
      SELECT imaz004,imaz006 INTO l_imaz004,l_imaz006
        FROM imaz_t
       WHERE imazent = g_enterprise 
         AND imaz001 = g_pmdt_d[l_ac].pmdt006
         AND imaz002 = l_sys2   
      
      #150710-00016#3 Add By Ken 150713(S) 如補貨規格有符合 則使用補貨規格的包裝單位、補貨規格，沒有的話則帶主條碼的包裝單位
      IF NOT cl_null(l_imaz004) THEN
         LET g_pmdt_d[l_ac].pmdt201 = l_imaz004
         LET g_pmdt_d[l_ac].pmdt227 = l_imaz006
      ELSE
         SELECT imay004
           INTO g_pmdt_d[l_ac].pmdt201 
           FROM imay_t 
          WHERE imayent= g_enterprise 
            AND imay001 = g_pmdt_d[l_ac].pmdt006 
            AND imay003 = g_pmdt_d[l_ac].pmdt200   
      END IF
   #150710-00016#3 Add By Ken 150713 (E)       
   ELSE     
      #取的商品條碼裡的包裝單位
      SELECT imay004 INTO g_pmdt_d[l_ac].pmdt201
        FROM imay_t
       WHERE imayent = g_enterprise
         AND imay003 = g_pmdt_d[l_ac].pmdt200
   END IF
   
   #數量轉換
   CALL apmt860_num_change()
   
   #150520-00017#1 150526 By pomelo add(S)
   ##150703 By pomelo mark(S)
   #LET l_rtdx028 = ''
   #SELECT rtdx028 INTO l_rtdx028
   #  FROM rtdx_t
   # WHERE rtdxent = g_enterprise
   #   AND rtdxsite = g_pmdt_d[l_ac].pmdtsite
   #   AND rtdx001 = g_pmdt_d[l_ac].pmdt006
   ##150703 By pomelo mark(E)
   ##150703 By pomelo add(S)
   LET l_sql = "SELECT star008",
               "  FROM star_t,stas_t",
               " WHERE starent = stasent",
               "   AND starsite = stassite",
               "   AND star001 = stas001",
               "   AND starent = ",g_enterprise,
               "   AND star003 = '",g_pmds_m.pmds007,"'",
               "   AND starstus = 'Y'",
               "   AND starsite = '",g_site,"'",
               "   AND stas003 = '",g_pmdt_d[l_ac].pmdt006,"'",   #160322-00033#1 160325 By pomelo add
               " ORDER BY star002 DESC"
   PREPARE apmt860_get_star008_pre1 FROM l_sql
   DECLARE apmt860_get_star008_cs1 SCROLL CURSOR FOR apmt860_get_star008_pre1
   OPEN apmt860_get_star008_cs1
   FETCH FIRST apmt860_get_star008_cs1 INTO l_rtdx028
   ##150703 By pomelo add(E)
   CALL s_apmt840_get_pact(l_rtdx028,g_pmds_m.pmds037,g_pmds_m.pmds007,g_pmds_m.pmdsdocdt,g_pmdt_d[l_ac].pmdt006,g_site)
      RETURNING g_pmdt_d[l_ac].pmdtorga, g_pmdt_d[l_ac].pmdt019, g_pmdt_d[l_ac].pmdt023,
                g_pmdt_d[l_ac].pmdt044,  g_pmdt_d[l_ac].pmdt046, g_pmdt_d[l_ac].pmdt037,
                g_pmdt_d[l_ac].pmdt210,  g_pmdt_d[l_ac].pmdt211, g_pmdt_d[l_ac].pmdt212,
                g_pmdt_d[l_ac].pmdt213,  l_ooag001,              l_ooef001
   LET g_pmdt_d[l_ac].pmdt036 = g_pmdt_d[l_ac].pmdt044
   #150520-00017#1 150526 By pomelo add(E)
   
   #150930-00013#1 Add By Ken 151007(S)  #取得單頭稅別的稅別應用 ，單頭稅別應用為1時 單身稅別需與單頭稅別相同
   LET l_oodb011 = ''
   CALL s_apmt840_get_oodb011(g_pmds_m.pmdssite,g_pmds_m.pmds033) RETURNING l_oodb011
   IF (l_oodb011 = '1') AND (g_pmds_m.pmds033 <> g_pmdt_d[l_ac].pmdt046) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  'apm-01002'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds033
      LET g_errparam.replace[2] = g_pmdt_d[l_ac].pmdt046
      CALL cl_err()       
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150930-00013#1 Add By Ken 151007(E)    
   
   #Add By Ken 150702(S) 無採購收貨、無採購收貨入庫單時 把採購中心寫入欄位(隱藏)
   IF g_argv[1] MATCHES '[24]' THEN
      LET g_pmdt_d[l_ac].pmdt204 = l_rtdx028
   END IF
   #Add By Ken 150702(E)
   
   #160604-00009#96 Add By Ken 160623(S)   制造(有效)日期给默认值:如保質期(月、日)都沒設定的話 默认给系统日期
   SELECT COALESCE(imaa102,0),COALESCE(imaa103,0) 
     INTO l_imaa102,l_imaa103
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_pmdt_d[l_ac].pmdt006
   IF (l_imaa102 = 0) AND (l_imaa103 = 0) THEN
      LET g_pmdt_d[l_ac].pmdt219 = g_today 
      LET g_pmdt_d[l_ac].pmdt089 = g_today 
   ELSE
      LET g_pmdt_d[l_ac].pmdt219 = ''
      LET g_pmdt_d[l_ac].pmdt089 = ''   
   END IF
   #160604-00009#96 Add By Ken 160623(E)   
   
   #當商品編號有修改
   IF g_pmdt_d[l_ac].pmdt006 != g_pmdt_d_o.pmdt006 OR
      cl_null(g_pmdt_d_o.pmdt006) THEN
      #刪除多庫儲批資料，多庫儲批欄位 = 'N'
      CALL s_apmt860_del_pmdu(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
         RETURNING l_success
      LET g_pmdt_d[l_ac].pmdt062 = 'N'
      
      #庫位、儲位、批號、庫存管理特徵 清空
      LET g_pmdt_d[l_ac].pmdt016 = ''
      LET g_pmdt_d[l_ac].pmdt016_desc = ''
      LET g_pmdt_d[l_ac].pmdt017 = ' '
      LET g_pmdt_d[l_ac].pmdt017_desc = ''
      LET g_pmdt_d[l_ac].pmdt018 = ' '
      LET g_pmdt_d[l_ac].pmdt063 = ' '
      
      CALL s_apmt860_warehouse_default(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt006)
         RETURNING g_pmdt_d[l_ac].pmdt016
         
      #150507-00001#8 150610 by lori522612 add---(S)
      IF g_argv[1] MATCHES '[346]' THEN            
         LET l_success = ''
         CALL s_lot_out_effdate(g_pmdt_d[l_ac].pmdtsite,
                                g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                                g_pmdt_d[l_ac].pmdt219,g_pmdt_d[l_ac].pmdt018)
           RETURNING l_success,g_pmdt_d[l_ac].pmdt089
           
         #160615-00028#3 Add By ken 160623(S)
         CALL s_apmt860_pmdt219_get(g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt007,
                                   g_pmdt_d[l_ac].pmdt089,  g_pmdt_d[l_ac].pmdt018)
            RETURNING l_success,l_pmdt219
         IF l_success THEN
            LET g_pmdt_d[l_ac].pmdt219 = l_pmdt219
         END IF
         #160615-00028#3 Add By ken 160623(E)            
      END IF
      #150507-00001#8 150610 by lori522612 add---(E)
   END IF
      
   #取得未稅金額、稅額、含稅金額
   CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                             g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                             g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                             g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
      RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
   
   #商品品名、規格
   CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006)
      RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
   
   #包裝單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt201) RETURNING g_pmdt_d[l_ac].pmdt201_desc
   
   #採購單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
   
   #計價單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
   
   #庫位
   CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
   
   #稅別
   CALL s_desc_get_tax_desc1(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046)
      RETURNING g_pmdt_d[l_ac].pmdt046_desc
      
   #帳務組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdtorga) RETURNING g_pmdt_d[l_ac].pmdtorga_desc
   
   #結算方式
   CALL apmt860_pmdt211_ref()
   
   #採購方式(無採購時)
   #160511-00010#1 Add By Ken 160518(S)
   IF g_argv[1] MATCHES '[24]' THEN
      SELECT rtdx027 INTO g_pmdt_d[l_ac].pmdt214
        FROM rtdx_t
       WHERE rtdxent = g_enterprise
         AND rtdxsite= g_site
         AND rtdx001 = g_pmdt_d[l_ac].pmdt006
   END IF
   #160511-00010#1 Add By Ken 160518(E)
   
   
   #151202-00010#2 s983961--add(s)
   #商品品類
    SELECT imaa009,rtaxl003 INTO g_pmdt_d[l_ac].pmdt220,g_pmdt_d[l_ac].pmdt220_desc
      FROM imaa_t
      LEFT OUTER JOIN rtaxl_t ON rtaxlent = g_enterprise AND rtaxl001 = imaa009 AND rtaxl002 = g_dlang
     WHERE imaaent = g_enterprise
       AND imaa001 = g_pmdt_d[l_ac].pmdt006
    #151202-00010#2 s983961--add(e)
    
   LET g_pmdt_d_o.* = g_pmdt_d[l_ac].*
   
   RETURN r_success   #150930-00013#1 Add By Ken 151007    
END FUNCTION

################################################################################
# Descriptions...: 採購/計價單位 檢查
# Memo...........:
# Usage..........: CALL apmt860_unit_chk(p_pmdt019)
#                :    RETURNING r_success
# Input parameter: p_pmdt019      單位
# Return code....: r_success      True/False
# Date & Author..: 2014/12/30 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_unit_chk(p_pmdt019)
DEFINE p_pmdt019    LIKE pmdt_t.pmdt019
DEFINE r_success    LIKE type_t.num5

   LET r_success = TRUE

   IF NOT cl_null(p_pmdt019) THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt006
      LET g_chkparam.arg2 = p_pmdt019
      
      IF NOT cl_chk_exist("v_imao002") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 取得產品特徵類別
# Memo...........:
# Usage..........: CALL apmt860_get_imaa005(p_imaa001)
#                  RETURNING r_imaa005
# Input parameter: p_imaa001      商品編號
# Return code....: r_imaa005      產品特徵類別
# Date & Author..: 2015/01/05 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_get_imaa005(p_imaa001)
DEFINE p_imaa001      LIKE imaa_t.imaa001
DEFINE r_imaa005      LIKE imaa_t.imaa005

   LET r_imaa005 = ''
   SELECT imaa005 INTO r_imaa005 
     FROM imaa_t 
    WHERE imaaent = g_enterprise 
      AND imaa001 = p_imaa001
      
   RETURN r_imaa005   
   
END FUNCTION

################################################################################
# Descriptions...: 驗退、入庫、倉退時，檢查對應收貨單號的收貨項次
# Memo...........:
# Usage..........: CALL apmt860_pmdt028_chk()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success      True/False
# Date & Author..: 2015/01/05 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_pmdt028_chk()
DEFINE r_success        LIKE type_t.num5
DEFINE l_cnt            LIKE type_t.num5
DEFINE l_success        LIKE type_t.num5
DEFINE l_pmdt020        LIKE pmdt_t.pmdt020
DEFINE l_errno          LIKE type_t.chr10

   LET r_success = TRUE
       
   #驗退、入庫、倉退時，檢查對應收貨單號的收貨項次
   IF g_argv[1] MATCHES '[567]' THEN
      #1.輸入的收貨項次需存在單頭輸入的收貨單號對應的收貨明細中
      LET l_cnt = 0
      SELECT COUNT(pmdtdocno) INTO l_cnt
        FROM pmdt_t
       WHERE pmdtent = g_enterprise
         AND pmdtdocno = g_pmdt_d[l_ac].pmdt027
         AND pmdtseq = g_pmdt_d[l_ac].pmdt028
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00752'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      LET l_success = ''
      LET l_pmdt020 = 0
      CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000,   g_pmdt_d[l_ac].pmdtsite,
                                 g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,
                                 g_pmdt_d[l_ac].pmdt027,  g_pmdt_d[l_ac].pmdt028,
                                 '',                      '',
                                 g_pmdt_d[l_ac].pmdt006,  g_pmdt_d[l_ac].pmdt206,
                                 g_pmdt_d[l_ac].pmdt207,  0)
         RETURNING l_success,l_pmdt020
      
      IF l_pmdt020 <= 0 THEN
         CASE g_pmds_m.pmds000
            WHEN '5'
               LET l_errno = 'apm-00753'
            WHEN '6'
               LET l_errno = 'apm-00754'
            WHEN '7'
               LET l_errno = 'apm-00755'
         END CASE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = l_errno
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   RETURN r_success
        
END FUNCTION

################################################################################
# Descriptions...: 根據收貨單號+收貨項次 帶出收貨單資料
# Memo...........:
# Usage..........: CALL apmt860_pmdt028_default()  RETURNING r_success
# Input parameter: 無
# Return code....: r_success   True/False
# Date & Author..: 2015/01/05 By pomelo
# Modify.........: 2017/02/08 By sakura #170207-00002#1 新增回傳值
################################################################################
PUBLIC FUNCTION apmt860_pmdt028_default()
DEFINE l_pmdt      RECORD
       pmdt001     LIKE pmdt_t.pmdt001,     #採購單號
       pmdt002     LIKE pmdt_t.pmdt002,     #採購項次
       pmdt003     LIKE pmdt_t.pmdt003,     #採購項序
       pmdt004     LIKE pmdt_t.pmdt004,     #採購分批序
       pmdt005     LIKE pmdt_t.pmdt005,     #子件特性
       pmdt006     LIKE pmdt_t.pmdt006,     #料件編號
       pmdt007     LIKE pmdt_t.pmdt007,     #產品特徵
       pmdt016     LIKE pmdt_t.pmdt016,     #庫位
       pmdt017     LIKE pmdt_t.pmdt017,     #儲位
       pmdt018     LIKE pmdt_t.pmdt018,     #批號
       pmdt019     LIKE pmdt_t.pmdt019,     #收貨/入庫單位
       pmdt020     LIKE pmdt_t.pmdt020,     #收貨/入庫數量
       pmdt023     LIKE pmdt_t.pmdt023,     #計價單位
       pmdt024     LIKE pmdt_t.pmdt024,     #計價數量
       pmdt025     LIKE pmdt_t.pmdt025,     #緊急度
       pmdt026     LIKE pmdt_t.pmdt026,     #檢驗否
       pmdt036     LIKE pmdt_t.pmdt036,     #單價
       pmdt037     LIKE pmdt_t.pmdt037,     #稅率	
       pmdt038     LIKE pmdt_t.pmdt038,     #未稅金額	
       pmdt039     LIKE pmdt_t.pmdt039,     #含稅金額
       pmdt044     LIKE pmdt_t.pmdt044,     #取出單價
       pmdt046     LIKE pmdt_t.pmdt046,     #稅別
       pmdt047     LIKE pmdt_t.pmdt047,     #稅額
       pmdt062     LIKE pmdt_t.pmdt062,     #多庫儲批
       pmdt063     LIKE pmdt_t.pmdt063,     #庫存管理特徵
       pmdt200     LIKE pmdt_t.pmdt200,     #商品條碼
       pmdt201     LIKE pmdt_t.pmdt201,     #收貨包裝單位
       pmdt202     LIKE pmdt_t.pmdt202,     #收貨包裝數量
       pmdt203     LIKE pmdt_t.pmdt203,     #採購組織
       pmdt204     LIKE pmdt_t.pmdt204,     #採購中心
       pmdt205     LIKE pmdt_t.pmdt205,     #要貨組織
       pmdt206     LIKE pmdt_t.pmdt206,     #預約收貨單號
       pmdt207     LIKE pmdt_t.pmdt207,     #預約收貨項次
       pmdt208     LIKE pmdt_t.pmdt208,     #採購渠道
       pmdt209     LIKE pmdt_t.pmdt209,     #渠道性質
       pmdt210     LIKE pmdt_t.pmdt210,     #經營方式
       pmdt211     LIKE pmdt_t.pmdt211,     #結算方式
       pmdt212     LIKE pmdt_t.pmdt212,     #合約編號
       pmdt213     LIKE pmdt_t.pmdt213,     #協議編號
       pmdt214     LIKE pmdt_t.pmdt214,     #採購方式
       pmdt215     LIKE pmdt_t.pmdt215,     #最終收貨組織
       pmdt218     LIKE pmdt_t.pmdt218,     #採購價
       pmdtorga    LIKE pmdt_t.pmdtorga,    #帳務組織
       pmdt227     LIKE pmdt_t.pmdt227      #補貨規格說明 150710-00016#7 Add By Ken 150713
                   END RECORD
DEFINE l_success   LIKE type_t.num5
DEFINE l_pmdt020   LIKE pmdt_t.pmdt020      #可登打的數量
#170207-00002#1 170207 by sakura add(S)
DEFINE l_sql       STRING   
DEFINE l_rtdx028   LIKE rtdx_t.rtdx028     #採購中心
DEFINE l_ooag001   LIKE ooag_t.ooag001     #採購人員
DEFINE l_ooef001   LIKE ooef_t.ooef001     #採購部門
DEFINE r_success   LIKE type_t.num5
DEFINE l_para_apmt890   LIKE gzcb_t.gzcb002     #退廠單批號自動沖減與收貨單掛勾
#170207-00002#1 170207 by sakura add(E)

   LET r_success = TRUE   #170207-00002#1 170207 by sakura add

   INITIALIZE l_pmdt.* TO NULL
   SELECT pmdt001, pmdt002, pmdt003, pmdt004,
          pmdt005, pmdt006, pmdt007, pmdt016,
          pmdt017, pmdt018, pmdt019, pmdt023,
          pmdt025, pmdt026, pmdt036, pmdt037,
          pmdt044, pmdt047, pmdt062, pmdt063,
          pmdt200, pmdt201, pmdt203, pmdt204,
          pmdt205, pmdt206, pmdt207, pmdt208,
          pmdt209, pmdt210, pmdt211, pmdt212,
          pmdt213, pmdt214, pmdt215, pmdt218,
          pmdtorga,pmdt227  #補貨規格說明 150710-00016#7 Add By Ken 150713
     INTO l_pmdt.pmdt001, l_pmdt.pmdt002, l_pmdt.pmdt003, l_pmdt.pmdt004,
          l_pmdt.pmdt005, l_pmdt.pmdt006, l_pmdt.pmdt007, l_pmdt.pmdt016,
          l_pmdt.pmdt017, l_pmdt.pmdt018, l_pmdt.pmdt019, l_pmdt.pmdt023,
          l_pmdt.pmdt025, l_pmdt.pmdt026, l_pmdt.pmdt036, l_pmdt.pmdt037,
          l_pmdt.pmdt044, l_pmdt.pmdt047, l_pmdt.pmdt062, l_pmdt.pmdt063,
          l_pmdt.pmdt200, l_pmdt.pmdt201, l_pmdt.pmdt203, l_pmdt.pmdt204,
          l_pmdt.pmdt205, l_pmdt.pmdt206, l_pmdt.pmdt207, l_pmdt.pmdt208,
          l_pmdt.pmdt209, l_pmdt.pmdt210, l_pmdt.pmdt211, l_pmdt.pmdt212,
          l_pmdt.pmdt213, l_pmdt.pmdt214, l_pmdt.pmdt215, l_pmdt.pmdt218,
          l_pmdt.pmdtorga,l_pmdt.pmdt227  #補貨規格說明 150710-00016#7 Add By Ken 150713
     FROM pmdt_t
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmdt_d[l_ac].pmdt027
      AND pmdtseq = g_pmdt_d[l_ac].pmdt028
      
   LET l_success = ''
   LET l_pmdt020 = 0
   CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000,  g_pmdt_d[l_ac].pmdtsite,  
                              g_pmds_m.pmdsdocno,     g_pmdt_d[l_ac].pmdtseq,
                              g_pmdt_d[l_ac].pmdt027, g_pmdt_d[l_ac].pmdt028,
                              '',                     '',
                              g_pmdt_d[l_ac].pmdt006, g_pmdt_d[l_ac].pmdt206,
                              g_pmdt_d[l_ac].pmdt207, 0)
      RETURNING l_success,l_pmdt020
      
   #170207-00002#1 170207 by sakura add(S)
   #需重新取"合同"、"協議"(因能快速帶出單身資料,但有可能對應的"合同"、"協議"已改變了)
   IF g_argv[1] MATCHES '[7]' THEN
      LET l_sql = "SELECT star008",   #採購中心
                  "  FROM star_t,stas_t",
                  " WHERE starent = stasent",
                  "   AND starsite = stassite",
                  "   AND star001 = stas001",
                  "   AND starent = ",g_enterprise,
                  "   AND star003 = '",g_pmds_m.pmds007,"'",   #採購供應商
                  "   AND starstus = 'Y'",
                  "   AND starsite = '",g_site,"'",
                  "   AND stas003 = '",l_pmdt.pmdt006,"'",   #商品
                  " ORDER BY star002 DESC"
      PREPARE apmt860_get_star008_pre3 FROM l_sql
      DECLARE apmt860_get_star008_cs3 SCROLL CURSOR FOR apmt860_get_star008_pre3
      OPEN apmt860_get_star008_cs3
      FETCH FIRST apmt860_get_star008_cs3 INTO l_rtdx028
      CALL s_apmt840_get_pact(l_rtdx028,g_pmds_m.pmds037,g_pmds_m.pmds007,g_pmds_m.pmdsdocdt,l_pmdt.pmdt006,g_site)
         RETURNING l_pmdt.pmdtorga, l_pmdt.pmdt019, l_pmdt.pmdt023,
                   l_pmdt.pmdt044,  l_pmdt.pmdt046, l_pmdt.pmdt037,
                   l_pmdt.pmdt210,  l_pmdt.pmdt211, l_pmdt.pmdt212,
                   l_pmdt.pmdt213,  l_ooag001,      l_ooef001
      #檢查協議
      IF cl_null(l_pmdt.pmdt212) OR cl_null(l_pmdt.pmdt213) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-01154'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         LET g_errparam.replace[1] = g_pmds_m.pmds006
         LET g_errparam.replace[2] = g_pmdt_d[l_ac].pmdt028
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success          
      END IF
      #為批號沖減流程,批號清空
      IF NOT apmt860_chk_lot('a') THEN
         LET l_pmdt.pmdt018 = ''
         
         #退廠單批號自動沖減與收貨單掛勾參數
         CALL cl_get_para(g_enterprise,'','E-CIR-0048') RETURNING l_para_apmt890
         IF cl_null(l_para_apmt890) THEN
            LET l_para_apmt890 = 'N'
         END IF
         #與收貨單掛勾則清空合同、協議
         IF l_para_apmt890 = 'Y' THEN
            LET l_pmdt.pmdt212 = ''
            LET l_pmdt.pmdt213 = ''
         END IF
      END IF      
   END IF         
   #170207-00002#1 170207 by sakura add(E)       
   
   LET g_pmdt_d[l_ac].pmdt001  = l_pmdt.pmdt001     #採購單號
   LET g_pmdt_d[l_ac].pmdt002  = l_pmdt.pmdt002     #採購項次
   LET g_pmdt_d[l_ac].pmdt003  = l_pmdt.pmdt003     #採購項序
   LET g_pmdt_d[l_ac].pmdt004  = l_pmdt.pmdt004     #採購分批序
   LET g_pmdt_d[l_ac].pmdt005  = l_pmdt.pmdt005     #子件特性
   LET g_pmdt_d[l_ac].pmdt006  = l_pmdt.pmdt006     #商品編號
   LET g_pmdt_d[l_ac].pmdt007  = l_pmdt.pmdt007     #產品特徵
   LET g_pmdt_d[l_ac].pmdt016  = l_pmdt.pmdt016     #庫位
   LET g_pmdt_d[l_ac].pmdt017  = l_pmdt.pmdt017     #儲位
   LET g_pmdt_d[l_ac].pmdt018  = l_pmdt.pmdt018     #批號
   LET g_pmdt_d[l_ac].pmdt019  = l_pmdt.pmdt019     #收貨單位
   LET g_pmdt_d[l_ac].pmdt020  = l_pmdt020          #收貨數量
   LET g_pmdt_d[l_ac].pmdt023  = l_pmdt.pmdt023     #計價單位
   LET g_pmdt_d[l_ac].pmdt024  = 0                  #計價數量
   LET g_pmdt_d[l_ac].pmdt025  = l_pmdt.pmdt025     #緊急度
   LET g_pmdt_d[l_ac].pmdt026  = l_pmdt.pmdt026     #檢驗否
   LET g_pmdt_d[l_ac].pmdt036  = l_pmdt.pmdt036     #單價
   LET g_pmdt_d[l_ac].pmdt037  = l_pmdt.pmdt037     #稅率
   LET g_pmdt_d[l_ac].pmdt044  = l_pmdt.pmdt044     #取出單價
   LET g_pmdt_d[l_ac].pmdt046  = l_pmdt.pmdt046     #稅別
   LET g_pmdt_d[l_ac].pmdt053  = 0                  #允收數量
   #150611-00034#1 150701 By pomelo mark(S)
   #LET g_pmdt_d[l_ac].pmdt062  = l_pmdt.pmdt062     #多庫儲批
   #150611-00034#1 150701 By pomelo mark(E)
   #150611-00034#1 150701 By pomelo add(S)
   #多庫儲批
   IF g_pmds_m.pmds000 = '7' THEN
      LET g_pmdt_d[l_ac].pmdt062  = 'N'
      IF cl_null(g_pmdt_d[l_ac].pmdt016) THEN
         LET g_pmdt_d[l_ac].pmdt016 = s_apmt860_warehouse_default(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt006)
      END IF
   ELSE
      LET g_pmdt_d[l_ac].pmdt062  = l_pmdt.pmdt062
   END IF
   #150611-00034#1 150701 By pomelo add(E)
   LET g_pmdt_d[l_ac].pmdt063  = l_pmdt.pmdt063     #庫存管理特徵
   LET g_pmdt_d[l_ac].pmdt200  = l_pmdt.pmdt200     #商品條碼
   LET g_pmdt_d[l_ac].pmdt201  = l_pmdt.pmdt201     #包裝單位
   LET g_pmdt_d[l_ac].pmdt202  = 0                  #包裝數量
   LET g_pmdt_d[l_ac].pmdt203  = l_pmdt.pmdt203     #採購組織
   LET g_pmdt_d[l_ac].pmdt204  = l_pmdt.pmdt204     #採購中心
   LET g_pmdt_d[l_ac].pmdt205  = l_pmdt.pmdt205     #要貨組織
   LET g_pmdt_d[l_ac].pmdt208  = l_pmdt.pmdt208     #採購渠道
   LET g_pmdt_d[l_ac].pmdt209  = l_pmdt.pmdt209     #渠道性質
   LET g_pmdt_d[l_ac].pmdt210  = l_pmdt.pmdt210     #經營方式
   LET g_pmdt_d[l_ac].pmdt211  = l_pmdt.pmdt211     #結算方式
   LET g_pmdt_d[l_ac].pmdt212  = l_pmdt.pmdt212     #協議編號
   LET g_pmdt_d[l_ac].pmdt213  = l_pmdt.pmdt213     #合約編號
   LET g_pmdt_d[l_ac].pmdt214  = l_pmdt.pmdt214     #採購方式
   LET g_pmdt_d[l_ac].pmdt215  = l_pmdt.pmdt215     #最終收貨組織
   LET g_pmdt_d[l_ac].pmdt218  = l_pmdt.pmdt218     #採購價
   LET g_pmdt_d[l_ac].pmdtorga = l_pmdt.pmdtorga    #帳務組織
   LET g_pmdt_d[l_ac].pmdt227  = l_pmdt.pmdt227     #補貨規格說明 150710-00016#7 Add By Ken 150713
   
   #單位間的轉換數量
   CALL apmt860_num_change()
   
   #新增多庫儲批收貨明細檔
   IF NOT s_apmt860_ins_pmdu(g_pmds_m.pmds000,      g_pmds_m.pmdsdocno,    g_pmdt_d[l_ac].pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                             g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                             g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,
                             g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt027,
                             g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,
                             g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt063,
                             g_pmdt_d[l_ac].pmdt088,g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt201,
                             g_pmdt_d[l_ac].pmdt202,g_pmdt_d[l_ac].pmdt219) THEN
   END IF
   
   #取得未稅金額、稅額、含稅金額
   CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                             g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                             g_pmds_m.pmds037,g_pmdt_d[l_ac].pmdt024,
                             g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
      RETURNING g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt047,g_pmdt_d[l_ac].pmdt039
   
   #商品編號
   CALL s_desc_get_item_desc(g_pmdt_d[l_ac].pmdt006)
      RETURNING g_pmdt_d[l_ac].pmdt006_desc,g_pmdt_d[l_ac].pmdt006_desc_desc
   
   #產品特徵
   CALL s_feature_description(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007)
     RETURNING l_success,g_pmdt_d[l_ac].pmdt007_desc
   
   #庫位
   CALL s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016) RETURNING g_pmdt_d[l_ac].pmdt016_desc
   
   #儲位
   CALL s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
      RETURNING g_pmdt_d[l_ac].pmdt017_desc
   
   #收貨單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt019) RETURNING g_pmdt_d[l_ac].pmdt019_desc
   
   #計價單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt023) RETURNING g_pmdt_d[l_ac].pmdt023_desc
   
   #稅別
   CALL s_desc_get_tax_desc1(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt046) RETURNING g_pmdt_d[l_ac].pmdt046_desc
   
   #包裝單位
   CALL s_desc_get_unit_desc(g_pmdt_d[l_ac].pmdt201) RETURNING g_pmdt_d[l_ac].pmdt201_desc
   
   #採購組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt203) RETURNING g_pmdt_d[l_ac].pmdt203_desc
   
   #採購中心
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt204) RETURNING g_pmdt_d[l_ac].pmdt204_desc
   
   #要貨組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt205) RETURNING g_pmdt_d[l_ac].pmdt205_desc
   
   #最終收貨組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdt215) RETURNING g_pmdt_d[l_ac].pmdt215_desc
   
   #採購渠道
   CALL s_desc_get_oojdl003_desc(g_pmdt_d[l_ac].pmdt208) RETURNING g_pmdt_d[l_ac].pmdt208_desc
   
   #帳務組織
   CALL s_desc_get_department_desc(g_pmdt_d[l_ac].pmdtorga) RETURNING g_pmdt_d[l_ac].pmdtorga_desc
   
   #結算方式
   CALL apmt860_pmdt211_ref()
   
   LET g_pmdt_d[l_ac].pmdo001 = g_pmdt_d[l_ac].pmdt006
   LET g_pmdt_d[l_ac].pmdo001_desc = g_pmdt_d[l_ac].pmdt006_desc
   LET g_pmdt_d[l_ac].pmdo001_desc_desc = g_pmdt_d[l_ac].pmdt006_desc_desc
   LET g_pmdt_d[l_ac].pmdo002 = g_pmdt_d[l_ac].pmdt007
   LET g_pmdt_d[l_ac].pmdo002_desc = g_pmdt_d[l_ac].pmdt007_desc
   
   #取前單據限定庫位、限定儲位、限定批號
   LET g_pmdt016 = l_pmdt.pmdt016
   LET g_pmdt017 = l_pmdt.pmdt017
   LET g_pmdt018 = l_pmdt.pmdt018
   LET g_pmdt063 = l_pmdt.pmdt063
   
   RETURN r_success   #170207-00002#1 170207 by sakura add
END FUNCTION

################################################################################
# Descriptions...: 單身必要輸入欄位關閉
# Memo...........: 
# Usage..........: CALL apmt860_set_no_required_b()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/05 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_set_no_required_b()

   CALL cl_set_comp_required("pmdt016",FALSE)    #庫位
   CALL cl_set_comp_required("pmdt063",FALSE)    #庫存管理特徵
   CALL cl_set_comp_required("pmdt219",FALSE)    #製造日期
   CALL cl_set_comp_required("pmdt089",FALSE)    #有效日期
   CALL cl_set_comp_required("pmdt017",FALSE)    #儲位   #160426-00021#1 160503 by lori add
   
END FUNCTION

################################################################################
# Descriptions...: 單身必要輸入欄位開啟
# Memo...........: 
# Usage..........: CALL apmt860_set_required_b()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/05 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_set_required_b()
DEFINE l_imaf055        LIKE imaf_t.imaf055
DEFINE l_imaf061        LIKE imaf_t.imaf061
DEFINE l_success        LIKE type_t.num5
DEFINE l_set_required   LIKE type_t.num5
DEFINE l_inaa007        LIKE inaa_t.inaa007   #160426-00021#1 160503 by lori add

   #收貨入庫和倉退時，庫位不可為空
   IF g_argv[1] MATCHES '[3467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_comp_required("pmdt016",TRUE)    #庫位
   END IF
   
   LET l_imaf055 = ''
   LET l_imaf061 = ''
   CALL s_apmt860_get_imaf(g_pmdt_d[l_ac].pmdt006) RETURNING l_imaf055,l_imaf061
   #庫存管理特徵 = 1.必須有庫存管理特徵，庫存管理特徵欄位必須輸入
   IF l_imaf055 = '1' THEN
      CALL cl_set_comp_required("pmdt063",TRUE)
   END IF
   
   #批號 出/入庫扣帳作業時需依設定判斷是否設為必填
   IF g_argv[1] MATCHES '[3467]' THEN   #150427-00001#8 1500601 by lori522612 add
      LET l_success = ''
      LET l_set_required = ''
      CALL s_lot_out_required(g_pmdt_d[l_ac].pmdt006)
         RETURNING l_success,l_set_required
      IF l_success THEN
         CALL cl_set_comp_required("pmdt018",l_set_required)
      END IF
   END IF                               #150427-00001#8 1500601 by lori522612 add
   
   #當為(無)採購收貨入庫單 採購收貨入庫單時
   IF g_argv[1] MATCHES '[12346]' THEN
      #製造日期
      CALL cl_set_comp_required("pmdt219",TRUE)
      #有效日期
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt018) THEN
         LET l_success = ''
         LET l_set_required = ''
         CALL s_lot_out_effdate_required(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt018)
            RETURNING l_success,l_set_required
         IF l_success THEN
            CALL cl_set_comp_required("pmdt089",l_set_required)
         END IF
      END IF
   END IF
   
   #160426-00021#1 160503 by lori add---(S)
   #儲位    
   LET l_inaa007 = ''   
   CALL s_apmt860_get_inaa007(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016)
      RETURNING l_inaa007 
   IF NOT cl_null(l_inaa007) AND l_inaa007 <> '5' THEN      
      CALL cl_set_comp_required("pmdt017",TRUE)    
   END IF
   #160426-00021#1 160503 by lori add---(E)
END FUNCTION

################################################################################
# Descriptions...: 根據不同程式，toolbar action 選擇顯示貨隱藏
# Memo...........: 
# Usage..........: CALL apmt860_act_visible_init()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/09 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_act_visible_init()

   ###############
   #整單Action
   ###############

   #價格變更
   #apmt860 apmt862 apmt880 apmt890 才顯示
   IF g_argv[1] MATCHES '[245]' THEN
      CALL cl_set_toolbaritem_visible("upd_price",FALSE)
   END IF
   
   #150506-00032#10 150527 by sakura add---STR
   #批次重新取價
   #apmt860 apmt861 apmt862 apmt863 才顯示
   IF g_argv[1] MATCHES '[24567]' THEN    #Modify By Ken 150702 先把無採購的二支作業 批次重新取價功能隱藏
      CALL cl_set_toolbaritem_visible("batch_price",FALSE)
   END IF   
   #150506-00032#10 150527 by sakura add---END

   #價格查詢
   #apmt860 apmt862 apmt870 apmt880 apmt890 才顯示
   IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("query_price",FALSE)
   END IF
   
   #產生收貨明細單身
   #apmt860 apmt862 才顯示
   IF g_argv[1] MATCHES '[24567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("open_apmt860_01",FALSE)
   END IF
   
   #產生入庫/驗退單
   #apmt860 apmt861 才顯示
   IF g_argv[1] MATCHES '[34567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("gen_apmt880_apmt870",FALSE)
   END IF
   
   #產生採購單
   #apmt890 才顯示
   IF g_argv[1] MATCHES '[123456]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("gen_purchase",FALSE)
   END IF
   
   #產生調撥單
   #apmt863 apmt880 才顯示
   IF g_argv[1] MATCHES '[12457]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("gen_aint510",FALSE)
   END IF
   
   #維護供應商貨日
   #apmt860 apmt861 apmt862 apmt863 才顯示
   IF g_argv[1] MATCHES '[567]' THEN
      CALL cl_set_toolbaritem_visible("upd_pmds052",FALSE)
   END IF
   
   #取回
   #apmt870 apmt890 才顯示
   IF g_argv[1] MATCHES '[12346]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("upd_pmds081",FALSE)
   END IF
   
   #查詢入庫單
   #apmt860 apmt861 才顯示
   IF g_argv[1] MATCHES '[34567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("query_apmt880",FALSE)
   END IF
   
   #查詢驗退單
   #apmt860 apmt861 才顯示
   IF g_argv[1] MATCHES '[34567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("query_apmt870",FALSE)
   END IF
   
   #當涉及到收貨時，可以執行維護進項發票信息的action(待確認)
   #維護進項發票信息
   #apmt860 apmt861 apmt862 apmt863 apmt880 apmt890 才顯示
   IF g_argv[1] MATCHES '[123467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("gen_pmdw",FALSE)
   END IF
   
   #發票訊息查詢
   #apmt860 apmt861 apmt862 apmt863 apmt880 apmt890 才顯示
   IF g_argv[1] MATCHES '[123467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("query_aapt110_01",FALSE)
   END IF
   
   #150608-00012#3 Add By Ken 150627(S)
   #apmt881、apmt891 整單操作全不顯示
   #IF (g_argv[1] = '16') OR (g_argv[1] = '17') THEN    
   IF (g_argv[1] = '16') OR (g_argv[1] = '17') OR (g_argv[1] = '18') THEN  #151104-00007#1 Add By Ken 151109 加g_argv[1]=18
      CALL cl_set_toolbaritem_visible("upd_price",FALSE)               #價格變更    
      CALL cl_set_toolbaritem_visible("batch_price",FALSE)             #批次重新取價           
      CALL cl_set_toolbaritem_visible("open_apmt860_01",FALSE)         #產生收貨明細單身    
      CALL cl_set_toolbaritem_visible("gen_apmt880_apmt870",FALSE)     #產生入庫/驗退單   
      CALL cl_set_toolbaritem_visible("gen_purchase",FALSE)            #產生採購單   
      CALL cl_set_toolbaritem_visible("gen_aint510",FALSE)             #產生調撥單   
      CALL cl_set_toolbaritem_visible("upd_pmds052",FALSE)             #維護供應商貨日   
      CALL cl_set_toolbaritem_visible("upd_pmds081",FALSE)             #取回
      CALL cl_set_toolbaritem_visible("query_apmt880",FALSE)           #查詢入庫單   
      CALL cl_set_toolbaritem_visible("query_apmt870",FALSE)           #查詢驗退單   
      CALL cl_set_toolbaritem_visible("gen_pmdw",FALSE)                #維護進項發票信息   
      CALL cl_set_toolbaritem_visible("query_aapt110_01",FALSE)        #發票訊息查詢   
      CALL cl_set_toolbaritem_visible("demo",FALSE)                    #備註
   END IF
   #150608-00012#3 Add By Ken 150627(E)
   
   ###############
   #明細Action
   ###############
   
   #重新產生原始需求分配
   #apmt860 apmt862 才顯示
   IF g_argv[1] MATCHES '[24567]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("open_apmt860_02",FALSE)
   END IF
   
   #明細發票查詢
   #apmt860 apmt861 apmt862 apmt863 apmt880 apmt890 才顯示
   IF g_argv[1] MATCHES '[123467]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'
      CALL cl_set_toolbaritem_visible("query_detail_aapt110_01",FALSE)
   END IF
   
   #150608-00012#3 Add By Ken 150627(S)
   #apmt881、apmt891 明細全不顯示
   #IF (g_argv[1] = '16') OR (g_argv[1] = '17') THEN   
   IF (g_argv[1] = '16') OR (g_argv[1] = '17') OR (g_argv[1] = '18') THEN  #151104-00007#1 Add By Ken 151109 加g_argv[1]=18
      CALL cl_set_toolbaritem_visible("open_apmt860_02",FALSE)  #重新產生原始需求分配    
      CALL cl_set_toolbaritem_visible("open_apmt860_03",FALSE)  #維護多庫儲批資料              
      CALL cl_set_toolbaritem_visible("query_detail_aapt110_01",FALSE)   #明細發票查詢
   END IF
   #150608-00012#3 Add By Ken 150627(E)
END FUNCTION

################################################################################
# Descriptions...: 取前單據單號、前單據項次
# Memo...........: 前單據單號、前單據項次
#                  1.當單據性質 = (1.採購收貨單 或 3.採購收貨入庫單) 且 預約收貨單不為空
#                    => 前單據單號 = 收貨預約單號(pmdt206)、前單據項次 = 預約收貨項次(pmdt207)
#                  2.當單據性質 = (1.採購收貨單 或 3.採購收貨入庫單) 且 預約收貨單為空
#                    => 前單據單號 = 採購單號(pmdt001)、前單據項次 = 採購項次(pmdt002)
#                  3.當單據性質 = 1.採購收貨單 或 2.無採購收貨單 或 3.採購收貨入庫單 或 4.無採購收貨入庫單
#                    => 前單據單號 = 收貨單號(pmdt027)、前單據項次 = 收貨項次(pmdt028)
# Usage..........: CALL apmt860_get_before_docno()
#                     RETURNING r_docno,r_seq
# Input parameter: 無
# Return code....: r_docno        前單據編號
#                : r_seq          前單據項次
# Date & Author..: 2015/01/14 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_get_before_docno()
DEFINE r_docno          LIKE pmdt_t.pmdtdocno    #前單據編號
DEFINE r_seq            LIKE pmdt_t.pmdtseq      #前單據項次

   LET r_docno = ''  #前單據編號
   LET r_seq   = ''  #前單據項次
   
   #1.當單據性質 = (1.採購收貨單 或 3.採購收貨入庫單) 且 預約收貨單不為空
   #  => 前單據單號 = 收貨預約單號(pmdt206)、前單據項次 = 預約收貨項次(pmdt207)
   IF g_pmds_m.pmds000 MATCHES '[13]' AND NOT cl_null(g_pmds_m.pmds200) THEN
      LET r_docno = g_pmdt_d[l_ac].pmdt206
      LET r_seq   = g_pmdt_d[l_ac].pmdt207
      RETURN r_docno,r_seq
   END IF
   
   #2.當單據性質 = (1.採購收貨單 或 3.採購收貨入庫單) 且 預約收貨單為空
   #  => 前單據單號 = 採購單號(pmdt001)、前單據項次 = 採購項次(pmdt002)
   IF g_pmds_m.pmds000 MATCHES '[13]' AND cl_null(g_pmds_m.pmds200) THEN
      LET r_docno = g_pmdt_d[l_ac].pmdt001
      LET r_seq   = g_pmdt_d[l_ac].pmdt002
      RETURN r_docno,r_seq
   END IF
   
   #3.當單據性質 = 5.採購驗退單 或 6.採購入庫單 或 7.採購倉退單
   #  => 前單據單號 = 收貨單號(pmdt027)、前單據項次 = 收貨項次(pmdt028)
   IF g_pmds_m.pmds000 MATCHES '[567]' AND cl_null(g_pmds_m.pmds200) THEN
      LET r_docno = g_pmdt_d[l_ac].pmdt027
      LET r_seq   = g_pmdt_d[l_ac].pmdt028
      RETURN r_docno,r_seq
   END IF
   
   RETURN r_docno,r_seq
END FUNCTION

################################################################################
# Descriptions...: 多庫儲批有更改時，更新單身資料
# Memo...........:
# Usage..........: CALL apmt860_upd_detail(p_pmdt020,p_pmdt053,p_pmdt202)
#                  RETURNING r_success
# Input parameter: p_pmdt020      收貨/入庫數量
#                : p_pmdt053      允收數量
#                : p_pmdt202      包裝收貨/入庫數量
# Return code....: r_success      True/False
# Date & Author..: 2015/01/14 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_upd_detail(p_pmdt020,p_pmdt053,p_pmdt202)
DEFINE p_pmdt020            LIKE pmdt_t.pmdt020    #收貨/入庫數量
DEFINE p_pmdt053            LIKE pmdt_t.pmdt053    #允收數量
DEFINE p_pmdt202            LIKE pmdt_t.pmdt202    #包裝收貨/入庫數量
DEFINE r_success            LIKE type_t.num5
DEFINE l_success            LIKE type_t.num5
DEFINE l_cnt                LIKE type_t.num5
DEFINE l_change             RECORD
       pmdt016              LIKE pmdt_t.pmdt016,   #限定庫位
       pmdt017              LIKE pmdt_t.pmdt017,   #限定儲位
       pmdt018              LIKE pmdt_t.pmdt018,   #限定批號
       pmdt020              LIKE pmdt_t.pmdt020,   #收貨/入庫數量
       pmdt024              LIKE pmdt_t.pmdt024,   #計價數量
       pmdt038              LIKE pmdt_t.pmdt038,   #未稅金額
       pmdt047              LIKE pmdt_t.pmdt047,   #稅額
       pmdt039              LIKE pmdt_t.pmdt039,   #未稅金額
       pmdt053              LIKE pmdt_t.pmdt053,   #允收數量
       pmdt055              LIKE pmdt_t.pmdt055,   #驗退量
       pmdt062              LIKE pmdt_t.pmdt062,   #多庫儲批
       pmdt089              LIKE pmdt_t.pmdt089,   #有效日期
       pmdt202              LIKE pmdt_t.pmdt202,   #包裝收貨/入庫數量
       pmdt219              LIKE pmdt_t.pmdt089    #製造日期
                            END RECORD
   LET r_success = TRUE
   
   #1.把值給Record
   INITIALIZE l_change.* TO NULL
   LET l_change.pmdt020 = p_pmdt020    #收貨/入庫數量
   LET l_change.pmdt053 = p_pmdt053    #允收數量
   LET l_change.pmdt202 = p_pmdt202    #包裝收貨/入庫數量
   
   #2.重新計算計價數量
   IF NOT cl_null(g_pmdt_d[l_ac].pmdt023) THEN
      CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,l_change.pmdt020)
         RETURNING l_success,l_change.pmdt024
   END IF
   
   #3.重新計算未稅、含稅、稅額
   CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq,
                             g_pmdt_d[l_ac].pmdt001,g_pmds_m.pmdssite,
                             g_pmds_m.pmds037,l_change.pmdt024,
                             g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt046)
      RETURNING l_change.pmdt038,l_change.pmdt047,l_change.pmdt039
   
   #4.計算使用者對該項次是否維護多筆多庫儲批資料
   #  判斷單身多庫儲批應給予 'N' Or 'Y'
   #  當筆數 >= 2 多庫儲批 = 'Y' ELSE 多庫儲批 = 'N'
   LET l_cnt = 0
   SELECT COUNT(pmduseq1) INTO l_cnt
     FROM pmdu_t    
    WHERE pmduent = g_enterprise
      AND pmdudocno = g_pmds_m.pmdsdocno
      AND pmduseq = g_pmdt_d[l_ac].pmdtseq
   IF l_cnt >= 2 THEN
      LET l_change.pmdt062 = 'Y'
      LET l_change.pmdt016 = '' #限定庫位
      LET l_change.pmdt017 = '' #限定儲位
      LET l_change.pmdt018 = '' #限定批號
      LET l_change.pmdt089 = '' #有效日期
      LET l_change.pmdt219 = '' #製造日期
   ELSE
      SELECT pmdu006,pmdu007,pmdu008,
             pmdu017,pmdu202
        INTO l_change.pmdt016,l_change.pmdt017,l_change.pmdt018,
             l_change.pmdt089,l_change.pmdt219
        FROM pmdu_t    
       WHERE pmduent = g_enterprise
         AND pmdudocno = g_pmds_m.pmdsdocno
         AND pmduseq = g_pmdt_d[l_ac].pmdtseq
      LET l_change.pmdt062 = 'N'
   END IF
   
   #5.計算驗退量
   #  當檢驗 = 'Y' 且 (無)採購收貨單
   #    驗退量 = 出貨數量 - 允收數量
   #  Else
   #    驗退量 = 0
   LET l_change.pmdt055 = 0
   IF g_pmdt_d[l_ac].pmdt026 = 'Y' AND g_argv[1] MATCHES '[12]' THEN
      LET l_change.pmdt055 = l_change.pmdt020 - l_change.pmdt053
   END IF
   
   #6.更新單身資料
   UPDATE pmdt_t
      SET pmdt016 = l_change.pmdt016,   #限定庫位
          pmdt017 = l_change.pmdt017,   #限定儲位
          pmdt018 = l_change.pmdt018,   #限定批號
          pmdt020 = l_change.pmdt020,   #收貨/入庫數量
          pmdt024 = l_change.pmdt024,   #計價數量
          pmdt038 = l_change.pmdt038,   #未稅金額
          pmdt047 = l_change.pmdt047,   #稅額
          pmdt039 = l_change.pmdt039,   #未稅金額
          pmdt053 = l_change.pmdt053,   #允收數量
          pmdt055 = l_change.pmdt055,   #驗退量
          pmdt062 = l_change.pmdt062,   #多庫儲批
          pmdt089 = l_change.pmdt089,   #有效日期
          pmdt202 = l_change.pmdt202,   #包裝收貨/入庫數量
          pmdt219 = l_change.pmdt219    #製造日期
    WHERE pmdtent = g_enterprise
      AND pmdtdocno = g_pmds_m.pmdsdocno
      AND pmdtseq = g_pmdt_d[l_ac].pmdtseq
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Upd pmdt_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #6.產生原始需求分配明細
   CALL s_apmt860_gen_pmdv(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
      RETURNING l_success
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 檢查庫位
# Memo...........:
# Usage..........: CALL apmt860_chk_pmdt016()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success       True/False
# Date & Author..: 2015/01/15 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_chk_pmdt016()
DEFINE r_success   LIKE type_t.num5
DEFINE l_success   LIKE type_t.num5

   LET r_success = TRUE
   
   #產品特徵
   IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
      LET g_pmdt_d[l_ac].pmdt007 = ' '
   END IF
   
   #1.檢查庫位是否存在庫位基本資料檢查
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_pmdt_d[l_ac].pmdt016
   #160318-00025#21  by 07900 --add-str
   LET g_errshow = TRUE #是否開窗                   
   LET g_chkparam.err_str[1] ="aim-00065:sub-01302|aini001|",cl_get_progname("aini001",g_lang,"2"),"|:EXEPROGaini001"
   #160318-00025#21  by 07900 --add-end
   IF NOT cl_chk_exist("v_inaa001_9") THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #2.倉退時 輸入的商品編號+產品特徵+庫存管理特徵+庫位必須存在[T:庫存明細檔]中
   IF g_pmds_m.pmds000 = '7' THEN
      # 2-1.檢查儲位
      IF NOT cl_null(g_pmdt_d[l_ac].pmdt017) THEN
         IF NOT apmt860_chk_pmdt017() THEN
            LET r_success = FALSE
            RETURN r_success 
         END IF
      END IF
      
      # 2-2.檢查是否存在庫存明細檔中
      LET l_success = ''
      CALL s_apmt860_chk_inag(g_pmds_m.pmdssite,      g_pmdt_d[l_ac].pmdt006,
                              g_pmdt_d[l_ac].pmdt007, g_pmdt_d[l_ac].pmdt063,
                              g_pmdt_d[l_ac].pmdt016, g_pmdt_d[l_ac].pmdt017,
                              g_pmdt_d[l_ac].pmdt018, g_pmdt_d[l_ac].pmdt019,
                              g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
   END IF
   
   #150518-00001#3--add by dongsz--str---
   #根據經營方式判斷庫位
   IF NOT s_inaa_chk(g_pmds_m.pmdssite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt210) THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150518-00001#3--add by dongsz--end---
   
   #校驗正確 儲位、批號必須清空
   IF g_pmds_m.pmds000 != '7' THEN
      LET g_pmdt_d[l_ac].pmdt017 = ' '
      
      IF g_argv[1] NOT MATCHES '[12346]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'    ##150613 by lori add
         LET g_pmdt_d[l_ac].pmdt018 = ' ' 
      END IF                                     ##150613 by lori add
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 檢查儲位
# Memo...........:
# Usage..........: CALL apmt860_chk_pmdt017()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success       True/False
# Date & Author..: 2015/01/15 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_chk_pmdt017()
DEFINE r_success           LIKE type_t.num5
DEFINE l_success           LIKE type_t.num5

   LET r_success = TRUE   
   
   #產品特徵
   IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
      LET g_pmdt_d[l_ac].pmdt007 = ' '
   END IF
   
   #1.檢查儲位基本資料
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_pmds_m.pmdssite
   LET g_chkparam.arg2 = g_pmdt_d[l_ac].pmdt016
   LET g_chkparam.arg3 = g_pmdt_d[l_ac].pmdt017
   IF NOT cl_chk_exist("v_inab002_1") THEN
      LET r_success = FALSE
      RETURN r_success  
   END IF
   
   #2.倉退時 輸入的商品編號+產品特徵+庫存管理特徵+庫位+儲位必須存在[T:庫存明細檔]中
   IF g_pmds_m.pmds000 = '7' THEN
      LET l_success = ''
      CALL s_apmt860_chk_inag(g_pmds_m.pmdssite,      g_pmdt_d[l_ac].pmdt006,
                              g_pmdt_d[l_ac].pmdt007, g_pmdt_d[l_ac].pmdt063,
                              g_pmdt_d[l_ac].pmdt016, g_pmdt_d[l_ac].pmdt017,
                              g_pmdt_d[l_ac].pmdt018, g_pmdt_d[l_ac].pmdt019,
                              g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
   END IF
   
   #校驗正確 批號必須清空
   IF g_pmds_m.pmds000 != '7' THEN
      IF g_argv[1] NOT MATCHES '[12346]' OR g_argv[1] = '22' THEN    #add by yangxf g_argv[1]='22'    ##150613 by lori add
         LET g_pmdt_d[l_ac].pmdt018 = ' '
      END IF                                   ##150613 by lori add  
   END IF
   
   RETURN r_success  
END FUNCTION

################################################################################
# Descriptions...: 檢查批號
# Memo...........:
# Usage..........: CALL apmt860_chk_pmdt018()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success       True/False
# Date & Author..: 2015/01/15 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_chk_pmdt018()
DEFINE r_success           LIKE type_t.num5
DEFINE l_success           LIKE type_t.num5

   LET r_success = TRUE   
   
   #產品特徵
   IF cl_null(g_pmdt_d[l_ac].pmdt007) THEN
      LET g_pmdt_d[l_ac].pmdt007 = ' '
   END IF
   
   #倉退時 輸入的商品編號+產品特徵+庫存管理特徵+庫位+儲位必須存在[T:庫存明細檔]中
   IF g_pmds_m.pmds000 = '7' THEN
      LET l_success = ''
      CALL s_apmt860_chk_inag(g_pmds_m.pmdssite,      g_pmdt_d[l_ac].pmdt006,
                              g_pmdt_d[l_ac].pmdt007, g_pmdt_d[l_ac].pmdt063,
                              g_pmdt_d[l_ac].pmdt016, g_pmdt_d[l_ac].pmdt017,
                              g_pmdt_d[l_ac].pmdt018, g_pmdt_d[l_ac].pmdt019,
                              g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success  
      END IF
   END IF
   
   #150507-00001#4 150529 By pomelo add(S)
   IF g_pmds_m.pmds000 MATCHES '[12346]' AND
      NOT cl_null(g_pmdt_d[l_ac].pmdt006) AND
      NOT cl_null(g_pmdt_d[l_ac].pmdt018)  THEN
      IF NOT s_lot_out_chk(g_pmds_m.pmdssite,g_pmds_m.pmdsdocno,
                           g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                           g_pmdt_d[l_ac].pmdt018) THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   #150507-00001#4 150529 By pomelo add(E)
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 修改單價
# Memo...........:
# Usage..........: CALL apmt860_upd_price()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/16 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_upd_price()
DEFINE l_insert      BOOLEAN
DEFINE l_lock_sw     LIKE type_t.chr1                #單身鎖住否
DEFINE ls_keys       DYNAMIC ARRAY OF VARCHAR(500)
DEFINE l_n           LIKE type_t.num5
DEFINE l_cmd         LIKE type_t.chr1
DEFINE l_success     LIKE type_t.num5
DEFINE l_cnt         LIKE type_t.num5   #151112-00010#1 151116 by sakura add

   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   CALL apmt860_show()
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      INPUT ARRAY g_pmdt4_d FROM s_detail4.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = FALSE, 
                 DELETE ROW = FALSE,
                 APPEND ROW = FALSE)

         BEFORE INPUT
            CALL apmt860_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_detail_idx)
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_pmdt4_d.getLength()
         
         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
          
            CALL s_transaction_begin()
            OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN apmt860_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CLOSE apmt860_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            
            LET g_rec_b = g_pmdt4_d.getLength()
            
            IF g_rec_b >= l_ac AND g_pmdt4_d[l_ac].pmdtseq IS NOT NULL THEN 
               LET l_cmd='u'
               LET g_pmdt4_d_t.* = g_pmdt4_d[l_ac].*  #BACKUP
               LET g_pmdt4_d_o.* = g_pmdt4_d[l_ac].*  #BACKUP
               CALL apmt860_set_entry_b(l_cmd)
               CALL cl_set_comp_required("pmdt0361",TRUE)   #151112-00010#1 151116 by sakura add
               CALL apmt860_set_no_entry_b(l_cmd)
               IF NOT apmt860_lock_b("pmdt_t1","'4'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH apmt860_price INTO g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt206, 
                      g_pmdt_d[l_ac].pmdt207,g_pmdt_d[l_ac].pmdt027,g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt216, 
                      g_pmdt_d[l_ac].pmdt217,g_pmdt_d[l_ac].pmdt001,g_pmdt_d[l_ac].pmdt002,g_pmdt_d[l_ac].pmdt003, 
                      g_pmdt_d[l_ac].pmdt004,g_pmdt_d[l_ac].pmdt005,g_pmdt_d[l_ac].pmdt200,g_pmdt_d[l_ac].pmdt006, 
                      g_pmdt_d[l_ac].pmdt007,g_pmdt_d[l_ac].pmdt025,g_pmdt_d[l_ac].pmdt201,g_pmdt_d[l_ac].pmdt202, 
                      g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt024, 
                      g_pmdt_d[l_ac].pmdt036,g_pmdt_d[l_ac].pmdt218,g_pmdt_d[l_ac].pmdt044,g_pmdt_d[l_ac].pmdt046, 
                      g_pmdt_d[l_ac].pmdt037,g_pmdt_d[l_ac].pmdt038,g_pmdt_d[l_ac].pmdt039,g_pmdt_d[l_ac].pmdt047, 
                      g_pmdt_d[l_ac].pmdt026,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017, 
                      g_pmdt_d[l_ac].pmdt018,g_pmdt_d[l_ac].pmdt063,g_pmdt_d[l_ac].pmdt052,g_pmdt_d[l_ac].pmdt051, 
                      g_pmdt_d[l_ac].pmdt059,g_pmdt_d[l_ac].pmdt203,g_pmdt_d[l_ac].pmdt204,g_pmdt_d[l_ac].pmdt205, 
                      g_pmdt_d[l_ac].pmdt214,g_pmdt_d[l_ac].pmdt215,g_pmdt_d[l_ac].pmdt208,g_pmdt_d[l_ac].pmdt209, 
                      g_pmdt_d[l_ac].pmdt210,g_pmdt_d[l_ac].pmdt211,g_pmdt_d[l_ac].pmdt212,g_pmdt_d[l_ac].pmdt213, 
                      g_pmdt_d[l_ac].pmdtorga,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,g_pmdt_d[l_ac].pmdt055, 
                      g_pmdt_d[l_ac].pmdt060,g_pmdt_d[l_ac].pmdt061,g_pmdt_d[l_ac].pmdt084,g_pmdt_d[l_ac].pmdt219, 
                      g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt088,g_pmdt4_d[l_ac].pmdtseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = '' 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  LET g_bfill = "N"
                  CALL apmt860_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
             
         AFTER FIELD pmdt0361
             IF NOT cl_ap_chk_range(g_pmdt4_d[l_ac].pmdt0361,"0.000","1","","","azz-00079",1) THEN
                LET g_pmdt4_d[l_ac].pmdt0361 = g_pmdt4_d_o.pmdt0361
                NEXT FIELD CURRENT
             END IF
             IF NOT cl_null(g_pmdt4_d[l_ac].pmdt0361) THEN
                IF g_pmdt4_d[l_ac].pmdt0361 <> g_pmdt4_d_o.pmdt0361 OR cl_null(g_pmdt4_d_o.pmdt0361) THEN
                   #151112-00010#1 151116 by sakura add(S)
                   #為退廠單：控卡單據走批號自動沖減且商品的批號自動編碼時,單價不可以修改
                   IF g_argv[1] = '7' THEN
                      IF apmt860_chk_lot(l_cmd) THEN
                         #單價容差率控卡
                         IF NOT s_apm_price_get_stan025_chk(g_pmdt_d[l_ac].pmdt212,g_pmdt4_d[l_ac].pmdt0361,g_pmdt4_d[l_ac].pmdt0441) THEN
                            LET g_pmdt4_d[l_ac].pmdt0361 = g_pmdt4_d_o.pmdt0361
                         END IF
                      ELSE
                         LET l_cnt = 0
                         SELECT COUNT(*) INTO l_cnt
                           FROM imaf_t
                          WHERE imafent = g_enterprise
                            AND imafsite = 'ALL'
                            AND imaf001 = g_pmdt4_d[l_ac].pmdt0061
                            AND imaf061 = '1'   #批號控管方式=1.必須有批號
                            AND imaf062 = 'Y'   #批號自動編碼=Y
                            AND imaf063 <> ' '  #批號編碼方式不為空值
                         IF l_cnt >= 1 THEN
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = 'apm-01036'
                            LET g_errparam.extend = ""
                            LET g_errparam.popup = TRUE
                            CALL cl_err()                         
                            LET g_pmdt4_d[l_ac].pmdt0361 = g_pmdt4_d_o.pmdt0361
                         END IF
                      END IF
                   ELSE
                   #151112-00010#1 151116 by sakura add(S)
                      #150506-00032#10 150527 by sakura add---STR
                      #單價容差率控卡
                      IF NOT s_apm_price_get_stan025_chk(g_pmdt_d[l_ac].pmdt212,g_pmdt4_d[l_ac].pmdt0361,g_pmdt4_d[l_ac].pmdt0441) THEN
                         LET g_pmdt4_d[l_ac].pmdt0361 = g_pmdt4_d_o.pmdt0361
                      END IF
                      #150506-00032#10 150527 by sakura add---END
                   END IF   #151112-00010#1 151116 by sakura add
                   #取得未稅金額、稅額、含稅金額
                   CALL s_apmt860_get_amount(g_pmds_m.pmdsdocno,       g_pmdt4_d[l_ac].pmdtseq,
                                             g_pmdt4_d[l_ac].pmdt0011, g_pmds_m.pmdssite,
                                             g_pmds_m.pmds037,         g_pmdt4_d[l_ac].pmdt0241,
                                             g_pmdt4_d[l_ac].pmdt0361, g_pmdt4_d[l_ac].pmdt0461)
                      RETURNING g_pmdt4_d[l_ac].pmdt0381,g_pmdt4_d[l_ac].pmdt0471,g_pmdt4_d[l_ac].pmdt0391
                END IF
             END IF
             LET g_pmdt4_d_o.pmdt0361 = g_pmdt4_d[l_ac].pmdt0361
             LET g_pmdt4_d_o.pmdt0381 = g_pmdt4_d[l_ac].pmdt0381
             LET g_pmdt4_d_o.pmdt0471 = g_pmdt4_d[l_ac].pmdt0471
             LET g_pmdt4_d_o.pmdt0391 = g_pmdt4_d[l_ac].pmdt0391
             
          ON ROW CHANGE 
             IF INT_FLAG THEN
                INITIALIZE g_errparam TO NULL 
                LET g_errparam.extend = '' 
                LET g_errparam.code   = 9001 
                LET g_errparam.popup  = FALSE 
                CALL cl_err()
                LET INT_FLAG = 0
                LET g_pmdt4_d[l_ac].* = g_pmdt4_d_t.*
                CLOSE apmt860_pmdt
                CALL s_transaction_end('N','0')
                EXIT DIALOG 
             END IF
             
             IF l_lock_sw = 'Y' THEN
                INITIALIZE g_errparam TO NULL 
                LET g_errparam.extend = '' 
                LET g_errparam.code   = -263 
                LET g_errparam.popup  = TRUE 
                CALL cl_err()
                LET g_pmdt4_d[l_ac].* = g_pmdt4_d_t.*
             ELSE
                UPDATE pmdt_t
                   SET pmdt036 = g_pmdt4_d[l_ac].pmdt0361,   #單價
                       pmdt038 = g_pmdt4_d[l_ac].pmdt0381,   #未稅金額
                       pmdt039 = g_pmdt4_d[l_ac].pmdt0391,   #含稅金額
                       pmdt047 = g_pmdt4_d[l_ac].pmdt0471    #稅額
                 WHERE pmdtent = g_enterprise
                   AND pmdtdocno = g_pmds_m.pmdsdocno
                   AND pmdtseq = g_pmdt4_d_t.pmdtseq
                   
                CASE
                   WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                      INITIALIZE g_errparam TO NULL 
                      LET g_errparam.extend = "pmdt_t" 
                      LET g_errparam.code   = "std-00009" 
                      LET g_errparam.popup  = TRUE 
                      CALL cl_err()
                      CALL s_transaction_end('N','0')
                      LET g_pmdt4_d[l_ac].* = g_pmdt4_d_t.*
                   WHEN SQLCA.sqlcode #其他錯誤
                      INITIALIZE g_errparam TO NULL 
                      LET g_errparam.extend = "pmdt_t" 
                      LET g_errparam.code   = SQLCA.sqlcode 
                      LET g_errparam.popup  = TRUE 
                      CALL cl_err()
                      CALL s_transaction_end('N','0')
                      LET g_pmdt4_d[l_ac].* = g_pmdt4_d_t.*
                   OTHERWISE
                      INITIALIZE gs_keys TO NULL 
                      LET gs_keys[1] = g_pmds_m.pmdsdocno
                      LET gs_keys_bak[1] = g_pmdsdocno_t
                      LET gs_keys[2] = g_pmdt4_d[g_detail_idx].pmdtseq
                      LET gs_keys_bak[2] = g_pmdt4_d_t.pmdtseq
                      CALL apmt860_update_b('pmdt_t',gs_keys,gs_keys_bak,"'4'")
                      #資料多語言用-增/改
                END CASE
                
                #判斷key是否有改變
                INITIALIZE ls_keys TO NULL
                IF NOT (g_pmdt4_d[g_detail_idx].pmdtseq = g_pmdt4_d_t.pmdtseq) THEN
                   LET ls_keys[01] = g_pmds_m.pmdsdocno
                   LET ls_keys[ls_keys.getLength()+1] = g_pmdt4_d_t.pmdtseq
                   CALL apmt860_key_update_b(ls_keys,'pmdt_t')
                END IF
                
                #修改歷程記錄
                LET g_log1 = util.JSON.stringify(g_pmds_m),util.JSON.stringify(g_pmdt4_d_t)
                LET g_log2 = util.JSON.stringify(g_pmds_m),util.JSON.stringify(g_pmdt4_d[l_ac])
                IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                   CALL s_transaction_end('N','0')
                END IF
             END IF
            
          AFTER ROW
             LET l_ac = ARR_CURR()
             IF INT_FLAG THEN
                INITIALIZE g_errparam TO NULL 
                LET g_errparam.extend = '' 
                LET g_errparam.code   = 9001 
                LET g_errparam.popup  = FALSE 
                CALL cl_err()
                LET INT_FLAG = 0
                IF l_cmd = 'u' THEN
                   LET g_pmdt4_d[l_ac].* = g_pmdt4_d_t.*
                END IF
                CLOSE apmt860_pmdt
                CALL s_transaction_end('N','0')
                EXIT DIALOG 
             END IF
             CALL apmt860_unlock_b("pmdt_t1","pmdt_t1")
             CALL s_transaction_end('Y','0')
             
      END INPUT
      
      ON ACTION accept    
         ACCEPT DIALOG
         
      ON ACTION cancel      #在dialog button (放棄)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
      
   END DIALOG 

   #重新計算整單的未稅、含稅總金額
   LET l_success = ''
   CALL s_transaction_begin()
   CALL s_apmt860_upd_pmds(g_pmds_m.pmdsdocno)
      RETURNING l_success,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046
   IF l_success THEN
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
   
   CLOSE apmt860_cl
   LET INT_FLAG = FALSE
   
END FUNCTION

################################################################################
# Descriptions...: 維護扣帳日期
# Memo...........:
# Usage..........: CALL apmt860_upd_pmds001()
#                     RETURNING r_success
# Input parameter: 無
# Return code....: r_success        True/Fale
# Date & Author..: 2015/01/16 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_upd_pmds001()
DEFINE r_success    LIKE type_t.num5
DEFINE l_pmdsmoddt  LIKE pmds_t.pmdsmoddt
DEFINE l_gzsz008    LIKE gzsz_t.gzsz008
DEFINE l_forupd_sql STRING

   LET r_success = TRUE
   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN apmt860_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      LET r_success = FALSE
      RETURN r_success
   END IF

   #顯示最新的資料
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,
       g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,
       g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101,
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,
       g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,
       g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,
       g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc,
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc,
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
    
   CALL apmt860_show()
    
   INPUT BY NAME g_pmds_m.pmds001 ATTRIBUTE(WITHOUT DEFAULTS)
      BEFORE INPUT
         LET g_pmds_m_t.* = g_pmds_m.*
         LET g_pmds_m_o.* = g_pmds_m.*
         
      AFTER FIELD pmds001
         IF NOT cl_null(g_pmds_m.pmds001) THEN
            IF g_pmds_m.pmds001 != g_pmds_m_o.pmds001 OR cl_null(g_pmds_m_o.pmds001) THEN
               #151120-00003#1 20151125 mark by beckxie---S
               ##扣帳日期不可以小於輸入的單據日期
               #IF g_pmds_m.pmds001 < g_pmds_m.pmdsdocdt THEN
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = 'apm-00783'
               #   LET g_errparam.extend = ""
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               #   LET g_pmds_m.pmds001 = g_pmds_m_o.pmds001
               #   NEXT FIELD CURRENT
               #END IF
               #151120-00003#1 20151125 mark by beckxie---E
               #151130-00019#1 20151203  add by beckxie---S
               IF g_pmds_m.pmds001 > g_today THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-01042'   #扣帳日期不可大於系統日期！
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_pmds_m.pmds001 = g_pmds_m_t.pmds001
                  DISPLAY g_pmds_m.pmds001 TO pmds001
                  NEXT FIELD CURRENT
               END IF
               #151130-00019#1 20151203  add by beckxie---E
               #維護的日期不可小於成本關帳日
               LET l_gzsz008 = cl_get_para(g_enterprise,g_pmds_m.pmdssite,'S-MFG-0031')
               IF g_pmds_m.pmds001 <= l_gzsz008 THEN
                  LET r_success = FALSE
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'sub-00306'
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_pmds_m.pmds001 = g_pmds_m_o.pmds001
                  NEXT FIELD CURRENT
               END IF
               
            END IF
         END IF
         LET g_pmds_m_o.pmds001 = g_pmds_m.pmds001
      
      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG THEN
            LET INT_FLAG = FALSE
            LET r_success = FALSE
            CLOSE apmt860_cl
            RETURN r_success
         END IF
         #151005-00003#1 過帳前檢查參數&上月份盤點流程是否完成 20151021 add by beckxie---S
         IF NOT s_beforeinv_chk(g_pmds_m.pmdssite,g_pmds_m.pmds001) THEN
            NEXT FIELD CURRENT
         END IF
         #151005-00003#1 過帳前檢查參數&上月份盤點流程是否完成 20151021 add by beckxie---E
   END INPUT
   
   LET l_pmdsmoddt = cl_get_current()
   UPDATE pmds_t
      SET pmds001 = g_pmds_m.pmds001,
          pmdsmodid = g_user,
          pmdsmoddt = l_pmdsmoddt
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = g_pmds_m.pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Upd pmds_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      LET r_success = FALSE
      RETURN r_success
   END IF

   CLOSE apmt860_cl
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: 維護供應商出貨日
# Memo...........:
# Usage..........: CALL apmt860_upd_pmds052()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/16 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_upd_pmds052()
DEFINE l_pmdsmoddt  LIKE pmds_t.pmdsmoddt

   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   CALL s_transaction_begin()
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN apmt860_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #顯示最新的資料
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,
       g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,
       g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101,
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,
       g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,
       g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,
       g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc,
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc,
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
    
   CALL apmt860_show()
   
   INPUT BY NAME g_pmds_m.pmds052  ATTRIBUTE(WITHOUT DEFAULTS)

      AFTER FIELD pmds052
      
      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG THEN
            LET INT_FLAG = FALSE
            CLOSE apmt860_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
   END INPUT
   
   LET l_pmdsmoddt = cl_get_current()
   UPDATE pmds_t
      SET pmds052 = g_pmds_m.pmds052,
          pmdsmodid = g_user,
          pmdsmoddt = l_pmdsmoddt
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = g_pmds_m.pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Upd pmds_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CLOSE apmt860_cl
   CALL s_transaction_end('Y','0')

END FUNCTION

################################################################################
# Descriptions...: 維護取回日期
# Memo...........:
# Usage..........: CALL apmt860_upd_pmds081()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/16 By pomelo
# Modify.........:
################################################################################
PUBLIC FUNCTION apmt860_upd_pmds081()
DEFINE l_pmdsmoddt      LIKE pmds_t.pmdsmoddt

   IF g_pmds_m.pmdsdocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   CALL s_transaction_begin()
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN apmt860_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #顯示最新的資料
   EXECUTE apmt860_master_referesh USING g_pmds_m.pmdsdocno INTO g_pmds_m.pmdssite,g_pmds_m.pmdsdocdt,
       g_pmds_m.pmds001,g_pmds_m.pmdsdocno,g_pmds_m.pmds200,g_pmds_m.pmds006,g_pmds_m.pmds011,g_pmds_m.pmds002,
       g_pmds_m.pmds003,g_pmds_m.pmdsstus,g_pmds_m.pmds007,g_pmds_m.pmds008,g_pmds_m.pmds009,g_pmds_m.pmds010,
       g_pmds_m.pmds052,g_pmds_m.pmds100,g_pmds_m.pmds081,g_pmds_m.pmds045,g_pmds_m.pmds021,g_pmds_m.pmds022,
       g_pmds_m.pmds023,g_pmds_m.pmds024,g_pmds_m.pmds048,g_pmds_m.pmds049,g_pmds_m.pmds031,g_pmds_m.pmds032,
       g_pmds_m.pmds037,g_pmds_m.pmds038,g_pmds_m.pmds033,g_pmds_m.pmds034,g_pmds_m.pmds035,g_pmds_m.pmds101,
       g_pmds_m.pmds102,g_pmds_m.pmds000,g_pmds_m.pmds014,g_pmds_m.pmds043,g_pmds_m.pmds044,g_pmds_m.pmds046,
       g_pmds_m.pmdsownid,g_pmds_m.pmdsowndp,g_pmds_m.pmdscrtid,g_pmds_m.pmdscrtdp,g_pmds_m.pmdscrtdt,
       g_pmds_m.pmdsmodid,g_pmds_m.pmdsmoddt,g_pmds_m.pmdscnfid,g_pmds_m.pmdscnfdt,g_pmds_m.pmdspstid,
       g_pmds_m.pmdspstdt,g_pmds_m.pmdssite_desc,g_pmds_m.pmds002_desc,g_pmds_m.pmds003_desc,g_pmds_m.pmds007_desc,
       g_pmds_m.pmds008_desc,g_pmds_m.pmds009_desc,g_pmds_m.pmds031_desc,g_pmds_m.pmds032_desc,g_pmds_m.pmds037_desc,
       g_pmds_m.pmdsownid_desc,g_pmds_m.pmdsowndp_desc,g_pmds_m.pmdscrtid_desc,g_pmds_m.pmdscrtdp_desc,
       g_pmds_m.pmdsmodid_desc,g_pmds_m.pmdscnfid_desc,g_pmds_m.pmdspstid_desc
    
   CALL apmt860_show()
    
   INPUT BY NAME g_pmds_m.pmds081 ATTRIBUTE(WITHOUT DEFAULTS)
      
      AFTER FIELD pmds081
      
      AFTER INPUT
         #若取消則直接結束
         IF INT_FLAG THEN
            LET INT_FLAG = FALSE
            CLOSE apmt860_cl
            CALL s_transaction_end('N','0')
            RETURN
         END IF
   END INPUT

   LET l_pmdsmoddt = cl_get_current()
   UPDATE pmds_t
      SET pmds081 = g_pmds_m.pmds081,
          pmdsmodid = g_user,
          pmdsmoddt = l_pmdsmoddt
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = g_pmds_m.pmdsdocno

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Upd pmds_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CLOSE apmt860_cl
   CALL s_transaction_end('Y','0')

END FUNCTION

################################################################################
# Descriptions...: 當為多庫儲批資料時，數量與多庫儲總數量不相同
# Memo...........:
# Usage..........: CALL apmt860_for_apmt860_03()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/16 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_for_apmt860_03()
DEFINE p_type    LIKE type_t.chr1       #檢查的欄位類型
DEFINE l_cnt     LIKE type_t.num5
DEFINE l_b_docno LIKE pmdt_t.pmdtdocno  #前單據單號
DEFINE l_b_seq   LIKE pmdt_t.pmdtseq    #前單據項次
DEFINE l_success LIKE type_t.num5
DEFINE l_pmdt001 LIKE pmdt_t.pmdt001
DEFINE l_pmdt002 LIKE pmdt_t.pmdt002
DEFINE l_pmdt020 LIKE pmdt_t.pmdt020    #該項次可輸入的最大數量
DEFINE l_sum     RECORD
       pmdu010   LIKE pmdu_t.pmdu010,   #收貨數量
       pmdu013   LIKE pmdu_t.pmdu013,   #允收數量
       pmdu201   LIKE pmdu_t.pmdu201    #包裝數量
                 END RECORD

   #1.多庫儲批由'Y'改成'N'
   #  刪除多庫儲批資料，多庫儲批欄位 = 'N'
   IF g_pmdt_d[l_ac].pmdt062 = 'N' AND g_pmdt_d_o.pmdt062 = 'Y' THEN
      CALL s_apmt860_del_pmdu(g_pmds_m.pmdsdocno,g_pmdt_d[l_ac].pmdtseq)
         RETURNING l_success
      LET g_pmdt_d[l_ac].pmdt062 = 'N'
   END IF

   #2.當多庫儲 = 'N'
   IF g_pmdt_d[l_ac].pmdt062 = 'N' THEN
      #151207-00021#6 160106 By pomelo mark(S)
      #LET l_cnt = 0
      #SELECT COUNT(pmdtseq) INTO l_cnt
      #  FROM pmdt_t,pmdu_t
      # WHERE pmdtent = pmduent
      #    AND pmdtdocno = pmdudocno
      #    AND pmdtseq = pmduseq
      #    AND (pmdu201 != g_pmdt_d[l_ac].pmdt202
      #     OR pmdu010 != g_pmdt_d[l_ac].pmdt020
      #     OR pmdu013 != g_pmdt_d[l_ac].pmdt053)
      #IF l_cnt >= 0 THEN
      #151207-00021#6 160106 By pomelo mark(E)
      #151207-00021#6 160106 By pomelo add(S)
      IF (g_pmdt_d[l_ac].pmdt202 != g_pmdt_d_o.pmdt202 OR cl_null(g_pmdt_d_o.pmdt202)) OR
         (g_pmdt_d[l_ac].pmdt020 != g_pmdt_d_o.pmdt020 OR cl_null(g_pmdt_d_o.pmdt020)) OR
         (g_pmdt_d[l_ac].pmdt052 != g_pmdt_d_o.pmdt053 OR cl_null(g_pmdt_d_o.pmdt053)) THEN
      #151207-00021#6 160106 By pomelo add(E)
         IF NOT s_apmt860_ins_pmdu(g_pmds_m.pmds000,      g_pmds_m.pmdsdocno,    g_pmdt_d[l_ac].pmdtsite, #150514-00002#1 150514 By pomelo add pmdtsite
                                   g_pmdt_d[l_ac].pmdtseq,g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt007,
                                   g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,
                                   g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt020,g_pmdt_d[l_ac].pmdt027,
                                   g_pmdt_d[l_ac].pmdt028,g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt054,
                                   g_pmdt_d[l_ac].pmdt055,g_pmdt_d[l_ac].pmdt062,g_pmdt_d[l_ac].pmdt063,
                                   g_pmdt_d[l_ac].pmdt088,g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt201,
                                   g_pmdt_d[l_ac].pmdt202,g_pmdt_d[l_ac].pmdt219) THEN
         END IF
      END IF
      CALL apmt860_pmdt055_default()
      RETURN
   END IF
   
   #3.加總多庫儲批總數量
   INITIALIZE l_sum.* TO NULL
   SELECT COALESCE(SUM(pmdu010),0),COALESCE(SUM(pmdu013),0),COALESCE(SUM(pmdu201),0)
     INTO l_sum.pmdu010,l_sum.pmdu013,l_sum.pmdu201
     FROM pmdu_t
    WHERE pmduent = g_enterprise
      AND pmdudocno = g_pmds_m.pmdsdocno
      AND pmduseq = g_pmdt_d[l_ac].pmdtseq
      
   #4.(多庫儲批總包裝數量 != 包裝數量 或
   #  多庫儲批總出貨數量 != 出貨數量 或
   #  (無)採購出貨單 且 檢驗 = 'Y' 且多庫儲批總允收數量 != 允收數量) 或
   #  多庫儲批由'N'改成'Y'
   IF (l_sum.pmdu201 != g_pmdt_d[l_ac].pmdt202 OR
      l_sum.pmdu010 != g_pmdt_d[l_ac].pmdt020 OR
      (g_argv[1] MATCHES '[12]' AND g_pmdt_d[l_ac].pmdt026 = 'Y' AND
      l_sum.pmdu013 != g_pmdt_d[l_ac].pmdt053)) OR
      g_pmdt_d[l_ac].pmdt062 = 'Y' AND g_pmdt_d_o.pmdt062 = 'N' THEN
      #4-1.取前單據
      LET l_b_docno = ''
      LET l_b_seq = ''
      CALL apmt860_get_before_docno() RETURNING l_b_docno,l_b_seq
      LET l_pmdt020 = 0
      IF g_argv[1] MATCHES '[567]' THEN  
         LET l_pmdt001 = g_pmdt_d[l_ac].pmdt027
         LET l_pmdt002 = g_pmdt_d[l_ac].pmdt028
      ELSE
         LET l_pmdt001 = g_pmdt_d[l_ac].pmdt001
         LET l_pmdt002 = g_pmdt_d[l_ac].pmdt002
      END IF
      

      CALL s_apmt860_chk_pmdt020('1', g_pmds_m.pmds000,   g_pmdt_d[l_ac].pmdtsite,
                                 g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,
                                 l_pmdt001,               l_pmdt002,
                                 g_pmdt_d[l_ac].pmdt003,  g_pmdt_d[l_ac].pmdt004,
                                 g_pmdt_d[l_ac].pmdt006,  g_pmdt_d[l_ac].pmdt206,
                                 g_pmdt_d[l_ac].pmdt207,  0)
         RETURNING l_success,l_pmdt020

      
      CALL apmt860_03(g_pmds_m.pmdsdocno,      g_pmdt_d[l_ac].pmdtseq,    #單號、項次
                      g_pmdt_d[l_ac].pmdtsite, g_pmdt_d[l_ac].pmdt006,    #營運據點、商品編號
                      g_pmdt_d[l_ac].pmdt007,  g_pmdt_d[l_ac].pmdt019,    #產品特徵、收貨/入庫單位
                      g_pmdt_d[l_ac].pmdt020,  g_pmdt_d[l_ac].pmdt026,    #收貨/入庫數量、檢驗
                      g_pmdt_d[l_ac].pmdt053,  g_pmdt_d[l_ac].pmdt201,    #允收數量、包裝單位
                      g_pmdt_d[l_ac].pmdt202,  g_pmdt_d[l_ac].pmdt001,    #包裝數量、訂單單號
                      g_pmdt_d[l_ac].pmdt002,  l_pmdt020,                 #訂單項次、可輸入的最大數量
                      l_b_docno,               l_b_seq,                   #前單據單號、前單據項次
                      g_pmdt_d[l_ac].pmdt214)                             #採購方式  #160304-00027#1 160307 By pomelo add
         RETURNING l_success,g_pmdt_d[l_ac].pmdt020,
                   g_pmdt_d[l_ac].pmdt053,g_pmdt_d[l_ac].pmdt202
      DISPLAY BY NAME g_pmdt_d[l_ac].pmdt020 #151207-00021#1 Add By Ken 151209 修正開多庫儲批如只異動單筆時 數量帶回第一頁面不會寫入問題
                                        
      #4-2.計算使用者對該項次是否維護多筆多庫儲批資料
      #    判斷單身多庫儲批應給予 'N' Or 'Y'
      #    當筆數 >= 2 多庫儲批 = 'Y' ELSE 多庫儲批 = 'N'
      LET l_cnt = 0
      SELECT COUNT(pmduseq1) INTO l_cnt
        FROM pmdu_t    
       WHERE pmduent = g_enterprise
         AND pmdudocno = g_pmds_m.pmdsdocno
         AND pmduseq = g_pmdt_d[l_ac].pmdtseq
      IF l_cnt >= 2 THEN
         LET g_pmdt_d[l_ac].pmdt062 = 'Y'
         LET g_pmdt_d[l_ac].pmdt016 = '' #限定庫位
         LET g_pmdt_d[l_ac].pmdt017 = '' #限定儲位
         LET g_pmdt_d[l_ac].pmdt018 = '' #限定批號
         LET g_pmdt_d[l_ac].pmdt089 = '' #有效日期
         LET g_pmdt_d[l_ac].pmdt219 = '' #製造日期
         LET g_pmdt_d[l_ac].pmdt016_desc = ''
         LET g_pmdt_d[l_ac].pmdt017_desc = ''
      ELSE
         SELECT pmdu006,pmdu007,pmdu008,
                pmdu017,pmdu202
           INTO g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017,g_pmdt_d[l_ac].pmdt018,
                g_pmdt_d[l_ac].pmdt089,g_pmdt_d[l_ac].pmdt219
           FROM pmdu_t    
          WHERE pmduent = g_enterprise
            AND pmdudocno = g_pmds_m.pmdsdocno
            AND pmduseq = g_pmdt_d[l_ac].pmdtseq
         LET g_pmdt_d[l_ac].pmdt062 = 'N'
         LET g_pmdt_d[l_ac].pmdt016_desc = s_desc_get_stock_desc('',g_pmdt_d[l_ac].pmdt016)
         LET g_pmdt_d[l_ac].pmdt017_desc = s_desc_get_locator_desc(g_pmdt_d[l_ac].pmdtsite,g_pmdt_d[l_ac].pmdt016,g_pmdt_d[l_ac].pmdt017)
      END IF
   END IF
   
   #5.計算驗退數量
   CALL apmt860_pmdt055_default()
   
   #6.重新計算計價數量
   IF NOT cl_null(g_pmdt_d[l_ac].pmdt023) THEN
      CALL s_aooi250_convert_qty(g_pmdt_d[l_ac].pmdt006,g_pmdt_d[l_ac].pmdt019,g_pmdt_d[l_ac].pmdt023,g_pmdt_d[l_ac].pmdt020)
         RETURNING l_success,g_pmdt_d[l_ac].pmdt024
   END IF
END FUNCTION

################################################################################
# Descriptions...: 產生入庫/驗退單
# Memo...........:
# Usage..........: CALL apmt860_gen_apmt880_apmt870()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/16 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_apmt880_apmt870()
DEFINE l_ins_apmt880     LIKE type_t.num5     #新增入庫單
DEFINE l_ins_apmt870     LIKE type_t.num5     #新增驗退單
DEFINE l_cnt             LIKE type_t.num5
DEFINE l_success         LIKE type_t.num5
DEFINE l_doctype         LIKE rtai_t.rtai004
DEFINE l_docno_apmt880   LIKE pmds_t.pmdsdocno    #入庫單單據編號
DEFINE l_docno_apmt870   LIKE pmds_t.pmdsdocno    #驗退單單據編號
DEFINE la_param          RECORD
       prog              STRING,
       param             DYNAMIC ARRAY OF STRING
                         END RECORD
DEFINE ls_js             STRING
DEFINE l_sql             STRING
DEFINE l_pmds            RECORD
       pmdsent           LIKE pmds_t.pmdsent,     #企業編號
       pmdssite          LIKE pmds_t.pmdssite,    #營運據點
       pmdsdocno         LIKE pmds_t.pmdsdocno,   #單據單號
       pmdsdocdt         LIKE pmds_t.pmdsdocdt,   #單據日期
       pmds000           LIKE pmds_t.pmds000,     #單據性質
       pmds001           LIKE pmds_t.pmds001,     #扣帳日期
       pmds002           LIKE pmds_t.pmds002,     #申請人員
       pmds003           LIKE pmds_t.pmds003,     #申請部門
       pmds006           LIKE pmds_t.pmds006,     #來源單號
       pmds007           LIKE pmds_t.pmds007,     #採購供應商
       pmds008           LIKE pmds_t.pmds008,     #帳款供應商
       pmds009           LIKE pmds_t.pmds009,     #送貨供應商
       pmds010           LIKE pmds_t.pmds010,     #供應商送貨單號
       pmds011           LIKE pmds_t.pmds011,     #採購性質
       pmds014           LIKE pmds_t.pmds014,     #多角性質
       pmds021           LIKE pmds_t.pmds021,     #LC進口
       pmds022           LIKE pmds_t.pmds022,     #進口日期
       pmds023           LIKE pmds_t.pmds023,     #進口報單
       pmds024           LIKE pmds_t.pmds024,     #進口號碼
       pmds031           LIKE pmds_t.pmds031,     #付款條件
       pmds032           LIKE pmds_t.pmds032,     #交易條件
       pmds033           LIKE pmds_t.pmds033,     #稅別
       pmds034           LIKE pmds_t.pmds034,     #稅率
       pmds035           LIKE pmds_t.pmds035,     #單價含稅否
       pmds037           LIKE pmds_t.pmds037,     #幣別
       pmds038           LIKE pmds_t.pmds038,     #匯率
       pmds043           LIKE pmds_t.pmds043,     #採購總未稅金額
       pmds044           LIKE pmds_t.pmds044,     #採購總含稅金額
       pmds046           LIKE pmds_t.pmds046,     #採購總稅額
       pmds048           LIKE pmds_t.pmds048,     #內外購
       pmds049           LIKE pmds_t.pmds049,     #匯率計算基準
       pmdsownid         LIKE pmds_t.pmdsownid,   #資料所有者
       pmdsowndp         LIKE pmds_t.pmdsowndp,   #資料所有部門
       pmdscrtid         LIKE pmds_t.pmdscrtid,   #資料建立者
       pmdscrtdp         LIKE pmds_t.pmdscrtdp,   #資料建立部門
       pmdscrtdt         LIKE pmds_t.pmdscrtdt,   #資料創建日
       pmdsmodid         LIKE pmds_t.pmdsmodid,   #資料修改者
       pmdsmoddt         LIKE pmds_t.pmdsmoddt,   #最近修改日
       pmdsstus          LIKE pmds_t.pmdsstus     #狀態碼
                         END RECORD
DEFINE l_pmds_apmt880    RECORD
       pmdsent           LIKE pmds_t.pmdsent,     #企業編號
       pmdssite          LIKE pmds_t.pmdssite,    #營運據點
       pmdsdocno         LIKE pmds_t.pmdsdocno,   #單據單號
       pmdsdocdt         LIKE pmds_t.pmdsdocdt,   #單據日期
       pmds000           LIKE pmds_t.pmds000,     #單據性質
       pmds001           LIKE pmds_t.pmds001,     #扣帳日期
       pmds002           LIKE pmds_t.pmds002,     #申請人員
       pmds003           LIKE pmds_t.pmds003,     #申請部門
       pmds006           LIKE pmds_t.pmds006,     #來源單號
       pmds007           LIKE pmds_t.pmds007,     #採購供應商
       pmds008           LIKE pmds_t.pmds008,     #帳款供應商
       pmds009           LIKE pmds_t.pmds009,     #送貨供應商
       pmds010           LIKE pmds_t.pmds010,     #供應商送貨單號
       pmds011           LIKE pmds_t.pmds011,     #採購性質
       pmds014           LIKE pmds_t.pmds014,     #多角性質
       pmds021           LIKE pmds_t.pmds021,     #LC進口
       pmds022           LIKE pmds_t.pmds022,     #進口日期
       pmds023           LIKE pmds_t.pmds023,     #進口報單
       pmds024           LIKE pmds_t.pmds024,     #進口號碼
       pmds031           LIKE pmds_t.pmds031,     #付款條件
       pmds032           LIKE pmds_t.pmds032,     #交易條件
       pmds033           LIKE pmds_t.pmds033,     #稅別
       pmds034           LIKE pmds_t.pmds034,     #稅率
       pmds035           LIKE pmds_t.pmds035,     #單價含稅否
       pmds037           LIKE pmds_t.pmds037,     #幣別
       pmds038           LIKE pmds_t.pmds038,     #匯率
       pmds043           LIKE pmds_t.pmds043,     #採購總未稅金額
       pmds044           LIKE pmds_t.pmds044,     #採購總含稅金額
       pmds046           LIKE pmds_t.pmds046,     #採購總稅額
       pmds048           LIKE pmds_t.pmds048,     #內外購
       pmds049           LIKE pmds_t.pmds049,     #匯率計算基準
       pmdsownid         LIKE pmds_t.pmdsownid,   #資料所有者
       pmdsowndp         LIKE pmds_t.pmdsowndp,   #資料所有部門
       pmdscrtid         LIKE pmds_t.pmdscrtid,   #資料建立者
       pmdscrtdp         LIKE pmds_t.pmdscrtdp,   #資料建立部門
       pmdscrtdt         LIKE pmds_t.pmdscrtdt,   #資料創建日
       pmdsmodid         LIKE pmds_t.pmdsmodid,   #資料修改者
       pmdsmoddt         LIKE pmds_t.pmdsmoddt,   #最近修改日
       pmdsstus          LIKE pmds_t.pmdsstus     #狀態碼
                         END RECORD
DEFINE l_pmds_apmt870    RECORD
       pmdsent           LIKE pmds_t.pmdsent,     #企業編號
       pmdssite          LIKE pmds_t.pmdssite,    #營運據點
       pmdsdocno         LIKE pmds_t.pmdsdocno,   #單據單號
       pmdsdocdt         LIKE pmds_t.pmdsdocdt,   #單據日期
       pmds000           LIKE pmds_t.pmds000,     #單據性質
       pmds001           LIKE pmds_t.pmds001,     #扣帳日期
       pmds002           LIKE pmds_t.pmds002,     #申請人員
       pmds003           LIKE pmds_t.pmds003,     #申請部門
       pmds006           LIKE pmds_t.pmds006,     #來源單號
       pmds007           LIKE pmds_t.pmds007,     #採購供應商
       pmds008           LIKE pmds_t.pmds008,     #帳款供應商
       pmds009           LIKE pmds_t.pmds009,     #送貨供應商
       pmds010           LIKE pmds_t.pmds010,     #供應商送貨單號
       pmds011           LIKE pmds_t.pmds011,     #採購性質
       pmds014           LIKE pmds_t.pmds014,     #多角性質
       pmds021           LIKE pmds_t.pmds021,     #LC進口
       pmds022           LIKE pmds_t.pmds022,     #進口日期
       pmds023           LIKE pmds_t.pmds023,     #進口報單
       pmds024           LIKE pmds_t.pmds024,     #進口號碼
       pmds031           LIKE pmds_t.pmds031,     #付款條件
       pmds032           LIKE pmds_t.pmds032,     #交易條件
       pmds033           LIKE pmds_t.pmds033,     #稅別
       pmds034           LIKE pmds_t.pmds034,     #稅率
       pmds035           LIKE pmds_t.pmds035,     #單價含稅否
       pmds037           LIKE pmds_t.pmds037,     #幣別
       pmds038           LIKE pmds_t.pmds038,     #匯率
       pmds043           LIKE pmds_t.pmds043,     #採購總未稅金額
       pmds044           LIKE pmds_t.pmds044,     #採購總含稅金額
       pmds046           LIKE pmds_t.pmds046,     #採購總稅額
       pmds048           LIKE pmds_t.pmds048,     #內外購
       pmds049           LIKE pmds_t.pmds049,     #匯率計算基準
       pmdsownid         LIKE pmds_t.pmdsownid,   #資料所有者
       pmdsowndp         LIKE pmds_t.pmdsowndp,   #資料所有部門
       pmdscrtid         LIKE pmds_t.pmdscrtid,   #資料建立者
       pmdscrtdp         LIKE pmds_t.pmdscrtdp,   #資料建立部門
       pmdscrtdt         LIKE pmds_t.pmdscrtdt,   #資料創建日
       pmdsmodid         LIKE pmds_t.pmdsmodid,   #資料修改者
       pmdsmoddt         LIKE pmds_t.pmdsmoddt,   #最近修改日
       pmdsstus          LIKE pmds_t.pmdsstus     #狀態碼
                         END RECORD
   LET l_ins_apmt880 = TRUE
   LET l_ins_apmt870 = TRUE
   
   #1.檢查單號是否存在
   IF g_pmds_m.pmdsdocno IS NULL  THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   #2.檢查入庫單相關資訊
   #  2-1.檢查是否有未確認入庫單
   LET l_cnt = 0
   SELECT COUNT(pmdtseq) INTO l_cnt
     FROM pmds_t,pmdt_t
    WHERE pmdsent = pmdtent
      AND pmdsdocno = pmdtdocno
      AND pmdsent = g_enterprise
      AND pmdsstus = 'N'
      AND pmds000 = '6'
      AND (pmds006 = g_pmds_m.pmdsdocno
       OR pmdt027 = g_pmds_m.pmdsdocno)
   IF l_cnt >= 1 THEN
      LET l_ins_apmt880 = FALSE
      #此(無)採購收貨單已產生一筆未確認的採購入庫單，不可重複產生！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00784"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   #  2-2.檢查檢查是否入庫量可以自動產生單據
   #      允收數量(pmdt053) - 已入庫量(pmdt054) - 非作廢入庫量
   LET l_cnt = 0
   SELECT COUNT(pmdtdocno) INTO l_cnt
     FROM pmdt_t a
     #150814-00005#1 By 150817 By pomelo mark(S) 效能調整
     #LEFT OUTER JOIN(SELECT c.pmdtent, c.pmdt027, c.pmdt028,
     #                       COALESCE(SUM(c.pmdt020),0) sumpmdt020
     #                  FROM pmds_t b, pmdt_t c
     #                 WHERE b.pmdsent = c.pmdtent
     #                   AND b.pmdsdocno = c.pmdtdocno
     #                   AND b.pmds000 = '6'
     #                   AND NOT(b.pmdsstus = 'X' OR b.pmdsstus = 'S')
     #                 GROUP BY c.pmdtent, c.pmdt027, c.pmdt028) d
     #  ON a.pmdtent = d.pmdtent
     # AND a.pmdtdocno = d.pmdt027
     # AND a.pmdtseq =  d.pmdt028
     #150814-00005#1 By 150817 By pomelo mark(E) 效能調整
    WHERE a.pmdtent = g_enterprise
      AND a.pmdtdocno = g_pmds_m.pmdsdocno
      AND 1 <= (COALESCE(a.pmdt053,0) - COALESCE(a.pmdt054,0) -
                COALESCE((SELECT COALESCE(SUM(c.pmdt020),0)
                            FROM pmds_t b, pmdt_t c
                           WHERE b.pmdsent = c.pmdtent
                             AND b.pmdsdocno = c.pmdtdocno
                             AND b.pmds000 = '6'
                             AND b.pmdsstus NOT IN ('X','S')
                             AND a.pmdtent = c.pmdtent
                             AND a.pmdtdocno = c.pmdt027
                             AND a.pmdtseq = c.pmdt028
                           GROUP BY c.pmdtent, c.pmdt027, c.pmdt028),0))
   IF l_cnt = 0 THEN
      LET l_ins_apmt880 = FALSE
      #此(無)採購收貨單單身沒有任何一筆有允收數量，不可產生採購入庫單！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00785"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   #3.檢查驗退單相關資訊
   #  3-1.檢查是否有未確認驗退單
   LET l_cnt = 0 
   SELECT COUNT(pmdtseq) INTO l_cnt
     FROM pmds_t,pmdt_t
    WHERE pmdsent = pmdtent
      AND pmdsdocno = pmdtdocno
      AND pmdsent = g_enterprise
      AND pmdsstus = 'N'
      AND pmds000 = '5'
      AND (pmds006 = g_pmds_m.pmdsdocno
       OR pmdt027 = g_pmds_m.pmdsdocno)
   IF l_cnt >= 1 THEN
      LET l_ins_apmt870 = FALSE
      #此(無)採購收貨單已產生一筆未確認的採購驗退單，不可重複產生！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00786"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   #  3-2.檢查檢查是否驗退量可以自動產生單據
   #      收貨數量(pmdt020) - 允收數量(pmdt053) - 非作廢驗退量
   LET l_cnt = 0
   SELECT COUNT(pmdtdocno) INTO l_cnt
     FROM pmdt_t a
     #150814-00005#1 By 150817 By pomelo mark(S) 效能調整
     #LEFT OUTER JOIN(SELECT c.pmdtent, c.pmdt027, c.pmdt028,
     #                       COALESCE(SUM(c.pmdt020),0) sumpmdt020
     #                  FROM pmds_t b, pmdt_t c
     #                 WHERE b.pmdsent = c.pmdtent
     #                   AND b.pmdsdocno = c.pmdtdocno
     #                   AND b.pmds000 = '5'
     #                   AND b.pmdsstus = 'X'
     #                 GROUP BY c.pmdtent, c.pmdt027, c.pmdt028) d
     #  ON a.pmdtent = d.pmdtent
     # AND a.pmdtdocno = d.pmdt027
     # AND a.pmdtseq =  d.pmdt028
     #150814-00005#1 By 150817 By pomelo mark(E) 效能調整
    WHERE a.pmdtent = g_enterprise
      AND a.pmdtdocno = g_pmds_m.pmdsdocno
      AND 1 <= (COALESCE(a.pmdt020,0) - COALESCE(a.pmdt053,0) -
                COALESCE(((SELECT COALESCE(SUM(c.pmdt020),0)
                             FROM pmds_t b, pmdt_t c
                            WHERE b.pmdsent = c.pmdtent
                              AND b.pmdsdocno = c.pmdtdocno
                              AND b.pmds000 = '5'
                              AND b.pmdsstus = 'X'
                              AND a.pmdtent = c.pmdtent
                              AND a.pmdtdocno = c.pmdt027
                              AND a.pmdtseq = c.pmdt028
                            GROUP BY c.pmdtent, c.pmdt027, c.pmdt028)),0))
   IF l_cnt = 0 THEN
      LET l_ins_apmt870 = FALSE
      #此(無)採購收貨單單身沒有任何一筆有驗退量，不可產生採購驗退單！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00787"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   #4.是否有單據可以產生
   IF l_ins_apmt870 = FALSE AND l_ins_apmt880 = FALSE THEN
      RETURN
   END IF
   
   #5.lock 單據
   CALL s_transaction_begin()
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt860_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #6.產生單據單頭
   INITIALIZE l_pmds.* TO NULL
   INITIALIZE l_pmds_apmt870.* TO NULL
   INITIALIZE l_pmds_apmt880.* TO NULL
   SELECT pmdsent, pmdssite, pmdsdocno, pmdsdocdt,
          pmds006, pmds007,  pmds008,   pmds009,
          pmds010, pmds011,  pmds014,   pmds021,
          pmds022, pmds023,  pmds024,   pmds031,
          pmds032, pmds033,  pmds034,   pmds035,
          pmds037, pmds038,  pmds043,   pmds044,
          pmds046, pmds048,  pmds049
     INTO l_pmds.pmdsent, l_pmds.pmdssite, l_pmds.pmdsdocno, l_pmds.pmdsdocdt,
          l_pmds.pmds006, l_pmds.pmds007,  l_pmds.pmds008,   l_pmds.pmds009,
          l_pmds.pmds010, l_pmds.pmds011,  l_pmds.pmds014,   l_pmds.pmds021,
          l_pmds.pmds022, l_pmds.pmds023,  l_pmds.pmds024,   l_pmds.pmds031,
          l_pmds.pmds032, l_pmds.pmds033,  l_pmds.pmds034,   l_pmds.pmds035,
          l_pmds.pmds037, l_pmds.pmds038,  l_pmds.pmds043,   l_pmds.pmds044,
          l_pmds.pmds046, l_pmds.pmds048,  l_pmds.pmds049
     FROM pmds_t
    WHERE pmdsent = g_enterprise
      AND pmdsdocno = g_pmds_m.pmdsdocno
      
   #6-1.當有驗退數量時，才產生驗退單
   IF l_ins_apmt870 THEN
      LET l_pmds_apmt870.* = l_pmds.*
      #6-1-1.預設單據的單別 
      LET l_success = ''
      LET l_doctype = ''
      CALL s_arti200_get_def_doc_type(l_pmds.pmdssite,'apmt870','2')
         RETURNING l_success, l_doctype
      IF l_success = FALSE THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #6-1-2.給值
      LET l_pmds_apmt870.pmdsdocno = l_doctype          #單號
      LET l_pmds_apmt870.pmdsdocdt = g_today            #單據日期
      LET l_pmds_apmt870.pmds000   = '5'                #單據性質
      LET l_pmds_apmt870.pmds002   = g_user             #驗退人員
      LET l_pmds_apmt870.pmds003   = g_dept             #驗退部門
      LET l_pmds_apmt870.pmds006   = g_pmds_m.pmdsdocno #收貨單號
      LET l_pmds_apmt870.pmdsownid = g_user             #資料所有者
      LET l_pmds_apmt870.pmdsowndp = g_dept             #資料所有部門
      LET l_pmds_apmt870.pmdscrtid = g_user             #資料建立者
      LET l_pmds_apmt870.pmdscrtdp = g_dept             #資料建立部門
      LET l_pmds_apmt870.pmdscrtdt = cl_get_current()   #資料建立日期
      LET l_pmds_apmt870.pmdsstus  = "N"                #狀態碼
      
      #6-1-3.產生單據編號
      LET l_success = ''
      CALL s_aooi200_gen_docno(l_pmds_apmt870.pmdssite,l_pmds_apmt870.pmdsdocno,g_today,'apmt870') 
         RETURNING l_success,l_pmds_apmt870.pmdsdocno
      
      #6-1-4.Insert pmds_t
      INSERT INTO pmds_t(pmdsent,   pmdssite,  pmdsdocno, pmdsdocdt,
                         pmds000,   pmds001,   pmds002,   pmds003,
                         pmds006,   pmds007,   pmds008,   pmds009,
                         pmds010,   pmds011,   pmds014,   pmds021,
                         pmds022,   pmds023,   pmds024,   pmds031,
                         pmds032,   pmds033,   pmds034,   pmds035,
                         pmds037,   pmds038,   pmds043,   pmds044,
                         pmds046,   pmds048,   pmds049,   pmdsownid,
                         pmdsowndp, pmdscrtid, pmdscrtdp, pmdscrtdt,
                         pmdsmodid, pmdsmoddt, pmdsstus)
         VALUES(l_pmds_apmt870.pmdsent,   l_pmds_apmt870.pmdssite,  l_pmds_apmt870.pmdsdocno, l_pmds_apmt870.pmdsdocdt,
                l_pmds_apmt870.pmds000,   l_pmds_apmt870.pmds001,   l_pmds_apmt870.pmds002,   l_pmds_apmt870.pmds003,
                l_pmds_apmt870.pmds006,   l_pmds_apmt870.pmds007,   l_pmds_apmt870.pmds008,   l_pmds_apmt870.pmds009,
                l_pmds_apmt870.pmds010,   l_pmds_apmt870.pmds011,   l_pmds_apmt870.pmds014,   l_pmds_apmt870.pmds021,
                l_pmds_apmt870.pmds022,   l_pmds_apmt870.pmds023,   l_pmds_apmt870.pmds024,   l_pmds_apmt870.pmds031,
                l_pmds_apmt870.pmds032,   l_pmds_apmt870.pmds033,   l_pmds_apmt870.pmds034,   l_pmds_apmt870.pmds035,
                l_pmds_apmt870.pmds037,   l_pmds_apmt870.pmds038,   l_pmds_apmt870.pmds043,   l_pmds_apmt870.pmds044,
                l_pmds_apmt870.pmds046,   l_pmds_apmt870.pmds048,   l_pmds_apmt870.pmds049,   l_pmds_apmt870.pmdsownid,
                l_pmds_apmt870.pmdsowndp, l_pmds_apmt870.pmdscrtid, l_pmds_apmt870.pmdscrtdp, l_pmds_apmt870.pmdscrtdt,
                l_pmds_apmt870.pmdsmodid, l_pmds_apmt870.pmdsmoddt, l_pmds_apmt870.pmdsstus)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #6-1-5.紀錄驗退單單號
      LET l_docno_apmt870 = l_pmds_apmt870.pmdsdocno
   END IF
   
   #7-1.當有允收數量時，才產生入庫單
   IF l_ins_apmt880 THEN
      LET l_pmds_apmt880.* = l_pmds.*
      #7-1-1.預設單據的單別 
      LET l_success = ''
      LET l_doctype = ''
      CALL s_arti200_get_def_doc_type(l_pmds.pmdssite,'apmt880','2')
         RETURNING l_success, l_doctype
      IF l_success = FALSE THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #7-1-2.給值
      LET l_pmds_apmt880.pmdsdocno = l_doctype          #單號
      LET l_pmds_apmt880.pmdsdocdt = g_today            #單據日期
      LET l_pmds_apmt880.pmds000   = '6'                #單據性質
      LET l_pmds_apmt880.pmds001   = g_today            #扣帳日期
      LET l_pmds_apmt880.pmds002   = g_user             #入庫人員
      LET l_pmds_apmt880.pmds003   = g_dept             #入庫部門
      LET l_pmds_apmt880.pmds006   = g_pmds_m.pmdsdocno #收貨單號
      LET l_pmds_apmt880.pmdsownid = g_user             #資料所有者
      LET l_pmds_apmt880.pmdsowndp = g_dept             #資料所有部門
      LET l_pmds_apmt880.pmdscrtid = g_user             #資料建立者
      LET l_pmds_apmt880.pmdscrtdp = g_dept             #資料建立部門
      LET l_pmds_apmt880.pmdscrtdt = cl_get_current()   #資料建立日期
      LET l_pmds_apmt880.pmdsstus  = "N"                #狀態碼
      
      #7-1-3.產生單據編號
      LET l_success = ''
      CALL s_aooi200_gen_docno(l_pmds_apmt880.pmdssite,l_pmds_apmt880.pmdsdocno,g_today,'apmt880') 
         RETURNING l_success,l_pmds_apmt880.pmdsdocno
      
      #7-1-4.Insert pmds_t
      INSERT INTO pmds_t(pmdsent,   pmdssite,  pmdsdocno, pmdsdocdt,
                         pmds000,   pmds001,   pmds002,   pmds003,
                         pmds006,   pmds007,   pmds008,   pmds009,
                         pmds010,   pmds011,   pmds014,   pmds021,
                         pmds022,   pmds023,   pmds024,   pmds031,
                         pmds032,   pmds033,   pmds034,   pmds035,
                         pmds037,   pmds038,   pmds043,   pmds044,
                         pmds046,   pmds048,   pmds049,   pmdsownid,
                         pmdsowndp, pmdscrtid, pmdscrtdp, pmdscrtdt,
                         pmdsmodid, pmdsmoddt, pmdsstus)
         VALUES(l_pmds_apmt880.pmdsent,   l_pmds_apmt880.pmdssite,  l_pmds_apmt880.pmdsdocno, l_pmds_apmt880.pmdsdocdt,
                l_pmds_apmt880.pmds000,   l_pmds_apmt880.pmds001,   l_pmds_apmt880.pmds002,   l_pmds_apmt880.pmds003,
                l_pmds_apmt880.pmds006,   l_pmds_apmt880.pmds007,   l_pmds_apmt880.pmds008,   l_pmds_apmt880.pmds009,
                l_pmds_apmt880.pmds010,   l_pmds_apmt880.pmds011,   l_pmds_apmt880.pmds014,   l_pmds_apmt880.pmds021,
                l_pmds_apmt880.pmds022,   l_pmds_apmt880.pmds023,   l_pmds_apmt880.pmds024,   l_pmds_apmt880.pmds031,
                l_pmds_apmt880.pmds032,   l_pmds_apmt880.pmds033,   l_pmds_apmt880.pmds034,   l_pmds_apmt880.pmds035,
                l_pmds_apmt880.pmds037,   l_pmds_apmt880.pmds038,   l_pmds_apmt880.pmds043,   l_pmds_apmt880.pmds044,
                l_pmds_apmt880.pmds046,   l_pmds_apmt880.pmds048,   l_pmds_apmt880.pmds049,   l_pmds_apmt880.pmdsownid,
                l_pmds_apmt880.pmdsowndp, l_pmds_apmt880.pmdscrtid, l_pmds_apmt880.pmdscrtdp, l_pmds_apmt880.pmdscrtdt,
                l_pmds_apmt880.pmdsmodid, l_pmds_apmt880.pmdsmoddt, l_pmds_apmt880.pmdsstus)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #7-1-5.紀錄入庫單單號
      LET l_docno_apmt880 = l_pmds_apmt880.pmdsdocno
   END IF
   
   #8.準備產生單身需要的SQL
   # 8-1.項次最大值
   LET l_sql = "SELECT COALESCE(MAX(pmdtseq),0)+1",
               "  FROM pmdt_t",
               " WHERE pmdtent = ",g_enterprise,
               "   AND pmdtdocno = ?"
   PREPARE apmt860_gen_detail_maxseq FROM l_sql
   
   #9.產生入庫單單身
   IF l_ins_apmt880 THEN
      LET l_success = ''
      CALL apmt860_gen_apmt880_detail(l_docno_apmt880)
        RETURNING l_success
      IF l_success = FALSE THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
   END IF
   
   #10.產生驗退單單身
   IF l_ins_apmt870 THEN
      LET l_success = ''
      CALL apmt860_gen_apmt870_detail(l_docno_apmt870)
        RETURNING l_success
      IF l_success = FALSE THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
   END IF
   
   #11.執行到這步驟，表示前面動作都成功，關閉transaction
   CALL s_transaction_end('Y','0')
   
   #12.串查成功產生的入庫單號
   IF NOT cl_null(l_docno_apmt880) THEN
      LET la_param.prog = 'apmt880'
      LET la_param.param[1] = l_docno_apmt880
      LET ls_js = util.JSON.stringify(la_param)
      CALL cl_cmdrun(ls_js)
   END IF
   
   #13.串查成功產生的驗退單號
   IF NOT cl_null(l_docno_apmt870) THEN
      LET la_param.prog = 'apmt870'
      LET la_param.param[1] = l_docno_apmt870
      LET ls_js = util.JSON.stringify(la_param)
      CALL cl_cmdrun(ls_js)
   END IF
END FUNCTION

################################################################################
# Descriptions...: 產生驗退單單身
# Memo...........:
# Usage..........: CALL apmt860_gen_apmt870_detail(p_pmdtdocno)
#                  RETURNING r_success
# Input parameter: p_pmdtdocno    驗退單單號
# Return code....: r_success      True/False
# Date & Author..: 2015/01/19 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_apmt870_detail(p_pmdtdocno)
DEFINE p_pmdtdocno       LIKE pmdt_t.pmdtdocno
DEFINE r_success         LIKE type_t.num5
DEFINE l_success         LIKE type_t.num5
DEFINE l_sum_pmdt020     LIKE pmdt_t.pmdt020
DEFINE l_sql             STRING
DEFINE l_pmds            RECORD
       pmds043           LIKE pmds_t.pmds043,   #採購總未稅金額
       pmds044           LIKE pmds_t.pmds044,   #採購總含稅金額
       pmds046           LIKE pmds_t.pmds046    #採購總稅額
                         END RECORD
DEFINE l_pmdt            RECORD
       pmdtent           LIKE pmdt_t.pmdtent,   #企業編號
       pmdtsite          LIKE pmdt_t.pmdtsite,  #營運據點
       pmdtdocno         LIKE pmdt_t.pmdtdocno, #單據編號
       pmdtseq           LIKE pmdt_t.pmdtseq,   #項次
       pmdt001           LIKE pmdt_t.pmdt001,   #採購單號
       pmdt002           LIKE pmdt_t.pmdt002,   #採購項次
       pmdt003           LIKE pmdt_t.pmdt003,   #採購項序
       pmdt004           LIKE pmdt_t.pmdt004,   #採購分批序
       pmdt005           LIKE pmdt_t.pmdt005,   #子件特性
       pmdt006           LIKE pmdt_t.pmdt006,   #料件編號
       pmdt007           LIKE pmdt_t.pmdt007,   #產品特徵
       pmdt016           LIKE pmdt_t.pmdt016,   #庫位
       pmdt017           LIKE pmdt_t.pmdt017,   #儲位
       pmdt018           LIKE pmdt_t.pmdt018,   #批號
       pmdt019           LIKE pmdt_t.pmdt019,   #收貨/入庫單位
       pmdt020           LIKE pmdt_t.pmdt020,   #收貨/入庫數量
       pmdt023           LIKE pmdt_t.pmdt023,   #計價單位
       pmdt024           LIKE pmdt_t.pmdt024,   #計價數量
       pmdt025           LIKE pmdt_t.pmdt025,   #緊急度
       pmdt026           LIKE pmdt_t.pmdt026,   #檢驗否
       pmdt027           LIKE pmdt_t.pmdt027,   #收貨單號
       pmdt028           LIKE pmdt_t.pmdt028,   #收貨項次
       pmdt036           LIKE pmdt_t.pmdt036,   #單價
       pmdt037           LIKE pmdt_t.pmdt037,   #稅率
       pmdt038           LIKE pmdt_t.pmdt038,   #未稅金額
       pmdt039           LIKE pmdt_t.pmdt039,   #含稅金額
       pmdt044           LIKE pmdt_t.pmdt044,   #取出單價
       pmdt046           LIKE pmdt_t.pmdt046,   #稅別
       pmdt047           LIKE pmdt_t.pmdt047,   #稅額
       pmdt051           LIKE pmdt_t.pmdt051,   #理由碼
       pmdt052           LIKE pmdt_t.pmdt052,   #狀態碼
       pmdt053           LIKE pmdt_t.pmdt053,   #允收數量
       pmdt054           LIKE pmdt_t.pmdt054,   #已入庫量
       pmdt055           LIKE pmdt_t.pmdt055,   #驗退量
       pmdt062           LIKE pmdt_t.pmdt062,   #多庫儲批收貨入庫
       pmdt063           LIKE pmdt_t.pmdt063,   #庫存管理特徵
       pmdt084           LIKE pmdt_t.pmdt084,   #須自立AP否
       pmdt088           LIKE pmdt_t.pmdt088,   #存貨備註
       pmdt089           LIKE pmdt_t.pmdt089,   #有效日期
       pmdt200           LIKE pmdt_t.pmdt200,   #商品條碼
       pmdt201           LIKE pmdt_t.pmdt201,   #收貨包裝單位
       pmdt202           LIKE pmdt_t.pmdt202,   #收貨包裝數量
       pmdt203           LIKE pmdt_t.pmdt203,   #採購組織
       pmdt204           LIKE pmdt_t.pmdt204,   #採購中心
       pmdt205           LIKE pmdt_t.pmdt205,   #要貨組織
       pmdt208           LIKE pmdt_t.pmdt208,   #採購渠道
       pmdt209           LIKE pmdt_t.pmdt209,   #渠道性質
       pmdt210           LIKE pmdt_t.pmdt210,   #經營方式
       pmdt211           LIKE pmdt_t.pmdt211,   #結算方式
       pmdt212           LIKE pmdt_t.pmdt212,   #合約編號
       pmdt213           LIKE pmdt_t.pmdt213,   #協議編號
       pmdt218           LIKE pmdt_t.pmdt218,   #採購價
       pmdt219           LIKE pmdt_t.pmdt219,   #製造日期
       pmdt227           LIKE pmdt_t.pmdt227,   #補貨規格說明 150710-00016#7 Add By Ken 150713
       #pmdt214           LIKE pmdt_t.pmdt214    #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
       #170216-00026#1 17/02/17 By 08171 --s add
       pmdt214           LIKE pmdt_t.pmdt214,   #採購方式
       pmdt215           LIKE pmdt_t.pmdt215    #最終收貨組織
       #170216-00026#1 17/02/17 By 08171 --e add
                         END RECORD
   LET r_success = TRUE
   
   #1.準備SQL
   # 1-1.單身有驗退數量
   LET l_sql = "SELECT pmdtent, pmdtsite, pmdtdocno, pmdtseq,",
               "       pmdt001, pmdt002,  pmdt003,   pmdt004,",
               "       pmdt005, pmdt006,  pmdt007,   pmdt016,",
               "       pmdt017, pmdt018,  pmdt019,   COALESCE(pmdt020,0) - COALESCE(pmdt053,0),",
               "       pmdt023, pmdt024,  pmdt025,   pmdt026,",
               "       pmdt027, pmdt028,  pmdt036,   pmdt037,",
               "       pmdt038, pmdt039,  pmdt044,   pmdt046,",
               "       pmdt047, pmdt051,  pmdt052,   pmdt053,",
               "       pmdt054, pmdt055,  pmdt062,   pmdt063,",
               "       pmdt084, pmdt088,  pmdt089,   pmdt200,",
               "       pmdt201, pmdt202,  pmdt203,   pmdt204,",
               "       pmdt205, pmdt208,  pmdt209,   pmdt210,",
               "       pmdt211, pmdt212,  pmdt213,   pmdt218,",
               "       pmdt219, pmdt227,  ",   #補貨規格說明 150710-00016#7 Add By Ken 150713
               #"       pmdt214  ",             #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
               "       pmdt214,pmdt215  ",      #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
               "  FROM pmdt_t",
               " WHERE pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'",
               "   AND COALESCE(pmdt020,0) - COALESCE(pmdt053,0) >= 1"     #單身有驗退數量的
   PREPARE apmt860_gen_apmt870_dpre FROM l_sql
   DECLARE apmt860_gen_apmt870_dcs CURSOR FOR apmt860_gen_apmt870_dpre
   # 1-2.非作廢驗退單數量
   LET l_sql = "SELECT COALESCE(SUM(pmdt020),0)",
               "  FROM pmds_t,pmdt_t",
               " WHERE pmdsent = pmdtent",
               "   AND pmdsdocno = pmdtdocno",
               "   AND pmdsent = ",g_enterprise,
               "   AND pmds000 = '5'",
               "   AND pmdsstus != 'X'",
               "   AND pmdt027 = '",g_pmds_m.pmdsdocno,"'",   #出貨單號
               "   AND pmdt028 = ?"                           #出貨項次
   PREPARE apmt860_sum_apmt870 FROM l_sql
   
   #2.撈出資料
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_apmt870_dcs
      INTO l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
           l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
           l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
           l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
           l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
           l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
           l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt044,   l_pmdt.pmdt046,
           l_pmdt.pmdt047, l_pmdt.pmdt051,  l_pmdt.pmdt052,   l_pmdt.pmdt053,
           l_pmdt.pmdt054, l_pmdt.pmdt055,  l_pmdt.pmdt062,   l_pmdt.pmdt063,
           l_pmdt.pmdt084, l_pmdt.pmdt088,  l_pmdt.pmdt089,   l_pmdt.pmdt200,
           l_pmdt.pmdt201, l_pmdt.pmdt202,  l_pmdt.pmdt203,   l_pmdt.pmdt204,
           l_pmdt.pmdt205, l_pmdt.pmdt208,  l_pmdt.pmdt209,   l_pmdt.pmdt210,
           l_pmdt.pmdt211, l_pmdt.pmdt212,  l_pmdt.pmdt213,   l_pmdt.pmdt218,
           l_pmdt.pmdt219, l_pmdt.pmdt227,  #補貨規格說明 150710-00016#7 Add By Ken 150713
           #l_pmdt.pmdt214                   #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
           l_pmdt.pmdt214, l_pmdt.pmdt215   #170216-00026#1 17/02/17 By 08171 add
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Foreach apmt860_gen_apmt870_dcs"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2-1.加總非作廢驗退數量
      LET l_sum_pmdt020 = 0
      EXECUTE apmt860_sum_apmt870 USING l_pmdt.pmdtseq
         INTO l_sum_pmdt020
         
      #2-2.給值
      LET l_pmdt.pmdt020 = l_pmdt.pmdt020 - l_sum_pmdt020     #驗退數量
      IF l_pmdt.pmdt020 = 0 THEN
         CONTINUE FOREACH
      END IF
      LET l_pmdt.pmdt027 = l_pmdt.pmdtdocno                   #收貨單號
      LET l_pmdt.pmdt028 = l_pmdt.pmdtseq                     #收貨單項次
      LET l_pmdt.pmdt053 = 0                                  #允收數量
      LET l_pmdt.pmdt054 = 0                                  #已入庫量
      LET l_pmdt.pmdt055 = 0                                  #驗退量
      LET l_pmdt.pmdt084 = 'N'                                #須自立AP
      LET l_pmdt.pmdtdocno = p_pmdtdocno                      #單據編號
      #項次
      EXECUTE apmt860_gen_detail_maxseq
         USING p_pmdtdocno INTO l_pmdt.pmdtseq
      
      #2-3.驗退數量轉成驗退包裝數量
      LET l_success = ''
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt201,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt202
      
      #2-4.驗退數量轉成驗退計價數量
      IF NOT cl_null(l_pmdt.pmdt023) THEN
         LET l_success = ''
         CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
            RETURNING l_success,l_pmdt.pmdt024
      END IF
      
      #2-5.該計算項次未稅金額、稅額、含稅金額
      CALL s_apmt860_get_amount(p_pmdtdocno,l_pmdt.pmdtseq,
                                l_pmdt.pmdt001,l_pmdt.pmdtsite,
                                g_pmds_m.pmds037,l_pmdt.pmdt024,
                                l_pmdt.pmdt036,l_pmdt.pmdt046)
         RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
      
      #2-6.Insert pmdt_t
      INSERT INTO pmdt_t(pmdtent, pmdtsite, pmdtdocno, pmdtseq,
                         pmdt001, pmdt002,  pmdt003,   pmdt004,
                         pmdt005, pmdt006,  pmdt007,   pmdt016,
                         pmdt017, pmdt018,  pmdt019,   pmdt020,
                         pmdt023, pmdt024,  pmdt025,   pmdt026,
                         pmdt027, pmdt028,  pmdt036,   pmdt037,
                         pmdt038, pmdt039,  pmdt044,   pmdt046,
                         pmdt047, pmdt051,  pmdt052,   pmdt053,
                         pmdt054, pmdt055,  pmdt062,   pmdt063,
                         pmdt084, pmdt088,  pmdt089,   pmdt200,
                         pmdt201, pmdt202,  pmdt203,   pmdt204,
                         pmdt205, pmdt208,  pmdt209,   pmdt210,
                         pmdt211, pmdt212,  pmdt213,   pmdt218,
                         pmdt219, pmdt227,  #補貨規格說明 150710-00016#7 Add By Ken 150713
                        #pmdt214 )          #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
                         pmdt214, pmdt215)  #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
         VALUES(l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
                l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
                l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
                l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
                l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
                l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
                l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt044,   l_pmdt.pmdt046,
                l_pmdt.pmdt047, l_pmdt.pmdt051,  l_pmdt.pmdt052,   l_pmdt.pmdt053,
                l_pmdt.pmdt054, l_pmdt.pmdt055,  l_pmdt.pmdt062,   l_pmdt.pmdt063,
                l_pmdt.pmdt084, l_pmdt.pmdt088,  l_pmdt.pmdt089,   l_pmdt.pmdt200,
                l_pmdt.pmdt201, l_pmdt.pmdt202,  l_pmdt.pmdt203,   l_pmdt.pmdt204,
                l_pmdt.pmdt205, l_pmdt.pmdt208,  l_pmdt.pmdt209,   l_pmdt.pmdt210,
                l_pmdt.pmdt211, l_pmdt.pmdt212,  l_pmdt.pmdt213,   l_pmdt.pmdt218,
                l_pmdt.pmdt219, l_pmdt.pmdt227,  #補貨規格說明 150710-00016#7 Add By Ken 150713
               #l_pmdt.pmdt214 )                 #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
                l_pmdt.pmdt214, l_pmdt.pmdt215)  #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
                
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Ins pmdt_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2-7.產生多庫儲批資料
      LET l_success = ''
      
      CALL s_apmt860_ins_pmdu('5',            p_pmdtdocno,    l_pmdt.pmdtsite,#150514-00002#1 150514 By pomelo add pmdtsite
                              l_pmdt.pmdtseq, l_pmdt.pmdt006, l_pmdt.pmdt007,
                              l_pmdt.pmdt016, l_pmdt.pmdt017, l_pmdt.pmdt018,
                              l_pmdt.pmdt019, l_pmdt.pmdt020, l_pmdt.pmdt027,
                              l_pmdt.pmdt028, l_pmdt.pmdt053, l_pmdt.pmdt054,
                              l_pmdt.pmdt055, l_pmdt.pmdt062, l_pmdt.pmdt063,
                              l_pmdt.pmdt088, l_pmdt.pmdt089, l_pmdt.pmdt201,
                              l_pmdt.pmdt202, l_pmdt.pmdt219)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2-8.產生原始需求分配明細
      CALL s_apmt860_gen_pmdv(l_pmdt.pmdtdocno,l_pmdt.pmdtseq)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      INITIALIZE l_pmdt.* TO NULL
   END FOREACH
   
   #3.重新計算整單的未稅、含稅總金額
   LET l_success = ''
   INITIALIZE l_pmds.* TO NULL
   CALL s_apmt860_upd_pmds(p_pmdtdocno)
      RETURNING l_success,l_pmds.pmds043,l_pmds.pmds044,l_pmds.pmds046
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 產生入庫單單身
# Memo...........:
# Usage..........: CALL apmt860_gen_apmt880_detail(p_pmdtdocno)
#                  RETURNING r_success
# Input parameter: p_pmdtdocno    入庫單單號
# Return code....: r_success      True/False
# Date & Author..: 2015/01/19 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_apmt880_detail(p_pmdtdocno)
DEFINE p_pmdtdocno       LIKE pmdt_t.pmdtdocno
DEFINE r_success         LIKE type_t.num5
DEFINE l_success         LIKE type_t.num5
DEFINE l_sum_pmdt020     LIKE pmdt_t.pmdt020
DEFINE l_sql             STRING
DEFINE l_pmds            RECORD
       pmds043           LIKE pmds_t.pmds043,   #採購總未稅金額
       pmds044           LIKE pmds_t.pmds044,   #採購總含稅金額
       pmds046           LIKE pmds_t.pmds046    #採購總稅額
                         END RECORD
DEFINE l_pmdt            RECORD
       pmdtent           LIKE pmdt_t.pmdtent,   #企業編號
       pmdtsite          LIKE pmdt_t.pmdtsite,  #營運據點
       pmdtdocno         LIKE pmdt_t.pmdtdocno, #單據編號
       pmdtseq           LIKE pmdt_t.pmdtseq,   #項次
       pmdt001           LIKE pmdt_t.pmdt001,   #採購單號
       pmdt002           LIKE pmdt_t.pmdt002,   #採購項次
       pmdt003           LIKE pmdt_t.pmdt003,   #採購項序
       pmdt004           LIKE pmdt_t.pmdt004,   #採購分批序
       pmdt005           LIKE pmdt_t.pmdt005,   #子件特性
       pmdt006           LIKE pmdt_t.pmdt006,   #料件編號
       pmdt007           LIKE pmdt_t.pmdt007,   #產品特徵
       pmdt016           LIKE pmdt_t.pmdt016,   #庫位
       pmdt017           LIKE pmdt_t.pmdt017,   #儲位
       pmdt018           LIKE pmdt_t.pmdt018,   #批號
       pmdt019           LIKE pmdt_t.pmdt019,   #收貨/入庫單位
       pmdt020           LIKE pmdt_t.pmdt020,   #收貨/入庫數量
       pmdt023           LIKE pmdt_t.pmdt023,   #計價單位
       pmdt024           LIKE pmdt_t.pmdt024,   #計價數量
       pmdt025           LIKE pmdt_t.pmdt025,   #緊急度
       pmdt026           LIKE pmdt_t.pmdt026,   #檢驗否
       pmdt027           LIKE pmdt_t.pmdt027,   #收貨單號
       pmdt028           LIKE pmdt_t.pmdt028,   #收貨項次
       pmdt036           LIKE pmdt_t.pmdt036,   #單價
       pmdt037           LIKE pmdt_t.pmdt037,   #稅率
       pmdt038           LIKE pmdt_t.pmdt038,   #未稅金額
       pmdt039           LIKE pmdt_t.pmdt039,   #含稅金額
       pmdt044           LIKE pmdt_t.pmdt044,   #取出單價
       pmdt046           LIKE pmdt_t.pmdt046,   #稅別
       pmdt047           LIKE pmdt_t.pmdt047,   #稅額
       pmdt051           LIKE pmdt_t.pmdt051,   #理由碼
       pmdt052           LIKE pmdt_t.pmdt052,   #狀態碼
       pmdt053           LIKE pmdt_t.pmdt053,   #允收數量
       pmdt054           LIKE pmdt_t.pmdt054,   #已入庫量
       pmdt055           LIKE pmdt_t.pmdt055,   #驗退量
       pmdt062           LIKE pmdt_t.pmdt062,   #多庫儲批收貨入庫
       pmdt063           LIKE pmdt_t.pmdt063,   #庫存管理特徵
       pmdt084           LIKE pmdt_t.pmdt084,   #須自立AP否
       pmdt088           LIKE pmdt_t.pmdt088,   #存貨備註
       pmdt089           LIKE pmdt_t.pmdt089,   #有效日期
       pmdt200           LIKE pmdt_t.pmdt200,   #商品條碼
       pmdt201           LIKE pmdt_t.pmdt201,   #收貨包裝單位
       pmdt202           LIKE pmdt_t.pmdt202,   #收貨包裝數量
       pmdt203           LIKE pmdt_t.pmdt203,   #採購組織
       pmdt204           LIKE pmdt_t.pmdt204,   #採購中心
       pmdt205           LIKE pmdt_t.pmdt205,   #要貨組織
       pmdt208           LIKE pmdt_t.pmdt208,   #採購渠道
       pmdt209           LIKE pmdt_t.pmdt209,   #渠道性質
       pmdt210           LIKE pmdt_t.pmdt210,   #經營方式
       pmdt211           LIKE pmdt_t.pmdt211,   #結算方式
       pmdt212           LIKE pmdt_t.pmdt212,   #合約編號
       pmdt213           LIKE pmdt_t.pmdt213,   #協議編號
       pmdt218           LIKE pmdt_t.pmdt218,   #採購價
       pmdt219           LIKE pmdt_t.pmdt219,   #製造日期
       pmdt227           LIKE pmdt_t.pmdt227,   #補貨規格說明 150710-00016#7 Add By Ken 150713
      #pmdt214           LIKE pmdt_t.pmdt214    #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
       pmdt214           LIKE pmdt_t.pmdt214,   #採購方式     #170216-00026#1 17/02/17 By 08171 add
       pmdt215           LIKE pmdt_t.pmdt215    #最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
                         END RECORD
   LET r_success = TRUE
   
   #1.準備SQL
   #  1-1.單身有允收數量
   LET l_sql = "SELECT pmdtent, pmdtsite, pmdtdocno, pmdtseq,",
               "       pmdt001, pmdt002,  pmdt003,   pmdt004,",
               "       pmdt005, pmdt006,  pmdt007,   pmdt016,",
               "       pmdt017, pmdt018,  pmdt019,   COALESCE(pmdt053,0) - COALESCE(pmdt054,0),",
               "       pmdt023, pmdt024,  pmdt025,   pmdt026,",
               "       pmdt027, pmdt028,  pmdt036,   pmdt037,",
               "       pmdt038, pmdt039,  pmdt044,   pmdt046,",
               "       pmdt047, pmdt051,  pmdt052,   pmdt053,",
               "       pmdt054, pmdt055,  pmdt062,   pmdt063,",
               "       pmdt084, pmdt088,  pmdt089,   pmdt200,",
               "       pmdt201, pmdt202,  pmdt203,   pmdt204,",
               "       pmdt205, pmdt208,  pmdt209,   pmdt210,",
               "       pmdt211, pmdt212,  pmdt213,   pmdt218,",
               "       pmdt219, pmdt227,  ",  #補貨規格說明 150710-00016#7 Add By Ken 150713
              #"       pmdt214 ",             #採購方式     160503-00033#1 Add By Ken 160506
               "       pmdt214,pmdt215 ",     #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171
               "  FROM pmdt_t",
               " WHERE pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'",
               "   AND COALESCE(pmdt053,0) - COALESCE(pmdt054,0) >= 1"     #單身有允收數量的
   PREPARE apmt860_gen_apmt880_dpre FROM l_sql
   DECLARE apmt860_gen_apmt880_dcs CURSOR FOR apmt860_gen_apmt880_dpre
   # 1-2.非作廢驗退單數量
   LET l_sql = "SELECT COALESCE(SUM(pmdt020),0)",
               "  FROM pmds_t,pmdt_t",
               " WHERE pmdsent = pmdtent",
               "   AND pmdsdocno = pmdtdocno",
               "   AND pmdsent = ",g_enterprise,
               "   AND pmds000 = '6'",
               "   AND (pmdsstus != 'X' AND pmdsstus !='S')",
               "   AND pmdt027 = '",g_pmds_m.pmdsdocno,"'",   #出貨單號
               "   AND pmdt028 = ?"                           #出貨項次
   PREPARE apmt860_sum_apmt880 FROM l_sql
   
   #2.撈出資料
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_apmt880_dcs
      INTO l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
           l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
           l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
           l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
           l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
           l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
           l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt044,   l_pmdt.pmdt046,
           l_pmdt.pmdt047, l_pmdt.pmdt051,  l_pmdt.pmdt052,   l_pmdt.pmdt053,
           l_pmdt.pmdt054, l_pmdt.pmdt055,  l_pmdt.pmdt062,   l_pmdt.pmdt063,
           l_pmdt.pmdt084, l_pmdt.pmdt088,  l_pmdt.pmdt089,   l_pmdt.pmdt200,
           l_pmdt.pmdt201, l_pmdt.pmdt202,  l_pmdt.pmdt203,   l_pmdt.pmdt204,
           l_pmdt.pmdt205, l_pmdt.pmdt208,  l_pmdt.pmdt209,   l_pmdt.pmdt210,
           l_pmdt.pmdt211, l_pmdt.pmdt212,  l_pmdt.pmdt213,   l_pmdt.pmdt218,
           l_pmdt.pmdt219, l_pmdt.pmdt227,  #補貨規格說明 150710-00016#7 Add By Ken 150713
           #l_pmdt.pmdt214                   #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark 
           l_pmdt.pmdt214,l_pmdt.pmdt215     #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Foreach apmt860_gen_apmt880_dcs"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2-1.加總非作廢驗退數量
      LET l_sum_pmdt020 = 0
      EXECUTE apmt860_sum_apmt880 USING l_pmdt.pmdtseq
         INTO l_sum_pmdt020
         
      #2-2.給值
      LET l_pmdt.pmdt020 = l_pmdt.pmdt020 - l_sum_pmdt020     #驗退數量
      IF l_pmdt.pmdt020 = 0 THEN
         CONTINUE FOREACH
      END IF
      LET l_pmdt.pmdt027 = l_pmdt.pmdtdocno   #收貨單號
      LET l_pmdt.pmdt028 = l_pmdt.pmdtseq     #收貨單項次
      LET l_pmdt.pmdt053 = 0                  #允收數量
      LET l_pmdt.pmdt054 = 0                  #已入庫量
      LET l_pmdt.pmdt055 = 0                  #驗退量
      LET l_pmdt.pmdt084 = 'Y'                #須自立AP
      LET l_pmdt.pmdtdocno = p_pmdtdocno      #單據編號
      #項次
      EXECUTE apmt860_gen_detail_maxseq
         USING p_pmdtdocno INTO l_pmdt.pmdtseq
      
      #2-3.驗退數量轉成驗退包裝數量
      LET l_success = ''
      CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt201,l_pmdt.pmdt020)
         RETURNING l_success,l_pmdt.pmdt202
      
      #2-4.驗退數量轉成驗退計價數量
      IF NOT cl_null(l_pmdt.pmdt023) THEN
         LET l_success = ''
         CALL s_aooi250_convert_qty(l_pmdt.pmdt006,l_pmdt.pmdt019,l_pmdt.pmdt023,l_pmdt.pmdt020)
            RETURNING l_success,l_pmdt.pmdt024
      END IF
      
      #2-5.該計算項次未稅金額、稅額、含稅金額
      CALL s_apmt860_get_amount(p_pmdtdocno,l_pmdt.pmdtseq,
                                l_pmdt.pmdt001,l_pmdt.pmdtsite,
                                g_pmds_m.pmds037,l_pmdt.pmdt024,
                                l_pmdt.pmdt036,l_pmdt.pmdt046)
         RETURNING l_pmdt.pmdt038,l_pmdt.pmdt047,l_pmdt.pmdt039
         
      #170217-00003#1 2017/02/18 By 08171 --s add
      #當採購收貨單的庫位為空，產生入庫單時
      IF cl_null(l_pmdt.pmdt016) THEN
         LET l_pmdt.pmdt016 = s_apmt860_warehouse_default(g_pmds_m.pmdssite,l_pmdt.pmdt006)
      END IF
      #170217-00003#1 2017/02/18 By 08171 --e add
      
      #2-6.Insert pmdt_t
      INSERT INTO pmdt_t(pmdtent, pmdtsite, pmdtdocno, pmdtseq,
                         pmdt001, pmdt002,  pmdt003,   pmdt004,
                         pmdt005, pmdt006,  pmdt007,   pmdt016,
                         pmdt017, pmdt018,  pmdt019,   pmdt020,
                         pmdt023, pmdt024,  pmdt025,   pmdt026,
                         pmdt027, pmdt028,  pmdt036,   pmdt037,
                         pmdt038, pmdt039,  pmdt044,   pmdt046,
                         pmdt047, pmdt051,  pmdt052,   pmdt053,
                         pmdt054, pmdt055,  pmdt062,   pmdt063,
                         pmdt084, pmdt088,  pmdt089,   pmdt200,
                         pmdt201, pmdt202,  pmdt203,   pmdt204,
                         pmdt205, pmdt208,  pmdt209,   pmdt210,
                         pmdt211, pmdt212,  pmdt213,   pmdt218,
                         pmdt219, pmdt227,  #補貨規格說明 150710-00016#7 Add By Ken 150713
                         #pmdt214 )          #採購方式     160503-00033#1 Add By Ken 160506  #170216-00026#1 17/02/17 By 08171 mark
                         pmdt214, pmdt215 )   #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
         VALUES(l_pmdt.pmdtent, l_pmdt.pmdtsite, l_pmdt.pmdtdocno, l_pmdt.pmdtseq,
                l_pmdt.pmdt001, l_pmdt.pmdt002,  l_pmdt.pmdt003,   l_pmdt.pmdt004,
                l_pmdt.pmdt005, l_pmdt.pmdt006,  l_pmdt.pmdt007,   l_pmdt.pmdt016,
                l_pmdt.pmdt017, l_pmdt.pmdt018,  l_pmdt.pmdt019,   l_pmdt.pmdt020,
                l_pmdt.pmdt023, l_pmdt.pmdt024,  l_pmdt.pmdt025,   l_pmdt.pmdt026,
                l_pmdt.pmdt027, l_pmdt.pmdt028,  l_pmdt.pmdt036,   l_pmdt.pmdt037,
                l_pmdt.pmdt038, l_pmdt.pmdt039,  l_pmdt.pmdt044,   l_pmdt.pmdt046,
                l_pmdt.pmdt047, l_pmdt.pmdt051,  l_pmdt.pmdt052,   l_pmdt.pmdt053,
                l_pmdt.pmdt054, l_pmdt.pmdt055,  l_pmdt.pmdt062,   l_pmdt.pmdt063,
                l_pmdt.pmdt084, l_pmdt.pmdt088,  l_pmdt.pmdt089,   l_pmdt.pmdt200,
                l_pmdt.pmdt201, l_pmdt.pmdt202,  l_pmdt.pmdt203,   l_pmdt.pmdt204,
                l_pmdt.pmdt205, l_pmdt.pmdt208,  l_pmdt.pmdt209,   l_pmdt.pmdt210,
                l_pmdt.pmdt211, l_pmdt.pmdt212,  l_pmdt.pmdt213,   l_pmdt.pmdt218,
                l_pmdt.pmdt219, l_pmdt.pmdt227,  #補貨規格說明 150710-00016#7 Add By Ken 150713
                #l_pmdt.pmdt214 )                 #採購方式     160503-00033#1 Add By Ken 160506 #170216-00026#1 17/02/17 By 08171 mark
                l_pmdt.pmdt214,l_pmdt.pmdt215 )  #採購方式/最終收貨組織 #170216-00026#1 17/02/17 By 08171 add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Ins pmdt_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2-7.產生多庫儲批資料
      LET l_success = ''
      CALL s_apmt860_ins_pmdu('6',            p_pmdtdocno,    l_pmdt.pmdtsite,#150514-00002#1 150514 By pomelo add pmdtsite
                              l_pmdt.pmdtseq, l_pmdt.pmdt006, l_pmdt.pmdt007,
                              l_pmdt.pmdt016, l_pmdt.pmdt017, l_pmdt.pmdt018,
                              l_pmdt.pmdt019, l_pmdt.pmdt020, l_pmdt.pmdt027,
                              l_pmdt.pmdt028, l_pmdt.pmdt053, l_pmdt.pmdt054,
                              l_pmdt.pmdt055, l_pmdt.pmdt062, l_pmdt.pmdt063,
                              l_pmdt.pmdt088, l_pmdt.pmdt089, l_pmdt.pmdt201,
                              l_pmdt.pmdt202, l_pmdt.pmdt219)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #2-8.產生原始需求分配明細
      CALL s_apmt860_gen_pmdv(l_pmdt.pmdtdocno,l_pmdt.pmdtseq)
         RETURNING l_success
      IF l_success = FALSE THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      INITIALIZE l_pmdt.* TO NULL
   END FOREACH
   
   #3.重新計算整單的未稅、含稅總金額
   LET l_success = ''
   INITIALIZE l_pmds.* TO NULL
   CALL s_apmt860_upd_pmds(p_pmdtdocno)
      RETURNING l_success,l_pmds.pmds043,l_pmds.pmds044,l_pmds.pmds046
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 準備產生採購單SQL
# Memo...........:
# Usage..........: CALL apmt860_gen_po_sql()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/22 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_po_sql()
DEFINE l_sql         STRING

   #1.採購單單身項次
   LET l_sql = "SELECT COALESCE(MAX(pmdnseq),0)+1",
               "  FROM pmdn_t",
               " WHERE pmdnent = ",g_enterprise,
               "   AND pmdndocno = ?"
   PREPARE apmt860_pmdnseq FROM l_sql
   
   #2.採購單關聯單據分批序
   LET l_sql = "SELECT COALESCE(MAX(pmdpseq1),0)+1",
               "  FROM pmdp_t",
               " WHERE pmdpent = ",g_enterprise,
               "   AND pmdpdocno = ?",
               "   AND pmdpseq = ?"
   PREPARE apmt860_pmdpseq1 FROM l_sql
   
   #3.撈取符合採購單身條件的倉退單身資料
   LET l_sql = "SELECT pmdtdocno,pmdtseq,pmdt019,pmdt020",
               "  FROM pmdt_t,pmdl_t",
               " WHERE pmdtent = pmdlent",
               "   AND pmdt001 = pmdldocno",
               "   AND pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'",
               "   AND pmdlsite = ?",                               #採購組織
               "   AND pmdl005 = ?",                                #採購性質
               "   AND pmdl200 = ?",                                #採購中心
               "   AND pmdl203 = ?",                                #採購方式
               "   AND COALESCE(pmdl204,'-1') = COALESCE(?,'-1')",  #配送中心
               "   AND pmdtsite = ?",                               #收貨組織
               "   AND pmdt005 = ?",                                #子件特性
               "   AND pmdt006 = ?",                                #商品編號
               "   AND COALESCE(pmdt007,' ') = COALESCE(?,' ')",    #產品特徵
               "   AND pmdt205 = ?",                                #要貨組織
               " ORDER BY pmdtseq"
   PREPARE apmt860_gen_pmdp_pre FROM l_sql
   DECLARE apmt860_gen_pmdp_cs CURSOR FOR apmt860_gen_pmdp_pre
   
   #4.計算該項次的關聯單據裡的總採購量
   LET l_sql = "SELECT COALESCE(SUM(pmdp024),0)",
               "  FROM pmdp_t",
               " WHERE pmdpent = ",g_enterprise,
               "   AND pmdpdocno = ?",
               "   AND pmdpseq = ?"
   PREPARE apmt860_sum_pmdp024 FROM l_sql
   
END FUNCTION

################################################################################
# Descriptions...: 根據倉退單 產生新的採購單
# Memo...........:
# Usage..........: CALL apmt860_gen_po()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/21 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_po()
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_success     LIKE type_t.num5
DEFINE l_pmdldocno   STRING
DEFINE la_param      RECORD
          prog       STRING,
          param      DYNAMIC ARRAY OF STRING
                     END RECORD
DEFINE ls_js         STRING

   IF g_pmds_m.pmdsdocno IS NULL  THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   #1.檢查是否已經存在採購單
   LET l_cnt = 0
   SELECT COUNT(pmdldocno) INTO l_cnt
     FROM pmdl_t 
    WHERE pmdlent = g_enterprise
      AND pmdl008 = g_pmds_m.pmdsdocno
      AND pmdl007 = '7' 
      AND NOT(pmdlstus = 'X')
   IF l_cnt >= 1 THEN
      #該採購倉退單 已產生對應採購採購單，不可重複產生！
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_pmds_m.pmdsdocno
      LET g_errparam.code   = 'apm-00798'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #2.Lock單據
   CALL s_transaction_begin()
   OPEN apmt860_cl USING g_enterprise,g_pmds_m.pmdsdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN apmt860_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #3.準備SQL
   CALL apmt860_gen_po_sql()
   
   #4.產生採購單單頭
   CALL apmt860_gen_po_pmdl() RETURNING l_success,l_pmdldocno
   IF NOT l_success THEN
      CLOSE apmt860_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL cl_err_collect_show()
   
   #5.把產生成功的採購單執行給使用者看
   IF NOT cl_null(l_pmdldocno) THEN
      LET l_pmdldocno = " pmdldocno IN(",l_pmdldocno,")"
      LET la_param.prog = 'apmt840'
      LET la_param.param[1] = ''
      LET la_param.param[2] = l_pmdldocno
      LET ls_js = util.JSON.stringify(la_param)
      CALL cl_cmdrun(ls_js)
   END IF
   CLOSE apmt860_cl
   CALL s_transaction_end('Y','0')
END FUNCTION

################################################################################
# Descriptions...: 根據倉退單 產生採購單頭資料
# Memo...........:
# Usage..........: CALL apmt860_gen_po_pmdl()
#                     RETURNING r_success,r_pmdldocno
# Input parameter: 無
# Return code....: r_success     True/False
#                : r_pmdldocno   成功產生採購單號
# Date & Author..: 2015/01/21 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_po_pmdl()
DEFINE r_success          LIKE type_t.num5
DEFINE r_pmdldocno        STRING                    #成功產生的採購單號
DEFINE l_pmdl             RECORD    #採購單單頭
       pmdlent            LIKE pmdl_t.pmdlent,      #企業編號
       pmdlsite           LIKE pmdl_t.pmdlsite,     #營運據點
       pmdlunit           LIKE pmdl_t.pmdlunit,     #收貨組織
       pmdldocno          LIKE pmdl_t.pmdldocno,    #採購單號
       pmdldocdt          LIKE pmdl_t.pmdldocdt,    #採購日期
       pmdl001            LIKE pmdl_t.pmdl001,      #版次
       pmdl002            LIKE pmdl_t.pmdl002,      #採購人員
       pmdl003            LIKE pmdl_t.pmdl003,      #採購部門
       pmdl004            LIKE pmdl_t.pmdl004,      #供應商編號
       pmdl005            LIKE pmdl_t.pmdl005,      #採購性質
       pmdl007            LIKE pmdl_t.pmdl007,      #資料來源類型
       pmdl008            LIKE pmdl_t.pmdl008,      #來源單號
       pmdl009            LIKE pmdl_t.pmdl009,      #付款條件
       pmdl010            LIKE pmdl_t.pmdl010,      #交易條件
       pmdl011            LIKE pmdl_t.pmdl011,      #稅別
       pmdl012            LIKE pmdl_t.pmdl012,      #稅率
       pmdl013            LIKE pmdl_t.pmdl013,      #單價含稅否
       pmdl015            LIKE pmdl_t.pmdl015,      #幣別
       pmdl016            LIKE pmdl_t.pmdl016,      #匯率
       pmdl020            LIKE pmdl_t.pmdl020,      #運送方式
       pmdl021            LIKE pmdl_t.pmdl021,      #付款供應商
       pmdl022            LIKE pmdl_t.pmdl022,      #送貨供應商
       pmdl023            LIKE pmdl_t.pmdl023,      #採購渠道
       pmdl024            LIKE pmdl_t.pmdl024,      #採購分類
       pmdl025            LIKE pmdl_t.pmdl025,      #送貨地址
       pmdl027            LIKE pmdl_t.pmdl027,      #供應商連絡人
       pmdl029            LIKE pmdl_t.pmdl029,      #收貨部門
       pmdl033            LIKE pmdl_t.pmdl033,      #發票類型
       pmdl040            LIKE pmdl_t.pmdl040,      #採購總未稅金額
       pmdl041            LIKE pmdl_t.pmdl041,      #採購總含稅金額
       pmdl042            LIKE pmdl_t.pmdl042,      #採購總稅額
       pmdl046            LIKE pmdl_t.pmdl046,      #預付款發票開立方式
       pmdl047            LIKE pmdl_t.pmdl047,      #物流結案
       pmdl048            LIKE pmdl_t.pmdl048,      #帳流結案
       pmdl049            LIKE pmdl_t.pmdl049,      #金流結案
       pmdl054            LIKE pmdl_t.pmdl054,      #內外購
       pmdl055            LIKE pmdl_t.pmdl055,      #匯率計算基準
       pmdl200            LIKE pmdl_t.pmdl200,      #採購中心
       pmdl201            LIKE pmdl_t.pmdl201,      #聯絡電話
       pmdl202            LIKE pmdl_t.pmdl202,      #傳真號碼
       pmdl203            LIKE pmdl_t.pmdl203,      #採購方式
       pmdl204            LIKE pmdl_t.pmdl204,      #配送中心
       pmdl205            LIKE pmdl_t.pmdl205,      #最終有效日
       pmdl206            LIKE pmdl_t.pmdl206,      #長效期訂單
       pmdlownid          LIKE pmdl_t.pmdlownid,    #資料所有者
       pmdlowndp          LIKE pmdl_t.pmdlowndp,    #資料所屬部門
       pmdlcrtid          LIKE pmdl_t.pmdlcrtid,    #資料建立者
       pmdlcrtdp          LIKE pmdl_t.pmdlcrtdp,    #資料建立部門
       pmdlcrtdt          DATETIME YEAR TO SECOND,  #資料創建日
       pmdlstus           LIKE pmdl_t.pmdlstus      #狀態碼
                          END RECORD
DEFINE l_sel              RECORD
       pmdlsite           LIKE pmdl_t.pmdlsite,     #採購組織
       pmdl005            LIKE pmdl_t.pmdl005,      #採購性質
       pmdl200            LIKE pmdl_t.pmdl200,      #採購中心
       pmdl203            LIKE pmdl_t.pmdl203,      #採購方式
       pmdl204            LIKE pmdl_t.pmdl204       #配送中心
                          END RECORD
DEFINE l_need             RECORD
       pmdl009            LIKE pmdl_t.pmdl009,      #付款條件
       pmdl010            LIKE pmdl_t.pmdl010,      #交易條件
       pmdl011            LIKE pmdl_t.pmdl011,      #稅別
       pmdl015            LIKE pmdl_t.pmdl015,      #幣別
       pmdl020            LIKE pmdl_t.pmdl020,      #運送方式
       pmdl021            LIKE pmdl_t.pmdl021,      #付款供應商
       pmdl022            LIKE pmdl_t.pmdl022,      #送貨供應商
       pmdl023            LIKE pmdl_t.pmdl023,      #採購渠道
       pmdl024            LIKE pmdl_t.pmdl024,      #採購分類
       pmdl027            LIKE pmdl_t.pmdl027,      #供應商連絡人
       pmdl033            LIKE pmdl_t.pmdl033,      #發票類型
       pmdl054            LIKE pmdl_t.pmdl054,      #內外購
       pmdl055            LIKE pmdl_t.pmdl055       #匯率計算基準
                          END RECORD
DEFINE p_pmdl             RECORD
       pmdldocno          LIKE pmdl_t.pmdldocno,   #採購單號
       pmdlsite           LIKE pmdl_t.pmdlsite,    #採購組織
       pmdl004            LIKE pmdl_t.pmdl004,     #供應商
       pmdl005            LIKE pmdl_t.pmdl005,     #採購性質
       pmdl011            LIKE pmdl_t.pmdl011,     #稅別
       pmdl012            LIKE pmdl_t.pmdl012,     #稅率
       pmdl015            LIKE pmdl_t.pmdl015,     #幣別
       pmdl020            LIKE pmdl_t.pmdl020,     #運輸方式
       pmdl022            LIKE pmdl_t.pmdl022,     #送貨供應商
       pmdl023            LIKE pmdl_t.pmdl023,     #採購渠道
       pmdl200            LIKE pmdl_t.pmdl200,     #採購中心
       pmdl203            LIKE pmdl_t.pmdl203,     #採購方式
       pmdl204            LIKE pmdl_t.pmdl204      #配送中心
                          END RECORD
DEFINE l_pre_pmdl         RECORD
       pmdldocno          LIKE pmdl_t.pmdldocno,   #採購單號
       pmdlsite           LIKE pmdl_t.pmdlsite,    #採購組織
       pmdl004            LIKE pmdl_t.pmdl004,     #供應商
       pmdl005            LIKE pmdl_t.pmdl005,     #採購性質
       pmdl011            LIKE pmdl_t.pmdl011,     #稅別
       pmdl012            LIKE pmdl_t.pmdl012,     #稅率
       pmdl015            LIKE pmdl_t.pmdl015,     #幣別
       pmdl020            LIKE pmdl_t.pmdl020,     #運輸方式
       pmdl022            LIKE pmdl_t.pmdl022,     #送貨供應商
       pmdl023            LIKE pmdl_t.pmdl023,     #採購渠道
       pmdl200            LIKE pmdl_t.pmdl200,     #採購中心
       pmdl203            LIKE pmdl_t.pmdl203,     #採購方式
       pmdl204            LIKE pmdl_t.pmdl204      #配送中心
                          END RECORD
DEFINE l_success          LIKE type_t.num5
DEFINE l_docno            LIKE rtai_t.rtai004       #批次拋轉預設單別
DEFINE l_pmdl205          LIKE pmdl_t.pmdl205
DEFINE l_sql              STRING

   LET r_success = TRUE
   LET r_pmdldocno = ''
   
   #1.取單別
   LET l_success = ''
   CALL s_arti200_get_def_doc_type(g_pmds_m.pmdssite,'apmt840','2')
      RETURNING l_success,l_docno
   IF l_success = FALSE THEN
      LET r_success = FALSE
      RETURN r_success,r_pmdldocno
   END IF
   
   #2.準備資料
   # 2-1.倉退單對應到採購單
   #     依照採購單 採購組織 採購性質 採購中心 採購方式 配送中心 拆單
   LET l_sql = "SELECT DISTINCT pmdlsite,pmdl005,pmdl200,pmdl203,pmdl204",
               "  FROM pmdl_t,pmdt_t",
               " WHERE pmdtent = pmdlent",
               "   AND pmdt001 = pmdldocno",
               "   AND pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'"
   PREPARE apmt860_gen_po_pre FROM l_sql
   DECLARE apmt860_gen_po_cs CURSOR FOR apmt860_gen_po_pre
   
   # 2-2.準備撈取單身最大到庫日期
   LET l_sql = "SELECT MAX(pmdn014)",
               "  FROM pmdn_t",
               " WHERE pmdnent = ",g_enterprise,
               "   AND pmdndocno = ?"
   PREPARE apmt860_gen_po_sel_pmdn014 FROM l_sql
   
   # 2-3.準備更新單頭最終有效日
   LET l_sql = "UPDATE pmdl_t SET pmdl205 = ?",
               " WHERE pmdlent = ",g_enterprise,
               "   AND pmdldocno = ?"
   PREPARE apmt860_gen_po_upd_pmdl205 FROM l_sql
   
   #3.撈取需要的資料
   # 3-1.撈取供應商預設資料
   LET l_success = ''
   CALL apmt860_gen_po_chk_get()
      RETURNING l_success,      l_need.pmdl009, l_need.pmdl010,
                l_need.pmdl011, l_need.pmdl020, l_need.pmdl021,
                l_need.pmdl022, l_need.pmdl023, l_need.pmdl033,
                l_need.pmdl054, l_need.pmdl055
   IF l_success = FALSE THEN
      LET r_success = FALSE
   END IF
   
   # 3-2.撈取供應商預設幣別
   SELECT pmab033 INTO l_need.pmdl015
     FROM pmab_t
    WHERE pmabent = g_enterprise
      AND pmabsite = 'ALL'
      AND pmab001 = g_pmds_m.pmds007
   IF cl_null(l_need.pmdl015) THEN
      #供應商%1+營運據點：ALL 供應商慣用幣別為空！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00799"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds007
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   # 3-3.資料有錯誤
   IF r_success = FALSE THEN
      RETURN r_success,r_pmdldocno
   END IF
   
   #4.撈取採購單資料
   INITIALIZE l_sel.* TO NULL
   FOREACH apmt860_gen_po_cs
      INTO l_sel.pmdlsite, l_sel.pmdl005, l_sel.pmdl200, l_sel.pmdl203, l_sel.pmdl204
      
      # 4-1.給值
      LET l_pmdl.pmdlent   = g_enterprise           #企業編號
      LET l_pmdl.pmdlsite  = l_sel.pmdlsite         #營運據點
      LET l_pmdl.pmdlunit  = ''                     #收貨組織
      LET l_pmdl.pmdldocno = l_docno                #採購單號
      LET l_pmdl.pmdldocdt = g_today                #採購日期
      LET l_pmdl.pmdl001   = 0                      #版次
      LET l_pmdl.pmdl002   = g_user                 #採購人員
      LET l_pmdl.pmdl003   = g_dept                 #採購部門
      LET l_pmdl.pmdl004   = g_pmds_m.pmds007       #供應商編號
      LET l_pmdl.pmdl005   = l_sel.pmdl005          #採購性質
      LET l_pmdl.pmdl007   = '7'                    #資料來源類型
      LET l_pmdl.pmdl008   = g_pmds_m.pmdsdocno     #來源單號
      LET l_pmdl.pmdl009   = l_need.pmdl009         #付款條件
      LET l_pmdl.pmdl010   = l_need.pmdl010         #交易條件
      LET l_pmdl.pmdl011   = l_need.pmdl011         #稅別
      LET l_pmdl.pmdl015   = l_need.pmdl015         #幣別
      LET l_pmdl.pmdl020   = l_need.pmdl020         #運送方式
      LET l_pmdl.pmdl021   = l_need.pmdl021         #付款供應商
      LET l_pmdl.pmdl022   = l_need.pmdl022         #送貨供應商
      LET l_pmdl.pmdl023   = l_need.pmdl023         #採購渠道
      LET l_pmdl.pmdl024   = l_need.pmdl024         #採購分類
      LET l_pmdl.pmdl025   = ''                     #送貨地址
      LET l_pmdl.pmdl027   = l_need.pmdl027         #供應商連絡人
      LET l_pmdl.pmdl029   = ''                     #收貨部門
      LET l_pmdl.pmdl033   = l_need.pmdl033         #發票類型
      LET l_pmdl.pmdl040   = 0                      #採購總未稅金額
      LET l_pmdl.pmdl041   = 0                      #採購總含稅金額
      LET l_pmdl.pmdl042   = 0                      #採購總稅額
      LET l_pmdl.pmdl046   = '1'                    #預付款發票開立方式
      LET l_pmdl.pmdl047   = 'N'                    #物流結案
      LET l_pmdl.pmdl048   = 'N'                    #帳流結案
      LET l_pmdl.pmdl049   = 'N'                    #金流結案
      LET l_pmdl.pmdl054   = l_need.pmdl054         #內外購
      LET l_pmdl.pmdl055   = l_need.pmdl055         #匯率計算基準
      LET l_pmdl.pmdl200   = l_sel.pmdl200          #採購中心
      LET l_pmdl.pmdl201   = ''                     #聯絡電話
      LET l_pmdl.pmdl202   = ''                     #傳真號碼
      LET l_pmdl.pmdl203   = l_sel.pmdl203          #採購方式
      LET l_pmdl.pmdl204   = l_sel.pmdl204          #配送中心
      LET l_pmdl.pmdl205   = ''                     #最終有效日
      LET l_pmdl.pmdl206   = 'N'                    #長效期訂單
      LET l_pmdl.pmdlownid = g_user                 #資料所有者
      LET l_pmdl.pmdlowndp = g_dept                 #資料所屬部門
      LET l_pmdl.pmdlcrtid = g_user                 #資料建立者
      LET l_pmdl.pmdlcrtdp = g_dept                 #資料建立部門
      LET l_pmdl.pmdlcrtdt = cl_get_current()       #資料創建日
      LET l_pmdl.pmdlstus  = 'N'                    #狀態碼

      # 4-2.取稅率、單價含稅否
      CALL s_adb_oodb002_default(l_pmdl.pmdlsite,l_pmdl.pmdl011)
         RETURNING l_pmdl.pmdl013,l_pmdl.pmdl012
      
      # 4-3.取匯率
      CALL s_apmt840_pmdl016_default(l_pmdl.pmdlsite,l_pmdl.pmdl015,l_pmdl.pmdl054)
         RETURNING l_pmdl.pmdl016

      # 4-4.產生採購單單號
      CALL s_aooi200_gen_docno(l_pmdl.pmdlsite,l_pmdl.pmdldocno,g_today,'apmt840')
         RETURNING l_success,l_pmdl.pmdldocno
      IF NOT l_success THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00003'
         LET g_errparam.extend = ""
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success,r_pmdldocno
      END IF
      
      # 4-5.Insert pmdl_t
      INSERT INTO pmdl_t(pmdlent,   pmdlsite,  pmdlunit,  pmdldocno, pmdldocdt,
                         pmdl001,   pmdl002,   pmdl003,   pmdl004,   pmdl005,
                         pmdl007,   pmdl008,   pmdl009,   pmdl010,   pmdl011,
                         pmdl012,   pmdl013,   pmdl015,   pmdl016,   pmdl020,
                         pmdl021,   pmdl022,   pmdl023,   pmdl024,   pmdl025,
                         pmdl027,   pmdl029,   pmdl033,   pmdl040,   pmdl041,
                         pmdl042,   pmdl046,   pmdl047,   pmdl048,   pmdl049,
                         pmdl054,   pmdl055,   pmdl200,   pmdl201,   pmdl202,
                         pmdl203,   pmdl204,   pmdl205,   pmdl206,   pmdlownid,
                         pmdlowndp, pmdlcrtid, pmdlcrtdp, pmdlcrtdt, pmdlstus)
         VALUES(l_pmdl.pmdlent,   l_pmdl.pmdlsite,  l_pmdl.pmdlunit,  l_pmdl.pmdldocno, l_pmdl.pmdldocdt,
                l_pmdl.pmdl001,   l_pmdl.pmdl002,   l_pmdl.pmdl003,   l_pmdl.pmdl004,   l_pmdl.pmdl005,
                l_pmdl.pmdl007,   l_pmdl.pmdl008,   l_pmdl.pmdl009,   l_pmdl.pmdl010,   l_pmdl.pmdl011,
                l_pmdl.pmdl012,   l_pmdl.pmdl013,   l_pmdl.pmdl015,   l_pmdl.pmdl016,   l_pmdl.pmdl020,
                l_pmdl.pmdl021,   l_pmdl.pmdl022,   l_pmdl.pmdl023,   l_pmdl.pmdl024,   l_pmdl.pmdl025,
                l_pmdl.pmdl027,   l_pmdl.pmdl029,   l_pmdl.pmdl033,   l_pmdl.pmdl040,   l_pmdl.pmdl041,
                l_pmdl.pmdl042,   l_pmdl.pmdl046,   l_pmdl.pmdl047,   l_pmdl.pmdl048,   l_pmdl.pmdl049,
                l_pmdl.pmdl054,   l_pmdl.pmdl055,   l_pmdl.pmdl200,   l_pmdl.pmdl201,   l_pmdl.pmdl202,
                l_pmdl.pmdl203,   l_pmdl.pmdl204,   l_pmdl.pmdl205,   l_pmdl.pmdl206,   l_pmdl.pmdlownid,
                l_pmdl.pmdlowndp, l_pmdl.pmdlcrtid, l_pmdl.pmdlcrtdp, l_pmdl.pmdlcrtdt, l_pmdl.pmdlstus)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Ins pmdl_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success,r_pmdldocno
      END IF
      
      # 4-5.準備要傳遞的參數值
      INITIALIZE l_pre_pmdl.* TO NULL
      LET l_pre_pmdl.pmdldocno = l_pmdl.pmdldocno    #採購單號
      LET l_pre_pmdl.pmdlsite  = l_pmdl.pmdlsite     #採購組織
      LET l_pre_pmdl.pmdl004   = l_pmdl.pmdl004      #供應商
      LET l_pre_pmdl.pmdl005   = l_pmdl.pmdl005      #採購性質
      LET l_pre_pmdl.pmdl011   = l_pmdl.pmdl011      #稅別
      LET l_pre_pmdl.pmdl012   = l_pmdl.pmdl012      #稅率
      LET l_pre_pmdl.pmdl015   = l_pmdl.pmdl015      #幣別
      LET l_pre_pmdl.pmdl020   = l_pmdl.pmdl020      #運輸方式
      LET l_pre_pmdl.pmdl022   = l_pmdl.pmdl022      #送貨供應商
      LET l_pre_pmdl.pmdl023   = l_pmdl.pmdl023      #採購渠道
      LET l_pre_pmdl.pmdl200   = l_pmdl.pmdl200      #採購中心
      LET l_pre_pmdl.pmdl203   = l_pmdl.pmdl203      #採購方式
      LET l_pre_pmdl.pmdl204   = l_pmdl.pmdl204      #配送中心
      
      # 4-7.產生單身
      IF NOT apmt860_gen_po_pmdn(l_pre_pmdl.*) THEN
         LET r_success = FALSE
         RETURN r_success,r_pmdldocno
      END IF
      
      # 4-8.更新單頭資料
      IF NOT s_apmp840_sum_money(l_pmdl.pmdldocno) THEN
         LET r_success = FALSE
         RETURN r_success,r_pmdldocno
      END IF
      
      # 4-9.更新單頭最終有效日
      LET l_pmdl205 = ''
      EXECUTE apmt860_gen_po_sel_pmdn014 USING l_pmdl.pmdldocno
         INTO l_pmdl205
         
      EXECUTE apmt860_gen_po_upd_pmdl205
        USING l_pmdl205,l_pmdl.pmdldocno
      
      # 4-10.組成功單號
      IF cl_null(r_pmdldocno) THEN
         LET r_pmdldocno = "'",l_pmdl.pmdldocno,"'"
      ELSE
         LET r_pmdldocno = r_pmdldocno,",'",l_pmdl.pmdldocno,"'"
      END IF
      
      INITIALIZE l_sel.* TO NULL
      INITIALIZE l_pmdl.* TO NULL
   END FOREACH
   
   RETURN r_success,r_pmdldocno
    
END FUNCTION

################################################################################
# Descriptions...: 根據倉退單 產生採購單身檔
# Memo...........:
# Usage..........: CALL apmt860_gen_po_pmdn(p_pmdl)
#                     RETURNING r_success
# Input parameter: p_pmdl        RECORD
#                  pmdldocno     採購單號
#                  pmdlsite      採購組織
#                  pmdl004       供應商
#                  pmdl005       採購性質
#                  pmdl011       稅別
#                  pmdl012       稅率
#                  pmdl015       幣別
#                  pmdl020       運輸方式
#                  pmdl022       送貨供應商
#                  pmdl023       採購渠道
#                  pmdl200       採購中心
#                  pmdl203       採購方式
#                  pmdl204       配送中心
#                                END RECORD
# Return code....: r_success     True/False
# Date & Author..: 2015/01/21 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_po_pmdn(p_pmdl)
DEFINE p_pmdl             RECORD
       pmdldocno          LIKE pmdl_t.pmdldocno,   #採購單號
       pmdlsite           LIKE pmdl_t.pmdlsite,    #採購組織
       pmdl004            LIKE pmdl_t.pmdl004,     #供應商
       pmdl005            LIKE pmdl_t.pmdl005,     #採購性質
       pmdl011            LIKE pmdl_t.pmdl011,     #稅別
       pmdl012            LIKE pmdl_t.pmdl012,     #稅率
       pmdl015            LIKE pmdl_t.pmdl015,     #幣別
       pmdl020            LIKE pmdl_t.pmdl020,     #運輸方式
       pmdl022            LIKE pmdl_t.pmdl022,     #送貨供應商
       pmdl023            LIKE pmdl_t.pmdl023,     #採購渠道
       pmdl200            LIKE pmdl_t.pmdl200,     #採購中心
       pmdl203            LIKE pmdl_t.pmdl203,     #採購方式
       pmdl204            LIKE pmdl_t.pmdl204      #配送中心
                          END RECORD
DEFINE r_success          LIKE type_t.num5
DEFINE l_pmdn             RECORD
       pmdnent            LIKE pmdn_t.pmdnent,     #企業編號     
       pmdnsite           LIKE pmdn_t.pmdnsite,    #營運據點     
       pmdnunit           LIKE pmdn_t.pmdnunit,    #收貨組織     
       pmdnorga           LIKE pmdn_t.pmdnorga,    #付款據點     
       pmdndocno          LIKE pmdn_t.pmdndocno,   #採購單號     
       pmdnseq            LIKE pmdn_t.pmdnseq,     #項次         
       pmdn001            LIKE pmdn_t.pmdn001,     #商品編號
       pmdn002            LIKE pmdn_t.pmdn002,     #產品特徵     
       pmdn006            LIKE pmdn_t.pmdn006,     #採購單位     
       pmdn007            LIKE pmdn_t.pmdn007,     #採購數量     
       pmdn010            LIKE pmdn_t.pmdn010,     #計價單位     
       pmdn011            LIKE pmdn_t.pmdn011,     #計價數量     
       pmdn012            LIKE pmdn_t.pmdn012,     #出貨日期     
       pmdn013            LIKE pmdn_t.pmdn013,     #到廠日期     
       pmdn014            LIKE pmdn_t.pmdn014,     #到庫日期     
       pmdn015            LIKE pmdn_t.pmdn015,     #單價         
       pmdn016            LIKE pmdn_t.pmdn016,     #稅別         
       pmdn017            LIKE pmdn_t.pmdn017,     #稅率         
       pmdn019            LIKE pmdn_t.pmdn019,     #子件特性     
       pmdn020            LIKE pmdn_t.pmdn020,     #緊急度       
       pmdn022            LIKE pmdn_t.pmdn022,     #部分交貨     
       pmdn023            LIKE pmdn_t.pmdn023,     #送貨供應商   
       pmdn024            LIKE pmdn_t.pmdn024,     #多交期       
       pmdn025            LIKE pmdn_t.pmdn025,     #收貨地址代碼 
       pmdn026            LIKE pmdn_t.pmdn026,     #帳款地址代碼 
       pmdn028            LIKE pmdn_t.pmdn028,     #收貨庫位
       pmdn029            LIKE pmdn_t.pmdn029,     #收貨儲位
       pmdn030            LIKE pmdn_t.pmdn030,     #收貨批號
       pmdn031            LIKE pmdn_t.pmdn031,     #運輸方式
       pmdn045            LIKE pmdn_t.pmdn045,     #行狀態
       pmdn046            LIKE pmdn_t.pmdn046,     #未稅金額     
       pmdn047            LIKE pmdn_t.pmdn047,     #含稅金額     
       pmdn048            LIKE pmdn_t.pmdn048,     #稅額         
       pmdn049            LIKE pmdn_t.pmdn049,     #理由碼       
       pmdn050            LIKE pmdn_t.pmdn050,     #備註         
       pmdn051            LIKE pmdn_t.pmdn051,     #結案理由碼   
       pmdn052            LIKE pmdn_t.pmdn052,     #檢驗否       
       pmdn200            LIKE pmdn_t.pmdn200,     #商品條碼     
       pmdn201            LIKE pmdn_t.pmdn201,     #包裝單位     
       pmdn202            LIKE pmdn_t.pmdn202,     #包裝數量     
       pmdn203            LIKE pmdn_t.pmdn203,     #收貨部門     
       pmdn205            LIKE pmdn_t.pmdn205,     #要貨組織     
       pmdn206            LIKE pmdn_t.pmdn206,     #庫存量       
       pmdn207            LIKE pmdn_t.pmdn207,     #採購在途量   
       pmdn208            LIKE pmdn_t.pmdn208,     #前日銷售量   
       pmdn209            LIKE pmdn_t.pmdn209,     #上月銷量     
       pmdn210            LIKE pmdn_t.pmdn210,     #第一週銷量   
       pmdn211            LIKE pmdn_t.pmdn211,     #第二週銷量   
       pmdn212            LIKE pmdn_t.pmdn212,     #第三週銷量   
       pmdn213            LIKE pmdn_t.pmdn213,     #第四週銷量   
       pmdn214            LIKE pmdn_t.pmdn214,     #採購渠道     
       pmdn215            LIKE pmdn_t.pmdn215,     #渠道性質     
       pmdn216            LIKE pmdn_t.pmdn216,     #經營方式     
       pmdn217            LIKE pmdn_t.pmdn217,     #結算方式     
       pmdn218            LIKE pmdn_t.pmdn218,     #合約編號     
       pmdn219            LIKE pmdn_t.pmdn219,     #協議編號     
       pmdn220            LIKE pmdn_t.pmdn220,     #採購人員     
       pmdn221            LIKE pmdn_t.pmdn221,     #採購部門     
       pmdn222            LIKE pmdn_t.pmdn222,     #採購中心     
       pmdn223            LIKE pmdn_t.pmdn223,     #配送中心     
       pmdn224            LIKE pmdn_t.pmdn224,     #採購失效日   
       pmdn225            LIKE pmdn_t.pmdn225,     #最終收貨組織
       pmdn228            LIKE pmdn_t.pmdn228      #商品品類
                          END RECORD
DEFINE l_pmdt             RECORD
       pmdtsite           LIKE pmdt_t.pmdtsite,    #出貨組織
#       pmdtseq            LIKE pmdt_t.pmdtseq,     #項次
#       pmdt001            LIKE pmdt_t.pmdt001,     #採購單號
#       pmdt002            LIKE pmdt_t.pmdt002,     #採購項次
#       pmdt003            LIKE pmdt_t.pmdt003,     #採購項序
#       pmdt004            LIKE pmdt_t.pmdt004,     #採購分批序
       pmdt005            LIKE pmdt_t.pmdt005,     #子件特性
       pmdt006            LIKE pmdt_t.pmdt006,     #商品編號
       pmdt007            LIKE pmdt_t.pmdt007,     #產品特徵
       pmdt205            LIKE pmdt_t.pmdt205      #要貨組織
                          END RECORD
DEFINE l_pact             RECORD   #協議資訊
       pmdnorga           LIKE pmdn_t.pmdnorga,    #帳務組織
       pmdn006            LIKE pmdn_t.pmdn006,     #採購單位
       pmdn010            LIKE pmdn_t.pmdn010,     #計價單位
       pmdn015            LIKE pmdn_t.pmdn015,     #單價
       pmdn016            LIKE pmdn_t.pmdn016,     #稅別
       pmdn017            LIKE pmdn_t.pmdn017,     #稅率
       pmdn216            LIKE pmdn_t.pmdn216,     #經營方式
       pmdn217            LIKE pmdn_t.pmdn217,     #結算方式
       pmdn218            LIKE pmdn_t.pmdn218,     #合約編號
       pmdn219            LIKE pmdn_t.pmdn219,     #協議編號
       pmdn220            LIKE pmdn_t.pmdn220,     #採購人員
       pmdn221            LIKE pmdn_t.pmdn221      #採購部門
                          END RECORD
#準備要傳遞的參數
DEFINE l_pre_pmdn         RECORD
       pmdldocno          LIKE pmdl_t.pmdldocno,   #採購單號
       pmdl005            LIKE pmdl_t.pmdl005,     #採購性質
       pmdl200            LIKE pmdl_t.pmdl200,     #採購中心
       pmdl203            LIKE pmdl_t.pmdl203,     #採購方式
       pmdl204            LIKE pmdl_t.pmdl204,     #配送中心
       pmdnsite           LIKE pmdn_t.pmdnsite,    #採購組織
       pmdnseq            LIKE pmdn_t.pmdnseq,     #項次
       pmdn001            LIKE pmdn_t.pmdn001,     #商品編號
       pmdn002            LIKE pmdn_t.pmdn002,     #產品特徵
       pmdn006            LIKE pmdn_t.pmdn006,     #採購單位
       pmdn019            LIKE pmdn_t.pmdn019,     #子件特性
       pmdn205            LIKE pmdn_t.pmdn205,     #要貨組織
       pmdn225            LIKE pmdn_t.pmdn225      #收貨組織
                          END RECORD
#計算到庫日期
DEFINE l_pmdn014          LIKE pmdn_t.pmdn014      #到庫日期
DEFINE l_pmdn224          LIKE pmdn_t.pmdn224      #採購失效日(到庫日期+訂單有效期)
DEFINE l_rtka010          LIKE rtka_t.rtka010      #訂單有效期
#門店清單
DEFINE l_pmdn200          LIKE pmdn_t.pmdn200      #商品條碼
DEFINE l_pmdn201          LIKE pmdn_t.pmdn201      #包裝單位
DEFINE l_pmdn228          LIKE pmdn_t.pmdn228      #商品品類
DEFINE l_sql              STRING
DEFINE l_success          LIKE type_t.num5

   LET r_success = TRUE
      
   #1.算到庫日期
   CALL s_apmt840_get_date('1', g_today,g_site,p_pmdl.pmdl004)
      RETURNING l_pmdn014,l_rtka010
   #2.採購失效日(到庫日期+訂單有效期)
   LET l_pmdn224 = l_pmdn014 + l_rtka010
   
   #3.撈取採購單單身資料
   LET l_sql = "SELECT DISTINCT pmdtsite, pmdt005, pmdt006,",
               "       pmdt007, pmdt205",
               "  FROM pmdl_t,pmdt_t",
               " WHERE pmdtent = pmdlent",
               "   AND pmdt001 = pmdldocno",
               "   AND pmdtent = ",g_enterprise,
               "   AND pmdtdocno = '",g_pmds_m.pmdsdocno,"'",
               "   AND pmdlsite = '",p_pmdl.pmdlsite,"'",
               "   AND pmdl005 = '",p_pmdl.pmdl005,"'",
               "   AND pmdl200 = '",p_pmdl.pmdl200,"'",
               "   AND pmdl203 = '",p_pmdl.pmdl203,"'"
   IF NOT cl_null(p_pmdl.pmdl204) THEN
      LET l_sql = l_sql," AND pmdl204 = '",p_pmdl.pmdl204,"'"
   END IF
   PREPARE apmt860_gen_po_pmdn_pre FROM l_sql
   DECLARE apmt860_gen_po_pmdn_cs CURSOR FOR apmt860_gen_po_pmdn_pre
   
   LET l_sql = "SELECT imaa009",
               "  FROM imaa_t",
               " WHERE imaaent = ",g_enterprise,
               "   AND imaa001 = ?"
   PREPARE apmt860_gen_po_sel_imaa009 FROM l_sql
   
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_po_pmdn_cs
      INTO l_pmdt.pmdtsite, l_pmdt.pmdt005, l_pmdt.pmdt006,
           l_pmdt.pmdt007,  l_pmdt.pmdt205
      
      # 3-1.取協議資訊
      INITIALIZE l_pact.* TO NULL
      CALL s_apmt840_get_pact(p_pmdl.pmdl200,  p_pmdl.pmdl015,
                              p_pmdl.pmdl004,  g_today,
                              l_pmdt.pmdt006,  p_pmdl.pmdlsite)
         RETURNING l_pact.pmdnorga, l_pact.pmdn006, l_pact.pmdn010,
                   l_pact.pmdn015,  l_pact.pmdn016, l_pact.pmdn017,
                   l_pact.pmdn216,  l_pact.pmdn217, l_pact.pmdn218,
                   l_pact.pmdn219,  l_pact.pmdn220, l_pact.pmdn221
     
     # 3-1-1.帳務組織
     IF cl_null(l_pact.pmdnorga) THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = "apm-00677"
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        LET g_errparam.replace[1] = p_pmdl.pmdl200
        LET g_errparam.replace[2] = p_pmdl.pmdl015
        LET g_errparam.replace[3] = p_pmdl.pmdl004
        LET g_errparam.replace[4] = g_today
        LET g_errparam.replace[5] = l_pmdt.pmdt006
        CALL cl_err()
        LET r_success = FALSE
     END IF
     # 3-1-2.採購單位
     IF cl_null(l_pact.pmdn006) THEN
        #採購中心 %1 + 幣別 %2 + 供應商 %3 + 日期 %4 + 商品編號%5 取到的採購單位為空！
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = "apm-00700"
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        LET g_errparam.replace[1] = p_pmdl.pmdl200
        LET g_errparam.replace[2] = p_pmdl.pmdl015
        LET g_errparam.replace[3] = p_pmdl.pmdl004
        LET g_errparam.replace[4] = g_today
        LET g_errparam.replace[5] = l_pmdt.pmdt006
        CALL cl_err()
        LET r_success = FALSE
     END IF
     # 3-1-3.計價單位
     IF cl_null(l_pact.pmdn010) THEN
        #採購中心 %1 + 幣別 %2 + 供應商 %3 + 日期 %4 + 商品編號%5 取到的計價單位為空！
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = "apm-00701"
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        LET g_errparam.replace[1] = p_pmdl.pmdl200
        LET g_errparam.replace[2] = p_pmdl.pmdl015
        LET g_errparam.replace[3] = p_pmdl.pmdl004
        LET g_errparam.replace[4] = g_today
        LET g_errparam.replace[5] = l_pmdt.pmdt006
        CALL cl_err()
        LET r_success = FALSE
     END IF
     # 3-1-4.單價
     IF cl_null(l_pact.pmdn010) THEN
        #採購中心 %1 + 幣別 %2 + 供應商 %3 + 日期 %4 + 商品編號%5 取到的單價為空！
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = "apm-00702"
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        LET g_errparam.replace[1] = p_pmdl.pmdl200
        LET g_errparam.replace[2] = p_pmdl.pmdl015
        LET g_errparam.replace[3] = p_pmdl.pmdl004
        LET g_errparam.replace[4] = g_today
        LET g_errparam.replace[5] = l_pmdt.pmdt006
        CALL cl_err()
        LET r_success = FALSE
     END IF
     
     # 3-2.取的門店清單裡的商品條碼及包裝單位
     CALL s_apmt840_get_rtdx(p_pmdl.pmdlsite,l_pmdt.pmdt006)
        RETURNING l_pmdn200,l_pmdn201
     IF cl_null(l_pmdn201) THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = "apm-00678"
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        LET g_errparam.replace[1] = l_pmdt.pmdt006
        LET g_errparam.replace[2] = p_pmdl.pmdlsite
        CALL cl_err()
        LET r_success = FALSE
     END IF
     
     LET l_pmdn228 = ''
     EXECUTE apmt860_gen_po_sel_imaa009 USING l_pmdt.pmdt006
        INTO l_pmdn228
     
     # 3-3.資料有錯誤
     IF r_success = FALSE THEN
        RETURN r_success
     END IF
     
     # 3-4.給值
     LET l_pmdn.pmdnent   = g_enterprise      #企業編號
     LET l_pmdn.pmdnsite  = p_pmdl.pmdlsite   #採購組織
     LET l_pmdn.pmdnorga  = l_pact.pmdnorga   #帳款據點
     LET l_pmdn.pmdndocno = p_pmdl.pmdldocno  #採購單號
     LET l_pmdn.pmdn001   = l_pmdt.pmdt006    #商品編號
     LET l_pmdn.pmdn002   = l_pmdt.pmdt007    #產品特徵
     LET l_pmdn.pmdn006   = l_pact.pmdn006    #採購單位
     LET l_pmdn.pmdn007   = 0                 #採購數量
     LET l_pmdn.pmdn010   = l_pact.pmdn010    #計價單位
     LET l_pmdn.pmdn011   = 0                 #計價數量
     LET l_pmdn.pmdn012   = l_pmdn014         #出貨日期
     LET l_pmdn.pmdn013   = l_pmdn014         #到廠日期
     LET l_pmdn.pmdn014   = l_pmdn014         #到庫日期
     LET l_pmdn.pmdn015   = l_pact.pmdn015    #單價
     LET l_pmdn.pmdn016   = l_pact.pmdn016    #稅別
     LET l_pmdn.pmdn017   = l_pact.pmdn017    #稅率
     LET l_pmdn.pmdn019   = l_pmdt.pmdt005    #子件特性
     LET l_pmdn.pmdn020   = '1'               #緊急度
     LET l_pmdn.pmdn022   = 'Y'               #部分交貨
     LET l_pmdn.pmdn023   = p_pmdl.pmdl022    #送貨供應商
     LET l_pmdn.pmdn024   = 'N'               #多交期
     LET l_pmdn.pmdn025   = ''                #收貨地址代碼
     LET l_pmdn.pmdn028   = ''                #收貨庫位
     LET l_pmdn.pmdn029   = ''                #收貨儲位
     LET l_pmdn.pmdn030   = ''                #收貨批號
     LET l_pmdn.pmdn031   = p_pmdl.pmdl020    #運送方式
     LET l_pmdn.pmdn045   = '1'               #行狀態
     LET l_pmdn.pmdn046   = 0                 #未稅金額
     LET l_pmdn.pmdn047   = 0                 #含稅金額
     LET l_pmdn.pmdn048   = 0                 #稅額
     LET l_pmdn.pmdn049   = ''                #理由碼
     LET l_pmdn.pmdn050   = ''                #備註
     LET l_pmdn.pmdn051   = ''                #結案理由碼
     LET l_pmdn.pmdn200   = l_pmdn200         #商品條碼     
     LET l_pmdn.pmdn201   = l_pmdn201         #包裝單位     
     LET l_pmdn.pmdn202   = 0                 #包裝數量
     LET l_pmdn.pmdn203   = ''                #收貨部門     
     LET l_pmdn.pmdn205   = l_pmdt.pmdt205    #要貨組織 
     LET l_pmdn.pmdn214   = p_pmdl.pmdl023    #採購渠道
     LET l_pmdn.pmdn216   = l_pact.pmdn216    #經營方式
     LET l_pmdn.pmdn217   = l_pact.pmdn217    #結算方式
     LET l_pmdn.pmdn218   = l_pact.pmdn218    #合約編號
     LET l_pmdn.pmdn219   = l_pact.pmdn219    #協議編號
     LET l_pmdn.pmdn220   = l_pact.pmdn220    #採購人員
     LET l_pmdn.pmdn221   = l_pact.pmdn221    #採購部門
     LET l_pmdn.pmdn222   = p_pmdl.pmdl200    #採購中心
     LET l_pmdn.pmdn223   = p_pmdl.pmdl204    #配送中心
     LET l_pmdn.pmdn224   = l_pmdn224         #採購失效日
     LET l_pmdn.pmdn225   = l_pmdt.pmdtsite   #最終收貨組織
     LET l_pmdn.pmdn228   = l_pmdn228         #商品品類

     # 3-4-1.收貨組織
     IF p_pmdl.pmdl203 = '3' THEN
        LET l_pmdn.pmdnunit = l_pmdn.pmdn223
     ELSE
        LET l_pmdn.pmdnunit = l_pmdt.pmdtsite
     END IF

     # 3-4-2.項次
     EXECUTE apmt860_pmdnseq USING p_pmdl.pmdldocno
        INTO l_pmdn.pmdnseq

     # 3-4-3.帳款地址代碼 
     CALL s_apmt840_main_addr('5',l_pmdn.pmdnorga)
        RETURNING l_pmdn.pmdn026

     # 3-4-4.檢驗否
     CALL s_apmt840_get_rtax009(l_pmdn.pmdn001)
        RETURNING l_pmdn.pmdn052

     # 3-4-5.庫存量
     CALL s_apmt840_sum_inag008(l_pmdn.pmdnunit,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn206

     # 3-4-6.採購在途量
     CALL s_apmt840_sum_in_way(l_pmdn.pmdnunit,l_pmdn.pmdn001,l_pmdn.pmdn002) #150413-00018#1 sakura add pmdn002
        RETURNING l_pmdn.pmdn207

     # 3-4-7.前日銷售量
     CALL s_daily_sale(l_pmdn.pmdn205,g_today,1,1,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn208

     # 3-4-8.上月銷售量
     CALL s_monthly_sale(l_pmdn.pmdn205,g_today,1,1,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn209

     # 3-4-9.第一週銷量
     CALL s_daily_sale(l_pmdn.pmdn205,g_today,1,7,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn210

     # 3-4-10.第二週銷量
     CALL s_daily_sale(l_pmdn.pmdn205,g_today,8,14,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn211

     # 3-4-11.第三週銷量
     CALL s_daily_sale(l_pmdn.pmdn205,g_today,15,21,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn212

     # 3-4-12.第四週銷量
     CALL s_daily_sale(l_pmdn.pmdn205,g_today,22,28,l_pmdn.pmdn001,l_pmdn.pmdn002)
        RETURNING l_pmdn.pmdn213

     # 3-4-13.渠道性質
     CALL s_apmt840_get_oojd004(l_pmdn.pmdn214)
        RETURNING l_pmdn.pmdn215
     
     # 3-5.準備要傳遞的參數值
     INITIALIZE l_pre_pmdn.* TO NULL
     LET l_pre_pmdn.pmdldocno = p_pmdl.pmdldocno    #採購單號
     LET l_pre_pmdn.pmdl005   = p_pmdl.pmdl005      #採購性質
     LET l_pre_pmdn.pmdl200   = p_pmdl.pmdl200      #採購中心
     LET l_pre_pmdn.pmdl203   = p_pmdl.pmdl203      #採購方式
     LET l_pre_pmdn.pmdl204   = p_pmdl.pmdl204      #配送中心
     LET l_pre_pmdn.pmdnsite  = l_pmdn.pmdnsite     #採購組織
     LET l_pre_pmdn.pmdnseq   = l_pmdn.pmdnseq      #項次
     LET l_pre_pmdn.pmdn001   = l_pmdn.pmdn001      #商品編號
     LET l_pre_pmdn.pmdn002   = l_pmdn.pmdn002      #產品特徵
     LET l_pre_pmdn.pmdn006   = l_pmdn.pmdn006      #採購單位
     LET l_pre_pmdn.pmdn019   = l_pmdn.pmdn019      #子件特性
     LET l_pre_pmdn.pmdn205   = l_pmdn.pmdn205      #要貨組織
     LET l_pre_pmdn.pmdn225   = l_pmdn.pmdn225      #收貨組織
     
     # 3-6.新增關聯單據
     IF NOT apmt860_gen_po_pmdp(l_pre_pmdn.*) THEN
        LET r_success = FALSE
        RETURN r_success
     END IF
     
     # 3-7.計算該項次的採購量
     EXECUTE apmt860_sum_pmdp024 USING l_pmdn.pmdndocno,l_pmdn.pmdnseq
        INTO l_pmdn.pmdn007
        
     # 3-8.由採購數量轉換成包裝數量
     LET l_success = ''
     CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn201,l_pmdn.pmdn007)
        RETURNING l_success,l_pmdn.pmdn202
     IF l_success = FALSE THEN
        LET r_success = FALSE
        RETURN r_success
     END IF
     
     # 3-9.由採購數量轉換成計價數量
     LET l_success = ''
     CALL s_aooi250_convert_qty(l_pmdn.pmdn001,l_pmdn.pmdn006,l_pmdn.pmdn010,l_pmdn.pmdn007)
        RETURNING l_success,l_pmdn.pmdn011
     IF l_success = FALSE THEN
        LET r_success = FALSE
        RETURN r_success
     END IF
     
     # 3-10.重新計算[C:未稅金額]、[C:含稅金額]、[稅額]
     CALL s_apmt840_get_amount(p_pmdl.pmdldocno,l_pmdn.pmdnseq,p_pmdl.pmdlsite,
                               p_pmdl.pmdl015,  l_pmdn.pmdn011,l_pmdn.pmdn015,
                               l_pmdn.pmdn016)
        RETURNING l_pmdn.pmdn046,l_pmdn.pmdn048,l_pmdn.pmdn047
     
     # 3-11.Insert pmdn_t
     INSERT INTO pmdn_t(pmdnent,   pmdnsite, pmdnunit, pmdnorga,
                        pmdndocno, pmdnseq,  pmdn001,  pmdn002,
                        pmdn006,   pmdn007,  pmdn010,  pmdn011,
                        pmdn012,   pmdn013,  pmdn014,  pmdn015,
                        pmdn016,   pmdn017,  pmdn019,  pmdn020,
                        pmdn022,   pmdn023,  pmdn024,  pmdn025,
                        pmdn026,   pmdn028,  pmdn029,  pmdn030,
                        pmdn031,   pmdn045,  pmdn046,  pmdn047,
                        pmdn048,   pmdn049,  pmdn050,  pmdn051,
                        pmdn052,   pmdn200,  pmdn201,  pmdn202,
                        pmdn203,   pmdn205,  pmdn206,  pmdn207,
                        pmdn208,   pmdn209,  pmdn210,  pmdn211,
                        pmdn212,   pmdn213,  pmdn214,  pmdn215,
                        pmdn216,   pmdn217,  pmdn218,  pmdn219,
                        pmdn220,   pmdn221,  pmdn222,  pmdn223,
                        pmdn224,   pmdn225,  pmdn228)
        VALUES(l_pmdn.pmdnent,   l_pmdn.pmdnsite, l_pmdn.pmdnunit, l_pmdn.pmdnorga,
               l_pmdn.pmdndocno, l_pmdn.pmdnseq,  l_pmdn.pmdn001,  l_pmdn.pmdn002,
               l_pmdn.pmdn006,   l_pmdn.pmdn007,  l_pmdn.pmdn010,  l_pmdn.pmdn011,
               l_pmdn.pmdn012,   l_pmdn.pmdn013,  l_pmdn.pmdn014,  l_pmdn.pmdn015,
               l_pmdn.pmdn016,   l_pmdn.pmdn017,  l_pmdn.pmdn019,  l_pmdn.pmdn020,
               l_pmdn.pmdn022,   l_pmdn.pmdn023,  l_pmdn.pmdn024,  l_pmdn.pmdn025,
               l_pmdn.pmdn026,   l_pmdn.pmdn028,  l_pmdn.pmdn029,  l_pmdn.pmdn030,
               l_pmdn.pmdn031,   l_pmdn.pmdn045,  l_pmdn.pmdn046,  l_pmdn.pmdn047,
               l_pmdn.pmdn048,   l_pmdn.pmdn049,  l_pmdn.pmdn050,  l_pmdn.pmdn051,
               l_pmdn.pmdn052,   l_pmdn.pmdn200,  l_pmdn.pmdn201,  l_pmdn.pmdn202,
               l_pmdn.pmdn203,   l_pmdn.pmdn205,  l_pmdn.pmdn206,  l_pmdn.pmdn207,
               l_pmdn.pmdn208,   l_pmdn.pmdn209,  l_pmdn.pmdn210,  l_pmdn.pmdn211,
               l_pmdn.pmdn212,   l_pmdn.pmdn213,  l_pmdn.pmdn214,  l_pmdn.pmdn215,
               l_pmdn.pmdn216,   l_pmdn.pmdn217,  l_pmdn.pmdn218,  l_pmdn.pmdn219,
               l_pmdn.pmdn220,   l_pmdn.pmdn221,  l_pmdn.pmdn222,  l_pmdn.pmdn223,
               l_pmdn.pmdn224,   l_pmdn.pmdn225,  l_pmdn.pmdn228)
     IF SQLCA.SQLcode  THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Ins pmdn_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
     END IF
     
     # 3-12.新增採購多交期匯總檔
     IF NOT s_apmt840_gen_pmdq(p_pmdl.pmdldocno,l_pmdn.pmdnseq) THEN
        LET r_success = FALSE
        RETURN r_success
     END IF
     
     # 3-13.新增採購交期明細檔
     IF NOT s_apmt840_gen_pmdo(p_pmdl.pmdldocno,l_pmdn.pmdnseq) THEN
        LET r_success = FALSE
        RETURN r_success
     END IF
     
     INITIALIZE l_pmdn.* TO NULL
   END FOREACH
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 根據倉退單 產生關聯單據單身檔
# Memo...........:
# Usage..........: CALL apmt860_gen_po_pmdp(p_pmdn)
#                     RETURNING r_success
# Input parameter: p_pmdn        RECORD
#                  pmdldocno     採購單號
#                  pmdl005       採購性質
#                  pmdl200       採購中心
#                  pmdl203       採購方式
#                  pmdl204       配送中心
#                  pmdnsite      採購組織
#                  pmdnseq       項次
#                  pmdn001       商品編號
#                  pmdn002       產品特徵
#                  pmdn006       採購單位
#                  pmdn019       子件特性
#                  pmdn205       要貨組織
#                  pmdn225       收貨組織
#                                END RECORD
# Return code....: r_success     True/False
# Date & Author..: 2015/01/22 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_po_pmdp(p_pmdn)
#準備要傳遞的參數
DEFINE p_pmdn        RECORD
       pmdldocno     LIKE pmdl_t.pmdldocno,   #採購單號
       pmdl005       LIKE pmdl_t.pmdl005,     #採購性質
       pmdl200       LIKE pmdl_t.pmdl200,     #採購中心
       pmdl203       LIKE pmdl_t.pmdl203,     #採購方式
       pmdl204       LIKE pmdl_t.pmdl204,     #配送中心
       pmdnsite      LIKE pmdn_t.pmdnsite,    #採購組織
       pmdnseq       LIKE pmdn_t.pmdnseq,     #項次
       pmdn001       LIKE pmdn_t.pmdn001,     #商品編號
       pmdn002       LIKE pmdn_t.pmdn002,     #產品特徵
       pmdn006       LIKE pmdn_t.pmdn006,     #採購單位
       pmdn019       LIKE pmdn_t.pmdn019,     #子件特性
       pmdn205       LIKE pmdn_t.pmdn205,     #要貨組織
       pmdn225       LIKE pmdn_t.pmdn225      #收貨組織
                     END RECORD
DEFINE r_success     LIKE type_t.num5
DEFINE l_pmdp        RECORD
       pmdpent       LIKE pmdp_t.pmdpent,     #企業編號
       pmdpdocno     LIKE pmdp_t.pmdpdocno,   #採購單號
       pmdpseq       LIKE pmdp_t.pmdpseq,     #採購項次
       pmdpseq1      LIKE pmdp_t.pmdpseq1,    #採購分批序
       pmdp001       LIKE pmdp_t.pmdp001,     #商品編號
       pmdp002       LIKE pmdp_t.pmdp002,     #產品特徵
       pmdp003       LIKE pmdp_t.pmdp003,     #來源單號
       pmdp004       LIKE pmdp_t.pmdp004,     #來源項次
       pmdp007       LIKE pmdp_t.pmdp007,     #來源商品編號
       pmdp008       LIKE pmdp_t.pmdp008,     #來源產品特徵
       pmdp021       LIKE pmdp_t.pmdp021,     #沖銷順序
       pmdp022       LIKE pmdp_t.pmdp022,     #需求單位
       pmdp023       LIKE pmdp_t.pmdp023,     #需求數量
       pmdp024       LIKE pmdp_t.pmdp024,     #折合採購量
       pmdp025       LIKE pmdp_t.pmdp025,     #已收貨量
       pmdp026       LIKE pmdp_t.pmdp026      #已入庫量
                     END RECORD
DEFINE l_pmdt        RECORD
       pmdtdocno     LIKE pmdt_t.pmdtdocno,   #倉退單號
       pmdtseq       LIKE pmdt_t.pmdtseq,     #倉退項次
       pmdt019       LIKE pmdt_t.pmdt019,     #倉退單位
       pmdt020       LIKE pmdt_t.pmdt020      #倉退數量
                     END RECORD
DEFINE l_success     LIKE type_t.num5

   LET r_success = TRUE
   
   #1.撈出符合的資料
   INITIALIZE l_pmdt.* TO NULL
   FOREACH apmt860_gen_pmdp_cs
     USING p_pmdn.pmdnsite, p_pmdn.pmdl005, p_pmdn.pmdl200, p_pmdn.pmdl203,
           p_pmdn.pmdl204,  p_pmdn.pmdn225, p_pmdn.pmdn019, p_pmdn.pmdn001,
           p_pmdn.pmdn002,  p_pmdn.pmdn205
      INTO l_pmdt.pmdtdocno, l_pmdt.pmdtseq, l_pmdt.pmdt019, l_pmdt.pmdt020
      
      # 1-1.給值
      INITIALIZE l_pmdp.* TO NULL
      LET l_pmdp.pmdpent   = g_enterprise       #企業編號
      LET l_pmdp.pmdpdocno = p_pmdn.pmdldocno   #採購單號
      LET l_pmdp.pmdpseq   = p_pmdn.pmdnseq     #採購項次
      #採購分批序
      EXECUTE apmt860_pmdpseq1 USING p_pmdn.pmdldocno,p_pmdn.pmdnseq
         INTO l_pmdp.pmdpseq1
      LET l_pmdp.pmdp001   = p_pmdn.pmdn001     #商品編號
      LET l_pmdp.pmdp002   = p_pmdn.pmdn002     #產品特徵
      LET l_pmdp.pmdp003   = l_pmdt.pmdtdocno   #來源單號
      LET l_pmdp.pmdp004   = l_pmdt.pmdtseq     #來源項次
      LET l_pmdp.pmdp007   = p_pmdn.pmdn001     #來源商品編號
      LET l_pmdp.pmdp008   = p_pmdn.pmdn002     #來源產品特徵
      LET l_pmdp.pmdp021   = l_pmdp.pmdpseq1    #沖銷順序
      LET l_pmdp.pmdp022   = l_pmdt.pmdt019     #需求單位
      LET l_pmdp.pmdp023   = l_pmdt.pmdt020     #需求數量
      #折合採購量 由需求數量轉換成採購數量
      LET l_success = ''
      CALL s_aooi250_convert_qty(l_pmdp.pmdp001,l_pmdp.pmdp022,p_pmdn.pmdn006,l_pmdp.pmdp023)
         RETURNING l_success, l_pmdp.pmdp024
      LET l_pmdp.pmdp025   = 0                  #已收貨量
      LET l_pmdp.pmdp026   = 0                  #已入庫量
      
      # 1-2.Insert pmdp_t
      INSERT INTO pmdp_t(pmdpent, pmdpdocno, pmdpseq, pmdpseq1,
                         pmdp001, pmdp002,   pmdp003, pmdp004,
                         pmdp007, pmdp008,   pmdp021, pmdp022,
                         pmdp023, pmdp024,   pmdp025, pmdp026)
         VALUES(l_pmdp.pmdpent, l_pmdp.pmdpdocno, l_pmdp.pmdpseq, l_pmdp.pmdpseq1,
                l_pmdp.pmdp001, l_pmdp.pmdp002,   l_pmdp.pmdp003, l_pmdp.pmdp004,
                l_pmdp.pmdp007, l_pmdp.pmdp008,   l_pmdp.pmdp021, l_pmdp.pmdp022,
                l_pmdp.pmdp023, l_pmdp.pmdp024,   l_pmdp.pmdp025, l_pmdp.pmdp026)
      
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Ins pmdp_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      INITIALIZE l_pmdt.* TO NULL
   END FOREACH
   
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 確認供應商相關資訊取出來的值是否為空
# Memo...........:
# Usage..........: CALL apmt860_gen_po_chk_get()
#                :    RETURNING r_success,r_pmdl.pmdl009,r_pmdl.pmdl010,r_pmdl.pmdl011,
#                :              r_pmdl.pmdl021,r_pmdl.pmdl022,r_pmdl.pmdl023,
#                :              r_pmdl.pmdl033,r_pmdl.pmdl054,r_pmdl.pmdl055
# Input parameter: 無
# Return code....: r_success      True/False
#                : r_pmdl.pmdl009 付款條件
#                : r_pmdl.pmdl010 交易條件
#                : r_pmdl.pmdl011 稅別
#                : r_pmdl.pmdl023 採購渠道
#                : r_pmdl.pmdl033 發票類型
#                : r_pmdl.pmdl054 內外購
#                : r_pmdl.pmdl055 匯率計算基準
# Date & Author..: 2015/01/22 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_gen_po_chk_get()
DEFINE r_success          LIKE type_t.num5
DEFINE r_pmdl             RECORD
       pmdl009            LIKE pmdl_t.pmdl009,  #付款條件
       pmdl010            LIKE pmdl_t.pmdl010,  #交易條件
       pmdl011            LIKE pmdl_t.pmdl011,  #稅別
       pmdl020            LIKE pmdl_t.pmdl020,  #運輸方式
       pmdl021            LIKE pmdl_t.pmdl021,  #帳款供應商
       pmdl022            LIKE pmdl_t.pmdl022,  #代送商
       pmdl023            LIKE pmdl_t.pmdl023,  #採購渠道
       pmdl033            LIKE pmdl_t.pmdl033,  #發票類型
       pmdl054            LIKE pmdl_t.pmdl054,  #內外購
       pmdl055            LIKE pmdl_t.pmdl055   #匯率計算基準
                          END RECORD
DEFINE l_pmdl             RECORD
       pmdl009            LIKE pmdl_t.pmdl009,  #付款條件
       pmdl010            LIKE pmdl_t.pmdl010,  #交易條件
       pmdl011            LIKE pmdl_t.pmdl011,  #稅別
       pmdl020            LIKE pmdl_t.pmdl020,  #運輸方式
       pmdl021            LIKE pmdl_t.pmdl021,  #帳款供應商
       pmdl022            LIKE pmdl_t.pmdl022,  #代送商
       pmdl023            LIKE pmdl_t.pmdl023,  #採購渠道
       pmdl033            LIKE pmdl_t.pmdl033,  #發票類型
       pmdl054            LIKE pmdl_t.pmdl054,  #內外購
       pmdl055            LIKE pmdl_t.pmdl055   #匯率計算基準
                          END RECORD
DEFINE l_sql              STRING

   WHENEVER ERROR CONTINUE
   LET r_success = TRUE
   INITIALIZE r_pmdl.* TO NULL
   
   #交易對象據點檔
   LET l_sql = "SELECT pmab037,pmab053,pmab034,pmab040,",
               "       pmab056,pmab057,pmab058",
               "  FROM pmab_t",
               " WHERE pmabent = ",g_enterprise,
               "   AND pmabsite = 'ALL'",
               "   AND pmab001 = ?",
               "   AND pmabstus = 'Y'"
   PREPARE apmt860_pmab FROM l_sql

   #採購渠道
   LET l_sql = "SELECT pmaa221",
               "  FROM pmaa_t",
               " WHERE pmaaent = ",g_enterprise,
               "   AND pmaa001 = ?",
               "   AND pmaastus = 'Y'"
   PREPARE apmt860_pmaa221 FROM l_sql

   #交易對象交易夥伴檔
   LET l_sql = "SELECT pmac002",
               "  FROM pmac_t",
               " WHERE pmacent = ",g_enterprise,
               "   AND pmac001 = ?",
               "   AND pmac003 = ?",
               "   AND pmac004 = 'Y'",
               "   AND pmacstus = 'Y'"
   PREPARE apmt860_pmac002 FROM l_sql
   
   #取供應商慣用資訊
   INITIALIZE l_pmdl.* TO NULL
   EXECUTE apmt860_pmab USING g_pmds_m.pmds007
      INTO l_pmdl.pmdl009,l_pmdl.pmdl010,l_pmdl.pmdl011,l_pmdl.pmdl020,
           l_pmdl.pmdl033,l_pmdl.pmdl054,l_pmdl.pmdl055

   #150506-00007#5 151216 By pomelo mark(S)
   ##付款條件
   #IF cl_null(l_pmdl.pmdl009) THEN
   #   #供應商%1+營運據點：ALL  供應商慣用付款條件為空！
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "apm-00686"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = TRUE
   #   LET g_errparam.replace[1] = g_pmds_m.pmds007
   #   CALL cl_err()
   #   LET r_success = FALSE
   #END IF
   #
   ##交易條件
   #IF cl_null(l_pmdl.pmdl010) THEN
   #   #供應商%1+營運據點：ALL  供應商慣用交易條件為空！
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "apm-00687"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = TRUE
   #   LET g_errparam.replace[1] = g_pmds_m.pmds007
   #   CALL cl_err()
   #   LET r_success = FALSE
   #END IF
   #150506-00007#5 151216 By pomelo mark(E)

   #稅別
   IF cl_null(l_pmdl.pmdl011) THEN
      #供應商%1+營運據點：ALL 供應商慣用交易稅別為空！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00688"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds007
      CALL cl_err()
      LET r_success = FALSE
   END IF

   #150506-00007#5 151216 By pomelo mark(S)
   ##發票類型
   #IF cl_null(l_pmdl.pmdl033) THEN
   #   #供應商%1+營運據點：ALL 供應商慣用發票類型為空！
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "apm-00689"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = TRUE
   #   LET g_errparam.replace[1] = g_pmds_m.pmds007
   #   CALL cl_err()
   #   LET r_success = FALSE
   #END IF
   #150506-00007#5 151216 By pomelo mark(E)

   #內外購
   IF cl_null(l_pmdl.pmdl054) THEN
      #供應商%1+營運據點：ALL 供應商慣用內外購為空！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00690"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds007
      CALL cl_err()
      LET r_success = FALSE
   END IF

   #匯率計算基準
   IF cl_null(l_pmdl.pmdl055) THEN
      #供應商%1+營運據點：ALL 供應商慣用匯率計算基準為空！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00691"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds007
      CALL cl_err()
      LET r_success = FALSE
   END IF

   EXECUTE apmt860_pmaa221 USING g_pmds_m.pmds007
      INTO l_pmdl.pmdl023
   #150626-00008#5 151626 by sakura mark(S)
   #取消採購渠道必輸控卡   
   #IF cl_null(l_pmdl.pmdl023) THEN
   #   #供應商%1 所屬渠道為空！
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "apm-00692"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = TRUE
   #   LET g_errparam.replace[1] = g_pmds_m.pmds007
   #   CALL cl_err()
   #   LET r_success = FALSE
   #END IF
   #150626-00008#5 151626 by sakura mark(S)

   #帳款供應商
   EXECUTE apmt860_pmac002 USING g_pmds_m.pmds007,'1'
      INTO l_pmdl.pmdl021
   IF cl_null(l_pmdl.pmdl021) THEN
      #供應商%1 交易夥伴關係，交易類型 = 1.收/付款對象 且 主要 且 有效 的 交易對象編號為空！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00693"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds007
      CALL cl_err()
      LET r_success = FALSE
   END IF

   #代送商
   EXECUTE apmt860_pmac002 USING g_pmds_m.pmds007,'2'
      INTO l_pmdl.pmdl022
   IF cl_null(l_pmdl.pmdl021) THEN
      #供應商%1 交易夥伴關係，交易類型 = 2.送貨對象 且 主要 且 有效 的 交易對象編號為空！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "apm-00694"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = g_pmds_m.pmds007
      CALL cl_err()
      LET r_success = FALSE
   END IF

   IF r_success THEN
      LET r_pmdl.pmdl009 = l_pmdl.pmdl009   #付款條件
      LET r_pmdl.pmdl010 = l_pmdl.pmdl010   #交易條件
      LET r_pmdl.pmdl011 = l_pmdl.pmdl011   #稅別
      LET r_pmdl.pmdl020 = l_pmdl.pmdl020   #運輸方式
      LET r_pmdl.pmdl021 = l_pmdl.pmdl021   #帳款供應商
      LET r_pmdl.pmdl022 = l_pmdl.pmdl022   #代送商
      LET r_pmdl.pmdl023 = l_pmdl.pmdl023   #採購渠道
      LET r_pmdl.pmdl033 = l_pmdl.pmdl033   #發票類型
      LET r_pmdl.pmdl054 = l_pmdl.pmdl054   #內外購
      LET r_pmdl.pmdl055 = l_pmdl.pmdl055   #匯率計算基準
   END IF

   RETURN r_success,r_pmdl.pmdl009,r_pmdl.pmdl010,r_pmdl.pmdl011,
          r_pmdl.pmdl020,r_pmdl.pmdl021,r_pmdl.pmdl022,r_pmdl.pmdl023,
          r_pmdl.pmdl033,r_pmdl.pmdl054,r_pmdl.pmdl055
END FUNCTION

################################################################################
# Descriptions...: 查詢驗退/入庫單
# Memo...........:
# Usage..........: CALL apmt860_query_docno(p_type)
# Input parameter: p_type         5.驗退單 6.入庫單
# Return code....: 無
# Date & Author..: 2015/01/23 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_query_docno(p_type)
DEFINE p_type            LIKE type_t.chr1
DEFINE l_pmdsdocno       LIKE pmds_t.pmdsdocno
DEFINE l_docno_str       STRING
DEFINE l_sql             STRING
DEFINE la_param          RECORD
       prog              STRING,
       param             DYNAMIC ARRAY OF STRING
                         END RECORD
DEFINE ls_js             STRING

   LET l_sql = "SELECT DISTINCT pmdsdocno",
               "  FROM pmds_t,pmdt_t",
               " WHERE pmdsent = pmdtent",
               "   ANd pmdsdocno = pmdtdocno",
               "   AND pmdsent = ",g_enterprise,
               "   AND pmds000 = '",p_type,"'",
               "   AND (pmds006 = '",g_pmds_m.pmdsdocno,"'",
               "    OR pmdt027 = '",g_pmds_m.pmdsdocno,"')",
               "   AND pmdsstus != 'X'"
   PREPARE apmt860_query_docno_pre FROM l_sql
   DECLARE apmt860_query_docno_cs CURSOR FOR apmt860_query_docno_pre
   
   LET l_docno_str = ''
   FOREACH apmt860_query_docno_cs INTO l_pmdsdocno
      IF cl_null(l_docno_str) THEN
         LET l_docno_str = "'",l_pmdsdocno,"'"
      ELSE
         LET l_docno_str = l_docno_str,",'",l_pmdsdocno,"'"
      END IF
   END FOREACH
   
   IF NOT cl_null(l_docno_str) THEN
      LET l_docno_str = " pmdsdocno IN (",l_docno_str,")"
      IF p_type = '5' THEN
         LET la_param.prog = 'apmt870'
      ELSE
         LET la_param.prog = 'apmt880'
      END IF
      LET la_param.param[1] = ''
      LET la_param.param[2] = l_docno_str
      LET ls_js = util.JSON.stringify(la_param)
      CALL cl_cmdrun(ls_js)
   END IF
END FUNCTION

################################################################################
# Descriptions...: 計算驗退數量
# Memo...........:
# Usage..........: CALL apmt860_pmdt055_default()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/01/23 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_pmdt055_default()
   
   #計算驗退數量
   #  當檢驗 = 'Y' 且 (無)採購收貨單
   #    驗退量 = 出貨數量 - 允收數量
   #  Else
   #    驗退量 = 0
   IF g_pmdt_d[l_ac].pmdt026 = 'Y' AND g_argv[1] MATCHES '[12]' THEN
      LET g_pmdt_d[l_ac].pmdt055 = g_pmdt_d[l_ac].pmdt020 - g_pmdt_d[l_ac].pmdt053
   ELSE
      LET g_pmdt_d[l_ac].pmdt055 = 0
   END IF
END FUNCTION

################################################################################
# Descriptions...: 檢查收貨預約單
# Memo...........:
# Usage..........: CALL apmt860_pmds200_chk()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success      True/False
# Date & Author..: 2015/05/25 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_pmds200_chk()
DEFINE r_success         LIKE type_t.num5
DEFINE l_cnt             LIKE type_t.num5

   LET r_success = TRUE
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_pmds_m.pmds200
   LET g_chkparam.arg2 = g_pmds_m.pmdssite
   IF g_argv[1] = '1' THEN
      IF NOT cl_chk_exist("v_pmeldocno") THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   ELSE
      IF NOT cl_chk_exist("v_pmeldocno_1") THEN
         LET g_pmds_m.pmds200 = g_pmds_m_o.pmds200
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   LET l_cnt = 0
   SELECT COUNT (pmdldocno) INTO l_cnt
     FROM pmel_t,pmem_t,pmdl_t,pmab_t,pmdn_t,pmdo_t
     LEFT OUTER JOIN(SELECT pmdtent,pmdt001,pmdt002,pmdt003,pmdt004,COUNT (pmdt001) cnt
                       FROM pmds_t, pmdt_t
                      WHERE pmdsent = pmdtent
                        AND pmdsdocno = pmdtdocno
                        AND pmdsstus != 'X'
                        AND (pmds000 = '1' OR pmds000 = '3')
                      GROUP BY pmdtent,pmdt001,pmdt002,pmdt003,pmdt004)
       ON pmdoent = pmdtent
      AND pmdodocno = pmdt001
      AND pmdoseq = pmdt002
      AND pmdoseq1 = pmdt003
      AND pmdoseq2 = pmdt004
    WHERE pmelent = pmement
      AND pmeldocno = pmemdocno
      AND pmdlent = pmdnent
      AND pmdldocno = pmdndocno
      AND pmdnent = pmdoent
      AND pmdndocno = pmdodocno
      AND pmdnseq = pmdoseq
      AND pmabent = pmdlent
      AND pmabsite = 'ALL'
      AND pmab001 = pmdl004
      AND pmement = pmdoent
      AND pmem001 = pmdodocno
      AND pmem002 = pmdoseq
      AND pmem003 = pmdoseq1
      AND pmem004 = pmdoseq2
      AND ( (pmdn022 = 'Y'
      AND   (COALESCE (pmab050, 0) >= 1
      AND    COALESCE (pmdl206, 'N') = 'N'
      AND    COALESCE (pmab050, 0) > COALESCE(cnt, 0)
       OR    COALESCE (pmab050, 0) = 0))
       OR   (pmdn022 = 'N' AND COALESCE(cnt, 0) = 0))
      AND pmement = g_enterprise
      AND pmemdocno = g_pmds_m.pmds200
   #輸入收貨預約單對應到採購單 必須有一筆以上 未達收貨次數！
   IF l_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'apm-00906'
         LET g_errparam.extend = g_pmds_m.pmds200
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 檢查是否走批號自動沖減
# Memo...........:
# Usage..........: CALL apmt860_chk_lot(p_cmd)
#                  RETURNING r_success
# Input parameter: p_cmd          a：新增 u：修改
# Return code....: r_success      True/False
# Date & Author..: 2015/08/18 By pomelo 150818-00010#1
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_chk_lot(p_cmd)
DEFINE p_cmd             LIKE type_t.chr1
DEFINE r_success         LIKE type_t.num5
DEFINE l_success         LIKE type_t.num5
DEFINE l_slip            LIKE ooba_t.ooba002   #單據別
DEFINE l_gzcb002         LIKE gzcb_t.gzcb002   #批號沖減方式

   LET r_success = TRUE
   
   #151109-00007#1 Add By Ken 151109(S)
   IF g_argv[1] MATCHES '[24]' OR g_argv[1] = '16' OR g_argv[1] = '17' OR g_argv[1] = '22' THEN
      LET r_success = FALSE
      RETURN r_success
   END IF 
   #151109-00007#1 Add By Ken 151109(E)
   
   IF g_prog != 'apmt890' THEN
      RETURN r_success
   END IF
   
   LET l_slip = ''
   IF p_cmd = 'a' THEN
      LET l_slip = g_pmds_m.pmdsdocno
   ELSE
      IF cl_null(g_pmds_m.pmdsdocno) THEN
         RETURN r_success
      END IF

      LET l_success = ''
      CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno)
         RETURNING l_success,l_slip
   END IF
   
   #170207-00002#1 170207 by sakura add(S)
   LET l_success = ''
   CALL s_aooi200_get_slip(g_pmds_m.pmdsdocno)
      RETURNING l_success,l_slip
   #170207-00002#1 170207 by sakura add(E)
   
   #取單別參數 批號沖減方式
   LET l_gzcb002 = ''
   CALL cl_get_doc_para(g_enterprise,g_pmds_m.pmdssite,l_slip,'D-CIR-0001')
      RETURNING l_gzcb002

   #當單別參數為空
   IF cl_null(l_gzcb002) THEN
      #取集團參數 批號沖減方式
      LET l_gzcb002 = ''
      CALL cl_get_para(g_enterprise,l_slip,'E-CIR-0029')
         RETURNING l_gzcb002
   END IF
   
   IF l_gzcb002 MATCHES '[234]' THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 檢查單身是否有採購方式為統採越庫的資料
# Memo...........:
# Usage..........: CALL apmt860_aint510_chk(p_pmdsdocno)
#                  RETURNING r_success
# Input parameter: p_pmdsdocno    收貨入庫單號
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 2016-05-06 By Ken   #160503-00033#1 Add By Ken 160506
# Modify.........:
################################################################################
PRIVATE FUNCTION apmt860_aint510_chk(p_pmdsdocno)
DEFINE p_pmdsdocno      LIKE pmds_t.pmdsdocno
DEFINE l_cnt            LIKE type_t.num5
DEFINE r_success        LIKE type_t.num5

  LET r_success = TRUE
  LET l_cnt = 0
  
  SELECT COUNT(*) INTO l_cnt
    FROM pmdt_t
   WHERE pmdtent = g_enterprise
     AND pmdtdocno = p_pmdsdocno
     AND pmdt214 = '3'

  IF l_cnt = 0 THEN
     LET r_success = FALSE     
  END IF
  
  RETURN r_success
END FUNCTION

 
{</section>}
 
