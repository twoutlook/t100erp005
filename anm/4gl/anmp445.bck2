#該程式未解開Section, 採用最新樣板產出!
{<section id="anmp445.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0003(2016-04-25 11:21:55), PR版次:0003(2016-10-24 05:53:22)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000025
#+ Filename...: anmp445
#+ Description: 支票整批列印作業
#+ Creator....: 05016(2016-04-15 16:14:08)
#+ Modifier...: 05016 -SD/PR- 08729
 
{</section>}
 
{<section id="anmp445.global" >}
#應用 p02 樣板自動產生(Version:19)
#add-point:填寫註解說明
#Memos
#160816-00012#2   2016/08/29 By 01727    ANM增加资金中心，帐套，法人三个栏位权限
#161021-00050#1   2016/10/24 By 08729    處理組織開窗
#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT util
#add-point:增加匯入項目

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
    
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)  #注意要在add-point內寫入END RECORD
   nmckdocno     LIKE nmck_t.nmckdocno,
   nmckcomp      LIKE nmck_t.nmckcomp,
   nmcd003       LIKE nmcd_t.nmcd003,
   sel           LIKE type_t.chr1,
   nmck005       LIKE nmck_t.nmck005,
   nmck005_desc  LIKE type_t.chr100,
   nmck003       LIKE nmck_t.nmck003,
   nmck003_desc  LIKE type_t.chr100,
   nmck015       LIKE nmck_t.nmck015,
   nmck011       LIKE nmck_t.nmck011,
   nmck103       LIKE nmck_t.nmck103
    END RECORD

#單頭
TYPE type_master   RECORD
   nmcksite        LIKE nmck_t.nmcksite,
   nmcksite_desc   LIKE type_t.chr500,
   nmckcomp        LIKE nmck_t.nmckcomp,
   nmckcomp_desc   LIKE type_t.chr500,
   nmck004         LIKE nmck_t.nmck004,
   nmck004_desc    LIKE type_t.chr500,
   nmas003         LIKE nmas_t.nmas003,
   nmck002         LIKE nmck_t.nmck002,
   nmck024         LIKE nmck_t.nmck024,
   nmaf010         LIKE nmaf_t.nmaf010,
   l_a1            LIKE type_t.num5,
   l_a2            LIKE type_t.num5,
   l_str           LIKE type_t.chr80,
   l_end           LIKE type_t.chr80   
END RECORD

DEFINE g_master      type_master
DEFINE g_wc_nmcksite STRING
DEFINE g_wc_nmckcomp STRING
DEFINE g_apcald      LIKE glaa_t.glaald
DEFINE g_wc_filter2  STRING
DEFINE g_sql_bank            STRING     
DEFINE g_master_wc   STRING
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)

#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明

#end add-point
 
{</section>}
 
{<section id="anmp445.main" >}
#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   
   #end add-point   
   #add-point:main段define
   
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("anm","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_anmp445 WITH FORM cl_ap_formpath("anm",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL anmp445_init()   
 
      #進入選單 Menu (="N")
      CALL anmp445_ui_dialog() 
 
      #add-point:畫面關閉前
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_anmp445
   END IF 
   
   #add-point:作業離開前
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="anmp445.init" >}
#+ 畫面資料初始化
PRIVATE FUNCTION anmp445_init()
   #add-point:init段define
   
   #end add-point   
   #add-point:init段define
   
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   CALL anmp445_set_combo_scc('nmck002','30')
   #組織下階成員所需之暫存檔
   CALL s_fin_create_account_center_tmp() 
   LET g_sql_bank=NULL
   CALL s_anmi120_get_bank_account_sql(g_user,g_dept) RETURNING g_sub_success,g_sql_bank
   CALL anmp445_qbe_clear()
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="anmp445.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION anmp445_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE l_nmaa003              LIKE nmaa_t.nmaa003
   DEFINE l_nmag002              LIKE nmag_t.nmag002   
   DEFINE l_n                    LIKE type_t.num5
   DEFINE l_nmas001              LIKE nmas_t.nmas001
  #160816-00012#2 Add  ---(S)---
   DEFINE  l_count    LIKE type_t.num5
   DEFINE  l_wc       STRING
   DEFINE  l_sql      STRING
  #160816-00012#2 Add  ---(E)---
   #end add-point 
   #add-point:ui_dialog段define
   
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL anmp445_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         
         #end add-point
         #add-point:ui_dialog段input
         INPUT BY NAME g_master.nmcksite,g_master.nmckcomp,g_master.nmck004,g_master.nmck002,g_master.nmck024,
                       g_master.nmaf010,g_master.l_a1,g_master.l_a2,g_master.l_str,g_master.l_end
                       
            ATTRIBUTE(WITHOUT DEFAULTS)
                          
            AFTER FIELD nmcksite
               LET g_master.nmcksite_desc = ' '
               DISPLAY BY NAME g_master.nmcksite_desc
               IF NOT cl_null(g_master.nmcksite) THEN 
                  CALL s_fin_account_center_with_ld_chk(g_master.nmcksite,'',g_user,'6','N','',g_today) RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.nmcksite = g_site
                     LET g_master.nmcksite_desc = s_desc_get_department_desc(g_master.nmcksite)
                     LET g_master.nmckcomp = ''
                     LET g_master.nmckcomp_desc = ''
                     LET g_wc_nmcksite = ''
                     LET g_wc_nmckcomp = ''
                     DISPLAY BY NAME g_master.nmcksite,g_master.nmcksite_desc,g_master.nmckcomp,g_master.nmckcomp_desc
                     NEXT FIELD CURRENT
                  END IF
                  #資金中心預設主帳套及主帳套所屬法人及其他預設值         
                  CALL s_fin_orga_get_comp_ld(g_master.nmcksite) RETURNING g_sub_success,g_errno,g_master.nmckcomp,g_apcald   
                  CALL s_fin_account_center_sons_query('6',g_master.nmcksite,g_today,'1')
                  #160816-00012#2 Add  ---(S)---
                  #检查用户是否有资金中心对应法人的权限
                  CALL s_axrt300_get_site(g_user,'','3') RETURNING l_wc
                  LET l_count = 0
                  LET l_sql = "SELECT COUNT(*) FROM ooef_t WHERE ooefent = '",g_enterprise,"' ",
                              "   AND ooef001 = '",g_master.nmckcomp,"'",
                              "   AND ooef003 = 'Y'",
                              "   AND ",l_wc CLIPPED
                  PREPARE anmp410_count_prep FROM l_sql
                  EXECUTE anmp410_count_prep INTO l_count
                  IF cl_null(l_count) THEN LET l_count = 0 END IF
                  IF l_count = 0 THEN
                     LET g_master.nmckcomp = ''
                     LET g_master.nmckcomp_desc = ''
                     DISPLAY BY NAME g_master.nmckcomp,g_master.nmckcomp_desc
                  END IF
                  #160816-00012#2 Add  ---(E)---
                  #取得資金中心底下的法人範圍               
                  CALL s_fin_account_center_comp_str() RETURNING g_wc_nmckcomp
                  CALL s_fin_get_wc_str(g_wc_nmckcomp) RETURNING g_wc_nmckcomp 
                  LET g_master.nmcksite_desc = s_desc_get_department_desc(g_master.nmcksite)
                  LET g_master.nmckcomp_desc = s_desc_get_department_desc(g_master.nmckcomp)
                  DISPLAY BY NAME g_master.nmcksite,g_master.nmcksite_desc,g_master.nmckcomp,g_master.nmckcomp_desc
               ELSE                        
                  LET g_master.nmcksite_desc = ''
                  LET g_master.nmckcomp      = ''
                  LET g_master.nmckcomp_desc = ''
                  LET g_wc_nmcksite = ''
                  LET g_wc_nmckcomp = ''
                  DISPLAY BY NAME g_master.nmcksite,g_master.nmcksite_desc,g_master.nmckcomp,g_master.nmckcomp_desc
               END IF
               
            AFTER FIELD nmckcomp
               LET g_master.nmckcomp_desc = ' '
               DISPLAY BY NAME g_master.nmckcomp_desc
               IF NOT cl_null(g_master.nmckcomp) THEN
                  #取得資金組織底下所屬的法人範圍
                  CALL s_fin_account_center_comp_str() RETURNING g_wc_nmckcomp
                  #將取回的字串轉換為SQL條件
                  CALL s_fin_get_wc_str(g_wc_nmckcomp) RETURNING g_wc_nmckcomp
                  CALL anmp445_nmcksite_chk() RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.replace[1] = 'aooi125'
                     LET g_errparam.replace[2] = cl_get_progname("aooi125",g_lang,"2")
                     LET g_errparam.exeprog ='aooi125'
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.nmckcomp = ''
                     LET g_master.nmckcomp_desc = ''
                     DISPLAY BY NAME g_master.nmckcomp_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #比對輸入的法人是否在資金組織下
                  IF s_chr_get_index_of(g_wc_nmckcomp,g_master.nmckcomp,'1') = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'anm-00274'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.nmckcomp = ''
                     LET g_master.nmckcomp_desc = ''
                     DISPLAY BY NAME g_master.nmckcomp_desc
                     NEXT FIELD CURRENT
                  END IF
                  #160816-00012#2 Add  ---(S)---
                  #检查用户是否有资金中心对应法人的权限
                  CALL s_axrt300_get_site(g_user,'','3') RETURNING l_wc
                  LET l_count = 0
                  LET l_sql = "SELECT COUNT(*) FROM ooef_t WHERE ooefent = '",g_enterprise,"' ",
                              "   AND ooef001 = '",g_master.nmckcomp,"'",
                              "   AND ooef003 = 'Y'",
                              "   AND ",l_wc CLIPPED
                  PREPARE anmp410_count_prep1 FROM l_sql
                  EXECUTE anmp410_count_prep1 INTO l_count
                  IF cl_null(l_count) THEN LET l_count = 0 END IF
                  IF l_count = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "ais-00228"
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     NEXT FIELD CURRENT
                  END IF
                  #160816-00012#2 Add  ---(E)---
                  LET g_master.nmckcomp_desc = s_desc_get_department_desc(g_master.nmckcomp)
                  DISPLAY BY NAME g_master.nmckcomp_desc     
               END IF
               
            AFTER FIELD nmck004
               IF NOT cl_null(g_master.nmck004) THEN 
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_master.nmck004
                  LET g_chkparam.arg2 = g_master.nmckcomp
                  IF cl_chk_exist("v_nmas002_1") THEN 
                     IF NOT s_anmi120_nmll002_chk(g_master.nmck004,g_user) THEN
                       INITIALIZE g_errparam TO NULL 
                       LET g_errparam.extend = g_master.nmck004
                       LET g_errparam.code   = 'anm-00574' 
                       LET g_errparam.popup  = TRUE 
                       CALL cl_err()
                       LET g_master.nmck004 = ''
                       LET g_master.nmas003 = ''
                       DISPLAY BY NAME g_master.nmas003,g_master.nmck004            
                       NEXT FIELD CURRENT
                     END IF
                     SELECT nmaa003 INTO l_nmaa003 #帳戶類型
                       FROM nmaa_t,nmas_t
                      WHERE nmaaent = g_enterprise
                        AND nmaaent = nmasent
                        AND nmaa001 = nmas001
                        AND nmas002 = g_master.nmck004 
                        AND nmaa002 IN (select ooef001 FROM ooef_t WHERE ooefent = g_enterprise
                                                                     AND ooef017 = g_master.nmckcomp)

                     SELECT nmag002 INTO l_nmag002 #帳戶運用類型
                       FROM nmag_t
                      WHERE nmagent = g_enterprise
                        AND nmag001 = l_nmaa003
                         
                     IF l_nmag002 <> '1' AND l_nmag002 <> '4' THEN 
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'anm-00258'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_master.nmck004 = ''
                        LET g_master.nmas003 = ''
                        DISPLAY BY NAME g_master.nmas003,g_master.nmck004
                        NEXT FIELD nmck004
                     END IF
                     #帳戶編碼
                      SELECT nmas001 INTO l_nmas001
                        FROM nmas_t
                       WHERE nmasent = g_enterprise
                         AND nmas002 = g_master.nmck004
                      SELECT nmaal003 INTO g_master.nmck004_desc FROM nmaal_t WHERE nmaalent = g_enterprise 
                         AND nmaal001 = l_nmas001 AND nnaal002 = g_dlang                     
                     #交易幣別
                     LET g_master.nmas003 = ''
                     SELECT nmas003 INTO g_master.nmas003 
                       FROM nmaa_t,nmas_t
                      WHERE nmaaent = g_enterprise
                        AND nmaaent = nmasent
                        AND nmaa001 = nmas001
                        AND nmas002 = g_master.nmck004 
                        AND nmaa002 IN (SELECT ooef001 FROM ooef_t WHERE ooefent = g_enterprise AND ooef017 = g_master.nmckcomp)
                     DISPLAY BY NAME g_master.nmas003,g_master.nmck004,g_master.nmck004_desc
                  ELSE
                     LET g_master.nmas003 = ''
                     LET g_master.nmck004 = ''
                     LET g_master.nmck004_desc = ''
                     DISPLAY BY NAME g_master.nmas003,g_master.nmck004,g_master.nmck004_desc
                  END IF
               END IF
               
            AFTER FIELD nmck024               
               IF NOT cl_null(g_master.nmck024) THEN
                  CALL anmp445_nmck024_chk() RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = FALSE
                     CALL cl_err()               
                     LET g_master.nmck024=''
                     LET g_master.nmaf010 = ''
                     DISPLAY BY NAME g_master.nmaf010,g_master.nmck024
                     NEXT FIELD nmck024
                  END IF
                  CALL anmp445_nmaf_ref()
               END IF
               
            ON CHANGE nmck002
               LET g_master.nmck024 = ''
               LET g_master.nmaf010 = ''
               LET g_master.l_a1 = ''
               DISPLAY BY NAME g_master.nmck024,g_master.nmaf010,g_master.l_a1

                                                                                       
            ON ACTION controlp INFIELD nmcksite
               #開窗i段
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.nmcksite    #給予default值
               #LET g_qryparam.where = " ooef206 = 'Y'"                      #161021-00050#1 mark
               #CALL q_ooef001()                                #呼叫開窗     #161021-00050#1 mark
               CALL q_ooef001_33()                                           #161021-00050#1 add
               LET g_master.nmcksite = g_qryparam.return1              
               LET g_master.nmcksite_desc = s_desc_get_department_desc(g_master.nmcksite)
               DISPLAY BY NAME g_master.nmcksite,g_master.nmcksite_desc                
               NEXT FIELD nmcksite  
            
            ON ACTION controlp INFIELD nmckcomp
               #開窗i段
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.nmckcomp    #給予default值
               CALL s_fin_account_center_sons_query('6',g_master.nmcksite,g_today,'1')
               #取得資金中心底下的法人範圍               
               CALL s_fin_account_center_comp_str() RETURNING g_wc_nmckcomp
               CALL s_fin_get_wc_str(g_wc_nmckcomp) RETURNING g_wc_nmckcomp
               LET g_master.nmckcomp_desc = s_desc_get_department_desc(g_master.nmckcomp)
               DISPLAY BY NAME g_master.nmckcomp,g_master.nmckcomp_desc               
               LET g_qryparam.where = " ooef003 = 'Y' AND ooef001 IN ",g_wc_nmckcomp CLIPPED
               #160816-00012#2 Add  ---(S)---
               CALL s_axrt300_get_site(g_user,'','1') RETURNING l_wc
               LET g_qryparam.where = g_qryparam.where," AND ",l_wc CLIPPED
               #160816-00012#2 Add  ---(E)---
               CALL q_ooef017_01()                                #呼叫開窗
               LET g_master.nmckcomp = g_qryparam.return1  
               LET g_master.nmckcomp_desc = s_desc_get_department_desc(g_master.nmckcomp)
               DISPLAY BY NAME g_master.nmckcomp,g_master.nmckcomp_desc            
               NEXT FIELD nmckcomp                          #返回原欄位
            
            ON ACTION controlp INFIELD nmck004           
               #開窗i段
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE               
               LET g_qryparam.default1 = g_master.nmck004             #給予default值
               LET g_qryparam.where = " nmaa002 IN (select ooef001 FROM ooef_t WHERE ooefent = '",g_enterprise,"'",
                                      "              AND ooef017 = '",g_master.nmckcomp,"')",
                                      " AND nmaa003 IN (SELECT nmag001 FROM nmag_t WHERE nmagent = '",g_enterprise,"'",
                                      "                    AND (nmag002 = '1' OR nmag002 = '4'))"
               LET g_qryparam.where =g_qryparam.where CLIPPED, " AND  nmas002 IN (",g_sql_bank,")"
               CALL q_nmas_01()                                #呼叫開窗
               LET g_master.nmck004 = g_qryparam.return1        
               LET g_master.nmas003 = ''
               SELECT nmas003 INTO g_master.nmas003 
                 FROM nmaa_t,nmas_t
                WHERE nmaaent = g_enterprise
                  AND nmaaent = nmasent
                  AND nmaa001 = nmas001
                  AND nmas002 = g_master.nmck004 
                  AND nmaa002 IN (SELECT ooef001 FROM ooef_t WHERE ooefent = g_enterprise AND ooef017 = g_master.nmckcomp)
                  #帳戶編碼
                  SELECT nmas001 INTO l_nmas001
                    FROM nmas_t
                   WHERE nmasent = g_enterprise
                     AND nmas002 = g_master.nmck004
                  SELECT nmaal003 INTO g_master.nmck004_desc FROM nmaal_t WHERE nmaalent = g_enterprise 
                     AND nmaal001 = l_nmas001 AND nnaal002 = g_dlang 
               DISPLAY BY NAME g_master.nmas003,g_master.nmck004,g_master.nmck004_desc                             
               NEXT FIELD nmck004                          #返回原欄位
             
             
            ON ACTION controlp INFIELD nmck024
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.nmck024            
               LET g_qryparam.arg1 = g_master.nmck004 
               LET g_qryparam.arg2 = g_master.nmck002               
               CALL q_nmaf004()                                              
               LET g_master.nmck024 = g_qryparam.return1
               CALL anmp445_nmaf_ref()
               DISPLAY g_master.nmck024 TO nmck024                        
               NEXT FIELD nmck024                          
             
         END INPUT 
         #end add-point
         #add-point:ui_dialog段自定義display array
         INPUT ARRAY g_detail_d FROM s_detail1.*
            ATTRIBUTE(COUNT = g_detail_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                       INSERT ROW = FALSE,
                       DELETE ROW = FALSE,
                       APPEND ROW = FALSE)
            BEFORE ROW
               LET l_ac = ARR_CURR()
               DISPLAY l_ac TO FORMONLY.h_index
               
            ON CHANGE b_sel
               LET g_master.l_a2 = 0           
               FOR l_n = 1 TO g_detail_d.getLength()
                  IF g_detail_d[l_n].sel = "Y" THEN
                     CALL anmp445_nmaf_ref()
                     LET g_master.l_a2 = g_master.l_a2 + 1
                     IF g_master.l_a2 > g_master.l_a1 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'anm-00401'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_master.l_a2 = g_master.l_a2 - 1
                        LET g_detail_d[l_n].sel = "N"
                        DISPLAY BY NAME g_master.l_a2
                     END IF
                  END IF
               END FOR
               DISPLAY BY NAME g_master.l_a2
            
            
         END INPUT
        
         CONSTRUCT BY NAME g_wc ON nmckdocno,nmckdocdt
            BEFORE CONSTRUCT
            
            ON ACTION controlp INFIELD nmckdocno
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.where = " nmck002 IN (SELECT ooia001 FROM ooia_t  WHERE ooia002 = '30' AND ooiaent = ",g_enterprise," )",
                                      " AND nmcksite = '",g_master.nmcksite,"'  ",
                                      " AND nmckcomp = '",g_master.nmckcomp,"' AND nmck004 = '",g_master.nmck004,"'    ",
                                      " AND nmck002 = '",g_master.nmck002,"'   AND nmck026 IN('0','1')                 ",
                                      " AND nmckstus = 'Y' AND nmck024 IS NULL AND nmck025 IS NULL "
               CALL q_nmckdocno()                       
               DISPLAY g_qryparam.return1 TO nmckdocno  
               NEXT FIELD nmckdocno                     
            
         END CONSTRUCT  
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            LET g_master.l_a2 = 0    
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               LET g_master.l_a2 = g_master.l_a2 + 1
               IF g_master.l_a2 > g_master.l_a1 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'anm-00401'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_master.l_a2 = g_master.l_a2 - 1
                  LET g_detail_d[l_n].sel = "N"
                  DISPLAY BY NAME g_master.l_a2
                  EXIT FOR
               END IF            
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
             DISPLAY BY NAME g_master.l_a2
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
 
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            LET g_master.l_a2 = 0   
            DISPLAY BY NAME g_master.l_a2            
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            LET g_master.l_a2 = 0           
            FOR l_n = 1 TO g_detail_d.getLength()
               IF g_detail_d[l_n].sel = "Y" THEN
                  LET g_master.l_a2 = g_master.l_a2 + 1
                  IF g_master.l_a2 > g_master.l_a1 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'anm-00401'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.l_a2 = g_master.l_a2 - 1
                     LET g_detail_d[l_n].sel = "N"
                     DISPLAY BY NAME g_master.l_a2
                  END IF
               END IF
            END FOR
            DISPLAY BY NAME g_master.l_a2
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            LET g_master.l_a2 = 0           
            FOR l_n = 1 TO g_detail_d.getLength()
               IF g_detail_d[l_n].sel = "Y" THEN
                  LET g_master.l_a2 = g_master.l_a2 + 1
                  IF g_master.l_a2 > g_master.l_a1 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'anm-00401'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.l_a2 = g_master.l_a2 - 1
                     LET g_detail_d[l_n].sel = "N"
                     DISPLAY BY NAME g_master.l_a2
                  END IF
               END IF
            END FOR
            DISPLAY BY NAME g_master.l_a2
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL anmp445_filter()
            #add-point:ON ACTION filter
            #單身資料二次搜尋
            CALL anmp445_filter2()
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            
            #end add-point
            CALL anmp445_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            CALL anmp445_qbe_clear()
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            
            #end add-point
            CALL anmp445_b_fill()
 
         #add-point:ui_dialog段action
         ON ACTION batch_execute
            CALL anmp445_process()
            CALL anmp445_b_fill()
            CALL anmp445_nmaf_ref()
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
{</section>}
 
{<section id="anmp445.query" >}
#+ QBE資料查詢
PRIVATE FUNCTION anmp445_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   
   #end add-point 
   #add-point:query段define
   
   #end add-point 
    
   #add-point:cs段after_construct
   
   #end add-point
        
   LET g_error_show = 1
   CALL anmp445_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="anmp445.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION anmp445_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   
   #end add-point
   #add-point:b_fill段define
   
   #end add-point
 
   #add-point:b_fill段sql_before
   IF cl_null(g_wc) THEN
      LET g_wc = "1=1"
   END IF
   IF cl_null(g_wc_filter2) THEN
      LET g_wc_filter2 = "1=1"
   END IF 
   LET g_master.l_a2 = 0
   
   LET g_sql = " SELECT nmckdocno,nmckcomp,'','N',nmck005, ",
               "        (SELECT pmaal004 FROM pmaal_t WHERE pmaal001 = nmck005 AND pmaalent = nmckent AND pmaal002 = '",g_dlang,"'), ",
               "         nmck003, ",
               "        (SELECT ooag011 FROM ooag_t WHERE ooag001 = nmck003 and ooagent = nmckent), ",
               "         nmck015,nmck011,nmck103 ",
               "   FROM nmck_t  ",                
               "  WHERE nmckent = ?                        AND nmcksite = '",g_master.nmcksite,"'  ",
               "    AND nmckcomp = '",g_master.nmckcomp,"' AND nmck004 = '",g_master.nmck004,"'    ",
               "    AND nmck002 = '",g_master.nmck002,"'   AND nmckstus = 'Y'                      ",
               "    AND nmck026 IN('0','1')  AND nmck024 IS NULL AND nmck025 IS NULL               ",
               "    AND ",g_wc , 
               "    AND ",g_wc_filter2,             
               "  ORDER BY nmckdocno,nmck005 "               
               
   #end add-point
 
   PREPARE anmp445_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR anmp445_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   g_detail_d[l_ac].*
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
     
      #end add-point
      
      CALL anmp445_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   IF g_detail_d.getLength() > 0 THEN
      CALL g_detail_d.deleteElement(g_detail_d.getLength())
   END IF
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE anmp445_sel
   
   LET l_ac = 1
   CALL anmp445_fetch()
   #add-point:b_fill段資料填充(其他單身)
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="anmp445.fetch" >}
#+ 單身陣列填充2
PRIVATE FUNCTION anmp445_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   
   #end add-point
   #add-point:fetch段define
   
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
 
{</section>}
 
{<section id="anmp445.detail_show" >}
#+ 顯示相關資料
PRIVATE FUNCTION anmp445_detail_show()
   #add-point:show段define
   
   #end add-point
   #add-point:show段define
   
   #end add-point
   
   #add-point:detail_show段
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="anmp445.filter" >}
#+ filter過濾功能
PRIVATE FUNCTION anmp445_filter()
   #add-point:filter段define
   RETURN
   #end add-point    
   #add-point:filter段define
   
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL anmp445_b_fill()
   
END FUNCTION
 
{</section>}
 
{<section id="anmp445.filter_parser" >}
#+ filter欄位解析
PRIVATE FUNCTION anmp445_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   
   #end add-point    
   #add-point:filter段define
   
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="anmp445.filter_show" >}
#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION anmp445_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = anmp445_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="anmp445.other_function" readonly="Y" >}
#add-point:自定義元件(Function)

################################################################################
# Descriptions...: 預設
# Memo...........:
# Usage..........: CALL anmp445_qbe_clear()
# Date & Author..: 2016/04/15 By Hans
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_qbe_clear()
   #清空二次條件
   LET g_wc_filter2 = ""
   LET g_master.l_str =''
   LET g_master.l_end =''
   LET g_master.nmck004 = ''
   LET g_master.nmas003 = ''
   LET g_master.nmck002 = '301'
   LET g_master.nmck024 = ''
   LET g_master.nmaf010 = ''
   LET g_master.l_a1 = 0
   LET g_master.l_a2 = 0
   
   DISPLAY '' TO nmckdocno  
   DISPLAY '' TO nmckdocdt
   LET g_wc = '1=1 '
   CALL g_detail_d.clear()

   CALL s_fin_account_center_sons_query('6',g_master.nmcksite,g_today,'1')
   #取得資金中心底下的法人範圍               
   CALL s_fin_account_center_comp_str() RETURNING g_wc_nmckcomp
   CALL s_fin_get_wc_str(g_wc_nmckcomp) RETURNING g_wc_nmckcomp 
   
   #預設值
   LET g_master.nmcksite = g_site
   LET g_master.nmcksite_desc = s_desc_get_department_desc(g_master.nmcksite)
   CALL s_fin_orga_get_comp_ld(g_master.nmcksite) RETURNING g_sub_success,g_errno,g_master.nmckcomp,g_apcald
   LET g_master.nmckcomp_desc = s_desc_get_department_desc(g_master.nmckcomp)
   LET g_master.l_a2 = 0
   
   DISPLAY BY NAME g_master.nmcksite,g_master.nmcksite_desc,g_master.nmckcomp,
                   g_master.nmckcomp_desc,g_master.l_a2,g_master.l_str,g_master.l_end,
                   g_master.nmck004,g_master.nmas003,g_master.nmck002,g_master.nmck024,
                   g_master.nmaf010,g_master.l_a1,g_master.l_a2
   
END FUNCTION

################################################################################
# Descriptions...: 檢驗是否在組織下之有效的法人
# Memo...........:
# Usage..........: CALL anmp445_nmcksite_chk()
# Date & Author..: 2016/04/15 By Hans
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_nmcksite_chk()
DEFINE l_ooefstus          LIKE ooef_t.ooefstus
DEFINE r_success           LIKE type_t.num5
DEFINE r_errno             LIKE gzze_t.gzze001

   LET r_success = TRUE
   LET r_errno = ''
   
   SELECT ooefstus INTO l_ooefstus
     FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_master.nmcksite  
   CASE 
      WHEN SQLCA.SQLCODE = 100 LET r_errno = 'aoo-00094' LET r_success = FALSE
      WHEN l_ooefstus = 'N'    LET r_errno = 'sub-01302' LET r_success = FALSE    
   END CASE
   
   RETURN r_success,r_errno
END FUNCTION

################################################################################
# Descriptions...: 設置nmck002下拉選項
# Memo...........:
# Usage..........: CALL anmp445_set_combo_scc(p_field,p_scc)
# Date & Author..: 2016/04/20 By Hans
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_set_combo_scc(p_field,p_scc)
DEFINE p_field        LIKE type_t.chr80
DEFINE p_scc          LIKE type_t.chr10
DEFINE ps_values      STRING
DEFINE ps_items       STRING
DEFINE pc_ooia001     LIKE ooia_t.ooia001      
DEFINE pc_ooial003    LIKE ooial_t.ooial003  
DEFINE li_cnt         LIKE type_t.num5
DEFINE ps_field_name  STRING
DEFINE lcbo_target    ui.ComboBox
DEFINE ls_temp        STRING
DEFINE l_sql          STRING
DEFINE pa_array DYNAMIC ARRAY OF RECORD
          value       STRING,
          label_tag   STRING,
          label       STRING
                END RECORD

   LET l_sql = "SELECT ooia001,ooial003",
               "  FROM ooia_t LEFT JOIN ooial_t   ON ooial001 = ooia001",
               "                                 AND ooial002 = '",g_lang,"'",
               "                                 AND ooiaent = ooialent",
               "                                 AND ooiaent = ",g_enterprise,
               " WHERE ooia002 = '",p_scc,"' AND ooiaent=",g_enterprise
   PREPARE p_scc_itemp_pe FROM l_sql
   DECLARE p_scc_itemp_cs CURSOR FOR p_scc_itemp_pe

   LET ps_values = ''
   LET ps_items = ''

   #將選項填入陣列
   LET li_cnt = 1
   FOREACH p_scc_itemp_cs INTO pc_ooia001, pc_ooial003
      LET pa_array[li_cnt].value = pc_ooia001 CLIPPED
      LET pa_array[li_cnt].label_tag = pc_ooia001 CLIPPED
      LET pa_array[li_cnt].label = pc_ooial003 CLIPPED
      LET li_cnt = li_cnt + 1
   END FOREACH

   LET ps_field_name = p_field

   LET ps_field_name = ps_field_name.trim()

   LET lcbo_target = ui.ComboBox.forName(ps_field_name)

   #以下是Combobox的處理
   FOR li_cnt = 1 TO pa_array.getLength()
       IF cl_null(pa_array[li_cnt].label_tag) THEN
          LET ls_temp = pa_array[li_cnt].label
       ELSE
          LET ls_temp = pa_array[li_cnt].label_tag,":",pa_array[li_cnt].label
       END IF
      CALL lcbo_target.addItem(pa_array[li_cnt].value,ls_temp)
   END FOR
END FUNCTION

################################################################################
# Descriptions...: 支票簿號檢核
# Memo...........:
# Usage..........: CALL anmp445_nmck024_chk
# Date & Author..: 2016/04/20 By Hans
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_nmck024_chk()
DEFINE l_nmaf007      LIKE nmaf_t.nmaf007
DEFINE l_nmaf010      LIKE nmaf_t.nmaf010
DEFINE l_nmaf012      LIKE nmaf_t.nmaf012
DEFINE l_nmaf011      LIKE nmaf_t.nmaf011
DEFINE r_success      LIKE type_t.num5
DEFINE r_errno        LIKE gzze_t.gzze001
   
   LET r_errno="" LET r_success = TRUE
   SELECT nmaf010,nmaf007,nmaf012,nmaf011 
     INTO l_nmaf010,l_nmaf007,l_nmaf012,l_nmaf011
     FROM nmaf_t    
    WHERE nmafent = g_enterprise 
      AND nmaf001 = g_master.nmck004 #交易帳戶
      AND nmaf002 = g_master.nmck002 #票據類型
      AND nmaf004 = g_master.nmck024 #支票簿 
              
   CASE
      WHEN SQLCA.sqlcode=100     LET r_errno="anm-00150" LET r_success = FALSE
      WHEN l_nmaf010>=l_nmaf007  LET r_errno="anm-00151" LET r_success = FALSE
      WHEN l_nmaf012<>'Y'        LET r_errno="anm-00152" LET r_success = FALSE
   END CASE
   
   DISPLAY g_master.nmaf010
   RETURN r_success,r_errno
   
   
   
END FUNCTION

################################################################################
# Descriptions...: 支票簿相關資訊
# Memo...........:
# Usage..........: CALL anmp445_nmaf_ref()
# Date & Author..: 2016/04/20 By Hans
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_nmaf_ref()
DEFINE l_nmaf  RECORD LIKE nmaf_t.*
DEFINE r_success      LIKE type_t.num5
DEFINE r_errno        LIKE gzze_t.gzze001
DEFINE  l_nmaf006             STRING
DEFINE  l_nmaf006_str         STRING
DEFINE  l_nmaf010             STRING
DEFINE  l_nmaf010_str         STRING
DEFINE  l_nmaf010_num         LIKE type_t.num5
   
   SELECT * INTO l_nmaf.*
     FROM nmaf_t    
    WHERE nmafent = g_enterprise 
      AND nmaf001 = g_master.nmck004 #交易帳戶
      AND nmaf002 = g_master.nmck002 #票據類型
      AND nmaf004 = g_master.nmck024 #支票簿 
      
   #計算已使用張數         
   LET l_nmaf006 = l_nmaf.nmaf006
   LET l_nmaf010 = l_nmaf.nmaf010
   LET l_nmaf006_str = l_nmaf006.substring(l_nmaf006.getLength()-l_nmaf.nmaf009+1,l_nmaf006.getLength())
   LET l_nmaf010_str = l_nmaf010.substring(l_nmaf010.getLength()-l_nmaf.nmaf009+1,l_nmaf010.getLength())
   LET l_nmaf010_str = l_nmaf010_str - l_nmaf006_str
   LET l_nmaf010_num = l_nmaf010_str
   #剩餘張數
   LET g_master.l_a1 = l_nmaf.nmaf008 - l_nmaf010_num 

   LET g_master.nmaf010 = l_nmaf.nmaf010
   DISPLAY BY NAME  g_master.nmaf010,g_master.l_a1

END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_process()
DEFINE l_n          LIKE type_t.num5    
DEFINE l_cnt        LIKE type_t.num5
DEFINE l_print_type LIKE type_t.chr500  #列印參數
DEFINE l_i          LIKE type_t.num5    
DEFINE l_nmcd003    LIKE nmcd_t.nmcd003
DEFINE l_nmcd0032   LIKE nmcd_t.nmcd003
DEFINE l_wc         STRING              
DEFINE l_nmcd003_wc STRING
DEFINE l_sql        STRING
DEFINE l_str_num    LIKE nmcd_t.nmcd003
DEFINE l_end_num    LIKE nmcd_t.nmcd003
DEFINE l_flag       LIKE type_t.chr1

   #總共有幾筆資料要跑
   LET l_cnt = 0
   FOR l_n = 1 TO g_detail_d.getLength()
      IF g_detail_d[l_n].sel = "Y" THEN
         LET l_cnt = l_cnt + 1
      END IF
   END FOR

  
   #取得有勾選的條件
   FOR l_i = 1 TO g_detail_cnt
      IF g_detail_d[l_i].sel = 'N' THEN
         CONTINUE FOR 
      ELSE
         IF cl_null(l_wc) THEN
            LET l_wc = g_detail_d[l_i].nmckdocno 
         ELSE
            LET l_wc = l_wc,"','",g_detail_d[l_i].nmckdocno                                
         END IF
     
      END IF
   END FOR
   #如未勾選任何一筆資料
   IF cl_null(l_wc) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axr-00159'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()       
      LET g_success = 'N'
      RETURN
   ELSE
      LET l_wc = "('",l_wc,"')"      
   END IF
   
   #列印需求
   LET g_master_wc = " nmckent = ",g_enterprise," AND nmckdocno IN ",l_wc CLIPPED 

   CALL anmp445_g01(g_master_wc)
   
   IF cl_ask_confirm("anm-00400")  THEN
      LET l_flag = 'N' 
      LET l_sql = " SELECT * FROM nmcd_t WHERE nmcdent = '",g_enterprise,"' ",
                  "    AND nmcd001 = ? AND nmcd002 = ? AND nmcd003 = ?      ",
                  "    AND nmcd008 = 'N' FOR UPDATE                         "
      DECLARE anmp445_cs CURSOR FROM l_sql 
      FOR l_n = 1 TO g_detail_d.getLength()
         IF g_detail_d[l_n].sel = "Y" THEN                  
            WHILE TRUE
               IF s_transaction_chk("N",0) THEN
                  CALL s_transaction_begin()
               END IF
               #找出可用最小號
               LET l_nmcd003 = '' LET l_nmcd0032 = ''
               SELECT MIN(nmcd003) INTO l_nmcd003 FROM nmcd_t
                WHERE nmcdent = g_enterprise AND nmcd002 = g_master.nmck024
                  AND nmcd001 = g_master.nmck004
                  AND nmcd008 = 'N' AND nmcd009 = 'N'
               #更新  
               OPEN anmp445_cs USING g_master.nmck004,g_master.nmck024,l_nmcd003
               #table被鎖住 取下一筆
               IF STATUS THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "OPEN anmp445_cl:"
                  LET g_errparam.code   = STATUS
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  CLOSE anmp445_cs
                  CONTINUE WHILE
               END IF
               IF l_flag = 'N' THEN LET l_str_num = l_nmcd003 END IF            
               #更新
               UPDATE nmcd_t SET nmcd009 = 'Y'
                WHERE nmcdent = g_enterprise AND nmcd002 = g_master.nmck024
                  AND nmcd001 = g_master.nmck004 AND nmcd003 = l_nmcd003
                  AND nmcd008 = 'N'              
               #更新nmck_t               
               UPDATE nmck_t 
                  SET nmck024 = g_master.nmck024,nmck025 = l_nmcd003
                WHERE nmckent = g_enterprise AND nmckcomp = g_master.nmckcomp
                  AND nmckdocno = g_detail_d[l_n].nmckdocno                              
               CLOSE anmp445_cs
               #找出可用最小號/更新支票檔案
               SELECT MIN(nmcd003) INTO l_nmcd0032 FROM nmcd_t
                WHERE nmcdent = g_enterprise AND nmcd002 = g_master.nmck024
                  AND nmcd001 = g_master.nmck004
                  AND nmcd008 = 'N' AND nmcd009 = 'N'               
               
               UPDATE nmaf_t SET nmaf010 = l_nmcd0032               
                WHERE nmafent = g_enterprise 
                  AND nmaf001 = g_master.nmck004 #交易帳戶
                  AND nmaf002 = g_master.nmck002 #票據類型
                  AND nmaf004 = g_master.nmck024 #支票簿                   
               LET l_flag = 'Y'
               LET l_end_num = l_nmcd003
               IF NOT cl_null(l_nmcd003) THEN CALL s_transaction_end('Y','0') EXIT WHILE END IF               
            END WHILE            
            LET l_cnt = l_cnt + 1
         END IF
      END FOR   
      LET g_master.l_str = l_str_num
      LET g_master.l_end = l_end_num
      DISPLAY BY NAME g_master.l_str,g_master.l_end
      CALL anmp445_g02(g_master_wc)
   END IF



END FUNCTION

################################################################################
# Descriptions...: 單身二次搜索
# Memo...........:
# Usage..........: CALL anmp445_filter2()
# Date & Author..: 2016/04/25 By Hans
# Modify.........:
################################################################################
PRIVATE FUNCTION anmp445_filter2()
DEFINE l_wc_filter2_t STRING
   
   LET INT_FLAG = 0

   LET l_ac = 1
   LET g_detail_cnt = 1
  
   LET l_wc_filter2_t = g_wc_filter2
   LET g_wc_t = g_wc
   
    #使用DIALOG包住 
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      #進行二次搜尋的欄位
      CONSTRUCT g_wc_filter2 ON nmck005,nmck003,nmck015,nmck011,nmck103
           FROM s_detail1[1].b_nmck005,s_detail1[1].b_nmck003,s_detail1[1].b_nmck015,
                s_detail1[1].b_nmck011,s_detail1[1].b_nmck103
      
         BEFORE CONSTRUCT
        
       ON ACTION controlp INFIELD b_nmck003
           #開窗c段
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'c'
           LET g_qryparam.reqry = FALSE
           CALL q_ooag001()                           #呼叫開窗
           DISPLAY g_qryparam.return1 TO nmck003  #顯示到畫面上
           NEXT FIELD b_nmck003            
        
        ON ACTION controlp INFIELD b_nmck005
           #開窗c段
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'c'
           LET g_qryparam.reqry = FALSE
           CALL q_pmaa001_10()                    #呼叫開窗
           DISPLAY g_qryparam.return1 TO b_nmck005  #顯示到畫面上
           NEXT FIELD b_nmck005  
      END CONSTRUCT
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG
 
     &include "common_action.4gl"
     CONTINUE DIALOG
     
   END DIALOG 

      
      IF NOT INT_FLAG THEN
         LET g_wc_filter2 = g_wc_filter2, " "
      ELSE
         LET g_wc_filter2 = l_wc_filter2_t
      END IF
      
      CALL anmp445_b_fill()
   
END FUNCTION

#end add-point
 
{</section>}
 
