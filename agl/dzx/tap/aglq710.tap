<add_points prog="aglq710" std_prog="aglq710" erpver="1.0" module="AGL" ver="1" env="s" zone="t10dev" booking="Y">
  <point name="construct.c.page1.b_glar001" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = "glac001 = '",g_glaa004,"' AND glac006 = '1'"
            CALL aglt310_04()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar001  #顯示到畫面上

            NEXT FIELD b_glar001                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.glar001" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[]]>
</point>
  <point name="input.a.page1.glarld" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="function.aglq710_create_temp_table" cite_std="N" status="" ver="1" src="s" new="Y" order="1" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 建立臨時表
# Memo...........:
# Usage..........: CALL aglq710_create_temp_table()
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_create_temp_table()
   DROP TABLE aglq710_tmp
   CREATE TEMP TABLE aglq710_tmp(
   glar001      VARCHAR(24),
   glar009      VARCHAR(10),
   oyeard       DECIMAL(20,6),
   oyearc       DECIMAL(20,6),
   yeard        DECIMAL(20,6),
   yearc        DECIMAL(20,6),
   yeard2       DECIMAL(20,6),
   yearc2       DECIMAL(20,6),
   yeard3       DECIMAL(20,6),
   yearc3       DECIMAL(20,6),
   oqcd         DECIMAL(20,6),
   oqcc         DECIMAL(20,6),
   qcd          DECIMAL(20,6),
   qcc          DECIMAL(20,6),
   qcd2         DECIMAL(20,6),
   qcc2         DECIMAL(20,6),
   qcd3         DECIMAL(20,6),
   qcc3         DECIMAL(20,6),
   oqjd         DECIMAL(20,6),
   oqjc         DECIMAL(20,6),
   qjd          DECIMAL(20,6),
   qjc          DECIMAL(20,6),
   qjd2         DECIMAL(20,6),
   qjc2         DECIMAL(20,6),
   qjd3         DECIMAL(20,6),
   qjc3         DECIMAL(20,6),
   oqmd         DECIMAL(20,6),
   oqmc         DECIMAL(20,6),
   qmd          DECIMAL(20,6),
   qmc          DECIMAL(20,6),
   qmd2         DECIMAL(20,6),
   qmc2         DECIMAL(20,6),
   qmd3         DECIMAL(20,6),
   qmc3         DECIMAL(20,6),
   osumd        DECIMAL(20,6),
   osumc        DECIMAL(20,6),
   sumd         DECIMAL(20,6),
   sumc         DECIMAL(20,6),
   sumd2        DECIMAL(20,6),
   sumc2        DECIMAL(20,6),
   sumd3        DECIMAL(20,6),
   sumc3        DECIMAL(20,6))
END FUNCTION]]>
</point>
  <point name="function.aglq710_set_curr_show" cite_std="N" status="" ver="1" src="s" new="Y" order="2" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 設置本位幣二、別你幣三顯示否
# Memo...........:
# Usage..........: CALL aglq710_set_curr_show()
# Date & Author..: 2014/03/13 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_set_curr_show()
   
   #顯示本位幣二
   IF tm.ctype='1' THEN
      CALL cl_set_comp_visible("yeard2,yearc2,qcd2,qcc2,qjd2,qjc2,qmd2,qmc2,sumd2,sumc2",TRUE)
   ELSE
      CALL cl_set_comp_visible("yeard2,yearc2,qcd2,qcc2,qjd2,qjc2,qmd2,qmc2,sumd2,sumc2",FALSE)
   END IF
   #顯示本位幣三
   IF tm.ctype='2' THEN
      CALL cl_set_comp_visible("yeard3,yearc3,qcd3,qcc3,qjd3,qjc3,qmd3,qmc3,sumd3,sumc3",TRUE)
   ELSE
      CALL cl_set_comp_visible("yeard3,yearc3,qcd3,qcc3,qjd3,qjc3,qmd3,qmc3,sumd3,sumc3",FALSE)
   END IF
   #全部
   IF tm.ctype='3' THEN
      CALL cl_set_comp_visible("yeard2,yearc2,qcd2,qcc2,qjd2,qjc2,qmd2,qmc2,sumd2,sumc2",TRUE)
      CALL cl_set_comp_visible("yeard3,yearc3,qcd3,qcc3,qjd3,qjc3,qmd3,qmc3,sumd3,sumc3",TRUE)
   END IF
END FUNCTION]]>
</point>
  <point name="function.aglq710_glaald_desc" cite_std="N" status="" ver="1" src="s" new="Y" order="3" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 獲取帳套相關資料
# Memo...........:
# Usage..........: CALL aglq710_glaald_desc(p_glaald)
# Input parameter: p_glaald   帳套
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_glaald_desc(p_glaald)
   DEFINE  p_glaald    LIKE glaa_t.glaald
   
    INITIALIZE g_ref_fields TO NULL
    LET g_ref_fields[1] = p_glaald 
    CALL ap_ref_array2(g_ref_fields,"SELECT glaal002 FROM glaal_t WHERE glaalent='"||g_enterprise||"' AND glaalld=? AND glaal001='"||g_dlang||"'","") RETURNING g_rtn_fields
    LET g_glaald_desc=g_rtn_fields[1]
    #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
   SELECT glaacomp,glaa001,glaa002,glaa003,glaa004,glaa013,
          glaa015,glaa016,glaa017,glaa018,glaa019,glaa020,
          glaa021,glaa022 
     INTO g_glaacomp,g_glaa001,g_glaa002,g_glaa003,g_glaa004,g_glaa013,
          g_glaa015,g_glaa016,g_glaa017,g_glaa018,g_glaa019,g_glaa020,
          g_glaa021,g_glaa022
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glaald 
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_glaacomp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_glaacomp_desc= g_rtn_fields[1]
  
   #本位幣二
   IF g_glaa015='Y' THEN
      CALL cl_set_comp_visible("glaa016",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa016",FALSE)
   END IF
   #本位幣三
   IF g_glaa019='Y' THEN
      CALL cl_set_comp_visible("glaa020",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa020",FALSE)
   END IF 
   #多本位幣
   CALL cl_set_comp_visible("ctype",TRUE)
   CASE
      WHEN g_glaa015<>'Y' AND g_glaa019<>'Y' 
         CALL cl_set_comp_visible("ctype",FALSE)
         LET tm.ctype=''
      WHEN g_glaa015='Y' AND g_glaa019<>'Y' 
         CALL cl_set_combo_scc_part('ctype','9921','1')
         LET tm.ctype='1'
      WHEN g_glaa015<>'Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','2')
         LET tm.ctype='2'  
      WHEN g_glaa015='Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','1,2,3')
         LET tm.ctype='3'
   END CASE
   CALL aglq710_set_curr_show() #顯示本位幣二、本位幣三
END FUNCTION]]>
</point>
  <point name="function.aglq710_get_data" cite_std="N" status="u" ver="1" src="s" new="Y" order="4" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 抓取數據
# Memo...........:
# Usage..........: CALL aglq710_get_data()
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_get_data()
   DEFINE l_pdate_s1       LIKE glav_t.glav004 #起始年度+期別對應的起始截止日期
   DEFINE l_pdate_e1       LIKE glav_t.glav004
   DEFINE l_pdate_s2       LIKE glav_t.glav004 #截止年度+期別對應的起始截止日期
   DEFINE l_pdate_e2       LIKE glav_t.glav004
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_flag           LIKE type_t.num5    #表示是否是完整期別
   DEFINE l_sql,l_sql1,l_sql2   STRING
   DEFINE l_sql3,l_sql4         STRING
   DEFINE l_wc,l_wc1            STRING 
   DEFINE l_glar001        LIKE glar_t.glar001
   DEFINE l_glar001_desc   LIKE glacl_t.glacl004
   DEFINE l_glar009        LIKE glar_t.glar009
   DEFINE l_oyeard         LIKE type_t.num20_6
   DEFINE l_oyearc         LIKE type_t.num20_6
   DEFINE l_yeard          LIKE type_t.num20_6
   DEFINE l_yearc          LIKE type_t.num20_6
   DEFINE l_yeard2         LIKE type_t.num20_6
   DEFINE l_yearc2         LIKE type_t.num20_6
   DEFINE l_yeard3         LIKE type_t.num20_6
   DEFINE l_yearc3         LIKE type_t.num20_6
   DEFINE l_oqcd           LIKE type_t.num20_6
   DEFINE l_oqcc           LIKE type_t.num20_6
   DEFINE l_qcd            LIKE type_t.num20_6
   DEFINE l_qcc            LIKE type_t.num20_6
   DEFINE l_qcd2           LIKE type_t.num20_6
   DEFINE l_qcc2           LIKE type_t.num20_6
   DEFINE l_qcd3           LIKE type_t.num20_6
   DEFINE l_qcc3           LIKE type_t.num20_6
   DEFINE l_oqjd           LIKE type_t.num20_6
   DEFINE l_oqjc           LIKE type_t.num20_6
   DEFINE l_qjd            LIKE type_t.num20_6
   DEFINE l_qjc            LIKE type_t.num20_6
   DEFINE l_qjd2           LIKE type_t.num20_6
   DEFINE l_qjc2           LIKE type_t.num20_6
   DEFINE l_qjd3           LIKE type_t.num20_6
   DEFINE l_qjc3           LIKE type_t.num20_6
   DEFINE l_oqmd           LIKE type_t.num20_6
   DEFINE l_oqmc           LIKE type_t.num20_6
   DEFINE l_qmd            LIKE type_t.num20_6
   DEFINE l_qmc            LIKE type_t.num20_6
   DEFINE l_qmd2           LIKE type_t.num20_6
   DEFINE l_qmc2           LIKE type_t.num20_6
   DEFINE l_qmd3           LIKE type_t.num20_6
   DEFINE l_qmc3           LIKE type_t.num20_6
   DEFINE l_osumd          LIKE type_t.num20_6
   DEFINE l_osumc          LIKE type_t.num20_6
   DEFINE l_sumd           LIKE type_t.num20_6
   DEFINE l_sumc           LIKE type_t.num20_6
   DEFINE l_sumd2          LIKE type_t.num20_6
   DEFINE l_sumc2          LIKE type_t.num20_6
   DEFINE l_sumd3          LIKE type_t.num20_6
   DEFINE l_sumc3          LIKE type_t.num20_6
   DEFINE l_amt1           LIKE type_t.num20_6
   DEFINE l_amt2           LIKE type_t.num20_6
   DEFINE l_amt3           LIKE type_t.num20_6
   DEFINE l_amt4           LIKE type_t.num20_6
   DEFINE l_amt5           LIKE type_t.num20_6
   DEFINE l_amt6           LIKE type_t.num20_6
   DEFINE l_amt7           LIKE type_t.num20_6
   DEFINE l_amt8           LIKE type_t.num20_6
   DEFINE l_period         LIKE glap_t.glap004
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_str,l_str1,l_str2   STRING
   DEFINE l_glac002        LIKE glac_t.glac002
   DEFINE l_glav004        LIKE glav_t.glav004
   DEFINE l_glav004_m      LIKE glav_t.glav004
   DEFINE l_glav004_e      LIKE glav_t.glav004
   
   #刪除臨時表中資料
   DELETE FROM aglq710_tmp
   
   CALL s_get_accdate(g_glaa003,'',tm.syear,tm.speriod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s1,l_pdate_e1,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      CALL cl_err('',l_errno,0)
   END IF

   CALL s_get_accdate(g_glaa003,'',tm.eyear,tm.eperiod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s2,l_pdate_e2,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      CALL cl_err('',l_errno,0)
   END IF

   #判斷是否是整期間查詢
   IF tm.sdate=l_pdate_s1 AND tm.edate=l_pdate_e2 THEN
      LET l_flag=TRUE
   ELSE
      LET l_flag=FALSE
   END IF
   
   LET l_wc=cl_replace_str(g_wc,'glar001','glaq002')
   LET l_wc1=cl_replace_str(g_wc1,'glar009','glaq005')
   LET l_sql1=cl_replace_str(g_wc,'glar001','glac002')
   #顯示統制科目否
   IF tm.show_acc<>'Y' THEN
      LET l_sql1=l_sql1," AND glac003<>'1' "
   END IF
   #科目層級
   IF NOT cl_null(tm.glac005) THEN
      LET l_sql1=l_sql1," AND glac005<=",tm.glac005
   END IF
   #含內部管理科目否
   IF tm.glac009<>'Y' THEN
      LET l_sql1=l_sql1," AND glac009<>'Y'"
   END IF
   #顯示月結CE憑證否
   IF tm.show_ce<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'CE' "
      LET l_sql3="'CE'"
   END IF
   #顯示年結YE憑證否
   IF tm.show_ye<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'YE' "
      IF NOT cl_null(l_sql3) THEN
         LET l_sql3=l_sql3,",'YE'"
      ELSE
         LET l_sql3="'YE'" 
      END IF
   END IF
   IF NOT cl_null(l_sql3) THEN
      LET l_sql3=" AND glap007 IN (",l_sql3,")"
   END IF
   #單據狀態
   CASE
      WHEN tm.stus='1'
         LET l_sql4=l_sql4," AND glapstus='S' "
      WHEN tm.stus='2'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y') "
      WHEN tm.stus='3'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y','N') "
   END CASE
   
   #抓出所有符合條件的會計科目
   LET g_sql="SELECT glac002 FROM glac_t",
             " WHERE glacent=",g_enterprise,
             "   AND glac001='",g_glaa004,"' AND ",l_sql1,
             " ORDER BY glac002"
   PREPARE aglq710_sel_glac_pr FROM g_sql
   DECLARE aglq710_sel_glac_cs CURSOR FOR aglq710_sel_glac_pr
   
   #當顯示原幣時抓取幣別資料
   IF tm.curr_o='Y' THEN
      IF l_flag=TRUE THEN
         LET g_sql="(SELECT DISTINCT glar009 FROM glar_t ",
                   "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' AND glar001 = ?" 
         IF tm.syear<>tm.eyear THEN
            LET g_sql=g_sql," AND ( (glar002=",tm.syear,") ",
                            "  OR (glar002=",tm.eyear," AND glar003<=",tm.eperiod," AND glar003<>0)  )"
         ELSE
            LET g_sql=g_sql," AND glar002=",tm.syear,
                            " AND glar003<=",tm.eperiod
         END IF
         LET g_sql=g_sql," AND ",g_wc," AND ",g_wc1,")" 
         #單據狀態      
         IF tm.stus MATCHES '[23]' THEN
            LET g_sql=g_sql,
                      " UNION ALL ",
                      "(SELECT DISTINCT glaq005 glar009 ", 
                      "   FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                      "  WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                      "    AND glapdocdt <='",tm.edate,"' AND glap002>=",tm.syear
             CASE
                WHEN tm.stus='2'
                   LET g_sql=g_sql," AND glapstus='Y'"
                WHEN tm.stus='3'
                   LET g_sql=g_sql," AND glapstus IN ('Y','N')"
            END CASE
            LET g_sql=g_sql,l_sql2," AND ",l_wc," AND ",l_wc1,")"
         END IF
         LET g_sql="SELECT DISTINCT glar009",
                   "  FROM (",g_sql,")",
                   " ORDER BY glar009"                  
      ELSE 
         LET g_sql="SELECT DISTINCT glaq005",
                   "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                   " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                   "    AND glapdocdt <='",tm.edate,"' AND glap002>=",tm.syear
         LET g_sql=g_sql,l_sql2,l_sql4," AND ",l_wc," AND ",l_wc1                  
      END IF
   END IF
   PREPARE aglq710_sel_pr FROM g_sql
   DECLARE aglq710_sel_cr CURSOR FOR aglq710_sel_pr
  
   #期間異動
   IF l_flag=TRUE THEN
      LET l_sql="(SELECT glar010,glar011,glar005,glar006,glar034,glar035,glar036,glar037",
                "   FROM glar_t",
                "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' AND glar001 = ?"
      IF tm.curr_o='Y' THEN 
         LET l_sql=l_sql," AND glar009=? "
      END IF
      IF tm.syear<>tm.eyear THEN
         LET l_sql=l_sql," AND ( (glar002=",tm.syear," AND glar003>=",tm.speriod,") ",
                         "  OR (glar002=",tm.eyear," AND glar003<=",tm.eperiod," AND glar003<>0) )"
      ELSE
         LET l_sql=l_sql," AND glar002=",tm.syear,
                         " AND glar003 BETWEEN ",tm.speriod," AND ",tm.eperiod
      END IF
      LET l_sql=l_sql," AND ",g_wc," AND ",g_wc1,")"  
      #單據狀態      
      IF tm.stus MATCHES '[23]' THEN
         LET l_sql=l_sql,
                   " UNION ALL ",
                   "(SELECT (CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END) glar010,",
                   "        (CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END) glar011,",
                   "        glaq003 glar005,glaq004 glar006,glaq040 glar034,",
                   "        glaq041 glar035,glaq043 glar036,glaq044 glar037",
                   "   FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                   "  WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                   "    AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
         IF tm.curr_o='Y' THEN 
            LET l_sql=l_sql," AND glaq005=? "
         END IF
         CASE
             WHEN tm.stus='2'
                LET l_sql=l_sql," AND glapstus='Y'"
             WHEN tm.stus='3'
                LET l_sql=l_sql," AND glapstus IN ('Y','N')"
         END CASE
         LET l_sql=l_sql,l_sql2," AND ",l_wc," AND ",l_wc1,")"
      END IF
      LET l_sql="SELECT SUM(glar010),SUM(glar011),SUM(glar005),SUM(glar006),",
                "       SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037)",
                "  FROM (",l_sql,")"
      
   ELSE 
      LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
                "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
                "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044)",
                "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
      LET l_sql=l_sql,l_sql2,l_sql4," AND ",l_wc," AND ",l_wc1
      IF tm.curr_o='Y' THEN 
         LET l_sql=l_sql," AND glaq005=? "
      END IF
   END IF 
   PREPARE aglq710_sel_pr5 FROM l_sql
   
   #期間異動：抓取CE、YE傳票金額
   LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
             "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
             "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044)",
             "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
             " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
             "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
   LET l_sql=l_sql,l_sql3," AND glapstus='S'  AND ",l_wc," AND ",l_wc1
   IF tm.curr_o='Y' THEN 
      LET l_sql=l_sql," AND glaq005=? "
   END IF
   PREPARE aglq710_sel_pr8 FROM l_sql
   
   #年初、期初
   LET l_sql="SELECT SUM(glar010-glar011),SUM(glar005-glar006),SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
             " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
             "   AND glar001 = ? AND glar002=? AND glar003<=?  "
   IF tm.curr_o='Y' THEN
      LET l_sql=l_sql," AND glar009=?"
   END IF
   PREPARE aglq710_sel_pr1 FROM l_sql
   #期初：抓取CE、YE傳票金額
   LET l_sql="SELECT SUM(CASE WHEN glaq003=0 THEN glaq010*-1 ELSE glaq010 END),",
              "      SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
              "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
              " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
              "   AND glap002= ? AND glap004<=? ",
              "   AND glaq002 LIKE ? ",
              "   AND glapstus='S' ",
              "   AND ",l_wc," AND ",l_wc1,l_sql3
   IF tm.curr_o='Y' THEN
      LET l_sql=l_sql," AND glaq005=?"
   END IF
   PREPARE aglq710_sel_pr6 FROM l_sql 
   
   
   #期初：根據不同傳票類型抓glaq_t資料(stus=1/2/3)   
   LET l_sql="SELECT SUM(CASE WHEN glaq003=0 THEN glaq010*-1 ELSE glaq010 END),",
              "      SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
              "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
              " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
              "   AND glapdocdt BETWEEN ? AND ? ",
              "   AND glaq002 LIKE ? ",
              "   AND ",l_wc," AND ",l_wc1,l_sql2,l_sql4
   IF tm.curr_o='Y' THEN
      LET l_sql=l_sql," AND glaq005=?"
   END IF
   PREPARE aglq710_sel_pr2 FROM l_sql 
   
   #本年累計
   LET l_sql="SELECT SUM(glar010),SUM(glar011),SUM(glar005),SUM(glar006),",
             "       SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037) FROM glar_t",    
             " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
             "   AND glar001 = ? AND glar002=? AND glar003<=? "
   IF tm.curr_o='Y' THEN
      LET l_sql=l_sql," AND glar009=?"
   END IF
   PREPARE aglq710_sel_pr3 FROM l_sql
   LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
             "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
             "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
             "       SUM(glaq043),SUM(glaq044) ",
             "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
             " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
             "   AND glap002= ? AND glap004<=? ",
             "   AND glaq002 LIKE ? ",
             "   AND glapstus='S' ",
             "   AND ",l_wc," AND ",l_wc1,l_sql3
   IF tm.curr_o='Y' THEN
      LET l_sql=l_sql," AND glaq005=? "
   END IF
   PREPARE aglq710_sel_pr7 FROM l_sql
   
   #破期本年累計
   LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
             "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
             "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
             "       SUM(glaq043),SUM(glaq044) ",
             "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
             " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
             "   AND glapdocdt BETWEEN ? AND ? ",
             "   AND glaq002 LIKE ? ",
             "   AND ",l_wc," AND ",l_wc1,l_sql2,l_sql4
   IF tm.curr_o='Y' THEN
      LET l_sql=l_sql," AND glaq005=? "
   END IF
   PREPARE aglq710_sel_pr4 FROM l_sql
   
   CALL cl_showmsg_init()
   LET l_success = TRUE
   
   #抓取該年第一天
   SELECT MIN(glav004) INTO l_glav004 FROM glav_t
    WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=tm.syear
   #抓取上一期最後一天
   LET l_period=tm.speriod-1 #上期
   SELECT MAX(glav004) INTO l_glav004_m FROM glav_t
    WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=tm.syear AND glav006=l_period
   #获取期初截止日期
   IF tm.sdate=l_pdate_s1 THEN
      LET l_glav004_e=l_glav004_m
   ELSE
      LET l_glav004_e=tm.sdate-1
   END IF
   FOREACH aglq710_sel_glac_cs INTO l_glac002
      IF SQLCA.sqlcode THEN
         CALL cl_errmsg('','FOREACH aglq710_sel_glac_cs','',SQLCA.sqlcode,1)
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      LET l_glar001=l_glac002,"%"
      
      #根據是否勾選顯示原幣抓取值
      IF tm.curr_o<>'Y' THEN
         #年初金額
         IF tm.show_y='Y' THEN
            LET l_period=0
            EXECUTE aglq710_sel_pr1 USING l_glac002,tm.syear,l_period
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr1','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            IF l_amt2>0 THEN
               LET l_oyeard=l_amt1
               LET l_oyearc=0
               LET l_yeard =l_amt2
               LET l_yearc =0
               LET l_yeard2=l_amt3
               LET l_yearc2=0
               LET l_yeard3=l_amt4
               LET l_yearc3=0
            ELSE
               LET l_oyeard=0
               LET l_oyearc=-1*l_amt1
               LET l_yeard =0
               LET l_yearc =-1*l_amt2
               LET l_yeard2=0
               LET l_yearc2=-1*l_amt3
               LET l_yeard3=0
               LET l_yearc3=-1*l_amt4
            END IF 
         ELSE
            LET l_oyeard=0
            LET l_oyearc=0
            LET l_yeard =0
            LET l_yearc =0
            LET l_yeard2=0
            LET l_yearc2=0
            LET l_yeard3=0
            LET l_yearc3=0
         END IF
         
         #期初金額
         LET l_amt1=0
         LET l_amt2=0
         LET l_amt3=0
         LET l_amt4=0
         LET l_amt5=0
         LET l_amt6=0
         LET l_amt7=0
         LET l_amt8=0
         LET l_period=tm.speriod-1 #上期
         #當整期間且傳狀態為stus=1:已過帳時，抓取匯總glar_t,否則抓取資料來源為glaq_t
         IF tm.sdate=l_pdate_s1 AND tm.stus='1' THEN  
            #匯總上期之前已過帳資料
            EXECUTE aglq710_sel_pr1 USING l_glac002,tm.syear,l_period
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr1','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            #當不包含CE或YE憑證時，減去CE或YE傳票金額
            IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
               EXECUTE aglq710_sel_pr6 USING tm.syear,l_period,l_glar001
                                        INTO l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr6','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
               LET l_amt1=l_amt1-l_amt5
               LET l_amt2=l_amt2-l_amt6
               LET l_amt3=l_amt3-l_amt7
               LET l_amt4=l_amt4-l_amt8
            END IF
         #當為破期時，匯總該年第一天到查詢條件的起始日期tm.sdate的傳票資料
         ELSE
            #抓取年初金額
            LET l_period=0
            EXECUTE aglq710_sel_pr1 USING l_glac002,tm.syear,l_period
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr1','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            LET l_period=tm.speriod-1 #上期
            IF l_period>0 THEN
               EXECUTE aglq710_sel_pr2 USING l_glav004,l_glav004_e,l_glar001
                                        INTO l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr2','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
            IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
            IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
            IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
            LET l_amt1=l_amt1+l_amt5
            LET l_amt2=l_amt2+l_amt6
            LET l_amt3=l_amt3+l_amt7
            LET l_amt4=l_amt4+l_amt8
         END IF
         
         IF l_amt2>0 THEN
            LET l_oqcd=l_amt1
            LET l_oqcc=0
            LET l_qcd =l_amt2
            LET l_qcc =0
            LET l_qcd2=l_amt3
            LET l_qcc2=0
            LET l_qcd3=l_amt4
            LET l_qcc3=0
         ELSE
            LET l_oqcd=0
            LET l_oqcc=-1*l_amt1
            LET l_qcd =0
            LET l_qcc =-1*l_amt2
            LET l_qcd2=0
            LET l_qcc2=-1*l_amt3
            LET l_qcd3=0
            LET l_qcc3=-1*l_amt4
         END IF
         
         #期間異動
         IF l_flag=TRUE THEN
            IF tm.stus MATCHES '[23]' THEN
               EXECUTE aglq710_sel_pr5 USING l_glac002,l_glar001
                                        INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
            ELSE
               EXECUTE aglq710_sel_pr5 USING l_glac002
                                        INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
            END IF
         ELSE
            EXECUTE aglq710_sel_pr5 USING l_glar001
                                     INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq710_sel_pr5','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         IF cl_null(l_oqjd) THEN LET l_oqjd=0 END IF
         IF cl_null(l_oqjc) THEN LET l_oqjc=0 END IF
         IF cl_null(l_qjd)  THEN LET l_qjd=0  END IF
         IF cl_null(l_qjc)  THEN LET l_qjc=0  END IF
         IF cl_null(l_qjd2) THEN LET l_qjd2=0 END IF
         IF cl_null(l_qjc2) THEN LET l_qjc2=0 END IF
         IF cl_null(l_qjd3) THEN LET l_qjd3=0 END IF
         IF cl_null(l_qjc3) THEN LET l_qjc3=0 END IF
         
         #當不包含CE或YE憑證時，減去CE或YE傳票金額
         IF l_flag=TRUE AND (tm.show_ce<>'Y' OR tm.show_ye<>'Y') THEN
            EXECUTE aglq710_sel_pr8 USING l_glar001
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr8','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
            IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
            IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
            IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
            LET l_oqjd=l_oqjd-l_amt1
            LET l_oqjc=l_oqjc-l_amt2
            LET l_qjd =l_qjd -l_amt3
            LET l_qjc =l_qjc -l_amt4
            LET l_qjd2=l_qjd2-l_amt5
            LET l_qjc2=l_qjc2-l_amt6
            LET l_qjd3=l_qjd3-l_amt7
            LET l_qjc3=l_qjc3-l_amt8
         END IF
         
         #期末金額=期初+期間
         #原幣
         LET l_amt1=(l_oqcd+l_oqjd)-(l_oqcc+l_oqjc)
         IF l_amt1>0 THEN
            LET l_oqmd=l_amt1
            LET l_oqmc=0
         ELSE
            LET l_oqmd=0
            LET l_oqmc=l_amt1*-1
         END IF
         #本幣
         LET l_amt1=(l_qcd+l_qjd)-(l_qcc+l_qjc)
         IF l_amt1>0 THEN
            LET l_qmd=l_amt1
            LET l_qmc=0
         ELSE
            LET l_qmd=0
            LET l_qmc=l_amt1*-1
         END IF
         #本幣二
         LET l_amt1=(l_qcd2+l_qjd2)-(l_qcc2+l_qjc2)
         IF l_amt1>0 THEN
            LET l_qmd2=l_amt1
            LET l_qmc2=0
         ELSE
            LET l_qmd2=0
            LET l_qmc2=l_amt1*-1
         END IF
         #本幣三
         LET l_amt1=(l_qcd3+l_qjd3)-(l_qcc3+l_qjc3)
         IF l_amt1>0 THEN
            LET l_qmd3=l_amt1
            LET l_qmc3=0
         ELSE
            LET l_qmd3=0
            LET l_qmc3=l_amt1*-1
         END IF  

         #本年累計金額
         LET l_amt1=0
         LET l_amt2=0
         LET l_amt3=0
         LET l_amt4=0
         LET l_amt5=0
         LET l_amt6=0
         LET l_amt7=0
         LET l_amt8=0
         #當截止日期為該期最後一天，且傳票狀態為1：已過帳時，抓取glar_t餘額當資料,否則，直接抓取glaq_t傳票資料
         IF tm.edate=l_pdate_e2 AND tm.stus='1' THEN
            EXECUTE aglq710_sel_pr3 USING l_glac002,tm.eyear,tm.eperiod
                                     INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr3','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
            IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
            IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
            IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
            IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
            IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
            #當不包含CE或YE憑證時，減去CE或YE傳票金額
            IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
               EXECUTE aglq710_sel_pr7 USING tm.eyear,tm.eperiod,l_glar001
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8                                       
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr7','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
               LET l_osumd=l_osumd-l_amt1
               LET l_osumc=l_osumc-l_amt2
               LET l_sumd =l_sumd -l_amt3
               LET l_sumc =l_sumc -l_amt4
               LET l_sumd2=l_sumd2-l_amt5
               LET l_sumc2=l_sumc2-l_amt6
               LET l_sumd3=l_sumd3-l_amt7
               LET l_sumc3=l_sumc3-l_amt8 
            END IF
         ELSE
            #年初數
            LET l_period=0
            EXECUTE aglq710_sel_pr3 USING l_glac002,tm.eyear,l_period
                                     INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr3','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            #所有傳票匯總
            EXECUTE aglq710_sel_pr4 USING l_glav004,tm.edate,l_glar001
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8                                       
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr4','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
            IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
            IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
            IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
            IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
            IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
            IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
            IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
            IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
            IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
            IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
            LET l_osumd=l_osumd+l_amt1
            LET l_osumc=l_osumc+l_amt2
            LET l_sumd =l_sumd +l_amt3
            LET l_sumc =l_sumc +l_amt4
            LET l_sumd2=l_sumd2+l_amt5
            LET l_sumc2=l_sumc2+l_amt6
            LET l_sumd3=l_sumd3+l_amt7
            LET l_sumc3=l_sumc3+l_amt8            
         END IF 
         
         
         IF l_yeard=0 AND l_yearc=0 AND  #年初數
            l_qcd=0 AND l_qcc=0 AND      #期初數
            l_qjd=0 AND l_qjc=0 AND      #期間異動
            l_qmd=0 AND l_qmc=0 AND      #期末
            l_sumd=0 AND l_sumc=0 THEN   #本年累計，以上全部等於0時該筆科目資料不顯示
            CONTINUE FOREACH
         END IF
                   
         INSERT INTO aglq710_tmp 
         VALUES(l_glac002,l_glar009,
                l_oyeard,l_oyearc,l_yeard,l_yearc,l_yeard2,l_yearc2,l_yeard3,l_yearc3,
                l_oqcd,l_oqcc,l_qcd,l_qcc,l_qcd2,l_qcc2,l_qcd3,l_qcc3,
                l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3,
                l_oqmd,l_oqmc,l_qmd,l_qmc,l_qmd2,l_qmc2,l_qmd3,l_qmc3,
                l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3)
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
      ELSE
         #按照幣別抓取科目餘額
         IF l_flag=TRUE THEN
            IF tm.stus MATCHES '[23]' THEN
               OPEN aglq710_sel_cr USING l_glac002,l_glar001
            ELSE
               OPEN aglq710_sel_cr USING l_glac002
            END IF
         ELSE
            OPEN aglq710_sel_cr USING l_glar001
         END IF
         
         FOREACH aglq710_sel_cr INTO l_glar009
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','FOREACH aglq710_sel_cr','',SQLCA.sqlcode,1)
               LET l_success = FALSE
               EXIT FOREACH
            END IF
         
            #年初金額
            IF tm.show_y='Y' THEN
               LET l_period=0
               EXECUTE aglq710_sel_pr1 USING l_glac002,tm.syear,l_period,l_glar009
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr1','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               IF l_amt2>0 THEN
                  LET l_oyeard=l_amt1
                  LET l_oyearc=0
                  LET l_yeard =l_amt2
                  LET l_yearc =0
                  LET l_yeard2=l_amt3
                  LET l_yearc2=0
                  LET l_yeard3=l_amt4
                  LET l_yearc3=0
               ELSE
                  LET l_oyeard=0
                  LET l_oyearc=-1*l_amt1
                  LET l_yeard =0
                  LET l_yearc =-1*l_amt2
                  LET l_yeard2=0
                  LET l_yearc2=-1*l_amt3
                  LET l_yeard3=0
                  LET l_yearc3=-1*l_amt4
               END IF 
            ELSE
               LET l_oyeard=0
               LET l_oyearc=0
               LET l_yeard =0
               LET l_yearc =0
               LET l_yeard2=0
               LET l_yearc2=0
               LET l_yeard3=0
               LET l_yearc3=0
            END IF
      
            #期初金額
            LET l_amt1=0
            LET l_amt2=0
            LET l_amt3=0
            LET l_amt4=0
            LET l_amt5=0
            LET l_amt6=0
            LET l_amt7=0
            LET l_amt8=0
            LET l_period=tm.speriod-1 #上期
            IF tm.sdate=l_pdate_s1 AND tm.stus='1' THEN
               #抓取上期已過帳資料
               EXECUTE aglq710_sel_pr1 USING l_glac002,tm.syear,l_period,l_glar009
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr1','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               #當不包含CE或YE憑證時，減去CE或YE傳票金額
               IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
                  EXECUTE aglq710_sel_pr6 USING tm.syear,l_period,l_glar001,l_glar009
                                           INTO l_amt5,l_amt6,l_amt7,l_amt8
                  IF SQLCA.sqlcode THEN
                     CALL cl_errmsg('','aglq710_sel_pr6','',SQLCA.sqlcode,1)
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
                  IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
                  IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
                  LET l_amt1=l_amt1-l_amt5
                  LET l_amt2=l_amt2-l_amt6
                  LET l_amt3=l_amt3-l_amt7
                  LET l_amt4=l_amt4-l_amt8
               END IF
            #當為破期時，匯總該年第一天到上期最後一天的傳票資料
            ELSE
               #年初數
               LET l_period=0
               EXECUTE aglq710_sel_pr1 USING l_glac002,tm.syear,l_period,l_glar009
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr1','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               
               LET l_period=tm.speriod-1 #上期
               #匯總該年第一天到上期最後一天的傳票資料
               IF l_period>0 THEN
                  EXECUTE aglq710_sel_pr2 USING l_glav004,l_glav004_e,l_glar001,l_glar009
                                           INTO l_amt5,l_amt6,l_amt7,l_amt8
                  IF SQLCA.sqlcode THEN
                     CALL cl_errmsg('','aglq710_sel_pr2','',SQLCA.sqlcode,1)
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
                  IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
                  IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
                  LET l_amt1=l_amt1+l_amt5
                  LET l_amt2=l_amt2+l_amt6
                  LET l_amt3=l_amt3+l_amt7
                  LET l_amt4=l_amt4+l_amt8
               END IF
            END IF
            
            IF l_amt2>0 THEN
               LET l_oqcd=l_amt1
               LET l_oqcc=0
               LET l_qcd =l_amt2
               LET l_qcc =0
               LET l_qcd2=l_amt3
               LET l_qcc2=0
               LET l_qcd3=l_amt4
               LET l_qcc3=0
            ELSE
               LET l_oqcd=0
               LET l_oqcc=-1*l_amt1
               LET l_qcd =0
               LET l_qcc =-1*l_amt2
               LET l_qcd2=0
               LET l_qcc2=-1*l_amt3
               LET l_qcd3=0
               LET l_qcc3=-1*l_amt4
            END IF 
         
            #期間異動
            IF l_flag=TRUE THEN
               IF tm.stus MATCHES '[23]' THEN
                  EXECUTE aglq710_sel_pr5 USING l_glac002,l_glar009,l_glar001,l_glar009
                                           INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
               ELSE
                  EXECUTE aglq710_sel_pr5 USING l_glac002,l_glar009
                                           INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
               END IF
            ELSE
               EXECUTE aglq710_sel_pr5 USING l_glar001,l_glar009
                                        INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
            END IF
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq710_sel_pr5','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_oqjd) THEN LET l_oqjd=0 END IF
            IF cl_null(l_oqjc) THEN LET l_oqjc=0 END IF
            IF cl_null(l_qjd)  THEN LET l_qjd=0  END IF
            IF cl_null(l_qjc)  THEN LET l_qjc=0  END IF
            IF cl_null(l_qjd2) THEN LET l_qjd2=0 END IF
            IF cl_null(l_qjc2) THEN LET l_qjc2=0 END IF
            IF cl_null(l_qjd3) THEN LET l_qjd3=0 END IF
            IF cl_null(l_qjc3) THEN LET l_qjc3=0 END IF
            
            #當不包含CE或YE憑證時，減去CE或YE傳票金額
            IF l_flag=TRUE AND (tm.show_ce<>'Y' OR tm.show_ye<>'Y') THEN
               EXECUTE aglq710_sel_pr8 USING l_glar001,l_glar009
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr8','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
               LET l_oqjd=l_oqjd-l_amt1
               LET l_oqjc=l_oqjc-l_amt2
               LET l_qjd =l_qjd -l_amt3
               LET l_qjc =l_qjc -l_amt4
               LET l_qjd2=l_qjd2-l_amt5
               LET l_qjc2=l_qjc2-l_amt6
               LET l_qjd3=l_qjd3-l_amt7
               LET l_qjc3=l_qjc3-l_amt8
            END IF
            
            #期末金額=期初+期間
            #原幣
            LET l_amt1=(l_oqcd+l_oqjd)-(l_oqcc+l_oqjc)
            IF l_amt1>0 THEN
               LET l_oqmd=l_amt1
               LET l_oqmc=0
            ELSE
               LET l_oqmd=0
               LET l_oqmc=l_amt1*-1
            END IF
            #本幣
            LET l_amt1=(l_qcd+l_qjd)-(l_qcc+l_qjc)
            IF l_amt1>0 THEN
               LET l_qmd=l_amt1
               LET l_qmc=0
            ELSE
               LET l_qmd=0
               LET l_qmc=l_amt1*-1
            END IF
            #本幣二
            LET l_amt1=(l_qcd2+l_qjd2)-(l_qcc2+l_qjc2)
            IF l_amt1>0 THEN
               LET l_qmd2=l_amt1
               LET l_qmc2=0
            ELSE
               LET l_qmd2=0
               LET l_qmc2=l_amt1*-1
            END IF
            #本幣三
            LET l_amt1=(l_qcd3+l_qjd3)-(l_qcc3+l_qjc3)
            IF l_amt1>0 THEN
               LET l_qmd3=l_amt1
               LET l_qmc3=0
            ELSE
               LET l_qmd3=0
               LET l_qmc3=l_amt1*-1
            END IF  

            #本年累計金額
            LET l_amt1=0
            LET l_amt2=0
            LET l_amt3=0
            LET l_amt4=0
            LET l_amt5=0
            LET l_amt6=0
            LET l_amt7=0
            LET l_amt8=0
            #當截止日期為該期最後一天，且傳票狀態為1：已過帳時，抓取glar_t餘額當資料,否則，直接抓取glaq_t傳票資料
            IF tm.edate=l_pdate_e2 AND tm.stus='1' THEN
               EXECUTE aglq710_sel_pr3 USING l_glac002,tm.eyear,tm.eperiod,l_glar009
                                        INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr3','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
               IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
               IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
               IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
               IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
               IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
               #當不包含CE或YE憑證時，減去CE或YE傳票金額
               IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
                  EXECUTE aglq710_sel_pr7 USING tm.eyear,tm.eperiod,l_glar001,l_glar009
                                           INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8                                       
                  IF SQLCA.sqlcode THEN
                     CALL cl_errmsg('','aglq710_sel_pr7','',SQLCA.sqlcode,1)
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
                  IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
                  IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
                  IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
                  IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
                  IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
                  IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
                  LET l_osumd=l_osumd-l_amt1
                  LET l_osumc=l_osumc-l_amt2
                  LET l_sumd =l_sumd -l_amt3
                  LET l_sumc =l_sumc -l_amt4
                  LET l_sumd2=l_sumd2-l_amt5
                  LET l_sumc2=l_sumc2-l_amt6
                  LET l_sumd3=l_sumd3-l_amt7
                  LET l_sumc3=l_sumc3-l_amt8 
               END IF
            ELSE
               #年初數
               LET l_period=0
               EXECUTE aglq710_sel_pr3 USING l_glac002,tm.eyear,l_period,l_glar009
                                        INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr3','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               #匯總該年第一天到查詢條件截止日期的傳票資料
               EXECUTE aglq710_sel_pr4 USING l_glav004,tm.edate,l_glar001,l_glar009
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq710_sel_pr4','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
               IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
               IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
               IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
               IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
               IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
               IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
               LET l_osumd=l_osumd+l_amt1
               LET l_osumc=l_osumc+l_amt2
               LET l_sumd =l_sumd +l_amt3
               LET l_sumc =l_sumc +l_amt4
               LET l_sumd2=l_sumd2+l_amt5
               LET l_sumc2=l_sumc2+l_amt6
               LET l_sumd3=l_sumd3+l_amt7
               LET l_sumc3=l_sumc3+l_amt8               
            END IF 
            
            IF l_yeard=0 AND l_yearc=0 AND  #年初數
               l_qcd=0 AND l_qcc=0 AND      #期初數
               l_qjd=0 AND l_qjc=0 AND      #期間異動
               l_qmd=0 AND l_qmc=0 AND      #期末
               l_sumd=0 AND l_sumc=0 THEN   #本年累計，以上全部等於0時該筆科目資料不顯示
               CONTINUE FOREACH
            END IF
            
            INSERT INTO aglq710_tmp 
            VALUES(l_glac002,l_glar009,
                   l_oyeard,l_oyearc,l_yeard,l_yearc,l_yeard2,l_yearc2,l_yeard3,l_yearc3,
                   l_oqcd,l_oqcc,l_qcd,l_qcc,l_qcd2,l_qcc2,l_qcd3,l_qcc3,
                   l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3,
                   l_oqmd,l_oqmc,l_qmd,l_qmc,l_qmd2,l_qmc2,l_qmd3,l_qmc3,
                   l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3)
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
         END FOREACH
      END IF
   END FOREACH
   IF l_success = FALSE THEN
      CALL cl_err_showmsg()
      DELETE FROM aglq710_tmp
   END IF
END FUNCTION]]>
</point>
  <point name="function.aglq710_fetch1" cite_std="N" status="" ver="1" src="s" new="Y" order="5" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 抓取下一筆資料
# Memo...........:
# Usage..........: CALL aglq710_fetch1(p_flag)
# Input parameter: p_flag            
# Date & Author..: 2014/3/17 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_fetch1(p_flag)
   DEFINE p_flag   LIKE type_t.chr1
   DEFINE ls_msg     STRING
   
   IF g_header_cnt = 0 THEN
      RETURN
   END IF
   
   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt        
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_glar_s.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         
         LET g_no_ask = FALSE  
   END CASE 
   
   #代表沒有資料
   IF g_current_idx = 0 OR g_glar_s.getLength() = 0 THEN
      RETURN
   END IF
   
   #超出範圍
   IF g_current_idx > g_glar_s.getLength() THEN
      LET g_current_idx = g_glar_s.getLength()
   END IF
   
   DISPLAY g_current_idx TO FORMONLY.h_index
   LET g_glar009 = g_glar_s[g_current_idx].glar009 
   CALL aglq710_b_fill1() 
   
END FUNCTION]]>
</point>
  <point name="function.aglq710_set_default_value" cite_std="N" status="" ver="1" src="s" new="Y" order="6" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 設置默認值
# Memo...........:
# Usage..........: CALL aglq710_set_default_value()
# Date & Author..: 2014/03/13 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_set_default_value()
   DEFINE l_flag           LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   
   CALL s_get_accdate(g_glaa003,g_today,'','')
   RETURNING l_flag,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag='N' THEN
      CALL cl_err('',l_errno,0)
   END IF
   LET tm.sdate=l_pdate_s  #起始日期
   LET tm.syear=l_glav002
   LET tm.speriod=l_glav006
   LET tm.edate=l_pdate_e  #截止日期
   LET tm.eyear=l_glav002
   LET tm.eperiod=l_glav006
  
   #原幣顯示設置
   LET tm.curr_o='N'
   CALL cl_set_comp_visible('b_glar009,oyeard,oyearc,oqcd,oqcc,oqjd,oqjc,oqmd,oqmc,osumd,osumc',FALSE)
   LET tm.curr_p='N'
   CALL aglq710_set_comp_entry('curr_p',FALSE)
   #年初數
   LET tm.show_y='N'
   CALL cl_set_comp_visible('oyeard,oyearc,yeard,yearc,yeard2,yearc2,yeard3,yearc3',FALSE)
   #統制科目
   LET tm.show_acc='Y'
   #科目層級
   LET tm.glac005=99
   #單據狀態
   LET tm.stus='1'
   #含內部管理科目
   LET tm.glac009='Y'
   #含月結傳票
   LET tm.show_ce='Y'
   #含年結傳票
   LET tm.show_ye='Y'
END FUNCTION]]>
</point>
  <point name="function.aglq710_glar001_desc" cite_std="N" status="" ver="1" src="s" new="Y" order="7" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 科目说明
# Memo...........:
# Usage..........: CALL aglq710_glar001_desc(p_glar001)
#                  RETURNING r_desc
# Input parameter: p_glar001   科目編號
# Return code....: r_desc      科目說
# Date & Author..: 2014/03/14 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_glar001_desc(p_glar001)
   DEFINE p_glar001   LIKE glar_t.glar001
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = p_glar001
   CALL ap_ref_array2(g_ref_fields,"SELECT glacl004 FROM glacl_t WHERE glaclent='"||g_enterprise||"' AND glacl001 = '"||g_glaa004||"' AND glacl002 = ? AND glacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   RETURN  g_rtn_fields[1]
END FUNCTION]]>
</point>
  <point name="function.aglq710_set_comp_entry" cite_std="N" status="" ver="1" src="s" new="Y" order="8" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 動態設定元件是否需輸入值
# Memo...........:
# Usage..........: CALL aglq710_set_comp_entry(ps_fields,pi_entry)
# Input parameter: ps_fields   欄位名稱
#                : pi_entry    是否進入欄位
# Date & Author..: 2014/04/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_set_comp_entry(ps_fields,pi_entry)
   DEFINE ps_fields STRING,
          pi_entry  LIKE type_t.num5           
   DEFINE lst_fields base.StringTokenizer,
          ls_field_name STRING
   DEFINE lwin_curr     ui.Window
   DEFINE lnode_win     om.DomNode,
          llst_items    om.NodeList,
          li_i          LIKE type_t.num5,        
          lnode_item    om.DomNode,
          ls_item_name  STRING
 
   IF g_bgjob = 'Y' AND g_gui_type NOT MATCHES "[13]"  THEN  
      RETURN
   END IF
 
   IF (ps_fields IS NULL) THEN
      RETURN
   END IF
 
   LET ps_fields = ps_fields.toLowerCase()
 
   LET lst_fields = base.StringTokenizer.create(ps_fields, ",")
 
   LET lwin_curr = ui.Window.getCurrent()
   LET lnode_win = lwin_curr.getNode()
 
   LET llst_items = lnode_win.selectByPath("//Form//*")
 
   WHILE lst_fields.hasMoreTokens()
     LET ls_field_name = lst_fields.nextToken()
     LET ls_field_name = ls_field_name.trim()
 
     IF (ls_field_name.getLength() > 0) THEN
        FOR li_i = 1 TO llst_items.getLength()
            LET lnode_item = llst_items.item(li_i)
            LET ls_item_name = lnode_item.getAttribute("colName")
 
            IF (ls_item_name IS NULL) THEN
               LET ls_item_name = lnode_item.getAttribute("name")
 
               IF (ls_item_name IS NULL) THEN
                  CONTINUE FOR
               END IF
            END IF
 
            LET ls_item_name = ls_item_name.trim()
 
            IF (ls_item_name.equals(ls_field_name)) THEN
               IF (pi_entry) THEN
                  CALL lnode_item.setAttribute("noEntry", "0")
                  CALL lnode_item.setAttribute("active", "1")
               ELSE
                  CALL lnode_item.setAttribute("noEntry", "1")
                  CALL lnode_item.setAttribute("active", "0")
               END IF
 
               EXIT FOR
            END IF
        END FOR
     END IF
   END WHILE
END FUNCTION]]>
</point>
  <point name="function.aglq710_show" cite_std="N" status="" ver="1" src="s" new="Y" order="9" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 显示资料
# Memo...........:
# Usage..........: CALL aglq710_show()
# Date & Author..:  2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_show()
   DISPLAY g_glaald,g_glaald_desc,g_glaacomp,g_glaacomp_desc,g_glaa001,g_glaa016,g_glaa020,
           tm.sdate,tm.syear,tm.speriod,tm.edate,tm.eyear,tm.eperiod,tm.ctype,tm.curr_o,tm.curr_p,
           tm.show_y,tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye
        TO glaald,glaald_desc,glaacomp,glaacomp_desc,glaa001,glaa016,glaa020,
           sdate,syear,speriod,edate,eyear,eperiod,ctype,curr_o,curr_p,
           show_y,show_acc,glac005,stus,glac009,show_ce,show_ye
           
END FUNCTION]]>
</point>
  <point name="function.aglq710_b_fill1" cite_std="N" status="" ver="1" src="s" new="Y" order="10" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 填充单身资料
# Memo...........:
# Usage..........: CALL aglq710_b_fill1()
# Date & Author..: 2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_b_fill1()
   LET g_sql="SELECT UNIQUE glar001,'',glar009,",
             "       oyeard,oyearc,yeard,yearc,yeard2,yearc2,yeard3,yearc3,",
             "       oqcd,oqcc,qcd,qcc,qcd2,qcc2,qcd3,qcc3,",
             "       oqjd,oqjc,qjd,qjc,qjd2,qjc2,qjd3,qjc3,",
             "       oqmd,oqmc,qmd,qmc,qmd2,qmc2,qmd3,qmc3,",
             "       osumd,osumc,sumd,sumc,sumd2,sumc2,sumd3,sumc3 ",
             "  FROM aglq710_tmp "
   #是否按照幣別分頁
   IF NOT cl_null(g_glar009) THEN
      LET g_sql=g_sql," WHERE glar009='",g_glar009,"'"
   END IF          
   LET g_sql=g_sql," ORDER BY glar001,glar009 "
   
   
   #end add-point
  
   PREPARE aglq710_pb1 FROM g_sql
   DECLARE b_fill_curs1 CURSOR FOR aglq710_pb1
   OPEN b_fill_curs1
   
   CALL g_glar_d.clear()
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs1 INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,g_glar_d[l_ac].glar009, 
       g_glar_d[l_ac].oyeard,g_glar_d[l_ac].oyearc,g_glar_d[l_ac].yeard,g_glar_d[l_ac].yearc,g_glar_d[l_ac].yeard2, 
       g_glar_d[l_ac].yearc2,g_glar_d[l_ac].yeard3,g_glar_d[l_ac].yearc3,g_glar_d[l_ac].oqcd,g_glar_d[l_ac].oqcc, 
       g_glar_d[l_ac].qcd,g_glar_d[l_ac].qcc,g_glar_d[l_ac].qcd2,g_glar_d[l_ac].qcc2,g_glar_d[l_ac].qcd3, 
       g_glar_d[l_ac].qcc3,g_glar_d[l_ac].oqjd,g_glar_d[l_ac].oqjc,g_glar_d[l_ac].qjd,g_glar_d[l_ac].qjc, 
       g_glar_d[l_ac].qjd2,g_glar_d[l_ac].qjc2,g_glar_d[l_ac].qjd3,g_glar_d[l_ac].qjc3,g_glar_d[l_ac].oqmd, 
       g_glar_d[l_ac].oqmc,g_glar_d[l_ac].qmd,g_glar_d[l_ac].qmc,g_glar_d[l_ac].qmd2,g_glar_d[l_ac].qmc2, 
       g_glar_d[l_ac].qmd3,g_glar_d[l_ac].qmc3,g_glar_d[l_ac].osumd,g_glar_d[l_ac].osumc,g_glar_d[l_ac].sumd, 
       g_glar_d[l_ac].sumc,g_glar_d[l_ac].sumd2,g_glar_d[l_ac].sumc2,g_glar_d[l_ac].sumd3,g_glar_d[l_ac].sumc3 

      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET g_glar_d[l_ac].sel = "N"
      #科目說明
      CALL aglq710_glar001_desc(g_glar_d[l_ac].glar001) RETURNING g_glar_d[l_ac].glar001_desc
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   CALL g_glar_d.deleteElement(g_glar_d.getLength())   
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.cnt
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs1
   FREE aglq710_pb1
   
   LET l_ac = 1
   
   CALL aglq710_filter_show('glar001','b_glar001')
 
END FUNCTION]]>
</point>
  <point name="function.aglq710_set_page" cite_std="N" status="" ver="1" src="s" new="Y" order="11" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 设置分页
# Memo...........:
# Usage..........: CALL aglq710_set_page()
# Date & Author..: 2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq710_set_page()
   DEFINE l_sql    STRING
   DEFINE l_idx    LIKE type_t.num5
   
   CALL g_glar_s.clear()
   IF tm.curr_p <>'Y' THEN
      LET g_glar_s[1].glar009=''
      LET g_header_cnt = 1
      LET g_rec_b = 1
   ELSE      
      LET l_sql="SELECT DISTINCT glar009 FROM aglq710_tmp ORDER BY glar009 "
      PREPARE aglq710_sel_s_pr FROM l_sql
      DECLARE aglq710_sel_s_cr CURSOR FOR aglq710_sel_s_pr
      LET l_idx=1
      FOREACH aglq710_sel_s_cr INTO g_glar_s[l_idx].glar009
         IF SQLCA.sqlcode THEN
            CALL cl_err('FOREACH aglq710_sel_s_cr',SQLCA.sqlcode,0)
            EXIT FOREACH
         END IF
         LET l_idx=l_idx+1
         IF l_idx > g_max_rec THEN
            CALL cl_err('',9035,0)
            EXIT FOREACH
         END IF
      END FOREACH
      LET l_idx=l_idx-1
      CALL g_glar_s.deleteElement(g_glar_s.getLength())
      LET g_header_cnt = l_idx
      LET g_rec_b = l_idx
   END IF
   DISPLAY g_header_cnt TO FORMONLY.h_count
END FUNCTION]]>
</point>
  <point name="b_fill.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   RETURN]]>
</point>
  <point name="b_fill.sql_after" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   ]]>
</point>
  <point name="cs.after_construct" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   IF l_flag=TRUE THEN
      IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF
      CALL aglq710_get_data()
      SELECT COUNT(*) INTO l_cnt FROM aglq710_tmp
      IF l_cnt=0 THEN 
         CALL cl_err('',-100,0)
         RETURN
      END IF
      CALL aglq710_set_page()
      CALL aglq710_fetch1('F')
   ELSE
      IF g_glar_d.getLength()>0 THEN
         CALL aglq710_b_fill1()
         DISPLAY g_current_idx TO FORMONLY.h_index
         DISPLAY g_glar_s.getLength() TO FORMONLY.h_count
         DISPLAY g_detail_idx TO FORMONLY.idx
      END IF
   END IF]]>
</point>
  <point name="fetch.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   RETURN]]>
</point>
  <point name="global.variable" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[#依据当前账别，抓取账别所归属的法人，使用币别，汇率参照表号，会计科目参照表号
DEFINE g_bookno        LIKE glap_t.glapld
DEFINE g_glaald        LIKE glaa_t.glaald
DEFINE g_glaald_desc   LIKE glaal_t.glaal002
DEFINE g_glaacomp      LIKE glaa_t.glaacomp
DEFINE g_glaacomp_desc LIKE ooefl_t.ooefl003
DEFINE g_glaa001       LIKE glaa_t.glaa001
DEFINE g_glaa002       LIKE glaa_t.glaa002
DEFINE g_glaa003       LIKE glaa_t.glaa003
DEFINE g_glaa004       LIKE glaa_t.glaa004
DEFINE g_glaa013       LIKE glaa_t.glaa013
DEFINE g_glaa015       LIKE glaa_t.glaa015
DEFINE g_glaa016       LIKE glaa_t.glaa016
DEFINE g_glaa017       LIKE glaa_t.glaa017
DEFINE g_glaa018       LIKE glaa_t.glaa018
DEFINE g_glaa019       LIKE glaa_t.glaa019
DEFINE g_glaa020       LIKE glaa_t.glaa020
DEFINE g_glaa021       LIKE glaa_t.glaa021
DEFINE g_glaa022       LIKE glaa_t.glaa022
#查询条件定义
DEFINE tm              RECORD
       sdate           LIKE glap_t.glapdocdt,  #起始日期
       syear           LIKE glap_t.glap002,    #起始年度
       speriod         LIKE glap_t.glap004,    #起始期別
       edate           LIKE glap_t.glapdocdt,  #截止日期
       eyear           LIKE glap_t.glap002,    #截止年度
       eperiod         LIKE glap_t.glap004,    #截止期別
       ctype           LIKE type_t.chr1,       #多本位幣
       curr_o          LIKE type_t.chr1, 
       curr_p          LIKE type_t.chr1, 
       show_y          LIKE type_t.chr1, 
       show_acc        LIKE type_t.chr1, 
       glac005	       LIKE glac_t.glac005,
       stus            LIKE type_t.chr1,
       glac009	       LIKE glac_t.glac009,
       show_ce         LIKE type_t.chr1,
       show_ye         LIKE type_t.chr1
       END RECORD
DEFINE g_wc1           STRING
DEFINE g_glar009       LIKE glar_t.glar009
DEFINE g_glar_s        DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位 
       glar009         LIKE glar_t.glar009
      END RECORD 
DEFINE g_current_row   LIKE type_t.num5 
DEFINE g_current_idx   LIKE type_t.num10     
DEFINE g_jump          LIKE type_t.num10        
DEFINE g_no_ask        LIKE type_t.num5  
DEFINE g_rec_b         LIKE type_t.num5]]>
</point>
  <point name="init.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   DEFINE l_success   LIKE type_t.num5
   DEFINE l_pass      LIKE type_t.num5]]>
</point>
  <point name="init.init" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   LET g_detail_idx  = 1
   CALL cl_set_combo_scc('stus','9922')
   #获取账别
   IF cl_null(g_glaald) THEN
      CALL s_ld_bookno()  RETURNING l_success,g_glaald
      IF l_success = FALSE THEN
         RETURN 
      END IF 
      CALL s_ld_chk_authorization(g_user,g_glaald) RETURNING l_pass
      IF l_pass = FALSE THEN
         CALL cl_err(g_glaald,'agl-00164',1)
         RETURN
      END IF
   END IF      
   CALL aglq710_glaald_desc(g_glaald)
   CALL aglq710_set_default_value()
   #建立临时表
   CALL aglq710_create_temp_table()]]>
</point>
  <point name="input.a.glarcomp" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_glar_m.glarcomp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_glar_m.glarcomp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_glar_m.glarcomp_desc
]]>
</point>
  <point name="input.a.glarld" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  NOT cl_null(g_glar_m.glarld) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_glar_m.glarld != g_glarld_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_m.glarld ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_glar_m.glarld
            CALL ap_ref_array2(g_ref_fields,"SELECT glaal002 FROM glaal_t WHERE glaalent='"||g_enterprise||"' AND glaalld=? AND glaal001='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_glar_m.glarld_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_glar_m.glarld_desc
]]>
</point>
  <point name="input.a.page1.glar001" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_m.glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_m.glarld != g_glarld_t OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_m.glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glar002" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_m.glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_m.glarld != g_glarld_t OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_m.glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glar003" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_m.glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_m.glarld != g_glarld_t OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_m.glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glar004" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_m.glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_m.glarld != g_glarld_t OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_m.glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.body.before_row" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               DISPLAY g_current_idx TO FORMONLY.h_index
               DISPLAY g_glar_s.getLength() TO FORMONLY.h_count
               DISPLAY g_detail_idx TO FORMONLY.idx
               DISPLAY g_glar_d.getLength() TO FORMONLY.cnt]]>
</point>
  <point name="menu.exchange_ld" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglt310_01(g_glaald) RETURNING g_bookno
               IF g_glaald <> g_bookno THEN
                  CLEAR FORM
                  CALL g_glar_s.clear()
                  CALL g_glar_d.clear()
               END IF
               LET g_glaald = g_bookno
               #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
               CALL aglq710_glaald_desc(g_glaald)
               CALL aglq710_show()
                IF cl_null(g_wc) THEN
                   LET g_wc = '1=1'
                END IF 
                LET g_wc1 = ' 1=1']]>
</point>
  <point name="menu.first" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq710_fetch1('F')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.jump" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq710_fetch1('/')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.last" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq710_fetch1('L')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.next" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq710_fetch1('N')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.previous" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq710_fetch1('P')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.query" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               EXIT DIALOG]]>
</point>
  <point name="query.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   DEFINE l_flag           LIKE type_t.num5
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_cnt            LIKE type_t.num5
   
   
   LET l_flag=TRUE]]>
</point>
  <point name="query.more_construct" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[      CONSTRUCT g_wc1 ON glar009
           FROM s_detail1[1].b_glar009
                      
         BEFORE CONSTRUCT
         
         ON ACTION controlp INFIELD b_glar009
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooai001()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar009  #顯示到畫面上
            NEXT FIELD b_glar009                     #返回原欄位            
      END CONSTRUCT
      
      INPUT BY NAME tm.sdate,tm.edate,tm.ctype,tm.curr_o,tm.curr_p,tm.show_y,
                    tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye
         ATTRIBUTE(WITHOUT DEFAULTS)
         BEFORE INPUT
         
         AFTER FIELD sdate
            IF NOT cl_null(tm.sdate) THEN
               CALL s_get_accdate(g_glaa003,tm.sdate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  CALL cl_err('',l_errno,0)
                  NEXT FIELD sdate
               END IF
               IF NOT cl_null(tm.edate) THEN
                  IF tm.sdate>tm.edate THEN
                     CALL cl_err('','agl-00116',0)
                     NEXT FIELD sdate
                  END IF
               END IF
               LET tm.syear=l_glav002
               LET tm.speriod=l_glav006
               DISPLAY tm.syear,tm.speriod TO syear,speriod 
            END IF
            
         AFTER FIELD edate
            IF NOT cl_null(tm.edate) THEN
               CALL s_get_accdate(g_glaa003,tm.edate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  CALL cl_err('',l_errno,0)
                  NEXT FIELD edate
               END IF
               IF NOT cl_null(tm.sdate) THEN
                  IF tm.sdate>tm.edate THEN
                     CALL cl_err('','agl-00117',0)
                     NEXT FIELD edate
                  END IF
               END IF
               LET tm.eyear=l_glav002
               LET tm.eperiod=l_glav006
               DISPLAY tm.eyear,tm.eperiod TO eyear,eperiod 
            END IF
         
         ON CHANGE ctype
            IF tm.ctype MATCHES '[123]' THEN
               CALL aglq710_set_curr_show()
            ELSE
               NEXT FIELD ctype
            END IF
            
         ON CHANGE curr_o 
            IF tm.curr_o MATCHES '[yYnN]' THEN
               IF tm.curr_o='Y' THEN
                  CALL cl_set_comp_visible('b_glar009,oqcd,oqcc,oqjd,oqjc,oqmd,oqmc,osumd,osumc',TRUE)
                  CALL aglq710_set_comp_entry('curr_p',TRUE)
                  IF tm.show_y='Y' THEN
                     CALL cl_set_comp_visible('oyeard,oyearc',TRUE)
                  END IF
               ELSE
                  CALL cl_set_comp_visible('b_glar009,oyeard,oyearc,oqcd,oqcc,oqjd,oqjc,oqmd,oqmc,osumd,osumc',FALSE)
                  CALL aglq710_set_comp_entry('curr_p',FALSE)
                  LET tm.curr_p='N'
                  DISPLAY tm.curr_p TO curr_p
               END IF                  
            ELSE
               NEXT FIELD curr_o
            END IF
            
         ON CHANGE curr_p
            IF tm.curr_p NOT MATCHES '[yYnN]' THEN
                NEXT FIELD curr_p
            END IF
            
         ON CHANGE show_y
            IF tm.show_y NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_y
            END IF
            IF tm.show_y='Y' THEN
               CALL cl_set_comp_visible('yeard,yearc',TRUE)
               IF tm.curr_o='Y' THEN
                  CALL cl_set_comp_visible('oyeard,oyearc',TRUE)
               END IF
               IF tm.ctype='1' OR tm.ctype='3' THEN
                  CALL cl_set_comp_visible('yeard2,yearc2',TRUE)
               END IF
               IF tm.ctype='2' OR tm.ctype='3' THEN
                  CALL cl_set_comp_visible('yeard3,yearc3',TRUE)
               END IF
            ELSE
               CALL cl_set_comp_visible('oyeard,oyearc,yeard,yearc,yeard2,yearc2,yeard3,yearc3',FALSE)
            END IF
            
         AFTER FIELD show_acc
            IF tm.show_acc NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_acc
            END IF
         
         AFTER FIELD glac005
            IF NOT cl_ap_chk_Range(tm.glac005,"1","1","99","1","azz-00087",1) THEN
               NEXT FIELD glac005
            END IF
         
         AFTER FIELD stus
            IF tm.stus NOT MATCHES '[123]' THEN
               NEXT FIELD stus
            END IF
            
         AFTER FIELD glac009
            IF tm.glac009 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glac009
            END IF
            
         AFTER FIELD show_ce
            IF tm.show_ce NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ce
            END IF
         
         AFTER FIELD show_ye
            IF tm.show_ye NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ye
            END IF
         
      END INPUT
      
      BEFORE DIALOG
        #預設
        CALL aglq710_show()
      ]]>
</point>
  <point name="ref_show.head.reference" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_glar_m.glarld
            CALL ap_ref_array2(g_ref_fields,"SELECT glaal002 FROM glaal_t WHERE glaalent='"||g_enterprise||"' AND glaalld=? AND glaal001='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_glar_m.glarld_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_glar_m.glarld_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_glar_m.glarcomp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_glar_m.glarcomp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_glar_m.glarcomp_desc
]]>
</point>
  <point name="ui_dialog.bef_dialog" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #上下筆按鈕顯示否設置
            IF g_header_cnt=1 THEN
               CALL cl_set_act_visible("first,previous,jump,next,last",FALSE) 
            ELSE
               IF g_current_idx=1 THEN
                  CALL cl_set_act_visible("first,previous", FALSE) 
                  CALL cl_set_act_visible("jump,next,last", TRUE) 
               ELSE
                  IF g_current_idx<>g_header_cnt THEN
                     CALL cl_set_act_visible("first,previous,jump,next,last",TRUE) 
                  ELSE
                     CALL cl_set_act_visible("first,previous,jump",TRUE) 
                     CALL cl_set_act_visible("next,last", FALSE) 
                  END IF
               END IF
            END IF
            CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)]]>
</point>
  <point name="global.memo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.import" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.inc" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.argv" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.init" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.after_define_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.after_refresh_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.servicecall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.before_close" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.exit" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.before_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.more_displayarray" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.datainfo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.output" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selnone" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_sel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_unsel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.filter" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.agendum" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="cs.head.before_construct" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar001" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar001" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.sql_before" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.others.fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="fetch.after_fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.before" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.body.reference" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.after" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.add_cs" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.b_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter_parser.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="insert.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="insert.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="modify.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="modify.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="reproduce.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="reproduce.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="delete.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="delete.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <section id="aglq710.query" ver="1" status="" src="m">
<![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION aglq710_query()
   {<Local define>}
   DEFINE ls_wc      LIKE type_t.chr500
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   {</Local define>}
   #add-point:query段define
{<point name="query.define" />}
   #end add-point 
   
   LET INT_FLAG = 0
   CLEAR FORM
   CALL g_glar_d.clear()
   LET g_wc_filter = " 1=1"
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
   
   LET g_qryparam.state = "c"
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   
   #wc備份
   LET ls_wc = g_wc
   LET g_master_idx = l_ac
 
   
 
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單身根據table分拆construct
      CONSTRUCT g_wc_table ON glar001
           FROM s_detail1[1].b_glar001
                      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
{<point name="cs.head.before_construct" />}
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
       #---------------------<  Detail: page1  >---------------------
         #----<<b_glar001>>----
         #Ctrlp:construct.c.page1.b_glar001
         ON ACTION controlp INFIELD b_glar001
            #add-point:ON ACTION controlp INFIELD b_glar001
{<point name="construct.c.page1.b_glar001" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar001
            #add-point:BEFORE FIELD b_glar001
{<point name="construct.b.page1.b_glar001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar001
            
            #add-point:AFTER FIELD b_glar001
{<point name="construct.a.page1.b_glar001" />}
            #END add-point
            
 
   
       
      END CONSTRUCT
      
 
      
 
  
      #add-point:query段more_construct
{<point name="query.more_construct" />}
      #end add-point 
      
      ON ACTION accept
         ACCEPT DIALOG
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG
      
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG 
   END DIALOG
 
   
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      #還原
      LET g_wc = ls_wc
      LET l_flag=FALSE
   ELSE
      LET g_master_idx = 1
   END IF
   
   LET g_wc = g_wc_table 
 
 
        
   LET g_wc2 = " 1=1"
 
        
   #add-point:cs段after_construct
{<point name="cs.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL aglq710_b_fill()
   LET l_ac = g_master_idx
   CALL aglq710_fetch()
#   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
#      CALL cl_err("",-100,1)
#   END IF
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
   
END FUNCTION
]]>
</section>
  <section id="aglq710.b_fill" ver="25" status="" src="s">
<![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION aglq710_b_fill()
   {<Local define>}
   DEFINE ls_wc           STRING
   {</Local define>}
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
   
   IF cl_null(g_wc_filter) THEN
      LET g_wc_filter = " 1=1"
   END IF
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   
   LET ls_wc = g_wc, " AND ", g_wc2, " AND ", g_wc_filter
   
   LET g_sql = "SELECT  UNIQUE glar001,'',glar009,'','','','','','','','','','','','','','','','','', 
       '','','','','','','','','','','','','','','','','','','','','','','' FROM glar_t",
 
 
               "",
               " WHERE glarent= ? AND 1=1 AND ", ls_wc
    
   LET g_sql = g_sql, " ORDER BY glar_t.glarld,glar_t.glar001,glar_t.glar002,glar_t.glar003,glar_t.glar004"
  
   #add-point:b_fill段sql_after
   {<point name="b_fill.sql_after"/>}
   #end add-point
  
   PREPARE aglq710_pb FROM g_sql
   DECLARE b_fill_curs CURSOR FOR aglq710_pb
   
   OPEN b_fill_curs USING g_enterprise
 
   CALL g_glar_d.clear()
 
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,g_glar_d[l_ac].glar009, 
       g_glar_d[l_ac].oyeard,g_glar_d[l_ac].oyearc,g_glar_d[l_ac].yeard,g_glar_d[l_ac].yearc,g_glar_d[l_ac].yeard2, 
       g_glar_d[l_ac].yearc2,g_glar_d[l_ac].yeard3,g_glar_d[l_ac].yearc3,g_glar_d[l_ac].oqcd,g_glar_d[l_ac].oqcc, 
       g_glar_d[l_ac].qcd,g_glar_d[l_ac].qcc,g_glar_d[l_ac].qcd2,g_glar_d[l_ac].qcc2,g_glar_d[l_ac].qcd3, 
       g_glar_d[l_ac].qcc3,g_glar_d[l_ac].oqjd,g_glar_d[l_ac].oqjc,g_glar_d[l_ac].qjd,g_glar_d[l_ac].qjc, 
       g_glar_d[l_ac].qjd2,g_glar_d[l_ac].qjc2,g_glar_d[l_ac].qjd3,g_glar_d[l_ac].qjc3,g_glar_d[l_ac].oqmd, 
       g_glar_d[l_ac].oqmc,g_glar_d[l_ac].qmd,g_glar_d[l_ac].qmc,g_glar_d[l_ac].qmd2,g_glar_d[l_ac].qmc2, 
       g_glar_d[l_ac].qmd3,g_glar_d[l_ac].qmc3,g_glar_d[l_ac].osumd,g_glar_d[l_ac].osumc,g_glar_d[l_ac].sumd, 
       g_glar_d[l_ac].sumc,g_glar_d[l_ac].sumd2,g_glar_d[l_ac].sumc2,g_glar_d[l_ac].sumd3,g_glar_d[l_ac].sumc3 

      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET g_glar_d[l_ac].sel = "N"
      #LET g_glar_d[l_ac].statepic = cl_get_actipic(g_glar_d[l_ac].statepic)
 
      
 
      #add-point:b_fill段資料填充
      {<point name="b_fill.fill"/>}
      #end add-point
      
      CALL aglq710_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
 
   
   CALL g_glar_d.deleteElement(g_glar_d.getLength())   
 
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.others.fill"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE aglq710_pb
   
   LET l_ac = 1
   CALL aglq710_fetch()
   
      CALL aglq710_filter_show('glar001','b_glar001')
   CALL aglq710_filter_show('glar009','b_glar009')
 
   
END FUNCTION
]]>
</section>
  <section id="aglq710.b_fill2" ver="1" status="" src="s">
<![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION aglq710_b_fill2(pi_idx)
   {<Local define>}
   DEFINE pi_idx          LIKE type_t.num5
   DEFINE li_ac           LIKE type_t.num5
   {</Local define>}
   #add-point:b_fill2段define
   {<point name="b_fill2.define"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
 
      
   #add-point:單身填充後
   {<point name="b_fill2.after_fill" />}
   #end add-point
    
   LET l_ac = li_ac
   
END FUNCTION
]]>
</section>
  <section id="aglq710.before_delete" ver="1" status="" src="s">
<![CDATA[#+ 單身db資料刪除
PRIVATE FUNCTION aglq710_before_delete()
   #add-point:before_delete段define
   {<point name="before_delete.define"/>}
   #end add-point 
   
   #add-point:單筆刪除前
   {<point name="delete.body.b_single_delete" mark="Y"/>}
   #end add-point
   
   DELETE FROM glar_t
    WHERE glarent = g_enterprise AND glarld = g_glar_m.glarld AND
 
          glar001 = g_glar_d_t.glar001
      AND glar002 = g_glar_d_t.glar002
 
      AND glar003 = g_glar_d_t.glar003
 
      AND glar004 = g_glar_d_t.glar004
 
 
      
   #add-point:單筆刪除中
   {<point name="delete.body.m_single_delete"/>}
   #end add-point
   
   IF SQLCA.sqlcode THEN
      CALL cl_err("glar_t",SQLCA.sqlcode,1)
      RETURN FALSE 
   END IF
   
   #add-point:單筆刪除後
   {<point name="delete.body.a_single_delete"/>}
   #end add-point
 
   LET g_rec_b = g_rec_b-1
   DISPLAY g_rec_b TO FORMONLY.cnt
 
   RETURN TRUE
    
END FUNCTION
]]>
</section>
  <section id="aglq710.browser_fill" ver="1" status="" src="s">
<![CDATA[#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION aglq710_browser_fill(ps_page_action)
   {<Local define>}
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   DEFINE l_searchcol       STRING
   {</Local define>}
   #add-point:browser_fill段define
   {<point name="browser_fill.define"/>}
   #end add-point    
   
   #add-point:browser_fill段動作開始前
   {<point name="browser_fill.before_browser_fill"/>}
   #end add-point    
   
   CALL g_browser.clear()
 
   #搜尋用
   IF cl_null(g_searchcol) OR g_searchcol = '0' THEN
      LET l_searchcol = "glarld"
   ELSE
      LET l_searchcol = g_searchcol
   END IF
   
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
   IF cl_null(l_wc) THEN  #p_wc 查詢條件
      RETURN
   END IF
   
   IF g_wc2 <> " 1=1" OR NOT cl_null(g_wc2) THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT UNIQUE glarld ",
 
                      " FROM glar_t ",
                      " ",
                      " LEFT JOIN glacl_t ON glar001 = glacl002 AND glacl003 = '",g_lang,"' ",
 
                      " WHERE glarent = '" ||g_enterprise|| "' AND ",l_wc, " AND ", l_wc2 
 
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE glarld ",
 
                      " FROM glar_t ",
                      " ",
                      " LEFT JOIN glacl_t ON glar001 = glacl002 AND glacl003 = '",g_lang,"' ",
                      " WHERE glarent = '" ||g_enterprise|| "' AND ",l_wc CLIPPED
 
   END IF 
   
   LET g_sql = " SELECT COUNT(*) FROM (",l_sub_sql,")"
 
   #add-point:browser_fill,count前
   {<point name="browser_fill.before_count"/>}
   #end add-point
   
   PREPARE header_cnt_pre FROM g_sql
   EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
   FREE header_cnt_pre
   
   #若超過最大顯示筆數
   LET g_error_show = 0
 
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #LET g_page_action = ps_page_action          # Keep Action
   IF ps_page_action = "first" OR              
      ps_page_action = "prev"  OR
      ps_page_action = "next"  OR
      ps_page_action = "last"  THEN
      LET g_page_action = ps_page_action        #g_page_action 這個會影響 browser 下面四個button 的判斷 
   END IF
   
   CASE ps_page_action
      WHEN "F" 
         LET g_pagestart = 1
          
      WHEN "P"  
         LET g_pagestart = g_pagestart - g_max_browse
         IF g_pagestart < 1 THEN
             LET g_pagestart = 1
         END IF
          
      WHEN "N"  
         LET g_pagestart = g_pagestart + g_max_browse
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
            WHILE g_pagestart > g_browser_cnt 
               LET g_pagestart = g_pagestart - g_max_browse
            END WHILE
         END IF
      
      WHEN "L"  
         LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
         WHILE g_pagestart > g_browser_cnt 
            LET g_pagestart = g_pagestart - g_max_browse
         END WHILE
 
      OTHERWISE
         LET g_pagestart = 1
         
   END CASE
   
   #單身有輸入查詢條件且非null
   IF g_wc2 <> " 1=1" AND NOT cl_null(g_wc2) THEN 
 
      #依照glarld Browser欄位定義(取代原本bs_sql功能)
      LET l_sub_sql  = "SELECT DISTINCT glarld ",
                       " FROM glar_t ",
 
                       " ",
                       " WHERE glarent = '" ||g_enterprise|| "' AND ", g_wc," AND ",g_wc2
 
   ELSE
      #單身無輸入資料
      LET l_sub_sql  = "SELECT DISTINCT glarld ",
                       " FROM glar_t ",
                       " WHERE glarent = '" ||g_enterprise|| "' AND ", g_wc
                 
   END IF
   
   LET l_sql_rank = "SELECT glarld,DENSE_RANK() OVER(ORDER BY glarld ",g_order,") AS RANK ",
                    " FROM (",l_sub_sql,") "
                       
   #定義翻頁CURSOR
   LET g_sql= " SELECT glarld FROM (",l_sql_rank,") WHERE RANK>=",g_pagestart,
              " AND RANK<",g_pagestart+g_max_browse,
              " ORDER BY ",l_searchcol," ",g_order
                
   PREPARE browse_pre FROM g_sql
   DECLARE browse_cur CURSOR FOR browse_pre
 
   CALL g_browser.clear()
   LET g_cnt = 1
   FOREACH browse_cur INTO g_browser[g_cnt].b_glarld    
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      
      
      #add-point:browser_fill段reference
      {<point name="browser_fill.reference"/>}
      #end add-point    
      
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         EXIT FOREACH
      END IF
   END FOREACH
 
   CALL g_browser.deleteElement(g_cnt)
   IF g_browser.getLength() = 0 AND g_wc THEN
      INITIALIZE g_glar_m.* TO NULL
      CALL g_glar_d.clear()
 
      CLEAR FORM
   END IF
   
   LET g_header_cnt = g_browser.getLength()
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
   
   
   FREE browse_pre
   
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", TRUE)
   END IF
   
END FUNCTION
]]>
</section>
  <section id="aglq710.browser_search" ver="1" status="" src="s">
<![CDATA[#+ 瀏覽頁簽資料搜尋
PRIVATE FUNCTION aglq710_browser_search(p_type)
   {<Local define>}
   DEFINE p_type LIKE type_t.chr10
   {</Local define>}
   #add-point:browser_search段define
   {<point name="browser_search.define"/>}
   #end add-point    
   
   #若無輸入關鍵字則查找出所有資料
   IF NOT cl_null(g_searchstr) AND g_searchcol='0' THEN
      CALL cl_err("searchcol","std-00005",0)
      RETURN FALSE 
   END IF 
   
   IF NOT cl_null(g_searchstr) THEN
      LET g_wc = " lower(", g_searchcol, ") LIKE '%", g_searchstr, "%'"
      LET g_wc = g_wc.toLowerCase()
   ELSE
      LET g_wc = " 1=1"
   END IF         
   
   #若為排序搜尋則添加以下條件
   IF cl_null(g_searchcol) OR g_searchcol = "0" THEN
      LET g_wc = g_wc, " ORDER BY glarld"
   ELSE
      LET g_wc = g_wc, " ORDER BY ", g_searchcol
   END IF 
 
   CALL aglq710_browser_fill("F")
   CALL ui.Interface.refresh()
   RETURN TRUE
 
END FUNCTION
]]>
</section>
  <section id="aglq710.construct" ver="1" status="" src="s">
<![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION aglq710_construct()
 
   {<Local define>}
   DEFINE lc_qbe_sn   LIKE type_t.num10
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   {</Local define>}
   #add-point:cs段define
   {<point name="cs.define"/>}
   #end add-point    
 
   #清除畫面上相關資料
   CLEAR FORM                 
   INITIALIZE g_glar_m.* TO NULL
   CALL g_glar_d.clear()
 
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   LET g_action_choice = ""
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段construct外
   {<point name="cs.head.before"/>}
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON glarld,glarcomp
 
         BEFORE CONSTRUCT
#saki            CALL cl_qbe_init()
            #add-point:cs段more_construct
            {<point name="cs.head.before_construct"/>}
            #end add-point 
            
        #---------------------------<  Master  >---------------------------
         #----<<glarld>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glarld
            #add-point:BEFORE FIELD glarld
            {<point name="construct.b.glarld" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glarld
            
            #add-point:AFTER FIELD glarld
            {<point name="construct.a.glarld" />}
            #END add-point
            
 
         #Ctrlp:construct.c.glarld
         ON ACTION controlp INFIELD glarld
            #add-point:ON ACTION controlp INFIELD glarld
            {<point name="construct.c.glarld" />}
            #END add-point
 
         #----<<glarcomp>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glarcomp
            #add-point:BEFORE FIELD glarcomp
            {<point name="construct.b.glarcomp" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glarcomp
            
            #add-point:AFTER FIELD glarcomp
            {<point name="construct.a.glarcomp" />}
            #END add-point
            
 
         #Ctrlp:construct.c.glarcomp
         ON ACTION controlp INFIELD glarcomp
            #add-point:ON ACTION controlp INFIELD glarcomp
            {<point name="construct.c.glarcomp" />}
            #END add-point
 
 
         
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table1 ON glar001,glar001_desc,glar009
           FROM s_detail1[1].glar001,s_detail1[1].glar001_desc,s_detail1[1].glar009
                      
         BEFORE CONSTRUCT
#saki            CALL cl_qbe_display_condition(lc_qbe_sn)
            #add-point:cs段more_construct
            {<point name="cs.body.before_construct"/>}
            #end add-point 
            
         #單身公用欄位開窗相關處理
         
           
         #單身一般欄位開窗相關處理
         #---------------------<  Detail: page1  >---------------------
         #----<<glar001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glar001
            #add-point:BEFORE FIELD glar001
            {<point name="construct.b.page1.glar001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glar001
            
            #add-point:AFTER FIELD glar001
            {<point name="construct.a.page1.glar001" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.glar001
         ON ACTION controlp INFIELD glar001
            #add-point:ON ACTION controlp INFIELD glar001
            {<point name="construct.c.page1.glar001" />}
            #END add-point
 
         #----<<glar001_desc>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glar001_desc
            #add-point:BEFORE FIELD glar001_desc
            {<point name="construct.b.page1.glar001_desc" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glar001_desc
            
            #add-point:AFTER FIELD glar001_desc
            {<point name="construct.a.page1.glar001_desc" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.glar001_desc
         ON ACTION controlp INFIELD glar001_desc
            #add-point:ON ACTION controlp INFIELD glar001_desc
            {<point name="construct.c.page1.glar001_desc" />}
            #END add-point
 
         #----<<glar009>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glar009
            #add-point:BEFORE FIELD glar009
            {<point name="construct.b.page1.glar009" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glar009
            
            #add-point:AFTER FIELD glar009
            {<point name="construct.a.page1.glar009" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.glar009
         ON ACTION controlp INFIELD glar009
            #add-point:ON ACTION controlp INFIELD glar009
            {<point name="construct.c.page1.glar009" />}
            #END add-point
 
   
       
      END CONSTRUCT
  
 
  
      #add-point:cs段more_construct
      {<point name="cs.more_construct"/>}
      #end add-point
 
      BEFORE DIALOG
         #add-point:ui_dialog段b_dialog
         {<point name="cs.before_dialog"/>}
         #end add-point
      
      ON ACTION qbe_select     #條件查詢
#saki         CALL cl_qbe_list() RETURNING lc_qbe_sn
#saki         CALL cl_qbe_display_condition(lc_qbe_sn)
 
      ON ACTION qbe_save       #條件儲存
#saki         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG
   
   #add-point:cs段after_construct
   {<point name="cs.after_construct"/>}
   #end add-point
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
 
 
 
   
   LET g_current_row = 1
 
   IF INT_FLAG THEN
      RETURN
   END IF
   
   LET g_wc_filter = ""
 
END FUNCTION
]]>
</section>
  <section id="aglq710.default_search" ver="1" status="" src="s">
<![CDATA[#+ 外部參數搜尋, 施工中
PRIVATE FUNCTION aglq710_default_search()
   {<Local define>}
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   {</Local define>}
   #add-point:default_search段define
   {<point name="default_search.define"/>}
   #end add-point  
   
   #add-point:default_search段開始前
   {<point name="default_search.before"/>}
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[1]) THEN
      LET ls_wc = ls_wc, " glarld = '", g_argv[1], "' AND "
   END IF
   
 
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
   ELSE
      IF cl_null(g_wc) THEN
         LET g_wc = " 1=1"
      END IF
   END IF
   
   #add-point:default_search段結束前
   {<point name="default_search.after"/>}
   #end add-point  
 
END FUNCTION
]]>
</section>
  <section id="aglq710.delete" ver="2" status="" src="s">
<![CDATA[#+ delete
PRIVATE FUNCTION aglq710_delete()
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point
 
   #add-point:delete段control
   {<point name="delete.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq710.delete_b" ver="1" status="" src="s">
<![CDATA[#+ 刪除單身後其他table連動
PRIVATE FUNCTION aglq710_delete_b(ps_table,ps_keys_bak,ps_page)
   {<Local define>}
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   {</Local define>}
   #add-point:delete_b段define
   {<point name="delete_b.define"/>}
   #end add-point     
 
 
   
END FUNCTION
]]>
</section>
  <section id="aglq710.description" ver="174" status="" src="s">
<![CDATA[#+ Version..: T100-ERP-1.00.00(版次:1) Build-000173
#+ 
#+ Filename...: aglq710
#+ Description: 科目各期餘額查詢作業
#+ Creator....: 02599(2014/03/12)
#+ Modifier...: 02599(2014/03/13)
#+ Buildtype..: 應用 q02 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
</section>
  <section id="aglq710.detail_reproduce" ver="1" status="" src="s">
<![CDATA[#+ 單身自動複製
PRIVATE FUNCTION aglq710_detail_reproduce()
   {<Local define>}
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE glar_t.*
 
 
   {</Local define>}
   #add-point:delete段define
   {<point name="detail_reproduce.define"/>}
   #end add-point    
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE aglq710_detail
   
   #add-point:單身複製前1
   {<point name="detail_reproduce.body.table1.b_insert" mark="Y"/>}
   #end add-point
   
   #CREATE TEMP TABLE
   LET ls_sql = "CREATE GLOBAL TEMPORARY TABLE aglq710_detail AS ",
                "SELECT * FROM glar_t "
   PREPARE repro_tbl FROM ls_sql
   EXECUTE repro_tbl
   FREE repro_tbl
                
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO aglq710_detail SELECT * FROM glar_t 
                                         WHERE glarent = g_enterprise AND glarld = g_glarld_t
 
   
   #將key修正為調整後   
   UPDATE aglq710_detail 
      #更新key欄位
      SET glarld = g_glar_m.glarld
 
      #更新共用欄位
      
                                       
  
   #將資料塞回原table   
   INSERT INTO glar_t SELECT * FROM aglq710_detail
   
   IF SQLCA.sqlcode THEN
      CALL cl_err("reproduce",SQLCA.sqlcode,1)
      RETURN
   END IF
   
   #add-point:單身複製中1
   {<point name="detail_reproduce.body.table1.m_insert"/>}
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aglq710_detail
   
   #add-point:單身複製後1
   {<point name="detail_reproduce.body.table1.a_insert"/>}
   #end add-point
 
 
   
 
   
   #多語言複製段落
      #此段落由子樣板a38產生
   DROP TABLE aglq710_detail_lang
   
   #add-point:單身複製前1
   {<point name="detail_reproduce.body.lang0.b_insert" mark="Y"/>}
   #end add-point
   
   #CREATE TEMP TABLE
   LET ls_sql = "CREATE GLOBAL TEMPORARY TABLE aglq710_detail_lang AS ",
                "SELECT * FROM glacl_t "
   PREPARE repro_glacl_t FROM ls_sql
   EXECUTE repro_glacl_t
   FREE repro_glacl_t
                
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO aglq710_detail_lang SELECT * FROM glacl_t 
                                             WHERE glaclent = g_enterprise AND glacl002 = g_glarld_t
 
   
   #將key修正為調整後   
   UPDATE aglq710_detail_lang 
      #更新key欄位
      SET glacl002 = g_glar_m.glarld
 
  
   #將資料塞回原table   
   INSERT INTO glacl_t SELECT * FROM aglq710_detail_lang
   
   IF SQLCA.sqlcode THEN
      CALL cl_err("reproduce",SQLCA.sqlcode,1)
      RETURN
   END IF
   
   #add-point:單身複製中1
   {<point name="detail_reproduce.lang0.table1.m_insert"/>}
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aglq710_detail_lang
   
   #add-point:單身複製後1
   {<point name="detail_reproduce.lang0.table1.a_insert"/>}
   #end add-point
 
 
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_glarld_t = g_glar_m.glarld
 
   
   DROP TABLE aglq710_detail
   
END FUNCTION
]]>
</section>
  <section id="aglq710.detail_show" ver="1" status="" src="s">
<![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION aglq710_detail_show()
   #add-point:show段define
   {<point name="detail_show.define"/>}
   #end add-point
 
   #add-point:detail_show段之前
   {<point name="detail_show.before"/>}
   #end add-point
   
   
   
   #帶出公用欄位reference值page1
   
    
 
   
   #讀入ref值
   #add-point:show段單身reference
   {<point name="detail_show.body.reference"/>}
   #end add-point
   
 
 
   #add-point:detail_show段之後
   {<point name="detail_show.after"/>}
   #end add-point
 
END FUNCTION
]]>
</section>
  <section id="aglq710.fetch" ver="2" status="" src="s">
<![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION aglq710_fetch()
   {<Local define>}
   DEFINE li_ac           LIKE type_t.num5
   {</Local define>}
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point
   
 
   
   LET li_ac = l_ac 
   
 
   
   #DISPLAY g_detail_cnt TO FORMONLY.cnt
 
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
</section>
  <section id="aglq710.fill_chk" ver="1" status="" src="s">
<![CDATA[#+ 單身填充確認
PRIVATE FUNCTION aglq710_fill_chk(ps_idx)
   {<Local define>}
   DEFINE ps_idx        LIKE type_t.chr10
   DEFINE lst_token     base.StringTokenizer
   DEFINE ls_token      STRING
   {</Local define>}
   #add-point:fill_chk段define
   {<point name="fill_chk.define"/>}
   #end add-point
   
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1') THEN
      RETURN TRUE
   END IF
   
   #第一單身
   IF ps_idx = 1 AND
      ((NOT cl_null(g_wc2_table1) AND g_wc2_table1.trim() <> '1=1')) THEN
      RETURN TRUE
   END IF
   
   #根據wc判定是否需要填充
 
 
   
   #add-point:fill_chk段other
   {<point name="fill_chk.other"/>}
   #end add-point
   
   RETURN FALSE
 
END FUNCTION
]]>
</section>
  <section id="aglq710.filter" ver="16" status="" src="s">
<![CDATA[#+ filter過濾功能
PRIVATE FUNCTION aglq710_filter()
   {<Local define>}
   {</Local define>}
   #add-point:filter段define
   {<point name="filter.define"/>}
   #end add-point    
   
   LET l_ac = 1
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON glar001,glar009
                          FROM s_detail1[1].b_glar001,s_detail1[1].b_glar009
 
         BEFORE CONSTRUCT
#saki       CALL cl_qbe_init()
                     DISPLAY aglq710_filter_parser('glar001') TO s_detail1[1].b_glar001
            DISPLAY aglq710_filter_parser('glar009') TO s_detail1[1].b_glar009
 
 
      END CONSTRUCT
 
      #add-point:filter段add_cs
      {<point name="filter.add_cs"/>}
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog
         {<point name="filter.b_dialog"/>}
         #end add-point  
 
      ON ACTION accept
         ACCEPT DIALOG 
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
 
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = g_wc_filter, " "
   ELSE
      LET g_wc_filter = g_wc_filter_t
   END IF
   
      CALL aglq710_filter_show('glar001','b_glar001')
   CALL aglq710_filter_show('glar009','b_glar009')
 
    
   CALL aglq710_b_fill()
   CALL aglq710_fetch()
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
 
END FUNCTION
]]>
</section>
  <section id="aglq710.filter_parser" ver="2" status="" src="s">
<![CDATA[#+ filter欄位解析
PRIVATE FUNCTION aglq710_filter_parser(ps_field)
   {<Local define>}
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   {</Local define>}
   #add-point:filter段define
   {<point name="filter_parser.define"/>}
   #end add-point    
 
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
</section>
  <section id="aglq710.filter_show" ver="1" status="" src="s">
<![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION aglq710_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = aglq710_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
</section>
  <section id="aglq710.global" ver="18" status="" src="s">
<![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單身 type 宣告
PRIVATE TYPE type_g_glar_d RECORD
       #statepic       LIKE type_t.chr1,
       sel            LIKE type_t.chr1,
       glar001 LIKE glar_t.glar001, 
   glar001_desc LIKE type_t.chr500, 
   glar009 LIKE glar_t.glar009, 
   oyeard LIKE type_t.chr80, 
   oyearc LIKE type_t.chr80, 
   yeard LIKE type_t.chr80, 
   yearc LIKE type_t.chr80, 
   yeard2 LIKE type_t.chr80, 
   yearc2 LIKE type_t.chr80, 
   yeard3 LIKE type_t.chr80, 
   yearc3 LIKE type_t.chr80, 
   oqcd LIKE type_t.chr80, 
   oqcc LIKE type_t.chr80, 
   qcd LIKE type_t.chr80, 
   qcc LIKE type_t.chr80, 
   qcd2 LIKE type_t.chr80, 
   qcc2 LIKE type_t.chr80, 
   qcd3 LIKE type_t.chr80, 
   qcc3 LIKE type_t.chr80, 
   oqjd LIKE type_t.chr80, 
   oqjc LIKE type_t.chr80, 
   qjd LIKE type_t.chr80, 
   qjc LIKE type_t.chr80, 
   qjd2 LIKE type_t.chr80, 
   qjc2 LIKE type_t.chr80, 
   qjd3 LIKE type_t.chr80, 
   qjc3 LIKE type_t.chr80, 
   oqmd LIKE type_t.chr80, 
   oqmc LIKE type_t.chr80, 
   qmd LIKE type_t.chr80, 
   qmc LIKE type_t.chr80, 
   qmd2 LIKE type_t.chr80, 
   qmc2 LIKE type_t.chr80, 
   qmd3 LIKE type_t.chr80, 
   qmc3 LIKE type_t.chr80, 
   osumd LIKE type_t.chr80, 
   osumc LIKE type_t.chr80, 
   sumd LIKE type_t.chr80, 
   sumc LIKE type_t.chr80, 
   sumd2 LIKE type_t.chr80, 
   sumc2 LIKE type_t.chr80, 
   sumd3 LIKE type_t.chr80, 
   sumc3 LIKE type_t.chr80 
       END RECORD
 
 
#模組變數(Module Variables)
DEFINE g_master                     type_g_glar_d
DEFINE g_master_t                   type_g_glar_d
DEFINE g_glar_d          DYNAMIC ARRAY OF type_g_glar_d
DEFINE g_glar_d_t        type_g_glar_d
 
      
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num5              
DEFINE l_ac_d               LIKE type_t.num5              #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num5              #目前所在頁數
DEFINE g_detail_cnt         LIKE type_t.num5              #單身 總筆數(所有資料)
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num5
DEFINE g_detail_idx         LIKE type_t.num5
DEFINE g_detail_idx2        LIKE type_t.num5
DEFINE g_hyper_url          STRING                        #hyperlink的主要網址
 
 
#多table用wc
DEFINE g_wc_table           STRING
 
 
 
DEFINE g_wc_filter_table           STRING
 
 
 
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
</section>
  <section id="aglq710.init" ver="2" status="" src="s">
<![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION aglq710_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
   
   
   
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
</section>
  <section id="aglq710.input" ver="1" status="" src="s">
<![CDATA[#+ 資料輸入
PRIVATE FUNCTION aglq710_input(p_cmd)
   {<Local define>}
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_ac_t                LIKE type_t.num5                #未取消的ARRAY CNT 
   DEFINE  l_n                   LIKE type_t.num5                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num5                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num5
   DEFINE  l_i                   LIKE type_t.num5
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num5
   DEFINE  li_reproduce_target   LIKE type_t.num5
   {</Local define>}
   #add-point:input段define
   {<point name="input.define"/>}
   #end add-point    
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF  
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql
   {<point name="input.define_sql" mark="Y"/>}
   #end add-point 
   LET g_forupd_sql = "SELECT glar001,'',glar009,'','','','','','','','','','','','','','','','','', 
       '','','','','','','','','','','','','','','','','','','','','','','' FROM glar_t WHERE glarent=?  
       AND glarld=? AND glar001=? AND glar002=? AND glar003=? AND glar004=? FOR UPDATE"
   #add-point:input段define_sql
   {<point name="input.after_define_sql"/>}
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   DECLARE aglq710_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR
 
 
   
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL aglq710_set_entry(p_cmd)
   #add-point:set_entry後
   {<point name="input.after_set_entry"/>}
   #end add-point
   CALL aglq710_set_no_entry(p_cmd)
   #add-point:set_no_entry後
   {<point name="input.after_set_no_entry"/>}
   #end add-point
 
   DISPLAY BY NAME g_glar_m.glarld,g_glar_m.glarcomp
   
   LET lb_reproduce = FALSE
   
   #add-point:進入修改段前
   {<point name="input.before_input"/>}
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
]]>
</section>
  <section id="aglq710.input.body" ver="1" status="" src="s">
<![CDATA[      #Page1 預設值產生於此處
      INPUT ARRAY g_glar_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂單身ACTION
         
 
 
         ON ACTION update_item
            #add-point:ON ACTION update_item
            {<point name="input.detail_input.page1.update_item" />}
            #END add-point
 
 
         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_glar_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aglq710_b_fill(g_wc2) 
            IF g_rec_b != 0 THEN
               CALL fgl_set_arr_curr(l_ac)
            END IF
            #add-point:資料輸入前
            {<point name="input.body.before_input"/>}
            #end add-point
         
         BEFORE ROW
            LET l_insert = FALSE
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
            LET l_ac = ARR_CURR()
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            
         
            CALL s_transaction_begin()
            
            #判定新增或修改
            IF l_cmd = 'u' THEN
               OPEN aglq710_cl USING g_enterprise,
                                               g_glar_m.glarld
 
                                               
               IF STATUS THEN
                  CALL cl_err("OPEN aglq710_cl:", STATUS, 1)
                  CLOSE aglq710_cl
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
            END IF
            
            LET l_cmd = ''
            
            IF g_rec_b >= l_ac 
               AND g_glar_d[l_ac].glar001 IS NOT NULL
               AND g_glar_d[l_ac].glar002 IS NOT NULL
 
               AND g_glar_d[l_ac].glar003 IS NOT NULL
 
               AND g_glar_d[l_ac].glar004 IS NOT NULL
 
 
            THEN
               LET l_cmd='u'
               LET g_glar_d_t.* = g_glar_d[l_ac].*  #BACKUP
               CALL aglq710_set_entry_b(l_cmd)
               CALL aglq710_set_no_entry_b(l_cmd)
               OPEN aglq710_bcl USING g_enterprise,g_glar_m.glarld,
 
                                                g_glar_d_t.glar001
                                                ,g_glar_d_t.glar002
 
                                                ,g_glar_d_t.glar003
 
                                                ,g_glar_d_t.glar004
 
 
               IF STATUS THEN
                  CALL cl_err("OPEN aglq710_bcl:", STATUS, 1)
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aglq710_bcl INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,g_glar_d[l_ac].glar009, 
                      g_glar_d[l_ac].year,g_glar_d[l_ac].year,g_glar_d[l_ac].year,g_glar_d[l_ac].year, 
                      g_glar_d[l_ac].year,g_glar_d[l_ac].year,g_glar_d[l_ac].year,g_glar_d[l_ac].year, 
                      g_glar_d[l_ac].qc,g_glar_d[l_ac].qc,g_glar_d[l_ac].qc,g_glar_d[l_ac].qc,g_glar_d[l_ac].qc, 
                      g_glar_d[l_ac].qc,g_glar_d[l_ac].qc,g_glar_d[l_ac].qc,g_glar_d[l_ac].qj,g_glar_d[l_ac].qj, 
                      g_glar_d[l_ac].qj,g_glar_d[l_ac].qj,g_glar_d[l_ac].qj,g_glar_d[l_ac].qj,g_glar_d[l_ac].qj, 
                      g_glar_d[l_ac].qj,g_glar_d[l_ac].qm,g_glar_d[l_ac].qm,g_glar_d[l_ac].qm,g_glar_d[l_ac].qm, 
                      g_glar_d[l_ac].qm,g_glar_d[l_ac].qm,g_glar_d[l_ac].qm,g_glar_d[l_ac].qm,g_glar_d[l_ac].sum, 
                      g_glar_d[l_ac].sum,g_glar_d[l_ac].sum,g_glar_d[l_ac].sum,g_glar_d[l_ac].sum,g_glar_d[l_ac].sum, 
                      g_glar_d[l_ac].sum,g_glar_d[l_ac].sum
                  IF SQLCA.sqlcode THEN
                      CALL cl_err(g_glar_d_t.glar001,SQLCA.sqlcode,1)
                      LET l_lock_sw = "Y"
                  END IF
                  
                  CALL aglq710_ref_show()
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row
            {<point name="input.body.before_row"/>}
            #end add-point  
            
        
         BEFORE INSERT
            
            INITIALIZE g_glar_d_t.* TO NULL
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_glar_d[l_ac].* TO NULL
            
            #公用欄位預設值
              
            
            #一般欄位預設值
            
            
            
            LET g_glar_d_t.* = g_glar_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aglq710_set_entry_b(l_cmd)
            CALL aglq710_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_glar_d[li_reproduce_target].* = g_glar_d[li_reproduce].*
 
               LET g_glar_d[g_glar_d.getLength()].glar001 = NULL
               LET g_glar_d[g_glar_d.getLength()].glar002 = NULL
 
               LET g_glar_d[g_glar_d.getLength()].glar003 = NULL
 
               LET g_glar_d[g_glar_d.getLength()].glar004 = NULL
 
 
            END IF
            
            #add-point:modify段before insert
            {<point name="input.body.before_insert"/>}
            #end add-point  
 
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            LET l_count = 1  
            SELECT COUNT(*) INTO l_count FROM glar_t 
             WHERE glarent = g_enterprise AND glarld = g_glar_m.glarld
 
               AND glar001 = g_glar_d[l_ac].glar001
               AND glar002 = g_glar_d[l_ac].glar002
 
               AND glar003 = g_glar_d[l_ac].glar003
 
               AND glar004 = g_glar_d[l_ac].glar004
 
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               CALL s_transaction_begin()
               #add-point:單身新增前
               {<point name="input.body.b_insert" mark="Y"/>}
               #end add-point
               INSERT INTO glar_t
                           (glarent,
                            glarld,glarcomp,
                            glar001,glar002,glar003,glar004
                            ,glar009) 
                     VALUES(g_enterprise,
                            g_glar_m.glarld,g_glar_m.glarcomp,
                            g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar002,g_glar_d[l_ac].glar003,g_glar_d[l_ac].glar004 

                            ,g_glar_d[l_ac].glar009)
               #add-point:單身新增中
               {<point name="input.body.m_insert"/>}
               #end add-point
               LET p_cmd = 'u'
            ELSE    
               CALL cl_err('INSERT',"std-00006",1)
               INITIALIZE g_glar_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLcode  THEN
               CALL cl_err("glar_t",SQLCA.sqlcode,1)  
               CALL s_transaction_end('N','0')                    
               CANCEL INSERT
            ELSE
               #資料多語言用-增/改
               
               #add-point:input段-after_insert
               {<point name="input.body.a_insert"/>}
               #end add-point
               CALL s_transaction_end('Y','0')
               ERROR "INSERT O.K"
               LET g_rec_b=g_rec_b+1
               DISPLAY g_rec_b TO FORMONLY.cnt
            END IF
            
            #add-point:單身新增後
            {<point name="input.body.after_insert"/>}
            #end add-point
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' AND g_glar_d.getLength() < l_ac THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_glar_d.deleteElement(l_ac)
               NEXT FIELD glar001
            END IF
            IF g_glar_d_t.glar001 IS NOT NULL
               AND g_glar_d_t.glar002 IS NOT NULL
 
               AND g_glar_d_t.glar003 IS NOT NULL
 
               AND g_glar_d_t.glar004 IS NOT NULL
 
 
               THEN
               
               #add-point:單身刪除前
               {<point name="input.body.b_delete"/>}
               #end add-point
               
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  CALL cl_err("", -263, 1)
                  CANCEL DELETE
               END IF
               IF aglq710_before_delete() THEN 
                  CALL s_transaction_end('Y','0')
               ELSE 
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE   
               END IF 
               CLOSE aglq710_bcl
               LET l_count = g_glar_d.getLength()
            END IF 
            
            #add-point:單身刪除後
            {<point name="input.body.a_delete"/>}
            #end add-point
              
         AFTER DELETE 
            #add-point:單身AFTER DELETE 
            {<point name="input.body.after_delete"/>}
            #end add-point
 
         #---------------------<  Detail: page1  >---------------------
         #----<<glar001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glar001
            #add-point:BEFORE FIELD glar001
            {<point name="input.b.page1.glar001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glar001
            
            #add-point:AFTER FIELD glar001
            {<point name="input.a.page1.glar001" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE glar001
            #add-point:ON CHANGE glar001
            {<point name="input.g.page1.glar001" />}
            #END add-point
 
         #----<<glar001_desc>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glar001_desc
            #add-point:BEFORE FIELD glar001_desc
            {<point name="input.b.page1.glar001_desc" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glar001_desc
            
            #add-point:AFTER FIELD glar001_desc
            {<point name="input.a.page1.glar001_desc" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE glar001_desc
            #add-point:ON CHANGE glar001_desc
            {<point name="input.g.page1.glar001_desc" />}
            #END add-point
 
         #----<<glar009>>----
         #此段落由子樣板a01產生
         BEFORE FIELD glar009
            #add-point:BEFORE FIELD glar009
            {<point name="input.b.page1.glar009" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD glar009
            
            #add-point:AFTER FIELD glar009
            {<point name="input.a.page1.glar009" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE glar009
            #add-point:ON CHANGE glar009
            {<point name="input.g.page1.glar009" />}
            #END add-point
 
 
         #---------------------<  Detail: page1  >---------------------
         #----<<glar001>>----
         #Ctrlp:input.c.page1.glar001
         ON ACTION controlp INFIELD glar001
            #add-point:ON ACTION controlp INFIELD glar001
            {<point name="input.c.page1.glar001" />}
            #END add-point
 
         #----<<glar001_desc>>----
         #Ctrlp:input.c.page1.glar001_desc
         ON ACTION controlp INFIELD glar001_desc
            #add-point:ON ACTION controlp INFIELD glar001_desc
            {<point name="input.c.page1.glar001_desc" />}
            #END add-point
 
         #----<<glar009>>----
         #Ctrlp:input.c.page1.glar009
         ON ACTION controlp INFIELD glar009
            #add-point:ON ACTION controlp INFIELD glar009
            {<point name="input.c.page1.glar009" />}
            #END add-point
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_glar_d[l_ac].* = g_glar_d_t.*
               CLOSE aglq710_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_glar_d[l_ac].glar001,-263,1)
               LET g_glar_d[l_ac].* = g_glar_d_t.*
            ELSE
               #寫入修改者/修改日期資訊
               
            
               #add-point:單身修改前
               {<point name="input.body.b_update" mark="Y"/>}
               #end add-point
         
               UPDATE glar_t SET (glarld,glar001,glar009) = (g_glar_m.glarld,g_glar_d[l_ac].glar001, 
                   g_glar_d[l_ac].glar009)
                WHERE glarent = g_enterprise AND glarld = g_glar_m.glarld 
 
                 AND glar001 = g_glar_d_t.glar001 #項次   
                 AND glar002 = g_glar_d_t.glar002  
 
                 AND glar003 = g_glar_d_t.glar003  
 
                 AND glar004 = g_glar_d_t.glar004  
 
 
                 
               #add-point:單身修改中
               {<point name="input.body.m_update"/>}
               #end add-point
               
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     CALL cl_err("glar_t","std-00009",1)
                     CALL s_transaction_end('N','0')
                  #WHEN SQLCA.sqlcode #其他錯誤
                  #   CALL cl_err("glar_t",SQLCA.sqlcode,1)  
                  #   CALL s_transaction_end('N','0')
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_glar_m.glarld
               LET gs_keys_bak[1] = g_glarld_t
               LET gs_keys[2] = g_glar_d[g_detail_idx].glar001
               LET gs_keys_bak[2] = g_glar_d_t.glar001
               LET gs_keys[3] = g_glar_d[g_detail_idx].glar002
               LET gs_keys_bak[3] = g_glar_d_t.glar002
               LET gs_keys[4] = g_glar_d[g_detail_idx].glar003
               LET gs_keys_bak[4] = g_glar_d_t.glar003
               LET gs_keys[5] = g_glar_d[g_detail_idx].glar004
               LET gs_keys_bak[5] = g_glar_d_t.glar004
               CALL aglq710_update_b('glar_t',gs_keys,gs_keys_bak,"'1'")
                     #資料多語言用-增/改
                     
               END CASE
               
               #add-point:單身修改後
               {<point name="input.body.a_update"/>}
               #end add-point
            END IF
 
         AFTER INPUT
            #若單身還沒有輸入資料, 強制切換至單身
            IF cl_null(g_glar_d[1].glar001) THEN
               CALL g_glar_d.deleteElement(1)
               NEXT FIELD glar001
            END IF
            #add-point:input段after input 
            {<point name="input.body.after_input"/>}
            #end add-point    
            
         ON ACTION controlo   
            CALL FGL_SET_ARR_CURR(g_glar_d.getLength()+1)
            LET lb_reproduce = TRUE
            LET li_reproduce = l_ac
            LET li_reproduce_target = g_glar_d.getLength()+1
            
      END INPUT
 
 
      
 
      
 
      
      #add-point:input段more_input
      {<point name="input.more_inputarray"/>}
      #end add-point    
      
      BEFORE DIALOG
         #add-point:input段before_dialog
         {<point name="input.before_dialog"/>}
         #end add-point 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            NEXT FIELD glarld
        ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD glar001
 
            END CASE
         END IF
   
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         CALL cl_set_head_visible("","AUTO")
 
      ON ACTION accept
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         LET g_action_choice=""
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
   
   #add-point:input段after_input
   {<point name="input.after_input"/>}
   #end add-point  
   
END FUNCTION
]]>
</section>
  <section id="aglq710.input.head" ver="1" status="" src="s">
<![CDATA[   
      #單頭段
      INPUT BY NAME g_glar_m.glarld,g_glar_m.glarcomp 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂單頭ACTION
         
         
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #add-point:單頭input前
            {<point name="input.head.b_input"/>}
            #end add-point
          
         #---------------------------<  Master  >---------------------------
         #----<<glarld>>----
         #此段落由子樣板a02產生
         AFTER FIELD glarld
            
            #add-point:AFTER FIELD glarld
            {<point name="input.a.glarld" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD glarld
            #add-point:BEFORE FIELD glarld
            {<point name="input.b.glarld" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE glarld
            #add-point:ON CHANGE glarld
            {<point name="input.g.glarld" />}
            #END add-point
 
         #----<<glarcomp>>----
         #此段落由子樣板a02產生
         AFTER FIELD glarcomp
            
            #add-point:AFTER FIELD glarcomp
            {<point name="input.a.glarcomp" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD glarcomp
            #add-point:BEFORE FIELD glarcomp
            {<point name="input.b.glarcomp" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE glarcomp
            #add-point:ON CHANGE glarcomp
            {<point name="input.g.glarcomp" />}
            #END add-point
 
 #欄位檢查
         #---------------------------<  Master  >---------------------------
         #----<<glarld>>----
         #Ctrlp:input.c.glarld
         ON ACTION controlp INFIELD glarld
            #add-point:ON ACTION controlp INFIELD glarld
            {<point name="input.c.glarld" />}
            #END add-point
 
         #----<<glarcomp>>----
         #Ctrlp:input.c.glarcomp
         ON ACTION controlp INFIELD glarcomp
            #add-point:ON ACTION controlp INFIELD glarcomp
            {<point name="input.c.glarcomp" />}
            #END add-point
 
 #欄位開窗
 
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
            
            IF s_transaction_chk("N",0) THEN
                CALL s_transaction_begin()
            END IF
 
            #多語言處理
            
                
            CALL cl_showmsg()
            DISPLAY BY NAME g_glar_m.glarld             
 
 
            IF p_cmd = 'u' THEN
               #add-point:單頭修改前
               {<point name="input.head.b_update" mark="Y"/>}
               #end add-point
            
               UPDATE glar_t SET (glarld,glarcomp) = (g_glar_m.glarld,g_glar_m.glarcomp)
                WHERE glarent = g_enterprise AND glarld = g_glarld_t
 
               #add-point:單頭修改中
               {<point name="input.head.m_update"/>}
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     CALL cl_err("glar_t","std-00009",1)
                     CALL s_transaction_end('N','0')
                  WHEN SQLCA.sqlcode #其他錯誤
                     CALL cl_err("glar_t",SQLCA.sqlcode,1)  
                     CALL s_transaction_end('N','0')
                  OTHERWISE
                     #資料多語言用-增/改
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_glar_m.glarld
               LET gs_keys_bak[1] = g_glarld_t
               LET gs_keys[2] = g_glar_d[g_detail_idx].glar001
               LET gs_keys_bak[2] = g_glar_d_t.glar001
               LET gs_keys[3] = g_glar_d[g_detail_idx].glar002
               LET gs_keys_bak[3] = g_glar_d_t.glar002
               LET gs_keys[4] = g_glar_d[g_detail_idx].glar003
               LET gs_keys_bak[4] = g_glar_d_t.glar003
               LET gs_keys[5] = g_glar_d[g_detail_idx].glar004
               LET gs_keys_bak[5] = g_glar_d_t.glar004
               CALL aglq710_update_b('glar_t',gs_keys,gs_keys_bak,"'1'")
                     
                     LET g_glarld_t = g_glar_m.glarld
 
                     #add-point:單頭修改後
                     {<point name="input.head.a_update"/>}
                     #end add-point
                     CALL s_transaction_end('Y','0')
               END CASE
            
            ELSE    
               #add-point:單頭新增
               {<point name="input.head.a_insert"/>}
               #end add-point
                                 
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL aglq710_detail_reproduce()
               END IF
            END IF
           #controlp
                     
           LET g_glarld_t = g_glar_m.glarld
 
           
           #若單身還沒有輸入資料, 強制切換至單身
           IF cl_null(g_glar_d[1].glar001) THEN
              CALL g_glar_d.deleteElement(1)
              NEXT FIELD glar001
           END IF
 
      END INPUT
]]>
</section>
  <section id="aglq710.insert" ver="3" status="" src="s">
<![CDATA[#+ insert
PRIVATE FUNCTION aglq710_insert()
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point
 
   #add-point:insert段control
   {<point name="insert.control"/>}
   #end add-point    
   
END FUNCTION
]]>
</section>
  <section id="aglq710.insert_b" ver="1" status="" src="s">
<![CDATA[#+ 新增單身後其他table連動
PRIVATE FUNCTION aglq710_insert_b(ps_table,ps_keys,ps_page)
   {<Local define>}
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   {</Local define>}
   #add-point:insert_b段define
   {<point name="insert_b.define"/>}
   #end add-point     
   
 
   
END FUNCTION
]]>
</section>
  <section id="aglq710.lock_b" ver="1" status="" src="s">
<![CDATA[#+ 連動lock其他單身table資料
PRIVATE FUNCTION aglq710_lock_b(ps_table,ps_page)
   {<Local define>}
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   {</Local define>}
   #add-point:lock_b段define
   {<point name="lock_b.define"/>}
   #end add-point   
   
   #先刷新資料
   #CALL aglq710_b_fill()
   
 
   
   RETURN TRUE
 
END FUNCTION
]]>
</section>
  <section id="aglq710.main" ver="5" status="" src="s">
<![CDATA[#+ 此段落由子樣板a26產生
#OPTIONS SHORT CIRCUIT
#+ 作業開始 
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point   
 
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("agl","")
 
   #add-point:作業初始化
   {<point name="main.init" />}
   #end add-point
   
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = ""
   #add-point:SQL_define
   {<point name="main.after_define_sql"/>}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   DECLARE aglq710_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT UNIQUE ",
               " FROM ",
               " WHERE  "
   #add-point:SQL_define
   {<point name="main.after_refresh_sql"/>}
   #end add-point
   PREPARE aglq710_master_referesh FROM g_sql
 
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
 
   ELSE
      
      #畫面開啟 (identifier)
      OPEN WINDOW w_aglq710 WITH FORM cl_ap_formpath("agl",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL aglq710_init()   
 
      #進入選單 Menu (="N")
      CALL aglq710_ui_dialog() 
      
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_aglq710
      
   END IF 
   
   CLOSE aglq710_cl
   
   
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
   
END MAIN
 
 
]]>
</section>
  <section id="aglq710.modify" ver="2" status="" src="s">
<![CDATA[#+ modify
PRIVATE FUNCTION aglq710_modify()
   #add-point:modify段define
   {<point name="modify.define"/>}
   #end add-point
 
   #add-point:modify段control
   {<point name="modify.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq710.modify_detail_chk" ver="1" status="" src="s">
<![CDATA[#+ 單身輸入判定
PRIVATE FUNCTION aglq710_modify_detail_chk(ps_record)
   {<Local define>}
   DEFINE ps_record STRING
   DEFINE ls_return STRING
   {</Local define>}
   #add-point:modify_detail_chk段define
   {<point name="modify_detail_chk.define"/>}
   #end add-point
   
   #add-point:modify_detail_chk段開始前
   {<point name="modify_detail_chk.before"/>}
   #end add-point
   
   CASE ps_record
      WHEN "s_detail1" 
         LET ls_return = "glar001"
 
      #add-point:modify_detail_chk段自訂page控制
      {<point name="modify_detail_chk.page_control"/>}
      #end add-point
   END CASE
    
   #add-point:modify_detail_chk段結束前
   {<point name="modify_detail_chk.after"/>}
   #end add-point
   
   RETURN ls_return
   
END FUNCTION
]]>
</section>
  <section id="aglq710.other_function" ver="1" status="" src="s">
<![CDATA[{<point name="other.function"/>}
]]>
</section>
  <section id="aglq710.ref_show" ver="1" status="" src="s">
<![CDATA[#+ 帶出reference資料
PRIVATE FUNCTION aglq710_ref_show()
   {<Local define>}
   DEFINE l_ac_t LIKE type_t.num10 #l_ac暫存用
   {</Local define>}
   #add-point:ref_show段define
   {<point name="ref_show.define"/>}
   #end add-point
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:ref_show段m_reference
   {<point name="ref_show.head.reference"/>}
   #end add-point
 
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_glar_d.getLength()
      #add-point:ref_show段d_reference
      {<point name="ref_show.body.reference"/>}
      #end add-point
   END FOR
   
 
   
   LET l_ac = l_ac_t
 
END FUNCTION
]]>
</section>
  <section id="aglq710.reproduce" ver="2" status="" src="s">
<![CDATA[#+ reproduce
PRIVATE FUNCTION aglq710_reproduce()
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point
 
   #add-point:reproduce段control
   {<point name="reproduce.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq710.set_entry" ver="1" status="" src="s">
<![CDATA[#+ 單頭欄位開啟設定
PRIVATE FUNCTION aglq710_set_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1  
   {</Local define>}
   #add-point:set_entry段define
   {<point name="set_entry.define"/>}
   #end add-point       
 
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("glarld",TRUE)
      #add-point:set_entry段欄位控制
      {<point name="set_entry.field_control"/>}
      #end add-point 
   END IF
   
   #add-point:set_entry段欄位控制後
   {<point name="set_entry.after_control"/>}
   #end add-point 
 
END FUNCTION
]]>
</section>
  <section id="aglq710.set_entry_b" ver="1" status="" src="s">
<![CDATA[#+ 單身欄位開啟設定
PRIVATE FUNCTION aglq710_set_entry_b(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1   
   {</Local define>}
   #add-point:set_entry_b段define
   {<point name="set_entry_b.define"/>}
   #end add-point     
   
   #add-point:set_entry_b段
   {<point name="set_entry_b.set_entry_b"/>}
   #end add-point  
   
END FUNCTION
]]>
</section>
  <section id="aglq710.set_no_entry" ver="1" status="" src="s">
<![CDATA[#+ 單頭欄位關閉設定
PRIVATE FUNCTION aglq710_set_no_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1   
   {</Local define>}
   #add-point:set_no_entry段define
   {<point name="set_no_entry.define"/>}
   #end add-point     
 
   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("glarld",FALSE)
      #add-point:set_no_entry段欄位控制
      {<point name="set_no_entry.field_control"/>}
      #end add-point 
   END IF
   
   #add-point:set_no_entry段欄位控制後
   {<point name="set_no_entry.after_control"/>}
   #end add-point 
 
END FUNCTION
]]>
</section>
  <section id="aglq710.set_no_entry_b" ver="1" status="" src="s">
<![CDATA[#+ 單身欄位關閉設定
PRIVATE FUNCTION aglq710_set_no_entry_b(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1   
   {</Local define>}
   #add-point:set_no_entry_b段define
   {<point name="set_no_entry_b.define"/>}
   #end add-point    
   
   #add-point:set_no_entry_b段
   {<point name="set_no_entry_b.set_no_entry_b段"/>}
   #end add-point 
   
END FUNCTION
]]>
</section>
  <section id="aglq710.show" ver="1" status="" src="s">
<![CDATA[#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION aglq710_show()
   #add-point:show段define
   {<point name="show.define"/>}
   #end add-point
   
   #add-point:show段之前
   {<point name="show.before"/>}
   #end add-point
   
   IF g_bfill = "Y" THEN
      CALL aglq710_b_fill(g_wc2) #單身填充
      CALL aglq710_b_fill2('0') #單身填充
   END IF
   
   
 
   LET g_glar_m_t.* = g_glar_m.*      #保存單頭舊值
   
   DISPLAY BY NAME g_glar_m.glarld,g_glar_m.glarld_desc,g_glar_m.glarcomp,g_glar_m.glarcomp_desc,g_glar_m.glaa001, 
       g_glar_m.glaa016,g_glar_m.glaa020,g_glar_m.sdate,g_glar_m.syear,g_glar_m.speriod,g_glar_m.curr_o, 
       g_glar_m.show_acc,g_glar_m.glac009,g_glar_m.edate,g_glar_m.eyear,g_glar_m.eperiod,g_glar_m.curr_p, 
       g_glar_m.glac005,g_glar_m.show_ce,g_glar_m.ctype,g_glar_m.show_y,g_glar_m.stus,g_glar_m.show_ye 

   CALL aglq710_b_fill(g_wc2_table1)                 #單身
   CALL aglq710_b_fill2('0') #單身填充
 
   CALL aglq710_ref_show()
 
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()  
 
   #add-point:show段之後
   {<point name="show.after"/>}
   #end add-point   
   
END FUNCTION
]]>
</section>
  <section id="aglq710.state_change" ver="1" status="" src="s">
<![CDATA[    
]]>
</section>
  <section id="aglq710.ui_browser_refresh" ver="1" status="" src="s">
<![CDATA[#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION aglq710_ui_browser_refresh()
   {<Local define>}
   DEFINE l_i  LIKE type_t.num10
   {</Local define>}
   #add-point:ui_browser_refresh段define
   {<point name="ui_browser_refresh.define"/>}
   #end add-point    
   
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_glarld = g_glar_m.glarld 
 
         THEN  
         CALL g_browser.deleteElement(l_i)
         LET g_header_cnt = g_header_cnt - 1
      END IF
   END FOR
 
   LET g_browser_cnt = g_browser_cnt - 1
   IF g_current_row > g_browser_cnt THEN        #確定browse 筆數指在同一筆
      LET g_current_row = g_browser_cnt
   END IF
 
   DISPLAY g_browser_cnt TO FORMONLY.b_count    #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數的顯示
   
END FUNCTION
]]>
</section>
  <section id="aglq710.ui_detailshow" ver="1" status="" src="s">
<![CDATA[#+ 單身資料重新顯示
PRIVATE FUNCTION aglq710_ui_detailshow()
   #add-point:ui_detailshow段define
   {<point name="ui_detailshow.define"/>}
   #end add-point    
   
   #add-point:ui_detailshow段before
   {<point name="ui_detailshow.before"/>}
   #end add-point  
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
 
      #add-point:ui_detailshow段more
      {<point name="ui_detailshow.more"/>}
      #end add-point 
   END IF
   
   #add-point:ui_detailshow段after
   {<point name="ui_detailshow.after"/>}
   #end add-point 
   
END FUNCTION
]]>
</section>
  <section id="aglq710.ui_dialog" ver="60" status="" src="s">
<![CDATA[#+ 功能選單 
PRIVATE FUNCTION aglq710_ui_dialog()
   {<Local define>}
   DEFINE li_idx   LIKE type_t.num5
   {</Local define>}
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define"/>}
   #end add-point 
 
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   CALL aglq710_query()
   
   WHILE TRUE
   
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         DISPLAY ARRAY g_glar_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_glar_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_ac
               CALL aglq710_fetch()
               #add-point:input段before row
               {<point name="input.body.before_row"/>}
               #end add-point  
            
            #自訂ACTION(detail_show,page_1)
            
               
         END DISPLAY
      
 
         
 
      
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
         
         BEFORE DIALOG      
            CALL DIALOG.setSelectionMode("s_detail1", 1)
 
            #add-point:ui_dialog段before dialog
            {<point name="ui_dialog.bef_dialog"/>}
            #end add-point
 
            NEXT FIELD sel
      
         
 
         ON ACTION datainfo
 
            LET g_action_choice="datainfo"
            IF cl_auth_chk_act("datainfo") THEN 
               #add-point:ON ACTION datainfo
               {<point name="menu.datainfo" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION exchange_ld
 
            LET g_action_choice="exchange_ld"
            IF cl_auth_chk_act("exchange_ld") THEN 
               #add-point:ON ACTION exchange_ld
               {<point name="menu.exchange_ld" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION first
 
            LET g_action_choice="first"
            IF cl_auth_chk_act("first") THEN 
               #add-point:ON ACTION first
               {<point name="menu.first" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION jump
 
            LET g_action_choice="jump"
            IF cl_auth_chk_act("jump") THEN 
               #add-point:ON ACTION jump
               {<point name="menu.jump" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION last
 
            LET g_action_choice="last"
            IF cl_auth_chk_act("last") THEN 
               #add-point:ON ACTION last
               {<point name="menu.last" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION next
 
            LET g_action_choice="next"
            IF cl_auth_chk_act("next") THEN 
               #add-point:ON ACTION next
               {<point name="menu.next" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION output
 
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN 
               #add-point:ON ACTION output
               {<point name="menu.output" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION previous
 
            LET g_action_choice="previous"
            IF cl_auth_chk_act("previous") THEN 
               #add-point:ON ACTION previous
               {<point name="menu.previous" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION query
 
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN 
               CALL aglq710_query()
               #add-point:ON ACTION query
               {<point name="menu.query" />}
               #END add-point
            END IF
 
      
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            FOR li_idx = 1 TO g_glar_d.getLength()
               LET g_glar_d[li_idx].sel = "Y"
            END FOR
 
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_glar_d.getLength()
               LET g_glar_d[li_idx].sel = "N"
            END FOR
 
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_glar_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glar_d[li_idx].sel = "Y"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_glar_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glar_d[li_idx].sel = "N"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL aglq710_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION qbeclear   # 條件清除
            CLEAR FORM
 
         ON ACTION datarefresh   # 重新整理
            LET g_error_show = 1
            CALL aglq710_b_fill()
            CALL aglq710_fetch()
 
         ON ACTION agendum   # 待辦事項
            #add-point:ON ACTION agendum
            {<point name="ui_dialog.agendum"/>}
            #END add-point
            CALL cl_user_overview()
 
         
      
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
</section>
  <section id="aglq710.ui_headershow" ver="1" status="" src="s">
<![CDATA[#+ 單頭資料重新顯示
PRIVATE FUNCTION aglq710_ui_headershow()
   #add-point:ui_headershow段define
   {<point name="ui_headershow.define"/>}
   #end add-point    
   
   LET g_glar_m.glarld = g_browser[g_current_idx].b_glarld   
 
    SELECT UNIQUE glarld,glarcomp
 INTO g_glar_m.glarld,g_glar_m.glarcomp
 FROM glar_t
 WHERE glarent = g_enterprise AND glarld = g_glar_m.glarld
   CALL aglq710_show()
   
END FUNCTION
]]>
</section>
  <section id="aglq710.unlock_b" ver="1" status="" src="s">
<![CDATA[#+ 連動unlock其他單身table資料
PRIVATE FUNCTION aglq710_unlock_b(ps_table,ps_page)
   {<Local define>}
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   {</Local define>}
   #add-point:unlock_b段define
   {<point name="unlock_b.define"/>}
   #end add-point  
   
 
 
END FUNCTION
]]>
</section>
  <section id="aglq710.update_b" ver="1" status="" src="s">
<![CDATA[#+ 修改單身後其他table連動
PRIVATE FUNCTION aglq710_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   {<Local define>}
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num5 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   {</Local define>}
   #add-point:update_b段define
   {<point name="update_b.define"/>}
   #end add-point     
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
 
   
 
   
END FUNCTION
]]>
</section>
</add_points>