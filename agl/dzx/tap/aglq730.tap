<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="aglq730" std_prog="aglq730" erpver="1.0" module="AGL" ver="6" env="s" zone="t10prd" booking="Y" type="M" identity="s" section_flag="Y" designer_ver="1.0">
  <other>
    <code_template value="Q" status="u"/>
    <free_style value="N" status="u"/>
    <start_arg value="" status="u"/>
  </other>
  <point name="construct.c.page1.b_glar001" order="0" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = "glac001 = '",g_glaa004,"' AND glac006 = '1'"
            CALL aglt310_04()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar001  #顯示到畫面上

            NEXT FIELD b_glar001                     #返回原欄位

]]>
  </point>
  <point name="input.a.page1.glarld" order="0" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.glar004" order="0" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.glar003" order="0" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.glar002" order="0" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.glar001" order="0" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="function.aglq730_create_temp_table" order="1" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 建立臨時表
# Memo...........:
# Usage..........: CALL aglq730_create_temp_table()
# Date & Author..: 2014/03/10 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_create_temp_table()
   DROP TABLE aglq730_tmp
   CREATE TEMP TABLE aglq730_tmp(
   glar001      LIKE glar_t.glar001,
   glar001_desc LIKE glacl_t.glacl004,
   amt11        LIKE glaq_t.glaq003,
   amt12        LIKE glaq_t.glaq003,
   amt13        LIKE glaq_t.glaq003,
   amt21        LIKE glaq_t.glaq003,
   amt22        LIKE glaq_t.glaq003,
   amt23        LIKE glaq_t.glaq003,
   amt31        LIKE glaq_t.glaq003,
   amt32        LIKE glaq_t.glaq003,
   amt33        LIKE glaq_t.glaq003,
   amt41        LIKE glaq_t.glaq003,
   amt42        LIKE glaq_t.glaq003,
   amt43        LIKE glaq_t.glaq003,
   amt51        LIKE glaq_t.glaq003,
   amt52        LIKE glaq_t.glaq003,
   amt53        LIKE glaq_t.glaq003,
   amt61        LIKE glaq_t.glaq003,
   amt62        LIKE glaq_t.glaq003,
   amt63        LIKE glaq_t.glaq003,
   amt71        LIKE glaq_t.glaq003,
   amt72        LIKE glaq_t.glaq003,
   amt73        LIKE glaq_t.glaq003,
   amt81        LIKE glaq_t.glaq003,
   amt82        LIKE glaq_t.glaq003,
   amt83        LIKE glaq_t.glaq003,
   amt91        LIKE glaq_t.glaq003,
   amt92        LIKE glaq_t.glaq003,
   amt93        LIKE glaq_t.glaq003,
   amt101       LIKE glaq_t.glaq003,
   amt102       LIKE glaq_t.glaq003,
   amt103       LIKE glaq_t.glaq003,
   amt111       LIKE glaq_t.glaq003,
   amt112       LIKE glaq_t.glaq003,
   amt113       LIKE glaq_t.glaq003,
   amt121       LIKE glaq_t.glaq003,
   amt122       LIKE glaq_t.glaq003,
   amt123       LIKE glaq_t.glaq003,
   amt131       LIKE glaq_t.glaq003,
   amt132       LIKE glaq_t.glaq003,
   amt133       LIKE glaq_t.glaq003,
   amt141       LIKE glaq_t.glaq003,
   amt142       LIKE glaq_t.glaq003,
   amt143       LIKE glaq_t.glaq003,
   amt151       LIKE glaq_t.glaq003,
   amt152       LIKE glaq_t.glaq003,
   amt153       LIKE glaq_t.glaq003,
   amt161       LIKE glaq_t.glaq003,
   amt162       LIKE glaq_t.glaq003,
   amt163       LIKE glaq_t.glaq003,
   amt171       LIKE glaq_t.glaq003,
   amt172       LIKE glaq_t.glaq003,
   amt173       LIKE glaq_t.glaq003,
   amt181       LIKE glaq_t.glaq003,
   amt182       LIKE glaq_t.glaq003,
   amt183       LIKE glaq_t.glaq003,
   amt191       LIKE glaq_t.glaq003,
   amt192       LIKE glaq_t.glaq003,
   amt193       LIKE glaq_t.glaq003,
   amt201       LIKE glaq_t.glaq003,
   amt202       LIKE glaq_t.glaq003,
   amt203       LIKE glaq_t.glaq003,
   amt211       LIKE glaq_t.glaq003,
   amt212       LIKE glaq_t.glaq003,
   amt213       LIKE glaq_t.glaq003,
   amt221       LIKE glaq_t.glaq003,
   amt222       LIKE glaq_t.glaq003,
   amt223       LIKE glaq_t.glaq003,
   amt231       LIKE glaq_t.glaq003,
   amt232       LIKE glaq_t.glaq003,
   amt233       LIKE glaq_t.glaq003,
   amt241       LIKE glaq_t.glaq003,
   amt242       LIKE glaq_t.glaq003,
   amt243       LIKE glaq_t.glaq003,
   amt251       LIKE glaq_t.glaq003,
   amt252       LIKE glaq_t.glaq003,
   amt253       LIKE glaq_t.glaq003,
   amt261       LIKE glaq_t.glaq003,
   amt262       LIKE glaq_t.glaq003,
   amt263       LIKE glaq_t.glaq003,
   amt271       LIKE glaq_t.glaq003,
   amt272       LIKE glaq_t.glaq003,
   amt273       LIKE glaq_t.glaq003,
   amt281       LIKE glaq_t.glaq003,
   amt282       LIKE glaq_t.glaq003,
   amt283       LIKE glaq_t.glaq003,
   amt291       LIKE glaq_t.glaq003,
   amt292       LIKE glaq_t.glaq003,
   amt293       LIKE glaq_t.glaq003,
   amt301       LIKE glaq_t.glaq003,
   amt302       LIKE glaq_t.glaq003,
   amt303       LIKE glaq_t.glaq003)
END FUNCTION]]>
  </point>
  <point name="function.aglq730_create_for_xg" order="2" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 為XG報表建立臨時表
# Memo...........:
# Usage..........: CALL aglq730_create_for_xg()
#                  RETURNING ---
# Input parameter:
# Return code....:
# Date & Author..: 2015/06/02 By 01727
# Modify.........: #130726-00001#95 Add
################################################################################
PRIVATE FUNCTION aglq730_create_for_xg()
      DROP TABLE aglq730_print_tmp;
      CREATE TEMP TABLE aglq730_print_tmp(
            glar001       LIKE glar_t.glar001,
            glar001_desc  LIKE type_t.chr500,
            amt11          LIKE type_t.num20_6,
            amt12          LIKE type_t.num20_6,
            amt13          LIKE type_t.num20_6,
            amt21          LIKE type_t.num20_6,
            amt22          LIKE type_t.num20_6,
            amt23          LIKE type_t.num20_6,
            amt31          LIKE type_t.num20_6,
            amt32          LIKE type_t.num20_6,
            amt33          LIKE type_t.num20_6,
            amt41          LIKE type_t.num20_6,
            amt42          LIKE type_t.num20_6,
            amt43          LIKE type_t.num20_6,
            amt51          LIKE type_t.num20_6,
            amt52          LIKE type_t.num20_6,
            amt53          LIKE type_t.num20_6,
            amt61          LIKE type_t.num20_6,
            amt62          LIKE type_t.num20_6,
            amt63          LIKE type_t.num20_6,
            amt71          LIKE type_t.num20_6,
            amt72          LIKE type_t.num20_6,
            amt73          LIKE type_t.num20_6,
            amt81          LIKE type_t.num20_6,
            amt82          LIKE type_t.num20_6,
            amt83          LIKE type_t.num20_6,
            amt91          LIKE type_t.num20_6,
            amt92          LIKE type_t.num20_6,
            amt93          LIKE type_t.num20_6,
            amt101         LIKE type_t.num20_6,
            amt102         LIKE type_t.num20_6,
            amt103         LIKE type_t.num20_6,
            amt111         LIKE type_t.num20_6,
            amt112         LIKE type_t.num20_6,
            amt113         LIKE type_t.num20_6,
            amt121         LIKE type_t.num20_6,
            amt122         LIKE type_t.num20_6,
            amt123         LIKE type_t.num20_6,
            amt131         LIKE type_t.num20_6,
            amt132         LIKE type_t.num20_6,
            amt133         LIKE type_t.num20_6,
            amt141         LIKE type_t.num20_6,
            amt142         LIKE type_t.num20_6,
            amt143         LIKE type_t.num20_6,
            amt151         LIKE type_t.num20_6,
            amt152         LIKE type_t.num20_6,
            amt153         LIKE type_t.num20_6,
            amt161         LIKE type_t.num20_6,
            amt162         LIKE type_t.num20_6,
            amt163         LIKE type_t.num20_6,
            amt171         LIKE type_t.num20_6,
            amt172         LIKE type_t.num20_6,
            amt173         LIKE type_t.num20_6,
            amt181         LIKE type_t.num20_6,
            amt182         LIKE type_t.num20_6,
            amt183         LIKE type_t.num20_6,
            amt191         LIKE type_t.num20_6,
            amt192         LIKE type_t.num20_6,
            amt193         LIKE type_t.num20_6,
            amt201         LIKE type_t.num20_6,
            amt202         LIKE type_t.num20_6,
            amt203         LIKE type_t.num20_6,
            amt211         LIKE type_t.num20_6,
            amt212         LIKE type_t.num20_6,
            amt213         LIKE type_t.num20_6,
            amt221         LIKE type_t.num20_6,
            amt222         LIKE type_t.num20_6,
            amt223         LIKE type_t.num20_6,
            amt231         LIKE type_t.num20_6,
            amt232         LIKE type_t.num20_6,
            amt233         LIKE type_t.num20_6,
            amt241         LIKE type_t.num20_6,
            amt242         LIKE type_t.num20_6,
            amt243         LIKE type_t.num20_6,
            amt251         LIKE type_t.num20_6,
            amt252         LIKE type_t.num20_6,
            amt253         LIKE type_t.num20_6,
            amt261         LIKE type_t.num20_6,
            amt262         LIKE type_t.num20_6,
            amt263         LIKE type_t.num20_6,
            amt271         LIKE type_t.num20_6,
            amt272         LIKE type_t.num20_6,
            amt273         LIKE type_t.num20_6,
            amt281         LIKE type_t.num20_6,
            amt282         LIKE type_t.num20_6,
            amt283         LIKE type_t.num20_6,
            amt291         LIKE type_t.num20_6,
            amt292         LIKE type_t.num20_6,
            amt293         LIKE type_t.num20_6,
            amt301         LIKE type_t.num20_6,
            amt302         LIKE type_t.num20_6,
            amt303         LIKE type_t.num20_6,
            l_glaald_desc  LIKE type_t.chr500,
            l_glaacomp_desc LIKE type_t.chr500,
            l_curr         LIKE type_t.chr500,
            l_sdate        LIKE type_t.chr500,  #起始日期
            l_edate        LIKE type_t.chr500,  #截止日期
            l_ctype        LIKE type_t.chr500,  #多本位幣
            l_fix_acc      LIKE type_t.chr500, 
            l_stype        LIKE type_t.chr500, 
            l_glac005	   LIKE glac_t.glac005,
            l_stus         LIKE type_t.chr500
          )
END FUNCTION]]>
  </point>
  <point name="function.aglq730_glaald_desc" order="3" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 獲取帳套相關資料
# Memo...........:
# Usage..........: CALL aglq730_glaald_desc(p_glaald)
# Input parameter: p_glaald   帳套
# Date & Author..: 2014/03/10 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_glaald_desc(p_glaald)
   DEFINE  p_glaald    LIKE glaa_t.glaald
   
    INITIALIZE g_ref_fields TO NULL
    LET g_ref_fields[1] = p_glaald 
    CALL ap_ref_array2(g_ref_fields,"SELECT glaal002 FROM glaal_t WHERE glaalent='"||g_enterprise||"' AND glaalld=? AND glaal001='"||g_dlang||"'","") RETURNING g_rtn_fields
    LET g_glaald_desc=g_rtn_fields[1]
    #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
   SELECT glaacomp,glaa001,glaa002,glaa003,glaa004,glaa013,
          glaa015,glaa016,glaa017,glaa018,glaa019,glaa020,
          glaa021,glaa022 
     INTO g_glaacomp,g_glaa001,g_glaa002,g_glaa003,g_glaa004,g_glaa013,
          g_glaa015,g_glaa016,g_glaa017,g_glaa018,g_glaa019,g_glaa020,
          g_glaa021,g_glaa022
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glaald 
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_glaacomp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_glaacomp_desc= g_rtn_fields[1]
   
   #本位幣二
   IF g_glaa015='Y' THEN
      CALL cl_set_comp_visible("glaa016",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa016",FALSE)
   END IF
   #本位幣三
   IF g_glaa019='Y' THEN
      CALL cl_set_comp_visible("glaa020",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa020",FALSE)
   END IF 
   #多本位幣
#   CALL cl_set_comp_visible("ctype",TRUE)
   CALL cl_set_comp_entry("ctype",TRUE)
   CASE
      WHEN g_glaa015<>'Y' AND g_glaa019<>'Y' 
#         CALL cl_set_comp_visible("ctype",FALSE)
#         LET tm.ctype=''
         CALL cl_set_comp_entry("ctype",FALSE)
         CALL cl_set_combo_scc_part('ctype','9921','0')
      WHEN g_glaa015='Y' AND g_glaa019<>'Y' 
         CALL cl_set_combo_scc_part('ctype','9921','0,1')
#         LET tm.ctype='1'
      WHEN g_glaa015<>'Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','0,2')
#         LET tm.ctype='2'  
      WHEN g_glaa015='Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','0,1,2,3')
#         LET tm.ctype='3'
   END CASE
   LET tm.ctype='0'
END FUNCTION]]>
  </point>
  <point name="function.aglq730_set_default_value" order="4" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 設置默認值
# Memo...........:
# Usage..........: CALL aglq730_set_default_value()
# Date & Author..: 2014/03/13 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_set_default_value()
   DEFINE l_flag           LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   
   CALL s_get_accdate(g_glaa003,g_today,'','')
   RETURNING l_flag,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag='N' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = l_errno
      LET g_errparam.extend = ''
      LET g_errparam.popup = FALSE
      CALL cl_err()

   END IF
   LET tm.sdate=l_pdate_s  #起始日期
   LET tm.syear=l_glav002
   LET tm.speriod=l_glav006
   LET tm.edate=l_pdate_e  #截止日期
   LET tm.eyear=l_glav002
   LET tm.eperiod=l_glav006
  
   #核算項
   LET tm.fix_acc='1'
   #餘額形態
   LET tm.stype='1'
   #統制科目
   LET tm.show_acc='N'
   #科目層級
   LET tm.glac005=99
   #單據狀態
   LET tm.stus='1'
   #含內部管理科目
   LET tm.glac009='Y'
   #含月結傳票
   LET tm.show_ce='Y'
   #含年結傳票
   LET tm.show_ye='Y'
END FUNCTION]]>
  </point>
  <point name="function.aglq730_glar001_desc" order="5" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 科目说明
# Memo...........:
# Usage..........: CALL aglq730_glar001_desc(p_glar001)
#                  RETURNING r_desc
# Input parameter: p_glar001   科目編號
# Return code....: r_desc      科目說明
# Date & Author..: 2014/03/14 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_glar001_desc(p_glar001)
   DEFINE p_glar001   LIKE glar_t.glar001
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = p_glar001
   CALL ap_ref_array2(g_ref_fields,"SELECT glacl004 FROM glacl_t WHERE glaclent='"||g_enterprise||"' AND glacl001 = '"||g_glaa004||"' AND glacl002 = ? AND glacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   RETURN  g_rtn_fields[1]
END FUNCTION]]>
  </point>
  <point name="function.aglq730_get_data" order="6" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 抓取數據
# Memo...........:
# Usage..........: CALL aglq730_get_data()
# Date & Author..: 2014/03/10 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_get_data()
   DEFINE l_pdate_s1       LIKE glav_t.glav004 #起始年度+期別對應的起始截止日期
   DEFINE l_pdate_e1       LIKE glav_t.glav004
   DEFINE l_pdate_s2       LIKE glav_t.glav004 #截止年度+期別對應的起始截止日期
   DEFINE l_pdate_e2       LIKE glav_t.glav004
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_flag           LIKE type_t.num5    #表示是否是完整期別
   DEFINE l_sql,l_sql1,l_sql2   STRING
   DEFINE l_sql3,l_sql4         STRING
   DEFINE l_sql5,l_sql6         STRING
   DEFINE l_wc                  STRING 
   DEFINE l_amt1           LIKE type_t.num20_6
   DEFINE l_amt2           LIKE type_t.num20_6
   DEFINE l_amt3           LIKE type_t.num20_6
   DEFINE l_amt4           LIKE type_t.num20_6
   DEFINE l_amt5           LIKE type_t.num20_6
   DEFINE l_amt6           LIKE type_t.num20_6
   DEFINE l_period         LIKE glap_t.glap004
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_glac008        LIKE glac_t.glac008
   DEFINE l_str,l_str1,l_str2     STRING
   DEFINE l_str3,l_str4,l_str5    STRING
   DEFINE l_i,l_j          LIKE type_t.num5
   DEFINE l_str6           STRING  #核算项类型
   DEFINE l_flag_free_acc  LIKE type_t.num5 #標示是否為自由核算項
   DEFINE l_sql_free       STRING #自由核算項類型條件組sql
   DEFINE l_glaq002        STRING
   
   #刪除臨時表中資料
   DELETE FROM aglq730_tmp
   CALL g_glar001.clear()
   CALL g_glar012.clear()
   
   CALL s_get_accdate(g_glaa003,'',tm.syear,tm.speriod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s1,l_pdate_e1,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = l_errno
      LET g_errparam.extend = ''
      LET g_errparam.popup = FALSE
      CALL cl_err()
   END IF

   CALL s_get_accdate(g_glaa003,'',tm.eyear,tm.eperiod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s2,l_pdate_e2,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = l_errno
      LET g_errparam.extend = ''
      LET g_errparam.popup = FALSE
      CALL cl_err()
   END IF

   #判斷是否是整期間查詢
   IF tm.sdate=l_pdate_s1 AND tm.edate=l_pdate_e2 THEN
      LET l_flag=TRUE
   ELSE
      LET l_flag=FALSE
   END IF
   
   LET l_wc=cl_replace_str(g_wc,'glar001','glaq002')
   LET l_sql5=cl_replace_str(g_wc,'glar001','glac002')
   #顯示統制科目否
   IF tm.show_acc<>'Y' THEN
      LET l_sql1=l_sql1," AND glac003<>'1' "
   END IF
   #科目層級
   IF NOT cl_null(tm.glac005) THEN
      LET l_sql1=l_sql1," AND glac005<=",tm.glac005
   END IF
   #含內部管理科目否
   IF tm.glac009<>'Y' THEN
      LET l_sql1=l_sql1," AND glac009<>'Y' "
   END IF
   #顯示月結CE憑證否
   IF tm.show_ce<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'CE' "
      LET l_sql3="'CE'"
   END IF
   #顯示年結YE憑證否
   IF tm.show_ye<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'YE' "
      IF NOT cl_null(l_sql3) THEN
         LET l_sql3=l_sql3,",'YE'"
      ELSE
         LET l_sql3="'YE'" 
      END IF
   END IF
   IF NOT cl_null(l_sql3) THEN
      LET l_sql3=" AND glap007 IN (",l_sql3,")"
   END IF 
   #單據狀態
   CASE
      WHEN tm.stus='1'
         LET l_sql4=l_sql4," AND glapstus='S' "
      WHEN tm.stus='2'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y') "
      WHEN tm.stus='3'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y','N') "
   END CASE
   
   #單頭所選核算項
   CALL aglq730_get_acc_filed() RETURNING l_str,l_str1,l_str2,l_str5,l_str6
   
   #判斷是否為自由核算項
   IF tm.fix_acc='15' OR tm.fix_acc='16' OR tm.fix_acc='17' OR tm.fix_acc='18' OR tm.fix_acc='19' OR
      tm.fix_acc='20' OR tm.fix_acc='21' OR tm.fix_acc='22' OR tm.fix_acc='23' OR tm.fix_acc='24' THEN
      LET l_flag_free_acc = TRUE 
   ELSE
      LET l_flag_free_acc = FALSE
   END IF
   
   #抓出所有符合條件的會計科目
   LET g_sql="SELECT DISTINCT glac002 FROM glac_t",
             " WHERE glacent=",g_enterprise,
             "   AND glac001='",g_glaa004,"' AND ",l_sql5,l_sql1,
             "   AND glac002 IN (SELECT glad001 FROM glad_t ",
             "                    WHERE gladent =",g_enterprise," AND gladld='",g_glaald,"' AND ",l_str5,
             "                   )",
             " ORDER BY glac002"
   PREPARE aglq730_glar001_pr FROM g_sql
   DECLARE aglq730_glar001_cr CURSOR FOR aglq730_glar001_pr
   #整期间且不跨年查询
   IF l_flag=TRUE AND tm.syear=tm.eyear THEN
      IF l_flag_free_acc = TRUE  THEN #自由核算項
         LET l_sql=" (SELECT DISTINCT ",l_str,",",l_str6,      #抓取核算項編號
                   "   FROM glar_t",
                   "   LEFT OUTER JOIN glad_t ON gladent=glarent AND gladld=glarld AND glad001=glar001",
                   "   LEFT OUTER JOIN glac_t ON glacent=glarent AND glac002=glar001 AND glac001='",g_glaa004,"'",
                   "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' "
      ELSE
         LET l_sql=" (SELECT DISTINCT ",l_str,    #抓取核算項編號
                   "   FROM glar_t",
                   "   LEFT OUTER JOIN glac_t ON glacent=glarent AND glac002=glar001 AND glac001='",g_glaa004,"'",
                   "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
                   "    AND ",l_str," <> ' ' "
      END IF
      
      #發生額
      IF tm.stype='1' THEN 
         LET l_sql=l_sql," AND glar002=",tm.syear,
                         " AND glar003 BETWEEN ",tm.speriod," AND ",tm.eperiod
      ELSE  #累計額
         LET l_sql=l_sql," AND glar002=",tm.syear,
                         " AND glar003<=",tm.eperiod
      END IF
      LET l_sql=l_sql,l_sql1," AND ",g_wc,")"      
      #單據狀態      
      IF tm.stus MATCHES '[23]' THEN
         LET l_sql=l_sql," UNION ALL "
         IF l_flag_free_acc = TRUE  THEN #自由核算項
            LET l_sql=l_sql,"(SELECT DISTINCT ",l_str2,",",l_str6,
                           "    FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                           "    LEFT OUTER JOIN glad_t ON gladent=glaqent AND gladld=glaqld AND glad001=glaq002",
                           "    LEFT OUTER JOIN glac_t ON glacent=glaqent AND glac002=glaq002 AND glac001='",g_glaa004,"'",
                           "   WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' "
         ELSE            
            LET l_sql=l_sql,"(SELECT DISTINCT ",l_str2,
                           "    FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                           "    LEFT OUTER JOIN glac_t ON glacent=glaqent AND glac002=glaq002 AND glac001='",g_glaa004,"'",
                           "   WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                           "    AND ",l_str1," <> ' ' "
         END IF
         
         #發生額
         IF tm.stype='1' THEN 
            LET l_sql=l_sql,"    AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
         ELSE  #累計額
            LET l_sql=l_sql,"    AND glapdocdt <='",tm.edate,"' AND glap002>=",tm.syear
         END IF
         CASE
             WHEN tm.stus='2'
                LET l_sql=l_sql," AND glapstus='Y'"
             WHEN tm.stus='3'
                LET l_sql=l_sql," AND glapstus IN ('Y','N')"
         END CASE
         LET l_sql=l_sql,l_sql1,l_sql2," AND ",l_wc," )"
      END IF
      
      #抓取核算項編號
      IF l_flag_free_acc = TRUE  THEN #自由核算項
         #10個自由核算項
         LET l_sql="SELECT DISTINCT ",l_str,",",l_str6,
                   "  FROM (",l_sql,")",
                   " ORDER BY ",l_str6,",",l_str
      ELSE
         #14個固定核算項
         LET l_sql="SELECT DISTINCT ",l_str,
                   "  FROM (",l_sql,")",
                   " ORDER BY ",l_str
      END IF
   ELSE
      IF l_flag_free_acc = TRUE  THEN #自由核算項
         LET l_sql="SELECT DISTINCT ",l_str1,",",l_str6,
                   "  FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                   "  LEFT OUTER JOIN glad_t ON gladent=glaqent AND gladld=glaqld AND glad001=glaq002",
                   "  LEFT OUTER JOIN glac_t ON glacent=glaqent AND glac002=glaq002 AND glac001='",g_glaa004,"'",
                   " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' "
      ELSE
         LET l_sql="SELECT DISTINCT ",l_str1,
                   "  FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                   "  LEFT OUTER JOIN glac_t ON glacent=glaqent AND glac002=glaq002 AND glac001='",g_glaa004,"'",
                   " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                   "   AND ",l_str1," <> ' '"
      END IF
      
      #發生額
      IF tm.stype='1' THEN
         LET l_sql=l_sql,"   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
      ELSE  #累計額
         LET l_sql=l_sql,"   AND glapdocdt <='",tm.edate,"' AND glap002>=",tm.syear
      END IF
      LET l_sql=l_sql,l_sql1,l_sql2,l_sql4," AND ",l_wc," ORDER BY ",l_str1          
   END IF
   
   PREPARE aglq730_acc_pr FROM l_sql
   DECLARE aglq730_acc_cr CURSOR FOR aglq730_acc_pr   
   
   CALL cl_err_collect_init()
   LET l_success = TRUE
   
   #科目編號
   LET l_i=1
   FOREACH aglq730_glar001_cr INTO g_glar001[l_i]
      IF SQLCA.sqlcode THEN
#         CALL cl_errmsg('','FOREACH aglq730_glar001_cr','',SQLCA.sqlcode,1)
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = 'FOREACH aglq730_glar001_cr'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      LET l_i=l_i+1
   END FOREACH
   LET l_i=l_i-1
   CALL g_glar001.deleteElement(g_glar001.getLength())
   IF l_i=0 THEN RETURN END IF
   
   #核算項編號
   LET l_j=1
   FOREACH aglq730_acc_cr INTO g_glar012[l_j].glar012,g_glar012[l_j].glad0171
      IF SQLCA.sqlcode THEN
#         CALL cl_errmsg('','FOREACH aglq730_acc_cr','',SQLCA.sqlcode,1)
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = 'FOREACH aglq730_acc_cr'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      LET l_j=l_j+1
      IF l_j>30 THEN
         EXIT FOREACH
      END IF
   END FOREACH
   LET l_j=l_j-1
   LET g_col=l_j
   CALL g_glar012.deleteElement(g_glar012.getLength())
   IF g_col=0 THEN RETURN END IF
   
   IF l_flag_free_acc = TRUE  THEN #自由核算項
      LET l_sql_free=" (SELECT DISTINCT glad001 FROM glad_t ",
                     "   WHERE gladent=",g_enterprise," AND gladld='",g_glaald,"' ",
                     "     AND ",l_str5,
                     "     AND ",l_str6," = ? )"
   END IF
   
   #發生額
   #整期間(借-貸)且狀態選擇1：已過帳，且没有跨年查询时
   LET l_sql="SELECT SUM(glar005-glar006),SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
             " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
             "   AND glar002=",tm.syear,
             "   AND glar003 BETWEEN ",tm.speriod," AND ",tm.eperiod," AND glar003<>0 ",
             "   AND glar001=? AND ",l_str,"=? "
   IF l_flag_free_acc = TRUE  THEN #自由核算項
      LET l_sql=l_sql," AND glar001 IN ",l_sql_free
   END IF
   PREPARE aglq730_sel_pr1 FROM l_sql
  
   #累計額
   #整期間(借-貸)且狀態選擇1：已過帳,且没有跨年查询时
   LET l_sql="SELECT SUM(glar005-glar006),SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
             " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
             "   AND glar001=? AND ",l_str,"=? ",
             "   AND glar002=",tm.syear,
             "   AND glar003<=",tm.eperiod," AND glar003<>0 "
   IF l_flag_free_acc = TRUE  THEN #自由核算項
      LET l_sql=l_sql," AND glar001 IN ",l_sql_free
   END IF
   PREPARE aglq730_sel_pr3 FROM l_sql

   
   #年初數
   LET l_sql="SELECT SUM(glar005-glar006),SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
             " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
             "   AND glar001=? AND ",l_str,"=? ",
             "   AND glar002=? AND glar003<=?"
   IF l_flag_free_acc = TRUE  THEN #自由核算項
      LET l_sql=l_sql," AND glar001 IN ",l_sql_free
   END IF
   PREPARE aglq730_sel_pr5 FROM l_sql
   
   FOR l_i=1 TO g_glar001.getLength()
      SELECT glac008 INTO l_glac008 FROM glac_t
       WHERE glacent=g_enterprise AND glac001=g_glaa004 AND glac002=g_glar001[l_i]
       
      LET l_str3="glar001"
      LET l_str4="'",g_glar001[l_i],"'"
      
      #抓取科目对应的明细科目或者独立科目
      CALL s_voucher_get_glac_str(g_glaa004,g_glar001[l_i]) RETURNING l_glaq002
      #当该统治科目没有下层明细科目时，抓取该科目本身资料
      IF cl_null(l_glaq002) THEN
         LET l_glaq002 = "'",g_glar001[l_i],"'"
      END IF
      LET l_glaq002 = " AND glaq002 IN (",l_glaq002,")"
      
      FOR l_j=1 TO g_col
         #發生額
         IF tm.stype='1' THEN
            LET l_amt1 = 0
            LET l_amt2 = 0
            LET l_amt3 = 0
            IF l_flag=TRUE AND tm.syear=tm.eyear AND tm.stus='1' THEN
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  EXECUTE aglq730_sel_pr1 USING g_glar001[l_i],g_glar012[l_j].glar012,g_glar012[l_j].glad0171
                                           INTO l_amt1,l_amt2,l_amt3
               ELSE
                  EXECUTE aglq730_sel_pr1 USING g_glar001[l_i],g_glar012[l_j].glar012
                                           INTO l_amt1,l_amt2,l_amt3
               END IF
               IF SQLCA.sqlcode THEN
#                  CALL cl_errmsg('','aglq730_sel_pr1','',SQLCA.sqlcode,1)
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = 'aglq730_sel_pr1'
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               #當不包含CE或YE憑證時，減去CE或YE傳票金額
               IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
                  #發生額：抓取CE、YE憑證金額
                  LET l_sql="SELECT SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                             "  FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                             " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                             "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'",
                             l_glaq002," AND ",l_str1,"=? ",
                             l_sql3,l_sql4
                  IF l_flag_free_acc = TRUE  THEN #自由核算項
                     LET l_sql=l_sql," AND glaq002 IN ",l_sql_free
                  END IF
                  PREPARE aglq730_sel_pr6 FROM l_sql 
                  
                  LET l_amt4 = 0
                  LET l_amt5 = 0
                  LET l_amt6 = 0
                  IF l_flag_free_acc = TRUE  THEN #自由核算項
                     EXECUTE aglq730_sel_pr6 USING g_glar012[l_j].glar012,g_glar012[l_j].glad0171
                                              INTO l_amt4,l_amt5,l_amt6
                  ELSE
                     EXECUTE aglq730_sel_pr6 USING g_glar012[l_j].glar012
                                              INTO l_amt4,l_amt5,l_amt6
                  END IF
                  IF SQLCA.sqlcode THEN
#                     CALL cl_errmsg('','aglq730_sel_pr6','',SQLCA.sqlcode,1)
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = 'aglq730_sel_pr6'
                     LET g_errparam.code   = SQLCA.sqlcode
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
                  IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
                  LET l_amt1=l_amt1-l_amt4
                  LET l_amt2=l_amt2-l_amt5
                  LET l_amt3=l_amt3-l_amt6
               END IF
            ELSE
               #發生額
               #破期或狀態選擇2:含已審核或3：全部時發生額(借-貸)
               LET l_sql="SELECT SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                          "  FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                          " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                          "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'",
                          l_glaq002," AND ",l_str1,"=? ",
                          l_sql2,l_sql4
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  LET l_sql=l_sql," AND glaq002 IN ",l_sql_free
               END IF
               PREPARE aglq730_sel_pr2 FROM l_sql 
               
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  EXECUTE aglq730_sel_pr2 USING g_glar012[l_j].glar012,g_glar012[l_j].glad0171
                                           INTO l_amt1,l_amt2,l_amt3
               ELSE
                  EXECUTE aglq730_sel_pr2 USING g_glar012[l_j].glar012
                                           INTO l_amt1,l_amt2,l_amt3
               END IF
               IF SQLCA.sqlcode THEN
#                  CALL cl_errmsg('','aglq730_sel_pr2','',SQLCA.sqlcode,1)
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = 'aglq730_sel_pr2'
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            END IF
            
         ELSE
            #累計額
            LET l_amt1 = 0
            LET l_amt2 = 0
            LET l_amt3 = 0
            LET l_amt4 = 0
            LET l_amt5 = 0
            LET l_amt6 = 0
            #整期且狀態=1：已過帳
            IF tm.edate=l_pdate_e2 AND tm.syear=tm.eyear AND tm.stus='1' THEN
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  EXECUTE aglq730_sel_pr3 USING g_glar001[l_i],g_glar012[l_j].glar012,g_glar012[l_j].glad0171
                                           INTO l_amt1,l_amt2,l_amt3
               ELSE
                  EXECUTE aglq730_sel_pr3 USING g_glar001[l_i],g_glar012[l_j].glar012
                                           INTO l_amt1,l_amt2,l_amt3
               END IF
               IF SQLCA.sqlcode THEN
#                  CALL cl_errmsg('','aglq730_sel_pr3','',SQLCA.sqlcode,1)
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = 'aglq730_sel_pr3'
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               #當不包含CE或YE憑證時，減去CE或YE傳票金額
               IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
                  #累計額：抓取CE、YE憑證金額
                  LET l_sql="SELECT SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                            "  FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                            " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                            "   AND glapdocdt <= ? AND glap002>=? ",
                            l_glaq002," AND ",l_str1,"=? ",
                            l_sql3,l_sql4
                  IF l_flag_free_acc = TRUE  THEN #自由核算項
                     LET l_sql=l_sql," AND glaq002 IN ",l_sql_free
                  END IF
                  PREPARE aglq730_sel_pr7 FROM l_sql
                  
                  IF l_flag_free_acc = TRUE  THEN #自由核算項
                     EXECUTE aglq730_sel_pr7 USING tm.edate,tm.syear,g_glar012[l_j].glar012,g_glar012[l_j].glad0171
                                           INTO l_amt4,l_amt5,l_amt6
                  ELSE
                     EXECUTE aglq730_sel_pr7 USING tm.edate,tm.syear,g_glar012[l_j].glar012
                                           INTO l_amt4,l_amt5,l_amt6
                  END IF
                  IF SQLCA.sqlcode THEN
#                     CALL cl_errmsg('','aglq730_sel_pr7','',SQLCA.sqlcode,1)
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = 'aglq730_sel_pr7'
                     LET g_errparam.code   = SQLCA.sqlcode
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_success = FALSE
                  END IF 
                  IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
                  IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
                  LET l_amt1=l_amt1-l_amt4
                  LET l_amt2=l_amt2-l_amt5
                  LET l_amt3=l_amt3-l_amt6 
               END IF
            ELSE
               #累計額
               #破期或狀態選擇2:含已審核或3：全部時累計額(借-貸)
               LET l_sql="SELECT SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                         "  FROM glaq_t INNER JOIN glap_t ON glapent=glaqent AND glapld = glaqld AND glapdocno = glaqdocno ",
                         " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                         "   AND glapdocdt <= ? AND glap002>=? ",
                         l_glaq002," AND ",l_str1,"=? ",
                         l_sql2,l_sql4
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  LET l_sql=l_sql," AND glaq002 IN ",l_sql_free
               END IF
               PREPARE aglq730_sel_pr4 FROM l_sql
               
               #破期或者狀態-2：含已審核或3：全部
               LET l_period=0
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  EXECUTE aglq730_sel_pr5 USING g_glar001[l_i],g_glar012[l_j].glar012,tm.eyear,l_period,g_glar012[l_j].glad0171
                                           INTO l_amt1,l_amt2,l_amt3
               ELSE
                  EXECUTE aglq730_sel_pr5 USING g_glar001[l_i],g_glar012[l_j].glar012,tm.eyear,l_period
                                           INTO l_amt1,l_amt2,l_amt3
               END IF
               IF SQLCA.sqlcode THEN
#                  CALL cl_errmsg('','aglq730_sel_pr5','',SQLCA.sqlcode,1)
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = 'aglq730_sel_pr5'
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET l_success = FALSE
               END IF
               IF l_flag_free_acc = TRUE  THEN #自由核算項
                  EXECUTE aglq730_sel_pr4 USING tm.edate,tm.syear,g_glar012[l_j].glar012,g_glar012[l_j].glad0171
                                           INTO l_amt4,l_amt5,l_amt6
               ELSE
                  EXECUTE aglq730_sel_pr4 USING tm.edate,tm.syear,g_glar012[l_j].glar012
                                           INTO l_amt4,l_amt5,l_amt6
               END IF
               IF SQLCA.sqlcode THEN
#                  CALL cl_errmsg('','aglq730_sel_pr4','',SQLCA.sqlcode,1)
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = 'aglq730_sel_pr4'
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET l_success = FALSE
               END IF 
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
               LET l_amt1=l_amt1+l_amt4
               LET l_amt2=l_amt2+l_amt5
               LET l_amt3=l_amt3+l_amt6    
            END IF               
         END IF
         
         IF l_glac008='2' THEN
            LET l_amt1=(-1)*l_amt1
            LET l_amt2=(-1)*l_amt2
            LET l_amt3=(-1)*l_amt3
         END IF
         
         LET l_str3=l_str3,",amt",l_j USING '<<<',"1",
                           ",amt",l_j USING '<<<',"2",
                           ",amt",l_j USING '<<<',"3"
         LET l_str4=l_str4,",",l_amt1,",",l_amt2,",",l_amt3
      END FOR
       
      LET g_sql="INSERT INTO aglq730_tmp (",l_str3,")",
                " VALUES (",l_str4,")"
      PREPARE aglq730_ins_tmp FROM g_sql
      EXECUTE aglq730_ins_tmp
      IF SQLCA.sqlcode THEN
#         CALL cl_errmsg('','ins aglq730_tmp','',SQLCA.sqlcode,1)
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = 'ins aglq730_tmp'
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET l_success = FALSE
      END IF
   END FOR
   
   IF l_success = FALSE THEN
      CALL cl_err_collect_show()
      DELETE FROM aglq730_tmp
   ELSE
      CALL cl_err_collect_init()
      CALL cl_err_collect_show()
   END IF
END FUNCTION]]>
  </point>
  <point name="function.aglq730_get_acc_filed" order="7" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 獲取核算項對應的字段名
# Memo...........:
# Usage..........: CALL aglq730_get_acc_filed()
#                  RETURNING r_str,r_str1
# Return code....: r_str     glar_t表中對應核算項字段名
#                : r_str1    glaq_t表中對應核算項字段名
# Date & Author..: 2014/3/27 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_get_acc_filed()
   DEFINE r_str,r_str1,r_str2,r_str3,r_str4  STRING
   
   LET r_str4="''"
   CASE
      WHEN tm.fix_acc='1' 
         LET r_str="glar012"
         LET r_str1="glaq017"
         LET r_str2="glaq017 glar012"
         LET r_str3=" 1=1"
      WHEN tm.fix_acc='2' 
         LET r_str="glar013"
         LET r_str1="glaq018" 
         LET r_str2="glaq018 glar013" 
         LET r_str3=" glad007='Y' "         
      WHEN tm.fix_acc='3' 
         LET r_str="glar014"
         LET r_str1="glaq019"
         LET r_str2="glaq019 glar014"
         LET r_str3=" glad008='Y' "
      WHEN tm.fix_acc='4' 
         LET r_str="glar015"
         LET r_str1="glaq020"
         LET r_str2="glaq020 glar015"
         LET r_str3=" glad009='Y' "
      WHEN tm.fix_acc='5' 
         LET r_str="glar016"
         LET r_str1="glaq021"
         LET r_str2="glaq021 glar016"
         LET r_str3=" glad010='Y' "
      WHEN tm.fix_acc='6' 
         LET r_str="glar017"
         LET r_str1="glaq022" 
         LET r_str2="glaq022 glar017" 
         LET r_str3=" glad027='Y' "
      WHEN tm.fix_acc='7' 
         LET r_str="glar018"
         LET r_str1="glaq023"
         LET r_str2="glaq023 glar018"
         LET r_str3=" glad011='Y' "
      WHEN tm.fix_acc='8' 
         LET r_str="glar019"
         LET r_str1="glaq024"
         LET r_str2="glaq024 glar019"
         LET r_str3=" glad012='Y' "
      #經營方式
      WHEN tm.fix_acc='9' 
         LET r_str="glar051"
         LET r_str1="glaq051"
         LET r_str2="glaq051 glar051"
         LET r_str3=" glad031='Y' "
      #渠道
      WHEN tm.fix_acc='10' 
         LET r_str="glar052"
         LET r_str1="glaq052"
         LET r_str2="glaq052 glar052"
         LET r_str3=" glad032='Y' "
      #品牌
      WHEN tm.fix_acc='11' 
         LET r_str="glar053"
         LET r_str1="glaq053"
         LET r_str2="glaq053 glar053"
         LET r_str3=" glad033='Y' "
      WHEN tm.fix_acc='12' 
         LET r_str="glar020"
         LET r_str1="glaq025"
         LET r_str2="glaq025 glar020"
         LET r_str3=" glad013='Y' "
#      WHEN tm.fix_acc='10' 
#         LET r_str="glar021"
#         LET r_str1="glaq026"
#         LET r_str2="glaq026 glar021"
      WHEN tm.fix_acc='13' 
         LET r_str="glar022"
         LET r_str1="glaq027"
         LET r_str2="glaq027 glar022"
         LET r_str3=" glad015='Y' "
      WHEN tm.fix_acc='14' 
         LET r_str="glar023"
         LET r_str1="glaq028" 
         LET r_str2="glaq028 glar023"
         LET r_str3=" glad016='Y' "
      WHEN tm.fix_acc='15' 
         LET r_str="glar024"
         LET r_str1="glaq029" 
         LET r_str2="glaq029 glar024"
         LET r_str3=" glad017='Y' "
         LET r_str4="glad0171"
      WHEN tm.fix_acc='16' 
         LET r_str="glar025"
         LET r_str1="glaq030" 
         LET r_str2="glaq030 glar025"
         LET r_str3=" glad018='Y' "
         LET r_str4="glad0181"
      WHEN tm.fix_acc='17' 
         LET r_str="glar026"
         LET r_str1="glaq031" 
         LET r_str2="glaq031 glar026"
         LET r_str3=" glad019='Y' "
         LET r_str4="glad0191"
      WHEN tm.fix_acc='18' 
         LET r_str="glar027"
         LET r_str1="glaq032" 
         LET r_str2="glaq032 glar027"
         LET r_str3=" glad020='Y' "
         LET r_str4="glad0201"
      WHEN tm.fix_acc='19' 
         LET r_str="glar028"
         LET r_str1="glaq033" 
         LET r_str2="glaq033 glar028"
         LET r_str3=" glad021='Y' "
         LET r_str4="glad0211"
      WHEN tm.fix_acc='20' 
         LET r_str="glar029"
         LET r_str1="glaq034" 
         LET r_str2="glaq034 glar029"
         LET r_str3=" glad022='Y' "
         LET r_str4="glad0221"
      WHEN tm.fix_acc='21' 
         LET r_str="glar030"
         LET r_str1="glaq035" 
         LET r_str2="glaq035 glar030"
         LET r_str3=" glad023='Y' "
         LET r_str4="glad0231"
      WHEN tm.fix_acc='22' 
         LET r_str="glar031"
         LET r_str1="glaq036" 
         LET r_str2="glaq036 glar031"
         LET r_str3=" glad024='Y' "
         LET r_str4="glad0241"
      WHEN tm.fix_acc='23' 
         LET r_str="glar032"
         LET r_str1="glaq037" 
         LET r_str2="glaq037 glar032"
         LET r_str3=" glad025='Y' "
         LET r_str4="glad0251"
      WHEN tm.fix_acc='24' 
         LET r_str="glar033"
         LET r_str1="glaq038" 
         LET r_str2="glaq038 glar033"
         LET r_str3=" glad026='Y' "
         LET r_str4="glad0261"
   END CASE
   RETURN r_str,r_str1,r_str2,r_str3,r_str4
END FUNCTION]]>
  </point>
  <point name="function.aglq730_show" order="8" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 显示资料
# Memo...........:
# Usage..........: CALL aglq730_show()
# Date & Author..:  2014/03/18 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_show()
   DEFINE l_i   LIKE type_t.num5
   DEFINE l_str STRING
   
   DISPLAY g_glaald,g_glaald_desc,g_glaacomp,g_glaacomp_desc,g_glaa001,g_glaa016,g_glaa020,
           tm.sdate,tm.syear,tm.speriod,tm.edate,tm.eyear,tm.eperiod,tm.ctype,tm.fix_acc,tm.stype,
           tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye
        TO glaald,glaald_desc,glaacomp,glaacomp_desc,glaa001,glaa016,glaa020,
           sdate,syear,speriod,edate,eyear,eperiod,ctype,fix_acc,stype,
           show_acc,glac005,stus,glac009,show_ce,show_ye
   #隱藏單身中核算項欄位
   FOR l_i=1 TO g_col
       LET l_str="amt",l_i USING '<<<',"1,",
                 "amt",l_i USING '<<<',"2,",
                 "amt",l_i USING '<<<',"3"
       CALL cl_set_comp_visible(l_str,FALSE)
   END FOR

END FUNCTION]]>
  </point>
  <point name="function.aglq730_acc_name" order="9" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 獲取核算項說明并顯示在單身欄位說明
# Memo...........:
# Usage..........: CALL aglq730_acc_name()
# Date & Author..: 2014/3/27 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_acc_name()
   DEFINE l_i       LIKE type_t.num5
   DEFINE l_j       LIKE type_t.num5
   DEFINE l_str     STRING
   DEFINE l_str1    STRING
   DEFINE l_str2    STRING
   DEFINE l_str3    STRING
   DEFINE l_str4    STRING
   
   LET l_str3=cl_getmsg("axr-00092",g_lang)
   LET l_str3=l_str3.subString(2,l_str3.getLength()) #(本位幣二)
   LET l_str4=cl_getmsg("axr-00093",g_lang)
   LET l_str4=l_str4.subString(2,l_str4.getLength()) #(本位幣三)
   
   LET l_j = 3
   FOR l_i=1 TO g_glar012.getLength()
      #核算項說明
      CALL aglq730_fix_acc_desc(g_glar012[l_i].glar012,g_glar012[l_i].glad0171) RETURNING l_str
      IF cl_null(l_str) THEN
         LET l_str="  "
      END IF
      #本位幣一
      LET l_str1="amt",l_i USING '<<<',"1"
      CALL cl_set_comp_att_text(l_str1,l_str)
     #LET g_xg_fieldname[l_i + 2] = l_str    #130726-00001#95 Add
      LET g_xg_fieldname[l_j] = l_str    #yangtt---15/6/10
      LET l_j = l_j + 1                  #yangtt---15/6/10
       
      #本位幣二
      LET l_str1="amt",l_i USING '<<<',"2"
      LET l_str2=l_str,l_str3 
      CALL cl_set_comp_att_text(l_str1,l_str2) 
     #LET g_xg_fieldname[l_i + 3] = l_str2   #130726-00001#95 Add
      LET g_xg_fieldname[l_j] = l_str2   #yangtt---15/6/10
      LET l_j = l_j + 1                  #yangtt---15/6/10
      
      #本位幣三
      LET l_str1="amt",l_i USING '<<<',"3"
      LET l_str2=l_str,l_str4 
      CALL cl_set_comp_att_text(l_str1,l_str2)      
     #LET g_xg_fieldname[l_i + 4] = l_str3   #130726-00001#95 Add
      LET g_xg_fieldname[l_j] = l_str2   #yangtt---15/6/10
      LET l_j = l_j + 1                  #yangtt---15/6/10
   END FOR
END FUNCTION]]>
  </point>
  <point name="function.aglq730_set_acc_visible" order="10" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 設置單身核算項欄位顯示
# Memo...........:
# Usage..........: CALL aglq730_set_acc_visible()
# Date & Author..: 2014/3/27 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_set_acc_visible()
   DEFINE l_i       LIKE type_t.num5
   DEFINE l_str     STRING
   DEFINE l_str1    STRING
   DEFINE l_str2    STRING
   
   #核算項顯示列數
   FOR l_i=1 TO g_col
       IF l_i=1 THEN
          LET l_str="amt",l_i USING '<<<',"1"
          LET l_str1="amt",l_i USING '<<<',"2"
          LET l_str2="amt",l_i USING '<<<',"3"
       ELSE
          LET l_str=l_str,",amt",l_i USING '<<<',"1"
          LET l_str1=l_str1,",amt",l_i USING '<<<',"2"
          LET l_str2=l_str2,",amt",l_i USING '<<<',"3"
       END IF
   END FOR
   CALL cl_set_comp_visible(l_str,TRUE)
   #本位幣二
   IF tm.ctype='1' OR tm.ctype='3' THEN
      CALL cl_set_comp_visible(l_str1,TRUE)
   ELSE
      CALL cl_set_comp_visible(l_str1,FALSE)
   END IF
   #本位幣三
   IF tm.ctype='2' OR tm.ctype='3' THEN
      CALL cl_set_comp_visible(l_str2,TRUE)
   ELSE
      CALL cl_set_comp_visible(l_str2,FALSE)
   END IF
   #核算項隱藏列數
   FOR l_i=g_col+1 TO 30
       LET l_str="amt",l_i USING '<<<',"1,",
                 "amt",l_i USING '<<<',"2,",
                 "amt",l_i USING '<<<',"3"
       CALL cl_set_comp_visible(l_str,FALSE)
   END FOR
END FUNCTION]]>
  </point>
  <point name="function.aglq730_fix_acc_desc" order="11" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 獲取核算項說明
# Memo...........:
# Usage..........: CALL aglq730_fix_acc_desc(p_acc,p_glad0171)
#                  RETURNING r_desc
# Input parameter: p_acc     核算項編號
#                : p_glad0171核算項類型
# Return code....: r_desc    說明
# Date & Author..: 2014/3/27 By 02599
# Modify.........: 加核算項類型
################################################################################
PRIVATE FUNCTION aglq730_fix_acc_desc(p_acc,p_glad0171)
   DEFINE p_acc          LIKE type_t.chr30
   DEFINE p_glad0171     LIKE glad_t.glad0171
   DEFINE l_ooag011      LIKE ooag_t.ooag011
   DEFINE r_desc         STRING
   
   LET r_desc=''
   CASE tm.fix_acc
      #營運據點
      WHEN '1'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] =p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]
      
      #部門
      WHEN '2'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] =p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]

      #成本中心
      WHEN '3'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] =p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]

      #區域
      WHEN '4'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = '287'
         LET g_ref_fields[2] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1] 
      
      #交易客戶
      WHEN '5'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]
      
      #帳款客戶
      WHEN '6'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]
      
      #客群   
      WHEN '7'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = '281'
         LET g_ref_fields[2] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1] 
      
      #產品類別
      WHEN '8'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT rtaxl003 FROM rtaxl_t WHERE rtaxlent='"||g_enterprise||"' AND rtaxl001=? AND rtaxl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]
         
      #經營方式
      WHEN '9'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = '6013'
         LET g_ref_fields[2] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT gzcbl004 FROM gzcbl_t WHERE gzcbl001=? AND gzcbl002=? AND gzcbl003='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]
      
      #渠道
      WHEN '10'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT oojdl004 FROM oojdl_t WHERE oojdlent='"||g_enterprise||"' AND oojdl001=? AND oojdl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1]
       
      #品牌   
      WHEN '11'
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = '2002'
         LET g_ref_fields[2] = p_acc
         CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET r_desc=g_rtn_fields[1] 
         
      #人員編號
      WHEN '12'
         SELECT ooag011 INTO l_ooag011 FROM ooag_t 
          WHERE ooagent = g_enterprise AND ooag001 = p_acc
         LET r_desc=l_ooag011 
#      #預算編號
#      WHEN '10'
#         INITIALIZE g_ref_fields TO NULL
#         LET g_ref_fields[1] = p_acc
#         CALL ap_ref_array2(g_ref_fields,"SELECT bgaal003 FROM bgaal_t WHERE bgaalent='"||g_enterprise||"' AND bgaal001=? AND bgaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
#         LET r_desc=g_rtn_fields[1]  
      #专案   
      WHEN '13'
         CALL s_desc_get_project_desc(p_acc) RETURNING r_desc
      #WBS
      WHEN '14'
         CALL s_desc_get_wbs_desc('',p_acc) RETURNING r_desc
   END CASE
   #自由核算項
   IF tm.fix_acc='15' OR tm.fix_acc='16' OR tm.fix_acc='17' OR tm.fix_acc='18' OR tm.fix_acc='19' OR
      tm.fix_acc='20' OR tm.fix_acc='21' OR tm.fix_acc='22' OR tm.fix_acc='23' OR tm.fix_acc='24' THEN
      CALL s_voucher_free_account_desc(p_glad0171,p_acc) RETURNING r_desc
   END IF
   RETURN r_desc
END FUNCTION]]>
  </point>
  <point name="function.aglq730_b_fill1" order="12" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 單身填充
# Memo...........:
# Usage..........: CALL aglq730_b_fill1()
# Date & Author..: 2014/3/27 By 02599
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq730_b_fill1()
   
   LET g_sql = "SELECT UNIQUE glar001,'',",
               "       amt11,amt12,amt13,    amt21,amt22,amt23,    amt31,amt32,amt33,    amt41,amt42,amt43,    amt51,amt52,amt53,",
               "       amt61,amt62,amt63,    amt71,amt72,amt73,    amt81,amt82,amt83,    amt91,amt92,amt93,    amt101,amt102,amt103,",
               "       amt111,amt112,amt113, amt121,amt122,amt123, amt131,amt132,amt133, amt141,amt142,amt143, amt151,amt152,amt153,",
               "       amt161,amt162,amt163, amt171,amt172,amt173, amt181,amt182,amt183, amt191,amt192,amt193, amt201,amt202,amt203,",
               "       amt211,amt212,amt213, amt221,amt222,amt223, amt231,amt232,amt233, amt241,amt242,amt243, amt251,amt252,amt253,",
               "       amt261,amt262,amt263, amt271,amt272,amt273, amt281,amt282,amt283, amt291,amt292,amt293, amt301,amt302,amt303",
               "  FROM aglq730_tmp ORDER BY glar001 "

   PREPARE aglq730_pb1 FROM g_sql
   DECLARE b_fill_curs1 CURSOR FOR aglq730_pb1
   
   CALL g_glar_d.clear()
 
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs1 INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,g_glar_d[l_ac].amt11, 
       g_glar_d[l_ac].amt12,g_glar_d[l_ac].amt13,g_glar_d[l_ac].amt21,g_glar_d[l_ac].amt22,g_glar_d[l_ac].amt23, 
       g_glar_d[l_ac].amt31,g_glar_d[l_ac].amt32,g_glar_d[l_ac].amt33,g_glar_d[l_ac].amt41,g_glar_d[l_ac].amt42, 
       g_glar_d[l_ac].amt43,g_glar_d[l_ac].amt51,g_glar_d[l_ac].amt52,g_glar_d[l_ac].amt53,g_glar_d[l_ac].amt61, 
       g_glar_d[l_ac].amt62,g_glar_d[l_ac].amt63,g_glar_d[l_ac].amt71,g_glar_d[l_ac].amt72,g_glar_d[l_ac].amt73, 
       g_glar_d[l_ac].amt81,g_glar_d[l_ac].amt82,g_glar_d[l_ac].amt83,g_glar_d[l_ac].amt91,g_glar_d[l_ac].amt92, 
       g_glar_d[l_ac].amt93,g_glar_d[l_ac].amt101,g_glar_d[l_ac].amt102,g_glar_d[l_ac].amt103,g_glar_d[l_ac].amt111, 
       g_glar_d[l_ac].amt112,g_glar_d[l_ac].amt113,g_glar_d[l_ac].amt121,g_glar_d[l_ac].amt122,g_glar_d[l_ac].amt123, 
       g_glar_d[l_ac].amt131,g_glar_d[l_ac].amt132,g_glar_d[l_ac].amt133,g_glar_d[l_ac].amt141,g_glar_d[l_ac].amt142, 
       g_glar_d[l_ac].amt143,g_glar_d[l_ac].amt151,g_glar_d[l_ac].amt152,g_glar_d[l_ac].amt153,g_glar_d[l_ac].amt161, 
       g_glar_d[l_ac].amt162,g_glar_d[l_ac].amt163,g_glar_d[l_ac].amt171,g_glar_d[l_ac].amt172,g_glar_d[l_ac].amt173, 
       g_glar_d[l_ac].amt181,g_glar_d[l_ac].amt182,g_glar_d[l_ac].amt183,g_glar_d[l_ac].amt191,g_glar_d[l_ac].amt192, 
       g_glar_d[l_ac].amt193,g_glar_d[l_ac].amt201,g_glar_d[l_ac].amt202,g_glar_d[l_ac].amt203,g_glar_d[l_ac].amt211, 
       g_glar_d[l_ac].amt212,g_glar_d[l_ac].amt213,g_glar_d[l_ac].amt221,g_glar_d[l_ac].amt222,g_glar_d[l_ac].amt223, 
       g_glar_d[l_ac].amt231,g_glar_d[l_ac].amt232,g_glar_d[l_ac].amt233,g_glar_d[l_ac].amt241,g_glar_d[l_ac].amt242, 
       g_glar_d[l_ac].amt243,g_glar_d[l_ac].amt251,g_glar_d[l_ac].amt252,g_glar_d[l_ac].amt253,g_glar_d[l_ac].amt261, 
       g_glar_d[l_ac].amt262,g_glar_d[l_ac].amt263,g_glar_d[l_ac].amt271,g_glar_d[l_ac].amt272,g_glar_d[l_ac].amt273, 
       g_glar_d[l_ac].amt281,g_glar_d[l_ac].amt282,g_glar_d[l_ac].amt283,g_glar_d[l_ac].amt291,g_glar_d[l_ac].amt292, 
       g_glar_d[l_ac].amt293,g_glar_d[l_ac].amt301,g_glar_d[l_ac].amt302,g_glar_d[l_ac].amt303
     
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      #科目說明
      CALL aglq730_glar001_desc(g_glar_d[l_ac].glar001) RETURNING g_glar_d[l_ac].glar001_desc
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code =  9035
            LET g_errparam.extend =  ""
            LET g_errparam.popup = TRUE
            CALL cl_err()

         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   CALL g_glar_d.deleteElement(g_glar_d.getLength())
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET g_cnt = 0
   LET l_ac = 1
   DISPLAY g_detail_idx TO FORMONLY.h_index
   CALL aglq730_filter_show('glar001','b_glar001')
END FUNCTION]]>
  </point>
  <point name="function.aglq730_xg" order="13" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 列印XG報表
# Memo...........:
# Usage..........: CALL aglq730_xg()
#                  RETURNING ---
# Input parameter:
# Return code....:
# Date & Author..: 2015/06/02 By 07727
# Modify.........: #130726-00001#95 Add
################################################################################
PRIVATE FUNCTION aglq730_xg()
   DEFINE l_success      LIKE type_t.num5
   DEFINE l_i            LIKE type_t.num5
   DEFINE l_title        LIKE type_t.chr200
   DEFINE l_n            LIKE type_t.num5
   DEFINE l_glaald_desc  LIKE type_t.chr500
   DEFINE l_glaacomp_desc LIKE type_t.chr500
   DEFINE l_curr         LIKE type_t.chr500
   DEFINE l_sdate        LIKE type_t.chr500  #起始日期
   DEFINE l_edate        LIKE type_t.chr500  #截止日期
   DEFINE l_ctype        LIKE type_t.chr500  #多本位幣
   DEFINE l_fix_acc      LIKE type_t.chr500 
   DEFINE l_stype        LIKE type_t.chr500
   DEFINE l_stus         LIKE type_t.chr500

   CALL aglq730_create_for_xg()
   DELETE FROM aglq730_print_tmp
   
   LET l_glaald_desc = g_glaald,"   ",g_glaald_desc
   LET l_glaacomp_desc = g_glaacomp,"    ",g_glaacomp_desc
   LET l_curr = g_glaa001,"  ",g_glaa016,"   ",g_glaa020
   LET l_sdate = tm.sdate,"  ",tm.syear," ",tm.speriod
   LET l_edate = tm.edate,"  ",tm.eyear," ",tm.eperiod
   LET l_ctype = tm.ctype,":",s_desc_gzcbl004_desc('9921',tm.ctype)
   LET l_fix_acc = tm.fix_acc,":",s_desc_gzcbl004_desc('9934',tm.fix_acc) 
   LET l_stype = tm.stype,":",s_desc_gzcbl004_desc('9925',tm.stype)
   LET l_stus = tm.stus,":",s_desc_gzcbl004_desc('9922',tm.stus)
   FOR l_i = 1 TO g_glar_d.getLength()
      INSERT INTO aglq730_print_tmp(glar001,glar001_desc,
                  amt11,amt12,amt13,amt21,amt22,amt23,amt31,amt32,amt33,
                  amt41,amt42,amt43,amt51,amt52,amt53,amt61,amt62,amt63,
                  amt71,amt72,amt73,amt81,amt82,amt83,amt91,amt92,amt93,
                  amt101,amt102,amt103,amt111,amt112,amt113,amt121,amt122,amt123,
                  amt131,amt132,amt133,amt141,amt142,amt143,amt151,amt152,amt153,
                  amt161,amt162,amt163,amt171,amt172,amt173,amt181,amt182,amt183,
                  amt191,amt192,amt193,amt201,amt202,amt203,amt211,amt212,amt213,
                  amt221,amt222,amt223,amt231,amt232,amt233,amt241,amt242,amt243,
                  amt251,amt252,amt253,amt261,amt262,amt263,amt271,amt272,amt273,
                  amt281,amt282,amt283,amt291,amt292,amt293,amt301,amt302,amt303,
                  l_glaald_desc,l_glaacomp_desc,l_curr,l_sdate,l_edate,l_ctype,l_fix_acc,l_stype,l_glac005,l_stus)
         VALUES(g_glar_d[l_i].glar001,g_glar_d[l_i].glar001_desc,
                  g_glar_d[l_i].amt11,g_glar_d[l_i].amt12,g_glar_d[l_i].amt13,g_glar_d[l_i].amt21,g_glar_d[l_i].amt22,g_glar_d[l_i].amt23,g_glar_d[l_i].amt31,g_glar_d[l_i].amt32,g_glar_d[l_i].amt33,
                  g_glar_d[l_i].amt41,g_glar_d[l_i].amt42,g_glar_d[l_i].amt43,g_glar_d[l_i].amt51,g_glar_d[l_i].amt52,g_glar_d[l_i].amt53,g_glar_d[l_i].amt61,g_glar_d[l_i].amt62,g_glar_d[l_i].amt63,
                  g_glar_d[l_i].amt71,g_glar_d[l_i].amt72,g_glar_d[l_i].amt73,g_glar_d[l_i].amt81,g_glar_d[l_i].amt82,g_glar_d[l_i].amt83,g_glar_d[l_i].amt91,g_glar_d[l_i].amt92,g_glar_d[l_i].amt93,
                  g_glar_d[l_i].amt101,g_glar_d[l_i].amt102,g_glar_d[l_i].amt103,g_glar_d[l_i].amt111,g_glar_d[l_i].amt112,g_glar_d[l_i].amt113,g_glar_d[l_i].amt121,g_glar_d[l_i].amt122,g_glar_d[l_i].amt123,
                  g_glar_d[l_i].amt131,g_glar_d[l_i].amt132,g_glar_d[l_i].amt133,g_glar_d[l_i].amt141,g_glar_d[l_i].amt142,g_glar_d[l_i].amt143,g_glar_d[l_i].amt151,g_glar_d[l_i].amt152,g_glar_d[l_i].amt153,
                  g_glar_d[l_i].amt161,g_glar_d[l_i].amt162,g_glar_d[l_i].amt163,g_glar_d[l_i].amt171,g_glar_d[l_i].amt172,g_glar_d[l_i].amt173,g_glar_d[l_i].amt181,g_glar_d[l_i].amt182,g_glar_d[l_i].amt183,
                  g_glar_d[l_i].amt191,g_glar_d[l_i].amt192,g_glar_d[l_i].amt193,g_glar_d[l_i].amt201,g_glar_d[l_i].amt202,g_glar_d[l_i].amt203,g_glar_d[l_i].amt211,g_glar_d[l_i].amt212,g_glar_d[l_i].amt213,
                  g_glar_d[l_i].amt221,g_glar_d[l_i].amt222,g_glar_d[l_i].amt223,g_glar_d[l_i].amt231,g_glar_d[l_i].amt232,g_glar_d[l_i].amt233,g_glar_d[l_i].amt241,g_glar_d[l_i].amt242,g_glar_d[l_i].amt243,
                  g_glar_d[l_i].amt251,g_glar_d[l_i].amt252,g_glar_d[l_i].amt253,g_glar_d[l_i].amt261,g_glar_d[l_i].amt262,g_glar_d[l_i].amt263,g_glar_d[l_i].amt271,g_glar_d[l_i].amt272,g_glar_d[l_i].amt273,
                  g_glar_d[l_i].amt281,g_glar_d[l_i].amt282,g_glar_d[l_i].amt283,g_glar_d[l_i].amt291,g_glar_d[l_i].amt292,g_glar_d[l_i].amt293,g_glar_d[l_i].amt301,g_glar_d[l_i].amt302,g_glar_d[l_i].amt303,
                  l_glaald_desc,l_glaacomp_desc,l_curr,l_sdate,l_edate,l_ctype,l_fix_acc,l_stype,tm.glac005,l_stus)
   END FOR

   SELECT COUNT(*) INTO l_n FROM aglq730_print_tmp
   DISPLAY "aglq730:",l_n
   DISPLAY "SQLCA:",SQLCA.sqlerrd[2]
   CALL aglq730_x01(" 1=1","aglq730_print_tmp",g_col,tm.ctype)

   
END FUNCTION]]>
  </point>
  <point name="b_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="b_fill.fill" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      ]]>
  </point>
  <point name="b_fill.sql_after" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   ]]>
  </point>
  <point name="b_fill.sql_before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   RETURN]]>
  </point>
  <point name="construct.c.page1.glar001" order="" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL aglt310_04()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar001  #顯示到畫面上
            NEXT FIELD glar001                     #返回原欄位
    

]]>
  </point>
  <point name="cs.after_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   IF l_flag=TRUE THEN
      CALL aglq730_get_data()
      SELECT COUNT(*) INTO l_cnt FROM aglq730_tmp
      IF l_cnt=0 THEN 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = -100
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN
      END IF
      CALL aglq730_acc_name()
      CALL aglq730_set_acc_visible()
   END IF
   CALL aglq730_b_fill1()]]>
  </point>
  <point name="detail_show.body.reference" order="" ver="1" cite_std="" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_glar_d[l_ac].glar001
            CALL ap_ref_array2(g_ref_fields,"SELECT glacl004 FROM glacl_t WHERE glaclent='"||g_enterprise||"' AND glacl002=? AND glacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_glar_d[l_ac].glar001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_glar_d[l_ac].glar001_desc
]]>
  </point>
  <point name="fetch.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="global.inc" order="" ver="6" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[GLOBALS "../../cfg/top_report.inc"   #130726-00001#95 Add]]>
  </point>
  <point name="global.memo" order="" ver="6" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[#130726-00001#95 2015/06/02 增加列印功能]]>
  </point>
  <point name="global.variable" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#依据当前账别，抓取账别所归属的法人，使用币别，汇率参照表号，会计科目参照表号
DEFINE g_bookno        LIKE glap_t.glapld
DEFINE g_glaald        LIKE glaa_t.glaald
DEFINE g_glaald_desc   LIKE glaal_t.glaal002
DEFINE g_glaacomp      LIKE glaa_t.glaacomp
DEFINE g_glaacomp_desc LIKE ooefl_t.ooefl003
DEFINE g_glaa001       LIKE glaa_t.glaa001
DEFINE g_glaa002       LIKE glaa_t.glaa002
DEFINE g_glaa003       LIKE glaa_t.glaa003
DEFINE g_glaa004       LIKE glaa_t.glaa004
DEFINE g_glaa013       LIKE glaa_t.glaa013
DEFINE g_glaa015       LIKE glaa_t.glaa015
DEFINE g_glaa016       LIKE glaa_t.glaa016
DEFINE g_glaa017       LIKE glaa_t.glaa017
DEFINE g_glaa018       LIKE glaa_t.glaa018
DEFINE g_glaa019       LIKE glaa_t.glaa019
DEFINE g_glaa020       LIKE glaa_t.glaa020
DEFINE g_glaa021       LIKE glaa_t.glaa021
DEFINE g_glaa022       LIKE glaa_t.glaa022
#查询条件定义
DEFINE tm              RECORD
       sdate           LIKE glap_t.glapdocdt,  #起始日期
       syear           LIKE glap_t.glap002,    #起始年度
       speriod         LIKE glap_t.glap004,    #起始期別
       edate           LIKE glap_t.glapdocdt,  #截止日期
       eyear           LIKE glap_t.glap002,    #截止年度
       eperiod         LIKE glap_t.glap004,    #截止期別
       ctype           LIKE type_t.chr1,       #多本位幣
       fix_acc         LIKE type_t.chr2, 
       stype           LIKE type_t.chr1, 
       show_acc        LIKE type_t.chr1, 
       glac005	       LIKE glac_t.glac005,
       stus            LIKE type_t.chr1,
       glac009	       LIKE glac_t.glac009,
       show_ce         LIKE type_t.chr1,
       show_ye         LIKE type_t.chr1
       END RECORD
DEFINE g_wc1           STRING
DEFINE g_glar009       LIKE glar_t.glar009
DEFINE g_glar001       DYNAMIC ARRAY OF VARCHAR(24)  #科目編號
DEFINE g_glar012       DYNAMIC ARRAY OF RECORD  #核算項
       glar012         LIKE type_t.chr30,
       glad0171        LIKE glad_t.glad0171
       END RECORD
DEFINE g_col           LIKE type_t.num5]]>
  </point>
  <point name="init.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success   LIKE type_t.num5
   DEFINE l_pass      LIKE type_t.num5]]>
  </point>
  <point name="init.init" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   LET g_detail_idx  = 1
   CALL cl_set_combo_scc('stus','9922')
   CALL cl_set_combo_scc('fix_acc','9934')
   CALL cl_set_combo_scc('stype','9925')
   #获取账别
   IF cl_null(g_glaald) THEN
      CALL s_ld_bookno()  RETURNING l_success,g_glaald
      IF l_success = FALSE THEN
         RETURN 
      END IF 
      CALL s_ld_chk_authorization(g_user,g_glaald) RETURNING l_pass
      IF l_pass = FALSE THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'agl-00164'
         LET g_errparam.extend = g_glaald
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN
      END IF
   END IF      
   CALL aglq730_glaald_desc(g_glaald)
   CALL aglq730_set_default_value()
   LET g_col=0
   CALL aglq730_set_acc_visible()
   #建立临时表
   CALL aglq730_create_temp_table()]]>
  </point>
  <point name="main.exit" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DROP TABLE aglq730_tmp]]>
  </point>
  <point name="menu.exchange_ld" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               CALL aglt310_01(g_glaald) RETURNING g_bookno
               IF g_glaald <> g_bookno THEN
                  CLEAR FORM
                  CALL g_glar_d.clear()
               END IF
               LET g_glaald = g_bookno
               #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
               CALL aglq730_glaald_desc(g_glaald)
               CALL aglq730_show()
                IF cl_null(g_wc) THEN
                   LET g_wc = '1=1'
                END IF ]]>
  </point>
  <point name="menu.output" order="" ver="6" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[               CALL aglq730_xg()   ##130726-00001#95 Add]]>
  </point>
  <point name="menu.query" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)]]>
  </point>
  <point name="query.define" order="" ver="5" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_flag           LIKE type_t.num5
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_cnt            LIKE type_t.num5
   
   #建立临时表
   CALL aglq730_create_temp_table()
   LET l_flag=TRUE]]>
  </point>
  <point name="query.more_construct" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      INPUT BY NAME tm.sdate,tm.edate,tm.ctype,tm.fix_acc,tm.stype,
                    tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye
         ATTRIBUTE(WITHOUT DEFAULTS)
         BEFORE INPUT
         
         AFTER FIELD sdate
            IF NOT cl_null(tm.sdate) THEN
               CALL s_get_accdate(g_glaa003,tm.sdate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = l_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = FALSE
                  CALL cl_err()

                  NEXT FIELD sdate
               END IF
               IF NOT cl_null(tm.edate) THEN
                  IF tm.sdate>tm.edate THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'agl-00116'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = FALSE
                     CALL cl_err()

                     NEXT FIELD sdate
                  END IF
               END IF
               LET tm.syear=l_glav002
               LET tm.speriod=l_glav006
               DISPLAY tm.syear,tm.speriod TO syear,speriod 
            END IF
         AFTER FIELD edate
            IF NOT cl_null(tm.edate) THEN
               CALL s_get_accdate(g_glaa003,tm.edate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = l_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = FALSE
                  CALL cl_err()

                  NEXT FIELD edate
               END IF
               IF NOT cl_null(tm.sdate) THEN
                  IF tm.sdate>tm.edate THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'agl-00117'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = FALSE
                     CALL cl_err()

                     NEXT FIELD edate
                  END IF
               END IF
               LET tm.eyear=l_glav002
               LET tm.eperiod=l_glav006
               DISPLAY tm.eyear,tm.eperiod TO eyear,eperiod 
            END IF
         ON CHANGE ctype
            IF tm.ctype NOT MATCHES '[0123]' THEN
               NEXT FIELD ctype
            END IF
         AFTER FIELD stype
            IF tm.stype NOT MATCHES '[12]' THEN
               NEXT FIELD stype
            END IF
            
         AFTER FIELD show_acc
            IF tm.show_acc NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_acc
            END IF
         
         AFTER FIELD glac005
            IF NOT cl_ap_chk_Range(tm.glac005,"1","1","99","1","azz-00087",1) THEN
               NEXT FIELD glac005
            END IF
         
         AFTER FIELD stus
            IF tm.stus NOT MATCHES '[123]' THEN
               NEXT FIELD stus
            END IF
            
         AFTER FIELD glac009
            IF tm.glac009 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glac009
            END IF
            
         AFTER FIELD show_ce
            IF tm.show_ce NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ce
            END IF
         
         AFTER FIELD show_ye
            IF tm.show_ye NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ye
            END IF
         
      END INPUT
      
      BEFORE DIALOG
        #預設
        CALL aglq730_show()
        
      ON ACTION qbeclear   # 條件清除
         CLEAR FORM
         #預設
         CALL aglq730_show()
         CALL aglq730_glaald_desc(g_glaald)
         CALL aglq730_set_default_value()
         LET g_col=0
         CALL aglq730_set_acc_visible()]]>
  </point>
  <point name="ui_dialog.bef_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)]]>
  </point>
  <section id="aglq730.b_fill" ver="13" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION aglq730_b_fill()
   {<Local define>}
   DEFINE ls_wc           STRING
   {</Local define>}
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
   
   IF cl_null(g_wc_filter) THEN
      LET g_wc_filter = " 1=1"
   END IF
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   
   LET ls_wc = g_wc, " AND ", g_wc2, " AND ", g_wc_filter
   
   LET g_sql = "SELECT  UNIQUE glar001,'','','','','','','','','','','','','','','','','','','','','', 
       '','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','', 
       '','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','', 
       '','','','','','','','' FROM glar_t",
 
 
               "",
               " WHERE glarent= ? AND 1=1 AND ", ls_wc
    
   LET g_sql = g_sql, " ORDER BY glar_t.glarld,glar_t.glar001,glar_t.glar002,glar_t.glar003,glar_t.glar004"
  
   #add-point:b_fill段sql_after
   {<point name="b_fill.sql_after"/>}
   #end add-point
  
   PREPARE aglq730_pb FROM g_sql
   DECLARE b_fill_curs CURSOR FOR aglq730_pb
   
   OPEN b_fill_curs USING g_enterprise
 
   CALL g_glar_d.clear()
 
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,g_glar_d[l_ac].amt11, 
       g_glar_d[l_ac].amt12,g_glar_d[l_ac].amt13,g_glar_d[l_ac].amt21,g_glar_d[l_ac].amt22,g_glar_d[l_ac].amt23, 
       g_glar_d[l_ac].amt31,g_glar_d[l_ac].amt32,g_glar_d[l_ac].amt33,g_glar_d[l_ac].amt41,g_glar_d[l_ac].amt42, 
       g_glar_d[l_ac].amt43,g_glar_d[l_ac].amt51,g_glar_d[l_ac].amt52,g_glar_d[l_ac].amt53,g_glar_d[l_ac].amt61, 
       g_glar_d[l_ac].amt62,g_glar_d[l_ac].amt63,g_glar_d[l_ac].amt71,g_glar_d[l_ac].amt72,g_glar_d[l_ac].amt73, 
       g_glar_d[l_ac].amt81,g_glar_d[l_ac].amt82,g_glar_d[l_ac].amt83,g_glar_d[l_ac].amt91,g_glar_d[l_ac].amt92, 
       g_glar_d[l_ac].amt93,g_glar_d[l_ac].amt101,g_glar_d[l_ac].amt102,g_glar_d[l_ac].amt103,g_glar_d[l_ac].amt111, 
       g_glar_d[l_ac].amt112,g_glar_d[l_ac].amt113,g_glar_d[l_ac].amt121,g_glar_d[l_ac].amt122,g_glar_d[l_ac].amt123, 
       g_glar_d[l_ac].amt131,g_glar_d[l_ac].amt132,g_glar_d[l_ac].amt133,g_glar_d[l_ac].amt141,g_glar_d[l_ac].amt142, 
       g_glar_d[l_ac].amt143,g_glar_d[l_ac].amt151,g_glar_d[l_ac].amt152,g_glar_d[l_ac].amt153,g_glar_d[l_ac].amt161, 
       g_glar_d[l_ac].amt162,g_glar_d[l_ac].amt163,g_glar_d[l_ac].amt171,g_glar_d[l_ac].amt172,g_glar_d[l_ac].amt173, 
       g_glar_d[l_ac].amt181,g_glar_d[l_ac].amt182,g_glar_d[l_ac].amt183,g_glar_d[l_ac].amt191,g_glar_d[l_ac].amt192, 
       g_glar_d[l_ac].amt193,g_glar_d[l_ac].amt201,g_glar_d[l_ac].amt202,g_glar_d[l_ac].amt203,g_glar_d[l_ac].amt211, 
       g_glar_d[l_ac].amt212,g_glar_d[l_ac].amt213,g_glar_d[l_ac].amt221,g_glar_d[l_ac].amt222,g_glar_d[l_ac].amt223, 
       g_glar_d[l_ac].amt231,g_glar_d[l_ac].amt232,g_glar_d[l_ac].amt233,g_glar_d[l_ac].amt241,g_glar_d[l_ac].amt242, 
       g_glar_d[l_ac].amt243,g_glar_d[l_ac].amt251,g_glar_d[l_ac].amt252,g_glar_d[l_ac].amt253,g_glar_d[l_ac].amt261, 
       g_glar_d[l_ac].amt262,g_glar_d[l_ac].amt263,g_glar_d[l_ac].amt271,g_glar_d[l_ac].amt272,g_glar_d[l_ac].amt273, 
       g_glar_d[l_ac].amt281,g_glar_d[l_ac].amt282,g_glar_d[l_ac].amt283,g_glar_d[l_ac].amt291,g_glar_d[l_ac].amt292, 
       g_glar_d[l_ac].amt293,g_glar_d[l_ac].amt301,g_glar_d[l_ac].amt302,g_glar_d[l_ac].amt303
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      
      LET g_glar_d[l_ac].sel = "N"
      #LET g_glar_d[l_ac].statepic = cl_get_actipic(g_glar_d[l_ac].statepic)
 
      
 
      #add-point:b_fill段資料填充
      {<point name="b_fill.fill"/>}
      #end add-point
      
      CALL aglq730_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code =  9035
            LET g_errparam.extend =  ""
            LET g_errparam.popup = TRUE
            CALL cl_err()

         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
 
   
   CALL g_glar_d.deleteElement(g_glar_d.getLength())   
 
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.others.fill"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE aglq730_pb
   
   LET l_ac = 1
   CALL aglq730_fetch()
   
      CALL aglq730_filter_show('glar001','b_glar001')
 
   
END FUNCTION
]]>
  </section>
  <section id="aglq730.delete" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ delete
PRIVATE FUNCTION aglq730_delete()
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point
 
   #add-point:delete段control
   {<point name="delete.control"/>}
   #end add-point 
END FUNCTION
]]>
  </section>
  <section id="aglq730.description" ver="63" status="" src="s" readonly="">
    <![CDATA[#+ Version..: T100-ERP-1.00.00(版次:1) Build-000062
#+ 
#+ Filename...: aglq730
#+ Description: 科目核算項二維查詢作業
#+ Creator....: 02599(2014/03/23)
#+ Modifier...: 02599(2014/03/26)
#+ Buildtype..: 應用 q02 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
  </section>
  <section id="aglq730.detail_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION aglq730_detail_show()
   #add-point:show段define
   {<point name="detail_show.define"/>}
   #end add-point
 
   #add-point:detail_show段之前
   {<point name="detail_show.before"/>}
   #end add-point
   
   
   
   #帶出公用欄位reference值page1
   
    
 
   
   #讀入ref值
   #add-point:show段單身reference
   {<point name="detail_show.body.reference"/>}
   #end add-point
   
 
 
   #add-point:detail_show段之後
   {<point name="detail_show.after"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="aglq730.fetch" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION aglq730_fetch()
   {<Local define>}
   DEFINE li_ac           LIKE type_t.num5
   {</Local define>}
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point
   
 
   
   LET li_ac = l_ac 
   
 
   
   #DISPLAY g_detail_cnt TO FORMONLY.cnt
 
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="aglq730.filter" ver="7" status="" src="s" readonly="">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION aglq730_filter()
   {<Local define>}
   {</Local define>}
   #add-point:filter段define
   {<point name="filter.define"/>}
   #end add-point    
   
   LET l_ac = 1
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON glar001
                          FROM s_detail1[1].b_glar001
 
         BEFORE CONSTRUCT
#saki       CALL cl_qbe_init()
                     DISPLAY aglq730_filter_parser('glar001') TO s_detail1[1].b_glar001
 
 
      END CONSTRUCT
 
      #add-point:filter段add_cs
      {<point name="filter.add_cs"/>}
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog
         {<point name="filter.b_dialog"/>}
         #end add-point  
 
      ON ACTION accept
         ACCEPT DIALOG 
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
 
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = g_wc_filter, " "
   ELSE
      LET g_wc_filter = g_wc_filter_t
   END IF
   
      CALL aglq730_filter_show('glar001','b_glar001')
 
    
   CALL aglq730_b_fill()
   CALL aglq730_fetch()
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
 
END FUNCTION
]]>
  </section>
  <section id="aglq730.filter_parser" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ filter欄位解析
PRIVATE FUNCTION aglq730_filter_parser(ps_field)
   {<Local define>}
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   {</Local define>}
   #add-point:filter段define
   {<point name="filter_parser.define"/>}
   #end add-point    
 
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
  </section>
  <section id="aglq730.filter_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION aglq730_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = aglq730_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
  </section>
  <section id="aglq730.global" ver="8" status="" src="m" readonly="">
    <![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單身 type 宣告
PRIVATE TYPE type_g_glar_d RECORD
       #statepic       LIKE type_t.chr1,
       sel            LIKE type_t.chr1,
       glar001 LIKE glar_t.glar001, 
   glar001_desc LIKE type_t.chr500, 
   amt11 LIKE glaq_t.glaq003, 
   amt12 LIKE glaq_t.glaq003, 
   amt13 LIKE glaq_t.glaq003, 
   amt21 LIKE glaq_t.glaq003, 
   amt22 LIKE glaq_t.glaq003, 
   amt23 LIKE glaq_t.glaq003, 
   amt31 LIKE glaq_t.glaq003, 
   amt32 LIKE glaq_t.glaq003, 
   amt33 LIKE glaq_t.glaq003, 
   amt41 LIKE glaq_t.glaq003, 
   amt42 LIKE glaq_t.glaq003, 
   amt43 LIKE glaq_t.glaq003, 
   amt51 LIKE glaq_t.glaq003, 
   amt52 LIKE glaq_t.glaq003, 
   amt53 LIKE glaq_t.glaq003, 
   amt61 LIKE glaq_t.glaq003, 
   amt62 LIKE glaq_t.glaq003, 
   amt63 LIKE glaq_t.glaq003, 
   amt71 LIKE glaq_t.glaq003, 
   amt72 LIKE glaq_t.glaq003, 
   amt73 LIKE glaq_t.glaq003, 
   amt81 LIKE glaq_t.glaq003, 
   amt82 LIKE glaq_t.glaq003, 
   amt83 LIKE glaq_t.glaq003, 
   amt91 LIKE glaq_t.glaq003, 
   amt92 LIKE glaq_t.glaq003, 
   amt93 LIKE glaq_t.glaq003, 
   amt101 LIKE glaq_t.glaq003, 
   amt102 LIKE glaq_t.glaq003, 
   amt103 LIKE glaq_t.glaq003, 
   amt111 LIKE glaq_t.glaq003, 
   amt112 LIKE glaq_t.glaq003, 
   amt113 LIKE glaq_t.glaq003, 
   amt121 LIKE glaq_t.glaq003, 
   amt122 LIKE glaq_t.glaq003, 
   amt123 LIKE glaq_t.glaq003, 
   amt131 LIKE glaq_t.glaq003, 
   amt132 LIKE glaq_t.glaq003, 
   amt133 LIKE glaq_t.glaq003, 
   amt141 LIKE glaq_t.glaq003, 
   amt142 LIKE glaq_t.glaq003, 
   amt143 LIKE glaq_t.glaq003, 
   amt151 LIKE glaq_t.glaq003, 
   amt152 LIKE glaq_t.glaq003, 
   amt153 LIKE glaq_t.glaq003, 
   amt161 LIKE glaq_t.glaq003, 
   amt162 LIKE glaq_t.glaq003, 
   amt163 LIKE glaq_t.glaq003, 
   amt171 LIKE glaq_t.glaq003, 
   amt172 LIKE glaq_t.glaq003, 
   amt173 LIKE glaq_t.glaq003, 
   amt181 LIKE glaq_t.glaq003, 
   amt182 LIKE glaq_t.glaq003, 
   amt183 LIKE glaq_t.glaq003, 
   amt191 LIKE glaq_t.glaq003, 
   amt192 LIKE glaq_t.glaq003, 
   amt193 LIKE glaq_t.glaq003, 
   amt201 LIKE glaq_t.glaq003, 
   amt202 LIKE glaq_t.glaq003, 
   amt203 LIKE glaq_t.glaq003, 
   amt211 LIKE glaq_t.glaq003, 
   amt212 LIKE glaq_t.glaq003, 
   amt213 LIKE glaq_t.glaq003, 
   amt221 LIKE glaq_t.glaq003, 
   amt222 LIKE glaq_t.glaq003, 
   amt223 LIKE glaq_t.glaq003, 
   amt231 LIKE glaq_t.glaq003, 
   amt232 LIKE glaq_t.glaq003, 
   amt233 LIKE glaq_t.glaq003, 
   amt241 LIKE glaq_t.glaq003, 
   amt242 LIKE glaq_t.glaq003, 
   amt243 LIKE glaq_t.glaq003, 
   amt251 LIKE glaq_t.glaq003, 
   amt252 LIKE glaq_t.glaq003, 
   amt253 LIKE glaq_t.glaq003, 
   amt261 LIKE glaq_t.glaq003, 
   amt262 LIKE glaq_t.glaq003, 
   amt263 LIKE glaq_t.glaq003, 
   amt271 LIKE glaq_t.glaq003, 
   amt272 LIKE glaq_t.glaq003, 
   amt273 LIKE glaq_t.glaq003, 
   amt281 LIKE glaq_t.glaq003, 
   amt282 LIKE glaq_t.glaq003, 
   amt283 LIKE glaq_t.glaq003, 
   amt291 LIKE glaq_t.glaq003, 
   amt292 LIKE glaq_t.glaq003, 
   amt293 LIKE glaq_t.glaq003, 
   amt301 LIKE glaq_t.glaq003, 
   amt302 LIKE glaq_t.glaq003, 
   amt303 LIKE glaq_t.glaq003 
       END RECORD
 
 
#模組變數(Module Variables)
DEFINE g_master                     type_g_glar_d
DEFINE g_master_t                   type_g_glar_d
DEFINE g_glar_d          DYNAMIC ARRAY OF type_g_glar_d
DEFINE g_glar_d_t        type_g_glar_d
 
      
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num5              
DEFINE l_ac_d               LIKE type_t.num5              #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num5              #目前所在頁數
DEFINE g_detail_cnt         LIKE type_t.num5              #單身 總筆數(所有資料)
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num5
DEFINE g_detail_idx         LIKE type_t.num5
DEFINE g_detail_idx2        LIKE type_t.num5
DEFINE g_hyper_url          STRING                        #hyperlink的主要網址
 
 
#多table用wc
DEFINE g_wc_table           STRING
 
 
 
DEFINE g_wc_filter_table           STRING
 
 
 
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="aglq730.init" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION aglq730_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
   
   
   
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="aglq730.insert" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ insert
PRIVATE FUNCTION aglq730_insert()
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point
 
   #add-point:insert段control
   {<point name="insert.control"/>}
   #end add-point    
   
END FUNCTION
]]>
  </section>
  <section id="aglq730.main" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 此段落由子樣板a26產生
#OPTIONS SHORT CIRCUIT
#+ 作業開始 
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point   
 
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("agl","")
 
   #add-point:作業初始化
   {<point name="main.init" />}
   #end add-point
   
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = ""
   #add-point:SQL_define
   {<point name="main.after_define_sql"/>}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   DECLARE aglq730_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT UNIQUE ",
               " FROM ",
               " WHERE  "
   #add-point:SQL_define
   {<point name="main.after_refresh_sql"/>}
   #end add-point
   PREPARE aglq730_master_referesh FROM g_sql
 
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
 
   ELSE
      
      #畫面開啟 (identifier)
      OPEN WINDOW w_aglq730 WITH FORM cl_ap_formpath("agl",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL aglq730_init()   
 
      #進入選單 Menu (="N")
      CALL aglq730_ui_dialog() 
      
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_aglq730
      
   END IF 
   
   CLOSE aglq730_cl
   
   
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
   
END MAIN
 
 
]]>
  </section>
  <section id="aglq730.modify" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ modify
PRIVATE FUNCTION aglq730_modify()
   #add-point:modify段define
   {<point name="modify.define"/>}
   #end add-point
 
   #add-point:modify段control
   {<point name="modify.control"/>}
   #end add-point 
END FUNCTION
]]>
  </section>
  <section id="aglq730.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[{<point name="other.function"/>}
]]>
  </section>
  <section id="aglq730.query" ver="1" status="" src="m" readonly="">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION aglq730_query()
   {<Local define>}
   DEFINE ls_wc      LIKE type_t.chr500
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   {</Local define>}
   #add-point:query段define
{<point name="query.define"/>}
   #end add-point 
   
   LET INT_FLAG = 0
   CLEAR FORM
   CALL g_glar_d.clear()
   LET g_wc_filter = " 1=1"
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
   
   LET g_qryparam.state = "c"
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   
   #wc備份
   LET ls_wc = g_wc
   LET g_master_idx = l_ac
 
   
 
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單身根據table分拆construct
      CONSTRUCT g_wc_table ON glar001
           FROM s_detail1[1].b_glar001
                      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
{<point name="cs.head.before_construct"/>}
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
       #---------------------<  Detail: page1  >---------------------
         #----<<b_glar001>>----
         #Ctrlp:construct.c.page1.b_glar001
         ON ACTION controlp INFIELD b_glar001
            #add-point:ON ACTION controlp INFIELD b_glar001
{<point name="construct.c.page1.b_glar001" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar001
            #add-point:BEFORE FIELD b_glar001
{<point name="construct.b.page1.b_glar001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar001
            
            #add-point:AFTER FIELD b_glar001
{<point name="construct.a.page1.b_glar001" />}
            #END add-point
            
 
   
       
      END CONSTRUCT
      
 
      
 
  
      #add-point:query段more_construct
{<point name="query.more_construct"/>}
      #end add-point 
      
      ON ACTION accept
         ACCEPT DIALOG
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG
      
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG 
   END DIALOG
 
   
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      #還原
      LET g_wc = ls_wc
      LET l_flag=FALSE
   ELSE
      LET g_master_idx = 1
   END IF
   
   LET g_wc = g_wc_table 
 
 
        
   LET g_wc2 = " 1=1"
 
        
   #add-point:cs段after_construct
{<point name="cs.after_construct"/>}
   #end add-point
        
   LET g_error_show = 1
   CALL aglq730_b_fill()
   LET l_ac = g_master_idx
   CALL aglq730_fetch()
#   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
#      CALL cl_err("",-100,1)
#   END IF
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
   
END FUNCTION
]]>
  </section>
  <section id="aglq730.reproduce" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ reproduce
PRIVATE FUNCTION aglq730_reproduce()
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point
 
   #add-point:reproduce段control
   {<point name="reproduce.control"/>}
   #end add-point 
END FUNCTION
]]>
  </section>
  <section id="aglq730.ui_dialog" ver="23" status="" src="m" readonly="">
    <![CDATA[#+ 功能選單 
PRIVATE FUNCTION aglq730_ui_dialog()
   {<Local define>}
   DEFINE li_idx   LIKE type_t.num5
   {</Local define>}
   #add-point:ui_dialog段define
{<point name="ui_dialog.define"/>}
   #end add-point 
 
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   #add-point:ui_dialog段before dialog 
{<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   CALL aglq730_query()
   
   WHILE TRUE
   
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         DISPLAY ARRAY g_glar_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_glar_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_ac
               CALL aglq730_fetch()
               #add-point:input段before row
{<point name="input.body.before_row"/>}
               #end add-point  
            
            #自訂ACTION(detail_show,page_1)
            
               
         END DISPLAY
      
 
         
 
      
         #add-point:ui_dialog段自定義display array
{<point name="ui_dialog.more_displayarray"/>}
         #end add-point
         
         BEFORE DIALOG      
            CALL DIALOG.setSelectionMode("s_detail1", 1)
 
            #add-point:ui_dialog段before dialog
{<point name="ui_dialog.bef_dialog"/>}
            #end add-point
 
            NEXT FIELD sel
      
         
 
         ON ACTION datainfo
 
            LET g_action_choice="datainfo"
            IF cl_auth_chk_act("datainfo") THEN 
               #add-point:ON ACTION datainfo
{<point name="menu.datainfo" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION exchange_ld
 
            LET g_action_choice="exchange_ld"
            IF cl_auth_chk_act("exchange_ld") THEN 
               #add-point:ON ACTION exchange_ld
{<point name="menu.exchange_ld" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION output
 
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN 
               #add-point:ON ACTION output
{<point name="menu.output" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION query
 
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN 
               CALL aglq730_query()
               #add-point:ON ACTION query
{<point name="menu.query" />}
               #END add-point
            END IF
 
      
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            FOR li_idx = 1 TO g_glar_d.getLength()
               LET g_glar_d[li_idx].sel = "Y"
            END FOR
 
            #add-point:ui_dialog段on action selall
{<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_glar_d.getLength()
               LET g_glar_d[li_idx].sel = "N"
            END FOR
 
            #add-point:ui_dialog段on action selnone
{<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_glar_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glar_d[li_idx].sel = "Y"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action sel
{<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_glar_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glar_d[li_idx].sel = "N"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action unsel
{<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL aglq730_filter()
            #add-point:ON ACTION filter
{<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION qbeclear   # 條件清除
            CLEAR FORM
            CALL aglq730_glaald_desc(g_glaald)
            CALL aglq730_set_default_value()
            LET g_col=0
            CALL aglq730_set_acc_visible()
            CALL aglq730_query()
            EXIT DIALOG
 
         ON ACTION datarefresh   # 重新整理
            LET g_error_show = 1
            CALL aglq730_b_fill()
            CALL aglq730_fetch()
 
         ON ACTION agendum   # 待辦事項
            #add-point:ON ACTION agendum
{<point name="ui_dialog.agendum"/>}
            #END add-point
            CALL cl_user_overview()
 
         ON ACTION exporttoexcel   #匯出excel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               CALL g_export_node.clear()
               LET g_export_node[1] = base.typeInfo.create(g_glar_d)
 
               CALL cl_export_to_excel_getpage()
               CALL cl_export_to_excel()
            END IF         
      
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
  </section>
</add_points>
