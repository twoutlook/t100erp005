<add_points prog="aglq770" std_prog="aglq770" erpver="1.0" module="AGL" ver="1" env="s" zone="t10dev" booking="Y">
  <point name="construct.c.page1.b_glaq002" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = "glac001 = '",g_glaa004,"' AND glac006 = '1'"
            CALL aglt310_04()                        #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq002  #顯示到畫面上
            NEXT FIELD b_glaq002                     #返回原欄位
]]>
</point>
  <point name="construct.c.page1.b_glaq005" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glaq017" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq017  #顯示到畫面上
            NEXT FIELD b_glaq017                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq018" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq018  #顯示到畫面上
            NEXT FIELD b_glaq018                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq019" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq019  #顯示到畫面上
            NEXT FIELD b_glaq019                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq020" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq020  #顯示到畫面上
            NEXT FIELD b_glaq020                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq021" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq021  #顯示到畫面上
            NEXT FIELD b_glaq021                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq022" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq022  #顯示到畫面上
            NEXT FIELD b_glaq022                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq023" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq023  #顯示到畫面上
            NEXT FIELD b_glaq023                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq024" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_rtax001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq024  #顯示到畫面上
            NEXT FIELD b_glaq024                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq025" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq025  #顯示到畫面上
            NEXT FIELD b_glaq025                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.b_glaq026" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_bgaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glaq026  #顯示到畫面上
            NEXT FIELD b_glaq026                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq002" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_glac002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq002  #顯示到畫面上
            NEXT FIELD glaq002                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq017" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq017  #顯示到畫面上
            NEXT FIELD glaq017                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq018" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq018  #顯示到畫面上
            NEXT FIELD glaq018                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq019" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq019  #顯示到畫面上
            NEXT FIELD glaq019                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq020" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq020  #顯示到畫面上
            NEXT FIELD glaq020                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq021" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq021  #顯示到畫面上
            NEXT FIELD glaq021                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq022" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq022  #顯示到畫面上
            NEXT FIELD glaq022                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq023" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq023  #顯示到畫面上
            NEXT FIELD glaq023                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq024" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_rtax001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq024  #顯示到畫面上
            NEXT FIELD glaq024                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq025" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq025  #顯示到畫面上
            NEXT FIELD glaq025                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glaq026" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_bgaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq026  #顯示到畫面上
            NEXT FIELD glaq026                     #返回原欄位
    

]]>
</point>
  <point name="input.a.page1.glaqdocno" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glaq_d[g_detail_idx].glaqld IS NOT NULL AND g_glaq_d[g_detail_idx].glaqdocno IS NOT NULL AND g_glaq_d[g_detail_idx].glaqseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glaq_d[g_detail_idx].glaqld != g_glaq_d_t.glaqld OR g_glaq_d[g_detail_idx].glaqdocno != g_glaq_d_t.glaqdocno OR g_glaq_d[g_detail_idx].glaqseq != g_glaq_d_t.glaqseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glaq_t WHERE "||"glaqent = '" ||g_enterprise|| "' AND "||"glaqld = '"||g_glaq_d[g_detail_idx].glaqld ||"' AND "|| "glaqdocno = '"||g_glaq_d[g_detail_idx].glaqdocno ||"' AND "|| "glaqseq = '"||g_glaq_d[g_detail_idx].glaqseq ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glaqld" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glaq_d[g_detail_idx].glaqld IS NOT NULL AND g_glaq_d[g_detail_idx].glaqdocno IS NOT NULL AND g_glaq_d[g_detail_idx].glaqseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glaq_d[g_detail_idx].glaqld != g_glaq_d_t.glaqld OR g_glaq_d[g_detail_idx].glaqdocno != g_glaq_d_t.glaqdocno OR g_glaq_d[g_detail_idx].glaqseq != g_glaq_d_t.glaqseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glaq_t WHERE "||"glaqent = '" ||g_enterprise|| "' AND "||"glaqld = '"||g_glaq_d[g_detail_idx].glaqld ||"' AND "|| "glaqdocno = '"||g_glaq_d[g_detail_idx].glaqdocno ||"' AND "|| "glaqseq = '"||g_glaq_d[g_detail_idx].glaqseq ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glaqseq" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glaq_d[g_detail_idx].glaqld IS NOT NULL AND g_glaq_d[g_detail_idx].glaqdocno IS NOT NULL AND g_glaq_d[g_detail_idx].glaqseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glaq_d[g_detail_idx].glaqld != g_glaq_d_t.glaqld OR g_glaq_d[g_detail_idx].glaqdocno != g_glaq_d_t.glaqdocno OR g_glaq_d[g_detail_idx].glaqseq != g_glaq_d_t.glaqseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glaq_t WHERE "||"glaqent = '" ||g_enterprise|| "' AND "||"glaqld = '"||g_glaq_d[g_detail_idx].glaqld ||"' AND "|| "glaqdocno = '"||g_glaq_d[g_detail_idx].glaqdocno ||"' AND "|| "glaqseq = '"||g_glaq_d[g_detail_idx].glaqseq ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="function.aglq770_create_temp_table" cite_std="N" status="" ver="1" src="s" new="Y" order="1" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 建立臨時表
# Memo...........:
# Usage..........: CALL aglq770_create_temp_table()
# Date & Author..: 2014/03/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_create_temp_table()
   DROP TABLE aglq770_tmp
   CREATE TEMP TABLE aglq770_tmp(
   seq          DECIMAL(10,0),
   glaq002      VARCHAR(24),
   glaq017      VARCHAR(10),
   glaq018      VARCHAR(10),
   glaq019      VARCHAR(10),
   glaq020      VARCHAR(10),
   glaq021      VARCHAR(10),
   glaq022      VARCHAR(10),
   glaq023      VARCHAR(10),
   glaq024      VARCHAR(10),
   glaq025      VARCHAR(10),
   glaq026      VARCHAR(10),
   glaq027      VARCHAR(10),
   glaq028      VARCHAR(30),
   glapdocdt    DATE,
   glaqdocno    VARCHAR(20),
   glap004      DECIMAL(5,0),
   style        VARCHAR(1), 
   glaq005      VARCHAR(10),
   glaq006      DECIMAL(20,10),
   glaq010d     DECIMAL(20,6),
   glaq010c     DECIMAL(20,6),
   glaq003      DECIMAL(20,6), 
   glaq004      DECIMAL(20,6), 
   glaq039      DECIMAL(20,10),
   glaq040      DECIMAL(20,6), 
   glaq041      DECIMAL(20,6),
   glaq042      DECIMAL(20,10),   
   glaq043      DECIMAL(20,6), 
   glaq044      DECIMAL(20,6), 
   state        VARCHAR(1), 
   amt          DECIMAL(20,6),
   amt1         DECIMAL(20,6),
   amt2         DECIMAL(20,6),
   amt3         DECIMAL(20,6))
END FUNCTION]]>
</point>
  <point name="function.aglq770_set_curr_show" cite_std="N" status="" ver="1" src="s" new="Y" order="2" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 設置本位幣二、別你幣三顯示否
# Memo...........:
# Usage..........: CALL aglq770_set_curr_show()
# Date & Author..: 2014/03/13 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_set_curr_show()
   #顯示本位幣二
   IF tm.ctype='1' THEN
      CALL cl_set_comp_visible("glaq039,glaq040,glaq041,amt2",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaq039,glaq040,glaq041,amt2",FALSE)
   END IF
   #顯示本位幣三
   IF tm.ctype='2' THEN
      CALL cl_set_comp_visible("glaq042,glaq043,glaq044,amt3",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaq042,glaq043,glaq044,amt3",FALSE)
   END IF
   #全部
   IF tm.ctype='3' THEN
      CALL cl_set_comp_visible("glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,amt2,amt3",TRUE)
      CALL cl_set_comp_visible("glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,amt2,amt3",TRUE)
   END IF
END FUNCTION]]>
</point>
  <point name="function.aglq770_glaald_desc" cite_std="N" status="" ver="1" src="s" new="Y" order="3" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 獲取帳套相關資料
# Memo...........:
# Usage..........: CALL aglq770_glaald_desc(p_glaald)
# Input parameter: p_glaald   帳套
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_glaald_desc(p_glaald)
   DEFINE  p_glaald    LIKE glaa_t.glaald
   
    INITIALIZE g_ref_fields TO NULL
    LET g_ref_fields[1] = p_glaald 
    CALL ap_ref_array2(g_ref_fields,"SELECT glaal002 FROM glaal_t WHERE glaalent='"||g_enterprise||"' AND glaalld=? AND glaal001='"||g_dlang||"'","") RETURNING g_rtn_fields
    LET g_glaald_desc=g_rtn_fields[1]
    #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
   SELECT glaacomp,glaa001,glaa002,glaa003,glaa004,glaa013,
          glaa015,glaa016,glaa017,glaa018,glaa019,glaa020,
          glaa021,glaa022
     INTO g_glaacomp,g_glaa001,g_glaa002,g_glaa003,g_glaa004,g_glaa013,
          g_glaa015,g_glaa016,g_glaa017,g_glaa018,g_glaa019,g_glaa020,
          g_glaa021,g_glaa022
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glaald 
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_glaacomp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_glaacomp_desc= g_rtn_fields[1]
  
   #本位幣二
   IF g_glaa015='Y' THEN
      CALL cl_set_comp_visible("glaa016",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa016",FALSE)
   END IF
   #本位幣三
   IF g_glaa019='Y' THEN
      CALL cl_set_comp_visible("glaa020",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa020",FALSE)
   END IF 
   #多本位幣
   CALL cl_set_comp_visible("ctype",TRUE)
   CASE
      WHEN g_glaa015<>'Y' AND g_glaa019<>'Y' 
         CALL cl_set_comp_visible("ctype",FALSE)
         LET tm.ctype=''
      WHEN g_glaa015='Y' AND g_glaa019<>'Y' 
         CALL cl_set_combo_scc_part('ctype','9921','1')
         LET tm.ctype='1'
      WHEN g_glaa015<>'Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','2')
         LET tm.ctype='2'  
      WHEN g_glaa015='Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','1,2,3')
         LET tm.ctype='3'
   END CASE
   CALL aglq770_set_curr_show() #顯示本位幣二、本位幣三
END FUNCTION]]>
</point>
  <point name="function.aglq770_get_data" cite_std="N" status="u" ver="1" src="s" new="Y" order="4" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 抓取數據
# Memo...........:
# Usage..........: CALL aglq770_get_data()
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_get_data()
   DEFINE l_pdate_s1       LIKE glav_t.glav004 #起始年度+期別對應的起始截止日期
   DEFINE l_pdate_e1       LIKE glav_t.glav004
   DEFINE l_pdate_s2       LIKE glav_t.glav004 #截止年度+期別對應的起始截止日期
   DEFINE l_pdate_e2       LIKE glav_t.glav004
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_flag           LIKE type_t.num5    #表示是否是完整期別
   DEFINE l_sql,l_sql1,l_sql2   STRING
   DEFINE l_sql3,l_sql4         STRING
   DEFINE l_wc,l_wc2            STRING 
   DEFINE l_glar001        LIKE glar_t.glar001
   DEFINE l_glar012        LIKE glar_t.glar012
   DEFINE l_glar013        LIKE glar_t.glar013
   DEFINE l_glar014        LIKE glar_t.glar014
   DEFINE l_glar015        LIKE glar_t.glar015
   DEFINE l_glar016        LIKE glar_t.glar016
   DEFINE l_glar017        LIKE glar_t.glar017
   DEFINE l_glar018        LIKE glar_t.glar018
   DEFINE l_glar019        LIKE glar_t.glar019
   DEFINE l_glar020        LIKE glar_t.glar020
   DEFINE l_glar021        LIKE glar_t.glar021
   DEFINE l_glar022        LIKE glar_t.glar022
   DEFINE l_glar023        LIKE glar_t.glar023
   DEFINE l_glar002        LIKE glar_t.glar002
   DEFINE l_glar003        LIKE glar_t.glar003
   DEFINE l_glar009        LIKE glar_t.glar009
   DEFINE l_glar010        LIKE glar_t.glar010
   DEFINE l_glar011        LIKE glar_t.glar011
   DEFINE l_glar005        LIKE glar_t.glar005
   DEFINE l_glar006        LIKE glar_t.glar006
   DEFINE l_glar034        LIKE glar_t.glar034
   DEFINE l_glar035        LIKE glar_t.glar035
   DEFINE l_glar036        LIKE glar_t.glar036
   DEFINE l_glar037        LIKE glar_t.glar037
   DEFINE l_state          LIKE type_t.num5
   DEFINE l_amt            LIKE type_t.num20_6 
   DEFINE l_amt1           LIKE type_t.num20_6 
   DEFINE l_amt2           LIKE type_t.num20_6 
   DEFINE l_amt3           LIKE type_t.num20_6 
   DEFINE l_sum            LIKE type_t.num20_6 
   DEFINE l_sum1           LIKE type_t.num20_6 
   DEFINE l_sum2           LIKE type_t.num20_6 
   DEFINE l_sum3           LIKE type_t.num20_6 
   DEFINE l_period         LIKE glap_t.glap004
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_seq            LIKE type_t.num10
   DEFINE l_str,l_str1,l_str2      STRING
   DEFINE l_str3,l_str4,l_str5     STRING
   DEFINE l_glapdocdt      LIKE glap_t.glapdocdt
   DEFINE l_glapdocno      LIKE glap_t.glapdocno
   DEFINE l_glaq005        LIKE glaq_t.glaq005
   DEFINE l_glaq006        LIKE glaq_t.glaq006
   DEFINE l_glaq010d       LIKE glaq_t.glaq010
   DEFINE l_glaq010c       LIKE glaq_t.glaq010
   DEFINE l_glaq003        LIKE glaq_t.glaq003
   DEFINE l_glaq004        LIKE glaq_t.glaq004
   DEFINE l_glaq039        LIKE glaq_t.glaq039
   DEFINE l_glaq040        LIKE glaq_t.glaq040
   DEFINE l_glaq041        LIKE glaq_t.glaq041
   DEFINE l_glaq042        LIKE glaq_t.glaq042
   DEFINE l_glaq043        LIKE glaq_t.glaq043
   DEFINE l_glaq044        LIKE glaq_t.glaq044
   DEFINE l_state_qc       LIKE type_t.num5
   DEFINE l_amt1_qc        LIKE type_t.num20_6 
   DEFINE l_amt2_qc        LIKE type_t.num20_6 
   DEFINE l_amt3_qc        LIKE type_t.num20_6
   DEFINE l_glav004        LIKE glav_t.glav004
   DEFINE l_glav004_m      LIKE glav_t.glav004
   DEFINE l_glav004_e      LIKE glav_t.glav004
   DEFINE l_pdate_s3       LIKE glav_t.glav004 #年度+期別對應的起始截止日期
   DEFINE l_pdate_e3       LIKE glav_t.glav004
   
   #刪除臨時表中資料
   DELETE FROM aglq770_tmp
   
   CALL s_get_accdate(g_glaa003,'',tm.syear,tm.speriod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s1,l_pdate_e1,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      CALL cl_err('',l_errno,0)
   END IF

   CALL s_get_accdate(g_glaa003,'',tm.eyear,tm.eperiod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s2,l_pdate_e2,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      CALL cl_err('',l_errno,0)
   END IF

   #判斷是否是整期間查詢
   IF tm.sdate=l_pdate_s1 AND tm.edate=l_pdate_e2 THEN
      LET l_flag=TRUE
   ELSE
      LET l_flag=FALSE
   END IF
   LET l_wc=cl_replace_str(g_wc,'glaq002','glar001')
   LET l_wc=cl_replace_str(l_wc,'glaq017','glar012')
   LET l_wc=cl_replace_str(l_wc,'glaq018','glar013')
   LET l_wc=cl_replace_str(l_wc,'glaq019','glar014')
   LET l_wc=cl_replace_str(l_wc,'glaq020','glar015')
   LET l_wc=cl_replace_str(l_wc,'glaq021','glar016')
   LET l_wc=cl_replace_str(l_wc,'glaq022','glar017')
   LET l_wc=cl_replace_str(l_wc,'glaq023','glar018')
   LET l_wc=cl_replace_str(l_wc,'glaq024','glar019')
   LET l_wc=cl_replace_str(l_wc,'glaq025','glar020')
   LET l_wc=cl_replace_str(l_wc,'glaq026','glar021')
   LET l_wc=cl_replace_str(l_wc,'glaq027','glar022')
   LET l_wc=cl_replace_str(l_wc,'glaq028','glar023')
   LET l_wc2=cl_replace_str(g_wc2,'glaq005','glar009')
   IF g_wc1<>' 1=1' AND NOT cl_null(g_wc1) THEN
      LET l_flag=FALSE
   END IF   
   
    #顯示外幣否
   IF tm.curr_o='Y' THEN
      LET l_str=",glar009"
      LET l_str1=",glaq005"
      LET l_str2=",glaq005 glar009"
   ELSE
      LET l_str=",''"
      LET l_str1=",''"
      LET l_str2=",''"
   END IF
   
   #顯示統制科目否
   IF tm.show_acc<>'Y' THEN
      LET l_sql1=l_sql1," AND glac003<>'1' "
   END IF
   #科目層級
   IF NOT cl_null(tm.glac005) THEN
      LET l_sql1=l_sql1," AND glac005<=",tm.glac005
   END IF
   #含內部管理科目否
   IF tm.glac009<>'Y' THEN
      LET l_sql1=l_sql1," AND glac009<>'Y'"
   END IF
   #顯示月結CE憑證否
   IF tm.show_ce<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'CE' "
      LET l_sql3="'CE'"
   END IF
   #顯示年結YE憑證否
   IF tm.show_ye<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'YE' "
      IF NOT cl_null(l_sql3) THEN
         LET l_sql3=l_sql3,",'YE'"
      ELSE
         LET l_sql3="'YE'" 
      END IF
   END IF
   IF NOT cl_null(l_sql3) THEN
      LET l_sql3=" AND glap007 IN (",l_sql3,")"
   END IF 
   #單據狀態
   CASE
      WHEN tm.stus='1'
         LET l_sql4=l_sql4," AND glapstus='S' "
      WHEN tm.stus='2'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y') "
      WHEN tm.stus='3'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y','N') "
   END CASE
   
   #核算項
   CALL aglq770_fix_acc_get_sql() RETURNING l_str3,l_str4,l_str5
   
   IF l_flag=TRUE AND tm.show_ce='Y' AND tm.show_ye='Y' THEN
      LET l_sql="(SELECT glar001,glar002,glar003,SUM(glar010) glar010,SUM(glar011) glar011,",
                "        SUM(glar005) glar005,SUM(glar006) glar006,SUM(glar034) glar034,",
                "        SUM(glar035) glar035,SUM(glar036) glar036,SUM(glar037) glar037",l_str,l_str3,
                "   FROM glar_t",
                "   LEFT OUTER JOIN glac_t ON glacent=glarent AND glac002=glar001 AND glac001='",g_glaa004,"'",
                "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' "
      IF tm.syear<>tm.eyear THEN
         LET l_sql=l_sql," AND ((glar002=",tm.syear," AND glar003>=",tm.speriod,") ",
                         "  OR (glar002=",tm.eyear," AND glar003<=",tm.eperiod," AND glar003<>0 )) "
      ELSE
         LET l_sql=l_sql," AND glar002=",tm.syear,
                         " AND glar003 BETWEEN ",tm.speriod," AND ",tm.eperiod
      END IF
      
      LET l_sql=l_sql,l_sql1," AND ",l_wc," AND ",l_wc2,
                " GROUP BY glar001,glar002,glar003",l_str3,l_str," )"  
      #單據狀態      
      IF tm.stus MATCHES '[23]' THEN
         LET l_sql=l_sql,
                   " UNION ALL ",
                   "(SELECT  glaq002 glar001,glap002 glar002,glap004 glar003,",
                   "        SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END) glar010,",
                   "        SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END) glar011,",
                   "        SUM(glaq003) glar005,SUM(glaq004) glar006,SUM(glaq040) glar034,",
                   "        SUM(glaq041) glar035,SUM(glaq043) glar036,SUM(glaq044) glar037 ",l_str2,l_str5,
                   "   FROM glaq_t",
                   "  INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                   "   LEFT OUTER JOIN glac_t ON glacent=glaqent AND glac002=glaq002 AND glac001='",g_glaa004,"'",
                   "  WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                   "    AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
         CASE
             WHEN tm.stus='2'
                LET l_sql=l_sql," AND glapstus='Y'"
             WHEN tm.stus='3'
                LET l_sql=l_sql," AND glapstus IN ('Y','N')"
         END CASE
                   
         LET l_sql=l_sql,l_sql1,l_sql2," AND ",g_wc," AND ",g_wc1," AND ",g_wc2,
                   " GROUP BY glaq002,glap002,glap004",l_str4,l_str1,")"
      END IF
      LET l_sql="SELECT glar001,glar002,glar003,SUM(glar010),SUM(glar011),SUM(glar005),SUM(glar006),",
                "       SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037)",l_str,l_str3,
                "  FROM (",l_sql,")",
                "  GROUP BY glar001,glar002,glar003",l_str3,l_str,
                "  ORDER BY glar001",l_str3,",glar002,glar003",l_str
   ELSE
      LET l_sql="SELECT glaq002,glap002,glap004,SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
                "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
                "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),SUM(glaq043),SUM(glaq044)",l_str1,l_str4,
                "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                "  LEFT OUTER JOIN glac_t ON glacent=glaqent AND glac002=glaq002 AND glac001='",g_glaa004,"'",
                " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
      LET l_sql=l_sql,l_sql1,l_sql2,l_sql4," AND ",g_wc," AND ",g_wc1," AND ",g_wc2,
                " GROUP BY glaq002,glap002,glap004",l_str4,l_str1,
                " ORDER BY glaq002",l_str4,",glap002,glap004",l_str1
   END IF
   PREPARE aglq770_sel_pr FROM l_sql
   DECLARE aglq770_sel_cr CURSOR FOR aglq770_sel_pr   

   CALL cl_showmsg_init()
   LET l_success = TRUE
   LET l_seq=1
   #起始年度第一天
   SELECT MIN(glav004) INTO l_glav004 FROM glav_t 
   WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=tm.syear
   #抓取上一期最後一天
   LET l_period=tm.speriod-1 #上期
   SELECT MAX(glav004) INTO l_glav004_m FROM glav_t
    WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=tm.syear AND glav006=l_period
   #获取期初截止日期
   IF tm.sdate=l_pdate_s1 THEN
      LET l_glav004_e=l_glav004_m
   ELSE
      LET l_glav004_e=tm.sdate-1
   END IF
   
   FOREACH aglq770_sel_cr INTO l_glar001,l_glar002,l_glar003,l_glar010,l_glar011,
                               l_glar005,l_glar006,l_glar034,l_glar035,l_glar036,l_glar037,l_glar009,
                               l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
                               l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022
      IF SQLCA.sqlcode THEN
         CALL cl_errmsg('','FOREACH aglq770_sel_cr','',SQLCA.sqlcode,1)
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      IF cl_null(l_glar010) THEN LET l_glar010=0 END IF
      IF cl_null(l_glar011) THEN LET l_glar011=0 END IF
      IF cl_null(l_glar005) THEN LET l_glar005=0 END IF
      IF cl_null(l_glar006) THEN LET l_glar006=0 END IF
      IF cl_null(l_glar034) THEN LET l_glar034=0 END IF
      IF cl_null(l_glar035) THEN LET l_glar035=0 END IF
      IF cl_null(l_glar036) THEN LET l_glar036=0 END IF
      IF cl_null(l_glar037) THEN LET l_glar037=0 END IF
      
      CALL aglq770_fix_acc_sql(l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
                               l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022)
      RETURNING l_str,l_str1
      
      #期初餘額、本年累計（整期）
      LET l_sql="SELECT SUM(glar005-glar006),",
                "       SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
                " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
                "   AND glar001=? AND glar002=? AND glar003<=? ",l_str
      IF tm.curr_o='Y' THEN
         LET l_sql=l_sql," AND glar009=? "
      END IF
      PREPARE aglq770_sel_pr1 FROM l_sql
      
      #期初：抓取CE、YE憑證金額
      LET l_sql="SELECT SUM(glaq003-glaq004),SUM(glaq040-glaq041),",
                "       SUM(glaq043-glaq044) ",
                "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                "   AND glaq002=? ",
                "   AND glap002=? AND glap004<=? ",l_str1,
                "   AND glapstus='S' AND ",g_wc,l_sql3
      IF tm.curr_o='Y' THEN
         LET l_sql=l_sql," AND glaq005=? "
      END IF
      PREPARE aglq770_sel_pr2 FROM l_sql
      
      #破期或狀態=2：含已審核、3：全部
      LET l_sql="SELECT SUM(glaq003-glaq004),SUM(glaq040-glaq041),",
                "       SUM(glaq043-glaq044) ",
                "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                "   AND glaq002=? ",
                "   AND glapdocdt BETWEEN ? AND ? ",l_str1,
                "   AND ",g_wc,l_sql2,l_sql4
      IF tm.curr_o='Y' THEN
         LET l_sql=l_sql," AND glaq005=? "
      END IF
      PREPARE aglq770_sel_pr3 FROM l_sql
      
      #明細傳票資料
      LET l_sql="SELECT glapdocdt,glapdocno,glaq005,glaq006,",
                "       (CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
                "       (CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
                "       glaq003,glaq004,glaq039,glaq040,glaq041,glaq042,glaq043,glaq044 ",
                "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                "   AND glaq002=? ",
                "   AND glapdocdt BETWEEN ? AND ? ",l_str1,
                "   AND ",g_wc," AND ",g_wc1," AND ",g_wc2,l_sql2,l_sql4
      IF tm.curr_o='Y' THEN
         LET l_sql=l_sql," AND glaq005=? "
      END IF          
      PREPARE aglq770_sel_pr4 FROM l_sql 
      DECLARE aglq770_sel_cs4 CURSOR FOR aglq770_sel_pr4
   
      LET l_amt1=0
      LET l_amt2=0
      LET l_amt3=0      
      LET l_sum1=0
      LET l_sum2=0
      LET l_sum3=0
      LET l_state=NULL
      #期初餘額
      #整期且狀態=1：已過帳
      IF tm.sdate=l_pdate_s1 AND tm.stus='1' THEN
         LET l_period=l_glar003-1
         IF tm.curr_o='Y' THEN
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_period,l_glar009 INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=l_glar009
         ELSE
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_period INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=NULL
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq770_sel_pr1','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
         IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
         IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
         #當不包含CE或YE憑證時，減去CE或YE傳票金額
         IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
            IF tm.curr_o='Y' THEN
               EXECUTE aglq770_sel_pr2 USING l_glar001,l_glar002,l_period,l_glar009 INTO l_sum1,l_sum2,l_sum3
            ELSE
               EXECUTE aglq770_sel_pr2 USING l_glar001,l_glar002,l_period INTO l_sum1,l_sum2,l_sum3
            END IF
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq770_sel_pr2','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_sum1) THEN LET l_sum1=0 END IF
            IF cl_null(l_sum2) THEN LET l_sum2=0 END IF
            IF cl_null(l_sum3) THEN LET l_sum3=0 END IF
            LET l_amt1=l_amt1-l_sum1
            LET l_amt2=l_amt2-l_sum2
            LET l_amt3=l_amt3-l_sum3
         END IF
      ELSE
         #年初余额
         LET l_period=0
         IF tm.curr_o='Y' THEN
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_period,l_glar009 INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=l_glar009
         ELSE
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_period INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=NULL
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq770_sel_pr1','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
         IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
         IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
         LET l_period=l_glar003-1 #上期
         IF l_period>0 THEN
            #抓取上一期最後一天
            SELECT MAX(glav004) INTO l_glav004_m FROM glav_t
             WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=l_glar002 AND glav006=l_period
            #获取期初截止日期
            IF tm.speriod<>l_glar003 THEN #當期別不等於起始期別時
               LET l_glav004_e=l_glav004_m
            ELSE
               LET l_glav004_e=tm.sdate-1
            END IF
            IF tm.curr_o='Y' THEN
               EXECUTE aglq770_sel_pr3 USING l_glar001,l_glav004,l_glav004_e,l_glar009 INTO l_sum1,l_sum2,l_sum3
            ELSE
               EXECUTE aglq770_sel_pr3 USING l_glar001,l_glav004,l_glav004_e INTO l_sum1,l_sum2,l_sum3
            END IF
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq770_sel_pr3','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_sum1) THEN LET l_sum1=0 END IF
            IF cl_null(l_sum2) THEN LET l_sum2=0 END IF
            IF cl_null(l_sum3) THEN LET l_sum3=0 END IF
            LET l_amt1=l_amt1+l_sum1
            LET l_amt2=l_amt2+l_sum2
            LET l_amt3=l_amt3+l_sum3
         END IF
      END IF
      #借貸平否
      CASE
         WHEN l_amt1>0 
            LET l_state='1'
         WHEN l_amt1<0
            LET l_state='2'
            LET l_amt1=(-1)*l_amt1
            LET l_amt2=(-1)*l_amt2
            LET l_amt3=(-1)*l_amt3
         WHEN l_amt1=0
            LET l_state='3'
      END CASE
      INSERT INTO aglq770_tmp(seq,glaq002,
                              glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,
                              glaq023,glaq024,glaq025,glaq026,glaq027,glaq028,
                              style,glaq005,state,amt1,amt2,amt3)
      VALUES(l_seq,l_glar001,
             l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
             l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022,
             '1',l_glaq005,
             l_state,l_amt1,l_amt2,l_amt3)
      IF SQLCA.sqlcode THEN
         CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
         LET l_success = FALSE
      END IF
      LET l_seq=l_seq+1
      
      #記錄期初金額及借貸狀態
      LET l_state_qc=l_state
      LET l_amt1_qc=l_amt1
      LET l_amt2_qc=l_amt2
      LET l_amt3_qc=l_amt3
      
      #抓取該期起始、截止日期
      CALL s_get_accdate(g_glaa003,'',l_glar002,l_glar003) 
      RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                l_glav006,l_pdate_s3,l_pdate_e3,l_glav007,l_wdate_s,l_wdate_e
      LET l_glav004_m=l_pdate_e3 #該期截止日期
      IF l_glar002=tm.syear AND l_glar003=tm.speriod THEN
         IF l_pdate_s3<>tm.sdate THEN
            LET l_pdate_s3=tm.sdate
         END IF
      END IF
      IF l_glar002=tm.eyear AND l_glar003=tm.eperiod THEN
         IF l_pdate_e3<>tm.edate THEN
            LET l_pdate_e3=tm.edate
         END IF
      END IF
      
      IF tm.curr_o='Y' THEN
         OPEN aglq770_sel_cs4 USING l_glar001,l_pdate_s3,l_pdate_e3,l_glar009
      ELSE
         OPEN aglq770_sel_cs4 USING l_glar001,l_pdate_s3,l_pdate_e3
      END IF
      #傳票明細資料
      FOREACH aglq770_sel_cs4 INTO l_glapdocdt,l_glapdocno,l_glaq005,l_glaq006,l_glaq010d,l_glaq010c,
                                   l_glaq003,l_glaq004,l_glaq039,l_glaq040,l_glaq041,
                                   l_glaq042,l_glaq043,l_glaq044
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','FOREACH aglq770_sel_cs4','',SQLCA.sqlcode,1)
            LET l_success = FALSE
            EXIT FOREACH
         END IF
         IF cl_null(l_glaq010d) THEN LET l_glaq010d=0 END IF
         IF cl_null(l_glaq010c) THEN LET l_glaq010c=0 END IF
         IF cl_null(l_glaq003) THEN LET l_glaq003=0 END IF
         IF cl_null(l_glaq004) THEN LET l_glaq004=0 END IF
         IF cl_null(l_glaq040) THEN LET l_glaq040=0 END IF
         IF cl_null(l_glaq041) THEN LET l_glaq041=0 END IF
         IF cl_null(l_glaq043) THEN LET l_glaq043=0 END IF
         IF cl_null(l_glaq044) THEN LET l_glaq044=0 END IF
         
         #餘額計算
         LET l_sum1=l_glaq003-l_glaq004
	     LET l_sum2=l_glaq040-l_glaq041
	     LET l_sum3=l_glaq043-l_glaq044
         #借餘
         IF l_state='1' THEN 
            LET l_amt1=l_sum1+l_amt1
            LET l_amt2=l_sum2+l_amt2
            LET l_amt3=l_sum3+l_amt3
         END IF
         #貸餘
         IF l_state='2' THEN 
            LET l_amt1=l_sum1-l_amt1
            LET l_amt2=l_sum2-l_amt2
            LET l_amt3=l_sum3-l_amt3
         END IF
         #平
         IF l_state='3' THEN 
            LET l_amt1=l_sum1
            LET l_amt2=l_sum2
            LET l_amt3=l_sum3
         END IF
         #借貸平否
         CASE
            WHEN l_amt1>0 
               LET l_state='1'
            WHEN l_amt1<0
               LET l_state='2'
               LET l_amt1=(-1)*l_amt1
               LET l_amt2=(-1)*l_amt2
               LET l_amt3=(-1)*l_amt3
            WHEN l_amt1=0
               LET l_state='3'
         END CASE
         #原幣餘額
         LET l_amt=l_glaq010d-l_glaq010c
         IF l_amt<0 THEN LET l_amt=(-1)*l_amt END IF
         
         INSERT INTO aglq770_tmp(seq,glaq002,
                                 glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,
                                 glaq023,glaq024,glaq025,glaq026,glaq027,glaq028,
                                 glapdocdt,glaqdocno,glaq005,glaq006,
                                 glaq010d,glaq010c,glaq003,glaq004,glaq039,glaq040,glaq041,
                                 glaq042,glaq043,glaq044,state,amt,amt1,amt2,amt3)
         VALUES(l_seq,l_glar001,
                l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
                l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022,
                l_glapdocdt,l_glapdocno,l_glaq005,l_glaq006,l_glaq010d,l_glaq010c,
                l_glaq003,l_glaq004,l_glaq039,l_glaq040,l_glaq041,l_glaq042,l_glaq043,l_glaq044,
                l_state,l_amt,l_amt1,l_amt2,l_amt3)
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         LET l_seq=l_seq+1 
      END FOREACH
      CLOSE aglq770_sel_cs4
      FREE aglq770_sel_pr4
      
      #本期合計
      LET l_sum1=l_glar005-l_glar006
	   LET l_sum2=l_glar034-l_glar035
	   LET l_sum3=l_glar036-l_glar037
	  #借餘
      IF l_state_qc='1' THEN 
         LET l_sum1=l_sum1+l_amt1_qc
         LET l_sum2=l_sum2+l_amt2_qc
         LET l_sum3=l_sum3+l_amt3_qc
      END IF
      #貸餘
      IF l_state_qc='2' THEN 
         LET l_sum1=l_sum1-l_amt1_qc
         LET l_sum2=l_sum2-l_amt2_qc
         LET l_sum3=l_sum3-l_amt3_qc
      END IF
      #借貸平否
      CASE
         WHEN l_sum1>0 
            LET l_state='1'
         WHEN l_sum1<0
            LET l_state='2'
            LET l_sum1=(-1)*l_sum1
            LET l_sum2=(-1)*l_sum2
            LET l_sum3=(-1)*l_sum3
         WHEN l_sum1=0
            LET l_state='3'
      END CASE
      IF tm.curr_o='Y' THEN
         LET l_glaq005=l_glar009
      ELSE
         LET l_glaq005=NULL
      END IF
      
      INSERT INTO aglq770_tmp(seq,glaq002,
                              glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,
                              glaq023,glaq024,glaq025,glaq026,glaq027,glaq028,
                              glap004,style,glaq005,glaq003,glaq004,glaq040,glaq041,
                              glaq043,glaq044,state,amt1,amt2,amt3)
      VALUES(l_seq,l_glar001,
             l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
             l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022,
             l_glar003,'2',l_glaq005,
             l_glar005,l_glar006,l_glar034,l_glar035,l_glar036,l_glar037,
             l_state,l_sum1,l_sum2,l_sum3)
      IF SQLCA.sqlcode THEN
         CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
         LET l_success = FALSE
      END IF
      LET l_seq=l_seq+1
      
      
      #本年累計
      #整期且狀態=1：已審核
      IF l_glav004_m=l_pdate_e3 AND tm.stus='1' THEN
         IF tm.curr_o='Y' THEN
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_glar003,l_glar009 INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=l_glar009
         ELSE
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_glar003 INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=NULL
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq770_sel_pr1','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
         IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
         IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
         #當不包含CE或YE憑證時，減去CE或YE傳票金額
         IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
            IF tm.curr_o='Y' THEN
               EXECUTE aglq770_sel_pr2 USING l_glar001,l_glar002,l_glar003,l_glar009 INTO l_sum1,l_sum2,l_sum3
            ELSE
               EXECUTE aglq770_sel_pr2 USING l_glar001,l_glar002,l_glar003 INTO l_sum1,l_sum2,l_sum3
            END IF
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq770_sel_pr2','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_sum1) THEN LET l_sum1=0 END IF
            IF cl_null(l_sum2) THEN LET l_sum2=0 END IF
            IF cl_null(l_sum3) THEN LET l_sum3=0 END IF
            LET l_amt1=l_amt1-l_sum1
            LET l_amt2=l_amt2-l_sum2
            LET l_amt3=l_amt3-l_sum3
         END IF
      ELSE
         #年初余额
         LET l_period=0
         IF tm.curr_o='Y' THEN
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_period,l_glar009 INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=l_glar009
         ELSE
            EXECUTE aglq770_sel_pr1 USING l_glar001,l_glar002,l_period INTO l_amt1,l_amt2,l_amt3
            LET l_glaq005=NULL
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq770_sel_pr1','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
         IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
         IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
         #破期抓取傳票檔資料
         IF tm.curr_o='Y' THEN
            EXECUTE aglq770_sel_pr3 USING l_glar001,l_glav004,l_pdate_e3,l_glar009 INTO l_sum1,l_sum2,l_sum3
         ELSE
            EXECUTE aglq770_sel_pr3 USING l_glar001,l_glav004,l_pdate_e3 INTO l_sum1,l_sum2,l_sum3
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq770_sel_pr3','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
         IF cl_null(l_sum1) THEN LET l_sum1=0 END IF
         IF cl_null(l_sum2) THEN LET l_sum2=0 END IF
         IF cl_null(l_sum3) THEN LET l_sum3=0 END IF
         LET l_amt1=l_amt1+l_sum1
         LET l_amt2=l_amt2+l_sum2
         LET l_amt3=l_amt3+l_sum3
      END IF
      #借貸平否
      CASE
         WHEN l_amt1>0 
            LET l_state='1'
         WHEN l_amt1<0
            LET l_state='2'
            LET l_amt1=(-1)*l_amt1
            LET l_amt2=(-1)*l_amt2
            LET l_amt3=(-1)*l_amt3
         WHEN l_amt1=0
            LET l_state='3'
      END CASE
      INSERT INTO aglq770_tmp(seq,glaq002,
                              glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,
                              glaq023,glaq024,glaq025,glaq026,glaq027,glaq028,
                              style,glaq005,state,amt1,amt2,amt3)
      VALUES(l_seq,l_glar001,
             l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
             l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022,
             '3',l_glaq005,
             l_state,l_amt1,l_amt2,l_amt3)
      IF SQLCA.sqlcode THEN
         CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
         LET l_success = FALSE
      END IF
      LET l_seq=l_seq+1
   END FOREACH
   IF l_success = FALSE THEN
      CALL cl_err_showmsg()
      DELETE FROM aglq770_tmp
   END IF
END FUNCTION]]>
</point>
  <point name="function.aglq770_show" cite_std="N" status="" ver="1" src="s" new="Y" order="5" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 显示资料
# Memo...........:
# Usage..........: CALL aglq770_show()
# Date & Author..:  2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_show()
    DISPLAY g_glaald,g_glaald_desc,g_glaacomp,g_glaacomp_desc,g_glaa001,g_glaa016,g_glaa020,
           tm.sdate,tm.syear,tm.speriod,tm.edate,tm.eyear,tm.eperiod,tm.ctype,tm.curr_o,tm.curr_p,
           tm.acc_p,tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye,
           tm.comp,tm.glad007,tm.glad008,tm.glad009,tm.glad010,tm.glad027,tm.glad011,
           tm.glad012,tm.glad013,tm.glad014,tm.glad015,tm.glad016
        TO glaald,glaald_desc,glaacomp,glaacomp_desc,glaa001,glaa016,glaa020,
           sdate,syear,speriod,edate,eyear,eperiod,ctype,curr_o,curr_p,
           acc_p,show_acc,glac005,stus,glac009,show_ce,show_ye,
           comp,glad007,glad008,glad009,glad010,glad027,glad011,
           glad012,glad013,glad014,glad015,glad016
END FUNCTION]]>
</point>
  <point name="function.aglq770_b_fill1" cite_std="N" status="" ver="1" src="s" new="Y" order="6" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 填充单身资料
# Memo...........:
# Usage..........: CALL aglq770_b_fill1()
# Date & Author..: 2014/03/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_b_fill1()
   DEFINE l_seq      LIKE type_t.num10
   DEFINE l_sql      STRING
   DEFINE l_glaq002  LIKE glaq_t.glaq002
   DEFINE l_glaq017  LIKE glaq_t.glaq017
   DEFINE l_glaq018  LIKE glaq_t.glaq018
   DEFINE l_glaq019  LIKE glaq_t.glaq019
   DEFINE l_glaq020  LIKE glaq_t.glaq020
   DEFINE l_glaq021  LIKE glaq_t.glaq021
   DEFINE l_glaq022  LIKE glaq_t.glaq022
   DEFINE l_glaq023  LIKE glaq_t.glaq023
   DEFINE l_glaq024  LIKE glaq_t.glaq024
   DEFINE l_glaq025  LIKE glaq_t.glaq025
   DEFINE l_glaq026  LIKE glaq_t.glaq026
   DEFINE l_glaq027  LIKE glaq_t.glaq027
   DEFINE l_glaq028  LIKE glaq_t.glaq028
   
   LET g_sql="SELECT UNIQUE seq,glaq002,'',glaq017,'',glaq018,'',glaq019,'',glaq020,'',glaq021,'',glaq022,'',",
             "       glaq023,'',glaq024,'',glaq025,'',glaq026,'',glaq027,glaq028,",
             "       glapdocdt,glaqdocno,glap004,style,glaq005,glaq006,glaq010d,glaq010c,glaq003,glaq004,",
             "       glaq039,glaq040,glaq041,glaq042,glaq043,glaq044,",
             "       state,amt,amt1,amt2,amt3 ",
             "  FROM aglq770_tmp "
   #是否按照外幣分頁
   IF NOT cl_null(g_glaq005) THEN
      LET l_sql=" glaq005='",g_glaq005,"'"
   END IF
   #是否按照科目分頁
   IF NOT cl_null(g_glaq002) THEN
      IF cl_null(l_sql) THEN
         LET l_sql=" glaq002='",g_glaq002,"'"
      ELSE
         LET l_sql=l_sql," AND glaq002='",g_glaq002,"'"
      END IF
   END IF
   IF NOT cl_null(l_sql) THEN
      LET g_sql=g_sql,"  WHERE ",l_sql
   END IF
   LET g_sql=g_sql," ORDER BY seq "
  
   PREPARE aglq770_pb1 FROM g_sql
   DECLARE b_fill_curs1 CURSOR FOR aglq770_pb1
   OPEN b_fill_curs1
   
   CALL g_glaq_d.clear()
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!"
   
   FOREACH b_fill_curs1 INTO l_seq,g_glaq_d[l_ac].glaq002,g_glaq_d[l_ac].glaq002_desc,g_glaq_d[l_ac].glaq017, 
       g_glaq_d[l_ac].glaq017_desc,g_glaq_d[l_ac].glaq018,g_glaq_d[l_ac].glaq018_desc,g_glaq_d[l_ac].glaq019, 
       g_glaq_d[l_ac].glaq019_desc,g_glaq_d[l_ac].glaq020,g_glaq_d[l_ac].glaq020_desc,g_glaq_d[l_ac].glaq021, 
       g_glaq_d[l_ac].glaq021_desc,g_glaq_d[l_ac].glaq022,g_glaq_d[l_ac].glaq022_desc,g_glaq_d[l_ac].glaq023, 
       g_glaq_d[l_ac].glaq023_desc,g_glaq_d[l_ac].glaq024,g_glaq_d[l_ac].glaq024_desc,g_glaq_d[l_ac].glaq025, 
       g_glaq_d[l_ac].glaq025_desc,g_glaq_d[l_ac].glaq026,g_glaq_d[l_ac].glaq026_desc,g_glaq_d[l_ac].glaq027, 
       g_glaq_d[l_ac].glaq028,g_glaq_d[l_ac].glapdocdt,g_glaq_d[l_ac].glaqdocno,g_glaq_d[l_ac].glap004,g_glaq_d[l_ac].style, 
       g_glaq_d[l_ac].glaq005,g_glaq_d[l_ac].glaq006,g_glaq_d[l_ac].glaq010d,g_glaq_d[l_ac].glaq010c, 
       g_glaq_d[l_ac].glaq003,g_glaq_d[l_ac].glaq004,g_glaq_d[l_ac].glaq039,g_glaq_d[l_ac].glaq040,g_glaq_d[l_ac].glaq041, 
       g_glaq_d[l_ac].glaq042,g_glaq_d[l_ac].glaq043,g_glaq_d[l_ac].glaq044,g_glaq_d[l_ac].state,g_glaq_d[l_ac].amt, 
       g_glaq_d[l_ac].amt1,g_glaq_d[l_ac].amt2,g_glaq_d[l_ac].amt3
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      #期初
      IF g_glaq_d[l_ac].style='1' THEN
         IF l_glaq002 = g_glaq_d[l_ac].glaq002 AND 
            (l_glaq017 = g_glaq_d[l_ac].glaq017 OR (l_glaq017 IS NULL AND g_glaq_d[l_ac].glaq017 IS NULL)) AND
            (l_glaq018 = g_glaq_d[l_ac].glaq018 OR (l_glaq018 IS NULL AND g_glaq_d[l_ac].glaq018 IS NULL)) AND
            (l_glaq019 = g_glaq_d[l_ac].glaq019 OR (l_glaq019 IS NULL AND g_glaq_d[l_ac].glaq019 IS NULL)) AND
            (l_glaq020 = g_glaq_d[l_ac].glaq020 OR (l_glaq020 IS NULL AND g_glaq_d[l_ac].glaq020 IS NULL)) AND
            (l_glaq021 = g_glaq_d[l_ac].glaq021 OR (l_glaq021 IS NULL AND g_glaq_d[l_ac].glaq021 IS NULL)) AND
            (l_glaq022 = g_glaq_d[l_ac].glaq022 OR (l_glaq022 IS NULL AND g_glaq_d[l_ac].glaq022 IS NULL)) AND
            (l_glaq023 = g_glaq_d[l_ac].glaq023 OR (l_glaq023 IS NULL AND g_glaq_d[l_ac].glaq023 IS NULL)) AND
            (l_glaq024 = g_glaq_d[l_ac].glaq024 OR (l_glaq024 IS NULL AND g_glaq_d[l_ac].glaq024 IS NULL)) AND
            (l_glaq025 = g_glaq_d[l_ac].glaq025 OR (l_glaq025 IS NULL AND g_glaq_d[l_ac].glaq025 IS NULL)) AND
            (l_glaq026 = g_glaq_d[l_ac].glaq026 OR (l_glaq026 IS NULL AND g_glaq_d[l_ac].glaq026 IS NULL)) AND
            (l_glaq027 = g_glaq_d[l_ac].glaq027 OR (l_glaq027 IS NULL AND g_glaq_d[l_ac].glaq027 IS NULL)) AND
            (l_glaq028 = g_glaq_d[l_ac].glaq028 OR (l_glaq028 IS NULL AND g_glaq_d[l_ac].glaq028 IS NULL)) THEN
            CONTINUE FOREACH
         ELSE
            LET l_glaq002 = g_glaq_d[l_ac].glaq002
            LET l_glaq017 = g_glaq_d[l_ac].glaq017
            LET l_glaq018 = g_glaq_d[l_ac].glaq018
            LET l_glaq019 = g_glaq_d[l_ac].glaq019
            LET l_glaq020 = g_glaq_d[l_ac].glaq020
            LET l_glaq021 = g_glaq_d[l_ac].glaq021
            LET l_glaq022 = g_glaq_d[l_ac].glaq022
            LET l_glaq023 = g_glaq_d[l_ac].glaq023
            LET l_glaq024 = g_glaq_d[l_ac].glaq024
            LET l_glaq025 = g_glaq_d[l_ac].glaq025
            LET l_glaq026 = g_glaq_d[l_ac].glaq026
            LET l_glaq027 = g_glaq_d[l_ac].glaq027
            LET l_glaq028 = g_glaq_d[l_ac].glaq028
         END IF
      END IF
      CALL aglq770_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   CALL g_glaq_d.deleteElement(g_glaq_d.getLength())   
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.cnt
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs1
   FREE aglq770_pb1
   
   LET l_ac = 1
END FUNCTION]]>
</point>
  <point name="function.aglq770_set_default_value" cite_std="N" status="" ver="1" src="s" new="Y" order="7" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 設置默認值
# Memo...........:
# Usage..........: CALL aglq770_set_default_value()
# Date & Author..: 2014/03/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_set_default_value()
   DEFINE l_flag           LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   
   CALL s_get_accdate(g_glaa003,g_today,'','')
   RETURNING l_flag,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag='N' THEN
      CALL cl_err('',l_errno,0)
   END IF
   LET tm.sdate=l_pdate_s  #起始日期
   LET tm.syear=l_glav002
   LET tm.speriod=l_glav006
   LET tm.edate=l_pdate_e  #截止日期
   LET tm.eyear=l_glav002
   LET tm.eperiod=l_glav006
  
   #原幣顯示設置
   LET tm.curr_o='N'
   CALL cl_set_comp_visible('glaq005,glaq006,glaq010d,glaq010c,amt',FALSE)
   LET tm.curr_p='N'
   CALL aglq770_set_comp_entry('curr_p',FALSE)
   #按科目分頁
   LET tm.acc_p='N'
   #統制科目
   LET tm.show_acc='Y'
   #科目層級
   LET tm.glac005=99
   #單據狀態
   LET tm.stus='1'
   #含內部管理科目
   LET tm.glac009='Y'
   #含月結傳票
   LET tm.show_ce='Y'
   #含年結傳票
   LET tm.show_ye='Y'
   #核算項
   LET tm.comp='Y'
   LET tm.glad007='N'
   LET tm.glad008='N'
   LET tm.glad009='N'
   LET tm.glad010='N'
   LET tm.glad027='N'
   LET tm.glad011='N'
   LET tm.glad012='N'
   LET tm.glad013='N'
   LET tm.glad014='N'
   LET tm.glad015='N'
   LET tm.glad016='N'
   CALL cl_set_comp_visible("b_glaq018,b_glaq018_desc,b_glaq019,b_glaq019_desc,
                             b_glaq020,b_glaq020_desc,b_glaq021,b_glaq021_desc,b_glaq022,b_glaq022_desc,
                             b_glaq023,b_glaq023_desc,b_glaq024,b_glaq024_desc,b_glaq025,glaq025_desc,
                             b_glaq026,b_glaq026_desc,b_glaq027,b_glaq028",FALSE)
END FUNCTION]]>
</point>
  <point name="function.aglq770_fetch1" cite_std="N" status="" ver="1" src="s" new="Y" order="8" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 抓取下一筆資料
# Memo...........:
# Usage..........: CALL aglq770_fetch1(p_flag)
# Input parameter: p_flag            
# Date & Author..: 2014/3/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_fetch1(p_flag)
   DEFINE p_flag   LIKE type_t.chr1
   DEFINE ls_msg     STRING
   
   IF g_header_cnt = 0 THEN
      RETURN
   END IF
   
   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt        
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_glaq_s.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         
         LET g_no_ask = FALSE  
   END CASE 
   
   #代表沒有資料
   IF g_current_idx = 0 OR g_glaq_s.getLength() = 0 THEN
      RETURN
   END IF
   
   #超出範圍
   IF g_current_idx > g_glaq_s.getLength() THEN
      LET g_current_idx = g_glaq_s.getLength()
   END IF
   
   DISPLAY g_current_idx TO FORMONLY.h_index
   LET g_glaq002 = g_glaq_s[g_current_idx].glaq002 
   LET g_glaq005 = g_glaq_s[g_current_idx].glaq005
   CALL aglq770_b_fill1() 
END FUNCTION]]>
</point>
  <point name="function.aglq770_fix_acc_get_sql" cite_std="N" status="" ver="1" src="s" new="Y" order="9" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 根據核算項勾選組SQL語句
# Memo...........:
# Usage..........: CALL aglq770_fix_acc_get_sql()
#                  RETURNING r_sql,r_sql1
# Return code....: r_sql    關於glar_t的SQL語句
#                : r_sql1   關於glaq_t的SQL語句
# Date & Author..: 2014/03/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_fix_acc_get_sql()
   DEFINE r_sql,r_sql1,r_sql2   STRING 
   
   LET r_sql=''
   LET r_sql1=''
   LET r_sql2=''
   
   IF tm.comp='Y' THEN
      LET r_sql =r_sql,",glar012"
      LET r_sql1=r_sql1,",glaq017"
      LET r_sql2=r_sql2,",glaq017 glar012"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad007='Y' THEN
      LET r_sql =r_sql,",glar013"
      LET r_sql1=r_sql1,",glaq018"
      LET r_sql2=r_sql2,",glaq018 glar013"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad008='Y' THEN
      LET r_sql =r_sql,",glar014"
      LET r_sql1=r_sql1,",glaq019"
      LET r_sql2=r_sql2,",glaq019 glar014"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad009='Y' THEN
      LET r_sql =r_sql,",glar015"
      LET r_sql1=r_sql1,",glaq020"
      LET r_sql2=r_sql2,",glaq020 glar015"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad010='Y' THEN
      LET r_sql =r_sql,",glar016"
      LET r_sql1=r_sql1,",glaq021"
      LET r_sql2=r_sql2,",glaq021 glar016"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad027='Y' THEN
      LET r_sql =r_sql,",glar017"
      LET r_sql1=r_sql1,",glaq022"
      LET r_sql2=r_sql2,",glaq022 glar017"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad011='Y' THEN
      LET r_sql =r_sql,",glar018"
      LET r_sql1=r_sql1,",glaq023"
      LET r_sql2=r_sql2,",glaq023 glar018"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad012='Y' THEN
      LET r_sql =r_sql,",glar019"
      LET r_sql1=r_sql1,",glaq024"
      LET r_sql2=r_sql2,",glaq024 glar019"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad013='Y' THEN
      LET r_sql =r_sql,",glar020"
      LET r_sql1=r_sql1,",glaq025"
      LET r_sql2=r_sql2,",glaq025 glar020"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad014='Y' THEN
      LET r_sql =r_sql,",glar021"
      LET r_sql1=r_sql1,",glaq026"
      LET r_sql2=r_sql2,",glaq026 glar021"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad015='Y' THEN
      LET r_sql =r_sql,",glar022"
      LET r_sql1=r_sql1,",glaq027"
      LET r_sql2=r_sql2,",glaq027 glar022"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad016='Y' THEN
      LET r_sql =r_sql,",glar023"
      LET r_sql1=r_sql1,",glaq028"
      LET r_sql2=r_sql2,",glaq028 glar023"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
     
   RETURN r_sql,r_sql1,r_sql2
END FUNCTION]]>
</point>
  <point name="function.aglq770_fix_acc_sql" cite_std="N" status="" ver="1" src="s" new="Y" order="10" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL aglq770_fix_acc_sql(p_glaq017,p_glaq018,p_glaq019,p_glaq020,p_glaq021,p_glaq022,p_glaq023,p_glaq024,p_glaq025,p_glaq026,p_glaq027,p_glaq028)
#                  RETURNING r_sql,r_sql1
# Input parameter: p_glaq017,p_glaq018,p_glaq019,p_glaq020,p_glaq021,p_glaq022,p_glaq023,p_glaq024,p_glaq025,p_glaq026,p_glaq027,p_glaq028  12個固定核算項   传入参数变量说明1
# Return code....: r_sql，r_sql1 組合SQL語句
# Date & Author..: 2014/03/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_fix_acc_sql(p_glaq017,p_glaq018,p_glaq019,p_glaq020,p_glaq021,p_glaq022,p_glaq023,p_glaq024,p_glaq025,p_glaq026,p_glaq027,p_glaq028)
   DEFINE p_glaq017            LIKE glaq_t.glaq017
   DEFINE p_glaq018            LIKE glaq_t.glaq018
   DEFINE p_glaq019            LIKE glaq_t.glaq019
   DEFINE p_glaq020            LIKE glaq_t.glaq020
   DEFINE p_glaq021            LIKE glaq_t.glaq021
   DEFINE p_glaq022            LIKE glaq_t.glaq022
   DEFINE p_glaq023            LIKE glaq_t.glaq023
   DEFINE p_glaq024            LIKE glaq_t.glaq024
   DEFINE p_glaq025            LIKE glaq_t.glaq025
   DEFINE p_glaq026            LIKE glaq_t.glaq026
   DEFINE p_glaq027            LIKE glaq_t.glaq027
   DEFINE p_glaq028            LIKE glaq_t.glaq028
   DEFINE r_sql,r_sql1         STRING
   
   LET r_sql=''
   LET r_sql1=''
   IF tm.comp='Y' THEN
      IF p_glaq017 IS NULL THEN
         LET r_sql=r_sql," AND glar012 IS NULL "
         LET r_sql1=r_sql1," AND glaq017 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar012='",p_glaq017,"'"
         LET r_sql1=r_sql1," AND glaq017='",p_glaq017,"'"
      END IF
   END IF
   
   IF tm.glad007='Y' THEN
      IF p_glaq018 IS NULL THEN
         LET r_sql=r_sql," AND glar013 IS NULL "
         LET r_sql1=r_sql1," AND glaq018 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar013='",p_glaq018,"'"
         LET r_sql1=r_sql1," AND glaq018='",p_glaq018,"'"
      END IF
   END IF
   
   IF tm.glad008='Y' THEN
      IF p_glaq019 IS NULL THEN
         LET r_sql=r_sql," AND glar014 IS NULL "
         LET r_sql1=r_sql1," AND glaq019 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar014='",p_glaq019,"'"
         LET r_sql1=r_sql1," AND glaq019='",p_glaq019,"'"
      END IF
   END IF
   
   IF tm.glad009='Y' THEN
      IF p_glaq020 IS NULL THEN
         LET r_sql=r_sql," AND glar015 IS NULL "
         LET r_sql1=r_sql1," AND glaq020 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar015='",p_glaq020,"'"
         LET r_sql1=r_sql1," AND glaq020='",p_glaq020,"'"
      END IF
   END IF
   
   IF tm.glad010='Y' THEN
      IF p_glaq021 IS NULL THEN
         LET r_sql=r_sql," AND glar016 IS NULL "
         LET r_sql1=r_sql1," AND glaq021 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar016='",p_glaq021,"'"
         LET r_sql1=r_sql1," AND glaq021='",p_glaq021,"'"
      END IF
   END IF
   
   IF tm.glad027='Y' THEN
      IF p_glaq022 IS NULL THEN
         LET r_sql=r_sql," AND glar017 IS NULL "
         LET r_sql1=r_sql1," AND glaq022 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar017='",p_glaq022,"'"
         LET r_sql1=r_sql1," AND glaq022='",p_glaq022,"'"
      END IF
   END IF
      
   IF tm.glad011='Y' THEN
      IF p_glaq023 IS NULL THEN
         LET r_sql=r_sql," AND glar018 IS NULL "
         LET r_sql1=r_sql1," AND glaq023 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar018='",p_glaq023,"'"
         LET r_sql1=r_sql1," AND glaq023='",p_glaq023,"'"
      END IF
   END IF
   
   IF tm.glad012='Y' THEN
      IF p_glaq024 IS NULL THEN
         LET r_sql=r_sql," AND glar019 IS NULL "
         LET r_sql1=r_sql1," AND glaq024 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar019='",p_glaq024,"'"
         LET r_sql1=r_sql1," AND glaq024='",p_glaq024,"'"
      END IF
   END IF
   
   IF tm.glad013='Y' THEN
      IF p_glaq025 IS NULL THEN
         LET r_sql=r_sql," AND glar020 IS NULL "
         LET r_sql1=r_sql1," AND glaq025 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar020='",p_glaq025,"'"
         LET r_sql1=r_sql1," AND glaq025='",p_glaq025,"'"
      END IF
   END IF
   
   IF tm.glad014='Y' THEN
      IF p_glaq026 IS NULL THEN
         LET r_sql=r_sql," AND glar021 IS NULL "
         LET r_sql1=r_sql1," AND glaq026 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar021='",p_glaq026,"'"
         LET r_sql1=r_sql1," AND glaq026='",p_glaq026,"'"
      END IF
   END IF
   
   IF tm.glad015='Y' THEN
      IF p_glaq027 IS NULL THEN
         LET r_sql=r_sql," AND glar022 IS NULL "
         LET r_sql1=r_sql1," AND glaq027 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar022='",p_glaq027,"'"
         LET r_sql1=r_sql1," AND glaq027='",p_glaq027,"'"
      END IF
   END IF
   
   IF tm.glad016='Y' THEN
      IF p_glaq028 IS NULL THEN
         LET r_sql=r_sql," AND glar023 IS NULL "
         LET r_sql1=r_sql1," AND glaq028 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar023='",p_glaq028,"'"
         LET r_sql1=r_sql1," AND glaq028='",p_glaq028,"'"
      END IF
   END IF
   RETURN r_sql,r_sql1
END FUNCTION]]>
</point>
  <point name="function.aglq770_set_page" cite_std="N" status="" ver="1" src="s" new="Y" order="11" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 设置分页
# Memo...........:
# Usage..........: CALL aglq770_set_page()
# Date & Author..: 2014/03/30 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_set_page()
   DEFINE l_sql    STRING
   DEFINE l_idx    LIKE type_t.num5
   
   CALL g_glaq_s.clear()
   IF tm.curr_p <>'Y' AND tm.acc_p<>'Y' THEN
      LET g_glaq_s[1].glaq002=''
      LET g_glaq_s[1].glaq005=''
      LET g_header_cnt = 1
      LET g_rec_b = 1
   ELSE
      CASE   
         WHEN tm.acc_p='Y' AND tm.curr_p<>'Y' 
            LET l_sql="SELECT DISTINCT glaq002,'' FROM aglq770_tmp ORDER BY glaq002 "
         WHEN tm.acc_p='Y' AND tm.curr_p='Y'
            LET l_sql="SELECT DISTINCT glaq002,glaq005 FROM aglq770_tmp ORDER BY glaq002,glaq005 "
         WHEN tm.acc_p<>'Y' AND tm.curr_p='Y'
            LET l_sql="SELECT DISTINCT '',glaq005 FROM aglq770_tmp ORDER BY glaq005 "
      END CASE
      PREPARE aglq770_sel_s_pr FROM l_sql
      DECLARE aglq770_sel_s_cr CURSOR FOR aglq770_sel_s_pr
      LET l_idx=1
      FOREACH aglq770_sel_s_cr INTO g_glaq_s[l_idx].glaq002,g_glaq_s[l_idx].glaq005
         IF SQLCA.sqlcode THEN
            CALL cl_err('FOREACH aglq770_sel_s_cr',SQLCA.sqlcode,0)
            EXIT FOREACH
         END IF
         LET l_idx=l_idx+1
         IF l_idx > g_max_rec THEN
            CALL cl_err('',9035,0)
            EXIT FOREACH
         END IF
      END FOREACH
      LET l_idx = l_idx - 1
      CALL g_glaq_s.deleteElement(g_glaq_s.getLength())
      LET g_header_cnt = g_glaq_s.getLength()
      LET g_rec_b = l_idx
   END IF
   DISPLAY g_header_cnt TO FORMONLY.h_count
END FUNCTION]]>
</point>
  <point name="function.aglq770_set_comp_entry" cite_std="N" status="" ver="1" src="s" new="Y" order="12" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 動態設定元件是否需輸入值
# Memo...........:
# Usage..........: CALL aglq770_set_comp_entry(ps_fields,pi_entry)
# Input parameter: ps_fields   欄位名稱
#                : pi_entry    是否進入欄位
# Date & Author..: 2014/04/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq770_set_comp_entry(ps_fields,pi_entry)
   DEFINE ps_fields STRING,
          pi_entry  LIKE type_t.num5           
   DEFINE lst_fields base.StringTokenizer,
          ls_field_name STRING
   DEFINE lwin_curr     ui.Window
   DEFINE lnode_win     om.DomNode,
          llst_items    om.NodeList,
          li_i          LIKE type_t.num5,        
          lnode_item    om.DomNode,
          ls_item_name  STRING
 
   IF g_bgjob = 'Y' AND g_gui_type NOT MATCHES "[13]"  THEN  
      RETURN
   END IF
 
   IF (ps_fields IS NULL) THEN
      RETURN
   END IF
 
   LET ps_fields = ps_fields.toLowerCase()
 
   LET lst_fields = base.StringTokenizer.create(ps_fields, ",")
 
   LET lwin_curr = ui.Window.getCurrent()
   LET lnode_win = lwin_curr.getNode()
 
   LET llst_items = lnode_win.selectByPath("//Form//*")
 
   WHILE lst_fields.hasMoreTokens()
     LET ls_field_name = lst_fields.nextToken()
     LET ls_field_name = ls_field_name.trim()
 
     IF (ls_field_name.getLength() > 0) THEN
        FOR li_i = 1 TO llst_items.getLength()
            LET lnode_item = llst_items.item(li_i)
            LET ls_item_name = lnode_item.getAttribute("colName")
 
            IF (ls_item_name IS NULL) THEN
               LET ls_item_name = lnode_item.getAttribute("name")
 
               IF (ls_item_name IS NULL) THEN
                  CONTINUE FOR
               END IF
            END IF
 
            LET ls_item_name = ls_item_name.trim()
 
            IF (ls_item_name.equals(ls_field_name)) THEN
               IF (pi_entry) THEN
                  CALL lnode_item.setAttribute("noEntry", "0")
                  CALL lnode_item.setAttribute("active", "1")
               ELSE
                  CALL lnode_item.setAttribute("noEntry", "1")
                  CALL lnode_item.setAttribute("active", "0")
               END IF
 
               EXIT FOR
            END IF
        END FOR
     END IF
   END WHILE
END FUNCTION]]>
</point>
  <point name="b_fill.sql_before" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   RETURN]]>
</point>
  <point name="cs.after_construct" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   IF l_flag=TRUE THEN
      CALL cl_set_comp_visible('group3',FALSE)
      CALL aglq770_get_data()
      SELECT COUNT(*) INTO l_cnt FROM aglq770_tmp
      IF l_cnt=0 THEN 
         CALL cl_err('',-100,0)
         RETURN
      END IF
      CALL aglq770_set_page()
      CALL aglq770_fetch1('F')
   ELSE
      CALL aglq770_b_fill1()
      DISPLAY g_current_idx TO FORMONLY.h_index
      DISPLAY g_glaq_s.getLength() TO FORMONLY.h_count
      DISPLAY g_detail_idx TO FORMONLY.idx
   END IF]]>
</point>
  <point name="detail_show.body.reference" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   #科目編號
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_glaq_d[l_ac].glaq002
   CALL ap_ref_array2(g_ref_fields,"SELECT glacl004 FROM glacl_t WHERE glaclent='"||g_enterprise||"' AND glacl001 = '"||g_glaa004||"' AND glacl002 = ? AND glacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_glaq_d[l_ac].glaq002_desc=g_rtn_fields[1]
   #營運據點
   IF tm.comp='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =g_glaq_d[l_ac].glaq017
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq017_desc=g_rtn_fields[1]
   END IF
   #部門
   IF tm.glad007='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =g_glaq_d[l_ac].glaq018
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq018_desc=g_rtn_fields[1]
   END IF
   #成本中心
   IF tm.glad008='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =g_glaq_d[l_ac].glaq019
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq019_desc=g_rtn_fields[1]
   END IF
   #區域
   IF tm.glad009='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = '287'
      LET g_ref_fields[2] = g_glaq_d[l_ac].glaq020
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq020_desc=g_rtn_fields[1] 
   END IF
   #交易客戶
   IF tm.glad010='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glaq_d[l_ac].glaq021
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq021_desc=g_rtn_fields[1]
   END IF
   #帳款客戶
   IF tm.glad027='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glaq_d[l_ac].glaq022
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq022_desc=g_rtn_fields[1]
   END IF
   #客群   
   IF tm.glad011='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = '281'
      LET g_ref_fields[2] = g_glaq_d[l_ac].glaq023
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq023_desc=g_rtn_fields[1] 
   END IF
   #產品類別
   IF tm.glad012='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glaq_d[l_ac].glaq024
      CALL ap_ref_array2(g_ref_fields,"SELECT rtaxl003 FROM rtaxl_t WHERE rtaxlent='"||g_enterprise||"' AND rtaxl001=? AND rtaxl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq024_desc=g_rtn_fields[1]
   END IF
   #人員編號
   IF tm.glad013='Y' THEN
      SELECT oofa011 INTO g_glaq_d[l_ac].glaq025_desc FROM oofa_t
       WHERE oofaent = g_enterprise
         AND oofa001 IN (SELECT ooag002 FROM ooag_t WHERE ooagent = g_enterprise
                         AND ooag001 = g_glaq_d[l_ac].glaq025)
   END IF
   #預算編號
   IF tm.glad014='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glaq_d[l_ac].glaq026
      CALL ap_ref_array2(g_ref_fields,"SELECT bgaal003 FROM bgaal_t WHERE bgaalent='"||g_enterprise||"' AND bgaal001=? AND bgaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glaq_d[l_ac].glaq026_desc=g_rtn_fields[1]
   END IF]]>
</point>
  <point name="fetch.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   RETURN]]>
</point>
  <point name="global.variable" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[#依据当前账别，抓取账别所归属的法人，使用币别，汇率参照表号，会计科目参照表号
DEFINE g_bookno        LIKE glap_t.glapld
DEFINE g_glaald        LIKE glaa_t.glaald
DEFINE g_glaald_desc   LIKE glaal_t.glaal002
DEFINE g_glaacomp      LIKE glaa_t.glaacomp
DEFINE g_glaacomp_desc LIKE ooefl_t.ooefl003
DEFINE g_glaa001       LIKE glaa_t.glaa001
DEFINE g_glaa002       LIKE glaa_t.glaa002
DEFINE g_glaa003       LIKE glaa_t.glaa003
DEFINE g_glaa004       LIKE glaa_t.glaa004
DEFINE g_glaa013       LIKE glaa_t.glaa013
DEFINE g_glaa015       LIKE glaa_t.glaa015
DEFINE g_glaa016       LIKE glaa_t.glaa016
DEFINE g_glaa017       LIKE glaa_t.glaa017
DEFINE g_glaa018       LIKE glaa_t.glaa018
DEFINE g_glaa019       LIKE glaa_t.glaa019
DEFINE g_glaa020       LIKE glaa_t.glaa020
DEFINE g_glaa021       LIKE glaa_t.glaa021
DEFINE g_glaa022       LIKE glaa_t.glaa022
#查询条件定义
DEFINE tm              RECORD
       sdate           LIKE glap_t.glapdocdt,  #起始日期
       syear           LIKE glap_t.glap002,    #起始年度
       speriod         LIKE glap_t.glap004,    #起始期別
       edate           LIKE glap_t.glapdocdt,  #截止日期
       eyear           LIKE glap_t.glap002,    #截止年度
       eperiod         LIKE glap_t.glap004,    #截止期別
       ctype           LIKE type_t.chr1,       #多本位幣
       curr_o          LIKE type_t.chr1, 
       curr_p          LIKE type_t.chr1, 
       acc_p           LIKE type_t.chr1, 
       show_acc        LIKE type_t.chr1, 
       glac005	       LIKE glac_t.glac005,
       stus            LIKE type_t.chr1,
       glac009	       LIKE glac_t.glac009,
       show_ce         LIKE type_t.chr1,
       show_ye         LIKE type_t.chr1,
       comp            LIKE type_t.chr1,
       glad007         LIKE type_t.chr1,
       glad008         LIKE type_t.chr1,
       glad009         LIKE type_t.chr1,
       glad010         LIKE type_t.chr1,
       glad027         LIKE type_t.chr1,
       glad011         LIKE type_t.chr1,
       glad012         LIKE type_t.chr1,
       glad013         LIKE type_t.chr1,
       glad014         LIKE type_t.chr1,
       glad015         LIKE type_t.chr1,
       glad016         LIKE type_t.chr1
       END RECORD
DEFINE g_wc1           STRING
DEFINE g_glaq002       LIKE glaq_t.glaq002
DEFINE g_glaq005       LIKE glaq_t.glaq005
DEFINE g_glaq_s        DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位 
       glaq002         LIKE glaq_t.glaq002, 
       glaq005         LIKE glaq_t.glaq005
      END RECORD 
DEFINE g_current_row   LIKE type_t.num5 
DEFINE g_current_idx   LIKE type_t.num10     
DEFINE g_jump          LIKE type_t.num10        
DEFINE g_no_ask        LIKE type_t.num5  
DEFINE g_rec_b         LIKE type_t.num5]]>
</point>
  <point name="init.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   DEFINE l_success   LIKE type_t.num5
   DEFINE l_pass      LIKE type_t.num5]]>
</point>
  <point name="init.init" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   LET g_detail_idx  = 1
   CALL cl_set_combo_scc('stus','9922')
   CALL cl_set_combo_scc('state','9926')
   CALL cl_set_combo_scc('style','9927')
   #获取账别
   IF cl_null(g_glaald) THEN
      CALL s_ld_bookno()  RETURNING l_success,g_glaald
      IF l_success = FALSE THEN
         RETURN 
      END IF 
      CALL s_ld_chk_authorization(g_user,g_glaald) RETURNING l_pass
      IF l_pass = FALSE THEN
         CALL cl_err(g_glaald,'agl-00164',1)
         RETURN
      END IF
   END IF      
   CALL aglq770_glaald_desc(g_glaald)
   CALL aglq770_set_default_value()
   #建立临时表
   CALL aglq770_create_temp_table()]]>
</point>
  <point name="input.body.before_row" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               DISPLAY g_current_idx TO FORMONLY.h_index
               DISPLAY g_glaq_s.getLength() TO FORMONLY.h_count
               DISPLAY g_detail_idx TO FORMONLY.idx
               DISPLAY g_glaq_d.getLength() TO FORMONLY.cnt]]>
</point>
  <point name="menu.first1" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq770_fetch1('F')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.jump1" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq770_fetch1('/')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.last1" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq770_fetch1('L')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.next1" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq770_fetch1('N')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.previous1" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq770_fetch1('P')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.query" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               EXIT DIALOG]]>
</point>
  <point name="query.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   DEFINE l_flag           LIKE type_t.num5
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_cnt            LIKE type_t.num5
   
   LET l_flag=TRUE]]>
</point>
  <point name="query.more_construct" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[      CONSTRUCT g_wc1 ON glapdocdt,glaqdocno
           FROM s_detail1[1].glapdocdt,s_detail1[1].glaqdocno
                      
         BEFORE CONSTRUCT
         
         ON ACTION controlp INFIELD glaqdocno
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_glapdocno()                        #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaqdocno  #顯示到畫面上
            NEXT FIELD glaqdocno                     #返回原欄位            
      END CONSTRUCT
      
      CONSTRUCT g_wc2 ON glaq005
           FROM s_detail1[1].glaq005
                      
         BEFORE CONSTRUCT
         
         ON ACTION controlp INFIELD glaq005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooai001()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO glaq005  #顯示到畫面上
            NEXT FIELD glaq005                     #返回原欄位            
      END CONSTRUCT
      
      INPUT BY NAME tm.sdate,tm.edate,tm.ctype,tm.curr_o,tm.curr_p,tm.acc_p,
                    tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye,
                    tm.comp,tm.glad007,tm.glad008,tm.glad009,tm.glad010,tm.glad027,
                    tm.glad011,tm.glad012,tm.glad013,tm.glad014,tm.glad015,tm.glad016
         ATTRIBUTE(WITHOUT DEFAULTS)
         BEFORE INPUT
         
         AFTER FIELD sdate
            IF NOT cl_null(tm.sdate) THEN
               CALL s_get_accdate(g_glaa003,tm.sdate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  CALL cl_err('',l_errno,0)
                  NEXT FIELD sdate
               END IF
               IF NOT cl_null(tm.edate) THEN
                  IF tm.sdate>tm.edate THEN
                     CALL cl_err('','agl-00116',0)
                     NEXT FIELD sdate
                  END IF
               END IF
               LET tm.syear=l_glav002
               LET tm.speriod=l_glav006
               DISPLAY tm.syear,tm.speriod TO syear,speriod 
            END IF
         
         AFTER FIELD edate
            IF NOT cl_null(tm.edate) THEN
               CALL s_get_accdate(g_glaa003,tm.edate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  CALL cl_err('',l_errno,0)
                  NEXT FIELD edate
               END IF
               IF NOT cl_null(tm.sdate) THEN
                  IF tm.sdate>tm.edate THEN
                     CALL cl_err('','agl-00117',0)
                     NEXT FIELD edate
                  END IF
               END IF
               LET tm.eyear=l_glav002
               LET tm.eperiod=l_glav006
               DISPLAY tm.eyear,tm.eperiod TO eyear,eperiod 
            END IF
         
         ON CHANGE ctype
            IF tm.ctype MATCHES '[123]' THEN
               CALL aglq770_set_curr_show()
            ELSE
               NEXT FIELD ctype
            END IF
            
         ON CHANGE curr_o 
            IF tm.curr_o MATCHES '[yYnN]' THEN
               IF tm.curr_o='Y' THEN
                  CALL cl_set_comp_visible('glaq005,glaq006,glaq010d,glaq010c,amt',TRUE)
                  CALL aglq770_set_comp_entry('curr_p',TRUE)
               ELSE
                  CALL cl_set_comp_visible('glaq005,glaq006,glaq010d,glaq010c,amt',FALSE)
                  CALL aglq770_set_comp_entry('curr_p',FALSE)
                  LET tm.curr_p='N'
                  DISPLAY tm.curr_p TO curr_p
               END IF                  
            ELSE
               NEXT FIELD curr_o
            END IF
            
         ON CHANGE acc_p
            IF tm.acc_p NOT MATCHES '[yYnN]' THEN
                NEXT FIELD curr_p
            END IF
            
         AFTER FIELD acc_p
            IF tm.acc_p NOT MATCHES '[yYnN]' THEN
               NEXT FIELD acc_p
            END IF
            
         AFTER FIELD show_acc
            IF tm.show_acc NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_acc
            END IF
         
         AFTER FIELD glac005
            IF NOT cl_ap_chk_Range(tm.glac005,"1","1","99","1","azz-00087",1) THEN
               NEXT FIELD glac005
            END IF
         
         AFTER FIELD stus
            IF tm.stus NOT MATCHES '[123]' THEN
               NEXT FIELD stus
            END IF
            
         AFTER FIELD glac009
            IF tm.glac009 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glac009
            END IF
            
         AFTER FIELD show_ce
            IF tm.show_ce NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ce
            END IF
         
         AFTER FIELD show_ye
            IF tm.show_ye NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ye
            END IF
            
         ON CHANGE comp
            IF tm.comp NOT MATCHES '[yYnN]' THEN
               NEXT FIELD comp
            END IF
            IF tm.comp='Y' THEN
               CALL cl_set_comp_visible("b_glaq017,b_glaq017_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq017,b_glaq017_desc",FALSE)
            END IF
            
         ON CHANGE glad007
            IF tm.glad007 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad007
            END IF
            IF tm.glad007='Y' THEN
               CALL cl_set_comp_visible("b_glaq018,b_glaq018_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq018,b_glaq018_desc",FALSE)
            END IF
            
         ON CHANGE glad008
            IF tm.glad008 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad008
            END IF
            IF tm.glad008='Y' THEN
               CALL cl_set_comp_visible("b_glaq019,b_glaq019_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq019,b_glaq019_desc",FALSE)
            END IF
            
         ON CHANGE glad009
            IF tm.glad009 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad009
            END IF
            IF tm.glad009='Y' THEN
               CALL cl_set_comp_visible("b_glaq020,b_glaq020_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq020,b_glaq020_desc",FALSE)
            END IF
         
         ON CHANGE glad010
            IF tm.glad010 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad010
            END IF
            IF tm.glad010='Y' THEN
               CALL cl_set_comp_visible("b_glaq021,b_glaq021_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq021,b_glaq021_desc",FALSE)
            END IF
            
         ON CHANGE glad027
            IF tm.glad027 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad027
            END IF
            IF tm.glad027='Y' THEN
               CALL cl_set_comp_visible("b_glaq022,b_glaq022_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq022,b_glaq022_desc",FALSE)
            END IF
            
         ON CHANGE glad011
            IF tm.glad011 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad011
            END IF
            IF tm.glad011='Y' THEN
               CALL cl_set_comp_visible("b_glaq023,b_glaq023_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq023,b_glaq023_desc",FALSE)
            END IF
            
         ON CHANGE glad012
            IF tm.glad012 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad012
            END IF
            IF tm.glad012='Y' THEN
               CALL cl_set_comp_visible("b_glaq024,b_glaq024_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq024,b_glaq024_desc",FALSE)
            END IF
         
         ON CHANGE glad013
            IF tm.glad013 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad013
            END IF
            IF tm.glad013='Y' THEN
               CALL cl_set_comp_visible("b_glaq025,glaq025_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq025,glaq025_desc",FALSE)
            END IF 
         
         ON CHANGE glad014
            IF tm.glad014 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad014
            END IF
            IF tm.glad014='Y' THEN
               CALL cl_set_comp_visible("b_glaq026,b_glaq026_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq026,b_glaq026_desc",FALSE)
            END IF

         ON CHANGE glad015
            IF tm.glad015 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad015
            END IF
            IF tm.glad015='Y' THEN
               CALL cl_set_comp_visible("b_glaq027",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq027",FALSE)
            END IF
            
         ON CHANGE glad016
            IF tm.glad016 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad016
            END IF
            IF tm.glad016='Y' THEN
               CALL cl_set_comp_visible("b_glaq028",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glaq028",FALSE)
            END IF
      END INPUT
      
      BEFORE DIALOG
        #預設
        CALL cl_set_comp_visible('group3',TRUE)
        CALL aglq770_show()]]>
</point>
  <point name="ui_dialog.bef_dialog" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #上下筆按鈕顯示否設置
            IF g_header_cnt=1 THEN
               CALL cl_set_act_visible("first,previous,jump,next,last",FALSE) 
            ELSE
               IF g_current_idx=1 THEN
                  CALL cl_set_act_visible("first,previous", FALSE) 
                  CALL cl_set_act_visible("jump,next,last", TRUE) 
               ELSE
                  IF g_current_idx<>g_header_cnt THEN
                     CALL cl_set_act_visible("first,previous,jump,next,last",TRUE) 
                  ELSE
                     CALL cl_set_act_visible("first,previous,jump",TRUE) 
                     CALL cl_set_act_visible("next,last", FALSE) 
                  END IF
               END IF
            END IF
            CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)]]>
</point>
  <point name="global.memo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.import" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.inc" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.argv" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.init" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.after_define_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.after_refresh_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.servicecall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.before_close" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.exit" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.before_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.more_displayarray" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.insert" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.output" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.datainfo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selnone" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_sel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_unsel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.filter" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="cs.head.before_construct" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq002" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq002" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq017" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq017" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq018" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq018" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq019" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq019" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq020" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq020" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq021" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq021" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq022" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq022" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq023" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq023" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq024" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq024" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq025" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq025" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq026" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq026" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq027" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq027" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glaq027" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq028" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq028" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glaq028" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glapdocdt" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glapdocdt" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glapdocdt" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaqdocno" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaqdocno" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glaqdocno" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq005" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq005" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glaq006" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glaq006" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glaq006" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.glaq003" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.glaq003" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.glaq003" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.glaq004" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.glaq004" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.glaq004" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.glaq040" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.glaq040" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.glaq040" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.glaq041" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.glaq041" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.glaq041" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.glaq043" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.glaq043" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.glaq043" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.glaq044" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.glaq044" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.glaq044" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.sql_after" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.others.fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="fetch.after_fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.before" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.after" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.add_cs" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.b_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter_parser.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="insert.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="insert.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="modify.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="modify.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="reproduce.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="reproduce.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="delete.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="delete.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <section id="aglq770.query" ver="1" status="" src="m">
<![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION aglq770_query()
   {<Local define>}
   DEFINE ls_wc      LIKE type_t.chr500
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   {</Local define>}
   #add-point:query段define
{<point name="query.define"/>}
   #end add-point 
   
   LET INT_FLAG = 0
   CLEAR FORM
   CALL g_glaq_d.clear()
   LET g_wc_filter = " 1=1"
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
   
   LET g_qryparam.state = "c"
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   
   #wc備份
   LET ls_wc = g_wc
   LET g_master_idx = l_ac
 
   
 
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單身根據table分拆construct
      CONSTRUCT g_wc_table ON glaq002,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024, 
          glaq025,glaq026,glaq027,glaq028
           FROM s_detail1[1].b_glaq002,s_detail1[1].b_glaq017,s_detail1[1].b_glaq018,s_detail1[1].b_glaq019, 
               s_detail1[1].b_glaq020,s_detail1[1].b_glaq021,s_detail1[1].b_glaq022,s_detail1[1].b_glaq023, 
               s_detail1[1].b_glaq024,s_detail1[1].b_glaq025,s_detail1[1].b_glaq026,s_detail1[1].b_glaq027, 
               s_detail1[1].b_glaq028
                      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
{<point name="cs.head.before_construct"/>}
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
       #---------------------<  Detail: page1  >---------------------
         #----<<b_glaq002>>----
         #Ctrlp:construct.c.page1.b_glaq002
         ON ACTION controlp INFIELD b_glaq002
            #add-point:ON ACTION controlp INFIELD b_glaq002
{<point name="construct.c.page1.b_glaq002" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq002
            #add-point:BEFORE FIELD b_glaq002
{<point name="construct.b.page1.b_glaq002" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq002
            
            #add-point:AFTER FIELD b_glaq002
{<point name="construct.a.page1.b_glaq002" />}
            #END add-point
            
 
         #----<<b_glaq017>>----
         #Ctrlp:construct.c.page1.b_glaq017
         ON ACTION controlp INFIELD b_glaq017
            #add-point:ON ACTION controlp INFIELD b_glaq017
{<point name="construct.c.page1.b_glaq017" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq017
            #add-point:BEFORE FIELD b_glaq017
{<point name="construct.b.page1.b_glaq017" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq017
            
            #add-point:AFTER FIELD b_glaq017
{<point name="construct.a.page1.b_glaq017" />}
            #END add-point
            
 
         #----<<b_glaq018>>----
         #Ctrlp:construct.c.page1.b_glaq018
         ON ACTION controlp INFIELD b_glaq018
            #add-point:ON ACTION controlp INFIELD b_glaq018
{<point name="construct.c.page1.b_glaq018" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq018
            #add-point:BEFORE FIELD b_glaq018
{<point name="construct.b.page1.b_glaq018" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq018
            
            #add-point:AFTER FIELD b_glaq018
{<point name="construct.a.page1.b_glaq018" />}
            #END add-point
            
 
         #----<<b_glaq019>>----
         #Ctrlp:construct.c.page1.b_glaq019
         ON ACTION controlp INFIELD b_glaq019
            #add-point:ON ACTION controlp INFIELD b_glaq019
{<point name="construct.c.page1.b_glaq019" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq019
            #add-point:BEFORE FIELD b_glaq019
{<point name="construct.b.page1.b_glaq019" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq019
            
            #add-point:AFTER FIELD b_glaq019
{<point name="construct.a.page1.b_glaq019" />}
            #END add-point
            
 
         #----<<b_glaq020>>----
         #Ctrlp:construct.c.page1.b_glaq020
         ON ACTION controlp INFIELD b_glaq020
            #add-point:ON ACTION controlp INFIELD b_glaq020
{<point name="construct.c.page1.b_glaq020" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq020
            #add-point:BEFORE FIELD b_glaq020
{<point name="construct.b.page1.b_glaq020" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq020
            
            #add-point:AFTER FIELD b_glaq020
{<point name="construct.a.page1.b_glaq020" />}
            #END add-point
            
 
         #----<<b_glaq021>>----
         #Ctrlp:construct.c.page1.b_glaq021
         ON ACTION controlp INFIELD b_glaq021
            #add-point:ON ACTION controlp INFIELD b_glaq021
{<point name="construct.c.page1.b_glaq021" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq021
            #add-point:BEFORE FIELD b_glaq021
{<point name="construct.b.page1.b_glaq021" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq021
            
            #add-point:AFTER FIELD b_glaq021
{<point name="construct.a.page1.b_glaq021" />}
            #END add-point
            
 
         #----<<b_glaq022>>----
         #Ctrlp:construct.c.page1.b_glaq022
         ON ACTION controlp INFIELD b_glaq022
            #add-point:ON ACTION controlp INFIELD b_glaq022
{<point name="construct.c.page1.b_glaq022" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq022
            #add-point:BEFORE FIELD b_glaq022
{<point name="construct.b.page1.b_glaq022" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq022
            
            #add-point:AFTER FIELD b_glaq022
{<point name="construct.a.page1.b_glaq022" />}
            #END add-point
            
 
         #----<<b_glaq023>>----
         #Ctrlp:construct.c.page1.b_glaq023
         ON ACTION controlp INFIELD b_glaq023
            #add-point:ON ACTION controlp INFIELD b_glaq023
{<point name="construct.c.page1.b_glaq023" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq023
            #add-point:BEFORE FIELD b_glaq023
{<point name="construct.b.page1.b_glaq023" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq023
            
            #add-point:AFTER FIELD b_glaq023
{<point name="construct.a.page1.b_glaq023" />}
            #END add-point
            
 
         #----<<b_glaq024>>----
         #Ctrlp:construct.c.page1.b_glaq024
         ON ACTION controlp INFIELD b_glaq024
            #add-point:ON ACTION controlp INFIELD b_glaq024
{<point name="construct.c.page1.b_glaq024" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq024
            #add-point:BEFORE FIELD b_glaq024
{<point name="construct.b.page1.b_glaq024" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq024
            
            #add-point:AFTER FIELD b_glaq024
{<point name="construct.a.page1.b_glaq024" />}
            #END add-point
            
 
         #----<<b_glaq025>>----
         #Ctrlp:construct.c.page1.b_glaq025
         ON ACTION controlp INFIELD b_glaq025
            #add-point:ON ACTION controlp INFIELD b_glaq025
{<point name="construct.c.page1.b_glaq025" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq025
            #add-point:BEFORE FIELD b_glaq025
{<point name="construct.b.page1.b_glaq025" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq025
            
            #add-point:AFTER FIELD b_glaq025
{<point name="construct.a.page1.b_glaq025" />}
            #END add-point
            
 
         #----<<b_glaq026>>----
         #Ctrlp:construct.c.page1.b_glaq026
         ON ACTION controlp INFIELD b_glaq026
            #add-point:ON ACTION controlp INFIELD b_glaq026
{<point name="construct.c.page1.b_glaq026" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq026
            #add-point:BEFORE FIELD b_glaq026
{<point name="construct.b.page1.b_glaq026" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq026
            
            #add-point:AFTER FIELD b_glaq026
{<point name="construct.a.page1.b_glaq026" />}
            #END add-point
            
 
         #----<<b_glaq027>>----
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq027
            #add-point:BEFORE FIELD b_glaq027
{<point name="construct.b.page1.b_glaq027" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq027
            
            #add-point:AFTER FIELD b_glaq027
{<point name="construct.a.page1.b_glaq027" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.b_glaq027
         ON ACTION controlp INFIELD b_glaq027
            #add-point:ON ACTION controlp INFIELD b_glaq027
{<point name="construct.c.page1.b_glaq027" />}
            #END add-point
 
         #----<<b_glaq028>>----
         #此段落由子樣板a01產生
         BEFORE FIELD b_glaq028
            #add-point:BEFORE FIELD b_glaq028
{<point name="construct.b.page1.b_glaq028" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glaq028
            
            #add-point:AFTER FIELD b_glaq028
{<point name="construct.a.page1.b_glaq028" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.b_glaq028
         ON ACTION controlp INFIELD b_glaq028
            #add-point:ON ACTION controlp INFIELD b_glaq028
{<point name="construct.c.page1.b_glaq028" />}
            #END add-point
{<point name="construct.b.page1.b_glapdocdt" />}

{<point name="construct.a.page1.b_glapdocdt" />}

{<point name="construct.c.page1.b_glapdocdt" />}

{<point name="construct.b.page1.b_glaqdocno" />}

{<point name="construct.a.page1.b_glaqdocno" />}

{<point name="construct.c.page1.b_glaqdocno" />}

{<point name="construct.c.page1.b_glaq005" />}

{<point name="construct.b.page1.b_glaq005" />}

{<point name="construct.a.page1.b_glaq005" />}

{<point name="construct.b.page1.b_glaq006" />}

{<point name="construct.a.page1.b_glaq006" />}

{<point name="construct.c.page1.b_glaq006" />}

{<point name="construct.b.page1.glaq003" />}

{<point name="construct.a.page1.glaq003" />}

{<point name="construct.c.page1.glaq003" />}

{<point name="construct.b.page1.glaq004" />}

{<point name="construct.a.page1.glaq004" />}

{<point name="construct.c.page1.glaq004" />}

{<point name="construct.b.page1.glaq040" />}

{<point name="construct.a.page1.glaq040" />}

{<point name="construct.c.page1.glaq040" />}

{<point name="construct.b.page1.glaq041" />}

{<point name="construct.a.page1.glaq041" />}

{<point name="construct.c.page1.glaq041" />}

{<point name="construct.b.page1.glaq043" />}

{<point name="construct.a.page1.glaq043" />}

{<point name="construct.c.page1.glaq043" />}

{<point name="construct.b.page1.glaq044" />}

{<point name="construct.a.page1.glaq044" />}
 
{<point name="construct.c.page1.glaq044" />}
       END CONSTRUCT
      
 
      
 
  
      #add-point:query段more_construct
{<point name="query.more_construct"/>}
      #end add-point 
      
      ON ACTION accept
         ACCEPT DIALOG
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG
      
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG 
   END DIALOG
 
   
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      #還原
      LET g_wc = ls_wc
      LET l_flag=FALSE
   ELSE
      LET g_master_idx = 1
   END IF
   
   LET g_wc = g_wc_table 
 
 
        
   LET g_wc2 = " 1=1"
 
        
   #add-point:cs段after_construct
{<point name="cs.after_construct"/>}
   #end add-point
        
   LET g_error_show = 1
   CALL aglq770_b_fill()
   LET l_ac = g_master_idx
   CALL aglq770_fetch()
#   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
#      CALL cl_err("",-100,1)
#   END IF
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
   
END FUNCTION
]]>
</section>
  <section id="aglq770.ui_dialog" ver="1" status="" src="m">
<![CDATA[#+ 功能選單 
PRIVATE FUNCTION aglq770_ui_dialog()
   {<Local define>}
   DEFINE li_idx   LIKE type_t.num5
   {</Local define>}
   #add-point:ui_dialog段define
{<point name="ui_dialog.define"/>}
   #end add-point 
 
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   #add-point:ui_dialog段before dialog 
{<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   CALL aglq770_query()
   
   WHILE TRUE
   
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         DISPLAY ARRAY g_glaq_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_glaq_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_ac
               CALL aglq770_fetch()
               #add-point:input段before row
{<point name="input.body.before_row"/>}
               #end add-point  
            
            #自訂ACTION(detail_show,page_1)
            
               
         END DISPLAY
      
 
         
 
      
         #add-point:ui_dialog段define
{<point name="ui_dialog.more_displayarray"/>}
         #end add-point
         
         BEFORE DIALOG      
            CALL DIALOG.setSelectionMode("s_detail1", 1)
 
            #add-point:ui_dialog段before dialog
{<point name="ui_dialog.bef_dialog"/>}
            #end add-point
 
            NEXT FIELD sel
      
         ON ACTION exchange_ld
 
            LET g_action_choice="exchange_ld"
            IF cl_auth_chk_act("exchange_ld") THEN 
               #add-point:ON ACTION exchange_ld
               CALL aglt310_01(g_glaald) RETURNING g_bookno
               IF g_glaald <> g_bookno THEN
                  CLEAR FORM
                  CALL g_glaq_s.clear()
                  CALL g_glaq_d.clear()
               END IF
               LET g_glaald = g_bookno
               #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
               CALL aglq770_glaald_desc(g_glaald)
               CALL aglq770_show()
                IF cl_null(g_wc) THEN
                   LET g_wc = '1=1'
                END IF 
                LET g_wc1 = ' 1=1'
                LET g_wc2 = ' 1=1'
               #END add-point
               EXIT DIALOG
            END IF               
 
         ON ACTION last
 
            LET g_action_choice="last"
            IF cl_auth_chk_act("last") THEN 
               #add-point:ON ACTION last
{<point name="menu.last1" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION next
 
            LET g_action_choice="next"
            IF cl_auth_chk_act("next") THEN 
               #add-point:ON ACTION next
{<point name="menu.next1" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION insert
 
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN 
               CALL aglq770_insert()
               #add-point:ON ACTION insert
{<point name="menu.insert" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION previous
 
            LET g_action_choice="previous"
            IF cl_auth_chk_act("previous") THEN 
               #add-point:ON ACTION previous
{<point name="menu.previous1" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION jump
 
            LET g_action_choice="jump"
            IF cl_auth_chk_act("jump") THEN 
               #add-point:ON ACTION jump
{<point name="menu.jump1" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION query
 
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN 
               CALL aglq770_query()
               #add-point:ON ACTION query
{<point name="menu.query" />}
               #END add-point
            END IF
 
 
         ON ACTION first
 
            LET g_action_choice="first"
            IF cl_auth_chk_act("first") THEN 
               #add-point:ON ACTION first
{<point name="menu.first1" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION output
 
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN 
               #add-point:ON ACTION output
{<point name="menu.output" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION datainfo
 
            LET g_action_choice="datainfo"
            IF cl_auth_chk_act("datainfo") THEN 
               #add-point:ON ACTION datainfo
{<point name="menu.datainfo" />}
               #END add-point
               EXIT DIALOG
            END IF
 
      
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            FOR li_idx = 1 TO g_glaq_d.getLength()
               LET g_glaq_d[li_idx].sel = "Y"
            END FOR
 
            #add-point:ui_dialog段on action selall
{<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_glaq_d.getLength()
               LET g_glaq_d[li_idx].sel = "N"
            END FOR
 
            #add-point:ui_dialog段on action selnone
{<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_glaq_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glaq_d[li_idx].sel = "Y"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action sel
{<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_glaq_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glaq_d[li_idx].sel = "N"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action unsel
{<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL aglq770_filter()
            #add-point:ON ACTION filter
{<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            CALL aglq770_b_fill()
            CALL aglq770_fetch()
            
         
      
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
</section>
  <section id="aglq770.b_fill" ver="10" status="" src="s">
<![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION aglq770_b_fill()
   {<Local define>}
   DEFINE ls_wc           STRING
   {</Local define>}
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
   
   IF cl_null(g_wc_filter) THEN
      LET g_wc_filter = " 1=1"
   END IF
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   
   LET ls_wc = g_wc, " AND ", g_wc2, " AND ", g_wc_filter
   
   LET g_sql = "SELECT  UNIQUE glaq002,'',glaq017,'',glaq018,'',glaq019,'',glaq020,'',glaq021,'',glaq022, 
       '',glaq023,'',glaq024,'',glaq025,'',glaq026,'',glaq027,glaq028,'','','','','','','','','','', 
       '','','','','','','','','','','' FROM glaq_t",
 
 
               "",
               " WHERE glaqent= ? AND 1=1 AND ", ls_wc
    
   LET g_sql = g_sql, " ORDER BY glaq_t.glaqld,glaq_t.glaqdocno,glaq_t.glaqseq"
  
   #add-point:b_fill段sql_after
   {<point name="b_fill.sql_after"/>}
   #end add-point
  
   PREPARE aglq770_pb FROM g_sql
   DECLARE b_fill_curs CURSOR FOR aglq770_pb
   
   OPEN b_fill_curs USING g_enterprise
 
   CALL g_glaq_d.clear()
 
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs INTO g_glaq_d[l_ac].glaq002,g_glaq_d[l_ac].glaq002_desc,g_glaq_d[l_ac].glaq017, 
       g_glaq_d[l_ac].glaq017_desc,g_glaq_d[l_ac].glaq018,g_glaq_d[l_ac].glaq018_desc,g_glaq_d[l_ac].glaq019, 
       g_glaq_d[l_ac].glaq019_desc,g_glaq_d[l_ac].glaq020,g_glaq_d[l_ac].glaq020_desc,g_glaq_d[l_ac].glaq021, 
       g_glaq_d[l_ac].glaq021_desc,g_glaq_d[l_ac].glaq022,g_glaq_d[l_ac].glaq022_desc,g_glaq_d[l_ac].glaq023, 
       g_glaq_d[l_ac].glaq023_desc,g_glaq_d[l_ac].glaq024,g_glaq_d[l_ac].glaq024_desc,g_glaq_d[l_ac].glaq025, 
       g_glaq_d[l_ac].glaq025_desc,g_glaq_d[l_ac].glaq026,g_glaq_d[l_ac].glaq026_desc,g_glaq_d[l_ac].glaq027, 
       g_glaq_d[l_ac].glaq028,g_glaq_d[l_ac].glapdocdt,g_glaq_d[l_ac].glaqdocno,g_glaq_d[l_ac].glap004, 
       g_glaq_d[l_ac].style,g_glaq_d[l_ac].glaq005,g_glaq_d[l_ac].glaq006,g_glaq_d[l_ac].glaq010d,g_glaq_d[l_ac].glaq010c, 
       g_glaq_d[l_ac].glaq003,g_glaq_d[l_ac].glaq004,g_glaq_d[l_ac].glaq039,g_glaq_d[l_ac].glaq040,g_glaq_d[l_ac].glaq041, 
       g_glaq_d[l_ac].glaq042,g_glaq_d[l_ac].glaq043,g_glaq_d[l_ac].glaq044,g_glaq_d[l_ac].state,g_glaq_d[l_ac].amt, 
       g_glaq_d[l_ac].amt1,g_glaq_d[l_ac].amt2,g_glaq_d[l_ac].amt3
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET g_glaq_d[l_ac].sel = "N"
      #LET g_glaq_d[l_ac].statepic = cl_get_actipic(g_glaq_d[l_ac].statepic)
 
      
 
      #add-point:b_fill段資料填充
      {<point name="b_fill.fill"/>}
      #end add-point
      
      CALL aglq770_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
 
   
   CALL g_glaq_d.deleteElement(g_glaq_d.getLength())   
 
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.others.fill"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE aglq770_pb
   
   LET l_ac = 1
   CALL aglq770_fetch()
   
      CALL aglq770_filter_show('glaq002','b_glaq002')
   CALL aglq770_filter_show('glaq017','b_glaq017')
   CALL aglq770_filter_show('glaq018','b_glaq018')
   CALL aglq770_filter_show('glaq019','b_glaq019')
   CALL aglq770_filter_show('glaq020','b_glaq020')
   CALL aglq770_filter_show('glaq021','b_glaq021')
   CALL aglq770_filter_show('glaq022','b_glaq022')
   CALL aglq770_filter_show('glaq023','b_glaq023')
   CALL aglq770_filter_show('glaq024','b_glaq024')
   CALL aglq770_filter_show('glaq025','b_glaq025')
   CALL aglq770_filter_show('glaq026','b_glaq026')
   CALL aglq770_filter_show('glaq027','b_glaq027')
   CALL aglq770_filter_show('glaq028','b_glaq028')
   CALL aglq770_filter_show('glaqdocno','b_glaq028')
   CALL aglq770_filter_show('glaq005','b_glaq028')
   CALL aglq770_filter_show('glaq006','b_glaq028')
   CALL aglq770_filter_show('glaq003','b_glaq028')
   CALL aglq770_filter_show('glaq004','b_glaq028')
   CALL aglq770_filter_show('glaq039','b_glaq028')
   CALL aglq770_filter_show('glaq040','b_glaq028')
   CALL aglq770_filter_show('glaq041','b_glaq028')
   CALL aglq770_filter_show('glaq042','b_glaq028')
   CALL aglq770_filter_show('glaq043','b_glaq028')
   CALL aglq770_filter_show('glaq044','b_glaq028')
 
   
END FUNCTION
]]>
</section>
  <section id="aglq770.delete" ver="1" status="" src="s">
<![CDATA[#+ delete
PRIVATE FUNCTION aglq770_delete()
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point
 
   #add-point:delete段control
   {<point name="delete.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq770.description" ver="59" status="" src="s">
<![CDATA[#+ Version..: T100-ERP-1.00.00(版次:1) Build-000058
#+ 
#+ Filename...: aglq770
#+ Description: 明細分類帳(核算項)查詢作業
#+ Creator....: 02599(2014/03/27)
#+ Modifier...: 02599(2014/03/29)
#+ Buildtype..: 應用 q02 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
</section>
  <section id="aglq770.detail_show" ver="1" status="" src="s">
<![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION aglq770_detail_show()
   #add-point:show段define
   {<point name="detail_show.define"/>}
   #end add-point
 
   #add-point:detail_show段之前
   {<point name="detail_show.before"/>}
   #end add-point
   
   
   
   #帶出公用欄位reference值page1
   
    
 
   
   #讀入ref值
   #add-point:show段單身reference
   {<point name="detail_show.body.reference"/>}
   #end add-point
   
 
 
   #add-point:detail_show段之後
   {<point name="detail_show.after"/>}
   #end add-point
 
END FUNCTION
]]>
</section>
  <section id="aglq770.fetch" ver="1" status="" src="s">
<![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION aglq770_fetch()
   {<Local define>}
   DEFINE li_ac           LIKE type_t.num5
   {</Local define>}
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point
   
 
   
   LET li_ac = l_ac 
   
 
   
   #DISPLAY g_detail_cnt TO FORMONLY.cnt
 
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
</section>
  <section id="aglq770.filter" ver="9" status="" src="s">
<![CDATA[#+ filter過濾功能
PRIVATE FUNCTION aglq770_filter()
   {<Local define>}
   {</Local define>}
   #add-point:filter段define
   {<point name="filter.define"/>}
   #end add-point    
   
   LET l_ac = 1
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON glaq002,glaq017,glaq018,glaq019,glaq020,glaq021,glaq022,glaq023,glaq024, 
          glaq025,glaq026,glaq027,glaq028,glaqdocno,glaq005,glaq006,glaq003,glaq004,glaq039,glaq040, 
          glaq041,glaq042,glaq043,glaq044
                          FROM s_detail1[1].b_glaq002,s_detail1[1].b_glaq017,s_detail1[1].b_glaq018, 
                              s_detail1[1].b_glaq019,s_detail1[1].b_glaq020,s_detail1[1].b_glaq021,s_detail1[1].b_glaq022, 
                              s_detail1[1].b_glaq023,s_detail1[1].b_glaq024,s_detail1[1].b_glaq025,s_detail1[1].b_glaq026, 
                              s_detail1[1].b_glaq027,s_detail1[1].b_glaq028,s_detail1[1].b_glaq028,s_detail1[1].b_glaq028, 
                              s_detail1[1].b_glaq028,s_detail1[1].b_glaq028,s_detail1[1].b_glaq028,s_detail1[1].b_glaq028, 
                              s_detail1[1].b_glaq028,s_detail1[1].b_glaq028,s_detail1[1].b_glaq028,s_detail1[1].b_glaq028, 
                              s_detail1[1].b_glaq028
 
         BEFORE CONSTRUCT
#saki       CALL cl_qbe_init()
                     DISPLAY aglq770_filter_parser('glaq002') TO s_detail1[1].b_glaq002
            DISPLAY aglq770_filter_parser('glaq017') TO s_detail1[1].b_glaq017
            DISPLAY aglq770_filter_parser('glaq018') TO s_detail1[1].b_glaq018
            DISPLAY aglq770_filter_parser('glaq019') TO s_detail1[1].b_glaq019
            DISPLAY aglq770_filter_parser('glaq020') TO s_detail1[1].b_glaq020
            DISPLAY aglq770_filter_parser('glaq021') TO s_detail1[1].b_glaq021
            DISPLAY aglq770_filter_parser('glaq022') TO s_detail1[1].b_glaq022
            DISPLAY aglq770_filter_parser('glaq023') TO s_detail1[1].b_glaq023
            DISPLAY aglq770_filter_parser('glaq024') TO s_detail1[1].b_glaq024
            DISPLAY aglq770_filter_parser('glaq025') TO s_detail1[1].b_glaq025
            DISPLAY aglq770_filter_parser('glaq026') TO s_detail1[1].b_glaq026
            DISPLAY aglq770_filter_parser('glaq027') TO s_detail1[1].b_glaq027
            DISPLAY aglq770_filter_parser('glaq028') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaqdocno') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq005') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq006') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq003') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq004') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq039') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq040') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq041') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq042') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq043') TO s_detail1[1].b_glaq028
            DISPLAY aglq770_filter_parser('glaq044') TO s_detail1[1].b_glaq028
 
 
      END CONSTRUCT
 
      #add-point:filter段add_cs
      {<point name="filter.add_cs"/>}
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog
         {<point name="filter.b_dialog"/>}
         #end add-point  
 
      ON ACTION accept
         ACCEPT DIALOG 
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
 
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = g_wc_filter, " "
   ELSE
      LET g_wc_filter = g_wc_filter_t
   END IF
   
      CALL aglq770_filter_show('glaq002','b_glaq002')
   CALL aglq770_filter_show('glaq017','b_glaq017')
   CALL aglq770_filter_show('glaq018','b_glaq018')
   CALL aglq770_filter_show('glaq019','b_glaq019')
   CALL aglq770_filter_show('glaq020','b_glaq020')
   CALL aglq770_filter_show('glaq021','b_glaq021')
   CALL aglq770_filter_show('glaq022','b_glaq022')
   CALL aglq770_filter_show('glaq023','b_glaq023')
   CALL aglq770_filter_show('glaq024','b_glaq024')
   CALL aglq770_filter_show('glaq025','b_glaq025')
   CALL aglq770_filter_show('glaq026','b_glaq026')
   CALL aglq770_filter_show('glaq027','b_glaq027')
   CALL aglq770_filter_show('glaq028','b_glaq028')
   CALL aglq770_filter_show('glaqdocno','b_glaq028')
   CALL aglq770_filter_show('glaq005','b_glaq028')
   CALL aglq770_filter_show('glaq006','b_glaq028')
   CALL aglq770_filter_show('glaq003','b_glaq028')
   CALL aglq770_filter_show('glaq004','b_glaq028')
   CALL aglq770_filter_show('glaq039','b_glaq028')
   CALL aglq770_filter_show('glaq040','b_glaq028')
   CALL aglq770_filter_show('glaq041','b_glaq028')
   CALL aglq770_filter_show('glaq042','b_glaq028')
   CALL aglq770_filter_show('glaq043','b_glaq028')
   CALL aglq770_filter_show('glaq044','b_glaq028')
 
    
   CALL aglq770_b_fill()
   CALL aglq770_fetch()
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
 
END FUNCTION
]]>
</section>
  <section id="aglq770.filter_parser" ver="1" status="" src="s">
<![CDATA[#+ filter欄位解析
PRIVATE FUNCTION aglq770_filter_parser(ps_field)
   {<Local define>}
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   {</Local define>}
   #add-point:filter段define
   {<point name="filter_parser.define"/>}
   #end add-point    
 
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
</section>
  <section id="aglq770.filter_show" ver="1" status="" src="s">
<![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION aglq770_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = aglq770_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
</section>
  <section id="aglq770.global" ver="5" status="" src="s">
<![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單身 type 宣告
PRIVATE TYPE type_g_glaq_d RECORD
       #statepic       LIKE type_t.chr1,
       sel            LIKE type_t.chr1,
       glaq002 LIKE glaq_t.glaq002, 
   glaq002_desc LIKE type_t.chr500, 
   glaq017 LIKE glaq_t.glaq017, 
   glaq017_desc LIKE type_t.chr500, 
   glaq018 LIKE glaq_t.glaq018, 
   glaq018_desc LIKE type_t.chr500, 
   glaq019 LIKE glaq_t.glaq019, 
   glaq019_desc LIKE type_t.chr500, 
   glaq020 LIKE glaq_t.glaq020, 
   glaq020_desc LIKE type_t.chr500, 
   glaq021 LIKE glaq_t.glaq021, 
   glaq021_desc LIKE type_t.chr500, 
   glaq022 LIKE glaq_t.glaq022, 
   glaq022_desc LIKE type_t.chr500, 
   glaq023 LIKE glaq_t.glaq023, 
   glaq023_desc LIKE type_t.chr500, 
   glaq024 LIKE glaq_t.glaq024, 
   glaq024_desc LIKE type_t.chr500, 
   glaq025 LIKE glaq_t.glaq025, 
   glaq025_desc LIKE type_t.chr80, 
   glaq026 LIKE glaq_t.glaq026, 
   glaq026_desc LIKE type_t.chr500, 
   glaq027 LIKE glaq_t.glaq027, 
   glaq028 LIKE glaq_t.glaq028, 
   glapdocdt LIKE type_t.chr80, 
   glaqdocno LIKE type_t.chr80, 
   glap004 LIKE type_t.chr80, 
   style LIKE type_t.chr80, 
   glaq005 LIKE type_t.chr80, 
   glaq006 LIKE type_t.chr80, 
   glaq010d LIKE type_t.chr500, 
   glaq010c LIKE type_t.chr500, 
   glaq003 LIKE type_t.chr500, 
   glaq004 LIKE type_t.chr500, 
   glaq039 LIKE type_t.chr500, 
   glaq040 LIKE type_t.chr500, 
   glaq041 LIKE type_t.chr500, 
   glaq042 LIKE type_t.chr500, 
   glaq043 LIKE type_t.chr500, 
   glaq044 LIKE type_t.chr500, 
   state LIKE type_t.chr80, 
   amt LIKE type_t.chr500, 
   amt1 LIKE type_t.chr500, 
   amt2 LIKE type_t.chr500, 
   amt3 LIKE type_t.chr500 
       END RECORD
 
 
#模組變數(Module Variables)
DEFINE g_master                     type_g_glaq_d
DEFINE g_master_t                   type_g_glaq_d
DEFINE g_glaq_d          DYNAMIC ARRAY OF type_g_glaq_d
DEFINE g_glaq_d_t        type_g_glaq_d
 
      
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num5              
DEFINE l_ac_d               LIKE type_t.num5              #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num5              #目前所在頁數
DEFINE g_detail_cnt         LIKE type_t.num5              #單身 總筆數(所有資料)
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num5
DEFINE g_detail_idx         LIKE type_t.num5
DEFINE g_detail_idx2        LIKE type_t.num5
DEFINE g_hyper_url          STRING                        #hyperlink的主要網址
 
 
#多table用wc
DEFINE g_wc_table           STRING
 
 
 
DEFINE g_wc_filter_table           STRING
 
 
 
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
</section>
  <section id="aglq770.init" ver="1" status="" src="s">
<![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION aglq770_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
   
   
   
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
</section>
  <section id="aglq770.insert" ver="1" status="" src="s">
<![CDATA[#+ insert
PRIVATE FUNCTION aglq770_insert()
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point
 
   #add-point:insert段control
   {<point name="insert.control"/>}
   #end add-point    
   
END FUNCTION
]]>
</section>
  <section id="aglq770.main" ver="2" status="" src="s">
<![CDATA[#+ 此段落由子樣板a26產生
#OPTIONS SHORT CIRCUIT
#+ 作業開始 
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point   
 
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("agl","")
 
   #add-point:作業初始化
   {<point name="main.init" />}
   #end add-point
   
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = ""
   #add-point:SQL_define
   {<point name="main.after_define_sql"/>}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   DECLARE aglq770_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT UNIQUE ",
               " FROM ",
               " WHERE  "
   #add-point:SQL_define
   {<point name="main.after_refresh_sql"/>}
   #end add-point
   PREPARE aglq770_master_referesh FROM g_sql
 
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
 
   ELSE
      
      #畫面開啟 (identifier)
      OPEN WINDOW w_aglq770 WITH FORM cl_ap_formpath("agl",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL aglq770_init()   
 
      #進入選單 Menu (="N")
      CALL aglq770_ui_dialog() 
      
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_aglq770
      
   END IF 
   
   CLOSE aglq770_cl
   
   
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
   
END MAIN
 
 
]]>
</section>
  <section id="aglq770.modify" ver="1" status="" src="s">
<![CDATA[#+ modify
PRIVATE FUNCTION aglq770_modify()
   #add-point:modify段define
   {<point name="modify.define"/>}
   #end add-point
 
   #add-point:modify段control
   {<point name="modify.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq770.other_function" ver="1" status="" src="s">
<![CDATA[{<point name="other.function"/>}
]]>
</section>
  <section id="aglq770.reproduce" ver="1" status="" src="s">
<![CDATA[#+ reproduce
PRIVATE FUNCTION aglq770_reproduce()
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point
 
   #add-point:reproduce段control
   {<point name="reproduce.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
</add_points>