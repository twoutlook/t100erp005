<add_points prog="aglq720" std_prog="aglq720" erpver="1.0" module="AGL" ver="1" env="s" zone="t10dev" booking="Y">
  <point name="construct.c.page1.b_glar001" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
			LET g_qryparam.where = "glac001 = '",g_glaa004,"' AND glac006 = '1'"
            CALL aglt310_04()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar001  #顯示到畫面上

            NEXT FIELD b_glar001                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar009" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooai001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar009  #顯示到畫面上

            NEXT FIELD b_glar009                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar012" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar012  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO ooefl003 #說明(簡稱) 

            NEXT FIELD b_glar012                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar013" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar013  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO ooeg001 #部門編號 

            NEXT FIELD b_glar013                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar014" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar014  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO ooeg001 #部門編號 

            NEXT FIELD b_glar014                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar015" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar015  #顯示到畫面上

            NEXT FIELD b_glar015                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar016" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar016  #顯示到畫面上

            NEXT FIELD b_glar016                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar017" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar017  #顯示到畫面上

            NEXT FIELD b_glar017                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar018" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar018  #顯示到畫面上

            NEXT FIELD b_glar018                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar019" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_rtax001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar019  #顯示到畫面上

            NEXT FIELD b_glar019                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar020" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar020  #顯示到畫面上
               #DISPLAY g_qryparam.return2 TO oofa011 #全名 

            NEXT FIELD b_glar020                     #返回原欄位

]]>
</point>
  <point name="construct.c.page1.b_glar021" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_bgaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_glar021  #顯示到畫面上

            NEXT FIELD b_glar021                     #返回原欄位

]]>
</point>
  <point name="input.a.page1.glar001" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glar002" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glar003" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glar004" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="input.a.page1.glarld" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a05產生
            IF  g_glar_d[g_detail_idx].glarld IS NOT NULL AND g_glar_d[g_detail_idx].glar001 IS NOT NULL AND g_glar_d[g_detail_idx].glar002 IS NOT NULL AND g_glar_d[g_detail_idx].glar003 IS NOT NULL AND g_glar_d[g_detail_idx].glar004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_glar_d[g_detail_idx].glarld != g_glar_d_t.glarld OR g_glar_d[g_detail_idx].glar001 != g_glar_d_t.glar001 OR g_glar_d[g_detail_idx].glar002 != g_glar_d_t.glar002 OR g_glar_d[g_detail_idx].glar003 != g_glar_d_t.glar003 OR g_glar_d[g_detail_idx].glar004 != g_glar_d_t.glar004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM glar_t WHERE "||"glarent = '" ||g_enterprise|| "' AND "||"glarld = '"||g_glar_d[g_detail_idx].glarld ||"' AND "|| "glar001 = '"||g_glar_d[g_detail_idx].glar001 ||"' AND "|| "glar002 = '"||g_glar_d[g_detail_idx].glar002 ||"' AND "|| "glar003 = '"||g_glar_d[g_detail_idx].glar003 ||"' AND "|| "glar004 = '"||g_glar_d[g_detail_idx].glar004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
</point>
  <point name="function.aglq720_create_temp_table" cite_std="N" status="" ver="1" src="s" new="Y" order="1" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 建立臨時表
# Memo...........:
# Usage..........: CALL aglq720_create_temp_table()
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_create_temp_table()
   DROP TABLE aglq720_tmp
   CREATE TEMP TABLE aglq720_tmp(
   glar001      VARCHAR(24),
   glar012      VARCHAR(10),
   glar013      VARCHAR(10),
   glar014      VARCHAR(10),
   glar015      VARCHAR(10),
   glar016      VARCHAR(10),
   glar017      VARCHAR(10),
   glar018      VARCHAR(10),
   glar019      VARCHAR(10),
   glar020      VARCHAR(10),
   glar021      VARCHAR(10),
   glar022      VARCHAR(10),
   glar023      VARCHAR(30),
   glar009      VARCHAR(10),
   oyeard       DECIMAL(20,6),
   oyearc       DECIMAL(20,6),
   yeard        DECIMAL(20,6),
   yearc        DECIMAL(20,6),
   yeard2       DECIMAL(20,6),
   yearc2       DECIMAL(20,6),
   yeard3       DECIMAL(20,6),
   yearc3       DECIMAL(20,6),
   oqcd         DECIMAL(20,6),
   oqcc         DECIMAL(20,6),
   qcd          DECIMAL(20,6),
   qcc          DECIMAL(20,6),
   qcd2         DECIMAL(20,6),
   qcc2         DECIMAL(20,6),
   qcd3         DECIMAL(20,6),
   qcc3         DECIMAL(20,6),
   oqjd         DECIMAL(20,6),
   oqjc         DECIMAL(20,6),
   qjd          DECIMAL(20,6),
   qjc          DECIMAL(20,6),
   qjd2         DECIMAL(20,6),
   qjc2         DECIMAL(20,6),
   qjd3         DECIMAL(20,6),
   qjc3         DECIMAL(20,6),
   oqmd         DECIMAL(20,6),
   oqmc         DECIMAL(20,6),
   qmd          DECIMAL(20,6),
   qmc          DECIMAL(20,6),
   qmd2         DECIMAL(20,6),
   qmc2         DECIMAL(20,6),
   qmd3         DECIMAL(20,6),
   qmc3         DECIMAL(20,6),
   osumd        DECIMAL(20,6),
   osumc        DECIMAL(20,6),
   sumd         DECIMAL(20,6),
   sumc         DECIMAL(20,6),
   sumd2        DECIMAL(20,6),
   sumc2        DECIMAL(20,6),
   sumd3        DECIMAL(20,6),
   sumc3        DECIMAL(20,6))
END FUNCTION]]>
</point>
  <point name="function.aglq720_set_curr_show" cite_std="N" status="" ver="1" src="s" new="Y" order="2" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 設置本位幣二、別你幣三顯示否
# Memo...........:
# Usage..........: CALL aglq720_set_curr_show()
# Date & Author..: 2014/03/13 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_set_curr_show()
   #顯示本位幣二
   IF tm.ctype='1' THEN
      CALL cl_set_comp_visible("yeard2,yearc2,qcd2,qcc2,qjd2,qjc2,qmd2,qmc2,sumd2,sumc2",TRUE)
   ELSE
      CALL cl_set_comp_visible("yeard2,yearc2,qcd2,qcc2,qjd2,qjc2,qmd2,qmc2,sumd2,sumc2",FALSE)
   END IF
   #顯示本位幣三
   IF tm.ctype='2' THEN
      CALL cl_set_comp_visible("yeard3,yearc3,qcd3,qcc3,qjd3,qjc3,qmd3,qmc3,sumd3,sumc3",TRUE)
   ELSE
      CALL cl_set_comp_visible("yeard3,yearc3,qcd3,qcc3,qjd3,qjc3,qmd3,qmc3,sumd3,sumc3",FALSE)
   END IF
   #全部
   IF tm.ctype='3' THEN
      CALL cl_set_comp_visible("yeard2,yearc2,qcd2,qcc2,qjd2,qjc2,qmd2,qmc2,sumd2,sumc2",TRUE)
      CALL cl_set_comp_visible("yeard3,yearc3,qcd3,qcc3,qjd3,qjc3,qmd3,qmc3,sumd3,sumc3",TRUE)
   END IF
END FUNCTION]]>
</point>
  <point name="function.aglq720_glaald_desc" cite_std="N" status="" ver="1" src="s" new="Y" order="3" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 獲取帳套相關資料
# Memo...........:
# Usage..........: CALL aglq720_glaald_desc(p_glaald)
# Input parameter: p_glaald   帳套
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_glaald_desc(p_glaald)
   DEFINE  p_glaald    LIKE glaa_t.glaald
   
    INITIALIZE g_ref_fields TO NULL
    LET g_ref_fields[1] = p_glaald 
    CALL ap_ref_array2(g_ref_fields,"SELECT glaal002 FROM glaal_t WHERE glaalent='"||g_enterprise||"' AND glaalld=? AND glaal001='"||g_dlang||"'","") RETURNING g_rtn_fields
    LET g_glaald_desc=g_rtn_fields[1]
    #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
   SELECT glaacomp,glaa001,glaa002,glaa003,glaa004,glaa013,
          glaa015,glaa016,glaa017,glaa018,glaa019,glaa020,
          glaa021,glaa022 
     INTO g_glaacomp,g_glaa001,g_glaa002,g_glaa003,g_glaa004,g_glaa013,
          g_glaa015,g_glaa016,g_glaa017,g_glaa018,g_glaa019,g_glaa020,
          g_glaa021,g_glaa022
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_glaald 
   
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_glaacomp
   CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_glaacomp_desc= g_rtn_fields[1]
   
   #本位幣二
   IF g_glaa015='Y' THEN
      CALL cl_set_comp_visible("glaa016",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa016",FALSE)
   END IF
   #本位幣三
   IF g_glaa019='Y' THEN
      CALL cl_set_comp_visible("glaa020",TRUE)
   ELSE
      CALL cl_set_comp_visible("glaa020",FALSE)
   END IF 
   #多本位幣
   CALL cl_set_comp_visible("ctype",TRUE)
   CASE
      WHEN g_glaa015<>'Y' AND g_glaa019<>'Y' 
         CALL cl_set_comp_visible("ctype",FALSE)
         LET tm.ctype=''
      WHEN g_glaa015='Y' AND g_glaa019<>'Y' 
         CALL cl_set_combo_scc_part('ctype','9921','1')
         LET tm.ctype='1'
      WHEN g_glaa015<>'Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','2')
         LET tm.ctype='2'  
      WHEN g_glaa015='Y' AND g_glaa019='Y' 
         CALL cl_set_combo_scc_part('ctype','9921','1,2,3')
         LET tm.ctype='3'
   END CASE
   CALL aglq720_set_curr_show() #顯示本位幣二、本位幣三
END FUNCTION]]>
</point>
  <point name="function.aglq720_get_data" cite_std="N" status="u" ver="1" src="s" new="Y" order="4" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 抓取數據
# Memo...........:
# Usage..........: CALL aglq720_get_data()
# Date & Author..: 2014/03/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_get_data()
   DEFINE l_pdate_s1       LIKE glav_t.glav004 #起始年度+期別對應的起始截止日期
   DEFINE l_pdate_e1       LIKE glav_t.glav004
   DEFINE l_pdate_s2       LIKE glav_t.glav004 #截止年度+期別對應的起始截止日期
   DEFINE l_pdate_e2       LIKE glav_t.glav004
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_flag           LIKE type_t.num5    #表示是否是完整期別
   DEFINE l_sql,l_sql1,l_sql2   STRING
   DEFINE l_sql3,l_sql4         STRING
   DEFINE l_wc                  STRING 
   DEFINE l_glar001        LIKE glar_t.glar001
   DEFINE l_glar001_desc   LIKE glacl_t.glacl004
   DEFINE l_glar012        LIKE glar_t.glar012
   DEFINE l_glar013        LIKE glar_t.glar013
   DEFINE l_glar014        LIKE glar_t.glar014
   DEFINE l_glar015        LIKE glar_t.glar015
   DEFINE l_glar016        LIKE glar_t.glar016
   DEFINE l_glar017        LIKE glar_t.glar017
   DEFINE l_glar018        LIKE glar_t.glar018
   DEFINE l_glar019        LIKE glar_t.glar019
   DEFINE l_glar020        LIKE glar_t.glar020
   DEFINE l_glar021        LIKE glar_t.glar021
   DEFINE l_glar022        LIKE glar_t.glar022
   DEFINE l_glar023        LIKE glar_t.glar023
   DEFINE l_glar009        LIKE glar_t.glar009
   DEFINE l_oyeard         LIKE type_t.num20_6
   DEFINE l_oyearc         LIKE type_t.num20_6
   DEFINE l_yeard          LIKE type_t.num20_6
   DEFINE l_yearc          LIKE type_t.num20_6
   DEFINE l_yeard2         LIKE type_t.num20_6
   DEFINE l_yearc2         LIKE type_t.num20_6
   DEFINE l_yeard3         LIKE type_t.num20_6
   DEFINE l_yearc3         LIKE type_t.num20_6
   DEFINE l_oqcd           LIKE type_t.num20_6
   DEFINE l_oqcc           LIKE type_t.num20_6
   DEFINE l_qcd            LIKE type_t.num20_6
   DEFINE l_qcc            LIKE type_t.num20_6
   DEFINE l_qcd2           LIKE type_t.num20_6
   DEFINE l_qcc2           LIKE type_t.num20_6
   DEFINE l_qcd3           LIKE type_t.num20_6
   DEFINE l_qcc3           LIKE type_t.num20_6
   DEFINE l_oqjd           LIKE type_t.num20_6
   DEFINE l_oqjc           LIKE type_t.num20_6
   DEFINE l_qjd            LIKE type_t.num20_6
   DEFINE l_qjc            LIKE type_t.num20_6
   DEFINE l_qjd2           LIKE type_t.num20_6
   DEFINE l_qjc2           LIKE type_t.num20_6
   DEFINE l_qjd3           LIKE type_t.num20_6
   DEFINE l_qjc3           LIKE type_t.num20_6
   DEFINE l_oqmd           LIKE type_t.num20_6
   DEFINE l_oqmc           LIKE type_t.num20_6
   DEFINE l_qmd            LIKE type_t.num20_6
   DEFINE l_qmc            LIKE type_t.num20_6
   DEFINE l_qmd2           LIKE type_t.num20_6
   DEFINE l_qmc2           LIKE type_t.num20_6
   DEFINE l_qmd3           LIKE type_t.num20_6
   DEFINE l_qmc3           LIKE type_t.num20_6
   DEFINE l_osumd          LIKE type_t.num20_6
   DEFINE l_osumc          LIKE type_t.num20_6
   DEFINE l_sumd           LIKE type_t.num20_6
   DEFINE l_sumc           LIKE type_t.num20_6
   DEFINE l_sumd2          LIKE type_t.num20_6
   DEFINE l_sumc2          LIKE type_t.num20_6
   DEFINE l_sumd3          LIKE type_t.num20_6
   DEFINE l_sumc3          LIKE type_t.num20_6
   DEFINE l_amt1           LIKE type_t.num20_6
   DEFINE l_amt2           LIKE type_t.num20_6
   DEFINE l_amt3           LIKE type_t.num20_6
   DEFINE l_amt4           LIKE type_t.num20_6
   DEFINE l_amt5           LIKE type_t.num20_6
   DEFINE l_amt6           LIKE type_t.num20_6
   DEFINE l_amt7           LIKE type_t.num20_6
   DEFINE l_amt8           LIKE type_t.num20_6
   DEFINE l_period         LIKE glap_t.glap004
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_str,l_str1,l_str2  STRING
   DEFINE l_num,l_i        LIKE type_t.num5
   DEFINE l_glac002        LIKE glac_t.glac002
   DEFINE l_flag2          LIKE type_t.num5
   DEFINE l_glav004        LIKE glav_t.glav004
   DEFINE l_glav004_m      LIKE glav_t.glav004
   DEFINE l_glav004_e      LIKE glav_t.glav004
   
   #刪除臨時表中資料
   DELETE FROM aglq720_tmp
   
   CALL s_get_accdate(g_glaa003,'',tm.syear,tm.speriod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s1,l_pdate_e1,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      CALL cl_err('',l_errno,0)
   END IF

   CALL s_get_accdate(g_glaa003,'',tm.eyear,tm.eperiod) 
   RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s2,l_pdate_e2,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag1='N' THEN
      CALL cl_err('',l_errno,0)
   END IF

   #判斷是否是整期間查詢
   IF tm.sdate=l_pdate_s1 AND tm.edate=l_pdate_e2 THEN
      LET l_flag=TRUE
   ELSE
      LET l_flag=FALSE
   END IF
   #核算項條件篩選
   LET l_wc=cl_replace_str(g_wc,'glar001','glaq002')
   LET l_wc=cl_replace_str(l_wc,'glar009','glaq005')
   LET l_wc=cl_replace_str(l_wc,'glar012','glaq017')
   LET l_wc=cl_replace_str(l_wc,'glar013','glaq018')
   LET l_wc=cl_replace_str(l_wc,'glar014','glaq019')
   LET l_wc=cl_replace_str(l_wc,'glar015','glaq020')
   LET l_wc=cl_replace_str(l_wc,'glar016','glaq021')
   LET l_wc=cl_replace_str(l_wc,'glar017','glaq022')
   LET l_wc=cl_replace_str(l_wc,'glar018','glaq023')
   LET l_wc=cl_replace_str(l_wc,'glar019','glaq024')
   LET l_wc=cl_replace_str(l_wc,'glar020','glaq025')
   LET l_wc=cl_replace_str(l_wc,'glar021','glaq026')
   LET l_wc=cl_replace_str(l_wc,'glar022','glaq027')
   LET l_wc=cl_replace_str(l_wc,'glar023','glaq028')
   
   LET l_num =g_wc.getIndexOf('glar001',1)
   IF l_num>0 THEN
      LET l_i=g_wc.getIndexOf('and',1)
      IF l_i=0 THEN
         LET l_sql1=g_wc
      ELSE
         LET l_sql1=g_wc.substring(l_num,l_i-1) 
      END IF
      LET l_sql1=" AND ",cl_replace_str(l_sql1,'glar001','glac002')
   END IF
   #顯示統制科目否
   IF tm.show_acc<>'Y' THEN
      LET l_sql1=l_sql1," AND glac003<>'1' "
   END IF
   #科目層級
   IF NOT cl_null(tm.glac005) THEN
      LET l_sql1=l_sql1," AND glac005<=",tm.glac005
   END IF
   #含內部管理科目否
   IF tm.glac009<>'Y' THEN
      LET l_sql1=l_sql1," AND glac009<>'Y' "
   END IF
   
   #顯示月結CE憑證否
   IF tm.show_ce<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'CE' "
      LET l_sql3="'CE'"
   END IF
   #顯示年結YE憑證否
   IF tm.show_ye<>'Y' THEN
      LET l_sql2=l_sql2," AND glap007<>'YE' "
      IF NOT cl_null(l_sql3) THEN
         LET l_sql3=l_sql3,",'YE'"
      ELSE
         LET l_sql3="'YE'" 
      END IF
   END IF
   IF NOT cl_null(l_sql3) THEN
      LET l_sql3=" AND glap007 IN (",l_sql3,")"
   END IF
   #單據狀態
   CASE
      WHEN tm.stus='1'
         LET l_sql4=l_sql4," AND glapstus='S' "
      WHEN tm.stus='2'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y') "
      WHEN tm.stus='3'
         LET l_sql4=l_sql4," AND glapstus IN ('S','Y','N') "
   END CASE
   #核算項
   CALL aglq720_fix_acc_get_sql() RETURNING l_str,l_str1,l_str2
   
   #抓出所有符合條件的會計科目
   LET g_sql="SELECT glac002 FROM glac_t",
             " WHERE glacent=",g_enterprise,
             "   AND glac001='",g_glaa004,"' ",l_sql1,
             " ORDER BY glac002"
   PREPARE aglq720_sel_glac_pr FROM g_sql
   DECLARE aglq720_sel_glac_cs CURSOR FOR aglq720_sel_glac_pr
   
   #判斷是否勾選原幣或核算項等
   LET l_num =l_str.getIndexOf('g',1)
   IF l_num>0 THEN 
      LET l_flag2=TRUE #表示勾選了顯示原幣或核算項
      IF l_flag=TRUE THEN
         LET l_sql="(SELECT ",l_str,
                   "   FROM glar_t",
                   "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' AND glar001=?"
         IF tm.syear<>tm.eyear THEN
            LET l_sql=l_sql," AND ((glar002=",tm.syear,") ",
                            "  OR (glar002=",tm.eyear," AND glar003<=",tm.eperiod," AND glar003<>0)) "
         ELSE
            LET l_sql=l_sql," AND glar002=",tm.syear,
                            " AND glar003<=",tm.eperiod
         END IF
         LET l_sql=l_sql," AND ",g_wc,")"  
         #單據狀態      
         IF tm.stus MATCHES '[23]' THEN
            LET l_sql=l_sql,
                      " UNION ALL ",
                      "(SELECT ",l_str2,
                      "   FROM glaq_t",
                      "  INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                      "  WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
#                      "    AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
                      "    AND glapdocdt <='",tm.edate,"' AND glap002>=",tm.syear
            CASE
                WHEN tm.stus='2'
                   LET l_sql=l_sql," AND glapstus='Y'"
                WHEN tm.stus='3'
                   LET l_sql=l_sql," AND glapstus IN ('Y','N')"
            END CASE
            LET l_sql=l_sql,l_sql2," AND ",l_wc,")"
         END IF
         LET l_sql="SELECT ",l_str,
                   "  FROM (",l_sql,")",
                   " ORDER BY ",l_str
      ELSE 
         LET l_sql="SELECT ",l_str1,
                   "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                   " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
#                   "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
                   "    AND glapdocdt <='",tm.edate,"' AND glap002>=",tm.syear
         LET l_sql=l_sql,l_sql2,l_sql4," AND ",l_wc,
                   " ORDER BY ",l_str1
      END IF
      PREPARE aglq720_sel_pr FROM l_sql
      DECLARE aglq720_sel_cr CURSOR FOR aglq720_sel_pr
   ELSE
      #年初，期初
      LET l_sql="SELECT SUM(glar010-glar011),SUM(glar005-glar006),SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
                 " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
                 "   AND glar001=? AND glar002=? AND glar003<=? "
       PREPARE aglq720_sel_pr01 FROM l_sql
       
       #期初：抓取CE、YE憑證金額
       LET l_sql="SELECT SUM(CASE WHEN glaq003=0 THEN glaq010*-1 ELSE glaq010 END),",
                  "      SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                  "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                  " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                  "   AND glap002=？ AND glap004<=? ",
                  "   AND glaq002 LIKE ? ",
                  "   AND glapstus='S' ",
                  "   AND ",l_wc,l_sql3
       PREPARE aglq720_sel_pr06 FROM l_sql  
            
       #破期时年初、期初根據傳票狀態（1、2、3）抓取資料
       LET l_sql="SELECT SUM(CASE WHEN glaq003=0 THEN glaq010*-1 ELSE glaq010 END),",
                  "      SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                  "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                  " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                  "   AND glapdocdt BETWEEN ? AND ? ",
                  "   AND glaq002 LIKE ? ",
                  "   AND ",l_wc,l_sql2,l_sql4
       PREPARE aglq720_sel_pr02 FROM l_sql  
       
       #本年累計
       LET l_sql="SELECT SUM(glar010),SUM(glar011),SUM(glar005),SUM(glar006),",
                 "       SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037) FROM glar_t",    
                 " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
                 "   AND glar001=? AND glar002=? AND glar003<=? "
       PREPARE aglq720_sel_pr03 FROM l_sql
       
       #本年累計：抓取CE、YE憑證金額
       LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
                 "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
                 "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                 "       SUM(glaq043),SUM(glaq044) ",
                 "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                 " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                 "   AND glap002= ? AND glap004<=? ",
                 "   AND glaq002 LIKE ? ",
                 "   AND glapstus='S' ",
                 "   AND ",l_wc,l_sql3
       PREPARE aglq720_sel_pr07 FROM l_sql
       
       #破期本年累計
       LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
                 "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
                 "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                 "       SUM(glaq043),SUM(glaq044) ",
                 "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                 " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                 "   AND glapdocdt BETWEEN ? AND ? ",
                 "   AND glaq002 LIKE ? ",
                 "   AND ",l_wc,l_sql2,l_sql4
       PREPARE aglq720_sel_pr04 FROM l_sql
       
       #期間異動
       IF l_flag=TRUE THEN
          LET l_sql="(SELECT glar010,glar011,glar005,",
                    "        glar006,glar034,glar035,glar036,glar037",
                    "   FROM glar_t",
                    "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' AND glar001=?"
          IF tm.syear<>tm.eyear THEN
             LET l_sql=l_sql," AND ((glar002=",tm.syear," AND glar003>=",tm.speriod,") ",
                             "  OR (glar002=",tm.eyear," AND glar003<=",tm.eperiod," AND glar003<>0)) "
          ELSE
             LET l_sql=l_sql," AND glar002=",tm.syear,
                             " AND glar003 BETWEEN ",tm.speriod," AND ",tm.eperiod
          END IF
          LET l_sql=l_sql," AND ",g_wc,")"  
          #單據狀態      
          IF tm.stus MATCHES '[23]' THEN
             LET l_sql=l_sql,
                       " UNION ALL ",
                       "(SELECT (CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END) glar010,",
                       "        (CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END) glar011,",
                       "        glaq003 glar005,glaq004 glar006,glaq040 glar034,",
                       "        glaq041 glar035,glaq043 glar036,glaq044 glar037",
                       "   FROM glaq_t",
                       "  INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                       "  WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                       "    AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
             CASE
                 WHEN tm.stus='2'
                    LET l_sql=l_sql," AND glapstus='Y'"
                 WHEN tm.stus='3'
                    LET l_sql=l_sql," AND glapstus IN ('Y','N')"
             END CASE
             LET l_sql=l_sql,l_sql2," AND ",l_wc,")"
          END IF
          LET l_sql="SELECT SUM(glar010),SUM(glar011),SUM(glar005),",
                    "       SUM(glar006),SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037)",
                    "  FROM (",l_sql,")"
       ELSE 
          LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
                    "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
                    "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                    "       SUM(glaq043),SUM(glaq044)",
                    "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                    " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                    "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'",
                    l_sql2,l_sql4," AND ",l_wc
       END IF 
       PREPARE aglq720_sel_pr05 FROM l_sql
       
       #期間異動：抓取CE、YE憑證金額
       LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
                 "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
                 "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                 "       SUM(glaq043),SUM(glaq044)",
                 "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                 " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                 "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'",
                 l_sql3," AND glapstus='S' AND ",l_wc
      PREPARE aglq720_sel_pr08 FROM l_sql
   END IF
   CALL cl_showmsg_init()
   LET l_success = TRUE
   
   #抓取該年第一天
   SELECT MIN(glav004) INTO l_glav004 FROM glav_t
    WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=tm.syear
   #抓取上一期最後一天
   LET l_period=tm.speriod-1 #上期
   SELECT MAX(glav004) INTO l_glav004_m FROM glav_t
    WHERE glavent=g_enterprise AND glav001=g_glaa003 AND glav002=tm.syear AND glav006=l_period
   #获取期初截止日期
   IF tm.sdate=l_pdate_s1 THEN
      LET l_glav004_e=l_glav004_m
   ELSE
      LET l_glav004_e=tm.sdate-1
   END IF
   
   #科目遍歷
   FOREACH aglq720_sel_glac_cs INTO l_glac002
      IF SQLCA.sqlcode THEN
         CALL cl_errmsg('','FOREACH aglq720_sel_glac_cs','',SQLCA.sqlcode,1)
         LET l_success = FALSE
         EXIT FOREACH
      END IF
      LET l_glar001=l_glac002,"%"
      #當勾選了顯示原幣或核算項等條件后，依勾選條件遍歷查詢資料
      IF l_flag2=TRUE THEN
         IF l_flag=TRUE THEN
            IF tm.stus MATCHES '[23]' THEN
               OPEN aglq720_sel_cr USING l_glac002,l_glar001
            ELSE
               OPEN aglq720_sel_cr USING l_glac002
            END IF
         ELSE
            OPEN aglq720_sel_cr USING l_glar001
         END IF
         #原幣及核算項遍歷
         FOREACH aglq720_sel_cr INTO l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
                                     l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022,l_glar009
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','FOREACH aglq720_sel_cr','',SQLCA.sqlcode,1)
               LET l_success = FALSE
               EXIT FOREACH
            END IF
            
            CALL aglq720_fix_acc_sql(l_glar009,l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
                                     l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar022)
            RETURNING l_str,l_str1
            #年初、期初
            LET l_sql="SELECT SUM(glar010-glar011),SUM(glar005-glar006),SUM(glar034-glar035),SUM(glar036-glar037) FROM glar_t",    
                      " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
                      "   AND glar001=? AND glar002=? AND glar003<=? ",
                      l_str
            PREPARE aglq720_sel_pr1 FROM l_sql
            
            #期初：抓取CE、YE傳票金額
            LET l_sql="SELECT SUM(CASE WHEN glaq003=0 THEN glaq010*-1 ELSE glaq010 END),",
                       "      SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                       "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                       " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                       "   AND glap002= ? AND glap004<=? AND glapstus='S' ",
                       "   AND glaq002 LIKE ? ",l_str1,
                       "   AND ",l_wc,l_sql3
            PREPARE aglq720_sel_pr6 FROM l_sql
            
            #破期時年初、期初根據傳票狀態（1、2、3）抓取資料
            LET l_sql="SELECT SUM(CASE WHEN glaq003=0 THEN glaq010*-1 ELSE glaq010 END),",
                       "      SUM(glaq003-glaq004),SUM(glaq040-glaq041),SUM(glaq043-glaq044) ",
                       "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                       " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                       "   AND glapdocdt BETWEEN ? AND ? ",
                       "   AND glaq002 LIKE ? ",l_str1,
                       "   AND ",l_wc,l_sql2,l_sql4
            PREPARE aglq720_sel_pr2 FROM l_sql 
            
            #本年累計
            LET l_sql="SELECT SUM(glar010),SUM(glar011),SUM(glar005),SUM(glar006),",
                      "       SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037) FROM glar_t",    
                      " WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' ",
                      "   AND glar001=? AND glar002=? AND glar003<=? ",
                      l_str
            PREPARE aglq720_sel_pr3 FROM l_sql
            
            #本年累計：抓取CE、YE憑證金額
            LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
                      "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
                      "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                      "       SUM(glaq043),SUM(glaq044) ",
                      "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                      " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                      "   AND glap002= ? AND glap004<=? AND glapstus='S' ",
                      "   AND glaq002 LIKE ? ",l_str1,
                      "   AND ",l_wc,l_sql3
            PREPARE aglq720_sel_pr7 FROM l_sql
            
            #破期本年累計
            LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END),",
                      "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END),",
                      "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                      "       SUM(glaq043),SUM(glaq044) ",
                      "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                      " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' ",
                      "   AND glapdocdt BETWEEN ? AND ? ",
                      "   AND glaq002 LIKE ? ",l_str1,
                      "   AND ",l_wc,l_sql2,l_sql4
            PREPARE aglq720_sel_pr4 FROM l_sql
            
            #期間異動
            IF l_flag=TRUE THEN
               LET l_sql="(SELECT glar010,glar011,glar005,",
                         "        glar006,glar034,glar035,glar036,glar037",
                         "   FROM glar_t",
                         "  WHERE glarent=",g_enterprise," AND glarld='",g_glaald,"' AND glar001=?"
               IF tm.syear<>tm.eyear THEN
                  LET l_sql=l_sql," AND ((glar002=",tm.syear," AND glar003>=",tm.speriod,") ",
                                  "  OR (glar002=",tm.eyear," AND glar003<=",tm.eperiod," AND glar003<>0)) "
               ELSE
                  LET l_sql=l_sql," AND glar002=",tm.syear,
                                  " AND glar003 BETWEEN ",tm.speriod," AND ",tm.eperiod
               END IF
               LET l_sql=l_sql,l_str," AND ",g_wc,")"  
               #單據狀態      
               IF tm.stus MATCHES '[23]' THEN
                  LET l_sql=l_sql,
                            " UNION ALL ",
                            "(SELECT (CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END) glar010,",
                            "        (CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END) glar011,",
                            "        glaq003 glar005,glaq004 glar006,glaq040 glar034,",
                            "        glaq041 glar035,glaq043 glar036,glaq044 glar037",
                            "   FROM glaq_t",
                            "  INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                            "  WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                            "    AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'"
                  CASE
                      WHEN tm.stus='2'
                         LET l_sql=l_sql," AND glapstus='Y'"
                      WHEN tm.stus='3'
                         LET l_sql=l_sql," AND glapstus IN ('Y','N')"
                  END CASE
                  LET l_sql=l_sql,l_sql2,l_str1," AND ",l_wc,")"
               END IF
               LET l_sql="SELECT SUM(glar010),SUM(glar011),SUM(glar005),",
                         "       SUM(glar006),SUM(glar034),SUM(glar035),SUM(glar036),SUM(glar037)",
                         "  FROM (",l_sql,")"
            ELSE 
               LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
                         "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
                         "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                         "       SUM(glaq043),SUM(glaq044)",
                         "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                         " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                         "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"'",
                         l_sql2,l_sql4,l_str1," AND ",l_wc
            END IF 
            PREPARE aglq720_sel_pr5 FROM l_sql
            
            #期間異動：抓取CE、YE憑證金額
            LET l_sql="SELECT SUM(CASE WHEN glaq003>0 THEN glaq010 ELSE 0 END ),",
                      "       SUM(CASE WHEN glaq003=0 THEN glaq010 ELSE 0 END ),",
                      "       SUM(glaq003),SUM(glaq004),SUM(glaq040),SUM(glaq041),",
                      "       SUM(glaq043),SUM(glaq044)",
                      "  FROM glaq_t INNER JOIN glap_t ON glapld = glaqld AND glapdocno = glaqdocno ",
                      " WHERE glaqent=",g_enterprise," AND glaqld='",g_glaald,"' AND glaq002 LIKE ?",
                      "   AND glapdocdt BETWEEN '",tm.sdate,"' AND '",tm.edate,"' AND glapstus='S' ",
                      l_sql3,l_str1," AND ",l_wc
            PREPARE aglq720_sel_pr8 FROM l_sql
            
            #年初金額
            IF tm.show_y='Y' THEN
               LET l_period=0
               EXECUTE aglq720_sel_pr1 USING l_glac002,tm.syear,l_period
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr1','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               IF l_amt2>0 THEN
                  LET l_oyeard=l_amt1
                  LET l_oyearc=0
                  LET l_yeard =l_amt2
                  LET l_yearc =0
                  LET l_yeard2=l_amt3
                  LET l_yearc2=0
                  LET l_yeard3=l_amt4
                  LET l_yearc3=0
               ELSE
                  LET l_oyeard=0
                  LET l_oyearc=-1*l_amt1
                  LET l_yeard =0
                  LET l_yearc =-1*l_amt2
                  LET l_yeard2=0
                  LET l_yearc2=-1*l_amt3
                  LET l_yeard3=0
                  LET l_yearc3=-1*l_amt4
               END IF 
            ELSE
               LET l_oyeard=0
               LET l_oyearc=0
               LET l_yeard =0
               LET l_yearc =0
               LET l_yeard2=0
               LET l_yearc2=0
               LET l_yeard3=0
               LET l_yearc3=0
            END IF
      
            #期初金額
            LET l_amt1=0
            LET l_amt2=0
            LET l_amt3=0
            LET l_amt4=0
            LET l_amt5=0
            LET l_amt6=0
            LET l_amt7=0
            LET l_amt8=0
            LET l_period=tm.speriod-1 #上期
            #當整期間且傳狀態為stus=1:已過帳時，抓取匯總glar_t,否則抓取資料來源為glaq_t
            IF tm.sdate=l_pdate_s1 AND tm.stus='1' THEN
               EXECUTE aglq720_sel_pr1 USING l_glac002,tm.syear,l_period
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr1','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               #當不包含CE或YE憑證時，減去CE或YE傳票金額
               IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
                  EXECUTE aglq720_sel_pr6 USING tm.syear,l_period,l_glar001
                                           INTO l_amt5,l_amt6,l_amt7,l_amt8
                  IF SQLCA.sqlcode THEN
                     CALL cl_errmsg('','aglq720_sel_pr6','',SQLCA.sqlcode,1)
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
                  IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
                  IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
                  LET l_amt1=l_amt1-l_amt5
                  LET l_amt2=l_amt2-l_amt6
                  LET l_amt3=l_amt3-l_amt7
                  LET l_amt4=l_amt4-l_amt8
               END IF
            #當為破期時，匯總該年第一天到查詢條件的起始日期tm.sdate的傳票資料
            ELSE
               #抓取年初金額
               LET l_period=0
               EXECUTE aglq720_sel_pr1 USING l_glac002,tm.syear,l_period
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr1','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               
               LET l_period=tm.speriod-1 #上期
               IF l_period>0 THEN
                  EXECUTE aglq720_sel_pr2 USING l_glav004,l_glav004_e,l_glar001
                                           INTO l_amt5,l_amt6,l_amt7,l_amt8
                  IF SQLCA.sqlcode THEN
                     CALL cl_errmsg('','aglq720_sel_pr2','',SQLCA.sqlcode,1)
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
                  IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
                  IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
                  LET l_amt1=l_amt1+l_amt5
                  LET l_amt2=l_amt2+l_amt6
                  LET l_amt3=l_amt3+l_amt7
                  LET l_amt4=l_amt4+l_amt8
               END IF
            END IF
            
            IF l_amt2>0 THEN
               LET l_oqcd=l_amt1
               LET l_oqcc=0
               LET l_qcd =l_amt2
               LET l_qcc =0
               LET l_qcd2=l_amt3
               LET l_qcc2=0
               LET l_qcd3=l_amt4
               LET l_qcc3=0
            ELSE
               LET l_oqcd=0
               LET l_oqcc=-1*l_amt1
               LET l_qcd =0
               LET l_qcc =-1*l_amt2
               LET l_qcd2=0
               LET l_qcc2=-1*l_amt3
               LET l_qcd3=0
               LET l_qcc3=-1*l_amt4
            END IF 
      
            #期間異動
            IF l_flag=TRUE THEN
               IF tm.stus MATCHES '[23]' THEN
                  EXECUTE aglq720_sel_pr5 USING l_glac002,l_glar001 
                                           INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
               ELSE
                  EXECUTE aglq720_sel_pr5 USING l_glac002 
                                           INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
               END IF
            ELSE
               EXECUTE aglq720_sel_pr5 USING l_glar001 
                                        INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
            END IF
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr5','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_oqjd) THEN LET l_oqjd=0 END IF
            IF cl_null(l_oqjc) THEN LET l_oqjc=0 END IF
            IF cl_null(l_qjd)  THEN LET l_qjd=0  END IF
            IF cl_null(l_qjc)  THEN LET l_qjc=0  END IF
            IF cl_null(l_qjd2) THEN LET l_qjd2=0 END IF
            IF cl_null(l_qjc2) THEN LET l_qjc2=0 END IF
            IF cl_null(l_qjd3) THEN LET l_qjd3=0 END IF
            IF cl_null(l_qjc3) THEN LET l_qjc3=0 END IF
            
            #當不包含CE或YE憑證時，減去CE或YE傳票金額
            IF l_flag=TRUE AND (tm.show_ce<>'Y' OR tm.show_ye<>'Y') THEN
               EXECUTE aglq720_sel_pr8 USING l_glar001 
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr8','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
               LET l_oqjd=l_oqjd-l_amt1
               LET l_oqjc=l_oqjc-l_amt2
               LET l_qjd =l_qjd -l_amt3
               LET l_qjc =l_qjc -l_amt4
               LET l_qjd2=l_qjd2-l_amt5
               LET l_qjc2=l_qjc2-l_amt6
               LET l_qjd3=l_qjd3-l_amt7
               LET l_qjc3=l_qjc3-l_amt8
            END IF
            #期末金額=期初+期間異動
            #原幣
            LET l_amt1=(l_oqcd+l_oqjd)-(l_oqcc+l_oqjc)
            IF l_amt1>0 THEN
               LET l_oqmd=l_amt1
               LET l_oqmc=0
            ELSE
               LET l_oqmd=0
               LET l_oqmc=l_amt1*-1
            END IF
            #本幣
            LET l_amt1=(l_qcd+l_qjd)-(l_qcc+l_qjc)
            IF l_amt1>0 THEN
               LET l_qmd=l_amt1
               LET l_qmc=0
            ELSE
               LET l_qmd=0
               LET l_qmc=l_amt1*-1
            END IF
            #本幣二
            LET l_amt1=(l_qcd2+l_qjd2)-(l_qcc2+l_qjc2)
            IF l_amt1>0 THEN
               LET l_qmd2=l_amt1
               LET l_qmc2=0
            ELSE
               LET l_qmd2=0
               LET l_qmc2=l_amt1*-1
            END IF
            #本幣三
            LET l_amt1=(l_qcd3+l_qjd3)-(l_qcc3+l_qjc3)
            IF l_amt1>0 THEN
               LET l_qmd3=l_amt1
               LET l_qmc3=0
            ELSE
               LET l_qmd3=0
               LET l_qmc3=l_amt1*-1
            END IF  

            #本年累計金額
            LET l_amt1=0
            LET l_amt2=0
            LET l_amt3=0
            LET l_amt4=0
            LET l_amt5=0
            LET l_amt6=0
            LET l_amt7=0
            LET l_amt8=0
            #當截止日期為該期最後一天，且傳票狀態為1：已過帳時，抓取glar_t餘額當資料,否則，直接抓取glaq_t傳票資料
            IF tm.edate=l_pdate_e2 AND tm.stus='1' THEN
               EXECUTE aglq720_sel_pr3 USING l_glac002,tm.eyear,tm.eperiod
                                        INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr3','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
               IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
               IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
               IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
               IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
               IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
               #當不包含CE或YE憑證時，減去CE或YE傳票金額
               IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
                  EXECUTE aglq720_sel_pr7 USING tm.eyear,tm.eperiod,l_glar001
                                           INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8  
                  IF SQLCA.sqlcode THEN
                     CALL cl_errmsg('','aglq720_sel_pr7','',SQLCA.sqlcode,1)
                     LET l_success = FALSE
                  END IF
                  IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
                  IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
                  IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
                  IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
                  IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
                  IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
                  IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
                  IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
                  LET l_osumd=l_osumd-l_amt1
                  LET l_osumc=l_osumc-l_amt2
                  LET l_sumd =l_sumd -l_amt3
                  LET l_sumc =l_sumc -l_amt4
                  LET l_sumd2=l_sumd2-l_amt5
                  LET l_sumc2=l_sumc2-l_amt6
                  LET l_sumd3=l_sumd3-l_amt7
                  LET l_sumc3=l_sumc3-l_amt8
               END IF
            ELSE
               #年初數
               LET l_period=0
               EXECUTE aglq720_sel_pr3 USING l_glac002,tm.eyear,l_period
                                        INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr3','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               #匯總該年第一天到查詢截止日期tm.edate
               EXECUTE aglq720_sel_pr4 USING l_glav004,tm.edate,l_glar001
                                        INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8  
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr4','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
               IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
               IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
               IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
               IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
               IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
               IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
               IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
               LET l_osumd=l_osumd+l_amt1
               LET l_osumc=l_osumc+l_amt2
               LET l_sumd =l_sumd +l_amt3
               LET l_sumc =l_sumc +l_amt4
               LET l_sumd2=l_sumd2+l_amt5
               LET l_sumc2=l_sumc2+l_amt6
               LET l_sumd3=l_sumd3+l_amt7
               LET l_sumc3=l_sumc3+l_amt8               
            END IF 
            
            IF l_yeard=0 AND l_yearc=0 AND  #年初數
               l_qcd=0 AND l_qcc=0 AND      #期初數
               l_qjd=0 AND l_qjc=0 AND      #期間異動
               l_qmd=0 AND l_qmc=0 AND      #期末
               l_sumd=0 AND l_sumc=0 THEN   #本年累計，以上全部等於0時該筆科目資料不顯示
               CONTINUE FOREACH
            END IF
            INSERT INTO aglq720_tmp 
            VALUES(l_glac002,l_glar012,l_glar013,l_glar014,l_glar015,l_glar016,l_glar017,
                   l_glar018,l_glar019,l_glar020,l_glar021,l_glar022,l_glar023,l_glar009,
                   l_oyeard,l_oyearc,l_yeard,l_yearc,l_yeard2,l_yearc2,l_yeard3,l_yearc3,
                   l_oqcd,l_oqcc,l_qcd,l_qcc,l_qcd2,l_qcc2,l_qcd3,l_qcc3,
                   l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3,
                   l_oqmd,l_oqmc,l_qmd,l_qmc,l_qmd2,l_qmc2,l_qmd3,l_qmc3,
                   l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3)
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
         END FOREACH
      ELSE
         #年初金額
         IF tm.show_y='Y' THEN
            LET l_period=0
            EXECUTE aglq720_sel_pr01 USING l_glac002,tm.syear,l_period
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr01','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            IF l_amt2>0 THEN
               LET l_oyeard=l_amt1
               LET l_oyearc=0
               LET l_yeard =l_amt2
               LET l_yearc =0
               LET l_yeard2=l_amt3
               LET l_yearc2=0
               LET l_yeard3=l_amt4
               LET l_yearc3=0
            ELSE
               LET l_oyeard=0
               LET l_oyearc=-1*l_amt1
               LET l_yeard =0
               LET l_yearc =-1*l_amt2
               LET l_yeard2=0
               LET l_yearc2=-1*l_amt3
               LET l_yeard3=0
               LET l_yearc3=-1*l_amt4
            END IF 
         ELSE
            LET l_oyeard=0
            LET l_oyearc=0
            LET l_yeard =0
            LET l_yearc =0
            LET l_yeard2=0
            LET l_yearc2=0
            LET l_yeard3=0
            LET l_yearc3=0
         END IF
      
         #期初金額
         LET l_amt1=0
         LET l_amt2=0
         LET l_amt3=0
         LET l_amt4=0
         LET l_amt5=0
         LET l_amt6=0
         LET l_amt7=0
         LET l_amt8=0
         LET l_period=tm.speriod-1
         IF tm.sdate=l_pdate_s1 AND tm.stus='1' THEN
            EXECUTE aglq720_sel_pr01 USING l_glac002,tm.syear,l_period
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr01','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            #當不包含CE或YE憑證時，減去CE或YE傳票金額
            IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
               EXECUTE aglq720_sel_pr06 USING tm.syear,l_period,l_glar001
                                        INTO l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr06','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
               LET l_amt1=l_amt1-l_amt5
               LET l_amt2=l_amt2-l_amt6
               LET l_amt3=l_amt3-l_amt7
               LET l_amt4=l_amt4-l_amt8
            END IF
         #當為破期時，匯總年初數+該年第一天到查詢開始前一天的傳票資料
         ELSE
            #年初數
            LET l_period=0
            EXECUTE aglq720_sel_pr01 USING l_glac002,tm.syear,l_period
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr01','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
         
            LET l_period=tm.speriod-1 #上期
            #匯總該年第一天到查詢開始前一天的傳票資料
            IF l_period>0 THEN
               EXECUTE aglq720_sel_pr02 USING l_glav004,l_glav004_e,l_glar001
                                        INTO l_amt5,l_amt6,l_amt7,l_amt8
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr02','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
               LET l_amt1=l_amt1+l_amt5
               LET l_amt2=l_amt2+l_amt6
               LET l_amt3=l_amt3+l_amt7
               LET l_amt4=l_amt4+l_amt8
            END IF
         END IF
         
         IF l_amt2>0 THEN
            LET l_oqcd=l_amt1
            LET l_oqcc=0
            LET l_qcd =l_amt2
            LET l_qcc =0
            LET l_qcd2=l_amt3
            LET l_qcc2=0
            LET l_qcd3=l_amt4
            LET l_qcc3=0
         ELSE
            LET l_oqcd=0
            LET l_oqcc=-1*l_amt1
            LET l_qcd =0
            LET l_qcc =-1*l_amt2
            LET l_qcd2=0
            LET l_qcc2=-1*l_amt3
            LET l_qcd3=0
            LET l_qcc3=-1*l_amt4
         END IF 
      
         #期間異動
         IF l_flag=TRUE THEN
            IF tm.stus MATCHES '[23]' THEN
               EXECUTE aglq720_sel_pr05 USING l_glac002,l_glar001 
                                        INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
            ELSE
               EXECUTE aglq720_sel_pr05 USING l_glac002 
                                        INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
            END IF
         ELSE
            EXECUTE aglq720_sel_pr05 USING l_glar001 
                                     INTO l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3
         END IF
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','aglq720_sel_pr05','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF         
         IF cl_null(l_oqjd) THEN LET l_oqjd=0 END IF
         IF cl_null(l_oqjc) THEN LET l_oqjc=0 END IF
         IF cl_null(l_qjd)  THEN LET l_qjd=0  END IF
         IF cl_null(l_qjc)  THEN LET l_qjc=0  END IF
         IF cl_null(l_qjd2) THEN LET l_qjd2=0 END IF
         IF cl_null(l_qjc2) THEN LET l_qjc2=0 END IF
         IF cl_null(l_qjd3) THEN LET l_qjd3=0 END IF
         IF cl_null(l_qjc3) THEN LET l_qjc3=0 END IF
         
         #當不包含CE或YE憑證時，減去CE或YE傳票金額
         IF l_flag=TRUE AND (tm.show_ce<>'Y' OR tm.show_ye<>'Y') THEN
            EXECUTE aglq720_sel_pr08 USING l_glar001 
                                      INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr08','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1) THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2) THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3) THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4) THEN LET l_amt4=0 END IF
            IF cl_null(l_amt5) THEN LET l_amt5=0 END IF
            IF cl_null(l_amt6) THEN LET l_amt6=0 END IF
            IF cl_null(l_amt7) THEN LET l_amt7=0 END IF
            IF cl_null(l_amt8) THEN LET l_amt8=0 END IF
            LET l_oqjd=l_oqjd-l_amt1
            LET l_oqjc=l_oqjc-l_amt2
            LET l_qjd =l_qjd -l_amt3
            LET l_qjc =l_qjc -l_amt4
            LET l_qjd2=l_qjd2-l_amt5
            LET l_qjc2=l_qjc2-l_amt6
            LET l_qjd3=l_qjd3-l_amt7
            LET l_qjc3=l_qjc3-l_amt8
         END IF
         
         #期末金額=期初+期間異動
         #原幣
         LET l_amt1=(l_oqcd+l_oqjd)-(l_oqcc+l_oqjc)
         IF l_amt1>0 THEN
            LET l_oqmd=l_amt1
            LET l_oqmc=0
         ELSE
            LET l_oqmd=0
            LET l_oqmc=l_amt1*-1
         END IF
         #本幣
         LET l_amt1=(l_qcd+l_qjd)-(l_qcc+l_qjc)
         IF l_amt1>0 THEN
            LET l_qmd=l_amt1
            LET l_qmc=0
         ELSE
            LET l_qmd=0
            LET l_qmc=l_amt1*-1
         END IF
         #本幣二
         LET l_amt1=(l_qcd2+l_qjd2)-(l_qcc2+l_qjc2)
         IF l_amt1>0 THEN
            LET l_qmd2=l_amt1
            LET l_qmc2=0
         ELSE
            LET l_qmd2=0
            LET l_qmc2=l_amt1*-1
         END IF
         #本幣三
         LET l_amt1=(l_qcd3+l_qjd3)-(l_qcc3+l_qjc3)
         IF l_amt1>0 THEN
            LET l_qmd3=l_amt1
            LET l_qmc3=0
         ELSE
            LET l_qmd3=0
            LET l_qmc3=l_amt1*-1
         END IF  

         #本年累計金額
         LET l_amt1=0
         LET l_amt2=0
         LET l_amt3=0
         LET l_amt4=0
         LET l_amt5=0
         LET l_amt6=0
         LET l_amt7=0
         LET l_amt8=0
         IF tm.edate=l_pdate_e2 THEN
            EXECUTE aglq720_sel_pr03 USING l_glac002,tm.eyear,tm.eperiod
                                     INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr03','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
            IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
            IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
            IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
            IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
            IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
            #當不包含CE或YE憑證時，減去CE或YE傳票金額
            IF tm.show_ce<>'Y' OR tm.show_ye<>'Y' THEN
               EXECUTE aglq720_sel_pr07 USING tm.eyear,tm.eperiod,l_glar001
                                         INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8  
               IF SQLCA.sqlcode THEN
                  CALL cl_errmsg('','aglq720_sel_pr07','',SQLCA.sqlcode,1)
                  LET l_success = FALSE
               END IF
               IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
               IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
               IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
               IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
               IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
               IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
               IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
               IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
               LET l_osumd=l_osumd-l_amt1
               LET l_osumc=l_osumc-l_amt2
               LET l_sumd =l_sumd -l_amt3
               LET l_sumc =l_sumc -l_amt4
               LET l_sumd2=l_sumd2-l_amt5
               LET l_sumc2=l_sumc2-l_amt6
               LET l_sumd3=l_sumd3-l_amt7
               LET l_sumc3=l_sumc3-l_amt8
            END IF
         ELSE
            #年初数
            LET l_period=0
            EXECUTE aglq720_sel_pr03 USING l_glac002,tm.eyear,l_period
                                     INTO l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr03','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_osumd) THEN LET l_osumd=0 END IF
            IF cl_null(l_osumc) THEN LET l_osumc=0 END IF
            IF cl_null(l_sumd)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumc)  THEN LET l_sumd=0  END IF
            IF cl_null(l_sumd2) THEN LET l_sumd2=0 END IF
            IF cl_null(l_sumc2) THEN LET l_sumc2=0 END IF
            IF cl_null(l_sumd3) THEN LET l_sumd3=0 END IF
            IF cl_null(l_sumc3) THEN LET l_sumc3=0 END IF
            #匯總該年第一天到查詢截止日期tm.edate
            EXECUTE aglq720_sel_pr04 USING l_glav004,tm.edate,l_glar001
                                     INTO l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6,l_amt7,l_amt8  
            IF SQLCA.sqlcode THEN
               CALL cl_errmsg('','aglq720_sel_pr04','',SQLCA.sqlcode,1)
               LET l_success = FALSE
            END IF
            IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
            IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
            IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
            IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
            IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
            IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
            IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
            IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
            LET l_osumd=l_osumd+l_amt1
            LET l_osumc=l_osumc+l_amt2
            LET l_sumd =l_sumd +l_amt3
            LET l_sumc =l_sumc +l_amt4
            LET l_sumd2=l_sumd2+l_amt5
            LET l_sumc2=l_sumc2+l_amt6
            LET l_sumd3=l_sumd3+l_amt7
            LET l_sumc3=l_sumc3+l_amt8            
         END IF 
         
         IF cl_null(l_amt1)  THEN LET l_amt1=0 END IF
         IF cl_null(l_amt2)  THEN LET l_amt2=0 END IF
         IF cl_null(l_amt3)  THEN LET l_amt3=0 END IF
         IF cl_null(l_amt4)  THEN LET l_amt4=0 END IF
         IF cl_null(l_amt5)  THEN LET l_amt5=0 END IF
         IF cl_null(l_amt6)  THEN LET l_amt6=0 END IF
         IF cl_null(l_amt7)  THEN LET l_amt7=0 END IF
         IF cl_null(l_amt8)  THEN LET l_amt8=0 END IF
         LET l_osumd=l_osumd+l_amt1
         LET l_osumc=l_osumc+l_amt2
         LET l_sumd =l_sumd +l_amt3
         LET l_sumc =l_sumc +l_amt4
         LET l_sumd2=l_sumd2+l_amt5
         LET l_sumc2=l_sumc2+l_amt6
         LET l_sumd3=l_sumd3+l_amt7
         LET l_sumc3=l_sumc3+l_amt8
         
         IF l_yeard=0 AND l_yearc=0 AND  #年初數
            l_qcd=0 AND l_qcc=0 AND      #期初數
            l_qjd=0 AND l_qjc=0 AND      #期間異動
            l_qmd=0 AND l_qmc=0 AND      #期末
            l_sumd=0 AND l_sumc=0 THEN   #本年累計，以上全部等於0時該筆科目資料不顯示
            CONTINUE FOREACH
         END IF
            
         INSERT INTO aglq720_tmp 
         VALUES(l_glac002,'','','','','','',
                '','','','','','','',
                l_oyeard,l_oyearc,l_yeard,l_yearc,l_yeard2,l_yearc2,l_yeard3,l_yearc3,
                l_oqcd,l_oqcc,l_qcd,l_qcc,l_qcd2,l_qcc2,l_qcd3,l_qcc3,
                l_oqjd,l_oqjc,l_qjd,l_qjc,l_qjd2,l_qjc2,l_qjd3,l_qjc3,
                l_oqmd,l_oqmc,l_qmd,l_qmc,l_qmd2,l_qmc2,l_qmd3,l_qmc3,
                l_osumd,l_osumc,l_sumd,l_sumc,l_sumd2,l_sumc2,l_sumd3,l_sumc3)
         IF SQLCA.sqlcode THEN
            CALL cl_errmsg('','insert','',SQLCA.sqlcode,1)
            LET l_success = FALSE
         END IF
      END IF
   END FOREACH
   IF l_success = FALSE THEN
      CALL cl_err_showmsg()
      DELETE FROM aglq720_tmp
   END IF
END FUNCTION]]>
</point>
  <point name="function.aglq720_show" cite_std="N" status="" ver="1" src="s" new="Y" order="5" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 显示资料
# Memo...........:
# Usage..........: CALL aglq720_show()
# Date & Author..:  2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_show()
   DISPLAY g_glaald,g_glaald_desc,g_glaacomp,g_glaacomp_desc,g_glaa001,g_glaa016,g_glaa020,
           tm.sdate,tm.syear,tm.speriod,tm.edate,tm.eyear,tm.eperiod,tm.ctype,tm.curr_o,tm.curr_p,
           tm.show_y,tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye,
           tm.comp,tm.glad007,tm.glad008,tm.glad009,tm.glad010,tm.glad027,tm.glad011,
           tm.glad012,tm.glad013,tm.glad014,tm.glad015,tm.glad016
        TO glaald,glaald_desc,glaacomp,glaacomp_desc,glaa001,glaa016,glaa020,
           sdate,syear,speriod,edate,eyear,eperiod,ctype,curr_o,curr_p,
           show_y,show_acc,glac005,stus,glac009,show_ce,show_ye,
           comp,glad007,glad008,glad009,glad010,glad027,glad011,
           glad012,glad013,glad014,glad015,glad016
END FUNCTION]]>
</point>
  <point name="function.aglq720_b_fill1" cite_std="N" status="" ver="1" src="s" new="Y" order="6" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 填充单身资料
# Memo...........:
# Usage..........: CALL aglq720_b_fill1()
# Date & Author..: 2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_b_fill1()
 
   LET g_sql="SELECT UNIQUE glar001,'',glar012,'',glar013,'',glar014,'',glar015,'',glar016,'',glar017,'',",
             "       glar018,'',glar019,'',glar020,'',glar021,'',glar022,glar023,glar009,",
             "       oyeard,oyearc,yeard,yearc,yeard2,yearc2,yeard3,yearc3,",
             "       oqcd,oqcc,qcd,qcc,qcd2,qcc2,qcd3,qcc3,",
             "       oqjd,oqjc,qjd,qjc,qjd2,qjc2,qjd3,qjc3,",
             "       oqmd,oqmc,qmd,qmc,qmd2,qmc2,qmd3,qmc3,",
             "       osumd,osumc,sumd,sumc,sumd2,sumc2,sumd3,sumc3 ",
             "  FROM aglq720_tmp "
   #是否按照幣別分頁
   IF NOT cl_null(g_glar009) THEN
      LET g_sql=g_sql," WHERE glar009='",g_glar009,"'"
   END IF
   LET g_sql=g_sql," ORDER BY glar001,glar012,glar013,glar014,glar015,glar016,glar017,glar018,glar019,",
                   "          glar020,glar021,glar022,glar023,glar009 "
   
  
   PREPARE aglq720_pb1 FROM g_sql
   DECLARE b_fill_curs1 CURSOR FOR aglq720_pb1
   OPEN b_fill_curs1
   
   CALL g_glar_d.clear()
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs1 INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,
       g_glar_d[l_ac].glar012,g_glar_d[l_ac].glar012_desc,g_glar_d[l_ac].glar013,g_glar_d[l_ac].glar013_desc,
       g_glar_d[l_ac].glar014,g_glar_d[l_ac].glar014_desc,g_glar_d[l_ac].glar015,g_glar_d[l_ac].glar015_desc,
       g_glar_d[l_ac].glar016,g_glar_d[l_ac].glar016_desc,g_glar_d[l_ac].glar017,g_glar_d[l_ac].glar017_desc,
       g_glar_d[l_ac].glar018,g_glar_d[l_ac].glar018_desc,g_glar_d[l_ac].glar019,g_glar_d[l_ac].glar019_desc,
       g_glar_d[l_ac].glar020,g_glar_d[l_ac].glar020_desc,g_glar_d[l_ac].glar021,g_glar_d[l_ac].glar021_desc,
       g_glar_d[l_ac].glar022,g_glar_d[l_ac].glar023,g_glar_d[l_ac].glar009, 
       g_glar_d[l_ac].oyeard,g_glar_d[l_ac].oyearc,g_glar_d[l_ac].yeard,g_glar_d[l_ac].yearc,g_glar_d[l_ac].yeard2, 
       g_glar_d[l_ac].yearc2,g_glar_d[l_ac].yeard3,g_glar_d[l_ac].yearc3,g_glar_d[l_ac].oqcd,g_glar_d[l_ac].oqcc, 
       g_glar_d[l_ac].qcd,g_glar_d[l_ac].qcc,g_glar_d[l_ac].qcd2,g_glar_d[l_ac].qcc2,g_glar_d[l_ac].qcd3, 
       g_glar_d[l_ac].qcc3,g_glar_d[l_ac].oqjd,g_glar_d[l_ac].oqjc,g_glar_d[l_ac].qjd,g_glar_d[l_ac].qjc, 
       g_glar_d[l_ac].qjd2,g_glar_d[l_ac].qjc2,g_glar_d[l_ac].qjd3,g_glar_d[l_ac].qjc3,g_glar_d[l_ac].oqmd, 
       g_glar_d[l_ac].oqmc,g_glar_d[l_ac].qmd,g_glar_d[l_ac].qmc,g_glar_d[l_ac].qmd2,g_glar_d[l_ac].qmc2, 
       g_glar_d[l_ac].qmd3,g_glar_d[l_ac].qmc3,g_glar_d[l_ac].osumd,g_glar_d[l_ac].osumc,g_glar_d[l_ac].sumd, 
       g_glar_d[l_ac].sumc,g_glar_d[l_ac].sumd2,g_glar_d[l_ac].sumc2,g_glar_d[l_ac].sumd3,g_glar_d[l_ac].sumc3 

      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET g_glar_d[l_ac].sel = "N"
      CALL aglq720_detail_show()
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   CALL g_glar_d.deleteElement(g_glar_d.getLength())   
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.cnt
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs1
   FREE aglq720_pb1
   
   LET l_ac = 1
   
   CALL aglq720_filter_show('glar001','b_glar001')
END FUNCTION]]>
</point>
  <point name="function.aglq720_set_page" cite_std="N" status="" ver="1" src="s" new="Y" order="7" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 设置分页
# Memo...........:
# Usage..........: CALL aglq720_set_page()
# Date & Author..: 2014/03/18 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_set_page()
   DEFINE l_sql    STRING
   DEFINE l_idx    LIKE type_t.num5
   
   CALL g_glar_s.clear()
   IF tm.curr_p <>'Y' THEN
      LET g_glar_s[1].glar009=''
      LET g_header_cnt = 1
      LET g_rec_b = 1
   ELSE      
      LET l_sql="SELECT DISTINCT glar009 FROM aglq720_tmp ORDER BY glar009 "
      PREPARE aglq720_sel_s_pr FROM l_sql
      DECLARE aglq720_sel_s_cr CURSOR FOR aglq720_sel_s_pr
      LET l_idx=1
      FOREACH aglq720_sel_s_cr INTO g_glar_s[l_idx].glar009
         IF SQLCA.sqlcode THEN
            CALL cl_err('FOREACH aglq720_sel_s_cr',SQLCA.sqlcode,0)
            EXIT FOREACH
         END IF
         LET l_idx=l_idx+1
         IF l_idx > g_max_rec THEN
            CALL cl_err('',9035,0)
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_glar_s.deleteElement(l_idx)
      LET g_header_cnt = g_glar_s.getLength()
      LET g_rec_b = l_idx - 1
   END IF
   DISPLAY g_header_cnt TO FORMONLY.h_count
END FUNCTION]]>
</point>
  <point name="function.aglq720_fix_acc_sql" cite_std="N" status="" ver="1" src="s" new="Y" order="8" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL aglq720_fix_acc_sql(p_glar009,p_glar012,p_glar013,p_glar014,p_glar015,p_glar016,p_glar017,p_glar018,p_glar019,p_glar020,p_glar021,p_glar022,p_glar023)
#                  RETURNING r_sql,r_sql1
# Input parameter: p_glar009,p_glar012,p_glar013,p_glar014,p_glar015,p_glar016,p_glar017,p_glar018,p_glar019,p_glar020,p_glar021,p_glar022,p_glar023  12組固定核算項   传入参数变量说明1
# Return code....: r_sql，r_sql1 組合SQL語句
# Date & Author..: 2014/03/25 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_fix_acc_sql(p_glar009,p_glar012,p_glar013,p_glar014,p_glar015,p_glar016,p_glar017,p_glar018,p_glar019,p_glar020,p_glar021,p_glar022,p_glar023)
   DEFINE p_glar009            LIKE glar_t.glar009
   DEFINE p_glar012            LIKE glar_t.glar012
   DEFINE p_glar013            LIKE glar_t.glar013
   DEFINE p_glar014            LIKE glar_t.glar014
   DEFINE p_glar015            LIKE glar_t.glar015
   DEFINE p_glar016            LIKE glar_t.glar016
   DEFINE p_glar017            LIKE glar_t.glar017
   DEFINE p_glar018            LIKE glar_t.glar018
   DEFINE p_glar019            LIKE glar_t.glar019
   DEFINE p_glar020            LIKE glar_t.glar020
   DEFINE p_glar021            LIKE glar_t.glar021
   DEFINE p_glar022            LIKE glar_t.glar022
   DEFINE p_glar023            LIKE glar_t.glar023
   DEFINE r_sql,r_sql1         STRING
   
   LET r_sql=''
   LET r_sql1=''
      
   IF tm.comp='Y' THEN
      IF p_glar012 IS NULL THEN
         LET r_sql=r_sql," AND glar012 IS NULL"
         LET r_sql1=r_sql1," AND glaq017 IS NULL"
      ELSE
         LET r_sql=r_sql," AND glar012='",p_glar012,"'"
         LET r_sql1=r_sql1," AND glaq017='",p_glar012,"'"
      END IF
   END IF
   
   IF tm.glad007='Y' THEN
      IF p_glar013 IS NULL THEN
         LET r_sql=r_sql," AND glar013 IS NULL"
         LET r_sql1=r_sql1," AND glaq018 IS NULL"
      ELSE
         LET r_sql=r_sql," AND glar013='",p_glar013,"'"
         LET r_sql1=r_sql1," AND glaq018='",p_glar013,"'"
      END IF
   END IF
   
   IF tm.glad008='Y' THEN
      IF p_glar014 IS NULL THEN
         LET r_sql=r_sql," AND glar014 IS NULL "
         LET r_sql1=r_sql1," AND glaq019 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar014='",p_glar014,"'"
         LET r_sql1=r_sql1," AND glaq019='",p_glar014,"'"
      END IF
   END IF
   
   IF tm.glad009='Y' THEN
      IF p_glar015 IS NULL THEN
         LET r_sql=r_sql," AND glar015 IS NULL"
         LET r_sql1=r_sql1," AND glaq020 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar015='",p_glar015,"'"
         LET r_sql1=r_sql1," AND glaq020='",p_glar015,"'"
      END IF
   END IF
   
   IF tm.glad010='Y' THEN
      IF p_glar016 IS NULL THEN
         LET r_sql=r_sql," AND glar016 IS NULL "
         LET r_sql1=r_sql1," AND glaq021 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar016='",p_glar016,"'"
         LET r_sql1=r_sql1," AND glaq021='",p_glar016,"'"
      END IF
   END IF
   
   IF tm.glad027='Y' THEN
      IF p_glar017 IS NULL THEN
         LET r_sql=r_sql," AND glar017 IS NULL "
         LET r_sql1=r_sql1," AND glaq022 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar017='",p_glar017,"'"
         LET r_sql1=r_sql1," AND glaq022='",p_glar017,"'"
      END IF
   END IF
      
   IF tm.glad011='Y' THEN
      IF p_glar018 IS NULL THEN
         LET r_sql=r_sql," AND glar018 IS NULL "
         LET r_sql1=r_sql1," AND glaq023 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar018='",p_glar018,"'"
         LET r_sql1=r_sql1," AND glaq023='",p_glar018,"'"
      END IF
   END IF
   
   IF tm.glad012='Y' THEN
      IF p_glar019 IS NULL THEN
         LET r_sql=r_sql," AND glar019 IS NULL "
         LET r_sql1=r_sql1," AND glaq024 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar019='",p_glar019,"'"
         LET r_sql1=r_sql1," AND glaq024='",p_glar019,"'"
      END IF
   END IF
   
   IF tm.glad013='Y' THEN
      IF p_glar020 IS NULL THEN
         LET r_sql=r_sql," AND glar020 IS NULL "
         LET r_sql1=r_sql1," AND glaq025 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar020='",p_glar020,"'"
         LET r_sql1=r_sql1," AND glaq025='",p_glar020,"'"
      END IF
   END IF
   
   IF tm.glad014='Y' THEN
      IF p_glar021 IS NULL THEN
         LET r_sql=r_sql," AND glar021 IS NULL "
         LET r_sql1=r_sql1," AND glaq026 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar021='",p_glar021,"'"
         LET r_sql1=r_sql1," AND glaq026='",p_glar021,"'"
      END IF
   END IF
   
   IF tm.glad015='Y' THEN
      IF p_glar022 IS NULL THEN
         LET r_sql=r_sql," AND glar022 IS NULL "
         LET r_sql1=r_sql1," AND glaq027 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar022='",p_glar022,"'"
         LET r_sql1=r_sql1," AND glaq027='",p_glar022,"'"
      END IF
   END IF
   
   IF tm.glad016='Y' THEN
      IF p_glar023 IS NULL THEN
         LET r_sql=r_sql," AND glar023 IS NULL "
         LET r_sql1=r_sql1," AND glaq028 IS NULL "
      ELSE
         LET r_sql=r_sql," AND glar023='",p_glar023,"'"
         LET r_sql1=r_sql1," AND glaq028='",p_glar023,"'"
      END IF
   END IF
   
   IF tm.curr_o='Y' THEN
      LET r_sql=r_sql," AND glar009='",p_glar009,"'"
      LET r_sql1=r_sql1," AND glaq005='",p_glar009,"'"
   END IF
   
   RETURN r_sql,r_sql1
END FUNCTION]]>
</point>
  <point name="function.aglq720_set_default_value" cite_std="N" status="" ver="1" src="s" new="Y" order="9" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 設置默認值
# Memo...........:
# Usage..........: CALL aglq720_set_default_value()
# Date & Author..: 2014/03/13 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_set_default_value()
   DEFINE l_flag           LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   
   CALL s_get_accdate(g_glaa003,g_today,'','')
   RETURNING l_flag,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
             l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
   IF l_flag='N' THEN
      CALL cl_err('',l_errno,0)
   END IF
   LET tm.sdate=l_pdate_s  #起始日期
   LET tm.syear=l_glav002
   LET tm.speriod=l_glav006
   LET tm.edate=l_pdate_e  #截止日期
   LET tm.eyear=l_glav002
   LET tm.eperiod=l_glav006
  
   #原幣顯示設置
   LET tm.curr_o='N'
   CALL cl_set_comp_visible('b_glar009,oyeard,oyearc,oqcd,oqcc,oqjd,oqjc,oqmd,oqmc,osumd,osumc',FALSE)
   LET tm.curr_p='N'
   CALL aglq720_set_comp_entry('curr_p',FALSE)
   #年初數
   LET tm.show_y='N'
   CALL cl_set_comp_visible('oyeard,oyearc,yeard,yearc,yeard2,yearc2,yeard3,yearc3',FALSE)
   #統制科目
   LET tm.show_acc='Y'
   #科目層級
   LET tm.glac005=99
   #單據狀態
   LET tm.stus='1'
   #含內部管理科目
   LET tm.glac009='Y'
   #含月結傳票
   LET tm.show_ce='Y'
   #含年結傳票
   LET tm.show_ye='Y'
   #核算項
   LET tm.comp='Y'
   LET tm.glad007='N'
   LET tm.glad008='N'
   LET tm.glad009='N'
   LET tm.glad010='N'
   LET tm.glad027='N'
   LET tm.glad011='N'
   LET tm.glad012='N'
   LET tm.glad013='N'
   LET tm.glad014='N'
   LET tm.glad015='N'
   LET tm.glad016='N'
   CALL cl_set_comp_visible("b_glar013,b_glar013_desc,b_glar014,b_glar014_desc,b_glar015,b_glar015_desc,
                             b_glar016,b_glar016_desc,b_glar017,b_glar017_desc,b_glar018,b_glar018_desc,
                             b_glar019,b_glar019_desc,b_glar020,b_glar020_desc,b_glar021,b_glar021_desc,
                             b_glar022,b_glar023",FALSE)
END FUNCTION]]>
</point>
  <point name="function.aglq720_fix_acc_get_sql" cite_std="N" status="" ver="1" src="s" new="Y" order="10" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 根據核算項勾選組SQL語句
# Memo...........:
# Usage..........: CALL aglq720_fix_acc_get_sql()
#                  RETURNING r_sql,r_sql1
# Return code....: r_sql    關於glar_t的SQL語句
#                : r_sql1   關於glaq_t的SQL語句
# Date & Author..: 2014/03/24 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_fix_acc_get_sql()
   DEFINE r_sql,r_sql1,r_sql2   STRING 
   
   LET r_sql=''
   LET r_sql1=''
   LET r_sql2=''
   
   IF tm.comp='Y' THEN
      LET r_sql =r_sql,"glar012"
      LET r_sql1=r_sql1,"glaq017"
      LET r_sql2=r_sql2,"glaq017 glar012"
   ELSE
      LET r_sql =r_sql,"''"
      LET r_sql1=r_sql1,"''"
      LET r_sql2=r_sql2,"''"
   END IF
   
   IF tm.glad007='Y' THEN
      LET r_sql =r_sql,",glar013"
      LET r_sql1=r_sql1,",glaq018"
      LET r_sql2=r_sql2,",glaq018 glar013"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad008='Y' THEN
      LET r_sql =r_sql,",glar014"
      LET r_sql1=r_sql1,",glaq019"
      LET r_sql2=r_sql2,",glaq019 glar014"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad009='Y' THEN
      LET r_sql =r_sql,",glar015"
      LET r_sql1=r_sql1,",glaq020"
      LET r_sql2=r_sql2,",glaq020 glar015"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad010='Y' THEN
      LET r_sql =r_sql,",glar016"
      LET r_sql1=r_sql1,",glaq021"
      LET r_sql2=r_sql2,",glaq021 glar016"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad027='Y' THEN
      LET r_sql =r_sql,",glar017"
      LET r_sql1=r_sql1,",glaq022"
      LET r_sql2=r_sql2,",glaq022 glar017"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad011='Y' THEN
      LET r_sql =r_sql,",glar018"
      LET r_sql1=r_sql1,",glaq023"
      LET r_sql2=r_sql2,",glaq023 glar018"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad012='Y' THEN
      LET r_sql =r_sql,",glar019"
      LET r_sql1=r_sql1,",glaq024"
      LET r_sql2=r_sql2,",glaq024 glar019"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad013='Y' THEN
      LET r_sql =r_sql,",glar020"
      LET r_sql1=r_sql1,",glaq025"
      LET r_sql2=r_sql2,",glaq025 glar020"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad014='Y' THEN
      LET r_sql =r_sql,",glar021"
      LET r_sql1=r_sql1,",glaq026"
      LET r_sql2=r_sql2,",glaq026 glar021"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad015='Y' THEN
      LET r_sql =r_sql,",glar022"
      LET r_sql1=r_sql1,",glaq027"
      LET r_sql2=r_sql2,",glaq027 glar022"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.glad016='Y' THEN
      LET r_sql =r_sql,",glar023"
      LET r_sql1=r_sql1,",glaq028"
      LET r_sql2=r_sql2,",glaq028 glar023"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   IF tm.curr_o='Y' THEN
      LET r_sql =r_sql,",glar009"
      LET r_sql1=r_sql1,",glaq005"
      LET r_sql2=r_sql2,",glaq005 glar009"
   ELSE
      LET r_sql =r_sql,",''"
      LET r_sql1=r_sql1,",''"
      LET r_sql2=r_sql2,",''"
   END IF
   
   RETURN r_sql,r_sql1,r_sql2
END FUNCTION]]>
</point>
  <point name="function.aglq720_set_comp_entry" cite_std="N" status="" ver="1" src="s" new="Y" order="11" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 動態設定元件是否需輸入值
# Memo...........:
# Usage..........: CALL aglq720_set_comp_entry(ps_fields,pi_entry)
# Input parameter: ps_fields   欄位名稱
#                : pi_entry    是否進入欄位
# Date & Author..: 2014/04/10 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_set_comp_entry(ps_fields,pi_entry)
   DEFINE ps_fields STRING,
          pi_entry  LIKE type_t.num5           
   DEFINE lst_fields base.StringTokenizer,
          ls_field_name STRING
   DEFINE lwin_curr     ui.Window
   DEFINE lnode_win     om.DomNode,
          llst_items    om.NodeList,
          li_i          LIKE type_t.num5,        
          lnode_item    om.DomNode,
          ls_item_name  STRING
 
   IF g_bgjob = 'Y' AND g_gui_type NOT MATCHES "[13]"  THEN  
      RETURN
   END IF
 
   IF (ps_fields IS NULL) THEN
      RETURN
   END IF
 
   LET ps_fields = ps_fields.toLowerCase()
 
   LET lst_fields = base.StringTokenizer.create(ps_fields, ",")
 
   LET lwin_curr = ui.Window.getCurrent()
   LET lnode_win = lwin_curr.getNode()
 
   LET llst_items = lnode_win.selectByPath("//Form//*")
 
   WHILE lst_fields.hasMoreTokens()
     LET ls_field_name = lst_fields.nextToken()
     LET ls_field_name = ls_field_name.trim()
 
     IF (ls_field_name.getLength() > 0) THEN
        FOR li_i = 1 TO llst_items.getLength()
            LET lnode_item = llst_items.item(li_i)
            LET ls_item_name = lnode_item.getAttribute("colName")
 
            IF (ls_item_name IS NULL) THEN
               LET ls_item_name = lnode_item.getAttribute("name")
 
               IF (ls_item_name IS NULL) THEN
                  CONTINUE FOR
               END IF
            END IF
 
            LET ls_item_name = ls_item_name.trim()
 
            IF (ls_item_name.equals(ls_field_name)) THEN
               IF (pi_entry) THEN
                  CALL lnode_item.setAttribute("noEntry", "0")
                  CALL lnode_item.setAttribute("active", "1")
               ELSE
                  CALL lnode_item.setAttribute("noEntry", "1")
                  CALL lnode_item.setAttribute("active", "0")
               END IF
 
               EXIT FOR
            END IF
        END FOR
     END IF
   END WHILE
END FUNCTION]]>
</point>
  <point name="function.aglq720_fetch1" cite_std="N" status="" ver="1" src="s" new="Y" order="12" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 抓取下一筆資料
# Memo...........:
# Usage..........: CALL aglq720_fetch1(p_flag)
# Input parameter: p_flag            
# Date & Author..: 2014/3/17 By wangrr
# Modify.........:
################################################################################
PRIVATE FUNCTION aglq720_fetch1(p_flag)
   DEFINE p_flag   LIKE type_t.chr1
   DEFINE ls_msg     STRING
   
   IF g_header_cnt = 0 THEN
      RETURN
   END IF
   
   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt        
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_glar_s.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         
         LET g_no_ask = FALSE  
   END CASE 
   
   #代表沒有資料
   IF g_current_idx = 0 OR g_glar_s.getLength() = 0 THEN
      RETURN
   END IF
   
   #超出範圍
   IF g_current_idx > g_glar_s.getLength() THEN
      LET g_current_idx = g_glar_s.getLength()
   END IF
   
   DISPLAY g_current_idx TO FORMONLY.h_index
   LET g_glar009 = g_glar_s[g_current_idx].glar009 
   CALL aglq720_b_fill1() 
END FUNCTION]]>
</point>
  <point name="b_fill.sql_before" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   RETURN]]>
</point>
  <point name="construct.c.page1.glar001" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL aglt310_04()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar001  #顯示到畫面上
            NEXT FIELD glar001                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar009" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooai001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar009  #顯示到畫面上
            NEXT FIELD glar009                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar012" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar012  #顯示到畫面上
            NEXT FIELD glar012                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar013" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar013  #顯示到畫面上
            NEXT FIELD glar013                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar014" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar014  #顯示到畫面上
            NEXT FIELD glar014                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar015" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar015  #顯示到畫面上
            NEXT FIELD glar015                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar016" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar016  #顯示到畫面上
            NEXT FIELD glar016                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar017" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pmaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar017  #顯示到畫面上
            NEXT FIELD glar017                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar018" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar018  #顯示到畫面上
            NEXT FIELD glar018                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar019" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_rtax001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar019  #顯示到畫面上
            NEXT FIELD glar019                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar020" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar020  #顯示到畫面上
            NEXT FIELD glar020                     #返回原欄位
    

]]>
</point>
  <point name="construct.c.page1.glar021" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_bgaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO glar021  #顯示到畫面上
            NEXT FIELD glar021                     #返回原欄位
    

]]>
</point>
  <point name="cs.after_construct" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   IF l_flag=TRUE THEN
      CALL cl_set_comp_visible('group3',FALSE)
      CALL aglq720_get_data()
      SELECT COUNT(*) INTO l_cnt FROM aglq720_tmp
      IF l_cnt=0 THEN 
         CALL cl_err('',-100,0)
         RETURN
      END IF
      CALL aglq720_set_page()
      CALL aglq720_fetch1('F')
   ELSE
      CALL aglq720_b_fill1()
      DISPLAY g_current_idx TO FORMONLY.h_index
      DISPLAY g_glar_s.getLength() TO FORMONLY.h_count
      DISPLAY g_detail_idx TO FORMONLY.idx
   END IF]]>
</point>
  <point name="detail_show.body.reference" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   #科目編號
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_glar_d[l_ac].glar001
   CALL ap_ref_array2(g_ref_fields,"SELECT glacl004 FROM glacl_t WHERE glaclent='"||g_enterprise||"' AND glacl001 = '"||g_glaa004||"' AND glacl002 = ? AND glacl003='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_glar_d[l_ac].glar001_desc=g_rtn_fields[1]
   #營運據點
   IF tm.comp='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =g_glar_d[l_ac].glar012
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar012_desc=g_rtn_fields[1]
   END IF
   #部門
   IF tm.glad007='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =g_glar_d[l_ac].glar013
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar013_desc=g_rtn_fields[1]
   END IF
   #成本中心
   IF tm.glad008='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] =g_glar_d[l_ac].glar014
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar014_desc=g_rtn_fields[1]
   END IF
   #區域
   IF tm.glad009='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = '287'
      LET g_ref_fields[2] = g_glar_d[l_ac].glar015
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar015_desc=g_rtn_fields[1] 
   END IF
   #交易客戶
   IF tm.glad010='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glar_d[l_ac].glar016
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar016_desc=g_rtn_fields[1]
   END IF
   #帳款客戶
   IF tm.glad027='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glar_d[l_ac].glar017
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar017_desc=g_rtn_fields[1]
   END IF
   #客群   
   IF tm.glad011='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = '281'
      LET g_ref_fields[2] = g_glar_d[l_ac].glar018
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001=? AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar018_desc=g_rtn_fields[1] 
   END IF
   #產品類別
   IF tm.glad012='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glar_d[l_ac].glar019
      CALL ap_ref_array2(g_ref_fields,"SELECT rtaxl003 FROM rtaxl_t WHERE rtaxlent='"||g_enterprise||"' AND rtaxl001=? AND rtaxl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar019_desc=g_rtn_fields[1]
   END IF
   #人員編號
   IF tm.glad013='Y' THEN
      SELECT oofa011 INTO g_glar_d[l_ac].glar020_desc FROM oofa_t
       WHERE oofaent = g_enterprise
         AND oofa001 IN (SELECT ooag002 FROM ooag_t WHERE ooagent = g_enterprise
                            AND ooag001 = g_glar_d[l_ac].glar020)
   END IF
   #預算編號
   IF tm.glad014='Y' THEN
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_glar_d[l_ac].glar021
      CALL ap_ref_array2(g_ref_fields,"SELECT bgaal003 FROM bgaal_t WHERE bgaalent='"||g_enterprise||"' AND bgaal001=? AND bgaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_glar_d[l_ac].glar021_desc=g_rtn_fields[1]
   END IF]]>
</point>
  <point name="fetch.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   RETURN]]>
</point>
  <point name="global.variable" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[#依据当前账别，抓取账别所归属的法人，使用币别，汇率参照表号，会计科目参照表号
DEFINE g_bookno        LIKE glap_t.glapld
DEFINE g_glaald        LIKE glaa_t.glaald
DEFINE g_glaald_desc   LIKE glaal_t.glaal002
DEFINE g_glaacomp      LIKE glaa_t.glaacomp
DEFINE g_glaacomp_desc LIKE ooefl_t.ooefl003
DEFINE g_glaa001       LIKE glaa_t.glaa001
DEFINE g_glaa002       LIKE glaa_t.glaa002
DEFINE g_glaa003       LIKE glaa_t.glaa003
DEFINE g_glaa004       LIKE glaa_t.glaa004
DEFINE g_glaa013       LIKE glaa_t.glaa013
DEFINE g_glaa015       LIKE glaa_t.glaa015
DEFINE g_glaa016       LIKE glaa_t.glaa016
DEFINE g_glaa017       LIKE glaa_t.glaa017
DEFINE g_glaa018       LIKE glaa_t.glaa018
DEFINE g_glaa019       LIKE glaa_t.glaa019
DEFINE g_glaa020       LIKE glaa_t.glaa020
DEFINE g_glaa021       LIKE glaa_t.glaa021
DEFINE g_glaa022       LIKE glaa_t.glaa022
#查询条件定义
DEFINE tm              RECORD
       sdate           LIKE glap_t.glapdocdt,  #起始日期
       syear           LIKE glap_t.glap002,    #起始年度
       speriod         LIKE glap_t.glap004,    #起始期別
       edate           LIKE glap_t.glapdocdt,  #截止日期
       eyear           LIKE glap_t.glap002,    #截止年度
       eperiod         LIKE glap_t.glap004,    #截止期別
       ctype           LIKE type_t.chr1,       #多本位幣
       curr_o          LIKE type_t.chr1, 
       curr_p          LIKE type_t.chr1, 
       show_y          LIKE type_t.chr1, 
       show_acc        LIKE type_t.chr1, 
       glac005	       LIKE glac_t.glac005,
       stus            LIKE type_t.chr1,
       glac009	       LIKE glac_t.glac009,
       show_ce         LIKE type_t.chr1,
       show_ye         LIKE type_t.chr1,
       comp            LIKE type_t.chr1,
       glad007         LIKE type_t.chr1,
       glad008         LIKE type_t.chr1,
       glad009         LIKE type_t.chr1,
       glad010         LIKE type_t.chr1,
       glad027         LIKE type_t.chr1,
       glad011         LIKE type_t.chr1,
       glad012         LIKE type_t.chr1,
       glad013         LIKE type_t.chr1,
       glad014         LIKE type_t.chr1,
       glad015         LIKE type_t.chr1,
       glad016         LIKE type_t.chr1
       END RECORD
DEFINE g_glar009       LIKE glar_t.glar009
DEFINE g_glar_s        DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位 
       glar009         LIKE glar_t.glar009
      END RECORD 
DEFINE g_current_row   LIKE type_t.num5 
DEFINE g_current_idx   LIKE type_t.num10     
DEFINE g_jump          LIKE type_t.num10        
DEFINE g_no_ask        LIKE type_t.num5  
DEFINE g_rec_b         LIKE type_t.num5]]>
</point>
  <point name="init.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   DEFINE l_success   LIKE type_t.num5
   DEFINE l_pass      LIKE type_t.num5]]>
</point>
  <point name="init.init" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   LET g_detail_idx  = 1
   CALL cl_set_combo_scc('stus','9922')
   #获取账别
   IF cl_null(g_glaald) THEN
      CALL s_ld_bookno()  RETURNING l_success,g_glaald
      IF l_success = FALSE THEN
         RETURN 
      END IF 
      CALL s_ld_chk_authorization(g_user,g_glaald) RETURNING l_pass
      IF l_pass = FALSE THEN
         CALL cl_err(g_glaald,'agl-00164',1)
         RETURN
      END IF
   END IF      
   CALL aglq720_glaald_desc(g_glaald)
   CALL aglq720_set_default_value()
   #建立临时表
   CALL aglq720_create_temp_table()]]>
</point>
  <point name="input.a.page1.glar012" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar013" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar014" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar015" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar016" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar017" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar018" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar019" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.a.page1.glar021" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[
]]>
</point>
  <point name="input.body.before_row" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               DISPLAY g_current_idx TO FORMONLY.h_index
               DISPLAY g_glar_s.getLength() TO FORMONLY.h_count
               DISPLAY g_detail_idx TO FORMONLY.idx
               DISPLAY g_glar_d.getLength() TO FORMONLY.cnt]]>
</point>
  <point name="menu.exchange_ld" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglt310_01(g_glaald) RETURNING g_bookno
               IF g_glaald <> g_bookno THEN
                  CLEAR FORM
                  CALL g_glar_s.clear()
                  CALL g_glar_d.clear()
               END IF
               LET g_glaald = g_bookno
               #依据对应的主账套编码，抓取对应法人，币别，汇率参照编号，会计科目参照编号,关账日期
               CALL aglq720_glaald_desc(g_glaald)
               CALL aglq720_show()
                IF cl_null(g_wc) THEN
                   LET g_wc = '1=1'
                END IF ]]>
</point>
  <point name="menu.first" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq720_fetch1('F')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.jump" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq720_fetch1('/')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.last" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq720_fetch1('L')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.next" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq720_fetch1('N')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.previous" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               CALL aglq720_fetch1('P')
               LET g_current_row = g_current_idx
               LET g_curr_diag = ui.DIALOG.getCurrent()]]>
</point>
  <point name="menu.query" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[               EXIT DIALOG]]>
</point>
  <point name="query.define" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[   DEFINE l_flag           LIKE type_t.num5
   DEFINE l_flag1          LIKE type_t.chr1
   DEFINE l_errno          LIKE type_t.chr100
   DEFINE l_glav002        LIKE glav_t.glav002
   DEFINE l_glav005        LIKE glav_t.glav005
   DEFINE l_sdate_s        LIKE glav_t.glav004
   DEFINE l_sdate_e        LIKE glav_t.glav004
   DEFINE l_glav006        LIKE glav_t.glav006
   DEFINE l_pdate_s        LIKE glav_t.glav004
   DEFINE l_pdate_e        LIKE glav_t.glav004
   DEFINE l_glav007        LIKE glav_t.glav007
   DEFINE l_wdate_s        LIKE glav_t.glav004
   DEFINE l_wdate_e        LIKE glav_t.glav004
   DEFINE l_cnt            LIKE type_t.num5
   
   LET  l_flag=TRUE]]>
</point>
  <point name="query.more_construct" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[      INPUT BY NAME tm.sdate,tm.edate,tm.ctype,tm.curr_o,tm.curr_p,tm.show_y,
                    tm.show_acc,tm.glac005,tm.stus,tm.glac009,tm.show_ce,tm.show_ye,
                    tm.comp,tm.glad007,tm.glad008,tm.glad009,tm.glad010,tm.glad027,
                    tm.glad011,tm.glad012,tm.glad013,tm.glad014,tm.glad015,tm.glad016
         ATTRIBUTE(WITHOUT DEFAULTS)
         BEFORE INPUT
         
         AFTER FIELD sdate
            IF NOT cl_null(tm.sdate) THEN
               CALL s_get_accdate(g_glaa003,tm.sdate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  CALL cl_err('',l_errno,0)
                  NEXT FIELD sdate
               END IF
               IF NOT cl_null(tm.edate) THEN
                  IF tm.sdate>tm.edate THEN
                     CALL cl_err('','agl-00116',0)
                     NEXT FIELD sdate
                  END IF
               END IF
               LET tm.syear=l_glav002
               LET tm.speriod=l_glav006
               DISPLAY tm.syear,tm.speriod TO syear,speriod 
            END IF
            
         AFTER FIELD edate
            IF NOT cl_null(tm.edate) THEN
               CALL s_get_accdate(g_glaa003,tm.edate,'','')
               RETURNING l_flag1,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                         l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
               IF l_flag1='N' THEN
                  CALL cl_err('',l_errno,0)
                  NEXT FIELD edate
               END IF
               IF NOT cl_null(tm.sdate) THEN
                  IF tm.sdate>tm.edate THEN
                     CALL cl_err('','agl-00117',0)
                     NEXT FIELD edate
                  END IF
               END IF
               LET tm.eyear=l_glav002
               LET tm.eperiod=l_glav006
               DISPLAY tm.eyear,tm.eperiod TO eyear,eperiod 
            END IF
         
         ON CHANGE ctype
            IF tm.ctype MATCHES '[123]' THEN
               CALL aglq720_set_curr_show()
            ELSE
               NEXT FIELD ctype
            END IF
            
         ON CHANGE curr_o 
            IF tm.curr_o MATCHES '[yYnN]' THEN
               IF tm.curr_o='Y' THEN
                  CALL cl_set_comp_visible('b_glar009,oqcd,oqcc,oqjd,oqjc,oqmd,oqmc,osumd,osumc',TRUE)
                  CALL aglq720_set_comp_entry('curr_p',TRUE)
                  IF tm.show_y='Y' THEN
                     CALL cl_set_comp_visible('oyeard,oyearc',TRUE)
                  END IF
               ELSE
                  CALL cl_set_comp_visible('b_glar009,oyeard,oyearc,oqcd,oqcc,oqjd,oqjc,oqmd,oqmc,osumd,osumc',FALSE)
                  CALL aglq720_set_comp_entry('curr_p',FALSE)
                  LET tm.curr_p='N'
                  DISPLAY tm.curr_p TO curr_p
               END IF                  
            ELSE
               NEXT FIELD curr_o
            END IF
            
         ON CHANGE curr_p
            IF tm.curr_p NOT MATCHES '[yYnN]' THEN
                NEXT FIELD curr_p
            END IF
            
         ON CHANGE show_y
            IF tm.show_y NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_y
            END IF
            IF tm.show_y='Y' THEN
               CALL cl_set_comp_visible('yeard,yearc',TRUE)
               IF tm.curr_o='Y' THEN
                  CALL cl_set_comp_visible('oyeard,oyearc',TRUE)
               END IF
               IF tm.ctype='1' OR tm.ctype='3' THEN
                  CALL cl_set_comp_visible('yeard2,yearc2',TRUE)
               END IF
               IF tm.ctype='2' OR tm.ctype='3' THEN
                  CALL cl_set_comp_visible('yeard3,yearc3',TRUE)
               END IF
            ELSE
               CALL cl_set_comp_visible('oyeard,oyearc,yeard,yearc,yeard2,yearc2,yeard3,yearc3',FALSE)
            END IF
            
         AFTER FIELD show_acc
            IF tm.show_acc NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_acc
            END IF
         
         AFTER FIELD glac005
            IF NOT cl_ap_chk_Range(tm.glac005,"1","1","99","1","azz-00087",1) THEN
               NEXT FIELD glac005
            END IF
         
         AFTER FIELD stus
            IF tm.stus NOT MATCHES '[123]' THEN
               NEXT FIELD stus
            END IF
            
         AFTER FIELD glac009
            IF tm.glac009 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glac009
            END IF
            
         AFTER FIELD show_ce
            IF tm.show_ce NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ce
            END IF
         
         AFTER FIELD show_ye
            IF tm.show_ye NOT MATCHES '[yYnN]' THEN
               NEXT FIELD show_ye
            END IF
            
         ON CHANGE comp
            IF tm.comp NOT MATCHES '[yYnN]' THEN
               NEXT FIELD comp
            END IF
            IF tm.comp='Y' THEN
               CALL cl_set_comp_visible("b_glar012,b_glar012_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar012,b_glar012_desc",FALSE)
            END IF
            
         ON CHANGE glad007
            IF tm.glad007 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad007
            END IF
            IF tm.glad007='Y' THEN
               CALL cl_set_comp_visible("b_glar013,b_glar013_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar013,b_glar013_desc",FALSE)
            END IF
            
         ON CHANGE glad008
            IF tm.glad008 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad008
            END IF
            IF tm.glad008='Y' THEN
               CALL cl_set_comp_visible("b_glar014,b_glar014_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar014,b_glar014_desc",FALSE)
            END IF
            
         ON CHANGE glad009
            IF tm.glad009 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad009
            END IF
            IF tm.glad009='Y' THEN
               CALL cl_set_comp_visible("b_glar015,b_glar015_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar015,b_glar015_desc",FALSE)
            END IF
         
         ON CHANGE glad010
            IF tm.glad010 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad010
            END IF
            IF tm.glad010='Y' THEN
               CALL cl_set_comp_visible("b_glar016,b_glar016_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar016,b_glar016_desc",FALSE)
            END IF
            
         ON CHANGE glad027
            IF tm.glad027 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad027
            END IF
            IF tm.glad027='Y' THEN
               CALL cl_set_comp_visible("b_glar017,b_glar017_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar017,b_glar017_desc",FALSE)
            END IF
            
         ON CHANGE glad011
            IF tm.glad011 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad011
            END IF
            IF tm.glad011='Y' THEN
               CALL cl_set_comp_visible("b_glar018,b_glar018_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar018,b_glar018_desc",FALSE)
            END IF
            
         ON CHANGE glad012
            IF tm.glad012 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad012
            END IF
            IF tm.glad012='Y' THEN
               CALL cl_set_comp_visible("b_glar019,b_glar019_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar019,b_glar019_desc",FALSE)
            END IF
         
         ON CHANGE glad013
            IF tm.glad013 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad013
            END IF
            IF tm.glad013='Y' THEN
               CALL cl_set_comp_visible("b_glar020,b_glar020_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar020,b_glar020_desc",FALSE)
            END IF 
         
         ON CHANGE glad014
            IF tm.glad014 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad014
            END IF
            IF tm.glad014='Y' THEN
               CALL cl_set_comp_visible("b_glar021,b_glar021_desc",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar021,b_glar021_desc",FALSE)
            END IF

         ON CHANGE glad015
            IF tm.glad015 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad015
            END IF
            IF tm.glad015='Y' THEN
               CALL cl_set_comp_visible("b_glar022",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar022",FALSE)
            END IF
            
         ON CHANGE glad016
            IF tm.glad016 NOT MATCHES '[yYnN]' THEN
               NEXT FIELD glad016
            END IF
            IF tm.glad016='Y' THEN
               CALL cl_set_comp_visible("b_glar023",TRUE)
            ELSE
               CALL cl_set_comp_visible("b_glar023",FALSE)
            END IF
      END INPUT
      
      BEFORE DIALOG
        #預設
        CALL cl_set_comp_visible('group3',TRUE)
        CALL aglq720_show()]]>
</point>
  <point name="ui_dialog.bef_dialog" cite_std="N" status="" ver="1" src="s" new="N" mark_hard="N">
<![CDATA[            IF g_header_cnt=1 THEN
               CALL cl_set_act_visible("first,previous,jump,next,last",FALSE) 
            ELSE
               IF g_current_idx=1 THEN
                  CALL cl_set_act_visible("first,previous", FALSE) 
                  CALL cl_set_act_visible("jump,next,last", TRUE) 
               ELSE
                  IF g_current_idx<>g_header_cnt THEN
                     CALL cl_set_act_visible("first,previous,jump,next,last",TRUE) 
                  ELSE
                     CALL cl_set_act_visible("first,previous,jump",TRUE) 
                     CALL cl_set_act_visible("next,last", FALSE) 
                  END IF
               END IF
            END IF
            CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)]]>
</point>
  <point name="global.memo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.import" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.inc" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.argv" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.init" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.after_define_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.after_refresh_sql" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.servicecall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.before_close" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.exit" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.before_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.more_displayarray" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.datainfo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.output" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_selnone" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_sel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.onaction_unsel" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="menu.filter" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.agendum" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="cs.head.before_construct" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar001" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar001" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar012" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar012" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar013" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar013" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar014" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar014" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar015" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar015" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar016" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar016" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar017" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar017" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar018" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar018" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar019" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar019" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar020" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar020" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar021" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar021" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar022" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar022" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glar022" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar023" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar023" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.c.page1.b_glar023" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.b.page1.b_glar009" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="construct.a.page1.b_glar009" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.sql_after" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="b_fill.others.fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="fetch.after_fill" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.before" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="detail_show.after" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.add_cs" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter.b_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="filter_parser.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="insert.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="insert.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="modify.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="modify.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="reproduce.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="reproduce.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="delete.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="delete.control" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <section id="aglq720.query" ver="1" status="" src="m">
<![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION aglq720_query()
   {<Local define>}
   DEFINE ls_wc      LIKE type_t.chr500
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   {</Local define>}
   #add-point:query段define
{<point name="query.define" />}
   #end add-point 
   
   LET INT_FLAG = 0
   CLEAR FORM
   CALL g_glar_d.clear()
   LET g_wc_filter = " 1=1"
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
   
   LET g_qryparam.state = "c"
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   
   #wc備份
   LET ls_wc = g_wc
   LET g_master_idx = l_ac
 
   
 
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單身根據table分拆construct
      CONSTRUCT g_wc_table ON glar001,glar012,glar013,glar014,glar015,glar016,glar017,glar018,glar019, 
          glar020,glar021,glar022,glar023,glar009
           FROM s_detail1[1].b_glar001,s_detail1[1].b_glar012,s_detail1[1].b_glar013,s_detail1[1].b_glar014, 
               s_detail1[1].b_glar015,s_detail1[1].b_glar016,s_detail1[1].b_glar017,s_detail1[1].b_glar018, 
               s_detail1[1].b_glar019,s_detail1[1].b_glar020,s_detail1[1].b_glar021,s_detail1[1].b_glar022, 
               s_detail1[1].b_glar023,s_detail1[1].b_glar009
                      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
{<point name="cs.head.before_construct" />}
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
       #---------------------<  Detail: page1  >---------------------
         #----<<b_glar001>>----
         #Ctrlp:construct.c.page1.b_glar001
         ON ACTION controlp INFIELD b_glar001
            #add-point:ON ACTION controlp INFIELD b_glar001
{<point name="construct.c.page1.b_glar001" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar001
            #add-point:BEFORE FIELD b_glar001
{<point name="construct.b.page1.b_glar001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar001
            
            #add-point:AFTER FIELD b_glar001
{<point name="construct.a.page1.b_glar001" />}
            #END add-point
            
 
         #----<<b_glar012>>----
         #Ctrlp:construct.c.page1.b_glar012
         ON ACTION controlp INFIELD b_glar012
            #add-point:ON ACTION controlp INFIELD b_glar012
{<point name="construct.c.page1.b_glar012" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar012
            #add-point:BEFORE FIELD b_glar012
{<point name="construct.b.page1.b_glar012" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar012
            
            #add-point:AFTER FIELD b_glar012
{<point name="construct.a.page1.b_glar012" />}
            #END add-point
            
 
         #----<<b_glar013>>----
         #Ctrlp:construct.c.page1.b_glar013
         ON ACTION controlp INFIELD b_glar013
            #add-point:ON ACTION controlp INFIELD b_glar013
{<point name="construct.c.page1.b_glar013" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar013
            #add-point:BEFORE FIELD b_glar013
{<point name="construct.b.page1.b_glar013" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar013
            
            #add-point:AFTER FIELD b_glar013
{<point name="construct.a.page1.b_glar013" />}
            #END add-point
            
 
         #----<<b_glar014>>----
         #Ctrlp:construct.c.page1.b_glar014
         ON ACTION controlp INFIELD b_glar014
            #add-point:ON ACTION controlp INFIELD b_glar014
{<point name="construct.c.page1.b_glar014" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar014
            #add-point:BEFORE FIELD b_glar014
{<point name="construct.b.page1.b_glar014" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar014
            
            #add-point:AFTER FIELD b_glar014
{<point name="construct.a.page1.b_glar014" />}
            #END add-point
            
 
         #----<<b_glar015>>----
         #Ctrlp:construct.c.page1.b_glar015
         ON ACTION controlp INFIELD b_glar015
            #add-point:ON ACTION controlp INFIELD b_glar015
{<point name="construct.c.page1.b_glar015" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar015
            #add-point:BEFORE FIELD b_glar015
{<point name="construct.b.page1.b_glar015" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar015
            
            #add-point:AFTER FIELD b_glar015
{<point name="construct.a.page1.b_glar015" />}
            #END add-point
            
 
         #----<<b_glar016>>----
         #Ctrlp:construct.c.page1.b_glar016
         ON ACTION controlp INFIELD b_glar016
            #add-point:ON ACTION controlp INFIELD b_glar016
{<point name="construct.c.page1.b_glar016" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar016
            #add-point:BEFORE FIELD b_glar016
{<point name="construct.b.page1.b_glar016" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar016
            
            #add-point:AFTER FIELD b_glar016
{<point name="construct.a.page1.b_glar016" />}
            #END add-point
            
 
         #----<<b_glar017>>----
         #Ctrlp:construct.c.page1.b_glar017
         ON ACTION controlp INFIELD b_glar017
            #add-point:ON ACTION controlp INFIELD b_glar017
{<point name="construct.c.page1.b_glar017" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar017
            #add-point:BEFORE FIELD b_glar017
{<point name="construct.b.page1.b_glar017" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar017
            
            #add-point:AFTER FIELD b_glar017
{<point name="construct.a.page1.b_glar017" />}
            #END add-point
            
 
         #----<<b_glar018>>----
         #Ctrlp:construct.c.page1.b_glar018
         ON ACTION controlp INFIELD b_glar018
            #add-point:ON ACTION controlp INFIELD b_glar018
{<point name="construct.c.page1.b_glar018" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar018
            #add-point:BEFORE FIELD b_glar018
{<point name="construct.b.page1.b_glar018" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar018
            
            #add-point:AFTER FIELD b_glar018
{<point name="construct.a.page1.b_glar018" />}
            #END add-point
            
 
         #----<<b_glar019>>----
         #Ctrlp:construct.c.page1.b_glar019
         ON ACTION controlp INFIELD b_glar019
            #add-point:ON ACTION controlp INFIELD b_glar019
{<point name="construct.c.page1.b_glar019" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar019
            #add-point:BEFORE FIELD b_glar019
{<point name="construct.b.page1.b_glar019" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar019
            
            #add-point:AFTER FIELD b_glar019
{<point name="construct.a.page1.b_glar019" />}
            #END add-point
            
 
         #----<<b_glar020>>----
         #Ctrlp:construct.c.page1.b_glar020
         ON ACTION controlp INFIELD b_glar020
            #add-point:ON ACTION controlp INFIELD b_glar020
{<point name="construct.c.page1.b_glar020" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar020
            #add-point:BEFORE FIELD b_glar020
{<point name="construct.b.page1.b_glar020" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar020
            
            #add-point:AFTER FIELD b_glar020
{<point name="construct.a.page1.b_glar020" />}
            #END add-point
            
 
         #----<<b_glar021>>----
         #Ctrlp:construct.c.page1.b_glar021
         ON ACTION controlp INFIELD b_glar021
            #add-point:ON ACTION controlp INFIELD b_glar021
{<point name="construct.c.page1.b_glar021" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar021
            #add-point:BEFORE FIELD b_glar021
{<point name="construct.b.page1.b_glar021" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar021
            
            #add-point:AFTER FIELD b_glar021
{<point name="construct.a.page1.b_glar021" />}
            #END add-point
            
 
         #----<<b_glar022>>----
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar022
            #add-point:BEFORE FIELD b_glar022
{<point name="construct.b.page1.b_glar022" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar022
            
            #add-point:AFTER FIELD b_glar022
{<point name="construct.a.page1.b_glar022" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.b_glar022
         ON ACTION controlp INFIELD b_glar022
            #add-point:ON ACTION controlp INFIELD b_glar022
{<point name="construct.c.page1.b_glar022" />}
            #END add-point
 
         #----<<b_glar023>>----
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar023
            #add-point:BEFORE FIELD b_glar023
{<point name="construct.b.page1.b_glar023" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar023
            
            #add-point:AFTER FIELD b_glar023
{<point name="construct.a.page1.b_glar023" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.b_glar023
         ON ACTION controlp INFIELD b_glar023
            #add-point:ON ACTION controlp INFIELD b_glar023
{<point name="construct.c.page1.b_glar023" />}
            #END add-point
 
         #----<<b_glar009>>----
         #Ctrlp:construct.c.page1.b_glar009
         ON ACTION controlp INFIELD b_glar009
            #add-point:ON ACTION controlp INFIELD b_glar009
{<point name="construct.c.page1.b_glar009" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD b_glar009
            #add-point:BEFORE FIELD b_glar009
{<point name="construct.b.page1.b_glar009" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD b_glar009
            
            #add-point:AFTER FIELD b_glar009
{<point name="construct.a.page1.b_glar009" />}
            #END add-point
            
 
   
       
      END CONSTRUCT
      
 
      
 
  
      #add-point:query段more_construct
{<point name="query.more_construct" />}
      #end add-point 
      
      ON ACTION accept
         ACCEPT DIALOG
         
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG
      
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG 
   END DIALOG
 
   
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      #還原
      LET g_wc = ls_wc
      LET l_flag=FALSE
   ELSE
      LET g_master_idx = 1
   END IF
   
   LET g_wc = g_wc_table 
 
 
        
   LET g_wc2 = " 1=1"
 
        
   #add-point:cs段after_construct
{<point name="cs.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL aglq720_b_fill()
   LET l_ac = g_master_idx
   CALL aglq720_fetch()
#   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
#      CALL cl_err("",-100,1)
#   END IF
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
   
END FUNCTION
]]>
</section>
  <section id="aglq720.b_fill" ver="9" status="" src="s">
<![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION aglq720_b_fill()
   {<Local define>}
   DEFINE ls_wc           STRING
   {</Local define>}
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
   
   IF cl_null(g_wc_filter) THEN
      LET g_wc_filter = " 1=1"
   END IF
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   
   LET ls_wc = g_wc, " AND ", g_wc2, " AND ", g_wc_filter
   
   LET g_sql = "SELECT  UNIQUE glar001,'',glar012,'',glar013,'',glar014,'',glar015,'',glar016,'',glar017, 
       '',glar018,'',glar019,'',glar020,'',glar021,'',glar022,glar023,glar009,'','','','','','','','', 
       '','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','', 
       '' FROM glar_t",
 
 
               "",
               " WHERE glarent= ? AND 1=1 AND ", ls_wc
    
   LET g_sql = g_sql, " ORDER BY glar_t.glarld,glar_t.glar001,glar_t.glar002,glar_t.glar003,glar_t.glar004"
  
   #add-point:b_fill段sql_after
   {<point name="b_fill.sql_after"/>}
   #end add-point
  
   PREPARE aglq720_pb FROM g_sql
   DECLARE b_fill_curs CURSOR FOR aglq720_pb
   
   OPEN b_fill_curs USING g_enterprise
 
   CALL g_glar_d.clear()
 
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs INTO g_glar_d[l_ac].glar001,g_glar_d[l_ac].glar001_desc,g_glar_d[l_ac].glar012, 
       g_glar_d[l_ac].glar012_desc,g_glar_d[l_ac].glar013,g_glar_d[l_ac].glar013_desc,g_glar_d[l_ac].glar014, 
       g_glar_d[l_ac].glar014_desc,g_glar_d[l_ac].glar015,g_glar_d[l_ac].glar015_desc,g_glar_d[l_ac].glar016, 
       g_glar_d[l_ac].glar016_desc,g_glar_d[l_ac].glar017,g_glar_d[l_ac].glar017_desc,g_glar_d[l_ac].glar018, 
       g_glar_d[l_ac].glar018_desc,g_glar_d[l_ac].glar019,g_glar_d[l_ac].glar019_desc,g_glar_d[l_ac].glar020, 
       g_glar_d[l_ac].glar020_desc,g_glar_d[l_ac].glar021,g_glar_d[l_ac].glar021_desc,g_glar_d[l_ac].glar022, 
       g_glar_d[l_ac].glar023,g_glar_d[l_ac].glar009,g_glar_d[l_ac].oyeard,g_glar_d[l_ac].oyearc,g_glar_d[l_ac].yeard, 
       g_glar_d[l_ac].yearc,g_glar_d[l_ac].yeard2,g_glar_d[l_ac].yearc2,g_glar_d[l_ac].yeard3,g_glar_d[l_ac].yearc3, 
       g_glar_d[l_ac].oqcd,g_glar_d[l_ac].oqcc,g_glar_d[l_ac].qcd,g_glar_d[l_ac].qcc,g_glar_d[l_ac].qcd2, 
       g_glar_d[l_ac].qcc2,g_glar_d[l_ac].qcd3,g_glar_d[l_ac].qcc3,g_glar_d[l_ac].oqjd,g_glar_d[l_ac].oqjc, 
       g_glar_d[l_ac].qjd,g_glar_d[l_ac].qjc,g_glar_d[l_ac].qjd2,g_glar_d[l_ac].qjc2,g_glar_d[l_ac].qjd3, 
       g_glar_d[l_ac].qjc3,g_glar_d[l_ac].oqmd,g_glar_d[l_ac].oqmc,g_glar_d[l_ac].qmd,g_glar_d[l_ac].qmc, 
       g_glar_d[l_ac].qmd2,g_glar_d[l_ac].qmc2,g_glar_d[l_ac].qmd3,g_glar_d[l_ac].qmc3,g_glar_d[l_ac].osumd, 
       g_glar_d[l_ac].osumc,g_glar_d[l_ac].sumd,g_glar_d[l_ac].sumc,g_glar_d[l_ac].sumd2,g_glar_d[l_ac].sumc2, 
       g_glar_d[l_ac].sumd3,g_glar_d[l_ac].sumc3
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      LET g_glar_d[l_ac].sel = "N"
      #LET g_glar_d[l_ac].statepic = cl_get_actipic(g_glar_d[l_ac].statepic)
 
      
 
      #add-point:b_fill段資料填充
      {<point name="b_fill.fill"/>}
      #end add-point
      
      CALL aglq720_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            CALL cl_err( "", 9035, 1 )
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
 
   
   CALL g_glar_d.deleteElement(g_glar_d.getLength())   
 
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.others.fill"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE aglq720_pb
   
   LET l_ac = 1
   CALL aglq720_fetch()
   
      CALL aglq720_filter_show('glar001','b_glar001')
   CALL aglq720_filter_show('glar012','b_glar012')
   CALL aglq720_filter_show('glar013','b_glar013')
   CALL aglq720_filter_show('glar014','b_glar014')
   CALL aglq720_filter_show('glar015','b_glar015')
   CALL aglq720_filter_show('glar016','b_glar016')
   CALL aglq720_filter_show('glar017','b_glar017')
   CALL aglq720_filter_show('glar018','b_glar018')
   CALL aglq720_filter_show('glar019','b_glar019')
   CALL aglq720_filter_show('glar020','b_glar020')
   CALL aglq720_filter_show('glar021','b_glar021')
   CALL aglq720_filter_show('glar022','b_glar022')
   CALL aglq720_filter_show('glar023','b_glar023')
   CALL aglq720_filter_show('glar009','b_glar009')
 
   
END FUNCTION
]]>
</section>
  <section id="aglq720.delete" ver="1" status="" src="s">
<![CDATA[#+ delete
PRIVATE FUNCTION aglq720_delete()
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point
 
   #add-point:delete段control
   {<point name="delete.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq720.description" ver="113" status="" src="s">
<![CDATA[#+ Version..: T100-ERP-1.00.00(版次:1) Build-000112
#+ 
#+ Filename...: aglq720
#+ Description: 科目核算項各期餘額查詢作業
#+ Creator....: 02599(2014/03/23)
#+ Modifier...: 02599(2014/03/25)
#+ Buildtype..: 應用 q02 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
</section>
  <section id="aglq720.detail_show" ver="1" status="" src="s">
<![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION aglq720_detail_show()
   #add-point:show段define
   {<point name="detail_show.define"/>}
   #end add-point
 
   #add-point:detail_show段之前
   {<point name="detail_show.before"/>}
   #end add-point
   
   
   
   #帶出公用欄位reference值page1
   
    
 
   
   #讀入ref值
   #add-point:show段單身reference
   {<point name="detail_show.body.reference"/>}
   #end add-point
   
 
 
   #add-point:detail_show段之後
   {<point name="detail_show.after"/>}
   #end add-point
 
END FUNCTION
]]>
</section>
  <section id="aglq720.fetch" ver="1" status="" src="s">
<![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION aglq720_fetch()
   {<Local define>}
   DEFINE li_ac           LIKE type_t.num5
   {</Local define>}
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point
   
 
   
   LET li_ac = l_ac 
   
 
   
   #DISPLAY g_detail_cnt TO FORMONLY.cnt
 
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
</section>
  <section id="aglq720.filter" ver="6" status="" src="s">
<![CDATA[#+ filter過濾功能
PRIVATE FUNCTION aglq720_filter()
   {<Local define>}
   {</Local define>}
   #add-point:filter段define
   {<point name="filter.define"/>}
   #end add-point    
   
   LET l_ac = 1
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON glar001,glar012,glar013,glar014,glar015,glar016,glar017,glar018,glar019, 
          glar020,glar021,glar022,glar023,glar009
                          FROM s_detail1[1].b_glar001,s_detail1[1].b_glar012,s_detail1[1].b_glar013, 
                              s_detail1[1].b_glar014,s_detail1[1].b_glar015,s_detail1[1].b_glar016,s_detail1[1].b_glar017, 
                              s_detail1[1].b_glar018,s_detail1[1].b_glar019,s_detail1[1].b_glar020,s_detail1[1].b_glar021, 
                              s_detail1[1].b_glar022,s_detail1[1].b_glar023,s_detail1[1].b_glar009
 
         BEFORE CONSTRUCT
#saki       CALL cl_qbe_init()
                     DISPLAY aglq720_filter_parser('glar001') TO s_detail1[1].b_glar001
            DISPLAY aglq720_filter_parser('glar012') TO s_detail1[1].b_glar012
            DISPLAY aglq720_filter_parser('glar013') TO s_detail1[1].b_glar013
            DISPLAY aglq720_filter_parser('glar014') TO s_detail1[1].b_glar014
            DISPLAY aglq720_filter_parser('glar015') TO s_detail1[1].b_glar015
            DISPLAY aglq720_filter_parser('glar016') TO s_detail1[1].b_glar016
            DISPLAY aglq720_filter_parser('glar017') TO s_detail1[1].b_glar017
            DISPLAY aglq720_filter_parser('glar018') TO s_detail1[1].b_glar018
            DISPLAY aglq720_filter_parser('glar019') TO s_detail1[1].b_glar019
            DISPLAY aglq720_filter_parser('glar020') TO s_detail1[1].b_glar020
            DISPLAY aglq720_filter_parser('glar021') TO s_detail1[1].b_glar021
            DISPLAY aglq720_filter_parser('glar022') TO s_detail1[1].b_glar022
            DISPLAY aglq720_filter_parser('glar023') TO s_detail1[1].b_glar023
            DISPLAY aglq720_filter_parser('glar009') TO s_detail1[1].b_glar009
 
 
      END CONSTRUCT
 
      #add-point:filter段add_cs
      {<point name="filter.add_cs"/>}
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog
         {<point name="filter.b_dialog"/>}
         #end add-point  
 
      ON ACTION accept
         ACCEPT DIALOG 
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
 
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = g_wc_filter, " "
   ELSE
      LET g_wc_filter = g_wc_filter_t
   END IF
   
      CALL aglq720_filter_show('glar001','b_glar001')
   CALL aglq720_filter_show('glar012','b_glar012')
   CALL aglq720_filter_show('glar013','b_glar013')
   CALL aglq720_filter_show('glar014','b_glar014')
   CALL aglq720_filter_show('glar015','b_glar015')
   CALL aglq720_filter_show('glar016','b_glar016')
   CALL aglq720_filter_show('glar017','b_glar017')
   CALL aglq720_filter_show('glar018','b_glar018')
   CALL aglq720_filter_show('glar019','b_glar019')
   CALL aglq720_filter_show('glar020','b_glar020')
   CALL aglq720_filter_show('glar021','b_glar021')
   CALL aglq720_filter_show('glar022','b_glar022')
   CALL aglq720_filter_show('glar023','b_glar023')
   CALL aglq720_filter_show('glar009','b_glar009')
 
    
   CALL aglq720_b_fill()
   CALL aglq720_fetch()
   
   CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
   CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
 
END FUNCTION
]]>
</section>
  <section id="aglq720.filter_parser" ver="1" status="" src="s">
<![CDATA[#+ filter欄位解析
PRIVATE FUNCTION aglq720_filter_parser(ps_field)
   {<Local define>}
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   {</Local define>}
   #add-point:filter段define
   {<point name="filter_parser.define"/>}
   #end add-point    
 
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
</section>
  <section id="aglq720.filter_show" ver="1" status="" src="s">
<![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION aglq720_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = aglq720_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
</section>
  <section id="aglq720.global" ver="4" status="" src="s">
<![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單身 type 宣告
PRIVATE TYPE type_g_glar_d RECORD
       #statepic       LIKE type_t.chr1,
       sel            LIKE type_t.chr1,
       glar001 LIKE glar_t.glar001, 
   glar001_desc LIKE type_t.chr500, 
   glar012 LIKE glar_t.glar012, 
   glar012_desc LIKE type_t.chr500, 
   glar013 LIKE glar_t.glar013, 
   glar013_desc LIKE type_t.chr500, 
   glar014 LIKE glar_t.glar014, 
   glar014_desc LIKE type_t.chr500, 
   glar015 LIKE glar_t.glar015, 
   glar015_desc LIKE type_t.chr500, 
   glar016 LIKE glar_t.glar016, 
   glar016_desc LIKE type_t.chr500, 
   glar017 LIKE glar_t.glar017, 
   glar017_desc LIKE type_t.chr500, 
   glar018 LIKE glar_t.glar018, 
   glar018_desc LIKE type_t.chr500, 
   glar019 LIKE glar_t.glar019, 
   glar019_desc LIKE type_t.chr500, 
   glar020 LIKE glar_t.glar020, 
   glar020_desc LIKE type_t.chr500, 
   glar021 LIKE glar_t.glar021, 
   glar021_desc LIKE type_t.chr500, 
   glar022 LIKE glar_t.glar022, 
   glar023 LIKE glar_t.glar023, 
   glar009 LIKE glar_t.glar009, 
   oyeard LIKE type_t.chr500, 
   oyearc LIKE type_t.chr500, 
   yeard LIKE type_t.chr500, 
   yearc LIKE type_t.chr500, 
   yeard2 LIKE type_t.chr500, 
   yearc2 LIKE type_t.chr500, 
   yeard3 LIKE type_t.chr500, 
   yearc3 LIKE type_t.chr500, 
   oqcd LIKE type_t.chr500, 
   oqcc LIKE type_t.chr500, 
   qcd LIKE type_t.chr500, 
   qcc LIKE type_t.chr500, 
   qcd2 LIKE type_t.chr500, 
   qcc2 LIKE type_t.chr500, 
   qcd3 LIKE type_t.chr500, 
   qcc3 LIKE type_t.chr500, 
   oqjd LIKE type_t.chr500, 
   oqjc LIKE type_t.chr500, 
   qjd LIKE type_t.chr500, 
   qjc LIKE type_t.chr500, 
   qjd2 LIKE type_t.chr500, 
   qjc2 LIKE type_t.chr500, 
   qjd3 LIKE type_t.chr500, 
   qjc3 LIKE type_t.chr500, 
   oqmd LIKE type_t.chr500, 
   oqmc LIKE type_t.chr500, 
   qmd LIKE type_t.chr500, 
   qmc LIKE type_t.chr500, 
   qmd2 LIKE type_t.chr500, 
   qmc2 LIKE type_t.chr500, 
   qmd3 LIKE type_t.chr500, 
   qmc3 LIKE type_t.chr500, 
   osumd LIKE type_t.chr500, 
   osumc LIKE type_t.chr500, 
   sumd LIKE type_t.chr500, 
   sumc LIKE type_t.chr500, 
   sumd2 LIKE type_t.chr500, 
   sumc2 LIKE type_t.chr500, 
   sumd3 LIKE type_t.chr500, 
   sumc3 LIKE type_t.chr500 
       END RECORD
 
 
#模組變數(Module Variables)
DEFINE g_master                     type_g_glar_d
DEFINE g_master_t                   type_g_glar_d
DEFINE g_glar_d          DYNAMIC ARRAY OF type_g_glar_d
DEFINE g_glar_d_t        type_g_glar_d
 
      
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num5              
DEFINE l_ac_d               LIKE type_t.num5              #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num5              #目前所在頁數
DEFINE g_detail_cnt         LIKE type_t.num5              #單身 總筆數(所有資料)
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num5
DEFINE g_detail_idx         LIKE type_t.num5
DEFINE g_detail_idx2        LIKE type_t.num5
DEFINE g_hyper_url          STRING                        #hyperlink的主要網址
 
 
#多table用wc
DEFINE g_wc_table           STRING
 
 
 
DEFINE g_wc_filter_table           STRING
 
 
 
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
</section>
  <section id="aglq720.init" ver="1" status="" src="s">
<![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION aglq720_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
   
   
   
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
</section>
  <section id="aglq720.insert" ver="1" status="" src="s">
<![CDATA[#+ insert
PRIVATE FUNCTION aglq720_insert()
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point
 
   #add-point:insert段control
   {<point name="insert.control"/>}
   #end add-point    
   
END FUNCTION
]]>
</section>
  <section id="aglq720.main" ver="2" status="" src="s">
<![CDATA[#+ 此段落由子樣板a26產生
#OPTIONS SHORT CIRCUIT
#+ 作業開始 
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point   
 
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("agl","")
 
   #add-point:作業初始化
   {<point name="main.init" />}
   #end add-point
   
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = ""
   #add-point:SQL_define
   {<point name="main.after_define_sql"/>}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   DECLARE aglq720_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT UNIQUE ",
               " FROM ",
               " WHERE  "
   #add-point:SQL_define
   {<point name="main.after_refresh_sql"/>}
   #end add-point
   PREPARE aglq720_master_referesh FROM g_sql
 
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
 
   ELSE
      
      #畫面開啟 (identifier)
      OPEN WINDOW w_aglq720 WITH FORM cl_ap_formpath("agl",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL aglq720_init()   
 
      #進入選單 Menu (="N")
      CALL aglq720_ui_dialog() 
      
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_aglq720
      
   END IF 
   
   CLOSE aglq720_cl
   
   
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
   
END MAIN
 
 
]]>
</section>
  <section id="aglq720.modify" ver="1" status="" src="s">
<![CDATA[#+ modify
PRIVATE FUNCTION aglq720_modify()
   #add-point:modify段define
   {<point name="modify.define"/>}
   #end add-point
 
   #add-point:modify段control
   {<point name="modify.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq720.other_function" ver="1" status="" src="s">
<![CDATA[{<point name="other.function"/>}
]]>
</section>
  <section id="aglq720.reproduce" ver="1" status="" src="s">
<![CDATA[#+ reproduce
PRIVATE FUNCTION aglq720_reproduce()
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point
 
   #add-point:reproduce段control
   {<point name="reproduce.control"/>}
   #end add-point 
END FUNCTION
]]>
</section>
  <section id="aglq720.ui_dialog" ver="39" status="" src="s">
<![CDATA[#+ 功能選單 
PRIVATE FUNCTION aglq720_ui_dialog()
   {<Local define>}
   DEFINE li_idx   LIKE type_t.num5
   {</Local define>}
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define"/>}
   #end add-point 
 
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   CALL aglq720_query()
   
   WHILE TRUE
   
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         DISPLAY ARRAY g_glar_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_glar_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_ac
               CALL aglq720_fetch()
               #add-point:input段before row
               {<point name="input.body.before_row"/>}
               #end add-point  
            
            #自訂ACTION(detail_show,page_1)
            
               
         END DISPLAY
      
 
         
 
      
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
         
         BEFORE DIALOG      
            CALL DIALOG.setSelectionMode("s_detail1", 1)
 
            #add-point:ui_dialog段before dialog
            {<point name="ui_dialog.bef_dialog"/>}
            #end add-point
 
            NEXT FIELD sel
      
         
 
         ON ACTION datainfo
 
            LET g_action_choice="datainfo"
            IF cl_auth_chk_act("datainfo") THEN 
               #add-point:ON ACTION datainfo
               {<point name="menu.datainfo" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION exchange_ld
 
            LET g_action_choice="exchange_ld"
            IF cl_auth_chk_act("exchange_ld") THEN 
               #add-point:ON ACTION exchange_ld
               {<point name="menu.exchange_ld" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION first
 
            LET g_action_choice="first"
            IF cl_auth_chk_act("first") THEN 
               #add-point:ON ACTION first
               {<point name="menu.first" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION jump
 
            LET g_action_choice="jump"
            IF cl_auth_chk_act("jump") THEN 
               #add-point:ON ACTION jump
               {<point name="menu.jump" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION last
 
            LET g_action_choice="last"
            IF cl_auth_chk_act("last") THEN 
               #add-point:ON ACTION last
               {<point name="menu.last" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION next
 
            LET g_action_choice="next"
            IF cl_auth_chk_act("next") THEN 
               #add-point:ON ACTION next
               {<point name="menu.next" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION output
 
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN 
               #add-point:ON ACTION output
               {<point name="menu.output" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION previous
 
            LET g_action_choice="previous"
            IF cl_auth_chk_act("previous") THEN 
               #add-point:ON ACTION previous
               {<point name="menu.previous" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         ON ACTION query
 
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN 
               CALL aglq720_query()
               #add-point:ON ACTION query
               {<point name="menu.query" />}
               #END add-point
            END IF
 
      
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            FOR li_idx = 1 TO g_glar_d.getLength()
               LET g_glar_d[li_idx].sel = "Y"
            END FOR
 
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_glar_d.getLength()
               LET g_glar_d[li_idx].sel = "N"
            END FOR
 
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_glar_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glar_d[li_idx].sel = "Y"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_glar_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_glar_d[li_idx].sel = "N"
               END IF
            END FOR
 
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL aglq720_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION qbeclear   # 條件清除
            CLEAR FORM
 
         ON ACTION datarefresh   # 重新整理
            LET g_error_show = 1
            CALL aglq720_b_fill()
            CALL aglq720_fetch()
 
         ON ACTION agendum   # 待辦事項
            #add-point:ON ACTION agendum
            {<point name="ui_dialog.agendum"/>}
            #END add-point
            CALL cl_user_overview()
 
         
      
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
</section>
</add_points>