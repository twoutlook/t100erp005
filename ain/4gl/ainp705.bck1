#該程式未解開Section, 採用最新樣板產出!
{<section id="ainp705.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0007(2016-12-27 08:27:01), PR版次:0007(2017-01-23 08:54:26)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000022
#+ Filename...: ainp705
#+ Description: 批次裝箱作業
#+ Creator....: 06137(2016-11-11 11:04:28)
#+ Modifier...: 06137 -SD/PR- 06137
 
{</section>}
 
{<section id="ainp705.global" >}
#應用 p02 樣板自動產生(Version:22)
#add-point:填寫註解說明 name="global.memo"
#Memos
#161109-00078#15  2016/11/22  By Rainy 加上備註欄位(indi005)於配送日期後
#161208-00023#2   2016/12/08  By 06137 if本笔配送单对象需求单的需求对象的总数量为0，则该笔资料不显示
#161220-00037#4   2016/12/22  By 06137 增加多次装箱处理，详见分镜；s_add_aint701修改产生装箱单身inbp里数量的取值逻辑，应装量改为此次分配量indj010-已装箱量indj022
#161230-00009#1   2016/12/30  By 06137 TQC(查询时总数量为0的不显示)
#170119-00027#3   2017/01/23  By 06137 打印优化：点打印按钮调r作业界面，点打印或者快速打印，进去预览画面，关闭预览画面时，须同步关闭报表元件选择界面和R作业的前端界面
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
#add-point:增加匯入項目 name="global.import"

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable) name="global.parameter"
   
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)  #注意要在add-point內寫入END RECORD name="global.variable"
     sel             LIKE type_t.chr1,
     indi007         LIKE indi_t.indi007,   #需求類型   #161220-00037#4 Add By Ken 161222
     indi001         LIKE indi_t.indi001,
     indj020         LIKE indj_t.indj020,
     indj020_desc    LIKE ooefl_t.ooefl003,
     indj001         LIKE indj_t.indj001,
     indidocno       LIKE indi_t.indidocno,
     indidocdt       LIKE indi_t.indidocdt,
     indi005         LIKE indi_t.indi005,     #161109-00078#15  2016/11/22  ADD By Rainy
     indi003         LIKE indi_t.indi003,
     indi003_desc    LIKE ooag_t.ooag011,
     indi004         LIKE indi_t.indi004,
     indi004_desc    LIKE ooefl_t.ooefl003,   
     indj010         LIKE indj_t.indj010,  
     indj022         LIKE indj_t.indj022,    #已裝箱量   #161220-00037#4 Add By Ken 161222
     indj021         LIKE indj_t.indj021,
     indj023         LIKE indj_t.indj023     #結束碼     #161220-00037#4 Add By Ken 161222
                     END RECORD
                     
TYPE type_g_detail2_d RECORD   #配送單身明細檔
       indjseq       LIKE indj_t.indjseq, #項次
       indj001       LIKE indj_t.indj001, #來源要貨單號
       indj002       LIKE indj_t.indj002, #來源要貨項次
       indj003       LIKE indj_t.indj003, #要貨組織
       indj003_desc  LIKE ooefl_t.ooefl003,
       indj020       LIKE indj_t.indj020, #需求對象
       indj020_desc  LIKE ooefl_t.ooefl003,
       indj004       LIKE indj_t.indj004, #商品編號
       indj004_desc  LIKE imaal_t.imaal003,
       indj004_desc_1 LIKE imaal_t.imaal004,
       indj005       LIKE indj_t.indj005, #產品特徵
       indj006       LIKE indj_t.indj006, #要貨包裝單位
       indj006_desc  LIKE oocal_t.oocal003,
       indj007       LIKE indj_t.indj007, #要貨包裝數量
       indj008       LIKE indj_t.indj008, #庫存單位
       indj008_desc  LIKE oocal_t.oocal003,
       indj009       LIKE indj_t.indj009, #要貨數量
       indj010       LIKE indj_t.indj010, #此次分配數量
       indj022       LIKE indj_t.indj022, #已裝箱量     #161220-00037#4 Add By Ken 161222
       indj011       LIKE indj_t.indj011, #未分配數量
       indj018       LIKE indj_t.indj018, #多庫儲批發貨
       indjsite      LIKE indj_t.indjsite,
       indjsite_desc LIKE ooefl_t.ooefl003,
       indj012       LIKE indj_t.indj012, #發貨庫位
       indj012_desc  LIKE inayl_t.inayl003,
       indj013       LIKE indj_t.indj013, #發貨儲位
       indj013_desc  LIKE inab_t.inab003,
       indj014       LIKE indj_t.indj014, #發貨批號
       indj019       LIKE indj_t.indj019, #庫存管理特徵
       indjunit      LIKE indj_t.indjunit,
       indjunit_desc LIKE ooefl_t.ooefl003,
       indj015       LIKE indj_t.indj015, #收貨庫位
       indj015_desc  LIKE inayl_t.inayl003,
       indj016       LIKE indj_t.indj016, #收貨儲位
       indj016_desc  LIKE inab_t.inab003,
       indj017       LIKE indj_t.indj017,  #收貨批號
       indj023       LIKE indj_t.indj023   #結束碼    #161220-00037#4 Add By Ken 161222
                     END RECORD
DEFINE g_detail2_cnt         LIKE type_t.num5      
DEFINE g_detail2_d           DYNAMIC ARRAY OF type_g_detail2_d
DEFINE g_detail_idx          LIKE type_t.num5
DEFINE g_detail_idx2         LIKE type_t.num5
DEFINE g_cnt1                LIKE type_t.num10     
DEFINE g_deteal_cnt          LIKE type_t.num10     
DEFINE g_aw                  STRING                        #確定當下點擊的單身 
DEFINE g_detail_d_t          type_g_detail_d
DEFINE g_slip_wc             STRING
DEFINE g_wc1                 STRING                     
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明 name="global.argv"
DEFINE g_default_flag  LIKE type_t.num5
DEFINE g_total_cnt     LIKE type_t.num10      #161220-00037#4 Add By ken 161227 記選取幾筆資料
#end add-point
 
{</section>}
 
{<section id="ainp705.main" >}
#+ 作業開始 
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   DEFINE ls_js  STRING
   #add-point:main段define name="main.define"
   
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義 name="main.before_ap_init"
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("ain","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js name="main.background"
   
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_ainp705 WITH FORM cl_ap_formpath("ain",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL ainp705_init()   
 
      #進入選單 Menu (="N")
      CALL ainp705_ui_dialog() 
 
      #add-point:畫面關閉前 name="main.before_close"
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_ainp705
   END IF 
   
   #add-point:作業離開前 name="main.exit"
   CALL s_aint700_drop_tmp()
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="ainp705.init" >}
#+ 畫面資料初始化
PRIVATE FUNCTION ainp705_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point   
   #add-point:init段define name="init.define"
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_session_id    LIKE type_t.num20
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化 name="init.init"
   CALL cl_set_combo_scc_part('b_indj021','6982','N,Y,0')
   #161220-00037#4 Add By Ken 161222(S)
   CALL cl_set_combo_scc('b_indi007','6874') 
   CALL cl_set_combo_scc_part('b_indj023','6875','N,Y')
   CALL cl_set_combo_scc_part('indj023_1','6875','N,Y')
   #161220-00037#4 Add By Ken 161222(E)
   SELECT USERENV('SESSIONID') INTO l_session_id FROM DUAL
   DISPLAY "------------------------------"
   DISPLAY "SessionId: ",l_session_id   
   DISPLAY "------------------------------"   
   CALL s_aint700_create_tmp() RETURNING l_success   
   LET g_default_flag = TRUE
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="ainp705.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION ainp705_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point 
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define name="init.init"
   DEFINE l_success      LIKE type_t.num5
   DEFINE l_indjdocno    LIKE indj_t.indjdocno
   DEFINE l_indj020      LIKE indj_t.indj020
   DEFINE l_indjdocno_p  STRING
   DEFINE l_indj020_p    STRING
   DEFINE l_sql          STRING
   DEFINE l_indi007_cnt1 LIKE type_t.num10
   DEFINE l_indi007_cnt2 LIKE type_t.num10
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING   
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog name="ui_dialog.before_dialog"
   
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL ainp705_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct name="ui_dialog.more_construct"
         
         #end add-point
         #add-point:ui_dialog段input name="ui_dialog.more_input"
         
         #end add-point
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         #DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTES(COUNT=g_detail_cnt)  
         
         INPUT ARRAY g_detail_d FROM s_detail1.* 
            ATTRIBUTE(COUNT = g_detail2_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                     INSERT ROW = FALSE,DELETE ROW = FALSE, APPEND ROW = FALSE)         

            BEFORE INPUT
               LET g_current_page = 1
               CALL cl_set_act_visible("filter",FALSE)
               CALL ainp705_set_entry()
               CALL ainp705_set_no_entry()               
               
    
            BEFORE ROW
               #顯示單身筆數
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               IF g_detail_idx > g_detail_d.getLength() THEN
                  LET g_detail_idx = g_detail_d.getLength()
               END IF
               IF g_detail_idx = 0 AND g_detail_d.getLength() <> 0 THEN
                  LET g_detail_idx = 1
               END IF
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_detail_d.getLength() TO FORMONLY.h_count
               CALL ainp705_fetch()
               CALL ainp705_set_entry()
               CALL ainp705_set_no_entry()               

                         
         END INPUT
         DISPLAY ARRAY g_detail2_d TO s_detail2.*
            ATTRIBUTES(COUNT=g_detail_cnt)
         
            BEFORE DISPLAY
               LET g_current_page = 2
               CALL cl_set_act_visible("filter",FALSE)
               
            BEFORE ROW
               LET g_detail_idx2 = DIALOG.getCurrentRow("s_detail2")
               LET l_ac = g_detail_idx2
               DISPLAY g_detail_idx2 TO FORMONLY.idx
               DISPLAY g_detail2_d.getLength() TO FORMONLY.cnt
         END DISPLAY
       
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            IF g_default_flag THEN
               CALL ainp705_b_fill()   
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            CALL ainp705_set_entry()
            CALL ainp705_set_no_entry()  
            NEXT FIELD l_sel            
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall name="ui_dialog.selall.befroe"
            
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall name="ui_dialog.for.onaction_selall"
               
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall name="ui_dialog.onaction_selall"
            
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone name="ui_dialog.for.onaction_selnone"
               
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone name="ui_dialog.onaction_selnone"
            
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel name="ui_dialog.onaction_sel"
            
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel name="ui_dialog.onaction_unsel"
            
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL ainp705_filter()
            #add-point:ON ACTION filter name="menu.filter"
            
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前 name="menu.filter"
            
            #end add-point
            CALL ainp705_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段 name="ui_dialog.qbeclear"
            
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh name="ui_dialog.datarefresh"
            
            #end add-point
            CALL ainp705_b_fill()
 
         #add-point:ui_dialog段action name="ui_dialog.more_action"
         ON ACTION query_1
            CALL ainp705_construct()
            CALL ainp705_set_entry()
            CALL ainp705_set_no_entry()            
            
         ON ACTION batch_execute    
            CALL cl_err_collect_init()             
            CALL ainp705_process() RETURNING l_success
            CALL cl_err_collect_show()
            
         ON ACTION print_1
            #CALL ainp705_ins_tmp() RETURNING l_success     #20161118 mark by beckxie
            CALL ainp705_ins_tmp('1') RETURNING l_success   #20161118  add by beckxie
            LET l_sql = " SELECT SUM(indi007_1),SUM(indi007_2) ",
                        "   FROM ( ",
                        "        SELECT indidocno,CASE WHEN indi007 IN('1','2') THEN 1 ELSE 0 END indi007_1, ",
                        "                         CASE WHEN indi007 = '3' THEN 1 ELSE 0 END indi007_2 ",
                        "          FROM indi_t WHERE indient = ",g_enterprise,
                        "           AND EXISTS(SELECT 1 FROM s_aint700_tmp01 WHERE indidocno = l_indjdocno)) "
            PREPARE ainp705_indi007_cnt_pre FROM l_sql
            EXECUTE ainp705_indi007_cnt_pre INTO l_indi007_cnt1,l_indi007_cnt2
            IF l_indi007_cnt1 > 0 AND l_indi007_cnt2 > 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'ain-00834'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CONTINUE DIALOG               
            END IF
            LET l_indjdocno_p = ''
            LET l_indj020_p = ''
            LET l_sql = " SELECT DISTINCT l_indjdocno,l_indj020 ",
                        "   FROM s_aint700_tmp01 "                     
            PREPARE ainp705_sel_tmp_pre FROM l_sql
            DECLARE ainp705_sel_tmp_cur CURSOR FOR ainp705_sel_tmp_pre
            FOREACH ainp705_sel_tmp_cur INTO l_indjdocno,l_indj020
               LET l_indjdocno_p = l_indjdocno_p , l_indjdocno ,"|"
               LET l_indj020_p = l_indj020_p , l_indj020 ,"|"
            END FOREACH            
            LET l_indjdocno_p = l_indjdocno_p.subString(1,l_indjdocno_p.getLength()-1)
            LET l_indj020_p = l_indj020_p.subString(1,l_indj020_p.getLength()-1)
            IF NOT cl_null(l_indjdocno_p) THEN
               LET la_param.prog = 'ainr705'
               LET la_param.param[1] = l_indjdocno_p
               LET la_param.param[2] = ''
               IF l_indi007_cnt1 > 0 THEN
                  LET la_param.param[3] = '1'
               ELSE
                  LET la_param.param[3] = '3'
               END IF
               LET la_param.param[4] = l_indj020_p
               LET la_param.param[5] = '2'
               LET la_param.param[6] = 'ainp705'     #170119-00027#3 Add By Ken 170123
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun(ls_js)
            END IF              
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      #(ver:22) ---start---
      #add-point:ui_dialog段 after dialog name="ui_dialog.exit_dialog"
      
      #end add-point
      #(ver:22) --- end ---
 
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #(ver:22) ---start---
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         #(ver:22) --- end ---
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
{</section>}
 
{<section id="ainp705.query" >}
#+ QBE資料查詢
PRIVATE FUNCTION ainp705_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point 
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define name="query.define"
   
   #end add-point 
    
   #add-point:cs段after_construct name="query.after_construct"
 
   #end add-point
        
   LET g_error_show = 1
   CALL ainp705_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query name="query.cs_after_query"
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="ainp705.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION ainp705_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point
   DEFINE ls_wc           STRING
   #add-point:b_fill段define name="b_fill.define"
   DEFINE l_indi007       LIKE indi_t.indi007
   DEFINE l_wc_tmp        STRING
   #end add-point
 
   LET g_wc = g_wc, cl_sql_auth_filter()   #(ver:21) add cl_sql_auth_filter()
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"

   IF cl_null(g_wc) THEN 
      LET g_wc = " 1=1"
   END IF  
   #IF NOT cl_null(g_slip_wc) THEN
   #   LET g_wc = g_wc," AND ",g_slip_wc
   #END IF   
   IF g_default_flag THEN
      LET l_wc_tmp = " indj021 = 'N' "  
      LET g_default_flag = FALSE 
   ELSE
      LET l_wc_tmp = " 1 = 1 "
   END IF
   LET g_sql = #161208-00023#2 Add By ken 161208(S)
               "SELECT sel,indi001,indj020,indj020_desc,indj001, ",
               "       indidocno,indidocdt,indi005,indi003,  ",
               "       indi003_desc,indi004,indi004_desc,indj010,indj021, ",
               "       indi007,indj022,indj023 ",    #161220-00037#4 Add By Ken 161222
               "  FROM ( ",
               #161208-00023#2 Add By ken 161208(E)
               "SELECT 'N' sel,indi001,indj020,(SELECT pmaal003 FROM pmaal_t WHERE pmaalent = indjent AND pmaal001 = indj020 AND pmaal002 ='"||g_dlang||"') indj020_desc, ",
               "       indj001,indidocno,indidocdt,indi005, ",   #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
               "       indi003, (SELECT ooag011 FROM ooag_t WHERE ooagent = indient AND ooag001 = indi003) indi003_desc,",
               "       indi004, (SELECT ooefl003 FROM ooefl_t WHERE ooeflent = indient AND ooefl001 = indi004 AND ooefl002 ='"||g_dlang||"') indi004_desc, ",
               "       SUM(COALESCE(indj010,0))indj010,indj021, ", 
               "       indi007,SUM(COALESCE(indj022,0))indj022,indj023 ",   #161220-00037#4 Add By Ken 161222
               "  FROM indj_t,indi_t ",
               " WHERE indjent = indient AND indjdocno = indidocno AND indistus ='Y' ",
               "   AND indjent = ? ",
               "   AND ",g_wc CLIPPED,   
               "   AND ",l_wc_tmp ,
               " GROUP BY indjent,indient,indi001,indj020,indj001,indidocno,indidocdt,indi005,indi003,indi004,indj021, ",   #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
               "          indi007,indj023 ",  #161220-00037#4 Add By ken 161223
               #161208-00023#2 Add By ken 161208(S)
               " ) ",   
               " WHERE indj010 <> 0 ",    #161230-00009#1 Add By Ken 161230
               #161208-00023#2 Add By ken 161208(E)
               " ORDER BY indi001,indj020,indj001 "
   #end add-point
 
   PREPARE ainp705_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR ainp705_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空 name="b_fill.clear"
   
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into name="b_fill.foreach_into"
           g_detail_d[l_ac].sel           ,g_detail_d[l_ac].indi001       ,g_detail_d[l_ac].indj020       ,
           g_detail_d[l_ac].indj020_desc  ,g_detail_d[l_ac].indj001       ,g_detail_d[l_ac].indidocno     ,
           g_detail_d[l_ac].indidocdt     ,g_detail_d[l_ac].indi005       ,g_detail_d[l_ac].indi003       ,g_detail_d[l_ac].indi003_desc  ,   #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
           g_detail_d[l_ac].indi004       ,g_detail_d[l_ac].indi004_desc  ,g_detail_d[l_ac].indj010       ,
           g_detail_d[l_ac].indj021       ,
           g_detail_d[l_ac].indi007       ,g_detail_d[l_ac].indj022       ,g_detail_d[l_ac].indj023       
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充 name="b_fill.foreach_iside"
      #161220-00037#4 Mark By ken 161223(S)
      #SELECT indi007 INTO l_indi007
      #  FROM indi_t
      # WHERE indient = g_enterprise
      #   AND indidocno = g_detail_d[l_ac].indidocno
      #161220-00037#4 Mark By ken 161223(E)
      
      #IF l_indi007 = '3' THEN   #來源訂單      #161220-00037#4 Mark By ken 161223
      IF g_detail_d[l_ac].indi007 = '3' THEN   #161220-00037#4 Add By ken 161223
         CALL s_desc_get_trading_partner_full_desc(g_detail_d[l_ac].indj020) 
          RETURNING g_detail_d[l_ac].indj020_desc
      ELSE 
         CALL s_desc_get_department_desc(g_detail_d[l_ac].indj020) 
          RETURNING g_detail_d[l_ac].indj020_desc      
      END IF
      #end add-point
      
      CALL ainp705_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身) name="b_fill.other_table"
   CALL g_detail_d.deleteElement(g_detail_d.getLength())
   LET g_detail_idx = l_ac - 1
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE ainp705_sel
   
   LET l_ac = 1
   CALL ainp705_fetch()
   #add-point:b_fill段資料填充(其他單身) name="b_fill.after_b_fill"
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="ainp705.fetch" >}
#+ 單身陣列填充2
PRIVATE FUNCTION ainp705_fetch()
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define name="fetch.define"
   DEFINE l_indi007       LIKE indi_t.indi007
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後 name="fetch.after_fill"
   CALL g_detail2_d.clear()
   IF g_detail_idx = 0 THEN
      LET g_detail_idx = 1
   END IF
 
          LET g_sql = "SELECT  DISTINCT indjseq,      indj001,     indj002,     indj003,      t0.ooefl003, ",
                      "                 indj020,      indj004,     t1.imaal003, t1.imaal004,  indj005,     ",
                      "                 indj006,      t2.oocal003, indj007,     indj008,      t3.oocal003, ",
                      "                 indj009,      indj010,     indj011,     indj018,      indjsite,    ",  
                      "                 t4.ooefl003,  indj012,     t5.inayl003, indj013,      t6.inab003,  ",
                      "                 indj014,      indj019,     indjunit,    t7.ooefl003,  indj015,     ",
                      "                 t8.inayl003,  indj016,     t9.inab003,  indj017,      ",
                      "                 indj022,      indj023  ",    #161220-00037#4 Add By Ken 161222 
               " FROM indj_t",                
               " INNER JOIN indi_t ON indient = " ||g_enterprise|| " AND indidocno = indjdocno ", 
               " LEFT JOIN ooefl_t t0  ON t0.ooeflent="||g_enterprise||" AND t0.ooefl001=indj003  AND t0.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t1  ON t1.imaalent="||g_enterprise||" AND t1.imaal001=indj004  AND t1.imaal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t2  ON t2.oocalent="||g_enterprise||" AND t2.oocal001=indj006  AND t2.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t3  ON t3.oocalent="||g_enterprise||" AND t3.oocal001=indj008  AND t3.oocal002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t4  ON t4.ooeflent="||g_enterprise||" AND t4.ooefl001=indjsite AND t4.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t5  ON t5.inaylent="||g_enterprise||" AND t5.inayl001=indj012  AND t5.inayl002='"||g_dlang||"' ",
               " LEFT JOIN inab_t  t6  ON t6.inabent=" ||g_enterprise||" AND t6.inabsite=indjsite AND t6.inab001=indj012 AND t6.inab002=indj013  ",
               " LEFT JOIN ooefl_t t7  ON t7.ooeflent="||g_enterprise||" AND t7.ooefl001=indjunit AND t7.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t8  ON t8.inaylent="||g_enterprise||" AND t8.inayl001=indj015  AND t8.inayl002='"||g_dlang||"' ",
               " LEFT JOIN inab_t  t9  ON t9.inabent="||g_enterprise||"  AND t9.inabsite=indjsite AND t9.inab001=indj015 AND t9.inab002=indj016  ",
               " WHERE indjent=? AND indjdocno = '",g_detail_d[g_detail_idx].indidocno CLIPPED,"'",
               "   AND indj001 = '",g_detail_d[g_detail_idx].indj001 CLIPPED,"'",
               #161220-00037#4 Add By Ken 161222(S)
               "   AND indj020 = '",g_detail_d[g_detail_idx].indj020 CLIPPED,"'",   
               "   AND indj021 = '",g_detail_d[g_detail_idx].indj021 CLIPPED,"'",   
               "   AND indj023 = '",g_detail_d[g_detail_idx].indj023 CLIPPED,"'",   
               #161220-00037#4 Add By Ken 161222(E)
               " ORDER BY indjseq "
   PREPARE ainp705_fetch_pre FROM g_sql
   DECLARE ainp705_fetch_cs CURSOR FOR ainp705_fetch_pre
   
   #DISPLAY "ainp705_fetch_cs[SQL] ",g_sql
   
   LET l_ac = 1
   
   FOREACH ainp705_fetch_cs USING g_enterprise INTO 
         g_detail2_d[l_ac].indjseq      , g_detail2_d[l_ac].indj001        , g_detail2_d[l_ac].indj002      ,g_detail2_d[l_ac].indj003        ,g_detail2_d[l_ac].indj003_desc      , 
         g_detail2_d[l_ac].indj020      , g_detail2_d[l_ac].indj004        , g_detail2_d[l_ac].indj004_desc ,g_detail2_d[l_ac].indj004_desc_1 ,g_detail2_d[l_ac].indj005           ,
         g_detail2_d[l_ac].indj006      , g_detail2_d[l_ac].indj006_desc   , g_detail2_d[l_ac].indj007      ,g_detail2_d[l_ac].indj008        ,g_detail2_d[l_ac].indj008_desc      ,      
         g_detail2_d[l_ac].indj009      , g_detail2_d[l_ac].indj010        , g_detail2_d[l_ac].indj011      ,g_detail2_d[l_ac].indj018        ,g_detail2_d[l_ac].indjsite          ,  
         g_detail2_d[l_ac].indjsite_desc, g_detail2_d[l_ac].indj012        , g_detail2_d[l_ac].indj012_desc ,g_detail2_d[l_ac].indj013        ,g_detail2_d[l_ac].indj013_desc      ,
         g_detail2_d[l_ac].indj014      , g_detail2_d[l_ac].indj019        , g_detail2_d[l_ac].indjunit     ,g_detail2_d[l_ac].indjunit_desc  ,g_detail2_d[l_ac].indj015           ,  
         g_detail2_d[l_ac].indj015_desc , g_detail2_d[l_ac].indj016        , g_detail2_d[l_ac].indj016_desc ,g_detail2_d[l_ac].indj017        , 
         g_detail2_d[l_ac].indj022      , g_detail2_d[l_ac].indj023            #161220-00037#4 Add By Ken 161222 
         
         SELECT indi007 INTO l_indi007
           FROM indi_t
          WHERE indient = g_enterprise
            AND indidocno = g_detail_d[g_detail_idx].indidocno
         
         IF l_indi007 = '3' THEN   #來源訂單
            CALL s_desc_get_trading_partner_full_desc(g_detail2_d[l_ac].indj020) 
             RETURNING g_detail2_d[l_ac].indj020_desc
         ELSE 
            CALL s_desc_get_department_desc(g_detail2_d[l_ac].indj020) 
             RETURNING g_detail2_d[l_ac].indj020_desc      
         END IF

      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code =  9035
            LET g_errparam.extend =  ""
            LET g_errparam.popup = TRUE
            CALL cl_err()
  
         END IF
         EXIT FOREACH
      END IF   
   END FOREACH   
  
   CALL g_detail2_d.deleteElement(l_ac)
   LET g_detail2_cnt = l_ac - 1 
   DISPLAY g_detail2_cnt TO FORMONLY.cnt  
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
 
{</section>}
 
{<section id="ainp705.detail_show" >}
#+ 顯示相關資料
PRIVATE FUNCTION ainp705_detail_show()
   #add-point:show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point
   #add-point:show段define name="detail_show.define"
   
   #end add-point
   
   #add-point:detail_show段 name="detail_show.detail_show"
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="ainp705.filter" >}
#+ filter過濾功能
PRIVATE FUNCTION ainp705_filter()
   #add-point:filter段define(客製用) name="filter.define_customerization"
   
   #end add-point    
   #add-point:filter段define name="filter.define"
   
   #end add-point
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define name="filter.detail_cnt"
   
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL ainp705_b_fill()
   
END FUNCTION
 
{</section>}
 
{<section id="ainp705.filter_parser" >}
#+ filter欄位解析
PRIVATE FUNCTION ainp705_filter_parser(ps_field)
   #add-point:filter段define(客製用) name="filter_parser.define_customerization"
   
   #end add-point    
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define name="filter_parser.define"
   
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="ainp705.filter_show" >}
#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION ainp705_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = ainp705_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="ainp705.other_function" readonly="Y" >}
#add-point:自定義元件(Function) name="other.function"

################################################################################
# Descriptions...: 查詢按鈕的功能
# Memo...........:
# Usage..........: CALL ainp705_construct()
# Input parameter: 
# Return code....: 
# Date & Author..: 2016/11/11 By Ken
# Modify.........:
################################################################################
PRIVATE FUNCTION ainp705_construct()
   CALL g_detail_d.clear()
   CALL g_detail2_d.clear()
   CLEAR FORM
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      CONSTRUCT g_wc 
             ON indi001,indj020,indj001,indidocno,indidocdt,indi005,indi003,indi004,indj021,                   #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
                indi007,indj023       #161220-00037#4 Add By Ken 161222
           FROM b_indi001,b_indj020,b_indj001,b_indidocno,b_indidocdt,b_indi005,b_indi003,b_indi004,b_indj021,   #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
                b_indi007,b_indj023   #161220-00037#4 Add By Ken 161222
         BEFORE CONSTRUCT
            CALL cl_set_act_visible("filter",FALSE)

         ON ACTION controlp INFIELD b_indj020
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_indj020()                          #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_indj020   #顯示到畫面上
            NEXT FIELD b_indj020                      #返回原欄位            
     

         ON ACTION controlp INFIELD b_indj001       
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = "pmcz032 = '2'"
            CALL q_pmcz001_1()
            DISPLAY g_qryparam.return1 TO b_indj001           
            NEXT FIELD b_indj001
            
 
         ON ACTION controlp INFIELD b_indidocno            
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_indidocno()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_indidocno    #顯示到畫面上
            NEXT FIELD b_indidocno   
            
          
         ON ACTION controlp INFIELD b_indi003
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE			   
			   CALL q_ooag001()      
            DISPLAY g_qryparam.return1 TO b_indi003  #顯示到畫面上
            NEXT FIELD b_indi003                     #返回原欄位
               

         ON ACTION controlp INFIELD b_indi004
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_4()                       #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_indi004  #顯示到畫面上
            NEXT FIELD b_indi004                     #返回原欄位
            
         AFTER CONSTRUCT
      
      END CONSTRUCT

      BEFORE DIALOG
         LET g_detail_d[1].sel = ""
         DISPLAY ARRAY g_detail_d TO s_detail1.*
            BEFORE DISPLAY
            LET l_ac = 1
               EXIT DISPLAY
         END DISPLAY
         #LET g_detail2_d[1].xmdlseq = ""
         #DISPLAY ARRAY g_detail2_d TO s_detail2.*
         #   BEFORE DISPLAY
         #      EXIT DISPLAY
         #END DISPLAY
         
      ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            #end add-point
            CALL ainp705_query()
           
            ACCEPT DIALOG 
                          
      #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
   END DIALOG 
END FUNCTION

################################################################################
# Descriptions...: 欄位輸入控制
# Memo...........:
# Usage..........: CALL ainp705_set_entry()
# Date & Author..: 2016/11/11 By Ken
# Modify.........:
################################################################################
PRIVATE FUNCTION ainp705_set_entry()
   CALL cl_set_comp_entry('b_indi001',TRUE)
   CALL cl_set_comp_entry('b_indj020',TRUE)
   CALL cl_set_comp_entry('b_indj001',TRUE)
   CALL cl_set_comp_entry('b_indidocno',TRUE)
   CALL cl_set_comp_entry('b_indidocdt',TRUE)   
   CALL cl_set_comp_entry('b_indi005',TRUE)      #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
   CALL cl_set_comp_entry('b_indi003',TRUE)
   CALL cl_set_comp_entry('b_indi004',TRUE)
   CALL cl_set_comp_entry('b_indj010',TRUE) 
   CALL cl_set_comp_entry('b_indj021',TRUE)    
END FUNCTION

################################################################################
# Descriptions...: 欄位輸入控制
# Memo...........:
# Usage..........: CALL ainp705_set_no_entry()
# Date & Author..: 2016/11/11 By Ken
# Modify.........:
################################################################################
PRIVATE FUNCTION ainp705_set_no_entry()
   CALL cl_set_comp_entry('b_indi001',FALSE)
   CALL cl_set_comp_entry('b_indj020',FALSE)
   CALL cl_set_comp_entry('b_indj001',FALSE)
   CALL cl_set_comp_entry('b_indidocno',FALSE)
   CALL cl_set_comp_entry('b_indidocdt',FALSE)
   CALL cl_set_comp_entry('b_indi005',FALSE)       #161109-00078#15  2016/11/22  Modify By Rainy:加上備註(indi005)
   CALL cl_set_comp_entry('b_indi003',FALSE)
   CALL cl_set_comp_entry('b_indi004',FALSE)
   CALL cl_set_comp_entry('b_indj010',FALSE) 
   CALL cl_set_comp_entry('b_indj021',FALSE)  
END FUNCTION

################################################################################
# Descriptions...: 產生裝箱號處理段
# Memo...........:
# Usage..........: CALL ainp705_process()
# Input parameter: 
# Return code....: 
# Date & Author..: 2016/11/11 By Ken
# Modify.........:
################################################################################
PRIVATE FUNCTION ainp705_process()
DEFINE l_sql            STRING
DEFINE li_idx           LIKE type_t.num10
DEFINE l_cnt            LIKE type_t.num10
DEFINE r_success        LIKE type_t.num5

   LET r_success = TRUE
   
   WHENEVER ERROR CONTINUE
     
   #IF NOT ainp705_ins_tmp() THEN      #20161118  mark by beckxie
   IF NOT ainp705_ins_tmp('2') THEN    #20161118   add by beckxie
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   CALL s_transaction_begin() 
   #IF NOT s_aint700_gen_aint701('2','','') THEN              #161220-00037#4 Mark By ken 161227
   IF NOT s_aint700_gen_aint701('2','','',g_total_cnt) THEN   #161220-00037#4 Add By ken 161227
      CALL s_transaction_end('N','0')
      LET r_success = FALSE      
      RETURN r_success
   ELSE
      CALL s_transaction_end('Y','1')
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 將選取的資料寫入tmp table
# Memo...........:
# Usage..........: CALL ainp705_ins_tmp(p_type)
# Input parameter: p_type       1:打印/2:執行批次 
# Return code....: 
# Date & Author..: 2016/11/15 By Ken
# Modify.........: 20161118 modify by beckxie(增加傳參p_type:若為打印呼叫,不檢查是否已經拋轉過)
################################################################################
PRIVATE FUNCTION ainp705_ins_tmp(p_type)
DEFINE p_type           LIKE type_t.chr1    #20161118 add by beckxie 增加傳參p_type:若為打印呼叫,不檢查是否已經拋轉過
DEFINE l_sql            STRING
DEFINE li_idx           LIKE type_t.num10
DEFINE l_cnt            LIKE type_t.num10
DEFINE l_err_cnt        LIKE type_t.num10
DEFINE l_total_cnt      LIKE type_t.num10
#161220-00037#4 Add By Ken 161222(S)
DEFINE l_indisite       LIKE indi_t.indisite
DEFINE l_slip           LIKE ooba_t.ooba002      #單據別   
DEFINE l_CIR004         LIKE gzcb_t.gzcb002      #單項是否允許多次發貨
DEFINE l_CIR009         LIKE gzcb_t.gzcb002      #未確認裝箱部分是否重複拋轉
DEFINE l_success        LIKE type_t.num10
#161220-00037#4 Add By Ken 161222(E)   
DEFINE r_success        LIKE type_t.num5

   LET r_success = TRUE
   
   LET g_total_cnt = 0  #161220-00037#4 Add By Ken 161227
   
   WHENEVER ERROR CONTINUE
   
   LET l_sql = "DELETE FROM s_aint700_tmp01 "
   PREPARE ainp705_tmp_del FROM l_sql
   EXECUTE ainp705_tmp_del   
   
   #檢查是否存在tmp table
   LET l_sql = " SELECT COUNT(1) ",
               "   FROM s_aint700_tmp01 ",
               "  WHERE l_indjdocno = ? ",
               "    AND l_indj001 = ? ",
               "    AND l_indj020 = ? ",
   #161220-00037#4 Add By Ken 161223(S)            
               "    AND l_indj021 = ? ",
               "    AND l_indj023 = ? ",
               "    AND l_CIR004 = ? ",
               "    AND l_CIR009 = ? ",
               "    AND l_indi007 = ? "
   #161220-00037#4 Add By Ken 161223(E)
   PREPARE ainp705_cnt_sel FROM l_sql 
   
   #161220-00037#4 Add By Ken 161226(S)
   #取得配送組織
   LET l_sql = " SELECT indisite ",
               "   FROM indi_t ",
               "  WHERE indient = ",g_enterprise,
               "    AND indidocno = ? "
   PREPARE ainp705_indisite_sel FROM l_sql
   #161220-00037#4 Add By Ken 161226(E)   
   
   #寫入tmp table
   #161220-00037#4 Mark By ken 161223(S)
   #LET l_sql = " INSERT INTO s_aint700_tmp01 (indjdocno,indj001,indj020) ",
   #            "  VALUES(?,?,?) "
   #161220-00037#4 Mark By ken 161223(E)
   #161220-00037#4 Add By ken 161223(S)
   LET l_sql = " INSERT INTO s_aint700_tmp01 (l_indjdocno,l_indj001,l_indj020,l_indj021,l_indj023,l_CIR004,l_CIR009,l_indi007) ",
               "  VALUES(?,?,?,?,?,?,?,?) "      
   #161220-00037#4 Add By ken 161223(E)               
   PREPARE ainp705_ins_tmp FROM l_sql    
   LET l_err_cnt = 0
   LET l_total_cnt = 0
   FOR li_idx = 1 TO g_detail_d.getLength()
      LET l_cnt = 0        
      IF g_detail_d[li_idx].sel = "Y" THEN        
         LET g_total_cnt = g_total_cnt + 1       
         #161220-00037#4 Mark By Ken 161227(S)         
         #IF p_type = '2' THEN   #20161118 add by beckxie
         #   IF g_detail_d[li_idx].indj021 = "Y" THEN 
         #      INITIALIZE g_errparam TO NULL
         #      LET g_errparam.extend = ''
         #      LET g_errparam.code   = "ain-00835"
         #      LET g_errparam.popup  = TRUE
         #      LET g_errparam.replace[1] = g_detail_d[li_idx].indidocno
         #      LET g_errparam.replace[2] = g_detail_d[li_idx].indj001
         #      LET g_errparam.replace[3] = g_detail_d[li_idx].indj020            
         #      CALL cl_err()   
         #      LET l_err_cnt = l_err_cnt + 1  
         #      CONTINUE FOR            
         #   END IF
         #END IF    #20161118 add by beckxie
         #161220-00037#4 Mark By Ken 161227(E)         
         #161220-00037#4 Add By Ken 161222(S)
         # 取出單號的單別(需求類型的單別)(S)
         LET l_success = ''
         LET l_slip = ''
         CALL s_aooi200_get_slip(g_detail_d[li_idx].indj001)
            RETURNING l_success,l_slip
         
         # 依各來源類型不同 取對應的單據別參數(單項是否允許多次發貨)
         LET l_CIR004 = ''
         CALL cl_get_doc_para(g_enterprise,g_site,l_slip,'D-CIR-0004')
            RETURNING l_CIR004  
         # 取出單號的單別(需求類型的單別)(E)
         
         # 取出單號的單別(配送單號的單別)(S)
         LET l_success = ''
         LET l_slip = ''
         CALL s_aooi200_get_slip(g_detail_d[li_idx].indidocno)
            RETURNING l_success,l_slip            
         # 依各來源類型不同 取對應的單據別參數(未確認裝箱部分是否重複拋轉)
         
         #取得配送組織
         LET l_indisite = ''
         EXECUTE ainp705_indisite_sel USING g_detail_d[li_idx].indidocno INTO l_indisite
         LET l_CIR009 = ''
         CALL cl_get_doc_para(g_enterprise,l_indisite,l_slip,'D-CIR-0009')
            RETURNING l_CIR009
         # 取出單號的單別(配送單號的單別)(E)            
         #161220-00037#4 Add By Ken 161222(E)          
         EXECUTE ainp705_cnt_sel USING g_detail_d[li_idx].indidocno,g_detail_d[li_idx].indj001,g_detail_d[li_idx].indj020,
                                       g_detail_d[li_idx].indj021,g_detail_d[li_idx].indj023,l_CIR004,l_CIR009,g_detail_d[li_idx].indi007  #161220-00037#4 Add By Ken 161223
         
            INTO l_cnt
         IF l_cnt = 0 THEN
            EXECUTE ainp705_ins_tmp USING g_detail_d[li_idx].indidocno,g_detail_d[li_idx].indj001,g_detail_d[li_idx].indj020,
                                          g_detail_d[li_idx].indj021,g_detail_d[li_idx].indj023,l_CIR004,l_CIR009,g_detail_d[li_idx].indi007  #161220-00037#4 Add By Ken 161223
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'ainp705_ins_tmp'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
               RETURN r_success
            END IF             
         END IF        
      END IF
   END FOR
   #161220-00037#4 Mark By Ken 161227(S)   
   #IF (l_err_cnt > 0) AND (l_total_cnt = l_err_cnt) THEN
   #   LET r_success = FALSE
   #   RETURN r_success 
   #END IF 
   #161220-00037#4 Mark By Ken 161227(E)
      
   RETURN r_success
END FUNCTION

#end add-point
 
{</section>}
 
