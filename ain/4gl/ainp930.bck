#該程式未解開Section, 採用最新樣板產出!
{<section id="ainp930.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0003(2014-12-23 15:25:18), PR版次:0003(2016-12-09 14:14:36)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000078
#+ Filename...: ainp930
#+ Description: 存貨週轉率計算作業
#+ Creator....: 01534(2014-12-22 10:38:10)
#+ Modifier...: 01534 -SD/PR- 08734
 
{</section>}
 
{<section id="ainp930.global" >}
#應用 p01 樣板自動產生(Version:19)
#add-point:填寫註解說明 name="global.memo" name="global.memo"
#160318-00025#23    16/04/22   BY 07900   校验代码重复错误讯息的修改
#161124-00048#4     16/12/09   By 08734   星号整批调整
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_schedule
#add-point:增加匯入項目 name="global.import"

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
GLOBALS "../../cfg/top_schedule.inc"
GLOBALS
   DEFINE gwin_curr2  ui.Window
   DEFINE gfrm_curr2  ui.Form
   DEFINE gi_hiden_asign       LIKE type_t.num5
   DEFINE gi_hiden_exec        LIKE type_t.num5
   DEFINE gi_hiden_spec        LIKE type_t.num5
   DEFINE gi_hiden_exec_end    LIKE type_t.num5
   DEFINE g_chk_jobid          LIKE type_t.num5
END GLOBALS
 
PRIVATE TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable) name="global.parameter"
   
   #end add-point
        wc               STRING
                     END RECORD
 
DEFINE g_sql             STRING        #組 sql 用
DEFINE g_forupd_sql      STRING        #SELECT ... FOR UPDATE  SQL
DEFINE g_error_show      LIKE type_t.num5
DEFINE g_jobid           STRING
DEFINE g_wc              STRING
 
PRIVATE TYPE type_master RECORD
       inpo001 LIKE type_t.chr10, 
   inpo002 LIKE type_t.chr500, 
   inpo003 LIKE type_t.chr1, 
   inpo004 LIKE type_t.chr1, 
   inpo005 LIKE type_t.chr1, 
   yy LIKE type_t.chr500, 
   mm LIKE type_t.chr500, 
   print01 LIKE type_t.chr1, 
   stagenow LIKE type_t.chr80,
       wc               STRING
       END RECORD
 
#模組變數(Module Variables)
DEFINE g_master type_master
 
#add-point:自定義模組變數(Module Variable) name="global.variable"
DEFINE g_master_t   type_master
DEFINE g_stage      LIKE type_t.num5
DEFINE g_ooef017    LIKE ooef_t.ooef017
DEFINE g_glaa014    LIKE glaa_t.glaa014
DEFINE g_glaald     LIKE glaa_t.glaald     #wujie 151014 014 -->ld
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明 name="global.argv"

#end add-point
 
{</section>}
 
{<section id="ainp930.main" >}
MAIN
   #add-point:main段define (客製用) name="main.define_customerization"
   
   #end add-point 
   DEFINE ls_js    STRING
   DEFINE lc_param type_parameter  
   #add-point:main段define name="main.define"
   
   #end add-point 
  
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義 name="main.before_ap_init"
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("ain","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js name="main.background"
   
   #end add-point
 
   #背景(Y) 或半背景(T) 時不做主畫面開窗
   IF g_bgjob = "Y" OR g_bgjob = "T" THEN
      #排程參數由01開始，若不是1開始，表示有保留參數
      LET ls_js = g_argv[01]
     #CALL util.JSON.parse(ls_js,g_master)   #p類主要使用l_param,此處不解析
      #add-point:Service Call name="main.servicecall"
      
      #end add-point
      CALL ainp930_process(ls_js)
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_ainp930 WITH FORM cl_ap_formpath("ain",g_code)
 
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
 
      #程式初始化
      CALL ainp930_init()
 
      #進入選單 Menu (="N")
      CALL ainp930_ui_dialog()
 
      #add-point:畫面關閉前 name="main.before_close"
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_ainp930
   END IF
 
   #add-point:作業離開前 name="main.exit"
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="ainp930.init" >}
#+ 初始化作業
PRIVATE FUNCTION ainp930_init()
 
   #add-point:init段define (客製用) name="init.define_customerization"
   
   #end add-point
   #add-point:ui_dialog段define name="init.define"
   
   #end add-point
 
   LET g_error_show = 1
   LET gwin_curr2 = ui.Window.getCurrent()
   LET gfrm_curr2 = gwin_curr2.getForm()
   CALL cl_schedule_import_4fd()
   CALL cl_set_combo_scc("gzpa003","75")
   IF cl_get_para(g_enterprise,"","E-SYS-0005") = "N" THEN
       CALL cl_set_comp_visible("scheduling_page,history_page",FALSE)
   END IF 
   #add-point:畫面資料初始化 name="init.init"
   CALL cl_set_combo_scc('inpo003','2219')
   CALL cl_set_combo_scc('inpo004','2220')
   CALL cl_set_combo_scc('inpo005','2221')
   LET g_master.print01 = 'N'
   DISPLAY BY NAME g_master.print01
   LET g_master.yy = YEAR(g_today)
   LET g_master.mm = MONTH(g_today)
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="ainp930.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION ainp930_ui_dialog()
 
   #add-point:ui_dialog段define (客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_exit  LIKE type_t.num5    #判別是否為離開作業
   DEFINE li_idx   LIKE type_t.num10
   DEFINE ls_js    STRING
   DEFINE ls_wc    STRING
   DEFINE l_dialog ui.DIALOG
   DEFINE lc_param type_parameter
   #add-point:ui_dialog段define name="ui_dialog.define"
   
   #end add-point
   
   #add-point:ui_dialog段before dialog name="ui_dialog.before_dialog"
   LET g_errshow = 1
   #end add-point
 
   WHILE TRUE
      #add-point:ui_dialog段before dialog2 name="ui_dialog.before_dialog2"
      
      #end add-point
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #應用 a57 樣板自動產生(Version:3)
         INPUT BY NAME g_master.inpo001,g_master.yy,g_master.mm,g_master.print01 
            ATTRIBUTE(WITHOUT DEFAULTS)
            
            #自訂ACTION(master_input)
            
         
            BEFORE INPUT
               #add-point:資料輸入前 name="input.m.before_input"
               
               #end add-point
         
                     #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD inpo001
            
            #add-point:AFTER FIELD inpo001 name="input.a.inpo001"
            IF NOT cl_null(g_master.inpo001) THEN 
#應用 a19 樣板自動產生(Version:2)
               #校驗代值
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_master.inpo001

               #160318-00025#23  by 07900 --add-str
               LET g_errshow = TRUE #是否開窗                   
               LET g_chkparam.err_str[1] ="aap-00118:apr-00152"
               #160318-00025#23  by 07900 --add-end    
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_inpo001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 
               ELSE
                  #檢查失敗時後續處理
                  LET g_master.inpo001 = g_master_t.inpo001
                  CALL ainp930_inpo001_desc()
                  NEXT FIELD CURRENT
               END IF
            
 
            END IF 
            CALL ainp930_inpo001_desc()
            LET g_master_t.inpo001 = g_master.inpo001
            NEXT FIELD yy

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD inpo001
            #add-point:BEFORE FIELD inpo001 name="input.b.inpo001"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE inpo001
            #add-point:ON CHANGE inpo001 name="input.g.inpo001"
 
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD yy
            #add-point:BEFORE FIELD yy name="input.b.yy"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD yy
            
            #add-point:AFTER FIELD yy name="input.a.yy"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE yy
            #add-point:ON CHANGE yy name="input.g.yy"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD mm
            #add-point:BEFORE FIELD mm name="input.b.mm"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD mm
            
            #add-point:AFTER FIELD mm name="input.a.mm"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE mm
            #add-point:ON CHANGE mm name="input.g.mm"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD print01
            #add-point:BEFORE FIELD print01 name="input.b.print01"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD print01
            
            #add-point:AFTER FIELD print01 name="input.a.print01"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE print01
            #add-point:ON CHANGE print01 name="input.g.print01"
            
            #END add-point 
 
 
 
                     #Ctrlp:input.c.inpo001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD inpo001
            #add-point:ON ACTION controlp INFIELD inpo001 name="input.c.inpo001"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_master.inpo001             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #


            CALL q_inpo001()                                #呼叫開窗

            LET g_master.inpo001 = g_qryparam.return1              

            DISPLAY g_master.inpo001 TO inpo001              #

            NEXT FIELD inpo001                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.yy
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD yy
            #add-point:ON ACTION controlp INFIELD yy name="input.c.yy"
            
            #END add-point
 
 
         #Ctrlp:input.c.mm
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD mm
            #add-point:ON ACTION controlp INFIELD mm name="input.c.mm"
            
            #END add-point
 
 
         #Ctrlp:input.c.print01
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD print01
            #add-point:ON ACTION controlp INFIELD print01 name="input.c.print01"
            
            #END add-point
 
 
 
               
            AFTER INPUT
               #add-point:資料輸入後 name="input.m.after_input"
               
               #end add-point
               
            #add-point:其他管控(on row change, etc...) name="input.other"
            
            #end add-point
         END INPUT
 
 
 
         
         
      
         #add-point:ui_dialog段construct name="ui_dialog.more_construct"
         
         #end add-point
         #add-point:ui_dialog段input name="ui_dialog.more_input"
         
         #end add-point
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         
         #end add-point
 
         SUBDIALOG lib_cl_schedule.cl_schedule_setting
         SUBDIALOG lib_cl_schedule.cl_schedule_setting_exec_call
         SUBDIALOG lib_cl_schedule.cl_schedule_select_show_history
         SUBDIALOG lib_cl_schedule.cl_schedule_show_history
 
         BEFORE DIALOG
            LET l_dialog = ui.DIALOG.getCurrent()
            CALL ainp930_get_buffer(l_dialog)
            #add-point:ui_dialog段before dialog name="ui_dialog.before_dialog3"
            LET g_master.print01 = 'N'
            DISPLAY BY NAME g_master.print01
            LET g_master.yy = YEAR(g_today)
            LET g_master.mm = MONTH(g_today)
            DISPLAY BY NAME g_master.yy,g_master.mm
            LET g_stage = 0                    #add by lixh 20150723
            DISPLAY g_stage TO stagecomplete            
            #end add-point
 
         ON ACTION batch_execute
            LET g_action_choice = "batch_execute"
            ACCEPT DIALOG
 
         #add-point:ui_dialog段before_qbeclear name="ui_dialog.before_qbeclear"
         
         #end add-point
 
         ON ACTION qbeclear         
            CLEAR FORM
            INITIALIZE g_master.* TO NULL   #畫面變數清空
            INITIALIZE lc_param.* TO NULL   #傳遞參數變數清空
            #add-point:ui_dialog段qbeclear name="ui_dialog.qbeclear"
            
            #end add-point
 
         ON ACTION history_fill
            CALL cl_schedule_history_fill()
 
         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT DIALOG
         
         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT DIALOG
 
         #add-point:ui_dialog段action name="ui_dialog.more_action"
         
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM   
         INITIALIZE g_master.* TO NULL
         LET g_wc  = ' 1=2'
         LET g_action_choice = ""
         CALL ainp930_init()
         CONTINUE WHILE
      END IF
 
      #檢查批次設定是否有錯(或未設定完成)
      IF NOT cl_schedule_exec_check() THEN
         CONTINUE WHILE
      END IF
      
      LET lc_param.wc = g_master.wc    #把畫面上的wc傳遞到參數變數
      #請在下方的add-point內進行把畫面的輸入資料(g_master)轉換到傳遞參數變數(lc_param)的動作
      #add-point:ui_dialog段exit dialog name="process.exit_dialog"
      
      #end add-point
 
      LET ls_js = util.JSON.stringify(lc_param)  #r類使用g_master/p類使用lc_param
 
      IF INT_FLAG THEN
         LET INT_FLAG = FALSE
         EXIT WHILE
      ELSE
         IF g_chk_jobid THEN 
            LET g_jobid = g_schedule.gzpa001
         ELSE 
            LET g_jobid = cl_schedule_get_jobid(g_prog)
         END IF 
 
         #依照指定模式執行報表列印
         CASE 
            WHEN g_schedule.gzpa003 = "0"
                 CALL ainp930_process(ls_js)
 
            WHEN g_schedule.gzpa003 = "1"
                 LET ls_js = ainp930_transfer_argv(ls_js)
                 CALL cl_cmdrun(ls_js)
 
            WHEN g_schedule.gzpa003 = "2"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
 
            WHEN g_schedule.gzpa003 = "3"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
         END CASE  
 
         IF g_schedule.gzpa003 = "2" OR g_schedule.gzpa003 = "3" THEN 
            CALL cl_ask_confirm3("std-00014","") #設定完成
         END IF    
         LET g_schedule.gzpa003 = "0" #預設一開始 立即於前景執行
 
         #add-point:ui_dialog段after schedule name="process.after_schedule"
         
         #end add-point
 
         #欄位初始資訊 
         CALL cl_schedule_init_info("all",g_schedule.gzpa003) 
         LET gi_hiden_asign = FALSE 
         LET gi_hiden_exec = FALSE 
         LET gi_hiden_spec = FALSE 
         LET gi_hiden_exec_end = FALSE 
         CALL cl_schedule_hidden()
      END IF
   END WHILE
 
END FUNCTION
 
{</section>}
 
{<section id="ainp930.transfer_argv" >}
#+ 轉換本地參數至cmdrun參數內,準備進入背景執行
PRIVATE FUNCTION ainp930_transfer_argv(ls_js)
 
   #add-point:transfer_agrv段define (客製用) name="transfer_agrv.define_customerization"
   
   #end add-point
   DEFINE ls_js       STRING
   DEFINE la_cmdrun   RECORD
             prog       STRING,
             actionid   STRING,
             background LIKE type_t.chr1,
             param      DYNAMIC ARRAY OF STRING
                  END RECORD
   DEFINE la_param    type_parameter
   #add-point:transfer_agrv段define name="transfer_agrv.define"
   
   #end add-point
 
   LET la_cmdrun.prog = g_prog
   LET la_cmdrun.background = "Y"
   LET la_cmdrun.param[1] = ls_js
 
   #add-point:transfer.argv段程式內容 name="transfer.argv.define"
   
   #end add-point
 
   RETURN util.JSON.stringify( la_cmdrun )
END FUNCTION
 
{</section>}
 
{<section id="ainp930.process" >}
#+ 資料處理   (r類使用g_master為主處理/p類使用l_param為主)
PRIVATE FUNCTION ainp930_process(ls_js)
 
   #add-point:process段define (客製用) name="process.define_customerization"
   
   #end add-point
   DEFINE ls_js         STRING
   DEFINE lc_param      type_parameter
   DEFINE li_stus       LIKE type_t.num5
   DEFINE li_count      LIKE type_t.num10  #progressbar計量
   DEFINE ls_sql        STRING             #主SQL
   DEFINE li_p01_status LIKE type_t.num5
   #add-point:process段define name="process.define"
   DEFINE l_xccc304   LIKE xccc_t.xccc304
   DEFINE l_xccc102   LIKE xccc_t.xccc102
   DEFINE s_xccc304   LIKE xccc_t.xccc304
   DEFINE s_xccc102   LIKE xccc_t.xccc102  
   DEFINE l_xccd102   LIKE xccd_t.xccd102
   DEFINE s_xccd102   LIKE xccd_t.xccd102   
   DEFINE l_xcce102   LIKE xcce_t.xcce102
   DEFINE s_xcce102   LIKE xcce_t.xcce102   
   DEFINE l_n         LIKE type_t.num10
   DEFINE i           LIKE type_t.num10   
   #DEFINE l_inpq      RECORD LIKE inpq_t.*  #161124-00048#4  16/12/09 By 08734 mark
   #161124-00048#4  16/12/09 By 08734 add(S)
   DEFINE l_inpq RECORD  #存貨週轉率期間統計檔
       inpqent LIKE inpq_t.inpqent, #企业编号
       inpqsite LIKE inpq_t.inpqsite, #营运据点
       inpq000 LIKE inpq_t.inpq000, #计算类别
       inpq001 LIKE inpq_t.inpq001, #存货编号
       inpq002 LIKE inpq_t.inpq002, #当前年度
       inpq003 LIKE inpq_t.inpq003, #当前期别
       inpq004 LIKE inpq_t.inpq004, #计算区间
       inpq005 LIKE inpq_t.inpq005, #版本
       inpq006 LIKE inpq_t.inpq006, #计算原则编号
       inpq007 LIKE inpq_t.inpq007, #存货周转率
       inpq008 LIKE inpq_t.inpq008, #存货周转天数
       inpq009 LIKE inpq_t.inpq009, #销货成本
       inpq010 LIKE inpq_t.inpq010, #平均存货
       inpq011 LIKE inpq_t.inpq011 #在制金额
END RECORD
#161124-00048#4  16/12/09 By 08734 add(E)
   DEFINE l_yy        LIKE type_t.num5
   DEFINE l_mm        LIKE type_t.num5 
   DEFINE l_imaa001   LIKE imaa_t.imaa001
   DEFINE l_imaa009   LIKE imaa_t.imaa009  
   DEFINE l_inpp002   LIKE inpp_t.inpp002
   DEFINE l_imaf057   LIKE imaf_t.imaf057
   DEFINE l_imag011   LIKE imag_t.imag011
   DEFINE l_cnt       LIKE type_t.num5
   DEFINE l_count     LIKE type_t.num5
   DEFINE l_days      LIKE type_t.num5
   DEFINE l_wc        STRING
   DEFINE l_sql       STRING
   DEFINE la_param  RECORD                  #程式串查用變數
             prog   STRING,                 #串查程式名稱
             param  DYNAMIC ARRAY OF STRING #傳遞變數
                    END RECORD 
   #end add-point
 
  #INITIALIZE lc_param TO NULL           #p類不可以清空
   CALL util.JSON.parse(ls_js,lc_param)  #r類作業被t類呼叫時使用, p類主要解開參數處
   LET li_p01_status = 1
 
  #IF lc_param.wc IS NOT NULL THEN
  #   LET g_bgjob = "T"       #特殊情況,此為t類作業鬆耦合串入報表主程式使用
  #END IF
 
   #add-point:process段前處理 name="process.pre_process"
   
   #end add-point
 
   #預先計算progressbar迴圈次數
   IF g_bgjob <> "Y" THEN
      #add-point:process段count_progress name="process.count_progress"
      
      #end add-point
   END IF
 
   #主SQL及相關FOREACH前置處理
#  DECLARE ainp930_process_cs CURSOR FROM ls_sql
#  FOREACH ainp930_process_cs INTO
   #add-point:process段process name="process.process"
   SELECT ooef017 INTO g_ooef017 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_site

   SELECT DISTINCT glaald INTO g_glaald FROM glaa_t   #wujie 151014 014 -->ld
    WHERE glaaent = g_enterprise
      AND glaacomp = g_ooef017
      AND glaa014 = 'Y'                               #wujie 151014 add   
      
   IF g_master.inpo005 = '1' THEN
      LET l_days = 360
   END IF
   IF g_master.inpo005 = '2' THEN
      LET l_days = 180
   END IF
   IF g_master.inpo005 = '3' THEN
      LET l_days = 90
   END IF
   IF g_master.inpo005 = '4' THEN
      LET l_days = 30
   END IF   
   IF g_master.inpo003 = '1' THEN  #全部存貨
      LET ls_sql = " SELECT imaa001,imaa009 FROM imaa_t,imaf_t ",
                   "  WHERE imaaent = imafent ",
                   "    AND imaa001 = imaf001 ",
                   "    AND imaastus = 'Y' ",
                   "    AND imaaent = '",g_enterprise,"'",                
                   "    AND imafsite = '",g_site,"'"
   END IF     

   IF g_master.inpo003 = '2' THEN  #依產品分類
      SELECT COUNT(*) INTO l_cnt FROM inpp_t
       WHERE inppent = g_enterprise
         AND inppsite = g_site
         AND inpp001 = g_master.inpo001
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt > 0 THEN      
         LET l_sql = " SELECT inpp002 FROM inpp_t ",
                     "   LEFT OUTER JOIN inpo_t ON inpoent = inppent AND inposite = inppsite AND inpo001 = inpp001 ",
                     "  WHERE inppent = '",g_enterprise,"'",
                     "    AND inppsite = '",g_site,"'",
                     "    AND inpp001 = '",g_master.inpo001,"'"
      ELSE
         LET l_sql = " SELECT DISTINCT imaa009 FROM imaa_t,imaf_t ",
                     "  WHERE imaaent = imafent ",
                     "    AND imaa001 = imaf001 ",
                     "    AND imaaent = '",g_enterprise,"'",
                     "    AND imafsite = '",g_site,"'",
                     "    AND imaastus = 'Y' "           
      END IF            
      PREPARE ainp930_inpp_pre FROM l_sql
      DECLARE ainp930_inpp_cur CURSOR FOR ainp930_inpp_pre   
   END IF
   
   IF g_master.inpo003 = '3' THEN  #依ABC分類碼
      LET l_sql = " SELECT DISTINCT imaf057 FROM imaf_t,imaa_t ",
                  "  WHERE imaaent = imafent ",
                  "    AND imaa001 = imaf001 ",
                  "    AND imaaent = '",g_enterprise,"'",
                  "    AND imafsite = '",g_site,"'",
                  "    AND imaastus = 'Y' "      
      PREPARE ainp930_imaf_pre FROM l_sql
      DECLARE ainp930_imaf_cur CURSOR FOR ainp930_imaf_pre                  
   END IF
   
   IF g_master.inpo003 = '4' THEN  #依成本分群
      SELECT COUNT(*) INTO l_cnt FROM inpp_t
       WHERE inppent = g_enterprise
         AND inppsite = g_site
         AND inpp001 = g_master.inpo001
      IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
      IF l_cnt > 0 THEN      
         LET l_sql = " SELECT inpp002 FROM inpp_t ",
                     "   LEFT OUTER JOIN inpo_t ON inpoent = inppent AND inposite = inppsite AND inpo001 = inpp001 ",
                     "  WHERE inppent = '",g_enterprise,"'",
                     "    AND inppsite = '",g_site,"'",
                     "    AND inpp001 = '",g_master.inpo001,"'"
      ELSE
         LET l_sql = " SELECT DISTINCT imag011 FROM imaa_t,imag_t ",
                     "  WHERE imaaent = imagent ",
                     "    AND imaa001 = imag001 ",
                     "    AND imagent = '",g_enterprise,"'",
                     "    AND imagsite = '",g_site,"'",
                     "    AND imaastus = 'Y' "           
      END IF  
      PREPARE ainp930_imag_pre FROM l_sql
      DECLARE ainp930_imag_cur CURSOR FOR ainp930_imag_pre      
   END IF   

   PREPARE ainp930_imaa_pre FROM ls_sql
   DECLARE ainp930_imaa_cur CURSOR FOR ainp930_imaa_pre 
   IF g_master.inpo005 = '4' THEN   #依月
      LET l_n = 2
   END IF
   IF g_master.inpo005 = '3' THEN   #依季
      LET l_n = 4
   END IF   
   IF g_master.inpo005 = '2' THEN   #依半年
      LET l_n = 7
   END IF   
   IF g_master.inpo005 = '1' THEN   #依年
      LET l_n = 13
   END IF  
   FOREACH ainp930_imaa_cur INTO l_imaa001,l_imaa009
   
      LET l_inpq.inpq000 = g_master.inpo003
      LET l_inpq.inpq004 = g_master.inpo005
      LET l_inpq.inpq002 = g_master.yy
      LET l_inpq.inpq003 = g_master.mm
      LET l_inpq.inpq006 = g_master.inpo001
      IF g_master.inpo003 = '1' THEN  #全部存貨
         LET l_xccc304 = 0
         LET l_xccc102 = 0 
         LET l_xccd102 = 0 
         LET l_xcce102 = 0                   
         LET s_xccc304 = 0
         LET s_xccc102 = 0
         LET s_xccd102 = 0 
         LET s_xcce102 = 0          
         FOR i = 1 TO l_n
            IF i = 1 THEN      
               LET l_yy = g_master.yy 
               LET l_mm = g_master.mm            
            ELSE
               IF l_yy = 1 THEN
                  LET l_yy = l_yy - 1
                  LET l_mm = 12
               ELSE
                  LET l_mm = l_mm - 1           
               END IF                
            END IF           
            #期間銷貨成本
            LET l_xccc304 = 0
            LET l_xccc102 = 0          
            #SELECT SUM(xccc304-xccc306),SUM(xccc102+xccc902) INTO l_xccc304,l_xccc102 FROM xccc_t
            SELECT SUM(xccc304+xccc306)*-1,SUM(xccc102+xccc902) INTO l_xccc304,l_xccc102 FROM xccc_t  #add by lixh 20151022
             WHERE xcccent = g_enterprise
#               AND xccc003 = 'A002'
               AND xccc003 IN (SELECT DISTINCT xccc003 FROM xccc_t,xcat_t
                                   WHERE xcccent = xcatent
                                     AND xccc003 = xcat001 
                                     AND xcat005 = '5')
               AND xccc004 = l_yy
               AND xccc005 = l_mm
               AND xccc006 = l_imaa001
               AND xccccomp = g_ooef017
               AND xcccld = g_glaald   #wujie 151014 014 -->ld
            IF cl_null(l_xccc304) THEN LET l_xccc304 = 0 END IF
            IF cl_null(l_xccc102) THEN LET l_xccc102 = 0 END IF          
            LET s_xccc304 = s_xccc304 + l_xccc304
            LET s_xccc102 = s_xccc102 + l_xccc102
            
            LET l_xccd102 = 0
                       
            IF g_master.inpo004 = '1' THEN  #包含在製品金額
               SELECT SUM(xccd102+xccd902) INTO l_xccd102 FROM xccd_t
                WHERE xccdent = g_enterprise
                #  AND xccd003 = 'A002'
                  AND xccd003 IN (SELECT DISTINCT xccd003 FROM xccd_t,xcat_t
                                   WHERE xccdent = xcatent
                                     AND xccd003 = xcat001 
                                     AND xcat005 = '5')
                  AND xccd004 = l_yy
                  AND xccd005 = l_mm
                  AND xccd007 = l_imaa001
                  AND xccdcomp = g_ooef017
                  AND xccdld = g_glaald   #wujie 151014 014 -->ld                  
               IF cl_null(l_xccd102) THEN LET l_xccd102 = 0 END IF  
               LET s_xccd102 = s_xccd102 + l_xccd102    
               LET l_xcce102 = 0
               SELECT SUM(xcce102+xcce902) INTO l_xcce102 FROM xcce_t
                WHERE xcceent = g_enterprise
#                  AND xcce003 = 'A002'
                  AND xcce003 IN (SELECT DISTINCT xcce003 FROM xcce_t,xcat_t
                                   WHERE xcceent = xcatent
                                     AND xcce003 = xcat001 
                                     AND xcat005 = '5')
                  AND xcce004 = l_yy
                  AND xcce005 = l_mm
                  AND xcce007 = l_imaa001
                  AND xccecomp = g_ooef017
                  AND xcceld = g_glaald   #wujie 151014 014 -->ld                   
               IF cl_null(l_xcce102) THEN LET l_xcce102 = 0 END IF  
               LET s_xcce102 = s_xcce102 + l_xcce102                
            END IF  
         END FOR             
         LET l_inpq.inpq001 = l_imaa001
         LET l_inpq.inpq009 = s_xccc304 
         IF cl_null(l_inpq.inpq009) THEN LET l_inpq.inpq009 = 0 END IF 
         LET l_inpq.inpq010 = (s_xccc102+s_xccd102+s_xcce102)/2
         IF cl_null(l_inpq.inpq010) THEN LET l_inpq.inpq010 = 0 END IF
         LET l_inpq.inpq007 = l_inpq.inpq009/l_inpq.inpq010
         IF cl_null(l_inpq.inpq007) THEN LET l_inpq.inpq007 = 0 END IF
         LET l_inpq.inpq008 = l_days/l_inpq.inpq007
         IF cl_null(l_inpq.inpq008) THEN LET l_inpq.inpq008 = 0 END IF
         LET l_inpq.inpq011 = s_xccd102+s_xcce102
         SELECT MAX(inpq005)+1 INTO l_inpq.inpq005 FROM inpq_t
          WHERE inpqent = g_enterprise
            AND inpqsite = g_site
            AND inpq001 = l_inpq.inpq001
            AND inpq002 = l_inpq.inpq002
            AND inpq003 = l_inpq.inpq003
            AND inpq000 = g_master.inpo003
         IF cl_null(l_inpq.inpq005) THEN LET l_inpq.inpq005 = 1 END IF           
  
         INSERT INTO inpq_t (inpqent,inpqsite,inpq000,inpq001,inpq002,inpq003,inpq004,inpq005,inpq006,inpq007,
                             inpq008,inpq009,inpq010,inpq011)

                     VALUES (g_enterprise,g_site,l_inpq.inpq000,l_inpq.inpq001,l_inpq.inpq002,l_inpq.inpq003,l_inpq.inpq004,l_inpq.inpq005,
                             l_inpq.inpq006,l_inpq.inpq007,l_inpq.inpq008,l_inpq.inpq009,l_inpq.inpq010,l_inpq.inpq011)
     
      END IF 
      INITIALIZE l_inpq.* TO NULL 
   END FOREACH
   
   FOREACH ainp930_inpp_cur INTO l_inpp002
      LET l_inpq.inpq000 = g_master.inpo003
      LET l_inpq.inpq004 = g_master.inpo005
      LET l_inpq.inpq002 = g_master.yy
      LET l_inpq.inpq003 = g_master.mm
      LET l_inpq.inpq006 = g_master.inpo001
      IF g_master.inpo003 = '2' THEN  #產品分類
         LET l_xccc304 = 0
         LET l_xccc102 = 0 
         LET l_xccd102 = 0 
         LET l_xcce102 = 0                   
         LET s_xccc304 = 0
         LET s_xccc102 = 0
         LET s_xccd102 = 0 
         LET s_xcce102 = 0          
         FOR i = 1 TO l_n
            IF i = 1 THEN      
               LET l_yy = g_master.yy 
               LET l_mm = g_master.mm            
            ELSE
               IF l_yy = 1 THEN
                  LET l_yy = l_yy - 1
                  LET l_mm = 12
               ELSE
                  LET l_mm = l_mm - 1           
               END IF                
            END IF           
            #期間銷貨成本
            LET l_xccc304 = 0
            LET l_xccc102 = 0    
            SELECT SUM(xccc304+xccc306)*-1,SUM(xccc102+xccc902) INTO l_xccc304,l_xccc102 FROM xccc_t 
              LEFT OUTER JOIN imaa_t ON imaaent = xcccent AND imaa001 = xccc006 AND imaastus = 'Y'
              LEFT OUTER JOIN imaf_t ON imafent = imaaent AND imaa001 = imaa001 AND imafsite = g_site
             WHERE xcccent = g_enterprise
               AND imaa009 = l_inpp002  
               AND xccc003 IN (SELECT DISTINCT xccc003 FROM xccc_t,xcat_t
                                WHERE xcccent = xcatent
                                  AND xccc003 = xcat001 
                                  AND xcat005 = '5')    
               AND xccc004 = l_yy
               AND xccc005 = l_mm    
               AND xccccomp = g_ooef017
               AND xcccld = g_glaald   #wujie 151014 014 -->ld               
            IF cl_null(l_xccc304) THEN LET l_xccc304 = 0 END IF
            IF cl_null(l_xccc102) THEN LET l_xccc102 = 0 END IF
            LET s_xccc304 = s_xccc304 + l_xccc304
            LET s_xccc102 = s_xccc102 + l_xccc102
            
            LET l_xccd102 = 0                       
            IF g_master.inpo004 = '1' THEN  #包含在製品金額
               SELECT SUM(xccd102+xccd902) INTO l_xccd102 FROM xccd_t
                 LEFT OUTER JOIN imaa_t ON imaaent = xccdent AND imaa001 = xccd006 AND imaastus = 'Y'
                 LEFT OUTER JOIN imaf_t ON imafent = imaaent AND imaa001 = imaa001 AND imafsite = g_site
                WHERE xccdent = g_enterprise
                  AND xccd003 IN (SELECT DISTINCT xccd003 FROM xccd_t,xcat_t
                                   WHERE xccdent = xcatent
                                     AND xccd003 = xcat001 
                                     AND xcat005 = '5')
                  AND xccd004 = l_yy
                  AND xccd005 = l_mm
                  AND imaa009 = l_inpp002
                  AND xccdcomp = g_ooef017
                  AND xccdld = g_glaald   #wujie 151014 014 -->ld               
               IF cl_null(l_xccd102) THEN LET l_xccd102 = 0 END IF  
               LET s_xccd102 = s_xccd102 + l_xccd102    
               LET l_xcce102 = 0
               SELECT SUM(xcce102+xcce902) INTO l_xcce102 FROM xcce_t
                 LEFT OUTER JOIN imaa_t ON imaaent = xcceent AND imaa001 = xcce006 AND imaastus = 'Y'
                 LEFT OUTER JOIN imaf_t ON imafent = imaaent AND imaa001 = imaa001 AND imafsite = g_site
                WHERE xcceent = g_enterprise
                  AND xcce003 IN (SELECT DISTINCT xcce003 FROM xcce_t,xcat_t
                                   WHERE xcceent = xcatent
                                     AND xcce003 = xcat001 
                                     AND xcat005 = '5')
                  AND xcce004 = l_yy
                  AND xcce005 = l_mm
                  AND imaa009 = l_inpp002
                  AND xccecomp = g_ooef017
                  AND xcceld = g_glaald   #wujie 151014 014 -->ld                        
               IF cl_null(l_xcce102) THEN LET l_xcce102 = 0 END IF  
               LET s_xcce102 = s_xcce102 + l_xcce102                
            END IF              

         END FOR
#         LET l_inpq.inpq000 = '2'
         LET l_inpq.inpq001 = l_inpp002
         LET l_inpq.inpq009 = s_xccc304 
         IF cl_null(l_inpq.inpq009) THEN LET l_inpq.inpq009 = 0 END IF 
         LET l_inpq.inpq010 = (s_xccc102+s_xccd102+s_xcce102)/2
         IF cl_null(l_inpq.inpq010) THEN LET l_inpq.inpq010 = 0 END IF
         LET l_inpq.inpq007 = l_inpq.inpq009/l_inpq.inpq010
         IF cl_null(l_inpq.inpq007) THEN LET l_inpq.inpq007 = 0 END IF
         LET l_inpq.inpq008 = l_days/l_inpq.inpq007
         IF cl_null(l_inpq.inpq008) THEN LET l_inpq.inpq008 = 0 END IF
         LET l_inpq.inpq011 = s_xccd102+s_xcce102
         SELECT MAX(inpq005)+1 INTO l_inpq.inpq005 FROM inpq_t
          WHERE inpqent = g_enterprise
            AND inpqsite = g_site
            AND inpq001 = l_inpq.inpq001
            AND inpq002 = l_inpq.inpq002
            AND inpq003 = l_inpq.inpq003
            AND inpq000 = g_master.inpo003
         IF cl_null(l_inpq.inpq005) THEN LET l_inpq.inpq005 = 1 END IF               
         INSERT INTO inpq_t (inpqent,inpqsite,inpq000,inpq001,inpq002,inpq003,inpq004,inpq005,inpq006,inpq007,
                             inpq008,inpq009,inpq010,inpq011)

                     VALUES (g_enterprise,g_site,l_inpq.inpq000,l_inpq.inpq001,l_inpq.inpq002,l_inpq.inpq003,l_inpq.inpq004,l_inpq.inpq005,
                             l_inpq.inpq006,l_inpq.inpq007,l_inpq.inpq008,l_inpq.inpq009,l_inpq.inpq010,l_inpq.inpq011)
              
      END IF  
      INITIALIZE l_inpq.* TO NULL       
   END FOREACH
   
   FOREACH ainp930_imaf_cur INTO l_imaf057
      LET l_inpq.inpq000 = g_master.inpo003
      LET l_inpq.inpq004 = g_master.inpo005
      LET l_inpq.inpq002 = g_master.yy
      LET l_inpq.inpq003 = g_master.mm
      LET l_inpq.inpq006 = g_master.inpo001
      IF g_master.inpo003 = '3' THEN  #ABC碼
         LET l_xccc304 = 0
         LET l_xccc102 = 0 
         LET l_xccd102 = 0 
         LET l_xcce102 = 0                   
         LET s_xccc304 = 0
         LET s_xccc102 = 0
         LET s_xccd102 = 0 
         LET s_xcce102 = 0          
         FOR i = 1 TO l_n
            IF i = 1 THEN      
               LET l_yy = g_master.yy 
               LET l_mm = g_master.mm            
            ELSE
               IF l_yy = 1 THEN
                  LET l_yy = l_yy - 1
                  LET l_mm = 12
               ELSE
                  LET l_mm = l_mm - 1           
               END IF                
            END IF           
            #期間銷貨成本
            LET l_xccc304 = 0
            LET l_xccc102 = 0    
            SELECT SUM(xccc304+xccc306)*-1,SUM(xccc102+xccc902) INTO l_xccc304,l_xccc102 FROM xccc_t 
              LEFT OUTER JOIN imaa_t ON imaaent = xcccent AND imaa001 = xccc006 AND imaastus = 'Y'
              LEFT OUTER JOIN imaf_t ON imafent = imaaent AND imaa001 = imaa001 AND imafsite = g_site
             WHERE xcccent = g_enterprise
               AND imaf057 = l_imaf057  
               AND xccc003 IN (SELECT DISTINCT xccc003 FROM xccc_t,xcat_t
                                WHERE xcccent = xcatent
                                  AND xccc003 = xcat001 
                                  AND xcat005 = '5')    
               AND xccc004 = l_yy
               AND xccc005 = l_mm      
               AND xccccomp = g_ooef017
               AND xcccld = g_glaald   #wujie 151014 014 -->ld                
            IF cl_null(l_xccc304) THEN LET l_xccc304 = 0 END IF
            IF cl_null(l_xccc102) THEN LET l_xccc102 = 0 END IF
            LET s_xccc304 = s_xccc304 + l_xccc304
            LET s_xccc102 = s_xccc102 + l_xccc102
            
            LET l_xccd102 = 0                       
            IF g_master.inpo004 = '1' THEN  #包含在製品金額
               SELECT SUM(xccd102+xccd902) INTO l_xccd102 FROM xccd_t
                 LEFT OUTER JOIN imaa_t ON imaaent = xccdent AND imaa001 = xccd006 AND imaastus = 'Y'
                 LEFT OUTER JOIN imaf_t ON imafent = imaaent AND imaa001 = imaa001 AND imafsite = g_site
                WHERE xccdent = g_enterprise
                  AND xccd003 IN (SELECT DISTINCT xccd003 FROM xccd_t,xcat_t
                                   WHERE xccdent = xcatent
                                     AND xccd003 = xcat001 
                                     AND xcat005 = '5')
                  AND xccd004 = l_yy
                  AND xccd005 = l_mm
                  AND imaf057 = l_imaf057
                  AND xccdcomp = g_ooef017
                  AND xccdld = g_glaald   #wujie 151014 014 -->ld                   
               IF cl_null(l_xccd102) THEN LET l_xccd102 = 0 END IF  
               LET s_xccd102 = s_xccd102 + l_xccd102    
               LET l_xcce102 = 0
               SELECT SUM(xcce102+xcce902) INTO l_xcce102 FROM xcce_t
                 LEFT OUTER JOIN imaa_t ON imaaent = xcceent AND imaa001 = xcce006 AND imaastus = 'Y'
                 LEFT OUTER JOIN imaf_t ON imafent = imaaent AND imaa001 = imaa001 AND imafsite = g_site
                WHERE xcceent = g_enterprise
                  AND xcce003 IN (SELECT DISTINCT xcce003 FROM xcce_t,xcat_t
                                   WHERE xcceent = xcatent
                                     AND xcce003 = xcat001 
                                     AND xcat005 = '5')
                  AND xcce004 = l_yy
                  AND xcce005 = l_mm
                  AND imaf057 = l_imaf057
                  AND xccecomp = g_ooef017
                  AND xcceld = g_glaald   #wujie 151014 014 -->ld                
               IF cl_null(l_xcce102) THEN LET l_xcce102 = 0 END IF  
               LET s_xcce102 = s_xcce102 + l_xcce102                
            END IF              

         END FOR
         LET l_inpq.inpq001 = l_imaf057
         LET l_inpq.inpq009 = s_xccc304 
         IF cl_null(l_inpq.inpq009) THEN LET l_inpq.inpq009 = 0 END IF 
         LET l_inpq.inpq010 = (s_xccc102+s_xccd102+s_xcce102)/2
         IF cl_null(l_inpq.inpq010) THEN LET l_inpq.inpq010 = 0 END IF
         LET l_inpq.inpq007 = l_inpq.inpq009/l_inpq.inpq010
         IF cl_null(l_inpq.inpq007) THEN LET l_inpq.inpq007 = 0 END IF
         LET l_inpq.inpq008 = l_days/l_inpq.inpq007
         IF cl_null(l_inpq.inpq008) THEN LET l_inpq.inpq008 = 0 END IF
         LET l_inpq.inpq011 = s_xccd102+s_xcce102
         SELECT MAX(inpq005)+1 INTO l_inpq.inpq005 FROM inpq_t
          WHERE inpqent = g_enterprise
            AND inpqsite = g_site
            AND inpq001 = l_inpq.inpq001
            AND inpq002 = l_inpq.inpq002
            AND inpq003 = l_inpq.inpq003
            AND inpq000 = g_master.inpo003
         IF cl_null(l_inpq.inpq005) THEN LET l_inpq.inpq005 = 1 END IF               
         INSERT INTO inpq_t (inpqent,inpqsite,inpq000,inpq001,inpq002,inpq003,inpq004,inpq005,inpq006,inpq007,
                             inpq008,inpq009,inpq010,inpq011)

                     VALUES (g_enterprise,g_site,l_inpq.inpq000,l_inpq.inpq001,l_inpq.inpq002,l_inpq.inpq003,l_inpq.inpq004,l_inpq.inpq005,
                             l_inpq.inpq006,l_inpq.inpq007,l_inpq.inpq008,l_inpq.inpq009,l_inpq.inpq010,l_inpq.inpq011)
                
      END IF        
      INITIALIZE l_inpq.* TO NULL 
   END FOREACH
   
   FOREACH ainp930_imag_cur INTO l_imag011
      LET l_inpq.inpq000 = g_master.inpo003
      LET l_inpq.inpq004 = g_master.inpo005
      LET l_inpq.inpq002 = g_master.yy
      LET l_inpq.inpq003 = g_master.mm
      LET l_inpq.inpq006 = g_master.inpo001
      IF g_master.inpo003 = '4' THEN  #成本分群
         LET l_xccc304 = 0
         LET l_xccc102 = 0 
         LET l_xccd102 = 0 
         LET l_xcce102 = 0                   
         LET s_xccc304 = 0
         LET s_xccc102 = 0
         LET s_xccd102 = 0 
         LET s_xcce102 = 0          
         FOR i = 1 TO l_n
            IF i = 1 THEN      
               LET l_yy = g_master.yy 
               LET l_mm = g_master.mm            
            ELSE
               IF l_yy = 1 THEN
                  LET l_yy = l_yy - 1
                  LET l_mm = 12
               ELSE
                  LET l_mm = l_mm - 1           
               END IF                
            END IF           
            #期間銷貨成本
            LET l_xccc304 = 0
            LET l_xccc102 = 0    
            SELECT SUM(xccc304+xccc306)*-1,SUM(xccc102+xccc902) INTO l_xccc304,l_xccc102 FROM xccc_t 
              LEFT OUTER JOIN imaa_t ON imaaent = xcccent AND imaa001 = xccc006 AND imaastus = 'Y'
              LEFT OUTER JOIN imag_t ON imagent = imaaent AND imaa001 = imaa001 AND imagsite = g_site
             WHERE xcccent = g_enterprise
               AND imag011 = l_imag011  
               AND xccc003 IN (SELECT DISTINCT xccc003 FROM xccc_t,xcat_t
                                WHERE xcccent = xcatent
                                  AND xccc003 = xcat001 
                                  AND xcat005 = '5')    
               AND xccc004 = l_yy
               AND xccc005 = l_mm  
               AND xccccomp = g_ooef017
               AND xcccld = g_glaald   #wujie 151014 014 -->ld               
            IF cl_null(l_xccc304) THEN LET l_xccc304 = 0 END IF
            IF cl_null(l_xccc102) THEN LET l_xccc102 = 0 END IF
            LET s_xccc304 = s_xccc304 + l_xccc304
            LET s_xccc102 = s_xccc102 + l_xccc102
            
            LET l_xccd102 = 0                       
            IF g_master.inpo004 = '1' THEN  #包含在製品金額
               SELECT SUM(xccd102+xccd902) INTO l_xccd102 FROM xccd_t
                 LEFT OUTER JOIN imaa_t ON imaaent = xccdent AND imaa001 = xccd006 AND imaastus = 'Y'
                 LEFT OUTER JOIN imag_t ON imagent = imaaent AND imaa001 = imaa001 AND imagsite = g_site
                WHERE xccdent = g_enterprise
                  AND xccd003 IN (SELECT DISTINCT xccd003 FROM xccd_t,xcat_t
                                   WHERE xccdent = xcatent
                                     AND xccd003 = xcat001 
                                     AND xcat005 = '5')
                  AND xccd004 = l_yy
                  AND xccd005 = l_mm
                  AND imag011 = l_imag011
                  AND xccdcomp = g_ooef017
                  AND xccdld = g_glaald   #wujie 151014 014 -->ld                 
               IF cl_null(l_xccd102) THEN LET l_xccd102 = 0 END IF  
               LET s_xccd102 = s_xccd102 + l_xccd102    
               LET l_xcce102 = 0
               SELECT SUM(xcce102+xcce902) INTO l_xcce102 FROM xcce_t
                 LEFT OUTER JOIN imaa_t ON imaaent = xcceent AND imaa001 = xcce006 AND imaastus = 'Y'
                 LEFT OUTER JOIN imag_t ON imagent = imaaent AND imaa001 = imaa001 AND imagsite = g_site
                WHERE xcceent = g_enterprise
                  AND xcce003 IN (SELECT DISTINCT xcce003 FROM xcce_t,xcat_t
                                   WHERE xcceent = xcatent
                                     AND xcce003 = xcat001 
                                     AND xcat005 = '5')
                  AND xcce004 = l_yy
                  AND xcce005 = l_mm
                  AND imag011 = l_imag011
                  AND xccecomp = g_ooef017
                  AND xcceld = g_glaald   #wujie 151014 014 -->ld                   
               IF cl_null(l_xcce102) THEN LET l_xcce102 = 0 END IF  
               LET s_xcce102 = s_xcce102 + l_xcce102                
            END IF              

         END FOR
         LET l_inpq.inpq001 = l_imag011
         LET l_inpq.inpq009 = s_xccc304 
         IF cl_null(l_inpq.inpq009) THEN LET l_inpq.inpq009 = 0 END IF 
         LET l_inpq.inpq010 = (s_xccc102+s_xccd102+s_xcce102)/2
         IF cl_null(l_inpq.inpq010) THEN LET l_inpq.inpq010 = 0 END IF
         LET l_inpq.inpq007 = l_inpq.inpq009/l_inpq.inpq010
         IF cl_null(l_inpq.inpq007) THEN LET l_inpq.inpq007 = 0 END IF
         LET l_inpq.inpq008 = l_days/l_inpq.inpq007
         IF cl_null(l_inpq.inpq008) THEN LET l_inpq.inpq008 = 0 END IF
         LET l_inpq.inpq011 = s_xccd102+s_xcce102
         SELECT MAX(inpq005)+1 INTO l_inpq.inpq005 FROM inpq_t
          WHERE inpqent = g_enterprise
            AND inpqsite = g_site
            AND inpq001 = l_inpq.inpq001
            AND inpq002 = l_inpq.inpq002
            AND inpq003 = l_inpq.inpq003
            AND inpq000 = g_master.inpo003 
         IF cl_null(l_inpq.inpq005) THEN LET l_inpq.inpq005 = 1 END IF               
         INSERT INTO inpq_t (inpqent,inpqsite,inpq000,inpq001,inpq002,inpq003,inpq004,inpq005,inpq006,inpq007,
                             inpq008,inpq009,inpq010,inpq011)

                     VALUES (g_enterprise,g_site,l_inpq.inpq000,l_inpq.inpq001,l_inpq.inpq002,l_inpq.inpq003,l_inpq.inpq004,l_inpq.inpq005,
                             l_inpq.inpq006,l_inpq.inpq007,l_inpq.inpq008,l_inpq.inpq009,l_inpq.inpq010,l_inpq.inpq011)
               
      END IF  
      INITIALIZE l_inpq.* TO NULL      
   END FOREACH
   IF g_master.print01 = 'Y' THEN
#      LET la_param.prog = 'ainr920'
#      LET ls_js = util.JSON.stringify( la_param )
#      CALL cl_cmdrun(ls_js)   
      LET l_wc = " 1 =1"
      IF g_master.inpo003 ='2'  THEN 
         SELECT COUNT(*) INTO l_count FROM inpp_t WHERE inppent = g_enterprise AND inppsite = g_site
                                       AND inpp001 = g_master.inpo001
                                      
         IF l_count > 0 THEN
            LET l_wc = l_wc," AND imaa009 IN (SELECT inpp002 FROM inpp_t WHERE inppent = '",g_enterprise,"' AND inppsite = '",g_site,"'",
                                                 " AND inpp001 = '",g_master.inpo001,"')"
         END IF         
        
      END IF
      IF g_master.inpo003 ='4'  THEN 
         SELECT COUNT(*) INTO l_count FROM inpp_t WHERE inppent = g_enterprise AND inppsite = g_site
                                       AND inpp001 = g_master.inpo001
                                      
         IF l_count > 0 THEN
            LET l_wc = l_wc," AND imag011 IN (SELECT inpp002 FROM inpp_t WHERE inppent = '",g_enterprise,"' AND inppsite = '",g_site,"'",
                                                 " AND inpp001 = '",g_master.inpo001,"')"
         END IF         
        
      END IF   
      LET l_wc = l_wc," AND inpq000 = '",g_master.inpo003 CLIPPED,"'" ," AND inpqent = '",g_enterprise,"' AND inpqsite = '",g_site,"'" ,
                      " AND inpq002 = ",g_master.yy CLIPPED, " AND inpq003 = ",g_master.mm CLIPPED                   
      CALL ainr920_x01(l_wc,g_master.inpo003,'Y') 
   END IF
   LET g_stage = 100   
   DISPLAY g_stage TO stagecomplete
   #end add-point
#  END FOREACH
 
   IF g_bgjob = "N" THEN
      #前景作業完成處理
      #add-point:process段foreground完成處理 name="process.foreground_finish"
      
      #end add-point
      CALL cl_ask_confirm3("std-00012","")
   ELSE
      #背景作業完成處理
      #add-point:process段background完成處理 name="process.background_finish"
      
      #end add-point
      CALL cl_schedule_exec_call(li_p01_status)
   END IF
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL ainp930_msgcentre_notify()
 
END FUNCTION
 
{</section>}
 
{<section id="ainp930.get_buffer" >}
PRIVATE FUNCTION ainp930_get_buffer(p_dialog)
 
   #add-point:process段define (客製用) name="get_buffer.define_customerization"
   
   #end add-point
   DEFINE p_dialog   ui.DIALOG
   #add-point:process段define name="get_buffer.define"
   
   #end add-point
 
   
   LET g_master.inpo001 = p_dialog.getFieldBuffer('inpo001')
   LET g_master.yy = p_dialog.getFieldBuffer('yy')
   LET g_master.mm = p_dialog.getFieldBuffer('mm')
   LET g_master.print01 = p_dialog.getFieldBuffer('print01')
 
   CALL cl_schedule_get_buffer(p_dialog)
 
   #add-point:get_buffer段其他欄位處理 name="get_buffer.others"
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="ainp930.msgcentre_notify" >}
PRIVATE FUNCTION ainp930_msgcentre_notify()
 
   #add-point:process段define (客製用) name="msgcentre_notify.define_customerization"
   
   #end add-point
   DEFINE lc_state LIKE type_t.chr5
   #add-point:process段define name="msgcentre_notify.define"
   
   #end add-point
 
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = "process"
 
   #add-point:msgcentre其他通知 name="msg_centre.process"
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
{</section>}
 
{<section id="ainp930.other_function" readonly="Y" >}
#add-point:自定義元件(Function) name="other.function"

################################################################################
# Descriptions...: 帶出資料
# Memo...........:
# Usage..........: CALL ainp930_inpo001_desc()
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By lixh
# Modify.........:
################################################################################
PRIVATE FUNCTION ainp930_inpo001_desc()
   IF NOT cl_null(g_master.inpo001) THEN
      SELECT inpo002,inpo003,inpo004,inpo005 INTO g_master.inpo002,g_master.inpo003,g_master.inpo004,g_master.inpo005
        FROM inpo_t
       WHERE inpoent = g_enterprise
         AND inposite = g_site
         AND inpo001 = g_master.inpo001
   ELSE
      LET g_master.inpo002 = ''
      LET g_master.inpo003 = ''
      LET g_master.inpo004 = ''
      LET g_master.inpo005 = ''
   END IF    
   DISPLAY BY NAME g_master.inpo002,g_master.inpo003,g_master.inpo004,g_master.inpo005       
END FUNCTION

#end add-point
 
{</section>}
 
