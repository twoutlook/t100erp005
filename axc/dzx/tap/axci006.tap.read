<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="axci006" std_prog="axci006" erpver="1.0" module="AXC" ver="3" env="s" zone="t10dev" booking="N" type="M" identity="s">
  <other>
    <code_template value="F" status=""/>
    <free_style value="Y" status=""/>
  </other>
  <point name="main.define_sql" order="0" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   LET g_sql = " SELECT UNIQUE xcagsite,xcagcomp,xcag011,xcag001",
               " FROM xcag_t",
               " WHERE xcagent = '" ||g_enterprise|| "' AND xcagsite = ? AND xcag001 = ? ",
               "   AND xcagcomp = ? AND xcag011 = ?"
   PREPARE axci006_master_referesh FROM g_sql
   
   LET g_forupd_sql = "SELECT xcagsite,'',xcagcomp,'',xcag011,'',xcag001,'' FROM xcag_t WHERE xcagent=
                      ? AND xcagsite=? AND xcag001=? AND xcagcomp=? AND xcag011=? FOR UPDATE"]]>
  </point>
  <point name="function.axci006_xcah_b_fill" order="1" ver="2" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axci006_xcah_b_fill()
DEFINE l_ac3      LIKE type_t.num5
DEFINE l_a        LIKE type_t.num10

   CALL g_xcah_d.clear()

   DELETE FROM axci006_xcah_tmp
   INSERT INTO axci006_xcah_tmp
    SELECT 0,xcahsite,xcah001,xcah002,xcah004,xcah020,xcah021,xcah040,xcah022,xcah023,xcah030,xcah030a,xcah030b,xcah030c,
           xcah030d,xcah030e,xcah030f,xcah030g,xcah030h,xcah026,xcah025,xcah027,xcah043,xcah042,xcah044,xcah031,xcah031a,
           xcah031b,xcah031c,xcah031d,xcah031e,xcah031f,xcah031g,xcah031h 
      FROM xcah_t 
     WHERE xcahent=g_enterprise AND xcahsite = g_xcag_m.xcagsite 
       AND xcah001=g_xcag_m.xcag001 AND xcah004=g_xcag_d[l_ac].xcag004 
       AND xcah002 =  g_xcag_d[l_ac].xcag002 
    
#    LET g_sql = " INSERT INTO axci006_xcah_tmp",
#                "  SELECT 1,b.xcahsite,b.xcah001,b.xcah002,b.xcah004,b.xcah020,'','','','','','','','','','','','','','','','','','','',SUM(xcah031),SUM(xcah031a),",
#                "         SUM(xcah031b),SUM(xcah031c),SUM(xcah031d),SUM(xcah031e),SUM(xcah031f),SUM(xcah031g),SUM(xcah031h)",
#                "    FROM axci006_xcah_tmp b,",
#                "   (SELECT distinct xcahsite,xcah001,xcah002,xcah004,xcah020 FROM axci006_xcah_tmp ) c ",
#                "   WHERE b.xcahsite=c.xcahsite",
#                "     AND b.xcah001=c.xcah001 AND b.xcah004=c.xcah004",
#                "     AND b.xcah002=c.xcah002 AND b.xcah020>=c.xcah020 ",
#                "   GROUP BY b.xcahsite,b.xcah001,b.xcah002,b.xcah004,b.xcah020",
#                "   ORDER BY b.xcahsite,b.xcah001,b.xcah002,b.xcah004,b.xcah020"
#   PREPARE axci006_xcah_tmp_prep FROM g_sql
#   EXECUTE axci006_xcah_tmp_prep

   LET g_sql = " INSERT INTO axci006_xcah_tmp",
                "  SELECT 1,xcahsite,xcah001,xcah002,xcah004,xcah020,'','','','','','','','','','','','','','','','','','','',SUM(xcah031),SUM(xcah031a),",
                "         SUM(xcah031b),SUM(xcah031c),SUM(xcah031d),SUM(xcah031e),SUM(xcah031f),SUM(xcah031g),SUM(xcah031h)",
                "    FROM axci006_xcah_tmp ",
                "   GROUP BY xcahsite,xcah001,xcah002,xcah004,xcah020",
                "   ORDER BY xcahsite,xcah001,xcah002,xcah004,xcah020"
   PREPARE axci006_xcah_tmp_prep FROM g_sql
   EXECUTE axci006_xcah_tmp_prep 

#   LET g_sql = " INSERT INTO axci006_xcah_tmp",
#                "  SELECT 2,xcahsite,xcah001,xcah004,'','','','','','','','','','','','','','','','',SUM(xcah031),SUM(xcah031a),",
#                "         SUM(xcah031b),SUM(xcah031c),SUM(xcah031d),SUM(xcah031e),SUM(xcah031f),SUM(xcah031g),SUM(xcah031h)",
#                "    FROM axci006_xcah_tmp WHERE a = 1",
#                "   GROUP BY xcahsite,xcah001,xcah004",
#                "   ORDER BY xcahsite,xcah001,xcah004"
#   PREPARE axci006_xcah_tmp_prep1 FROM g_sql
#   EXECUTE axci006_xcah_tmp_prep1
      
   LET g_sql = "SELECT xcah020,xcah021,xcah040,xcah022,xcah023,xcah030,xcah030a,xcah030b,xcah030c,",
               "       xcah030d,xcah030e,xcah030f,xcah030g,xcah030h,xcah026,xcah025,xcah027,xcah043,xcah042,xcah044,xcah031,xcah031a,",
               "       xcah031b,xcah031c,xcah031d,xcah031e,xcah031f,xcah031g,xcah031h,a ",
               "       FROM axci006_xcah_tmp"

   LET g_sql = g_sql, " ORDER BY xcah020,xcah040,a " 
                      
   PREPARE axci006_pb3 FROM g_sql
   DECLARE b_fill_curs3 CURSOR FOR axci006_pb3
   
   LET l_ac3 = 1
   FOREACH b_fill_curs3 INTO g_xcah_d[l_ac3].*,l_a
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      IF l_a = 1 THEN
         LET g_xcah_d[l_ac3].xcah040 = ''
         SELECT SUM(xcah031),SUM(xcah031a),SUM(xcah031b),SUM(xcah031c),SUM(xcah031d),SUM(xcah031e),
                SUM(xcah031f),SUM(xcah031g),SUM(xcah031h) 
            INTO g_xcah_d[l_ac3].xcah031,g_xcah_d[l_ac3].xcah031a,g_xcah_d[l_ac3].xcah031b,g_xcah_d[l_ac3].xcah031c,
                 g_xcah_d[l_ac3].xcah031d,g_xcah_d[l_ac3].xcah031e,g_xcah_d[l_ac3].xcah031f,g_xcah_d[l_ac3].xcah031g,
                 g_xcah_d[l_ac3].xcah031h                 
           FROM axci006_xcah_tmp 
          WHERE a = 1 and xcah020 >=g_xcah_d[l_ac3].xcah020
         CALL cl_getmsg('axc-00205',g_lang) RETURNING g_xcah_d[l_ac3].xcah020
         
      END IF
#      IF l_a = 2 THEN
#         LET g_xcah_d[l_ac3].xcah020 = ''
#         CALL cl_getmsg('axc-00204',g_lang) RETURNING g_xcah_d[l_ac3].xcah040
#      END IF
      LET l_ac3 = l_ac3 + 1
      IF l_ac3 > g_max_rec THEN
         CALL cl_err( '', 9035, 0 )
         EXIT FOREACH
      END IF
      
   END FOREACH

   CALL g_xcah_d.deleteElement(g_xcah_d.getLength()) 
END FUNCTION]]>
  </point>
  <point name="function.axci006_xcai_b_fill" order="2" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axci006_xcai_b_fill()
DEFINE l_ac4      LIKE type_t.num5
DEFINE l_a        LIKE type_t.num10

   DELETE FROM axci006_xcai_tmp
   CALL g_xcai_d.clear()

   INSERT INTO axci006_xcai_tmp
    SELECT 0,xcaisite,xcai001,xcai004,xcaiseq,xcai100,xcai101,xcai103,xcai108,xcai102,xcai104,xcai105,xcai106,xcai107 
      FROM xcai_t 
     WHERE xcaient=g_enterprise AND xcaisite = g_xcag_m.xcagsite
       AND xcai001=g_xcag_m.xcag001 AND xcai004 = g_xcag_d[l_ac].xcag004
       AND xcai002 =  g_xcag_d[l_ac].xcag002

   LET g_sql = " INSERT INTO axci006_xcai_tmp",
               "  SELECT 1,xcaisite,xcai001,xcai004,'',xcai100,xcai101,'','N','','','','',SUM(xcai107)",
               "    FROM axci006_xcai_tmp",
               "   GROUP BY xcaisite,xcai001,xcai004,xcai100,xcai101 ",
               "   ORDER BY xcaisite,xcai001,xcai004,xcai100,xcai101 "
  PREPARE axci006_xcai_tmp_prep FROM g_sql
  EXECUTE axci006_xcai_tmp_prep
  
  LET g_sql = " INSERT INTO axci006_xcai_tmp",
               "  SELECT 2,xcaisite,xcai001,xcai004,'','','','','N','','','','',SUM(xcai107)",
               "    FROM axci006_xcai_tmp WHERE a = 1",
               "   GROUP BY xcaisite,xcai001,xcai004 ",
               "   ORDER BY xcaisite,xcai001,xcai004"
  PREPARE axci006_xcai_tmp_prep1 FROM g_sql
  EXECUTE axci006_xcai_tmp_prep1

   LET g_sql = "SELECT xcaiseq,xcai100,xcai101,xcai103,xcai108,xcai102,xcai104,xcai105,xcai106,xcai107,a ",
               "  FROM axci006_xcai_tmp "

   LET g_sql = g_sql, " ORDER BY xcai100,xcai101,a,xcaiseq  " 
                      
   PREPARE axci006_pb4 FROM g_sql
   DECLARE b_fill_curs4 CURSOR FOR axci006_pb4

   LET l_ac4 = 1
   FOREACH b_fill_curs4 INTO g_xcai_d[l_ac4].*,l_a
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF

      IF l_a = 1 THEN
         LET g_xcai_d[l_ac4].xcai101 = ''
         CALL cl_getmsg('axc-00205',g_lang) RETURNING g_xcai_d[l_ac4].xcai100
      END IF
      IF l_a = 2 THEN
         LET g_xcai_d[l_ac4].xcai101 = ''
         CALL cl_getmsg('axc-00204',g_lang) RETURNING g_xcai_d[l_ac4].xcai100
      END IF
      
      LET l_ac4 = l_ac4 + 1
      IF l_ac4 > g_max_rec THEN
         CALL cl_err( '', 9035, 0 )
         EXIT FOREACH
      END IF
      
   END FOREACH
   
   CALL g_xcai_d.deleteElement(g_xcai_d.getLength()) 
END FUNCTION]]>
  </point>
  <point name="function.axci006_xcaj_b_fill" order="3" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axci006_xcaj_b_fill()
DEFINE l_ac5      LIKE type_t.num5

   CALL g_xcaj_d.clear()

   LET g_sql = "SELECT xcaj005,'',xcaj102 ",
               "  FROM xcaj_t WHERE xcajent=? AND xcajsite = ? AND xcaj001=? ",
               "   AND xcaj002=  ? AND xcaj004=? "

   LET g_sql = g_sql, " ORDER BY xcaj005 " 
                      
   PREPARE axci006_pb5 FROM g_sql
   DECLARE b_fill_curs5 CURSOR FOR axci006_pb5
   
   OPEN b_fill_curs5 USING g_enterprise,g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag004

   LET l_ac5 = 1
   FOREACH b_fill_curs5 INTO g_xcaj_d[l_ac5].*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF

      SELECT xcaul003 INTO g_xcaj_d[l_ac5].xcaj005_desc FROM xcaul_t
       WHERE xcaulent = g_enterprise AND xcaul001 = g_xcaj_d[l_ac5].xcaj005
         AND xcaul002 = g_dlang

      LET l_ac5 = l_ac5 + 1
      IF l_ac5 > g_max_rec THEN
         CALL cl_err( '', 9035, 0 )
         EXIT FOREACH
      END IF
      
   END FOREACH

   CALL g_xcaj_d.deleteElement(g_xcaj_d.getLength()) 
END FUNCTION]]>
  </point>
  <point name="function.axci006_create_tmp" order="4" ver="2" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axci006_create_tmp()
DROP TABLE axci006_xcah_tmp

   CREATE TEMP TABLE axci006_xcah_tmp
   (
   a DECIMAL(10,0),     #标识栏位
   xcahsite VARCHAR(10),
   xcah001 VARCHAR(80),
   xcah002 DATE,
   xcah004 VARCHAR(40),
   xcah020 DECIMAL(10,0),  
   xcah021 DECIMAL(10,0),
   xcah040 VARCHAR(40),
   xcah022 VARCHAR(40),
   xcah023 VARCHAR(10),
   xcah030 DECIMAL(20,6),
   xcah030a DECIMAL(20,6),
   xcah030b DECIMAL(20,6),
   xcah030c DECIMAL(20,6),
   xcah030d DECIMAL(20,6),
   xcah030e DECIMAL(20,6),
   xcah030f DECIMAL(20,6),
   xcah030g DECIMAL(20,6),
   xcah030h DECIMAL(20,6),
   xcah026 DECIMAL(20,6),
   xcah025 DECIMAL(20,6),
   xcah027 DECIMAL(20,6),
   xcah043 DECIMAL(20,6),
   xcah042 DECIMAL(20,6),
   xcah044 DECIMAL(20,6),
   xcah031 DECIMAL(20,6),
   xcah031a DECIMAL(20,6),
   xcah031b DECIMAL(20,6),
   xcah031c DECIMAL(20,6),
   xcah031d DECIMAL(20,6),
   xcah031e DECIMAL(20,6),
   xcah031f DECIMAL(20,6),
   xcah031g DECIMAL(20,6),
   xcah031h DECIMAL(20,6)
    );
    
   DROP TABLE axci006_xcai_tmp

   CREATE TEMP TABLE axci006_xcai_tmp
   (
   a DECIMAL(10,0),     #标识栏位
   xcaisite VARCHAR(10),
   xcai001 VARCHAR(80),
   xcai004 VARCHAR(40),
   xcaiseq DECIMAL(10,0), 
   xcai100 VARCHAR(40),
   xcai101 VARCHAR(10),
   xcai103 VARCHAR(10),
   xcai108 VARCHAR(1),
   xcai102 VARCHAR(10),
   xcai104 VARCHAR(10),
   xcai105 DECIMAL(20,6),
   xcai106 DECIMAL(20,6),
   xcai107 DECIMAL(20,6)
   );
END FUNCTION]]>
  </point>
  <point name="function.axci006_init" order="5" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_init()
   #add-point:init段define

   #end add-point

   LET g_bfill = "Y"
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1


   LET g_error_show = 1
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件

   #add-point:畫面資料初始化

   #end add-point

   CALL axci006_default_search()

END FUNCTION]]>
  </point>
  <point name="function.axci006_ui_dialog" order="6" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_ui_dialog()
   DEFINE la_param  RECORD
             prog   STRING,
             param  DYNAMIC ARRAY OF STRING
                    END RECORD
   DEFINE ls_js     STRING
   DEFINE li_idx    LIKE type_t.num5
   DEFINE ls_wc     STRING
   DEFINE lb_first  BOOLEAN
   #add-point:ui_dialog段define

   #end add-point

   CALL cl_set_act_visible("accept,cancel", FALSE)

   LET lb_first = TRUE


   #add-point:ui_dialog段before dialog
   CALL axci006_create_tmp()
   CALL cl_set_comp_visible('check',FALSE)
   #end add-point

   WHILE TRUE

      CALL axci006_browser_fill("")


      #判斷前一個動作是否為新增, 若是的話切換到新增的筆數
      IF g_state = "Y" THEN
         FOR li_idx = 1 TO g_browser.getLength()
            IF g_browser[li_idx].b_xcagsite = g_xcagsite_t
               AND g_browser[li_idx].b_xcag001 = g_xcag001_t

               THEN
               LET g_current_row = li_idx
               EXIT FOR
            END IF
         END FOR
         LET g_state = ""
      END IF

      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)


         DISPLAY ARRAY g_xcag_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1

            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL axci006_ui_detailshow()

               #add-point:page1自定義行為
               CALL axci006_xcah_b_fill()
               CALL axci006_xcai_b_fill()
               CALL axci006_xcaj_b_fill()
               #end add-point

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail1")

               #控制stus哪個按鈕可以按




            #add-point:page1自定義行為

            #end add-point

         END DISPLAY

         DISPLAY ARRAY g_xcag2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)

            BEFORE ROW
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL axci006_ui_detailshow()

               #add-point:page1自定義行為

               #end add-point

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)



            #add-point:page2自定義行為
            LET g_current_page = 1
            #end add-point

         END DISPLAY


         #add-point:ui_dialog段自定義display array
         DISPLAY ARRAY g_xcah_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b2)

            BEFORE ROW
               LET l_ac2 = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx2 = l_ac2

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx2)
               LET l_ac2 = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 1

         END DISPLAY

         DISPLAY ARRAY g_xcai_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b3)

            BEFORE ROW
               LET l_ac3 = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx3 = l_ac3

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx3)
               LET l_ac3 = DIALOG.getCurrentRow("s_detail4")
               LET g_current_page = 1

         END DISPLAY

         DISPLAY ARRAY g_xcaj_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b4)

            BEFORE ROW
               LET l_ac4 = DIALOG.getCurrentRow("s_detail5")
               LET g_detail_idx4 = l_ac4

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx4)
               LET l_ac4 = DIALOG.getCurrentRow("s_detail5")
               LET g_current_page = 1

         END DISPLAY
         #end add-point


         BEFORE DIALOG
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL g_curr_diag.setSelectionMode("s_detail1",1)
            LET g_page = "first"
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               LET g_current_idx = g_current_row
            END IF
            LET g_current_row = g_current_idx #目前指標
            LET g_current_sw = TRUE

            IF g_current_idx > g_browser.getLength() THEN
               LET g_current_idx = g_browser.getLength()
            END IF

            IF g_current_idx = 0 AND g_browser.getLength() > 0 THEN
               LET g_current_idx = 1
            END IF

            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL axci006_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL axci006_ui_detailshow() #Setting the current row

            #add-point:ui_dialog段before dialog2

            #end add-point

            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD xcag002
            END IF



         ON ACTION first
            CALL axci006_fetch('F')
            LET g_current_row = g_current_idx

         ON ACTION previous
            CALL axci006_fetch('P')
            LET g_current_row = g_current_idx

         ON ACTION jump
            CALL axci006_fetch('/')
            LET g_current_row = g_current_idx

         ON ACTION next
            CALL axci006_fetch('N')
            LET g_current_row = g_current_idx

         ON ACTION last
            CALL axci006_fetch('L')
            LET g_current_row = g_current_idx

         ON ACTION close
            LET INT_FLAG=FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG

         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG


         ON ACTION worksheethidden   #瀏覽頁折疊
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
                CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF

         ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden
            END IF

         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               LET g_wc = ls_wc
               CALL axci006_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF

         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               LET g_wc = ls_wc
               #取得條件後需要重查、跳到結果第一筆資料的功能程式段
               CALL axci006_browser_fill("F")
               IF g_browser_cnt = 0 THEN
                  CALL cl_err("","-100",1)
                  CLEAR FORM
               ELSE
                  CALL axci006_fetch("F")
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()


         #+ 此段落由子樣板a43產生
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL axci006_modify()
               #add-point:ON ACTION modify

               #END add-point
               EXIT DIALOG
            END IF


         #+ 此段落由子樣板a43產生
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL axci006_modify()
               #add-point:ON ACTION modify_detail

               #END add-point
               EXIT DIALOG
            END IF


         #+ 此段落由子樣板a43產生
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL axci006_delete()
               #add-point:ON ACTION delete

               #END add-point

            END IF


         #+ 此段落由子樣板a43產生
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN

               #add-point:ON ACTION output

               #END add-point
               EXIT DIALOG
            END IF


         #+ 此段落由子樣板a43產生
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL axci006_query()
               #add-point:ON ACTION query

               #END add-point

            END IF





         #+ 此段落由子樣板a46產生
         #新增相關文件
         ON ACTION related_document
            CALL axci006_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document

               #END add-point
               CALL cl_doc()
            END IF

         ON ACTION agendum
            CALL axci006_set_pk_array()
            #add-point:ON ACTION agendum

            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()

         ON ACTION followup
            CALL axci006_set_pk_array()
            #add-point:ON ACTION followup

            #END add-point
            CALL cl_user_overview_follow('')



         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG

      END DIALOG

      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF

   END WHILE

   CALL cl_set_act_visible("accept,cancel", TRUE)

END FUNCTION]]>
  </point>
  <point name="function.axci006_browser_search" order="7" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_browser_search(p_type)
   DEFINE p_type LIKE type_t.chr10
   #add-point:browser_search段define

   #end add-point

   #若無輸入關鍵字則查找出所有資料
   IF NOT cl_null(g_searchstr) AND g_searchcol='0' THEN
      CALL cl_err("searchcol","std-00005",0)
      RETURN FALSE
   END IF

   IF NOT cl_null(g_searchstr) THEN
      LET g_wc = " lower(", g_searchcol, ") LIKE '%", g_searchstr, "%'"
      LET g_wc = g_wc.toLowerCase()
   ELSE
      LET g_wc = " 1=1"
   END IF

   #若為排序搜尋則添加以下條件
   IF cl_null(g_searchcol) OR g_searchcol = "0" THEN
      LET g_wc = g_wc, " ORDER BY xcagsite"
   ELSE
      LET g_wc = g_wc, " ORDER BY ", g_searchcol
   END IF

   CALL axci006_browser_fill("F")
   CALL ui.Interface.refresh()
   RETURN TRUE

END FUNCTION]]>
  </point>
  <point name="function.axci006_browser_fill" order="8" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_browser_fill(ps_page_action)
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   DEFINE l_searchcol       STRING
   #add-point:browser_fill段define

   #end add-point

   #add-point:browser_fill段動作開始前

   #end add-point

   CALL g_browser.clear()

   #搜尋用
   IF cl_null(g_searchcol) OR g_searchcol = '0' THEN
      LET l_searchcol = "xcagsite"
   ELSE
      LET l_searchcol = g_searchcol
   END IF

   LET l_wc  = g_wc.trim()
   LET l_wc2 = g_wc2.trim()
   IF cl_null(l_wc) THEN  #p_wc 查詢條件
      RETURN
   END IF

   IF g_wc2 <> " 1=1" OR NOT cl_null(g_wc2) THEN
      #單身有輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE xcagsite ",
                      ", xcag001,xcagcomp,xcag011 ",

                      " FROM xcag_t ",
                      " ",
                      " ",

                      " WHERE xcagent = '" ||g_enterprise|| "' AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("xcag_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE xcagsite ",
                      ", xcag001,xcagcomp,xcag011 ",

                      " FROM xcag_t ",
                      " ",
                      " ",
                      " WHERE xcagent = '" ||g_enterprise|| "' AND ",l_wc CLIPPED, cl_sql_add_filter("xcag_t")
   END IF

   LET g_sql = " SELECT COUNT(*) FROM (",l_sub_sql,")"

   #add-point:browser_fill,count前

   #end add-point

   PREPARE header_cnt_pre FROM g_sql
   EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
   FREE header_cnt_pre

   #若超過最大顯示筆數
   LET g_error_show = 0

   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示

   #LET g_page_action = ps_page_action          # Keep Action
   IF ps_page_action = "first" OR
      ps_page_action = "prev"  OR
      ps_page_action = "next"  OR
      ps_page_action = "last"  THEN
      LET g_page_action = ps_page_action        #g_page_action 這個會影響 browser 下面四個button 的判斷
   END IF

   CASE ps_page_action
      WHEN "F"
         LET g_pagestart = 1

      WHEN "P"
         LET g_pagestart = g_pagestart - g_max_browse
         IF g_pagestart < 1 THEN
             LET g_pagestart = 1
         END IF

      WHEN "N"
         LET g_pagestart = g_pagestart + g_max_browse
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
            WHILE g_pagestart > g_browser_cnt
               LET g_pagestart = g_pagestart - g_max_browse
            END WHILE
         END IF

      WHEN "L"
         LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
         WHILE g_pagestart > g_browser_cnt
            LET g_pagestart = g_pagestart - g_max_browse
         END WHILE

      OTHERWISE
         LET g_pagestart = 1

   END CASE

   #單身有輸入查詢條件且非null
   IF g_wc2 <> " 1=1" AND NOT cl_null(g_wc2) THEN

      #依照xcagsite,xcag001 Browser欄位定義(取代原本bs_sql功能)
      LET l_sub_sql  = "SELECT DISTINCT xcagsite,xcag001,xcagcomp,xcag011 ",
                       " FROM xcag_t ",

                       " ",
                       " WHERE xcagent = '" ||g_enterprise|| "' AND ", g_wc," AND ",g_wc2, cl_sql_add_filter("xcag_t")

   ELSE
      #單身無輸入資料
      LET l_sub_sql  = "SELECT DISTINCT xcagsite,xcag001,xcagcomp,xcag011 ",
                       " FROM xcag_t ",
                       " WHERE xcagent = '" ||g_enterprise|| "' AND ", g_wc, cl_sql_add_filter("xcag_t")

   END IF

   #add-point:browser_fill,sql_rank前

   #end add-point

   LET l_sql_rank = "SELECT xcagsite,xcag001,xcagcomp,xcag011,DENSE_RANK() OVER(ORDER BY xcagsite ",g_order,") AS RANK ",

                    " FROM (",l_sub_sql,") "

   #定義翻頁CURSOR
   LET g_sql= " SELECT xcagsite,xcag001,xcagcomp,xcag011 FROM (",l_sql_rank,") WHERE RANK>=",g_pagestart,
              " AND RANK < ", g_pagestart + g_max_browse,
              " ORDER BY ",l_searchcol, " ", g_order

   #add-point:browser_fill,pre前

   #end add-point

   PREPARE browse_pre FROM g_sql
   DECLARE browse_cur CURSOR FOR browse_pre

   CALL g_browser.clear()
   LET g_cnt = 1
   FOREACH browse_cur INTO g_browser[g_cnt].b_xcagsite,g_browser[g_cnt].b_xcag001,
                           g_browser[g_cnt].b_xcagcomp,g_browser[g_cnt].b_xcag011
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF



      #add-point:browser_fill段reference

      #end add-point

      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         EXIT FOREACH
      END IF
   END FOREACH

   CALL g_browser.deleteElement(g_cnt)
   IF g_browser.getLength() = 0 AND g_wc THEN
      INITIALIZE g_xcag_m.* TO NULL
      CALL g_xcag_d.clear()
      CALL g_xcag2_d.clear()

      #add-point:browser_fill段after_clear

      #end add-point
      CLEAR FORM
   END IF

   LET g_header_cnt = g_browser.getLength()
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0


   FREE browse_pre

   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", TRUE)
   END IF

END FUNCTION]]>
  </point>
  <point name="function.axci006_ui_headershow" order="9" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_ui_headershow()
   #add-point:ui_headershow段define

   #end add-point

   LET g_xcag_m.xcagsite = g_browser[g_current_idx].b_xcagsite
   LET g_xcag_m.xcag001 = g_browser[g_current_idx].b_xcag001
   LET g_xcag_m.xcagcomp = g_browser[g_current_idx].b_xcagcomp
   LET g_xcag_m.xcag011 = g_browser[g_current_idx].b_xcag011

   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011
       INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001
   CALL axci006_show()

END FUNCTION]]>
  </point>
  <point name="function.axci006_ui_detailshow" order="10" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_ui_detailshow()
   #add-point:ui_detailshow段define

   #end add-point

   #add-point:ui_detailshow段before

   #end add-point

   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)

      #add-point:ui_detailshow段more

      #end add-point
   END IF

   #add-point:ui_detailshow段after

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_ui_browser_refresh" order="11" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_ui_browser_refresh()
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define

   #end add-point

   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_xcagsite = g_xcag_m.xcagsite
         AND g_browser[l_i].b_xcag001 = g_xcag_m.xcag001

         THEN
         CALL g_browser.deleteElement(l_i)
         LET g_header_cnt = g_header_cnt - 1
      END IF
   END FOR

   LET g_browser_cnt = g_browser_cnt - 1
   IF g_current_row > g_browser_cnt THEN        #確定browse 筆數指在同一筆
      LET g_current_row = g_browser_cnt
   END IF

   DISPLAY g_browser_cnt TO FORMONLY.b_count    #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數的顯示

END FUNCTION]]>
  </point>
  <point name="function.axci006_construct" order="12" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_construct()
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING
   DEFINE ls_wc       STRING
   #add-point:cs段define

   #end add-point

   #清除畫面上相關資料
   CLEAR FORM
   INITIALIZE g_xcag_m.* TO NULL
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()
   CALL g_xcah_d.clear()
   CALL g_xcai_d.clear()
   CALL g_xcaj_d.clear()

   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   LET g_action_choice = ""

   LET g_qryparam.state = 'c'

   #add-point:cs段construct外

   #end add-point

   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭
      CONSTRUCT BY NAME g_wc ON xcagsite,xcagcomp,xcag011,xcag001

         BEFORE CONSTRUCT
            #add-point:cs段more_construct

            #end add-point

        #---------------------------<  Master  >---------------------------
         #----<<xcagsite>>----
         #Ctrlp:construct.c.xcagsite
         ON ACTION controlp INFIELD xcagsite
            #add-point:ON ACTION controlp INFIELD xcagsite
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcagsite()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagsite  #顯示到畫面上
            NEXT FIELD xcagsite                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagsite
            #add-point:BEFORE FIELD xcagsite

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagsite

            #add-point:AFTER FIELD xcagsite

            #END add-point


         #----<<xcagsite_desc>>----
         #----<<xcagcomp>>----
         #Ctrlp:construct.c.xcagcomp
         ON ACTION controlp INFIELD xcagcomp
            #add-point:ON ACTION controlp INFIELD xcagcomp
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcagcomp()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagcomp  #顯示到畫面上
            NEXT FIELD xcagcomp                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagcomp
            #add-point:BEFORE FIELD xcagcomp

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagcomp

            #add-point:AFTER FIELD xcagcomp

            #END add-point


         #----<<xcagcomp_desc>>----
         #----<<xcag011>>----
         #Ctrlp:construct.c.xcag011
         ON ACTION controlp INFIELD xcag011
            #add-point:ON ACTION controlp INFIELD xcag011
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_aooi001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcag011  #顯示到畫面上
            NEXT FIELD xcag011                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcag011
            #add-point:BEFORE FIELD xcag011

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag011

            #add-point:AFTER FIELD xcag011

            #END add-point


         #----<<xcag011_desc>>----
         #----<<xcag001>>----
         #Ctrlp:construct.c.xcag001
         ON ACTION controlp INFIELD xcag001
            #add-point:ON ACTION controlp INFIELD xcag001
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcag001  #顯示到畫面上
            NEXT FIELD xcag001                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcag001
            #add-point:BEFORE FIELD xcag001

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag001

            #add-point:AFTER FIELD xcag001

            #END add-point


         #----<<xcag001_desc>>----


      END CONSTRUCT

      CONSTRUCT g_wc2_table1 ON check,xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d,
          xcag102e,xcag102f,xcag102g,xcag102h,xcagownid,xcagowndp,xcagcrtid,xcagcrtdp,xcagcrtdt,xcagmodid,
          xcagmoddt
           FROM s_detail1[1].check,s_detail1[1].xcag004,s_detail1[1].xcag002,s_detail1[1].xcag003,s_detail1[1].xcag102,
               s_detail1[1].xcag102a,s_detail1[1].xcag102b,s_detail1[1].xcag102c,s_detail1[1].xcag102d,
               s_detail1[1].xcag102e,s_detail1[1].xcag102f,s_detail1[1].xcag102g,s_detail1[1].xcag102h,
               s_detail2[1].xcagownid,s_detail2[1].xcagowndp,s_detail2[1].xcagcrtid,s_detail2[1].xcagcrtdp,
               s_detail2[1].xcagcrtdt,s_detail2[1].xcagmodid,s_detail2[1].xcagmoddt

         BEFORE CONSTRUCT
            #add-point:cs段more_construct

            #end add-point

         #單身公用欄位開窗相關處理
         #此段落由子樣板a11產生
         ##----<<xcagownid>>----
         #ON ACTION controlp INFIELD xcagownid
         #   CALL q_common('xcag_t','xcagownid',TRUE,FALSE,g_xcag2_d[1].xcagownid) RETURNING ls_return
         #   DISPLAY ls_return TO xcagownid
         #   NEXT FIELD xcagownid
         #
         ##----<<xcagowndp>>----
         #ON ACTION controlp INFIELD xcagowndp
         #   CALL q_common('xcag_t','xcagowndp',TRUE,FALSE,g_xcag2_d[1].xcagowndp) RETURNING ls_return
         #   DISPLAY ls_return TO xcagowndp
         #   NEXT FIELD xcagowndp
         #
         ##----<<xcagcrtid>>----
         #ON ACTION controlp INFIELD xcagcrtid
         #   CALL q_common('xcag_t','xcagcrtid',TRUE,FALSE,g_xcag2_d[1].xcagcrtid) RETURNING ls_return
         #   DISPLAY ls_return TO xcagcrtid
         #   NEXT FIELD xcagcrtid
         #
         ##----<<xcagcrtdp>>----
         #ON ACTION controlp INFIELD xcagcrtdp
         #   CALL q_common('xcag_t','xcagcrtdp',TRUE,FALSE,g_xcag2_d[1].xcagcrtdp) RETURNING ls_return
         #   DISPLAY ls_return TO xcagcrtdp
         #   NEXT FIELD xcagcrtdp
         #
         ##----<<xcagmodid>>----
         #ON ACTION controlp INFIELD xcagmodid
         #   CALL q_common('xcag_t','xcagmodid',TRUE,FALSE,g_xcag2_d[1].xcagmodid) RETURNING ls_return
         #   DISPLAY ls_return TO xcagmodid
         #   NEXT FIELD xcagmodid
         #
         ##----<<xcagcnfid>>----
         ##ON ACTION controlp INFIELD xcagcnfid
         ##   CALL q_common('xcag_t','xcagcnfid',TRUE,FALSE,.xcagcnfid) RETURNING ls_return
         ##   DISPLAY ls_return TO xcagcnfid
         ##   NEXT FIELD xcagcnfid
         #
         ##----<<xcagpstid>>----
         ##ON ACTION controlp INFIELD xcagpstid
         ##   CALL q_common('xcag_t','xcagpstid',TRUE,FALSE,.xcagpstid) RETURNING ls_return
         ##   DISPLAY ls_return TO xcagpstid
         ##   NEXT FIELD xcagpstid

         ##----<<xcagcrtdt>>----
         AFTER FIELD xcagcrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<xcagmoddt>>----
         AFTER FIELD xcagmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<xcagcnfdt>>----
         #AFTER FIELD xcagcnfdt
         #   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         #   IF NOT cl_null(ls_result) THEN
         #      IF NOT cl_chk_date_symbol(ls_result) THEN
         #         LET ls_result = cl_add_date_extra_cond(ls_result)
         #      END IF
         #   END IF
         #   CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<xcagpstdt>>----
         #AFTER FIELD xcagpstdt
         #   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         #   IF NOT cl_null(ls_result) THEN
         #      IF NOT cl_chk_date_symbol(ls_result) THEN
         #         LET ls_result = cl_add_date_extra_cond(ls_result)
         #      END IF
         #   END IF
         #   CALL FGL_DIALOG_SETBUFFER(ls_result)



         #單身一般欄位開窗相關處理
         #---------------------<  Detail: page1  >---------------------
         #----<<check>>----
         #此段落由子樣板a01產生
         BEFORE FIELD check
            #add-point:BEFORE FIELD check

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD check

            #add-point:AFTER FIELD check

            #END add-point


         #Ctrlp:construct.c.page1.check
#         ON ACTION controlp INFIELD check
            #add-point:ON ACTION controlp INFIELD check

            #END add-point

         #----<<xcag004>>----
         #Ctrlp:construct.c.page1.xcag004
         ON ACTION controlp INFIELD xcag004
            #add-point:ON ACTION controlp INFIELD xcag004
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcag004()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcag004  #顯示到畫面上
            NEXT FIELD xcag004                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcag004
            #add-point:BEFORE FIELD xcag004

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag004

            #add-point:AFTER FIELD xcag004

            #END add-point


         #----<<xcag002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag002
            #add-point:BEFORE FIELD xcag002

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag002

            #add-point:AFTER FIELD xcag002

            #END add-point


         #Ctrlp:construct.c.page1.xcag002
#         ON ACTION controlp INFIELD xcag002
            #add-point:ON ACTION controlp INFIELD xcag002

            #END add-point

         #----<<xcag003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag003
            #add-point:BEFORE FIELD xcag003

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag003

            #add-point:AFTER FIELD xcag003

            #END add-point


         #Ctrlp:construct.c.page1.xcag003
#         ON ACTION controlp INFIELD xcag003
            #add-point:ON ACTION controlp INFIELD xcag003

            #END add-point

         #----<<xcag102>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102
            #add-point:BEFORE FIELD xcag102

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102

            #add-point:AFTER FIELD xcag102

            #END add-point


         #Ctrlp:construct.c.page1.xcag102
#         ON ACTION controlp INFIELD xcag102
            #add-point:ON ACTION controlp INFIELD xcag102

            #END add-point

         #----<<xcag102a>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102a
            #add-point:BEFORE FIELD xcag102a

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102a

            #add-point:AFTER FIELD xcag102a

            #END add-point


         #Ctrlp:construct.c.page1.xcag102a
#         ON ACTION controlp INFIELD xcag102a
            #add-point:ON ACTION controlp INFIELD xcag102a

            #END add-point

         #----<<xcag102b>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102b
            #add-point:BEFORE FIELD xcag102b

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102b

            #add-point:AFTER FIELD xcag102b

            #END add-point


         #Ctrlp:construct.c.page1.xcag102b
#         ON ACTION controlp INFIELD xcag102b
            #add-point:ON ACTION controlp INFIELD xcag102b

            #END add-point

         #----<<xcag102c>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102c
            #add-point:BEFORE FIELD xcag102c

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102c

            #add-point:AFTER FIELD xcag102c

            #END add-point


         #Ctrlp:construct.c.page1.xcag102c
#         ON ACTION controlp INFIELD xcag102c
            #add-point:ON ACTION controlp INFIELD xcag102c

            #END add-point

         #----<<xcag102d>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102d
            #add-point:BEFORE FIELD xcag102d

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102d

            #add-point:AFTER FIELD xcag102d

            #END add-point


         #Ctrlp:construct.c.page1.xcag102d
#         ON ACTION controlp INFIELD xcag102d
            #add-point:ON ACTION controlp INFIELD xcag102d

            #END add-point

         #----<<xcag102e>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102e
            #add-point:BEFORE FIELD xcag102e

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102e

            #add-point:AFTER FIELD xcag102e

            #END add-point


         #Ctrlp:construct.c.page1.xcag102e
#         ON ACTION controlp INFIELD xcag102e
            #add-point:ON ACTION controlp INFIELD xcag102e

            #END add-point

         #----<<xcag102f>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102f
            #add-point:BEFORE FIELD xcag102f

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102f

            #add-point:AFTER FIELD xcag102f

            #END add-point


         #Ctrlp:construct.c.page1.xcag102f
#         ON ACTION controlp INFIELD xcag102f
            #add-point:ON ACTION controlp INFIELD xcag102f

            #END add-point

         #----<<xcag102g>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102g
            #add-point:BEFORE FIELD xcag102g

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102g

            #add-point:AFTER FIELD xcag102g

            #END add-point


         #Ctrlp:construct.c.page1.xcag102g
#         ON ACTION controlp INFIELD xcag102g
            #add-point:ON ACTION controlp INFIELD xcag102g

            #END add-point

         #----<<xcag102h>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102h
            #add-point:BEFORE FIELD xcag102h

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102h

            #add-point:AFTER FIELD xcag102h

            #END add-point


         #Ctrlp:construct.c.page1.xcag102h
#         ON ACTION controlp INFIELD xcag102h
            #add-point:ON ACTION controlp INFIELD xcag102h

            #END add-point

#---------------------<  Detail: page2  >---------------------
         #----<<xcagownid>>----
         #Ctrlp:construct.c.page2.xcagownid
         ON ACTION controlp INFIELD xcagownid
            #add-point:ON ACTION controlp INFIELD xcagownid
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagownid  #顯示到畫面上
            NEXT FIELD xcagownid                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagownid
            #add-point:BEFORE FIELD xcagownid

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagownid

            #add-point:AFTER FIELD xcagownid

            #END add-point


         #----<<xcagownid_desc>>----
         #----<<xcagowndp>>----
         #Ctrlp:construct.c.page2.xcagowndp
         ON ACTION controlp INFIELD xcagowndp
            #add-point:ON ACTION controlp INFIELD xcagowndp
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagowndp  #顯示到畫面上
            NEXT FIELD xcagowndp                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagowndp
            #add-point:BEFORE FIELD xcagowndp

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagowndp

            #add-point:AFTER FIELD xcagowndp

            #END add-point


         #----<<xcagowndp_desc>>----
         #----<<xcagcrtid>>----
         #Ctrlp:construct.c.page2.xcagcrtid
         ON ACTION controlp INFIELD xcagcrtid
            #add-point:ON ACTION controlp INFIELD xcagcrtid
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagcrtid  #顯示到畫面上
            NEXT FIELD xcagcrtid                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagcrtid
            #add-point:BEFORE FIELD xcagcrtid

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagcrtid

            #add-point:AFTER FIELD xcagcrtid

            #END add-point


         #----<<xcagcrtid_desc>>----
         #----<<xcagcrtdp>>----
         #Ctrlp:construct.c.page2.xcagcrtdp
         ON ACTION controlp INFIELD xcagcrtdp
            #add-point:ON ACTION controlp INFIELD xcagcrtdp
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagcrtdp  #顯示到畫面上
            NEXT FIELD xcagcrtdp                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagcrtdp
            #add-point:BEFORE FIELD xcagcrtdp

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagcrtdp

            #add-point:AFTER FIELD xcagcrtdp

            #END add-point


         #----<<xcagcrtdp_desc>>----
         #----<<xcagcrtdt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcagcrtdt
            #add-point:BEFORE FIELD xcagcrtdt

            #END add-point

         #----<<xcagmodid>>----
         #Ctrlp:construct.c.page2.xcagmodid
         ON ACTION controlp INFIELD xcagmodid
            #add-point:ON ACTION controlp INFIELD xcagmodid
            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagmodid  #顯示到畫面上
            NEXT FIELD xcagmodid                     #返回原欄位



            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD xcagmodid
            #add-point:BEFORE FIELD xcagmodid

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcagmodid

            #add-point:AFTER FIELD xcagmodid

            #END add-point


         #----<<xcagmodid_desc>>----
         #----<<xcagmoddt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcagmoddt
            #add-point:BEFORE FIELD xcagmoddt

            #END add-point



      END CONSTRUCT



      #add-point:cs段more_construct

      #end add-point

      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:ui_dialog段b_dialog

         #end add-point

      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc

      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG

   #add-point:cs段after_construct

   #end add-point

   #組合g_wc2
   LET g_wc2 = g_wc2_table1




   LET g_current_row = 1

   IF INT_FLAG THEN
      RETURN
   END IF

   LET g_wc_filter = ""

END FUNCTION]]>
  </point>
  <point name="function.axci006_query" order="13" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_query()
   DEFINE ls_wc STRING
   #add-point:query段define

   #end add-point

   #add-point:query開始前

   #end add-point

   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF

   LET ls_wc = g_wc

   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""

   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()

   DISPLAY ' ' TO FORMONLY.idx
   DISPLAY ' ' TO FORMONLY.cnt
   DISPLAY ' ' TO FORMONLY.b_index
   DISPLAY ' ' TO FORMONLY.b_count
   DISPLAY ' ' TO FORMONLY.h_index
   DISPLAY ' ' TO FORMONLY.h_count

   CALL axci006_construct()

   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      LET g_wc = ls_wc
      CALL axci006_browser_fill(g_wc)
      CALL axci006_fetch("")
      RETURN
   END IF

   LET l_ac = 1
   LET g_detail_cnt = 0
   LET g_current_idx = 0
   LET g_current_row = 0
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1

   LET g_error_show = 1
   CALL axci006_browser_fill("F")

   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||")")

   #備份搜尋條件
   LET ls_wc = g_wc

   IF g_browser.getLength() = 0 THEN
      CALL cl_err("","-100",1)
   ELSE
      CALL axci006_fetch("F")
   END IF

   LET g_wc_filter = ""

END FUNCTION]]>
  </point>
  <point name="function.axci006_fetch" order="14" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_fetch(p_flag)
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define

   #end add-point

   #add-point:fetch段動作開始前

   #end add-point

   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt
      WHEN 'P'
         IF g_current_idx > 1 THEN
            LET g_current_idx = g_current_idx - 1
         END IF
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF
      WHEN '/'
         IF (NOT g_no_ask) THEN
            CALL cl_set_act_visible("accept,cancel", TRUE)
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0

            PROMPT ls_msg CLIPPED,': ' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl"
            END PROMPT

            CALL cl_set_act_visible("accept,cancel", FALSE)
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               EXIT CASE
            END IF

         END IF

         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
            LET g_current_idx = g_jump
         END IF

         LET g_no_ask = FALSE
   END CASE

   #若無資料則離開
   IF g_current_idx = 0 THEN
      RETURN
   END IF

   CALL axci006_browser_fill(p_flag)

   LET g_detail_cnt = g_header_cnt

   #單身筆數顯示
   DISPLAY g_detail_cnt TO FORMONLY.cnt                      #設定page 總筆數
   #LET g_detail_idx = 1
   IF g_detail_cnt > 0 THEN
      #LET g_detail_idx = 1
      DISPLAY g_detail_idx TO FORMONLY.idx
   ELSE
      LET g_detail_idx = 0
      DISPLAY ' ' TO FORMONLY.idx
   END IF

   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數

   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )

   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF

   #超出範圍
   IF g_current_idx > g_browser.getLength() THEN
      LET g_current_idx = g_browser.getLength()
   END IF

   LET g_xcag_m.xcagsite = g_browser[g_current_idx].b_xcagsite
   LET g_xcag_m.xcag001 = g_browser[g_current_idx].b_xcag001
   LET g_xcag_m.xcagcomp = g_browser[g_current_idx].b_xcagcomp
   LET g_xcag_m.xcag011 = g_browser[g_current_idx].b_xcag011


   #重讀DB,因TEMP有不被更新特性
   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp,
       g_xcag_m.xcag011,g_xcag_m.xcag001
   IF SQLCA.sqlcode THEN
      CALL cl_err("xcag_t",SQLCA.sqlcode,1)
      INITIALIZE g_xcag_m.* TO NULL
      RETURN
   END IF

   #LET g_data_owner =
   #LET g_data_group =

   #重新顯示
   CALL axci006_show()

END FUNCTION]]>
  </point>
  <point name="function.axci006_insert" order="15" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_insert()
   #add-point:insert段define

   #end add-point

   #add-point:insert段before

   #end add-point

   #清除相關資料
   CLEAR FORM
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()


   INITIALIZE g_xcag_m.* LIKE xcag_t.*             #DEFAULT 設定
   LET g_xcagsite_t = NULL
   LET g_xcag001_t = NULL

   CALL s_transaction_begin()
   WHILE TRUE

      #單頭預設值


      #add-point:單頭預設值

      #end add-point

      CALL axci006_input("a")

      #add-point:單頭輸入後

      #end add-point

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_xcag_m.* = g_xcag_m_t.*
         CALL axci006_show()
         CALL cl_err('',9001,0)
         EXIT WHILE
      END IF

      CALL g_xcag_d.clear()
      CALL g_xcag2_d.clear()


      #add-point:單頭輸入後2

      #end add-point

      LET g_rec_b = 0
      EXIT WHILE

   END WHILE

   LET g_state = "Y"
   LET g_current_idx = 1

   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001


   LET g_wc = g_wc,
              " OR ( xcagent = '" ||g_enterprise|| "' AND ",
              " xcagsite = '", g_xcag_m.xcagsite CLIPPED, "' "
              ," AND xcag001 = '", g_xcag_m.xcag001 CLIPPED, "' "

              , ") "

END FUNCTION]]>
  </point>
  <point name="function.axci006_modify" order="16" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_modify()
   #add-point:modify段define

   #end add-point

   IF g_xcag_m.xcagsite IS NULL
   OR g_xcag_m.xcag001 IS NULL

   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF

   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp,
       g_xcag_m.xcag011,g_xcag_m.xcag001

   ERROR ""

   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001

   CALL s_transaction_begin()

   OPEN axci006_cl USING g_enterprise,g_xcag_m.xcagsite
                         ,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011

   IF STATUS THEN
      CALL cl_err("OPEN axci006_cl:", STATUS, 1)
      CLOSE axci006_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #鎖住將被更改或取消的資料
   FETCH axci006_cl INTO g_xcag_m.xcagsite,g_xcag_m.xcagsite_desc,g_xcag_m.xcagcomp,g_xcag_m.xcagcomp_desc,
       g_xcag_m.xcag011,g_xcag_m.xcag011_desc,g_xcag_m.xcag001,g_xcag_m.xcag001_desc

   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_xcag_m.xcagsite,SQLCA.sqlcode,0)
      CLOSE axci006_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   CALL s_transaction_end('Y','0')

   CALL axci006_show()
   WHILE TRUE
      LET g_xcagsite_t = g_xcag_m.xcagsite
      LET g_xcag001_t = g_xcag_m.xcag001


      #add-point:modify段修改前

      #end add-point

      CALL axci006_input("u")     #欄位更改

      #add-point:modify段修改後

      #end add-point

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_xcag_m.* = g_xcag_m_t.*
         CALL axci006_show()
         CALL cl_err('',9001,0)
         EXIT WHILE
      END IF

      #若單頭key欄位有變更
      IF g_xcag_m.xcagsite != g_xcagsite_t
      OR g_xcag_m.xcag001 != g_xcag001_t

      THEN
         CALL s_transaction_begin()

         #add-point:單頭(偽)修改前

         #end add-point

         #更新單頭key值
         UPDATE xcag_t SET xcagsite = g_xcag_m.xcagsite
                                       , xcag001 = g_xcag_m.xcag001

          WHERE xcagent = g_enterprise AND xcagsite = g_xcagsite_t
            AND xcag001 = g_xcag001_t

         #add-point:單頭(偽)修改中

         #end add-point

         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
               CALL cl_err("xcag_t","std-00009",1)
               CALL s_transaction_end('N','0')
               CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               CALL cl_err("xcag_t",SQLCA.sqlcode,1)
               CALL s_transaction_end('N','0')
               CONTINUE WHILE
         END CASE



         #add-point:單頭(偽)修改後

         #end add-point

      END IF

      EXIT WHILE

   END WHILE

   #修改歷程記錄
   IF NOT cl_log_modified_record(g_xcag_m.xcagsite,g_site) THEN
      CALL s_transaction_end('N','0')
   END IF

   CLOSE axci006_cl
   CALL s_transaction_end('Y','0')

   #流程通知預埋點-U
   CALL cl_flow_notify(g_xcag_m.xcagsite,'U')

   CALL axci006_b_fill("1=1")

END FUNCTION]]>
  </point>
  <point name="function.axci006_input" order="17" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_input(p_cmd)
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_ac_t                LIKE type_t.num5                #未取消的ARRAY CNT
   DEFINE  l_n                   LIKE type_t.num5                #檢查重複用
   DEFINE  l_cnt                 LIKE type_t.num5                #檢查重複用
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否
   DEFINE  l_count               LIKE type_t.num5
   DEFINE  l_i                   LIKE type_t.num5
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num5
   DEFINE  li_reproduce_target   LIKE type_t.num5
   #add-point:input段define
   DEFINE  l_flag                LIKE type_t.chr1
   DEFINE  li                    LIKE type_t.num5
   #end add-point

   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF

   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF

   CALL cl_set_head_visible("","YES")

   LET l_insert = FALSE
   LET g_action_choice = ""

   #add-point:input段define_sql

   #end add-point
   LET g_forupd_sql = "SELECT '',xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d,
       xcag102e,xcag102f,xcag102g,xcag102h,'','',xcagownid,'',xcagowndp,'',xcagcrtid,'',xcagcrtdp,'',
       xcagcrtdt,xcagmodid,'',xcagmoddt FROM xcag_t WHERE xcagent=? AND xcagsite=? AND xcag001=? AND
       xcagcomp=? AND xcag011=? AND xcag002=? AND xcag004=? FOR UPDATE"
   #add-point:input段define_sql

   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   DECLARE axci006_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR



   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'

   #控制key欄位可否輸入
   CALL axci006_set_entry(p_cmd)
   #add-point:set_entry後

   #end add-point
   CALL axci006_set_no_entry(p_cmd)
   #add-point:set_no_entry後

   #end add-point

   DISPLAY BY NAME g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001

   LET lb_reproduce = FALSE

   #add-point:進入修改段前

   #end add-point

   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

{</section>}

{<section id="axci006.input.head" >}

      #單頭段
      INPUT BY NAME g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001
         ATTRIBUTE(WITHOUT DEFAULTS)

         #自訂單頭ACTION


         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF

            IF l_cmd_t = 'r' THEN

            END IF
            #add-point:單頭input前

            #end add-point

         #---------------------------<  Master  >---------------------------
         #----<<xcagsite>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcagsite

            #add-point:AFTER FIELD xcagsite
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagsite
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagsite_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagsite_desc

            #此段落由子樣板a05產生
            IF  NOT cl_null(g_xcag_m.xcagsite) AND NOT cl_null(g_xcag_m.xcag001) THEN
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t  OR g_xcag_m.xcag001 != g_xcag001_t )) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD xcagsite
            #add-point:BEFORE FIELD xcagsite

            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE xcagsite
            #add-point:ON CHANGE xcagsite

            #END add-point

         #----<<xcagsite_desc>>----
         #----<<xcagcomp>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcagcomp

            #add-point:AFTER FIELD xcagcomp
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagcomp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagcomp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagcomp_desc


            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD xcagcomp
            #add-point:BEFORE FIELD xcagcomp

            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE xcagcomp
            #add-point:ON CHANGE xcagcomp

            #END add-point

         #----<<xcagcomp_desc>>----
         #----<<xcag011>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcag011

            #add-point:AFTER FIELD xcag011
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcag011
            CALL ap_ref_array2(g_ref_fields,"SELECT ooail003 FROM ooail_t WHERE ooailent='"||g_enterprise||"' AND ooail001=? AND ooail002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcag011_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcag011_desc


            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD xcag011
            #add-point:BEFORE FIELD xcag011

            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE xcag011
            #add-point:ON CHANGE xcag011

            #END add-point

         #----<<xcag011_desc>>----
         #----<<xcag001>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcag001

            #add-point:AFTER FIELD xcag001
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_xcag_m.xcagsite) AND NOT cl_null(g_xcag_m.xcag001) THEN
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t  OR g_xcag_m.xcag001 != g_xcag001_t )) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF



            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD xcag001
            #add-point:BEFORE FIELD xcag001

            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE xcag001
            #add-point:ON CHANGE xcag001

            #END add-point

         #----<<xcag001_desc>>----
 #欄位檢查
         #---------------------------<  Master  >---------------------------
         #----<<xcagsite>>----
         #Ctrlp:input.c.xcagsite
#         ON ACTION controlp INFIELD xcagsite
            #add-point:ON ACTION controlp INFIELD xcagsite

            #END add-point

         #----<<xcagsite_desc>>----
         #----<<xcagcomp>>----
         #Ctrlp:input.c.xcagcomp
#         ON ACTION controlp INFIELD xcagcomp
            #add-point:ON ACTION controlp INFIELD xcagcomp

            #END add-point

         #----<<xcagcomp_desc>>----
         #----<<xcag011>>----
         #Ctrlp:input.c.xcag011
#         ON ACTION controlp INFIELD xcag011
            #add-point:ON ACTION controlp INFIELD xcag011

            #END add-point

         #----<<xcag011_desc>>----
         #----<<xcag001>>----
         #Ctrlp:input.c.xcag001
#         ON ACTION controlp INFIELD xcag001
            #add-point:ON ACTION controlp INFIELD xcag001

            #END add-point

         #----<<xcag001_desc>>----
 #欄位開窗

         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF

            IF s_transaction_chk("N",0) THEN
                CALL s_transaction_begin()
            END IF

            #多語言處理


            CALL cl_showmsg()
            DISPLAY BY NAME g_xcag_m.xcagsite
                            ,g_xcag_m.xcag001


            IF p_cmd = 'u' THEN
               #add-point:單頭修改前

               #end add-point

               UPDATE xcag_t SET (xcagsite,xcagcomp,xcag011,xcag001) = (g_xcag_m.xcagsite,g_xcag_m.xcagcomp,
                   g_xcag_m.xcag011,g_xcag_m.xcag001)
                WHERE xcagent = g_enterprise AND xcagsite = g_xcagsite_t
                  AND xcag001 = g_xcag001_t

               #add-point:單頭修改中

               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     CALL cl_err("xcag_t","std-00009",1)
                     CALL s_transaction_end('N','0')
                  WHEN SQLCA.sqlcode #其他錯誤
                     CALL cl_err("xcag_t",SQLCA.sqlcode,1)
                     CALL s_transaction_end('N','0')
                  OTHERWISE
                     #資料多語言用-增/改
                                    INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_xcag_m.xcagsite
               LET gs_keys_bak[1] = g_xcagsite_t
               LET gs_keys[2] = g_xcag_m.xcag001
               LET gs_keys_bak[2] = g_xcag001_t
               LET gs_keys[3] = g_xcag_d[g_detail_idx].xcag002
               LET gs_keys_bak[3] = g_xcag_d_t.xcag002
               LET gs_keys[4] = g_xcag_d[g_detail_idx].xcag004
               LET gs_keys_bak[4] = g_xcag_d_t.xcag004
               CALL axci006_update_b('xcag_t',gs_keys,gs_keys_bak,"'1'")

                     LET g_xcagsite_t = g_xcag_m.xcagsite
                     LET g_xcag001_t = g_xcag_m.xcag001

                     #add-point:單頭修改後

                     #end add-point
                     CALL s_transaction_end('Y','0')
               END CASE

            ELSE
               #add-point:單頭新增

               #end add-point

               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL axci006_detail_reproduce()
               END IF
            END IF
           #controlp

           LET g_xcagsite_t = g_xcag_m.xcagsite
           LET g_xcag001_t = g_xcag_m.xcag001


           #若單身還沒有輸入資料, 強制切換至單身
           IF cl_null(g_xcag_d[1].xcag002) THEN
              CALL g_xcag_d.deleteElement(1)
              NEXT FIELD xcag002
           END IF

      END INPUT

{</section>}

{<section id="axci006.input.body" >}
      #Page1 預設值產生於此處
      INPUT ARRAY g_xcag_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                  INSERT ROW = FALSE,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)

         #自訂單身ACTION


         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN
              CALL FGL_SET_ARR_CURR(g_xcag_d.getLength()+1)
              LET g_insert = 'N'
           END IF

            CALL axci006_b_fill(g_wc2)
            IF g_rec_b != 0 THEN
               CALL fgl_set_arr_curr(l_ac)
            END IF
            #add-point:資料輸入前
            CALL cl_set_comp_visible('check',TRUE)
            #end add-point

         BEFORE ROW
            LET l_insert = FALSE
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
            LET l_ac = ARR_CURR()
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx


            CALL s_transaction_begin()

            #判定新增或修改
            IF l_cmd = 'u' THEN
               OPEN axci006_cl USING g_enterprise,
                                               g_xcag_m.xcagsite
                                               ,g_xcag_m.xcag001
                                               ,g_xcag_m.xcagcomp,g_xcag_m.xcag011


               IF STATUS THEN
                  CALL cl_err("OPEN axci006_cl:", STATUS, 1)
                  CLOSE axci006_cl
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
            END IF

            LET l_cmd = ''

            IF g_rec_b >= l_ac
               AND g_xcag_d[l_ac].xcag002 IS NOT NULL
               AND g_xcag_d[l_ac].xcag004 IS NOT NULL

            THEN
               LET l_cmd='u'
               LET g_xcag_d_t.* = g_xcag_d[l_ac].*  #BACKUP
               CALL axci006_set_entry_b(l_cmd)
               #add-point:set_entry_b後

               #end add-point
               CALL axci006_set_no_entry_b(l_cmd)
               OPEN axci006_bcl USING g_enterprise,g_xcag_m.xcagsite,
                                                g_xcag_m.xcag001,
                                                g_xcag_m.xcagcomp,
                                                g_xcag_m.xcag011,

                                                g_xcag_d_t.xcag002
                                                ,g_xcag_d_t.xcag004

               IF STATUS THEN
                  CALL cl_err("OPEN axci006_bcl:", STATUS, 1)
                  LET l_lock_sw='Y'
               ELSE
                  FETCH axci006_bcl INTO g_xcag_d[l_ac].check,g_xcag_d[l_ac].xcag004,g_xcag_d[l_ac].xcag002,
                      g_xcag_d[l_ac].xcag003,g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b,
                      g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e,g_xcag_d[l_ac].xcag102f,
                      g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h,g_xcag2_d[l_ac].xcag004,g_xcag2_d[l_ac].xcag002,
                      g_xcag2_d[l_ac].xcagownid,g_xcag2_d[l_ac].xcagownid_desc,g_xcag2_d[l_ac].xcagowndp,
                      g_xcag2_d[l_ac].xcagowndp_desc,g_xcag2_d[l_ac].xcagcrtid,g_xcag2_d[l_ac].xcagcrtid_desc,
                      g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdp_desc,g_xcag2_d[l_ac].xcagcrtdt,
                      g_xcag2_d[l_ac].xcagmodid,g_xcag2_d[l_ac].xcagmodid_desc,g_xcag2_d[l_ac].xcagmoddt

                  IF SQLCA.sqlcode THEN
                      CALL cl_err(g_xcag_d_t.xcag002,SQLCA.sqlcode,1)
                      LET l_lock_sw = "Y"
                  END IF

                  CALL axci006_ref_show()
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row
            LET g_xcag_d[l_ac].check = 'N'
            CALL axci006_xcah_b_fill()
            CALL axci006_xcai_b_fill()
            CALL axci006_xcaj_b_fill()
            #end add-point


         BEFORE INSERT

            INITIALIZE g_xcag_d_t.* TO NULL
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_xcag_d[l_ac].* TO NULL

            #公用欄位預設值
            #此段落由子樣板a14產生
      LET g_xcag2_d[l_ac].xcagownid = g_user
      LET g_xcag2_d[l_ac].xcagowndp = g_dept
      LET g_xcag2_d[l_ac].xcagcrtid = g_user
      LET g_xcag2_d[l_ac].xcagcrtdp = g_dept
      LET g_xcag2_d[l_ac].xcagcrtdt = cl_get_current()
      LET g_xcag2_d[l_ac].xcagmodid = ""
      LET g_xcag2_d[l_ac].xcagmoddt = ""
      #LET .xcagstus = ""



            #一般欄位預設值
                  LET g_xcag_d[l_ac].check = "N"




            LET g_xcag_d_t.* = g_xcag_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL axci006_set_entry_b(l_cmd)
            #add-point:set_entry_b後

            #end add-point
            CALL axci006_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_xcag_d[li_reproduce_target].* = g_xcag_d[li_reproduce].*
               LET g_xcag2_d[li_reproduce_target].* = g_xcag2_d[li_reproduce].*

               LET g_xcag_d[g_xcag_d.getLength()].xcag002 = NULL
               LET g_xcag_d[g_xcag_d.getLength()].xcag004 = NULL

            END IF

            #add-point:modify段before insert

            #end add-point

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            LET l_count = 1
            SELECT COUNT(*) INTO l_count FROM xcag_t
             WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite
               AND xcag001 = g_xcag_m.xcag001

               AND xcag002 = g_xcag_d[l_ac].xcag002
               AND xcag004 = g_xcag_d[l_ac].xcag004


            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               CALL s_transaction_begin()
               #add-point:單身新增前

               #end add-point
               INSERT INTO xcag_t
                           (xcagent,
                            xcagsite,xcagcomp,xcag011,xcag001,
                            xcag002,xcag004
                            ,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d,xcag102e,xcag102f,xcag102g,xcag102h,xcagownid,xcagowndp,xcagcrtid,xcagcrtdp,xcagcrtdt,xcagmodid,xcagmoddt)
                     VALUES(g_enterprise,
                            g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001,
                            g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag004
                            ,g_xcag_d[l_ac].xcag003,g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b,
                                g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e,
                                g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h,
                                g_xcag2_d[l_ac].xcagownid,g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagcrtid,
                                g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdt,g_xcag2_d[l_ac].xcagmodid,
                                g_xcag2_d[l_ac].xcagmoddt)
               #add-point:單身新增中

               #end add-point
               LET p_cmd = 'u'
            ELSE
               CALL cl_err('INSERT',"std-00006",1)
               INITIALIZE g_xcag_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

            IF SQLCA.SQLcode  THEN
               CALL cl_err("xcag_t",SQLCA.sqlcode,1)
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            ELSE
               #資料多語言用-增/改

               #add-point:input段-after_insert

               #end add-point
               CALL s_transaction_end('Y','0')
               ERROR "INSERT O.K"
               LET g_rec_b=g_rec_b+1
               DISPLAY g_rec_b TO FORMONLY.cnt
            END IF

            #add-point:單身新增後

            #end add-point

         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' AND g_xcag_d.getLength() < l_ac THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_xcag_d.deleteElement(l_ac)
               NEXT FIELD xcag002
            END IF
            IF g_xcag_d_t.xcag002 IS NOT NULL
               AND g_xcag_d_t.xcag004 IS NOT NULL

               THEN

               #add-point:單身刪除前
               LET l_flag = 'Y'
               IF l_flag = 'N' THEN
               #end add-point

               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  CALL cl_err("", -263, 1)
                  CANCEL DELETE
               END IF
               IF axci006_before_delete() THEN
                  CALL s_transaction_end('Y','0')
               ELSE
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               END IF
               CLOSE axci006_bcl
               LET l_count = g_xcag_d.getLength()
            END IF

            #add-point:單身刪除後
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               FOR li = 1 TO g_xcag_d.getLength()
                  IF g_xcag_d[l_ac].check <> 'Y' THEN
                     CONTINUE FOR
                  END IF
                  #end add-point


                  IF l_lock_sw = "Y" THEN
                     CALL cl_err("", -263, 1)
                     CANCEL DELETE
                  END IF
                  IF axci006_before_delete() THEN
                     CALL s_transaction_end('Y','0')
                  ELSE
                     CALL s_transaction_end('N','0')
                     CANCEL DELETE
                  END IF
                  CLOSE axci006_bcl
               END FOR
               LET l_count = g_xcag_d.getLength()
            END IF
            #end add-point

         AFTER DELETE
            #add-point:單身AFTER DELETE

            #end add-point

         #---------------------<  Detail: page1  >---------------------
         #----<<check>>----
         #此段落由子樣板a01產生
         BEFORE FIELD check
            #add-point:BEFORE FIELD check

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD check

            #add-point:AFTER FIELD check

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE check
            #add-point:ON CHANGE check

            #END add-point

         #----<<xcag004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag004
            #add-point:BEFORE FIELD xcag004

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag004

            #add-point:AFTER FIELD xcag004
            #此段落由子樣板a05產生
            IF  g_xcag_m.xcagsite IS NOT NULL AND g_xcag_m.xcag001 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag002 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag004 IS NOT NULL THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t OR g_xcag_m.xcag001 != g_xcag001_t OR g_xcag_d[g_detail_idx].xcag002 != g_xcag_d_t.xcag002 OR g_xcag_d[g_detail_idx].xcag004 != g_xcag_d_t.xcag004)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"' AND "|| "xcag002 = '"||g_xcag_d[g_detail_idx].xcag002 ||"' AND "|| "xcag004 = '"||g_xcag_d[g_detail_idx].xcag004 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag004
            #add-point:ON CHANGE xcag004

            #END add-point

         #----<<xcag002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag002
            #add-point:BEFORE FIELD xcag002

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag002

            #add-point:AFTER FIELD xcag002
            #此段落由子樣板a05產生
            IF  g_xcag_m.xcagsite IS NOT NULL AND g_xcag_m.xcag001 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag002 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag004 IS NOT NULL THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t OR g_xcag_m.xcag001 != g_xcag001_t OR g_xcag_d[g_detail_idx].xcag002 != g_xcag_d_t.xcag002 OR g_xcag_d[g_detail_idx].xcag004 != g_xcag_d_t.xcag004)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"' AND "|| "xcag002 = '"||g_xcag_d[g_detail_idx].xcag002 ||"' AND "|| "xcag004 = '"||g_xcag_d[g_detail_idx].xcag004 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag002
            #add-point:ON CHANGE xcag002

            #END add-point

         #----<<xcag003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag003
            #add-point:BEFORE FIELD xcag003

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag003

            #add-point:AFTER FIELD xcag003

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag003
            #add-point:ON CHANGE xcag003

            #END add-point

         #----<<xcag102>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102
            #add-point:BEFORE FIELD xcag102

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102

            #add-point:AFTER FIELD xcag102

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102
            #add-point:ON CHANGE xcag102

            #END add-point

         #----<<xcag102a>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102a
            #add-point:BEFORE FIELD xcag102a

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102a

            #add-point:AFTER FIELD xcag102a

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102a
            #add-point:ON CHANGE xcag102a

            #END add-point

         #----<<xcag102b>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102b
            #add-point:BEFORE FIELD xcag102b

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102b

            #add-point:AFTER FIELD xcag102b

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102b
            #add-point:ON CHANGE xcag102b

            #END add-point

         #----<<xcag102c>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102c
            #add-point:BEFORE FIELD xcag102c

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102c

            #add-point:AFTER FIELD xcag102c

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102c
            #add-point:ON CHANGE xcag102c

            #END add-point

         #----<<xcag102d>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102d
            #add-point:BEFORE FIELD xcag102d

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102d

            #add-point:AFTER FIELD xcag102d

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102d
            #add-point:ON CHANGE xcag102d

            #END add-point

         #----<<xcag102e>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102e
            #add-point:BEFORE FIELD xcag102e

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102e

            #add-point:AFTER FIELD xcag102e

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102e
            #add-point:ON CHANGE xcag102e

            #END add-point

         #----<<xcag102f>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102f
            #add-point:BEFORE FIELD xcag102f

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102f

            #add-point:AFTER FIELD xcag102f

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102f
            #add-point:ON CHANGE xcag102f

            #END add-point

         #----<<xcag102g>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102g
            #add-point:BEFORE FIELD xcag102g

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102g

            #add-point:AFTER FIELD xcag102g

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102g
            #add-point:ON CHANGE xcag102g

            #END add-point

         #----<<xcag102h>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102h
            #add-point:BEFORE FIELD xcag102h

            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD xcag102h

            #add-point:AFTER FIELD xcag102h

            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE xcag102h
            #add-point:ON CHANGE xcag102h

            #END add-point


         #---------------------<  Detail: page1  >---------------------
         #----<<check>>----
         #Ctrlp:input.c.page1.check
#         ON ACTION controlp INFIELD check
            #add-point:ON ACTION controlp INFIELD check

            #END add-point

         #----<<xcag004>>----
         #Ctrlp:input.c.page1.xcag004
#         ON ACTION controlp INFIELD xcag004
            #add-point:ON ACTION controlp INFIELD xcag004

            #END add-point

         #----<<xcag002>>----
         #Ctrlp:input.c.page1.xcag002
#         ON ACTION controlp INFIELD xcag002
            #add-point:ON ACTION controlp INFIELD xcag002

            #END add-point

         #----<<xcag003>>----
         #Ctrlp:input.c.page1.xcag003
#         ON ACTION controlp INFIELD xcag003
            #add-point:ON ACTION controlp INFIELD xcag003

            #END add-point

         #----<<xcag102>>----
         #Ctrlp:input.c.page1.xcag102
#         ON ACTION controlp INFIELD xcag102
            #add-point:ON ACTION controlp INFIELD xcag102

            #END add-point

         #----<<xcag102a>>----
         #Ctrlp:input.c.page1.xcag102a
#         ON ACTION controlp INFIELD xcag102a
            #add-point:ON ACTION controlp INFIELD xcag102a

            #END add-point

         #----<<xcag102b>>----
         #Ctrlp:input.c.page1.xcag102b
#         ON ACTION controlp INFIELD xcag102b
            #add-point:ON ACTION controlp INFIELD xcag102b

            #END add-point

         #----<<xcag102c>>----
         #Ctrlp:input.c.page1.xcag102c
#         ON ACTION controlp INFIELD xcag102c
            #add-point:ON ACTION controlp INFIELD xcag102c

            #END add-point

         #----<<xcag102d>>----
         #Ctrlp:input.c.page1.xcag102d
#         ON ACTION controlp INFIELD xcag102d
            #add-point:ON ACTION controlp INFIELD xcag102d

            #END add-point

         #----<<xcag102e>>----
         #Ctrlp:input.c.page1.xcag102e
#         ON ACTION controlp INFIELD xcag102e
            #add-point:ON ACTION controlp INFIELD xcag102e

            #END add-point

         #----<<xcag102f>>----
         #Ctrlp:input.c.page1.xcag102f
#         ON ACTION controlp INFIELD xcag102f
            #add-point:ON ACTION controlp INFIELD xcag102f

            #END add-point

         #----<<xcag102g>>----
         #Ctrlp:input.c.page1.xcag102g
#         ON ACTION controlp INFIELD xcag102g
            #add-point:ON ACTION controlp INFIELD xcag102g

            #END add-point

         #----<<xcag102h>>----
         #Ctrlp:input.c.page1.xcag102h
#         ON ACTION controlp INFIELD xcag102h
            #add-point:ON ACTION controlp INFIELD xcag102h

            #END add-point



         ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_xcag_d[l_ac].* = g_xcag_d_t.*
               CLOSE axci006_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_xcag_d[l_ac].xcag002,-263,1)
               LET g_xcag_d[l_ac].* = g_xcag_d_t.*
            ELSE
               #寫入修改者/修改日期資訊
               LET g_xcag2_d[l_ac].xcagmodid = g_user
LET g_xcag2_d[l_ac].xcagmoddt = cl_get_current()


               #add-point:單身修改前

               #end add-point

               UPDATE xcag_t SET (xcagsite,xcag001,xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,
                   xcag102c,xcag102d,xcag102e,xcag102f,xcag102g,xcag102h,xcagownid,xcagowndp,xcagcrtid,
                   xcagcrtdp,xcagcrtdt,xcagmodid,xcagmoddt) = (g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_d[l_ac].xcag004,
                   g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag003,g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,
                   g_xcag_d[l_ac].xcag102b,g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e,
                   g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h,g_xcag2_d[l_ac].xcagownid,
                   g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagcrtid,g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdt,
                   g_xcag2_d[l_ac].xcagmodid,g_xcag2_d[l_ac].xcagmoddt)
                WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite
                 AND xcag001 = g_xcag_m.xcag001
                 AND xcag011 = g_xcag_m.xcag011

                 AND xcag002 = g_xcag_d_t.xcag002 #項次
                 AND xcag004 = g_xcag_d_t.xcag004


               #add-point:單身修改中

               #end add-point

               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     CALL cl_err("xcag_t","std-00009",1)
                     CALL s_transaction_end('N','0')
                  #WHEN SQLCA.sqlcode #其他錯誤
                  #   CALL cl_err("xcag_t",SQLCA.sqlcode,1)
                  #   CALL s_transaction_end('N','0')
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_xcag_m.xcagsite
               LET gs_keys_bak[1] = g_xcagsite_t
               LET gs_keys[2] = g_xcag_m.xcag001
               LET gs_keys_bak[2] = g_xcag001_t
               LET gs_keys[3] = g_xcag_d[g_detail_idx].xcag002
               LET gs_keys_bak[3] = g_xcag_d_t.xcag002
               LET gs_keys[4] = g_xcag_d[g_detail_idx].xcag004
               LET gs_keys_bak[4] = g_xcag_d_t.xcag004
               CALL axci006_update_b('xcag_t',gs_keys,gs_keys_bak,"'1'")
                     #資料多語言用-增/改

               END CASE

               #add-point:單身修改後

               #end add-point
            END IF

         AFTER INPUT
            #若單身還沒有輸入資料, 強制切換至單身
            IF cl_null(g_xcag_d[1].xcag002) THEN
               CALL g_xcag_d.deleteElement(1)
               NEXT FIELD xcag002
            END IF
            #add-point:input段after input

            #end add-point

         ON ACTION controlo
            CALL FGL_SET_ARR_CURR(g_xcag_d.getLength()+1)
            LET lb_reproduce = TRUE
            LET li_reproduce = l_ac
            LET li_reproduce_target = g_xcag_d.getLength()+1

      END INPUT



      DISPLAY ARRAY g_xcag2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)

         BEFORE ROW
            CALL axci006_b_fill(g_wc2)
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
            LET l_ac = g_detail_idx
            DISPLAY g_detail_idx TO FORMONLY.idx
            CALL axci006_ui_detailshow()

         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx)

         #add-point:page2自定義行為

         #end add-point

      END DISPLAY




      #add-point:input段more_input
      DISPLAY ARRAY g_xcah_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b2)

         BEFORE ROW
            CALL axci006_xcah_b_fill()
            LET g_detail_idx2 = DIALOG.getCurrentRow("s_detail3")
            LET l_ac2 = g_detail_idx2
            CALL axci006_ui_detailshow()

         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx2)

      END DISPLAY

      DISPLAY ARRAY g_xcai_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b3)

         BEFORE ROW
            CALL axci006_xcai_b_fill()
            LET g_detail_idx3 = DIALOG.getCurrentRow("s_detail4")
            LET l_ac3 = g_detail_idx3
            CALL axci006_ui_detailshow()

         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx3)

      END DISPLAY

      DISPLAY ARRAY g_xcaj_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b4)

         BEFORE ROW
            CALL axci006_xcaj_b_fill()
            LET g_detail_idx4 = DIALOG.getCurrentRow("s_detail5")
            LET l_ac4 = g_detail_idx4
            CALL axci006_ui_detailshow()

         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx4)

      END DISPLAY
      #end add-point

      BEFORE DIALOG
         #add-point:input段before_dialog

         #end add-point
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            NEXT FIELD xcagsite
        ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD check
               WHEN "s_detail2"
                  NEXT FIELD xcag004_2

            END CASE
         END IF

      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)

      ON ACTION controlr
         CALL cl_show_req_fields()

      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden
         END IF

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel      #在dialog button (放棄)
         LET g_action_choice=""
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG

   #add-point:input段after_input
   CALL cl_set_comp_visible('check',FALSE)
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_show" order="18" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_show()
   #add-point:show段define

   #end add-point

   #add-point:show段之前
   CALL cl_set_act_visible("modify",FALSE)
   #end add-point

   IF g_bfill = "Y" THEN
      CALL axci006_b_fill(g_wc2) #單身填充
      CALL axci006_b_fill2('0') #單身填充
   END IF



   #顯示followup圖示
   #+ 此段落由子樣板a48產生
   CALL axci006_set_pk_array()
   #add-point:ON ACTION agendum

   #END add-point
   CALL cl_user_overview_set_follow_pic()



   LET g_xcag_m_t.* = g_xcag_m.*      #保存單頭舊值

   DISPLAY BY NAME g_xcag_m.xcagsite,g_xcag_m.xcagsite_desc,g_xcag_m.xcagcomp,g_xcag_m.xcagcomp_desc,
       g_xcag_m.xcag011,g_xcag_m.xcag011_desc,g_xcag_m.xcag001,g_xcag_m.xcag001_desc
   CALL axci006_b_fill(g_wc2_table1)                 #單身
   CALL axci006_b_fill2('0') #單身填充

   CALL axci006_ref_show()

   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()

   #add-point:show段之後
   IF ARR_CURR() > g_xcag_d.getLength() THEN   #防止会有空白行
      LET l_ac = 1
   END IF
   IF l_ac < 1 OR cl_null(l_ac) THEN
      LET l_ac = 1
   END IF
   CALL axci006_xcah_b_fill()
   CALL axci006_xcai_b_fill()
   CALL axci006_xcaj_b_fill()
   CALL cl_show_fld_cont()
   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_ref_show" order="19" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_ref_show()
   DEFINE l_ac_t LIKE type_t.num10 #l_ac暫存用
   #add-point:ref_show段define

   #end add-point

   LET l_ac_t = l_ac

   #讀入ref值(單頭)
   #add-point:ref_show段m_reference

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagsite
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagsite_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagsite_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagcomp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagcomp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagcomp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcag001
            CALL ap_ref_array2(g_ref_fields,"SELECT xcaal003 FROM xcaal_t WHERE xcaalent='"||g_enterprise||"' AND xcaal001=? AND xcaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcag001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcag001_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcag011
            CALL ap_ref_array2(g_ref_fields,"SELECT ooail003 FROM ooail_t WHERE ooailent='"||g_enterprise||"' AND ooail001=? AND ooail002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcag011_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcag011_desc

   #end add-point

   #讀入ref值(單身)
   FOR l_ac = 1 TO g_xcag_d.getLength()
      #add-point:ref_show段d_reference

      #end add-point
   END FOR

   FOR l_ac = 1 TO g_xcag2_d.getLength()
      #add-point:ref_show段d2_reference

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagownid
            CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagownid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagownid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagowndp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagowndp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagowndp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagcrtid
            CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagcrtid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagcrtid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagcrtdp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagcrtdp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagcrtdp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagmodid
            CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagmodid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagmodid_desc

      #end add-point
   END FOR


   #add-point:ref_show段自訂

   #end add-point

   LET l_ac = l_ac_t

END FUNCTION]]>
  </point>
  <point name="function.axci006_reproduce" order="20" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_reproduce()
   DEFINE l_newno     LIKE xcag_t.xcagsite
   DEFINE l_oldno     LIKE xcag_t.xcagsite
   DEFINE l_newno02     LIKE xcag_t.xcag001
   DEFINE l_oldno02     LIKE xcag_t.xcag001

   DEFINE l_master    RECORD LIKE xcag_t.*
   DEFINE l_detail    RECORD LIKE xcag_t.*

   DEFINE l_cnt       LIKE type_t.num5
   #add-point:reproduce段define

   #end add-point

   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF

   IF g_xcag_m.xcagsite IS NULL
      OR g_xcag_m.xcag001 IS NULL

      THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF

   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001


   LET g_xcag_m.xcagsite = ""
   LET g_xcag_m.xcag001 = ""


   CALL axci006_set_entry('a')
   CALL axci006_set_no_entry('a')

   CALL cl_set_head_visible("","YES")

   #add-point:複製輸入前

   #end add-point

   CALL axci006_input("r")

      LET g_xcag_m.xcagsite_desc = ''
   DISPLAY BY NAME g_xcag_m.xcagsite_desc
   LET g_xcag_m.xcag001_desc = ''
   DISPLAY BY NAME g_xcag_m.xcag001_desc


   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   LET g_state = "Y"
   LET g_current_idx = 1

   LET g_wc = g_wc,
              " OR (",
              " xcagsite = '", l_newno CLIPPED, "' "
              ," AND xcag001 = '", l_newno02 CLIPPED, "' "

              , ") "

   #add-point:完成複製段落後

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_detail_reproduce" order="21" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_detail_reproduce()
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE xcag_t.*


   #add-point:delete段define

   #end add-point

   CALL s_transaction_begin()

   LET ld_date = cl_get_current()

   DROP TABLE axci006_detail

   #add-point:單身複製前1

   #end add-point

   #CREATE TEMP TABLE
   LET ls_sql = "CREATE GLOBAL TEMPORARY TABLE axci006_detail AS ",
                "SELECT * FROM xcag_t "
   PREPARE repro_tbl FROM ls_sql
   EXECUTE repro_tbl
   FREE repro_tbl

   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO axci006_detail SELECT * FROM xcag_t
                                         WHERE xcagent = g_enterprise AND xcagsite = g_xcagsite_t
                                         AND xcag001 = g_xcag001_t


   #將key修正為調整後
   UPDATE axci006_detail
      #更新key欄位
      SET xcagsite = g_xcag_m.xcagsite
          , xcag001 = g_xcag_m.xcag001

      #更新共用欄位
      #此段落由子樣板a13產生
       , xcagownid = g_user
       , xcagowndp = g_dept
       , xcagcrtid = g_user
       , xcagcrtdp = g_dept
       , xcagcrtdt = ld_date
       , xcagmodid = ""
       , xcagmoddt = ""
      ##, xcagstus = "Y"




   #將資料塞回原table
   INSERT INTO xcag_t SELECT * FROM axci006_detail

   IF SQLCA.sqlcode THEN
      CALL cl_err("reproduce",SQLCA.sqlcode,1)
      RETURN
   END IF

   #add-point:單身複製中1

   #end add-point

   #刪除TEMP TABLE
   DROP TABLE axci006_detail

   #add-point:單身複製後1

   #end add-point





   #多語言複製段落


   CALL s_transaction_end('Y','0')

   #已新增完, 調整資料內容(修改時使用)
   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001


   DROP TABLE axci006_detail

END FUNCTION]]>
  </point>
  <point name="function.axci006_delete" order="22" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_delete()
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define

   #end add-point

   IF g_xcag_m.xcagsite IS NULL
   OR g_xcag_m.xcag001 IS NULL

   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF

   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp,
       g_xcag_m.xcag011,g_xcag_m.xcag001

   CALL axci006_show()

   CALL s_transaction_begin()



   OPEN axci006_cl USING g_enterprise,g_xcag_m.xcagsite
                         ,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011

   IF STATUS THEN
      CALL cl_err("OPEN axci006_cl:", STATUS, 1)
      CLOSE axci006_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #鎖住將被更改或取消的資料
   FETCH axci006_cl INTO g_xcag_m.xcagsite,g_xcag_m.xcagsite_desc,g_xcag_m.xcagcomp,g_xcag_m.xcagcomp_desc,
       g_xcag_m.xcag011,g_xcag_m.xcag011_desc,g_xcag_m.xcag001,g_xcag_m.xcag001_desc

   #若資料已被他人LOCK
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_xcag_m.xcagsite,SQLCA.sqlcode,0)
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #IF NOT cl_ask_delete() THEN             #確認一下
   IF cl_ask_del_master() THEN              #確認一下
      #+ 此段落由子樣板a47產生
      #刪除相關文件
      CALL axci006_set_pk_array()
      #add-point:相關文件刪除前

      #end add-point
      CALL cl_doc_remove()



      #add-point:單身刪除前

      #end add-point

      DELETE FROM xcag_t WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite
                                                               AND xcag001 = g_xcag_m.xcag001


      #add-point:單身刪除中
      DELETE FROM xcah_t WHERE xcahent = g_enterprise AND xcahsite = g_xcag_m.xcagsite
                                                               AND xcah001 = g_xcag_m.xcag001

      DELETE FROM xcai_t WHERE xcaient = g_enterprise AND xcaisite = g_xcag_m.xcagsite
                                                               AND xcai001 = g_xcag_m.xcag001

      DELETE FROM xcaj_t WHERE xcajent = g_enterprise AND xcajsite = g_xcag_m.xcagsite
                                                               AND xcaj001 = g_xcag_m.xcag001
      #end add-point

      IF SQLCA.sqlcode THEN
         CALL cl_err("xcag_t",SQLCA.sqlcode,0)
         CALL s_transaction_end('N','0')
      END IF



      #add-point:單身刪除後

      #end add-point



      CLEAR FORM
      CALL g_xcag_d.clear()
      CALL g_xcag2_d.clear()


      CALL axci006_ui_browser_refresh()
      CALL axci006_ui_headershow()
      CALL axci006_ui_detailshow()

      IF g_browser_cnt > 0 THEN
         CALL axci006_fetch('P')
      ELSE
         LET g_wc = " 1=1"
         LET g_wc2 = " 1=1"
         CALL axci006_browser_fill("F")
      END IF

   END IF

   CLOSE axci006_cl
   CALL s_transaction_end('Y','0')

   #流程通知預埋點-D
   CALL cl_flow_notify(g_xcag_m.xcagsite,'D')

END FUNCTION]]>
  </point>
  <point name="function.axci006_b_fill" order="23" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_b_fill(p_wc2)
   DEFINE p_wc2      STRING
   #add-point:b_fill段define

   #end add-point

   #先清空單身變數內容
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()


   #add-point:b_fill段sql_before

   #end add-point

      LET g_sql = "SELECT  UNIQUE '',xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d,
          xcag102e,xcag102f,xcag102g,xcag102h,xcag004,xcag002,xcagownid,'',xcagowndp,'',xcagcrtid,'',
          xcagcrtdp,'',xcagcrtdt,xcagmodid,'',xcagmoddt FROM xcag_t",
                  "",

                  " WHERE xcagent= ? AND xcagsite=? AND xcag001=? AND xcagcomp =? AND xcag011=?"

   IF NOT cl_null(g_wc2_table1) THEN
      LET g_sql = g_sql CLIPPED," AND ",g_wc2_table1 CLIPPED
   END IF

   #add-point:b_fill段sql_after

   #end add-point

   #子單身的WC


   #判斷是否填充
   IF axci006_fill_chk(1) THEN
      LET g_sql = g_sql, " ORDER BY xcag_t.xcag002,xcag_t.xcag004"

      #add-point:b_fill段fill_before

      #end add-point

      PREPARE axci006_pb FROM g_sql
      DECLARE b_fill_cs CURSOR FOR axci006_pb

      LET g_cnt = l_ac
      LET l_ac = 1

      OPEN b_fill_cs USING g_enterprise,g_xcag_m.xcagsite
                                               ,g_xcag_m.xcag001,g_xcag_m.xcagcomp,g_xcag_m.xcag011


      FOREACH b_fill_cs INTO g_xcag_d[l_ac].check,g_xcag_d[l_ac].xcag004,g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag003,
          g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b,g_xcag_d[l_ac].xcag102c,
          g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e,g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g,
          g_xcag_d[l_ac].xcag102h,g_xcag2_d[l_ac].xcag004,g_xcag2_d[l_ac].xcag002,g_xcag2_d[l_ac].xcagownid,
          g_xcag2_d[l_ac].xcagownid_desc,g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagowndp_desc,g_xcag2_d[l_ac].xcagcrtid,
          g_xcag2_d[l_ac].xcagcrtid_desc,g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdp_desc,g_xcag2_d[l_ac].xcagcrtdt,
          g_xcag2_d[l_ac].xcagmodid,g_xcag2_d[l_ac].xcagmodid_desc,g_xcag2_d[l_ac].xcagmoddt

         IF SQLCA.sqlcode THEN
            CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF

         #add-point:b_fill段資料填充
         LET g_xcag_d[l_ac].check = 'N'
         #end add-point

         #帶出公用欄位reference值


         #此段落由子樣板a12產生
      #LET g_xcag2_d[l_ac].xcagownid_desc = cl_get_username(g_xcag2_d[l_ac].xcagownid)
      #LET g_xcag2_d[l_ac].xcagowndp_desc = cl_get_deptname(g_xcag2_d[l_ac].xcagowndp)
      #LET g_xcag2_d[l_ac].xcagcrtid_desc = cl_get_username(g_xcag2_d[l_ac].xcagcrtid)
      #LET g_xcag2_d[l_ac].xcagcrtdp_desc = cl_get_deptname(g_xcag2_d[l_ac].xcagcrtdp)
      #LET g_xcag2_d[l_ac].xcagmodid_desc = cl_get_username(g_xcag2_d[l_ac].xcagmodid)
      ##LET .xcagcnfid_desc = cl_get_deptname(.xcagcnfid)
      ##LET .xcagpstid_desc = cl_get_deptname(.xcagpstid)





         #add-point:單身資料抓取

         #end add-point

         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            EXIT FOREACH
         END IF

      END FOREACH

            CALL g_xcag_d.deleteElement(g_xcag_d.getLength())
      CALL g_xcag2_d.deleteElement(g_xcag2_d.getLength())

   END IF

   #add-point:b_fill段more

   #end add-point

   LET g_rec_b=l_ac-1
   DISPLAY g_rec_b TO FORMONLY.cnt
   LET l_ac = g_cnt
   LET g_cnt = 0

   FREE axci006_pb

END FUNCTION]]>
  </point>
  <point name="function.axci006_b_fill2" order="24" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_b_fill2(pi_idx)
   DEFINE pi_idx          LIKE type_t.num5
   DEFINE li_ac           LIKE type_t.num5
   #add-point:b_fill2段define

   #end add-point

   LET li_ac = l_ac



   #add-point:單身填充後

   #end add-point

   LET l_ac = li_ac

END FUNCTION]]>
  </point>
  <point name="function.axci006_before_delete" order="25" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_before_delete()
   #add-point:before_delete段define

   #end add-point

   #add-point:單筆刪除前

   #end add-point

   DELETE FROM xcag_t
    WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite AND
                              xcag001 = g_xcag_m.xcag001 AND

          xcag002 = g_xcag_d_t.xcag002
      AND xcag004 = g_xcag_d_t.xcag004


   #add-point:單筆刪除中
   DELETE FROM xcah_t
    WHERE xcahent = g_enterprise AND xcahsite = g_xcag_m.xcagsite AND
                              xcah001 = g_xcag_m.xcag001 AND


          xcah002 = g_xcag_d_t.xcag002
      AND xcah004 = g_xcag_d_t.xcag004

   DELETE FROM xcai_t
    WHERE xcaient = g_enterprise AND xcaisite = g_xcag_m.xcagsite AND
                              xcai001 = g_xcag_m.xcag001 AND


          xcai002 = g_xcag_d_t.xcag002
      AND xcai004 = g_xcag_d_t.xcag004

   DELETE FROM xcaj_t
    WHERE xcajent = g_enterprise AND xcajsite = g_xcag_m.xcagsite AND
                              xcaj001 = g_xcag_m.xcag001 AND


          xcaj002 = g_xcag_d_t.xcag002
      AND xcaj004 = g_xcag_d_t.xcag004
   #end add-point

   IF SQLCA.sqlcode THEN
      CALL cl_err("xcag_t",SQLCA.sqlcode,1)
      RETURN FALSE
   END IF

   #add-point:單筆刪除後

   #end add-point

   LET g_rec_b = g_rec_b-1
   DISPLAY g_rec_b TO FORMONLY.cnt

   RETURN TRUE

END FUNCTION]]>
  </point>
  <point name="function.axci006_delete_b" order="26" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_delete_b(ps_table,ps_keys_bak,ps_page)
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   #add-point:delete_b段define

   #end add-point



END FUNCTION]]>
  </point>
  <point name="function.axci006_insert_b" order="27" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_insert_b(ps_table,ps_keys,ps_page)
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   #add-point:insert_b段define

   #end add-point



END FUNCTION]]>
  </point>
  <point name="function.axci006_update_b" order="28" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num5
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define

   #end add-point

   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR

   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF





END FUNCTION]]>
  </point>
  <point name="function.axci006_lock_b" order="29" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_lock_b(ps_table,ps_page)
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define

   #end add-point

   #先刷新資料
   #CALL axci006_b_fill()



   RETURN TRUE

END FUNCTION]]>
  </point>
  <point name="function.axci006_unlock_b" order="30" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_unlock_b(ps_table,ps_page)
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define

   #end add-point



END FUNCTION]]>
  </point>
  <point name="function.axci006_set_entry" order="31" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_set_entry(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_entry段define

   #end add-point

   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("xcagsite,xcag001",TRUE)
      #add-point:set_entry段欄位控制

      #end add-point
   END IF

   #add-point:set_entry段欄位控制後

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_set_no_entry" order="32" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_set_no_entry(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_no_entry段define

   #end add-point

   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("xcagsite,xcag001",FALSE)
      #add-point:set_no_entry段欄位控制

      #end add-point
   END IF

   #add-point:set_no_entry段欄位控制後

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_set_entry_b" order="33" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_set_entry_b(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_entry_b段define

   #end add-point

   #add-point:set_entry_b段

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_set_no_entry_b" order="34" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_set_no_entry_b(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_no_entry_b段define

   #end add-point

   #add-point:set_no_entry_b段

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_default_search" order="35" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_default_search()
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   #add-point:default_search段define

   #end add-point

   #add-point:default_search段開始前

   #end add-point

   LET g_pagestart = 1

   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF

   IF NOT cl_null(g_argv[1]) THEN
      LET ls_wc = ls_wc, " xcagsite = '", g_argv[1], "' AND "
   END IF

   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " xcag001 = '", g_argv[02], "' AND "
   END IF


   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      LET g_default = FALSE
      #預設查詢條件
      LET g_wc = cl_qbe_get_default_qryplan()
      IF cl_null(g_wc) THEN
         LET g_wc = " 1=1"
      END IF
   END IF

   #add-point:default_search段結束前

   #end add-point

END FUNCTION]]>
  </point>
  <point name="function.axci006_fill_chk" order="36" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_fill_chk(ps_idx)
   DEFINE ps_idx        LIKE type_t.chr10
   DEFINE lst_token     base.StringTokenizer
   DEFINE ls_token      STRING
   #add-point:fill_chk段define

   #end add-point

   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1') THEN
      RETURN TRUE
   END IF

   #第一單身
   IF ps_idx = 1 AND
      ((NOT cl_null(g_wc2_table1) AND g_wc2_table1.trim() <> '1=1')) THEN
      RETURN TRUE
   END IF

   #根據wc判定是否需要填充



   #add-point:fill_chk段other

   #end add-point

   RETURN FALSE

END FUNCTION]]>
  </point>
  <point name="function.axci006_modify_detail_chk" order="37" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_modify_detail_chk(ps_record)
   DEFINE ps_record STRING
   DEFINE ls_return STRING
   #add-point:modify_detail_chk段define

   #end add-point

   #add-point:modify_detail_chk段開始前

   #end add-point

   CASE ps_record
      WHEN "s_detail1"
         LET ls_return = "check"
      WHEN "s_detail2"
         LET ls_return = "xcag004_2"

      #add-point:modify_detail_chk段自訂page控制

      #end add-point
   END CASE

   #add-point:modify_detail_chk段結束前

   #end add-point

   RETURN ls_return

END FUNCTION]]>
  </point>
  <point name="function.axci006_set_pk_array" order="38" ver="1" cite_std="" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION axci006_set_pk_array()
   #add-point:set_pk_array段define

   #end add-point

   #add-point:set_pk_array段之前

   #end add-point

   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_xcag_m.xcagsite
   LET g_pk_array[1].column = 'xcagsite'
   LET g_pk_array[2].values = g_xcag_m.xcag001
   LET g_pk_array[2].column = 'xcag001'

   #add-point:set_pk_array段之後

   #end add-point

END FUNCTION]]>
  </point>
  <point name="b_fill.fill" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[         LET g_xcag_d[l_ac].check = 'N']]>
  </point>
  <point name="construct.c.page1.xcag004" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcag004()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcag004  #顯示到畫面上
            NEXT FIELD xcag004                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.page2.xcagcrtdp" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagcrtdp  #顯示到畫面上
            NEXT FIELD xcagcrtdp                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.page2.xcagcrtid" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagcrtid  #顯示到畫面上
            NEXT FIELD xcagcrtid                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.page2.xcagmodid" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagmodid  #顯示到畫面上
            NEXT FIELD xcagmodid                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.page2.xcagowndp" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagowndp  #顯示到畫面上
            NEXT FIELD xcagowndp                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.page2.xcagownid" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagownid  #顯示到畫面上
            NEXT FIELD xcagownid                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.xcag001" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcag001  #顯示到畫面上
            NEXT FIELD xcag001                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.xcag011" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_aooi001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcag011  #顯示到畫面上
            NEXT FIELD xcag011                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.xcagcomp" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcagcomp()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagcomp  #顯示到畫面上
            NEXT FIELD xcagcomp                     #返回原欄位
    

]]>
  </point>
  <point name="construct.c.xcagsite" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a08產生
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_xcagsite()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO xcagsite  #顯示到畫面上
            NEXT FIELD xcagsite                     #返回原欄位
    

]]>
  </point>
  <point name="delete.body.m_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[      DELETE FROM xcah_t WHERE xcahent = g_enterprise AND xcahsite = g_xcag_m.xcagsite
                                                               AND xcah001 = g_xcag_m.xcag001
                                                               
      DELETE FROM xcai_t WHERE xcaient = g_enterprise AND xcaisite = g_xcag_m.xcagsite
                                                               AND xcai001 = g_xcag_m.xcag001
                                                               
      DELETE FROM xcaj_t WHERE xcajent = g_enterprise AND xcajsite = g_xcag_m.xcagsite
                                                               AND xcaj001 = g_xcag_m.xcag001]]>
  </point>
  <point name="delete.body.m_single_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   DELETE FROM xcah_t
    WHERE xcahent = g_enterprise AND xcahsite = g_xcag_m.xcagsite AND
                              xcah001 = g_xcag_m.xcag001 AND
 
 
          xcah002 = g_xcag_d_t.xcag002
      AND xcah004 = g_xcag_d_t.xcag004
      
   DELETE FROM xcai_t
    WHERE xcaient = g_enterprise AND xcaisite = g_xcag_m.xcagsite AND
                              xcai001 = g_xcag_m.xcag001 AND
 
 
          xcai002 = g_xcag_d_t.xcag002
      AND xcai004 = g_xcag_d_t.xcag004
   
   DELETE FROM xcaj_t
    WHERE xcajent = g_enterprise AND xcajsite = g_xcag_m.xcagsite AND
                              xcaj001 = g_xcag_m.xcag001 AND
 
 
          xcaj002 = g_xcag_d_t.xcag002
      AND xcaj004 = g_xcag_d_t.xcag004]]>
  </point>
  <point name="free_style.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[#單頭 type 宣告
 type type_g_xcag_m        RECORD
       xcagsite LIKE xcag_t.xcagsite, 
   xcagsite_desc LIKE type_t.chr80, 
   xcagcomp LIKE xcag_t.xcagcomp, 
   xcagcomp_desc LIKE type_t.chr80, 
   xcag011 LIKE xcag_t.xcag011, 
   xcag011_desc LIKE type_t.chr80, 
   xcag001 LIKE xcag_t.xcag001, 
   xcag001_desc LIKE type_t.chr80
       END RECORD
 
#單身 type 宣告
 TYPE type_g_xcag_d        RECORD
       check LIKE type_t.chr80, 
   xcag004 LIKE xcag_t.xcag004, 
   xcag002 LIKE xcag_t.xcag002, 
   xcag003 LIKE xcag_t.xcag003, 
   xcag102 LIKE xcag_t.xcag102, 
   xcag102a LIKE xcag_t.xcag102a, 
   xcag102b LIKE xcag_t.xcag102b, 
   xcag102c LIKE xcag_t.xcag102c, 
   xcag102d LIKE xcag_t.xcag102d, 
   xcag102e LIKE xcag_t.xcag102e, 
   xcag102f LIKE xcag_t.xcag102f, 
   xcag102g LIKE xcag_t.xcag102g, 
   xcag102h LIKE xcag_t.xcag102h
       END RECORD
 TYPE type_g_xcag2_d RECORD
       xcag004 LIKE xcag_t.xcag004, 
   xcag002 LIKE xcag_t.xcag002, 
   xcagownid LIKE xcag_t.xcagownid, 
   xcagownid_desc LIKE type_t.chr500, 
   xcagowndp LIKE xcag_t.xcagowndp, 
   xcagowndp_desc LIKE type_t.chr500, 
   xcagcrtid LIKE xcag_t.xcagcrtid, 
   xcagcrtid_desc LIKE type_t.chr500, 
   xcagcrtdp LIKE xcag_t.xcagcrtdp, 
   xcagcrtdp_desc LIKE type_t.chr500, 
   xcagcrtdt DATETIME YEAR TO SECOND, 
   xcagmodid LIKE xcag_t.xcagmodid, 
   xcagmodid_desc LIKE type_t.chr500, 
   xcagmoddt DATETIME YEAR TO SECOND
       END RECORD
 
 
#無單頭append欄位定義
#無單身append欄位定義
 
#模組變數(Module Variables)
DEFINE g_xcag_m          type_g_xcag_m
DEFINE g_xcag_m_t        type_g_xcag_m
 
   DEFINE g_xcagsite_t LIKE xcag_t.xcagsite
DEFINE g_xcag001_t LIKE xcag_t.xcag001
 
 
DEFINE g_xcag_d          DYNAMIC ARRAY OF type_g_xcag_d
DEFINE g_xcag_d_t        type_g_xcag_d
DEFINE g_xcag2_d   DYNAMIC ARRAY OF type_g_xcag2_d
DEFINE g_xcag2_d_t type_g_xcag2_d
 
 
DEFINE g_browser      DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位  
       b_statepic     LIKE type_t.chr50,
          b_xcagsite LIKE xcag_t.xcagsite,
      b_xcag001 LIKE xcag_t.xcag001,
      b_xcagcomp LIKE xcag_t.xcagcomp,
      b_xcag011 LIKE xcag_t.xcag011
       #,rank           LIKE type_t.num10
      END RECORD 
 
DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
 
 
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING
 
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num5           
DEFINE l_ac                  LIKE type_t.num5    
DEFINE g_curr_diag           ui.Dialog                     #Current Dialog
 
DEFINE g_pagestart           LIKE type_t.num5           
DEFINE gwin_curr             ui.Window                     #Current Window
DEFINE gfrm_curr             ui.Form                       #Current Form
DEFINE g_page_action         STRING                        #page action
DEFINE g_header_hidden       LIKE type_t.num5              #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5              #隱藏工作Panel
DEFINE g_page                STRING                        #第幾頁
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
 
DEFINE g_detail_cnt          LIKE type_t.num5              #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num5              #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num5              #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num5              #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num5              #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num5              #Browser目前所在筆數(暫存用)
 
DEFINE g_searchcol           STRING                        #查詢欄位代碼
DEFINE g_searchstr           STRING                        #查詢欄位字串
DEFINE g_order               STRING                        #查詢排序欄位
DEFINE g_state               STRING                        
DEFINE g_insert              LIKE type_t.chr5              #是否導到其他page                    
DEFINE g_current_row         LIKE type_t.num5              #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                       #Browser所在筆數用開關
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_error_show          LIKE type_t.num5
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢]]>
  </point>
  <point name="global.variable" order="" ver="3" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[DEFINE g_current_page        LIKE type_t.num5              #目前所在頁數
DEFINE g_xcaesite            LIKE xcae_t.xcaesite
DEFINE g_flag                LIKE type_t.chr1
 TYPE type_g_xcah_d        RECORD
   xcah020 LIKE type_t.chr80,  
   xcah021 LIKE xcah_t.xcah021,
   xcah040 LIKE xcah_t.xcah040,
   xcah022 LIKE xcah_t.xcah022,
   xcah023 LIKE xcah_t.xcah023,
   xcah030 LIKE xcah_t.xcah030,
   xcah030a LIKE xcah_t.xcah030a,
   xcah030b LIKE xcah_t.xcah030b,
   xcah030c LIKE xcah_t.xcah030c,
   xcah030d LIKE xcah_t.xcah030d,
   xcah030e LIKE xcah_t.xcah030e,
   xcah030f LIKE xcah_t.xcah030f,
   xcah030g LIKE xcah_t.xcah030g,
   xcah030h LIKE xcah_t.xcah030h,
   xcah026 LIKE xcah_t.xcah026,
   xcah025 LIKE xcah_t.xcah025,
   xcah027 LIKE xcah_t.xcah027,
   xcah043 LIKE xcah_t.xcah043,
   xcah042 LIKE xcah_t.xcah042,
   xcah044 LIKE xcah_t.xcah044,
   xcah031 LIKE xcah_t.xcah031,
   xcah031a LIKE xcah_t.xcah031a,
   xcah031b LIKE xcah_t.xcah031b,
   xcah031c LIKE xcah_t.xcah031c,
   xcah031d LIKE xcah_t.xcah031d,
   xcah031e LIKE xcah_t.xcah031e,
   xcah031f LIKE xcah_t.xcah031f,
   xcah031g LIKE xcah_t.xcah031g,
   xcah031h LIKE xcah_t.xcah031h
       END RECORD
DEFINE g_xcah_d          DYNAMIC ARRAY OF type_g_xcah_d
DEFINE g_xcah_d_t        type_g_xcah_d

 TYPE type_g_xcai_d        RECORD
   xcaiseq LIKE xcai_t.xcaiseq,
   xcai100 LIKE xcai_t.xcai100,
   xcai101 LIKE xcai_t.xcai101,
   xcai103 LIKE xcai_t.xcai103,
   xcai108 LIKE xcai_t.xcai108,
   xcai102 LIKE xcai_t.xcai102,
   xcai104 LIKE xcai_t.xcai104,
   xcai105 LIKE xcai_t.xcai105,
   xcai106 LIKE xcai_t.xcai106,
   xcai107 LIKE xcai_t.xcai107
       END RECORD
DEFINE g_xcai_d          DYNAMIC ARRAY OF type_g_xcai_d
DEFINE g_xcai_d_t        type_g_xcai_d

 TYPE type_g_xcaj_d        RECORD
   xcaj005 LIKE xcaj_t.xcaj005,
   xcaj005_desc LIKE type_t.chr80,
   xcaj102 LIKE xcaj_t.xcaj102
       END RECORD
DEFINE g_xcaj_d          DYNAMIC ARRAY OF type_g_xcaj_d
DEFINE g_xcaj_d_t        type_g_xcaj_d
DEFINE l_ac2             LIKE type_t.num5
DEFINE l_ac2_t           LIKE type_t.num5
DEFINE g_rec_b2          LIKE type_t.num5
DEFINE l_ac3             LIKE type_t.num5
DEFINE l_ac3_t           LIKE type_t.num5
DEFINE g_rec_b3          LIKE type_t.num5 
DEFINE l_ac4             LIKE type_t.num5
DEFINE l_ac4_t           LIKE type_t.num5
DEFINE g_rec_b4          LIKE type_t.num5 
DEFINE g_flag2          LIKE type_t.num5 
DEFINE g_detail_idx3         LIKE type_t.num5 
DEFINE g_detail_idx4         LIKE type_t.num5 ]]>
  </point>
  <point name="input.a.page1.xcag002" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_xcag_m.xcagsite IS NOT NULL AND g_xcag_m.xcag001 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag002 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t OR g_xcag_m.xcag001 != g_xcag001_t OR g_xcag_d[g_detail_idx].xcag002 != g_xcag_d_t.xcag002 OR g_xcag_d[g_detail_idx].xcag004 != g_xcag_d_t.xcag004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"' AND "|| "xcag002 = '"||g_xcag_d[g_detail_idx].xcag002 ||"' AND "|| "xcag004 = '"||g_xcag_d[g_detail_idx].xcag004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page1.xcag004" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_xcag_m.xcagsite IS NOT NULL AND g_xcag_m.xcag001 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag002 IS NOT NULL AND g_xcag_d[g_detail_idx].xcag004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t OR g_xcag_m.xcag001 != g_xcag001_t OR g_xcag_d[g_detail_idx].xcag002 != g_xcag_d_t.xcag002 OR g_xcag_d[g_detail_idx].xcag004 != g_xcag_d_t.xcag004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"' AND "|| "xcag002 = '"||g_xcag_d[g_detail_idx].xcag002 ||"' AND "|| "xcag004 = '"||g_xcag_d[g_detail_idx].xcag004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page2.xcag002_2" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_xcag_m.xcagsite IS NOT NULL AND g_xcag_m.xcag001 IS NOT NULL AND g_xcag2_d[g_detail_idx].xcag002 IS NOT NULL AND g_xcag2_d[g_detail_idx].xcag004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t OR g_xcag_m.xcag001 != g_xcag001_t OR g_xcag2_d[g_detail_idx].xcag002 != g_xcag2_d_t.xcag002 OR g_xcag2_d[g_detail_idx].xcag004 != g_xcag2_d_t.xcag004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"' AND "|| "xcag002 = '"||g_xcag2_d[g_detail_idx].xcag002 ||"' AND "|| "xcag004 = '"||g_xcag2_d[g_detail_idx].xcag004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.page2.xcag004_2" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  g_xcag_m.xcagsite IS NOT NULL AND g_xcag_m.xcag001 IS NOT NULL AND g_xcag2_d[g_detail_idx].xcag002 IS NOT NULL AND g_xcag2_d[g_detail_idx].xcag004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t OR g_xcag_m.xcag001 != g_xcag001_t OR g_xcag2_d[g_detail_idx].xcag002 != g_xcag2_d_t.xcag002 OR g_xcag2_d[g_detail_idx].xcag004 != g_xcag2_d_t.xcag004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"' AND "|| "xcag002 = '"||g_xcag2_d[g_detail_idx].xcag002 ||"' AND "|| "xcag004 = '"||g_xcag2_d[g_detail_idx].xcag004 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.a.xcag001" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a05產生
            IF  NOT cl_null(g_xcag_m.xcagsite) AND NOT cl_null(g_xcag_m.xcag001) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t  OR g_xcag_m.xcag001 != g_xcag001_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


]]>
  </point>
  <point name="input.a.xcag011" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcag011
            CALL ap_ref_array2(g_ref_fields,"SELECT ooail003 FROM ooail_t WHERE ooailent='"||g_enterprise||"' AND ooail001=? AND ooail002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcag011_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcag011_desc

]]>
  </point>
  <point name="input.a.xcagcomp" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagcomp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagcomp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagcomp_desc

]]>
  </point>
  <point name="input.a.xcagsite" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagsite
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagsite_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagsite_desc

            #此段落由子樣板a05產生
            IF  NOT cl_null(g_xcag_m.xcagsite) AND NOT cl_null(g_xcag_m.xcag001) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_xcag_m.xcagsite != g_xcagsite_t  OR g_xcag_m.xcag001 != g_xcag001_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM xcag_t WHERE "||"xcagent = '" ||g_enterprise|| "' AND "||"xcagsite = '"||g_xcag_m.xcagsite ||"' AND "|| "xcag001 = '"||g_xcag_m.xcag001 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

]]>
  </point>
  <point name="input.after_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL cl_set_comp_visible('check',FALSE)]]>
  </point>
  <point name="input.body.a_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               FOR li = 1 TO g_xcag_d.getLength()
                  IF g_xcag_d[l_ac].check <> 'Y' THEN
                     CONTINUE FOR
                  END IF
                  #end add-point
                  
                  
                  IF l_lock_sw = "Y" THEN
                     CALL cl_err("", -263, 1)
                     CANCEL DELETE
                  END IF
                  IF axci006_before_delete() THEN 
                     CALL s_transaction_end('Y','0')
                  ELSE 
                     CALL s_transaction_end('N','0')
                     CANCEL DELETE   
                  END IF 
                  CLOSE axci006_bcl
               END FOR
               LET l_count = g_xcag_d.getLength()
            END IF ]]>
  </point>
  <point name="input.body.b_delete" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[               LET l_flag = 'Y'
               IF l_flag = 'N' THEN]]>
  </point>
  <point name="input.body.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            CALL cl_set_comp_visible('check',TRUE)]]>
  </point>
  <point name="input.body.before_row" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            LET g_xcag_d[l_ac].check = 'N'
            CALL axci006_xcah_b_fill()
            CALL axci006_xcai_b_fill()
            CALL axci006_xcaj_b_fill()]]>
  </point>
  <point name="input.define" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   DEFINE  l_flag                LIKE type_t.chr1
   DEFINE  li                    LIKE type_t.num5]]>
  </point>
  <point name="input.more_inputarray" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[      DISPLAY ARRAY g_xcah_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b2) 
    
         BEFORE ROW
            CALL axci006_xcah_b_fill() 
            LET g_detail_idx2 = DIALOG.getCurrentRow("s_detail3")
            LET l_ac2 = g_detail_idx2
            CALL axci006_ui_detailshow()
         
         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx2)
            
      END DISPLAY
      
      DISPLAY ARRAY g_xcai_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b3) 
    
         BEFORE ROW
            CALL axci006_xcai_b_fill() 
            LET g_detail_idx3 = DIALOG.getCurrentRow("s_detail4")
            LET l_ac3 = g_detail_idx3
            CALL axci006_ui_detailshow()
         
         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx3)
            
      END DISPLAY
      
      DISPLAY ARRAY g_xcaj_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b4) 
    
         BEFORE ROW
            CALL axci006_xcaj_b_fill() 
            LET g_detail_idx4 = DIALOG.getCurrentRow("s_detail5")
            LET l_ac4 = g_detail_idx4
            CALL axci006_ui_detailshow()
         
         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx4)
            
      END DISPLAY]]>
  </point>
  <point name="ref_show.body2.reference" order="" ver="1" cite_std="" new="N" status="" src="s" mark_hard="N">
    <![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagownid
            CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagownid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagownid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagowndp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagowndp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagowndp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagcrtid
            CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagcrtid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagcrtid_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagcrtdp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagcrtdp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagcrtdp_desc

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag2_d[l_ac].xcagmodid
            CALL ap_ref_array2(g_ref_fields,"SELECT oofa011 FROM oofa_t WHERE oofaent='"||g_enterprise||"' AND oofa002='2' AND oofa003=? ","") RETURNING g_rtn_fields
            LET g_xcag2_d[l_ac].xcagmodid_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag2_d[l_ac].xcagmodid_desc
]]>
  </point>
  <point name="ref_show.head.reference" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagsite
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagsite_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagsite_desc
            
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcagcomp
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcagcomp_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcagcomp_desc
            
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcag001
            CALL ap_ref_array2(g_ref_fields,"SELECT xcaal003 FROM xcaal_t WHERE xcaalent='"||g_enterprise||"' AND xcaal001=? AND xcaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcag001_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcag001_desc
            
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_xcag_m.xcag011
            CALL ap_ref_array2(g_ref_fields,"SELECT ooail003 FROM ooail_t WHERE ooailent='"||g_enterprise||"' AND ooail001=? AND ooail002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_xcag_m.xcag011_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_xcag_m.xcag011_desc
]]>
  </point>
  <point name="show.after" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   IF ARR_CURR() > g_xcag_d.getLength() THEN   #防止会有空白行
      LET l_ac = 1
   END IF
   IF l_ac < 1 OR cl_null(l_ac) THEN
      LET l_ac = 1
   END IF
   CALL axci006_xcah_b_fill()
   CALL axci006_xcai_b_fill()
   CALL axci006_xcaj_b_fill()
   CALL cl_show_fld_cont()]]>
  </point>
  <point name="show.before" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL cl_set_act_visible("modify",FALSE)]]>
  </point>
  <point name="ui_dialog.before_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL axci006_create_tmp()
   CALL cl_set_comp_visible('check',FALSE)]]>
  </point>
  <point name="ui_dialog.body.before_row" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[               CALL axci006_xcah_b_fill()
               CALL axci006_xcai_b_fill()
               CALL axci006_xcaj_b_fill()]]>
  </point>
  <point name="ui_dialog.body2.action" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            LET g_current_page = 1]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[         DISPLAY ARRAY g_xcah_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b2) 
    
            BEFORE ROW
               LET l_ac2 = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx2 = l_ac2
          
            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx2)
               LET l_ac2 = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 1
               
         END DISPLAY
      
         DISPLAY ARRAY g_xcai_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b3) 
         
            BEFORE ROW
               LET l_ac3 = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx3 = l_ac3
          
            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx3)
               LET l_ac3 = DIALOG.getCurrentRow("s_detail4")
               LET g_current_page = 1
               
         END DISPLAY
         
         DISPLAY ARRAY g_xcaj_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b4) 
         
            BEFORE ROW
               LET l_ac4 = DIALOG.getCurrentRow("s_detail5")
               LET g_detail_idx4 = l_ac4
          
            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx4)
               LET l_ac4 = DIALOG.getCurrentRow("s_detail5")
               LET g_current_page = 1
               
         END DISPLAY]]>
  </point>
  <section id="axci006.b_fill" ver="5" status="" src="s">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION axci006_b_fill(p_wc2)
   DEFINE p_wc2      STRING
   #add-point:b_fill段define
   {<point name="b_fill.define"/>}
   #end add-point     
 
   #先清空單身變數內容
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()
 
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
   
      LET g_sql = "SELECT  UNIQUE '',xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d, 
          xcag102e,xcag102f,xcag102g,xcag102h,xcag004,xcag002,xcagownid,'',xcagowndp,'',xcagcrtid,'', 
          xcagcrtdp,'',xcagcrtdt,xcagmodid,'',xcagmoddt FROM xcag_t",   
                  "",
                  
                  " WHERE xcagent= ? AND xcagsite=? AND xcag001=?"  
                  
   IF NOT cl_null(g_wc2_table1) THEN
      LET g_sql = g_sql CLIPPED," AND ",g_wc2_table1 CLIPPED
   END IF
   
   #add-point:b_fill段sql_after
   {<point name="b_fill.sql_after"/>}
   #end add-point
   
   #子單身的WC
   
   
   #判斷是否填充
   IF axci006_fill_chk(1) THEN
      LET g_sql = g_sql, " ORDER BY xcag_t.xcag002,xcag_t.xcag004"
      
      #add-point:b_fill段fill_before
      {<point name="b_fill.fill_before"/>}
      #end add-point
      
      PREPARE axci006_pb FROM g_sql
      DECLARE b_fill_cs CURSOR FOR axci006_pb
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
      OPEN b_fill_cs USING g_enterprise,g_xcag_m.xcagsite
                                               ,g_xcag_m.xcag001
 
                                               
      FOREACH b_fill_cs INTO g_xcag_d[l_ac].check,g_xcag_d[l_ac].xcag004,g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag003, 
          g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b,g_xcag_d[l_ac].xcag102c, 
          g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e,g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g, 
          g_xcag_d[l_ac].xcag102h,g_xcag2_d[l_ac].xcag004,g_xcag2_d[l_ac].xcag002,g_xcag2_d[l_ac].xcagownid, 
          g_xcag2_d[l_ac].xcagownid_desc,g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagowndp_desc,g_xcag2_d[l_ac].xcagcrtid, 
          g_xcag2_d[l_ac].xcagcrtid_desc,g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdp_desc,g_xcag2_d[l_ac].xcagcrtdt, 
          g_xcag2_d[l_ac].xcagmodid,g_xcag2_d[l_ac].xcagmodid_desc,g_xcag2_d[l_ac].xcagmoddt
                             ,g_xcag_d[l_ac].check,g_xcag_d[l_ac].xcag004,g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag003, 
                                 g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b, 
                                 g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e, 
                                 g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h, 
                                 g_xcag2_d[l_ac].xcag004,g_xcag2_d[l_ac].xcag002,g_xcag2_d[l_ac].xcagownid, 
                                 g_xcag2_d[l_ac].xcagownid_desc,g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagowndp_desc, 
                                 g_xcag2_d[l_ac].xcagcrtid,g_xcag2_d[l_ac].xcagcrtid_desc,g_xcag2_d[l_ac].xcagcrtdp, 
                                 g_xcag2_d[l_ac].xcagcrtdp_desc,g_xcag2_d[l_ac].xcagcrtdt,g_xcag2_d[l_ac].xcagmodid, 
                                 g_xcag2_d[l_ac].xcagmodid_desc,g_xcag2_d[l_ac].xcagmoddt
 
                             
         IF SQLCA.sqlcode THEN
            CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
                           
         #add-point:b_fill段資料填充
         {<point name="b_fill.fill"/>}
         #end add-point
      
         #帶出公用欄位reference值
         
         
         #此段落由子樣板a12產生
      #LET g_xcag2_d[l_ac].xcagownid_desc = cl_get_username(g_xcag2_d[l_ac].xcagownid)
      #LET g_xcag2_d[l_ac].xcagowndp_desc = cl_get_deptname(g_xcag2_d[l_ac].xcagowndp)
      #LET g_xcag2_d[l_ac].xcagcrtid_desc = cl_get_username(g_xcag2_d[l_ac].xcagcrtid)
      #LET g_xcag2_d[l_ac].xcagcrtdp_desc = cl_get_deptname(g_xcag2_d[l_ac].xcagcrtdp)
      #LET g_xcag2_d[l_ac].xcagmodid_desc = cl_get_username(g_xcag2_d[l_ac].xcagmodid)
      ##LET .xcagcnfid_desc = cl_get_deptname(.xcagcnfid)
      ##LET .xcagpstid_desc = cl_get_deptname(.xcagpstid)
      
 
 
 
        
         #add-point:單身資料抓取
         {<point name="bfill.foreach"/>}
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            EXIT FOREACH
         END IF
         
      END FOREACH
      
            CALL g_xcag_d.deleteElement(g_xcag_d.getLength())
      CALL g_xcag2_d.deleteElement(g_xcag2_d.getLength())
 
   END IF
   
   #add-point:b_fill段more
   {<point name="b_fill.more"/>}
   #end add-point
   
   LET g_rec_b=l_ac-1
   DISPLAY g_rec_b TO FORMONLY.cnt  
   LET l_ac = g_cnt
   LET g_cnt = 0 
 
   FREE axci006_pb   
   
END FUNCTION
]]>
  </section>
  <section id="axci006.b_fill2" ver="1" status="" src="s">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION axci006_b_fill2(pi_idx)
   DEFINE pi_idx          LIKE type_t.num5
   DEFINE li_ac           LIKE type_t.num5
   #add-point:b_fill2段define
   {<point name="b_fill2.define"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
 
      
   #add-point:單身填充後
   {<point name="b_fill2.after_fill" />}
   #end add-point
    
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="axci006.before_delete" ver="2" status="" src="s">
    <![CDATA[#+ 單身db資料刪除
PRIVATE FUNCTION axci006_before_delete()
   #add-point:before_delete段define
   {<point name="before_delete.define"/>}
   #end add-point 
   
   #add-point:單筆刪除前
   {<point name="delete.body.b_single_delete" mark="Y"/>}
   #end add-point
   
   DELETE FROM xcag_t
    WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite AND
                              xcag001 = g_xcag_m.xcag001 AND
 
          xcag002 = g_xcag_d_t.xcag002
      AND xcag004 = g_xcag_d_t.xcag004
 
      
   #add-point:單筆刪除中
   {<point name="delete.body.m_single_delete"/>}
   #end add-point
   
   IF SQLCA.sqlcode THEN
      CALL cl_err("xcag_t",SQLCA.sqlcode,1)
      RETURN FALSE 
   END IF
   
   #add-point:單筆刪除後
   {<point name="delete.body.a_single_delete"/>}
   #end add-point
 
   LET g_rec_b = g_rec_b-1
   DISPLAY g_rec_b TO FORMONLY.cnt
 
   RETURN TRUE
    
END FUNCTION
]]>
  </section>
  <section id="axci006.browser_fill" ver="4" status="" src="s">
    <![CDATA[#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION axci006_browser_fill(ps_page_action)
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   DEFINE l_searchcol       STRING
   #add-point:browser_fill段define
   {<point name="browser_fill.define"/>}
   #end add-point    
   
   #add-point:browser_fill段動作開始前
   {<point name="browser_fill.before_browser_fill"/>}
   #end add-point    
   
   CALL g_browser.clear()
 
   #搜尋用
   IF cl_null(g_searchcol) OR g_searchcol = '0' THEN
      LET l_searchcol = "xcagsite"
   ELSE
      LET l_searchcol = g_searchcol
   END IF
   
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
   IF cl_null(l_wc) THEN  #p_wc 查詢條件
      RETURN
   END IF
   
   IF g_wc2 <> " 1=1" OR NOT cl_null(g_wc2) THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT UNIQUE xcagsite ",
                      ", xcag001 ",
 
                      " FROM xcag_t ",
                      " ",
                      " ",
 
                      " WHERE xcagent = '" ||g_enterprise|| "' AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("xcag_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE xcagsite ",
                      ", xcag001 ",
 
                      " FROM xcag_t ",
                      " ",
                      " ",
                      " WHERE xcagent = '" ||g_enterprise|| "' AND ",l_wc CLIPPED, cl_sql_add_filter("xcag_t")
   END IF 
   
   LET g_sql = " SELECT COUNT(*) FROM (",l_sub_sql,")"
 
   #add-point:browser_fill,count前
   {<point name="browser_fill.before_count"/>}
   #end add-point
   
   PREPARE header_cnt_pre FROM g_sql
   EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
   FREE header_cnt_pre
   
   #若超過最大顯示筆數
   LET g_error_show = 0
 
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #LET g_page_action = ps_page_action          # Keep Action
   IF ps_page_action = "first" OR              
      ps_page_action = "prev"  OR
      ps_page_action = "next"  OR
      ps_page_action = "last"  THEN
      LET g_page_action = ps_page_action        #g_page_action 這個會影響 browser 下面四個button 的判斷 
   END IF
   
   CASE ps_page_action
      WHEN "F" 
         LET g_pagestart = 1
          
      WHEN "P"  
         LET g_pagestart = g_pagestart - g_max_browse
         IF g_pagestart < 1 THEN
             LET g_pagestart = 1
         END IF
          
      WHEN "N"  
         LET g_pagestart = g_pagestart + g_max_browse
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
            WHILE g_pagestart > g_browser_cnt 
               LET g_pagestart = g_pagestart - g_max_browse
            END WHILE
         END IF
      
      WHEN "L"  
         LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
         WHILE g_pagestart > g_browser_cnt 
            LET g_pagestart = g_pagestart - g_max_browse
         END WHILE
 
      OTHERWISE
         LET g_pagestart = 1
         
   END CASE
   
   #單身有輸入查詢條件且非null
   IF g_wc2 <> " 1=1" AND NOT cl_null(g_wc2) THEN 
 
      #依照xcagsite,xcag001 Browser欄位定義(取代原本bs_sql功能)
      LET l_sub_sql  = "SELECT DISTINCT xcagsite,xcag001 ",
                       " FROM xcag_t ",
 
                       " ",
                       " WHERE xcagent = '" ||g_enterprise|| "' AND ", g_wc," AND ",g_wc2, cl_sql_add_filter("xcag_t")
 
   ELSE
      #單身無輸入資料
      LET l_sub_sql  = "SELECT DISTINCT xcagsite,xcag001 ",
                       " FROM xcag_t ",
                       " WHERE xcagent = '" ||g_enterprise|| "' AND ", g_wc, cl_sql_add_filter("xcag_t")
                 
   END IF
   
   #add-point:browser_fill,sql_rank前
   {<point name="browser_fill.before_sql_rank"/>}
   #end add-point
   
   LET l_sql_rank = "SELECT xcagsite,xcag001,DENSE_RANK() OVER(ORDER BY xcagsite ",g_order,") AS RANK ", 

                    " FROM (",l_sub_sql,") "
                       
   #定義翻頁CURSOR
   LET g_sql= " SELECT xcagsite,xcag001 FROM (",l_sql_rank,") WHERE RANK>=",g_pagestart,
              " AND RANK < ", g_pagestart + g_max_browse,
              " ORDER BY ",l_searchcol, " ", g_order
                
   #add-point:browser_fill,pre前
   {<point name="browser_fill.before_pre"/>}
   #end add-point
                
   PREPARE browse_pre FROM g_sql
   DECLARE browse_cur CURSOR FOR browse_pre
 
   CALL g_browser.clear()
   LET g_cnt = 1
   FOREACH browse_cur INTO g_browser[g_cnt].b_xcagsite,g_browser[g_cnt].b_xcag001    
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      
      
      
      #add-point:browser_fill段reference
      {<point name="browser_fill.reference"/>}
      #end add-point    
      
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         EXIT FOREACH
      END IF
   END FOREACH
 
   CALL g_browser.deleteElement(g_cnt)
   IF g_browser.getLength() = 0 AND g_wc THEN
      INITIALIZE g_xcag_m.* TO NULL
      CALL g_xcag_d.clear()
      CALL g_xcag2_d.clear()
 
      CLEAR FORM
   END IF
   
   LET g_header_cnt = g_browser.getLength()
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
   
   
   FREE browse_pre
   
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", TRUE)
   END IF
   
END FUNCTION
]]>
  </section>
  <section id="axci006.browser_search" ver="1" status="" src="s">
    <![CDATA[#+ 瀏覽頁簽資料搜尋
PRIVATE FUNCTION axci006_browser_search(p_type)
   DEFINE p_type LIKE type_t.chr10
   #add-point:browser_search段define
   {<point name="browser_search.define"/>}
   #end add-point    
   
   #若無輸入關鍵字則查找出所有資料
   IF NOT cl_null(g_searchstr) AND g_searchcol='0' THEN
      CALL cl_err("searchcol","std-00005",0)
      RETURN FALSE 
   END IF 
   
   IF NOT cl_null(g_searchstr) THEN
      LET g_wc = " lower(", g_searchcol, ") LIKE '%", g_searchstr, "%'"
      LET g_wc = g_wc.toLowerCase()
   ELSE
      LET g_wc = " 1=1"
   END IF         
   
   #若為排序搜尋則添加以下條件
   IF cl_null(g_searchcol) OR g_searchcol = "0" THEN
      LET g_wc = g_wc, " ORDER BY xcagsite"
   ELSE
      LET g_wc = g_wc, " ORDER BY ", g_searchcol
   END IF 
 
   CALL axci006_browser_fill("F")
   CALL ui.Interface.refresh()
   RETURN TRUE
 
END FUNCTION
]]>
  </section>
  <section id="axci006.construct" ver="8" status="" src="s">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION axci006_construct()
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   #add-point:cs段define
   {<point name="cs.define"/>}
   #end add-point    
 
   #清除畫面上相關資料
   CLEAR FORM                 
   INITIALIZE g_xcag_m.* TO NULL
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()
 
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   LET g_action_choice = ""
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段construct外
   {<point name="cs.head.before"/>}
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON xcagsite,xcagcomp,xcag011,xcag001
 
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
            {<point name="cs.head.before_construct"/>}
            #end add-point 
            
        #---------------------------<  Master  >---------------------------
         #----<<xcagsite>>----
         #Ctrlp:construct.c.xcagsite
         ON ACTION controlp INFIELD xcagsite
            #add-point:ON ACTION controlp INFIELD xcagsite
            {<point name="construct.c.xcagsite" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagsite
            #add-point:BEFORE FIELD xcagsite
            {<point name="construct.b.xcagsite" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagsite
            
            #add-point:AFTER FIELD xcagsite
            {<point name="construct.a.xcagsite" />}
            #END add-point
            
 
         #----<<xcagsite_desc>>----
         #----<<xcagcomp>>----
         #Ctrlp:construct.c.xcagcomp
         ON ACTION controlp INFIELD xcagcomp
            #add-point:ON ACTION controlp INFIELD xcagcomp
            {<point name="construct.c.xcagcomp" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagcomp
            #add-point:BEFORE FIELD xcagcomp
            {<point name="construct.b.xcagcomp" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagcomp
            
            #add-point:AFTER FIELD xcagcomp
            {<point name="construct.a.xcagcomp" />}
            #END add-point
            
 
         #----<<xcagcomp_desc>>----
         #----<<xcag011>>----
         #Ctrlp:construct.c.xcag011
         ON ACTION controlp INFIELD xcag011
            #add-point:ON ACTION controlp INFIELD xcag011
            {<point name="construct.c.xcag011" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcag011
            #add-point:BEFORE FIELD xcag011
            {<point name="construct.b.xcag011" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag011
            
            #add-point:AFTER FIELD xcag011
            {<point name="construct.a.xcag011" />}
            #END add-point
            
 
         #----<<xcag011_desc>>----
         #----<<xcag001>>----
         #Ctrlp:construct.c.xcag001
         ON ACTION controlp INFIELD xcag001
            #add-point:ON ACTION controlp INFIELD xcag001
            {<point name="construct.c.xcag001" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcag001
            #add-point:BEFORE FIELD xcag001
            {<point name="construct.b.xcag001" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag001
            
            #add-point:AFTER FIELD xcag001
            {<point name="construct.a.xcag001" />}
            #END add-point
            
 
         #----<<xcag001_desc>>----
 
         
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table1 ON check,xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d, 
          xcag102e,xcag102f,xcag102g,xcag102h,xcagownid,xcagowndp,xcagcrtid,xcagcrtdp,xcagcrtdt,xcagmodid, 
          xcagmoddt
           FROM s_detail1[1].check,s_detail1[1].xcag004,s_detail1[1].xcag002,s_detail1[1].xcag003,s_detail1[1].xcag102, 
               s_detail1[1].xcag102a,s_detail1[1].xcag102b,s_detail1[1].xcag102c,s_detail1[1].xcag102d, 
               s_detail1[1].xcag102e,s_detail1[1].xcag102f,s_detail1[1].xcag102g,s_detail1[1].xcag102h, 
               s_detail2[1].xcagownid,s_detail2[1].xcagowndp,s_detail2[1].xcagcrtid,s_detail2[1].xcagcrtdp, 
               s_detail2[1].xcagcrtdt,s_detail2[1].xcagmodid,s_detail2[1].xcagmoddt
                      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct
            {<point name="cs.body.before_construct"/>}
            #end add-point 
            
         #單身公用欄位開窗相關處理
         #此段落由子樣板a11產生
         ##----<<xcagownid>>----
         #ON ACTION controlp INFIELD xcagownid
         #   CALL q_common('xcag_t','xcagownid',TRUE,FALSE,g_xcag2_d[1].xcagownid) RETURNING ls_return
         #   DISPLAY ls_return TO xcagownid
         #   NEXT FIELD xcagownid  
         #
         ##----<<xcagowndp>>----
         #ON ACTION controlp INFIELD xcagowndp
         #   CALL q_common('xcag_t','xcagowndp',TRUE,FALSE,g_xcag2_d[1].xcagowndp) RETURNING ls_return
         #   DISPLAY ls_return TO xcagowndp
         #   NEXT FIELD xcagowndp
         #
         ##----<<xcagcrtid>>----
         #ON ACTION controlp INFIELD xcagcrtid
         #   CALL q_common('xcag_t','xcagcrtid',TRUE,FALSE,g_xcag2_d[1].xcagcrtid) RETURNING ls_return
         #   DISPLAY ls_return TO xcagcrtid
         #   NEXT FIELD xcagcrtid
         #
         ##----<<xcagcrtdp>>----
         #ON ACTION controlp INFIELD xcagcrtdp
         #   CALL q_common('xcag_t','xcagcrtdp',TRUE,FALSE,g_xcag2_d[1].xcagcrtdp) RETURNING ls_return
         #   DISPLAY ls_return TO xcagcrtdp
         #   NEXT FIELD xcagcrtdp
         #
         ##----<<xcagmodid>>----
         #ON ACTION controlp INFIELD xcagmodid
         #   CALL q_common('xcag_t','xcagmodid',TRUE,FALSE,g_xcag2_d[1].xcagmodid) RETURNING ls_return
         #   DISPLAY ls_return TO xcagmodid
         #   NEXT FIELD xcagmodid
         #
         ##----<<xcagcnfid>>----
         ##ON ACTION controlp INFIELD xcagcnfid
         ##   CALL q_common('xcag_t','xcagcnfid',TRUE,FALSE,.xcagcnfid) RETURNING ls_return
         ##   DISPLAY ls_return TO xcagcnfid
         ##   NEXT FIELD xcagcnfid
         #
         ##----<<xcagpstid>>----
         ##ON ACTION controlp INFIELD xcagpstid
         ##   CALL q_common('xcag_t','xcagpstid',TRUE,FALSE,.xcagpstid) RETURNING ls_return
         ##   DISPLAY ls_return TO xcagpstid
         ##   NEXT FIELD xcagpstid
         
         ##----<<xcagcrtdt>>----
         AFTER FIELD xcagcrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<xcagmoddt>>----
         AFTER FIELD xcagmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<xcagcnfdt>>----
         #AFTER FIELD xcagcnfdt
         #   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         #   IF NOT cl_null(ls_result) THEN
         #      IF NOT cl_chk_date_symbol(ls_result) THEN
         #         LET ls_result = cl_add_date_extra_cond(ls_result)
         #      END IF
         #   END IF
         #   CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<xcagpstdt>>----
         #AFTER FIELD xcagpstdt
         #   CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
         #   IF NOT cl_null(ls_result) THEN
         #      IF NOT cl_chk_date_symbol(ls_result) THEN
         #         LET ls_result = cl_add_date_extra_cond(ls_result)
         #      END IF
         #   END IF
         #   CALL FGL_DIALOG_SETBUFFER(ls_result)
 
 
           
         #單身一般欄位開窗相關處理
         #---------------------<  Detail: page1  >---------------------
         #----<<check>>----
         #此段落由子樣板a01產生
         BEFORE FIELD check
            #add-point:BEFORE FIELD check
            {<point name="construct.b.page1.check" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD check
            
            #add-point:AFTER FIELD check
            {<point name="construct.a.page1.check" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.check
         ON ACTION controlp INFIELD check
            #add-point:ON ACTION controlp INFIELD check
            {<point name="construct.c.page1.check" />}
            #END add-point
 
         #----<<xcag004>>----
         #Ctrlp:construct.c.page1.xcag004
         ON ACTION controlp INFIELD xcag004
            #add-point:ON ACTION controlp INFIELD xcag004
            {<point name="construct.c.page1.xcag004" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcag004
            #add-point:BEFORE FIELD xcag004
            {<point name="construct.b.page1.xcag004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag004
            
            #add-point:AFTER FIELD xcag004
            {<point name="construct.a.page1.xcag004" />}
            #END add-point
            
 
         #----<<xcag002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag002
            #add-point:BEFORE FIELD xcag002
            {<point name="construct.b.page1.xcag002" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag002
            
            #add-point:AFTER FIELD xcag002
            {<point name="construct.a.page1.xcag002" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag002
         ON ACTION controlp INFIELD xcag002
            #add-point:ON ACTION controlp INFIELD xcag002
            {<point name="construct.c.page1.xcag002" />}
            #END add-point
 
         #----<<xcag003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag003
            #add-point:BEFORE FIELD xcag003
            {<point name="construct.b.page1.xcag003" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag003
            
            #add-point:AFTER FIELD xcag003
            {<point name="construct.a.page1.xcag003" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag003
         ON ACTION controlp INFIELD xcag003
            #add-point:ON ACTION controlp INFIELD xcag003
            {<point name="construct.c.page1.xcag003" />}
            #END add-point
 
         #----<<xcag102>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102
            #add-point:BEFORE FIELD xcag102
            {<point name="construct.b.page1.xcag102" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102
            
            #add-point:AFTER FIELD xcag102
            {<point name="construct.a.page1.xcag102" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102
         ON ACTION controlp INFIELD xcag102
            #add-point:ON ACTION controlp INFIELD xcag102
            {<point name="construct.c.page1.xcag102" />}
            #END add-point
 
         #----<<xcag102a>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102a
            #add-point:BEFORE FIELD xcag102a
            {<point name="construct.b.page1.xcag102a" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102a
            
            #add-point:AFTER FIELD xcag102a
            {<point name="construct.a.page1.xcag102a" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102a
         ON ACTION controlp INFIELD xcag102a
            #add-point:ON ACTION controlp INFIELD xcag102a
            {<point name="construct.c.page1.xcag102a" />}
            #END add-point
 
         #----<<xcag102b>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102b
            #add-point:BEFORE FIELD xcag102b
            {<point name="construct.b.page1.xcag102b" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102b
            
            #add-point:AFTER FIELD xcag102b
            {<point name="construct.a.page1.xcag102b" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102b
         ON ACTION controlp INFIELD xcag102b
            #add-point:ON ACTION controlp INFIELD xcag102b
            {<point name="construct.c.page1.xcag102b" />}
            #END add-point
 
         #----<<xcag102c>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102c
            #add-point:BEFORE FIELD xcag102c
            {<point name="construct.b.page1.xcag102c" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102c
            
            #add-point:AFTER FIELD xcag102c
            {<point name="construct.a.page1.xcag102c" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102c
         ON ACTION controlp INFIELD xcag102c
            #add-point:ON ACTION controlp INFIELD xcag102c
            {<point name="construct.c.page1.xcag102c" />}
            #END add-point
 
         #----<<xcag102d>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102d
            #add-point:BEFORE FIELD xcag102d
            {<point name="construct.b.page1.xcag102d" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102d
            
            #add-point:AFTER FIELD xcag102d
            {<point name="construct.a.page1.xcag102d" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102d
         ON ACTION controlp INFIELD xcag102d
            #add-point:ON ACTION controlp INFIELD xcag102d
            {<point name="construct.c.page1.xcag102d" />}
            #END add-point
 
         #----<<xcag102e>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102e
            #add-point:BEFORE FIELD xcag102e
            {<point name="construct.b.page1.xcag102e" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102e
            
            #add-point:AFTER FIELD xcag102e
            {<point name="construct.a.page1.xcag102e" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102e
         ON ACTION controlp INFIELD xcag102e
            #add-point:ON ACTION controlp INFIELD xcag102e
            {<point name="construct.c.page1.xcag102e" />}
            #END add-point
 
         #----<<xcag102f>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102f
            #add-point:BEFORE FIELD xcag102f
            {<point name="construct.b.page1.xcag102f" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102f
            
            #add-point:AFTER FIELD xcag102f
            {<point name="construct.a.page1.xcag102f" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102f
         ON ACTION controlp INFIELD xcag102f
            #add-point:ON ACTION controlp INFIELD xcag102f
            {<point name="construct.c.page1.xcag102f" />}
            #END add-point
 
         #----<<xcag102g>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102g
            #add-point:BEFORE FIELD xcag102g
            {<point name="construct.b.page1.xcag102g" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102g
            
            #add-point:AFTER FIELD xcag102g
            {<point name="construct.a.page1.xcag102g" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102g
         ON ACTION controlp INFIELD xcag102g
            #add-point:ON ACTION controlp INFIELD xcag102g
            {<point name="construct.c.page1.xcag102g" />}
            #END add-point
 
         #----<<xcag102h>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102h
            #add-point:BEFORE FIELD xcag102h
            {<point name="construct.b.page1.xcag102h" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102h
            
            #add-point:AFTER FIELD xcag102h
            {<point name="construct.a.page1.xcag102h" />}
            #END add-point
            
 
         #Ctrlp:construct.c.page1.xcag102h
         ON ACTION controlp INFIELD xcag102h
            #add-point:ON ACTION controlp INFIELD xcag102h
            {<point name="construct.c.page1.xcag102h" />}
            #END add-point
 
#---------------------<  Detail: page2  >---------------------
         #----<<xcagownid>>----
         #Ctrlp:construct.c.page2.xcagownid
         ON ACTION controlp INFIELD xcagownid
            #add-point:ON ACTION controlp INFIELD xcagownid
            {<point name="construct.c.page2.xcagownid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagownid
            #add-point:BEFORE FIELD xcagownid
            {<point name="construct.b.page2.xcagownid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagownid
            
            #add-point:AFTER FIELD xcagownid
            {<point name="construct.a.page2.xcagownid" />}
            #END add-point
            
 
         #----<<xcagownid_desc>>----
         #----<<xcagowndp>>----
         #Ctrlp:construct.c.page2.xcagowndp
         ON ACTION controlp INFIELD xcagowndp
            #add-point:ON ACTION controlp INFIELD xcagowndp
            {<point name="construct.c.page2.xcagowndp" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagowndp
            #add-point:BEFORE FIELD xcagowndp
            {<point name="construct.b.page2.xcagowndp" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagowndp
            
            #add-point:AFTER FIELD xcagowndp
            {<point name="construct.a.page2.xcagowndp" />}
            #END add-point
            
 
         #----<<xcagowndp_desc>>----
         #----<<xcagcrtid>>----
         #Ctrlp:construct.c.page2.xcagcrtid
         ON ACTION controlp INFIELD xcagcrtid
            #add-point:ON ACTION controlp INFIELD xcagcrtid
            {<point name="construct.c.page2.xcagcrtid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagcrtid
            #add-point:BEFORE FIELD xcagcrtid
            {<point name="construct.b.page2.xcagcrtid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagcrtid
            
            #add-point:AFTER FIELD xcagcrtid
            {<point name="construct.a.page2.xcagcrtid" />}
            #END add-point
            
 
         #----<<xcagcrtid_desc>>----
         #----<<xcagcrtdp>>----
         #Ctrlp:construct.c.page2.xcagcrtdp
         ON ACTION controlp INFIELD xcagcrtdp
            #add-point:ON ACTION controlp INFIELD xcagcrtdp
            {<point name="construct.c.page2.xcagcrtdp" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagcrtdp
            #add-point:BEFORE FIELD xcagcrtdp
            {<point name="construct.b.page2.xcagcrtdp" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagcrtdp
            
            #add-point:AFTER FIELD xcagcrtdp
            {<point name="construct.a.page2.xcagcrtdp" />}
            #END add-point
            
 
         #----<<xcagcrtdp_desc>>----
         #----<<xcagcrtdt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcagcrtdt
            #add-point:BEFORE FIELD xcagcrtdt
            {<point name="construct.b.page2.xcagcrtdt" />}
            #END add-point
 
         #----<<xcagmodid>>----
         #Ctrlp:construct.c.page2.xcagmodid
         ON ACTION controlp INFIELD xcagmodid
            #add-point:ON ACTION controlp INFIELD xcagmodid
            {<point name="construct.c.page2.xcagmodid" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagmodid
            #add-point:BEFORE FIELD xcagmodid
            {<point name="construct.b.page2.xcagmodid" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcagmodid
            
            #add-point:AFTER FIELD xcagmodid
            {<point name="construct.a.page2.xcagmodid" />}
            #END add-point
            
 
         #----<<xcagmodid_desc>>----
         #----<<xcagmoddt>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcagmoddt
            #add-point:BEFORE FIELD xcagmoddt
            {<point name="construct.b.page2.xcagmoddt" />}
            #END add-point
 
   
       
      END CONSTRUCT
  
 
  
      #add-point:cs段more_construct
      {<point name="cs.more_construct"/>}
      #end add-point
 
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:ui_dialog段b_dialog
         {<point name="cs.before_dialog"/>}
         #end add-point
      
      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
    
      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG
   
   #add-point:cs段after_construct
   {<point name="cs.after_construct"/>}
   #end add-point
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
 
 
 
   
   LET g_current_row = 1
 
   IF INT_FLAG THEN
      RETURN
   END IF
   
   LET g_wc_filter = ""
 
END FUNCTION
]]>
  </section>
  <section id="axci006.default_search" ver="2" status="" src="s">
    <![CDATA[#+ 外部參數搜尋
PRIVATE FUNCTION axci006_default_search()
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   #add-point:default_search段define
   {<point name="default_search.define"/>}
   #end add-point  
   
   #add-point:default_search段開始前
   {<point name="default_search.before"/>}
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[1]) THEN
      LET ls_wc = ls_wc, " xcagsite = '", g_argv[1], "' AND "
   END IF
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " xcag001 = '", g_argv[02], "' AND "
   END IF
 
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      LET g_default = FALSE
      #預設查詢條件
      LET g_wc = cl_qbe_get_default_qryplan()
      IF cl_null(g_wc) THEN
         LET g_wc = " 1=1"
      END IF
   END IF
   
   #add-point:default_search段結束前
   {<point name="default_search.after"/>}
   #end add-point  
 
END FUNCTION
]]>
  </section>
  <section id="axci006.delete" ver="4" status="" src="s">
    <![CDATA[#+ 資料刪除
PRIVATE FUNCTION axci006_delete()
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define
   {<point name="delete.define"/>}
   #end add-point     
   
   IF g_xcag_m.xcagsite IS NULL
   OR g_xcag_m.xcag001 IS NULL
 
   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF
 
   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp, 
       g_xcag_m.xcag011,g_xcag_m.xcag001
   
   CALL axci006_show()
   
   CALL s_transaction_begin()
   
   
 
   OPEN axci006_cl USING g_enterprise,g_xcag_m.xcagsite
                                                       ,g_xcag_m.xcag001
 
   IF STATUS THEN
      CALL cl_err("OPEN axci006_cl:", STATUS, 1)
      CLOSE axci006_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH axci006_cl INTO g_xcag_m.xcagsite,g_xcag_m.xcagsite_desc,g_xcag_m.xcagcomp,g_xcag_m.xcagcomp_desc, 
       g_xcag_m.xcag011,g_xcag_m.xcag011_desc,g_xcag_m.xcag001,g_xcag_m.xcag001_desc
   
   #若資料已被他人LOCK
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_xcag_m.xcagsite,SQLCA.sqlcode,0)
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #IF NOT cl_ask_delete() THEN             #確認一下
   IF cl_ask_del_master() THEN              #確認一下
      #+ 此段落由子樣板a47產生
      #刪除相關文件
      CALL axci006_set_pk_array()
      #add-point:相關文件刪除前
      {<point name="delete.befroe.related_document_remove"/>}
      #end add-point   
      CALL cl_doc_remove()  
 
  
 
      #add-point:單身刪除前
      {<point name="delete.body.b_delete" mark="Y"/>}
      #end add-point
      
      DELETE FROM xcag_t WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite
                                                               AND xcag001 = g_xcag_m.xcag001
 
                                                               
      #add-point:單身刪除中
      {<point name="delete.body.m_delete"/>}
      #end add-point
      
      IF SQLCA.sqlcode THEN
         CALL cl_err("xcag_t",SQLCA.sqlcode,0)
         CALL s_transaction_end('N','0')
      END IF
 
      
  
      #add-point:單身刪除後 
      {<point name="delete.body.a_delete"/>}
      #end add-point
      
 
      
      CLEAR FORM
      CALL g_xcag_d.clear() 
      CALL g_xcag2_d.clear()       
 
     
      CALL axci006_ui_browser_refresh()  
      CALL axci006_ui_headershow()  
      CALL axci006_ui_detailshow()
       
      IF g_browser_cnt > 0 THEN 
         CALL axci006_fetch('P')
      ELSE
         LET g_wc = " 1=1"
         LET g_wc2 = " 1=1"
         CALL axci006_browser_fill("F")
      END IF
       
   END IF
 
   CLOSE axci006_cl
   CALL s_transaction_end('Y','0')
 
   #流程通知預埋點-D
   CALL cl_flow_notify(g_xcag_m.xcagsite,'D')
    
END FUNCTION
]]>
  </section>
  <section id="axci006.delete_b" ver="1" status="" src="s">
    <![CDATA[#+ 刪除單身後其他table連動
PRIVATE FUNCTION axci006_delete_b(ps_table,ps_keys_bak,ps_page)
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   #add-point:delete_b段define
   {<point name="delete_b.define"/>}
   #end add-point     
 
 
   
END FUNCTION
]]>
  </section>
  <section id="axci006.description" ver="114" status="" src="s">
    <![CDATA[#+ Version..: T100-ERP-1.00.00(SD版次:3,PR版次:3) Build-000126
#+ 
#+ Filename...: axci006
#+ Description: 料件標準成本維護作業
#+ Creator....: 02291(2014/03/26)
#+ Modifier...: 02291(2014/07/03)
#+ Buildtype..: 應用 i00 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
  </section>
  <section id="axci006.detail_reproduce" ver="2" status="" src="s">
    <![CDATA[#+ 單身自動複製
PRIVATE FUNCTION axci006_detail_reproduce()
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE xcag_t.*
 
 
   #add-point:delete段define
   {<point name="detail_reproduce.define"/>}
   #end add-point    
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE axci006_detail
   
   #add-point:單身複製前1
   {<point name="detail_reproduce.body.table1.b_insert" mark="Y"/>}
   #end add-point
   
   #CREATE TEMP TABLE
   LET ls_sql = "CREATE GLOBAL TEMPORARY TABLE axci006_detail AS ",
                "SELECT * FROM xcag_t "
   PREPARE repro_tbl FROM ls_sql
   EXECUTE repro_tbl
   FREE repro_tbl
                
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO axci006_detail SELECT * FROM xcag_t 
                                         WHERE xcagent = g_enterprise AND xcagsite = g_xcagsite_t
                                         AND xcag001 = g_xcag001_t
 
   
   #將key修正為調整後   
   UPDATE axci006_detail 
      #更新key欄位
      SET xcagsite = g_xcag_m.xcagsite
          , xcag001 = g_xcag_m.xcag001
 
      #更新共用欄位
      #此段落由子樣板a13產生
       , xcagownid = g_user
       , xcagowndp = g_dept
       , xcagcrtid = g_user
       , xcagcrtdp = g_dept 
       , xcagcrtdt = ld_date
       , xcagmodid = "" 
       , xcagmoddt = "" 
      ##, xcagstus = "Y"
 
 
                                       
  
   #將資料塞回原table   
   INSERT INTO xcag_t SELECT * FROM axci006_detail
   
   IF SQLCA.sqlcode THEN
      CALL cl_err("reproduce",SQLCA.sqlcode,1)
      RETURN
   END IF
   
   #add-point:單身複製中1
   {<point name="detail_reproduce.body.table1.m_insert"/>}
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE axci006_detail
   
   #add-point:單身複製後1
   {<point name="detail_reproduce.body.table1.a_insert"/>}
   #end add-point
 
 
   
 
   
   #多語言複製段落
   
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001
 
   
   DROP TABLE axci006_detail
   
END FUNCTION
]]>
  </section>
  <section id="axci006.fetch" ver="4" status="" src="s">
    <![CDATA[#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION axci006_fetch(p_flag)
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define
   {<point name="fetch.define"/>}
   #end add-point    
   
   #add-point:fetch段動作開始前
   {<point name="fetch.before_fetch"/>}
   #end add-point    
 
   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt        
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,': ' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               EXIT CASE  
            END IF
            
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
            LET g_current_idx = g_jump
         END IF
 
         LET g_no_ask = FALSE  
   END CASE    
   
   #若無資料則離開
   IF g_current_idx = 0 THEN
      RETURN
   END IF
   
   CALL axci006_browser_fill(p_flag)
   
   LET g_detail_cnt = g_header_cnt                  
   
   #單身筆數顯示
   DISPLAY g_detail_cnt TO FORMONLY.cnt                      #設定page 總筆數 
   #LET g_detail_idx = 1
   IF g_detail_cnt > 0 THEN
      #LET g_detail_idx = 1
      DISPLAY g_detail_idx TO FORMONLY.idx  
   ELSE
      LET g_detail_idx = 0
      DISPLAY ' ' TO FORMONLY.idx    
   END IF
   
   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數
   
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #超出範圍
   IF g_current_idx > g_browser.getLength() THEN
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_xcag_m.xcagsite = g_browser[g_current_idx].b_xcagsite
   LET g_xcag_m.xcag001 = g_browser[g_current_idx].b_xcag001
 
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp, 
       g_xcag_m.xcag011,g_xcag_m.xcag001
   IF SQLCA.sqlcode THEN
      CALL cl_err("xcag_t",SQLCA.sqlcode,1)
      INITIALIZE g_xcag_m.* TO NULL
      RETURN
   END IF
   
   #LET g_data_owner =       
   #LET g_data_group =   
   
   #重新顯示   
   CALL axci006_show()
 
END FUNCTION
]]>
  </section>
  <section id="axci006.fill_chk" ver="1" status="" src="s">
    <![CDATA[#+ 單身填充確認
PRIVATE FUNCTION axci006_fill_chk(ps_idx)
   DEFINE ps_idx        LIKE type_t.chr10
   DEFINE lst_token     base.StringTokenizer
   DEFINE ls_token      STRING
   #add-point:fill_chk段define
   {<point name="fill_chk.define"/>}
   #end add-point
   
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1') THEN
      RETURN TRUE
   END IF
   
   #第一單身
   IF ps_idx = 1 AND
      ((NOT cl_null(g_wc2_table1) AND g_wc2_table1.trim() <> '1=1')) THEN
      RETURN TRUE
   END IF
   
   #根據wc判定是否需要填充
 
 
   
   #add-point:fill_chk段other
   {<point name="fill_chk.other"/>}
   #end add-point
   
   RETURN FALSE
 
END FUNCTION
]]>
  </section>
  <section id="axci006.filter" ver="1" status="" src="s">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION axci006_filter()
 
 
 
 
 
 
 
 
 
      #add-point:filter段add_cs
      {<point name="filter.add_cs"/>}
      #end add-point
 
         #add-point:filter段b_dialog
         {<point name="filter.b_dialog"/>}
         #end add-point  
 
 
 
   
 
 
END FUNCTION
]]>
  </section>
  <section id="axci006.filter_parser" ver="1" status="" src="s">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION axci006_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
 
 
 
 
 
END FUNCTION
]]>
  </section>
  <section id="axci006.global" ver="7" status="" src="s">
    <![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:free_style模組變數(Module Variable)
{<point name="free_style.variable"/>}
#end add-point
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
]]>
  </section>
  <section id="axci006.init" ver="1" status="" src="s">
    <![CDATA[#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION axci006_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point    
  
   LET g_bfill = "Y"
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
   
   
   LET g_error_show = 1
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #add-point:畫面資料初始化
   {<point name="init.init"/>}
   #end add-point
   
   CALL axci006_default_search()
    
END FUNCTION
]]>
  </section>
  <section id="axci006.input" ver="3" status="" src="s">
    <![CDATA[#+ 資料輸入
PRIVATE FUNCTION axci006_input(p_cmd)
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_ac_t                LIKE type_t.num5                #未取消的ARRAY CNT 
   DEFINE  l_n                   LIKE type_t.num5                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num5                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num5
   DEFINE  l_i                   LIKE type_t.num5
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num5
   DEFINE  li_reproduce_target   LIKE type_t.num5
   #add-point:input段define
   {<point name="input.define"/>}
   #end add-point    
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF  
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql
   {<point name="input.define_sql" mark="Y"/>}
   #end add-point 
   LET g_forupd_sql = "SELECT '',xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d, 
       xcag102e,xcag102f,xcag102g,xcag102h,'','',xcagownid,'',xcagowndp,'',xcagcrtid,'',xcagcrtdp,'', 
       xcagcrtdt,xcagmodid,'',xcagmoddt FROM xcag_t WHERE xcagent=? AND xcagsite=? AND xcag001=? AND  
       xcag002=? AND xcag004=? FOR UPDATE"
   #add-point:input段define_sql
   {<point name="input.after_define_sql"/>}
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   DECLARE axci006_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR
 
 
   
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL axci006_set_entry(p_cmd)
   #add-point:set_entry後
   {<point name="input.after_set_entry"/>}
   #end add-point
   CALL axci006_set_no_entry(p_cmd)
   #add-point:set_no_entry後
   {<point name="input.after_set_no_entry"/>}
   #end add-point
 
   DISPLAY BY NAME g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001
   
   LET lb_reproduce = FALSE
   
   #add-point:進入修改段前
   {<point name="input.before_input"/>}
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
]]>
  </section>
  <section id="axci006.input.body" ver="13" status="" src="s">
    <![CDATA[      #Page1 預設值產生於此處
      INPUT ARRAY g_xcag_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                  INSERT ROW = FALSE,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂單身ACTION
         
 
         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_xcag_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL axci006_b_fill(g_wc2) 
            IF g_rec_b != 0 THEN
               CALL fgl_set_arr_curr(l_ac)
            END IF
            #add-point:資料輸入前
            {<point name="input.body.before_input"/>}
            #end add-point
         
         BEFORE ROW
            LET l_insert = FALSE
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
            LET l_ac = ARR_CURR()
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            
         
            CALL s_transaction_begin()
            
            #判定新增或修改
            IF l_cmd = 'u' THEN
               OPEN axci006_cl USING g_enterprise,
                                               g_xcag_m.xcagsite
                                               ,g_xcag_m.xcag001
 
                                               
               IF STATUS THEN
                  CALL cl_err("OPEN axci006_cl:", STATUS, 1)
                  CLOSE axci006_cl
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
            END IF
            
            LET l_cmd = ''
            
            IF g_rec_b >= l_ac 
               AND g_xcag_d[l_ac].xcag002 IS NOT NULL
               AND g_xcag_d[l_ac].xcag004 IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_xcag_d_t.* = g_xcag_d[l_ac].*  #BACKUP
               CALL axci006_set_entry_b(l_cmd)
               #add-point:set_entry_b後
               {<point name="input.body.before_row.set_entry_b"/>}
               #end add-point
               CALL axci006_set_no_entry_b(l_cmd)
               OPEN axci006_bcl USING g_enterprise,g_xcag_m.xcagsite,
                                                g_xcag_m.xcag001,
 
                                                g_xcag_d_t.xcag002
                                                ,g_xcag_d_t.xcag004
 
               IF STATUS THEN
                  CALL cl_err("OPEN axci006_bcl:", STATUS, 1)
                  LET l_lock_sw='Y'
               ELSE
                  FETCH axci006_bcl INTO g_xcag_d[l_ac].check,g_xcag_d[l_ac].xcag004,g_xcag_d[l_ac].xcag002, 
                      g_xcag_d[l_ac].xcag003,g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b, 
                      g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e,g_xcag_d[l_ac].xcag102f, 
                      g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h,g_xcag2_d[l_ac].xcag004,g_xcag2_d[l_ac].xcag002, 
                      g_xcag2_d[l_ac].xcagownid,g_xcag2_d[l_ac].xcagownid_desc,g_xcag2_d[l_ac].xcagowndp, 
                      g_xcag2_d[l_ac].xcagowndp_desc,g_xcag2_d[l_ac].xcagcrtid,g_xcag2_d[l_ac].xcagcrtid_desc, 
                      g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdp_desc,g_xcag2_d[l_ac].xcagcrtdt, 
                      g_xcag2_d[l_ac].xcagmodid,g_xcag2_d[l_ac].xcagmodid_desc,g_xcag2_d[l_ac].xcagmoddt 

                  IF SQLCA.sqlcode THEN
                      CALL cl_err(g_xcag_d_t.xcag002,SQLCA.sqlcode,1)
                      LET l_lock_sw = "Y"
                  END IF
                  
                  CALL axci006_ref_show()
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row
            {<point name="input.body.before_row"/>}
            #end add-point  
            
        
         BEFORE INSERT
            
            INITIALIZE g_xcag_d_t.* TO NULL
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_xcag_d[l_ac].* TO NULL
            
            #公用欄位預設值
            #此段落由子樣板a14產生    
      LET g_xcag2_d[l_ac].xcagownid = g_user
      LET g_xcag2_d[l_ac].xcagowndp = g_dept
      LET g_xcag2_d[l_ac].xcagcrtid = g_user
      LET g_xcag2_d[l_ac].xcagcrtdp = g_dept 
      LET g_xcag2_d[l_ac].xcagcrtdt = cl_get_current()
      LET g_xcag2_d[l_ac].xcagmodid = ""
      LET g_xcag2_d[l_ac].xcagmoddt = ""
      ##LET .xcagstus = ""
 
  
            
            #一般欄位預設值
                  LET g_xcag_d[l_ac].check = "N"
 
 
            
            
            LET g_xcag_d_t.* = g_xcag_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL axci006_set_entry_b(l_cmd)
            #add-point:set_entry_b後
            {<point name="input.body.before_insert.set_entry_b"/>}
            #end add-point
            CALL axci006_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_xcag_d[li_reproduce_target].* = g_xcag_d[li_reproduce].*
               LET g_xcag2_d[li_reproduce_target].* = g_xcag2_d[li_reproduce].*
 
               LET g_xcag_d[g_xcag_d.getLength()].xcag002 = NULL
               LET g_xcag_d[g_xcag_d.getLength()].xcag004 = NULL
 
            END IF
            
            #add-point:modify段before insert
            {<point name="input.body.before_insert"/>}
            #end add-point  
 
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            LET l_count = 1  
            SELECT COUNT(*) INTO l_count FROM xcag_t 
             WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite
               AND xcag001 = g_xcag_m.xcag001
 
               AND xcag002 = g_xcag_d[l_ac].xcag002
               AND xcag004 = g_xcag_d[l_ac].xcag004
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               CALL s_transaction_begin()
               #add-point:單身新增前
               {<point name="input.body.b_insert" mark="Y"/>}
               #end add-point
               INSERT INTO xcag_t
                           (xcagent,
                            xcagsite,xcagcomp,xcag011,xcag001,
                            xcag002,xcag004
                            ,xcag003,xcag102,xcag102a,xcag102b,xcag102c,xcag102d,xcag102e,xcag102f,xcag102g,xcag102h,xcagownid,xcagowndp,xcagcrtid,xcagcrtdp,xcagcrtdt,xcagmodid,xcagmoddt) 
                     VALUES(g_enterprise,
                            g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001,
                            g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag004
                            ,g_xcag_d[l_ac].xcag003,g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a,g_xcag_d[l_ac].xcag102b, 
                                g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e, 
                                g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h, 
                                g_xcag2_d[l_ac].xcagownid,g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagcrtid, 
                                g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdt,g_xcag2_d[l_ac].xcagmodid, 
                                g_xcag2_d[l_ac].xcagmoddt)
               #add-point:單身新增中
               {<point name="input.body.m_insert"/>}
               #end add-point
               LET p_cmd = 'u'
            ELSE    
               CALL cl_err('INSERT',"std-00006",1)
               INITIALIZE g_xcag_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLcode  THEN
               CALL cl_err("xcag_t",SQLCA.sqlcode,1)  
               CALL s_transaction_end('N','0')                    
               CANCEL INSERT
            ELSE
               #資料多語言用-增/改
               
               #add-point:input段-after_insert
               {<point name="input.body.a_insert"/>}
               #end add-point
               CALL s_transaction_end('Y','0')
               ERROR "INSERT O.K"
               LET g_rec_b=g_rec_b+1
               DISPLAY g_rec_b TO FORMONLY.cnt
            END IF
            
            #add-point:單身新增後
            {<point name="input.body.after_insert"/>}
            #end add-point
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' AND g_xcag_d.getLength() < l_ac THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_xcag_d.deleteElement(l_ac)
               NEXT FIELD xcag002
            END IF
            IF g_xcag_d_t.xcag002 IS NOT NULL
               AND g_xcag_d_t.xcag004 IS NOT NULL
 
               THEN
               
               #add-point:單身刪除前
               {<point name="input.body.b_delete"/>}
               #end add-point
               
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  CALL cl_err("", -263, 1)
                  CANCEL DELETE
               END IF
               IF axci006_before_delete() THEN 
                  CALL s_transaction_end('Y','0')
               ELSE 
                  CALL s_transaction_end('N','0')
                  CANCEL DELETE   
               END IF 
               CLOSE axci006_bcl
               LET l_count = g_xcag_d.getLength()
            END IF 
            
            #add-point:單身刪除後
            {<point name="input.body.a_delete"/>}
            #end add-point
              
         AFTER DELETE 
            #add-point:單身AFTER DELETE 
            {<point name="input.body.after_delete"/>}
            #end add-point
 
         #---------------------<  Detail: page1  >---------------------
         #----<<check>>----
         #此段落由子樣板a01產生
         BEFORE FIELD check
            #add-point:BEFORE FIELD check
            {<point name="input.b.page1.check" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD check
            
            #add-point:AFTER FIELD check
            {<point name="input.a.page1.check" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE check
            #add-point:ON CHANGE check
            {<point name="input.g.page1.check" />}
            #END add-point
 
         #----<<xcag004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag004
            #add-point:BEFORE FIELD xcag004
            {<point name="input.b.page1.xcag004" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag004
            
            #add-point:AFTER FIELD xcag004
            {<point name="input.a.page1.xcag004" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag004
            #add-point:ON CHANGE xcag004
            {<point name="input.g.page1.xcag004" />}
            #END add-point
 
         #----<<xcag002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag002
            #add-point:BEFORE FIELD xcag002
            {<point name="input.b.page1.xcag002" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag002
            
            #add-point:AFTER FIELD xcag002
            {<point name="input.a.page1.xcag002" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag002
            #add-point:ON CHANGE xcag002
            {<point name="input.g.page1.xcag002" />}
            #END add-point
 
         #----<<xcag003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag003
            #add-point:BEFORE FIELD xcag003
            {<point name="input.b.page1.xcag003" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag003
            
            #add-point:AFTER FIELD xcag003
            {<point name="input.a.page1.xcag003" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag003
            #add-point:ON CHANGE xcag003
            {<point name="input.g.page1.xcag003" />}
            #END add-point
 
         #----<<xcag102>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102
            #add-point:BEFORE FIELD xcag102
            {<point name="input.b.page1.xcag102" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102
            
            #add-point:AFTER FIELD xcag102
            {<point name="input.a.page1.xcag102" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102
            #add-point:ON CHANGE xcag102
            {<point name="input.g.page1.xcag102" />}
            #END add-point
 
         #----<<xcag102a>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102a
            #add-point:BEFORE FIELD xcag102a
            {<point name="input.b.page1.xcag102a" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102a
            
            #add-point:AFTER FIELD xcag102a
            {<point name="input.a.page1.xcag102a" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102a
            #add-point:ON CHANGE xcag102a
            {<point name="input.g.page1.xcag102a" />}
            #END add-point
 
         #----<<xcag102b>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102b
            #add-point:BEFORE FIELD xcag102b
            {<point name="input.b.page1.xcag102b" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102b
            
            #add-point:AFTER FIELD xcag102b
            {<point name="input.a.page1.xcag102b" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102b
            #add-point:ON CHANGE xcag102b
            {<point name="input.g.page1.xcag102b" />}
            #END add-point
 
         #----<<xcag102c>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102c
            #add-point:BEFORE FIELD xcag102c
            {<point name="input.b.page1.xcag102c" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102c
            
            #add-point:AFTER FIELD xcag102c
            {<point name="input.a.page1.xcag102c" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102c
            #add-point:ON CHANGE xcag102c
            {<point name="input.g.page1.xcag102c" />}
            #END add-point
 
         #----<<xcag102d>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102d
            #add-point:BEFORE FIELD xcag102d
            {<point name="input.b.page1.xcag102d" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102d
            
            #add-point:AFTER FIELD xcag102d
            {<point name="input.a.page1.xcag102d" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102d
            #add-point:ON CHANGE xcag102d
            {<point name="input.g.page1.xcag102d" />}
            #END add-point
 
         #----<<xcag102e>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102e
            #add-point:BEFORE FIELD xcag102e
            {<point name="input.b.page1.xcag102e" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102e
            
            #add-point:AFTER FIELD xcag102e
            {<point name="input.a.page1.xcag102e" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102e
            #add-point:ON CHANGE xcag102e
            {<point name="input.g.page1.xcag102e" />}
            #END add-point
 
         #----<<xcag102f>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102f
            #add-point:BEFORE FIELD xcag102f
            {<point name="input.b.page1.xcag102f" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102f
            
            #add-point:AFTER FIELD xcag102f
            {<point name="input.a.page1.xcag102f" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102f
            #add-point:ON CHANGE xcag102f
            {<point name="input.g.page1.xcag102f" />}
            #END add-point
 
         #----<<xcag102g>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102g
            #add-point:BEFORE FIELD xcag102g
            {<point name="input.b.page1.xcag102g" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102g
            
            #add-point:AFTER FIELD xcag102g
            {<point name="input.a.page1.xcag102g" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102g
            #add-point:ON CHANGE xcag102g
            {<point name="input.g.page1.xcag102g" />}
            #END add-point
 
         #----<<xcag102h>>----
         #此段落由子樣板a01產生
         BEFORE FIELD xcag102h
            #add-point:BEFORE FIELD xcag102h
            {<point name="input.b.page1.xcag102h" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD xcag102h
            
            #add-point:AFTER FIELD xcag102h
            {<point name="input.a.page1.xcag102h" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE xcag102h
            #add-point:ON CHANGE xcag102h
            {<point name="input.g.page1.xcag102h" />}
            #END add-point
 
 
         #---------------------<  Detail: page1  >---------------------
         #----<<check>>----
         #Ctrlp:input.c.page1.check
         ON ACTION controlp INFIELD check
            #add-point:ON ACTION controlp INFIELD check
            {<point name="input.c.page1.check" />}
            #END add-point
 
         #----<<xcag004>>----
         #Ctrlp:input.c.page1.xcag004
         ON ACTION controlp INFIELD xcag004
            #add-point:ON ACTION controlp INFIELD xcag004
            {<point name="input.c.page1.xcag004" />}
            #END add-point
 
         #----<<xcag002>>----
         #Ctrlp:input.c.page1.xcag002
         ON ACTION controlp INFIELD xcag002
            #add-point:ON ACTION controlp INFIELD xcag002
            {<point name="input.c.page1.xcag002" />}
            #END add-point
 
         #----<<xcag003>>----
         #Ctrlp:input.c.page1.xcag003
         ON ACTION controlp INFIELD xcag003
            #add-point:ON ACTION controlp INFIELD xcag003
            {<point name="input.c.page1.xcag003" />}
            #END add-point
 
         #----<<xcag102>>----
         #Ctrlp:input.c.page1.xcag102
         ON ACTION controlp INFIELD xcag102
            #add-point:ON ACTION controlp INFIELD xcag102
            {<point name="input.c.page1.xcag102" />}
            #END add-point
 
         #----<<xcag102a>>----
         #Ctrlp:input.c.page1.xcag102a
         ON ACTION controlp INFIELD xcag102a
            #add-point:ON ACTION controlp INFIELD xcag102a
            {<point name="input.c.page1.xcag102a" />}
            #END add-point
 
         #----<<xcag102b>>----
         #Ctrlp:input.c.page1.xcag102b
         ON ACTION controlp INFIELD xcag102b
            #add-point:ON ACTION controlp INFIELD xcag102b
            {<point name="input.c.page1.xcag102b" />}
            #END add-point
 
         #----<<xcag102c>>----
         #Ctrlp:input.c.page1.xcag102c
         ON ACTION controlp INFIELD xcag102c
            #add-point:ON ACTION controlp INFIELD xcag102c
            {<point name="input.c.page1.xcag102c" />}
            #END add-point
 
         #----<<xcag102d>>----
         #Ctrlp:input.c.page1.xcag102d
         ON ACTION controlp INFIELD xcag102d
            #add-point:ON ACTION controlp INFIELD xcag102d
            {<point name="input.c.page1.xcag102d" />}
            #END add-point
 
         #----<<xcag102e>>----
         #Ctrlp:input.c.page1.xcag102e
         ON ACTION controlp INFIELD xcag102e
            #add-point:ON ACTION controlp INFIELD xcag102e
            {<point name="input.c.page1.xcag102e" />}
            #END add-point
 
         #----<<xcag102f>>----
         #Ctrlp:input.c.page1.xcag102f
         ON ACTION controlp INFIELD xcag102f
            #add-point:ON ACTION controlp INFIELD xcag102f
            {<point name="input.c.page1.xcag102f" />}
            #END add-point
 
         #----<<xcag102g>>----
         #Ctrlp:input.c.page1.xcag102g
         ON ACTION controlp INFIELD xcag102g
            #add-point:ON ACTION controlp INFIELD xcag102g
            {<point name="input.c.page1.xcag102g" />}
            #END add-point
 
         #----<<xcag102h>>----
         #Ctrlp:input.c.page1.xcag102h
         ON ACTION controlp INFIELD xcag102h
            #add-point:ON ACTION controlp INFIELD xcag102h
            {<point name="input.c.page1.xcag102h" />}
            #END add-point
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_xcag_d[l_ac].* = g_xcag_d_t.*
               CLOSE axci006_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_xcag_d[l_ac].xcag002,-263,1)
               LET g_xcag_d[l_ac].* = g_xcag_d_t.*
            ELSE
               #寫入修改者/修改日期資訊
               LET g_xcag2_d[l_ac].xcagmodid = g_user 
LET g_xcag2_d[l_ac].xcagmoddt = cl_get_current()
 
            
               #add-point:單身修改前
               {<point name="input.body.b_update" mark="Y"/>}
               #end add-point
         
               UPDATE xcag_t SET (xcagsite,xcag001,xcag004,xcag002,xcag003,xcag102,xcag102a,xcag102b, 
                   xcag102c,xcag102d,xcag102e,xcag102f,xcag102g,xcag102h,xcagownid,xcagowndp,xcagcrtid, 
                   xcagcrtdp,xcagcrtdt,xcagmodid,xcagmoddt) = (g_xcag_m.xcagsite,g_xcag_m.xcag001,g_xcag_d[l_ac].xcag004, 
                   g_xcag_d[l_ac].xcag002,g_xcag_d[l_ac].xcag003,g_xcag_d[l_ac].xcag102,g_xcag_d[l_ac].xcag102a, 
                   g_xcag_d[l_ac].xcag102b,g_xcag_d[l_ac].xcag102c,g_xcag_d[l_ac].xcag102d,g_xcag_d[l_ac].xcag102e, 
                   g_xcag_d[l_ac].xcag102f,g_xcag_d[l_ac].xcag102g,g_xcag_d[l_ac].xcag102h,g_xcag2_d[l_ac].xcagownid, 
                   g_xcag2_d[l_ac].xcagowndp,g_xcag2_d[l_ac].xcagcrtid,g_xcag2_d[l_ac].xcagcrtdp,g_xcag2_d[l_ac].xcagcrtdt, 
                   g_xcag2_d[l_ac].xcagmodid,g_xcag2_d[l_ac].xcagmoddt)
                WHERE xcagent = g_enterprise AND xcagsite = g_xcag_m.xcagsite 
                 AND xcag001 = g_xcag_m.xcag001 
 
                 AND xcag002 = g_xcag_d_t.xcag002 #項次   
                 AND xcag004 = g_xcag_d_t.xcag004  
 
                 
               #add-point:單身修改中
               {<point name="input.body.m_update"/>}
               #end add-point
               
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     CALL cl_err("xcag_t","std-00009",1)
                     CALL s_transaction_end('N','0')
                  #WHEN SQLCA.sqlcode #其他錯誤
                  #   CALL cl_err("xcag_t",SQLCA.sqlcode,1)  
                  #   CALL s_transaction_end('N','0')
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_xcag_m.xcagsite
               LET gs_keys_bak[1] = g_xcagsite_t
               LET gs_keys[2] = g_xcag_m.xcag001
               LET gs_keys_bak[2] = g_xcag001_t
               LET gs_keys[3] = g_xcag_d[g_detail_idx].xcag002
               LET gs_keys_bak[3] = g_xcag_d_t.xcag002
               LET gs_keys[4] = g_xcag_d[g_detail_idx].xcag004
               LET gs_keys_bak[4] = g_xcag_d_t.xcag004
               CALL axci006_update_b('xcag_t',gs_keys,gs_keys_bak,"'1'")
                     #資料多語言用-增/改
                     
               END CASE
               
               #add-point:單身修改後
               {<point name="input.body.a_update"/>}
               #end add-point
            END IF
 
         AFTER INPUT
            #若單身還沒有輸入資料, 強制切換至單身
            IF cl_null(g_xcag_d[1].xcag002) THEN
               CALL g_xcag_d.deleteElement(1)
               NEXT FIELD xcag002
            END IF
            #add-point:input段after input 
            {<point name="input.body.after_input"/>}
            #end add-point    
            
         ON ACTION controlo   
            CALL FGL_SET_ARR_CURR(g_xcag_d.getLength()+1)
            LET lb_reproduce = TRUE
            LET li_reproduce = l_ac
            LET li_reproduce_target = g_xcag_d.getLength()+1
            
      END INPUT
 
 
      
      DISPLAY ARRAY g_xcag2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
      
         BEFORE ROW
            CALL axci006_b_fill(g_wc2) 
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
            LET l_ac = g_detail_idx
            DISPLAY g_detail_idx TO FORMONLY.idx
            CALL axci006_ui_detailshow()
        
         BEFORE DISPLAY 
            CALL FGL_SET_ARR_CURR(g_detail_idx)      
         
         #add-point:page2自定義行為
         {<point name="input.body2.action"/>}
         #end add-point
         
      END DISPLAY
 
      
 
      
      #add-point:input段more_input
      {<point name="input.more_inputarray"/>}
      #end add-point    
      
      BEFORE DIALOG
         #add-point:input段before_dialog
         {<point name="input.before_dialog"/>}
         #end add-point 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            NEXT FIELD xcagsite
        ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD check
               WHEN "s_detail2"
                  NEXT FIELD xcag004_2
 
            END CASE
         END IF
   
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         LET g_action_choice=""
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
   
   #add-point:input段after_input
   {<point name="input.after_input"/>}
   #end add-point  
   
END FUNCTION
]]>
  </section>
  <section id="axci006.input.head" ver="4" status="" src="s">
    <![CDATA[   
      #單頭段
      INPUT BY NAME g_xcag_m.xcagsite,g_xcag_m.xcagcomp,g_xcag_m.xcag011,g_xcag_m.xcag001 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂單頭ACTION
         
         
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #add-point:單頭input前
            {<point name="input.head.b_input"/>}
            #end add-point
          
         #---------------------------<  Master  >---------------------------
         #----<<xcagsite>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcagsite
            
            #add-point:AFTER FIELD xcagsite
            {<point name="input.a.xcagsite" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagsite
            #add-point:BEFORE FIELD xcagsite
            {<point name="input.b.xcagsite" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE xcagsite
            #add-point:ON CHANGE xcagsite
            {<point name="input.g.xcagsite" />}
            #END add-point
 
         #----<<xcagsite_desc>>----
         #----<<xcagcomp>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcagcomp
            
            #add-point:AFTER FIELD xcagcomp
            {<point name="input.a.xcagcomp" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcagcomp
            #add-point:BEFORE FIELD xcagcomp
            {<point name="input.b.xcagcomp" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE xcagcomp
            #add-point:ON CHANGE xcagcomp
            {<point name="input.g.xcagcomp" />}
            #END add-point
 
         #----<<xcagcomp_desc>>----
         #----<<xcag011>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcag011
            
            #add-point:AFTER FIELD xcag011
            {<point name="input.a.xcag011" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcag011
            #add-point:BEFORE FIELD xcag011
            {<point name="input.b.xcag011" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE xcag011
            #add-point:ON CHANGE xcag011
            {<point name="input.g.xcag011" />}
            #END add-point
 
         #----<<xcag011_desc>>----
         #----<<xcag001>>----
         #此段落由子樣板a02產生
         AFTER FIELD xcag001
            
            #add-point:AFTER FIELD xcag001
            {<point name="input.a.xcag001" />}
            #END add-point
            
 
         #此段落由子樣板a01產生
         BEFORE FIELD xcag001
            #add-point:BEFORE FIELD xcag001
            {<point name="input.b.xcag001" />}
            #END add-point
 
         #此段落由子樣板a04產生
         ON CHANGE xcag001
            #add-point:ON CHANGE xcag001
            {<point name="input.g.xcag001" />}
            #END add-point
 
         #----<<xcag001_desc>>----
 #欄位檢查
         #---------------------------<  Master  >---------------------------
         #----<<xcagsite>>----
         #Ctrlp:input.c.xcagsite
         ON ACTION controlp INFIELD xcagsite
            #add-point:ON ACTION controlp INFIELD xcagsite
            {<point name="input.c.xcagsite" />}
            #END add-point
 
         #----<<xcagsite_desc>>----
         #----<<xcagcomp>>----
         #Ctrlp:input.c.xcagcomp
         ON ACTION controlp INFIELD xcagcomp
            #add-point:ON ACTION controlp INFIELD xcagcomp
            {<point name="input.c.xcagcomp" />}
            #END add-point
 
         #----<<xcagcomp_desc>>----
         #----<<xcag011>>----
         #Ctrlp:input.c.xcag011
         ON ACTION controlp INFIELD xcag011
            #add-point:ON ACTION controlp INFIELD xcag011
            {<point name="input.c.xcag011" />}
            #END add-point
 
         #----<<xcag011_desc>>----
         #----<<xcag001>>----
         #Ctrlp:input.c.xcag001
         ON ACTION controlp INFIELD xcag001
            #add-point:ON ACTION controlp INFIELD xcag001
            {<point name="input.c.xcag001" />}
            #END add-point
 
         #----<<xcag001_desc>>----
 #欄位開窗
 
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
            
            IF s_transaction_chk("N",0) THEN
                CALL s_transaction_begin()
            END IF
 
            #多語言處理
            
                
            CALL cl_showmsg()
            DISPLAY BY NAME g_xcag_m.xcagsite             
                            ,g_xcag_m.xcag001   
 
 
            IF p_cmd = 'u' THEN
               #add-point:單頭修改前
               {<point name="input.head.b_update" mark="Y"/>}
               #end add-point
            
               UPDATE xcag_t SET (xcagsite,xcagcomp,xcag011,xcag001) = (g_xcag_m.xcagsite,g_xcag_m.xcagcomp, 
                   g_xcag_m.xcag011,g_xcag_m.xcag001)
                WHERE xcagent = g_enterprise AND xcagsite = g_xcagsite_t
                  AND xcag001 = g_xcag001_t
 
               #add-point:單頭修改中
               {<point name="input.head.m_update"/>}
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     CALL cl_err("xcag_t","std-00009",1)
                     CALL s_transaction_end('N','0')
                  WHEN SQLCA.sqlcode #其他錯誤
                     CALL cl_err("xcag_t",SQLCA.sqlcode,1)  
                     CALL s_transaction_end('N','0')
                  OTHERWISE
                     #資料多語言用-增/改
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_xcag_m.xcagsite
               LET gs_keys_bak[1] = g_xcagsite_t
               LET gs_keys[2] = g_xcag_m.xcag001
               LET gs_keys_bak[2] = g_xcag001_t
               LET gs_keys[3] = g_xcag_d[g_detail_idx].xcag002
               LET gs_keys_bak[3] = g_xcag_d_t.xcag002
               LET gs_keys[4] = g_xcag_d[g_detail_idx].xcag004
               LET gs_keys_bak[4] = g_xcag_d_t.xcag004
               CALL axci006_update_b('xcag_t',gs_keys,gs_keys_bak,"'1'")
                     
                     LET g_xcagsite_t = g_xcag_m.xcagsite
                     LET g_xcag001_t = g_xcag_m.xcag001
 
                     #add-point:單頭修改後
                     {<point name="input.head.a_update"/>}
                     #end add-point
                     CALL s_transaction_end('Y','0')
               END CASE
            
            ELSE    
               #add-point:單頭新增
               {<point name="input.head.a_insert"/>}
               #end add-point
                                 
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL axci006_detail_reproduce()
               END IF
            END IF
           #controlp
                     
           LET g_xcagsite_t = g_xcag_m.xcagsite
           LET g_xcag001_t = g_xcag_m.xcag001
 
           
           #若單身還沒有輸入資料, 強制切換至單身
           IF cl_null(g_xcag_d[1].xcag002) THEN
              CALL g_xcag_d.deleteElement(1)
              NEXT FIELD xcag002
           END IF
 
      END INPUT
]]>
  </section>
  <section id="axci006.insert" ver="2" status="" src="s">
    <![CDATA[#+ 資料新增
PRIVATE FUNCTION axci006_insert()
   #add-point:insert段define
   {<point name="insert.define"/>}
   #end add-point    
   
   #add-point:insert段before
   {<point name="insert.before"/>}
   #end add-point    
   
   #清除相關資料
   CLEAR FORM                    
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()
 
 
   INITIALIZE g_xcag_m.* LIKE xcag_t.*             #DEFAULT 設定
   LET g_xcagsite_t = NULL
   LET g_xcag001_t = NULL
 
   CALL s_transaction_begin()
   WHILE TRUE
     
      #單頭預設值
      
     
      #add-point:單頭預設值
      {<point name="insert.default"/>}
      #end add-point 
 
      CALL axci006_input("a")
      
      #add-point:單頭輸入後
      {<point name="insert.after_insert"/>}
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_xcag_m.* = g_xcag_m_t.*
         CALL axci006_show()
         CALL cl_err('',9001,0)
         EXIT WHILE
      END IF
      
      CALL g_xcag_d.clear()
      CALL g_xcag2_d.clear()
 
      
      #add-point:單頭輸入後2
      {<point name="insert.after_insert2"/>}
      #end add-point
 
      LET g_rec_b = 0
      EXIT WHILE
      
   END WHILE
   
   LET g_state = "Y"
   
   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001
 
   
   LET g_wc = g_wc,  
              " OR ( xcagent = '" ||g_enterprise|| "' AND ",
              " xcagsite = '", g_xcag_m.xcagsite CLIPPED, "' "
              ," AND xcag001 = '", g_xcag_m.xcag001 CLIPPED, "' "
 
              , ") "
   
END FUNCTION
]]>
  </section>
  <section id="axci006.insert_b" ver="1" status="" src="s">
    <![CDATA[#+ 新增單身後其他table連動
PRIVATE FUNCTION axci006_insert_b(ps_table,ps_keys,ps_page)
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   #add-point:insert_b段define
   {<point name="insert_b.define"/>}
   #end add-point     
   
 
   
END FUNCTION
]]>
  </section>
  <section id="axci006.lock_b" ver="1" status="" src="s">
    <![CDATA[#+ 連動lock其他單身table資料
PRIVATE FUNCTION axci006_lock_b(ps_table,ps_page)
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define
   {<point name="lock_b.define"/>}
   #end add-point   
   
   #先刷新資料
   #CALL axci006_b_fill()
   
 
   
   RETURN TRUE
 
END FUNCTION
]]>
  </section>
  <section id="axci006.main" ver="7" status="" src="s">
    <![CDATA[#+ 作業開始
MAIN
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point    
 
   #定義在其他link的程式則無效
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("axc","")
 
   #add-point:作業初始化
   {<point name="main.init"/>}
   #end add-point
 
   #add-point:SQL_define
   {<point name="main.define_sql" />}
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)    #轉換不同資料庫語法
   DECLARE axci006_cl CURSOR FROM g_forupd_sql 
   
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_axci006 WITH FORM cl_ap_formpath("axc",g_code)
   
      #程式初始化
      CALL axci006_init()
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #進入選單 Menu (='N')
      CALL axci006_ui_dialog()
   
      #畫面關閉
      CLOSE WINDOW w_axci006
   END IF
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
 
END MAIN
]]>
  </section>
  <section id="axci006.modify" ver="4" status="" src="s">
    <![CDATA[#+ 資料修改
PRIVATE FUNCTION axci006_modify()
   #add-point:modify段define
   {<point name="modify.define"/>}
   #end add-point    
   
   IF g_xcag_m.xcagsite IS NULL
   OR g_xcag_m.xcag001 IS NULL
 
   THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF
   
   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp, 
       g_xcag_m.xcag011,g_xcag_m.xcag001
 
   ERROR ""
  
   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001
 
   CALL s_transaction_begin()
   
   OPEN axci006_cl USING g_enterprise,g_xcag_m.xcagsite
                                                       ,g_xcag_m.xcag001
 
   IF STATUS THEN
      CALL cl_err("OPEN axci006_cl:", STATUS, 1)
      CLOSE axci006_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #鎖住將被更改或取消的資料
   FETCH axci006_cl INTO g_xcag_m.xcagsite,g_xcag_m.xcagsite_desc,g_xcag_m.xcagcomp,g_xcag_m.xcagcomp_desc, 
       g_xcag_m.xcag011,g_xcag_m.xcag011_desc,g_xcag_m.xcag001,g_xcag_m.xcag001_desc
 
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_xcag_m.xcagsite,SQLCA.sqlcode,0)
      CLOSE axci006_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL s_transaction_end('Y','0')
 
   CALL axci006_show()
   WHILE TRUE
      LET g_xcagsite_t = g_xcag_m.xcagsite
      LET g_xcag001_t = g_xcag_m.xcag001
 
 
      #add-point:modify段修改前
      {<point name="modify.before_input"/>}
      #end add-point
      
      CALL axci006_input("u")     #欄位更改
      
      #add-point:modify段修改後
      {<point name="modify.after_input"/>}
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_xcag_m.* = g_xcag_m_t.*
         CALL axci006_show()
         CALL cl_err('',9001,0)
         EXIT WHILE
      END IF
      
      #若單頭key欄位有變更
      IF g_xcag_m.xcagsite != g_xcagsite_t 
      OR g_xcag_m.xcag001 != g_xcag001_t 
 
      THEN
         CALL s_transaction_begin()
         
         #add-point:單頭(偽)修改前
         {<point name="modify.b_key_update" mark="Y"/>}
         #end add-point
         
         #更新單頭key值
         UPDATE xcag_t SET xcagsite = g_xcag_m.xcagsite
                                       , xcag001 = g_xcag_m.xcag001
 
          WHERE xcagent = g_enterprise AND xcagsite = g_xcagsite_t
            AND xcag001 = g_xcag001_t
 
         #add-point:單頭(偽)修改中
         {<point name="modify.m_key_update"/>}
         #end add-point
         
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
               CALL cl_err("xcag_t","std-00009",1)
               CALL s_transaction_end('N','0')
               CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               CALL cl_err("xcag_t",SQLCA.sqlcode,1)  
               CALL s_transaction_end('N','0')
               CONTINUE WHILE
         END CASE
 
 
         
         #add-point:單頭(偽)修改後
         {<point name="modify.a_key_update"/>}
         #end add-point
         
      END IF
      
      EXIT WHILE
      
   END WHILE
 
   #修改歷程記錄
   IF NOT cl_log_modified_record(g_xcag_m.xcagsite,g_site) THEN 
      CALL s_transaction_end('N','0')
   END IF
 
   CLOSE axci006_cl
   CALL s_transaction_end('Y','0')
 
   #流程通知預埋點-U
   CALL cl_flow_notify(g_xcag_m.xcagsite,'U')
 
   CALL axci006_b_fill("1=1")
   
END FUNCTION   
]]>
  </section>
  <section id="axci006.modify_detail_chk" ver="3" status="" src="s">
    <![CDATA[#+ 單身輸入判定
PRIVATE FUNCTION axci006_modify_detail_chk(ps_record)
   DEFINE ps_record STRING
   DEFINE ls_return STRING
   #add-point:modify_detail_chk段define
   {<point name="modify_detail_chk.define"/>}
   #end add-point
   
   #add-point:modify_detail_chk段開始前
   {<point name="modify_detail_chk.before"/>}
   #end add-point
   
   CASE ps_record
      WHEN "s_detail1" 
         LET ls_return = "check"
      WHEN "s_detail2"
         LET ls_return = "xcag004_2"
 
      #add-point:modify_detail_chk段自訂page控制
      {<point name="modify_detail_chk.page_control"/>}
      #end add-point
   END CASE
    
   #add-point:modify_detail_chk段結束前
   {<point name="modify_detail_chk.after"/>}
   #end add-point
   
   RETURN ls_return
   
END FUNCTION
]]>
  </section>
  <section id="axci006.other_function" ver="2" status="" src="s">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="axci006.query" ver="3" status="" src="s">
    <![CDATA[#+ 資料查詢QBE功能準備
PRIVATE FUNCTION axci006_query()
   DEFINE ls_wc STRING
   #add-point:query段define
   {<point name="query.define"/>}
   #end add-point   
 
   #add-point:query開始前
   {<point name="query.befroe_query"/>}
   #end add-point 
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF     
   
   LET ls_wc = g_wc
 
   LET INT_FLAG = 0    
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()       
   CALL g_xcag_d.clear()
   CALL g_xcag2_d.clear()
 
   DISPLAY ' ' TO FORMONLY.idx
   DISPLAY ' ' TO FORMONLY.cnt
   DISPLAY ' ' TO FORMONLY.b_index
   DISPLAY ' ' TO FORMONLY.b_count
   DISPLAY ' ' TO FORMONLY.h_index
   DISPLAY ' ' TO FORMONLY.h_count
   
   CALL axci006_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      LET g_wc = ls_wc
      CALL axci006_browser_fill(g_wc)
      CALL axci006_fetch("")
      RETURN
   END IF
   
   LET l_ac = 1
   LET g_detail_cnt = 0
   LET g_current_idx = 0
   LET g_current_row = 0
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
   
   LET g_error_show = 1
   CALL axci006_browser_fill("F")
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||")")
   
   #備份搜尋條件
   LET ls_wc = g_wc
   
   IF g_browser.getLength() = 0 THEN
      CALL cl_err("","-100",1)
   ELSE
      CALL axci006_fetch("F") 
   END IF
   
   LET g_wc_filter = ""
   
END FUNCTION
]]>
  </section>
  <section id="axci006.ref_show" ver="2" status="" src="s">
    <![CDATA[#+ 帶出reference資料
PRIVATE FUNCTION axci006_ref_show()
   DEFINE l_ac_t LIKE type_t.num10 #l_ac暫存用
   #add-point:ref_show段define
   {<point name="ref_show.define"/>}
   #end add-point
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:ref_show段m_reference
   {<point name="ref_show.head.reference"/>}
   #end add-point
 
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_xcag_d.getLength()
      #add-point:ref_show段d_reference
      {<point name="ref_show.body.reference"/>}
      #end add-point
   END FOR
   
   FOR l_ac = 1 TO g_xcag2_d.getLength()
      #add-point:ref_show段d2_reference
      {<point name="ref_show.body2.reference"/>}
      #end add-point
   END FOR
 
   
   LET l_ac = l_ac_t
 
END FUNCTION
]]>
  </section>
  <section id="axci006.reproduce" ver="3" status="" src="s">
    <![CDATA[#+ 資料複製
PRIVATE FUNCTION axci006_reproduce()
   DEFINE l_newno     LIKE xcag_t.xcagsite 
   DEFINE l_oldno     LIKE xcag_t.xcagsite 
   DEFINE l_newno02     LIKE xcag_t.xcag001 
   DEFINE l_oldno02     LIKE xcag_t.xcag001 
 
   DEFINE l_master    RECORD LIKE xcag_t.*
   DEFINE l_detail    RECORD LIKE xcag_t.*
 
   DEFINE l_cnt       LIKE type_t.num5
   #add-point:reproduce段define
   {<point name="reproduce.define"/>}
   #end add-point
 
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF     
 
   IF g_xcag_m.xcagsite IS NULL
      OR g_xcag_m.xcag001 IS NULL
 
      THEN
      CALL cl_err("","std-00003",0)
      RETURN
   END IF
   
   LET g_xcagsite_t = g_xcag_m.xcagsite
   LET g_xcag001_t = g_xcag_m.xcag001
 
   
   LET g_xcag_m.xcagsite = ""
   LET g_xcag_m.xcag001 = ""
 
    
   CALL axci006_set_entry('a')
   CALL axci006_set_no_entry('a')
   
   CALL cl_set_head_visible("","YES")
   
   #add-point:複製輸入前
   {<point name="reproduce.head.b_input"/>}
   #end add-point
   
   CALL axci006_input("r")
   
      LET g_xcag_m.xcagsite_desc = ''
   DISPLAY BY NAME g_xcag_m.xcagsite_desc
   LET g_xcag_m.xcag001_desc = ''
   DISPLAY BY NAME g_xcag_m.xcag001_desc
 
   
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
   
   LET g_state = "Y"
   
   LET g_wc = g_wc,  
              " OR (",
              " xcagsite = '", l_newno CLIPPED, "' "
              ," AND xcag001 = '", l_newno02 CLIPPED, "' "
 
              , ") "
   
   #add-point:完成複製段落後
   {<point name="reproduce.after_reproduce" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axci006.set_entry" ver="1" status="" src="s">
    <![CDATA[#+ 單頭欄位開啟設定
PRIVATE FUNCTION axci006_set_entry(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1  
   #add-point:set_entry段define
   {<point name="set_entry.define"/>}
   #end add-point       
 
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("xcagsite,xcag001",TRUE)
      #add-point:set_entry段欄位控制
      {<point name="set_entry.field_control"/>}
      #end add-point 
   END IF
   
   #add-point:set_entry段欄位控制後
   {<point name="set_entry.after_control"/>}
   #end add-point 
 
END FUNCTION
]]>
  </section>
  <section id="axci006.set_entry_b" ver="1" status="" src="s">
    <![CDATA[#+ 單身欄位開啟設定
PRIVATE FUNCTION axci006_set_entry_b(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define
   {<point name="set_entry_b.define"/>}
   #end add-point     
   
   #add-point:set_entry_b段
   {<point name="set_entry_b.set_entry_b"/>}
   #end add-point  
   
END FUNCTION
]]>
  </section>
  <section id="axci006.set_no_entry" ver="2" status="" src="s">
    <![CDATA[#+ 單頭欄位關閉設定
PRIVATE FUNCTION axci006_set_no_entry(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry段define
   {<point name="set_no_entry.define"/>}
   #end add-point     
 
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("xcagsite,xcag001",FALSE)
      #add-point:set_no_entry段欄位控制
      {<point name="set_no_entry.field_control"/>}
      #end add-point 
   END IF
   
   #add-point:set_no_entry段欄位控制後
   {<point name="set_no_entry.after_control"/>}
   #end add-point 
 
END FUNCTION
]]>
  </section>
  <section id="axci006.set_no_entry_b" ver="1" status="" src="s">
    <![CDATA[#+ 單身欄位關閉設定
PRIVATE FUNCTION axci006_set_no_entry_b(p_cmd)
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry_b段define
   {<point name="set_no_entry_b.define"/>}
   #end add-point    
   
   #add-point:set_no_entry_b段
   {<point name="set_no_entry_b.set_no_entry_b段"/>}
   #end add-point 
   
END FUNCTION
]]>
  </section>
  <section id="axci006.set_pk_array" ver="1" status="" src="s">
    <![CDATA[   #+ 此段落由子樣板a51產生
#+ 給予pk_array內容
PRIVATE FUNCTION axci006_set_pk_array()
   #add-point:set_pk_array段define
   {<point name="set_pk_array.define"/>}
   #end add-point
   
   #add-point:set_pk_array段之前
   {<point name="set_pk_array.before"/>}
   #end add-point  
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_xcag_m.xcagsite
   LET g_pk_array[1].column = 'xcagsite'
   LET g_pk_array[2].values = g_xcag_m.xcag001
   LET g_pk_array[2].column = 'xcag001'
   
   #add-point:set_pk_array段之後
   {<point name="set_pk_array.after"/>}
   #end add-point  
   
END FUNCTION
 
 
]]>
  </section>
  <section id="axci006.show" ver="3" status="" src="s">
    <![CDATA[#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION axci006_show()
   #add-point:show段define
   {<point name="show.define"/>}
   #end add-point
   
   #add-point:show段之前
   {<point name="show.before"/>}
   #end add-point
   
   IF g_bfill = "Y" THEN
      CALL axci006_b_fill(g_wc2) #單身填充
      CALL axci006_b_fill2('0') #單身填充
   END IF
   
   
 
   #顯示followup圖示
   #+ 此段落由子樣板a48產生
   CALL axci006_set_pk_array()
   #add-point:ON ACTION agendum
   {<point name="show.follow_pic"/>}
   #END add-point
   CALL cl_user_overview_set_follow_pic()
 
 
 
   LET g_xcag_m_t.* = g_xcag_m.*      #保存單頭舊值
   
   DISPLAY BY NAME g_xcag_m.xcagsite,g_xcag_m.xcagsite_desc,g_xcag_m.xcagcomp,g_xcag_m.xcagcomp_desc, 
       g_xcag_m.xcag011,g_xcag_m.xcag011_desc,g_xcag_m.xcag001,g_xcag_m.xcag001_desc
   CALL axci006_b_fill(g_wc2_table1)                 #單身
   CALL axci006_b_fill2('0') #單身填充
 
   CALL axci006_ref_show()
 
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()  
 
   #add-point:show段之後
   {<point name="show.after"/>}
   #end add-point   
   
END FUNCTION
]]>
  </section>
  <section id="axci006.state_change" ver="1" status="" src="s">
    <![CDATA[    
]]>
  </section>
  <section id="axci006.ui_browser_refresh" ver="2" status="" src="s">
    <![CDATA[#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION axci006_ui_browser_refresh()
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define
   {<point name="ui_browser_refresh.define"/>}
   #end add-point    
   
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_xcagsite = g_xcag_m.xcagsite 
         AND g_browser[l_i].b_xcag001 = g_xcag_m.xcag001 
 
         THEN  
         CALL g_browser.deleteElement(l_i)
         LET g_header_cnt = g_header_cnt - 1
      END IF
   END FOR
 
   LET g_browser_cnt = g_browser_cnt - 1
   IF g_current_row > g_browser_cnt THEN        #確定browse 筆數指在同一筆
      LET g_current_row = g_browser_cnt
   END IF
 
   DISPLAY g_browser_cnt TO FORMONLY.b_count    #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數的顯示
   
END FUNCTION
]]>
  </section>
  <section id="axci006.ui_detailshow" ver="2" status="" src="s">
    <![CDATA[#+ 單身資料重新顯示
PRIVATE FUNCTION axci006_ui_detailshow()
   #add-point:ui_detailshow段define
   {<point name="ui_detailshow.define"/>}
   #end add-point    
   
   #add-point:ui_detailshow段before
   {<point name="ui_detailshow.before"/>}
   #end add-point  
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)
 
      #add-point:ui_detailshow段more
      {<point name="ui_detailshow.more"/>}
      #end add-point 
   END IF
   
   #add-point:ui_detailshow段after
   {<point name="ui_detailshow.after"/>}
   #end add-point 
   
END FUNCTION
]]>
  </section>
  <section id="axci006.ui_dialog" ver="18" status="" src="s">
    <![CDATA[#+ 功能選單
PRIVATE FUNCTION axci006_ui_dialog()
   DEFINE la_param  RECORD
             prog   STRING,
             param  DYNAMIC ARRAY OF STRING
                    END RECORD
   DEFINE ls_js     STRING
   DEFINE li_idx    LIKE type_t.num5
   DEFINE ls_wc     STRING
   DEFINE lb_first  BOOLEAN
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define"/>}
   #end add-point  
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
   
   LET lb_first = TRUE
 
   
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
   
      CALL axci006_browser_fill("")
 
      
      #判斷前一個動作是否為新增, 若是的話切換到新增的筆數
      IF g_state = "Y" THEN
         FOR li_idx = 1 TO g_browser.getLength()
            IF g_browser[li_idx].b_xcagsite = g_xcagsite_t
               AND g_browser[li_idx].b_xcag001 = g_xcag001_t
 
               THEN
               LET g_current_row = li_idx
               EXIT FOR
            END IF
         END FOR
         LET g_state = ""
      END IF
      
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
        
         DISPLAY ARRAY g_xcag_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
         
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL axci006_ui_detailshow()
               
               #add-point:page1自定義行為
               {<point name="ui_dialog.body.before_row"/>}
               #end add-point
            
            BEFORE DISPLAY 
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               
               #控制stus哪個按鈕可以按
               
               
            
 
            #add-point:page1自定義行為
            {<point name="ui_dialog.page1.action"/>}
            #end add-point
               
         END DISPLAY
        
         DISPLAY ARRAY g_xcag2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
         
            BEFORE ROW
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL axci006_ui_detailshow()
               
               #add-point:page1自定義行為
               {<point name="ui_dialog.body2.before_row"/>}
               #end add-point
            
            BEFORE DISPLAY 
               CALL FGL_SET_ARR_CURR(g_detail_idx)      
            
            
         
            #add-point:page2自定義行為
            {<point name="ui_dialog.body2.action"/>}
            #end add-point
         
         END DISPLAY
 
         
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
         
         
         BEFORE DIALOG
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL g_curr_diag.setSelectionMode("s_detail1",1)         
            LET g_page = "first"
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               LET g_current_idx = g_current_row
            END IF
            LET g_current_row = g_current_idx #目前指標
            LET g_current_sw = TRUE
            
            IF g_current_idx > g_browser.getLength() THEN
               LET g_current_idx = g_browser.getLength()
            END IF 
            
            IF g_current_idx = 0 AND g_browser.getLength() > 0 THEN
               LET g_current_idx = 1 
            END IF
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL axci006_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL axci006_ui_detailshow() #Setting the current row 
            
            #add-point:ui_dialog段before dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD xcag002
            END IF
  
         
         
         ON ACTION first
            CALL axci006_fetch('F')
            LET g_current_row = g_current_idx         
          
         ON ACTION previous
            CALL axci006_fetch('P')
            LET g_current_row = g_current_idx
          
         ON ACTION jump
            CALL axci006_fetch('/')
            LET g_current_row = g_current_idx
        
         ON ACTION next
            CALL axci006_fetch('N')
            LET g_current_row = g_current_idx
         
         ON ACTION last
            CALL axci006_fetch('L')
            LET g_current_row = g_current_idx
          
         ON ACTION close
            LET INT_FLAG=FALSE        
            LET g_action_choice = "exit"
            EXIT DIALOG     
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
          
            
         ON ACTION worksheethidden   #瀏覽頁折疊
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
                CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF
       
         ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF
            
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               LET g_wc = ls_wc
               CALL axci006_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF
         
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               LET g_wc = ls_wc
               #取得條件後需要重查、跳到結果第一筆資料的功能程式段
               CALL axci006_browser_fill("F")
               IF g_browser_cnt = 0 THEN
                  CALL cl_err("","-100",1)
                  CLEAR FORM
               ELSE
                  CALL axci006_fetch("F")
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()
               
         
         #+ 此段落由子樣板a43產生
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL axci006_delete()
               #add-point:ON ACTION delete
               {<point name="menu.delete" />}
               #END add-point
               
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL axci006_modify()
               #add-point:ON ACTION modify
               {<point name="menu.modify" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL axci006_modify()
               #add-point:ON ACTION modify_detail
               {<point name="menu.modify_detail" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               
               #add-point:ON ACTION output
               {<point name="menu.output" />}
               #END add-point
               EXIT DIALOG
            END IF
 
 
         #+ 此段落由子樣板a43產生
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL axci006_query()
               #add-point:ON ACTION query
               {<point name="menu.query" />}
               #END add-point
               
            END IF
 
 
         
         
         
         #+ 此段落由子樣板a46產生
         #新增相關文件
         ON ACTION related_document
            CALL axci006_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document
               {<point name="ui_dialog.dialog.related_document"/>}
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL axci006_set_pk_array()
            #add-point:ON ACTION agendum
            {<point name="ui_dialog.dialog.agendum"/>}
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL axci006_set_pk_array()
            #add-point:ON ACTION followup
            {<point name="ui_dialog.dialog.followup"/>}
            #END add-point
            CALL cl_user_overview_follow('')
 
 
         
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl" 
            CONTINUE DIALOG
            
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
   
   CALL cl_set_act_visible("accept,cancel", TRUE)
   
END FUNCTION
]]>
  </section>
  <section id="axci006.ui_headershow" ver="4" status="" src="s">
    <![CDATA[#+ 單頭資料重新顯示
PRIVATE FUNCTION axci006_ui_headershow()
   #add-point:ui_headershow段define
   {<point name="ui_headershow.define"/>}
   #end add-point    
   
   LET g_xcag_m.xcagsite = g_browser[g_current_idx].b_xcagsite   
   LET g_xcag_m.xcag001 = g_browser[g_current_idx].b_xcag001   
 
   EXECUTE axci006_master_referesh USING g_xcag_m.xcagsite,g_xcag_m.xcag001 INTO g_xcag_m.xcagsite,g_xcag_m.xcagcomp, 
       g_xcag_m.xcag011,g_xcag_m.xcag001
   CALL axci006_show()
   
END FUNCTION
]]>
  </section>
  <section id="axci006.unlock_b" ver="1" status="" src="s">
    <![CDATA[#+ 連動unlock其他單身table資料
PRIVATE FUNCTION axci006_unlock_b(ps_table,ps_page)
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define
   {<point name="unlock_b.define"/>}
   #end add-point  
   
 
 
END FUNCTION
]]>
  </section>
  <section id="axci006.update_b" ver="1" status="" src="s">
    <![CDATA[#+ 修改單身後其他table連動
PRIVATE FUNCTION axci006_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num5 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define
   {<point name="update_b.define"/>}
   #end add-point     
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
 
   
 
   
END FUNCTION
]]>
  </section>
</add_points>
