#該程式未解開Section, 採用最新樣板產出!
{<section id="amhp343.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0009(2015-07-27 18:10:27), PR版次:0009(2017-02-02 14:10:04)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000094
#+ Filename...: amhp343
#+ Description: 單價收費項目批量處理作業
#+ Creator....: 06254(2015-07-24 11:58:44)
#+ Modifier...: 06254 -SD/PR- 02159
 
{</section>}
 
{<section id="amhp343.global" >}
#應用 p02 樣板自動產生(Version:22)
#add-point:填寫註解說明 name="global.memo"
#+ Modifier...: NO:#160318-00005#22  2016/03/30 by 07675   將重複內容的錯誤訊息置換為公用錯誤訊息
#+ Modifier...: NO:#160331-00021#1   2016/03/30 by 02003   sqlbug修改
#+ Modifier...: NO:#160406-00021#1   2016/04/06 by 08172   给stba000赋值
#+ Modifier...: NO:#160905-00003#6   2016/09/05 By 06814   修正ENT
#+ Modifier...: NO:#161104-00002#2   2016/11/08 By sakura  變數定義與INSERT不用*
#+ Modifier...: NO:#161228-00033#3   2017/01/03 by sakura  為了客戶DB種類的相容性:rownum寫法的改寫
#+ Modifier...: NO:#170120-00038#1   2017/01/23 By 06814   修正WHERE中無ENT條件
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
#add-point:增加匯入項目 name="global.import"

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable) name="global.parameter"
  

   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)  #注意要在add-point內寫入END RECORD name="global.variable"
      sel             LIKE type_t.chr1,
      mhalsite        LIKE mhal_t.mhalsite,
      mhalsite_desc   LIKE ooefl_t.ooefl003,
      mhal001         LIKE mhal_t.mhal001,
      mhal002         LIKE mhal_t.mhal002,
      mhal003         LIKE mhal_t.mhal003,
      mhal004         LIKE mhal_t.mhal004,
      mhal005         LIKE mhal_t.mhal005,
      mhal005_desc    LIKE mhael_t.mhael023,
      mhal006         LIKE mhal_t.mhal006,
      mhal006_desc    LIKE ooefl_t.ooefl003,
      mhal007         LIKE mhal_t.mhal007,
      mhal007_desc    LIKE mhaml_t.mhaml003,
      mhal008         LIKE mhal_t.mhal008,
      mhal009         LIKE mhal_t.mhal009,
      mhal010         LIKE mhal_t.mhal010,
      mhal011         LIKE mhal_t.mhal011,
      mhal012         LIKE mhal_t.mhal012,
      mhal013         LIKE mhal_t.mhal013,
      mhal014         LIKE mhal_t.mhal014,
      mhal025         LIKE mhal_t.mhal025,
      mhal015         LIKE mhal_t.mhal015,
      mhal016         LIKE mhal_t.mhal016,
      mhal017         LIKE mhal_t.mhal017, 
      mhal018         LIKE mhal_t.mhal018,
      mhal019         LIKE mhal_t.mhal019,
      mhal026         LIKE mhal_t.mhal026,
      mhal020         LIKE mhal_t.mhal020,
      mhal020_desc    LIKE rtax_t.rtax003,
      mhal021         LIKE mhal_t.mhal021,
      mhal022         LIKE mhal_t.mhal022,
      mhal023         LIKE mhal_t.mhal023,
      mhal024         LIKE mhal_t.mhal024,
#      mhal025         LIKE mhal_t.mhal025,
#      mhal026         LIKE mhal_t.mhal026,
      mhalstus        LIKE mhal_t.mhalstus, 
      mhalownid       LIKE mhal_t.mhalownid, 
      mhalownid_desc  LIKE type_t.chr80, 
      mhalowndp       LIKE mhal_t.mhalowndp, 
      mhalowndp_desc  LIKE type_t.chr80, 
      mhalcrtid       LIKE mhal_t.mhalcrtid, 
      mhalcrtid_desc  LIKE type_t.chr80, 
      mhalcrtdp       LIKE mhal_t.mhalcrtdp, 
      mhalcrtdp_desc  LIKE type_t.chr80, 
      mhalcrtdt       LIKE mhal_t.mhalcrtdt, 
      mhalmodid       LIKE mhal_t.mhalmodid, 
      mhalmodid_desc  LIKE type_t.chr80, 
      mhalmoddt       LIKE mhal_t.mhalmoddt, 
      mhalcnfid       LIKE mhal_t.mhalcnfid, 
      mhalcnfid_desc  LIKE type_t.chr80, 
      mhalcnfdt       LIKE mhal_t.mhalcnfdt
                   END RECORD
DEFINE g_detail_idx          LIKE type_t.num5
DEFINE l_mhal005             LIKE mhal_t.mhal005  #add by dengdd 15/10/28
DEFINE g_cnt1                LIKE type_t.num10 #add by dengdd 15/11/11
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明 name="global.argv"

#end add-point
 
{</section>}
 
{<section id="amhp343.main" >}
#+ 作業開始 
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   DEFINE ls_js  STRING
   #add-point:main段define name="main.define"
   DEFINE l_success LIKE type_t.num5
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義 name="main.before_ap_init"
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("amh","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js name="main.background"
   
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_amhp343 WITH FORM cl_ap_formpath("amh",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL amhp343_init()   
 
      #進入選單 Menu (="N")
      CALL amhp343_ui_dialog() 
 
      #add-point:畫面關閉前 name="main.before_close"
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_amhp343
   END IF 
   
   #add-point:作業離開前 name="main.exit"
   CALL s_aooi500_drop_temp() RETURNING l_success  #add by dengdd 151214
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="amhp343.init" >}
#+ 畫面資料初始化
PRIVATE FUNCTION amhp343_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point   
   #add-point:init段define name="init.define"
   DEFINE l_success LIKE type_t.num5 
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化 name="init.init"
   CALL cl_set_combo_scc_part('mhalstus','50','N,Y,X')  #资料有效性CALL 
   CALL cl_set_combo_scc_part('b_mhalstus','50','N,Y,X')  #资料有效性
   
#   CALL cl_set_combo_scc('mhal002','6795')   #mark by dengdd 151216
   CALL cl_set_combo_scc('mhal002','6848')  #费用类型  #add  by dengdd 151216
   CALL cl_set_combo_scc('mhal003','6796')  #来源类型
   CALL cl_set_combo_scc('mhal004','6790')  #类型
   CALL cl_set_combo_scc('mhal021','6791')  #分摊原则
   
#   CALL cl_set_combo_scc('mhal002','6795')   #mark by dengdd 151216
   CALL cl_set_combo_scc('b_mhal002','6848') #费用类型   #add  by dengdd 151216
   CALL cl_set_combo_scc('b_mhal003','6796') #来源类型
   CALL cl_set_combo_scc('b_mhal004','6790') #类型
   CALL cl_set_combo_scc('b_mhal021','6791') #分摊原则
   
   
   CALL s_aooi500_create_temp() RETURNING l_success
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="amhp343.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION amhp343_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point 
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define name="init.init"
   DEFINE l_stus   LIKE type_t.chr30 
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE lwin_curr       ui.Window
   DEFINE lfrm_curr       ui.Form
   DEFINE ls_path   STRING
   DEFINE l_success   LIKE type_t.num5        #add by dengdd 15/11/11
   DEFINE l_time      DATETIME YEAR TO SECOND #add by dengdd 15/11/11
   DEFINE l_mhal004   LIKE mhal_t.mhal004     #add by dengdd 15/11/24
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog name="ui_dialog.before_dialog"
 
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL amhp343_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct name="ui_dialog.more_construct"
         CONSTRUCT BY NAME g_wc ON mhalsite,mhal001,mhal002,mhal003,mhal004,mhal005,mhal006,
                                   mhal007,mhal008,mhal009,mhal020,mhal021,mhal022,mhal023,mhalstus 

               BEFORE CONSTRUCT
                    CALL cl_set_act_visible("filter",FALSE)  
              
              #add by dengdd 151124(S)
               AFTER FIELD mhal004
                    LET l_mhal004=GET_FLDBUF(mhal004)  
              #add by dengdd 151124(E)                    
                    
               ON ACTION controlp
                  CASE
                     WHEN INFIELD(mhalsite)   #營運組織
                       INITIALIZE g_qryparam.* TO NULL
                       LET g_qryparam.state = 'c'
                       LET g_qryparam.reqry = FALSE
                       LET g_qryparam.where = s_aooi500_q_where(g_prog,'stbasite',g_site,'c')
                       CALL q_ooef001_24()
                       DISPLAY g_qryparam.return1 TO mhalsite 
                       NEXT FIELD CURRENT
                     WHEN INFIELD(mhal005)   #专柜编号
                       INITIALIZE g_qryparam.* TO NULL
                       LET g_qryparam.state = 'c'
                       LET g_qryparam.reqry = FALSE
                       LET g_qryparam.arg1 = g_site
                       CALL q_mhae001()
                       DISPLAY g_qryparam.return1 TO mhal005 
                       NEXT FIELD CURRENT
                     WHEN INFIELD(mhal006)  #部门编号
                       INITIALIZE g_qryparam.* TO NULL
                       LET g_qryparam.state = 'c' 
                       LET g_qryparam.reqry = FALSE
                       CALL q_ooeg001_9()                           
                       DISPLAY g_qryparam.return1 TO mhal006 
                       NEXT FIELD CURRENT
                     WHEN INFIELD(mhal007) #电器编号
                       INITIALIZE g_qryparam.* TO NULL
                       LET g_qryparam.state = 'c' 
                       LET g_qryparam.reqry = FALSE
                       #add by dengdd 151124(S)
                       CASE l_mhal004
                            WHEN '3' 
                               CALL q_rtal001()
                            OTHERWISE
                               CALL q_mham001()                   
                       END CASE
                       #add by dengdd 151124(E)
#                       CALL q_mham001()       #mark by dengdd 151124                     
                       DISPLAY g_qryparam.return1 TO mhal007                       
                       NEXT FIELD CURRENT 
                     WHEN INFIELD(mhal020) #品类编号
                       INITIALIZE g_qryparam.* TO NULL
                       LET g_qryparam.state = 'c' 
                       LET g_qryparam.reqry = FALSE
                       CALL q_rtax001()                           
                       DISPLAY g_qryparam.return1 TO mhal007                       
                       NEXT FIELD CURRENT
                     
                     WHEN INFIELD(mhal023) #费用单号
                       INITIALIZE g_qryparam.* TO NULL
                       LET g_qryparam.state = 'c'
                       LET g_qryparam.reqry = FALSE
                       LET g_qryparam.where = " stba014 = '2' "
                       CALL q_stbadocno()
                       DISPLAY g_qryparam.return1 TO mhal023 
                       NEXT FIELD CURRENT
                END CASE
         END CONSTRUCT                  
                       
         #end add-point
         #add-point:ui_dialog段input name="ui_dialog.more_input"
       INPUT ARRAY g_detail_d FROM s_detail1.*
             ATTRIBUTE(COUNT = g_detail_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                       INSERT ROW = FALSE,
                       DELETE ROW = FALSE, 
                       APPEND ROW = FALSE)
          BEFORE INPUT
             LET g_current_page = 1
             CALL cl_set_act_visible("filter",FALSE)
          BEFORE ROW
             LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
             LET l_ac = g_detail_idx
             DISPLAY g_detail_idx TO FORMONLY.h_index
             DISPLAY g_detail_d.getLength() TO FORMONLY.h_count
             LET g_master_idx = l_ac
             CALL amhp343_fetch()
             IF g_detail_d[l_ac].sel = 'N' THEN
                NEXT FIELD sel
             END IF 
        END INPUT
         #end add-point
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
 
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall name="ui_dialog.selall.befroe"
            
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall name="ui_dialog.for.onaction_selall"
               
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall name="ui_dialog.onaction_selall"
            
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone name="ui_dialog.for.onaction_selnone"
               
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone name="ui_dialog.onaction_selnone"
            
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel name="ui_dialog.onaction_sel"
            
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel name="ui_dialog.onaction_unsel"
            
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL amhp343_filter()
            #add-point:ON ACTION filter name="menu.filter"
            
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前 name="menu.filter"
            
            #end add-point
            CALL amhp343_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段 name="ui_dialog.qbeclear"
            
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh name="ui_dialog.datarefresh"
            
            #end add-point
            CALL amhp343_b_fill()
 
         #add-point:ui_dialog段action name="ui_dialog.more_action"
          ON ACTION batch_execute
            LET l_stus = ''
            #151027-00016#2 20151112 mark by beckxie---S
            #MENU "" ATTRIBUTE(STYLE="popup")
            #   ON ACTION unconfirmed
            #      LET l_stus = "unconf"
            #   ON ACTION confirmed
            #      LET l_stus = "conf"
#           #    ON ACTION produce_cost
#           #       LET l_stus="procost"
            #      
            #END MENU
            #
            #CALL amhp343_process(l_stus)  
            #151027-00016#2 20151112 mark by beckxie---E
            #151027-00016#2 20151112  add by beckxie---S
            MENU "" ATTRIBUTE(STYLE="popup")
               ON ACTION unconfirmed
                  IF cl_auth_chk_act("unconfirmed") THEN
                     LET l_stus = "unconf"
                     CALL amhp343_process(l_stus)
                  END IF
               ON ACTION confirmed
                  IF cl_auth_chk_act("confirmed") THEN
                     LET l_stus = "conf"
                     CALL amhp343_process(l_stus)  
                  END IF
#           #    ON ACTION produce_cost
#           #       LET l_stus="procost"
            END MENU
            DISPLAY 0 TO stagecomplete
            #151027-00016#2 20151112  add by beckxie---E
        ON ACTION excel_load
           LET g_action_choice="excel_load"
            IF cl_auth_chk_act("excel_load") THEN
               
               #add-point:ON ACTION excel_load
               #add by dengdd 151111(S)
               LET l_time = cl_get_current()
               LET g_time = cl_replace_str(l_time,'-','')
               LET g_time = cl_replace_str(g_time,' ','')
               LET g_time = cl_replace_str(g_time,':','')
               
               LET g_etlparam[1].para_id = "g_docno"
               LET g_etlparam[1].type = "string"
               LET g_etlparam[1].value = g_time
               #add by dengdd 151111(S)
               
               LET la_param.prog = 'awsp200'
               LET la_param.param[1] = g_prog
               LET la_param.param[2] = "excel_load"
               LET la_param.param[3] = util.JSON.stringify(g_etlparam)

               LET ls_js = util.JSON.stringify( la_param )
               CALL cl_cmdrun_wait(ls_js)
               #END add-point
               
            END IF
            
            #抓暂存表资料写入专柜水电费资料档
            #add by dengdd 151111(S)
            CALL amhp343_check() RETURNING l_success
            IF l_success THEN                        
               IF NOT amhp343_insert() THEN 
                  LET g_errparam.code = 'adz-00218'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
               ELSE
                  LET g_errparam.code = 'amh-00619'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  LET g_errparam.replace[1] = g_cnt1
                  CALL cl_err()
               END IF
              
               CALL amhp343_b_fill()    
            END IF
            
            #写入水电费资料档完成，删除暂存表资料
            DELETE FROM mhav_t WHERE mhavent = g_enterprise
  #                               AND mhavsite= g_site
              
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "del_mhav" 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CONTINUE DIALOG
            END IF
            #add by dengdd 151111(S)
        ON ACTION excel_example
            LET g_action_choice="excel_example"
            IF cl_auth_chk_act("excel_example") THEN
               
               #add-point:ON ACTION excel_example
               LET la_param.prog = 'awsp200'
               LET la_param.param[1] = g_prog
               LET la_param.param[2] = "excel_example"
               LET ls_js = util.JSON.stringify( la_param )

               CALL cl_cmdrun_wait(ls_js)
               #END add-point
               
            END IF
            
         ON ACTION exporttoexcel
            #add by dengdd 151012-----str-----------
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN               
               CALL g_export_node.clear()
              
               LET g_export_node[1] = base.typeInfo.create(g_detail_d)
               LET g_export_id[1]   = "s_detail1"
                            
               CALL cl_export_to_excel_getpage()
               CALL cl_export_to_excel()
               
          END IF
         #add by dengdd 151012----end------------
         #add by dengdd 151123(S)
         ON ACTION pdelete
             LET g_action_choice="pdelete"
             IF cl_auth_chk_act("pdelete") THEN
                 CALL amhp343_p_delete()
                 CALL amhp343_b_fill()
             END IF
         #add by dengdd 151123(E)
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      #(ver:22) ---start---
      #add-point:ui_dialog段 after dialog name="ui_dialog.exit_dialog"
      
      #end add-point
      #(ver:22) --- end ---
 
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #(ver:22) ---start---
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         #(ver:22) --- end ---
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
{</section>}
 
{<section id="amhp343.query" >}
#+ QBE資料查詢
PRIVATE FUNCTION amhp343_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point 
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define name="query.define"
   
   #end add-point 
    
   #add-point:cs段after_construct name="query.after_construct"
   
   #end add-point
        
   LET g_error_show = 1
   CALL amhp343_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query name="query.cs_after_query"
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="amhp343.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION amhp343_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point
   DEFINE ls_wc           STRING
   #add-point:b_fill段define name="b_fill.define"
   DEFINE l_where         STRING
   #end add-point
 
   LET g_wc = g_wc, cl_sql_auth_filter()   #(ver:21) add cl_sql_auth_filter()
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"
   CALL s_aooi500_sql_where(g_prog,'mhalsite') RETURNING l_where
   
   IF cl_null(g_wc) THEN 
      LET g_wc = " 1=1"
   END IF
   
   LET g_wc = g_wc,
              " AND ",l_where 
              
   LET g_sql= " SELECT UNIQUE 'N',t0.mhalsite,t1.ooefl003,t0.mhal001,t0.mhal002,t0.mhal003,t0.mhal004,t0.mhal005,t2.mhael023,
                              t0.mhal006,t3.ooefl003, t0.mhal007,t4.mhaml003,t0.mhal008,t0.mhal009,t0.mhal010,t0.mhal011,
                              t0.mhal012,t0.mhal013,t0.mhal014,t0.mhal025,t0.mhal015,t0.mhal016,t0.mhal017,t0.mhal018,
                              t0.mhal019,t0.mhal026,t0.mhal020,t5.rtaxl003,t0.mhal021,t0.mhal022,t0.mhal023,t0.mhal024,
                              t0.mhalstus,t0.mhalownid,t6.ooag011,t0.mhalowndp,t7.ooefl003,t0.mhalcrtid,t8.ooag011,
                              t0.mhalcrtdp,t9.ooefl003,t0.mhalcrtdt,t0.mhalmodid,t10.ooag011,t0.mhalmoddt,t0.mhalcnfid,t11.ooag011,
                              t0.mhalcnfdt",
               " FROM mhal_t t0",
                              " LEFT JOIN ooefl_t t1 ON t1.ooeflent=mhalent AND t1.ooefl001=t0.mhalsite AND t1.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN mhael_t t2 ON t2.mhaelent=mhalent AND t2.mhael001=t0.mhal005 AND t2.mhael022='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t3 ON t3.ooeflent=mhalent AND t3.ooefl001=t0.mhal006 AND t3.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN mhaml_t t4 ON t4.mhamlent=mhalent AND t4.mhaml001=t0.mhal007 AND t4.mhaml002='"||g_dlang||"' ",
               " LEFT JOIN rtaxl_t t5 ON t5.rtaxlent=mhalent AND t5.rtaxl001=t0.mhal020 AND t5.rtaxl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t6 ON t6.ooagent=mhalent AND t6.ooag001=t0.mhalownid  ",
               " LEFT JOIN ooefl_t t7 ON t7.ooeflent=mhalent AND t7.ooefl001=t0.mhalowndp AND t7.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t8 ON t8.ooagent=mhalent AND t8.ooag001=t0.mhalcrtid  ",
               " LEFT JOIN ooefl_t t9 ON t9.ooeflent=mhalent AND t9.ooefl001=t0.mhalcrtdp AND t9.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t10 ON t10.ooagent=mhalent AND t10.ooag001=t0.mhalmodid  ",
               " LEFT JOIN ooag_t t11 ON t11.ooagent=mhalent AND t11.ooag001=t0.mhalcnfid  ", 
               " WHERE t0.mhalent =? ",
               "   AND ",g_wc CLIPPED
               
               
    LET g_sql = cl_sql_add_mask(g_sql)             
   #end add-point
 
   PREPARE amhp343_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR amhp343_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空 name="b_fill.clear"
   
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into name="b_fill.foreach_into"
           g_detail_d[l_ac].sel           ,g_detail_d[l_ac].mhalsite      ,g_detail_d[l_ac].mhalsite_desc,
           g_detail_d[l_ac].mhal001       ,g_detail_d[l_ac].mhal002       ,g_detail_d[l_ac].mhal003,
           g_detail_d[l_ac].mhal004       ,g_detail_d[l_ac].mhal005       ,g_detail_d[l_ac].mhal005_desc,
           g_detail_d[l_ac].mhal006       ,g_detail_d[l_ac].mhal006_desc  ,g_detail_d[l_ac].mhal007,
           g_detail_d[l_ac].mhal007_desc  ,g_detail_d[l_ac].mhal008       ,g_detail_d[l_ac].mhal009,
           g_detail_d[l_ac].mhal010       ,g_detail_d[l_ac].mhal011       ,g_detail_d[l_ac].mhal012,
           g_detail_d[l_ac].mhal013       ,g_detail_d[l_ac].mhal014       ,g_detail_d[l_ac].mhal025,
           g_detail_d[l_ac].mhal015       ,g_detail_d[l_ac].mhal016       ,g_detail_d[l_ac].mhal017,
           g_detail_d[l_ac].mhal018       ,g_detail_d[l_ac].mhal019       ,g_detail_d[l_ac].mhal026,
           g_detail_d[l_ac].mhal020       ,g_detail_d[l_ac].mhal020_desc  ,g_detail_d[l_ac].mhal021,
           g_detail_d[l_ac].mhal022       ,g_detail_d[l_ac].mhal023       ,g_detail_d[l_ac].mhal024,g_detail_d[l_ac].mhalstus,
           g_detail_d[l_ac].mhalownid     ,g_detail_d[l_ac].mhalownid_desc,g_detail_d[l_ac].mhalowndp,
           g_detail_d[l_ac].mhalowndp_desc,g_detail_d[l_ac].mhalcrtid     ,g_detail_d[l_ac].mhalcrtid_desc,
           g_detail_d[l_ac].mhalcrtdp     ,g_detail_d[l_ac].mhalcrtdp_desc,g_detail_d[l_ac].mhalcrtdt,
           g_detail_d[l_ac].mhalmodid     ,g_detail_d[l_ac].mhalmodid_desc,g_detail_d[l_ac].mhalmoddt,
           g_detail_d[l_ac].mhalcnfid     ,g_detail_d[l_ac].mhalcnfid_desc,g_detail_d[l_ac].mhalcnfdt
                      
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充 name="b_fill.foreach_iside"
      
      #end add-point
      
      CALL amhp343_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身) name="b_fill.other_table"
   CALL g_detail_d.deleteElement(l_ac)   #Standard---保留彈性,要補上清除ARRAY的最後一行
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE amhp343_sel
   
   LET l_ac = 1
   CALL amhp343_fetch()
   #add-point:b_fill段資料填充(其他單身) name="b_fill.after_b_fill"
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="amhp343.fetch" >}
#+ 單身陣列填充2
PRIVATE FUNCTION amhp343_fetch()
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define name="fetch.define"
   
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後 name="fetch.after_fill"
   
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
 
{</section>}
 
{<section id="amhp343.detail_show" >}
#+ 顯示相關資料
PRIVATE FUNCTION amhp343_detail_show()
   #add-point:show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point
   #add-point:show段define name="detail_show.define"
   
   #end add-point
   
   #add-point:detail_show段 name="detail_show.detail_show"
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="amhp343.filter" >}
#+ filter過濾功能
PRIVATE FUNCTION amhp343_filter()
   #add-point:filter段define(客製用) name="filter.define_customerization"
   
   #end add-point    
   #add-point:filter段define name="filter.define"
   
   #end add-point
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define name="filter.detail_cnt"
   
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL amhp343_b_fill()
   
END FUNCTION
 
{</section>}
 
{<section id="amhp343.filter_parser" >}
#+ filter欄位解析
PRIVATE FUNCTION amhp343_filter_parser(ps_field)
   #add-point:filter段define(客製用) name="filter_parser.define_customerization"
   
   #end add-point    
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define name="filter_parser.define"
   
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="amhp343.filter_show" >}
#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION amhp343_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = amhp343_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="amhp343.other_function" readonly="Y" >}
#add-point:自定義元件(Function) name="other.function"

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL amhp343_process(p_stus)
#                  RETURNING r_success
# Input parameter: p_stus      状态码
# Return code....: r_success   执行成功否
# Date & Author..: 2015/7/27 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_process(p_stus)
DEFINE p_stus   LIKE type_t.chr30
DEFINE li_idx   LIKE type_t.num5
DEFINE l_cnt    LIKE type_t.num5
DEFINE l_success LIKE type_t.num5
DEFINE r_mhaldocno LIKE mhal_t.mhal023
DEFINE l_stba   RECORD 
    stbaunit LIKE stba_t.stbaunit,    
   stbadocdt LIKE stba_t.stbadocdt, 
   stbadocno LIKE stba_t.stbadocno, 
   stba014 LIKE stba_t.stba014, 
   stba013 LIKE stba_t.stba013,  
   stba010 LIKE stba_t.stba010, 
   stba002 LIKE stba_t.stba002, 
   stba003 LIKE stba_t.stba003, 
   stba005 LIKE stba_t.stba005, 
   stba004 LIKE stba_t.stba004, 
   stbastus LIKE stba_t.stbastus, 
   stba006 LIKE stba_t.stba006, 
   stba007 LIKE stba_t.stba007, 
   stba001 LIKE stba_t.stba001, 
   stbasite LIKE stba_t.stbasite, 
   stba011 LIKE stba_t.stba011, 
   stba012 LIKE stba_t.stba012, 
   stba008 LIKE stba_t.stba008, 
   stba009 LIKE stba_t.stba009,
   stba000 LIKE stba_t.stba000
                END RECORD   
DEFINE l_msg         STRING           #160225-00040#9 20160328 add by beckxie
DEFINE l_stfa004 LIKE stfa_t.stfa004

   LET l_cnt = 0 
#  CALL cl_err_collect_init()
   #160225-00040#9 20160328 add by beckxie---S
   IF g_bgjob <> "Y" THEN
      CALL cl_progress_bar_no_window(2)   
   END IF
   #160225-00040#9 20160328 add by beckxie---E 
   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   LET l_success=TRUE
   #160225-00040#9 20160328 add by beckxie---S
   LET l_msg = cl_getmsg('ast-00330',g_lang)
   CALL cl_progress_no_window_ing(l_msg)
   #160225-00040#9 20160328 add by beckxie---E
   FOR li_idx = 1 TO g_detail_d.getLength()
      LET l_mhal005=g_detail_d[li_idx].mhal005
      IF g_detail_d[li_idx].sel = "Y" THEN
         LET l_cnt = l_cnt + 1
         
         CASE p_stus
           WHEN "unconf"
              IF NOT amhp343_conf_chk(p_stus,g_detail_d[li_idx].mhalstus,g_detail_d[li_idx].mhal022) THEN
 #                LET l_success=FALSE
  #               EXIT FOR
              ELSE
                 IF NOT amhp343_conf_upd(p_stus,g_detail_d[li_idx].mhalsite,g_detail_d[li_idx].mhal001,
                                         g_detail_d[li_idx].mhal002,g_detail_d[li_idx].mhal004,
                                         g_detail_d[li_idx].mhal005,g_detail_d[li_idx].mhal007) THEN
                    LET l_success=FALSE
                    EXIT FOR
                 END IF
              END IF
           WHEN "conf"
              IF NOT amhp343_conf_chk(p_stus,g_detail_d[li_idx].mhalstus,g_detail_d[li_idx].mhal022) THEN
#                 LET l_success=FALSE
#                 EXIT FOR
              ELSE
                #进行判断专柜编号为2时，查询合同是否有效，如果无效则不允许审核
                  IF g_detail_d[li_idx].mhal004='2' THEN
                     #170120-00038#1 modify(add ent) by beckxie---S
                     #select stfa004 into l_stfa004 from stfa_t where stfa005=g_detail_d[li_idx].mhal005 and stfasite=g_detail_d[li_idx].mhalsite and stfaacti='Y'
                     SELECT stfa004 INTO l_stfa004 FROM stfa_t WHERE stfaent = g_enterprise AND stfa005=g_detail_d[li_idx].mhal005 AND stfasite=g_detail_d[li_idx].mhalsite AND stfaacti='Y'
                     #170120-00038#1 modify(add ent) by beckxie---E
                     IF l_stfa004 > '6' THEN 
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = '！'
                        LET g_errparam.extend =g_detail_d[li_idx].mhal005," 专柜的合同状态已失效"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                      ELSE
                         IF NOT amhp343_conf_upd(p_stus,g_detail_d[li_idx].mhalsite,g_detail_d[li_idx].mhal001,
                                                  g_detail_d[li_idx].mhal002,g_detail_d[li_idx].mhal004,
                                                  g_detail_d[li_idx].mhal005,g_detail_d[li_idx].mhal007) THEN                                         
                             LET l_success=FALSE
                             EXIT FOR
                          END IF
                      END IF
                  ELSE
                          IF NOT amhp343_conf_upd(p_stus,g_detail_d[li_idx].mhalsite,g_detail_d[li_idx].mhal001,
                                                  g_detail_d[li_idx].mhal002,g_detail_d[li_idx].mhal004,
                                                  g_detail_d[li_idx].mhal005,g_detail_d[li_idx].mhal007) THEN                                         
                             LET l_success=FALSE
                             EXIT FOR
                          END IF                  
                  END IF
              END IF 
              
#           WHEN "procost" 
#              IF cl_null(g_detail_d[li_idx].mhal023) AND g_detail_d[li_idx].mhalstus='Y'THEN
#                 CALL amhp343_chk(g_detail_d[li_idx].mhalsite,g_detail_d[li_idx].mhal001,g_detail_d[li_idx].mhal005) 
#                      RETURNING l_success,r_mhaldocno
#                      
#                 IF cl_null(r_mhaldocno) THEN
#                 
#                    CALL amhp343_insa(g_detail_d[li_idx].mhalsite,g_detail_d[li_idx].mhal001,g_detail_d[li_idx].mhal005,
#                                      g_detail_d[li_idx].mhal002,g_detail_d[li_idx].mhal019) 
#                         RETURNING l_success,r_mhaldocno   
#                         
#                 ELSE
#                    SELECT stbaunit,stbadocdt,stbadocno,stba014,stba013,stba010,stba002,stba003,
#                           stba005,stba004,stbastus,stba006,stba007,stba001,stbasite,stba011,stba012, 
#                           stba008,stba009
#                      INTO l_stba.stbaunit,l_stba.stbadocdt,l_stba.stbadocno,l_stba.stba014,l_stba.stba013,
#                           l_stba.stba010,l_stba.stba002,l_stba.stba003,l_stba.stba005,l_stba.stba004,l_stba.stbastus,
#                           l_stba.stba006,l_stba.stba007,l_stba.stba001,l_stba.stbasite,l_stba.stba011,l_stba.stba012,
#                           l_stba.stba008,l_stba.stba009
#                      FROM stba_t
#                     WHERE stbaent=g_enterprise
#                       AND stbadocno=r_mhaldocno
#                       
#                    CALL amhp343_insb(g_detail_d[li_idx].mhal002,g_detail_d[li_idx].mhal005,g_detail_d[li_idx].mhal019,
#                                      g_detail_d[li_idx].mhal001,l_stba.*) 
#                         RETURNING l_success,r_mhaldocno
#                 END IF
#                 
#                 IF l_success = TRUE THEN 
#                    CALL amhp343_upd(g_detail_d[li_idx].mhalsite,g_detail_d[li_idx].mhal001,
#                                     g_detail_d[li_idx].mhal002,g_detail_d[li_idx].mhal004,
#                                     g_detail_d[li_idx].mhal005,g_detail_d[li_idx].mhal007,r_mhaldocno) 
#                         RETURNING l_success
#                 ELSE
#                    EXIT FOR
#                 END IF
#              
#              ELSE 
#                  INITIALIZE g_errparam TO NULL 
#                  LET g_errparam.code = "amh-00086"
#                  LET g_errparam.extend =""
#                  LET g_errparam.popup = TRUE
#                   CALL cl_err()
#                   LET l_success = FALSE            
#              END IF              
         END CASE
         
      END IF
    END FOR    
    
#   CALL cl_err_collect_show()
   #160225-00040#9 20160328 add by beckxie---S
   LET l_msg = cl_getmsg('std-00012',g_lang)
   CALL cl_progress_no_window_ing(l_msg)
   #160225-00040#9 20160328 add by beckxie---E
   IF l_cnt = 0 THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.code = 'adb-00078'
       LET g_errparam.extend = ''
       LET g_errparam.popup = TRUE
       CALL cl_err()
       CALL s_transaction_end("N","0")
       RETURN
   END IF  
    
   IF l_success THEN
      CALL cl_err_collect_show()
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'adz-00217'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CALL s_transaction_end("Y","0")
   ELSE
      CALL cl_err_collect_show()
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'adz-00218'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CALL s_transaction_end("N","0")
   END IF
   
    CALL amhp343_b_fill()    
    
END FUNCTION

################################################################################
# Descriptions...: 检查资料状态
# Memo...........:
# Usage..........: CALL amhp343_conf_chk(p_stus,p_mhalstus,mhal022)
#                  RETURNING r_success
# Input parameter: p_mhalstus     资料状态码
#                : p_stus   
#                : p_mhal022      产生费用单否      
# Return code....: r_success      执行成功否
# Date & Author..: 2015/7/27 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_conf_chk(p_stus,p_mhalstus,p_mhal022)
DEFINE p_mhalstus     LIKE mhal_t.mhalstus
DEFINE p_mhal022      LIKE mhal_t.mhal022
DEFINE p_stus         LIKE type_t.chr30
DEFINE r_success      LIKE type_t.num5
DEFINE l_cnt          LIKE type_t.num5  #add by dengdd 15/10/28

LET r_success=TRUE

IF p_mhalstus="N" AND p_stus="unconf" THEN
   INITIALIZE g_errparam TO NULL 
   LET g_errparam.code = "amh-00080"
   LET g_errparam.extend =""
   LET g_errparam.popup = TRUE
   CALL cl_err()
   LET r_success = FALSE
END IF 

IF p_mhalstus="Y" AND p_stus="conf" THEN
   INITIALIZE g_errparam TO NULL 
   LET g_errparam.code = "amh-00081"
   LET g_errparam.extend =""
   LET g_errparam.popup = TRUE
   CALL cl_err()
   LET r_success = FALSE
END IF 

IF p_mhalstus="X" THEN
   INITIALIZE g_errparam TO NULL 
   LET g_errparam.code = "amh-00082"
   LET g_errparam.extend =""
   LET g_errparam.popup = TRUE
   CALL cl_err()
   LET r_success = FALSE
END IF

#IF p_mhalstus="Y" AND p_stus="unconf" THEN
#   INITIALIZE g_errparam TO NULL 
#   LET g_errparam.code = "amh-00083"
#   LET g_errparam.extend =""
#   LET g_errparam.popup = TRUE
#   CALL cl_err()
#   LET r_success = FALSE
#END IF 

#add by dengdd 15/10/28(S)
   SELECT COUNT(*) INTO l_cnt
     FROM stfl_t,stfa_t
    WHERE stflent=stfaent
      AND stfl001=stfa001
      AND stfa005=l_mhal005
      
   IF l_cnt=0 THEN 
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = l_mhal005
      LET g_errparam.code   = 'amh-00087' 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET r_success = FALSE
   END IF  
   #add by dengdd 15/10/28(E)

RETURN r_success

END FUNCTION

################################################################################
#Descriptions...: 更新资料状态
# Memo...........:
# Usage..........: CALL amhp343_conf_upd(p_stus,p_site,p_mhal001,p_mhal002,p_mhal004,p_mhal005,p_mhal007)
#                  RETURNING r_success
# Input parameter: p_stus         
#                : p_site         营运组织
#                : p_mhal001      会计期间
#                : p_mhal002      水电费类型
#                : p_mhal004      类型
#                : p_mhal005      专柜编号
#                : p_mhal007      电器编号
# Return code....: r_success      执行成功否
# Date & Author..: 2015/7/27 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_conf_upd(p_stus,p_site,p_mhal001,p_mhal002,p_mhal004,p_mhal005,p_mhal007)
DEFINE p_stus      LIKE type_t.chr30
DEFINE p_site      LIKE mhal_t.mhalsite
DEFINE p_mhal001   LIKE mhal_t.mhal001
DEFINE p_mhal002   LIKE mhal_t.mhal002
DEFINE p_mhal004   LIKE mhal_t.mhal004
DEFINE p_mhal005   LIKE mhal_t.mhal005
DEFINE p_mhal007   LIKE mhal_t.mhal007
DEFINE r_success   LIKE type_t.num5
DEFINE r_errno     LIKE type_t.chr10
DEFINE l_sql       STRING
DEFINE l_mhal019   LIKE mhal_t.mhal019
DEFINE l_mhal023   LIKE mhal_t.mhal023
DEFINE l_stba   RECORD 
    stbaunit LIKE stba_t.stbaunit,    
   stbadocdt LIKE stba_t.stbadocdt, 
   stbadocno LIKE stba_t.stbadocno, 
   stba014 LIKE stba_t.stba014, 
   stba013 LIKE stba_t.stba013,  
   stba010 LIKE stba_t.stba010, 
   stba002 LIKE stba_t.stba002, 
   stba003 LIKE stba_t.stba003, 
   stba005 LIKE stba_t.stba005, 
   stba004 LIKE stba_t.stba004, 
   stbastus LIKE stba_t.stbastus, 
   stba006 LIKE stba_t.stba006, 
   stba007 LIKE stba_t.stba007, 
   stba001 LIKE stba_t.stba001, 
   stbasite LIKE stba_t.stbasite, 
   stba011 LIKE stba_t.stba011, 
   stba012 LIKE stba_t.stba012, 
   stba008 LIKE stba_t.stba008, 
   stba009 LIKE stba_t.stba009,
   stba000 LIKE stba_t.stba000
                END RECORD
DEFINE l_stbastus  LIKE stba_t.stbastus
DEFINE l_mhalcnfdt    DATETIME YEAR TO SECOND
                
LET l_mhalcnfdt = cl_get_current()
LET r_success=TRUE

IF p_stus = "conf" THEN
   LET l_sql="UPDATE mhal_t SET mhalstus='Y' WHERE mhalent=? ",
             "                                 AND mhalsite=? ",
             "                                 AND mhal001=? ",
             "                                 AND mhal002=? ",
             "                                 AND mhal004=? ",
             "                                 AND mhal005=? ",
             "                                 AND mhal007=? "
ELSE
   LET l_sql="UPDATE mhal_t SET mhalstus='N' WHERE mhalent=? ",
             "                                 AND mhalsite=? ",
             "                                 AND mhal001=? ",
             "                                 AND mhal002=? ",
             "                                 AND mhal004=? ",
             "                                 AND mhal005=? ",
             "                                 AND mhal007=? "
END IF
PREPARE amhp343_upd FROM l_sql
EXECUTE amhp343_upd USING g_enterprise,p_site,p_mhal001,p_mhal002,p_mhal004,
                          p_mhal005,p_mhal007
                          
IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]<=0 THEN
   INITIALIZE g_errparam TO NULL 
   LET g_errparam.code = SQLCA.sqlcode
   LET g_errparam.extend ="upd mhal_t"
   LET g_errparam.popup = TRUE
   CALL cl_err()
   LET r_success = FALSE
END IF 


IF p_stus="unconf" THEN
   SELECT mhal023 INTO l_mhal023 
     FROM mhal_t
    #WHERE mhalsite=p_site       #160905-00003#6 20160905 mark by beckxie
    WHERE mhalent = g_enterprise #160905-00003#6 20160905 add by beckxie
      AND mhalsite= p_site       #160905-00003#6 20160905 add by beckxie
      AND mhal001 =p_mhal001
      AND mhal002 =p_mhal002
      AND mhal004 =p_mhal004
      AND mhal005 =p_mhal005
      AND mhal007 =p_mhal007
      
      
   IF NOT cl_null(l_mhal023) THEN
      SELECT stbastus INTO l_stbastus FROM stba_t
       WHERE stbaent=g_enterprise
         AND stbadocno=l_mhal023
         
      IF l_stbastus='Y' THEN
         LET r_success=FALSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'amh-00064'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      ELSE
        LET l_mhalcnfdt = cl_get_current()        
        DELETE FROM stba_t WHERE stbaent=g_enterprise
                             AND stbadocno=l_mhal023
        DELETE FROM stbb_t WHERE stbbent=g_enterprise
                              AND stbbdocno=l_mhal023        
                  
         IF SQLCA.sqlcode THEN
            LET r_success=FALSE
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'sub-00034'
            LET g_errparam.extend = ''
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN r_success 
         END IF
         
       END IF
      
   END IF 
   
   UPDATE mhal_t SET mhalstus = 'N',
                          mhalcnfid = g_user,
                          mhalcnfdt = l_mhalcnfdt,
                          mhal022   ='N',         
                          mhal023   =' '
          WHERE mhalent = g_enterprise
            AND mhalsite = p_site
            AND mhal001 = p_mhal001
            AND mhal002 = p_mhal002
            AND mhal004 = p_mhal004
            AND mhal005 = p_mhal005
            AND mhal007 = p_mhal007
            
   IF SQLCA.sqlcode THEN
      LET r_success=FALSE
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-00034'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success 
   END IF
   
END IF 


   SELECT mhal019 INTO l_mhal019  FROM mhal_t 
                                 WHERE mhalent=g_enterprise 
                                   AND mhalsite=p_site
                                   AND mhal001 =p_mhal001
                                   AND mhal002 =p_mhal002
                                   AND mhal004 =p_mhal004
                                   AND mhal005 =p_mhal005
                                   AND mhal007 =p_mhal007
                                  
IF p_stus="conf" AND r_success=TRUE AND p_mhal004='2' AND l_mhal019>0 THEN
#   SELECT mhal019 INTO l_mhal019  FROM mhal_t 
#                                 WHERE mhalent=g_enterprise 
#                                   AND mhalsite=p_site
#                                   AND mhal001 =p_mhal001
#                                   AND mhal002 =p_mhal002
#                                   AND mhal004 =p_mhal004
#                                   AND mhal005 =p_mhal005
#                                   AND mhal007 =p_mhal007
   
#   CALL amhp343_chk(p_site,p_mhal001,p_mhal004,p_mhal005)
#        RETURNING r_success,l_mhal023
#        
#   IF r_success=TRUE AND cl_null(l_mhal023) THEN      
       CALL amhp343_insa(p_site,p_mhal001,p_mhal005,p_mhal002,l_mhal019)
            RETURNING r_success,l_mhal023
#   ELSE
#      IF NOT cl_null(l_mhal023) THEN
#         SELECT stbaunit,stbadocdt,stbadocno,stba014,stba013,stba010,stba002,stba003,
#                stba005,stba004,stbastus,stba006,stba007,stba001,stbasite,stba011,stba012, 
#                stba008,stba009
#           INTO l_stba.stbaunit,l_stba.stbadocdt,l_stba.stbadocno,l_stba.stba014,l_stba.stba013,
#                l_stba.stba010,l_stba.stba002,l_stba.stba003,l_stba.stba005,l_stba.stba004,l_stba.stbastus,
#                l_stba.stba006,l_stba.stba007,l_stba.stba001,l_stba.stbasite,l_stba.stba011,l_stba.stba012,
#                l_stba.stba008,l_stba.stba009
#           FROM stba_t
#          WHERE stbaent=g_enterprise
#            AND stbadocno=l_mhal023
#                       
#          CALL amhp343_insb(p_mhal001,p_mhal002,p_mhal005,l_mhal019,l_stba.*) 
#                RETURNING r_success,l_mhal023
#         
#       END IF     
#   END IF 
END IF 

IF p_stus="conf" AND r_success=TRUE AND p_mhal004='2' THEN
   CALL amhp343_upd(p_site,p_mhal001,p_mhal002,p_mhal004,p_mhal005,p_mhal007,l_mhal023) 
        RETURNING r_success
END IF 



RETURN r_success
END FUNCTION

################################################################################
#Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL amhp343_insa(p_site,p_mhal001,p_mhal005,p_mhal002,p_mhal019)
#                  RETURNING r_success
# Input parameter: p_site         营运组织
#                : p_mhal001      会计期间
#                : p_mhal005      专柜编号
#                : p_mhal002      水电费类型
#                : p_mhal019      实际金额
# Return code....: r_success
# Date & Author..: 2105/7/28 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_insa(p_site,p_mhal001,p_mhal005,p_mhal002,p_mhal019)
DEFINE p_site      LIKE mhal_t.mhalsite
DEFINE p_mhal001   LIKE mhal_t.mhal001
DEFINE p_mhal005   LIKE mhal_t.mhal005
DEFINE p_mhal002   LIKE mhal_t.mhal002
DEFINE p_mhal019   LIKE mhal_t.mhal019
DEFINE l_sql       STRING
DEFINE r_success   LIKE type_t.num5
DEFINE l_ooef004   LIKE ooef_t.ooef004
DEFINE l_ooba002   LIKE ooba_t.ooba002
DEFINE p_prog      LIKE type_t.chr10
DEFINE l_stba_m    RECORD 
   stbaunit LIKE stba_t.stbaunit,    
   stbadocdt LIKE stba_t.stbadocdt, 
   stbadocno LIKE stba_t.stbadocno, 
   stba014 LIKE stba_t.stba014, 
   stba013 LIKE stba_t.stba013,  
   stba010 LIKE stba_t.stba010, 
   stba002 LIKE stba_t.stba002, 
   stba003 LIKE stba_t.stba003, 
   stba005 LIKE stba_t.stba005, 
   stba004 LIKE stba_t.stba004, 
   stbastus LIKE stba_t.stbastus, 
   stba006 LIKE stba_t.stba006, 
   stba007 LIKE stba_t.stba007, 
   stba001 LIKE stba_t.stba001, 
   stbasite LIKE stba_t.stbasite, 
   stba011 LIKE stba_t.stba011, 
   stba012 LIKE stba_t.stba012, 
   stba008 LIKE stba_t.stba008, 
   stba009 LIKE stba_t.stba009, 
   stbaownid LIKE stba_t.stbaownid, 
   stbaowndp LIKE stba_t.stbaowndp, 
   stbacrtid LIKE stba_t.stbacrtid, 
   stbacrtdp LIKE stba_t.stbacrtdp, 
   stbacrtdt LIKE stba_t.stbacrtdt, 
   stbamodid LIKE stba_t.stbamodid, 
   stbamoddt LIKE stba_t.stbamoddt, 
   stbacnfid LIKE stba_t.stbacnfid, 
   stbacnfdt LIKE stba_t.stbacnfdt,
   stba000 LIKE stba_t.stba000 
                   END RECORD                   
DEFINE l_stba_t   RECORD 
   stbaunit LIKE stba_t.stbaunit,    
   stbadocdt LIKE stba_t.stbadocdt, 
   stbadocno LIKE stba_t.stbadocno, 
   stba014 LIKE stba_t.stba014, 
   stba013 LIKE stba_t.stba013,  
   stba010 LIKE stba_t.stba010, 
   stba002 LIKE stba_t.stba002, 
   stba003 LIKE stba_t.stba003, 
   stba005 LIKE stba_t.stba005, 
   stba004 LIKE stba_t.stba004, 
   stbastus LIKE stba_t.stbastus, 
   stba006 LIKE stba_t.stba006, 
   stba007 LIKE stba_t.stba007, 
   stba001 LIKE stba_t.stba001, 
   stbasite LIKE stba_t.stbasite, 
   stba011 LIKE stba_t.stba011, 
   stba012 LIKE stba_t.stba012, 
   stba008 LIKE stba_t.stba008, 
   stba009 LIKE stba_t.stba009,
   stba000 LIKE stba_t.stba000
                END RECORD  

   
    #add by geza 20151011(S)
   DEFINE l_str          LIKE type_t.chr10
   DEFINE l_str1         LIKE type_t.chr4
   DEFINE l_str2         LIKE type_t.chr4
   DEFINE l_ooef017      LIKE ooef_t.ooef017
   DEFINE l_glaa003      LIKE glaa_t.glaa003
   DEFINE l_glav001              LIKE glav_t.glav001
   DEFINE l_glav002              LIKE glav_t.glav002
   DEFINE l_glav003              LIKE glav_t.glav003
   DEFINE l_flag                 LIKE type_t.chr1
   DEFINE l_errno                LIKE type_t.chr100
   DEFINE l_glav005              LIKE glav_t.glav005
   DEFINE l_sdate_s              LIKE glav_t.glav004
   DEFINE l_sdate_e              LIKE glav_t.glav004
   DEFINE l_glav006              LIKE glav_t.glav006
   DEFINE l_pdate_s              LIKE glav_t.glav004
   DEFINE l_pdate_e              LIKE glav_t.glav004
   DEFINE l_glav007              LIKE glav_t.glav007
   DEFINE l_wdate_s              LIKE glav_t.glav004
   DEFINE l_wdate_e              LIKE glav_t.glav004
   #add by geza 20151011(E)
   
  
   INITIALIZE l_stba_m.*  LIKE stba_t.* 
    
   LET l_stba_m.stba000 = "astt510"
   LET l_stba_m.stbaownid = g_user
   LET l_stba_m.stbaowndp = g_dept
   LET l_stba_m.stbacrtid = g_user
   LET l_stba_m.stbacrtdp = g_dept 
   LET l_stba_m.stbacrtdt = cl_get_current()
   LET l_stba_m.stbamodid = g_user
   LET l_stba_m.stbamoddt = cl_get_current()
   LET l_stba_m.stbastus  = 'N'
   
   LET l_stba_m.stbaunit = p_site
   LET l_stba_m.stba014  = '2'
   LET l_stba_m.stbasite = p_site    #add by dengdd 151214
#   LET l_stba_m.stbasite = g_site   #mark by dengdd 151214
#   LET l_stba_m.stbadocdt= g_today  #mark by geza 20151011
   #add by geza 20151011(S) 
   LET l_str=p_mhal001
   LET l_str1 = l_str[1,4]
   LET l_str2 = l_str[5,6]
   LET l_ooef017 = NULL
   LET l_glaa003 = NULL
   SELECT ooef017 INTO l_ooef017
     FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = p_site
   SELECT glaa003 INTO l_glaa003
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaacomp = l_ooef017
      AND glaa014 = 'Y'
   CALL s_get_accdate(l_glaa003,'',l_str1,l_str2)
      RETURNING l_flag,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
   LET l_stba_m.stbadocdt= l_pdate_e  
   #add by geza 20151011(E)
   
   LET l_stba_m.stba006  = '15'
   LET l_stba_m.stba013  = p_mhal005
   LET l_stba_m.stbastus = 'N'
   
   
   #单据单别
  LET p_prog='astt510'
  
  SELECT ooef004 INTO l_ooef004 FROM ooef_t WHERE ooef001 = g_site AND ooefent  = g_enterprise 
   
  SELECT  OOBA002 INTO l_ooba002
  FROM OOBA_T
  LEFT OUTER JOIN OOBXL_T ON OOBAENT = OOBXLENT
                         AND OOBA002 = OOBXL001
                         AND OOBXL002 =g_dlang
 WHERE OOBAENT =g_enterprise
   AND OOBA002 IN (SELECT OOBL001
                     FROM OOBL_T
                    WHERE OOBLENT =g_enterprise
                      AND OOBL002 =p_prog)
   AND OOBASTUS = 'Y'
   AND OOBA001 = l_ooef004
  ORDER BY OOBA002
   
  #单据编号
  CALL s_aooi200_gen_docno(p_site,l_ooba002,l_stba_m.stbadocdt,p_prog) RETURNING r_success,l_stba_m.stbadocno
  
   #带出供应商、经营方式、结算方式、结算类型、结算中心、币别、税别(目前抓進項稅),合同編號、業務人員、部門
   SELECT stfa010,stfa003,stfa036,stfa037,
          stfa032,stfa001,stfa015,stfa044 INTO 
          l_stba_m.stba002,l_stba_m.stba003,l_stba_m.stba004,l_stba_m.stba005,
          l_stba_m.stba011,l_stba_m.stba010,l_stba_m.stba008,l_stba_m.stba009
     FROM stfa_t
    WHERE stfaent  =  g_enterprise
      AND stfa005  =  l_stba_m.stba013
      AND stfastus =  'Y' 
#      AND stfa019  <= l_stba_m.stbadocdt    #mark by dengdd
#      AND stfa020  >= l_stba_m.stbadocdt    #mark by dengdd
      AND stfa004 <> '7'                     #add by dengdd

  CALL s_astt401_stey004_get(l_stba_m.stba013,l_stba_m.stbadocdt) RETURNING l_stba_m.stba012   #税别 lanjj add on 2016-07-28
  CALL s_astt401_stey006_get(l_stba_m.stba013,l_stba_m.stbadocdt) RETURNING l_stba_m.stba001   #结算中心 anjj add on 2016-07-28
  LET l_stba_t.stbaunit=l_stba_m.stbaunit
  LET l_stba_t.stbadocdt=l_stba_m.stbadocdt 
  LET l_stba_t.stbadocno=l_stba_m.stbadocno  
  LET l_stba_t.stba014 = l_stba_m.stba014
  LET l_stba_t.stba013 = l_stba_m.stba013
  LET l_stba_t.stba010 = l_stba_m.stba010
  LET l_stba_t.stba002 = l_stba_m.stba002
  LET l_stba_t.stba003 = l_stba_m.stba003
  LET l_stba_t.stba005 = l_stba_m.stba005
  LET l_stba_t.stba004 = l_stba_m.stba004 
  LET l_stba_t.stbastus = l_stba_m.stbastus
  LET l_stba_t.stba006 = l_stba_m.stba006 
  LET l_stba_t.stba007 = l_stba_m.stba007 
  LET l_stba_t.stba001 = l_stba_m.stba001 
  LET l_stba_t.stbasite = l_stba_m.stbasite  
  LET l_stba_t.stba011 = l_stba_m.stba011
  LET l_stba_t.stba012 = l_stba_m.stba012 
  LET l_stba_t.stba008 = l_stba_m.stba008
  LET l_stba_t.stba009 = l_stba_m.stba009
  CALL s_astt401_stey003_get(l_stba_m.stba013,l_stba_m.stbadocdt) RETURNING l_stba_m.stba002    #add by yangxf #供應商編號 
  
   LET l_sql="INSERT INTO stba_t(stbaent,stbaunit,stbadocdt,stbadocno,stba014,stba013,stba010,stba002,stba003,
                                 stba005,stba004,stbastus,stba006,stba007,stba001,stbasite,stba011,stba012, 
                                 stba008,stba009,stbaownid,stbaowndp,stbacrtid,stbacrtdp,stbacrtdt,stbamodid,
                                 stbamoddt,stbacnfid,stbacnfdt,stba000) 
                          VALUES (?,?,?,?,?,   ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?)"
                          
   PREPARE amhp343_insa FROM l_sql
   EXECUTE amhp343_insa USING g_enterprise,l_stba_m.stbaunit,l_stba_m.stbadocdt,l_stba_m.stbadocno,l_stba_m.stba014, 
                   l_stba_m.stba013,l_stba_m.stba010,l_stba_m.stba002,l_stba_m.stba003,l_stba_m.stba005, 
                   l_stba_m.stba004,l_stba_m.stbastus,l_stba_m.stba006,l_stba_m.stba007,l_stba_m.stba001, 
                   l_stba_m.stbasite,l_stba_m.stba011,l_stba_m.stba012,l_stba_m.stba008,l_stba_m.stba009, 
                   l_stba_m.stbaownid,l_stba_m.stbaowndp,l_stba_m.stbacrtid,l_stba_m.stbacrtdp,l_stba_m.stbacrtdt, 
                   l_stba_m.stbamodid,l_stba_m.stbamoddt,l_stba_m.stbacnfid,l_stba_m.stbacnfdt,l_stba_m.stba000
                   
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]<=0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend ="ins stba_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   ELSE
      CALL amhp343_insb(p_mhal001,p_mhal002,p_mhal005,p_mhal019,l_stba_t.*) RETURNING r_success,l_stba_m.stbadocno
   END IF

   RETURN r_success,l_stba_m.stbadocno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL amhp343_insb(p_mhal001,p_mhal002,p_mhal005,p_mhal019,p_stba)
#                  RETURNING  r_success,r_mhaldocno
# Input parameter: p_mhal002      水电费类型
#                : p_mhal005      专柜编号
#                : p_mhal019      实际金额
#                : p_mhal001      会计期间
#                : p_stba      
# Return code....: r_success   
# Date & Author..: 2015/7/28 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_insb(p_mhal001,p_mhal002,p_mhal005,p_mhal019,p_stba)
DEFINE p_mhal001   LIKE mhal_t.mhal001
DEFINE p_mhal002   LIKE mhal_t.mhal002
DEFINE p_mhal019   LIKE mhal_t.mhal019
DEFINE p_mhal005   LIKE mhal_t.mhal005
DEFINE l_glav005   LIKE glav_t.glav005
DEFINE l_glav006   LIKE glav_t.glav006
DEFINE l_glav007   LIKE glav_t.glav007
DEFINE l_glav002   LIKE glav_t.glav002
DEFINE l_glav002_1 LIKE glav_t.glav002
DEFINE l_glav006_1 LIKE glav_t.glav006
DEFINE l_glaa003   LIKE glaa_t.glaa003
DEFINE l_ooef017   LIKE ooef_t.ooef017
DEFINE l_errno     LIKE type_t.chr10
DEFINE l_flag      LIKE type_t.chr1
DEFINE l_sdate_s   LIKE glav_t.glav004
DEFINE l_sdate_e   LIKE glav_t.glav004
DEFINE l_pdate_s   LIKE glav_t.glav004
DEFINE l_pdate_e   LIKE glav_t.glav004
DEFINE l_wdate_s   LIKE glav_t.glav004
DEFINE l_wdate_e   LIKE glav_t.glav004
DEFINE r_success   LIKE type_t.num5
DEFINE l_sql       STRING
DEFINE p_stba      RECORD 
   stbaunit LIKE stba_t.stbaunit,    
   stbadocdt LIKE stba_t.stbadocdt, 
   stbadocno LIKE stba_t.stbadocno, 
   stba014 LIKE stba_t.stba014, 
   stba013 LIKE stba_t.stba013,  
   stba010 LIKE stba_t.stba010, 
   stba002 LIKE stba_t.stba002, 
   stba003 LIKE stba_t.stba003, 
   stba005 LIKE stba_t.stba005, 
   stba004 LIKE stba_t.stba004, 
   stbastus LIKE stba_t.stbastus, 
   stba006 LIKE stba_t.stba006, 
   stba007 LIKE stba_t.stba007, 
   stba001 LIKE stba_t.stba001, 
   stbasite LIKE stba_t.stbasite, 
   stba011 LIKE stba_t.stba011, 
   stba012 LIKE stba_t.stba012, 
   stba008 LIKE stba_t.stba008, 
   stba009 LIKE stba_t.stba009,
   stba000 LIKE stba_t.stba000    
                   END RECORD
DEFINE l_stbb_d  RECORD
   stbbseq LIKE stbb_t.stbbseq, 
   stbb001 LIKE stbb_t.stbb001, 
   stbb015 LIKE stbb_t.stbb015, 
   stbb016 LIKE stbb_t.stbb016, 
   stbb002 LIKE stbb_t.stbb002, 
   stbb003 LIKE stbb_t.stbb003, 
   stbb004 LIKE stbb_t.stbb004, 
   stbb005 LIKE stbb_t.stbb005, 
   stbb006 LIKE stbb_t.stbb006, 
   stbb018 LIKE stbb_t.stbb018, 
   stbb007 LIKE stbb_t.stbb007, 
   stbb008 LIKE stbb_t.stbb008, 
   stbb014 LIKE stbb_t.stbb014, 
   stbb009 LIKE stbb_t.stbb009, 
   stbb010 LIKE stbb_t.stbb010, 
   stbb013 LIKE stbb_t.stbb013, 
   stbbsite LIKE stbb_t.stbbsite, 
   stbb012 LIKE stbb_t.stbb012, 
   stbb011 LIKE stbb_t.stbb011, 
   stbbunit LIKE stbb_t.stbbunit,
   stbbdocno LIKE stbb_t.stbbdocno,
   stbb019 LIKE stbb_t.stbb019,    #add by geza 20150831
   stbbud001 LIKE stbb_t.stbbud001, #add by geza 20151010 
   stbb017   LIKE stbb_t.stbb017    #add by dengdd 151223
                 END RECORD
DEFINE l_mhal007  LIKE mhal_t.mhal007 #add by dengdd 151210
DEFINE l_mhal004  LIKE mhal_t.mhal004 #add by dengdd 151210
   
   INITIALIZE l_stbb_d.* LIKE stbb_t.*
   
   
   
   LET r_success=TRUE
   
   LET l_stbb_d.stbbdocno=p_stba.stbadocno
#   LET l_stbb_d.stbbunit=g_site          #mark by dengdd 151215
   LET l_stbb_d.stbbunit=p_stba.stbasite  #add by dengdd 151215
   LET l_stbb_d.stbbsite=p_stba.stbasite
   LET l_stbb_d.stbb009 = p_mhal019
   
   
   #mark by geza 20150831(S)
#   #结算账期
#   SELECT DISTINCT stfj_t.stfjseq INTO l_stbb_d.stbb018
#              FROM stba_t,stbb_t,stfa_t,stfj_t
#             WHERE stbadocno = stbbdocno
#               AND stba013 = stfa005
#               AND stfa001 = stfj001
#               AND stbadocno = p_stba.stbadocno
#               AND stfj002 <= stbadocdt 
#               AND stfj003 >= stbadocdt
   #mark by geza 20150831(E)
   #项次
   SELECT MAX(stbbseq) INTO l_stbb_d.stbbseq
     FROM stbb_t
     WHERE stbbent= g_enterprise
       AND stbbdocno= p_stba.stbadocno
       
   IF cl_null(l_stbb_d.stbbseq) THEN
      LET l_stbb_d.stbbseq=1
   ELSE
      LET  l_stbb_d.stbbseq=l_stbb_d.stbbseq+1
   END IF 
                        
   
   #费用编号
#   SELECT stfl002 INTO l_stbb_d.stbb001
#     FROM stfa_t LEFT OUTER JOIN stfl_t ON stfaent=stflent AND stfa001=stfl001
#    WHERE stfa001=p_mhal005
#      AND stfl003=p_mhal002
      
   #add by dengdd 151210(S)
   #根据类型判断属于专柜水电费/资源水电费
   SELECT mhal004,mhal007 INTO l_mhal004 FROM mhal_t 
    WHERE mhalent=g_enterprise AND mhal001=p_mhal001 AND mhal002=p_mhal002 AND mhal005=p_mhal005
    
   IF l_mhal004 = '3' AND NOT cl_null(l_mhal007) THEN
      SELECT rtar003 INTO l_stbb_d.stbb001
        FROM rtar_t
       WHERE rtarent=g_enterprise
         AND rtar002=l_mhal007
         AND rtar004=p_mhal002
   END IF
   
   IF l_mhal004 = '2' THEN 
      SELECT stfl002 INTO l_stbb_d.stbb001 
        FROM stfa_t,stfl_t
       WHERE stfaent = stflent AND stfa001 = stfl001 
         AND stfa005 = p_mhal005 
         AND stfl003 = p_mhal002
   END IF
   #add by dengdd 151210(E)
#mark by dengdd 151210(S)
#   SELECT stfl002 INTO l_stbb_d.stbb001 
#     FROM stfa_t,stfl_t
#    WHERE stfaent = stflent AND stfa001 = stfl001 
#      AND stfa005 = p_mhal005 
#      AND stfl003 = p_mhal002
#mark by dengdd 151210(E)
      
   #價款類別
   SELECT stae006 INTO l_stbb_d.stbb004
     FROM stae_t 
    WHERE staeent=g_enterprise
      AND stae001=l_stbb_d.stbb001   
   #mark by geza 20150903(S)
   #帶出納入結算單否，票扣否
#    SELECT stae011,stae007 INTO l_stbb_d.stbb015,l_stbb_d.stbb016
#      FROM stae_t
#     WHERE staeent = g_enterprise   
#       AND stae001 = l_stbb_d.stbb001
#       
#    IF cl_null(l_stbb_d.stbb015) THEN
#       LET l_stbb_d.stbb015 = 'Y' 
#    END IF
#    IF cl_null(l_stbb_d.stbb016) THEN
#       LET l_stbb_d.stbb016 = 'N' 
#    END IF
    #mark by geza 20150903(E)
   #add by geza 20150903(S)
   #根据合同帶出納入結算單否，票扣否 
   SELECT stfl005,stfl006 INTO l_stbb_d.stbb015,l_stbb_d.stbb016 
     FROM stfa_t,stfl_t
    WHERE stfaent = stflent AND stfa001 = stfl001 
      AND stfa005 = p_mhal005 
      AND stfl003 = p_mhal002
      AND stflent = g_enterprise   
   #add by geza 20150903(E)
    
#   #mark by geza 20150831(S)
#   #主品类
#   SELECT stfa011 INTO l_stbb_d.stbb011
#     FROM stfa_t
#    WHERE stfaent  =  g_enterprise
#      AND stfa001  =  p_stba.stba010
#      AND stfastus =  'Y' 
#      AND stfa019  <= p_stba.stbadocdt
#      AND stfa020  >= p_stba.stbadocdt
#   #mark by geza 20150831(E)   
   #add by geza 20150831(S)
   #管理品类
   SELECT stfa051 INTO l_stbb_d.stbb011
     FROM stfa_t
    WHERE stfaent  =  g_enterprise
      AND stfa001  =  p_stba.stba010
      AND stfastus =  'Y' 
#      AND stfa019  <= p_stba.stbadocdt   #mark by dengdd 151215
#      AND stfa020  >= p_stba.stbadocdt   #mark by dengdd 151215
   #add by geza 20150831(E)
#   LET l_stbb_d.stbb005=g_today
#   #add by geza 20151010(S) #含发票否
#   SELECT stfa050 INTO l_stbb_d.stbbud001
#     FROM stfa_t
#    WHERE stfaent = g_enterprise
#      AND stfa001 = p_stba.stba010 
#   #add by geza 20151010(E) lanjj mark
   CALL s_astt401_stey005_get(p_stba.stba013,p_stba.stbadocdt) RETURNING l_stbb_d.stbbud001 #含发票否 lanjj add on 2016-07-28
   LET l_stbb_d.stbb010='1'
   LET l_stbb_d.stbb013='1'
   
   #币别，税别
   LET l_stbb_d.stbb002=p_stba.stba011
#   LET l_stbb_d.stbb003=p_stba.stba012   #mark by dengdd 151014
#add by dengdd 151014---str--------
#票扣否=Y，税带合同里面的，票扣否=N，税带费用编号asti203里面的   
   IF l_stbb_d.stbb016='Y' THEN 
#      SELECT stfa033 INTO l_stbb_d.stbb003
#        FROM stfa_t
#       WHERE stfaent=g_enterprise
#         AND stfa001=p_stba.stba010
       CALL s_astt401_stey004_get(p_stba.stba013,p_stba.stbadocdt) RETURNING l_stbb_d.stbb003   #税别 lanjj add on 2016-07-28   
   ELSE
       SELECT stae010 INTO l_stbb_d.stbb003
        FROM stae_t
       WHERE staeent = g_enterprise
         AND stae001 = l_stbb_d.stbb001 
   END IF
#add by dengdd 151014---end--------
  
   #所属部门
   LET l_stbb_d.stbb012=p_stba.stba009
   
    #截止日期,结算会计期,会计年度,会计期别

     #抓取法人對應會計週期參照表
     LET l_ooef017 = NULL
     LET l_glaa003 = NULL
            
     SELECT ooef017 INTO l_ooef017 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site
               
     SELECT glaa003 INTO l_glaa003 FROM glaa_t WHERE glaaent = g_enterprise AND glaacomp = l_ooef017 AND glaa014 = 'Y'
               
     #取得會計週期資料
     #CALL s_get_accdate(l_glaa003,g_today,'','')           #mark by geza 20151011
     CALL s_get_accdate(l_glaa003,p_stba.stbadocdt,'','')   #add by geza 20151011
           RETURNING l_flag,l_errno,l_glav002,l_glav005,l_sdate_s,l_sdate_e,
                     l_glav006,l_pdate_s,l_pdate_e,l_glav007,l_wdate_s,l_wdate_e
                           
  LET l_stbb_d.stbb005=l_pdate_s
  LET l_stbb_d.stbb006=l_pdate_e
                      
   CALL s_asti206_get_period(l_stbb_d.stbb005,l_stbb_d.stbb006,l_stbb_d.stbbsite,'astt510')
               RETURNING r_success, l_stbb_d.stbb007,l_stbb_d.stbb008, l_stbb_d.stbb014
               
   #add by geza 20150831(S)
   #根据开始日期结束日期抓取结算账期和结算日期
   CALL s_settle_date_get_stbb019(p_stba.stba010,l_stbb_d.stbb005,l_stbb_d.stbb005,'2') 
      RETURNING  l_stbb_d.stbb018,l_stbb_d.stbb019  
   CALL s_curr_round(p_stba.stbasite,l_stbb_d.stbb002,l_stbb_d.stbb009,'2') RETURNING l_stbb_d.stbb009  #add by yangxf
   #add by geza 20150831(E)
   #add by dengdd 151223(S)---备注
   SELECT mhal024 INTO l_stbb_d.stbb017 FROM mhal_t
    WHERE mhalent=g_enterprise AND mhalsite=l_stbb_d.stbbsite 
      AND mhal001=p_mhal001 AND mhal002=p_mhal002 AND mhal005=p_mhal005
   #add by dengdd 151223(E)
   LET l_sql="INSERT INTO stbb_t (stbbent,stbbdocno,stbbseq,stbb001,stbb015,stbb016,stbb002,
                                  stbb003,stbb004,stbb005,stbb006,stbb018,stbb007,stbb008,stbb014,
                                  stbb009,stbb010,stbb013,stbbsite,stbb012,stbb011,stbbunit,stbb019,stbbud001,stbb017) 
                          VALUES (?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?,  ?,?,?,?,?, ?,?,?,?,?)"        #add by geza 20150831 stbb019,20151010 stbbud001 ##160331-00021#1 add by yangxf 20160331 add ?
   
   PREPARE amhp343_insb FROM l_sql
   EXECUTE amhp343_insb USING g_enterprise,l_stbb_d.stbbdocno,l_stbb_d.stbbseq,l_stbb_d.stbb001,l_stbb_d.stbb015,
                              l_stbb_d.stbb016,l_stbb_d.stbb002,l_stbb_d.stbb003,l_stbb_d.stbb004,l_stbb_d.stbb005,
                              l_stbb_d.stbb006,l_stbb_d.stbb018,l_stbb_d.stbb007,l_stbb_d.stbb008,l_stbb_d.stbb014,
                              l_stbb_d.stbb009,l_stbb_d.stbb010,l_stbb_d.stbb013,l_stbb_d.stbbsite,l_stbb_d.stbb012,
                              l_stbb_d.stbb011,l_stbb_d.stbbunit,l_stbb_d.stbb019,l_stbb_d.stbbud001,l_stbb_d.stbb017          #add by geza 20150831 stbb019,20151010 stbbud001
   
    IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]<=0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend ="ins stbb_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
    END IF 

    RETURN r_success,p_stba.stbadocno
    
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL amhp343_upd(p_mhalsite,p_mhal001,p_mhal002,p_mhal004,p_mhal005,p_mhal007,p_docno)
#                  RETURNING r_success
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2015/7/29 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_upd(p_mhalsite,p_mhal001,p_mhal002,p_mhal004,p_mhal005,p_mhal007,p_docno)
DEFINE p_mhalsite   LIKE mhal_t.mhalsite
DEFINE p_mhal001    LIKE mhal_t.mhal001
DEFINE p_mhal002    LIKE mhal_t.mhal002
DEFINE p_mhal004    LIKE mhal_t.mhal004
DEFINE p_mhal005    LIKE mhal_t.mhal005
DEFINE p_mhal007    LIKE mhal_t.mhal007
DEFINE p_docno      LIKE mhal_t.mhal023
DEFINE r_success    LIKE type_t.num5
DEFINE l_sql        STRING
DEFINE l_mhalcnfdt    DATETIME YEAR TO SECOND
DEFINE l_mhal019    LIKE mhal_t.mhal019
DEFINE l_upd        STRING

       LET r_success = TRUE 
 #      LET l_mhalcnfdt = cl_get_current() 
 
       SELECT mhal019 INTO l_mhal019  FROM mhal_t 
                                 WHERE mhalent=g_enterprise 
                                   AND mhalsite=p_mhalsite
                                   AND mhal001 =p_mhal001
                                   AND mhal002 =p_mhal002
                                   AND mhal004 =p_mhal004
                                   AND mhal005 =p_mhal005
                                   AND mhal007 =p_mhal007
                                   
       IF l_mhal019<=0 THEN
          LET l_upd=" mhal022 ='N'"
       ELSE
          LET l_upd=" mhal022 ='Y'"
       END IF
       
       LET l_sql="UPDATE mhal_t SET mhal023 = '",p_docno,"',",l_upd,
                 #"            WHERE mhalsite = '",p_mhalsite,"'",   #160905-00003#6 20160905 mark by beckxie
                 "            WHERE mhalent = ",g_enterprise,       #160905-00003#6 20160905 add by beckxie
                 "              AND mhalsite = '",p_mhalsite,"'",   #160905-00003#6 20160905 add by beckxie
                 "              AND mhal001 = '",p_mhal001,"'",
                 "              AND mhal002 = '",p_mhal002,"'",
                 "              AND mhal004 = '",p_mhal004,"'",
                 "              AND mhal005 = '",p_mhal005,"'",
                 "              AND mhal007 = '",p_mhal007,"'"
                 
                 
       PREPARE amhp343_upd1 FROM l_sql
       EXECUTE amhp343_upd1
       
       IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]<=0 THEN
          INITIALIZE g_errparam TO NULL 
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend ="upd mhal_t"
          LET g_errparam.popup = TRUE
          CALL cl_err()
          LET r_success = FALSE
       END IF 

       RETURN r_success
       
       
       
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL amhp343_chk(p_mhalsite,p_mhal001,p_mhal005)
#                  RETURNING r_success，r_mhaldocno
# Input parameter: p_mhalsite     营运组织
#                : p_mhal001      会计期间
#                : p_mhal004      类型
#                : p_mhal005      专柜编号
# Return code....: r_success      
#                : r_mhaldocno    费用单号
# Date & Author..: 2015/7/29 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_chk(p_mhalsite,p_mhal001,p_mhal004,p_mhal005)
DEFINE p_mhalsite    LIKE mhal_t.mhalsite
DEFINE p_mhal001     LIKE mhal_t.mhal001
DEFINE p_mhal004     LIKE mhal_t.mhal004
DEFINE p_mhal005     LIKE mhal_t.mhal005
DEFINE r_mhaldocno   LIKE mhal_t.mhal023
DEFINE r_success     LIKE type_t.num5
DEFINE l_sql         STRING   #161228-00033#3 by sakura add

      LET r_success=TRUE
      #161228-00033#3 by sakura mark(S)
      #SELECT DISTINCT mhal023 INTO r_mhaldocno
      #  FROM mhal_t
      # #WHERE mhalsite=p_mhalsite   #160905-00003#6 20160905 mark by beckxie
      # WHERE mhalent = g_enterprise #160905-00003#6 20160905 add by beckxie 
      #   AND mhalsite=p_mhalsite    #160905-00003#6 20160905 add by beckxie
      #   AND mhal001=p_mhal001
      #   AND mhal004=p_mhal004
      #   AND mhal005=p_mhal005
      #   AND rownum=1
      #161228-00033#3 by sakura mark(E)
      #161228-00033#3 by sakura add(S)
      LET r_mhaldocno = ''
      LET l_sql = "SELECT DISTINCT mhal023 ",
                  "  FROM mhal_t ",
                  " WHERE mhalent = ",g_enterprise,
                  "   AND mhalsite = '",p_mhalsite,"'",
                  "   AND mhal001 = '",p_mhal001,"'",
                  "   AND mhal004 = '",p_mhal004,"'",
                  "   AND mhal005 = '",p_mhal005,"'"
      PREPARE amhp343_sel_mhal023_pre FROM l_sql
      DECLARE amhp343_sel_mhal023_cur SCROLL CURSOR FOR amhp343_sel_mhal023_pre   
      OPEN amhp343_sel_mhal023_cur   
      FETCH FIRST amhp343_sel_mhal023_cur INTO r_mhaldocno
      CLOSE amhp343_sel_mhal023_cur               
      FREE amhp343_sel_mhal023_pre                   
      #161228-00033#3 by sakura add(E)
          
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend ="sel mhal_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
      END IF
      
      RETURN r_success,r_mhaldocno
      
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2015/11/11 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_check()
#DEFINE l_mhav      RECORD LIKE mhav_t.*   #161104-00002#2 by sakura mark
#161104-00002#2 by sakura add(S)
DEFINE l_mhav RECORD  #水電費匯入資料暫存表
       mhavent LIKE mhav_t.mhavent, #企業編號
       mhavsite LIKE mhav_t.mhavsite, #營運據點
       mhavunit LIKE mhav_t.mhavunit, #應用組織
       mhav001 LIKE mhav_t.mhav001, #會計期間
       mhav002 LIKE mhav_t.mhav002, #水電費類型
       mhav003 LIKE mhav_t.mhav003, #來源類型
       mhav004 LIKE mhav_t.mhav004, #類型
       mhav005 LIKE mhav_t.mhav005, #专柜编号
       mhav006 LIKE mhav_t.mhav006, #資源編號
       mhav007 LIKE mhav_t.mhav007, #度數/噸數每小時
       mhav008 LIKE mhav_t.mhav008, #單價
       mhav009 LIKE mhav_t.mhav009, #金額
       mhav010 LIKE mhav_t.mhav010, #上月讀數
       mhav011 LIKE mhav_t.mhav011, #本月讀數
       mhav012 LIKE mhav_t.mhav012, #本月實際度數/噸數
       mhav013 LIKE mhav_t.mhav013, #標準經營時數
       mhav014 LIKE mhav_t.mhav014, #實際營業時數
       mhav015 LIKE mhav_t.mhav015, #實際單價
       mhav016 LIKE mhav_t.mhav016, #實際金額
       mhav017 LIKE mhav_t.mhav017, #分攤原則
       mhav018 LIKE mhav_t.mhav018  #備註
END RECORD
#161104-00002#2 by sakura add(E)
DEFINE l_cnt       LIKE type_t.num10
DEFINE r_success   LIKE type_t.num5  
DEFINE l_sql       STRING 
DEFINE l_stfa004   LIKE stfa_t.stfa004

   LET r_success = TRUE
   CALL cl_err_collect_init()   
   INITIALIZE l_mhav.* TO NULL
   #LET l_sql = " SELECT * FROM mhav_t ",      #161104-00002#2 by sakura mark
      #161104-00002#2 by sakura add(S)
   LET l_sql = " SELECT mhavent,mhavsite,mhavunit,mhav001,mhav002,mhav003, ",
               "        mhav004,mhav005 ,mhav006 ,mhav007,mhav008,mhav009, ",
               "        mhav010,mhav011 ,mhav012 ,mhav013,mhav014,mhav015, ",
               "        mhav016,mhav017 ,mhav018 ",
               " FROM mhav_t ",
   #161104-00002#2 by sakura add(E)
               "  WHERE mhavent = ",g_enterprise #, #mark by dengdd 151214
#              "    AND mhavsite = '",g_site,"'"
   PREPARE sel_mha_chk FROM l_sql
   DECLARE sel_mha_chk_cs CURSOR FOR sel_mha_chk
   
   #FOREACH sel_mha_chk_cs INTO l_mhav.*   #161104-00002#2 by sakura mark
   #161104-00002#2 by sakura add(S)
   FOREACH sel_mha_chk_cs INTO l_mhav.mhavent,l_mhav.mhavsite,l_mhav.mhavunit,l_mhav.mhav001,l_mhav.mhav002,l_mhav.mhav003,
                               l_mhav.mhav004,l_mhav.mhav005 ,l_mhav.mhav006 ,l_mhav.mhav007,l_mhav.mhav008,l_mhav.mhav009,
                               l_mhav.mhav010,l_mhav.mhav011 ,l_mhav.mhav012 ,l_mhav.mhav013,l_mhav.mhav014,l_mhav.mhav015,
                               l_mhav.mhav016,l_mhav.mhav017 ,l_mhav.mhav018
   #161104-00002#2 by sakura add(E)
      IF l_mhav.mhavsite IS NULL THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'afa-00451'
         LET g_errparam.extend = l_mhav.mhavsite
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      END IF
      
      IF l_mhav.mhav001 IS NULL THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'amh-00617'
         LET g_errparam.extend = l_mhav.mhav001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      END IF
      
      IF l_mhav.mhav002 IS NULL THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'amh-00618'
         LET g_errparam.extend = l_mhav.mhav002
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      END IF
      
      IF l_mhav.mhav005 IS NULL THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ast-00353'
         LET g_errparam.extend = l_mhav.mhav005
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      END IF
      
      #add by dengdd 151216(S)--如果类型为“资源协议”，资源编号不允许为空
      IF l_mhav.mhav004='3' AND cl_null(l_mhav.mhav006) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'amr-00062'
         LET g_errparam.extend = l_mhav.mhav006
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      END IF
      #add by dengdd 151216(S)
      
      #判断营运组织是否有效
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt
        FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_mhav.mhavsite
      IF l_cnt <= 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'aoo-00094'
         LET g_errparam.extend = l_mhav.mhavsite
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      ELSE
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt
           FROM ooef_t
          WHERE ooefent = g_enterprise
            AND ooef001 = l_mhav.mhavsite
            AND ooefstus = 'Y'
         IF l_cnt <= 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code =  'sub-01302'  #160318-00005#23 mod'aoo-00095'
            LET g_errparam.extend = l_mhav.mhavsite
            #160318-00005#23  --add--str
            LET g_errparam.replace[1] ='aooi125'
            LET g_errparam.replace[2] = cl_get_progname('aooi125',g_lang,"2")
            LET g_errparam.exeprog    ='aooi125'
            #160318-00005#23 --add--end
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success=FALSE
         END IF                
      END IF 
      
      #判断专柜编号是否有效
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt
        FROM mhae_t 
       WHERE mhaeent = g_enterprise 
         AND mhae001 = l_mhav.mhav005
      IF l_cnt <= 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'amh-00023'
         LET g_errparam.extend = l_mhav.mhav005
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      ELSE
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt
           FROM mhae_t 
          WHERE mhaeent = g_enterprise 
            AND mhae001 = l_mhav.mhav005
            AND mhaestus = 'Y'
         IF l_cnt <= 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'amh-00024'
            LET g_errparam.extend = l_mhav.mhav005
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET r_success=FALSE
         END IF                
      END IF
      
      #判断专柜合同是否失效
      LET l_cnt=0
      SELECT stfa004 INTO l_stfa004
        FROM stfa_t
       WHERE stfaent =g_enterprise
         AND stfasite=l_mhav.mhavsite
         AND stfa005 =l_mhav.mhav005
      IF l_stfa004 = '7' THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'ast-00367'
         LET g_errparam.extend = l_mhav.mhav005
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success=FALSE
      END IF     
        
   END FOREACH
   
   CALL cl_err_collect_show()
   RETURN r_success
     
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 2015/11/11 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_insert()
DEFINE l_sql       STRING
#DEFINE l_mhav      RECORD LIKE mhav_t.*    #161104-00002#2 by sakura mark
#DEFINE l_mhal      RECORD LIKE mhal_t.*    #161104-00002#2 by sakura mark
#DEFINE l_stfa      RECORD LIKE stfa_t.*    #161104-00002#2 by sakura mark
#161104-00002#2 by sakura add(S)
DEFINE l_mhav RECORD  #水電費匯入資料暫存表
       mhavent LIKE mhav_t.mhavent, #企業編號
       mhavsite LIKE mhav_t.mhavsite, #營運據點
       mhavunit LIKE mhav_t.mhavunit, #應用組織
       mhav001 LIKE mhav_t.mhav001, #會計期間
       mhav002 LIKE mhav_t.mhav002, #水電費類型
       mhav003 LIKE mhav_t.mhav003, #來源類型
       mhav004 LIKE mhav_t.mhav004, #類型
       mhav005 LIKE mhav_t.mhav005, #专柜编号
       mhav006 LIKE mhav_t.mhav006, #資源編號
       mhav007 LIKE mhav_t.mhav007, #度數/噸數每小時
       mhav008 LIKE mhav_t.mhav008, #單價
       mhav009 LIKE mhav_t.mhav009, #金額
       mhav010 LIKE mhav_t.mhav010, #上月讀數
       mhav011 LIKE mhav_t.mhav011, #本月讀數
       mhav012 LIKE mhav_t.mhav012, #本月實際度數/噸數
       mhav013 LIKE mhav_t.mhav013, #標準經營時數
       mhav014 LIKE mhav_t.mhav014, #實際營業時數
       mhav015 LIKE mhav_t.mhav015, #實際單價
       mhav016 LIKE mhav_t.mhav016, #實際金額
       mhav017 LIKE mhav_t.mhav017, #分攤原則
       mhav018 LIKE mhav_t.mhav018  #備註
END RECORD
DEFINE l_mhal RECORD  #專櫃自用水電費資料檔
       mhalent LIKE mhal_t.mhalent, #企業編號
       mhalsite LIKE mhal_t.mhalsite, #營運組織
       mhalunit LIKE mhal_t.mhalunit, #應用組織
       mhal001 LIKE mhal_t.mhal001, #會計期間
       mhal002 LIKE mhal_t.mhal002, #費用類型
       mhal003 LIKE mhal_t.mhal003, #來源類型
       mhal004 LIKE mhal_t.mhal004, #類型
       mhal005 LIKE mhal_t.mhal005, #专柜编号
       mhal006 LIKE mhal_t.mhal006, #部門編號
       mhal007 LIKE mhal_t.mhal007, #電器編號
       mhal008 LIKE mhal_t.mhal008, #進場日期
       mhal009 LIKE mhal_t.mhal009, #撤櫃日期
       mhal010 LIKE mhal_t.mhal010, #數量
       mhal011 LIKE mhal_t.mhal011, #單價
       mhal012 LIKE mhal_t.mhal012, #金額
       mhal013 LIKE mhal_t.mhal013, #上月讀數
       mhal014 LIKE mhal_t.mhal014, #本月讀數
       mhal015 LIKE mhal_t.mhal015, #本月實際度數/噸數
       mhal016 LIKE mhal_t.mhal016, #標準經營時數
       mhal017 LIKE mhal_t.mhal017, #實際營業時數
       mhal018 LIKE mhal_t.mhal018, #實際單價
       mhal019 LIKE mhal_t.mhal019, #實際金額
       mhal020 LIKE mhal_t.mhal020, #品類編號
       mhal021 LIKE mhal_t.mhal021, #分攤原則
       mhal022 LIKE mhal_t.mhal022, #產生費用單否
       mhal023 LIKE mhal_t.mhal023, #費用單號
       mhal024 LIKE mhal_t.mhal024, #備註
       mhalstus LIKE mhal_t.mhalstus, #資料狀態碼
       mhalownid LIKE mhal_t.mhalownid, #資料所有者
       mhalowndp LIKE mhal_t.mhalowndp, #資料所有部門
       mhalcrtid LIKE mhal_t.mhalcrtid, #資料建立者
       mhalcrtdp LIKE mhal_t.mhalcrtdp, #資料建立部門
       mhalcrtdt LIKE mhal_t.mhalcrtdt, #資料創建日
       mhalmodid LIKE mhal_t.mhalmodid, #資料修改者
       mhalmoddt LIKE mhal_t.mhalmoddt, #最近修改日
       mhalcnfid LIKE mhal_t.mhalcnfid, #資料確認者
       mhalcnfdt LIKE mhal_t.mhalcnfdt, #資料確認日
       mhal025 LIKE mhal_t.mhal025, #優惠度數
       mhal026 LIKE mhal_t.mhal026  #優惠金額
END RECORD
DEFINE l_stfa RECORD  #專櫃合約主檔
       stfaent LIKE stfa_t.stfaent, #企業編號
       stfasite LIKE stfa_t.stfasite, #營運據點
       stfaunit LIKE stfa_t.stfaunit, #制定組織
       stfaacti LIKE stfa_t.stfaacti, #合約有效
       stfa001 LIKE stfa_t.stfa001, #合約編號
       stfa002 LIKE stfa_t.stfa002, #版本
       stfa003 LIKE stfa_t.stfa003, #經營方式
       stfa004 LIKE stfa_t.stfa004, #合約狀態
       stfa005 LIKE stfa_t.stfa005, #专柜编号
       stfa006 LIKE stfa_t.stfa006, #專櫃類型
       stfa007 LIKE stfa_t.stfa007, #建築面積
       stfa008 LIKE stfa_t.stfa008, #經營面積
       stfa009 LIKE stfa_t.stfa009, #檔案編號
       stfa010 LIKE stfa_t.stfa010, #供應商編號
       stfa011 LIKE stfa_t.stfa011, #主品類
       stfa012 LIKE stfa_t.stfa012, #主品牌
       stfa013 LIKE stfa_t.stfa013, #模板編號
       stfa014 LIKE stfa_t.stfa014, #簽訂法人
       stfa015 LIKE stfa_t.stfa015, #簽訂人員
       stfa016 LIKE stfa_t.stfa016, #簽訂日期
       stfa017 LIKE stfa_t.stfa017, #進場日期
       stfa018 LIKE stfa_t.stfa018, #撤場日期
       stfa019 LIKE stfa_t.stfa019, #生效日期
       stfa020 LIKE stfa_t.stfa020, #失效日期
       stfa021 LIKE stfa_t.stfa021, #作廢日期
       stfa022 LIKE stfa_t.stfa022, #甲方日期
       stfa023 LIKE stfa_t.stfa023, #乙方日期
       stfa024 LIKE stfa_t.stfa024, #清退日期
       stfa025 LIKE stfa_t.stfa025, #延期日期
       stfa026 LIKE stfa_t.stfa026, #蓋章日期
       stfa027 LIKE stfa_t.stfa027, #文字蓋章否
       stfa028 LIKE stfa_t.stfa028, #按天產生銷售成本
       stfa029 LIKE stfa_t.stfa029, #收銀方式
       stfa030 LIKE stfa_t.stfa030, #定價屬性
       stfa031 LIKE stfa_t.stfa031, #專櫃ABC
       stfa032 LIKE stfa_t.stfa032, #幣別
       stfa033 LIKE stfa_t.stfa033, #進項稅
       stfa034 LIKE stfa_t.stfa034, #銷項稅
       stfa035 LIKE stfa_t.stfa035, #收付款方式
       stfa036 LIKE stfa_t.stfa036, #結算方式
       stfa037 LIKE stfa_t.stfa037, #結算類別
       stfa038 LIKE stfa_t.stfa038, #結算中心
       stfa039 LIKE stfa_t.stfa039, #基本提成率
       stfa040 LIKE stfa_t.stfa040, #增值稅扣率
       stfa041 LIKE stfa_t.stfa041, #合約摘要
       stfa042 LIKE stfa_t.stfa042, #經營範圍說明
       stfa043 LIKE stfa_t.stfa043, #備註
       stfa044 LIKE stfa_t.stfa044, #所屬部門
       stfa045 LIKE stfa_t.stfa045, #管理方式
       stfa046 LIKE stfa_t.stfa046, #業態
       stfa047 LIKE stfa_t.stfa047, #樓棟
       stfa048 LIKE stfa_t.stfa048, #樓層
       stfa049 LIKE stfa_t.stfa049, #續簽日期
       stfaownid LIKE stfa_t.stfaownid, #資料所屬者
       stfaowndp LIKE stfa_t.stfaowndp, #資料所有部門
       stfacrtid LIKE stfa_t.stfacrtid, #資料建立者
       stfacrtdp LIKE stfa_t.stfacrtdp, #資料建立部門
       stfacrtdt LIKE stfa_t.stfacrtdt, #資料創建日
       stfamodid LIKE stfa_t.stfamodid, #資料修改者
       stfamoddt LIKE stfa_t.stfamoddt, #最近修改日
       stfastus LIKE stfa_t.stfastus, #狀態碼
       stfacnfid LIKE stfa_t.stfacnfid, #資料確認者
       stfacnfdt LIKE stfa_t.stfacnfdt, #資料確認日
       stfa050 LIKE stfa_t.stfa050, #代扣代繳稅否
       stfa051 LIKE stfa_t.stfa051, #管理品類
       stfa052 LIKE stfa_t.stfa052, #最低折扣率
       stfa053 LIKE stfa_t.stfa053, #促銷庫區參與保底否
       stfa054 LIKE stfa_t.stfa054, #是否補差
       stfa055 LIKE stfa_t.stfa055, #庫區商品化否
       stfa056 LIKE stfa_t.stfa056  #工衣情況
END RECORD
#161104-00002#2 by sakura add(E)
DEFINE l_success   LIKE type_t.num5
DEFINE r_success   LIKE type_t.num5
DEFINE l_where     STRING


   WHENEVER ERROR CONTINUE
   
   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   LET l_success = TRUE
   LET g_cnt1 = 0
   #add by dengdd 151215(S)
#   CALL s_aooi500_sql_where(g_prog,'mhavsite') RETURNING l_where
#   LET l_where = g_wc CLIPPED," AND ",l_where CLIPPED
   #add by dengdd 151215(E)
   INITIALIZE l_mhav.* TO NULL
   
   #LET l_sql = " SELECT * ",   #161104-00002#2 by sakura mark
   LET l_sql = " SELECT mhavent,mhavsite,mhavunit,mhav001,mhav002,mhav003, ",
               "        mhav004,mhav005 ,mhav006 ,mhav007,mhav008,mhav009, ",
               "        mhav010,mhav011 ,mhav012 ,mhav013,mhav014,mhav015, ",
               "        mhav016,mhav017 ,mhav018 ",
   #161104-00002#2 by sakura add(E)  
               " FROM mhav_t WHERE mhavent =",g_enterprise," AND mhavsite='",g_site,"'"   #mark by dengdd 151214
   PREPARE sel_mhav FROM l_sql
   DECLARE sel_mhav_cs CURSOR FOR sel_mhav
   
   #FOREACH sel_mhav_cs INTO l_mhav.*   #161104-00002#2 by sakura mark
   #161104-00002#2 by sakura add(S)
   FOREACH sel_mhav_cs INTO l_mhav.mhavent,l_mhav.mhavsite,l_mhav.mhavunit,l_mhav.mhav001,l_mhav.mhav002,l_mhav.mhav003,
                            l_mhav.mhav004,l_mhav.mhav005 ,l_mhav.mhav006 ,l_mhav.mhav007,l_mhav.mhav008,l_mhav.mhav009,
                            l_mhav.mhav010,l_mhav.mhav011 ,l_mhav.mhav012 ,l_mhav.mhav013,l_mhav.mhav014,l_mhav.mhav015,
                            l_mhav.mhav016,l_mhav.mhav017 ,l_mhav.mhav018   
   #161104-00002#2 by sakura add(E)
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = 'foreach:' 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            LET l_success = FALSE
            EXIT FOREACH
         END IF
         INITIALIZE l_mhal.* TO NULL
        
            
         #预设值
         LET l_mhal.mhalent =g_enterprise    #企业编号
#         LET l_mhal.mhalsite=l_mhav.mhavsite #营运组织  #mark by dengdd 151214
#         LET l_mhal.mhalunit=g_site          #应用组织
         LET l_mhal.mhal001 = l_mhav.mhav001 #会计期间
         LET l_mhal.mhal002 = l_mhav.mhav002 #费用类型 1.水费 2.电费 3.电话费 4....
         LET l_mhal.mhal003 = '2'            #来源类型
#         LET l_mhal.mhal004 = '2'            #类型   #mark by dengdd 151127
         LET l_mhal.mhal004 = l_mhav.mhav004 #类型   1.门店 2.专柜 3.资源协议
         LET l_mhal.mhal005 = l_mhav.mhav005 #专柜编号
         LET l_mhal.mhal007 = l_mhav.mhav006 #资源编号
         LET l_mhal.mhal010 = l_mhav.mhav007 #度数/吨数每小时
         LET l_mhal.mhal011 = l_mhav.mhav008 #单价
         LET l_mhal.mhal012 = l_mhav.mhav009 #金额
         LET l_mhal.mhal013 = l_mhav.mhav010 #上月读数
         LET l_mhal.mhal014 = l_mhav.mhav011 #本月读数
         LET l_mhal.mhal015 = l_mhav.mhav012 #本月实际度数/吨数
         LET l_mhal.mhal016 = l_mhav.mhav013 #标准经营时数
         LET l_mhal.mhal017 = l_mhav.mhav014 #实际营业时数
         LET l_mhal.mhal018 = l_mhav.mhav015 #实际单价
         LET l_mhal.mhal019 = l_mhav.mhav016 #实际金额
         LET l_mhal.mhal021 = '2'            #分摊原则
         LET l_mhal.mhal022 = 'N'            #产生费用单否
         LET l_mhal.mhal024 = l_mhav.mhav018 #备注
         LET l_mhal.mhalstus= 'N'            #单据状态
         LET l_mhal.mhalownid=g_user
         LET l_mhal.mhalowndp=g_dept
         LET l_mhal.mhalcrtid=g_user
         LET l_mhal.mhalcrtdp=g_dept
         LET l_mhal.mhalcrtdt=g_today
         
         #add by dengdd 151214(S)
         #根据专柜编号带出营运组织
         SELECT mhaesite,mhaeunit INTO l_mhal.mhalsite,l_mhal.mhalunit FROM mhae_t 
          WHERE mhaeent=g_enterprise AND mhae001=l_mhal.mhal005
         #add by dengdd 151214(E)
         
         
         #从astm401中抓取进场日期、撤场日期、管理品类
         SELECT stfa017,stfa018,stfa051
           INTO l_mhal.mhal008,l_mhal.mhal009,l_mhal.mhal020
           FROM stfa_t
          WHERE stfaent =g_enterprise
            #AND stfasite=g_site
            AND stfasite = l_mhal.mhalsite #by lanjj
            AND stfa005 =l_mhal.mhal005
                    
         #若上月读数为空，则取上一会计期的本月读数         
         IF cl_null(l_mhal.mhal013) THEN
            SELECT mhal014 INTO l_mhal.mhal013
              FROM mhal_t
             WHERE mhalent=g_enterprise
               #AND mhalsite=g_site
               AND mhalsite=l_mhal.mhalsite #by lanjj
               AND mhal002=l_mhal.mhal002
               AND mhal005=l_mhal.mhal005
               AND mhal001=(SELECT to_number(to_char(add_months(to_date(l_mhal.mhal001,'yyyymm'),-1),'yyyymm')) AS last_month 
                            FROM dual )
            IF cl_null(l_mhal.mhal013)  THEN 
               LET l_mhal.mhal013=0.00
            END IF
         END IF
         
         #计算度数=本月度数-上月度数
         IF cl_null(l_mhal.mhal010) AND NOT cl_null(l_mhal.mhal014)THEN 
            LET l_mhal.mhal010=l_mhal.mhal014-l_mhal.mhal013
         ELSE
            LET l_mhal.mhal010=0.00
            LET l_mhal.mhal014=0.00
         END IF
         
         #如果单价为空或为0，取合同的单价
#         IF cl_null(l_mhal.mhal011) OR l_mhal.mhal011=0 THEN
        IF (cl_null(l_mhal.mhal011) OR l_mhal.mhal011=0) AND l_mhal.mhal004='2' THEN
            SELECT stfl007
              INTO l_mhal.mhal011
              FROM stfa_t,stfl_t
             WHERE stfaent = stflent
               AND stfasite= stflsite
               AND stfa001 = stfl001
               AND stfa005 = l_mhal.mhal005
               AND stfl003 = l_mhal.mhal002
         END IF
         
         #add by dengdd 151127(S)---资源协议水电费单价
         IF (cl_null(l_mhal.mhal011) OR l_mhal.mhal011=0) AND l_mhal.mhal004='3' THEN
            SELECT rtar008
              INTO l_mhal.mhal011
              FROM rtar_t
             WHERE rtarent=g_enterprise
               AND rtarsite=l_mhal.mhalsite
               AND rtar002= l_mhal.mhal007
               AND rtar004= l_mhal.mhal002
         END IF
         #add by dengdd 151127(E)
         
         #如果金额为null,金额=单价*度数
         IF cl_null(l_mhal.mhal012) THEN
            LET l_mhal.mhal012=l_mhal.mhal011*l_mhal.mhal010
         END IF
         
         #从astm401的水电费设置中抓取优惠金额，优惠度数
         #从artm230的水电费设置中抓取优惠金额，优惠度数 
#mark by dengdd 151127(S)  
#         SELECT stfl008,stfl009
#              INTO l_mhal.mhal025,l_mhal.mhal026
#              FROM stfa_t,stfl_t
#             WHERE stfaent = stflent
#               AND stfasite= stflsite
#               AND stfa001 = stfl001
#               AND stfa005 = l_mhal.mhal005
#               AND stfl003 = l_mhal.mhal002
#mark by dengdd 151127(E) 
#add by dengdd 151127(S)
         IF l_mhal.mhal004='3' THEN 
            SELECT rtar009,rtar010
              INTO l_mhal.mhal025,l_mhal.mhal026
              FROM rtar_t
             WHERE rtarent=g_enterprise
               AND rtarsite=l_mhal.mhalsite
               AND rtar002= l_mhal.mhal007
               AND rtar004= l_mhal.mhal002 
        END IF
        
        IF l_mhal.mhal004='2' THEN
            SELECT stfl008,stfl009
              INTO l_mhal.mhal025,l_mhal.mhal026
              FROM stfa_t,stfl_t
             WHERE stfaent = stflent
               AND stfasite= stflsite
               AND stfa001 = stfl001
               AND stfa005 = l_mhal.mhal005
               AND stfl003 = l_mhal.mhal002               
        END IF
#add by dengdd 151127(E)  

         IF cl_null(l_mhal.mhal025) THEN
            LET l_mhal.mhal025=0
         END IF         
         
         IF cl_null(l_mhal.mhal026) THEN
            LET l_mhal.mhal026=0
         END IF
         #优惠度数不为0，则优惠金额=单价*优惠度数
         IF l_mhal.mhal025<>0 THEN
            LET l_mhal.mhal026=l_mhal.mhal011*l_mhal.mhal025
         END IF
         
         #本月实际度数=度数-优惠度数
         IF cl_null(l_mhal.mhal015) THEN
            LET l_mhal.mhal015=l_mhal.mhal010-l_mhal.mhal025
         END IF
         #本月实际度数小于0，则赋值为0
         IF l_mhal.mhal015<0 THEN
            LET l_mhal.mhal015=0
         END IF
         #实际金额=金额-优惠金额
         IF cl_null(l_mhal.mhal019) THEN
            LET l_mhal.mhal019=l_mhal.mhal012-l_mhal.mhal026
         END IF
         
         #实际金额小于或等于0,实际度数和实际金额都赋值为0
         IF l_mhal.mhal019<=0 THEN
            LET l_mhal.mhal019=0
            LET l_mhal.mhal015=0
         END IF
         #标准经营时数
         IF cl_null(l_mhal.mhal016) THEN
            LET l_mhal.mhal016=0
         END IF
         #实际营业时数
         IF cl_null(l_mhal.mhal017) THEN
            LET l_mhal.mhal017=0
         END IF
         
         #实际单价
         IF cl_null(l_mhal.mhal018) AND l_mhal.mhal015<>0 THEN
            LET l_mhal.mhal018=l_mhal.mhal019/l_mhal.mhal015
         END IF
         
         #本月实际度数为0，实际单价赋值为0
         IF l_mhal.mhal015=0 THEN
            LET l_mhal.mhal018=0
         END IF
         
         #INSERT INTO mhal_t VALUES(l_mhal.*)   #161104-00002#2 by sakura mark
         #161104-00002#2 by sakura add(S)
         INSERT INTO mhal_t(mhalent  ,mhalsite ,mhalunit ,mhal001  ,mhal002  ,mhal003,
                            mhal004  ,mhal005  ,mhal006  ,mhal007  ,mhal008  ,mhal009,
                            mhal010  ,mhal011  ,mhal012  ,mhal013  ,mhal014  ,mhal015,
                            mhal016  ,mhal017  ,mhal018  ,mhal019  ,mhal020  ,mhal021,
                            mhal022  ,mhal023  ,mhal024  ,mhalstus ,mhalownid,mhalowndp,
                            mhalcrtid,mhalcrtdp,mhalcrtdt,mhalmodid,mhalmoddt,mhalcnfid,
                            mhalcnfdt,mhal025  ,mhal026)
         VALUES(l_mhal.mhalent  ,l_mhal.mhalsite ,l_mhal.mhalunit ,l_mhal.mhal001  ,l_mhal.mhal002  ,l_mhal.mhal003,
                l_mhal.mhal004  ,l_mhal.mhal005  ,l_mhal.mhal006  ,l_mhal.mhal007  ,l_mhal.mhal008  ,l_mhal.mhal009,
                l_mhal.mhal010  ,l_mhal.mhal011  ,l_mhal.mhal012  ,l_mhal.mhal013  ,l_mhal.mhal014  ,l_mhal.mhal015,
                l_mhal.mhal016  ,l_mhal.mhal017  ,l_mhal.mhal018  ,l_mhal.mhal019  ,l_mhal.mhal020  ,l_mhal.mhal021,
                l_mhal.mhal022  ,l_mhal.mhal023  ,l_mhal.mhal024  ,l_mhal.mhalstus ,l_mhal.mhalownid,l_mhal.mhalowndp,
                l_mhal.mhalcrtid,l_mhal.mhalcrtdp,l_mhal.mhalcrtdt,l_mhal.mhalmodid,l_mhal.mhalmoddt,l_mhal.mhalcnfid,
                l_mhal.mhalcnfdt,l_mhal.mhal025  ,l_mhal.mhal026)
         #161104-00002#2 by sakura add(E)
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "会计期间：",l_mhal.mhal001,",专柜编号：",l_mhal.mhal005," INTO mhal_t "
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET l_success = FALSE
            EXIT FOREACH   
         END IF
         LET g_cnt1 = g_cnt1 + 1
   END FOREACH
   
   IF l_success THEN 
      CALL cl_err_collect_show()
      CALL s_transaction_end('Y','0')
      RETURN TRUE
   ELSE
      CALL cl_err_collect_show()
      CALL s_transaction_end('N','0')
      RETURN FALSE
   END IF
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 15/11/23 By dengdd
# Modify.........:
################################################################################
PRIVATE FUNCTION amhp343_p_delete()
DEFINE li_ac     LIKE type_t.num5
DEFINE l_success LIKE type_t.num5
DEFINE l_cnt     LIKE type_t.num5


       WHENEVER ERROR CONTINUE
       
       CALL s_transaction_begin()
       CALL cl_err_collect_init()
       LET l_success = TRUE
       LET l_cnt = 0 
       
       FOR li_ac=1 TO g_detail_d.getlength()
         IF g_detail_d[li_ac].sel='Y' THEN
           LET l_cnt=l_cnt+1
           IF g_detail_d[li_ac].mhalstus<>'N' THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = "amh-00622"
              LET g_errparam.extend = g_detail_d[li_ac].mhal005
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET l_success = FALSE
           ELSE
              DELETE FROM mhal_t WHERE mhalent=g_enterprise
                                   AND mhalsite=g_site
                                   AND mhal001=g_detail_d[li_ac].mhal001
                                   AND mhal002=g_detail_d[li_ac].mhal002
                                   AND mhal004=g_detail_d[li_ac].mhal004
                                   AND mhal005=g_detail_d[li_ac].mhal005
                                   AND mhal007=g_detail_d[li_ac].mhal007 
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = g_detail_d[li_ac].mhal005
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET l_success = FALSE  
               END IF                    
           END IF
         END IF           
      END FOR
      
      IF l_cnt = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'adb-00078'
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET l_success = FALSE
      END IF 
       
      IF l_success THEN 
          CALL cl_err_collect_show()
          CALL s_transaction_end('Y','0')
          RETURN
      ELSE
          CALL cl_err_collect_show()
          CALL s_transaction_end('N','0')
          RETURN
      END IF
END FUNCTION

#end add-point
 
{</section>}
 
