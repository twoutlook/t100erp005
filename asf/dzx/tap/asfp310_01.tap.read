<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="asfp310_01" std_prog="asfp310_01" erpver="1.0" module="ASF" ver="3" env="s" zone="t10dev" booking="N" type="S" identity="s">
  <other>
    <code_template value="F" status=""/>
    <free_style value="N" status=""/>
  </other>
  <point name="function.asfp310_01_gen" order="1" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[###########################################
#产生成套发料单
#汇总方式
#1.依库位
#2.依工单
#3.依工单+库位
###########################################
PRIVATE FUNCTION asfp310_01_gen()
DEFINE l_success     LIKE type_t.num5
DEFINE l_cnt         LIKE type_t.num5

   CALL asfp310_01_crt_table() RETURNING l_success
   IF NOT l_success THEN
      RETURN
   END IF
   
   CALL s_transaction_begin()

   #插入临时表
   CALL asfp310_01_gen_ins_tmp() RETURNING l_success
   IF NOT l_success THEN
      CALL s_transaction_end('N','0')
      DROP TABLE asfp310_01_t;
      RETURN
   END IF

   #产生发料单
   CALL asfp310_01_gen_asft310() RETURNING l_success
   IF NOT l_success THEN
      CALL s_transaction_end('N','0')
      DROP TABLE asfp310_01_t;
      RETURN
   END IF



   #IF l_success = 'Y' THEN
      CALL s_transaction_end('Y','0')
   #ELSE
   #   CALL s_transaction_end('N','0')
   #END IF
   
   SELECT COUNT(*) INTO l_cnt FROM asfp310_01_t
   IF l_cnt = 0 THEN
      #无可产生的数据，请先选择数据
      CALL cl_err('','asf-00242',1)
      RETURN
   ELSE
      #执行成功，是否开启发料单
      IF cl_ask_confirm('asf-00243') THEN
         #开启发料单
         INITIALIZE la_param.* TO NULL
         LET la_param.prog = "asft311"
         #LET la_param.param[1] = g_bmba_d1[l_ac].bmba003
         LET ls_js = util.JSON.stringify(la_param)
         CALL cl_cmdrun(ls_js)
      END IF
   END IF
   
   CALL asfp310_01_drop_table()

END FUNCTION]]>
  </point>
  <point name="function.asfp310_01_crt_table" order="2" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION asfp310_01_crt_table()
DEFINE r_success    LIKE type_t.num5

   LET r_success = FALSE
   #DROP TABLE asfp310_01_t;
   #CREATE TEMP TABLE asfp310_01_t(
   #   sfaadocno    LIKE sfaa_t.sfaadocno,      #工单号
   #   ware         LIKE sfdc_t.sfdc012,        #库位
   #   sfdadocno    LIKE sfda_t.sfdadocno       #发料单号
   #);
   #IF SQLCA.sqlcode THEN
   #   CALL cl_err('create table',SQLCA.sqlcode,1)
   #   RETURN r_success
   #END IF
   
   DROP TABLE asfp310_01_t;
   CREATE TEMP TABLE asfp310_01_t(
                     seq_1       LIKE type_t.num5,      #顺序
                     sfaadocno_1 LIKE sfaa_t.sfaadocno, #工单单号
                     sfaa010_1   LIKE sfaa_t.sfaa010,   #生产料号
                     sfaa019_1   LIKE sfaa_t.sfaa019,   #预计开工日
                     sfaa020_1   LIKE sfaa_t.sfaa020,   #预计完工日
                     sfaa017_1   LIKE sfaa_t.sfaa017,   #部门厂商
                     sfaa002_1   LIKE sfaa_t.sfaa002,   #生管员
                     sfba003_1   LIKE sfba_t.sfba003,   #作业编号
                     sfba004_1   LIKE sfba_t.sfba004,   #作业序
                     sfaa012_1   LIKE sfaa_t.sfaa012,   #生产数量
                     sfaa049_1   LIKE sfaa_t.sfaa049,   #已发套数
                     has_sets_1  LIKE sfaa_t.sfaa049,   #已发齐套数
                     can_sets_1  LIKE sfaa_t.sfaa049,   #可齐料套数
                     seq_2       LIKE type_t.num5,      #项次
                     seq1_2      LIKE type_t.num5,      #项序
                     sfba002_2   LIKE sfba_t.sfba002,   #部位
                     sfba003_2   LIKE sfba_t.sfba003,   #作业
                     sfba004_2   LIKE sfba_t.sfba004,   #作业序
                     sfba006_2   LIKE sfba_t.sfba006,   #发料料号
                     sfba021_2   LIKE sfba_t.sfba021,   #产品特征
                     sfba014_2   LIKE sfba_t.sfba014,   #单位
                     sfba013_2   LIKE sfba_t.sfba013,   #应发数量  
                     sfba016_2   LIKE sfba_t.sfba016,   #已发数量
                     no_issue_2  LIKE sfba_t.sfba016,   #未发数量
                     issue_qty_2 LIKE sfba_t.sfba016,   #发料量
                     inag008_2   LIKE sfba_t.sfba016,   #库存可用量
                     inan010_2   LIKE sfba_t.sfba016,   #在捡量
                     bmea007_4   LIKE bmea_t.bmea007,   #取替代特性
                     bmea008_4   LIKE bmea_t.bmea008,   #料件编号
                     replace_rate_4 LIKE sfba_t.sfba022,   #替代率
                     bmea016_4   LIKE bmea_t.bmea016,   #替代方式
                     bmea017_4   LIKE bmea_t.bmea017,   #替代上限比率
                     inag004_4   LIKE inag_t.inag004,   #库位
                     inag005_4   LIKE inag_t.inag005,   #储位
                     inag006_4   LIKE inag_t.inag006,   #批号
                     inag003_4   LIKE inag_t.inag003,   #库存管理特征 
                     inag007_4   LIKE inag_t.inag007,   #单位
                     inag008_4   LIKE inag_t.inag008,   #现有库存数量 
                     inan010_4   LIKE inan_t.inan010,   #库存在捡量
                     issue_qty_4 LIKE inag_t.inag008,   #发料量
                     sort        LIKE type_t.chr100,    #分类排序--g_sfda_m.method
                     sort2       LIKE type_t.chr100     #排序2--工单+项次+项序+库位 用于sfdc插入判断
                       );
   IF SQLCA.sqlcode THEN
      CALL cl_err('create table',SQLCA.sqlcode,1)
      RETURN r_success
   END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.asfp310_01_gen_ins_tmp" order="3" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[#将需产生发料单的资料插入临时表
PRIVATE FUNCTION asfp310_01_gen_ins_tmp()
DEFINE r_success     LIKE type_t.num5
DEFINE l_sql         STRING
DEFINE l_i           LIKE type_t.num5
DEFINE l_sfba        RECORD
                     seq_1       LIKE type_t.num5,      #顺序
                     seq_2       LIKE type_t.num5,      #项次
                     seq1_2      LIKE type_t.num5,      #项序
                     sfba002_2   LIKE sfba_t.sfba002,   #部位
                     sfba003_2   LIKE sfba_t.sfba003,   #作业
                     sfba004_2   LIKE sfba_t.sfba004,   #作业序
                     sfba006_2   LIKE sfba_t.sfba006,   #发料料号
                     sfba021_2   LIKE sfba_t.sfba021,   #产品特征
                     sfba014_2   LIKE sfba_t.sfba014,   #单位
                     sfba013_2   LIKE sfba_t.sfba013,   #应发数量  
                     sfba016_2   LIKE sfba_t.sfba016,   #已发数量
                     no_issue_2  LIKE sfba_t.sfba016,   #未发数量
                     issue_qty_2 LIKE sfba_t.sfba016,   #发料量
                     inag008_2   LIKE sfba_t.sfba016,   #库存可用量
                     inan010_2   LIKE sfba_t.sfba016    #在捡量
                     END RECORD
DEFINE l_inag        RECORD
                     seq_1       LIKE type_t.num5,      #顺序
                     seq_2       LIKE type_t.num5,      #项次
                     seq1_2      LIKE type_t.num5,      #项序
                     inag004_3   LIKE inag_t.inag004,   #库位
                     inag005_3   LIKE inag_t.inag005,   #储位
                     inag006_3   LIKE inag_t.inag006,   #批号
                     inag003_3   LIKE inag_t.inag003,   #库存管理特征
                     inag007_3   LIKE inag_t.inag007,   #单位
                     inag008_3   LIKE inag_t.inag008,   #现有库存数量
                     inan010_3   LIKE inan_t.inan010,   #库存在捡量
                     #has_qty_3   LIKE inag_t.inag008,   #其他工单分配量
                     issue_qty_3 LIKE inag_t.inag008    #发料量
                     END RECORD
DEFINE l_bmea        RECORD
                     seq_1       LIKE type_t.num5,      #顺序
                     seq_2       LIKE type_t.num5,      #项次
                     seq1_2      LIKE type_t.num5,      #项序
                     bmea007_4   LIKE bmea_t.bmea007,   #取替代特性
                     bmea008_4   LIKE bmea_t.bmea008,   #料件编号
                     replace_rate_4    LIKE sfba_t.sfba022,   #替代率
                     bmea016_4   LIKE bmea_t.bmea016,   #替代方式
                     bmea017_4   LIKE bmea_t.bmea017,   #替代上限比率
                     inag004_4   LIKE inag_t.inag004,   #库位
                     inag005_4   LIKE inag_t.inag005,   #储位
                     inag006_4   LIKE inag_t.inag006,   #批号
                     inag003_4   LIKE inag_t.inag003,   #库存管理特征 
                     inag007_4   LIKE inag_t.inag007,   #单位
                     inag008_4   LIKE inag_t.inag008,   #现有库存数量 
                     inan010_4   LIKE inan_t.inan010,   #库存在捡量
                     #has_qty_4   LIKE inag_t.inag008,   #其他工单分配量    
                     issue_qty_4 LIKE inag_t.inag008    #发料量
                     END RECORD
DEFINE l_gen         type_g_gen_d

   LET r_success = FALSE
   
   #定义游标--有发料量的发料资料
   LET l_sql = " SELECT * FROM asfp310_sfba ",
               "  WHERE seq_1 = ? ",
               "    AND issue_qty_2 > 0 "
   PREPARE asfp310_01_gen_sfba_p FROM l_sql
   DECLARE asfp310_01_gen_sfba_c CURSOR FOR asfp310_01_gen_sfba_p
   
   LET l_sql = " SELECT * FROM asfp310_inag ",
               "  WHERE seq_1 = ? ",
               "    AND seq_2 = ? ",
               "    AND seq1_2= ? ",
               "    AND issue_qty_3 > 0 "
   PREPARE asfp310_01_gen_inag_p FROM l_sql
   DECLARE asfp310_01_gen_inag_c CURSOR FOR asfp310_01_gen_inag_p
   
   LET l_sql = " SELECT * FROM asfp310_bmea ",
               "  WHERE seq_1 = ? ",
               "    AND seq_2 = ? ",
               "    AND seq1_2= ? ",
               "    AND issue_qty_4 > 0 "
   PREPARE asfp310_01_gen_bmea_p FROM l_sql
   DECLARE asfp310_01_gen_bmea_c CURSOR FOR asfp310_01_gen_bmea_p
   

   FOR l_i = 1 TO g_sfaa_d.getLength()
       IF g_sfaa_d[l_i].sel_1 = 'Y' THEN
          OPEN asfp310_01_gen_sfba_c USING g_sfaa_d[l_i].seq_1
          FOREACH asfp310_01_gen_sfba_c INTO l_sfba.*
             IF SQLCA.sqlcode THEN
                CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
                RETURN r_success
             END IF
             
             INITIALIZE l_gen.* TO NULL
             LET l_gen.seq_1          = g_sfaa_d[l_i].seq_1       #顺序
             LET l_gen.sfaadocno_1    = g_sfaa_d[l_i].sfaadocno_1 #工单单号
             LET l_gen.sfaa010_1      = g_sfaa_d[l_i].sfaa010_1   #生产料号
             LET l_gen.sfaa019_1      = g_sfaa_d[l_i].sfaa019_1   #预计开工日
             LET l_gen.sfaa020_1      = g_sfaa_d[l_i].sfaa020_1   #预计完工日
             LET l_gen.sfaa017_1      = g_sfaa_d[l_i].sfaa017_1   #部门厂商
             LET l_gen.sfaa002_1      = g_sfaa_d[l_i].sfaa002_1   #生管员
             LET l_gen.sfba003_1      = g_sfaa_d[l_i].sfba003_1   #作业编号
             LET l_gen.sfba004_1      = g_sfaa_d[l_i].sfba004_1   #作业序
             LET l_gen.sfaa012_1      = g_sfaa_d[l_i].sfaa012_1   #生产数量
             LET l_gen.sfaa049_1      = g_sfaa_d[l_i].sfaa049_1   #已发套数
             LET l_gen.has_sets_1     = g_sfaa_d[l_i].has_sets_1  #已发齐套数
             LET l_gen.can_sets_1     = g_sfaa_d[l_i].can_sets_1  #可齐料套数
             LET l_gen.seq_2          = l_sfba.seq_2              #项次
             LET l_gen.seq1_2         = l_sfba.seq1_2             #项序
             LET l_gen.sfba002_2      = l_sfba.sfba002_2          #部位
             LET l_gen.sfba003_2      = l_sfba.sfba003_2          #作业
             LET l_gen.sfba004_2      = l_sfba.sfba004_2          #作业序
             LET l_gen.sfba006_2      = l_sfba.sfba006_2          #发料料号
             LET l_gen.sfba021_2      = l_sfba.sfba021_2          #产品特征
             LET l_gen.sfba014_2      = l_sfba.sfba014_2          #单位
             LET l_gen.sfba013_2      = l_sfba.sfba013_2          #应发数量  
             LET l_gen.sfba016_2      = l_sfba.sfba016_2          #已发数量
             LET l_gen.no_issue_2     = l_sfba.no_issue_2         #未发数量
             LET l_gen.issue_qty_2    = l_sfba.issue_qty_2        #发料量
             LET l_gen.inag008_2      = l_sfba.inag008_2          #库存可用量
             LET l_gen.inan010_2      = l_sfba.inan010_2          #在捡量
             
             #inag
             OPEN asfp310_01_gen_inag_c USING l_sfba.seq_1,l_sfba.seq_2,l_sfba.seq1_2
             FOREACH asfp310_01_gen_inag_c INTO l_inag.*
                IF SQLCA.sqlcode THEN
                   CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
                   RETURN r_success
                END IF

                LET l_gen.bmea007_4      = ''                        #取替代特性
                LET l_gen.bmea008_4      = l_sfba.sfba006_2          #料件编号 实际发料料号
                LET l_gen.replace_rate_4 = 1                         #替代率
                LET l_gen.bmea016_4      = ''                        #替代方式
                LET l_gen.bmea017_4      = 0                         #替代上限比率
                LET l_gen.inag004_4      = l_inag.inag004_3          #库位
                LET l_gen.inag005_4      = l_inag.inag005_3          #储位
                LET l_gen.inag006_4      = l_inag.inag006_3          #批号
                LET l_gen.inag003_4      = l_inag.inag003_3          #库存管理特征 
                LET l_gen.inag007_4      = l_inag.inag007_3          #单位
                LET l_gen.inag008_4      = l_inag.inag008_3          #现有库存数量 
                LET l_gen.inan010_4      = l_inag.inan010_3          #库存在捡量
                #LET l_gen.has_qty_4      = l_inag.has_qty_3          #其他工单分配量    
                LET l_gen.issue_qty_4    = l_inag.issue_qty_3        #发料量
                CASE g_sfda_m.method
                   WHEN '1'  #库位
                        LET l_gen.sort = l_gen.inag004_4
                   WHEN '2'  #工单
                        LET l_gen.sort = l_gen.sfaadocno_1
                   WHEN '3'  #工单+库位
                        LET l_gen.sort = l_gen.sfaadocno_1,l_gen.inag004_4
                END CASE
                LET l_gen.sort2 = l_gen.sfaadocno_1,' ',l_gen.seq_2,' ',l_gen.seq1_2,' ',l_gen.inag004_4
                INSERT INTO asfp310_01_t VALUES(l_gen.*)
             END FOREACH

             #bmea
             OPEN asfp310_01_gen_bmea_c USING l_sfba.seq_1,l_sfba.seq_2,l_sfba.seq1_2
             FOREACH asfp310_01_gen_bmea_c INTO l_bmea.*
                IF SQLCA.sqlcode THEN
                   CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
                   RETURN r_success
                END IF
                
                LET l_gen.bmea007_4      = l_bmea.bmea007_4          #取替代特性
                LET l_gen.bmea008_4      = l_bmea.bmea008_4          #料件编号 实际发料料号
                LET l_gen.replace_rate_4 = l_bmea.replace_rate_4     #替代率
                LET l_gen.bmea016_4      = l_bmea.bmea016_4          #替代方式
                LET l_gen.bmea017_4      = l_bmea.bmea017_4          #替代上限比率
                LET l_gen.inag004_4      = l_bmea.inag004_4          #库位
                LET l_gen.inag005_4      = l_bmea.inag005_4          #储位
                LET l_gen.inag006_4      = l_bmea.inag006_4          #批号
                LET l_gen.inag003_4      = l_bmea.inag003_4          #库存管理特征 
                LET l_gen.inag007_4      = l_bmea.inag007_4          #单位
                LET l_gen.inag008_4      = l_bmea.inag008_4          #现有库存数量 
                LET l_gen.inan010_4      = l_bmea.inan010_4          #库存在捡量
                #LET l_gen.has_qty_4      = l_bmea.has_qty_4          #其他工单分配量    
                LET l_gen.issue_qty_4    = l_bmea.issue_qty_4        #发料量
                CASE g_sfda_m.method
                   WHEN '1'  #库位
                        LET l_gen.sort = l_gen.inag004_4
                   WHEN '2'  #工单
                        LET l_gen.sort = l_gen.sfaadocno_1
                   WHEN '3'  #工单+库位
                        LET l_gen.sort = l_gen.sfaadocno_1,l_gen.inag004_4
                END CASE
                LET l_gen.sort2 = l_gen.sfaadocno_1,' ',l_gen.seq_2,' ',l_gen.seq1_2,' ',l_gen.inag004_4
                INSERT INTO asfp310_01_t VALUES(l_gen.*)
             END FOREACH
          END FOREACH
       END IF
   END FOR
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.asfp310_01_gen_asft310" order="4" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[#插入发料单
PRIVATE FUNCTION asfp310_01_gen_asft310()
DEFINE r_success     LIKE type_t.num5
DEFINE l_sql         STRING
DEFINE l_gen         type_g_gen_d
DEFINE l_sort_t      LIKE type_t.chr100
DEFINE l_sort2_t     LIKE type_t.chr100
DEFINE l_sfdadocno   LIKE sfda_t.sfdadocno
DEFINE l_sfdb        RECORD LIKE sfdb_t.*
DEFINE l_sfdc        RECORD LIKE sfdc_t.*
DEFINE l_sfdd        RECORD LIKE sfdd_t.*
DEFINE l_seq_1_t     LIKE type_t.num5
DEFINE l_sfdb007_1        LIKE sfdb_t.sfdb007  #已发套数
DEFINE l_sfdb007_2        LIKE sfdb_t.sfdb007  #已退套数
DEFINE l_sfaa012          LIKE sfaa_t.sfaa012  #生产数量
DEFINE l_sfaa049          LIKE sfaa_t.sfaa049  #已发套数
DEFINE l_sfdcseq          LIKE sfdc_t.sfdcseq   #项次
DEFINE l_sfddseq1         LIKE sfdd_t.sfddseq1  #项序
DEFINE l_rate      LIKE inaj_t.inaj014  #单位换算率
DEFINE l_sfdb006     LIKE sfdb_t.sfdb006   #工单+部位+作业+作业序 预计发料套数
DEFINE l_sfdc007     LIKE sfdc_t.sfdc007   #本发料单据其他项次的发料数量
DEFINE l_sfba010     LIKE sfba_t.sfba010   #标准QPA分子
DEFINE l_sfba011     LIKE sfba_t.sfba011   #标准QPA分母
DEFINE l_sfba002     LIKE sfba_t.sfba002   #部位
DEFINE l_sfba003     LIKE sfba_t.sfba003   #作业
DEFINE l_sfba004     LIKE sfba_t.sfba004   #作业序
DEFINE l_sfba013     LIKE sfba_t.sfba013
DEFINE l_sfba016     LIKE sfba_t.sfba016   #已发数量
DEFINE l_success     LIKE type_t.num5

   LET r_success = FALSE
   
   LET l_sql = "SELECT * FROM asfp310_01_t ",
               " ORDER BY sort,sort2 "
   PREPARE asfp310_01_gen_p FROM l_sql
   DECLARE asfp310_01_gen_c CURSOR FOR asfp310_01_gen_p
   LET l_sort_t = ''
   LET l_sort2_t = ''
   FOREACH asfp310_01_gen_c INTO l_gen.*
      IF SQLCA.sqlcode THEN
         CALL cl_err("FOREACH:",SQLCA.sqlcode,1)
         RETURN r_success
      END IF
      ####################
      #-->产生单头资料
      ####################
      IF cl_null(l_sort_t) OR l_gen.sort != l_sort_t THEN
         CALL asfp310_01_ins_sfda() RETURNING l_success,l_sfdadocno
         IF NOT l_success THEN
            CALL s_transaction_end('N','0')
            RETURN r_success
         END IF
         LET l_sort_t  = l_gen.sort
         LET l_seq_1_t = 0  #重新开始
         LET l_sfdcseq = 0  #项次
         LET l_sfddseq1= 0  #项序
      END IF
      
      ####################
      #-->sfdb_t
      ####################
      IF l_seq_1_t = 0 OR l_gen.seq_1 != l_seq_1_t THEN
         LET l_seq_1_t = l_gen.seq_1
         
         INITIALIZE l_sfdb.* TO NULL
         LET l_sfdb.sfdbent   = g_enterprise       #企業代碼
         LET l_sfdb.sfdbsite  = g_site             #營運據點
         LET l_sfdb.sfdbdocno = l_sfdadocno        #發退料單號
         LET l_sfdb.sfdb001   = l_gen.sfaadocno_1  #工單單號
         
         #Run Card
         SELECT sfca001 INTO l_sfdb.sfdb002 FROM sfca_t
          WHERE sfcaent = g_enterprise
            AND sfcasite= g_site
            AND sfcadocno=l_gen.sfaadocno_1   #工单单号
        
         LET l_sfdb.sfdb003   = ' '                #部位
         LET l_sfdb.sfdb004   = l_gen.sfba003_1    #作業
         LET l_sfdb.sfdb005   = l_gen.sfba004_1    #作業序
         
         #預計套數
         #IF 部位、作业、制程序 都没输入 THEN              
         #    最大套数=工单生产数量sfaa012-工单已发套数sfaa049
         #ELSE (部位 <> 空白 OR 作业<>空白 )
         #    最大套数=工单生产数量sfaa012-(同工单的发料单未指定部位作业的实际套数+发料单有指定相同部位、作业、制程序的实际套数-退料单未指定部位作业的实际套数-退料单有指定相同部位、作业、制程序的实际套数)
         #END IF
         SELECT sfaa012,sfaa049  INTO l_sfaa012,l_sfaa049
           FROM sfaa_t
          WHERE sfaaent   = g_enterprise
            AND sfaasite  = g_site
            AND sfaadocno = l_sfdb.sfdb001
         IF cl_null(l_sfdb.sfdb003) AND cl_null(l_sfdb.sfdb004) AND cl_null(l_sfdb.sfdb005) THEN  #部位、作業、製程序 都沒輸入
            LET l_sfdb.sfdb006 =l_sfaa012-l_sfaa049  #工单生产数量-已发套数
         ELSE #(部位 <> 空白 OR 作業<>空白 )
            #委外发料数量
            CALL s_asft310_get_sfdb007('11',l_sfdb.sfdb001,l_sfdb.sfdb003,l_sfdb.sfdb004,l_sfdb.sfdb005)
               RETURNING l_sfdb007_1     
            #委外退料数量
            CALL s_asft310_get_sfdb007('21',l_sfdb.sfdb001,l_sfdb.sfdb003,l_sfdb.sfdb004,l_sfdb.sfdb005)
               RETURNING l_sfdb007_2
      
            LET l_sfdb.sfdb006 = l_sfaa012 - (l_sfdb007_1 - l_sfdb007_2)
         END IF
          
         LET l_sfdb.sfdb007   = l_sfdb.sfdb006     #實際套數
         LET l_sfdb.sfdb008   = -1                 #正負
         INSERT INTO sfdb_t VALUES(l_sfdb.*)
         IF SQLCA.sqlcode THEN
            CALL cl_err('ins sfdb_t',SQLCA.sqlcode,1)
            RETURN r_success
         END IF
      END IF
      
      ####################
      #-->sfdc_t
      ####################
      IF cl_null(l_sort2_t) OR l_gen.sort2 != l_sort2_t THEN
         LET l_sort2_t = l_gen.sort2
         LET l_sfddseq1= 0  #项序
         INITIALIZE l_sfdc.* TO NULL
         LET l_sfdc.sfdcent   = g_enterprise      #企業代碼                         
         LET l_sfdc.sfdcsite  = g_site            #營運據點                         
         LET l_sfdc.sfdcdocno = l_sfdadocno       #發退料單號
         LET l_sfdcseq = l_sfdcseq + 1      
         LET l_sfdc.sfdcseq   = l_sfdcseq         #項次       
         LET l_sfdc.sfdc001   = l_gen.sfaadocno_1 #工單單號                         
         LET l_sfdc.sfdc002   = l_gen.seq_2       #工單項次                         
         LET l_sfdc.sfdc003   = l_gen.seq1_2      #工單項序                         
         LET l_sfdc.sfdc004   = l_gen.sfba006_2   #需求料號                         
         LET l_sfdc.sfdc005   = l_gen.sfba021_2   #特徵                             
         LET l_sfdc.sfdc006   = l_gen.sfba014_2   #單位

         #申请数量
         SELECT sfaa012,sfaa049,sfba013,sfba016,sfba010,sfba011,
                sfba002,sfba003,sfba004
           INTO l_sfaa012,l_sfaa049,l_sfba013,l_sfba016,l_sfba010,l_sfba011,
                l_sfba002,l_sfba003,l_sfba004
           FROM sfba_t,sfaa_t
          WHERE sfaaent   = sfbaent
            AND sfaadocno = sfbadocno
            AND sfbaent   = g_enterprise
            AND sfbadocno = l_sfdc.sfdc001
            AND sfbaseq   = l_sfdc.sfdc002
            AND sfbaseq1  = l_sfdc.sfdc003
         #預計發料套數
         SELECT SUM(sfdb006) INTO l_sfdb006 FROM sfdb_t
          WHERE sfdbent  = g_enterprise
            AND sfdbsite = g_site
            AND sfdbdocno= l_sfdadocno     #发料单单号
            AND sfdb001  = l_sfdc.sfdc001  #工单单号
            AND sfdb003  = l_sfba002  #部位
            AND sfdb004  = l_sfba003  #作业
            AND sfdb005  = l_sfba004  #作业序
            #AND sfdb002  = #run card
         IF cl_null(l_sfdb006) THEN LET l_sfdb006=0 END IF

         IF l_sfdb006 = l_sfaa012 - l_sfaa049 THEN  #預計發料套數=生產數量-已發套數,即要把剩余
            #應發總數量-已發數量
            LET l_sfdc.sfdc007 = l_sfba013 - l_sfba016
         ELSE
            #預計發料套數*標準QPA分子/標準QPA分母
            LET l_sfdc.sfdc007 = l_sfdb006 * l_sfba010 / l_sfba011
         END IF
         IF l_sfdc.sfdc007 < 0 THEN
            LET l_sfdc.sfdc007 = 0        #申請數量   
         END IF
          

         #参考单位
         SELECT imaf015 INTO l_sfdc.sfdc009
           FROM imaf_t
          WHERE imafent = g_enterprise
            AND imafsite= g_site
            AND imaf001 = l_sfdc.sfdc004
         #參考單位需求數量
         CALL s_aimi190_get_convert(l_sfdc.sfdc004,l_sfdc.sfdc006,l_sfdc.sfdc009)
            RETURNING l_success,l_rate
         IF NOT l_success THEN
            LET l_rate = 1
         END IF
         LET l_sfdc.sfdc010 = l_sfdc.sfdc007 * l_rate
         
         LET l_sfdc.sfdc008   = 0                 #實際數量                  
         LET l_sfdc.sfdc011   = 0                 #參考單位實際數量                 
         LET l_sfdc.sfdc012   = l_gen.inag004_4   #指定庫位                         
         LET l_sfdc.sfdc013   = ' '               #指定儲位                         
         LET l_sfdc.sfdc014   = ' '               #指定批號                         
         LET l_sfdc.sfdc015   = ''                #理由碼                           
         LET l_sfdc.sfdc016   = ' '               #庫存管理特徴                     
         LET l_sfdc.sfdc017   = -1                #正負   
         INSERT INTO sfdc_t VALUES(l_sfdc.*)
         IF SQLCA.sqlcode THEN
            CALL cl_err('ins sfdc_t',SQLCA.sqlcode,1)
            RETURN r_success
         END IF
         
         #新增或更新sfde(包含新增或更新sfdf)
         CALL s_asft310_chg_sfde_f_sfdc_ins(l_sfdadocno,l_sfdc.sfdcseq) RETURNING l_success
         IF NOT l_success THEN
            RETURN r_success
         END IF

      END IF
      ####################
      #-->sfdd_t
      ####################
      INITIALIZE l_sfdd.* TO NULL
      LET l_sfdd.sfddent   = g_enterprise           #企業代碼
      LET l_sfdd.sfddsite  = g_site                 #營運據
      LET l_sfdd.sfdddocno = l_sfdadocno            #發退料單號
      LET l_sfdd.sfddseq   = l_sfdcseq              #項次
      LET l_sfddseq1 = l_sfddseq1 + 1
      LET l_sfdd.sfddseq1  = l_sfddseq1             #項序
      LET l_sfdd.sfdd001   = l_gen.bmea008_4        #發退料料號
      LET l_sfdd.sfdd002   = l_gen.replace_rate_4   #替代率
      LET l_sfdd.sfdd003   = l_gen.inag004_4        #庫位
      LET l_sfdd.sfdd004   = l_gen.inag005_4        #儲位
      LET l_sfdd.sfdd005   = l_gen.inag006_4        #批號
      LET l_sfdd.sfdd006   = l_gen.inag007_4        #單位
      LET l_sfdd.sfdd007   = l_gen.issue_qty_4      #數量
      
      #参考单位
      IF l_sfdd.sfdd001 = l_sfdc.sfdc004 THEN #没发生取替代
         LET l_sfdd.sfdd008 = l_sfdc.sfdc009
      ELSE
         SELECT imaf015 INTO l_sfdd.sfdd008
           FROM imaf_t
          WHERE imafent = g_enterprise
            AND imafsite= g_site
            AND imaf001 = l_sfdd.sfdd001
      END IF
      #參考單位數量
      CALL s_aimi190_get_convert(l_sfdd.sfdd001,l_sfdd.sfdd006,l_sfdd.sfdd008)
         RETURNING l_success,l_rate
      IF NOT l_success THEN
         LET l_rate = 1
      END IF
      LET l_sfdd.sfdd009 = l_sfdd.sfdd007 * l_rate

      LET l_sfdd.sfdd010   = l_gen.inag003_4        #庫存管理特徵
      LET l_sfdd.sfdd011   = ''   #包裝容器
      LET l_sfdd.sfdd012   = -1   #正負
      
      INSERT INTO sfdd_t VALUES(l_sfdd.*)
      IF SQLCA.sqlcode THEN
         CALL cl_err('ins sfdd_t',SQLCA.sqlcode,1)
         RETURN r_success
      END IF
         
      #更新sfdc
      CALL s_asft310_chg_sfdc_f_sfdd_ins(l_sfdadocno,l_sfdc.sfdcseq,l_sfdd.sfddseq1) RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success
      END IF
      #处理sfdf,sfde：sfdd与sfdf总数应该平的
      CALL s_asft310_chg_sfdf_f_sfdd_ins(l_sfdadocno,l_sfdc.sfdcseq,l_sfdd.sfddseq1) RETURNING l_success
      IF NOT l_success THEN
         RETURN r_success
      END IF

   END FOREACH

   LET r_success = TRUE
   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.asfp310_01_ins_sfda" order="5" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION asfp310_01_ins_sfda()
   DEFINE r_success       LIKE type_t.num5
   DEFINE r_sfdadocno     LIKE sfda_t.sfdadocno
   DEFINE l_sfda          RECORD LIKE sfda_t.*
   
   LET r_success  = TRUE
   LET r_sfdadocno = NULL
   
   INITIALIZE l_sfda.* TO NULL
   LET l_sfda.sfdaent   = g_enterprise      #企業代碼
   LET l_sfda.sfdasite  = g_site            #營運據點
   LET l_sfda.sfdadocdt = cl_get_today()    #單據日期
   LET l_sfda.sfda001   = cl_get_today()    #過帳日期
   LET l_sfda.sfda002   = '11'              #發料類別
   LET l_sfda.sfda003   = g_dept            #生產部門
   LET l_sfda.sfda004   = g_user            #申請人
   LET l_sfda.sfda005   = ''                #PBI編號
   LET l_sfda.sfda006   = ''                #生產料號
   LET l_sfda.sfda007   = ''                #BOM特性
   LET l_sfda.sfda008   = ''                #產品特徵
   LET l_sfda.sfda009   = ''                #生產控制組
   LET l_sfda.sfda010   = ''                #作業編號
   LET l_sfda.sfda011   = ''                #製程序
   LET l_sfda.sfda012   = ''                #庫位
   LET l_sfda.sfda013   = 0                 #套數
   LET l_sfda.sfdaownid = g_user            #資料所有者
   LET l_sfda.sfdaowndp = g_dept            #資料所屬部門
   LET l_sfda.sfdacrtid = g_user            #資料建立者
   LET l_sfda.sfdacrtdp = g_dept            #資料建立部門
   LET l_sfda.sfdacrtdt = cl_get_current()  #資料創建日
   LET l_sfda.sfdamodid = ''                #資料修改者
   LET l_sfda.sfdamoddt = ''                #最近修改日
   LET l_sfda.sfdacnfid = ''                #資料確認者
   LET l_sfda.sfdacnfdt = ''                #資料確認日
   LET l_sfda.sfdapstid = ''                #資料過帳者
   LET l_sfda.sfdapstdt = ''                #資料過帳日
   LET l_sfda.sfdastus  = 'N'               #狀態碼
   
   #發退料單號
   CALL s_aooi200_gen_docno(g_site,g_sfda_m.sfdadocno,l_sfda.sfdadocdt,'asft311')
        RETURNING r_success,l_sfda.sfdadocno
   IF NOT r_success THEN
      RETURN r_success,r_sfdadocno
   END IF 
   
   INSERT INTO sfda_t VALUES(l_sfda.*)
   IF SQLCA.sqlcode THEN
      CALL cl_err('ins sfda_t',SQLCA.sqlcode,1)
      LET r_success = FALSE
      RETURN r_success,r_sfdadocno
   END IF

   LET r_sfdadocno = l_sfda.sfdadocno
   RETURN r_success,r_sfdadocno
END FUNCTION]]>
  </point>
  <point name="function.asfp310_01_drop_table" order="6" ver="1" cite_std="N" new="Y" status="" src="s" mark_hard="N">
    <![CDATA[
PRIVATE FUNCTION asfp310_01_drop_table()
   DROP TABLE asfp310_01_t;
END FUNCTION]]>
  </point>
  <point name="global.import" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[IMPORT util]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[TYPE type_g_sfaa_d   RECORD
                     sel_1       LIKE type_t.chr1,      #选择
                     lock_1      LIKE type_t.chr1,      #锁定
                     seq_1       LIKE type_t.num5,      #顺序
                     sfaadocno_1 LIKE sfaa_t.sfaadocno, #工单单号
                     sfaa010_1   LIKE sfaa_t.sfaa010,   #生产料号
                     sfaa010_imaal003_1  LIKE imaal_t.imaal003,
                     sfaa010_imaal004_1  LIKE imaal_t.imaal004,
                     sfaa019_1   LIKE sfaa_t.sfaa019,   #预计开工日
                     sfaa020_1   LIKE sfaa_t.sfaa020,   #预计完工日
                     sfaa017_1   LIKE sfaa_t.sfaa017,   #部门厂商
                     sfaa017_desc_1      LIKE type_t.chr80,
                     sfaa002_1   LIKE sfaa_t.sfaa002,   #生管员
                     sfaa002_desc_1      LIKE type_t.chr80,
                     sfba003_1   LIKE sfba_t.sfba003,   #作业编号
                     sfba004_1   LIKE sfba_t.sfba004,   #作业序
                     sfaa012_1   LIKE sfaa_t.sfaa012,   #生产数量
                     sfaa049_1   LIKE sfaa_t.sfaa049,   #已发套数
                     has_sets_1  LIKE sfaa_t.sfaa049,   #已发齐套数
                     can_sets_1  LIKE sfaa_t.sfaa049    #可齐料套数
                     END RECORD
TYPE type_g_gen_d    RECORD
                     seq_1       LIKE type_t.num5,      #顺序
                     sfaadocno_1 LIKE sfaa_t.sfaadocno, #工单单号
                     sfaa010_1   LIKE sfaa_t.sfaa010,   #生产料号
                     sfaa019_1   LIKE sfaa_t.sfaa019,   #预计开工日
                     sfaa020_1   LIKE sfaa_t.sfaa020,   #预计完工日
                     sfaa017_1   LIKE sfaa_t.sfaa017,   #部门厂商
                     sfaa002_1   LIKE sfaa_t.sfaa002,   #生管员
                     sfba003_1   LIKE sfba_t.sfba003,   #作业编号
                     sfba004_1   LIKE sfba_t.sfba004,   #作业序
                     sfaa012_1   LIKE sfaa_t.sfaa012,   #生产数量
                     sfaa049_1   LIKE sfaa_t.sfaa049,   #已发套数
                     has_sets_1  LIKE sfaa_t.sfaa049,   #已发齐套数
                     can_sets_1  LIKE sfaa_t.sfaa049,   #可齐料套数
                     seq_2       LIKE type_t.num5,      #项次
                     seq1_2      LIKE type_t.num5,      #项序
                     sfba002_2   LIKE sfba_t.sfba002,   #部位
                     sfba003_2   LIKE sfba_t.sfba003,   #作业
                     sfba004_2   LIKE sfba_t.sfba004,   #作业序
                     sfba006_2   LIKE sfba_t.sfba006,   #发料料号
                     sfba021_2   LIKE sfba_t.sfba021,   #产品特征
                     sfba014_2   LIKE sfba_t.sfba014,   #单位
                     sfba013_2   LIKE sfba_t.sfba013,   #应发数量  
                     sfba016_2   LIKE sfba_t.sfba016,   #已发数量
                     no_issue_2  LIKE sfba_t.sfba016,   #未发数量
                     issue_qty_2 LIKE sfba_t.sfba016,   #发料量
                     inag008_2   LIKE sfba_t.sfba016,   #库存可用量
                     inan010_2   LIKE sfba_t.sfba016,   #在捡量
                     bmea007_4   LIKE bmea_t.bmea007,   #取替代特性
                     bmea008_4   LIKE bmea_t.bmea008,   #料件编号 实际发料料号
                     replace_rate_4 LIKE sfba_t.sfba022,   #替代率
                     bmea016_4   LIKE bmea_t.bmea016,   #替代方式
                     bmea017_4   LIKE bmea_t.bmea017,   #替代上限比率
                     inag004_4   LIKE inag_t.inag004,   #库位
                     inag005_4   LIKE inag_t.inag005,   #储位
                     inag006_4   LIKE inag_t.inag006,   #批号
                     inag003_4   LIKE inag_t.inag003,   #库存管理特征 
                     inag007_4   LIKE inag_t.inag007,   #单位
                     inag008_4   LIKE inag_t.inag008,   #现有库存数量 
                     inan010_4   LIKE inan_t.inan010,   #库存在捡量
                     #has_qty_4   LIKE inag_t.inag008,   #其他工单分配量    
                     issue_qty_4 LIKE inag_t.inag008,   #发料量
                     sort        LIKE type_t.chr100,    #分类排序--g_sfda_m.method
                     sort2       LIKE type_t.chr100     #排序2--工单+项次+项序+库位 用于sfdc插入判断
                     END RECORD
DEFINE g_sfaa_d      DYNAMIC ARRAY OF type_g_sfaa_d
DEFINE g_count       LIKE type_t.num5

DEFINE la_param  RECORD
                 prog   STRING,
                 param  DYNAMIC ARRAY OF STRING
                 END RECORD
DEFINE ls_js     STRING]]>
  </point>
  <point name="input.a.sfdadocno" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_sfda_m.sfdadocno) THEN
               #是否存在成套发料单别内
               CALL s_aooi200_chk_slip(g_site,'',g_sfda_m.sfdadocno,'asft311')
               RETURNING l_success
               IF NOT l_success THEN
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.after_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            CALL asfp310_01_gen()]]>
  </point>
  <point name="input.c.sfdadocno" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[            #此段落由子樣板a07產生            
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_sfda_m.sfdadocno             #給予default值

            #給予arg
            SELECT ooef004 INTO l_ooef004
              FROM ooef_t
             WHERE ooef001 = g_site
               AND ooefent  = g_enterprise
            LET g_qryparam.arg1 = l_ooef004    #參照表編號
            LET g_qryparam.arg2 = 'asft314'    #作业代号
            
            CALL q_ooba002_1()                                #呼叫開窗

            LET g_sfda_m.sfdadocno = g_qryparam.return1              

            DISPLAY g_sfda_m.sfdadocno TO sfdadocno              #

            NEXT FIELD sfdadocno                          #返回原欄位

]]>
  </point>
  <point name="input.define" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   DEFINE l_success       LIKE type_t.num5
   DEFINE p_sfaa_d        DYNAMIC ARRAY OF type_g_sfaa_d
   DEFINE l_i             LIKE type_t.num5
   DEFINE l_ooef004       LIKE ooef_t.ooef004]]>
  </point>
  <point name="input.get_var" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[p_sfaa_d]]>
  </point>
  <point name="input.pre_input" order="" ver="1" cite_std="N" new="N" status="" src="s" mark_hard="N">
    <![CDATA[   CALL cl_set_combo_scc('method','4018')
   LET g_sfda_m.method = '2'  #依工单
   LET g_sfaa_d.* = p_sfaa_d.*
   {
   #赋值全局变量，顺带将需产生发料单的资料理出来
   LET g_count = 0
   FOR l_i = 1 TO p_sfaa_d.getLength()
       IF p_sfaa_d[l_i].sel_1 = 'Y' THEN
          LET g_count = g_count + 1
          LET g_sfaa_d[g_count].* = p_sfaa_d[l_i].*
       END IF
   END FOR
   }
   WHENEVER ERROR CONTINUE]]>
  </point>
  <section id="asfp310_01.description" ver="18" status="" src="s">
    <![CDATA[#+ Version..: T100-ERP-1.00.00(SD版次:3,PR版次:3) Build-000034
#+ 
#+ Filename...: asfp310_01
#+ Description: ...
#+ Creator....: 00768(2014/04/22)
#+ Modifier...: 00768(2014/07/02)
#+ Buildtype..: 應用 c01b 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
  </section>
  <section id="asfp310_01.global" ver="2" status="" src="s">
    <![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔
{<point name="global.inc" />}
#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_sfda_m        RECORD
       sfdadocno LIKE sfda_t.sfdadocno, 
   method LIKE type_t.chr80
       END RECORD
DEFINE g_sfda_m        type_g_sfda_m
 
   DEFINE g_sfdadocno_t LIKE sfda_t.sfdadocno
 
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明(global.argv)
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="asfp310_01.input" ver="4" status="" src="s">
    <![CDATA[#+ 資料輸入
PUBLIC FUNCTION asfp310_01(--)
   #add-point:input段變數傳入
   {<point name="input.get_var"/>}
   #end add-point
   )
   DEFINE l_ac_t          LIKE type_t.num5        #未取消的ARRAY CNT 
   DEFINE l_allow_insert  LIKE type_t.num5        #可新增否 
   DEFINE l_allow_delete  LIKE type_t.num5        #可刪除否  
   DEFINE l_count         LIKE type_t.num5
   DEFINE l_insert        LIKE type_t.num5
   DEFINE p_cmd           LIKE type_t.chr5
   #add-point:input段define
   {<point name="input.define"/>}
   #end add-point
 
   #畫面開啟 (identifier)
   OPEN WINDOW w_asfp310_01 WITH FORM cl_ap_formpath("asf","asfp310_01")
 
   #瀏覽頁簽資料初始化
   CALL cl_ui_init()
   
   LET g_qryparam.state = "i"
   LET p_cmd = 'a'
   
   #輸入前處理
   #add-point:單頭前置處理
   {<point name="input.pre_input"/>}
   #end add-point
  
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      #輸入開始
      INPUT BY NAME g_sfda_m.sfdadocno,g_sfda_m.method ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION
         #add-point:單頭前置處理
         {<point name="input.action"/>}
         #end add-point
         
         #自訂ACTION(master_input)
         
         
         BEFORE INPUT
            #add-point:單頭輸入前處理
            {<point name="input.before_input"/>}
            #end add-point
          
                  #此段落由子樣板a01產生
         BEFORE FIELD sfdadocno
            #add-point:BEFORE FIELD sfdadocno
            {<point name="input.b.sfdadocno" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD sfdadocno
            
            #add-point:AFTER FIELD sfdadocno
            {<point name="input.a.sfdadocno" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE sfdadocno
            #add-point:ON CHANGE sfdadocno
            {<point name="input.g.sfdadocno" />}
            #END add-point
 
         #此段落由子樣板a01產生
         BEFORE FIELD method
            #add-point:BEFORE FIELD method
            {<point name="input.b.method" />}
            #END add-point
 
         #此段落由子樣板a02產生
         AFTER FIELD method
            
            #add-point:AFTER FIELD method
            {<point name="input.a.method" />}
            #END add-point
            
 
         #此段落由子樣板a04產生
         ON CHANGE method
            #add-point:ON CHANGE method
            {<point name="input.g.method" />}
            #END add-point
 
 #欄位檢查
                  #Ctrlp:input.c.sfdadocno
         ON ACTION controlp INFIELD sfdadocno
            #add-point:ON ACTION controlp INFIELD sfdadocno
            {<point name="input.c.sfdadocno" />}
            #END add-point
 
         #Ctrlp:input.c.method
         ON ACTION controlp INFIELD method
            #add-point:ON ACTION controlp INFIELD method
            {<point name="input.c.method" />}
            #END add-point
 
 #欄位開窗
 
         AFTER INPUT
            #add-point:單頭輸入後處理
            {<point name="input.after_input"/>}
            #end add-point
            
      END INPUT
    
      #add-point:自定義input
      {<point name="input.more_input"/>}
      #end add-point
    
      #公用action
      ON ACTION accept
         ACCEPT DIALOG
        
      ON ACTION cancel
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
 
   #add-point:畫面關閉前
   {<point name="input.before_close"/>}
   #end add-point
   
   #畫面關閉
   CLOSE WINDOW w_asfp310_01 
   
   #add-point:input段after input 
   {<point name="input.post_input"/>}
   #end add-point    
   
END FUNCTION
]]>
  </section>
  <section id="asfp310_01.other_dialog" ver="1" status="" src="s">
    <![CDATA[{<point name="other.dialog"/>}
]]>
  </section>
  <section id="asfp310_01.other_function" ver="1" status="" src="s">
    <![CDATA[{<point name="other.function"/>}
]]>
  </section>
</add_points>
