#該程式已解開Section, 不再透過樣板產出!
{<section id="asft310.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0065(2016-05-17 17:35:54), PR版次:0065(2017-02-21 09:25:10)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000806
#+ Filename...: asft310
#+ Description: 工單發料維護作業
#+ Creator....: 00768(2013-11-26 11:13:32)
#+ Modifier...: 07024 -SD/PR- 04441
 
{</section>}
 
{<section id="asft310.global" >}
#應用 i00 樣板自動產生(Version:10)
#add-point:填寫註解說明 name="global.memo"
#  memo.......: 1.g_sfdc_d[n].sfba028栏位只有在超領工單領工單不存在的料件时，才会是空的，否则不应该空，应查看工单资料是否正确
#                 各表间联动等应注意为null的情况
#               2.sfdc009 参考单位，当参数或料件设置为不做参考单位管理时，会有null的情况
#                 各表间联动等应注意为null的情况
#141204 料件做产品特征管理时，产品特征栏位不允许空白
#       发退料的产品特征要控制住对应的特征数量，否则容易造成库存错乱
#141211 asft310_01原沒有庫位的就不會產生到單身
#       改成
#       沒有庫位資料的也產生到單身去，只是實際數量為0，然後要可以確認、過帳
#       （实务说明：申請的人輸入單據，確認；到倉庫那確實沒有庫存，那實際量就0，其他的有庫存還是要發）
#141222 增加单头单身备注
#141226 欠料補料輸入工單時，如果無欠料資訊請提出警示，並不允許輸入，如輸入後在自動產生申請資料時，如果找不到資料也給提示
#150101 单位转换率改写
#150107 补足仓储批开窗管控，工单指定的开窗筛选，不可直接为空格
#150109 提高效能
#150115 对数量做单位取位
#150121 因150109提高效能，单身进入的显示，需重新获取下信息
#150304 检查工单的开单日期是否大于等于发退料的单据日期
#150309 在申请数量处增加欠料补料的检查
#150831 增加制造批序号功能
#151110-00030#1   2015/11/11  By Shiun      'ON ACTION unpost'，'ON ACTION unconf'少了權限控管
#151117-00005#1   2015/12/04  By TSD.Tim    資料異動時異動條碼資料(bcae_t,bcaf_t)
#151210-00012#1   2015/12/10  By Sarah      確認後判斷D-BAS-0083參數=Y則自動過帳
#151224-00025#4   2015/12/28  By yihsuan    手動輸入特徵碼同步新增inam_t[料件產品特徵明細檔]
#151222-00004#1   2015/12/28  By tsungyung  發料套數需扣除已發料數及已退料數
#151217-00023#5   2015/12/30  By Sarah      已確認的單據，可按整單操作"發料明細修改"修改發料明細數量，AFTER FIELD數量應彈出製造批序號的視窗重新維護(參照asrt310)
#160112-00015#2   2016/01/15  By Dorislai   sfaa012欄位屬性改成num，format才有用
#160125-00025#2   2016/02/15  By earl       整理條碼產生邏輯
#160128-00004#1   2016/03/10  By dorislai   修正校驗指定庫位(sfdc012)與開窗值不一致問題。問題：少了開窗多加的where條件
#160314-00009#15  2016/03/28  By xujing     产品特征自动开窗增加参数判断
#160129-00010#1   2016/04/06  By catmoon    修正檢查取替代料號的SQL條件
#160411-00018#1   2016/04/13  By Sarah      明明有資料,但點擊“製造批序號維護”按鈕沒有反應
#160318-00025#22  2016/04/21  BY 07900      校验代码重复错误讯息的修改
#160408-00035#7   2016/04/21  By xianghui   插入sfdd时增加备置量和在拣量的计算
#160128-00023#1   2016/05/04  By lixiang    倒扣料來源增加委外採購入庫單來源類型
#160408-00043#1   2016/05/18  By dorislai   修正【實際製造批序號明細】頁簽下的第幾項共幾項顯示不正確的狀況
#160126-00022#1   2016/05/30  By dorislai   修正【發料明細】頁籤下的庫存管理特徵是否可"輸入"的控卡
#160126-00023#1   2016/05/30  By dorislai   修正【發料明細】頁籤下的庫存管理特徵是否可"必輸"的控卡
#160613-00019#1   2016/06/26  By Sarah      asft315工單+Run Card+作業編號+作業序累計預計套數sfdb006不可大於asft301中製程的良品轉入數量sfcb050
#160623-00014#1   2016/06/27  By dorislai   為應應行業別，修改g_prog。
#                                                        原：g_prog='程式代碼'→改成：g_prog MATCHES '程式代碼*' (CASE WHEN 也有改)
#160705-00042#9   2016/07/13  By sakura     #160623-00014#1,g_prog MATCHES '程式代碼*'→g_prog MATCHES '程式代碼'
#160519-00022#18  2016/07/14  By 02040      #依料號控卡批號是否輸入
#160519-00008#18  2016/07/28  By 02097      单据上库存管理特征栏位依依料件设定控管
#160810-00046#1   2016/08/10  By wuxja      加上权限控管
#160812-00017#4   2016/08/15  By 06814     在satatchange( )的FUNCTION中，有RETURN指令但沒有加上transaction_end( ) 造成transaction沒有結束就直接RETURN
#160804-00045#1   2016/08/22  BY liuym      工单退料时，不管控库位是否存在被退料件
#160818-00017#36  2016/08/28  By lixh       单据类作业修改，删除时需重新检查状态
#160906-00040#1   2016/10/26  By Whitney    工單过滤掉委外类型
#161026-00049#1   2016/10/26  By Whitney    g_data_owner權限控管
#160914-00019#1   2016/11/04  By Whitney    Action權限檢查&reference顯示&修改時寫入log檔&count(1)取代
#161108-00013#1   2016/11/08  By dorislai   全域變數num5改成num10
#161109-00085#29  2016/11/15  By lienjunqi  整批調整系統星號寫法
#161109-00085#62  2016/11/28  By 08171      整批調整系統星號寫法
#161128-00043#1   2016/12/02  By liuym      不管S-MFG-0055参数是否勾选，发料时都要计算工单退料套数
#161205-00031#1   2016/12/05  By Sarah      單身倉庫不做儲位管理，輸入庫位後不應提示儲位不存在
#161129-00039#1   2016/11/06  By liuym      调整编辑状态下，从第二页签切换到第一页签时，第二页签单身自动增加一行项次为2的空记录
#161207-00067#1   2016/12/08  By liuym      调整D-MFG-0071设定为Y可超领间接材料时，系统报错问题
#161208-00061#1   2016/12/12  By Jessica    1.移除[提交]功能 2.移除[抽單]功能 3.狀態為D.抽單/R.已拒絕，無法作廢 4.狀態為D.抽單/R.已拒絕，無法刪除
#161214-00062#1   2016/12/15  By Sarah      browser_fill()增加呼叫權限過濾器lib
#161212-00025#1   2016/12/16  By Whitney    保存單頭舊值
#160824-00007#251 2016/12/19  By sakura     新舊值備份處理
#161215-00075#1   2016/12/21  By ouhz       调整asft312 D-MFG-0071设定为Y可超领间接材料时 发料需求页签下的工单项次,工单项序给值问题
#161215-00020#1   2016/12/21  By liuym      修复页签切换，时常出现需求页签‘申请制造批序号’选项无法点击问题
#161006-00018#10  2016/12/30  By Whitney    D-MFG-0050控管需求頁籤，D-MFG-0085控管明細的庫儲是否可修改改
#161207-00025#1   2017/01/10  By liuym      工单完工入库数量等于生产数量时，不允许成套退料
#170111-00041#1   2017/01/11  By shiun      mark，160906-00040#1修改的部分
#170102-00013#1   2017/01/19  By 066694     除了(sfdb004_chk())外，(sfdb005_chk())也需做一樣的過濾
#170116-00033#1   2017/01/20  By Whitney    庫儲批修改後，說明欄位需一併更新
#170118-00057#1   2017/01/23  By fionchen   調整#161215-00075#1,工單項次給值,除了取得工單最大項次之外,也要考慮輸入多筆不存在BOM的料件資料的給值問題
#170120-00052#1   2017/01/24  By fionchen   調整#161006-00018#10,單據為確認狀態才需處理在檢量
#170207-00014#1   2017/02/07  By fionchen   調整刪除項次後其他筆的在揀量也被刪除的問題
#161205-00025#6   2017/02/09  By Whitney    asft310_b_fill()效能优化
#170206-00019#1   2017/02/14  By Whitney    延續170102-00013，asft315和asft215要一起控管
#170216-00021#1   2017/02/16  By liuym      单据状态变更后需显示当前单据
#170217-00024#1   2017/02/20  By Ann_Huang  因為asft310_browser_fill()沒有重撈,導致發料結束後,沒重新顯示單身,修正原#170216-00021#1的問題
#170209-00003#1   2017/02/21  By Whitney    修正發料明細下查詢條件無法抓取資料
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"
IMPORT util
IMPORT FGL sub_s_lot #add 150831
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:free_style模組變數(Module Variable) name="free_style.variable"
{<Module define>}

#單頭 type 宣告
 type type_g_sfda_m        RECORD
       sfdadocno LIKE sfda_t.sfdadocno,
   oobal004 LIKE type_t.chr80,
   sfdadocdt LIKE sfda_t.sfdadocdt,
   sfda001 LIKE sfda_t.sfda001,
   sfda002 LIKE sfda_t.sfda002,
   sfda003 LIKE sfda_t.sfda003,
   sfda003_desc LIKE type_t.chr80,
   sfda004 LIKE sfda_t.sfda004,
   sfda004_desc LIKE type_t.chr80,
   sfda005 LIKE sfda_t.sfda005,
   sfda015 LIKE sfda_t.sfda015,
   sfda014 LIKE sfda_t.sfda014,
   sfdastus LIKE sfda_t.sfdastus,
   sfda_ooff013     LIKE ooff_t.ooff013, #add 141222
   sfdaownid LIKE sfda_t.sfdaownid,
   sfdaownid_desc LIKE type_t.chr80,
   sfdaowndp LIKE sfda_t.sfdaowndp,
   sfdaowndp_desc LIKE type_t.chr80,
   sfdacrtid LIKE sfda_t.sfdacrtid,
   sfdacrtid_desc LIKE type_t.chr80,
   sfdacrtdp LIKE sfda_t.sfdacrtdp,
   sfdacrtdp_desc LIKE type_t.chr80,
   sfdacrtdt DATETIME YEAR TO SECOND,
   sfdamodid LIKE sfda_t.sfdamodid,
   sfdamodid_desc LIKE type_t.chr80,
   sfdamoddt DATETIME YEAR TO SECOND,
   sfdacnfid LIKE sfda_t.sfdacnfid,
   sfdacnfid_desc LIKE type_t.chr80,
   sfdacnfdt DATETIME YEAR TO SECOND,
   sfdapstid LIKE sfda_t.sfdapstid,
   sfdapstid_desc LIKE type_t.chr80,
   sfdapstdt DATETIME YEAR TO SECOND
       END RECORD

#單身 type 宣告
 TYPE type_g_sfdb_d        RECORD 
   sfdb001 LIKE sfdb_t.sfdb001,
   sfdb002 LIKE sfdb_t.sfdb002,
   sfdb003 LIKE sfdb_t.sfdb003,
   sfdb003_desc LIKE type_t.chr500,
   sfdb004 LIKE sfdb_t.sfdb004,
   sfdb004_desc LIKE type_t.chr500,
   sfdb005 LIKE sfdb_t.sfdb005,
   sfaa010 LIKE type_t.chr80,
   sfaa010_desc LIKE type_t.chr80,
   sfaa010_desc2 LIKE type_t.chr80,
   sfaa012 LIKE type_t.num20_6,#type_t.chr80, #160112-00015#2-mod
   sfaa013 LIKE type_t.chr80,
   sfdb006 LIKE sfdb_t.sfdb006,
   sfdb007 LIKE sfdb_t.sfdb007,
   sfdb008 LIKE sfdb_t.sfdb008
       END RECORD
 TYPE type_g_sfdc_d RECORD
   sfdcseq LIKE sfdc_t.sfdcseq,
   sfdc001 LIKE sfdc_t.sfdc001,
   sfdc002 LIKE sfdc_t.sfdc002,
   sfdc003 LIKE sfdc_t.sfdc003,
   sfba002 LIKE sfba_t.sfba002,
   sfba002_desc LIKE type_t.chr500,
   sfba003 LIKE sfba_t.sfba003,
   sfba003_desc LIKE type_t.chr500,
   sfba004 LIKE sfba_t.sfba004,
   replace LIKE type_t.chr1,
   sfdc004 LIKE sfdc_t.sfdc004,
   sfdc004_desc LIKE type_t.chr500,
   sfdc004_desc2 LIKE type_t.chr500,
   sfdc005 LIKE sfdc_t.sfdc005,
   sfdc005_desc LIKE type_t.chr500,
   imaf034 LIKE imaf_t.imaf034,
   imae092 LIKE imae_t.imae092,
   sfba028 LIKE sfba_t.sfba028,
   sfdc006 LIKE sfdc_t.sfdc006,
   sfdc006_desc LIKE type_t.chr500,
   sfba013 LIKE sfba_t.sfba013,
   sfba016 LIKE sfba_t.sfba016,
   sfdc007 LIKE sfdc_t.sfdc007,
   sfdc008 LIKE sfdc_t.sfdc008,
   diff LIKE sfdc_t.sfdc007,
   sfdc009 LIKE sfdc_t.sfdc009,
   sfdc009_desc LIKE type_t.chr500,
   sfdc010 LIKE sfdc_t.sfdc010,
   sfdc011 LIKE sfdc_t.sfdc011,
   diff2 LIKE sfdc_t.sfdc007,
   sfdc012 LIKE sfdc_t.sfdc012,
   sfdc012_desc LIKE type_t.chr500,
   sfdc013 LIKE sfdc_t.sfdc013,
   sfdc013_desc LIKE type_t.chr500,
   sfdc014 LIKE sfdc_t.sfdc014,
   sfdc016 LIKE sfdc_t.sfdc016,
   sfdc015 LIKE sfdc_t.sfdc015,
   sfdc015_desc LIKE type_t.chr500,
   sfdc017 LIKE sfdc_t.sfdc017,
   sfdc_ooff013     LIKE ooff_t.ooff013  #add 141222
       END RECORD

 TYPE type_g_sfde_d RECORD
   sfdeseq LIKE sfde_t.sfdeseq,
   sfde001 LIKE sfde_t.sfde001,
   sfde001_desc LIKE type_t.chr500,
   sfde001_desc2 LIKE type_t.chr80,
   sfde002 LIKE sfde_t.sfde002,
   sfde002_desc LIKE type_t.chr500,
   imaf034 LIKE imaf_t.imaf034,
   imae092 LIKE imae_t.imae092,
   sfde009 LIKE sfde_t.sfde009,
   sfde003 LIKE sfde_t.sfde003,
   sfde003_desc LIKE type_t.chr500,
   sfde004 LIKE sfde_t.sfde004,
   sfde005 LIKE sfde_t.sfde005,
   diff03 LIKE type_t.chr80,
   sfde006 LIKE sfde_t.sfde006,
   sfde006_desc LIKE type_t.chr500,
   sfde007 LIKE sfde_t.sfde007,
   sfde008 LIKE sfde_t.sfde008,
   diff23 LIKE type_t.chr80,
   sfde010 LIKE sfde_t.sfde010
       END RECORD

 TYPE type_g_sfdc4_d RECORD
       sfdcseq LIKE sfdc_t.sfdcseq,
   sfdc001 LIKE sfdc_t.sfdc001,
   sfdc002 LIKE sfdc_t.sfdc002,
   sfdc003 LIKE sfdc_t.sfdc003,
   sfba002 LIKE sfba_t.sfba002,
   sfba002_desc LIKE type_t.chr500,
   sfba003 LIKE sfba_t.sfba003,
   sfba003_desc LIKE type_t.chr500,
   sfba004 LIKE sfba_t.sfba004,
   replace LIKE type_t.chr1,
   sfdc004 LIKE sfdc_t.sfdc004,
   sfdc004_desc LIKE type_t.chr500,
   sfdc004_desc2 LIKE type_t.chr500,
   sfdc005 LIKE sfdc_t.sfdc005,
   sfdc005_desc LIKE type_t.chr500,
   imaf034 LIKE imaf_t.imaf034,
   imae092 LIKE imae_t.imae092,
   sfba028 LIKE sfba_t.sfba028,
   sfdc006 LIKE sfdc_t.sfdc006,
   sfdc006_desc LIKE type_t.chr500,
   sfba013 LIKE sfba_t.sfba013,
   sfba016 LIKE sfba_t.sfba016,
   sfdc007 LIKE sfdc_t.sfdc007,
   sfdc008 LIKE sfdc_t.sfdc008,
   diff LIKE sfdc_t.sfdc007,
   sfdc009 LIKE sfdc_t.sfdc009,
   sfdc009_desc LIKE type_t.chr500,
   sfdc010 LIKE sfdc_t.sfdc010,
   sfdc011 LIKE sfdc_t.sfdc011,
   diff2 LIKE sfdc_t.sfdc007,
   sfdc012 LIKE sfdc_t.sfdc012,
   sfdc012_desc LIKE type_t.chr500,
   sfdc013 LIKE sfdc_t.sfdc013,
   sfdc013_desc LIKE type_t.chr500,
   sfdc014 LIKE sfdc_t.sfdc014,
   sfdc016 LIKE sfdc_t.sfdc016,
   sfdc015 LIKE sfdc_t.sfdc015,
   sfdc015_desc LIKE type_t.chr500,
   sfdc017 LIKE sfdc_t.sfdc017,
   sfdc_ooff013     LIKE ooff_t.ooff013  #add 141222
       END RECORD

 TYPE type_g_sfdf_d RECORD
       sfdfseq1 LIKE sfdf_t.sfdfseq1,
   sfdf001 LIKE sfdf_t.sfdf001,
   sfdf001_desc LIKE type_t.chr80,
   sfdf001_desc2 LIKE type_t.chr80,
   sfdf013 LIKE sfdf_t.sfdf013,
   sfdf013_desc LIKE type_t.chr80,
   sfdf002 LIKE sfdf_t.sfdf002,
   sfdf003 LIKE sfdf_t.sfdf003,
   sfdf003_desc LIKE type_t.chr500,
   sfdf004 LIKE sfdf_t.sfdf004,
   sfdf004_desc LIKE type_t.chr500,
   sfdf005 LIKE sfdf_t.sfdf005,
   sfdf010 LIKE sfdf_t.sfdf010,
   sfdf006 LIKE sfdf_t.sfdf006,
   sfdf006_desc LIKE type_t.chr500,
   sfdf007 LIKE sfdf_t.sfdf007,
   sfdf008 LIKE sfdf_t.sfdf008,
   sfdf008_desc LIKE type_t.chr500,
   sfdf009 LIKE sfdf_t.sfdf009,
   sfdf011 LIKE sfdf_t.sfdf011,
   sfdf012 LIKE sfdf_t.sfdf012
       END RECORD

 TYPE type_g_sfdd_d RECORD
   sfddseq1 LIKE sfdd_t.sfddseq1,
   sfdd001 LIKE sfdd_t.sfdd001,
   sfdd001_desc LIKE type_t.chr500,
   sfdd001_desc2 LIKE type_t.chr80,
   sfdd013 LIKE sfdd_t.sfdd013,
   sfdd013_desc LIKE type_t.chr500,
   sfdd002 LIKE sfdd_t.sfdd002,
   sfdd003 LIKE sfdd_t.sfdd003,
   sfdd003_desc LIKE type_t.chr500,
   sfdd004 LIKE sfdd_t.sfdd004,
   sfdd004_desc LIKE type_t.chr500,
   sfdd005 LIKE sfdd_t.sfdd005,
   sfdd010 LIKE sfdd_t.sfdd010,
   sfdd006 LIKE sfdd_t.sfdd006,
   sfdd006_desc LIKE type_t.chr500,
   sfdd007 LIKE sfdd_t.sfdd007,
   sfdd008 LIKE sfdd_t.sfdd008,
   sfdd008_desc LIKE type_t.chr500,
   sfdd009 LIKE sfdd_t.sfdd009,
   sfdd011 LIKE sfdd_t.sfdd011,
   sfdd012 LIKE sfdd_t.sfdd012,
   sfdd_ooff013     LIKE ooff_t.ooff013,  #add 141222
   sfdd014 LIKE sfdd_t.sfdd014,    #160408-00035#7
   sfdd015 LIKE sfdd_t.sfdd015     #160408-00035#7
       END RECORD
#add 150831
 TYPE type_g_inao_d RECORD
       inaoseq LIKE inao_t.inaoseq,
   inaoseq1 LIKE inao_t.inaoseq1,
   inaoseq2 LIKE inao_t.inaoseq2,
   inao001 LIKE inao_t.inao001,
   inao001_desc LIKE type_t.chr500,
   inao001_desc2 LIKE type_t.chr80,
   inao008 LIKE inao_t.inao008,
   inao009 LIKE inao_t.inao009,
   inao010 LIKE inao_t.inao010,
   inao012 LIKE inao_t.inao012
       END RECORD
#add 150831 end
DEFINE g_mdemand         LIKE type_t.chr1   #151217-00023#5 add
#模組變數(Module Variables)
DEFINE g_sfda_m          type_g_sfda_m
DEFINE g_sfda_m_o        type_g_sfda_m  #160914-00019#1
DEFINE g_sfda_m_t        type_g_sfda_m

   DEFINE g_sfdadocno_t LIKE sfda_t.sfdadocno


DEFINE g_sfdb_d          DYNAMIC ARRAY OF type_g_sfdb_d
DEFINE g_sfdb_d_t        type_g_sfdb_d
DEFINE g_sfdb_d_o        type_g_sfdb_d
DEFINE g_sfdc_d   DYNAMIC ARRAY OF type_g_sfdc_d
DEFINE g_sfdc_d_t        type_g_sfdc_d
DEFINE g_sfdc_d_o        type_g_sfdc_d

DEFINE g_sfde_d   DYNAMIC ARRAY OF type_g_sfde_d
DEFINE g_sfde_d_t type_g_sfde_d

DEFINE g_sfdc4_d   DYNAMIC ARRAY OF type_g_sfdc4_d
DEFINE g_sfdc4_d_t type_g_sfdc4_d

DEFINE g_sfdf_d   DYNAMIC ARRAY OF type_g_sfdf_d
DEFINE g_sfdf_d_t type_g_sfdf_d
DEFINE g_sfdf_d_o type_g_sfdf_d

DEFINE g_sfdd_d   DYNAMIC ARRAY OF type_g_sfdd_d
DEFINE g_sfdd_d_t type_g_sfdd_d
DEFINE g_sfdd_d_o type_g_sfdd_d

#add 150831
DEFINE g_inao_d   DYNAMIC ARRAY OF type_g_inao_d  #其实此变量没用处，在元件里面有g_inao_d变量，申请页签的，栏位定义不一样的
DEFINE g_inao_d2  DYNAMIC ARRAY OF type_g_inao_d
DEFINE g_rec_b7   LIKE type_t.num5
DEFINE l_ac7      LIKE type_t.num5
#add 150831 end

DEFINE g_browser    DYNAMIC ARRAY OF RECORD    #資料瀏覽之欄位
         b_statepic     LIKE type_t.chr50,
            b_sfdadocno LIKE sfda_t.sfdadocno,
      b_sfdadocdt LIKE sfda_t.sfdadocdt,
      b_sfda001 LIKE sfda_t.sfda001,
      b_sfda002 LIKE sfda_t.sfda002,
      b_sfda003 LIKE sfda_t.sfda003,
   b_sfda003_desc LIKE type_t.chr80,
      b_sfda004 LIKE sfda_t.sfda004,
   b_sfda004_desc LIKE type_t.chr80,
      b_sfda005 LIKE sfda_t.sfda005
         #,rank           LIKE type_t.num10
      END RECORD

DEFINE g_browser_f  RECORD    #資料瀏覽之欄位
         b_statepic     LIKE type_t.chr50,
            b_sfdadocno LIKE sfda_t.sfdadocno,
      b_sfdadocdt LIKE sfda_t.sfdadocdt,
      b_sfda001 LIKE sfda_t.sfda001,
      b_sfda002 LIKE sfda_t.sfda002,
      b_sfda003 LIKE sfda_t.sfda003,
   b_sfda003_desc LIKE type_t.chr80,
      b_sfda004 LIKE sfda_t.sfda004,
   b_sfda004_desc LIKE type_t.chr80,
      b_sfda005 LIKE sfda_t.sfda005
         #,rank           LIKE type_t.num10
      END RECORD

DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc2_table2   STRING
DEFINE g_wc2_table3   STRING
DEFINE g_wc2_table5   STRING
DEFINE g_wc2_table6   STRING

DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING

DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog

DEFINE g_pagestart           LIKE type_t.num10                 #161108-00013#1
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數           #161108-00013#1
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數     #161108-00013#1
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數    #161108-00013#1
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數       #161108-00013#1
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數  #161108-00013#1
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)  #161108-00013#1
DEFINE g_order               STRING                             #查詢排序欄位

DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數  #161108-00013#1
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數     #161108-00013#1
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page

DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息

DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢

DEFINE g_searchcol           STRING                        #查詢欄位代碼
DEFINE g_searchstr           STRING                        #查詢欄位字串

#160914-00019#1-s
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
#160914-00019#1-e

{</Module define>}
#end add-point
 
#add-point:自定義模組變數(Module Variable) name="global.variable"
DEFINE g_docdt               LIKE type_t.dat
DEFINE l_success             LIKE type_t.num5
DEFINE l_success_tot         LIKE type_t.num5
DEFINE g_para                LIKE type_t.chr80
DEFINE g_ref_unit            LIKE type_t.chr1   #是否启用参考单位
DEFINE g_ooba002             LIKE ooba_t.ooba002  #单别

DEFINE la_param  RECORD
         prog   STRING,
         actionid   STRING,
         background LIKE type_t.chr1,
         param  DYNAMIC ARRAY OF STRING
                END RECORD
DEFINE ls_js  STRING

GLOBALS
   DEFINE g_d_idx_display   LIKE type_t.num5   #製造批序號明細所在筆數
   DEFINE g_d_cnt_display   LIKE type_t.num5   #製造批序號明細總筆數
   DEFINE g_appoint_idx     LIKE type_t.num5   #指定進入單身行數
END GLOBALS

DEFINE g_sfdc012_switch   LIKE type_t.chr1   #庫位        可输入性 Y可输入 N不可输入
DEFINE g_sfdc013_switch   LIKE type_t.chr1   #儲位        可输入性 Y可输入 N不可输入
DEFINE g_sfdc014_switch   LIKE type_t.chr1   #批號        可输入性 Y可输入 N不可输入
DEFINE g_sfdc016_switch   LIKE type_t.chr1   #庫存管理特徵 可输入性 Y可输入 N不可输入

DEFINE g_sfdf003_switch   LIKE type_t.chr1   #庫位        可输入性 Y可输入 N不可输入
DEFINE g_sfdf004_switch   LIKE type_t.chr1   #儲位        可输入性 Y可输入 N不可输入
DEFINE g_sfdf005_switch   LIKE type_t.chr1   #批號        可输入性 Y可输入 N不可输入
DEFINE g_sfdf010_switch   LIKE type_t.chr1   #庫存管理特徵 可输入性 Y可输入 N不可输入

DEFINE g_sfdd003_switch   LIKE type_t.chr1   #庫位        可输入性 Y可输入 N不可输入 add 141211
DEFINE g_sfdd004_switch   LIKE type_t.chr1   #儲位        可输入性 Y可输入 N不可输入
DEFINE g_sfdd005_switch   LIKE type_t.chr1   #批號        可输入性 Y可输入 N不可输入
DEFINE g_sfdd010_switch   LIKE type_t.chr1   #庫存管理特徵 可输入性 Y可输入 N不可输入

DEFINE g_qty_t          LIKE sfdc_t.sfdc007  #add 150101数量 中间变量
DEFINE g_ooca002     LIKE ooca_t.ooca002  #小數位數  #add 150115
DEFINE g_ooca004     LIKE ooca_t.ooca004  #捨入類型  #add 150115
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
{</section>}
 
{<section id="asft310.main" >}
#+ 作業開始
MAIN
   #add-point:main段define
   DEFINE l_success LIKE type_t.num5
   #end add-point    
 
   #定義在其他link的程式則無效
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("asf","")
 
   #add-point:作業初始化
   CALL cl_get_para(g_enterprise,g_site,'S-MFG-0031') RETURNING g_docdt     #库存关帐日期
   IF cl_null(g_docdt) THEN
      #获取库存关账日期失败!请至【aoos020营运据点参数设定作业】中维护“库存关账日期”！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00149'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      #EXIT PROGRAM
      CALL cl_ap_exitprogram("1")
   END IF
   CALL cl_get_para(g_enterprise,g_site,'S-BAS-0028') RETURNING g_ref_unit  #是否启用参考单位
   CALL s_aooi390_cre_tmp_table() RETURNING l_success   #add--2015/05/08 By shiun
   #end add-point
 
   #add-point:SQL_define
   #建立临时表
   #CALL asft310_crt_temp_table() RETURNING l_success
   CALL s_asft310_create_table1() RETURNING l_success
   IF NOT l_success THEN
      #EXIT PROGRAM
      CALL cl_ap_exitprogram("1")
   END IF
  
   
   LET g_forupd_sql = "SELECT sfdadocno,'',sfdadocdt,sfda001,sfda002,sfda003,'',sfda004,'',sfda005,sfda015,sfda014,sfdastus, 
       sfdaownid,'',sfdaowndp,'',sfdacrtid,'',sfdacrtdp,'',sfdacrtdt,sfdamodid,'',sfdamoddt,sfdacnfid, 
       '',sfdacnfdt,sfdapstid,'',sfdapstdt FROM sfda_t WHERE sfdaent= ? AND sfdadocno=?  
       FOR UPDATE"
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)    #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料  #160731-00253#1
   DECLARE asft310_cl CURSOR FROM g_forupd_sql 
   
   IF g_bgjob = "Y" THEN
 
      #add-point:Service Call
                  
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_asft310 WITH FORM cl_ap_formpath("asf",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL asft310_init()
   
      #進入選單 Menu (='N')
      CALL asft310_ui_dialog()
   
      #畫面關閉
      CLOSE WINDOW w_asft310
   END IF
 
   #add-point:作業離開前
   #CALL asft310_drop_temp_table()
   CALL s_asft310_drop_table1() RETURNING l_success
   CALL s_aooi390_drop_tmp_table()   #add--2015/05/08 By shiun
   CALL s_lot_sel_drop_tmp()   #add 150831
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
 
END MAIN
 
{</section>}
 
{<section id="asft310.other_function" readonly="Y" >}
#add-point:自定義元件(Function) name="other.function"
################################################################################
# Descriptions...: 單別檢查
# Memo...........:
# Usage..........: CALL asft310_chk_sfdadocno()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2013/11/27 By zhangllc
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_chk_sfdadocno()
DEFINE l_cnt      LIKE type_t.num5

   LET g_errno = ""
   LET l_cnt = 0
   SELECT COUNT(1) INTO l_cnt
     FROM oobl_t
    WHERE oobl001 IN (SELECT ooef004 FROM ooef_t
                       WHERE ooef001 = g_site
                         AND ooefent = g_enterprise )
      AND oobl002 = g_sfda_m.sfdadocno
      AND ooblent = g_enterprise
      AND oobl003 = g_prog
    IF l_cnt = 0 THEN
       LET g_errno = 'abm-00066'
    END IF
END FUNCTION
################################################################################
# Descriptions...: 顯示單據說明
# Memo...........:
# Usage..........: CALL asft310_get_oobal004()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2013/11/27 By zhangllc
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_get_oobal004()
DEFINE l_ooef004       LIKE ooef_t.ooef004

   LET l_ooef004 = ""
   LET g_sfda_m.oobal004 = ""
   SELECT ooef004 INTO l_ooef004
     FROM ooef_t
    WHERE ooef001 = g_site
      AND ooefent = g_enterprise
   IF NOT cl_null(l_ooef004) THEN
      SELECT oobal004 INTO g_sfda_m.oobal004
        FROM oobal_t
       WHERE oobal001 = l_ooef004
         AND oobal002 = g_sfda_m.sfdadocno
         AND oobal003 = g_dlang
         AND oobalent = g_enterprise
   END IF
   DISPLAY BY NAME g_sfda_m.oobal004
END FUNCTION
########################################
#预设sfdb005作业序
########################################
PRIVATE FUNCTION asft310_def_sfdb005()
DEFINE l_sql     STRING

   ##预设工单制程内的本站作业对应的作业序第一笔
   #IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb005) THEN RETURN END IF
   #IF cl_null(g_sfdb_d[g_detail_idx].sfdb001) OR cl_null(g_sfdb_d[g_detail_idx].sfdb002)
   #OR cl_null(g_sfdb_d[g_detail_idx].sfdb004) THEN
   #   RETURN
   #END IF
   #
   #LET l_sql = " SELECT sfcb004  FROM sfcb_t ",
   #            "  WHERE sfcbent   = ",g_enterprise,
   #            "    AND sfcbsite  = '",g_site,"' ",
   #            "    AND sfcbdocno = '",g_sfdb_d[g_detail_idx].sfdb001,"' ",  #工单单号
   #            "    AND sfcb001   = '",g_sfdb_d[g_detail_idx].sfdb002,"' ",  #RUN CARD
   #            "    AND sfcb003   = '",g_sfdb_d[g_detail_idx].sfdb004,"' ",  #作业
   #            "  ORDER BY sfcb004 "
   #DECLARE asft310_def_sfdb005_c SCROLL CURSOR FROM l_sql                                                                                    
   #OPEN asft310_def_sfdb005_c                                                        
   #FETCH FIRST asft310_def_sfdb005_c INTO g_sfdb_d[g_detail_idx].sfdb005
   #CLOSE asft310_def_sfdb005_c
   #DISPLAY BY NAME g_sfdb_d[g_detail_idx].sfdb005

   #预设工单备料档内的本站作业对应的作业序第一笔
   IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb005) THEN RETURN END IF
   IF cl_null(g_sfdb_d[g_detail_idx].sfdb001) OR cl_null(g_sfdb_d[g_detail_idx].sfdb004) THEN
      RETURN
   END IF
   
   IF g_sfda_m.sfda002='15' OR g_sfda_m.sfda002='25' THEN
      IF cl_null(g_sfdb_d[g_detail_idx].sfdb002) THEN RETURN END IF
      LET l_sql = " SELECT sfcb004  FROM sfcb_t ",
                  "  WHERE sfcbent   = ",g_enterprise,
                  "    AND sfcbsite  = '",g_site,"' ",
                  "    AND sfcbdocno = '",g_sfdb_d[g_detail_idx].sfdb001,"' ",  #工单单号
                  "    AND sfcb001   = ",g_sfdb_d[g_detail_idx].sfdb002,     #Run card
                  "    AND sfcb003   = '",g_sfdb_d[g_detail_idx].sfdb004,"' "   #作业
      IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb003) THEN  #部位
         LET l_sql = l_sql CLIPPED," AND sfba002 = '",g_sfdb_d[g_detail_idx].sfdb003,"' "
      END IF
   ELSE
      LET l_sql = " SELECT sfba004  FROM sfba_t ",
                  "  WHERE sfbaent   = ",g_enterprise,
                  "    AND sfbasite  = '",g_site,"' ",
                  "    AND sfbadocno = '",g_sfdb_d[g_detail_idx].sfdb001,"' ",  #工单单号
                  "    AND sfba003   = '",g_sfdb_d[g_detail_idx].sfdb004,"' "   #作业
      IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb003) THEN  #部位
         LET l_sql = l_sql CLIPPED," AND sfba002 = '",g_sfdb_d[g_detail_idx].sfdb003,"' "
      END IF
   LET l_sql = l_sql CLIPPED," ORDER BY sfba004 "
   END IF
   DECLARE asft310_def_sfdb005_c SCROLL CURSOR FROM l_sql                                                                                    
   OPEN asft310_def_sfdb005_c                                                        
   FETCH FIRST asft310_def_sfdb005_c INTO g_sfdb_d[g_detail_idx].sfdb005
   CLOSE asft310_def_sfdb005_c
   DISPLAY BY NAME g_sfdb_d[g_detail_idx].sfdb005
END FUNCTION
# Descriptions...: 发料套数中工单单号，相关字段值预设
PRIVATE FUNCTION asft310_sfdb001_reference(p_cmd)
DEFINE p_cmd       LIKE type_t.chr1     #a:新增 u:修改

   LET g_sfdb_d[g_detail_idx].sfaa010=''   #生产料号
   LET g_sfdb_d[g_detail_idx].sfaa010_desc=''
   LET g_sfdb_d[g_detail_idx].sfaa010_desc2=''
   LET g_sfdb_d[g_detail_idx].sfaa013=''   #生产单位
   LET g_sfdb_d[g_detail_idx].sfaa012=0    #生产数量
   SELECT sfaa010,imaal003,imaal004,sfaa013,sfaa012
     INTO g_sfdb_d[g_detail_idx].sfaa010,g_sfdb_d[g_detail_idx].sfaa010_desc,g_sfdb_d[g_detail_idx].sfaa010_desc2,
          g_sfdb_d[g_detail_idx].sfaa013,g_sfdb_d[g_detail_idx].sfaa012
     FROM sfaa_t LEFT JOIN imaal_t ON sfaaent = imaalent AND sfaa010 = imaal001 AND imaal002 = g_dlang
    WHERE sfaaent   = g_enterprise
      AND sfaasite  = g_site
      AND sfaadocno = g_sfdb_d[g_detail_idx].sfdb001

   #预设runcard
   LET g_sfdb_d[g_detail_idx].sfdb002 = ''
   SELECT sfca001 INTO g_sfdb_d[g_detail_idx].sfdb002 FROM sfca_t
    WHERE sfcaent = g_enterprise
      AND sfcasite= g_site
      AND sfcadocno=g_sfdb_d[g_detail_idx].sfdb001   #工单单号
   {SELECT COUNT(1) INTO l_cnt FROM sfca_t
    WHERE sfcaent = g_enterprise
      AND sfcasite= g_site
      AND sfcadocno=g_sfdb_d[g_detail_idx].sfdb001   #工单单号
   IF l_cnt = 1 THEN
   END IF}
   
   #计算预计套数
   CALL asft310_def_sfdb006(p_cmd) RETURNING g_sfdb_d[g_detail_idx].sfdb006
   CALL asft310_def_sfdb007()

END FUNCTION
#预设sfdb006预计套数
#即：#计算最大可发料套数_分不同发料类型
PRIVATE FUNCTION asft310_def_sfdb006(p_cmd)
DEFINE p_cmd              LIKE type_t.chr1     #a:新增 u:修改
DEFINE r_sfdb006          LIKE sfdb_t.sfdb006  #最大可发预计套数

   LET r_sfdb006 = 0
   IF g_sfda_m.sfda002 = '11' THEN
      #mod 141229
      #CALL asft310_get_max_set(p_cmd,'11') RETURNING r_sfdb006
      CALL s_asft310_get_max_set(p_cmd,'11',g_sfda_m.sfdadocno,
                                 g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                 g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                 g_sfdb_d[g_detail_idx].sfdb005,
                                 g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                 g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
         RETURNING r_sfdb006
      #mod 141229 end
   ELSE
      LET r_sfdb006 = 0
   END IF
   
   IF g_sfda_m.sfda002 = '15' THEN #制程中委外发料
      #mod 141229
      #CALL asft310_get_max_set(p_cmd,'15') RETURNING r_sfdb006
      CALL s_asft310_get_max_set(p_cmd,'15',g_sfda_m.sfdadocno,
                                 g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                 g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                 g_sfdb_d[g_detail_idx].sfdb005,
                                 g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                 g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
         RETURNING r_sfdb006
      #mod 141229 end
   END IF
   
   RETURN r_sfdb006
END FUNCTION
#检查发料套数表中的工单单号
PRIVATE FUNCTION asft310_sfdb001_chk()
DEFINE r_success   LIKE type_t.num5
DEFINE l_cnt       LIKE type_t.num5
DEFINE l_sfaadocdt LIKE sfaa_t.sfaadocdt  #150304 add
#170111-00041#1-s-mark
#DEFINE l_sfaa057   LIKE sfaa_t.sfaa057    #160906-00040#1
#170111-00041#1-e-mark

   LET r_success = TRUE
   
   #150909 earl add s
   IF NOT s_aooi210_check_doc(g_site,'',g_sfdb_d[l_ac].sfdb001,g_sfda_m.sfdadocno,'4','') THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150909 earl add e
   
   #检查是否存在工单中，且为发放状态
   IF NOT s_asft300_chk_stus(g_sfdb_d[g_detail_idx].sfdb001,'F') THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #add 150304
   #检查工单的开单日期是否大于等于发退料的单据日期
   #170111-00041#1-s-mod
#   SELECT sfaadocdt,sfaa057 INTO l_sfaadocdt,l_sfaa057 FROM sfaa_t  #160906-00040#1
   SELECT sfaadocdt INTO l_sfaadocdt FROM sfaa_t
   #170111-00041#1-e-mod
    WHERE sfaaent   = g_enterprise
      AND sfaadocno = g_sfdb_d[g_detail_idx].sfdb001
   IF l_sfaadocdt > g_sfda_m.sfdadocdt THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00675'
      LET g_errparam.extend = l_sfaadocdt
      LET g_errparam.popup = FALSE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #add 150304 end
   
   #mark zhangllc 151118 --begin 放到下面case中
   #add 141226
   ##欠料补料检查是否有需补料的
   #IF g_sfda_m.sfda002 = '13' THEN
   #   CALL asft310_chk_13(g_sfdb_d[g_detail_idx].sfdb001) RETURNING l_success
   #   IF NOT l_success THEN
   #      #无欠料，不需补料
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = 'asf-00665'
   #      LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #      LET r_success = FALSE
   #      RETURN r_success
   #   END IF
   #END IF
   ##add 141226--end
   #mark zhangllc 151118 --end 放到下面case中
   #add zhangllc 151118 --begin
   #根据不同分类发退料单进行不同控制
   CASE g_sfda_m.sfda002
      WHEN '11'  #
           #检查有没有可发量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001
              AND sfba009 = 'N'  #非倒扣料
              AND sfba013 > sfba015+sfba016
           IF l_cnt = 0 THEN
              #工单没有可发量，不需发料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00699'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '12'  #超领
      WHEN '13'  #欠料补料
           #欠料补料检查是否有需补料的
           CALL asft310_chk_13(g_sfdb_d[g_detail_idx].sfdb001) RETURNING l_success
           IF NOT l_success THEN
              #无欠料，不需补料
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00665'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '14'  #倒扣料
           #检查有没有可发量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001
              AND sfba009 = 'Y' #倒扣料
              AND sfba013 > sfba015+sfba016
           IF l_cnt = 0 THEN
              #工单没有可发量，不需发料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00699'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '21'
           #170111-00041#1-s-mark
#           #160906-00040#1-s
#           IF l_sfaa057 = '2' THEN
#              INITIALIZE g_errparam TO NULL
#              LET g_errparam.code = 'asf-00801'
#              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
#              LET g_errparam.popup = FALSE
#              CALL cl_err()
#              LET r_success = FALSE
#              RETURN r_success
#           END IF
#           #160906-00040#1-e
           #170111-00041#1-e-mark
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001
              AND sfba009 = 'N' #非倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '22' #超领退
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001
              AND sfba025 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
           #161207-00025#1 add-------s-----------
           #检查完工入库量等于生产数量，不可退料
           SELECT COUNT(1) INTO l_cnt FROM sfaa_t WHERE sfaaent=g_enterprise
           AND sfaasite=g_site AND sfaadocno=g_sfdb_d[g_detail_idx].sfdb001
           AND sfaa050>=sfaa012
           IF l_cnt > 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
           #161207-00025#1 add-------e-----------           
      WHEN '23'
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001
              AND sfba009 = 'N' #非倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '24' #倒扣料退料
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001
              AND sfba009 = 'Y' #倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
   END CASE
   #add zhangllc 151118 --end
   
   #检查PBI
   IF NOT cl_null(g_sfda_m.sfda005) THEN
      SELECT * FROM sfqb_t
       WHERE sfqbent   = g_enterprise
         AND sfqbdocno = g_sfda_m.sfda005
         AND sfqb001   = g_sfdb_d[g_detail_idx].sfdb001
      IF SQLCA.sqlcode THEN
         #工单单号:%1 与单头的 PBI号:%2 无相关性
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code   = 'asf-00471'
         LET g_errparam.extend = ""
         LET g_errparam.replace[1] = g_sfdb_d[g_detail_idx].sfdb001
         LET g_errparam.replace[2] = g_sfda_m.sfda005
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #检查是否在工单制程档中的Run Card内(asft301)
   IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb002) THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = g_site
      LET g_chkparam.arg2 = g_sfdb_d[g_detail_idx].sfdb001
      LET g_chkparam.arg3 = g_sfdb_d[g_detail_idx].sfdb002
      IF NOT cl_chk_exist("v_sfca001") THEN
         LET g_sfdb_d[l_ac].sfdb002 = ' '
      END IF
   END IF

   #检查是否存在工单单身的部位
   IF NOT cl_null(g_sfdb_d[l_ac].sfdb003) THEN
      SELECT COUNT(1) INTO l_cnt FROM sfba_t
       WHERE sfbaent = g_enterprise
         AND sfbasite= g_site
         AND sfbadocno=g_sfdb_d[l_ac].sfdb001
         AND sfba002 = g_sfdb_d[l_ac].sfdb003  #部位
      IF l_cnt = 0 THEN
         LET g_sfdb_d[l_ac].sfdb003 = '' #不能空格 否则required则不认识
      END IF
   END IF
   
   #检查是否存在工单单身的作业
   IF (g_sfda_m.sfda002!='15' AND g_sfda_m.sfda002!='25') AND NOT cl_null(g_sfdb_d[l_ac].sfdb004) THEN
      SELECT COUNT(1) INTO l_cnt FROM sfba_t
       WHERE sfbaent = g_enterprise
         AND sfbasite= g_site
         AND sfbadocno=g_sfdb_d[l_ac].sfdb001
         AND sfba003 = g_sfdb_d[l_ac].sfdb004  #作业
      IF l_cnt = 0 THEN
         LET g_sfdb_d[l_ac].sfdb004 = '' #不能空格 否则required则不认识
      END IF
   END IF
               
   RETURN r_success
END FUNCTION

#检查工单单号
#add zhangllc 151118
PRIVATE FUNCTION asft310_sfdc001_chk()
DEFINE r_success   LIKE type_t.num5
DEFINE l_cnt       LIKE type_t.num5
DEFINE l_sfaadocdt LIKE sfaa_t.sfaadocdt  #150304 add

   LET r_success = TRUE
   
   #从AFTER FIELD sfdc001中移过来
   #150909 earl add s
   IF NOT s_aooi210_check_doc(g_site,'',g_sfdc_d[l_ac].sfdc001,g_sfda_m.sfdadocno,'4','') THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150909 earl add e
   #检查是否存在工单中，且为发放状态
   IF NOT s_asft300_chk_stus(g_sfdc_d[l_ac].sfdc001,'F') THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   #add 150304
   #检查工单的开单日期是否大于等于发退料的单据日期
   SELECT sfaadocdt INTO l_sfaadocdt FROM sfaa_t
    WHERE sfaaent   = g_enterprise
      AND sfaadocno = g_sfdc_d[l_ac].sfdc001
   IF l_sfaadocdt > g_sfda_m.sfdadocdt THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00675'
      LET g_errparam.extend = l_sfaadocdt
      LET g_errparam.popup = FALSE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #add 150304 end
   #mark zhangllc 151118 --begin 并入下面
   #IF g_sfda_m.sfda002='11' OR g_sfda_m.sfda002='13' OR g_sfda_m.sfda002='21' THEN
   #   #检查工单需存在发料套数单身
   #   SELECT COUNT(1) INTO l_cnt FROM sfdb_t
   #    WHERE sfdbent = g_enterprise
   #      AND sfdbsite= g_site
   #      AND sfdbdocno=g_sfda_m.sfdadocno
   #      AND sfdb001 = g_sfdc_d[l_ac].sfdc001
   #   IF l_cnt = 0 THEN
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = 'asf-00043'
   #      LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #      LET r_success = FALSE
   #      RETURN r_success
   #   END IF
   #END IF
   #mark zhangllc 151118 --end
   #add zhangllc 151118 --begin
   CASE g_sfda_m.sfda002
      WHEN '11'
           #检查工单需存在发料套数单身
           SELECT COUNT(1) INTO l_cnt FROM sfdb_t
            WHERE sfdbent = g_enterprise
              AND sfdbsite= g_site
              AND sfdbdocno=g_sfda_m.sfdadocno
              AND sfdb001 = g_sfdc_d[l_ac].sfdc001
           IF l_cnt = 0 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00043'
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '12'
      WHEN '13'
           #检查工单需存在发料套数单身
           SELECT COUNT(1) INTO l_cnt FROM sfdb_t
            WHERE sfdbent = g_enterprise
              AND sfdbsite= g_site
              AND sfdbdocno=g_sfda_m.sfdadocno
              AND sfdb001 = g_sfdc_d[l_ac].sfdc001
           IF l_cnt = 0 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00043'
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '14'
           #检查有没有可发量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
              #AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001  #mark by lixiang 2015/12/10 
              AND sfbadocno = g_sfdc_d[l_ac].sfdc001  #add by lixiang 2015/12/10 
              AND sfba009 = 'Y' #倒扣料
              AND sfba013 > sfba015+sfba016
           IF l_cnt = 0 THEN
              #工单没有可发量，不需发料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00699'
              #LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001  #mark by lixiang 2015/12/10 
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001  #add by lixiang 2015/12/10
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '21'
           #检查工单需存在发料套数单身
           SELECT COUNT(1) INTO l_cnt FROM sfdb_t
            WHERE sfdbent = g_enterprise
              AND sfdbsite= g_site
              AND sfdbdocno=g_sfda_m.sfdadocno
              AND sfdb001 = g_sfdc_d[l_ac].sfdc001
           IF l_cnt = 0 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00043'
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
#              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              AND sfbadocno = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              AND sfba009 = 'N' #非倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
#              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '22' #超领退
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
#              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              AND sfbadocno = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              AND sfba025 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
#              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '23'
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
#              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              AND sfbadocno = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              AND sfba009 = 'N' #非倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
#              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '24'
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
#              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              AND sfbadocno = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              AND sfba009 = 'Y' #倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
#              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN '25'
           #检查有没有可退量
           SELECT COUNT(1) INTO l_cnt FROM sfba_t
            WHERE sfbaent   = g_enterprise
              AND sfbasite  = g_site
#              AND sfbadocno = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              AND sfbadocno = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              AND sfba009 = 'N' #非倒扣料
              AND sfba016 > 0
           IF l_cnt = 0 THEN
              #工单没有可退量，不需退料！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00700'
#              LET g_errparam.extend = g_sfdb_d[g_detail_idx].sfdb001  #160120-00010 by whitney mark
              LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001           #160120-00010 by whitney add
              LET g_errparam.popup = FALSE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
   END CASE
   #add zhangllc 151118 end
   
   RETURN r_success
END FUNCTION

#根据工单+项次+项序预设发料需求档的资料
PRIVATE FUNCTION asft310_sfdc003_reference(p_cmd)
DEFINE p_cmd            LIKE type_t.chr1     #a:新增 u:修改
DEFINE r_success        LIKE type_t.num5
#DEFINE l_sfaa010        LIKE sfaa_t.sfaa010  #生产料号
DEFINE l_sfba001        LIKE sfba_t.sfba001  #生产料号
DEFINE l_sfaa011        LIKE sfaa_t.sfaa011  #特性
DEFINE l_success        LIKE type_t.num5
DEFINE l_rate           LIKE inaj_t.inaj014  #单位换算率
DEFINE l_cnt            LIKE type_t.num5
DEFINE l_sfba008        LIKE sfba_t.sfba008  #必要性
DEFINE l_where          STRING
DEFINE l_flag2          LIKE type_t.num5   #s_control使用
DEFINE l_sfba025        LIKE sfba_t.sfba025 #超领量
DEFINE l_imaa005        LIKE imaa_t.imaa005  #产品特征
#DEFINE l_imae101        LIKE imae_t.imae101  #预设发料库位
#DEFINE l_imae102        LIKE imae_t.imae102  #预设发料储位
#DEFINE l_imae103        LIKE imae_t.imae103  #预设退料库位
#DEFINE l_imae104        LIKE imae_t.imae104  #预设退料储位
#mark 给发料前调拨使用的
DEFINE l_imaf091        LIKE imaf_t.imaf091
DEFINE l_imaf092        LIKE imaf_t.imaf092

   LET r_success = TRUE
   
   #PBI检查
   IF NOT cl_null(g_sfda_m.sfda005) THEN
      SELECT * FROM sfqb_t
       WHERE sfqbent   = g_enterprise
         AND sfqbdocno = g_sfda_m.sfda005
         AND sfqb001   = g_sfdc_d[l_ac].sfdc001
      IF SQLCA.sqlcode THEN
         #工单单号:%1 与单头的 PBI号:%2 无相关性
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code   = 'asf-00471'
         LET g_errparam.extend = ""
         LET g_errparam.replace[1] = g_sfdc_d[l_ac].sfdc001
         LET g_errparam.replace[2] = g_sfda_m.sfda005
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #可超領工單未指定間接材料
   CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
   CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
   
   LET g_sfdc_d[l_ac].sfba002 = ''   #部位
   LET g_sfdc_d[l_ac].sfba002_desc = ''
   LET g_sfdc_d[l_ac].sfba003 = ''   #作业
   LET g_sfdc_d[l_ac].sfba003_desc = ''
   LET g_sfdc_d[l_ac].sfba004 = ''   #作业序
   LET g_sfdc_d[l_ac].sfdc004 = ''   #需求料号
   LET g_sfdc_d[l_ac].sfdc004_desc=''
   LET g_sfdc_d[l_ac].sfdc004_desc2=''
   LET g_sfdc_d[l_ac].sfdc005 = ''   #特征
   LET g_sfdc_d[l_ac].sfdc005_desc=''
   LET g_sfdc_d[l_ac].sfba028 = ''   #客供料
   LET g_sfdc_d[l_ac].sfdc006 = ''   #单位
   LET g_sfdc_d[l_ac].sfdc006_desc=''
   LET g_sfdc_d[l_ac].sfdc007 = 0    #申请数量
   LET g_sfdc_d[l_ac].sfdc008 = 0    #实际数量
   LET g_sfdc_d[l_ac].diff = 0
   LET g_sfdc_d[l_ac].sfdc009 = ''   #参考单位
   LET g_sfdc_d[l_ac].sfdc009_desc=''
   LET g_sfdc_d[l_ac].sfdc010 = 0    #参考单位申请数量
   LET g_sfdc_d[l_ac].sfdc011 = 0    #参考单位实际数量
   LET g_sfdc_d[l_ac].diff2 = 0
   LET g_sfdc_d[l_ac].sfba013 = 0    #应发料
   LET g_sfdc_d[l_ac].sfba016 = 0    #已发量
   LET g_sfdc_d[l_ac].sfdc012 = ''   #指定库位
   LET g_sfdc_d[l_ac].sfdc012_desc=''
   LET g_sfdc_d[l_ac].sfdc013 = ''   #指定储位
   LET g_sfdc_d[l_ac].sfdc013_desc=''
   LET g_sfdc_d[l_ac].sfdc014 = ''   #指定批号
   LET g_sfdc_d[l_ac].sfdc015 = ''   #理由码
   LET g_sfdc_d[l_ac].sfdc015_desc=''
   LET g_sfdc_d[l_ac].sfdc016 = ''   #库存管理特征
   
   LET g_sfdc_d[l_ac].replace = ''
   LET g_sfdc_d[l_ac].imae092 = ''
   LET g_sfdc_d[l_ac].imaf034 = ''
   
   DISPLAY BY NAME g_sfdc_d[l_ac].sfba002_desc,g_sfdc_d[l_ac].sfba003_desc,
                   g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2,
                   g_sfdc_d[l_ac].sfdc005_desc,
                   g_sfdc_d[l_ac].sfdc006_desc,g_sfdc_d[l_ac].sfdc009_desc,
                   g_sfdc_d[l_ac].sfdc012_desc,g_sfdc_d[l_ac].sfdc013_desc,
                   g_sfdc_d[l_ac].sfdc015_desc,g_sfdc_d[l_ac].replace,
                   g_sfdc_d[l_ac].imae092,g_sfdc_d[l_ac].imaf034
   
   SELECT sfba002,sfba003,sfba004,sfba006,sfba021,sfba028,sfba014,sfba013,sfba016,sfba019,
          sfba020,sfba029,sfba030,sfba001,sfaa011,sfba008,sfba025
     INTO g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,
          g_sfdc_d[l_ac].sfba028,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfba013,g_sfdc_d[l_ac].sfba016,g_sfdc_d[l_ac].sfdc012,
          g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,g_sfdc_d[l_ac].sfdc016,l_sfba001,l_sfaa011,l_sfba008,l_sfba025
     FROM sfba_t,sfaa_t
    WHERE sfbaent = sfaaent
      AND sfbasite= sfaasite
      AND sfbadocno=sfaadocno
      AND sfbaent = g_enterprise
      AND sfbasite= g_site
      AND sfbadocno=g_sfdc_d[l_ac].sfdc001
      AND sfbaseq = g_sfdc_d[l_ac].sfdc002
      AND sfbaseq1= g_sfdc_d[l_ac].sfdc003
   IF g_sfda_m.sfda002!='12' OR (g_sfda_m.sfda002='12' AND g_para='N') THEN
      IF SQLCA.sqlcode THEN
         #工单+项次+项序不存在工单单身档中,请检查工单维护作业asft300中的资料！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00044'
         LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   ELSE
      IF SQLCA.sqlcode THEN
         RETURN r_success
      END IF
   END IF

   IF cl_null(g_sfdc_d[l_ac].sfdc012) AND cl_null(g_sfdc_d[l_ac].sfdc013)THEN  #工单未指定仓储
      #依料號設定的主要倉、儲
      #SELECT imae101,imae102,imae103,imae104
      #  INTO l_imae101,l_imae102,l_imae103,l_imae104
      #  FROM imae_t
      # WHERE imaeent = g_enterprise
      #   AND imaesite= g_site
      #   AND imae001 = g_sfdc_d[l_ac].sfdc004
      #IF g_prog[1,6] = 'asft31' THEN #发料
      #   LET g_sfdc_d[l_ac].sfdc012 = l_imae101
      #   LET g_sfdc_d[l_ac].sfdc013 = l_imae102
      #END IF
      #IF g_prog[1,6] = 'asft32' THEN #退料
      #   LET g_sfdc_d[l_ac].sfdc012 = l_imae103
      #   LET g_sfdc_d[l_ac].sfdc013 = l_imae104
      #END IF
      #mark 给发料前调拨使用的
      SELECT imaf091,imaf092
        INTO l_imaf091,l_imaf092
        FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite= g_site
         AND imaf001 = g_sfdc_d[l_ac].sfdc004
      LET g_sfdc_d[l_ac].sfdc012 = l_imaf091
      LET g_sfdc_d[l_ac].sfdc013 = l_imaf092
   END IF

   IF l_sfba008 = '4' THEN  #参考材料
      #参考材料不需要发料，请确认！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00310'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   #檢核輸入的料件的生命週期是否在單據別限制範圍內
   CALL s_control_chk_doc('4',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc004,'','','','')
      RETURNING l_success,l_flag2    #处理状态否 存在否     都是num5类型
   IF NOT l_success OR NOT l_flag2 THEN
      #控制组检查错误,请检查单别设定的相关内容
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00122'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #檢核輸入的料件的產品分類是否在單據別限制範圍內
   CALL s_control_chk_doc('5',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc004,'','','','')
      RETURNING l_success,l_flag2    #处理状态否 存在否     都是num5类型
   IF NOT l_success OR NOT l_flag2 THEN
      #控制组检查错误,请检查单别设定的相关内容
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00122'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   #超领退料检查超领量需要大于0的
   IF g_sfda_m.sfda002='22' AND l_sfba025 = 0 THEN
      #超领数量为0，不可退料
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00386'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #一般退料检查已发数量需要大于0的
   IF g_sfda_m.sfda002='23' AND g_sfdc_d[l_ac].sfba016 = 0 THEN
      #已发数量为0，不可退料
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00385'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #部位说明
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = '215'
   LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfba002
   CALL cl_ref_val("v_oocql002")
   LET g_sfdc_d[l_ac].sfba002_desc = g_chkparam.return1
   DISPLAY BY NAME g_sfdc_d[l_ac].sfba002_desc

   #作业说明
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = '221'
   LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfba003
   CALL cl_ref_val("v_oocql002")
   LET g_sfdc_d[l_ac].sfba003_desc = g_chkparam.return1
   DISPLAY BY NAME g_sfdc_d[l_ac].sfba003_desc

   #replace取替代建议
   CALL s_abmm201_get_proposal(g_site,l_sfba001,l_sfaa011,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004) RETURNING g_sfdc_d[l_ac].replace
   DISPLAY BY NAME g_sfdc_d[l_ac].replace
   
   #需求料号品名规格
   CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004) RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
   DISPLAY BY NAME g_sfdc_d[l_ac].sfdc004_desc
   DISPLAY BY NAME g_sfdc_d[l_ac].sfdc004_desc2
   
   ##产品特征
   #SELECT imaa005 INTO l_imaa005 FROM imaa_t
   # WHERE imaaent = g_enterprise
   #   AND imaa001 = g_sfdc_d[l_ac].sfdc004
   #IF cl_null(l_imaa005) THEN  #不做产品特征管理
   #   LET g_sfdc_d[l_ac].sfdc005 = ' '
   #END IF
   #mark 不需要 资料肯定会自动变的，只要工单维护的时候卡控住就好了
   #显示产品特征说明
   CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
      RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
   IF NOT l_success THEN
      LET g_sfdc_d[l_ac].sfdc005_desc = ''
   END IF
   DISPLAY BY NAME g_sfdc_d[l_ac].sfdc005_desc
   
   #单位
   CALL s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc006) RETURNING g_sfdc_d[l_ac].sfdc006_desc
   DISPLAY BY NAME g_sfdc_d[l_ac].sfdc006_desc
   
   #保税料,参考单位
   SELECT imaf034,imaf015
     INTO g_sfdc_d[l_ac].imaf034,g_sfdc_d[l_ac].sfdc009
     FROM imaf_t
    WHERE imafent = g_enterprise
      AND imafsite= g_site
      AND imaf001 = g_sfdc_d[l_ac].sfdc004
   DISPLAY BY NAME g_sfdc_d[l_ac].imaf034
   IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
      CALL s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009) RETURNING g_sfdc_d[l_ac].sfdc009_desc
      DISPLAY BY NAME g_sfdc_d[l_ac].sfdc009_desc
   END IF

   #发料前调拨
   SELECT imae092 INTO g_sfdc_d[l_ac].imae092 FROM imae_t
    WHERE imaeent = g_enterprise
      AND imaesite= g_site
      AND imae001 = g_sfdc_d[l_ac].sfdc004
   DISPLAY BY NAME g_sfdc_d[l_ac].imae092
   
   CALL asft310_def_sfdc007(p_cmd) RETURNING g_sfdc_d[l_ac].sfdc007    #sfdc007申请数量
   #add 141226
   IF g_sfda_m.sfda002='13' AND g_sfdc_d[l_ac].sfdc007 = 0 THEN
      #无欠料，不需补料
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00665'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #add 141226 end
   LET g_sfdc_d[l_ac].sfdc008 = g_sfdc_d[l_ac].sfdc007        #实际数量
   LET g_sfdc_d[l_ac].diff = g_sfdc_d[l_ac].sfdc007 - g_sfdc_d[l_ac].sfdc008  #差异数量
   
   IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
      #参考单位申请数量=申请数量经过转换率换算为参考单位的数量
      #mod 150101
      #CALL s_aimi190_get_convert(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc009)
      #   RETURNING l_success,l_rate
      #IF NOT l_success THEN
      #   LET l_rate = 1
      #END IF
      #LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d[l_ac].sfdc007 * l_rate
      CALL s_aooi250_convert_qty(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc007)
         RETURNING l_success,g_sfdc_d[l_ac].sfdc010
      IF NOT l_success THEN
         LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d[l_ac].sfdc007
      END IF
      #mod 150101 end
      LET g_sfdc_d[l_ac].sfdc011 = 0        #参考单位实际数量
      LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010  - g_sfdc_d[l_ac].sfdc011  #参考单位差异数量
   ELSE
      LET g_sfdc_d[l_ac].sfdc010 = 0
      LET g_sfdc_d[l_ac].sfdc011 = 0        #参考单位实际数量
      LET g_sfdc_d[l_ac].diff2 = 0  #参考单位差异数量
   END IF
   
   CALL s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012) RETURNING g_sfdc_d[l_ac].sfdc012_desc    #库位名称
   CALL s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013) RETURNING g_sfdc_d[l_ac].sfdc013_desc  #储位名称
   
   #退料单:若发料批号只有一个，预设发料的批号
   IF g_prog[1,6] = 'asft32' THEN
      CALL asft310_def_sfdc014()
   END IF

   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 检查申请数量
# Memo...........:
# Usage..........: CALL asft310_chk_sfdc007(p_cmd)
#                  RETURNING r_success
# Input parameter: p_cmd       a:新增  u:修改
# Return code....: r_success   检查状态TRUE/FALSE
# Date & Author..: 2013/12/19 By zhangllc
# Modify.........: 150309 增加欠料补料的检查，逻辑需与自动产生同步，以防自动产生的资料还过不去
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_chk_sfdc007(p_cmd)
DEFINE p_cmd            LIKE type_t.chr1
DEFINE r_success        LIKE type_t.num5
DEFINE l_sfba017        LIKE sfba_t.sfba017   #下阶料报废数量
DEFINE l_sfba025        LIKE sfba_t.sfba025   #超领数量
DEFINE l_sfdc007        LIKE sfdc_t.sfdc007 
DEFINE l_sfdc007_1      LIKE sfdc_t.sfdc007   #其他单据发料未过账申请数
DEFINE l_sfdc007_2      LIKE sfdc_t.sfdc007   #其他单据退料未过账申请数
DEFINE l_sfdc008_1      LIKE sfdc_t.sfdc008 
DEFINE l_sfdc008_2      LIKE sfdc_t.sfdc008 
#161109-00085#29-s
#DEFINE l_sfba            RECORD LIKE sfba_t.*
DEFINE l_sfba RECORD  #工單備料單身檔
       sfbadocno LIKE sfba_t.sfbadocno, #單號
       sfbaseq LIKE sfba_t.sfbaseq, #項次
       sfbaseq1 LIKE sfba_t.sfbaseq1, #項序
       sfba002 LIKE sfba_t.sfba002, #部位
       sfba003 LIKE sfba_t.sfba003, #作業編號
       sfba004 LIKE sfba_t.sfba004, #作業序
       sfba008 LIKE sfba_t.sfba008, #必要特性
       sfba013 LIKE sfba_t.sfba013, #應發數量
       sfba014 LIKE sfba_t.sfba014, #單位
       sfba015 LIKE sfba_t.sfba015, #委外代買數量
       sfba016 LIKE sfba_t.sfba016, #已發數量
       sfba017 LIKE sfba_t.sfba017, #報廢數量
       sfba022 LIKE sfba_t.sfba022, #替代率
       sfba025 LIKE sfba_t.sfba025  #超領數量
END RECORD
#DEFINE l_sfba_0          RECORD LIKE sfba_t.*
DEFINE l_sfba_0 RECORD  #工單備料單身檔
       sfba010 LIKE sfba_t.sfba010, #標準QPA分子
       sfba011 LIKE sfba_t.sfba011  #標準QPA分母
END RECORD
#161109-00085#29-e
DEFINE l_sfba016        LIKE sfba_t.sfba016    #已发数量
DEFINE l_sfaa049         LIKE sfaa_t.sfaa049   #已发套数 add 150309
DEFINE l_sfaa012         LIKE sfaa_t.sfaa012   #生产数量 add 150309
DEFINE l_sets            LIKE sfaa_t.sfaa049   #add 150309
DEFINE l_sfba022         LIKE sfba_t.sfba022   #旧值的  替代率
DEFINE issue_qty         LIKE sfba_t.sfba013   #可发量
DEFINE l_sfdb006         LIKE sfdb_t.sfdb006   #套数
DEFINE l_success         LIKE type_t.num5

   LET r_success = TRUE

   #161109-00085#29-s
   #SELECT * INTO l_sfba.*
   SELECT sfbadocno,sfbaseq,sfbaseq1,sfba002,sfba003,sfba004,sfba008,sfba013,sfba014,sfba015,
          sfba016,sfba017,sfba022,sfba025
     INTO l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,l_sfba.sfba002,l_sfba.sfba003,
          l_sfba.sfba004,l_sfba.sfba008,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
          l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba022,l_sfba.sfba025
   #161109-00085#29-e   
     FROM sfba_t
    WHERE sfbaent = g_enterprise
      AND sfbasite= g_site
      AND sfbadocno=g_sfdc_d[l_ac].sfdc001
      AND sfbaseq = g_sfdc_d[l_ac].sfdc002
      AND sfbaseq1= g_sfdc_d[l_ac].sfdc003
   #间接材料,发料时可直接超领，过账时分配，所以不需要控管是否超过工单的未发数量
   #IF l_sfba.sfba008 = '3' THEN  #必要特性
   IF l_sfba.sfba008 = '3' AND g_sfda_m.sfda002 = '12' THEN #mod 150309
      RETURN r_success
   END IF
   
   CASE 
      WHEN g_sfda_m.sfda002 = '11' OR g_sfda_m.sfda002 = '13'   #发料类型
           #不可超過工單的未發數量
           
           #本发料单据其他项次的
           CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007
           
           #其他单据发料未过账申请数
           SELECT SUM(sfdc007) INTO l_sfdc007_1
             FROM sfdc_t,sfda_t
            WHERE sfdcent   = sfdaent
              AND sfdcdocno = sfdadocno
              AND sfdcent   = g_enterprise
              AND sfdcdocno!=g_sfda_m.sfdadocno
              AND sfdc001   = g_sfdc_d[l_ac].sfdc001  #工单
              AND sfdc002   = g_sfdc_d[l_ac].sfdc002  #工单项次
              AND sfdc003   = g_sfdc_d[l_ac].sfdc003  #工单项序
              AND sfda002 IN ('11','13','14') #发料
              AND sfdastus != 'S' AND sfdastus != 'X'
           IF cl_null(l_sfdc007_1) THEN LET l_sfdc007_1 = 0 END IF

           ##其他单据退料未过账申请数
           #SELECT SUM(sfdc007) INTO l_sfdc007_2
           #  FROM sfdc_t,sfda_t
           # WHERE sfdcent   = sfdaent
           #   AND sfdcdocno = sfdadocno
           #   AND sfdcent   = g_enterprise
           #   AND sfdcdocno!=g_sfda_m.sfdadocno
           #   AND sfdc001   = g_sfdc_d[l_ac].sfdc001  #工单
           #   AND sfdc002   = g_sfdc_d[l_ac].sfdc002  #工单项次
           #   AND sfdc003   = g_sfdc_d[l_ac].sfdc003  #工单项序
           #   AND sfda002 IN ('21','23','24') #退料
           #   AND sfdastus != 'S' AND sfdastus != 'X'
           #IF cl_null(l_sfdc007_2) THEN LET l_sfdc007_2 = 0 END IF
           #mark 退料不算，一退料未过账不应算，二若退料删除，这边就多了
 
           #可发数量
           LET l_sfdc007 = l_sfba.sfba013 - l_sfba.sfba015 - l_sfba.sfba016 - l_sfdc007 - l_sfdc007_1 #+ l_sfdc007_2
           IF g_sfdc_d[l_ac].sfdc007  > l_sfdc007 THEN
              #不可超过工单的未发数量1%,请重新输入！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00047'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              LET g_errparam.replace[1] = l_sfdc007
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
           
           #150309 add 同自动产生的逻辑
           #替代料,抓出原件资料
           #161109-00085#29-s
           #SELECT * INTO l_sfba_0.* FROM sfba_t
           SELECT sfba010,sfba011 INTO l_sfba_0.sfba010,l_sfba_0.sfba011
             FROM sfba_t
           #161109-00085#29-e
            WHERE sfbaent = g_enterprise
              AND sfbasite= g_site
              AND sfbadocno=g_sfdc_d[l_ac].sfdc001
              AND sfbaseq = g_sfdc_d[l_ac].sfdc002
              AND sfbaseq1= 0
           IF SQLCA.sqlcode THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = SQLCA.sqlcode
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
           #计算套数
           CALL s_asft310_get_sfdb006_2(g_sfda_m.sfdadocno,l_sfba.sfbadocno,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004)
              RETURNING l_success,l_sfdb006
           IF NOT l_success THEN
              LET r_success = FALSE
              RETURN r_success
           END IF
           #已发套数，生产数量
           SELECT sfaa049,sfaa012 INTO l_sfaa049,l_sfaa012
             FROM sfaa_t
            WHERE sfaaent  = g_enterprise
              AND sfaadocno= g_sfdc_d[l_ac].sfdc001
           IF SQLCA.sqlcode THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = SQLCA.sqlcode
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
           #欠料补料只可发不足套的量issue_qty
           IF g_sfda_m.sfda002 = '13' OR (g_sfda_m.sfda002 = '11' AND l_sfdb006 = 0) THEN
              #工单单身某笔总共应发=应发-扣除委外代買量
              LET l_sfba.sfba013=l_sfba.sfba013-l_sfba.sfba015
              #欠料补料把已发套数中不足的部分补发出去
              IF l_sfaa049 = l_sfaa012 THEN  #已發套數=生產數量,即要把剩余 
                 #计算发料单上已产生的发料数量
                 CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007
           
                 #计算剩下的应发量=應發總數量-已發數量-本发料单上已产生的发料量
                 LET issue_qty = l_sfba.sfba013 - l_sfba.sfba016 - l_sfdc007
              ELSE
                 #LET issue_qty = l_sfaa049 * l_sfba.sfba010 / l_sfba.sfba011 - l_sfba.sfba016
                 #考虑可能有取替代料的情况
                 #计算备料+本单据上所有已发量(包含元件+所有替代料的已发量),折算成元件的已发量
                 CALL s_asft310_get_sfba016('2',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) RETURNING l_sfba016
                 IF p_cmd='u' AND g_sfdc_d[l_ac].sfdc001=g_sfdc_d_t.sfdc001 AND g_sfdc_d[l_ac].sfdc002=g_sfdc_d_t.sfdc002 THEN
                    IF g_sfdc_d_t.sfdc003 = 0 THEN  #项序
                       LET l_sfba016 = l_sfba016 - g_sfdc_d_t.sfdc007
                    ELSE
                       SELECT sfba022 INTO l_sfba022 FROM sfba_t
                        WHERE sfbaent   = g_enterprise
                          AND sfbasite  = g_site
                          AND sfbadocno = g_sfdc_d_t.sfdc001
                          AND sfbaseq   = g_sfdc_d_t.sfdc002
                          AND sfbaseq1  = g_sfdc_d_t.sfdc003
                       LET l_sfba016 = l_sfba016 - g_sfdc_d_t.sfdc007/l_sfba022
                    END IF
                 END IF
                 #根据已发量计算该料已发套数
                 LET l_sets = l_sfba016 * l_sfba_0.sfba011 / l_sfba_0.sfba010
                 
                 IF l_sfba.sfbaseq1 = 0 THEN  #非替代料 不足套数*QPA分子/QPA分母
                    LET issue_qty = (l_sfaa049 - l_sets) * l_sfba_0.sfba010 / l_sfba_0.sfba011
                 ELSE  #替代料  不足套数*(QPA分子/QPA分母)*替代率=元件应发量*替代率=替代料的应发量
                    LET issue_qty = ((l_sfaa049 - l_sets) * l_sfba_0.sfba010 / l_sfba_0.sfba011)*l_sfba.sfba022
                 END IF
              END IF  
              
              IF issue_qty < 0 THEN
                 LET issue_qty = 0
              END IF
                 
              #单位取位
              CALL s_aooi250_get_msg(l_sfba.sfba014) RETURNING l_success,g_ooca002,g_ooca004
              IF l_success THEN
                 CALL s_num_round('4',issue_qty,g_ooca002) RETURNING issue_qty  #151118-00016 by whitney modify g_ooca004-->'4'
              END IF
              
              #发料时的應發量 > 应发 - 已发
              IF issue_qty>(l_sfba.sfba013-l_sfba.sfba016) THEN
                 LET issue_qty=(l_sfba.sfba013-l_sfba.sfba016)
              END IF
              
              IF g_sfdc_d[l_ac].sfdc007  > issue_qty THEN
                 #不可超过欠料量%1
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00676'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 LET g_errparam.replace[1] = issue_qty
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF  #欠料补料
           
           #成套只可发 套数的量issue_qty
           LET g_para = cl_get_para(g_enterprise,g_site,'S-MFG-0055') #发料控管套数否
           IF g_sfda_m.sfda002 = '11' AND l_sfdb006 > 0 AND g_para = 'Y' THEN #成套发&发料控管套数否='Y'
              #工单单身某笔总共应发=应发-扣除委外代買量
              LET l_sfba.sfba013=l_sfba.sfba013-l_sfba.sfba015
              IF l_sfdb006 = l_sfaa012 - l_sfaa049 THEN  #預計發料套數=生產數量-已發套數,即要把剩余 
                 #计算发料单上已产生的发料数量
                 CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007
                 #计算剩下的应发量=應發總數量-已發數量-本发料单上已产生的发料量
                 LET issue_qty = l_sfba.sfba013 - l_sfba.sfba016 - l_sfdc007
              ELSE
                 #LET issue_qty = l_sfaa049 * l_sfba.sfba010 / l_sfba.sfba011 - l_sfba.sfba016
                 #考虑可能有取替代料的情况
                 #计算本单据上已发量(包含元件+所有替代料的已发量)(不包括备料档),折算成元件的已发量
                 CALL s_asft310_get_sfba016('1',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) RETURNING l_sfba016
                 #减去当笔修改掉的量
                 IF p_cmd='u' AND g_sfdc_d[l_ac].sfdc001=g_sfdc_d_t.sfdc001 AND g_sfdc_d[l_ac].sfdc002=g_sfdc_d_t.sfdc002 THEN
                    IF g_sfdc_d_t.sfdc003 = 0 THEN  #项序
                       LET l_sfba016 = l_sfba016 - g_sfdc_d_t.sfdc007
                    ELSE
                       SELECT sfba022 INTO l_sfba022 FROM sfba_t
                        WHERE sfbaent   = g_enterprise
                          AND sfbasite  = g_site
                          AND sfbadocno = g_sfdc_d_t.sfdc001
                          AND sfbaseq   = g_sfdc_d_t.sfdc002
                          AND sfbaseq1  = g_sfdc_d_t.sfdc003
                       LET l_sfba016 = l_sfba016 - g_sfdc_d_t.sfdc007/l_sfba022
                    END IF
                 END IF
                 #根据已发量计算该料已发套数
                 LET l_sets = l_sfba016 * l_sfba_0.sfba011 / l_sfba_0.sfba010
                 
                 IF l_sfba.sfbaseq1 = 0 THEN  #非替代料 不足套数*QPA分子/QPA分母
                    LET issue_qty = (l_sfdb006 - l_sets) * l_sfba_0.sfba010 / l_sfba_0.sfba011
                 ELSE  #替代料  不足套数*(QPA分子/QPA分母)*替代率=元件应发量*替代率=替代料的应发量
                    LET issue_qty = ((l_sfdb006 - l_sets) * l_sfba_0.sfba010 / l_sfba_0.sfba011)*l_sfba.sfba022
                 END IF
              END IF
              
              IF issue_qty < 0 THEN
                 LET issue_qty = 0
              END IF
                 
              #单位取位
              CALL s_aooi250_get_msg(l_sfba.sfba014) RETURNING l_success,g_ooca002,g_ooca004
              IF l_success THEN
                 CALL s_num_round('4',issue_qty,g_ooca002) RETURNING issue_qty  #151118-00016 by whitney modify g_ooca004-->'4'
              END IF
              
              #发料时的應發量 > 应发 - 已发
              IF issue_qty>(l_sfba.sfba013-l_sfba.sfba016) THEN
                 LET issue_qty=(l_sfba.sfba013-l_sfba.sfba016)
              END IF
              
              IF g_sfdc_d[l_ac].sfdc007  > issue_qty THEN
                 #不可超过欠料量%1
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00676'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 LET g_errparam.replace[1] = issue_qty
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF #成套发
           #150309 add end
      WHEN g_sfda_m.sfda002 = '12'  #发料类型=超领
           #依發料單別參數"超領數量與下階料報廢數量勾稽"，
           #當此參數=Y時，申請數量需判斷數量不可超過(下階料報廢數量-已存在超領數量+超領退料數量)
           CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
           IF cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0056') = 'Y' THEN
              IF cl_null(l_sfba.sfba017) THEN LET l_sfba.sfba017=0 END IF #下阶报废数量
              IF cl_null(l_sfba.sfba025) THEN LET l_sfba.sfba025=0 END IF #超领数量
              
              #本发料单据其他项次的
              CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007

              #其他单据发料未过账申请数
              SELECT SUM(sfdc007) INTO l_sfdc007_1
                FROM sfdc_t,sfda_t
               WHERE sfdcent   = sfdaent
                 AND sfdcdocno = sfdadocno
                 AND sfdcent   = g_enterprise
                 AND sfdcdocno!=g_sfda_m.sfdadocno
                 AND sfdc001   = g_sfdc_d[l_ac].sfdc001  #工单
                 AND sfdc002   = g_sfdc_d[l_ac].sfdc002  #工单项次
                 AND sfdc003   = g_sfdc_d[l_ac].sfdc003  #工单项序
                 AND sfda002 = '12'  #发料
                 AND sfdastus != 'S' AND sfdastus != 'X'
              IF cl_null(l_sfdc007_1) THEN LET l_sfdc007_1 = 0 END IF

              ##其他单据退料未过账申请数
              #SELECT SUM(sfdc007) INTO l_sfdc007_2
              #  FROM sfdc_t,sfda_t
              # WHERE sfdcent   = sfdaent
              #   AND sfdcdocno = sfdadocno
              #   AND sfdcent   = g_enterprise
              #   AND sfdcdocno!=g_sfda_m.sfdadocno
              #   AND sfdc001   = g_sfdc_d[l_ac].sfdc001  #工单
              #   AND sfdc002   = g_sfdc_d[l_ac].sfdc002  #工单项次
              #   AND sfdc003   = g_sfdc_d[l_ac].sfdc003  #工单项序
              #   AND sfda002 = '22'  #退料
              #   AND sfdastus != 'S' AND sfdastus != 'X'
              #IF cl_null(l_sfdc007_2) THEN LET l_sfdc007_2 = 0 END IF

              #可发料的量
              #LET l_sfdc007 = l_sfba.sfba017-l_sfba.sfba025-l_sfdc007-l_sfdc007_1+l_sfdc007_2  #相当于=下階料報廢數量-已存在超領數量+超領退料數量
              #mark 退料不算，一退料未过账不应算，二若退料删除，这边就多了
              LET l_sfdc007 = l_sfba.sfba017-l_sfba.sfba025-l_sfdc007-l_sfdc007_1  #相当于=下階料報廢數量-已存在超領數量
              IF g_sfdc_d[l_ac].sfdc007  > l_sfdc007 THEN  
                 #不可超过工单的下阶料报废数量1%；请重新输入！
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00138'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 LET g_errparam.replace[1] = l_sfdc007
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
      WHEN g_sfda_m.sfda002 = '21' OR g_sfda_m.sfda002 = '23' OR g_sfda_m.sfda002 = '24'   #发料类型
           #不可超過工單的已發數量l_sfba.sfba016
           
           #本发料单据其他项次的
           CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007
           
           #可退数量
           LET l_sfdc007 = l_sfba.sfba016 - l_sfdc007
           IF g_sfdc_d[l_ac].sfdc007  > l_sfdc007 THEN  
              #不可超过工单的已發数量1%,请重新输入！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00065'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              LET g_errparam.replace[1] = l_sfdc007
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN g_sfda_m.sfda002 = '22'  #发料类型=超领
           #不可超過工單的超領數量l_sfba.sfba025
           IF cl_null(l_sfba.sfba025) THEN LET l_sfba.sfba025=0 END IF
           #本发料单据其他项次的
           CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007

           #可超退数量
           LET l_sfdc007 = l_sfba.sfba025 - l_sfdc007
           IF g_sfdc_d[l_ac].sfdc007  > l_sfdc007 THEN  
              #不可超过工单的超领数量1%,请重新输入！
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00066'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              LET g_errparam.replace[1] = l_sfdc007
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
   END CASE
   
   RETURN r_success
END FUNCTION
#预设sfdc007申请数量
#即最大可发料数量
#sfdc编辑状态时调用
PRIVATE FUNCTION asft310_def_sfdc007(p_cmd)
DEFINE p_cmd         LIKE type_t.chr1
DEFINE r_sfdc007     LIKE sfdc_t.sfdc007   #最大可发料数量
DEFINE l_sfaa012     LIKE sfaa_t.sfaa012   #生产数量
DEFINE l_sfaa049     LIKE sfaa_t.sfaa049   #已发套数
DEFINE l_sfdb006     LIKE sfdb_t.sfdb006   #工单+部位+作业+作业序 预计发料套数
DEFINE l_sfdc007     LIKE sfdc_t.sfdc007   #本发料单据其他项次的发料数量
DEFINE l_sfba010     LIKE sfba_t.sfba010   #标准QPA分子
DEFINE l_sfba011     LIKE sfba_t.sfba011   #标准QPA分母
DEFINE l_sfba002     LIKE sfba_t.sfba002   #部位
DEFINE l_sfba003     LIKE sfba_t.sfba003   #作业
DEFINE l_sfba004     LIKE sfba_t.sfba004   #作业序
DEFINE l_sfba016     LIKE sfba_t.sfba016   #已发数量
DEFINE l_success     LIKE type_t.num5

   LET r_sfdc007 = 0
   
   IF g_sfda_m.sfda002 ='11' OR g_sfda_m.sfda002 ='13' THEN
      #生产数量、已发套数、标准QPA分子、标准QPA分母
      #部位、作业、作业序、已发数量
      SELECT sfaa012,sfaa049,sfba010,sfba011,sfba002,sfba003,sfba004,sfba016
        INTO l_sfaa012,l_sfaa049,l_sfba010,l_sfba011,
             l_sfba002,l_sfba003,l_sfba004,l_sfba016
        FROM sfba_t,sfaa_t
       WHERE sfbaent = sfaaent
         AND sfbasite= sfaasite
         AND sfbadocno=sfaadocno
         AND sfbaent = g_enterprise
         AND sfbasite= g_site
         AND sfbadocno=g_sfdc_d[l_ac].sfdc001
         AND sfbaseq = g_sfdc_d[l_ac].sfdc002
         AND sfbaseq1= g_sfdc_d[l_ac].sfdc003
      IF cl_null(l_sfaa012) THEN LET l_sfaa012 = 0 END IF
      IF cl_null(l_sfaa049) THEN LET l_sfaa049 = 0 END IF

      #本发料单据其他项次的
      CALL asft310_get_sfdc007(p_cmd) RETURNING l_sfdc007
      
      IF g_sfda_m.sfda002 ='11' THEN
         #預計發料套數
         SELECT SUM(sfdb006) INTO l_sfdb006 FROM sfdb_t
          WHERE sfdbent  = g_enterprise
            AND sfdbsite = g_site
            AND sfdbdocno= g_sfda_m.sfdadocno       #发料单单号
            AND sfdb001  = g_sfdc_d[l_ac].sfdc001  #工单单号
            AND sfdb003  = l_sfba002  #部位
            AND sfdb004  = l_sfba003  #作业
            AND sfdb005  = l_sfba004  #作业序
            #AND sfdb002  = #run card 
         IF cl_null(l_sfdb006) THEN LET l_sfdb006=0 END IF
      END IF
   END IF
   
   CASE
      WHEN g_sfda_m.sfda002 ='11'   #成套发料
           IF l_sfdb006 = l_sfaa012 - l_sfaa049 THEN  #預計發料套數=生產數量-已發套數,即要把剩余
              #應發總數量-已發數量-本发料单据其他项次的发料数量
              LET r_sfdc007 = g_sfdc_d[l_ac].sfba013 - g_sfdc_d[l_ac].sfba016 - l_sfdc007
           ELSE
              #預計發料套數*標準QPA分子/標準QPA分母-本发料单据其他项次的发料数量
              LET r_sfdc007 = l_sfdb006 * l_sfba010 / l_sfba011 - l_sfdc007
           END IF
      WHEN g_sfda_m.sfda002 ='13'   #欠料补料
           IF l_sfaa012 = l_sfaa049 THEN   #生產數量=已發套數
              #應發總數量-已發數量-本发料单据其他项次的发料数量
              LET r_sfdc007 = g_sfdc_d[l_ac].sfba013 - g_sfdc_d[l_ac].sfba016 - l_sfdc007
           ELSE
              #(已發料套數*標準QPA分子/標準QPA分母)-已發數量-本发料单据其他项次的发料数量
              LET r_sfdc007 = l_sfaa049 * l_sfba010 / l_sfba011 - g_sfdc_d[l_ac].sfba016 - l_sfdc007
           END IF
      WHEN g_sfda_m.sfda002 = '21'  #成套退
           IF l_sfdb006 = l_sfaa049 THEN  #預計退料套數=已發套數  全退
              #已發數量-本发料单据其他项次的发料数量  
              LET r_sfdc007 = l_sfba016 - l_sfdc007
           ELSE
              #預計退料套數*標準QPA分子/標準QPA分母-本发料单据其他项次的发料数量
              LET r_sfdc007 = l_sfdb006 * l_sfba010 / l_sfba011 - l_sfdc007
              #不可超过工单的已发数量
              IF r_sfdc007 > l_sfba016 - l_sfdc007 THEN
                 LET r_sfdc007 = l_sfba016 - l_sfdc007
              END IF
           END IF
      OTHERWISE
           LET r_sfdc007 = 0
   END CASE
   IF r_sfdc007 < 0 THEN
      LET r_sfdc007 = 0
   END IF
   
   #add 150115 单位取位
   IF NOT cl_null(g_sfdc_d[l_ac].sfdc006) THEN
      CALL s_aooi250_get_msg(g_sfdc_d[l_ac].sfdc006) RETURNING l_success,g_ooca002,g_ooca004
      IF l_success THEN
         CALL s_num_round('4',r_sfdc007,g_ooca002) RETURNING r_sfdc007  #151118-00016 by whitney modify g_ooca004-->'4'
      END IF
   END IF
   #add 150115 end
   RETURN r_sfdc007
END FUNCTION

PRIVATE FUNCTION asft310_set_entry_b_sfdc(p_cmd)
DEFINE p_cmd   LIKE type_t.chr1

   CALL cl_set_comp_entry("sfdc016",TRUE)  #库存管理特征
   CALL cl_set_comp_entry("sfdc009,sfdc010",TRUE)  #参考单位申请数量
   CALL cl_set_comp_entry("sfdc012,sfdc013,sfdc014,sfdc016",TRUE)  #库位 储位 批号 库存管理特征
   LET g_sfdc012_switch = 'Y'   #庫位        可输入性 Y可输入 N不可输入
   LET g_sfdc013_switch = 'Y'   #儲位        可输入性 Y可输入 N不可输入
   LET g_sfdc014_switch = 'Y'   #批號        可输入性 Y可输入 N不可输入
   LET g_sfdc016_switch = 'Y'   #庫存管理特徵 可输入性 Y可输入 N不可输入
   
   CALL cl_set_comp_entry("sfdc005",TRUE)  #产品特征
   CALL cl_set_comp_entry("sfdc004",TRUE)  #需求料号
   CALL cl_set_comp_entry("sfdc003",TRUE)  #项序
   
   #發料料號有使用參考單位時sfdc009,sfdc010不允許空白
   CALL cl_set_comp_required("sfdc009,sfdc010",FALSE)
   #料件做产品特征管理时，产品特征栏位不允许空白
   CALL cl_set_comp_required("sfdc005",FALSE)  #add 141204 sfdc不控制，在sfdd中严格控制
   #料件设置为必须有库存管理特征时，库存管理特征不允许空白
   CALL cl_set_comp_required("sfdc016",FALSE)
   #料件設置有做批號管理時，批號不允許空白
   CALL cl_set_comp_required("sfdc014",FALSE)  #160519-00022#18 add
END FUNCTION

PRIVATE FUNCTION asft310_set_no_entry_b_sfdc(p_cmd)
DEFINE p_cmd      LIKE type_t.chr1
DEFINE l_imaf055  LIKE imaf_t.imaf055  #库存管理特征
DEFINE l_imaf061  LIKE imaf_t.imaf061  #批號管理    #160519-00022#18 add
DEFINE l_imaf015  LIKE imaf_t.imaf015  #参考单位
DEFINE l_imaa005  LIKE imaa_t.imaa005  #特征类别
DEFINE l_success  LIKE type_t.num5
DEFINE l_sfba019  LIKE sfba_t.sfba019  #指定库位
DEFINE l_sfba020  LIKE sfba_t.sfba020  #指定储位
DEFINE l_sfba029  LIKE sfba_t.sfba029  #指定批号
DEFINE l_sfba030  LIKE sfba_t.sfba030  #指定库存管理特征
DEFINE l_sfba021  LIKE sfba_t.sfba021  #产品特征
DEFINE l_cnt      LIKE type_t.num5

   #料件有使用庫存管理特徵时才可輸入库存管理特征栏位sfdc016
   IF NOT cl_null(g_sfdc_d[l_ac].sfdc004) THEN
      SELECT imaf055,imaf015,imaf061        #160519-00022#18 add imaf061
        INTO l_imaf055,l_imaf015,l_imaf061  #库存管理特征,参考单位 #160519-00022#18 add imaf061
        FROM imaf_t
       WHERE imafent  = g_enterprise
         AND imafsite = g_site
         AND imaf001  = g_sfdc_d[l_ac].sfdc004
      IF l_imaf055 = '2' THEN
         CALL cl_set_comp_required("sfdc016",FALSE)   #160519-00008#18
         CALL cl_set_comp_entry("sfdc016",FALSE)
         LET g_sfdc016_switch = 'N'   #可输入性 Y可输入 N不可输入
      END IF
      #料件设置为必须有库存管理特征时，库存管理特征不允许空白
      IF l_imaf055 = '1' THEN  #必须有库存管理特征
         CALL cl_set_comp_required("sfdc016",TRUE)
      #160519-00008#18--(S)
      ELSE
         CALL cl_set_comp_required("sfdc016",FALSE)
      #160519-00008#18--(E)      
      END IF
      
      #當料號有使用參考單位時，才允許輸入
      CALL cl_set_comp_entry("sfdc009",FALSE)  #参考单位 单据上统一不允许修改
      IF g_ref_unit = 'N' THEN
         CALL cl_set_comp_entry("sfdc010",FALSE)  #参考单位申请数量
      ELSE
         IF cl_null(l_imaf015) THEN
            CALL cl_set_comp_entry("sfdc010",FALSE)  #参考单位申请数量
         ELSE
            #發料料號有使用參考單位時sfdc009,sfdc010不允許空白
            CALL cl_set_comp_required("sfdc009,sfdc010",TRUE)
         END IF
      END IF
     #160519-00022#18-s-add      
      CASE l_imaf061
         WHEN '1'  #必須有批號
            CALL cl_set_comp_required("sfdc014",TRUE)
         WHEN '2'  #不可有批號
            CALL cl_set_comp_entry("sfdc014",FALSE)
      END CASE        
     #160519-00022#18-e-add
   END IF

   #发料单需要卡控工单有指定的，不可修改 add 150116 g_prog[1,6]='asft31'
   #工单、项次、项序不为空
   IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdc_d[l_ac].sfdc001) AND NOT cl_null(g_sfdc_d[l_ac].sfdc002) AND NOT cl_null(g_sfdc_d[l_ac].sfdc003) AND g_prog[1,6]='asft31' THEN
      #工單指定發料庫儲，發料時允許修改
      CALL s_aooi200_get_slip(g_sfdc_d[l_ac].sfdc001) RETURNING l_success,g_ooba002
      IF cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0050') = 'N' THEN
         SELECT sfba019,sfba020,sfba029,sfba030
           INTO l_sfba019,l_sfba020,l_sfba029,l_sfba030
           FROM sfba_t
          WHERE sfbaent  = g_enterprise
            AND sfbadocno= g_sfdc_d[l_ac].sfdc001
            AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
            AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
         IF NOT cl_null(l_sfba019) THEN
            CALL cl_set_comp_entry("sfdc012",FALSE)  #库位
            LET g_sfdc012_switch = 'N'   #可输入性 Y可输入 N不可输入
         END IF
         IF NOT cl_null(l_sfba020) THEN
            CALL cl_set_comp_entry("sfdc013",FALSE)  #储位
            LET g_sfdc013_switch = 'N'   #可输入性 Y可输入 N不可输入
         END IF
         IF NOT cl_null(l_sfba029) THEN
            CALL cl_set_comp_entry("sfdc014",FALSE)  #批号
            LET g_sfdc014_switch = 'N'   #可输入性 Y可输入 N不可输入
         END IF
         IF NOT cl_null(l_sfba030) THEN
            CALL cl_set_comp_entry("sfdc016",FALSE)  #库存管理特征
            LET g_sfdc016_switch = 'N'   #可输入性 Y可输入 N不可输入
         END IF
      END IF
   END IF

   #产品特征控制
   IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) AND NOT cl_null(g_sfdc_d[l_ac].sfdc002) AND NOT cl_null(g_sfdc_d[l_ac].sfdc003) THEN
      SELECT sfba021 INTO l_sfba021
        FROM sfba_t
       WHERE sfbaent  = g_enterprise
         AND sfbadocno= g_sfdc_d[l_ac].sfdc001
         AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
         AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
      #工单有指定产品特征，不可修改
      IF NOT cl_null(l_sfba021) THEN
         CALL cl_set_comp_entry("sfdc005",FALSE)  #产品特征
      END IF
   END IF
   IF NOT cl_null(g_sfdc_d[l_ac].sfdc004) THEN
      SELECT imaa005 INTO l_imaa005  #特征类别
        FROM imaa_t
       WHERE imaaent  = g_enterprise
         AND imaa001  = g_sfdc_d[l_ac].sfdc004
      IF cl_null(l_imaa005) THEN
         CALL cl_set_comp_entry("sfdc005",FALSE)  #产品特征
      ELSE
         #料件做产品特征管理时，不允许空白
         CALL cl_set_comp_required("sfdc005",TRUE)  #add 141204 sfdc不控制，在sfdd中严格控制
      END IF
   END IF
   
   #需求料号控制
   #可超領工單未指定間接材料
   CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
   CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
   IF g_sfda_m.sfda002!='12' OR (g_sfda_m.sfda002='12' AND g_para='N') THEN
      CALL cl_set_comp_entry("sfdc004",FALSE)  #需求料号
   ELSE
      IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) AND NOT cl_null(g_sfdc_d[l_ac].sfdc002) AND NOT cl_null(g_sfdc_d[l_ac].sfdc003) THEN
         SELECT COUNT(1) INTO l_cnt
           FROM sfba_t
          WHERE sfbaent  = g_enterprise
            AND sfbadocno= g_sfdc_d[l_ac].sfdc001
            AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
            AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
         #存在备料档中的，不可修改
         IF l_cnt > 0 THEN
            CALL cl_set_comp_entry("sfdc004",FALSE)  #需求料号
         END IF
      ELSE
         #CALL cl_set_comp_entry("sfdc004",FALSE)  #需求料号       #161207-00067#1 mark
      END IF
   END IF
   
   #项序控制
   #可超領工單未指定間接材料
   CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
   CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
   IF g_sfda_m.sfda002='12' AND g_para='Y' THEN
      IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) AND NOT cl_null(g_sfdc_d[l_ac].sfdc002) AND NOT cl_null(g_sfdc_d[l_ac].sfdc003) THEN
         SELECT COUNT(1) INTO l_cnt
           FROM sfba_t
          WHERE sfbaent  = g_enterprise
            AND sfbadocno= g_sfdc_d[l_ac].sfdc001
            AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
         #存在备料档中的，不可修改
         IF l_cnt = 0 THEN
            CALL cl_set_comp_entry("sfdc003",FALSE)  #需求料号
         END IF
      END IF
   END IF
   
   #160731-00253#1-s
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
   END IF
   #160731-00253#1-e
   
END FUNCTION

PRIVATE FUNCTION asft310_set_entry_b_sfdb(p_cmd)
DEFINE p_cmd   LIKE type_t.chr1

   CALL cl_set_comp_entry("sfdb005",TRUE)
   CALL cl_set_comp_entry("sfdb006",TRUE) #预计套数
END FUNCTION

PRIVATE FUNCTION asft310_set_no_entry_b_sfdb(p_cmd)
DEFINE p_cmd   LIKE type_t.chr1

   #sfdb005 作业序：有输入作业时才可以输入
   IF cl_null(g_sfdb_d[l_ac].sfdb004) THEN
      CALL cl_set_comp_entry("sfdb005",FALSE)
   END IF
   
   #13 欠料补料     23 一般退料   24 倒扣退料
   IF g_sfda_m.sfda002 = '13' OR g_sfda_m.sfda002 = '23' OR g_sfda_m.sfda002 = '24' THEN
      CALL cl_set_comp_entry("sfdb006",FALSE) #预计套数
   END IF
   
   #160731-00253#1-s
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
   END IF
   #160731-00253#1-e
   
END FUNCTION

PRIVATE FUNCTION asft310_set_entry_b_sfdf(p_cmd)
DEFINE p_cmd   LIKE type_t.chr1

   CALL cl_set_comp_entry("sfdf003,sfdf004,sfdf005,sfdf010",TRUE) #仓储批 库存管理特征
   LET g_sfdf003_switch = 'Y'   #庫位        可输入性 Y可输入 N不可输入
   LET g_sfdf004_switch = 'Y'   #儲位        可输入性 Y可输入 N不可输入
   LET g_sfdf005_switch = 'Y'   #批號        可输入性 Y可输入 N不可输入
   LET g_sfdf010_switch = 'Y'   #庫存管理特徵 可输入性 Y可输入 N不可输入
   
   CALL cl_set_comp_entry("sfdf008,sfdf009",TRUE) #参考单位
   
   
   
END FUNCTION

PRIVATE FUNCTION asft310_set_no_entry_b_sfdf(p_cmd)
DEFINE p_cmd      LIKE type_t.chr1
DEFINE l_imaf015  LIKE imaf_t.imaf015
DEFINE l_cnt      LIKE type_t.num5
DEFINE l_cnt1     LIKE type_t.num5
DEFINE l_sql      STRING

   #检查sfdf对应的sfde中包含的sfdc里是否只有一个相同的指定"库位"，此时库位栏位不允许输入只能默认
   IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
      LET l_sql = " SELECT COUNT(UNIQUE sfdc012) ",
                  "   FROM sfdc_t ",
                  "  WHERE sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  #"    AND sfdc009   = '",g_sfde_d[g_detail_idx].sfde006,"' "    #参考单位  
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
      END IF
   ELSE
      LET l_sql = " SELECT COUNT(UNIQUE sfdc012) ",
                  "   FROM sfdc_t,sfba_t ",
                  "  WHERE sfdcent   = sfbaent ",
                  "    AND sfdc001   = sfbadocno ",
                  "    AND sfdc002   = sfbaseq ",
                  "    AND sfdc003   = sfbaseq1 ",
                  "    AND sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  #"    AND sfdc009   = '",g_sfde_d[g_detail_idx].sfde006,"' "    #参考单位  
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
      END IF
   END IF
   IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
      LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
   ELSE
      LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
   END IF
   DECLARE asft310_set_no_entry_b_sfdf_c1 SCROLL CURSOR FROM l_sql
   OPEN asft310_set_no_entry_b_sfdf_c1
   FETCH asft310_set_no_entry_b_sfdf_c1 INTO l_cnt
   CLOSE asft310_set_no_entry_b_sfdf_c1
   IF l_cnt = 1 THEN
      #add 141211
      IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
         LET l_sql = " SELECT COUNT(UNIQUE sfdc012) ",
                     "   FROM sfdc_t ",
                     "  WHERE sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc012   = ' '  "  #库位
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
         END IF
      ELSE
         LET l_sql = " SELECT COUNT(UNIQUE sfdc012) ",
                     "   FROM sfdc_t,sfba_t ",
                     "  WHERE sfdcent   = sfbaent ",
                     "    AND sfdc001   = sfbadocno ",
                     "    AND sfdc002   = sfbaseq ",
                     "    AND sfdc003   = sfbaseq1 ",
                     "    AND sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc012   = ' '  "  #库位
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
         END IF
      END IF
      IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
         LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
      ELSE
         LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
      END IF
      DECLARE asft310_set_no_entry_b_sfdf_c11 SCROLL CURSOR FROM l_sql
      OPEN asft310_set_no_entry_b_sfdf_c11
      FETCH asft310_set_no_entry_b_sfdf_c11 INTO l_cnt
      CLOSE asft310_set_no_entry_b_sfdf_c11
      IF l_cnt = 0 THEN
      #add 141211 end
         CALL cl_set_comp_entry("sfdf003",FALSE)
         LET g_sfdf003_switch = 'N'
      END IF  #add 141211
   END IF
   #检查sfdf对应的sfde中包含的sfdc里是否有指定"储位"为非空，且只有一个相同的指定"储位"，此时此栏位不允许输入只能默认
   IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
      LET l_sql = " SELECT COUNT(UNIQUE sfdc013) ",
                  "   FROM sfdc_t ",
                  "  WHERE sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
      END IF
   ELSE
      LET l_sql = " SELECT COUNT(UNIQUE sfdc013) ",
                  "   FROM sfdc_t,sfba_t ",
                  "  WHERE sfdcent   = sfbaent ",
                  "    AND sfdc001   = sfbadocno ",
                  "    AND sfdc002   = sfbaseq ",
                  "    AND sfdc003   = sfbaseq1 ",
                  "    AND sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
      END IF
   END IF
               #"    AND sfdc009   = '",g_sfde_d[g_detail_idx].sfde006,"' "    #参考单位
   IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
      LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
   ELSE
      LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
   END IF
   DECLARE asft310_set_no_entry_b_sfdf_c2 SCROLL CURSOR FROM l_sql
   OPEN asft310_set_no_entry_b_sfdf_c2
   FETCH asft310_set_no_entry_b_sfdf_c2 INTO l_cnt
   CLOSE asft310_set_no_entry_b_sfdf_c2
   IF l_cnt = 1 THEN
      IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
         LET l_sql = " SELECT COUNT(UNIQUE sfdc013) ",
                     "   FROM sfdc_t ",
                     "  WHERE sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc013   = ' '  "  #儲位
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
         END IF
      ELSE
         LET l_sql = " SELECT COUNT(UNIQUE sfdc013) ",
                     "   FROM sfdc_t,sfba_t ",
                     "  WHERE sfdcent   = sfbaent ",
                     "    AND sfdc001   = sfbadocno ",
                     "    AND sfdc002   = sfbaseq ",
                     "    AND sfdc003   = sfbaseq1 ",
                     "    AND sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc013   = ' '  "  #儲位
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
         END IF
      END IF
      IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
         LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
      ELSE
         LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
      END IF
      DECLARE asft310_set_no_entry_b_sfdf_c21 SCROLL CURSOR FROM l_sql
      OPEN asft310_set_no_entry_b_sfdf_c21
      FETCH asft310_set_no_entry_b_sfdf_c21 INTO l_cnt
      CLOSE asft310_set_no_entry_b_sfdf_c21
      IF l_cnt = 0 THEN
         CALL cl_set_comp_entry("sfdf004",FALSE)
         LET g_sfdf004_switch = 'N'
      END IF
   END IF
   #检查sfdf对应的sfde中包含的sfdc里是否有指定"批号"为非空，且只有一个相同的指定"批号"，此时此栏位不允许输入只能默认
   IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
      LET l_sql = " SELECT COUNT(UNIQUE sfdc014) ",
                  "   FROM sfdc_t ",
                  "  WHERE sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
      END IF
   ELSE
      LET l_sql = " SELECT COUNT(UNIQUE sfdc014) ",
                  "   FROM sfdc_t,sfba_t ",
                  "  WHERE sfdcent   = sfbaent ",
                  "    AND sfdc001   = sfbadocno ",
                  "    AND sfdc002   = sfbaseq ",
                  "    AND sfdc003   = sfbaseq1 ",
                  "    AND sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
      END IF
   END IF
   IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
      LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
   ELSE
      LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
   END IF
   DECLARE asft310_set_no_entry_b_sfdf_c3 SCROLL CURSOR FROM l_sql
   OPEN asft310_set_no_entry_b_sfdf_c3
   FETCH asft310_set_no_entry_b_sfdf_c3 INTO l_cnt
   CLOSE asft310_set_no_entry_b_sfdf_c3
   IF l_cnt = 1 THEN
      IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
         LET l_sql = " SELECT COUNT(UNIQUE sfdc014) ",
                     "   FROM sfdc_t ",
                     "  WHERE sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc014   = ' '  "  #批号
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
         END IF
      ELSE
         LET l_sql = " SELECT COUNT(UNIQUE sfdc014) ",
                     "   FROM sfdc_t,sfba_t ",
                     "  WHERE sfdcent   = sfbaent ",
                     "    AND sfdc001   = sfbadocno ",
                     "    AND sfdc002   = sfbaseq ",
                     "    AND sfdc003   = sfbaseq1 ",
                     "    AND sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc014   = ' '  "  #批号
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
         END IF
      END IF
      IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
         LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
      ELSE
         LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
      END IF
      DECLARE asft310_set_no_entry_b_sfdf_c31 SCROLL CURSOR FROM l_sql
      OPEN asft310_set_no_entry_b_sfdf_c31
      FETCH asft310_set_no_entry_b_sfdf_c31 INTO l_cnt
      CLOSE asft310_set_no_entry_b_sfdf_c31
      IF l_cnt = 0 THEN
         CALL cl_set_comp_entry("sfdf005",FALSE)
         LET g_sfdf005_switch = 'N'
      END IF
   END IF
   #检查sfdf对应的sfde中包含的sfdc里是否有指定"库存管理特征"为非空，且只有一个相同的指定"库存管理特征"，此时此栏位不允许输入只能默认
   IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
      LET l_sql = " SELECT COUNT(UNIQUE sfdc016) ",
                  "   FROM sfdc_t ",
                  "  WHERE sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
      END IF
   ELSE
      LET l_sql = " SELECT COUNT(UNIQUE sfdc016) ",
                  "   FROM sfdc_t,sfba_t ",
                  "  WHERE sfdcent   = sfbaent ",
                  "    AND sfdc001   = sfbadocno ",
                  "    AND sfdc002   = sfbaseq ",
                  "    AND sfdc003   = sfbaseq1 ",
                  "    AND sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
      END IF
   END IF
   IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
      LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
   ELSE
      LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
   END IF
   DECLARE asft310_set_no_entry_b_sfdf_c4 SCROLL CURSOR FROM l_sql
   OPEN asft310_set_no_entry_b_sfdf_c4
   FETCH asft310_set_no_entry_b_sfdf_c4 INTO l_cnt
   CLOSE asft310_set_no_entry_b_sfdf_c4
   IF l_cnt = 1 THEN
      IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
         LET l_sql = " SELECT COUNT(UNIQUE sfdc016) ",
                     "   FROM sfdc_t ",
                     "  WHERE sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc016   = ' ' "  #库存管理特征
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
         END IF
      ELSE
         LET l_sql = " SELECT COUNT(UNIQUE sfdc016) ",
                     "   FROM sfdc_t,sfba_t ",
                     "  WHERE sfdcent   = sfbaent ",
                     "    AND sfdc001   = sfbadocno ",
                     "    AND sfdc002   = sfbaseq ",
                     "    AND sfdc003   = sfbaseq1 ",
                     "    AND sfdcent   = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                     "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                     "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                     "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",   #单位
                     "    AND sfdc016   = ' ' "  #库存管理特征
         IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
            LET l_sql = l_sql CLIPPED, " AND sfba028   = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
         END IF
      END IF
      IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
         LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
      ELSE
         LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
      END IF
      DECLARE asft310_set_no_entry_b_sfdf_c41 SCROLL CURSOR FROM l_sql
      OPEN asft310_set_no_entry_b_sfdf_c41
      FETCH asft310_set_no_entry_b_sfdf_c41 INTO l_cnt
      CLOSE asft310_set_no_entry_b_sfdf_c41
      IF l_cnt = 0 THEN
         CALL cl_set_comp_entry("sfdf010",FALSE)
         LET g_sfdf010_switch = 'N'
      END IF
   END IF

   SELECT imaf015 INTO l_imaf015  #参考单位
     FROM imaf_t
    WHERE imafent = g_enterprise
      AND imafsite= g_site
      AND imaf001 = g_sfdf_d[l_ac].sfdf001
   #料件有使用參考單位時才可輸入
   CALL cl_set_comp_entry("sfdf008",FALSE)  #参考单位 单据上统一不允许修改
   IF g_ref_unit = 'N' THEN
      CALL cl_set_comp_entry("sfdf009",FALSE)  #数量
   ELSE
      IF cl_null(l_imaf015) THEN
         CALL cl_set_comp_entry("sfdf009",FALSE)  #数量
      END IF
   END IF
   
   #160731-00253#1-s
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
   END IF
   #160731-00253#1-e
   
END FUNCTION

PRIVATE FUNCTION asft310_set_entry_b_sfdd(p_cmd)
DEFINE p_cmd   LIKE type_t.chr1

   IF g_prog[1,6] = 'asft31' THEN
      CALL cl_set_comp_entry("sfdd001,sfdd013",TRUE)  #发料料号
   END IF
   CALL cl_set_comp_entry("sfdd003",TRUE)  #库位 #add 141211
   CALL cl_set_comp_entry("sfdd004",TRUE)  #储位
   CALL cl_set_comp_entry("sfdd005",TRUE)  #批号
   CALL cl_set_comp_entry("sfdd010",TRUE)  #库存管理特征
   LET g_sfdd003_switch = 'Y'   #庫位        可输入性 Y可输入 N不可输入 add 141211
   LET g_sfdd004_switch = 'Y'   #儲位        可输入性 Y可输入 N不可输入
   LET g_sfdd005_switch = 'Y'   #批號        可输入性 Y可输入 N不可输入
   LET g_sfdd010_switch = 'Y'   #庫存管理特徵 可输入性 Y可输入 N不可输入
   
   CALL cl_set_comp_entry("sfdd008,sfdd009",TRUE)  #参考单位,数量
   
   #料件做产品特征管理时，产品特征栏位不允许空白
   CALL cl_set_comp_required("sfdd013",FALSE)  #add 141204
   
   CALL cl_set_comp_entry("sfdd010",TRUE) #庫存款裡特徵 160126-00022#1-add
END FUNCTION

PRIVATE FUNCTION asft310_set_no_entry_b_sfdd(p_cmd)
DEFINE p_cmd      LIKE type_t.chr1
DEFINE l_imaf015  LIKE imaf_t.imaf015
DEFINE l_imaa005  LIKE imaa_t.imaa005
DEFINE l_imaf055  LIKE imaf_t.imaf055  #160126-00022#1-add
DEFINE l_imaf061  LIKE imaf_t.imaf061  #160519-00022#18 add

   CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002  #161006-00018#10
   IF g_prog[1,6] = 'asft31' THEN
      #參數允許發料替代=Y時，才允許輸入发料料号
      #CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002  #161006-00018#10
      CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0072') RETURNING g_para
      IF cl_null(g_para) THEN LET g_para = 'N' END IF
      IF g_para = 'N' THEN
         CALL cl_set_comp_entry("sfdd001,sfdd013",FALSE)
      END IF
   END IF
   IF g_prog[1,6] = 'asft32' THEN
      CALL cl_set_comp_entry("sfdd001,sfdd013",FALSE)
   END IF
   #add 141211
   #161006-00018#10-s
   #來源單據指定庫儲後，是否允許修改
   IF cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0085') = 'N' THEN
      #當指定库位為空白時才允許修改
      IF NOT cl_null(g_sfdc4_d[g_detail_idx].sfdc012) THEN
         CALL cl_set_comp_entry("sfdd003",FALSE)  #库位
         LET g_sfdd003_switch = 'N'
      END IF
      #add 141211 end
      #當指定儲位為空白時才允許修改
      IF NOT cl_null(g_sfdc4_d[g_detail_idx].sfdc013) THEN
         CALL cl_set_comp_entry("sfdd004",FALSE)  #储位
         LET g_sfdd004_switch = 'N'
      END IF
      #當指定批號為空白時才允許輸入
      IF NOT cl_null(g_sfdc4_d[g_detail_idx].sfdc014) THEN
         CALL cl_set_comp_entry("sfdd005",FALSE)  #批号
         LET g_sfdd005_switch = 'N'
      END IF
      #當指定庫存管理特徵為空白時才允許輸入
      IF NOT cl_null(g_sfdc4_d[g_detail_idx].sfdc016) THEN
         CALL cl_set_comp_entry("sfdd010",FALSE)  #库存管理特征
         LET g_sfdd010_switch = 'N'
      END IF
   END IF
   #161006-00018#10-e
   #160126-00022#1-mod-(S)
#   SELECT imaf015 INTO l_imaf015  #参考单位
#     FROM imaf_t
#    WHERE imafent = g_enterprise
#      AND imafsite= g_site
#      AND imaf001 = g_sfdd_d[l_ac].sfdd001
    SELECT imaf015,imaf055,imaf061         #160519-00022#18 add imaf061
      INTO l_imaf015,l_imaf055,l_imaf061   #参考单位,庫存管理特徵 #160519-00022#18 add imaf061
      FROM imaf_t
     WHERE imafent = g_enterprise
       AND imafsite= g_site
       AND imaf001 = g_sfdd_d[l_ac].sfdd001
   #160126-00022#1-mod-(E)
   #料件有使用參考單位時才可輸入
   CALL cl_set_comp_entry("sfdd008",FALSE)  #参考单位 统一不允许修改 默认料件中设置的单位
   IF g_ref_unit = 'N' THEN
      CALL cl_set_comp_entry("sfdd009",FALSE)  #数量
   ELSE
      IF cl_null(l_imaf015) THEN
         CALL cl_set_comp_entry("sfdd009",FALSE)  #数量
      END IF
   END IF
   #160126-00022#1-mod-(S)
   #---不可有庫存管理特徵
   IF l_imaf055 = '2' THEN
      CALL cl_set_comp_entry("sfdd010",FALSE)
   END IF
   IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN
      IF l_imaf055 = '1' THEN
         LET g_sfdd_d[l_ac].sfdd010 = ''
      ELSE
         LET g_sfdd_d[l_ac].sfdd010 = ' '
      END IF
   END IF
   #160126-00022#1-mod-(E)
   #160519-00022#18-s-add 
   #檢查料件是否使用批號
   IF l_imaf061 = '2' THEN
      CALL cl_set_comp_entry("sfdd005",FALSE)
   END IF          
   #160519-00022#18-e-add     
   
   #料件做产品特征管理时，不允许空白
   IF NOT cl_null(g_sfdd_d[l_ac].sfdd001) THEN
      SELECT imaa005 INTO l_imaa005  #特征类别
        FROM imaa_t
       WHERE imaaent  = g_enterprise
         AND imaa001  = g_sfdd_d[l_ac].sfdd001
      IF NOT cl_null(l_imaa005) THEN
         CALL cl_set_comp_required("sfdd013",TRUE)  #add 141204
      END IF
   END IF
   
   #160731-00253#1-s
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
   END IF
   #160731-00253#1-e
   
END FUNCTION

#检查储位 校验带值
PRIVATE FUNCTION asft310_chk_loca(p_ware,p_loca)
DEFINE p_ware      LIKE sfdc_t.sfdc012  #库位
DEFINE p_loca      LIKE sfdc_t.sfdc013  #储位
DEFINE r_success   LIKE type_t.num5
DEFINE r_loca_desc LIKE type_t.chr80

   LET r_success = TRUE
   
   IF cl_null(p_ware) OR cl_null(p_loca) THEN
      RETURN r_success
   END IF
   
   #校验带值说明
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = p_ware
   LET g_chkparam.arg2 = p_loca
   #160318-00025#22  by 07900 --add-str
   LET g_errshow = TRUE #是否開窗                   
   LET g_chkparam.err_str[1] ="aim-00063:sub-01302|aini002|",cl_get_progname("aini002",g_lang,"2"),"|:EXEPROGaini002"
   #160318-00025#22  by 07900 --add-end
   IF cl_chk_exist_and_ref_val("v_inab003_2") THEN
      #檢查成功時後續處理
      LET r_loca_desc = g_chkparam.return1
   ELSE
      LET r_success = FALSE
   END IF

   RETURN r_success,r_loca_desc
END FUNCTION

PRIVATE FUNCTION asft310_chk_sfda003()
DEFINE r_success  LIKE type_t.num5

   LET r_success = TRUE
   
   IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN  #製程中委外時，顯示名稱為委外廠商
      #厂商资料检查
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = g_sfda_m.sfda003
      #檢查存在
      IF NOT cl_chk_exist("v_pmaa001_1") THEN
         LET r_success = FALSE
      END IF
   ELSE
     #部门检查
     IF NOT s_department_chk(g_sfda_m.sfda003,g_sfda_m.sfdadocdt) THEN
         LET r_success = FALSE
     END IF
   END IF
   
   RETURN r_success
END FUNCTION
################################################################################
# Descriptions...: 获取本单据其他项次的需求申请数量
# Memo...........:
# Usage..........: CALL asft310_get_sfdc007(p_cmd)
#                  RETURNING r_sfdc007
# Input parameter: p_cmd       a:新增  u:修改
# Return code....: r_sfdc007   需求申请数量
# Date & Author..: 2013/12/19 By zhangllc
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_get_sfdc007(p_cmd)
DEFINE p_cmd       LIKE type_t.chr1     #a:新增 u:修改
DEFINE r_sfdc007   LIKE sfdc_t.sfdc007  #需求申请数量

   #本发料单据其他项次的
   IF p_cmd = 'u' THEN
      SELECT SUM(sfdc007) INTO r_sfdc007 FROM sfdc_t
       WHERE sfdcent = g_enterprise
         AND sfdcdocno=g_sfda_m.sfdadocno       #发料单单号
         AND sfdcseq != g_sfdc_d_t.sfdcseq
         AND sfdc001 = g_sfdc_d[l_ac].sfdc001  #工单
         AND sfdc002 = g_sfdc_d[l_ac].sfdc002  #工单项次
         AND sfdc003 = g_sfdc_d[l_ac].sfdc003  #工单项序
   ELSE
      SELECT SUM(sfdc007) INTO r_sfdc007 FROM sfdc_t
       WHERE sfdcent = g_enterprise
         AND sfdcdocno=g_sfda_m.sfdadocno       #发料单单号
         AND sfdc001 = g_sfdc_d[l_ac].sfdc001  #工单
         AND sfdc002 = g_sfdc_d[l_ac].sfdc002  #工单项次
         AND sfdc003 = g_sfdc_d[l_ac].sfdc003  #工单项序
   END IF
   IF cl_null(r_sfdc007) THEN LET r_sfdc007 = 0 END IF
   
   RETURN r_sfdc007
END FUNCTION

PRIVATE FUNCTION asft310_init()
   DEFINE l_msg      STRING
   
   LET g_bfill = "Y"
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
   LET g_error_show = 1
   LET g_today = cl_get_today()
   
   LET g_mdemand = 'N'   #151217-00023#5 add
   CALL cl_set_combo_scc('b_sfda002','4013')
#   CALL cl_set_combo_scc_part('sfdastus','13','D,N,W,X,Y,A,R,S')  #160328-00028 by whitney mark
   CALL cl_set_combo_scc_part('sfdastus','13','N,Y,S,A,D,R,W,X')  #160328-00028 by whitney add
  CALL cl_set_combo_scc('sfda002','4013')
   CALL cl_set_combo_scc('sfda015','4029')  #来源类型
   CALL cl_set_combo_scc('replace','4011')    #取替代建议
   CALL cl_set_combo_scc('replace04','4011')  #取替代建议

   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件

   #add-point:畫面資料初始化
   #---SCC---
   #160623-00014#1-mod-(S)
#   CASE g_prog
#      WHEN 'asft310'
#           CALL cl_set_combo_scc_part('sfda002','4013','11,12,13,14,15')
#      WHEN 'asft311'
#           CALL cl_set_combo_scc_part('sfda002','4013','11')
#      WHEN 'asft312'
#           CALL cl_set_combo_scc_part('sfda002','4013','12')
#      WHEN 'asft313'
#           CALL cl_set_combo_scc_part('sfda002','4013','13')
#      WHEN 'asft314'
#           CALL cl_set_combo_scc_part('sfda002','4013','14')
#      WHEN 'asft315'
#           CALL cl_set_combo_scc_part('sfda002','4013','15')
#      WHEN 'asft320'
#           CALL cl_set_combo_scc_part('sfda002','4013','21,22,23,24,25')
#      WHEN 'asft321'
#           CALL cl_set_combo_scc_part('sfda002','4013','21')
#      WHEN 'asft322'
#           CALL cl_set_combo_scc_part('sfda002','4013','22')
#      WHEN 'asft323'
#           CALL cl_set_combo_scc_part('sfda002','4013','23')
#      WHEN 'asft324'
#           CALL cl_set_combo_scc_part('sfda002','4013','24')
#      WHEN 'asft325'
#           CALL cl_set_combo_scc_part('sfda002','4013','25')
#   END CASE
   CASE 
      WHEN g_prog MATCHES 'asft310'
           CALL cl_set_combo_scc_part('sfda002','4013','11,12,13,14,15')
      WHEN g_prog MATCHES 'asft311'
           CALL cl_set_combo_scc_part('sfda002','4013','11')
      WHEN g_prog MATCHES 'asft312'
           CALL cl_set_combo_scc_part('sfda002','4013','12')
      WHEN g_prog MATCHES 'asft313'
           CALL cl_set_combo_scc_part('sfda002','4013','13')
      WHEN g_prog MATCHES 'asft314'
           CALL cl_set_combo_scc_part('sfda002','4013','14')
      WHEN g_prog MATCHES 'asft315'
           CALL cl_set_combo_scc_part('sfda002','4013','15')
      WHEN g_prog MATCHES 'asft320'
           CALL cl_set_combo_scc_part('sfda002','4013','21,22,23,24,25')
      WHEN g_prog MATCHES 'asft321'
           CALL cl_set_combo_scc_part('sfda002','4013','21')
      WHEN g_prog MATCHES 'asft322'
           CALL cl_set_combo_scc_part('sfda002','4013','22')
      WHEN g_prog MATCHES 'asft323'
           CALL cl_set_combo_scc_part('sfda002','4013','23')
      WHEN g_prog MATCHES 'asft324'
           CALL cl_set_combo_scc_part('sfda002','4013','24')
      WHEN g_prog MATCHES 'asft325'
           CALL cl_set_combo_scc_part('sfda002','4013','25')
   END CASE
   #160623-00014#1-mod-(E) 
   
   #---visible---
   CALL cl_set_comp_visible("sfdd011,sfdf011",FALSE)  #add 141118包装容器隐藏
   #160623-00014#1-mod-(S)
#   #发退料需求、料号汇总、发退料明细、制造批序号页签 页签隐藏
#   IF g_prog='asft315' OR g_prog = 'asft325' THEN
#      CALL cl_set_comp_visible("page_3,page_4,page_5,page_6",FALSE)
#   END IF
#   #用不到套数页签的类型，套数页签隐藏
#   IF g_prog='asft314' OR g_prog='asft323' OR g_prog = 'asft324' THEN
#      CALL cl_set_comp_visible("bpage_1",FALSE)
#   END IF
   #发退料需求、料号汇总、发退料明细、制造批序号页签 页签隐藏
   IF g_prog MATCHES 'asft315' OR g_prog MATCHES 'asft325' THEN
      CALL cl_set_comp_visible("page_3,page_4,page_5,page_6",FALSE)
   END IF
   #用不到套数页签的类型，套数页签隐藏
   IF g_prog MATCHES 'asft314' OR g_prog MATCHES 'asft323' OR g_prog MATCHES 'asft324' THEN
      CALL cl_set_comp_visible("bpage_1",FALSE)
   END IF
   #160623-00014#1-mod-(E)
   #當整體參數有使用參考單位時才顯示
   IF g_ref_unit = 'N' THEN
      CALL cl_set_comp_visible("sfdc009,sfdc009_desc,sfdc010,sfdc011,diff2",FALSE) #參考單位
      CALL cl_set_comp_visible("sfde006,sfde006_desc,sfde007,sfde008,diff23",FALSE) #參考單位
      CALL cl_set_comp_visible("sfdf008,sfdf008_desc,sfdf009",FALSE) #參考單位
      CALL cl_set_comp_visible("sfdc009_4,sfdc009_4_desc,sfdc010_4,sfdc011_4,diff24",FALSE) #參考單位
      CALL cl_set_comp_visible("sfdd008,sfdd008_desc,sfdd009",FALSE) #參考單位
   END IF
   #退料单保税料imaf034、客供料sfde009 隐藏
   IF g_prog[1,6]='asft32' THEN
      CALL cl_set_comp_visible("imaf034_3,sfde009",FALSE) #參考單位
   END IF
   #160623-00014#1-mod-(S)
#   #runcard 在类型为非制程委外时隐藏
#   IF g_prog!='asft310' AND g_prog!='asft320' AND g_prog!='asft315' AND g_prog!='asft325' THEN
#      CALL cl_set_comp_visible("sfdb002",FALSE)
#   END IF
#   #部位  在制程中委外时隐藏不显示
#   IF g_prog='asft315' OR g_prog='asft325' THEN
#      CALL cl_set_comp_visible("sfdb003,sfdb003_desc",FALSE)
#   END IF
   #runcard 在类型为非制程委外时隐藏
   IF g_prog NOT MATCHES 'asft310' AND g_prog NOT MATCHES 'asft320' AND g_prog NOT MATCHES 'asft315' AND g_prog NOT MATCHES 'asft325' THEN
      CALL cl_set_comp_visible("sfdb002",FALSE)
   END IF
   #部位  在制程中委外时隐藏不显示
   IF g_prog MATCHES 'asft315' OR g_prog MATCHES 'asft325' THEN
      CALL cl_set_comp_visible("sfdb003,sfdb003_desc",FALSE)
   END IF
   #160623-00014#1-mod-(e)
   #150810-00003#1add wangxin #150902
   #参数S-BAS-0036：使用产品特征 为 否，则隐藏画面产品特征栏位
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036')  = 'N' THEN  
      CALL cl_set_comp_visible("sfdc005,sfdc005_desc,sfde002,sfde002_desc,sfdf013,sfdf013_desc,sfdc005_4,sfdc005_4_desc,sfdd013,sfdd013_desc",FALSE)
   END IF
   #150810-00003#1add
   
   #退料单调拨产生按钮隐藏
   IF g_prog[1,6] = 'asft32' THEN
      #CALL cl_set_act_visible("gen_asfp370",FALSE)
      #CALL cl_set_toolbaritem_visible("gen_asfp370",FALSE)
      CALL cl_set_act_visible_toolbaritem("gen_asfp370",FALSE)
   END IF
   #160623-00014#1-mod-(S)
#   #发料需求产生按钮隐藏
#   #只有11,12,13,21,22才允许点击“发退料需求产生”按钮。在其他作业中，把这个按钮进行隐藏
#   IF  g_prog != 'asft310' AND g_prog != 'asft320'
#   AND g_prog != 'asft311' AND g_prog != 'asft313' AND g_prog != 'asft321'
#   AND g_prog != 'asft312' AND g_prog != 'asft322' THEN
#      CALL cl_set_act_visible_toolbaritem("gen_sfdc",FALSE)
#   END IF
#   
#   #---requried---
#   CALL cl_set_comp_required("sfdb003,sfdb004,sfdb005",FALSE)
#   #制程委外时不可空白，其他的允许空白
#   IF g_prog='asft315' OR g_prog = 'asft325' THEN
#      CALL cl_set_comp_required("sfdb004,sfdb005",TRUE)
#   END IF
   #发料需求产生按钮隐藏
   #只有11,12,13,21,22才允许点击“发退料需求产生”按钮。在其他作业中，把这个按钮进行隐藏
   IF  g_prog NOT MATCHES 'asft310' AND g_prog NOT MATCHES 'asft320'
   AND g_prog NOT MATCHES 'asft311' AND g_prog NOT MATCHES 'asft313' AND g_prog NOT MATCHES 'asft321'
   AND g_prog NOT MATCHES 'asft312' AND g_prog NOT MATCHES 'asft322' THEN
      CALL cl_set_act_visible_toolbaritem("gen_sfdc",FALSE)
   END IF
   
   #---requried---
   CALL cl_set_comp_required("sfdb003,sfdb004,sfdb005",FALSE)
   #制程委外时不可空白，其他的允许空白
   IF g_prog MATCHES 'asft315' OR g_prog MATCHES 'asft325' THEN
      CALL cl_set_comp_required("sfdb004,sfdb005",TRUE)
   END IF
   #160623-00014#1-mod-(E)
   
   #---entry---
   #退料时，明细发料料号不允许输入
   IF g_prog[1,6] = 'asft32' THEN
      CALL cl_set_comp_entry("sfdd001,sfdd013",FALSE)  #发料料号
   END IF
   
   #--ACTION
   #160623-00014#1-mod-(S)
#   #asft310,asft320不允许新增，修改
#   IF g_prog='asft310' OR g_prog='asft320' THEN
#      CALL cl_set_act_visible_toolbaritem("insert,modify,modify_detail",FALSE)
#   END IF
#   
#   #标签说明更改
#   IF g_prog='asft315' OR g_prog='asft325' THEN
#      LET l_msg = cl_getmsg("asf-00685",g_lang)  #委外厂商
#      CALL gfrm_curr.setElementtext("lbl_sfda003",l_msg)
#   END IF
   #asft310,asft320不允许新增，修改
   IF g_prog MATCHES 'asft310' OR g_prog MATCHES 'asft320' THEN
      CALL cl_set_act_visible_toolbaritem("insert,modify,modify_detail",FALSE)
   END IF
   
   #标签说明更改
   IF g_prog MATCHES 'asft315' OR g_prog MATCHES 'asft325' THEN
      LET l_msg = cl_getmsg("asf-00685",g_lang)  #委外厂商
      CALL gfrm_curr.setElementtext("lbl_sfda003",l_msg)
   END IF
   #160623-00014#1-mod-(E)
   #end add-point
   
   #add 150831
   CALL cl_set_toolbaritem_visible("s_lot_sel,s_lot_sel1",TRUE) #制造批序号维护、申请制造批序号维护
   CALL cl_ui_replace_sub_window(cl_ap_formpath("sub", "s_lot_s01"), "grid_s_lot", "Table", "s_detail1_s_lot_s01")

   CALL s_lot_sel_create_tmp()
   #add 150831 end

   CALL asft310_default_search()

END FUNCTION

PRIVATE FUNCTION asft310_ui_dialog()
   {<Local define>}
   #160222-00012#1-add-(S)
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #160222-00012#1-add-(E)
   DEFINE li_idx  LIKE type_t.num5
   DEFINE ls_wc     STRING
   DEFINE l_inao013  LIKE inao_t.inao013  #出入库码
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   #add 150831
   DEFINE l_success LIKE type_t.num5
   DEFINE l_amount  LIKE sfdc_t.sfdc007
   DEFINE l_amountr LIKE sfdc_t.sfdc010
   DEFINE l_prog    LIKE gzzz_t.gzzz001   #作业编号（可当单据类型用）
   #add 150831 end
   
   {</Local define>}

   CALL cl_set_act_visible("accept,cancel", FALSE)

   CALL gfrm_curr.setElementImage("logo","logo/applogo.png")
   #IF g_wc.trim() <> "1=1" THEN
   IF g_default THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   ELSE
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF

   WHILE TRUE

      CALL asft310_browser_fill("")   #170216-00021 mark   #170217-00024#1 remark
      
      #判斷前一個動作是否為新增, 若是的話切換到新增的筆數
      IF g_state = "Y" THEN
         FOR li_idx = 1 TO g_browser.getLength()
            IF g_browser[li_idx].b_sfdadocno = g_sfdadocno_t THEN
               LET g_current_row = li_idx
               LET g_current_idx = li_idx
               EXIT FOR
            END IF
         END FOR
         LET g_state = ""
      END IF

      
      #add 150416切换营运据点画面处理
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_sfda_m.* TO NULL
         CALL g_sfdb_d.clear()
         CALL g_sfdc_d.clear()
         CALL g_sfde_d.clear()
         CALL g_sfdc4_d.clear()
         CALL g_sfdf_d.clear()
         CALL g_sfdd_d.clear()
         CALL g_inao_d.clear()  #add 150831
         CALL g_inao_d2.clear()  #add 150831
      
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL asft310_init()
      END IF
      #end
      
      CALL lib_cl_dlg.cl_dlg_before_display()
      CALL cl_notice()
      
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         #左側瀏覽頁簽
         DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)

            BEFORE ROW
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE

               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF

               CALL asft310_fetch('') # reload data
               LET l_ac = 1
               CALL asft310_ui_detailshow() #Setting the current row
               
               CALL asft310_idx_chk()
               #NEXT FIELD sfdb001

               #add 150416
               ON ACTION qbefield_user   #欄位隱藏設定 
                  LET g_action_choice="qbefield_user"
                  CALL cl_ui_qbefield_user()
               #add 150416 end
         END DISPLAY

         DISPLAY ARRAY g_sfdb_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1

            BEFORE ROW
               CALL asft310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               CALL asft310_idx_chk()
               LET g_current_page = 1

            #自訂ACTION(detail_show,page_1)

         END DISPLAY

         DISPLAY ARRAY g_sfdc_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)

            BEFORE ROW
               CALL asft310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               CALL asft310_b_fill2('6')


            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               CALL asft310_idx_chk()
               LET g_current_page = 2
            #自訂ACTION(detail_show,page_2)
               CALL cl_set_act_visible("s_lot_sel,s_lot_sel1",TRUE) #add 150831
            
            #add 150831 --begin
            ON ACTION s_lot_sel1 #申请制造批序号维护
               LET g_action_choice="s_lot_sel1"
               IF cl_auth_chk_act("s_lot_sel1") THEN
                  IF cl_null(g_detail_idx) OR g_detail_idx = 0 THEN
                     #单身缺少资料，不可维护！
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'abm-00073'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
                  
                  IF g_sfda_m.sfdastus <> 'N' THEN
                     #此笔单据状态不是未审核,不可修改！
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'apm-00035'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
                  
                  #add 150921 下阶料报废的控管
                  IF g_sfda_m.sfda015 = '04' THEN #来源：工单在制下阶料报废，不能修改，在asft339中指定好了，保持一致
                     #本单据来源类型为%1，不可异动
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00696'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     LET g_errparam.replace[1] = '04'
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
                  #add 150921
                  
                  IF cl_null(g_sfdc_d[g_detail_idx].sfdc012) THEN
                     #请先指定库位信息以便挑选批序号资料
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00691'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
                  
                  IF NOT cl_null(g_sfda_m.sfdadocno) AND
                     NOT cl_null(g_sfdc_d[g_detail_idx].sfdcseq) AND
                     NOT cl_null(g_sfdc_d[g_detail_idx].sfdc004) AND #料件
                     NOT cl_null(g_sfdc_d[g_detail_idx].sfdc006) AND #单位
                     NOT cl_null(g_sfdc_d[g_detail_idx].sfdc007) AND #数量
                     NOT cl_null(g_sfda_m.sfda004) THEN  #申请人
                     LET l_success = ''
                     CALL s_transaction_begin()
                     
                     IF g_prog[1,6] = 'asft31' AND g_sfdc_d[l_ac].sfdc007 > 0 THEN  #发料
                        CALL s_lot_sel('1','1',g_site,
                                       g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,'0', #目的单号，项次，项序
                                       g_sfdc_d[g_detail_idx].sfdc004,g_sfdc_d[g_detail_idx].sfdc005,
                                       g_sfdc_d[g_detail_idx].sfdc016,g_sfdc_d[g_detail_idx].sfdc012,g_sfdc_d[g_detail_idx].sfdc013,g_sfdc_d[g_detail_idx].sfdc014,
                                       g_sfdc_d[g_detail_idx].sfdc006,g_sfdc_d[g_detail_idx].sfdc007,'-1',g_prog,'',
                                       g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,'0','1' #来源单号，项次，项序,启用
                                       )
                             RETURNING l_success
                     ELSE #退料
                        ##工单已发的inao资料，产生到当前单据中的inao
                        ##                        工单                           项次 
                        #CALL s_asft310_inao_copy(g_sfdc_d[g_detail_idx].sfdc001,g_sfdc_d[g_detail_idx].sfdc002,
                        ##                        料                             产品特征
                        #                         g_sfdc_d[g_detail_idx].sfdc004,g_sfdc_d[g_detail_idx].sfdc005,
                        ##                        库存管理特征                    库位
                        #                         g_sfdc_d[g_detail_idx].sfdc016,g_sfdc_d[g_detail_idx].sfdc012,
                        ##                        储位                           批号
                        #                         g_sfdc_d[g_detail_idx].sfdc013,g_sfdc_d[g_detail_idx].sfdc014,
                        ##                        目的单号           项次
                        #                         g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,
                        ##                        项序
                        #                         0)
                        #   RETURNING l_success
                        ##从当前单据中已产生的inao中选取退料资料
                        ##              inao中抓 申请的资料 据点
                        #CALL s_lot_sel('2','1',g_site,
                        ##              目的单号            项次                           项序
                        #               g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,'0',
                        ##              料件编号                        产品特征                        库存管理特征仓储批
                        #               g_sfdc_d[g_detail_idx].sfdc004,g_sfdc_d[g_detail_idx].sfdc005,'','','','',
                        ##              退料单位                        数量
                        #               g_sfdc_d[g_detail_idx].sfdc006,g_sfdc_d[g_detail_idx].sfdc007,
                        ##              出入库码 作业编号 据点
                        #               '1',g_prog,'',
                        ##              来源单号            项次                           项序 启用来源单据
                        #               g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,'0','1'
                        #               )
                        #     RETURNING l_success 
                        CASE g_sfda_m.sfda002
                           WHEN '11'    LET l_prog='asft311'
                           WHEN '12'    LET l_prog='asft312'
                           WHEN '13'    LET l_prog='asft313'
                           WHEN '14'    LET l_prog='asft314'
                           WHEN '15'    LET l_prog='asft315'
                           WHEN '21'    LET l_prog='asft321'
                           WHEN '22'    LET l_prog='asft322'
                           WHEN '23'    LET l_prog='asft323'
                           WHEN '24'    LET l_prog='asft324'
                           WHEN '25'    LET l_prog='asft325'
                        END CASE
                        #                      发退料类型   工单                      项次 
                        CALL s_asft310_lot_sel(l_prog,g_sfdc_d[g_detail_idx].sfdc001,g_sfdc_d[g_detail_idx].sfdc002,
                        #                      料                             产品特征
                                               g_sfdc_d[g_detail_idx].sfdc004,g_sfdc_d[g_detail_idx].sfdc005,
                        #                      库存管理特征                    库位
                                               g_sfdc_d[g_detail_idx].sfdc016,g_sfdc_d[g_detail_idx].sfdc012,
                        #                      储位                           批号
                                               g_sfdc_d[g_detail_idx].sfdc013,g_sfdc_d[g_detail_idx].sfdc014,
                        #                      目的单号            项次                           项序
                                               g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,0,
                        #                      单位                           数量
                                               g_sfdc_d[g_detail_idx].sfdc006,g_sfdc_d[g_detail_idx].sfdc007)
                             RETURNING l_success 
                     END IF
                          
                     IF l_success THEN
                        CALL s_transaction_end('Y','0')
                     ELSE
                        CALL s_transaction_end('N','0')
                     END IF
                    #151217-00023#5 add -----(S)
                     IF asft310_ins_inao_2() THEN   
                     END IF
                     CALL asft310_b_fill_inao2()
                    #151217-00023#5 add -----(E)
                  END IF
               END IF
            #add 150831 --end
         END DISPLAY

         DISPLAY ARRAY g_sfde_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)

            BEFORE ROW
               CALL asft310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx = l_ac
               CALL asft310_b_fill2('5')

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               CALL asft310_idx_chk()
               LET g_current_page = 3

            #自訂ACTION(detail_show,page_3)


         END DISPLAY

         DISPLAY ARRAY g_sfdc4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)

            BEFORE ROW
               CALL asft310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               LET g_detail_idx = l_ac
               CALL asft310_b_fill2('6')

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail4")
               CALL asft310_idx_chk()
               LET g_current_page = 4
               CALL cl_set_act_visible("s_lot_sel,s_lot_sel1",TRUE) #add 150831

            #自訂ACTION(detail_show,page_4)

         END DISPLAY

         DISPLAY ARRAY g_sfdf_d TO s_detail5.* ATTRIBUTES(COUNT=g_rec_b)

            BEFORE ROW
               CALL asft310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail5")
               LET g_detail_idx2 = l_ac

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail5")
               CALL asft310_idx_chk()
               LET g_current_page = 5

            #自訂ACTION(detail_show,page_5)

         END DISPLAY

         DISPLAY ARRAY g_sfdd_d TO s_detail6.* ATTRIBUTES(COUNT=g_rec_b)
            ON ACTION s_lot_sel
               LET g_action_choice="s_lot_sel"
               IF cl_auth_chk_act("s_lot_sel") THEN
                  IF g_sfda_m.sfdastus <> 'Y' THEN
                     #该单据编号不是已确认状态，不可维护入库明细！
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ain-00024'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
            
                  #add 150921 下阶料报废的控管
                  IF g_sfda_m.sfda015 = '04' THEN #来源：工单在制下阶料报废，不能修改，在asft339中指定好了，保持一致
                     #本单据来源类型为%1，不可异动
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00696'
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     LET g_errparam.replace[1] = '04'
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
                  #add 150921
                  
                  IF cl_null(g_detail_idx2) OR g_detail_idx2 = 0 THEN
                     #未選擇資料,不可執行此操作;请选择一笔明细资料再执行此操作！
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00390'  #'abm-00073'单身缺少资料，不可维护！
                     LET g_errparam.extend = ""
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     EXIT DIALOG
                  END IF
            
                  IF NOT cl_null(g_sfdd_d[g_detail_idx2].sfddseq1) THEN
                     LET l_success = ''
                     CALL s_transaction_begin()
                     IF g_prog[1,6]='asft31' THEN
                        #发料出库
                        LET l_inao013 = -1
                     ELSE
                        LET l_inao013 = 1   #入库
                     END IF
                     #資料抓取來源'1'代表從現有的製造批序號庫存明細檔inai_t中抓出資料供挑選
                     #           '2'代表從單據對應的申請資料inao_t中抓取出資料供挑選
                     #    資料類型:1.申請資料， 2.實際異動資料
                     CALL s_lot_sel('2','2',
                                    #營運據點 目的單據編號
                                    g_site,g_sfda_m.sfdadocno,
                                    #目的單據項次                    目的單據項序(若單據沒有到項序層則此參數固定傳0)
                                    g_sfdc4_d[g_detail_idx].sfdcseq,'1',  #160411-00018#1 項序從'0'->'1'
                                    #料件編號                        產品特徵
                                    g_sfdd_d[g_detail_idx2].sfdd001,g_sfdd_d[g_detail_idx2].sfdd013,
                                    #庫存管理特徵                    庫位
                                    g_sfdd_d[g_detail_idx2].sfdd010,g_sfdd_d[g_detail_idx2].sfdd003,
                                    #儲位                           批號
                                    g_sfdd_d[g_detail_idx2].sfdd004,g_sfdd_d[g_detail_idx2].sfdd005,
                                    #交易單位                       交易數量
                                    g_sfdd_d[g_detail_idx2].sfdd006,g_sfdd_d[g_detail_idx2].sfdd007,
                                    #'-1出庫'  作業編號 營運據點
                                    l_inao013,g_prog,g_site,
                                    #来源單據編號       来源單據項次
                                    g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,
                                    #来源單據項序(若單據沒有到項序層則此參數固定傳0)  启用来源单据
                                    '0','1'
                                    )
                          RETURNING l_success
                     IF l_success THEN
                        CALL s_transaction_end('Y','0')
                     ELSE
                        CALL s_transaction_end('N','0')
                     END IF
                    #151217-00023#5 add -----(S)
                     IF asft310_ins_inao_2() THEN   
                     END IF
                     CALL asft310_b_fill_inao2()
                    #151217-00023#5 add -----(E)
                  END IF
                  EXIT DIALOG
               END IF
            
            BEFORE ROW
               CALL asft310_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail6")
               LET g_detail_idx2 = l_ac

            BEFORE DISPLAY
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               LET l_ac = DIALOG.getCurrentRow("s_detail6")
               CALL asft310_idx_chk()
               LET g_current_page = 6
               CALL cl_set_act_visible("s_lot_sel,s_lot_sel1",TRUE) #add 150831

            #自訂ACTION(detail_show,page_6)

         END DISPLAY

         #add 150831
         DISPLAY ARRAY g_inao_d2 TO s_detail7.* ATTRIBUTES(COUNT=g_rec_b)

            BEFORE ROW
               CALL asft310_idx_chk()
               #LET l_ac = DIALOG.getCurrentRow("s_detail7")
               #LET g_detail_idx = l_ac
               #CALL asft310_b_fill_inao2()
               
            BEFORE DISPLAY
               #CALL FGL_SET_ARR_CURR(g_detail_idx)
               #LET l_ac = DIALOG.getCurrentRow("s_detail7")  
               CALL cl_set_act_visible("s_lot_sel,s_lot_sel1",FALSE)
               CALL asft310_idx_chk()
               LET g_current_page = 7  


            #自訂ACTION(detail_show,page_7)

         END DISPLAY

         SUBDIALOG sub_s_lot.s_lot_display
         #add 150831 end

         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
         SUBDIALOG lib_cl_dlg.cl_dlg_relateapps

         BEFORE DIALOG
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_page = "first"
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               LET g_current_idx = g_current_row
            END IF
            LET g_current_row = g_current_idx #目前指標
            IF g_current_idx = 0 THEN
               LET g_current_idx = 1
            END IF
            LET g_current_sw = TRUE

            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF

            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL asft310_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL asft310_ui_detailshow() #Setting the current row

            #筆數顯示
            LET g_current_page = 1
            CALL asft310_idx_chk()

         #add 150831 --begin
         #ON ACTION bpage_1
         #   CALL cl_set_toolbaritem_visible("serialnum",FALSE)  #s_lot_sel
         #   
         #ON ACTION page_3
         #   CALL cl_set_toolbaritem_visible("serialnum",FALSE)  #s_lot_sel
         #   
         #ON ACTION page_4
         #   CALL cl_set_toolbaritem_visible("serialnum",FALSE)  #s_lot_sel
         #   
         #ON ACTION page_5  #发退料明细页签
         #   CALL cl_set_toolbaritem_visible("serialnum",TRUE)  #s_lot_sel
         #   
         #ON ACTION page_6
         #   CALL cl_set_toolbaritem_visible("serialnum",FALSE)  #s_lot_sel
         ON ACTION s_lot
            CALL cl_set_act_visible("s_lot_sel,s_lot_sel1",FALSE)
            IF g_prog[1,6]='asft31' THEN
               LET l_inao013 = -1  #出库
            ELSE
               LET l_inao013 = 1   #入库
            END IF
            IF NOT cl_null(g_detail_idx) AND g_detail_idx <> 0 THEN
               CALL s_lot_b_fill('2',g_site,'1',g_sfda_m.sfdadocno,'','',l_inao013)
            END IF
            #160408-00043#1-add-(S)
            IF g_inao_d.getLength() = 0 THEN
               DISPLAY 0 TO FORMONLY.idx 
            END IF   
            #160408-00043#1-add-(E)
            #LET lb_first = FALSE
         #add 150831 --end
         #160408-00043#1-add-(S)
         CALL cl_set_act_visible("s_lot_sel,s_lot_sel1",TRUE)  #161215-00020#1 add
         
         ON ACTION page_1
            LET g_current_page = 1
            CALL asft310_idx_chk()
         ON ACTION page_3
            LET g_current_page = 2
            CALL asft310_idx_chk()
            ON ACTION page_4
            LET g_current_page = 3
            CALL asft310_idx_chk()
         ON ACTION page_5
            LET g_current_page = 4
            CALL asft310_idx_chk()   
         ON ACTION page_7
            LET g_current_page = 7
            CALL asft310_idx_chk()
            
            
         #160408-00043#1-add-(E)
        #151217-00023#5 add -----(S)
         ON ACTION mdemand   #發料明細修改
            LET g_action_choice="mdemand"
            IF cl_auth_chk_act("mdemand") THEN
               LET g_mdemand = 'Y'
               CALL asft310_input('u')
               LET g_mdemand = 'N'
            END IF
        #151217-00023#5 add -----(E)

         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL asft310_statechange()
            CALL asft310_set_act_visible()     #151217-00023#5 add
            CALL asft310_set_act_no_visible()  #151217-00023#5 add
            #170217-00024#1-(S)-add
            IF NOT (g_sfda_m.sfdadocno IS NULL) THEN
               #組合條件
               LET g_add_browse = " sfdaent = '" ||g_enterprise|| "' AND",
				                      " sfdadocno = '", g_sfda_m.sfdadocno, "' "
               #填到對應位置
               CALL asft310_browser_fill("")
               CALL asft310_show()
            END IF
            #170217-00024#1-(E)-add
            #EXIT DIALOG   #170217-00024#1 mark
            

         #此段落由子樣板a32產生
         #簽核狀況
         ON ACTION bpm_status
            #查詢簽核狀況, 統一建立HyperLink
            CALL cl_bpm_status()
            #add-point:ON ACTION bpm_status
            
            #END add-point
            
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               #mod pattern 修改调整150624
               #LET g_wc = ls_wc
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
               INITIALIZE g_wc2_table3 TO NULL
               INITIALIZE g_wc2_table5 TO NULL
               INITIALIZE g_wc2_table6 TO NULL


               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "sfda_t"
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdb_t"
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdc_t"
                        LET g_wc2_table2 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfde_t"
                        LET g_wc2_table3 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdf_t"
                        LET g_wc2_table5 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdd_t"
                        LET g_wc2_table6 = la_wc[li_idx].wc


                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
                  OR NOT cl_null(g_wc2_table3)
                  OR NOT cl_null(g_wc2_table5)
                  OR NOT cl_null(g_wc2_table6)


                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
                  IF g_wc2_table5 <> " 1=1" AND NOT cl_null(g_wc2_table5) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table5
                  END IF
                  IF g_wc2_table6 <> " 1=1" AND NOT cl_null(g_wc2_table6) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table6
                  END IF


                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF

                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               #mod pattern 修改调整150624 end
               CALL asft310_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF

         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               #mod pattern 修改调整150624
               #LET g_wc = ls_wc
               ##取得條件後需要重查、跳到結果第一筆資料的功能程式段
               #CALL asft310_browser_fill("F")
               #IF g_browser_cnt = 0 THEN
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = "-100"
               #   LET g_errparam.extend = ""
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               #
               #   CLEAR FORM
               #ELSE
               #   CALL asft310_fetch("F")
               #END IF
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
               INITIALIZE g_wc2_table3 TO NULL
               INITIALIZE g_wc2_table5 TO NULL
               INITIALIZE g_wc2_table6 TO NULL
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "sfda_t"
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdb_t"
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdc_t"
                        LET g_wc2_table2 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfde_t"
                        LET g_wc2_table3 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdf_t"
                        LET g_wc2_table5 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfdd_t"
                        LET g_wc2_table6 = la_wc[li_idx].wc


                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
                  OR NOT cl_null(g_wc2_table3)
                  OR NOT cl_null(g_wc2_table5)
                  OR NOT cl_null(g_wc2_table6)


                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
                  IF g_wc2_table5 <> " 1=1" AND NOT cl_null(g_wc2_table5) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table5
                  END IF
                  IF g_wc2_table6 <> " 1=1" AND NOT cl_null(g_wc2_table6) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table6
                  END IF


                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL asft310_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = ""
                     LET g_errparam.code   = "-100"
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL asft310_fetch("F")
                  END IF
               END IF
               #mod pattern 修改调整150624 end
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()

         #ACTION表單列
         ON ACTION filter
            CALL asft310_filter()
            EXIT DIALOG

         ON ACTION first
            CALL asft310_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft310_idx_chk()

         ON ACTION previous
            CALL asft310_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft310_idx_chk()

         ON ACTION jump
            CALL asft310_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft310_idx_chk()

         ON ACTION next
            CALL asft310_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft310_idx_chk()

         ON ACTION last
            CALL asft310_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft310_idx_chk()

         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG

         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG

         ON ACTION mainhidden       #主頁摺疊
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF

         ON ACTION worksheethidden   #瀏覽頁折疊
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF

         ON ACTION controls      #單頭摺疊，可利用hot key "Ctrl-s"開啟/關閉單頭
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("worksheet_detail",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("worksheet_detail",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden
            END IF

         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL asft310_delete()
               #add-point:ON ACTION delete
               
               #END add-point
            END IF

         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL asft310_insert()
               #add-point:ON ACTION insert
               
               #END add-point
               EXIT DIALOG
            END IF

         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               CALL asft310_modify()
               #add-point:ON ACTION modify
               
               #END add-point
               EXIT DIALOG
            END IF

         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               CALL asft310_modify()
               #add-point:ON ACTION modify_detail
               
               #END add-point
               EXIT DIALOG
            END IF

         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               #add-point:ON ACTION output
               #MENU "" ATTRIBUTE (STYLE="popup", IMAGE="question")
               #   ON ACTION open_asfr310_g01
               #      CALL asfr310_g01("sfdaent ="|| g_enterprise ||" AND sfdadocno ='"|| g_sfda_m.sfdadocno||"'")
               #      EXIT MENU
               #
               #   ON ACTION open_asfr310_g02
               #      CALL asfr310_g02("sfdaent ="|| g_enterprise ||" AND sfdadocno ='"|| g_sfda_m.sfdadocno||"'")
               #      EXIT MENU
               #
               #   ON ACTION open_asfr310_g03
               #      CALL asfr310_g03("sfdaent ="|| g_enterprise ||" AND sfdadocno ='"|| g_sfda_m.sfdadocno||"'",'')
               #      EXIT MENU
               #
               #   ON ACTION open_asfr310_g04
               #      CALL asfr310_g04("sfdaent ="|| g_enterprise ||" AND sfdadocno ='"|| g_sfda_m.sfdadocno||"'",'')
               #      EXIT MENU
               #END MENU
               LET g_rep_wc = " sfdaent = '",g_enterprise,"' AND sfdadocno = '",g_sfda_m.sfdadocno,"' "
               &include "erp/asf/asft310_rep.4gl"
               #END add-point
               EXIT DIALOG
            END IF

         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL asft310_query()
               #add-point:ON ACTION query
               
               #END add-point

            END IF

         #ON ACTION reproduce
         #   LET g_action_choice="reproduce"
         #   IF cl_auth_chk_act("reproduce") THEN
         #      CALL asft310_reproduce()
         #      #add-point:ON ACTION reproduce
         #      
         #      #END add-point
         #      EXIT DIALOG
         #   END IF

         #調撥單產生
         ON ACTION gen_asfp370
            #LET g_action_choice="gen_asfp370"
            IF cl_auth_chk_act("gen_asfp370") THEN
               #add-point:ON ACTION gen_asfp370
               LET g_action_choice=""
               INITIALIZE la_param.* TO NULL
               LET la_param.prog = "asfp370"  #发料前调拨作业
               LET la_param.param[1] = g_sfda_m.sfdadocno
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun(ls_js) 
               #END add-point
               EXIT DIALOG
            END IF

         ##发/退料需求产生
         #ON ACTION gen_sfdc
         #   #LET g_action_choice="gen_sfdc"
         #   IF g_sfda_m.sfda002 != '11' AND g_sfda_m.sfda002 != '13' AND g_sfda_m.sfda002 != '21'  THEN
         #      #CALL cl_err('','asf-00169',1)
         #      INITIALIZE g_errparam TO NULL
         #      LET g_errparam.code = "asf-00169"
         #      LET g_errparam.extend = ""
         #      LET g_errparam.popup = TRUE
         #      CALL cl_err()
         #      EXIT DIALOG
         #   END IF
         #   SELECT COUNT(1) INTO l_cnt FROM sfdb_t
         #    WHERE sfdbent  = g_enterprise
         #      AND sfdbdocno= g_sfda_m.sfdadocno
         #   IF l_cnt = 0 THEN
         #      #CALL cl_err('','asf-00170',1)
         #      INITIALIZE g_errparam TO NULL
         #      LET g_errparam.code = "asf-00170"
         #      LET g_errparam.extend = ""
         #      LET g_errparam.popup = TRUE
         #      CALL cl_err()
         #      EXIT DIALOG
         #   END IF
         #   IF cl_auth_chk_act("gen_sfdc") THEN
         #      #add-point:ON ACTION serialnum
         #      IF asft310_01_cre_tmp_table() THEN
         #         CALL s_transaction_begin()
         #         CALL asft310_01(g_sfda_m.sfdadocno)
         #            RETURNING l_success
         #         IF l_success = TRUE THEN
         #            CALL s_transaction_end('Y','0')
         #         ELSE
         #            CALL s_transaction_end('N','0')
         #         END IF
         #         CALL asft310_01_drop_tmp_table()
         #      END IF
         #      #END add-point
         #      EXIT DIALOG
         #   END IF

         ##製造批序號維護
         #ON ACTION serialnum
         #   #LET g_action_choice="serialnum"
         #   IF cl_auth_chk_act("serialnum") THEN
         #      #add-point:ON ACTION serialnum
         #      #END add-point
         #      EXIT DIALOG
         #   END IF

         #+ 此段落由子樣板a46產生
         #新增相關文件
         ON ACTION related_document
            CALL asft310_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document

               #END add-point
               CALL cl_doc()
            END IF

         ON ACTION agendum
            CALL asft310_set_pk_array()
            #add-point:ON ACTION agendum

            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()

         ON ACTION exporttoexcel   #匯出excel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               CALL g_export_node.clear()
               LET g_export_node[1] = base.typeInfo.create(g_browser)
               LET g_export_id[1]   = "s_browse"
               LET g_export_node[2] = base.typeInfo.create(g_sfdb_d)
               LET g_export_id[2]   = "s_detail1"
               LET g_export_node[3] = base.typeInfo.create(g_sfdc_d)
               LET g_export_id[3]   = "s_detail2"
               LET g_export_node[4] = base.typeInfo.create(g_sfde_d)
               LET g_export_id[4]   = "s_detail3"
               LET g_export_node[5] = base.typeInfo.create(g_sfdf_d)
               LET g_export_id[5]   = "s_detail5"
               LET g_export_node[6] = base.typeInfo.create(g_sfdc4_d)
               LET g_export_id[6]   = "s_detail4"
               LET g_export_node[7] = base.typeInfo.create(g_sfdd_d)
               LET g_export_id[7]   = "s_detail6"
               #add 150831
               LET g_export_node[8] = base.typeInfo.create(g_inao_d)
               LET g_export_id[8]   = "s_detail1_s_lot_s01" 
               LET g_export_node[9] = base.typeInfo.create(g_inao_d2)
               LET g_export_id[9]   = "s_detail7"
               #add 150831
               CALL cl_export_to_excel_getpage()
               CALL cl_export_to_excel()
            END IF
            
         ON ACTION followup
            CALL asft310_set_pk_array()
            #add-point:ON ACTION followup

            #END add-point
            CALL cl_user_overview_follow(g_sfda_m.sfdadocdt)
         
         #主選單用ACTION
         &include "main_menu.4gl"
         #&include "main_menu_exit_dialog.4gl"   #mod 150416
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG

      END DIALOG

      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF

   END WHILE

   CALL cl_set_act_visible("accept,cancel", TRUE)

END FUNCTION

PRIVATE FUNCTION asft310_browser_search(p_type)
   {<Local define>}
   DEFINE p_type LIKE type_t.chr10
   {</Local define>}
   #add-point:browser_search段define
   
   #end add-point

   #若無輸入關鍵字則查找出所有資料
   IF NOT cl_null(g_searchstr) AND g_searchcol='0' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00005"
      LET g_errparam.extend = "searchcol"
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN FALSE
   END IF

   IF NOT cl_null(g_searchstr) THEN
      LET g_wc = " lower(", g_searchcol, ") LIKE '%", g_searchstr, "%'"
      LET g_wc = g_wc.toLowerCase()
   ELSE
      LET g_wc = " 1=1 "
   END IF

   #若為排序搜尋則添加以下條件
   IF cl_null(g_searchcol) OR g_searchcol = "0" THEN
      LET g_wc = g_wc, " ORDER BY sfdadocno"
   ELSE
      LET g_wc = g_wc, " ORDER BY ", g_searchcol
   END IF

   CALL asft310_browser_fill("F")
   CALL ui.Interface.refresh()
   RETURN TRUE

END FUNCTION

PRIVATE FUNCTION asft310_browser_fill(ps_page_action)
   {<Local define>}
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   DEFINE l_searchcol       STRING
   {</Local define>}

   #170217-00024#1-(S)-mark
   ##清除畫面
   #CLEAR FORM
   #INITIALIZE g_sfda_m.* TO NULL
   #CALL g_sfdb_d.clear()
   #CALL g_sfdc_d.clear()
   #CALL g_sfde_d.clear()
   #CALL g_sfdf_d.clear()
   #CALL g_sfdc4_d.clear()
   #CALL g_sfdd_d.clear()
   #CALL g_inao_d.clear()   #add 150831
   #CALL g_inao_d2.clear()   #add 150831
   #CALL g_browser.clear()
   #170217-00024#1-(E)-mark

   #搜尋用
   IF cl_null(g_searchcol) OR g_searchcol = '0' THEN
      LET l_searchcol = "sfdadocno"
   ELSE
      LET l_searchcol = g_searchcol
   END IF

   LET l_wc  = g_wc.trim()
   LET l_wc2 = g_wc2.trim()
   IF cl_null(l_wc) THEN  #p_wc 查詢條件
      RETURN
   ELSE
      #add 141104
      #160623-00014#1-mod-(S)
#      CASE g_prog
#         WHEN 'asft310'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
#         WHEN 'asft311'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11')"
#         WHEN 'asft312'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('12')"
#         WHEN 'asft313'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('13')"
#         WHEN 'asft314'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('14')"
#         WHEN 'asft315'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('15')"
#         WHEN 'asft320'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
#         WHEN 'asft321'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21')"
#         WHEN 'asft322'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('22')"
#         WHEN 'asft323'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('23')"
#         WHEN 'asft324'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('24')"
#         WHEN 'asft325'
#              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('25')"
#      END CASE
      CASE 
         WHEN g_prog MATCHES 'asft310'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
         WHEN g_prog MATCHES 'asft311'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11')"
         WHEN g_prog MATCHES 'asft312'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('12')"
         WHEN g_prog MATCHES 'asft313'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('13')"
         WHEN g_prog MATCHES 'asft314'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('14')"
         WHEN g_prog MATCHES 'asft315'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('15')"
         WHEN g_prog MATCHES 'asft320'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
         WHEN g_prog MATCHES 'asft321'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21')"
         WHEN g_prog MATCHES 'asft322'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('22')"
         WHEN g_prog MATCHES 'asft323'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('23')"
         WHEN g_prog MATCHES 'asft324'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('24')"
         WHEN g_prog MATCHES 'asft325'
              LET l_wc = l_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('25')"
      END CASE
      #160623-00014#1-mod-(E)
      #add 141104 end
   END IF

   IF l_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件
      #mod 150109
      #LET l_sub_sql = " SELECT UNIQUE sfdadocno ",
      #                  " FROM sfda_t ",
      #                        " LEFT JOIN sfdb_t ON sfdbent = sfdaent AND sfdbsite = sfdasite AND sfdadocno = sfdbdocno ",
      #                        " LEFT JOIN sfdc_t ON sfdcent = sfdaent AND sfdcsite = sfdasite AND sfdadocno = sfdcdocno",
      #                        " LEFT JOIN sfdd_t ON sfddent = sfdaent AND sfddsite = sfdasite AND sfdcdocno = sfdddocno AND sfdcseq = sfddseq",
      #                        " LEFT JOIN sfde_t ON sfdeent = sfdaent AND sfdesite = sfdasite AND sfdadocno = sfdedocno",
      #                        " LEFT JOIN sfdf_t ON sfdfent = sfdaent AND sfdfsite = sfdasite AND sfdedocno = sfdfdocno AND sfdeseq = sfdfseq",
      #                        #" LEFT JOIN inao_t ON inaoent = sfdaent AND inaosite = sfdasite AND sfdadocno = inaodocno",
      #                 #" WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND sfdbent = '" ||g_enterprise|| "' AND sfdbsite = '" ||g_site|| "' AND ",l_wc, " AND ", l_wc2
      #                  " WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND ",l_wc, " AND ", l_wc2

      LET l_sub_sql = " SELECT UNIQUE sfdadocno FROM sfda_t "
      IF l_wc2.getindexof('sfdb',1)>0 THEN
         LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfdb_t ON sfdbent = sfdaent AND sfdadocno = sfdbdocno "
      END IF
      IF l_wc2.getindexof('sfdc',1)>0 THEN
         LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfdc_t ON sfdcent = sfdaent AND sfdadocno = sfdcdocno "
      END IF
      IF l_wc2.getindexof('sfdd',1)>0 THEN
         #170209-00003#1-s
         #LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfdd_t ON sfddent = sfdaent AND sfdcdocno = sfdddocno AND sfdcseq = sfddseq "
         LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfdd_t ON sfddent = sfdaent AND sfdadocno = sfdddocno "
         #170209-00003#1-e
      END IF
      IF l_wc2.getindexof('sfde',1)>0 THEN
         LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfde_t ON sfdeent = sfdaent AND sfdadocno = sfdedocno "
      END IF
      IF l_wc2.getindexof('sfdf',1)>0 THEN
         #170209-00003#1-s
         #LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfdf_t ON sfdfent = sfdaent AND sfdedocno = sfdfdocno AND sfdeseq = sfdfseq "
         LET l_sub_sql = l_sub_sql CLIPPED," LEFT JOIN sfdf_t ON sfdfent = sfdaent AND sfdadocno = sfdfdocno "
         #170209-00003#1-e
      END IF
      LET l_sub_sql = l_sub_sql CLIPPED," WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND ",l_wc, " AND ", l_wc2
                    , cl_sql_add_filter("sfda_t")   #161214-00062#1 add
      #mod 150109
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT UNIQUE sfdadocno ",
                        " FROM sfda_t ",
                        "WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND ",l_wc CLIPPED
                        , cl_sql_add_filter("sfda_t")   #161214-00062#1 add

   END IF
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   PREPARE header_cnt_pre FROM g_sql
   EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
   FREE header_cnt_pre

   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示

   #170217-00024#1-(S)-add
   #DISPLAY 'g_browser_cnt=',g_browser_cnt   
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN    
      #清除畫面
      CLEAR FORM
      INITIALIZE g_sfda_m.* TO NULL
      CALL g_sfdb_d.clear()
      CALL g_sfdc_d.clear()
      CALL g_sfde_d.clear()
      CALL g_sfdf_d.clear()
      CALL g_sfdc4_d.clear()
      CALL g_sfdd_d.clear()
      CALL g_inao_d.clear()   #add 150831
      CALL g_inao_d2.clear()   #add 150831
      CALL g_browser.clear()
    		 
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1"
      LET g_cnt = g_current_idx
   END IF
    
   #170217-00024#1-(E)-add
   
   #LET g_page_action = ps_page_action          # Keep Action

   IF ps_page_action = "F" OR
      ps_page_action = "P" OR
      ps_page_action = "N" OR
      ps_page_action = "L" THEN
      LET g_page_action = ps_page_action
   END IF

   CASE ps_page_action
      WHEN "F"
         LET g_pagestart = 1

      WHEN "P"
         LET g_pagestart = g_pagestart - g_max_browse
         IF g_pagestart < 1 THEN
            LET g_pagestart = 1
         END IF

      WHEN "N"
         LET g_pagestart = g_pagestart + g_max_browse
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
            WHILE g_pagestart > g_browser_cnt
               LET g_pagestart = g_pagestart - g_max_browse
            END WHILE
         END IF

      WHEN "L"
         LET g_pagestart = g_browser_cnt - (g_browser_cnt mod g_max_browse) + 1
         WHILE g_pagestart > g_browser_cnt
            LET g_pagestart = g_pagestart - g_max_browse
         END WHILE

      WHEN '/'
         LET g_pagestart = g_jump
         IF g_pagestart > g_browser_cnt THEN
            LET g_pagestart = 1
         END IF

   END CASE

   #單身有輸入查詢條件且非null
   IF l_wc2 <> " 1=1" AND NOT cl_null(l_wc2) THEN
      #依照sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,'',sfda004,'',sfda005 Browser欄位定義(取代原本bs_sql功能)
      #mod 150109
      #LET l_sql_rank = "SELECT DISTINCT sfdastus,sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,'',sfda004,
      #    '',sfda005,DENSE_RANK() OVER(ORDER BY sfdadocno ",g_order,") AS RANK ",
      #                  " FROM sfda_t ",
      #                        " LEFT JOIN sfdb_t ON sfdbent = sfdaent AND sfdbsite = sfdasite AND sfdadocno = sfdbdocno ",
      #                        " LEFT JOIN sfdc_t ON sfdcent = sfdaent AND sfdcsite = sfdasite AND sfdadocno = sfdcdocno",
      #                        " LEFT JOIN sfde_t ON sfdeent = sfdaent AND sfdesite = sfdasite AND sfdadocno = sfdedocno",
      #                        " LEFT JOIN inao_t ON inaoent = sfdaent AND inaosite = sfdasite AND sfdadocno = inaodocno",
      #                        " LEFT JOIN sfdf_t ON sfdfent = sfdaent AND sfdfsite = sfdasite AND sfdedocno = sfdfdocno AND sfdeseq = sfdfseq",
      #                        " LEFT JOIN sfdd_t ON sfddent = sfdaent AND sfddsite = sfdasite AND sfdcdocno = sfdddocno AND sfdcseq = sfddseq",
      #                 " WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND ",l_wc," AND ",l_wc2
      LET l_sql_rank = "SELECT DISTINCT sfdastus,sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,'',sfda004,
          '',sfda005,DENSE_RANK() OVER(ORDER BY sfdadocno ",g_order,") AS RANK ",
                        " FROM sfda_t "
      IF l_wc2.getindexof('sfdb',1)>0 THEN
         LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfdb_t ON sfdbent = sfdaent AND sfdadocno = sfdbdocno "
      END IF
      IF l_wc2.getindexof('sfdc',1)>0 THEN
         LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfdc_t ON sfdcent = sfdaent AND sfdadocno = sfdcdocno "
      END IF
      IF l_wc2.getindexof('sfdd',1)>0 THEN
         #170209-00003#1-s
         #LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfdd_t ON sfddent = sfdaent AND sfdcdocno = sfdddocno AND sfdcseq = sfddseq "
         LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfdd_t ON sfddent = sfdaent AND sfdadocno = sfdddocno "
         #170209-00003#1-e
      END IF
      IF l_wc2.getindexof('sfde',1)>0 THEN
         LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfde_t ON sfdeent = sfdaent AND sfdadocno = sfdedocno "
      END IF
      IF l_wc2.getindexof('sfdf',1)>0 THEN
         #170209-00003#1-s
         #LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfdf_t ON sfdfent = sfdaent AND sfdedocno = sfdfdocno AND sfdeseq = sfdfseq "
         LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN sfdf_t ON sfdfent = sfdaent AND sfdadocno = sfdfdocno "
         #170209-00003#1-e
      END IF
      IF l_wc2.getindexof('inao',1)>0 THEN
         LET l_sql_rank = l_sql_rank CLIPPED," LEFT JOIN inao_t ON inaoent = sfdaent AND sfdadocno = inaodocno "
      END IF
      LET l_sql_rank = l_sql_rank CLIPPED," WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND ",l_wc, " AND ", l_wc2
                       , cl_sql_add_filter("sfda_t")   #161214-00062#1 add
      #mod 150109
   ELSE
      #單身無輸入資料
      LET l_sql_rank = "SELECT DISTINCT sfdastus,sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,'',sfda004,
          '',sfda005,DENSE_RANK() OVER(ORDER BY sfdadocno ",g_order,") AS RANK ",
                       " FROM sfda_t ",
                       " WHERE sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND ", l_wc
                       , cl_sql_add_filter("sfda_t")   #161214-00062#1 add
   END IF

   #定義翻頁CURSOR
   LET g_sql= "SELECT sfdastus,sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,'',sfda004,'',sfda005 FROM (",
       l_sql_rank,") WHERE ",
              " RANK >= ",1," AND RANK<",1+g_max_browse,
              " ORDER BY ",l_searchcol," ",g_order

   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料  #160731-00253#1
   PREPARE browse_pre FROM g_sql
   DECLARE browse_cur CURSOR FOR browse_pre

   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示  #170217-00024#1 add
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示  #170217-00024#1 add
   
  #CALL g_browser.clear()   #170217-00024#1 mark
  #LET g_cnt = 1            #170217-00024#1 mark
   FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_sfdadocno,g_browser[g_cnt].b_sfdadocdt,
       g_browser[g_cnt].b_sfda001,g_browser[g_cnt].b_sfda002,g_browser[g_cnt].b_sfda003,g_browser[g_cnt].b_sfda003_desc,
       g_browser[g_cnt].b_sfda004,g_browser[g_cnt].b_sfda004_desc,g_browser[g_cnt].b_sfda005
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF


      #人员姓名
      CALL s_desc_get_person_desc(g_browser[g_cnt].b_sfda004) RETURNING g_browser[g_cnt].b_sfda004_desc

      #add-point:browser_fill段reference
      #部门
      CALL asft310_sfda003_ref(g_browser[g_cnt].b_sfda003) RETURNING g_browser[g_cnt].b_sfda003_desc  #160914-00019#1
      #end add-point

      #此段落由子樣板a24產生
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/open.png"  #unconfirmed
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/invalid.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         WHEN "S"
            LET g_browser[g_cnt].b_statepic = "stus/16/posted.png"


		 #此段落由子樣板a33產生
         WHEN "W"
            LET g_browser[g_cnt].b_statepic = "stus/16/signing.png"
         WHEN "A"
            LET g_browser[g_cnt].b_statepic = "stus/16/approved.png"
         WHEN "D"
            LET g_browser[g_cnt].b_statepic = "stus/16/withdraw.png"
         WHEN "R"
            LET g_browser[g_cnt].b_statepic = "stus/16/rejection.png"


      END CASE


      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9035
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT FOREACH
      END IF

   END FOREACH
   
   #170217-00024#1-(S)-add
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   IF cl_null(g_browser[g_cnt].b_sfdadocno) THEN 
      CALL g_browser.deleteElement(g_cnt)
   END IF 
   #170217-00024#1-(E)-add   
   #CALL g_browser.deleteElement(g_cnt)   #170217-00024#1 mark
   
   LET g_header_cnt = g_browser.getLength()
   #170217-00024#1-(S)-add
    LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
   #170217-00024#1-(E)-add
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0

   FREE browse_pre

   #add-point:browser_fill段結束前
   
   #end add-point

   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", FALSE)
   ELSE
      CALL cl_set_act_visible("statechange,modify,delete,reproduce", TRUE)
   END IF

END FUNCTION

PRIVATE FUNCTION asft310_ui_headershow()
   #add-point:ui_headershow段define
   
   #end add-point

   LET g_sfda_m.sfdadocno = g_browser[g_current_idx].b_sfdadocno

    SELECT UNIQUE sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,sfdaownid,sfdaowndp,
        sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,sfdapstid,sfdapstdt
 INTO g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda004,
     g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,
     g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,
     g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt
 FROM sfda_t
 WHERE sfdaent = g_enterprise AND sfdasite = g_site AND sfdadocno = g_sfda_m.sfdadocno
   CALL asft310_show()

END FUNCTION

PRIVATE FUNCTION asft310_ui_detailshow()
   #add-point:ui_detailshow段define
   
   #end add-point

   #add-point:ui_detailshow段before
   
   #end add-point

   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)

      CALL g_curr_diag.setCurrentRow("s_detail3",g_detail_idx)

      CALL g_curr_diag.setCurrentRow("s_detail4",g_detail_idx)

      CALL g_curr_diag.setCurrentRow("s_detail5",g_detail_idx)

      CALL g_curr_diag.setCurrentRow("s_detail6",g_detail_idx)

      CALL g_curr_diag.setCurrentRow("s_detail7",g_detail_idx)


   END IF

   #add-point:ui_detailshow段after
   
   #end add-point

END FUNCTION

PRIVATE FUNCTION asft310_ui_browser_refresh()
   {<Local define>}
   DEFINE l_i  LIKE type_t.num10
   {</Local define>}
   #add-point:ui_browser_refresh段define
   
   #end add-point

   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_sfdadocno = g_sfda_m.sfdadocno

         THEN
         CALL g_browser.deleteElement(l_i)
         LET g_header_cnt = g_header_cnt - 1
      END IF
   END FOR

   LET g_browser_cnt = g_browser_cnt - 1
   IF g_current_row > g_browser_cnt THEN        #確定browse 筆數指在同一筆
      LET g_current_row = g_browser_cnt
   END IF

   #DISPLAY g_browser_cnt TO FORMONLY.b_count    #總筆數的顯示

END FUNCTION

PRIVATE FUNCTION asft310_construct()
   {<Local define>}
   DEFINE lc_qbe_sn   LIKE type_t.num10
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING
   {</Local define>}
   #add-point:cs段define
   
   #end add-point

   #清除畫面
   CLEAR FORM
   INITIALIZE g_sfda_m.* TO NULL
   CALL g_sfdb_d.clear()
   CALL g_sfdc_d.clear()

   CALL g_sfde_d.clear()
   CALL g_sfdf_d.clear()

   CALL g_sfdc4_d.clear()
   CALL g_sfdd_d.clear()

   CALL g_inao_d.clear()   #add 150831
   CALL g_inao_d2.clear()   #add 150831

   LET g_action_choice = ""

   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc2_table2 TO NULL
   INITIALIZE g_wc2_table3 TO NULL
   INITIALIZE g_wc2_table5 TO NULL
   INITIALIZE g_wc2_table6 TO NULL

   LET g_qryparam.state = 'c'

   #add-point:cs段開始前
   
   #end add-point

   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭
      CONSTRUCT BY NAME g_wc ON sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,
          sfdaownid,sfdaowndp,sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,
          sfdapstid,sfdapstdt

         BEFORE CONSTRUCT
#saki            CALL cl_qbe_init()

         ##----<<sfdacrtdt>>----
         AFTER FIELD sfdacrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<sfdamoddt>>----
         AFTER FIELD sfdamoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<sfdacnfdt>>----
         AFTER FIELD sfdacnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #----<<sfdapstdt>>----
         AFTER FIELD sfdapstdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         ON ACTION controlp INFIELD sfdadocno
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #160623-00014#1-mod-(S)
#            CASE g_prog
#               WHEN 'asft310'
#                    LET g_qryparam.where = " sfda002 in ('11','12','13','14','15')"
#               WHEN 'asft311'
#                    LET g_qryparam.where = " sfda002 in ('11')"
#               WHEN 'asft312'
#                    LET g_qryparam.where = " sfda002 in ('12')"
#               WHEN 'asft313'
#                    LET g_qryparam.where = " sfda002 in ('13')"
#               WHEN 'asft314'
#                    LET g_qryparam.where = " sfda002 in ('14')"
#               WHEN 'asft315'
#                    LET g_qryparam.where = " sfda002 in ('15')"
#               WHEN 'asft320'
#                    LET g_qryparam.where = " sfda002 in ('21','22','23','24','25')"
#               WHEN 'asft321'
#                    LET g_qryparam.where = " sfda002 in ('21')"
#               WHEN 'asft322'
#                    LET g_qryparam.where = " sfda002 in ('22')"
#               WHEN 'asft323'
#                    LET g_qryparam.where = " sfda002 in ('23')"
#               WHEN 'asft324'
#                    LET g_qryparam.where = " sfda002 in ('24')"
#               WHEN 'asft325'
#                    LET g_qryparam.where = " sfda002 in ('25')"
#            END CASE        
           CASE 
               WHEN g_prog MATCHES 'asft310'
                    LET g_qryparam.where = " sfda002 in ('11','12','13','14','15')"
               WHEN g_prog MATCHES 'asft311'
                    LET g_qryparam.where = " sfda002 in ('11')"
               WHEN g_prog MATCHES 'asft312'
                    LET g_qryparam.where = " sfda002 in ('12')"
               WHEN g_prog MATCHES 'asft313'
                    LET g_qryparam.where = " sfda002 in ('13')"
               WHEN g_prog MATCHES 'asft314'
                    LET g_qryparam.where = " sfda002 in ('14')"
               WHEN g_prog MATCHES 'asft315'
                    LET g_qryparam.where = " sfda002 in ('15')"
               WHEN g_prog MATCHES 'asft320'
                    LET g_qryparam.where = " sfda002 in ('21','22','23','24','25')"
               WHEN g_prog MATCHES 'asft321'
                    LET g_qryparam.where = " sfda002 in ('21')"
               WHEN g_prog MATCHES 'asft322'
                    LET g_qryparam.where = " sfda002 in ('22')"
               WHEN g_prog MATCHES 'asft323'
                    LET g_qryparam.where = " sfda002 in ('23')"
               WHEN g_prog MATCHES 'asft324'
                    LET g_qryparam.where = " sfda002 in ('24')"
               WHEN g_prog MATCHES 'asft325'
                    LET g_qryparam.where = " sfda002 in ('25')"
            END CASE 
           #160623-00014#1-mod-(E) 
            CALL q_sfdadocno3()               #呼叫開窗 #製程中委外時，部门顯示名稱為委外廠商
            DISPLAY g_qryparam.return1 TO sfdadocno  #顯示到畫面上
            NEXT FIELD sfdadocno                     #返回原欄位

         ON ACTION controlp INFIELD sfda003
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_site
            #160623-00014#1-mod-(S)
#            CASE g_prog
#               WHEN 'asft310'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
#               WHEN 'asft311'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('11')"
#               WHEN 'asft312'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('12')"
#               WHEN 'asft313'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('13')"
#               WHEN 'asft314'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('14')"
#               WHEN 'asft315'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('15')"
#               WHEN 'asft320'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
#               WHEN 'asft321'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('21')"
#               WHEN 'asft322'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('22')"
#               WHEN 'asft323'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('23')"
#               WHEN 'asft324'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('24')"
#               WHEN 'asft325'
#                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('25')"
#            END CASE
            CASE 
               WHEN g_prog MATCHES 'asft310'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
               WHEN g_prog MATCHES 'asft311'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('11')"
               WHEN g_prog MATCHES 'asft312'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('12')"
               WHEN g_prog MATCHES 'asft313'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('13')"
               WHEN g_prog MATCHES 'asft314'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('14')"
               WHEN g_prog MATCHES 'asft315'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('15')"
               WHEN g_prog MATCHES 'asft320'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
               WHEN g_prog MATCHES 'asft321'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('21')"
               WHEN g_prog MATCHES 'asft322'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('22')"
               WHEN g_prog MATCHES 'asft323'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('23')"
               WHEN g_prog MATCHES 'asft324'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('24')"
               WHEN g_prog MATCHES 'asft325'
                    LET g_qryparam.where = " sfdasite ='",g_site,"' AND sfda002 in ('25')"
            END CASE
            #160623-00014#1-mod-(E)
            CALL q_sfda003()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfda003  #顯示到畫面上
            NEXT FIELD sfda003                     #返回原欄位

         ON ACTION controlp INFIELD sfda004
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001_2()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfda004  #顯示到畫面上
            NEXT FIELD sfda004                     #返回原欄位

         ON ACTION controlp INFIELD sfda005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_sfda005()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfda005  #顯示到畫面上
            NEXT FIELD sfda005

         ON ACTION controlp INFIELD sfda014 #来源单号
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_sfda014()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfda014  #顯示到畫面上
            NEXT FIELD sfda014                     #返回原欄位

         ON ACTION controlp INFIELD sfdaownid
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdaownid  #顯示到畫面上
            NEXT FIELD sfdaownid                     #返回原欄位

         ON ACTION controlp INFIELD sfdaowndp
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdaowndp  #顯示到畫面上
            NEXT FIELD sfdaowndp                     #返回原欄位

         ON ACTION controlp INFIELD sfdacrtid
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdacrtid  #顯示到畫面上
            NEXT FIELD sfdacrtid                     #返回原欄位

         ON ACTION controlp INFIELD sfdacrtdp
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooea001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdacrtdp  #顯示到畫面上
            NEXT FIELD sfdacrtdp                     #返回原欄位

         ON ACTION controlp INFIELD sfdamodid
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdamodid  #顯示到畫面上
            NEXT FIELD sfdamodid                     #返回原欄位

         ON ACTION controlp INFIELD sfdacnfid
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdacnfid  #顯示到畫面上
            NEXT FIELD sfdacnfid                     #返回原欄位

         ON ACTION controlp INFIELD sfdapstid
            #開窗c段
			INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO sfdapstid  #顯示到畫面上
            NEXT FIELD sfdapstid                     #返回原欄位

      END CONSTRUCT

      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON sfdb001,sfdb002,sfdb003,sfdb004,sfdb005,sfdb006,sfdb007,sfdb008
           FROM s_detail1[1].sfdb001,s_detail1[1].sfdb002,s_detail1[1].sfdb003,s_detail1[1].sfdb004,
               s_detail1[1].sfdb005,s_detail1[1].sfdb006,s_detail1[1].sfdb007,s_detail1[1].sfdb008

         BEFORE CONSTRUCT
#saki            CALL cl_qbe_display_condition(lc_qbe_sn)

         ON ACTION controlp INFIELD sfdb001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite ='",g_site,"' "
            CALL q_sfaadocno_3()
            DISPLAY g_qryparam.return1 TO sfdb001
            NEXT FIELD sfdb001                     #返回原欄位

         ON ACTION controlp INFIELD sfdb003 #部位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "215"
            CALL q_oocq002_4()
            DISPLAY g_qryparam.return1 TO sfdb003
            NEXT FIELD sfdb003                     #返回原欄位

         ON ACTION controlp INFIELD sfdb004  #作业
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "221"
            CALL q_oocq002_4()
            DISPLAY g_qryparam.return1 TO sfdb004
            NEXT FIELD sfdb004                     #返回原欄位

         ON ACTION controlp INFIELD sfdb005 #作业序
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            CALL q_sfdb005()
            DISPLAY g_qryparam.return1 TO sfdb005
            NEXT FIELD sfdb005                     #返回原欄位
      END CONSTRUCT

      CONSTRUCT g_wc2_table2 ON sfdcseq,sfdc001,sfdc002,sfdc003,
                                --sfba002,sfba003,sfba004,
                                sfdc004,sfdc005,
                                --imaf034,imae092,sfba028,
                                sfdc006,
                                --sfba013,
                                sfdc007,sfdc008,
                                sfdc009,sfdc010,sfdc011,sfdc012,
                                sfdc013,sfdc014,sfdc016,sfdc015,
                                sfdc017
           FROM s_detail2[1].sfdcseq,s_detail2[1].sfdc001,s_detail2[1].sfdc002,s_detail2[1].sfdc003,
                --s_detail2[1].sfba002,s_detail2[1].sfba003,s_detail2[1].sfba004,
                s_detail2[1].sfdc004,s_detail2[1].sfdc005,
                --s_detail2[1].imaf034,s_detail2[1].imae092,s_detail2[1].sfba028,
                s_detail2[1].sfdc006,
                --s_detail2[1].sfba013,
                s_detail2[1].sfdc007,s_detail2[1].sfdc008,
                s_detail2[1].sfdc009,s_detail2[1].sfdc010,s_detail2[1].sfdc011,s_detail2[1].sfdc012,
                s_detail2[1].sfdc013,s_detail2[1].sfdc014,s_detail2[1].sfdc016,s_detail2[1].sfdc015,
                s_detail2[1].sfdc017

         BEFORE CONSTRUCT
#saki       CALL cl_qbe_display_condition(lc_qbe_sn)

         ON ACTION controlp INFIELD sfdc001
            #工单单号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfbasite ='",g_site,"' "
            CALL q_sfba001()
            DISPLAY g_qryparam.return1 TO sfdc001
            NEXT FIELD sfdc001                     #返回原欄位 

#         ON ACTION controlp INFIELD sfba002
#         ON ACTION controlp INFIELD sfba003
#         ON ACTION controlp INFIELD sfba004

         ON ACTION controlp INFIELD sfdc004
            #需求料号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc004()
            DISPLAY g_qryparam.return1 TO sfdc004
            NEXT FIELD sfdc004                     #返回原欄位

         ON ACTION controlp INFIELD sfdc005
            #特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc005()
            DISPLAY g_qryparam.return1 TO sfdc005
            NEXT FIELD sfdc005                     #返回原欄位

         ON ACTION controlp INFIELD sfdc006
            #单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc006()
            DISPLAY g_qryparam.return1 TO sfdc006
            NEXT FIELD sfdc006                     #返回原欄位

         ON ACTION controlp INFIELD sfdc009
            #单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc009()
            DISPLAY g_qryparam.return1 TO sfdc009
            NEXT FIELD sfdc009                     #返回原欄位

         ON ACTION controlp INFIELD sfdc012
            #库位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc012()
            DISPLAY g_qryparam.return1 TO sfdc012
            NEXT FIELD sfdc012                     #返回原欄位

         ON ACTION controlp INFIELD sfdc013
            #储位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc013()
            DISPLAY g_qryparam.return1 TO sfdc013
            NEXT FIELD sfdc013                     #返回原欄位

         ON ACTION controlp INFIELD sfdc014
            #批号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc014()
            DISPLAY g_qryparam.return1 TO sfdc014
            NEXT FIELD sfdc014                     #返回原欄位

         ON ACTION controlp INFIELD sfdc016
            #库存管理特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc016()
            DISPLAY g_qryparam.return1 TO sfdc016
            NEXT FIELD sfdc016                     #返回原欄位

         ON ACTION controlp INFIELD sfdc015
            #理由码
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdcsite ='",g_site,"' "
            CALL q_sfdc015()
            DISPLAY g_qryparam.return1 TO sfdc015
            NEXT FIELD sfdc015                     #返回原欄位

      END CONSTRUCT

      CONSTRUCT g_wc2_table3 ON sfdeseq,sfde001,sfde002,sfde009,
                                sfde003,sfde004,sfde005,sfde006,
                                sfde007,sfde008,sfde010
           FROM s_detail3[1].sfdeseq,s_detail3[1].sfde001,s_detail3[1].sfde002,s_detail3[1].sfde009,
                s_detail3[1].sfde003,s_detail3[1].sfde004,s_detail3[1].sfde005,s_detail3[1].sfde006,
                s_detail3[1].sfde007,s_detail3[1].sfde008,s_detail3[1].sfde010

         BEFORE CONSTRUCT
#saki            CALL cl_qbe_display_condition(lc_qbe_sn)


         ON ACTION controlp INFIELD sfde001
            #需求料号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdesite ='",g_site,"' "
            CALL q_sfde001()
            DISPLAY g_qryparam.return1 TO sfde001
            NEXT FIELD sfde001                     #返回原欄位

         ON ACTION controlp INFIELD sfde002
            #特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdesite ='",g_site,"' "
            CALL q_sfde002()
            DISPLAY g_qryparam.return1 TO sfde002
            NEXT FIELD sfde002                     #返回原欄位

         ON ACTION controlp INFIELD sfde003
            #单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdesite ='",g_site,"' "
            CALL q_sfde003()
            DISPLAY g_qryparam.return1 TO sfde003

         ON ACTION controlp INFIELD sfde006
            #参考单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdesite ='",g_site,"' "
            CALL q_sfde006()
            DISPLAY g_qryparam.return1 TO sfde006
            NEXT FIELD sfde006                     #返回原欄位

      END CONSTRUCT

      CONSTRUCT g_wc2_table5 ON sfdfseq1,sfdf001,sfdf013,sfdf002,
                                sfdf003,
                                sfdf004,sfdf005,sfdf010,sfdf006,
                                sfdf007,sfdf008,sfdf009,sfdf011,
                                sfdf012
           FROM s_detail5[1].sfdfseq1,s_detail5[1].sfdf001,s_detail5[1].sfdf013,s_detail5[1].sfdf002,
                s_detail5[1].sfdf003,
                s_detail5[1].sfdf004,s_detail5[1].sfdf005,s_detail5[1].sfdf010,s_detail5[1].sfdf006,
                s_detail5[1].sfdf007,s_detail5[1].sfdf008,s_detail5[1].sfdf009,s_detail5[1].sfdf011,
                s_detail5[1].sfdf012

         BEFORE CONSTRUCT


         ON ACTION controlp INFIELD sfdf001
            #发料料号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf001()
            DISPLAY g_qryparam.return1 TO sfdf001
            NEXT FIELD sfdf001                     #返回原欄位 

         ON ACTION controlp INFIELD sfdf013
            #产品特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf013()
            DISPLAY g_qryparam.return1 TO sfdf013
            NEXT FIELD sfdf013                     #返回原欄位 

         ON ACTION controlp INFIELD sfdf003
            #库位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf003()
            DISPLAY g_qryparam.return1 TO sfdf003
            NEXT FIELD sfdf003                    #返回原欄位 

         ON ACTION controlp INFIELD sfdf004
            #储位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf004()
            DISPLAY g_qryparam.return1 TO sfdf004
            NEXT FIELD sfdf004                    #返回原欄位

         ON ACTION controlp INFIELD sfdf005
            #批号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf005()
            DISPLAY g_qryparam.return1 TO sfdf005
            NEXT FIELD sfdf005                    #返回原欄位

         ON ACTION controlp INFIELD sfdf010
            #库存管理特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf010()
            DISPLAY g_qryparam.return1 TO sfdf010
            NEXT FIELD sfdf010                    #返回原欄位

         ON ACTION controlp INFIELD sfdf006
            #单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf006()
            DISPLAY g_qryparam.return1 TO sfdf006
            NEXT FIELD sfdf006                    #返回原欄位

         ON ACTION controlp INFIELD sfdf008
            #add-point:ON ACTION controlp INFIELD sfdf008
            #参考单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf008()
            DISPLAY g_qryparam.return1 TO sfdf008
            NEXT FIELD sfdf008                    #返回原欄位

         ON ACTION controlp INFIELD sfdf011
            #包装容器
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfdfsite ='",g_site,"' "
            CALL q_sfdf011()
            DISPLAY g_qryparam.return1 TO sfdf011
            NEXT FIELD sfdf011                    #返回原欄位 

#         ON ACTION controlp INFIELD sfdf012

      END CONSTRUCT

      CONSTRUCT g_wc2_table6 ON sfddseq1,sfdd001,sfdd013,sfdd002,sfdd003,
                                sfdd004,sfdd005,sfdd010,sfdd006,
                                sfdd007,sfdd008,sfdd009,sfdd011,
                                sfdd012
           FROM s_detail6[1].sfddseq1,s_detail6[1].sfdd001,s_detail6[1].sfdd013,s_detail6[1].sfdd002,s_detail6[1].sfdd003,
                s_detail6[1].sfdd004,s_detail6[1].sfdd005,s_detail6[1].sfdd010,s_detail6[1].sfdd006,
                s_detail6[1].sfdd007,s_detail6[1].sfdd008,s_detail6[1].sfdd009,s_detail6[1].sfdd011,
                s_detail6[1].sfdd012

         BEFORE CONSTRUCT

         ON ACTION controlp INFIELD sfdd001
            #发料料号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd001()
            DISPLAY g_qryparam.return1 TO sfdd001
            NEXT FIELD sfdd001                    #返回原欄位 
            
         ON ACTION controlp INFIELD sfdd013
            #产品特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd013()
            DISPLAY g_qryparam.return1 TO sfdd013
            NEXT FIELD sfdd013                     #返回原欄位 

         ON ACTION controlp INFIELD sfdd003
            #库位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd003()
            DISPLAY g_qryparam.return1 TO sfdd003
            NEXT FIELD sfdd003                    #返回原欄位 
            
         ON ACTION controlp INFIELD sfdd004
            #储位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd004()
            DISPLAY g_qryparam.return1 TO sfdd004
            NEXT FIELD sfdd004                    #返回原欄位
            
         ON ACTION controlp INFIELD sfdd005
            #批号
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd005()
            DISPLAY g_qryparam.return1 TO sfdd005
            NEXT FIELD sfdd005                    #返回原欄位 
            
         ON ACTION controlp INFIELD sfdd010
            #库存管理特征
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd010()
            DISPLAY g_qryparam.return1 TO sfdd010
            NEXT FIELD sfdd010                    #返回原欄位 
            
         ON ACTION controlp INFIELD sfdd006
            #单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd006()
            DISPLAY g_qryparam.return1 TO sfdd006
            NEXT FIELD sfdd006                    #返回原欄位 
            
         ON ACTION controlp INFIELD sfdd008
            #参考单位
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd008()
            DISPLAY g_qryparam.return1 TO sfdd008
            NEXT FIELD sfdd008                    #返回原欄位 
            
         ON ACTION controlp INFIELD sfdd011
            #包装容器
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "c"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfddsite ='",g_site,"' "
            CALL q_sfdd011()
            DISPLAY g_qryparam.return1 TO sfdd011
            NEXT FIELD sfdd011                    #返回原欄位

      END CONSTRUCT

      #inao也可以下查询条件的，先跟全局接轨，不下条件
      #CONSTRUCT g_wc2_table7 ON inaoseq,inaoseq1,inaoseq2,inao000,
      #                          inao001,inao008,inao009,inao010,
      #                          inao012
      #     FROM s_detail7[1].inaoseq,s_detail7[1].inaoseq1,s_detail7[1].inaoseq2,s_detail7[1].inao000,
      #          s_detail6[1].inao001,s_detail6[1].inao008,s_detail6[1].inao009,s_detail6[1].inao010,
      #          s_detail7[1].inao012
      #
      #   BEFORE CONSTRUCT
      #
      #   ON ACTION controlp INFIELD inao001
      #      #发料料号
      #      INITIALIZE g_qryparam.* TO NULL
      #      LET g_qryparam.state = "c"
      #      LET g_qryparam.reqry = FALSE
      #      LET g_qryparam.where = " inaosite ='",g_site,"' "
      #      CALL q_inao001()
      #      DISPLAY g_qryparam.return1 TO inao001
      #      NEXT FIELD inao001                    #返回原欄位 
      #END CONSTRUCT

      BEFORE DIALOG


      ON ACTION qbe_select     #條件查詢
#saki         CALL cl_qbe_list() RETURNING lc_qbe_sn
#saki         CALL cl_qbe_display_condition(lc_qbe_sn)

      ON ACTION qbe_save       #條件儲存
#saki         CALL cl_qbe_save()

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   END DIALOG

   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   IF g_wc2_table2 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
   END IF

   IF g_wc2_table3 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
   END IF

   IF g_wc2_table5 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table5
   END IF

   IF g_wc2_table6 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table6
   END IF

   #add-point:cs段結束前
   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF
   #160623-00014#1-mod-(S)
#   CASE g_prog
#      WHEN 'asft310'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
#      WHEN 'asft311'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11')"
#      WHEN 'asft312'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('12')"
#      WHEN 'asft313'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('13')"
#      WHEN 'asft314'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('14')"
#      WHEN 'asft315'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('15')"
#      WHEN 'asft320'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
#      WHEN 'asft321'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21')"
#      WHEN 'asft322'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('22')"
#      WHEN 'asft323'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('23')"
#      WHEN 'asft324'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('24')"
#      WHEN 'asft325'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('25')"
#   END CASE          {#ADP版次:1#}
   CASE 
      WHEN g_prog MATCHES 'asft310'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
      WHEN g_prog MATCHES 'asft311'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11')"
      WHEN g_prog MATCHES 'asft312'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('12')"
      WHEN g_prog MATCHES 'asft313'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('13')"
      WHEN g_prog MATCHES 'asft314'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('14')"
      WHEN g_prog MATCHES 'asft315'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('15')"
      WHEN g_prog MATCHES 'asft320'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
      WHEN g_prog MATCHES 'asft321'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21')"
      WHEN g_prog MATCHES 'asft322'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('22')"
      WHEN g_prog MATCHES 'asft323'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('23')"
      WHEN g_prog MATCHES 'asft324'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('24')"
      WHEN g_prog MATCHES 'asft325'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('25')"
   END CASE          {#ADP版次:1#}
   #160623-00014#1-mod-(E)
   #end add-point

   IF INT_FLAG THEN
      RETURN
   END IF

END FUNCTION

PRIVATE FUNCTION asft310_filter()
   #切換畫面
   IF NOT g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF

   LET INT_FLAG = 0

   LET g_qryparam.state = 'c'

   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc

   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')

   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭
      CONSTRUCT g_wc_filter ON sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005
                          FROM s_browse[1].b_sfdadocno,s_browse[1].b_sfdadocdt,s_browse[1].b_sfda001,
                              s_browse[1].b_sfda002,s_browse[1].b_sfda003,s_browse[1].b_sfda004,s_browse[1].b_sfda005


         BEFORE CONSTRUCT
#saki            CALL cl_qbe_init()
               DISPLAY asft310_filter_parser('sfdadocno') TO s_browse[1].b_sfdadocno
            DISPLAY asft310_filter_parser('sfdadocdt') TO s_browse[1].b_sfdadocdt
            DISPLAY asft310_filter_parser('sfda001') TO s_browse[1].b_sfda001
            DISPLAY asft310_filter_parser('sfda002') TO s_browse[1].b_sfda002
            DISPLAY asft310_filter_parser('sfda003') TO s_browse[1].b_sfda003
            DISPLAY asft310_filter_parser('sfda004') TO s_browse[1].b_sfda004
            DISPLAY asft310_filter_parser('sfda005') TO s_browse[1].b_sfda005

      END CONSTRUCT



      BEFORE DIALOG


      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG

   END DIALOG

   IF NOT INT_FLAG THEN
      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
      LET g_wc = g_wc , g_wc_filter
   ELSE
      LET g_wc_filter = g_wc_filter_t
      LET g_wc = g_wc_t
   END IF

      CALL asft310_filter_show('sfdadocno')
   CALL asft310_filter_show('sfdadocdt')
   CALL asft310_filter_show('sfda001')
   CALL asft310_filter_show('sfda002')
   CALL asft310_filter_show('sfda003')
   CALL asft310_filter_show('sfda004')
   CALL asft310_filter_show('sfda005')

END FUNCTION

PRIVATE FUNCTION asft310_filter_parser(ps_field)
   {<Local define>}
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num5
   DEFINE li_tmp2    LIKE type_t.num5
   DEFINE ls_var     STRING
   {</Local define>}

   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF

   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF

   RETURN ls_var

END FUNCTION

PRIVATE FUNCTION asft310_filter_show(ps_field)
   DEFINE ps_field         STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING

   LET ls_name = "formonly.b_", ps_field

   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF

   #顯示資料組合
   LET ls_condition = asft310_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF

   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)

END FUNCTION

PRIVATE FUNCTION asft310_query()
   {<Local define>}
   DEFINE ls_wc STRING
   DEFINE ls_wc2 STRING
   {</Local define>}

   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF

   LET ls_wc = g_wc
   LET ls_wc2= g_wc2

   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""

   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()
   CALL g_sfdb_d.clear()
   CALL g_sfdc_d.clear()

   CALL g_sfde_d.clear()
   CALL g_sfdf_d.clear()

   CALL g_sfdc4_d.clear()
   CALL g_sfdd_d.clear()

   CALL g_inao_d.clear()   #add 150831
   CALL g_inao_d2.clear()   #add 150831


   DISPLAY ' ' TO FORMONLY.idx
   DISPLAY ' ' TO FORMONLY.cnt
   DISPLAY ' ' TO FORMONLY.b_index
   DISPLAY ' ' TO FORMONLY.b_count
   DISPLAY ' ' TO FORMONLY.h_index
   DISPLAY ' ' TO FORMONLY.h_count

   CALL asft310_construct()

   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      LET g_wc = ls_wc
      LET g_wc2= ls_wc2
      CALL asft310_browser_fill("")
      CALL asft310_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化
   LET g_detail_cnt = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx = 1
   LET g_detail_idx2 = 1
   LET l_ac = 1
   LET g_wc_filter = ""
   CALL FGL_SET_ARR_CURR(1)
      CALL asft310_filter_show('sfdadocno')
   CALL asft310_filter_show('sfdadocdt')
   CALL asft310_filter_show('sfda001')
   CALL asft310_filter_show('sfda002')
   CALL asft310_filter_show('sfda003')
   CALL asft310_filter_show('sfda004')
   CALL asft310_filter_show('sfda005')
   LET g_error_show = 1
   CALL asft310_browser_fill("F")

   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "-100"
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()

   ELSE
      CALL asft310_fetch("F")
      CALL asft310_idx_chk() #160408-00043#1-add
   END IF

END FUNCTION

PRIVATE FUNCTION asft310_fetch(p_flag)
   {<Local define>}
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   {</Local define>}

   IF g_browser_cnt = 0 THEN
      RETURN
   END IF

   CASE p_flag
      WHEN 'F' LET g_current_idx = 1
      WHEN 'L' LET g_current_idx = g_header_cnt
      WHEN 'P'
         IF g_current_idx > 1 THEN
            LET g_current_idx = g_current_idx - 1
         END IF
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF
      WHEN '/'
         IF (NOT g_no_ask) THEN
            CALL cl_set_act_visible("accept,cancel", TRUE)
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0

            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl"
            END PROMPT

            CALL cl_set_act_visible("accept,cancel", FALSE)
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE
            END IF
         END IF

         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF

         LET g_no_ask = FALSE
   END CASE


   CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引

   LET g_detail_cnt = g_header_cnt

   #單身總筆數顯示
   #LET g_detail_idx = 1
   IF g_detail_cnt > 0 THEN
      #LET g_detail_idx = 1
      DISPLAY g_detail_idx TO FORMONLY.idx
   ELSE
      LET g_detail_idx = 0
      DISPLAY ' ' TO FORMONLY.idx
   END IF

   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數

   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )

   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF

   #超出範圍
   IF g_current_idx > g_browser.getLength() THEN
      LET g_current_idx = g_browser.getLength()
   END IF

   LET g_sfda_m.sfdadocno = g_browser[g_current_idx].b_sfdadocno
   
   #重讀DB,因TEMP有不被更新特性
    SELECT UNIQUE sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,sfdaownid,sfdaowndp,
                  sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,sfdapstid,sfdapstdt
      INTO g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda004,
           g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,
           g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,
           g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt
      FROM sfda_t
     WHERE sfdaent = g_enterprise AND sfdasite = g_site AND sfdadocno = g_sfda_m.sfdadocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "sfda_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      INITIALIZE g_sfda_m.* TO NULL
      RETURN
   END IF
   #fetch段action控制
   CALL cl_set_act_visible("modify,delete,insert,modify_detail",TRUE)
   CALL asft310_set_act_visible()     #151217-00023#5 add
   CALL asft310_set_act_no_visible()  #151217-00023#5 add
   IF g_sfda_m.sfdastus NOT MATCHES "[NYDR]" THEN   # N未確認/D抽單/R已拒絕允許修改  #150511-00026 增加Y
         CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)
   END IF
   #161212-00025#1-s
   LET g_sfda_m_t.* = g_sfda_m.*
   LET g_sfda_m_o.* = g_sfda_m.*
   #161212-00025#1-e
   #161026-00049#1-s
   LET g_data_owner = g_sfda_m.sfdaownid      
   LET g_data_dept  = g_sfda_m.sfdaowndp
   #161026-00049#1-e
   #重新顯示
   CALL asft310_show()

END FUNCTION

PRIVATE FUNCTION asft310_insert()
   
   #asft310,asft320不允许新增，修改
   #160623-00014#1-mod-(S)
#   IF g_prog='asft310' OR g_prog='asft320' THEN
#      RETURN
#   END IF
   IF g_prog MATCHES 'asft310' OR g_prog MATCHES 'asft320' THEN
      RETURN
   END IF
   #160623-00014#1-mod-(E)
   
   #清畫面欄位內容
   CLEAR FORM
   CALL g_sfdb_d.clear()
   CALL g_sfdc_d.clear()
   CALL g_sfde_d.clear()
   CALL g_sfdc4_d.clear()
   CALL g_sfdf_d.clear()
   CALL g_sfdd_d.clear()
   #add 150831
   CALL g_inao_d.clear()
   CALL g_inao_d2.clear()
   CALL s_lot_clear_detail()
   #add 150831 end
   
   INITIALIZE g_sfda_m.* LIKE sfda_t.*             #DEFAULT 設定
   LET g_sfdadocno_t = NULL

   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #此段落由子樣板a14產生
      LET g_sfda_m.sfdaownid = g_user
      LET g_sfda_m.sfdaowndp = g_dept
      LET g_sfda_m.sfdacrtid = g_user
      LET g_sfda_m.sfdacrtdp = g_dept
      LET g_sfda_m.sfdacrtdt = cl_get_current()
      LET g_sfda_m.sfdamodid = ""
      LET g_sfda_m.sfdamoddt = ""

      #add-point:單頭預設值
      LET g_sfda_m.sfdadocdt = g_today
      LET g_sfda_m.sfda001 = g_today
      #160623-00014#1-mod-(S)
#      CASE g_prog
#         WHEN 'asft310'
#              LET g_sfda_m.sfda002 = '11'
#         WHEN 'asft311'
#              LET g_sfda_m.sfda002 = '11'
#         WHEN 'asft312'
#              LET g_sfda_m.sfda002 = '12'
#         WHEN 'asft313'
#              LET g_sfda_m.sfda002 = '13'
#         WHEN 'asft314'
#              LET g_sfda_m.sfda002 = '14'
#         WHEN 'asft315'
#              LET g_sfda_m.sfda002 = '15'
#         WHEN 'asft320'
#              LET g_sfda_m.sfda002 = '21'
#         WHEN 'asft321'
#              LET g_sfda_m.sfda002 = '21'
#         WHEN 'asft322'
#              LET g_sfda_m.sfda002 = '22'
#         WHEN 'asft323'
#              LET g_sfda_m.sfda002 = '23'
#         WHEN 'asft324'
#              LET g_sfda_m.sfda002 = '24'
#         WHEN 'asft325'
#              LET g_sfda_m.sfda002 = '25'
#         OTHERWISE
#      END CASE
      CASE 
         WHEN g_prog MATCHES 'asft310'
              LET g_sfda_m.sfda002 = '11'
         WHEN g_prog MATCHES 'asft311'
              LET g_sfda_m.sfda002 = '11'
         WHEN g_prog MATCHES 'asft312'
              LET g_sfda_m.sfda002 = '12'
         WHEN g_prog MATCHES 'asft313'
              LET g_sfda_m.sfda002 = '13'
         WHEN g_prog MATCHES 'asft314'
              LET g_sfda_m.sfda002 = '14'
         WHEN g_prog MATCHES 'asft315'
              LET g_sfda_m.sfda002 = '15'
         WHEN g_prog MATCHES 'asft320'
              LET g_sfda_m.sfda002 = '21'
         WHEN g_prog MATCHES 'asft321'
              LET g_sfda_m.sfda002 = '21'
         WHEN g_prog MATCHES 'asft322'
              LET g_sfda_m.sfda002 = '22'
         WHEN g_prog MATCHES g_prog MATCHES 'asft323'
              LET g_sfda_m.sfda002 = '23'
         WHEN g_prog MATCHES 'asft324'
              LET g_sfda_m.sfda002 = '24'
         WHEN g_prog MATCHES 'asft325'
              LET g_sfda_m.sfda002 = '25'
         OTHERWISE
      END CASE
      #160623-00014#1-mod-(E)
      
      IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN  #製程中委外時，顯示名稱為委外廠商
         #委外厂商
      ELSE
         #部门
         LET g_sfda_m.sfda003 = g_dept
         CALL s_desc_get_department_desc(g_sfda_m.sfda003) RETURNING g_sfda_m.sfda003_desc
         DISPLAY BY NAME g_sfda_m.sfda003_desc
      END IF

      #人员
      LET g_sfda_m.sfda004 = g_user
      CALL s_desc_get_person_desc(g_sfda_m.sfda004) RETURNING g_sfda_m.sfda004_desc
      DISPLAY BY NAME g_sfda_m.sfda004_desc

      LET g_sfda_m.sfda015 = "01" 
      LET g_sfda_m.sfda014 = "" 
      LET g_sfda_m.sfdastus = "N" 
      #end add-point
      
      #161212-00025#1-s
      LET g_sfda_m_t.* = g_sfda_m.*
      LET g_sfda_m_o.* = g_sfda_m.*
      #161212-00025#1-e

      CALL asft310_input("a")
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_sfda_m.* = g_sfda_m_t.*
         CALL asft310_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         CALL s_transaction_end('N','0')
         EXIT WHILE
      END IF

      CALL g_sfdb_d.clear()
      CALL g_sfdc_d.clear()
      CALL g_sfde_d.clear()
      CALL g_sfdc4_d.clear()
      CALL g_sfdf_d.clear()
      CALL g_sfdd_d.clear()
      CALL g_inao_d.clear()   #add 150831
      CALL g_inao_d2.clear()   #add 150831


      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE

   END WHILE

   LET g_state = "Y"

   CALL asft310_set_act_visible()     #151217-00023#5 add
   CALL asft310_set_act_no_visible()  #151217-00023#5 add

   LET g_sfdadocno_t = g_sfda_m.sfdadocno


   LET g_wc = g_wc,
              " OR ( sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND",
              " sfdadocno = '", g_sfda_m.sfdadocno CLIPPED, "') "
   #170217-00024#1-(S)-add   
   LET g_add_browse = " sfdaent = '" ||g_enterprise|| "' AND",
		      		    " sfdadocno = '", g_sfda_m.sfdadocno, "' "           
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL asft310_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   #170217-00024#1-(E)-add
   CLOSE asft310_cl

END FUNCTION

PRIVATE FUNCTION asft310_modify()
   {<Local define>}
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   {</Local define>}

   #asft310,asft320不允许新增，修改
   #160623-00014#1-mod-(S)
#   IF g_prog='asft310' OR g_prog='asft320' THEN
#      RETURN
#   END IF
   IF g_prog MATCHES 'asft310' OR g_prog MATCHES 'asft320' THEN
      RETURN
   END IF
   #160623-00014#1-mod-(E)
   
   #161212-00025#1-s
   LET g_sfda_m_t.* = g_sfda_m.*
   LET g_sfda_m_o.* = g_sfda_m.*
   #161212-00025#1-e
   
   IF g_sfda_m.sfdadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF

   SELECT UNIQUE sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,sfdaownid,sfdaowndp,
                 sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,sfdapstid,sfdapstdt
     INTO g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda004,
          g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,
          g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,
          g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt
     FROM sfda_t
    WHERE sfdaent = g_enterprise AND sfdadocno = g_sfda_m.sfdadocno

   #IF g_sfda_m.sfdastus != 'N' THEN
   #   #此笔资料状态不为'N.未确认',不可对此单据资料进行修改
   #   #CALL cl_err("","art-00030",0)
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "art-00030"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = FALSE
   #   CALL cl_err()
   #   RETURN
   #END IF
   #mark for已审核的单据也能修改，只能修改发料明细和料号汇总页签
   IF g_sfda_m.sfdastus = 'S' THEN
      #已过账资料不可修改
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "asf-00119"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   IF g_sfda_m.sfdastus = 'X' THEN
      #资料已作废，不可异动!
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "afa-00023"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   IF g_sfda_m.sfdastus = 'Y' AND (g_sfda_m.sfda002='15' OR g_sfda_m.sfda002='25')THEN
      #资料已审核,不可修改
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "anm-00120"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   #add 150921 下阶料报废的控管
   IF g_sfda_m.sfda015 = '04' THEN #来源：工单在制下阶料报废，不能修改，在asft339中指定好了，保持一致
      #本单据来源类型为%1，不可异动
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00696'
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      LET g_errparam.replace[1] = '04'
      CALL cl_err()
      RETURN
   END IF
   #add 150921
   
   ERROR ""
   
   LET g_sfdadocno_t = g_sfda_m.sfdadocno

   CALL s_transaction_begin()

   OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN asft310_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #鎖住將被更改或取消的資料
   FETCH asft310_cl INTO g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,
       g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,
       g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,g_sfda_m.sfdaowndp_desc,
       g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,
       g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,
       g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt

   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_sfda_m.sfdadocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   #160818-00017#36-s
   #檢查是否允許此動作
   IF NOT asft310_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   #160818-00017#36-e
   CALL asft310_show()
   WHILE TRUE
      LET g_sfdadocno_t = g_sfda_m.sfdadocno

      #寫入修改者/修改日期資訊(單頭)
      LET g_sfda_m.sfdamodid = g_user
      LET g_sfda_m.sfdamoddt = cl_get_current()

      #「D抽單 / R已拒絕」狀況碼更改資料後，需還原為「N未確認」
      IF g_sfda_m.sfdastus MATCHES "[DR]" THEN 
         LET g_sfda_m.sfdastus = "N"
      END IF

      CALL asft310_input("u")     #欄位更改
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         LET g_sfda_m.* = g_sfda_m_t.*
         CALL asft310_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 9001
         LET g_errparam.extend = ''
         LET g_errparam.popup = FALSE
         CALL cl_err()

         EXIT WHILE
      END IF

      ##若單頭key欄位有變更
      #add这个应该在input里面的update sfda后马上处理的吧，否则鼠标移到单身会不见,且单头修改完后进入单身点放弃后，单身的key值就不会更新到了
      #   独立成函数asft310_upd_key()
      #IF g_sfda_m.sfdadocno != g_sfdadocno_t THEN
      #   CALL s_transaction_begin()
      #   #更新單身key值
      #   UPDATE sfdb_t SET sfdbdocno = g_sfda_m.sfdadocno
      #    WHERE sfdbent = g_enterprise AND sfdbdocno = g_sfdadocno_t
      #   CASE
      #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
      #         #CALL cl_err("sfdb_t","std-00009",1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = "std-00009"
      #         LET g_errparam.extend = "sfdb_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #      WHEN SQLCA.sqlcode #其他錯誤
      #         #CALL cl_err("sfdb_t",SQLCA.sqlcode,1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = "sfdb_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #   END CASE
	  #
      #   #更新單身key值
      #   UPDATE sfdc_t
      #      SET sfdcdocno = g_sfda_m.sfdadocno
      #    WHERE sfdcent = g_enterprise AND sfdcdocno = g_sfdadocno_t
      #   CASE
      #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
      #         #CALL cl_err("sfdc_t","std-00009",1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = "std-00009"
      #         LET g_errparam.extend = "sfdc_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #      WHEN SQLCA.sqlcode #其他錯誤
      #         #CALL cl_err("sfdc_t",SQLCA.sqlcode,1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = "sfdc_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #   END CASE
	  #
      #   #更新單身key值
      #   UPDATE sfde_t
      #      SET sfdedocno = g_sfda_m.sfdadocno
      #    WHERE sfdeent = g_enterprise AND sfdedocno = g_sfdadocno_t
      #   CASE
      #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
      #         #CALL cl_err("sfde_t","std-00009",1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = "std-00009"
      #         LET g_errparam.extend = "sfde_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #      WHEN SQLCA.sqlcode #其他錯誤
      #         #CALL cl_err("sfde_t",SQLCA.sqlcode,1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = "sfde_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #   END CASE
	  #
	  #
      #   #更新單身key值
      #   UPDATE inao_t
      #      SET inaodocno = g_sfda_m.sfdadocno
      #    WHERE inaoent = g_enterprise AND inaosite = g_site AND
      #          inaodocno = g_sfdadocno_t
      #   CASE
      #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
      #         #CALL cl_err("inao_t","std-00009",1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = "std-00009"
      #         LET g_errparam.extend = "inao_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #      WHEN SQLCA.sqlcode #其他錯誤
      #         #CALL cl_err("inao_t",SQLCA.sqlcode,1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = "inao_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #   END CASE
	  #
      #   #更新單身key值
      #   UPDATE sfdf_t
      #      SET sfdfdocno = g_sfda_m.sfdadocno
      #    WHERE sfdfent = g_enterprise AND sfdfdocno = g_sfdadocno_t
      #   CASE
      #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
      #         #CALL cl_err("sfdf_t","std-00009",1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = "std-00009"
      #         LET g_errparam.extend = "sfdf_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #      WHEN SQLCA.sqlcode #其他錯誤
      #         #CALL cl_err("sfdf_t",SQLCA.sqlcode,1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = "sfdf_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #   END CASE
	  #
	  #
      #   #更新單身key值
      #   UPDATE sfdd_t
      #      SET sfdddocno = g_sfda_m.sfdadocno
      #    WHERE sfddent = g_enterprise AND sfdddocno = g_sfdadocno_t
      #   CASE
      #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
      #         #CALL cl_err("sfdd_t","std-00009",1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = "std-00009"
      #         LET g_errparam.extend = "sfdd_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #      WHEN SQLCA.sqlcode #其他錯誤
      #         #CALL cl_err("sfdd_t",SQLCA.sqlcode,1)
      #         INITIALIZE g_errparam TO NULL
      #         LET g_errparam.code = SQLCA.sqlcode
      #         LET g_errparam.extend = "sfdd_t"
      #         LET g_errparam.popup = TRUE
      #         CALL cl_err()
      #         CALL s_transaction_end('N','0')
      #         CONTINUE WHILE
      #   END CASE
      #   #UPDATE 多語言table key值
      #   CALL s_transaction_end('Y','0')
      #END IF

      EXIT WHILE
   END WHILE

   CALL asft310_set_act_visible()     #151217-00023#5 add
   CALL asft310_set_act_no_visible()  #151217-00023#5 add

   #修改歷程記錄
   IF NOT cl_log_modified_record(g_sfda_m.sfdadocno,g_site) THEN
      CALL s_transaction_end('N','0')
   END IF

   #170217-00024#1-(S)-add
   #組合新增資料的條件
   LET g_add_browse = " sfdaent = '" ||g_enterprise|| "' AND",
		      		    " sfdadocno = '", g_sfda_m.sfdadocno, "' "     
 
   #填到對應位置
   CALL asft310_browser_fill("")
   #170217-00024#1-(E)-add
   
   CLOSE asft310_cl
   CALL s_transaction_end('Y','0')

   #流程通知預埋點-U
   CALL cl_flow_notify(g_sfda_m.sfdadocno,'U')

END FUNCTION
#讀入ref值(單身)
PRIVATE FUNCTION asft310_detail_show()
DEFINE l_ac_t      LIKE type_t.num5
DEFINE l_sfba001   LIKE sfba_t.sfba001  #生产料号
DEFINE l_sfaa011   LIKE sfaa_t.sfaa011  #特性

   LET l_ac_t = l_ac
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_sfdb_d.getLength()
      #部位说明
      CALL s_desc_get_acc_desc('215',g_sfdb_d[l_ac].sfdb003) RETURNING g_sfdb_d[l_ac].sfdb003_desc

      #作业说明
      CALL s_desc_get_acc_desc('221',g_sfdb_d[l_ac].sfdb004) RETURNING g_sfdb_d[l_ac].sfdb004_desc

      SELECT sfaa010,imaal003,imaal004,sfaa013,sfaa012
        INTO g_sfdb_d[l_ac].sfaa010,g_sfdb_d[l_ac].sfaa010_desc,g_sfdb_d[l_ac].sfaa010_desc2,
             g_sfdb_d[l_ac].sfaa013,g_sfdb_d[l_ac].sfaa012
        FROM sfaa_t LEFT JOIN imaal_t ON sfaaent = imaalent AND sfaa010 = imaal001 AND imaal002 = g_dlang
       WHERE sfaaent   = g_enterprise
         AND sfaasite  = g_site
         AND sfaadocno = g_sfdb_d[l_ac].sfdb001
   END FOR

   FOR l_ac = 1 TO g_sfdc_d.getLength()
      #单位
      CALL s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc006) RETURNING g_sfdc_d[l_ac].sfdc006_desc
      LET g_sfdc4_d[l_ac].sfdc006_desc = g_sfdc_d[l_ac].sfdc006_desc
      
      #参考单位
      CALL s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009) RETURNING g_sfdc_d[l_ac].sfdc009_desc
      LET g_sfdc4_d[l_ac].sfdc009_desc = g_sfdc_d[l_ac].sfdc009_desc
      
      #理由码
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_sfdc_d[l_ac].sfdc015
      CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='226' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_sfdc_d[l_ac].sfdc015_desc = '', g_rtn_fields[1] , ''
      LET g_sfdc4_d[l_ac].sfdc015_desc = g_sfdc_d[l_ac].sfdc015_desc
      
      #需求料号品名规格
      CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004) RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
      LET g_sfdc4_d[l_ac].sfdc004_desc  = g_sfdc_d[l_ac].sfdc004_desc 
      LET g_sfdc4_d[l_ac].sfdc004_desc2 = g_sfdc_d[l_ac].sfdc004_desc2
      #显示产品特征说明
      CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
         RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
      IF NOT l_success THEN
         LET g_sfdc_d[l_ac].sfdc005_desc = ''
      END IF
      LET g_sfdc4_d[l_ac].sfdc005_desc  = g_sfdc_d[l_ac].sfdc005_desc 

      #保税料
      SELECT imaf034 INTO g_sfdc_d[l_ac].imaf034
        FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite= g_site
         AND imaf001 = g_sfdc_d[l_ac].sfdc004
      LET g_sfdc4_d[l_ac].imaf034 = g_sfdc_d[l_ac].imaf034
      
      #发料前调拨
      SELECT imae092 INTO g_sfdc_d[l_ac].imae092
        FROM imae_t
       WHERE imaeent = g_enterprise
         AND imaesite= g_site
         AND imae001 = g_sfdc_d[l_ac].sfdc004
      LET g_sfdc4_d[l_ac].imae092 = g_sfdc_d[l_ac].imae092
      
      #差异数量
      LET g_sfdc_d[l_ac].diff  = g_sfdc_d[l_ac].sfdc007 - g_sfdc_d[l_ac].sfdc008
      LET g_sfdc4_d[l_ac].diff = g_sfdc_d[l_ac].diff
      #参考单位差异数量
      LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010  - g_sfdc_d[l_ac].sfdc011
      LET g_sfdc4_d[l_ac].diff2= g_sfdc_d[l_ac].diff2
      
      #库位名称
      CALL s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012) RETURNING g_sfdc_d[l_ac].sfdc012_desc
      LET g_sfdc4_d[l_ac].sfdc012_desc = g_sfdc_d[l_ac].sfdc012_desc
      
      #储位名称
      IF NOT cl_null(g_sfdc_d[l_ac].sfdc013) THEN
         CALL s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013) RETURNING g_sfdc_d[l_ac].sfdc013_desc
         LET g_sfdc4_d[l_ac].sfdc013_desc = g_sfdc_d[l_ac].sfdc013_desc
      END IF
      
      #工单信息-部位、作业、作业序、客供料、应发料、已发量
      SELECT sfba002,sfba003,sfba004,sfba028,sfba013,sfba016,sfba001,sfaa011
        INTO g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004,g_sfdc_d[l_ac].sfba028,
             g_sfdc_d[l_ac].sfba013,g_sfdc_d[l_ac].sfba016,l_sfba001,l_sfaa011
        FROM sfba_t,sfaa_t
       WHERE sfbaent = sfaaent
         AND sfbasite= sfaasite
         AND sfbadocno=sfaadocno
         AND sfbaent = g_enterprise
         AND sfbasite= g_site
         AND sfbadocno=g_sfdc_d[l_ac].sfdc001
         AND sfbaseq = g_sfdc_d[l_ac].sfdc002
         AND sfbaseq1= g_sfdc_d[l_ac].sfdc003
      LET g_sfdc4_d[l_ac].sfba002 = g_sfdc_d[l_ac].sfba002
      LET g_sfdc4_d[l_ac].sfba003 = g_sfdc_d[l_ac].sfba003
      LET g_sfdc4_d[l_ac].sfba004 = g_sfdc_d[l_ac].sfba004
      LET g_sfdc4_d[l_ac].sfba028 = g_sfdc_d[l_ac].sfba028
      LET g_sfdc4_d[l_ac].sfba013 = g_sfdc_d[l_ac].sfba013
      LET g_sfdc4_d[l_ac].sfba016 = g_sfdc_d[l_ac].sfba016

      #部位说明
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = '215'
      LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfba002
      CALL cl_ref_val("v_oocql002")
      LET g_sfdc_d[l_ac].sfba002_desc = g_chkparam.return1
      LET g_sfdc4_d[l_ac].sfba002_desc= g_sfdc_d[l_ac].sfba002_desc
      
      #作业说明
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = '221'
      LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfba003
      CALL cl_ref_val("v_oocql002")
      LET g_sfdc_d[l_ac].sfba003_desc = g_chkparam.return1
      LET g_sfdc4_d[l_ac].sfba003_desc= g_sfdc_d[l_ac].sfba003_desc
      
      #replace取替代建议
      CALL s_abmm201_get_proposal(g_site,l_sfba001,l_sfaa011,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004) RETURNING g_sfdc_d[l_ac].replace 
      LET g_sfdc4_d[l_ac].replace = g_sfdc_d[l_ac].replace 
      
      CALL asft310_show_sfdc_ooff013(l_ac) #add 141222 备注说明
      LET g_sfdc4_d[l_ac].sfdc_ooff013 = g_sfdc_d[l_ac].sfdc_ooff013
   END FOR

   FOR l_ac = 1 TO g_sfde_d.getLength()
      #需求料号
      CALL s_desc_get_item_desc(g_sfde_d[l_ac].sfde001) RETURNING g_sfde_d[l_ac].sfde001_desc,g_sfde_d[l_ac].sfde001_desc2
      #显示产品特征说明
      CALL s_feature_description(g_sfde_d[l_ac].sfde001,g_sfde_d[l_ac].sfde002)
         RETURNING l_success,g_sfde_d[l_ac].sfde002_desc
      IF NOT l_success THEN
         LET g_sfde_d[l_ac].sfde002_desc = ''
      END IF
      #保税料
      SELECT imaf034 INTO g_sfde_d[l_ac].imaf034
        FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite= g_site
         AND imaf001 = g_sfde_d[l_ac].sfde001
      
      #发料前调拨
      SELECT imae092 INTO g_sfde_d[l_ac].imae092
        FROM imae_t
       WHERE imaeent = g_enterprise
         AND imaesite= g_site
         AND imae001 = g_sfde_d[l_ac].sfde001

      #单位
      CALL s_desc_get_unit_desc(g_sfde_d[l_ac].sfde003) RETURNING g_sfde_d[l_ac].sfde003_desc

      #差异数量
      LET g_sfde_d[l_ac].diff03 = g_sfde_d[l_ac].sfde004 - g_sfde_d[l_ac].sfde005

      #参考单位
      CALL s_desc_get_unit_desc(g_sfde_d[l_ac].sfde006) RETURNING g_sfde_d[l_ac].sfde006_desc
      
      #参考单位差异数量
      LET g_sfde_d[l_ac].diff23 = g_sfde_d[l_ac].sfde007 - g_sfde_d[l_ac].sfde008
   END FOR

   FOR l_ac = 1 TO g_sfdf_d.getLength()
      #发料料号
      CALL s_desc_get_item_desc(g_sfdf_d[l_ac].sfdf001) RETURNING g_sfdf_d[l_ac].sfdf001_desc,g_sfdf_d[l_ac].sfdf001_desc2
      #显示产品特征说明
      CALL s_feature_description(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013)
         RETURNING l_success,g_sfdf_d[l_ac].sfdf013_desc
      IF NOT l_success THEN
         LET g_sfdf_d[l_ac].sfdf013_desc = ''
      END IF

      #库位
      CALL s_desc_get_stock_desc(g_site,g_sfdf_d[l_ac].sfdf003) RETURNING g_sfdf_d[l_ac].sfdf003_desc

      #储位
      IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) THEN
         CALL s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004) RETURNING g_sfdf_d[l_ac].sfdf004_desc
      END IF

      #单位
      CALL s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006) RETURNING g_sfdf_d[l_ac].sfdf006_desc
      DISPLAY BY NAME g_sfdf_d[l_ac].sfdf006_desc

      #参考单位
      CALL s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008) RETURNING g_sfdf_d[l_ac].sfdf008_desc
      DISPLAY BY NAME g_sfdf_d[l_ac].sfdf008_desc
   END FOR

   FOR l_ac = 1 TO g_sfdd_d.getLength()
      #发料料号
      CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001) RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
      DISPLAY BY NAME g_sfdd_d[l_ac].sfdd001_desc
      DISPLAY BY NAME g_sfdd_d[l_ac].sfdd001_desc2
      #显示产品特征说明
      CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
         RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
      IF NOT l_success THEN
         LET g_sfdd_d[l_ac].sfdd013_desc = ''
      END IF
      DISPLAY BY NAME g_sfdd_d[l_ac].sfdd013_desc
      
      #库位
      CALL s_desc_get_stock_desc(g_site,g_sfdd_d[l_ac].sfdd003) RETURNING g_sfdd_d[l_ac].sfdd003_desc

      #储位
      IF NOT cl_null(g_sfdd_d[l_ac].sfdd004) THEN
         CALL s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004) RETURNING g_sfdd_d[l_ac].sfdd004_desc
      END IF

      #单位
      CALL s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006) RETURNING g_sfdd_d[l_ac].sfdd006_desc
      DISPLAY BY NAME g_sfdd_d[l_ac].sfdd006_desc

      #参考单位
      CALL s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008) RETURNING g_sfdd_d[l_ac].sfdd008_desc
      DISPLAY BY NAME g_sfdd_d[l_ac].sfdd008_desc
      
      CALL asft310_show_sfdd_ooff013(l_ac) #add 141222 备注说明
   END FOR

   LET l_ac = l_ac_t

END FUNCTION

PRIVATE FUNCTION asft310_input(p_cmd)
   {<Local define>}
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_ac_t                LIKE type_t.num5                #未取消的ARRAY CNT
   DEFINE  l_n                   LIKE type_t.num5                #檢查重複用
   DEFINE  l_cnt                 LIKE type_t.num5                #檢查重複用
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否
   DEFINE  l_count               LIKE type_t.num5
   DEFINE  l_i                   LIKE type_t.num5
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num5
   DEFINE  li_reproduce_target   LIKE type_t.num5
   {</Local define>}
   #add-point:input段define
   DEFINE l_ooef004        LIKE ooef_t.ooef004
   DEFINE l_sfdb006        LIKE sfdb_t.sfdb006
   DEFINE l_sfdb006_1      LIKE sfdb_t.sfdb006  #151222-00004#1 add
   DEFINE l_sfdb006_max    LIKE sfdb_t.sfdb006  #151222-00004#1 add
   DEFINE l_inaa010        LIKE inaa_t.inaa010  #成本库否
   DEFINE l_rate           LIKE inaj_t.inaj014  #单位换算率
   DEFINE l_imaa006        LIKE imaa_t.imaa006  #基础单位
   #DEFINE l_bmea           RECORD LIKE bmea_t.* #161109-00085#62 mark
   #161109-00085#62 --s add
   DEFINE l_bmea RECORD  #取替代料檔
          bmeaent LIKE bmea_t.bmeaent, #企業編號
          bmeasite LIKE bmea_t.bmeasite, #營運據點
          bmea001 LIKE bmea_t.bmea001, #主件料號
          bmea002 LIKE bmea_t.bmea002, #特性
          bmea003 LIKE bmea_t.bmea003, #元件料號
          bmea004 LIKE bmea_t.bmea004, #部位
          bmea005 LIKE bmea_t.bmea005, #作業
          bmea006 LIKE bmea_t.bmea006, #製程式
          bmea007 LIKE bmea_t.bmea007, #取代/替代
          bmea008 LIKE bmea_t.bmea008, #取替代料件編號
          bmea009 LIKE bmea_t.bmea009, #生效日期
          bmea010 LIKE bmea_t.bmea010, #失效日期
          bmea011 LIKE bmea_t.bmea011, #取替代量
          bmea012 LIKE bmea_t.bmea012, #元件底數
          bmea013 LIKE bmea_t.bmea013, #替代料發料單位
          bmea014 LIKE bmea_t.bmea014, #限定客戶
          bmea015 LIKE bmea_t.bmea015, #優先順序
          bmea016 LIKE bmea_t.bmea016, #替代方式
          bmea017 LIKE bmea_t.bmea017, #部份替代上限比率
          bmea018 LIKE bmea_t.bmea018, #參照研發中心
          bmea019 LIKE bmea_t.bmea019, #產品特徵
          bmeaud001 LIKE bmea_t.bmeaud001, #自定義欄位(文字)001
          bmeaud002 LIKE bmea_t.bmeaud002, #自定義欄位(文字)002
          bmeaud003 LIKE bmea_t.bmeaud003, #自定義欄位(文字)003
          bmeaud004 LIKE bmea_t.bmeaud004, #自定義欄位(文字)004
          bmeaud005 LIKE bmea_t.bmeaud005, #自定義欄位(文字)005
          bmeaud006 LIKE bmea_t.bmeaud006, #自定義欄位(文字)006
          bmeaud007 LIKE bmea_t.bmeaud007, #自定義欄位(文字)007
          bmeaud008 LIKE bmea_t.bmeaud008, #自定義欄位(文字)008
          bmeaud009 LIKE bmea_t.bmeaud009, #自定義欄位(文字)009
          bmeaud010 LIKE bmea_t.bmeaud010, #自定義欄位(文字)010
          bmeaud011 LIKE bmea_t.bmeaud011, #自定義欄位(數字)011
          bmeaud012 LIKE bmea_t.bmeaud012, #自定義欄位(數字)012
          bmeaud013 LIKE bmea_t.bmeaud013, #自定義欄位(數字)013
          bmeaud014 LIKE bmea_t.bmeaud014, #自定義欄位(數字)014
          bmeaud015 LIKE bmea_t.bmeaud015, #自定義欄位(數字)015
          bmeaud016 LIKE bmea_t.bmeaud016, #自定義欄位(數字)016
          bmeaud017 LIKE bmea_t.bmeaud017, #自定義欄位(數字)017
          bmeaud018 LIKE bmea_t.bmeaud018, #自定義欄位(數字)018
          bmeaud019 LIKE bmea_t.bmeaud019, #自定義欄位(數字)019
          bmeaud020 LIKE bmea_t.bmeaud020, #自定義欄位(數字)020
          bmeaud021 LIKE bmea_t.bmeaud021, #自定義欄位(日期時間)021
          bmeaud022 LIKE bmea_t.bmeaud022, #自定義欄位(日期時間)022
          bmeaud023 LIKE bmea_t.bmeaud023, #自定義欄位(日期時間)023
          bmeaud024 LIKE bmea_t.bmeaud024, #自定義欄位(日期時間)024
          bmeaud025 LIKE bmea_t.bmeaud025, #自定義欄位(日期時間)025
          bmeaud026 LIKE bmea_t.bmeaud026, #自定義欄位(日期時間)026
          bmeaud027 LIKE bmea_t.bmeaud027, #自定義欄位(日期時間)027
          bmeaud028 LIKE bmea_t.bmeaud028, #自定義欄位(日期時間)028
          bmeaud029 LIKE bmea_t.bmeaud029, #自定義欄位(日期時間)029
          bmeaud030 LIKE bmea_t.bmeaud030, #自定義欄位(日期時間)030
          bmea020 LIKE bmea_t.bmea020  #保稅否
   END RECORD
   #161109-00085#62 --e add
   DEFINE l_sfdd007        LIKE sfdd_t.sfdd007  #替换料件折合成元件的数量
   DEFINE l_sfdd009        LIKE sfdd_t.sfdd009  #替换料件折合成元件的参考数量
   #161109-00085#62 --s mark
   #DEFINE l_sfdc           RECORD LIKE sfdc_t.*
   #DEFINE l_sfdd           RECORD LIKE sfdd_t.*
   #DEFINE l_sfdf           RECORD LIKE sfdf_t.*
   #DEFINE l_sfdc_t         RECORD LIKE sfdc_t.*
   #DEFINE l_sfdd_t         RECORD LIKE sfdd_t.*
   #DEFINE l_sfdf_t         RECORD LIKE sfdf_t.*
   #161109-00085#62 --e mark
   #161109-00085#62 --s add
   DEFINE l_sfdc RECORD  #發退料需求檔
          sfdcent LIKE sfdc_t.sfdcent, #企業編號
          sfdcsite LIKE sfdc_t.sfdcsite, #營運據點
          sfdcdocno LIKE sfdc_t.sfdcdocno, #發退料單號
          sfdcseq LIKE sfdc_t.sfdcseq, #項次
          sfdc001 LIKE sfdc_t.sfdc001, #工單單號
          sfdc002 LIKE sfdc_t.sfdc002, #工單項次
          sfdc003 LIKE sfdc_t.sfdc003, #工單項序
          sfdc004 LIKE sfdc_t.sfdc004, #需求料號
          sfdc005 LIKE sfdc_t.sfdc005, #產品特徵
          sfdc006 LIKE sfdc_t.sfdc006, #單位
          sfdc007 LIKE sfdc_t.sfdc007, #申請數量
          sfdc008 LIKE sfdc_t.sfdc008, #實際數量
          sfdc009 LIKE sfdc_t.sfdc009, #參考單位
          sfdc010 LIKE sfdc_t.sfdc010, #參考單位需求數量
          sfdc011 LIKE sfdc_t.sfdc011, #參考單位實際數量
          sfdc012 LIKE sfdc_t.sfdc012, #指定庫位
          sfdc013 LIKE sfdc_t.sfdc013, #指定儲位
          sfdc014 LIKE sfdc_t.sfdc014, #指定批號
          sfdc015 LIKE sfdc_t.sfdc015, #理由碼
          sfdc016 LIKE sfdc_t.sfdc016, #庫存管理特徴
          sfdc017 LIKE sfdc_t.sfdc017, #正負
          sfdcud001 LIKE sfdc_t.sfdcud001, #自定義欄位(文字)001
          sfdcud002 LIKE sfdc_t.sfdcud002, #自定義欄位(文字)002
          sfdcud003 LIKE sfdc_t.sfdcud003, #自定義欄位(文字)003
          sfdcud004 LIKE sfdc_t.sfdcud004, #自定義欄位(文字)004
          sfdcud005 LIKE sfdc_t.sfdcud005, #自定義欄位(文字)005
          sfdcud006 LIKE sfdc_t.sfdcud006, #自定義欄位(文字)006
          sfdcud007 LIKE sfdc_t.sfdcud007, #自定義欄位(文字)007
          sfdcud008 LIKE sfdc_t.sfdcud008, #自定義欄位(文字)008
          sfdcud009 LIKE sfdc_t.sfdcud009, #自定義欄位(文字)009
          sfdcud010 LIKE sfdc_t.sfdcud010, #自定義欄位(文字)010
          sfdcud011 LIKE sfdc_t.sfdcud011, #自定義欄位(數字)011
          sfdcud012 LIKE sfdc_t.sfdcud012, #自定義欄位(數字)012
          sfdcud013 LIKE sfdc_t.sfdcud013, #自定義欄位(數字)013
          sfdcud014 LIKE sfdc_t.sfdcud014, #自定義欄位(數字)014
          sfdcud015 LIKE sfdc_t.sfdcud015, #自定義欄位(數字)015
          sfdcud016 LIKE sfdc_t.sfdcud016, #自定義欄位(數字)016
          sfdcud017 LIKE sfdc_t.sfdcud017, #自定義欄位(數字)017
          sfdcud018 LIKE sfdc_t.sfdcud018, #自定義欄位(數字)018
          sfdcud019 LIKE sfdc_t.sfdcud019, #自定義欄位(數字)019
          sfdcud020 LIKE sfdc_t.sfdcud020, #自定義欄位(數字)020
          sfdcud021 LIKE sfdc_t.sfdcud021, #自定義欄位(日期時間)021
          sfdcud022 LIKE sfdc_t.sfdcud022, #自定義欄位(日期時間)022
          sfdcud023 LIKE sfdc_t.sfdcud023, #自定義欄位(日期時間)023
          sfdcud024 LIKE sfdc_t.sfdcud024, #自定義欄位(日期時間)024
          sfdcud025 LIKE sfdc_t.sfdcud025, #自定義欄位(日期時間)025
          sfdcud026 LIKE sfdc_t.sfdcud026, #自定義欄位(日期時間)026
          sfdcud027 LIKE sfdc_t.sfdcud027, #自定義欄位(日期時間)027
          sfdcud028 LIKE sfdc_t.sfdcud028, #自定義欄位(日期時間)028
          sfdcud029 LIKE sfdc_t.sfdcud029, #自定義欄位(日期時間)029
          sfdcud030 LIKE sfdc_t.sfdcud030  #自定義欄位(日期時間)030
   END RECORD
   DEFINE l_sfdd RECORD  #發退料明細檔
          sfddent LIKE sfdd_t.sfddent, #企業編號
          sfddsite LIKE sfdd_t.sfddsite, #營運據點
          sfdddocno LIKE sfdd_t.sfdddocno, #發退料單號
          sfddseq LIKE sfdd_t.sfddseq, #項次
          sfddseq1 LIKE sfdd_t.sfddseq1, #項序
          sfdd001 LIKE sfdd_t.sfdd001, #發退料料號
          sfdd002 LIKE sfdd_t.sfdd002, #替代率
          sfdd003 LIKE sfdd_t.sfdd003, #庫位
          sfdd004 LIKE sfdd_t.sfdd004, #儲位
          sfdd005 LIKE sfdd_t.sfdd005, #批號
          sfdd006 LIKE sfdd_t.sfdd006, #單位
          sfdd007 LIKE sfdd_t.sfdd007, #數量
          sfdd008 LIKE sfdd_t.sfdd008, #參考單位
          sfdd009 LIKE sfdd_t.sfdd009, #參考單位數量
          sfdd010 LIKE sfdd_t.sfdd010, #庫存管理特徵
          sfdd011 LIKE sfdd_t.sfdd011, #包裝容器
          sfdd012 LIKE sfdd_t.sfdd012, #正負
          sfdd013 LIKE sfdd_t.sfdd013, #產品特徵
          sfddud001 LIKE sfdd_t.sfddud001, #自定義欄位(文字)001
          sfddud002 LIKE sfdd_t.sfddud002, #自定義欄位(文字)002
          sfddud003 LIKE sfdd_t.sfddud003, #自定義欄位(文字)003
          sfddud004 LIKE sfdd_t.sfddud004, #自定義欄位(文字)004
          sfddud005 LIKE sfdd_t.sfddud005, #自定義欄位(文字)005
          sfddud006 LIKE sfdd_t.sfddud006, #自定義欄位(文字)006
          sfddud007 LIKE sfdd_t.sfddud007, #自定義欄位(文字)007
          sfddud008 LIKE sfdd_t.sfddud008, #自定義欄位(文字)008
          sfddud009 LIKE sfdd_t.sfddud009, #自定義欄位(文字)009
          sfddud010 LIKE sfdd_t.sfddud010, #自定義欄位(文字)010
          sfddud011 LIKE sfdd_t.sfddud011, #自定義欄位(數字)011
          sfddud012 LIKE sfdd_t.sfddud012, #自定義欄位(數字)012
          sfddud013 LIKE sfdd_t.sfddud013, #自定義欄位(數字)013
          sfddud014 LIKE sfdd_t.sfddud014, #自定義欄位(數字)014
          sfddud015 LIKE sfdd_t.sfddud015, #自定義欄位(數字)015
          sfddud016 LIKE sfdd_t.sfddud016, #自定義欄位(數字)016
          sfddud017 LIKE sfdd_t.sfddud017, #自定義欄位(數字)017
          sfddud018 LIKE sfdd_t.sfddud018, #自定義欄位(數字)018
          sfddud019 LIKE sfdd_t.sfddud019, #自定義欄位(數字)019
          sfddud020 LIKE sfdd_t.sfddud020, #自定義欄位(數字)020
          sfddud021 LIKE sfdd_t.sfddud021, #自定義欄位(日期時間)021
          sfddud022 LIKE sfdd_t.sfddud022, #自定義欄位(日期時間)022
          sfddud023 LIKE sfdd_t.sfddud023, #自定義欄位(日期時間)023
          sfddud024 LIKE sfdd_t.sfddud024, #自定義欄位(日期時間)024
          sfddud025 LIKE sfdd_t.sfddud025, #自定義欄位(日期時間)025
          sfddud026 LIKE sfdd_t.sfddud026, #自定義欄位(日期時間)026
          sfddud027 LIKE sfdd_t.sfddud027, #自定義欄位(日期時間)027
          sfddud028 LIKE sfdd_t.sfddud028, #自定義欄位(日期時間)028
          sfddud029 LIKE sfdd_t.sfddud029, #自定義欄位(日期時間)029
          sfddud030 LIKE sfdd_t.sfddud030, #自定義欄位(日期時間)030
          sfdd014 LIKE sfdd_t.sfdd014, #備置量
          sfdd015 LIKE sfdd_t.sfdd015  #在揀量
   END RECORD
   DEFINE l_sfdf RECORD  #發退料倉儲批匯總檔
          sfdfent LIKE sfdf_t.sfdfent, #企業編號
          sfdfsite LIKE sfdf_t.sfdfsite, #營運據點
          sfdfdocno LIKE sfdf_t.sfdfdocno, #發退料單號
          sfdfseq LIKE sfdf_t.sfdfseq, #項次
          sfdfseq1 LIKE sfdf_t.sfdfseq1, #項序
          sfdf001 LIKE sfdf_t.sfdf001, #發退料料號
          sfdf002 LIKE sfdf_t.sfdf002, #替代率
          sfdf003 LIKE sfdf_t.sfdf003, #庫位
          sfdf004 LIKE sfdf_t.sfdf004, #儲位
          sfdf005 LIKE sfdf_t.sfdf005, #批號
          sfdf006 LIKE sfdf_t.sfdf006, #單位
          sfdf007 LIKE sfdf_t.sfdf007, #數量
          sfdf008 LIKE sfdf_t.sfdf008, #參考單位
          sfdf009 LIKE sfdf_t.sfdf009, #參考單位數量
          sfdf010 LIKE sfdf_t.sfdf010, #庫存管理特徵
          sfdf011 LIKE sfdf_t.sfdf011, #包裝容器
          sfdf012 LIKE sfdf_t.sfdf012, #正負
          sfdf013 LIKE sfdf_t.sfdf013, #產品特徵
          sfdfud001 LIKE sfdf_t.sfdfud001, #自定義欄位(文字)001
          sfdfud002 LIKE sfdf_t.sfdfud002, #自定義欄位(文字)002
          sfdfud003 LIKE sfdf_t.sfdfud003, #自定義欄位(文字)003
          sfdfud004 LIKE sfdf_t.sfdfud004, #自定義欄位(文字)004
          sfdfud005 LIKE sfdf_t.sfdfud005, #自定義欄位(文字)005
          sfdfud006 LIKE sfdf_t.sfdfud006, #自定義欄位(文字)006
          sfdfud007 LIKE sfdf_t.sfdfud007, #自定義欄位(文字)007
          sfdfud008 LIKE sfdf_t.sfdfud008, #自定義欄位(文字)008
          sfdfud009 LIKE sfdf_t.sfdfud009, #自定義欄位(文字)009
          sfdfud010 LIKE sfdf_t.sfdfud010, #自定義欄位(文字)010
          sfdfud011 LIKE sfdf_t.sfdfud011, #自定義欄位(數字)011
          sfdfud012 LIKE sfdf_t.sfdfud012, #自定義欄位(數字)012
          sfdfud013 LIKE sfdf_t.sfdfud013, #自定義欄位(數字)013
          sfdfud014 LIKE sfdf_t.sfdfud014, #自定義欄位(數字)014
          sfdfud015 LIKE sfdf_t.sfdfud015, #自定義欄位(數字)015
          sfdfud016 LIKE sfdf_t.sfdfud016, #自定義欄位(數字)016
          sfdfud017 LIKE sfdf_t.sfdfud017, #自定義欄位(數字)017
          sfdfud018 LIKE sfdf_t.sfdfud018, #自定義欄位(數字)018
          sfdfud019 LIKE sfdf_t.sfdfud019, #自定義欄位(數字)019
          sfdfud020 LIKE sfdf_t.sfdfud020, #自定義欄位(數字)020
          sfdfud021 LIKE sfdf_t.sfdfud021, #自定義欄位(日期時間)021
          sfdfud022 LIKE sfdf_t.sfdfud022, #自定義欄位(日期時間)022
          sfdfud023 LIKE sfdf_t.sfdfud023, #自定義欄位(日期時間)023
          sfdfud024 LIKE sfdf_t.sfdfud024, #自定義欄位(日期時間)024
          sfdfud025 LIKE sfdf_t.sfdfud025, #自定義欄位(日期時間)025
          sfdfud026 LIKE sfdf_t.sfdfud026, #自定義欄位(日期時間)026
          sfdfud027 LIKE sfdf_t.sfdfud027, #自定義欄位(日期時間)027
          sfdfud028 LIKE sfdf_t.sfdfud028, #自定義欄位(日期時間)028
          sfdfud029 LIKE sfdf_t.sfdfud029, #自定義欄位(日期時間)029
          sfdfud030 LIKE sfdf_t.sfdfud030  #自定義欄位(日期時間)030
   END RECORD
   DEFINE l_sfdc_t RECORD  #發退料需求檔
          sfdcent LIKE sfdc_t.sfdcent, #企業編號
          sfdcsite LIKE sfdc_t.sfdcsite, #營運據點
          sfdcdocno LIKE sfdc_t.sfdcdocno, #發退料單號
          sfdcseq LIKE sfdc_t.sfdcseq, #項次
          sfdc001 LIKE sfdc_t.sfdc001, #工單單號
          sfdc002 LIKE sfdc_t.sfdc002, #工單項次
          sfdc003 LIKE sfdc_t.sfdc003, #工單項序
          sfdc004 LIKE sfdc_t.sfdc004, #需求料號
          sfdc005 LIKE sfdc_t.sfdc005, #產品特徵
          sfdc006 LIKE sfdc_t.sfdc006, #單位
          sfdc007 LIKE sfdc_t.sfdc007, #申請數量
          sfdc008 LIKE sfdc_t.sfdc008, #實際數量
          sfdc009 LIKE sfdc_t.sfdc009, #參考單位
          sfdc010 LIKE sfdc_t.sfdc010, #參考單位需求數量
          sfdc011 LIKE sfdc_t.sfdc011, #參考單位實際數量
          sfdc012 LIKE sfdc_t.sfdc012, #指定庫位
          sfdc013 LIKE sfdc_t.sfdc013, #指定儲位
          sfdc014 LIKE sfdc_t.sfdc014, #指定批號
          sfdc015 LIKE sfdc_t.sfdc015, #理由碼
          sfdc016 LIKE sfdc_t.sfdc016, #庫存管理特徴
          sfdc017 LIKE sfdc_t.sfdc017, #正負
          sfdcud001 LIKE sfdc_t.sfdcud001, #自定義欄位(文字)001
          sfdcud002 LIKE sfdc_t.sfdcud002, #自定義欄位(文字)002
          sfdcud003 LIKE sfdc_t.sfdcud003, #自定義欄位(文字)003
          sfdcud004 LIKE sfdc_t.sfdcud004, #自定義欄位(文字)004
          sfdcud005 LIKE sfdc_t.sfdcud005, #自定義欄位(文字)005
          sfdcud006 LIKE sfdc_t.sfdcud006, #自定義欄位(文字)006
          sfdcud007 LIKE sfdc_t.sfdcud007, #自定義欄位(文字)007
          sfdcud008 LIKE sfdc_t.sfdcud008, #自定義欄位(文字)008
          sfdcud009 LIKE sfdc_t.sfdcud009, #自定義欄位(文字)009
          sfdcud010 LIKE sfdc_t.sfdcud010, #自定義欄位(文字)010
          sfdcud011 LIKE sfdc_t.sfdcud011, #自定義欄位(數字)011
          sfdcud012 LIKE sfdc_t.sfdcud012, #自定義欄位(數字)012
          sfdcud013 LIKE sfdc_t.sfdcud013, #自定義欄位(數字)013
          sfdcud014 LIKE sfdc_t.sfdcud014, #自定義欄位(數字)014
          sfdcud015 LIKE sfdc_t.sfdcud015, #自定義欄位(數字)015
          sfdcud016 LIKE sfdc_t.sfdcud016, #自定義欄位(數字)016
          sfdcud017 LIKE sfdc_t.sfdcud017, #自定義欄位(數字)017
          sfdcud018 LIKE sfdc_t.sfdcud018, #自定義欄位(數字)018
          sfdcud019 LIKE sfdc_t.sfdcud019, #自定義欄位(數字)019
          sfdcud020 LIKE sfdc_t.sfdcud020, #自定義欄位(數字)020
          sfdcud021 LIKE sfdc_t.sfdcud021, #自定義欄位(日期時間)021
          sfdcud022 LIKE sfdc_t.sfdcud022, #自定義欄位(日期時間)022
          sfdcud023 LIKE sfdc_t.sfdcud023, #自定義欄位(日期時間)023
          sfdcud024 LIKE sfdc_t.sfdcud024, #自定義欄位(日期時間)024
          sfdcud025 LIKE sfdc_t.sfdcud025, #自定義欄位(日期時間)025
          sfdcud026 LIKE sfdc_t.sfdcud026, #自定義欄位(日期時間)026
          sfdcud027 LIKE sfdc_t.sfdcud027, #自定義欄位(日期時間)027
          sfdcud028 LIKE sfdc_t.sfdcud028, #自定義欄位(日期時間)028
          sfdcud029 LIKE sfdc_t.sfdcud029, #自定義欄位(日期時間)029
          sfdcud030 LIKE sfdc_t.sfdcud030  #自定義欄位(日期時間)030
   END RECORD
   DEFINE l_sfdd_t RECORD  #發退料明細檔
          sfddent LIKE sfdd_t.sfddent, #企業編號
          sfddsite LIKE sfdd_t.sfddsite, #營運據點
          sfdddocno LIKE sfdd_t.sfdddocno, #發退料單號
          sfddseq LIKE sfdd_t.sfddseq, #項次
          sfddseq1 LIKE sfdd_t.sfddseq1, #項序
          sfdd001 LIKE sfdd_t.sfdd001, #發退料料號
          sfdd002 LIKE sfdd_t.sfdd002, #替代率
          sfdd003 LIKE sfdd_t.sfdd003, #庫位
          sfdd004 LIKE sfdd_t.sfdd004, #儲位
          sfdd005 LIKE sfdd_t.sfdd005, #批號
          sfdd006 LIKE sfdd_t.sfdd006, #單位
          sfdd007 LIKE sfdd_t.sfdd007, #數量
          sfdd008 LIKE sfdd_t.sfdd008, #參考單位
          sfdd009 LIKE sfdd_t.sfdd009, #參考單位數量
          sfdd010 LIKE sfdd_t.sfdd010, #庫存管理特徵
          sfdd011 LIKE sfdd_t.sfdd011, #包裝容器
          sfdd012 LIKE sfdd_t.sfdd012, #正負
          sfdd013 LIKE sfdd_t.sfdd013, #產品特徵
          sfddud001 LIKE sfdd_t.sfddud001, #自定義欄位(文字)001
          sfddud002 LIKE sfdd_t.sfddud002, #自定義欄位(文字)002
          sfddud003 LIKE sfdd_t.sfddud003, #自定義欄位(文字)003
          sfddud004 LIKE sfdd_t.sfddud004, #自定義欄位(文字)004
          sfddud005 LIKE sfdd_t.sfddud005, #自定義欄位(文字)005
          sfddud006 LIKE sfdd_t.sfddud006, #自定義欄位(文字)006
          sfddud007 LIKE sfdd_t.sfddud007, #自定義欄位(文字)007
          sfddud008 LIKE sfdd_t.sfddud008, #自定義欄位(文字)008
          sfddud009 LIKE sfdd_t.sfddud009, #自定義欄位(文字)009
          sfddud010 LIKE sfdd_t.sfddud010, #自定義欄位(文字)010
          sfddud011 LIKE sfdd_t.sfddud011, #自定義欄位(數字)011
          sfddud012 LIKE sfdd_t.sfddud012, #自定義欄位(數字)012
          sfddud013 LIKE sfdd_t.sfddud013, #自定義欄位(數字)013
          sfddud014 LIKE sfdd_t.sfddud014, #自定義欄位(數字)014
          sfddud015 LIKE sfdd_t.sfddud015, #自定義欄位(數字)015
          sfddud016 LIKE sfdd_t.sfddud016, #自定義欄位(數字)016
          sfddud017 LIKE sfdd_t.sfddud017, #自定義欄位(數字)017
          sfddud018 LIKE sfdd_t.sfddud018, #自定義欄位(數字)018
          sfddud019 LIKE sfdd_t.sfddud019, #自定義欄位(數字)019
          sfddud020 LIKE sfdd_t.sfddud020, #自定義欄位(數字)020
          sfddud021 LIKE sfdd_t.sfddud021, #自定義欄位(日期時間)021
          sfddud022 LIKE sfdd_t.sfddud022, #自定義欄位(日期時間)022
          sfddud023 LIKE sfdd_t.sfddud023, #自定義欄位(日期時間)023
          sfddud024 LIKE sfdd_t.sfddud024, #自定義欄位(日期時間)024
          sfddud025 LIKE sfdd_t.sfddud025, #自定義欄位(日期時間)025
          sfddud026 LIKE sfdd_t.sfddud026, #自定義欄位(日期時間)026
          sfddud027 LIKE sfdd_t.sfddud027, #自定義欄位(日期時間)027
          sfddud028 LIKE sfdd_t.sfddud028, #自定義欄位(日期時間)028
          sfddud029 LIKE sfdd_t.sfddud029, #自定義欄位(日期時間)029
          sfddud030 LIKE sfdd_t.sfddud030, #自定義欄位(日期時間)030
          sfdd014 LIKE sfdd_t.sfdd014, #備置量
          sfdd015 LIKE sfdd_t.sfdd015  #在揀量
   END RECORD
   DEFINE l_sfdf_t RECORD  #發退料倉儲批匯總檔
          sfdfent LIKE sfdf_t.sfdfent, #企業編號
          sfdfsite LIKE sfdf_t.sfdfsite, #營運據點
          sfdfdocno LIKE sfdf_t.sfdfdocno, #發退料單號
          sfdfseq LIKE sfdf_t.sfdfseq, #項次
          sfdfseq1 LIKE sfdf_t.sfdfseq1, #項序
          sfdf001 LIKE sfdf_t.sfdf001, #發退料料號
          sfdf002 LIKE sfdf_t.sfdf002, #替代率
          sfdf003 LIKE sfdf_t.sfdf003, #庫位
          sfdf004 LIKE sfdf_t.sfdf004, #儲位
          sfdf005 LIKE sfdf_t.sfdf005, #批號
          sfdf006 LIKE sfdf_t.sfdf006, #單位
          sfdf007 LIKE sfdf_t.sfdf007, #數量
          sfdf008 LIKE sfdf_t.sfdf008, #參考單位
          sfdf009 LIKE sfdf_t.sfdf009, #參考單位數量
          sfdf010 LIKE sfdf_t.sfdf010, #庫存管理特徵
          sfdf011 LIKE sfdf_t.sfdf011, #包裝容器
          sfdf012 LIKE sfdf_t.sfdf012, #正負
          sfdf013 LIKE sfdf_t.sfdf013, #產品特徵
          sfdfud001 LIKE sfdf_t.sfdfud001, #自定義欄位(文字)001
          sfdfud002 LIKE sfdf_t.sfdfud002, #自定義欄位(文字)002
          sfdfud003 LIKE sfdf_t.sfdfud003, #自定義欄位(文字)003
          sfdfud004 LIKE sfdf_t.sfdfud004, #自定義欄位(文字)004
          sfdfud005 LIKE sfdf_t.sfdfud005, #自定義欄位(文字)005
          sfdfud006 LIKE sfdf_t.sfdfud006, #自定義欄位(文字)006
          sfdfud007 LIKE sfdf_t.sfdfud007, #自定義欄位(文字)007
          sfdfud008 LIKE sfdf_t.sfdfud008, #自定義欄位(文字)008
          sfdfud009 LIKE sfdf_t.sfdfud009, #自定義欄位(文字)009
          sfdfud010 LIKE sfdf_t.sfdfud010, #自定義欄位(文字)010
          sfdfud011 LIKE sfdf_t.sfdfud011, #自定義欄位(數字)011
          sfdfud012 LIKE sfdf_t.sfdfud012, #自定義欄位(數字)012
          sfdfud013 LIKE sfdf_t.sfdfud013, #自定義欄位(數字)013
          sfdfud014 LIKE sfdf_t.sfdfud014, #自定義欄位(數字)014
          sfdfud015 LIKE sfdf_t.sfdfud015, #自定義欄位(數字)015
          sfdfud016 LIKE sfdf_t.sfdfud016, #自定義欄位(數字)016
          sfdfud017 LIKE sfdf_t.sfdfud017, #自定義欄位(數字)017
          sfdfud018 LIKE sfdf_t.sfdfud018, #自定義欄位(數字)018
          sfdfud019 LIKE sfdf_t.sfdfud019, #自定義欄位(數字)019
          sfdfud020 LIKE sfdf_t.sfdfud020, #自定義欄位(數字)020
          sfdfud021 LIKE sfdf_t.sfdfud021, #自定義欄位(日期時間)021
          sfdfud022 LIKE sfdf_t.sfdfud022, #自定義欄位(日期時間)022
          sfdfud023 LIKE sfdf_t.sfdfud023, #自定義欄位(日期時間)023
          sfdfud024 LIKE sfdf_t.sfdfud024, #自定義欄位(日期時間)024
          sfdfud025 LIKE sfdf_t.sfdfud025, #自定義欄位(日期時間)025
          sfdfud026 LIKE sfdf_t.sfdfud026, #自定義欄位(日期時間)026
          sfdfud027 LIKE sfdf_t.sfdfud027, #自定義欄位(日期時間)027
          sfdfud028 LIKE sfdf_t.sfdfud028, #自定義欄位(日期時間)028
          sfdfud029 LIKE sfdf_t.sfdfud029, #自定義欄位(日期時間)029
          sfdfud030 LIKE sfdf_t.sfdfud030  #自定義欄位(日期時間)030
   END RECORD
   #161109-00085#62 --e add
   DEFINE l_sql            STRING
   DEFINE l_flag           LIKE type_t.chr1  #是否需要指定进入哪个单身，目前两个0不指定 b:sfdb单身 c:sfdc需求单身 d：sfdd单身 f:sfdf单身
   DEFINE l_cnt1           LIKE type_t.num5  #检查笔数用
   DEFINE l_cnt2           LIKE type_t.num5  #检查笔数用
   DEFINE l_where          STRING
   DEFINE l_flag2          LIKE type_t.num5  #s_control使用
   DEFINE l_imae023        LIKE imae_t.imae023
   #add 150107
   DEFINE l_sfba019  LIKE sfba_t.sfba019  #指定库位
   DEFINE l_sfba020  LIKE sfba_t.sfba020  #指定储位
   DEFINE l_sfba029  LIKE sfba_t.sfba029  #指定批号
   DEFINE l_sfba030  LIKE sfba_t.sfba030  #指定库存管理特征
   #add 150107 end
   DEFINE l_sfaadocdt LIKE sfaa_t.sfaadocdt  #150304 add
   DEFINE l_sfaa005   LIKE sfaa_t.sfaa005    #add by lixh 20150529
   DEFINE l_sfaa010   LIKE sfaa_t.sfaa010    #add by lixh 20150529
   DEFINE l_sfaa011   LIKE sfaa_t.sfaa010    #160914-00019#1
   DEFINE l_sfba001   LIKE sfba_t.sfba001    #160111-00028#1
   DEFINE j           LIKE type_t.num10
   DEFINE l_sfdc012_switch  LIKE type_t.chr1
   #add 150831 --begin
   DEFINE l_imaf071        LIKE imaf_t.imaf071
   DEFINE l_imaf081        LIKE imaf_t.imaf081
   DEFINE l_amount         LIKE sfdc_t.sfdc007
   DEFINE l_amountr        LIKE sfdc_t.sfdc010
   DEFINE l_inao013        LIKE inao_t.inao013   #出入库码
   DEFINE l_prog           LIKE gzzz_t.gzzz001   #作业编号（可当单据类型用）
   #add 150831 --end
   #end add-point
   DEFINE l_qty            LIKE sfdd_t.sfdd014    #160408-00035#7
   DEFINE l_sfdb006_15     LIKE sfdb_t.sfdb006    #已发套数      #160613-00019#1
   DEFINE l_sfdb006_25     LIKE sfdb_t.sfdb006    #已退套数      #160613-00019#1
   DEFINE l_sfcb050        LIKE sfcb_t.sfcb050    #良品轉入數量  #160613-00019#1   
   DEFINE l_ln             LIKE type_t.num5       #間隔項次      #161215-00075#1 add
   DEFINE l_sfdc002        LIKE sfdc_t.sfdc002    #工单项次      #161215-00075#1 add
   DEFINE l_sfdc002_1      LIKE sfdc_t.sfdc002    #工单项次      #170118-00057#1 add
   
   LET l_flag = '0'
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF

   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF

   CALL cl_set_head_visible("","YES")

   LET l_insert = FALSE
   LET g_action_choice = ""

   LET g_forupd_sql = "SELECT sfdb001,sfdb002,sfdb003,'',sfdb004,'',sfdb005,'','','','','',sfdb006,sfdb007,
       sfdb008 FROM sfdb_t WHERE sfdbent=? AND sfdbsite=? AND sfdbdocno=? AND sfdb001=? AND sfdb002=?
       AND sfdb003=? AND sfdb004=? AND sfdb005=? FOR UPDATE"
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料  #160731-00253#1
   DECLARE asft310_bcl CURSOR FROM g_forupd_sql

   LET g_forupd_sql = "SELECT sfdcseq,sfdc001,sfdc002,sfdc003,'','','','','','',sfdc004,'','',sfdc005,'',
       '','','',sfdc006,'','','',sfdc007,sfdc008,'',sfdc009,'',sfdc010,sfdc011,'',sfdc012,'',sfdc013,
       '',sfdc014,sfdc016,sfdc015,'',sfdc017 FROM sfdc_t WHERE sfdcent=? AND sfdcsite=?
       AND sfdcdocno=? AND sfdcseq=? FOR UPDATE"
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料  #160731-00253#1
   DECLARE asft310_bcl2 CURSOR FROM g_forupd_sql

   #LET g_forupd_sql = "SELECT sfdeseq,sfde001,'','',sfde002,'','','',sfde009,sfde003,'',sfde004,sfde005,
   #    '',sfde006,'',sfde007,sfde008,'',sfde010 FROM sfde_t WHERE sfdeent=? AND sfdesite=? AND sfdedocno=?
   #    AND sfdeseq=? FOR UPDATE"
   #LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   #DECLARE asft310_bcl3 CURSOR FROM g_forupd_sql

   #LET g_forupd_sql = "SELECT inaoseq,inaoseq1,inaoseq2,inao000,inao001,'','',inao008,inao009,inao010,
   #    inao012 FROM inao_t WHERE inaoent=? AND inaosite=? AND inaodocno=? AND inaoseq=? AND inaoseq1=?
   #    AND inaoseq2=? AND inao000=? FOR UPDATE"
   #LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   #DECLARE asft310_bcl4 CURSOR FROM g_forupd_sql

   LET g_forupd_sql = "SELECT sfdfseq1,sfdf001,'','',sfdf013,'',sfdf002,sfdf003,'',sfdf004,'',sfdf005,sfdf010,sfdf006,
       '',sfdf007,sfdf008,'',sfdf009,sfdf011,sfdf012 FROM sfdf_t WHERE sfdfent=? AND sfdfsite=? AND
       sfdfdocno=? AND sfdfseq=? AND sfdfseq1=? FOR UPDATE"
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料  #160731-00253#1
   DECLARE asft310_bcl5 CURSOR FROM g_forupd_sql

   LET g_forupd_sql = "SELECT sfddseq1,sfdd001,'','',sfdd013,'',sfdd002,sfdd003,'',sfdd004,'',sfdd005,sfdd010,sfdd006,
       '',sfdd007,sfdd008,'',sfdd009,sfdd011,sfdd012 FROM sfdd_t WHERE sfddent=? AND sfddsite=? AND
       sfdddocno=? AND sfddseq=? AND sfddseq1=? FOR UPDATE"
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料  #160731-00253#1
   DECLARE asft310_bcl6 CURSOR FROM g_forupd_sql

   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'

   #控制key欄位可否輸入
   CALL asft310_set_entry(p_cmd)
   CALL asft310_set_no_entry(p_cmd)

   DISPLAY BY NAME g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,
       g_sfda_m.sfda004,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt

   LET lb_reproduce = FALSE
   
   CALL cl_mask_set_no_entry()  #160731-00253#1

WHILE TRUE
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭段
      INPUT BY NAME g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,
          g_sfda_m.sfda004,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt

         ATTRIBUTE(WITHOUT DEFAULTS)

         #自訂ACTION(master_input)


         BEFORE INPUT
            IF g_sfda_m.sfdastus = 'Y' THEN #已审核的不能修改
               #单据已审核，只可修改发料明细或料号汇总页签
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00301'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET l_flag = 'f'
               CONTINUE WHILE
            END IF
            
            CALL asft310_set_entry(p_cmd)
           #151217-00023#5 add -----(S)
            IF g_mdemand = 'Y' THEN
               NEXT FIELD sfddseq1
            END IF
           #151217-00023#5 add -----(E)
            CALL asft310_set_no_entry(p_cmd)

            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF

            IF l_cmd_t = 'r' THEN

            END IF
#            IF g_prog = 'asft310' OR g_prog = 'asft320' THEN               #160623-00014#1-mod-(S)
            IF g_prog MATCHES 'asft310' OR g_prog MATCHES 'asft320' THEN   #160623-00014#1-mod-(E)
               #---visible---
               #15/25.製程中委發/退料 發/退料需求、發/退料明細、料號匯總、製造批序號頁籤隱藏不可維護
               CALL cl_set_comp_visible("page_3,page_4,page_5,page_6",TRUE)
               CALL cl_set_comp_visible("bpage_1",TRUE)
               CALL cl_set_comp_visible("sfdb002",TRUE)
               #部位  在制程中委外时隐藏不显示
               CALL cl_set_comp_visible("sfdb003,sfdb003_desc",TRUE)
               
               #---required---
               #制程委外时不可空白，其他的允许空白
               CALL cl_set_comp_required("sfdb004,sfdb005",FALSE)
            END IF

         #160914-00019#1-s
         AFTER FIELD sfdadocno
            LET g_sfda_m.oobal004 = ''
            DISPLAY BY NAME g_sfda_m.oobal004
            IF NOT cl_null(g_sfda_m.sfdadocno) THEN
               IF g_sfda_m.sfdadocno != g_sfda_m_o.sfdadocno OR cl_null(g_sfda_m_o.sfdadocno) THEN
                  IF NOT s_aooi200_chk_slip(g_site,'',g_sfda_m.sfdadocno,g_prog) THEN
                     LET g_sfda_m.sfdadocno = g_sfda_m_o.sfdadocno
                     LET g_sfda_m.oobal004 = s_aooi200_get_slip_desc(g_sfda_m.sfdadocno)
                     DISPLAY BY NAME g_sfda_m.oobal004
                     NEXT FIELD CURRENT
                  END IF
                  #檢核輸入的單據別是否可以被key人員對應的控制組使用,'6' 為生管控制組類型
                  CALL s_control_chk_doc('1',g_sfda_m.sfdadocno,'6',g_user,g_dept,'','')
                       RETURNING l_success,l_flag2
                  IF NOT l_success OR NOT l_flag2 THEN
                     LET g_sfda_m.sfdadocno = g_sfda_m_o.sfdadocno
                     LET g_sfda_m.oobal004 = s_aooi200_get_slip_desc(g_sfda_m.sfdadocno)
                     DISPLAY BY NAME g_sfda_m.oobal004
                     NEXT FIELD CURRENT
                  END IF
                  CALL asft310_get_doc_default()
                  #IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_sfda_m.sfdadocno != g_sfdadocno_t )) THEN
                  #   IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfda_t WHERE "||"sfdaent = '" ||g_enterprise|| "' AND sfdasite = '" ||g_site|| "' AND "||"sfdadocno = '"||g_sfda_m.sfdadocno ||"'",'std-00004',0) THEN
                  #      LET g_sfda_m.sfdadocno = g_sfdadocno_t
                  #      NEXT FIELD CURRENT
                  #   END IF
                  #END IF
               END IF
               LET g_sfda_m.oobal004 = s_aooi200_get_slip_desc(g_sfda_m.sfdadocno)
               DISPLAY BY NAME g_sfda_m.oobal004
               CALL asft310_show_sfda_ooff013()   #add 141222
            END IF
            LET g_sfda_m_o.sfdadocno = g_sfda_m.sfdadocno
            CALL asft310_set_entry(p_cmd)
            CALL asft310_set_no_entry(p_cmd)
         #160914-00019#1-e

         AFTER FIELD sfdadocdt
            IF NOT cl_null(g_sfda_m.sfdadocdt) THEN
            #160914-00019#1-s
               IF cl_null(g_sfda_m_o.sfdadocdt) OR g_sfda_m.sfdadocdt != g_sfda_m_o.sfdadocdt THEN
                  #不可小于等于关帐日期
                  IF g_sfda_m.sfdadocdt <= g_docdt THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00411'
                     LET g_errparam.extend = g_sfda_m.sfdadocdt
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfda_m.sfdadocdt = g_sfda_m_o.sfdadocdt
                     DISPLAY BY NAME g_sfda_m.sfdadocdt
                     NEXT FIELD sfdadocdt
                  END IF
               END IF
            END IF
            LET g_sfda_m_o.sfdadocdt = g_sfda_m.sfdadocdt
            #160914-00019#1-e
            
         AFTER FIELD sfda001
            IF NOT cl_null(g_sfda_m.sfda001) THEN
            #160914-00019#1-s
               IF cl_null(g_sfda_m_o.sfda001) OR g_sfda_m.sfda001 != g_sfda_m_o.sfda001 THEN
                  #不可小于等于关帐日期
                  IF g_sfda_m.sfda001 <= g_docdt THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00411'
                     LET g_errparam.extend = g_sfda_m.sfda001
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfda_m.sfda001 = g_sfda_m_o.sfda001
                     DISPLAY BY NAME g_sfda_m.sfda001
                     NEXT FIELD sfda001
                  END IF
               END IF
            END IF
            LET g_sfda_m_o.sfda001 = g_sfda_m.sfda001
            #160914-00019#1-e
            
         ON CHANGE sfda002
            IF NOT cl_null(g_sfda_m.sfda003) THEN
               IF NOT asft310_chk_sfda003() THEN
                  NEXT FIELD sfda003
               END IF
            END IF
            
         AFTER FIELD sfda003
            #160914-00019#1-s
            LET g_sfda_m.sfda003_desc = ''
            DISPLAY BY NAME g_sfda_m.sfda003_desc
            IF NOT cl_null(g_sfda_m.sfda003) THEN
               IF cl_null(g_sfda_m_o.sfda003) OR g_sfda_m.sfda003 != g_sfda_m_o.sfda003 THEN
                  IF NOT asft310_chk_sfda003() THEN
                     LET g_sfda_m.sfda003 = g_sfda_m_o.sfda003
                     LET g_sfda_m.sfda003_desc = asft310_sfda003_ref(g_sfda_m.sfda003)
                     DISPLAY BY NAME g_sfda_m.sfda003,g_sfda_m.sfda003_desc
                     NEXT FIELD sfda003
                  END IF
               END IF
               LET g_sfda_m.sfda003_desc = asft310_sfda003_ref(g_sfda_m.sfda003)
               DISPLAY BY NAME g_sfda_m.sfda003_desc
            END IF
            LET g_sfda_m_o.sfda003 = g_sfda_m.sfda003
            #160914-00019#1-e

         AFTER FIELD sfda004
            #160914-00019#1-s
            LET g_sfda_m.sfda004_desc = ''
            DISPLAY BY NAME g_sfda_m.sfda004_desc
            IF NOT cl_null(g_sfda_m.sfda004) THEN
               IF cl_null(g_sfda_m_o.sfda004) OR g_sfda_m.sfda004 != g_sfda_m_o.sfda004 THEN
                  IF NOT s_employee_chk(g_sfda_m.sfda004) THEN
                     LET g_sfda_m.sfda004 = g_sfda_m_o.sfda004
                     LET g_sfda_m.sfda004_desc = s_desc_get_person_desc(g_sfda_m.sfda004)
                     DISPLAY BY NAME g_sfda_m.sfda004,g_sfda_m.sfda004_desc
                     NEXT FIELD sfda004
                  END IF
               END IF
               LET g_sfda_m.sfda004_desc = s_desc_get_person_desc(g_sfda_m.sfda004)
               DISPLAY BY NAME g_sfda_m.sfda004_desc
            END IF
            LET g_sfda_m_o.sfda004 = g_sfda_m.sfda004
            #160914-00019#1-e
            
         AFTER FIELD sfda005
            IF NOT cl_null(g_sfda_m.sfda005) THEN
               IF cl_null(g_sfda_m_o.sfda005) OR g_sfda_m.sfda005 != g_sfda_m_o.sfda005 THEN
                  IF NOT asft310_chk_sfda005() THEN
                     LET g_sfda_m.sfda005 = g_sfda_m_o.sfda005
                     DISPLAY BY NAME g_sfda_m.sfda005
                     NEXT FIELD sfda005
                  END IF
               END IF
            END IF
            LET g_sfda_m_o.sfda005 = g_sfda_m.sfda005
         
         ON ACTION controlp INFIELD sfdadocno
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfda_m.sfdadocno  #給予default值
            #給予arg
            SELECT ooef004 INTO l_ooef004
              FROM ooef_t
             WHERE ooef001 = g_site
               AND ooefent  = g_enterprise
            LET g_qryparam.arg1 = l_ooef004 #參照表編號
            LET g_qryparam.arg2 = g_prog    #作业代号
            CALL q_ooba002_1()                            #呼叫開窗
            LET g_sfda_m.sfdadocno = g_qryparam.return1   #將開窗取得的值回傳到變數
            DISPLAY g_sfda_m.sfdadocno TO sfdadocno       #顯示到畫面上
            NEXT FIELD sfdadocno                          #返回原欄位

         ON ACTION controlp INFIELD sfda003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfda_m.sfda003  #給予default值
            IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN  #製程中委外時，顯示名稱為委外廠商
               CALL q_pmaa001_3()                       #呼叫開窗
            ELSE
               LET g_qryparam.arg1 = g_sfda_m.sfdadocdt #給予arg
               CALL q_ooeg001()                         #呼叫開窗
            END IF
            LET g_sfda_m.sfda003 = g_qryparam.return1   #將開窗取得的值回傳到變數
            DISPLAY g_sfda_m.sfda003 TO sfda003         #顯示到畫面上
            LET g_sfda_m.sfda003_desc = asft310_sfda003_ref(g_sfda_m.sfda003)  #160914-00019#1
            DISPLAY BY NAME g_sfda_m.sfda003_desc  #160914-00019#1
            NEXT FIELD sfda003                          #返回原欄位
            
         ON ACTION controlp INFIELD sfda004
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfda_m.sfda004  #給予default值
            CALL q_ooag001_2()                          #呼叫開窗
            LET g_sfda_m.sfda004 = g_qryparam.return1   #將開窗取得的值回傳到變數
            DISPLAY g_sfda_m.sfda004 TO sfda004         #顯示到畫面上
            LET g_sfda_m.sfda004_desc = s_desc_get_person_desc(g_sfda_m.sfda004)  #160914-00019#1
            DISPLAY BY NAME g_sfda_m.sfda004_desc  #160914-00019#1
            NEXT FIELD sfda004                          #返回原欄位 

         ON ACTION controlp INFIELD sfda005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfda_m.sfda005  #給予default值
            CALL q_sfqadocno()                          #呼叫開窗
            LET g_sfda_m.sfda005 = g_qryparam.return1   #將開窗取得的值回傳到變數
            DISPLAY g_sfda_m.sfda005 TO sfda005         #顯示到畫面上
            NEXT FIELD sfda005                          #返回原欄位 

         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
            
            #CALL cl_showmsg()      #錯誤訊息統整顯示  controlg后输入一个不存在的作业编号，报错，这边编辑完退出就会一直报错
            DISPLAY BY NAME g_sfda_m.sfdadocno
            
            IF p_cmd <> 'u' THEN
              #151217-00023#5 add -----(S)
               IF g_mdemand = 'Y' THEN
                  NEXT FIELD sfddseq1
               END IF
              #151217-00023#5 add -----(E)
               LET l_count = 1
               SELECT COUNT(1) INTO l_count FROM sfda_t
                WHERE sfdaent = g_enterprise AND sfdasite = g_site AND sfdadocno = g_sfda_m.sfdadocno
               IF l_count = 0 THEN
                  #add-point:單頭新增前
                  CALL s_aooi200_gen_docno(g_site,g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_prog)
                       RETURNING l_success,g_sfda_m.sfdadocno
                  IF NOT l_success THEN
                     NEXT FIELD sfdadocno
                  END IF          {#ADP版次:1#}
                  #end add-point

                  INSERT INTO sfda_t (sfdaent, sfdasite,sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,
                      sfda004,sfda005,sfda015,sfda014,sfdastus,sfdaownid,sfdaowndp,sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,
                      sfdamoddt,sfdacnfid,sfdacnfdt,sfdapstid,sfdapstdt)
                  VALUES (g_enterprise, g_site,g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,
                      g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda004,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,
                      g_sfda_m.sfdaownid,g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdt,
                      g_sfda_m.sfdamodid,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,
                      g_sfda_m.sfdapstdt)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "g_sfda_m"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CONTINUE DIALOG
                  END IF
                  
                  LET g_sfda_m_t.* = g_sfda_m.*
                  LET g_sfda_m_o.* = g_sfda_m.*  #160914-00019#1
                  CALL s_transaction_end('Y','0')

                  IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                     CALL asft310_detail_reproduce()  #执行复制的功能
                  END IF

                  LET p_cmd = 'u'

               ELSE
                  INITIALIZE g_errparam TO NULL
                  #LET g_errparam.code = '!'
                  LET g_errparam.code = 'std-00006'
                  LET g_errparam.extend =  g_sfda_m.sfdadocno
                  LET g_errparam.popup = FALSE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  NEXT FIELD sfdadocno
               END IF
            ELSE
              #151217-00023#5 add -----(S)
               IF g_mdemand = 'Y' THEN
                  NEXT FIELD sfddseq1
               END IF
              #151217-00023#5 add -----(E)
              
               UPDATE sfda_t SET (sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,
                   sfdaownid,sfdaowndp,sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,
                   sfdapstid,sfdapstdt) = (g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,
                   g_sfda_m.sfda003,g_sfda_m.sfda004,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,
                   g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,
                   g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt)
                WHERE sfdaent = g_enterprise AND sfdasite = g_site AND sfdadocno = g_sfdadocno_t
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "std-00009"
                     LET g_errparam.extend = "sfda_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_sfda_m.sfdadocno = g_sfdadocno_t  #add
                     CALL s_transaction_end('N','0')
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "sfda_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_sfda_m.sfdadocno = g_sfdadocno_t  #add
                     CALL s_transaction_end('N','0')
                  OTHERWISE
                     #add-point:单头修改後
                     #关联处理
                     LET l_success_tot = TRUE
                     #若key值变化，单身key跟着变化
                     IF g_sfda_m.sfdadocno != g_sfdadocno_t THEN
                        CALL asft310_upd_key() RETURNING l_success
                        IF NOT l_success THEN
                           LET l_success_tot = FALSE
                        END IF
                     END IF
                     IF NOT l_success_tot THEN
                        LET g_sfda_m.sfdadocno = g_sfdadocno_t
                        CALL s_transaction_end('N','0')
                     END IF
                     #end add-point
                     CALL s_transaction_end('Y','0')
               END CASE
            END IF
            LET g_sfdadocno_t = g_sfda_m.sfdadocno

#            IF g_prog = 'asft310' OR g_prog = 'asft320' THEN               #160623-00014#1-mod-(S)
            IF g_prog MATCHES 'asft310' OR g_prog MATCHES 'asft320' THEN  #160623-00014#1-mod-(E)
               #---visible---
               #发退料需求、料号汇总、发退料明细、制造批序号页签隐藏
               #部位  在制程中委外时隐藏不显示
               IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN
                  CALL cl_set_comp_visible("page_3,page_4,page_5,page_6",FALSE)
                  CALL cl_set_comp_visible("sfdb003,sfdb003_desc",FALSE)
               END IF
               #用不到套数页签的类型，套数页签隐藏
               IF g_sfda_m.sfda002 = '14' OR g_sfda_m.sfda002 = '23' OR g_sfda_m.sfda002 = '24' THEN
                  CALL cl_set_comp_visible("bpage_1",FALSE)
               END IF
               #runcard在类型为非制程委外时隐藏
               IF g_sfda_m.sfda002 != '15' AND g_sfda_m.sfda002 != '25' THEN
                  CALL cl_set_comp_visible("sfdb002",FALSE)
               END IF
               
               #---required---
               #制程委外时不可空白，其他的允许空白
               IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN
                  CALL cl_set_comp_required("sfdb004,sfdb005",TRUE)
               END IF
            END IF
            
            CALL asft310_show_sfda_ooff013()   #add 141222
            
            #mark 150101 移到单身问
            ##PBI自动产生单身
            #IF NOT cl_null(g_sfda_m.sfda005) THEN
            #   SELECT COUNT(1) INTO l_cnt1 FROM sfdb_t
            #    WHERE sfdbent   = g_enterprise
            #      AND sfdbdocno = g_sfda_m.sfdadocno
            #   SELECT COUNT(1) INTO l_cnt2 FROM sfdc_t
            #    WHERE sfdcent   = g_enterprise
            #      AND sfdcdocno = g_sfda_m.sfdadocno
            #   #单身没资料的可自动产生
            #   IF l_cnt1=0 AND l_cnt2=0 THEN
            #      IF cl_ask_confirm('asf-00473') THEN  #是否由【PBI编号】自动产生单身资料？
            #         CALL asft310_gen_b_sfda005()
            #      END IF
            #   END IF
            #END IF
            #mark 150101 end

      END INPUT

      #add 141222 begin
      #單頭段
      INPUT BY NAME g_sfda_m.sfda_ooff013
          ATTRIBUTE(WITHOUT DEFAULTS)

         #自訂ACTION
         
         BEFORE INPUT
         
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF

            CALL s_transaction_begin()
            IF NOT cl_null(g_sfda_m.sfda_ooff013) THEN
               CALL s_aooi360_gen('6',g_sfda_m.sfdadocno,' ',' ',' ',' ',' ',' ',' ',' ',' ','4',g_sfda_m.sfda_ooff013)
                  RETURNING l_success
            ELSE
               CALL s_aooi360_del('6',g_sfda_m.sfdadocno,' ',' ',' ',' ',' ',' ',' ',' ',' ','4')
                  RETURNING l_success
            END IF
            IF NOT l_success THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
      END INPUT
      #add 141222 end

      #Page1 預設值產生於此處
      INPUT ARRAY g_sfdb_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)

         #自訂ACTION(detail_input,page_1)


         BEFORE INPUT
            IF g_sfda_m.sfdastus = 'Y' THEN #已审核的不能修改
               #单据已审核，只可修改发料明细或料号汇总页签
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00301'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET l_flag = 'f'
               CONTINUE WHILE
            END IF
            IF g_sfda_m.sfda002 ='14' OR g_sfda_m.sfda002 ='23' OR g_sfda_m.sfda002 ='24'  #14.倒扣領料、23.一般退料、24.倒扣退料
            THEN
               CALL DIALOG.setCurrentRow("s_detail2",l_ac) #進入發/退料需求單身
               NEXT FIELD sfdcseq
            END IF

            #add 150101
            #PBI自动产生单身
            IF NOT cl_null(g_sfda_m.sfda005) THEN
               SELECT COUNT(1) INTO l_cnt1 FROM sfdb_t
                WHERE sfdbent   = g_enterprise
                  AND sfdbdocno = g_sfda_m.sfdadocno
               SELECT COUNT(1) INTO l_cnt2 FROM sfdc_t
                WHERE sfdcent   = g_enterprise
                  AND sfdcdocno = g_sfda_m.sfdadocno
               #单身没资料的可自动产生
               IF l_cnt1=0 AND l_cnt2=0 THEN
                  IF cl_ask_confirm('asf-00473') THEN  #是否由【PBI编号】自动产生单身资料？
                     CALL asft310_gen_b_sfda005()
                  END IF
               END IF
            END IF
            #add 150101 end
            
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN
              CALL FGL_SET_ARR_CURR(g_sfdb_d.getLength()+1)
              LET g_insert = 'N'
            END IF

            CALL asft310_b_fill()
            LET g_rec_b = g_sfdb_d.getLength()


         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac

            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx

            CALL s_transaction_begin()
            OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  STATUS
               LET g_errparam.extend = "OPEN asft310_cl:"
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CLOSE asft310_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF

            #FETCH asft310_cl INTO g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,
            #    g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,
            #    g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,
            #    g_sfda_m.sfdaowndp_desc,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,
            #    g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,
            #    g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,
            #    g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt #鎖住將被更改或取消的資料
            #IF SQLCA.sqlcode THEN
            #   #CALL cl_err(g_sfda_m.sfdadocno,SQLCA.sqlcode,0)
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.code = SQLCA.sqlcode
            #   LET g_errparam.extend = g_sfda_m.sfdadocno
            #   LET g_errparam.popup = FALSE
            #   CALL cl_err()
            #   CLOSE asft310_cl
            #   CALL s_transaction_end('N','0')
            #   RETURN
            #END IF

            LET g_rec_b = g_sfdb_d.getLength()

            IF g_rec_b >= l_ac
               AND g_sfdb_d[l_ac].sfdb001 IS NOT NULL
               AND g_sfdb_d[l_ac].sfdb002 IS NOT NULL
               AND g_sfdb_d[l_ac].sfdb003 IS NOT NULL
               AND g_sfdb_d[l_ac].sfdb004 IS NOT NULL
               AND g_sfdb_d[l_ac].sfdb005 IS NOT NULL
            THEN
               LET l_cmd='u'
               LET g_sfdb_d_t.* = g_sfdb_d[l_ac].*  #BACKUP
               LET g_sfdb_d_o.* = g_sfdb_d[l_ac].*  #BACKUP
               #CALL asft310_set_entry_b_sfdb(l_cmd)
               #CALL asft310_set_no_entry_b_sfdb(l_cmd)
               IF NOT asft310_lock_b("sfdb_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft310_bcl INTO g_sfdb_d[l_ac].sfdb001,g_sfdb_d[l_ac].sfdb002,g_sfdb_d[l_ac].sfdb003,
                      g_sfdb_d[l_ac].sfdb003_desc,g_sfdb_d[l_ac].sfdb004,g_sfdb_d[l_ac].sfdb004_desc,
                      g_sfdb_d[l_ac].sfdb005,g_sfdb_d[l_ac].sfaa010,g_sfdb_d[l_ac].sfaa010_desc,g_sfdb_d[l_ac].sfaa010_desc2,
                      g_sfdb_d[l_ac].sfaa012,g_sfdb_d[l_ac].sfaa013,g_sfdb_d[l_ac].sfdb006,g_sfdb_d[l_ac].sfdb007,
                      g_sfdb_d[l_ac].sfdb008
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = g_sfdb_d_t.sfdb001
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF

                  #mod 150121
                  #LET g_bfill = "N"
                  #CALL asft310_show()
                  #LET g_bfill = "Y"
                  CALL asft310_b_show('sfdb',l_ac)
                  #mod 150121 end

                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #160914-00019#1-s
            CALL asft310_set_entry_b_sfdb(l_cmd)
            CALL asft310_set_no_entry_b_sfdb(l_cmd)
            #160914-00019#1-e
            #其他table資料備份(確定是否更改用)

            #其他table進行lock


         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_sfdb_d[l_ac].* TO NULL
            LET g_sfdb_d_t.* = g_sfdb_d[l_ac].*     #新輸入資料
            LET g_sfdb_d_o.* = g_sfdb_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            #CALL asft310_set_entry_b_sfdb(l_cmd)
            #CALL asft310_set_no_entry_b_sfdb(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_sfdb_d[li_reproduce_target].* = g_sfdb_d[li_reproduce].*
               LET g_sfdb_d[li_reproduce_target].sfdb001 = NULL
               LET g_sfdb_d[li_reproduce_target].sfdb002 = NULL
               LET g_sfdb_d[li_reproduce_target].sfdb003 = NULL
               LET g_sfdb_d[li_reproduce_target].sfdb004 = NULL
               LET g_sfdb_d[li_reproduce_target].sfdb005 = NULL
            END IF
            #公用欄位給值(單身)
            #LET g_sfdb_d[l_ac].sfdb003 = ' '  #部位
            #LET g_sfdb_d[l_ac].sfdb004 = ' '  #作业
            #LET g_sfdb_d[l_ac].sfdb005 = ' '  #作业序 
            #mark reason：不能空格 否则required则不认识
            IF g_prog[1,6]='asft31' THEN
               LET g_sfdb_d[l_ac].sfdb008 = -1  #正负 发料-1
            END IF
            IF g_prog[1,6]='asft32' THEN
               LET g_sfdb_d[l_ac].sfdb008 = 1   #正负 退料1
            END IF
            CALL asft310_set_entry_b_sfdb(l_cmd)
            CALL asft310_set_no_entry_b_sfdb(l_cmd)

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            #add-point:單身新增
            #151222-00004#1 --- add start ---
            #於單身輸入工單單號後按下確定仍需判斷預計套數欄位的數量
            #预计套数
            IF NOT cl_null(g_sfdb_d[l_ac].sfdb006) THEN
               #13 欠料补料 必须为0
               IF g_sfda_m.sfda002 = '13' THEN
                  IF g_sfdb_d[l_ac].sfdb006 != 0 THEN
                     #此栏位必须为0
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00341'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     NEXT FIELD sfdb006
                  END IF
               END IF
               #11 成套发料 不可小于0,可以是0,代表做欠料补料的动作
               IF g_sfda_m.sfda002 = '11' THEN
                  IF NOT cl_ap_chk_Range(g_sfdb_d[l_ac].sfdb006,"0.000","1","","","azz-00079",1) THEN
                     NEXT FIELD sfdb006
                  END IF
               END IF
               #退料单\12 超领\15 制程委外发料 不可小于等于0
               IF g_prog[1,6] = 'asft32' OR g_sfda_m.sfda002 = '12' OR g_sfda_m.sfda002 = '15' THEN
                  IF g_sfdb_d[l_ac].sfdb006 <= 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00155'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     NEXT FIELD sfdb006
                  END IF
               END IF
               
               CASE
                 #成套發料控卡套數控卡，改為與工單的生產數量作比較即可(sfaa012)
                 #抓取除了本張單據其他的發料資料
                 WHEN g_sfda_m.sfda002='11'
                    LET l_sfdb006 =0
                    LET l_sfdb006_1 = 0  
                    LET l_sfdb006_max = 0
                    LET g_para = cl_get_para(g_enterprise,g_site,'S-MFG-0055')
                    
#                    IF g_para = 'Y' THEN   #發料套數控管否                 #161128-00043#1 mark
                       IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb004) THEN
                          SELECT SUM(sfdb006) INTO l_sfdb006 
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='11'
                             AND ( sfdb004 = g_sfdb_d[g_detail_idx].sfdb004 OR sfdb004 = ' ' )
                             AND sfdastus <> 'X' 
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                          SELECT SUM(sfdb006) INTO l_sfdb006_1
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='21'
                             AND ( sfdb004 = g_sfdb_d[g_detail_idx].sfdb004 OR sfdb004 = ' ' )   #151225 tsungyung add
                             AND sfdastus <> 'X' 
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                       ELSE
                          SELECT SUM(sfdb006) INTO l_sfdb006 
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='11'
                             AND sfdastus <> 'X' 
                             AND sfdb004 = ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site

                          SELECT SUM(sfdb006) INTO l_sfdb006_max 
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='11'
                             AND sfdastus <> 'X' 
                             AND sfdb004 <> ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                          
                          IF cl_null(l_sfdb006) THEN LET l_sfdb006 = 0 END IF
                          IF cl_null(l_sfdb006_max) THEN LET l_sfdb006_max = 0 END IF
                          LET l_sfdb006 = l_sfdb006 + l_sfdb006_max
                          LET l_sfdb006_max = 0
                          
                          SELECT SUM(sfdb006) INTO l_sfdb006_1
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='21'
                             AND sfdastus <> 'X' 
                             AND sfdb004 = ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                             
                          SELECT SUM(sfdb006) INTO l_sfdb006_max
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='21'
                             AND sfdastus <> 'X' 
                             AND sfdb004 <> ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site

                          IF cl_null(l_sfdb006_1) THEN LET l_sfdb006_1 = 0 END IF
                          IF cl_null(l_sfdb006_max) THEN LET l_sfdb006_max = 0 END IF
                          LET l_sfdb006_1 = l_sfdb006_1 + l_sfdb006_max
                          
                       END IF
                       LET l_sfdb006 = l_sfdb006 - l_sfdb006_1      #已发套数扣除已退数
#161128-00043#1 mark------s---------
#                    ELSE 
#                        SELECT SUM(sfdb007) INTO l_sfdb006 
#                         FROM sfda_t,sfdb_t
#                        WHERE sfdbent =sfdaent 
#                          AND sfdbdocno = sfdadocno
#                          AND sfdbsite = sfdasite
#                          AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
#                          AND sfda002='11'
#                          AND sfdastus <> 'X' 
#                          AND sfdbent = g_enterprise
#                          AND sfdbsite = g_site
#                          
#                          
#                     END IF 
#161128-00043#1 mark-----------e-------------

                     IF cl_null(l_sfdb006) THEN LET l_sfdb006 = 0 END IF   
                     
                     IF l_cmd = 'u' THEN #修改狀態要排除本身的舊值                                     
                        LET l_sfdb006 = l_sfdb006 - g_sfdb_d_t.sfdb006
                     END IF 
                     
                     IF g_sfdb_d[l_ac].sfdb006 + l_sfdb006 > g_sfdb_d[g_detail_idx].sfaa012 THEN
                       #不可超过最大可发/退料套数1%,请重新输入！
                       INITIALIZE g_errparam TO NULL
                       LET g_errparam.code = 'asf-00042'
                       LET g_errparam.extend = ''
                       LET g_errparam.popup = TRUE
                       LET g_errparam.replace[1] = g_sfdb_d[g_detail_idx].sfaa012
                       CALL cl_err()
                       NEXT FIELD CURRENT
                     END IF                     
                 
                  WHEN g_sfda_m.sfda002='14' #倒扣领料
                       #不能超过runcard剩余可发套数 
                       CALL s_asft310_get_max_set(l_cmd,'11',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                  WHEN g_sfda_m.sfda002='15' #制程中委外发料：预计套数不可大于用工单单号+Run Card+作业+制程序找到找到生产数量-委外发数量+委外退料数量
                       CALL s_asft310_get_max_set(l_cmd,'15',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                  WHEN g_sfda_m.sfda002='21' #成套退料：预计退料套数不可大于工单已发套数
                       CALL s_asft310_get_max_set(l_cmd,'21',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                  WHEN g_sfda_m.sfda002='25' #制程中委外退料：预计套数不可大于同一工单+Run card+作业+制程序的已发-退料套数
                       CALL s_asft310_get_max_set(l_cmd,'25',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
               END CASE

               CALL asft310_def_sfdb007()
            END IF
            
            LET g_sfdb_d_o.sfdb006 = g_sfdb_d[l_ac].sfdb006      
            #151222-00004#1 --- add end   ---
            
            IF cl_null(g_sfdb_d[l_ac].sfdb003) THEN
               LET g_sfdb_d[l_ac].sfdb003 = ' '
            END IF
            IF cl_null(g_sfdb_d[l_ac].sfdb004) THEN
               LET g_sfdb_d[l_ac].sfdb004 = ' '
            END IF
            IF cl_null(g_sfdb_d[l_ac].sfdb005) THEN
               LET g_sfdb_d[l_ac].sfdb005 = ' '
            END IF          {#ADP版次:1#}
            #end add-point

            LET l_count = 1
            SELECT COUNT(1) INTO l_count FROM sfdb_t
             WHERE sfdbent = g_enterprise AND sfdbsite = g_site AND sfdbdocno = g_sfda_m.sfdadocno
               AND sfdb001 = g_sfdb_d[l_ac].sfdb001
               AND sfdb002 = g_sfdb_d[l_ac].sfdb002
               AND sfdb003 = g_sfdb_d[l_ac].sfdb003
               AND sfdb004 = g_sfdb_d[l_ac].sfdb004
               AND sfdb005 = g_sfdb_d[l_ac].sfdb005
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfda_m.sfdadocno
               LET gs_keys[2] = g_sfdb_d[g_detail_idx].sfdb001
               LET gs_keys[3] = g_sfdb_d[g_detail_idx].sfdb002
               LET gs_keys[4] = g_sfdb_d[g_detail_idx].sfdb003
               LET gs_keys[5] = g_sfdb_d[g_detail_idx].sfdb004
               LET gs_keys[6] = g_sfdb_d[g_detail_idx].sfdb005
               CALL asft310_insert_b('sfdb_t',gs_keys,"'1'")
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               INITIALIZE g_sfdb_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "sfdb_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL asft310_b_fill()
               #資料多語言用-增/改
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF

         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_sfdb_d.deleteElement(l_ac)
               NEXT FIELD sfdb001
            END IF

            IF g_sfdb_d_t.sfdb001 IS NOT NULL
               AND g_sfdb_d_t.sfdb002 IS NOT NULL
               AND g_sfdb_d_t.sfdb003 IS NOT NULL
               AND g_sfdb_d_t.sfdb004 IS NOT NULL
               AND g_sfdb_d_t.sfdb005 IS NOT NULL
            THEN
               #160728-00032 by whitney modify start
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               #add
               #可删除否检查
               CALL asft310_del_sfdb_chk() RETURNING l_success
               IF NOT l_success THEN
                  CANCEL DELETE
               END IF
               #add --end
               #160728-00032 by whitney modify end
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CANCEL DELETE
               END IF

               DELETE FROM sfdb_t
                WHERE sfdbent = g_enterprise
                  AND sfdbdocno = g_sfda_m.sfdadocno
                  AND sfdb001 = g_sfdb_d_t.sfdb001
                  AND sfdb002 = g_sfdb_d_t.sfdb002
                  AND sfdb003 = g_sfdb_d_t.sfdb003
                  AND sfdb004 = g_sfdb_d_t.sfdb004
                  AND sfdb005 = g_sfdb_d_t.sfdb005
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "sfdb_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #CALL s_transaction_end('N','0')  事务结束后再回到before 单身状态，就没事务了
                  CANCEL DELETE
               ELSE
                  LET g_rec_b = g_rec_b-1
                  #add-point:單身2刪除後
                  #end add-point
                  CALL s_transaction_end('Y','0')
               END IF
               CLOSE asft310_bcl
               LET l_count = g_sfdb_d.getLength()
            END IF
            #INITIALIZE gs_keys TO NULL
            #LET gs_keys[1] = g_sfda_m.sfdadocno
            #LET gs_keys[2] = g_sfdb_d[g_detail_idx].sfdb001
            #LET gs_keys[3] = g_sfdb_d[g_detail_idx].sfdb002
            #LET gs_keys[4] = g_sfdb_d[g_detail_idx].sfdb003
            #LET gs_keys[5] = g_sfdb_d[g_detail_idx].sfdb004
            #LET gs_keys[6] = g_sfdb_d[g_detail_idx].sfdb005

         AFTER DELETE
            #IF asft310_delete_b('sfdb_t',gs_keys,"'1'") THEN
            #END IF

         #工单单号
         AFTER FIELD sfdb001
            IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb001) THEN
               IF cl_null(g_sfdb_d_t.sfdb001) OR g_sfdb_d[g_detail_idx].sfdb001 != g_sfdb_d_t.sfdb001 THEN
                  IF NOT asft310_sfdb001_chk() THEN
                     LET g_sfdb_d[g_detail_idx].sfdb001 = g_sfdb_d_t.sfdb001
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

            #add 150312 需求有工单的，这边不能被改掉
            IF NOT cl_null(g_sfdb_d_t.sfdb001) AND (cl_null(g_sfdb_d_t.sfdb001) OR g_sfdb_d[g_detail_idx].sfdb001 != g_sfdb_d_t.sfdb001) THEN
               #160728-00032 by whitney modify start
               #LET l_cnt1 = 0
               #LET l_cnt2 = 0
               #SELECT COUNT(1) INTO l_cnt1 FROM sfdc_t  #是否存在于需求单重
               # WHERE sfdcent   = g_enterprise
               #   AND sfdcdocno = g_sfda_m.sfdadocno
               #   AND sfdc001   = g_sfdb_d_t.sfdb001
               #SELECT COUNT(1) INTO l_cnt2 FROM sfdb_t  #除当笔之外是否还有此工单的
               # WHERE sfdbent   = g_enterprise
               #   AND sfdbdocno = g_sfda_m.sfdadocno
               #   AND sfdb001   = g_sfdb_d_t.sfdb001
               #IF l_cnt1 > 0 AND l_cnt2 =1 THEN
               #   #已存在需求申請資料，不可刪除或修改，請刪除需求申請資料后再重新操作
               #   INITIALIZE g_errparam TO NULL
               #   LET g_errparam.code = 'asf-00115'
               #   LET g_errparam.extend = ''
               #   LET g_errparam.popup = TRUE
               #   CALL cl_err()
               IF NOT asft310_del_sfdb_chk() THEN
               #160728-00032 by whitney modify end
                  LET g_sfdb_d[g_detail_idx].sfdb001 = g_sfdb_d_t.sfdb001
                  NEXT FIELD CURRENT
               END IF
            END IF
            #add 150312 end
   
            IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb001) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfdb_d[g_detail_idx].sfdb001 != g_sfdb_d_o.sfdb001)) THEN
                  CALL asft310_sfdb001_reference(l_cmd)
               END IF
            END IF
            
            LET g_sfdb_d_o.sfdb001 = g_sfdb_d[g_detail_idx].sfdb001

         #Run Card
         AFTER FIELD sfdb002
            IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb002) THEN
               #检查是否在工单制程档中的Run Card内(asft301)
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_site
               LET g_chkparam.arg2 = g_sfdb_d[g_detail_idx].sfdb001
               LET g_chkparam.arg3 = g_sfdb_d[g_detail_idx].sfdb002
               IF NOT cl_chk_exist("v_sfca001") THEN
                  NEXT FIELD CURRENT
               END IF

#               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfdb_d[g_detail_idx].sfdb002 != g_sfdb_d_o.sfdb002)) THEN  #160204-00007 by whitney mark
               IF g_sfdb_d[g_detail_idx].sfdb002 != g_sfdb_d_o.sfdb002 THEN  #160204-00007 by whitney add
                  IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb001) THEN
                     #计算预计套数
                     CALL asft310_def_sfdb006(l_cmd) RETURNING g_sfdb_d[g_detail_idx].sfdb006
                     CALL asft310_def_sfdb007()
                  END IF
               END IF
            END IF

            LET g_sfdb_d_o.sfdb002 = g_sfdb_d[g_detail_idx].sfdb002
            
         #部位
         AFTER FIELD sfdb003
            #160914-00019#1-s
            LET g_sfdb_d[l_ac].sfdb003_desc = ''
            IF NOT cl_null(g_sfdb_d[l_ac].sfdb003) THEN
               IF cl_null(g_sfdb_d_o.sfdb003) OR g_sfdb_d[l_ac].sfdb003 != g_sfdb_d_o.sfdb003 THEN
                  IF NOT asft310_sfdb003_chk() THEN
                     LET g_sfdb_d[l_ac].sfdb003 = g_sfdb_d_o.sfdb003
                     CALL s_desc_get_acc_desc('215',g_sfdb_d[l_ac].sfdb003) RETURNING g_sfdb_d[l_ac].sfdb003_desc
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb001) THEN
                     #计算预计套数
                     CALL asft310_def_sfdb006(l_cmd) RETURNING g_sfdb_d[l_ac].sfdb006
                     CALL asft310_def_sfdb007()
                  END IF
               END IF
               CALL s_desc_get_acc_desc('215',g_sfdb_d[l_ac].sfdb003) RETURNING g_sfdb_d[l_ac].sfdb003_desc
            END IF
            LET g_sfdb_d_o.sfdb003 = g_sfdb_d[l_ac].sfdb003
            #160914-00019#1-e
         
         #作业
         AFTER FIELD sfdb004
            #160914-00019#1-s
            LET g_sfdb_d[l_ac].sfdb004_desc = ''
            IF cl_null(g_sfdb_d[l_ac].sfdb004) THEN
               #作业不输入，作业序空格
               LET g_sfdb_d[l_ac].sfdb004 = ' '
               LET g_sfdb_d[l_ac].sfdb005 = ' '
            ELSE
               IF cl_null(g_sfdb_d_o.sfdb004) OR g_sfdb_d[l_ac].sfdb004 != g_sfdb_d_o.sfdb004 THEN
                  IF NOT asft310_sfdb004_chk() THEN
                     LET g_sfdb_d[l_ac].sfdb004 = g_sfdb_d_o.sfdb004
                     CALL s_desc_get_acc_desc('221',g_sfdb_d[l_ac].sfdb004) RETURNING g_sfdb_d[l_ac].sfdb004_desc
                     NEXT FIELD CURRENT
                  END IF
                  IF cl_null(g_sfdb_d[l_ac].sfdb005) THEN
                     CALL asft310_def_sfdb005()
                  END IF
                  IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb001) THEN
                     #计算预计套数
                     CALL asft310_def_sfdb006(l_cmd) RETURNING g_sfdb_d[l_ac].sfdb006
                     CALL asft310_def_sfdb007()
                  END IF
               END IF
               CALL s_desc_get_acc_desc('221',g_sfdb_d[l_ac].sfdb004) RETURNING g_sfdb_d[l_ac].sfdb004_desc
            END IF
            LET g_sfdb_d_o.sfdb004 = g_sfdb_d[l_ac].sfdb004
            CALL asft310_set_entry_b_sfdb(l_cmd)
            CALL asft310_set_no_entry_b_sfdb(l_cmd)
            #160914-00019#1-e
         
         #作业序
         AFTER FIELD sfdb005
            IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb005) THEN
            #160914-00019#1-s
               IF g_sfdb_d[l_ac].sfdb005 != g_sfdb_d_o.sfdb005 OR cl_null(g_sfdb_d_o.sfdb005) THEN
                  IF NOT asft310_sfdb005_chk() THEN
                     LET g_sfdb_d[l_ac].sfdb005 = g_sfdb_d_o.sfdb005
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb001) THEN
                     #计算预计套数
                     CALL asft310_def_sfdb006(l_cmd) RETURNING g_sfdb_d[l_ac].sfdb006
                     CALL asft310_def_sfdb007()
                  END IF
               END IF
            END IF
            LET g_sfdb_d_o.sfdb005 = g_sfdb_d[l_ac].sfdb005
            #160914-00019#1-e

         AFTER FIELD sfdb006
            #预计套数
            IF NOT cl_null(g_sfdb_d[l_ac].sfdb006) THEN
               #13 欠料补料 必须为0
               IF g_sfda_m.sfda002 = '13' THEN
                  IF g_sfdb_d[l_ac].sfdb006 != 0 THEN
                     #此栏位必须为0
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00341'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     NEXT FIELD sfdb006
                  END IF
               END IF
               #11 成套发料 不可小于0,可以是0,代表做欠料补料的动作
               IF g_sfda_m.sfda002 = '11' THEN
                  IF NOT cl_ap_chk_Range(g_sfdb_d[l_ac].sfdb006,"0.000","1","","","azz-00079",1) THEN
                     NEXT FIELD sfdb006
                  END IF
               END IF
               #退料单\12 超领\15 制程委外发料 不可小于等于0
               IF g_prog[1,6] = 'asft32' OR g_sfda_m.sfda002 = '12' OR g_sfda_m.sfda002 = '15' THEN
                  IF g_sfdb_d[l_ac].sfdb006 <= 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00155'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     NEXT FIELD sfdb006
                  END IF
               END IF
               
               CASE
                 #151222-00004#1 --- add start ---
                 #成套發料控卡套數控卡，改為與工單的生產數量作比較即可(sfaa012)
                 #抓取除了本張單據其他的發料資料
                 WHEN g_sfda_m.sfda002='11'
                    LET l_sfdb006 =0
                    LET l_sfdb006_1 = 0
                    LET l_sfdb006_max = 0
                    LET g_para = cl_get_para(g_enterprise,g_site,'S-MFG-0055')
                    
#                    IF g_para = 'Y' THEN   #發料套數控管否     #161128-00043#1 mark
                       IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb004) THEN
                          SELECT SUM(sfdb006) INTO l_sfdb006 
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='11'
                             AND ( sfdb004 = g_sfdb_d[g_detail_idx].sfdb004 OR sfdb004 = ' ' )
                             AND sfdastus <> 'X' 
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                          SELECT SUM(sfdb006) INTO l_sfdb006_1
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='21'
                             AND ( sfdb004 = g_sfdb_d[g_detail_idx].sfdb004 OR sfdb004 = ' ' )
                             AND sfdastus <> 'X' 
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                       ELSE
                          SELECT SUM(sfdb006) INTO l_sfdb006 
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='11'
                             AND sfdastus <> 'X' 
                             AND sfdb004 = ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site

                          SELECT SUM(sfdb006) INTO l_sfdb006_max 
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='11'
                             AND sfdastus <> 'X' 
                             AND sfdb004 <> ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                          
                          IF cl_null(l_sfdb006) THEN LET l_sfdb006 = 0 END IF
                          IF cl_null(l_sfdb006_max) THEN LET l_sfdb006_max = 0 END IF
                          LET l_sfdb006 = l_sfdb006 + l_sfdb006_max
                          LET l_sfdb006_max = 0
                          
                          SELECT SUM(sfdb006) INTO l_sfdb006_1
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='21'
                             AND sfdastus <> 'X' 
                             AND sfdb004 = ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site
                             
                          SELECT SUM(sfdb006) INTO l_sfdb006_max
                            FROM sfda_t,sfdb_t
                           WHERE sfdbent =sfdaent 
                             AND sfdbdocno = sfdadocno
                             AND sfdbsite = sfdasite
                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                             AND sfda002='21'
                             AND sfdastus <> 'X' 
                             AND sfdb004 <> ' '
                             AND sfdbent = g_enterprise
                             AND sfdbsite = g_site

                          IF cl_null(l_sfdb006_1) THEN LET l_sfdb006_1 = 0 END IF
                          IF cl_null(l_sfdb006_max) THEN LET l_sfdb006_max = 0 END IF
                          LET l_sfdb006_1 = l_sfdb006_1 + l_sfdb006_max
                       END IF
                       IF cl_null(l_sfdb006_1) THEN LET l_sfdb006_1 = 0 END IF
                       LET l_sfdb006 = l_sfdb006 - l_sfdb006_1      #已发套数扣除已退数
#161128-00043#1 mark -------------s-----------                       
#                     ELSE 
#                        SELECT SUM(sfdb007) INTO l_sfdb006 
#                         FROM sfda_t,sfdb_t
#                        WHERE sfdbent =sfdaent 
#                          AND sfdbdocno = sfdadocno
#                          AND sfdbsite = sfdasite
#                          AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
#                          AND sfda002='11'
#                          AND sfdastus <> 'X' 
#                          AND sfdbent = g_enterprise
#                          AND sfdbsite = g_site
#                     END IF 
#161128-00043#1 mark-----------e-----------

                     IF cl_null(l_sfdb006) THEN LET l_sfdb006 = 0 END IF   
                     
                     IF l_cmd = 'u' THEN #修改狀態要排除本身的舊值                                     
                        LET l_sfdb006 = l_sfdb006 - g_sfdb_d_t.sfdb006
                     END IF 
                     
                     IF g_sfdb_d[l_ac].sfdb006 + l_sfdb006 > g_sfdb_d[g_detail_idx].sfaa012 THEN
                       #不可超过最大可发/退料套数1%,请重新输入！
                       INITIALIZE g_errparam TO NULL
                       LET g_errparam.code = 'asf-00042'
                       LET g_errparam.extend = ''
                       LET g_errparam.popup = TRUE
                       LET g_errparam.replace[1] = g_sfdb_d[g_detail_idx].sfaa012
                       CALL cl_err()
                       NEXT FIELD CURRENT
                     END IF                     
                 #151222-00004#1 --- add end   ---
                 
                  #WHEN g_sfda_m.sfda002='11' OR g_sfda_m.sfda002='14' #成套发料、倒扣领料  #151222-00004#1 mark
                  WHEN g_sfda_m.sfda002='14' #倒扣领料     #151222-00004#1 add
                       #不能超过runcard剩余可发套数 
                       #mod 141229
                       #CALL asft310_get_max_set(l_cmd,'11') RETURNING l_sfdb006
                       CALL s_asft310_get_max_set(l_cmd,'11',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       #mod 141229 end
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                  WHEN g_sfda_m.sfda002='15' #制程中委外发料：预计套数不可大于用工单单号+Run Card+作业+制程序找到找到生产数量-委外发数量+委外退料数量
                       #mod 141229
                       #CALL asft310_get_max_set(l_cmd,'15') RETURNING l_sfdb006
                       CALL s_asft310_get_max_set(l_cmd,'15',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       #mod 141229 end
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                       #160613-00019#1-s
                       #asft315工單+Run Card+作業編號+作業序累計預計套數sfdb006不可大於asft301中製程的良品轉入數量sfcb050
                       LET l_sfdb006_15 = 0
                       LET l_sfdb006_25 = 0
                       LET l_sfcb050 = 0
                       #委外发料数量
                       CALL s_asft310_get_sfdb006('15','N',g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,g_sfdb_d[g_detail_idx].sfdb005)
                          RETURNING l_sfdb006_15
                       #修改状态下，需减去旧值
                       IF l_cmd = 'u' THEN
                          LET l_sfdb006_15 = l_sfdb006_15 - g_sfdb_d_t.sfdb006
                       END IF            
                       #委外退料数量
                       CALL s_asft310_get_sfdb006('25','Y',g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,g_sfdb_d[g_detail_idx].sfdb005)
                          RETURNING l_sfdb006_25
                       #製程的良品轉入數量
                       SELECT sfcb050 INTO l_sfcb050 FROM sfcb_t 
                        WHERE sfcbent   = g_enterprise
                          AND sfcbsite  = g_site
                          AND sfcbdocno = g_sfdb_d[g_detail_idx].sfdb001   #工單單號
                          AND sfcb001   = g_sfdb_d[g_detail_idx].sfdb002   #Run Card
                          AND sfcb003   = g_sfdb_d[g_detail_idx].sfdb004   #作業編號
                          AND sfcb004   = g_sfdb_d[g_detail_idx].sfdb005   #作業序
                       IF cl_null(l_sfcb050) THEN LET l_sfcb050 = 0 END IF
                       IF l_sfdb006_15 - l_sfdb006_25 + g_sfdb_d[g_detail_idx].sfdb006 > l_sfcb050 THEN                          
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00728'  #工單+Run Card+作業編號+作業序累計預計套數 不可大於 製程的良品轉入數量
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006_15 - l_sfdb006_25 + g_sfdb_d[g_detail_idx].sfdb006
                          LET g_errparam.replace[2] = l_sfcb050
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                       #160613-00019#1-e
                  WHEN g_sfda_m.sfda002='21' #成套退料：预计退料套数不可大于工单已发套数
                       #mod 141229
                       #CALL asft310_get_max_set(l_cmd,'21') RETURNING l_sfdb006
                       CALL s_asft310_get_max_set(l_cmd,'21',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       #mod 141229 end
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
                  WHEN g_sfda_m.sfda002='25' #制程中委外退料：预计套数不可大于同一工单+Run card+作业+制程序的已发-退料套数
                       #mod 141229
                       #CALL asft310_get_max_set(l_cmd,'25') RETURNING l_sfdb006
                       CALL s_asft310_get_max_set(l_cmd,'25',g_sfda_m.sfdadocno,
                                                  g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                  g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                  g_sfdb_d[g_detail_idx].sfdb005,
                                                  g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                  g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                          RETURNING l_sfdb006
                       #mod 141229 end
                       IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = l_sfdb006
                          CALL cl_err()
                          NEXT FIELD CURRENT
                       END IF
               END CASE

               #LET g_sfdb_d[l_ac].sfdb007 = g_sfdb_d[l_ac].sfdb006
               CALL asft310_def_sfdb007()
            END IF
            
            LET g_sfdb_d_o.sfdb006 = g_sfdb_d[l_ac].sfdb006

         #工單單號
         ON ACTION controlp INFIELD sfdb001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdb_d[l_ac].sfdb001
            LET g_qryparam.where = " sfaasite='",g_site,"' AND sfaastus='F' "
            #170111-00041#1-s-mark
#            #160906-00040#1-s
#            IF g_sfda_m.sfda002 = '21' THEN
#               LET g_qryparam.where = g_qryparam.where," AND sfaa057='1' "
#            END IF
#            #160906-00040#1-e
            #170111-00041#1-e-mark
            #150909 earl mod s
            #組合過濾前後置單據資料SQL
            CALL s_aooi210_get_check_sql(g_site,'',g_sfda_m.sfdadocno,'4','','sfaadocno') RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where," AND ",l_where
            #150909 earl mod e
               #mark 150827
               #IF g_sfda_m.sfda002='22' THEN   #超领退料只开有超领量的
               #   LET g_qryparam.where = g_qryparam.where CLIPPED,
               #                          " AND sfaadocno in (select unique sfbadocno from sfba_t ",
               #                          "                  where sfbaent   = ",g_enterprise,
               #                          "                    and sfbasite  = '",g_site,"' ",
               #                          "                    and sfba025 > 0 ) "
               #END IF
               ##单头PBI
               #IF NOT cl_null(g_sfda_m.sfda005) THEN
               #   LET g_qryparam.where = g_qryparam.where CLIPPED,
               #                          " AND sfaadocno in (select unique sfqb001 from sfqb_t ",
               #                          "                  where sfqbent   = ",g_enterprise,
               #                          "                    and sfqbdocno = '",g_sfda_m.sfda005,"') "
               #END IF
               #CALL q_sfaadocno_3()
               #mark 150827 end
               CALL q_sfaadocno_12(g_sfda_m.sfda002,g_sfda_m.sfda005)  #add 150827
               LET g_sfdb_d[l_ac].sfdb001 = g_qryparam.return1
               DISPLAY g_sfdb_d[l_ac].sfdb001 TO sfdb001
            END IF #150909 earl add
            NEXT FIELD sfdb001  #160914-00019#1
            
         #Run Card單號
         ON ACTION controlp INFIELD sfdb002
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdb_d[l_ac].sfdb002
            LET g_qryparam.where = " sfcasite ='",g_site,"'"
            IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfcadocno='",g_sfdb_d[l_ac].sfdb001,"'"
            END IF
            CALL q_sfca001_2()
            LET g_sfdb_d[l_ac].sfdb002 = g_qryparam.return1
            DISPLAY g_sfdb_d[l_ac].sfdb002 TO sfdb002

         #部位
         ON ACTION controlp INFIELD sfdb003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdb_d[l_ac].sfdb003
            LET g_qryparam.where = " sfbasite ='",g_site,"' "
            IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfbadocno='",g_sfdb_d[l_ac].sfdb001,"'"
            END IF
            IF NOT cl_null(g_sfdb_d[l_ac].sfdb004) THEN  #作业编号
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba003='",g_sfdb_d[l_ac].sfdb004,"'"
            END IF
            CALL q_sfba002()
            LET g_sfdb_d[l_ac].sfdb003 = g_qryparam.return1
            DISPLAY g_sfdb_d[l_ac].sfdb003 TO sfdb003
            LET g_sfdb_d[l_ac].sfdb003_desc = s_desc_get_acc_desc('215',g_sfdb_d[l_ac].sfdb003)  #160914-00019#1
            NEXT FIELD sfdb003

         #作业编号
         ON ACTION controlp INFIELD sfdb004
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdb_d[l_ac].sfdb004
            IF g_sfda_m.sfda002='15' OR g_sfda_m.sfda002='25' THEN
               LET g_qryparam.where = " sfcbsite ='",g_site,"' AND sfcb012='Y'"
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN  #工单单号
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfcbdocno='",g_sfdb_d[l_ac].sfdb001,"'"
               END IF
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb002) THEN  #Run Card
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfcb001= ",g_sfdb_d[l_ac].sfdb002
               END IF
               CALL q_sfcb003_3()
            ELSE
               LET g_qryparam.where = " sfbasite ='",g_site,"'"
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN  #工单单号
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfbadocno='",g_sfdb_d[l_ac].sfdb001,"'"
               END IF
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb003) THEN  #部位
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba002='",g_sfdb_d[l_ac].sfdb003,"'"
               END IF
               CALL q_sfba003()
            END IF
            LET g_sfdb_d[l_ac].sfdb004 = g_qryparam.return1
            DISPLAY g_sfdb_d[l_ac].sfdb004 TO sfdb004
            LET g_sfdb_d[l_ac].sfdb004_desc = s_desc_get_acc_desc('221',g_sfdb_d[l_ac].sfdb004)  #160914-00019#1
            NEXT FIELD sfdb004

         #作业序
         ON ACTION controlp INFIELD sfdb005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdb_d[l_ac].sfdb005
            IF g_sfda_m.sfda002='15' OR g_sfda_m.sfda002='25' THEN
               LET g_qryparam.where = " sfcbsite ='",g_site,"' AND sfcb012='Y'"
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN  #工单单号
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfcbdocno='",g_sfdb_d[l_ac].sfdb001,"'"
               END IF
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb002) THEN  #Run Card
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfcb001= ",g_sfdb_d[l_ac].sfdb002
               END IF
               CALL q_sfcb004_2()
            ELSE
               LET g_qryparam.where = " sfbasite ='",g_site,"' "
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN  #工单单号
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfbadocno='",g_sfdb_d[l_ac].sfdb001,"'"
               END IF
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb003) THEN  #部位
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba002='",g_sfdb_d[l_ac].sfdb003,"'"
               END IF
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb004) THEN  #作业编号
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba003='",g_sfdb_d[l_ac].sfdb004,"'"
               END IF
               CALL q_sfba004()
            END IF
            LET g_sfdb_d[l_ac].sfdb005 = g_qryparam.return1
            DISPLAY g_sfdb_d[l_ac].sfdb005 TO sfdb005
            NEXT FIELD sfdb005  #160914-00019#1

         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_sfdb_d[l_ac].* = g_sfdb_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE asft310_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_sfdb_d[l_ac].* = g_sfdb_d_t.*
            ELSE
               #寫入修改者/修改日期資訊(單身)
               IF cl_null(g_sfdb_d[l_ac].sfdb003) THEN LET g_sfdb_d[l_ac].sfdb003 = ' ' END IF
               IF cl_null(g_sfdb_d[l_ac].sfdb004) THEN LET g_sfdb_d[l_ac].sfdb004 = ' ' END IF
               IF cl_null(g_sfdb_d[l_ac].sfdb005) THEN LET g_sfdb_d[l_ac].sfdb005 = ' ' END IF
               UPDATE sfdb_t SET (sfdbdocno,sfdb001,sfdb002,sfdb003,sfdb004,sfdb005,sfdb006,sfdb007,
                   sfdb008) = (g_sfda_m.sfdadocno,g_sfdb_d[l_ac].sfdb001,g_sfdb_d[l_ac].sfdb002,g_sfdb_d[l_ac].sfdb003,
                   g_sfdb_d[l_ac].sfdb004,g_sfdb_d[l_ac].sfdb005,g_sfdb_d[l_ac].sfdb006,g_sfdb_d[l_ac].sfdb007,
                   g_sfdb_d[l_ac].sfdb008)
                WHERE sfdbent = g_enterprise AND sfdbsite = g_site AND sfdbdocno = g_sfda_m.sfdadocno
                  AND sfdb001 = g_sfdb_d_t.sfdb001 #項次
                  AND sfdb002 = g_sfdb_d_t.sfdb002
                  AND sfdb003 = g_sfdb_d_t.sfdb003
                  AND sfdb004 = g_sfdb_d_t.sfdb004
                  AND sfdb005 = g_sfdb_d_t.sfdb005
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_sfdb_d[l_ac].* = g_sfdb_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "sfdb_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_sfdb_d[l_ac].* = g_sfdb_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "sfdb_t:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                  #OTHERWISE
                  #   #資料多語言用-增/改
                  #   INITIALIZE gs_keys TO NULL
                  #   LET gs_keys[1] = g_sfda_m.sfdadocno
                  #   LET gs_keys_bak[1] = g_sfdadocno_t
                  #   LET gs_keys[2] = g_sfdb_d[g_detail_idx].sfdb001
                  #   LET gs_keys_bak[2] = g_sfdb_d_t.sfdb001
                  #   LET gs_keys[3] = g_sfdb_d[g_detail_idx].sfdb002
                  #   LET gs_keys_bak[3] = g_sfdb_d_t.sfdb002
                  #   LET gs_keys[4] = g_sfdb_d[g_detail_idx].sfdb003
                  #   LET gs_keys_bak[4] = g_sfdb_d_t.sfdb003
                  #   LET gs_keys[5] = g_sfdb_d[g_detail_idx].sfdb004
                  #   LET gs_keys_bak[5] = g_sfdb_d_t.sfdb004
                  #   LET gs_keys[6] = g_sfdb_d[g_detail_idx].sfdb005
                  #   LET gs_keys_bak[6] = g_sfdb_d_t.sfdb005
                  #   CALL asft310_update_b('sfdb_t',gs_keys,gs_keys_bak,"'1'")
               END CASE
               #160914-00019#1-s
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_sfdb_d),util.JSON.stringify(g_sfdb_d_t)
               LET g_log2 = util.JSON.stringify(g_sfdb_d),util.JSON.stringify(g_sfdb_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               #160914-00019#1-e
            END IF

         AFTER ROW
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_sfdb_d[l_ac].* = g_sfdb_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE asft310_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF

            #其他table進行unlock

            CALL asft310_unlock_b("sfdb_t","'1'")
            CALL s_transaction_end('Y','0')

         AFTER INPUT
            #151222-00004#1 --- add start ---
            #於單身輸入工單單號後按下確定仍需判斷預計套數欄位的數量
            #预计套数
            IF l_cmd = 'u' THEN
               IF NOT cl_null(g_sfdb_d[l_ac].sfdb006) THEN
                  #13 欠料补料 必须为0
                  IF g_sfda_m.sfda002 = '13' THEN
                     IF g_sfdb_d[l_ac].sfdb006 != 0 THEN
                        #此栏位必须为0
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00341'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD sfdb006
                     END IF
                  END IF
                  #11 成套发料 不可小于0,可以是0,代表做欠料补料的动作
                  IF g_sfda_m.sfda002 = '11' THEN
                     IF NOT cl_ap_chk_Range(g_sfdb_d[l_ac].sfdb006,"0.000","1","","","azz-00079",1) THEN
                        NEXT FIELD sfdb006
                     END IF
                  END IF
                  #退料单\12 超领\15 制程委外发料 不可小于等于0
                  IF g_prog[1,6] = 'asft32' OR g_sfda_m.sfda002 = '12' OR g_sfda_m.sfda002 = '15' THEN
                     IF g_sfdb_d[l_ac].sfdb006 <= 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00155'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD sfdb006
                     END IF
                  END IF
                  
                  CASE
                    #成套發料控卡套數控卡，改為與工單的生產數量作比較即可(sfaa012)
                    #抓取除了本張單據其他的發料資料
                    WHEN g_sfda_m.sfda002='11'
                       LET l_sfdb006 =0
                       LET l_sfdb006_1 = 0  
                       LET l_sfdb006_max = 0
                       LET g_para = cl_get_para(g_enterprise,g_site,'S-MFG-0055')
                       
#                       IF g_para = 'Y' THEN   #發料套數控管否     #161128-00043#1 mark
                          IF NOT cl_null(g_sfdb_d[g_detail_idx].sfdb004) THEN
                             SELECT SUM(sfdb006) INTO l_sfdb006 
                               FROM sfda_t,sfdb_t
                              WHERE sfdbent =sfdaent 
                                AND sfdbdocno = sfdadocno
                                AND sfdbsite = sfdasite
                                AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                                AND sfda002='11'
                                AND ( sfdb004 = g_sfdb_d[g_detail_idx].sfdb004 OR sfdb004 = ' ' )
                                AND sfdastus <> 'X' 
                                AND sfdbent = g_enterprise
                                AND sfdbsite = g_site
                             SELECT SUM(sfdb006) INTO l_sfdb006_1
                               FROM sfda_t,sfdb_t
                              WHERE sfdbent =sfdaent 
                                AND sfdbdocno = sfdadocno
                                AND sfdbsite = sfdasite
                                AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                                AND sfda002='21'
                                AND ( sfdb004 = g_sfdb_d[g_detail_idx].sfdb004 OR sfdb004 = ' ' )   #151225 tsungyung add
                                AND sfdastus <> 'X' 
                                AND sfdbent = g_enterprise
                                AND sfdbsite = g_site
                          ELSE
                             SELECT SUM(sfdb006) INTO l_sfdb006 
                               FROM sfda_t,sfdb_t
                              WHERE sfdbent =sfdaent 
                                AND sfdbdocno = sfdadocno
                                AND sfdbsite = sfdasite
                                AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                                AND sfda002='11'
                                AND sfdastus <> 'X' 
                                AND sfdb004 = ' '
                                AND sfdbent = g_enterprise
                                AND sfdbsite = g_site
               
                             SELECT SUM(sfdb006) INTO l_sfdb006_max 
                               FROM sfda_t,sfdb_t
                              WHERE sfdbent =sfdaent 
                                AND sfdbdocno = sfdadocno
                                AND sfdbsite = sfdasite
                                AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                                AND sfda002='11'
                                AND sfdastus <> 'X' 
                                AND sfdb004 <> ' '
                                AND sfdbent = g_enterprise
                                AND sfdbsite = g_site
                             
                             IF cl_null(l_sfdb006) THEN LET l_sfdb006 = 0 END IF
                             IF cl_null(l_sfdb006_max) THEN LET l_sfdb006_max = 0 END IF
                             LET l_sfdb006 = l_sfdb006 + l_sfdb006_max
                             LET l_sfdb006_max = 0
                             
                             SELECT SUM(sfdb006) INTO l_sfdb006_1
                               FROM sfda_t,sfdb_t
                              WHERE sfdbent =sfdaent 
                                AND sfdbdocno = sfdadocno
                                AND sfdbsite = sfdasite
                                AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                                AND sfda002='21'
                                AND sfdastus <> 'X' 
                                AND sfdb004 = ' '
                                AND sfdbent = g_enterprise
                                AND sfdbsite = g_site
                                
                             SELECT SUM(sfdb006) INTO l_sfdb006_max
                               FROM sfda_t,sfdb_t
                              WHERE sfdbent =sfdaent 
                                AND sfdbdocno = sfdadocno
                                AND sfdbsite = sfdasite
                                AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
                                AND sfda002='21'
                                AND sfdastus <> 'X' 
                                AND sfdb004 <> ' '
                                AND sfdbent = g_enterprise
                                AND sfdbsite = g_site
               
                             IF cl_null(l_sfdb006_1) THEN LET l_sfdb006_1 = 0 END IF
                             IF cl_null(l_sfdb006_max) THEN LET l_sfdb006_max = 0 END IF
                             LET l_sfdb006_1 = l_sfdb006_1 + l_sfdb006_max
                             
                          END IF
                          LET l_sfdb006 = l_sfdb006 - l_sfdb006_1      #已发套数扣除已退数
#161128-00043#1 mark----------s-----------                          
#                       ELSE 
#                           SELECT SUM(sfdb007) INTO l_sfdb006 
#                            FROM sfda_t,sfdb_t
#                           WHERE sfdbent =sfdaent 
#                             AND sfdbdocno = sfdadocno
#                             AND sfdbsite = sfdasite
#                             AND sfdb001 = g_sfdb_d[g_detail_idx].sfdb001
#                             AND sfda002='11'
#                             AND sfdastus <> 'X' 
#                             AND sfdbent = g_enterprise
#                             AND sfdbsite = g_site
#                        END IF 
#161128-00043#1 mark----------e------------               
               
                        IF cl_null(l_sfdb006) THEN LET l_sfdb006 = 0 END IF   
                        
                        IF l_cmd = 'u' THEN #修改狀態要排除本身的舊值                                     
                           LET l_sfdb006 = l_sfdb006 - g_sfdb_d_t.sfdb006
                        END IF 
                        
                        IF g_sfdb_d[l_ac].sfdb006 + l_sfdb006 > g_sfdb_d[g_detail_idx].sfaa012 THEN
                          #不可超过最大可发/退料套数1%,请重新输入！
                          INITIALIZE g_errparam TO NULL
                          LET g_errparam.code = 'asf-00042'
                          LET g_errparam.extend = ''
                          LET g_errparam.popup = TRUE
                          LET g_errparam.replace[1] = g_sfdb_d[g_detail_idx].sfaa012
                          CALL cl_err()
                          NEXT FIELD CURRENT
                        END IF                     
                    
                     WHEN g_sfda_m.sfda002='14' #倒扣领料
                          #不能超过runcard剩余可发套数 
                          CALL s_asft310_get_max_set(l_cmd,'11',g_sfda_m.sfdadocno,
                                                     g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                     g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                     g_sfdb_d[g_detail_idx].sfdb005,
                                                     g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                     g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                             RETURNING l_sfdb006
                          IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                             #不可超过最大可发/退料套数1%,请重新输入！
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = 'asf-00042'
                             LET g_errparam.extend = ''
                             LET g_errparam.popup = TRUE
                             LET g_errparam.replace[1] = l_sfdb006
                             CALL cl_err()
                             NEXT FIELD CURRENT
                          END IF
                     WHEN g_sfda_m.sfda002='15' #制程中委外发料：预计套数不可大于用工单单号+Run Card+作业+制程序找到找到生产数量-委外发数量+委外退料数量
                          CALL s_asft310_get_max_set(l_cmd,'15',g_sfda_m.sfdadocno,
                                                     g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                     g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                     g_sfdb_d[g_detail_idx].sfdb005,
                                                     g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                     g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                             RETURNING l_sfdb006
                          IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                             #不可超过最大可发/退料套数1%,请重新输入！
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = 'asf-00042'
                             LET g_errparam.extend = ''
                             LET g_errparam.popup = TRUE
                             LET g_errparam.replace[1] = l_sfdb006
                             CALL cl_err()
                             NEXT FIELD CURRENT
                          END IF
                     WHEN g_sfda_m.sfda002='21' #成套退料：预计退料套数不可大于工单已发套数
                          CALL s_asft310_get_max_set(l_cmd,'21',g_sfda_m.sfdadocno,
                                                     g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                     g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                     g_sfdb_d[g_detail_idx].sfdb005,
                                                     g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                     g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                             RETURNING l_sfdb006
                          IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                             #不可超过最大可发/退料套数1%,请重新输入！
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = 'asf-00042'
                             LET g_errparam.extend = ''
                             LET g_errparam.popup = TRUE
                             LET g_errparam.replace[1] = l_sfdb006
                             CALL cl_err()
                             NEXT FIELD CURRENT
                          END IF
                     WHEN g_sfda_m.sfda002='25' #制程中委外退料：预计套数不可大于同一工单+Run card+作业+制程序的已发-退料套数
                          CALL s_asft310_get_max_set(l_cmd,'25',g_sfda_m.sfdadocno,
                                                     g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                                                     g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                                                     g_sfdb_d[g_detail_idx].sfdb005,
                                                     g_sfdb_d_t.sfdb001,g_sfdb_d_t.sfdb002,g_sfdb_d_t.sfdb003,
                                                     g_sfdb_d_t.sfdb004,g_sfdb_d_t.sfdb005,g_sfdb_d_t.sfdb006)
                             RETURNING l_sfdb006
                          IF g_sfdb_d[l_ac].sfdb006 > l_sfdb006 THEN
                             #不可超过最大可发/退料套数1%,请重新输入！
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = 'asf-00042'
                             LET g_errparam.extend = ''
                             LET g_errparam.popup = TRUE
                             LET g_errparam.replace[1] = l_sfdb006
                             CALL cl_err()
                             NEXT FIELD CURRENT
                          END IF
                  END CASE
               
                  CALL asft310_def_sfdb007()
               END IF
               
               LET g_sfdb_d_o.sfdb006 = g_sfdb_d[l_ac].sfdb006
            END IF               
            #151222-00004#1 --- add end   ---
            
            SELECT COUNT(1) INTO l_cnt1 FROM sfdb_t  #套数单身笔数
             WHERE sfdbent  = g_enterprise
               AND sfdbdocno= g_sfda_m.sfdadocno
            SELECT COUNT(1) INTO l_cnt2 FROM sfdc_t  #需求单身笔数
             WHERE sfdcent  = g_enterprise
               AND sfdcdocno= g_sfda_m.sfdadocno
            ##成套发、成套退、欠料补料发、制程委外发退，必须打套数
            #IF g_sfda_m.sfda002 = '11' OR g_sfda_m.sfda002 = '13' OR g_sfda_m.sfda002 = '21'
            #OR g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN
            #   IF l_cnt1 = 0 THEN   #套数单身笔数
            #      #当前发/退料类别，套数单身必须维护数据;请维护套数单身数据，或确认单头发退料类别是否正确！
            #      INITIALIZE g_errparam TO NULL
            #      LET g_errparam.code = 'asf-00331'
            #      LET g_errparam.extend = ''
            #      LET g_errparam.popup = TRUE
            #      CALL cl_err()
            #      NEXT FIELD sfdb001
            #   END IF
            #END IF
            #超领发12和超领退22可以打套数，也可以不打套数，打了套数则需要开asft310_01
            #成套发11、成套退21、欠料补料发13，必须打套数,需要开asft310_01
            #制程委外发退15,25，必须打套数，不需要开asft310_01
            #其他类型的发退料单14,23,24，用不到套数页签，套数页签隐藏，不需要打开asft310_01
            IF g_sfda_m.sfda002 = '11' OR g_sfda_m.sfda002 = '13' OR g_sfda_m.sfda002 = '21'
            OR g_sfda_m.sfda002 = '12' OR g_sfda_m.sfda002 = '22' THEN
               IF l_cnt1 >0 AND l_cnt2 = 0 THEN    #套数单身笔数,需求单身笔数 #没产生过才自动跳出来，否则总跳烦
                  IF asft310_01_cre_tmp_table() THEN
                     CALL s_transaction_begin()
                     CALL asft310_01(g_sfda_m.sfdadocno)
                        RETURNING l_success
                     IF l_success = TRUE THEN
                        CALL s_transaction_end('Y','0')
                     ELSE
                        CALL s_transaction_end('N','0')
                     END IF
                     CALL asft310_01_drop_tmp_table()
                  END IF
               END IF
            END IF

         ON ACTION controlo
            CALL FGL_SET_ARR_CURR(g_sfdb_d.getLength()+1)
            LET lb_reproduce = TRUE
            LET li_reproduce = l_ac
            LET li_reproduce_target = g_sfdb_d.getLength()+1

      END INPUT

      INPUT ARRAY g_sfdc_d FROM s_detail2.*
         ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效!

                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)

         #自訂ACTION(detail_input,page_2)

         #发/退料需求产生
         ON ACTION gen_sfdc
            #LET g_action_choice="gen_sfdc"
            IF g_sfda_m.sfda002 != '11' AND g_sfda_m.sfda002 != '13' AND g_sfda_m.sfda002 != '21' AND g_sfda_m.sfda002 != '12' AND g_sfda_m.sfda002 != '22' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00169'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD CURRENT
            END IF

            SELECT COUNT(1) INTO l_cnt FROM sfdb_t
             WHERE sfdbent  = g_enterprise
               AND sfdbdocno= g_sfda_m.sfdadocno
            IF l_cnt = 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00170'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD CURRENT
            END IF

            IF cl_auth_chk_act("gen_sfdc") THEN
               #add-point:ON ACTION gen_sfdc
               CALL s_transaction_end('N','0')
               IF asft310_01_cre_tmp_table() THEN
                  CALL s_transaction_begin()
                  CALL asft310_01(g_sfda_m.sfdadocno)
                     RETURNING l_success
                  IF l_success = TRUE THEN
                     CALL s_transaction_end('Y','0')
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
                  CALL asft310_01_drop_tmp_table()
               END IF
               LET l_flag = 'c'
               LET l_ac = 1
               CONTINUE WHILE
               #END add-point
            END IF
         
         #add 150831 --begin
         #ON ACTION s_lot_sel1
         #   LET g_action_choice="s_lot_sel1"
         #   IF cl_auth_chk_act("s_lot_sel1") THEN
         #      IF NOT cl_null(g_sfda_m.sfdadocno) AND
         #         NOT cl_null(g_sfdc_d[l_ac].sfdcseq) AND
         #         NOT cl_null(g_sfdc_d[l_ac].sfdc004) AND #料件
         #         NOT cl_null(g_sfdc_d[l_ac].sfdc006) AND #单位
         #         NOT cl_null(g_sfdc_d[l_ac].sfdc007) AND #数量
         #         NOT cl_null(g_sfda_m.sfda004) THEN  #申请人
         #         LET l_success = ''
         #         CALL s_lot_sel('1','1',g_site,g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc016,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,'-1',g_prog,'')
         #              RETURNING l_success
         #         IF NOT l_success THEN
         #            CALL s_transaction_end('N','0')
         #         END IF
         #      END IF
         #   END IF
         #add 150831 --end
         
         BEFORE INPUT
            IF g_sfda_m.sfdastus = 'Y' THEN #已审核的不能修改
               #单据已审核，只可修改发料明细或料号汇总页签
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00301'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET l_flag = 'f'
               CONTINUE WHILE
            END IF
            #成套发、成套退、欠料补料发、制程委外发退，必须打套数
            IF g_sfda_m.sfda002 = '11' OR g_sfda_m.sfda002 = '13' OR g_sfda_m.sfda002 = '21'
            OR g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN
               SELECT COUNT(1) INTO l_cnt1 FROM sfdb_t  #套数单身笔数
                WHERE sfdbent  = g_enterprise
                  AND sfdbdocno= g_sfda_m.sfdadocno
               IF l_cnt1 = 0 THEN   #套数单身笔数
                  #当前发/退料类别，套数单身必须维护数据;请维护套数单身数据，或确认单头发退料类别是否正确！
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00331'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfdb001
               END IF
            END IF
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN
               CALL FGL_SET_ARR_CURR(g_sfdc_d.getLength()+1)
               LET g_insert = 'N'
            END IF

            CALL asft310_b_fill()
            LET g_rec_b = g_sfdc_d.getLength()
            #add-point:資料輸入前
           #151217-00023#5 add -----(S)
            IF g_mdemand = 'Y' THEN
               NEXT FIELD sfddseq1
            END IF
           #151217-00023#5 add -----(E)
            #由發料單別參數"發料理由碼不可空白"控制理由碼是不是一定要輸入
            CALL cl_set_comp_required("sfdc015",FALSE)
            #参数D-MFG-0032：發料理由碼是否可空白
            CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
            CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0032') RETURNING g_para
            IF g_para = 'N' THEN  #不可空白
               CALL cl_set_comp_required("sfdc015",TRUE)
            END IF
            
            #发料需求产生按钮隐藏显示gen_sfdc
            #只有11,12,13,21,22才允许点击“发退料需求产生”按钮。在其他作业中，把这个按钮进行隐藏
            CALL cl_set_act_visible_toolbaritem("gen_sfdc",TRUE)
            IF g_sfda_m.sfda002 != '11' AND g_sfda_m.sfda002 != '13' AND g_sfda_m.sfda002 != '21'
            AND g_sfda_m.sfda002 != '12' AND g_sfda_m.sfda002 != '22' THEN
               CALL cl_set_act_visible_toolbaritem("gen_sfdc",FALSE)
            END IF
            #end add-point

         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_sfdc_d[l_ac].* TO NULL
            LET g_sfdc_d_t.* = g_sfdc_d[l_ac].*     #新輸入資料
            LET g_sfdc_d_o.* = g_sfdc_d[l_ac].*     #新輸入資料
            LET g_sfdc_d[l_ac].sfdc008 = "0"
            LET g_sfdc_d[l_ac].sfdc011 = "0"
            CALL cl_show_fld_cont()
            #CALL asft310_set_entry_b_sfdc(l_cmd)
            #CALL asft310_set_no_entry_b_sfdc(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_sfdc_d[li_reproduce_target].* = g_sfdc_d[li_reproduce].*
               LET g_sfdc4_d[li_reproduce_target].* = g_sfdc4_d[li_reproduce].*
               LET g_sfdc_d[li_reproduce_target].sfdcseq = NULL
            END IF

            SELECT MAX(sfdcseq) INTO g_sfdc_d[l_ac].sfdcseq  #项次
              FROM sfdc_t
             WHERE sfdcent = g_enterprise
               AND sfdcsite= g_site
               AND sfdcdocno=g_sfda_m.sfdadocno
            IF g_sfdc_d[l_ac].sfdcseq IS NULL THEN
               LET g_sfdc_d[l_ac].sfdcseq = 0
            END IF
            LET g_sfdc_d[l_ac].sfdcseq = g_sfdc_d[l_ac].sfdcseq + 1
            IF g_prog[1,6]='asft31' THEN
               LET g_sfdc_d[l_ac].sfdc017 = -1  #正负 发料-1
            END IF
            IF g_prog[1,6]='asft32' THEN
               LET g_sfdc_d[l_ac].sfdc017 =  1  #正负 退料1
            END IF
            CALL asft310_set_entry_b_sfdc(l_cmd)
            CALL asft310_set_no_entry_b_sfdc(l_cmd)

         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            CALL asft310_b_fill2('6')

            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx

            CALL s_transaction_begin()
            OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  STATUS
               LET g_errparam.extend = "OPEN asft310_cl:"
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CLOSE asft310_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            #FETCH asft310_cl INTO g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,
            #    g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,
            #    g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,
            #    g_sfda_m.sfdaowndp_desc,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,
            #    g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,
            #    g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,
            #    g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt #鎖住將被更改或取消的資料
            #IF SQLCA.sqlcode THEN
            #   #CALL cl_err(g_sfda_m.sfdadocno,SQLCA.sqlcode,0)
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.code =  SQLCA.sqlcode
            #   LET g_errparam.extend = g_sfda_m.sfdadocno
            #   LET g_errparam.popup = FALSE
            #   CALL cl_err()
            #   CLOSE asft310_cl
            #   CALL s_transaction_end('N','0')
            #   RETURN
            #END IF

            LET g_rec_b = g_sfdc_d.getLength()

            IF g_rec_b >= l_ac
               AND g_sfdc_d[l_ac].sfdcseq IS NOT NULL
            THEN
               LET l_cmd='u'
               LET g_sfdc_d_t.* = g_sfdc_d[l_ac].*  #BACKUP
               LET g_sfdc_d_o.* = g_sfdc_d[l_ac].*  #BACKUP
               #add
               #SELECT * INTO l_sfdc_t.* FROM sfdc_t  #161109-00085#62 mark
               #161109-00085#62--s add
               SELECT sfdcent,sfdcsite,sfdcdocno,sfdcseq,sfdc001,
                      sfdc002,sfdc003,sfdc004,sfdc005,sfdc006,
                      sfdc007,sfdc008,sfdc009,sfdc010,sfdc011,
                      sfdc012,sfdc013,sfdc014,sfdc015,sfdc016,
                      sfdc017,sfdcud001,sfdcud002,sfdcud003,sfdcud004,
                      sfdcud005,sfdcud006,sfdcud007,sfdcud008,sfdcud009,
                      sfdcud010,sfdcud011,sfdcud012,sfdcud013,sfdcud014,
                      sfdcud015,sfdcud016,sfdcud017,sfdcud018,sfdcud019,
                      sfdcud020,sfdcud021,sfdcud022,sfdcud023,sfdcud024,
                      sfdcud025,sfdcud026,sfdcud027,sfdcud028,sfdcud029,
                      sfdcud030
                 INTO l_sfdc_t.sfdcent,l_sfdc_t.sfdcsite,l_sfdc_t.sfdcdocno,l_sfdc_t.sfdcseq,l_sfdc_t.sfdc001,
                      l_sfdc_t.sfdc002,l_sfdc_t.sfdc003,l_sfdc_t.sfdc004,l_sfdc_t.sfdc005,l_sfdc_t.sfdc006,
                      l_sfdc_t.sfdc007,l_sfdc_t.sfdc008,l_sfdc_t.sfdc009,l_sfdc_t.sfdc010,l_sfdc_t.sfdc011,
                      l_sfdc_t.sfdc012,l_sfdc_t.sfdc013,l_sfdc_t.sfdc014,l_sfdc_t.sfdc015,l_sfdc_t.sfdc016,
                      l_sfdc_t.sfdc017,l_sfdc_t.sfdcud001,l_sfdc_t.sfdcud002,l_sfdc_t.sfdcud003,l_sfdc_t.sfdcud004,
                      l_sfdc_t.sfdcud005,l_sfdc_t.sfdcud006,l_sfdc_t.sfdcud007,l_sfdc_t.sfdcud008,l_sfdc_t.sfdcud009,
                      l_sfdc_t.sfdcud010,l_sfdc_t.sfdcud011,l_sfdc_t.sfdcud012,l_sfdc_t.sfdcud013,l_sfdc_t.sfdcud014,
                      l_sfdc_t.sfdcud015,l_sfdc_t.sfdcud016,l_sfdc_t.sfdcud017,l_sfdc_t.sfdcud018,l_sfdc_t.sfdcud019,
                      l_sfdc_t.sfdcud020,l_sfdc_t.sfdcud021,l_sfdc_t.sfdcud022,l_sfdc_t.sfdcud023,l_sfdc_t.sfdcud024,
                      l_sfdc_t.sfdcud025,l_sfdc_t.sfdcud026,l_sfdc_t.sfdcud027,l_sfdc_t.sfdcud028,l_sfdc_t.sfdcud029,
                      l_sfdc_t.sfdcud030
                 FROM sfdc_t
               #161109-00085#62 --e add
                WHERE sfdcent   = g_enterprise
                  AND sfdcdocno = g_sfda_m.sfdadocno
                  AND sfdcseq   = g_sfdc_d_t.sfdcseq
               #add--ent
               #CALL asft310_set_entry_b_sfdc(l_cmd)
               #CALL asft310_set_no_entry_b_sfdc(l_cmd)
               IF NOT asft310_lock_b("sfdc_t","'2'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft310_bcl2 INTO g_sfdc_d[l_ac].sfdcseq,g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002,
                      g_sfdc_d[l_ac].sfdc003,g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba002_desc,g_sfdc_d[l_ac].sfba003,
                      g_sfdc_d[l_ac].sfba003_desc,g_sfdc_d[l_ac].sfba004,g_sfdc_d[l_ac].replace,g_sfdc_d[l_ac].sfdc004,
                      g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc005_desc,
                      g_sfdc_d[l_ac].imaf034,g_sfdc_d[l_ac].imae092,g_sfdc_d[l_ac].sfba028,g_sfdc_d[l_ac].sfdc006,
                      g_sfdc_d[l_ac].sfdc006_desc,g_sfdc_d[l_ac].sfba013,g_sfdc_d[l_ac].sfba016,g_sfdc_d[l_ac].sfdc007,
                      g_sfdc_d[l_ac].sfdc008,g_sfdc_d[l_ac].diff,g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc009_desc,
                      g_sfdc_d[l_ac].sfdc010,g_sfdc_d[l_ac].sfdc011,g_sfdc_d[l_ac].diff2,g_sfdc_d[l_ac].sfdc012,
                      g_sfdc_d[l_ac].sfdc012_desc,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc013_desc,
                      g_sfdc_d[l_ac].sfdc014,g_sfdc_d[l_ac].sfdc016,g_sfdc_d[l_ac].sfdc015,g_sfdc_d[l_ac].sfdc015_desc,
                      g_sfdc_d[l_ac].sfdc017
                   IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF

                  #mod 150121
                  #LET g_bfill = "N"
                  #CALL asft310_show()
                  #LET g_bfill = "Y"
                  CALL asft310_b_show('sfdc',l_ac)
                  #mod 150121 end

                  CALL cl_show_fld_cont()
               END IF
               CALL asft310_set_entry_b_sfdc(l_cmd)
               CALL asft310_set_no_entry_b_sfdc(l_cmd)
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row

            #end add-point
            #其他table資料備份(確定是否更改用)

            #其他table進行lock


         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_sfdc_d.deleteElement(l_ac)
               NEXT FIELD sfdcseq
            END IF

            IF g_sfdc_d_t.sfdcseq IS NOT NULL
            THEN
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               LET l_success_tot = TRUE
               #160728-00032 by whitney modify start
               IF NOT asft310_del_sfdc(l_sfdc_t.*) THEN
                  LET l_success_tot = FALSE
               END IF
               #160728-00032 by whitney modify end

               IF NOT l_success_tot THEN
                  CALL s_transaction_end('N','0')  #需要有事务，如果没有事务，直接cancel delete ，回到单身状态就不在事务中了
                  #CANCEL DELETE
                  LET l_flag = 'c'   #取消cancel的做法，本次事务回滚，重新走INPUT进入，回到当前笔状态
                  CLOSE asft310_bcl2 #重新进入单身需要先关闭游标
                  CONTINUE WHILE
               ELSE
                  LET g_rec_b = g_rec_b-1
                  CALL s_transaction_end('Y','0')
               END IF  
                  
               CLOSE asft310_bcl2
               LET l_count = g_sfdb_d.getLength()
            END IF
            #INITIALIZE gs_keys TO NULL
            #LET gs_keys[1] = g_sfda_m.sfdadocno
            #LET gs_keys[2] = g_sfdc_d[g_detail_idx].sfdcseq

         AFTER DELETE
            #IF asft310_delete_b('sfdc_t',gs_keys,"'2'") THEN
            #END IF

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            LET l_count = 1
            SELECT COUNT(1) INTO l_count FROM sfdc_t
             WHERE sfdcent = g_enterprise AND sfdcsite = g_site AND sfdcdocno = g_sfda_m.sfdadocno
               AND sfdcseq = g_sfdc_d[l_ac].sfdcseq
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfda_m.sfdadocno
               LET gs_keys[2] = g_sfdc_d[g_detail_idx].sfdcseq
               CALL asft310_insert_b('sfdc_t',gs_keys,"'2'")
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               INITIALIZE g_sfdb_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "sfdc_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL asft310_b_fill()
               #資料多語言用-增/改

               #add-point:單身新增後
               LET l_success_tot = TRUE
               #同步新增sfdd
               CALL s_asft310_chg_sfdd_f_sfdc_ins(g_sfda_m.sfdadocno, g_sfdc_d[l_ac].sfdcseq) RETURNING l_success
               IF NOT l_success THEN
                  LET l_success_tot = FALSE
               END IF
               
               #新增或更新sfde('Y'代表新增或更新sfdf)
               CALL s_asft310_chg_sfde_f_sfdc_ins(g_sfda_m.sfdadocno, g_sfdc_d[l_ac].sfdcseq,'Y') RETURNING l_success
               IF NOT l_success THEN
                  LET l_success_tot = FALSE
               END IF
               
               #add 141222 
               #处理备注 
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc_ooff013) THEN
                  CALL s_aooi360_gen('7',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,' ',' ',' ',' ',' ',' ',' ',' ','4',g_sfdc_d[l_ac].sfdc_ooff013)
                     RETURNING l_success
                  IF NOT l_success  THEN
                     LET l_success_tot = FALSE
                  END IF
               END IF
               #add 141222 end
               
               IF NOT l_success_tot THEN
                  CALL s_transaction_end('N','0')
                  CANCEL INSERT
                  #cancel insert了就不往下走了，都则就需要写LET g_rec_b = g_rec_b - 1来补救
               END IF
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF

         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()
               LET INT_FLAG = 0
               LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
               CLOSE asft310_bcl2
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
            ELSE
               #寫入修改者/修改日期資訊(單身2)
               IF cl_null(g_sfdc_d[l_ac].sfdc005) THEN LET g_sfdc_d[l_ac].sfdc005 = ' ' END IF #产品特征
               IF cl_null(g_sfdc_d[l_ac].sfdc012) THEN LET g_sfdc_d[l_ac].sfdc012 = ' ' END IF
               IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN LET g_sfdc_d[l_ac].sfdc013 = ' ' END IF
               IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN LET g_sfdc_d[l_ac].sfdc014 = ' ' END IF
               IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN LET g_sfdc_d[l_ac].sfdc016 = ' ' END IF
               IF cl_null(g_sfdc_d[l_ac].sfdc010) THEN LET g_sfdc_d[l_ac].sfdc010 = 0 END IF #参考单位需求数量
               IF cl_null(g_sfdc_d[l_ac].sfdc011) THEN LET g_sfdc_d[l_ac].sfdc011 = 0 END IF #参考单位实际数量 
               #150115 add 单位取位
               CALL s_aooi250_get_msg(g_sfdc_d[l_ac].sfdc006) RETURNING l_success,g_ooca002,g_ooca004
               IF l_success THEN
                  #151118-00016 by whitney modify start g_ooca004-->'4'
                  CALL s_num_round('4',g_sfdc_d[l_ac].sfdc007,g_ooca002) RETURNING g_sfdc_d[l_ac].sfdc007
                  CALL s_num_round('4',g_sfdc_d[l_ac].sfdc008,g_ooca002) RETURNING g_sfdc_d[l_ac].sfdc008
                  #151118-00016 by whitney modify end
               END IF
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
                  CALL s_aooi250_get_msg(g_sfdc_d[l_ac].sfdc009) RETURNING l_success,g_ooca002,g_ooca004
                  IF l_success THEN
                     #151118-00016 by whitney modify start g_ooca004-->'4'
                     CALL s_num_round('4',g_sfdc_d[l_ac].sfdc010,g_ooca002) RETURNING g_sfdc_d[l_ac].sfdc010
                     CALL s_num_round('4',g_sfdc_d[l_ac].sfdc011,g_ooca002) RETURNING g_sfdc_d[l_ac].sfdc011
                     #151118-00016 by whitney modify end
                  END IF
               END IF
               #150115 add end
               UPDATE sfdc_t SET (sfdcdocno,sfdcseq,sfdc001,sfdc002,sfdc003,sfdc004,sfdc005,sfdc006,
                   sfdc007,sfdc008,sfdc009,sfdc010,sfdc011,sfdc012,sfdc013,sfdc014,sfdc016,sfdc015,sfdc017) = (g_sfda_m.sfdadocno,
                   g_sfdc_d[l_ac].sfdcseq,g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002,g_sfdc_d[l_ac].sfdc003,
                   g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
                   g_sfdc_d[l_ac].sfdc008,g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc010,g_sfdc_d[l_ac].sfdc011,
                   g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,g_sfdc_d[l_ac].sfdc016,
                   g_sfdc_d[l_ac].sfdc015,g_sfdc_d[l_ac].sfdc017)
                WHERE sfdcent = g_enterprise AND sfdcsite = g_site AND sfdcdocno = g_sfda_m.sfdadocno
                  AND sfdcseq = g_sfdc_d_t.sfdcseq #項次
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "std-00009"
                     LET g_errparam.extend = "sfdc_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "sfdc_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     CALL s_transaction_end('N','0')
                     LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
                  #OTHERWISE
                  #   INITIALIZE gs_keys TO NULL
                  #   LET gs_keys[1] = g_sfda_m.sfdadocno
                  #   LET gs_keys_bak[1] = g_sfdadocno_t
                  #   LET gs_keys[2] = g_sfdc_d[g_detail_idx].sfdcseq
                  #   LET gs_keys_bak[2] = g_sfdc_d_t.sfdcseq
                  #   CALL asft310_update_b('sfdc_t',gs_keys,gs_keys_bak,"'2'")
                  #   #資料多語言用-增/改
               END CASE
               #add-point:單身page2修改後
               
               #add 150831 --begin
               #发料料件变化时,需删除原批序号资料(工单资料变化会对应发料料件的变化)
               IF NOT cl_null(g_sfdc_d_t.sfdc001) AND g_sfdc_d[l_ac].sfdc001 != g_sfdc_d_t.sfdc001 OR
                  NOT cl_null(g_sfdc_d_t.sfdc002) AND g_sfdc_d[l_ac].sfdc002 != g_sfdc_d_t.sfdc002 OR
                  NOT cl_null(g_sfdc_d_t.sfdc003) AND g_sfdc_d[l_ac].sfdc003 != g_sfdc_d_t.sfdc003 OR
                  NOT cl_null(g_sfdc_d_t.sfdc004) AND g_sfdc_d[l_ac].sfdc004 != g_sfdc_d_t.sfdc004 THEN
                  DELETE FROM inao_t
                   WHERE inaoent = g_enterprise AND inaosite = g_site
                     AND inaodocno = g_sfda_m.sfdadocno
                     AND (inaoseq = g_sfdc_d_t.sfdcseq OR inaoseq = g_sfdc_d_o.sfdcseq) #項次
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = 'DELETE FROM inao_t',SQLERRMESSAGE
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
                     CLOSE asft310_bcl2
                     CALL s_transaction_end('N','0')
                     EXIT DIALOG
                  END IF
               END IF
               #add 150831 --end
               
               #160526-00011 by whitney add start
               IF g_sfdc_d[l_ac].sfdc012 <> g_sfdc_d_t.sfdc012 OR
                  g_sfdc_d[l_ac].sfdc013 <> g_sfdc_d_t.sfdc013 OR
                  g_sfdc_d[l_ac].sfdc014 <> g_sfdc_d_t.sfdc014 OR
                  g_sfdc_d[l_ac].sfdc016 <> g_sfdc_d_t.sfdc016 THEN
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt
                    FROM inao_t
                   WHERE inaoent = g_enterprise
                     AND inaosite = g_site
                     AND inaodocno = g_sfda_m.sfdadocno
                     AND inaoseq = g_sfdc_d[l_ac].sfdcseq
                     AND inao013 = '-1'
                  IF l_cnt > 0 THEN
                     IF cl_ask_confirm('ain-00675') THEN
                        DELETE FROM inao_t
                         WHERE inaoent = g_enterprise
                           AND inaosite = g_site
                           AND inaodocno = g_sfda_m.sfdadocno
                           AND inaoseq = g_sfdc_d[l_ac].sfdcseq
                           AND inao013 = '-1'
                     ELSE
                        LET INT_FLAG = 0
                        LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
                        CLOSE asft310_bcl2
                        CALL s_transaction_end('N','0')
                        EXIT DIALOG
                     END IF
                  END IF
               END IF
               #160526-00011 by whitney add end
               
               #关联表处理
               #當有修改工單單號、項次、項序、申請數量、參考單位申請數量、指定庫、儲、批號、庫存管理特徵時
               IF g_intrans = 'Y' THEN  #若事务还没走rollback则(上面没有走commit)
                  LET l_success_tot = TRUE
                  #SELECT * INTO l_sfdc.* FROM sfdc_t #161109-00085#62 mark
                  #161109-00085#62 --s add
                  SELECT sfdcent,sfdcsite,sfdcdocno,sfdcseq,sfdc001,
                         sfdc002,sfdc003,sfdc004,sfdc005,sfdc006,
                         sfdc007,sfdc008,sfdc009,sfdc010,sfdc011,
                         sfdc012,sfdc013,sfdc014,sfdc015,sfdc016,
                         sfdc017,sfdcud001,sfdcud002,sfdcud003,sfdcud004,
                         sfdcud005,sfdcud006,sfdcud007,sfdcud008,sfdcud009,
                         sfdcud010,sfdcud011,sfdcud012,sfdcud013,sfdcud014,
                         sfdcud015,sfdcud016,sfdcud017,sfdcud018,sfdcud019,
                         sfdcud020,sfdcud021,sfdcud022,sfdcud023,sfdcud024,
                         sfdcud025,sfdcud026,sfdcud027,sfdcud028,sfdcud029,
                         sfdcud030
                    INTO l_sfdc.sfdcent,l_sfdc.sfdcsite,l_sfdc.sfdcdocno,l_sfdc.sfdcseq,l_sfdc.sfdc001,
                         l_sfdc.sfdc002,l_sfdc.sfdc003,l_sfdc.sfdc004,l_sfdc.sfdc005,l_sfdc.sfdc006,
                         l_sfdc.sfdc007,l_sfdc.sfdc008,l_sfdc.sfdc009,l_sfdc.sfdc010,l_sfdc.sfdc011,
                         l_sfdc.sfdc012,l_sfdc.sfdc013,l_sfdc.sfdc014,l_sfdc.sfdc015,l_sfdc.sfdc016,
                         l_sfdc.sfdc017,l_sfdc.sfdcud001,l_sfdc.sfdcud002,l_sfdc.sfdcud003,l_sfdc.sfdcud004,
                         l_sfdc.sfdcud005,l_sfdc.sfdcud006,l_sfdc.sfdcud007,l_sfdc.sfdcud008,l_sfdc.sfdcud009,
                         l_sfdc.sfdcud010,l_sfdc.sfdcud011,l_sfdc.sfdcud012,l_sfdc.sfdcud013,l_sfdc.sfdcud014,
                         l_sfdc.sfdcud015,l_sfdc.sfdcud016,l_sfdc.sfdcud017,l_sfdc.sfdcud018,l_sfdc.sfdcud019,
                         l_sfdc.sfdcud020,l_sfdc.sfdcud021,l_sfdc.sfdcud022,l_sfdc.sfdcud023,l_sfdc.sfdcud024,
                         l_sfdc.sfdcud025,l_sfdc.sfdcud026,l_sfdc.sfdcud027,l_sfdc.sfdcud028,l_sfdc.sfdcud029,
                         l_sfdc.sfdcud030
                    FROM sfdc_t
                  #161109-00085#62 --e add
                   WHERE sfdcent   = g_enterprise
                     AND sfdcdocno = g_sfda_m.sfdadocno
                     AND sfdcseq   = g_sfdc_d[l_ac].sfdcseq
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = 'sel sfdc'
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET l_success_tot = FALSE
                  END IF
                  #处理sfdd,sfdf,sfde
                  CALL s_asft310_chg_sfdd_f_sfdc_upd(l_sfdc_t.*,l_sfdc.*) RETURNING l_success
                  IF NOT l_success THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 141222
                  #ooff资料
                  IF NOT cl_null(g_sfdc_d[l_ac].sfdc_ooff013) THEN
                     CALL s_aooi360_gen('7',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,' ',' ',' ',' ',' ',' ',' ',' ','4',g_sfdc_d[l_ac].sfdc_ooff013)
                        RETURNING l_success
                  ELSE
                     CALL s_aooi360_del('7',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,' ',' ',' ',' ',' ',' ',' ',' ','4')
                        RETURNING l_success
                  END IF
                  IF NOT l_success THEN
                     LET l_success_tot = FALSE
                  END IF
                  #若key值变化
                  CALL asft310_update_ooff_key("c") RETURNING l_success
                  IF NOT l_success THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 141222 end
                  #add 150831 --begin
                  #处理inao
                  CALL asft310_update_inao_key("c") RETURNING l_success
                  IF NOT l_success THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 150831 --end
               
                  IF NOT l_success_tot THEN
                     CALL s_transaction_end('N','0')
                     LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
                  END IF
               END IF
               #end add-point
            END IF

         #项次
         AFTER FIELD sfdcseq
            IF g_sfda_m.sfdadocno IS NOT NULL AND g_sfdc_d[g_detail_idx].sfdcseq IS NOT NULL THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfda_m.sfdadocno != g_sfdadocno_t OR g_sfdc_d[g_detail_idx].sfdcseq != g_sfdc_d_t.sfdcseq)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfdc_t WHERE "||"sfdcent = '" ||g_enterprise|| "' AND sfdcsite = '" ||g_site|| "' AND "||"sfdcdocno = '"||g_sfda_m.sfdadocno ||"' AND "|| "sfdcseq = '"||g_sfdc_d[g_detail_idx].sfdcseq ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            IF NOT cl_null(g_sfdc_d[l_ac].sfdcseq) THEN
               IF g_sfdc_d[l_ac].sfdcseq < 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'amm-00002'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
            ELSE
               LET g_sfdc_d[l_ac].sfdcseq = g_sfdc_d_t.sfdcseq
            END IF
            LET g_sfdc_d_o.sfdcseq = g_sfdc_d[l_ac].sfdcseq
            
         #工单单号
         AFTER FIELD sfdc001
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) THEN
               #add zhangllc 151118 --begin 工单的检核移到函数里
               IF cl_null(g_sfdc_d_t.sfdc001) OR g_sfdc_d[l_ac].sfdc001 != g_sfdc_d_t.sfdc001 THEN
                  IF NOT asft310_sfdc001_chk() THEN
                     LET g_sfdc_d[l_ac].sfdc001 = g_sfdc_d_t.sfdc001
                     NEXT FIELD CURRENT
                  END IF
               END IF
               #add zhangllc 151118 --end
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc002) AND NOT cl_null(g_sfdc_d[l_ac].sfdc003) THEN
                 #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfdc_d[l_ac].sfdc001 != g_sfdc_d_t.sfdc001)) THEN   #160824-00007#251 by sakura mark
                  IF g_sfdc_d[l_ac].sfdc001 != g_sfdc_d_o.sfdc001 OR cl_null(g_sfdc_d_o.sfdc001) THEN        #160824-00007#251 by sakura add
                     IF NOT asft310_sfdc003_reference(l_cmd) THEN
                        LET g_sfdc_d[l_ac].sfdc001 = g_sfdc_d_o.sfdc001   #160824-00007#251 by sakura add
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdc_d_o.* = g_sfdc_d[l_ac].*   #160824-00007#251 by sakura add
            CALL asft310_set_entry_b_sfdc(l_cmd)
            CALL asft310_set_no_entry_b_sfdc(l_cmd) 
            #LET g_sfdc_d_o.sfdc001 = g_sfdc_d[l_ac].sfdc001   #160824-00007#251 by sakura mark

         AFTER FIELD sfdc002
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc002) THEN
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) THEN
                  #可超領工單未指定間接材料
                  CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
                  CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
                  IF g_sfda_m.sfda002!='12' OR (g_sfda_m.sfda002='12' AND g_para='N') THEN
                     #工单号号+项次需存在工单项次中
                     SELECT COUNT(1) INTO l_cnt FROM sfba_t
                      WHERE sfbaent = g_enterprise
                        AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                        AND sfbaseq = g_sfdc_d[l_ac].sfdc002
                     IF l_cnt = 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00044'
                        LET g_errparam.extend = g_sfdc_d[l_ac].sfdc001
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        NEXT FIELD CURRENT
                     END IF
                  ELSE #g_sfda_m.sfda002='12' AND g_para='Y'
                     #工单号号+项次若不存在于工单项次中，则需判断未被其他发料单占用
                     SELECT COUNT(1) INTO l_cnt FROM sfba_t
                      WHERE sfbaent = g_enterprise
                        AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                        AND sfbaseq = g_sfdc_d[l_ac].sfdc002
                     IF l_cnt = 0 THEN
                        SELECT COUNT(1) INTO l_cnt FROM sfdc_t
                         WHERE sfdcent   = g_enterprise
                           AND sfdcdocno!= g_sfda_m.sfdadocno
                           AND sfdc001   = g_sfdc_d[l_ac].sfdc001
                           AND sfdc002   = g_sfdc_d[l_ac].sfdc002
                        IF l_cnt > 0 THEN
                           #此工单项次已被其他发料单占用，本单据不可使用
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'asf-00393'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           NEXT FIELD CURRENT
                        END IF
                        LET g_sfdc_d[l_ac].sfdc003 = 0  #项序=0
                     END IF
                  END IF
               END IF
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) AND NOT cl_null(g_sfdc_d[l_ac].sfdc003) THEN
                 #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfdc_d[l_ac].sfdc002 != g_sfdc_d_t.sfdc002)) THEN   #160824-00007#251 by sakura mark
                  IF g_sfdc_d[l_ac].sfdc002 != g_sfdc_d_o.sfdc002 OR cl_null(g_sfdc_d_o.sfdc002) THEN        #160824-00007#251 by sakura add
                     IF NOT asft310_sfdc003_reference(l_cmd) THEN
                        LET g_sfdc_d[l_ac].sfdc002 = g_sfdc_d_o.sfdc002   #160824-00007#251 by sakura add
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdc_d_o.* = g_sfdc_d[l_ac].*   #160824-00007#251 by sakura add
            CALL asft310_set_entry_b_sfdc(l_cmd)
            CALL asft310_set_no_entry_b_sfdc(l_cmd) 
            #LET g_sfdc_d_o.sfdc002 = g_sfdc_d[l_ac].sfdc002   #160824-00007#251 by sakura mark

         BEFORE FIELD sfdc003
            #工单单号+项次若只有一个项序时，自动带出
            IF cl_null(g_sfdc_d[l_ac].sfdc003) THEN
               SELECT COUNT(1) INTO l_cnt FROM sfba_t
                WHERE sfbaent = g_enterprise
                  AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                  AND sfbaseq = g_sfdc_d[l_ac].sfdc002
               IF l_cnt = 1 THEN
                  SELECT sfbaseq1 INTO g_sfdc_d[l_ac].sfdc003 FROM sfba_t
                   WHERE sfbaent = g_enterprise
                     AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                     AND sfbaseq = g_sfdc_d[l_ac].sfdc002
               END IF
            END IF
            
         AFTER FIELD sfdc003
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc003) THEN
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) AND NOT cl_null(g_sfdc_d[l_ac].sfdc002) THEN
                 #IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfdc_d[l_ac].sfdc003 != g_sfdc_d_t.sfdc003)) THEN   #160824-00007#251 by sakura mark
                  IF g_sfdc_d[l_ac].sfdc003 != g_sfdc_d_o.sfdc003 OR cl_null(g_sfdc_d_o.sfdc003) THEN        #160824-00007#251 by sakura add
                     IF NOT asft310_sfdc003_reference(l_cmd) THEN
                        LET g_sfdc_d[l_ac].sfdc003 = g_sfdc_d_o.sfdc003   #160824-00007#251 by sakura add
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdc_d_o.* = g_sfdc_d[l_ac].*   #160824-00007#251 by sakura add
            CALL asft310_set_entry_b_sfdc(l_cmd)
            CALL asft310_set_no_entry_b_sfdc(l_cmd)  
            #LET g_sfdc_d_o.sfdc003 = g_sfdc_d[l_ac].sfdc003   #160824-00007#251 by sakura mark
         
         #需求料号
         AFTER FIELD sfdc004
            #160914-00019#1-s
            LET g_sfdc_d[l_ac].sfdc004_desc = ''
            LET g_sfdc_d[l_ac].sfdc004_desc2 = ''
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc004) THEN
               IF g_sfdc_d[l_ac].sfdc004 != g_sfdc_d_o.sfdc004 OR cl_null(g_sfdc_d_o.sfdc004) THEN
                  #可超領工單未指定間接材料
                  CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
                  CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
                  IF g_sfda_m.sfda002='12' AND g_para='Y' THEN
                     #工单号号+项次若不存在于工单项次中，则需判断料件为间接材料
                     SELECT COUNT(1) INTO l_cnt FROM sfba_t
                      WHERE sfbaent = g_enterprise
                        AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                        AND sfbaseq = g_sfdc_d[l_ac].sfdc002
                     IF l_cnt = 0 THEN
                        #在超領工單領工單不存在的料件，在申請頁籤可以輸入"間接材料"(imae023)='3'
                        SELECT imae023 INTO l_imae023 FROM imae_t
                         WHERE imaeent = g_enterprise
                           AND imaesite= g_site
                           AND imae001 = g_sfdc_d[l_ac].sfdc004
                        IF cl_null(l_imae023) OR l_imae023 != '3' THEN
                           #此料件非间接材料，不可直接超领
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'asf-00392'
                           LET g_errparam.extend = g_sfdc_d[l_ac].sfdc004
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_sfdc_d[l_ac].sfdc004 = g_sfdc_d_o.sfdc004
                           CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004) RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
                           NEXT FIELD CURRENT
                        END IF
                        #161215-00075#1---add----begin-----
                         LET l_sfdc002 = 0
                         SELECT MAX(sfbaseq) INTO l_sfdc002 FROM sfba_t                       
                            WHERE sfbaent = g_enterprise 
                              AND sfbasite = g_site
                              AND sfbadocno = g_sfdc_d[l_ac].sfdc001
                         #170118-00057#1 add --(S)--
                         LET l_sfdc002_1 = 0
                         SELECT MAX(sfdc002) INTO l_sfdc002_1 FROM sfdc_t LEFT JOIN sfda_t ON sfdcent = sfdaent AND sfdcsite = sfdasite AND sfdcdocno = sfdadocno                       
                            WHERE sfdcent = g_enterprise 
                              AND sfdcsite = g_site
                              AND sfdc001  = g_sfdc_d[l_ac].sfdc001
                              AND sfdastus NOT IN ('S','X') 
                         IF cl_null(l_sfdc002_1) THEN LET l_sfdc002_1 = 0 END IF
                         IF l_sfdc002_1 > l_sfdc002 THEN LET l_sfdc002 = l_sfdc002_1 END IF                         
                         #170118-00057#1 add --(E)--
                         CALL cl_get_para(g_enterprise,g_site,'E-BAS-0008') RETURNING l_ln
                         IF cl_null(l_ln) OR l_ln = 0 THEN
                            LET l_ln = 1
                         END IF
                         LET g_sfdc_d[l_ac].sfdc002 =   l_sfdc002 + l_ln
                         LET g_sfdc_d[l_ac].sfdc003 = 0
                         
                        #161215-00075#1---add----end-----
                     END IF
                  END IF
                  #檢核輸入的料件的生命週期是否在單據別限制範圍內
                  CALL s_control_chk_doc('4',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc004,'','','','')
                       RETURNING l_success,l_flag2
                  IF NOT l_success OR NOT l_flag2 THEN
                     #控制组检查错误,请检查单别设定的相关内容
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00122'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdc_d[l_ac].sfdc004 = g_sfdc_d_o.sfdc004
                     CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004) RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
                     NEXT FIELD CURRENT
                  END IF
                  #檢核輸入的料件的產品分類是否在單據別限制範圍內
                  CALL s_control_chk_doc('5',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc004,'','','','')
                       RETURNING l_success,l_flag2
                  IF NOT l_success OR NOT l_flag2 THEN
                     #控制组检查错误,请检查单别设定的相关内容
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00122'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdc_d[l_ac].sfdc004 = g_sfdc_d_o.sfdc004
                     CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004) RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
                     NEXT FIELD CURRENT
                  END IF
                  #预设栏位
                  #sfdc006单位、发料前调拨
                  SELECT imae081,imae092 INTO g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].imae092 FROM imae_t
                   WHERE imaeent = g_enterprise
                     AND imaesite= g_site
                     AND imae001 = g_sfdc_d[l_ac].sfdc004
                  IF cl_null(g_sfdc_d[l_ac].sfdc006) THEN
                     SELECT imaa006 INTO g_sfdc_d[l_ac].sfdc006 FROM imaa_t
                      WHERE imaaent=g_enterprise AND imaa001=g_sfdc_d[l_ac].sfdc004
                  END IF
                  LET g_sfdc_d[l_ac].sfdc006_desc = s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc006)
                  #sfdc009 参考单位,保税料
                  SELECT imaf015,imaf034 INTO g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].imaf034 FROM imaf_t
                   WHERE imafent=g_enterprise AND imafsite=g_site AND imaf001=g_sfdc_d[l_ac].sfdc004
                  LET g_sfdc_d[l_ac].sfdc009_desc = s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009)
                  #replace取替代建议
                  LET g_sfdc_d[l_ac].replace = s_abmm201_get_proposal(g_site,'','',g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004)
               END IF
               #需求料号品名规格
               CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004)
                    RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
               #显示产品特征说明
               CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                    RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
               #检查产品特征
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc005) THEN
                  IF NOT s_feature_check(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005) THEN
                     NEXT FIELD sfdc005
                  END IF
               END IF
            #160914-00019#1-e
            END IF
            CALL asft310_set_entry_b_sfdc(l_cmd)
            CALL asft310_set_no_entry_b_sfdc(l_cmd)  
            LET g_sfdc_d_o.sfdc004 = g_sfdc_d[l_ac].sfdc004
         
         #产品特征
         BEFORE FIELD sfdc005
           # IF cl_null(g_sfdc_d[l_ac].sfdc001)  OR cl_null(g_sfdc_d[l_ac].sfdc002) OR cl_null(g_sfdc_d[l_ac].sfdc003) THEN   #161207-00067#1 mark
           IF cl_null(g_sfdc_d[l_ac].sfdc001) THEN                                                                            #161207-00067#1 add 
               #请先选择工单资料
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00391'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD sfdc001
            END IF
            #160314-00009#15-s
            IF s_feature_auto_chk(g_sfdc_d[l_ac].sfdc004) AND cl_null(g_sfdc_d[l_ac].sfdc005) THEN
               CALL s_feature_single(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_site,'')
                    RETURNING l_success,g_sfdc_d[l_ac].sfdc005
               IF NOT l_success THEN
                  LET g_sfdc_d[l_ac].sfdc005 = ' '
               END IF
               CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                    RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
            END IF
            #160314-00009#15-e
         
         AFTER FIELD sfdc005
            LET g_sfdc_d[l_ac].sfdc005_desc = ''
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc005) AND NOT cl_null(g_sfdc_d[l_ac].sfdc004) THEN
               IF g_sfdc_d[l_ac].sfdc005 != g_sfdc_d_o.sfdc005 OR cl_null(g_sfdc_d_o.sfdc005) THEN
                  IF NOT s_feature_check(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005) THEN
                     LET g_sfdc_d[l_ac].sfdc005 = g_sfdc_d_o.sfdc005
                     CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                          RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
                     NEXT FIELD CURRENT
                  END IF
                  #151224-00025#4-s
                  IF NOT s_feature_direct_input(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d_t.sfdc005,g_sfda_m.sfdadocno,g_site) THEN
                     LET g_sfdc_d[l_ac].sfdc005 = g_sfdc_d_o.sfdc005
                     CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                          RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
                     NEXT FIELD CURRENT
                  END IF
                  #151224-00025#4-e
                  #add 141209 退料单检查
                  IF g_prog[1,6]='asft32' THEN
                     #做产品特征管理的料件检查该特征的退料量不可超过已发量
                     IF NOT asft310_chk_feature2() THEN
                        LET g_sfdc_d[l_ac].sfdc005 = g_sfdc_d_o.sfdc005
                        CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                             RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #add 141209 end
               END IF
               CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                    RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
            END IF
            LET g_sfdc_d_o.sfdc005 = g_sfdc_d[l_ac].sfdc005
            
         #申请数量
         AFTER FIELD sfdc007
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc007) THEN
               IF g_sfdc_d[l_ac].sfdc007 != g_sfdc_d_o.sfdc007 OR cl_null(g_sfdc_d_o.sfdc007) THEN
                  #不可小于等于0
                  IF g_sfdc_d[l_ac].sfdc007 <= 0 THEN
                     #资料不可小于等于0,请检查！请录入大于0的资料
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axc-00025'
                     LET g_errparam.extend = g_sfdc_d[l_ac].sfdc007
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdc_d[l_ac].sfdc007 = g_sfdc_d_o.sfdc007
                     NEXT FIELD CURRENT
                  END IF
                  #单位取位
                  IF NOT cl_null(g_sfdc_d[l_ac].sfdc006) THEN
                     CALL s_aooi250_take_decimals(g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007)
                          RETURNING l_success,g_sfdc_d[l_ac].sfdc007
                  END IF
                  #mark reason：实际发料数量改成岁申请数量变动而变动
                  ##检查是否小于实际发料数量
                  #IF g_sfdc_d[l_ac].sfdc007 < g_sfdc_d[l_ac].sfdc008 THEN
                  #   #申请数量不可小于实际数量,请先减少实发明细数量再来调整！
                  #   #CALL cl_err('','asf-00126',1)
                  #   INITIALIZE g_errparam TO NULL
                  #   LET g_errparam.code = 'asf-00126'
                  #   LET g_errparam.extend = g_sfdc_d[l_ac].sfdc007
                  #   LET g_errparam.popup = TRUE
                  #   CALL cl_err()
                  #   LET g_sfdc_d[l_ac].sfdc007 = g_sfdc_d_o.sfdc007
                  #   NEXT FIELD CURRENT
                  #END IF
                  #可超領工單未指定間接材料
                  CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
                  CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
                  IF g_sfda_m.sfda002!='12' OR (g_sfda_m.sfda002='12' AND g_para='N') THEN
                     #检查是否可超过 可发数量
                     IF NOT asft310_chk_sfdc007(l_cmd) THEN
                        LET g_sfdc_d[l_ac].sfdc007 = g_sfdc_d_o.sfdc007
                        NEXT FIELD CURRENT
                     END IF
                  ELSE  #g_sfda_m.sfda002='12' AND g_para='Y'
                     #工单号号+项次若不存在于工单项次中，则发料数量不需要控制
                     SELECT COUNT(1) INTO l_cnt FROM sfba_t
                      WHERE sfbaent = g_enterprise
                        AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                        AND sfbaseq = g_sfdc_d[l_ac].sfdc002
                     IF l_cnt > 0 THEN
                        #检查是否可超过 可发数量
                        IF NOT asft310_chk_sfdc007(l_cmd) THEN
                           LET g_sfdc_d[l_ac].sfdc007 = g_sfdc_d_o.sfdc007
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
                  #发料单做在捡量的检查
                  IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdc_d[l_ac].sfdc007) AND NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN  #在捡数量 库位
                     IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN LET g_sfdc_d[l_ac].sfdc016= ' ' END IF  #库存管理特征
                     IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN LET g_sfdc_d[l_ac].sfdc013= ' ' END IF  #储位
                     IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN LET g_sfdc_d[l_ac].sfdc014= ' ' END IF  #批号
                     #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
                     #                           据点   料件编号                产品特征                库存管理特征
                     CALL s_inventory_check_inan(g_site,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc016,
                     #                           库位                   储位                    批号
                                                 g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
                     #                           交易单位                在捡数量
                                                 g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
                     #                           单据编号            项次                   项序              
                                                 g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',
                     #                           工單單號                 工單項次 
                                                 g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
                                                 
                          RETURNING l_success,l_flag2
                     IF NOT l_flag2 THEN
                        LET g_sfdc_d[l_ac].sfdc007 = g_sfdc_d_o.sfdc007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #add 141209 退料单检查
                  IF g_prog[1,6]='asft32' THEN
                     #做产品特征管理的料件检查该特征的退料量不可超过已发量
                     IF NOT asft310_chk_feature2() THEN
                        LET g_sfdc_d[l_ac].sfdc007 = g_sfdc_d_o.sfdc007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #add 141209 end
                  #add 150831 --begin  因为仓库的条件，不好管理，先mark，统一由按钮实现
                  #LET l_imaf071 = NULL
                  #LET l_imaf081 = NULL
                  #SELECT imaf071,imaf081 INTO l_imaf071,l_imaf081 FROM imaf_t
                  # WHERE imafent = g_enterprise
                  #   AND imafsite = g_site AND imaf001 = g_sfdc_d[l_ac].sfdc004
                  ##本笔有没有inao的资料(批量自动产生到需求单身时会inao没有资料的情况，也要开画面出来给维护)
                  #LET l_cnt = 0
                  #SELECT COUNT(1) INTO l_cnt FROM inao_t
                  # WHERE inaoent  = g_enterprise
                  #   AND inaodocno= g_sfda_m.sfdadocno
                  #   AND inaoseq  = g_sfdc_d[l_ac].sfdcseq
                  #   AND inaoseq1 = 0
                  #   AND inao000  = '1'
                  #IF (cl_null(g_sfdc_d_o.sfdc007) OR g_sfdc_d[l_ac].sfdc007!=g_sfdc_d_o.sfdc007 OR l_cnt=0) AND (l_imaf071 = '1' OR l_imaf081 = '1') THEN
                  #   IF g_sfdc_d[l_ac].sfdc007 > 0 AND NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN
                  #      IF g_prog[1,6] = 'asft31' THEN  #发料
                  #         CALL s_lot_sel('1','1',g_site,
                  #                        g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',
                  #                        g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,
                  #                        g_sfdc_d[l_ac].sfdc016,g_sfdc_d[l_ac].sfdc012,
                  #                        g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
                  #                        g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
                  #                        '-1',g_prog,'',
                  #                        g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0','1'
                  #                        )
                  #              RETURNING l_success
                  #      ELSE #退料
                  #         ##工单已发的inao资料，产生到当前单据中的inao
                  #         ##                        工单                   项次
                  #         #CALL s_asft310_inao_copy(g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002,
                  #         ##                        料                     产品特征
                  #         #                         g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,
                  #         ##                        库存管理特征            库位
                  #         #                         g_sfdc_d[l_ac].sfdc016,g_sfdc_d[l_ac].sfdc012,
                  #         ##                        储位                   批号
                  #         #                         g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
                  #         ##                        目的单号           项次                   项序
                  #         #                         g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,0)
                  #         #   RETURNING l_success
                  #         ##从当前单据中已产生的inao中选取退料资料
                  #         ##              inao中抓 申请的资料 据点
                  #         #CALL s_lot_sel('2',    '1',       g_site,
                  #         ##              目的单号            项次                   项序
                  #         #               g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',
                  #         ##              料件编号                产品特征                库存管理特征仓储批
                  #         #               g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,'','','','',
                  #         ##              退料单位                数量
                  #         #               g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
                  #         ##              出入库码 作业编号 据点
                  #         #               '1',    g_prog,  '',
                  #         ##              来源单号            项次                   项序 启用来源单据
                  #         #               g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0','1'
                  #         #               )
                  #         #     RETURNING l_success 
                  #         CASE g_sfda_m.sfda002
                  #            WHEN '11'    LET l_prog='asft311'
                  #            WHEN '12'    LET l_prog='asft312'
                  #            WHEN '13'    LET l_prog='asft313'
                  #            WHEN '14'    LET l_prog='asft314'
                  #            WHEN '15'    LET l_prog='asft315'
                  #            WHEN '21'    LET l_prog='asft321'
                  #            WHEN '22'    LET l_prog='asft322'
                  #            WHEN '23'    LET l_prog='asft323'
                  #            WHEN '24'    LET l_prog='asft324'
                  #            WHEN '25'    LET l_prog='asft325'
                  #         END CASE
                  #         #                      发退料类型   工单              项次
                  #         CALL s_asft310_lot_sel(l_prog,g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002,
                  #         #                      料                     产品特征
                  #                                g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,
                  #         #                      库存管理特征            库位
                  #                                g_sfdc_d[l_ac].sfdc016,g_sfdc_d[l_ac].sfdc012,
                  #         #                      储位                   批号
                  #                                g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
                  #         #                      目的单号           项次                   项序
                  #                                g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,0,
                  #         #                      单位                   数量
                  #                                g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007)
                  #            RETURNING l_success
                  #      END IF
                  #   END IF
                  #END IF
                  #add 150831 --end
               
                  #更新相关栏位-差异数量
                  LET g_sfdc_d[l_ac].diff = g_sfdc_d[l_ac].sfdc007 - g_sfdc_d[l_ac].sfdc008
                  #更新相关栏位-参考单位申请数量，参考单位差异数量
                  IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
                     #参考单位申请数量=申请数量经过转换率换算为参考单位的数量
                     CALL s_aooi250_convert_qty(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc007)
                        RETURNING l_success,g_sfdc_d[l_ac].sfdc010
                     IF NOT l_success THEN
                        LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d[l_ac].sfdc007
                     END IF
                     LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010  - g_sfdc_d[l_ac].sfdc011  #参考单位差异数量
                  ELSE
                     LET g_sfdc_d[l_ac].sfdc010 = 0
                     LET g_sfdc_d[l_ac].sfdc011 = 0
                     LET g_sfdc_d[l_ac].diff2 = 0  #参考单位差异数量
                  END IF
                  #更新相关栏位-实际数量，差异数量，参考单位实际数量，参考单位差异数量
                  IF cl_null(g_sfdc_d_o.sfdc007) OR g_sfdc_d[l_ac].sfdc007!=g_sfdc_d_o.sfdc007 THEN
                     LET g_sfdc_d[l_ac].sfdc008 = g_sfdc_d[l_ac].sfdc007                          #实际数量
                     LET g_sfdc_d[l_ac].diff = g_sfdc_d[l_ac].sfdc007 - g_sfdc_d[l_ac].sfdc008    #差异数量
                     LET g_sfdc_d[l_ac].sfdc011 = g_sfdc_d[l_ac].sfdc010                          #参考单位实际数量
                     LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010  - g_sfdc_d[l_ac].sfdc011  #参考单位差异数量
                  END IF
               END IF
            END IF 
            LET g_sfdc_d_o.sfdc007 = g_sfdc_d[l_ac].sfdc007

         #参考单位
         AFTER FIELD sfdc009
            #160914-00019#1-s
            LET g_sfdc_d[l_ac].sfdc009_desc = ''
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
               IF g_sfdc_d[l_ac].sfdc009 != g_sfdc_d_o.sfdc009 OR cl_null(g_sfdc_d_o.sfdc009) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdc_d[l_ac].sfdc009
                  #160318-00025#22-s
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
                  #160318-00025#22-e
                  IF NOT cl_chk_exist("v_ooca001") THEN
                     LET g_sfdc_d[l_ac].sfdc009 = g_sfdc_d_o.sfdc009
                     LET g_sfdc_d[l_ac].sfdc009_desc = s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009)
                     NEXT FIELD CURRENT
                  END IF
                  #参考单位申请数量=申请数量经过转换率换算为参考单位的数量
                  CALL s_aooi250_convert_qty(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc007)
                       RETURNING l_success,g_sfdc_d[l_ac].sfdc010
                  IF NOT l_success THEN
                     LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d[l_ac].sfdc007
                  END IF
                  IF cl_null(g_sfdc_d_t.sfdc007) OR g_sfdc_d[l_ac].sfdc007!=g_sfdc_d_t.sfdc007 THEN
                     CALL s_aooi250_convert_qty(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc008)
                          RETURNING l_success,g_sfdc_d[l_ac].sfdc011
                     IF NOT l_success THEN
                        LET g_sfdc_d[l_ac].sfdc011 = g_sfdc_d[l_ac].sfdc008
                     END IF
                  END IF
                  LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010  - g_sfdc_d[l_ac].sfdc011  #参考单位差异数量
               END IF
               LET g_sfdc_d[l_ac].sfdc009_desc = s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009)
            #160914-00019#1-s
            ELSE
               LET g_sfdc_d[l_ac].sfdc010 = 0
               LET g_sfdc_d[l_ac].sfdc011 = 0
               LET g_sfdc_d[l_ac].diff2 = 0
            END IF 
            LET g_sfdc_d_o.sfdc009 = g_sfdc_d[l_ac].sfdc009

         #参考单位申请数量
         AFTER FIELD sfdc010
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc010) THEN
               IF g_sfdc_d[l_ac].sfdc010 != g_sfdc_d_o.sfdc010 OR cl_null(g_sfdc_d_o.sfdc010) THEN
                  #单位取位
                  IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
                     CALL s_aooi250_take_decimals(g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc010)
                          RETURNING l_success,g_sfdc_d[l_ac].sfdc010
                  END IF
                  IF NOT cl_ap_chk_Range(g_sfdc_d[l_ac].sfdc010,"0.000","1","","","azz-00079",1) THEN
                     LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d_o.sfdc010
                     NEXT FIELD CURRENT
                  END IF
                  #不可小于0
                  IF g_sfdc_d[l_ac].sfdc010 < 0 THEN
                     #资料不可小于0,请检查！,请录入大于等于0的资料
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axc-00024'
                     LET g_errparam.extend = g_sfdc_d[l_ac].sfdc010
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d_o.sfdc010
                     NEXT FIELD CURRENT
                  END IF
                  #mark reason:实际发料量改成随申请量的变动而变动
                  ##检查是否小于实际发料数量
                  #IF g_sfdc_d[l_ac].sfdc010 < g_sfdc_d[l_ac].sfdc011 THEN
                  #   #申请数量不可小于实际数量,请先减少实发明细数量再来调整！
                  #   INITIALIZE g_errparam TO NULL
                  #   LET g_errparam.code = 'asf-00126'
                  #   LET g_errparam.extend = g_sfdc_d[l_ac].sfdc010
                  #   LET g_errparam.popup = TRUE
                  #   CALL cl_err()
                  #   LET g_sfdc_d[l_ac].sfdc010 = g_sfdc_d_o.sfdc010
                  #   NEXT FIELD CURRENT
                  #END IF
                  IF cl_null(g_sfdc_d_t.sfdc007) OR g_sfdc_d[l_ac].sfdc007!=g_sfdc_d_t.sfdc007 THEN
                     LET g_sfdc_d[l_ac].sfdc011 = g_sfdc_d[l_ac].sfdc010
                  END IF
                  #更新相关栏位-参考单位差异数量
                  LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010  - g_sfdc_d[l_ac].sfdc011
               END IF
            END IF
            LET g_sfdc_d_o.sfdc010 = g_sfdc_d[l_ac].sfdc010

         #仓库
         BEFORE FIELD sfdc012
           # IF cl_null(g_sfdc_d[l_ac].sfdc001)  OR cl_null(g_sfdc_d[l_ac].sfdc002) OR cl_null(g_sfdc_d[l_ac].sfdc003) THEN   #161207-00067#1 mark
           IF cl_null(g_sfdc_d[l_ac].sfdc001) THEN                                                                            #161207-00067#1 add 
               #请先选择工单资料
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00391'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD sfdc001
            END IF
            
         AFTER FIELD sfdc012
            LET g_sfdc_d[l_ac].sfdc012_desc = ''
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN
               IF g_sfdc_d[l_ac].sfdc012 != g_sfdc_d_o.sfdc012 OR cl_null(g_sfdc_d_o.sfdc012) THEN
                  IF NOT asft310_sfdc012_chk() THEN
                     LET g_sfdc_d[l_ac].sfdc012 = g_sfdc_d_o.sfdc012
                     LET g_sfdc_d[l_ac].sfdc013 = g_sfdc_d_o.sfdc013
                     LET g_sfdc_d[l_ac].sfdc014 = g_sfdc_d_o.sfdc014
                     LET g_sfdc_d[l_ac].sfdc016 = g_sfdc_d_o.sfdc016
                     LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
                     LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
            END IF
            LET g_sfdc_d_o.sfdc012 = g_sfdc_d[l_ac].sfdc012

         #储位
         BEFORE FIELD sfdc013
           # IF cl_null(g_sfdc_d[l_ac].sfdc001)  OR cl_null(g_sfdc_d[l_ac].sfdc002) OR cl_null(g_sfdc_d[l_ac].sfdc003) THEN   #161207-00067#1 mark
           IF cl_null(g_sfdc_d[l_ac].sfdc001) THEN                                                                            #161207-00067#1 add 
               #请先选择工单资料
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00391'
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD sfdc001
            END IF
            
         AFTER FIELD sfdc013
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdc013_switch = 'Y' THEN
            #160914-00019#1-s
               LET g_sfdc_d[l_ac].sfdc013_desc = ''
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc013) AND NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN
                  IF g_sfdc_d[l_ac].sfdc013 != g_sfdc_d_o.sfdc013 OR cl_null(g_sfdc_d_o.sfdc013) THEN
                     IF NOT asft310_sfdc013_chk() THEN
                        LET g_sfdc_d[l_ac].sfdc012 = g_sfdc_d_o.sfdc012
                        LET g_sfdc_d[l_ac].sfdc013 = g_sfdc_d_o.sfdc013
                        LET g_sfdc_d[l_ac].sfdc014 = g_sfdc_d_o.sfdc014
                        LET g_sfdc_d[l_ac].sfdc016 = g_sfdc_d_o.sfdc016
                        LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
                        LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
               END IF 
            END IF
            LET g_sfdc_d_o.sfdc012 = g_sfdc_d[l_ac].sfdc012
            LET g_sfdc_d_o.sfdc013 = g_sfdc_d[l_ac].sfdc013
            LET g_sfdc_d_o.sfdc014 = g_sfdc_d[l_ac].sfdc014
            LET g_sfdc_d_o.sfdc016 = g_sfdc_d[l_ac].sfdc016
            #160914-00019#1-e

         #指定批号
         BEFORE FIELD sfdc014
            #退料預設值:若發料批號只有一個，預設發料的批號
            IF g_sfda_m.sfda002[1,1]='2' AND cl_null(g_sfdc_d[l_ac].sfdc014) THEN
               CALL asft310_def_sfdc014()
            END IF
            
         AFTER FIELD sfdc014
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdc014_switch = 'Y' THEN
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc014) THEN
                  IF g_sfdc_d[l_ac].sfdc014 != g_sfdc_d_o.sfdc014 OR cl_null(g_sfdc_d_o.sfdc014) THEN
                     #发料单做在捡量的检查
                     IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdc_d[l_ac].sfdc007) AND NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN  #在捡数量 库位
                        IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN LET g_sfdc_d[l_ac].sfdc016= ' ' END IF  #库存管理特征
                        IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN LET g_sfdc_d[l_ac].sfdc013= ' ' END IF  #储位
                        IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN LET g_sfdc_d[l_ac].sfdc014= ' ' END IF  #批号
                        #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
                        #                           据点   料件编号                产品特征                库存管理特征
                        CALL s_inventory_check_inan(g_site,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc016,
                        #                           库位                   储位                    批号
                                                    g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
                        #                           交易单位                在捡数量
                                                    g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
                        #                           单据编号            项次                   项序
                                                    g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',
                        #                           工單單號                 工單項次 
                                                    g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
                             RETURNING l_success,l_flag2
                        IF NOT l_flag2 THEN
                           LET g_sfdc_d[l_ac].sfdc012 = g_sfdc_d_o.sfdc012
                           LET g_sfdc_d[l_ac].sfdc013 = g_sfdc_d_o.sfdc013
                           LET g_sfdc_d[l_ac].sfdc014 = g_sfdc_d_o.sfdc014
                           LET g_sfdc_d[l_ac].sfdc016 = g_sfdc_d_o.sfdc016
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdc_d_o.sfdc012 = g_sfdc_d[l_ac].sfdc012
            LET g_sfdc_d_o.sfdc013 = g_sfdc_d[l_ac].sfdc013
            LET g_sfdc_d_o.sfdc014 = g_sfdc_d[l_ac].sfdc014
            LET g_sfdc_d_o.sfdc016 = g_sfdc_d[l_ac].sfdc016
               
         #库存管理特征
         AFTER FIELD sfdc016
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdc016_switch = 'Y' THEN
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc016) THEN
                  IF g_sfdc_d[l_ac].sfdc016 != g_sfdc_d_o.sfdc016 OR cl_null(g_sfdc_d_o.sfdc016) THEN
                     #mark 150119 reason：需求时，库存资料也可以不存在
                     #SELECT COUNT(1) INTO l_cnt FROM inag_t
                     # WHERE inagent  = g_enterprise
                     #   AND inagsite = g_site
                     #   AND inag001  = g_sfdc_d[l_ac].sfdc004  #料件
                     #   AND inag002  = g_sfdc_d[l_ac].sfdc005  #产品特征
                     #   AND inag003  = g_sfdc_d[l_ac].sfdc016  #库存管理特征
                     #IF l_cnt = 0 THEN
                     #   #无此库存管理特征，请检查库存资料后从新输入
                     #   INITIALIZE g_errparam TO NULL
                     #   LET g_errparam.code = 'asf-00117'
                     #   LET g_errparam.extend = '' #g_sfdc_d[l_ac].sfdc004
                     #   LET g_errparam.popup = TRUE
                     #   CALL cl_err()
                     #   NEXT FIELD CURRENT
                     #END IF
                     #mark 150119 end
                  END IF
               END IF
            END IF
            LET g_sfdc_d_o.sfdc012 = g_sfdc_d[l_ac].sfdc012
            LET g_sfdc_d_o.sfdc013 = g_sfdc_d[l_ac].sfdc013
            LET g_sfdc_d_o.sfdc014 = g_sfdc_d[l_ac].sfdc014
            LET g_sfdc_d_o.sfdc016 = g_sfdc_d[l_ac].sfdc016

         #理由码
         AFTER FIELD sfdc015
            #160914-00019#1-s
            LET g_sfdc_d[l_ac].sfdc015_desc = ''
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc015) THEN
               IF g_sfdc_d[l_ac].sfdc015 != g_sfdc_d_o.sfdc015 OR cl_null(g_sfdc_d_o.sfdc015) THEN
                  IF NOT s_azzi650_chk_exist('226',g_sfdc_d[l_ac].sfdc015) THEN
                     LET g_sfdc_d[l_ac].sfdc015 = g_sfdc_d_o.sfdc015
                     LET g_sfdc_d[l_ac].sfdc015_desc = s_desc_get_acc_desc('226',g_sfdc_d[l_ac].sfdc015)
                     NEXT FIELD CURRENT
                  END IF
                  #控制组检查
                  CALL s_control_chk_doc('8',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc015,'','','','')
                     RETURNING l_success,l_flag2
                  IF NOT l_success OR NOT l_flag2 THEN
                     LET g_sfdc_d[l_ac].sfdc015 = g_sfdc_d_o.sfdc015
                     LET g_sfdc_d[l_ac].sfdc015_desc = s_desc_get_acc_desc('226',g_sfdc_d[l_ac].sfdc015)
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfdc_d[l_ac].sfdc015_desc = s_desc_get_acc_desc('226',g_sfdc_d[l_ac].sfdc015)
            #160914-00019#1-e
            END IF 
            LET g_sfdc_d_o.sfdc015 = g_sfdc_d[l_ac].sfdc015

         #工单单号
         ON ACTION controlp INFIELD sfdc001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc001
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc002
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc003
            LET g_qryparam.where = " sfbasite ='",g_site,"'"
            SELECT COUNT(1) INTO l_cnt FROM sfdb_t
             WHERE sfdbent   = g_enterprise
               AND sfdbdocno = g_sfda_m.sfdadocno
            IF l_cnt > 0 THEN
               #找套数页签中有的工单
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      " AND sfbadocno in (select unique sfdb001 from sfdb_t ",
                                      "                  where sfdbent   = ",g_enterprise,
                                      "                    and sfdbdocno = '",g_sfda_m.sfdadocno,"') "
            END IF
            #add 150827
            IF g_sfda_m.sfda002='14' THEN   #倒扣料
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba009 = 'Y' AND sfba013 > sfba015+sfba016 "
            END IF
            IF g_sfda_m.sfda002='24' THEN   #倒扣料退料
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba009 = 'Y' AND sfba016 > 0  "
            END IF
            #add 150827 end
            IF g_sfda_m.sfda002='22' THEN   #超领退料只开有超领量的
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba025 > 0 "
            END IF
            #IF g_sfda_m.sfda002='23' THEN   #一般退料只开有已发量的
            IF g_sfda_m.sfda002='21' OR g_sfda_m.sfda002='23' OR g_sfda_m.sfda002='25' THEN   #一般退料只开有已发量的
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba016 > 0 "
            END IF
            #单头PBI
            IF NOT cl_null(g_sfda_m.sfda005) THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      " AND sfbadocno in (select unique sfqb001 from sfqb_t ",
                                      "                  where sfqbent   = ",g_enterprise,
                                      "                    and sfqbdocno = '",g_sfda_m.sfda005,"') "
            END IF
            #150909 earl mod s
            #組合過濾前後置單據資料SQL
            CALL s_aooi210_get_check_sql(g_site,'',g_sfda_m.sfdadocno,'4','','sfbadocno') RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where," AND ",l_where
            #150909 earl mod e
               CALL q_sfba001_1()
               LET g_sfdc_d[l_ac].sfdc001 = g_qryparam.return1
               LET g_sfdc_d[l_ac].sfdc002 = g_qryparam.return2
               LET g_sfdc_d[l_ac].sfdc003 = g_qryparam.return3
               DISPLAY g_sfdc_d[l_ac].sfdc001 TO sfdc001
               DISPLAY g_sfdc_d[l_ac].sfdc002 TO sfdc002
               DISPLAY g_sfdc_d[l_ac].sfdc003 TO sfdc003 
            END IF  #150909 earl add
            NEXT FIELD sfdc001  #160914-00019#1

         #项次
         ON ACTION controlp INFIELD sfdc002
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc001
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc002
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc003
            LET g_qryparam.where = " sfbasite ='",g_site,"'"
            SELECT COUNT(1) INTO l_cnt FROM sfdb_t
             WHERE sfdbent   = g_enterprise
               AND sfdbdocno = g_sfda_m.sfdadocno
            IF l_cnt > 0 THEN
               #找套数页签中有的工单
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      " AND sfbadocno in (select unique sfdb001 from sfdb_t ",
                                      "                  where sfdbent   = ",g_enterprise,
                                      "                    and sfdbdocno = '",g_sfda_m.sfdadocno,"') "
            END IF
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfbadocno = '",g_sfdc_d[l_ac].sfdc001,"' "
            END IF
            #add 150827
            IF g_sfda_m.sfda002='14' THEN   #倒扣料
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba009 = 'Y' AND sfba013 > sfba015+sfba016 "
            END IF
            IF g_sfda_m.sfda002='24' THEN   #倒扣料退料
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba009 = 'Y' AND sfba016 > 0  "
            END IF
            #add 150827 end
            IF g_sfda_m.sfda002='22' THEN   #超领退料只开有超领量的
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba025 > 0 "
            END IF
            #IF g_sfda_m.sfda002='23' THEN   #一般退料只开有已发量的
            IF g_sfda_m.sfda002='21' OR g_sfda_m.sfda002='23' OR g_sfda_m.sfda002='25' THEN   #一般退料只开有已发量的
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba016 > 0 "
            END IF
            CALL q_sfba001_1()
            LET g_sfdc_d[l_ac].sfdc001 = g_qryparam.return1
            LET g_sfdc_d[l_ac].sfdc002 = g_qryparam.return2
            LET g_sfdc_d[l_ac].sfdc003 = g_qryparam.return3
            DISPLAY g_sfdc_d[l_ac].sfdc001 TO sfdc001
            DISPLAY g_sfdc_d[l_ac].sfdc002 TO sfdc002
            DISPLAY g_sfdc_d[l_ac].sfdc003 TO sfdc003
            NEXT FIELD sfdc002  #160914-00019#1

         #项序
         ON ACTION controlp INFIELD sfdc003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc001
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc002
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc003
            LET g_qryparam.where = " sfbasite ='",g_site,"'"
            SELECT COUNT(1) INTO l_cnt FROM sfdb_t
             WHERE sfdbent   = g_enterprise
               AND sfdbdocno = g_sfda_m.sfdadocno
            IF l_cnt > 0 THEN
               #找套数页签中有的工单
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      " AND sfbadocno in (select unique sfdb001 from sfdb_t ",
                                      "                  where sfdbent   = ",g_enterprise,
                                      "                    and sfdbdocno = '",g_sfda_m.sfdadocno,"') "
            END IF
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfbadocno = '",g_sfdc_d[l_ac].sfdc001,"' "
            END IF
            IF NOT cl_null(g_sfdc_d[l_ac].sfdc002) THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfbaseq = ",g_sfdc_d[l_ac].sfdc002
            END IF
            #add 150827
            IF g_sfda_m.sfda002='14' THEN   #倒扣料
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba009 = 'Y' AND sfba013 > sfba015+sfba016 "
            END IF
            IF g_sfda_m.sfda002='24' THEN   #倒扣料退料
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba009 = 'Y' AND sfba016 > 0  "
            END IF
            #add 150827 end
            IF g_sfda_m.sfda002='22' THEN   #超领退料只开有超领量的
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba025 > 0 "
            END IF
            #IF g_sfda_m.sfda002='23' THEN   #一般退料只开有已发量的
            IF g_sfda_m.sfda002='21' OR g_sfda_m.sfda002='23' OR g_sfda_m.sfda002='25' THEN   #一般退料只开有已发量的
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND sfba016 > 0 "
            END IF
            CALL q_sfba001_1()
            LET g_sfdc_d[l_ac].sfdc001 = g_qryparam.return1
            LET g_sfdc_d[l_ac].sfdc002 = g_qryparam.return2
            LET g_sfdc_d[l_ac].sfdc003 = g_qryparam.return3
            DISPLAY g_sfdc_d[l_ac].sfdc001 TO sfdc001
            DISPLAY g_sfdc_d[l_ac].sfdc002 TO sfdc002
            DISPLAY g_sfdc_d[l_ac].sfdc003 TO sfdc003
            NEXT FIELD sfdc003  #160914-00019#1

         #需求料号
         ON ACTION controlp INFIELD sfdc004
            #因只有在超領工單領工單不存在的料件，在申請頁籤才可以輸入"間接材料"(imae023)='3'，所以这边只开间接材料的料件
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc004
            CALL q_imae001()
            LET g_sfdc_d[l_ac].sfdc004 = g_qryparam.return1
            DISPLAY g_sfdc_d[l_ac].sfdc004 TO sfdc004
            #160914-00019#1-s
            CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004)
                 RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
            NEXT FIELD sfdc004 
            #160914-00019#1-e

         ON ACTION controlp INFIELD sfdc005
            CALL s_feature_single(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_site,'')
                 RETURNING l_success,g_sfdc_d[l_ac].sfdc005
            IF NOT l_success THEN
               LET g_sfdc_d[l_ac].sfdc005 = ' '
            END IF
            DISPLAY g_sfdc_d[l_ac].sfdc005 TO sfdc005
            CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
                 RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
            NEXT FIELD sfdc005 
            
         #参考单位
         ON ACTION controlp INFIELD sfdc009
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc009
            CALL q_ooca001_1()
            LET g_sfdc_d[l_ac].sfdc009 = g_qryparam.return1
            DISPLAY g_sfdc_d[l_ac].sfdc009 TO sfdc009
            LET g_sfdc_d[l_ac].sfdc009_desc = s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009)  #160914-00019#1
            NEXT FIELD sfdc009  #160914-00019#1

         #仓库
         ON ACTION controlp INFIELD sfdc012
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc012
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc013
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc014
            LET g_qryparam.default4 = g_sfdc_d[l_ac].sfdc016
            #mod 141118 q_inag004_13修改成传参方式
            #LET g_qryparam.where = " inag001 ='",g_sfdc_d[l_ac].sfdc004,"'"
            LET g_qryparam.arg1 = g_sfdc_d[l_ac].sfdc004
            IF cl_null(g_sfdc_d[l_ac].sfdc005) THEN
               LET g_qryparam.arg2 = ' '
            ELSE
               LET g_qryparam.arg2 = g_sfdc_d[l_ac].sfdc005
            END IF
            #已有指定不可输入
            LET g_qryparam.where = "1=1 "
            #add 150107
            LET l_sfba019=''
            LET l_sfba020=''
            LET l_sfba029=''
            LET l_sfba030=''
            SELECT sfba019,sfba020,sfba029,sfba030
              INTO l_sfba019,l_sfba020,l_sfba029,l_sfba030
              FROM sfba_t
             WHERE sfbaent  = g_enterprise
               AND sfbadocno= g_sfdc_d[l_ac].sfdc001
               AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
               AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
            #add 150107 end
            #IF g_sfdc012_switch = 'N' THEN
            #   IF cl_null(g_sfdc_d[l_ac].sfdc012) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdc_d[l_ac].sfdc012,"' "
            #   END IF
            #END IF
            IF g_sfdc013_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
                  IF NOT cl_null(l_sfba020) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",l_sfba020,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdc_d[l_ac].sfdc013,"' "
               END IF
            END IF
            IF g_sfdc014_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
                  IF NOT cl_null(l_sfba029) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",l_sfba029,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdc_d[l_ac].sfdc014,"' "
               END IF
            END IF
            IF g_sfdc016_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
                  IF NOT cl_null(l_sfba030) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",l_sfba030,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdc_d[l_ac].sfdc016,"' "
               END IF
            END IF
            #mod 141118 --end
            #关于控制组
            CALL s_control_get_doc_sql("inag004",g_sfda_m.sfdadocno,'6')
                 RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where ," AND ",l_where
            END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN #發料單 庫存>0
               #add by lixh 20151208
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) THEN
                  SELECT sfaa005,sfaa010 INTO l_sfaa005,l_sfaa010 FROM sfaa_t
                   WHERE sfaaent = g_enterprise
                     AND sfaadocno = g_sfdc_d[l_ac].sfdc001
                  IF l_sfaa005 = '5' AND l_sfaa010 = g_sfdc_d[l_ac].sfdc004 THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inaa010 = 'N' "
                  END IF   
               END IF    
               #add by lixh 20151208   
               CALL q_inag004_13()  #库位、储位、批号、库存管理特征
            ELSE #退料單 不卡控库存
               #add by lixh 20151208
               IF NOT cl_null(g_sfdc_d[l_ac].sfdc001) THEN
                  SELECT sfaa005,sfaa010 INTO l_sfaa005,l_sfaa010 FROM sfaa_t
                   WHERE sfaaent = g_enterprise
                     AND sfaadocno = g_sfdc_d[l_ac].sfdc001
                  IF l_sfaa005 = '5' AND l_sfaa010 = g_sfdc_d[l_ac].sfdc004 THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inaa010 = 'N' "
                  END IF   
               END IF 
               #add by lixh 20151208             
               #CALL q_inag004_16()  #库位、储位、批号、库存管理特征                           #160804-00045#1 mark
               CALL q_inag004_21()   #库位、储位、批号、库存管理特征,取消料号+产品特征过滤条件   #160804-00045#1 add
            END IF
            LET g_sfdc_d[l_ac].sfdc012 = g_qryparam.return1
            LET g_sfdc_d[l_ac].sfdc013 = g_qryparam.return2
            LET g_sfdc_d[l_ac].sfdc014 = g_qryparam.return3
            LET g_sfdc_d[l_ac].sfdc016 = g_qryparam.return4   
            DISPLAY g_sfdc_d[l_ac].sfdc012 TO sfdc012
            DISPLAY g_sfdc_d[l_ac].sfdc013 TO sfdc013
            DISPLAY g_sfdc_d[l_ac].sfdc014 TO sfdc014 
            DISPLAY g_sfdc_d[l_ac].sfdc016 TO sfdc016 
            LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
            LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
            NEXT FIELD sfdc012

         #储位
         ON ACTION controlp INFIELD sfdc013
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc012
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc013
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc014
            LET g_qryparam.default4 = g_sfdc_d[l_ac].sfdc016
            #mod 141118 q_inag004_13修改成传参方式
            #LET g_qryparam.where = " inag001 ='",g_sfdc_d[l_ac].sfdc004,"'"
            LET g_qryparam.arg1 = g_sfdc_d[l_ac].sfdc004
            IF cl_null(g_sfdc_d[l_ac].sfdc005) THEN
               LET g_qryparam.arg2 = ' '
            ELSE
               LET g_qryparam.arg2 = g_sfdc_d[l_ac].sfdc005
            END IF
            #已有指定不可输入
            LET g_qryparam.where = "1=1 "
            #add 150107
            LET l_sfba019=''
            LET l_sfba020=''
            LET l_sfba029=''
            LET l_sfba030=''
            SELECT sfba019,sfba020,sfba029,sfba030
              INTO l_sfba019,l_sfba020,l_sfba029,l_sfba030
              FROM sfba_t
             WHERE sfbaent  = g_enterprise
               AND sfbadocno= g_sfdc_d[l_ac].sfdc001
               AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
               AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
            #add 150107 end
            IF g_sfdc012_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc012) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
                  IF NOT cl_null(l_sfba019) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",l_sfba019,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdc_d[l_ac].sfdc012,"' "
               END IF
            END IF
            #IF g_sfdc013_switch = 'N' THEN
            #   IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdc_d[l_ac].sfdc013,"' "
            #   END IF
            #END IF
            IF g_sfdc014_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
                  IF NOT cl_null(l_sfba029) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",l_sfba029,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdc_d[l_ac].sfdc014,"' "
               END IF
            END IF
            IF g_sfdc016_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
                  IF NOT cl_null(l_sfba030) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",l_sfba030,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdc_d[l_ac].sfdc016,"' "
               END IF
            END IF
            #mod 141118 --end
            IF g_sfda_m.sfda002[1,1]='1' THEN #發料單 庫存>0
               CALL q_inag004_13()  #库位、储位、批号、库存管理特征
            ELSE #退料單 不卡控库存
               #CALL q_inag004_16()  #库位、储位、批号、库存管理特征                           #160804-00045#1 mark
               CALL q_inag004_21()   #库位、储位、批号、库存管理特征,取消料号+产品特征过滤条件   #160804-00045#1 add
            END IF
            LET g_sfdc_d[l_ac].sfdc012 = g_qryparam.return1
            LET g_sfdc_d[l_ac].sfdc013 = g_qryparam.return2
            LET g_sfdc_d[l_ac].sfdc014 = g_qryparam.return3
            LET g_sfdc_d[l_ac].sfdc016 = g_qryparam.return4         
            DISPLAY g_sfdc_d[l_ac].sfdc012 TO sfdc012
            DISPLAY g_sfdc_d[l_ac].sfdc013 TO sfdc013
            DISPLAY g_sfdc_d[l_ac].sfdc014 TO sfdc014 
            DISPLAY g_sfdc_d[l_ac].sfdc016 TO sfdc016 
            LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
            LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
            NEXT FIELD sfdc013

         #批号
         ON ACTION controlp INFIELD sfdc014
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc012
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc013
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc014
            LET g_qryparam.default4 = g_sfdc_d[l_ac].sfdc016
            #mod 141118 q_inag004_13修改成传参方式
            #LET g_qryparam.where = " inag001 ='",g_sfdc_d[l_ac].sfdc004,"'"
            LET g_qryparam.arg1 = g_sfdc_d[l_ac].sfdc004
            IF cl_null(g_sfdc_d[l_ac].sfdc005) THEN
               LET g_qryparam.arg2 = ' '
            ELSE
               LET g_qryparam.arg2 = g_sfdc_d[l_ac].sfdc005
            END IF
            #已有指定不可输入
            LET g_qryparam.where = "1=1 "
            #add 150107
            LET l_sfba019=''
            LET l_sfba020=''
            LET l_sfba029=''
            LET l_sfba030=''
            SELECT sfba019,sfba020,sfba029,sfba030
              INTO l_sfba019,l_sfba020,l_sfba029,l_sfba030
              FROM sfba_t
             WHERE sfbaent  = g_enterprise
               AND sfbadocno= g_sfdc_d[l_ac].sfdc001
               AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
               AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
            #add 150107 end
            IF g_sfdc012_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc012) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
                  IF NOT cl_null(l_sfba019) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",l_sfba019,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdc_d[l_ac].sfdc012,"' "
               END IF
            END IF
            IF g_sfdc013_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
                  IF NOT cl_null(l_sfba020) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",l_sfba020,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdc_d[l_ac].sfdc013,"' "
               END IF
            END IF
            #IF g_sfdc014_switch = 'N' THEN
            #   IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdc_d[l_ac].sfdc014,"' "
            #   END IF
            #END IF
            IF g_sfdc016_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
                  IF NOT cl_null(l_sfba030) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",l_sfba030,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdc_d[l_ac].sfdc016,"' "
               END IF
            END IF
            #mod 141118 --end
            IF g_sfda_m.sfda002[1,1]='1' THEN #發料單 庫存>0
               CALL q_inag004_13()  #库位、储位、批号、库存管理特征
            ELSE #退料單 不卡控库存
               #CALL q_inag004_16()  #库位、储位、批号、库存管理特征                           #160804-00045#1 mark
               CALL q_inag004_21()   #库位、储位、批号、库存管理特征,取消料号+产品特征过滤条件   #160804-00045#1 add
            END IF
            LET g_sfdc_d[l_ac].sfdc012 = g_qryparam.return1
            LET g_sfdc_d[l_ac].sfdc013 = g_qryparam.return2
            LET g_sfdc_d[l_ac].sfdc014 = g_qryparam.return3
            LET g_sfdc_d[l_ac].sfdc016 = g_qryparam.return4
            DISPLAY g_sfdc_d[l_ac].sfdc012 TO sfdc012
            DISPLAY g_sfdc_d[l_ac].sfdc013 TO sfdc013
            DISPLAY g_sfdc_d[l_ac].sfdc014 TO sfdc014 
            DISPLAY g_sfdc_d[l_ac].sfdc016 TO sfdc016 
            LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
            LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
            NEXT FIELD sfdc014

         #库存管理特征
         ON ACTION controlp INFIELD sfdc016
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc012
            LET g_qryparam.default2 = g_sfdc_d[l_ac].sfdc013
            LET g_qryparam.default3 = g_sfdc_d[l_ac].sfdc014
            LET g_qryparam.default4 = g_sfdc_d[l_ac].sfdc016
            #mod 141118 q_inag004_13修改成传参方式
            #LET g_qryparam.where = " inag001 ='",g_sfdc_d[l_ac].sfdc004,"'"
            LET g_qryparam.arg1 = g_sfdc_d[l_ac].sfdc004
            IF cl_null(g_sfdc_d[l_ac].sfdc005) THEN
               LET g_qryparam.arg2 = ' '
            ELSE
               LET g_qryparam.arg2 = g_sfdc_d[l_ac].sfdc005
            END IF
            #已有指定不可输入
            LET g_qryparam.where = "1=1 "
            #add 150107
            LET l_sfba019=''
            LET l_sfba020=''
            LET l_sfba029=''
            LET l_sfba030=''
            SELECT sfba019,sfba020,sfba029,sfba030
              INTO l_sfba019,l_sfba020,l_sfba029,l_sfba030
              FROM sfba_t
             WHERE sfbaent  = g_enterprise
               AND sfbadocno= g_sfdc_d[l_ac].sfdc001
               AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
               AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
            #add 150107 end
            IF g_sfdc012_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc012) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
                  IF NOT cl_null(l_sfba019) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",l_sfba019,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdc_d[l_ac].sfdc012,"' "
               END IF
            END IF
            IF g_sfdc013_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
                  IF NOT cl_null(l_sfba020) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",l_sfba020,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdc_d[l_ac].sfdc013,"' "
               END IF
            END IF
            IF g_sfdc014_switch = 'N' THEN
               IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN
                  #mod 150107
                  #LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
                  IF NOT cl_null(l_sfba029) THEN
                     LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",l_sfba029,"' "
                  ELSE
                     LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
                  END IF
                  #mod 150107 end
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdc_d[l_ac].sfdc014,"' "
               END IF
            END IF
            #IF g_sfdc016_switch = 'N' THEN
            #   IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdc_d[l_ac].sfdc016,"' "
            #   END IF
            #END IF
            #mod 141118 --end
            IF g_sfda_m.sfda002[1,1]='1' THEN #發料單 庫存>0
               CALL q_inag004_13()  #库位、储位、批号、库存管理特征
            ELSE #退料單 不卡控库存
               #CALL q_inag004_16()  #库位、储位、批号、库存管理特征                           #160804-00045#1 mark
               CALL q_inag004_21()   #库位、储位、批号、库存管理特征,取消料号+产品特征过滤条件   #160804-00045#1 add
            END IF
            LET g_sfdc_d[l_ac].sfdc012 = g_qryparam.return1
            LET g_sfdc_d[l_ac].sfdc013 = g_qryparam.return2
            LET g_sfdc_d[l_ac].sfdc014 = g_qryparam.return3
            LET g_sfdc_d[l_ac].sfdc016 = g_qryparam.return4
            DISPLAY g_sfdc_d[l_ac].sfdc012 TO sfdc012
            DISPLAY g_sfdc_d[l_ac].sfdc013 TO sfdc013
            DISPLAY g_sfdc_d[l_ac].sfdc014 TO sfdc014 
            DISPLAY g_sfdc_d[l_ac].sfdc016 TO sfdc016 
            LET g_sfdc_d[l_ac].sfdc012_desc = s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
            LET g_sfdc_d[l_ac].sfdc013_desc = s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
            NEXT FIELD sfdc016
            
         #理由码
         ON ACTION controlp INFIELD sfdc015
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdc_d[l_ac].sfdc015
            LET g_qryparam.arg1 = '226'
            #关于控制组
            LET g_qryparam.where = "1=1 "
            CALL s_control_get_doc_sql("oocq002",g_sfda_m.sfdadocno,'8')
               RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND ",l_where
            END IF
            CALL q_oocq002_5()
            LET g_sfdc_d[l_ac].sfdc015 = g_qryparam.return1
            DISPLAY g_sfdc_d[l_ac].sfdc015 TO sfdc015
            LET g_sfdc_d[l_ac].sfdc015_desc = s_desc_get_acc_desc('226',g_sfdc_d[l_ac].sfdc015)  #160914-00019#1
            NEXT FIELD sfdc015 

         #add 141222
         #备注
         ON ACTION controlp INFIELD sfdc_ooff013
            CALL s_aooi360_edit('7',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,' ',' ',' ',' ',' ',' ',' ',' ','4',g_sfdc_d[l_ac].sfdc_ooff013)
               RETURNING g_sfdc_d[l_ac].sfdc_ooff013
            DISPLAY g_sfdc_d[l_ac].sfdc_ooff013 TO sfdc_ooff013
            NEXT FIELD sfdc_ooff013
         #add 141222 end
         
         AFTER ROW
            CALL asft310_b_fill() #單身填充
            CALL asft310_b_fill2('0') #單身填充
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_sfdc_d[l_ac].* = g_sfdc_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE asft310_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL asft310_unlock_b("sfdc_t","'2'")
            CALL s_transaction_end('Y','0')

         AFTER INPUT
            #add by lixh 20150529  
            IF g_sfdc_d.getLength() > 0 THEN
               FOR j = 1 TO g_sfdc_d.getLength()
                  CALL s_aooi200_get_slip(g_sfdc_d[j].sfdc001) RETURNING l_success,g_ooba002
                  IF cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0050') = 'N' THEN
                     SELECT sfba019 INTO l_sfba019 FROM sfba_t
                      WHERE sfbaent  = g_enterprise
                        AND sfbadocno= g_sfdc_d[j].sfdc001
                        AND sfbaseq  = g_sfdc_d[j].sfdc002
                        AND sfbaseq1 = g_sfdc_d[j].sfdc003
                     #可输入性
                     IF NOT cl_null(l_sfba019) THEN
                        LET l_sfdc012_switch = 'N'  #N不可输入
                     ELSE
                        LET l_sfdc012_switch = 'Y'  #N不可输入
                     END IF   
                   END IF     
                   IF l_sfdc012_switch = 'Y' THEN
                      SELECT sfaa005,sfaa010 INTO l_sfaa005,l_sfaa010 FROM sfaa_t
                       WHERE sfaaent = g_enterprise
                         AND sfaadocno = g_sfdc_d[j].sfdc001
                      IF l_sfaa005 = '5' AND l_sfaa010 = g_sfdc_d[j].sfdc004 THEN
                         #檢查倉庫是否未非成本倉
                         LET l_inaa010 = ''
                         SELECT inaa010 INTO l_inaa010 FROM inaa_t
                          WHERE inaaent = g_enterprise
                            AND inaasite = g_site
                            AND inaa001 = g_sfdc_d[j].sfdc012
                         IF l_inaa010 <> 'N' THEN
                            INITIALIZE g_errparam TO NULL
                            LET g_errparam.code = 'arm-00011'
                            LET g_errparam.extend = g_sfdc_d[j].sfdc012
                            LET g_errparam.popup = TRUE
                            CALL cl_err()
                            EXIT FOR
                         END IF                     
                      END IF
                   END IF    
                 #161215-00075#1---add---begin---- 
                  IF NOT cl_null(g_sfdc_d[l_ac].sfdc004) THEN
                   IF g_sfdc_d[l_ac].sfdc004 != g_sfdc_d_o.sfdc004  THEN
                    #可超領工單未指定間接材料
                    CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
                    CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0071') RETURNING g_para
                    IF g_sfda_m.sfda002='12' AND g_para='Y' THEN
                       #工单号号+项次若不存在于工单项次中，则需判断料件为间接材料
                       SELECT COUNT(1) INTO l_cnt FROM sfba_t
                        WHERE sfbaent = g_enterprise
                          AND sfbadocno=g_sfdc_d[l_ac].sfdc001
                          AND sfbaseq = g_sfdc_d[l_ac].sfdc002
                       IF l_cnt = 0 THEN
                          #在超領工單領工單不存在的料件，在申請頁籤可以輸入"間接材料"(imae023)='3'
                          SELECT imae023 INTO l_imae023 FROM imae_t
                           WHERE imaeent = g_enterprise
                             AND imaesite= g_site
                             AND imae001 = g_sfdc_d[l_ac].sfdc004
                          IF cl_null(l_imae023) OR l_imae023 != '3' THEN
                             #此料件非间接材料，不可直接超领
                             INITIALIZE g_errparam TO NULL
                             LET g_errparam.code = 'asf-00392'
                             LET g_errparam.extend = g_sfdc_d[l_ac].sfdc004
                             LET g_errparam.popup = TRUE
                             CALL cl_err()
                             LET g_sfdc_d[l_ac].sfdc004 = g_sfdc_d_o.sfdc004
                             CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004) RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
                             NEXT FIELD CURRENT
                          END IF
                           LET l_sfdc002 = 0 
                           SELECT MAX(sfbaseq) INTO l_sfdc002 FROM sfba_t                           
                            WHERE sfbaent = g_enterprise 
                              AND sfbasite = g_site
                              AND sfbadocno = g_sfdc_d[l_ac].sfdc001
                           #170118-00057#1 add --(S)--
                           LET l_sfdc002_1 = 0
                           SELECT MAX(sfdc002) INTO l_sfdc002_1 FROM sfdc_t LEFT JOIN sfda_t ON sfdcent = sfdaent AND sfdcsite = sfdasite AND sfdcdocno = sfdadocno                       
                            WHERE sfdcent = g_enterprise 
                              AND sfdcsite = g_site
                              AND sfdc001  = g_sfdc_d[l_ac].sfdc001
                              AND sfdastus NOT IN ('S','X') 
                           IF cl_null(l_sfdc002_1) THEN LET l_sfdc002_1 = 0 END IF
                           IF l_sfdc002_1 > l_sfdc002 THEN LET l_sfdc002 = l_sfdc002_1 END IF                         
                           #170118-00057#1 add --(E)--   
                           CALL cl_get_para(g_enterprise,g_site,'E-BAS-0008') RETURNING l_ln
                           IF cl_null(l_ln) OR l_ln = 0 THEN
                              LET l_ln = 1
                           END IF
                           LET g_sfdc_d[l_ac].sfdc002 =   l_sfdc002 + l_ln
                           LET g_sfdc_d[l_ac].sfdc003 = 0                           
                        END IF
                      END IF
                    END IF 
                   END IF 
                 #161215-00075#1---add---end----                 
               END FOR
#              CALL g_sfdc_d.deleteElement(g_sfdc_d.getLength())  #161129-00039#1
            END IF
            #add by lixh 20150529  

         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_sfdc_d[li_reproduce_target].* = g_sfdc_d[li_reproduce].*
               LET g_sfdc_d[li_reproduce_target].sfdcseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_sfdc_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_sfdc_d.getLength()+1
            END IF

      END INPUT

      DISPLAY ARRAY g_sfde_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)

         BEFORE ROW
            CALL asft310_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            LET g_detail_idx = l_ac
            CALL asft310_b_fill2('5')

         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx)
            LET l_ac = DIALOG.getCurrentRow("s_detail3")
            CALL asft310_idx_chk()
            LET g_current_page = 3

         #自訂ACTION(detail_show,page_3)

      END DISPLAY

      DISPLAY ARRAY g_sfdc4_d TO s_detail4.* ATTRIBUTES(COUNT=g_rec_b)

         BEFORE ROW
            CALL asft310_idx_chk()
            LET l_ac = DIALOG.getCurrentRow("s_detail4")
            LET g_detail_idx = l_ac
            CALL asft310_b_fill2('6')

         BEFORE DISPLAY
            CALL FGL_SET_ARR_CURR(g_detail_idx)
            LET l_ac = DIALOG.getCurrentRow("s_detail4")
            CALL asft310_idx_chk()
            LET g_current_page = 4

         #自訂ACTION(detail_show,page_4)

      END DISPLAY
      
      #add 150831
      #DISPLAY ARRAY g_inao_d TO s_detail1_s_lot_s01.* ATTRIBUTES(COUNT=g_rec_b) #page3 
      # 
      #   BEFORE ROW
      #      CALL asft310_idx_chk()
      #   #   LET l_ac = DIALOG.getCurrentRow("s_detail1_s_lot_s01")
      #   #   LET g_detail_idx = l_ac
      # 
      #   BEFORE DISPLAY
      #   #   CALL FGL_SET_ARR_CURR(g_detail_idx)
      #   #   LET l_ac = DIALOG.getCurrentRow("s_detail1_s_lot_s01")
      #      CALL asft310_idx_chk()
      #      LET g_current_page = 8
      # 
      #END DISPLAY
      
      DISPLAY ARRAY g_inao_d2 TO s_detail7.* ATTRIBUTES(COUNT=g_rec_b)

         BEFORE ROW
            CALL asft310_idx_chk()
            #LET l_ac = DIALOG.getCurrentRow("s_detail7")
            #LET g_detail_idx = l_ac
            #CALL asft310_b_fill_inao2()

         BEFORE DISPLAY
            #CALL FGL_SET_ARR_CURR(g_detail_idx)
            #LET l_ac = DIALOG.getCurrentRow("s_detail7")
            CALL asft310_idx_chk()
            LET g_current_page = 7  

         #自訂ACTION(detail_show,page_7)

      END DISPLAY
      #add 150831 end

      INPUT ARRAY g_sfdf_d FROM s_detail5.*
         ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效!

                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)

         #自訂ACTION(detail_input,page_5)

         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_sfdf_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL asft310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue(""))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_sfdf_d.getLength()
            #151217-00023#5-s
            IF g_mdemand = 'Y' THEN
               NEXT FIELD sfddseq1
            END IF
            #151217-00023#5-e

         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_sfdf_d[l_ac].* TO NULL 
            INITIALIZE g_sfdf_d_t.* TO NULL 
            INITIALIZE g_sfdf_d_o.* TO NULL 
            #公用欄位給值(單身5)
            #自动流水号
            SELECT MAX(sfdfseq1)+1 INTO g_sfdf_d[l_ac].sfdfseq1
              FROM sfdf_t
             WHERE sfdfent = g_enterprise
               AND sfdfsite= g_site
               AND sfdfdocno=g_sfda_m.sfdadocno
               AND sfdfseq=g_sfde_d[g_detail_idx].sfdeseq
            IF g_sfdf_d[l_ac].sfdfseq1 IS NULL THEN LET g_sfdf_d[l_ac].sfdfseq1 = 1 END IF
            #发料料号：预设带出需求料号
            LET g_sfdf_d[l_ac].sfdf001 = g_sfde_d[g_detail_idx].sfde001
            CALL s_desc_get_item_desc(g_sfdf_d[l_ac].sfdf001)
                 RETURNING g_sfdf_d[l_ac].sfdf001_desc,g_sfdf_d[l_ac].sfdf001_desc2
            #产品特征：预设带出需求料号特征
            LET g_sfdf_d[l_ac].sfdf013 = g_sfde_d[g_detail_idx].sfde002
            CALL s_feature_description(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013)
                 RETURNING l_success,g_sfdf_d[l_ac].sfdf013_desc
            #替代率预设1
            LET g_sfdf_d[l_ac].sfdf002 = 1
            #库位：发料需求指定的库位
            #检查sfdf对应的sfde中包含的sfdc里是否只有一个相同的指定"库位"，此时库位栏位不允许输入只能默认
            IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
               LET l_sql = "SELECT COUNT(UNIQUE sfdc012) ",
                           "  FROM sfdc_t ",
                           " WHERE sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
               END IF
            ELSE
               LET l_sql = "SELECT COUNT(UNIQUE sfdc012) ",
                           "  FROM sfdc_t,sfba_t ",
                           " WHERE sfdcent   = sfbaent ",
                           "   AND sfdc001   = sfbadocno ",
                           "   AND sfdc002   = sfbaseq ",
                           "   AND sfdc003   = sfbaseq1 ",
                           "   AND sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
               END IF
            END IF
            IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
               LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
            ELSE
               LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
            END IF
            DECLARE asft310_input_sfdf_c1 SCROLL CURSOR FROM l_sql
            OPEN asft310_input_sfdf_c1
            FETCH asft310_input_sfdf_c1 INTO l_cnt
            CLOSE asft310_input_sfdf_c1
            IF l_cnt = 1 THEN
               IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                  LET l_sql = "SELECT UNIQUE sfdc012 ",
                              "  FROM sfdc_t ",
                              " WHERE sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED,
                         "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                         "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                         "         where sfbaent  = ",g_enterprise,
                         "           and sfbasite = '",g_site,"') ",
                         "       or (sfdc001,sfdc002,sfdc003) in ",
                         "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                         "         where sfbaent  = ",g_enterprise,
                         "           and sfbasite = '",g_site,"' ",
                         "           and sfba028 IS NULL)) "
                  END IF
               ELSE
                  LET l_sql = "SELECT UNIQUE sfdc012 ",
                              "  FROM sfdc_t,sfba_t ",
                              " WHERE sfdcent   = sfbaent ",
                              "   AND sfdc001   = sfbadocno ",
                              "   AND sfdc002   = sfbaseq ",
                              "   AND sfdc003   = sfbaseq1 ",
                              "   AND sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                  END IF
               END IF
               IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                  LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
               ELSE
                  LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
               END IF
               DECLARE asft310_input_sfdf_c11 SCROLL CURSOR FROM l_sql
               OPEN asft310_input_sfdf_c11
               FETCH asft310_input_sfdf_c11 INTO g_sfdf_d[l_ac].sfdf003
               CLOSE asft310_input_sfdf_c11
               CALL s_desc_get_stock_desc(g_site,g_sfdf_d[l_ac].sfdf003) RETURNING g_sfdf_d[l_ac].sfdf003_desc
            END IF
            #儲位：發料需求的指定儲位
            #检查sfdf对应的sfde中包含的sfdc里是否有指定"储位"为非空，且只有一个相同的指定"储位"，此时此栏位不允许输入只能默认
            IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
               LET l_sql = "SELECT COUNT(UNIQUE sfdc013) ",
                           "  FROM sfdc_t ",
                           " WHERE sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED,
                      "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                      "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                      "         where sfbaent  = ",g_enterprise,
                      "           and sfbasite = '",g_site,"') ",
                      "       or (sfdc001,sfdc002,sfdc003) in ",
                      "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                      "         where sfbaent  = ",g_enterprise,
                      "           and sfbasite = '",g_site,"' ",
                      "           and sfba028 IS NULL)) "
               END IF
            ELSE
               LET l_sql = "SELECT COUNT(UNIQUE sfdc013) ",
                           "  FROM sfdc_t,sfba_t ",
                           " WHERE sfdcent   = sfbaent ",
                           "   AND sfdc001   = sfbadocno ",
                           "   AND sfdc002   = sfbaseq ",
                           "   AND sfdc003   = sfbaseq1 ",
                           "   AND sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
               END IF
            END IF
            IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
               LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
            ELSE
               LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
            END IF
            DECLARE asft310_input_sfdf_c2 SCROLL CURSOR FROM l_sql
            OPEN asft310_input_sfdf_c2
            FETCH asft310_input_sfdf_c2 INTO l_cnt
            CLOSE asft310_input_sfdf_c2
            IF l_cnt = 1 THEN
               IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                  LET l_sql = "SELECT UNIQUE sfdc013 ",
                              "  FROM sfdc_t ",
                              " WHERE sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED,
                            "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                            "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                            "         where sfbaent  = ",g_enterprise,
                            "           and sfbasite = '",g_site,"') ",
                            "       or (sfdc001,sfdc002,sfdc003) in ",
                            "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                            "         where sfbaent  = ",g_enterprise,
                            "           and sfbasite = '",g_site,"' ",
                            "           and sfba028 IS NULL)) "
                  END IF
               ELSE
                  LET l_sql = "SELECT UNIQUE sfdc013 ",
                              "  FROM sfdc_t,sfba_t ",
                              " WHERE sfdcent   = sfbaent ",
                              "   AND sfdc001   = sfbadocno ",
                              "   AND sfdc002   = sfbaseq ",
                              "   AND sfdc003   = sfbaseq1 ",
                              "   AND sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                  END IF
               END IF
               IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                  LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
               ELSE
                  LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
               END IF
               DECLARE asft310_input_sfdf_c21 SCROLL CURSOR FROM l_sql
               OPEN asft310_input_sfdf_c21
               FETCH asft310_input_sfdf_c21 INTO g_sfdf_d[l_ac].sfdf004
               CLOSE asft310_input_sfdf_c21
               CALL s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004) RETURNING g_sfdf_d[l_ac].sfdf004_desc
            END IF
            #批號：發料需求的指定批號
            #检查sfdf对应的sfde中包含的sfdc里是否有指定"批号"为非空，且只有一个相同的指定"批号"，此时此栏位不允许输入只能默认
            IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
               LET l_sql = "SELECT COUNT(UNIQUE sfdc014) ",
                           "  FROM sfdc_t ",
                           " WHERE sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED,
                      "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                      "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                      "         where sfbaent  = ",g_enterprise,
                      "           and sfbasite = '",g_site,"') ",
                      "       or (sfdc001,sfdc002,sfdc003) in ",
                      "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                      "         where sfbaent  = ",g_enterprise,
                      "           and sfbasite = '",g_site,"' ",
                      "           and sfba028 IS NULL)) "
               END IF
            ELSE
               LET l_sql = "SELECT COUNT(UNIQUE sfdc014) ",
                           "  FROM sfdc_t,sfba_t ",
                           " WHERE sfdcent   = sfbaent ",
                           "   AND sfdc001   = sfbadocno ",
                           "   AND sfdc002   = sfbaseq ",
                           "   AND sfdc003   = sfbaseq1 ",
                           "   AND sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
               END IF
            END IF
            IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
               LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
            ELSE
               LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
            END IF
            DECLARE asft310_input_sfdf_c3 SCROLL CURSOR FROM l_sql
            OPEN asft310_input_sfdf_c3
            FETCH asft310_input_sfdf_c3 INTO l_cnt
            CLOSE asft310_input_sfdf_c3
            IF l_cnt = 1 THEN
               IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                  LET l_sql = "SELECT UNIQUE sfdc014 ",
                              "  FROM sfdc_t ",
                              " WHERE sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED,
                          "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"') ",
                          "       or (sfdc001,sfdc002,sfdc003) in ",
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"' ",
                          "           and sfba028 IS NULL)) "
                  END IF
               ELSE
                  LET l_sql = "SELECT UNIQUE sfdc014 ",
                              "  FROM sfdc_t,sfba_t ",
                              " WHERE sfdcent   = sfbaent ",
                              "   AND sfdc001   = sfbadocno ",
                              "   AND sfdc002   = sfbaseq ",
                              "   AND sfdc003   = sfbaseq1 ",
                              "   AND sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                  END IF
               END IF
               IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                  LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
               ELSE
                  LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
               END IF
               DECLARE asft310_input_sfdf_c31 SCROLL CURSOR FROM l_sql
               OPEN asft310_input_sfdf_c31
               FETCH asft310_input_sfdf_c31 INTO g_sfdf_d[l_ac].sfdf005
               CLOSE asft310_input_sfdf_c31
            END IF
            #庫存管理特徵：發料需求的庫存管理特徵
            #检查sfdf对应的sfde中包含的sfdc里是否有指定"库存管理特征"为非空，且只有一个相同的指定"库存管理特征"，此时此栏位不允许输入只能默认
            IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
               LET l_sql = "SELECT COUNT(UNIQUE sfdc016) ",
                           "  FROM sfdc_t ",
                           " WHERE sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED,
                     "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                     "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                     "         where sfbaent  = ",g_enterprise,
                     "           and sfbasite = '",g_site,"') ",
                     "       or (sfdc001,sfdc002,sfdc003) in ",
                     "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                     "         where sfbaent  = ",g_enterprise,
                     "           and sfbasite = '",g_site,"' ",
                     "           and sfba028 IS NULL)) "
               END IF
            ELSE
               LET l_sql = "SELECT COUNT(UNIQUE sfdc016) ",
                           "  FROM sfdc_t,sfba_t ",
                           " WHERE sfdcent   = sfbaent ",
                           "   AND sfdc001   = sfbadocno ",
                           "   AND sfdc002   = sfbaseq ",
                           "   AND sfdc003   = sfbaseq1 ",
                           "   AND sfdcent   = ",g_enterprise,
                           "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                           "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                           "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                           "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
               IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                  LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
               END IF
            END IF
            IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
               LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
            ELSE
               LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
            END IF
            DECLARE asft310_input_sfdf_c4 SCROLL CURSOR FROM l_sql
            OPEN asft310_input_sfdf_c4
            FETCH asft310_input_sfdf_c4 INTO l_cnt
            CLOSE asft310_input_sfdf_c4
            IF l_cnt = 1 THEN
               IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                  LET l_sql = "SELECT UNIQUE sfdc016 ",
                              "  FROM sfdc_t ",
                              " WHERE sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED,
                          "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"') ",
                          "       or (sfdc001,sfdc002,sfdc003) in ",
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"' ",
                          "           and sfba028 IS NULL)) "
                  END IF
               ELSE
                  LET l_sql = "SELECT UNIQUE sfdc016 ",
                              "  FROM sfdc_t,sfba_t ",
                              " WHERE sfdcent   = sfbaent ",
                              "   AND sfdc001   = sfbadocno ",
                              "   AND sfdc002   = sfbaseq ",
                              "   AND sfdc003   = sfbaseq1 ",
                              "   AND sfdcent   = ",g_enterprise,
                              "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",
                              "   AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",   #需求料号
                              "   AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",   #特征
                              "   AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "    #单位
                  IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                     LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                  END IF
               END IF
               IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                  LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
               ELSE
                  LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
               END IF
               DECLARE asft310_input_sfdf_c41 SCROLL CURSOR FROM l_sql
               OPEN asft310_input_sfdf_c41
               FETCH asft310_input_sfdf_c41 INTO g_sfdf_d[l_ac].sfdf010
               CLOSE asft310_input_sfdf_c41
            END IF
            #单位：發料申請單身的單位
            LET g_sfdf_d[l_ac].sfdf006 = g_sfde_d[g_detail_idx].sfde003
            LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)
            #參考單位：發料申請單身的參考單位
            LET g_sfdf_d[l_ac].sfdf008 = g_sfde_d[g_detail_idx].sfde006
            LEt g_sfdf_d[l_ac].sfdf008_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008)
            #发料-1
            IF g_prog[1,6]='asft31' THEN LET g_sfdf_d[l_ac].sfdf012 = -1 END IF
            #退料1
            IF g_prog[1,6]='asft32' THEN LET g_sfdf_d[l_ac].sfdf012 =  1 END IF
            LET g_sfdf_d_t.* = g_sfdf_d[l_ac].*     #新輸入資料
            LET g_sfdf_d_o.* = g_sfdf_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL asft310_set_entry_b_sfdf(l_cmd)
            CALL asft310_set_no_entry_b_sfdf(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_sfdf_d[li_reproduce_target].* = g_sfdf_d[li_reproduce].*
               LET g_sfdf_d[li_reproduce_target].sfdfseq1 = NULL
            END IF

         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[5] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx2 = l_ac
            LET g_current_page = 5
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            
            CALL s_transaction_begin()
            OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN asft310_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE asft310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF

            LET g_rec_b = g_sfdf_d.getLength()

            IF g_rec_b >= l_ac AND g_sfdf_d[l_ac].sfdfseq1 IS NOT NULL THEN
               LET l_cmd='u'
               LET g_sfdf_d_t.* = g_sfdf_d[l_ac].*  #BACKUP
               LET g_sfdf_d_o.* = g_sfdf_d[l_ac].*  #BACKUP
               CALL asft310_set_entry_b_sfdf(l_cmd)
               CALL asft310_set_no_entry_b_sfdf(l_cmd)
               #SELECT * INTO l_sfdf_t.* FROM sfdf_t #161109-00085#62
               #161109-00085#62 --s add
               SELECT sfdfent,sfdfsite,sfdfdocno,sfdfseq,sfdfseq1,
                      sfdf001,sfdf002,sfdf003,sfdf004,sfdf005,
                      sfdf006,sfdf007,sfdf008,sfdf009,sfdf010,
                      sfdf011,sfdf012,sfdf013,sfdfud001,sfdfud002,
                      sfdfud003,sfdfud004,sfdfud005,sfdfud006,sfdfud007,
                      sfdfud008,sfdfud009,sfdfud010,sfdfud011,sfdfud012,
                      sfdfud013,sfdfud014,sfdfud015,sfdfud016,sfdfud017,
                      sfdfud018,sfdfud019,sfdfud020,sfdfud021,sfdfud022,
                      sfdfud023,sfdfud024,sfdfud025,sfdfud026,sfdfud027,
                      sfdfud028,sfdfud029,sfdfud030
                 INTO l_sfdf_t.sfdfent,l_sfdf_t.sfdfsite,l_sfdf_t.sfdfdocno,l_sfdf_t.sfdfseq,l_sfdf_t.sfdfseq1,
                      l_sfdf_t.sfdf001,l_sfdf_t.sfdf002,l_sfdf_t.sfdf003,l_sfdf_t.sfdf004,l_sfdf_t.sfdf005,
                      l_sfdf_t.sfdf006,l_sfdf_t.sfdf007,l_sfdf_t.sfdf008,l_sfdf_t.sfdf009,l_sfdf_t.sfdf010,
                      l_sfdf_t.sfdf011,l_sfdf_t.sfdf012,l_sfdf_t.sfdf013,l_sfdf_t.sfdfud001,l_sfdf_t.sfdfud002,
                      l_sfdf_t.sfdfud003,l_sfdf_t.sfdfud004,l_sfdf_t.sfdfud005,l_sfdf_t.sfdfud006,l_sfdf_t.sfdfud007,
                      l_sfdf_t.sfdfud008,l_sfdf_t.sfdfud009,l_sfdf_t.sfdfud010,l_sfdf_t.sfdfud011,l_sfdf_t.sfdfud012,
                      l_sfdf_t.sfdfud013,l_sfdf_t.sfdfud014,l_sfdf_t.sfdfud015,l_sfdf_t.sfdfud016,l_sfdf_t.sfdfud017,
                      l_sfdf_t.sfdfud018,l_sfdf_t.sfdfud019,l_sfdf_t.sfdfud020,l_sfdf_t.sfdfud021,l_sfdf_t.sfdfud022,
                      l_sfdf_t.sfdfud023,l_sfdf_t.sfdfud024,l_sfdf_t.sfdfud025,l_sfdf_t.sfdfud026,l_sfdf_t.sfdfud027,
                      l_sfdf_t.sfdfud028,l_sfdf_t.sfdfud029,l_sfdf_t.sfdfud030
                 FROM sfdf_t
               #161109-00085#62 --e add
                WHERE sfdfent   = g_enterprise
                  AND sfdfdocno = g_sfda_m.sfdadocno
                  AND sfdfseq   = g_sfde_d[g_detail_idx].sfdeseq
                  AND sfdfseq1  = g_sfdf_d_t.sfdfseq1
               IF NOT asft310_lock_b("sfdf_t","'5'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft310_bcl5 INTO g_sfdf_d[l_ac].sfdfseq1,g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf001_desc,
                      g_sfdf_d[l_ac].sfdf001_desc2,g_sfdf_d[l_ac].sfdf013,g_sfdf_d[l_ac].sfdf013_desc,g_sfdf_d[l_ac].sfdf002,g_sfdf_d[l_ac].sfdf003,
                      g_sfdf_d[l_ac].sfdf003_desc,g_sfdf_d[l_ac].sfdf004,g_sfdf_d[l_ac].sfdf004_desc,
                      g_sfdf_d[l_ac].sfdf005,g_sfdf_d[l_ac].sfdf010,g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf006_desc,
                      g_sfdf_d[l_ac].sfdf007,g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf008_desc,g_sfdf_d[l_ac].sfdf009,
                      g_sfdf_d[l_ac].sfdf011,g_sfdf_d[l_ac].sfdf012
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #mod 150121
                  #LET g_bfill = "N"
                  #CALL asft310_show()
                  #LET g_bfill = "Y"
                  CALL asft310_b_show('sfdf',l_ac)
                  #mod 150121 end

                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF

         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
            ELSE
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_sfda_m.sfdadocno
               LET gs_keys[02] = g_sfde_d[g_detail_idx].sfdeseq
               LET gs_keys[03] = g_sfdf_d_t.sfdfseq1
              
               DELETE FROM sfdf_t
                WHERE sfdfent  = g_enterprise
                  AND sfdfdocno= g_sfda_m.sfdadocno
                  AND sfdfseq  = g_sfde_d[g_detail_idx].sfdeseq
                  AND sfdfseq1 = g_sfdf_d_t.sfdfseq1
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "DELETE FROM sfdf_t",SQLERRMESSAGE  
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CALL s_transaction_end('N','0')  #需要有事务，如果没有事务，直接cancel delete ，回到单身状态就不在事务中了
                  LET l_flag = 'f'  #取消cancel的做法，本次事务回滚，重新走INPUT进入，回到当前笔状态
                  CLOSE asft310_bcl5 #重新进入单身需要先关闭游标
                  CONTINUE WHILE
                  #CANCEL DELETE
               ELSE
                  LET l_success_tot = TRUE
                  #回写sfde的实际数量，参考单位实际数量
                  IF NOT s_asft310_chg_sfde_f_sfdf_del('N',l_sfdf_t.*) THEN
                     LET l_success_tot = FALSE
                  END IF
                  #处理sfdd,sfdc
                  IF NOT s_asft310_chg_sfdd_f_sfdf_del('N',l_sfdf_t.*) THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 150831 begin
                  #删除sfdc中没有，而inao中有的资料
                  DELETE FROM inao_t
                   WHERE inaoent  = g_enterprise
                     AND inaosite = g_site
                     AND inaodocno= g_sfda_m.sfdadocno
                     AND inao000  = '1'  #申请
                     AND NOT EXISTS (SELECT 1 FROM sfdc_t
                                      WHERE sfdcent = inaoent AND sfdcdocno = inaodocno
                                        AND sfdcseq = inaoseq)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "DELETE FROM inao_t",SQLERRMESSAGE
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET l_success_tot = FALSE
                  END IF
                  #删除sfdd中没有，而inao中有的资料
                  DELETE FROM inao_t
                   WHERE inaoent  = g_enterprise
                     AND inaosite = g_site
                     AND inaodocno= g_sfda_m.sfdadocno
                     AND inao000  = '2'  #实际
                     AND NOT EXISTS (SELECT 1 FROM sfdd_t
                                      WHERE sfddent = inaoent AND sfdddocno = inaodocno
                                        AND sfddseq = inaoseq AND sfddseq1  = inaoseq1)
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "DELETE FROM inao_t",SQLERRMESSAGE
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET l_success_tot = FALSE
                  END IF
                  #add 150831 end
                  
                  IF NOT l_success_tot THEN
                     CALL s_transaction_end('N','0')  #需要有事务，如果没有事务，直接cancel delete ，回到单身状态就不在事务中了
                     LET l_flag = 'f'  #取消cancel的做法，本次事务回滚，重新走INPUT进入，回到当前笔状态
                     CLOSE asft310_bcl5 #重新进入单身需要先关闭游标
                     CONTINUE WHILE
                     #CANCEL DELETE
                  END IF
               END IF
                  
               CALL s_transaction_end('Y','0')
               CLOSE asft310_bcl5
               LET g_rec_b = g_rec_b-1
               LET l_count = g_sfdf_d.getLength()
               
            END IF

         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_sfdf_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
            
            #重复性检查
            IF NOT asft310_chk_sfdf_unique() THEN
               CANCEL INSERT
            END IF
            #检查库位、储位、批号的范围，是否在需求指定发料库位、储位、批号允许的数量内
            IF NOT asft310_chk_ware_range('ALL') THEN
               CANCEL INSERT
            END IF
            #检查储位、批号数量是否超出需求指定范围内的数量
            IF NOT asft310_chk_ware_range_qty('ALL') THEN
               CANCEL INSERT
            END IF

            LET l_count = 1
            SELECT COUNT(1) INTO l_count FROM sfdf_t
             WHERE sfdfent = g_enterprise AND sfdfsite = g_site AND sfdfdocno = g_sfda_m.sfdadocno
               AND sfdfseq = g_sfde_d[g_detail_idx].sfdeseq AND sfdfseq1 = g_sfdf_d[g_detail_idx2].sfdfseq1
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfda_m.sfdadocno
               LET gs_keys[2] = g_sfde_d[g_detail_idx].sfdeseq
               LET gs_keys[3] = g_sfdf_d[g_detail_idx2].sfdfseq1
               CALL asft310_insert_b('sfdf_t',gs_keys,"'5'")
            ELSE
               INITIALIZE g_sfdf_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
            
            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "sfdf_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               LET l_success_tot = TRUE
               #更新sfde
               IF NOT s_asft310_chg_sfde_f_sfdf_ins(g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq,g_sfdf_d[g_detail_idx2].sfdfseq1) THEN
                  LET l_success_tot = FALSE
               END IF
               #处理sfdd与dfdc：sfdd与sfdf总数应该平的
               IF NOT s_asft310_chg_sfdd_f_sfdf_ins(g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq,g_sfdf_d[g_detail_idx2].sfdfseq1) THEN
                  LET l_success_tot = FALSE
               END IF
               IF NOT l_success_tot THEN
                  CALL s_transaction_end('N','0')
                  CANCEL INSERT
               END IF
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF

         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_sfdf_d[l_ac].* = g_sfdf_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE asft310_bcl5
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_sfdf_d[l_ac].* = g_sfdf_d_t.*
            ELSE
               #检查库位、储位、批号的范围，是否在需求指定发料库位、储位、批号允许的数量内
               IF NOT asft310_chk_ware_range('ALL') THEN
                  NEXT FIELD sfdf004  #储位
               END IF
               #检查储位、批号数量是否超出需求指定范围内的数量
               IF NOT asft310_chk_ware_range_qty('ALL') THEN
                  NEXT FIELD sfdf004  #储位
               END IF

               #寫入修改者/修改日期資訊(單身5)

               IF cl_null(g_sfdf_d[l_ac].sfdf013) THEN LET g_sfdf_d[l_ac].sfdf013 = ' ' END IF #产品特征
               IF cl_null(g_sfdf_d[l_ac].sfdf003) THEN LET g_sfdf_d[l_ac].sfdf003 = ' ' END IF
               IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN LET g_sfdf_d[l_ac].sfdf004 = ' ' END IF
               IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN LET g_sfdf_d[l_ac].sfdf005 = ' ' END IF
               IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN LET g_sfdf_d[l_ac].sfdf010 = ' ' END IF
               IF cl_null(g_sfdf_d[l_ac].sfdf009) THEN LET g_sfdf_d[l_ac].sfdf009 = 0 END IF #参考单位数量
               #单位取位
               IF NOT cl_null(g_sfdf_d[l_ac].sfdf006) THEN
                  CALL s_aooi250_take_decimals(g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf007)
                       RETURNING l_success,g_sfdf_d[l_ac].sfdf007
               END IF
               IF NOT cl_null(g_sfdf_d[l_ac].sfdf008) THEN
                  CALL s_aooi250_take_decimals(g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf009)
                       RETURNING l_success,g_sfdf_d[l_ac].sfdf009
               END IF
               
               UPDATE sfdf_t SET (sfdfdocno,sfdfseq,sfdfseq1,sfdf001,sfdf013,sfdf002,sfdf003,sfdf004,sfdf005,
                   sfdf010,sfdf006,sfdf007,sfdf008,sfdf009,sfdf011,sfdf012) = (g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq,
                   g_sfdf_d[l_ac].sfdfseq1,g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013,g_sfdf_d[l_ac].sfdf002,g_sfdf_d[l_ac].sfdf003,
                   g_sfdf_d[l_ac].sfdf004,g_sfdf_d[l_ac].sfdf005,g_sfdf_d[l_ac].sfdf010,g_sfdf_d[l_ac].sfdf006,
                   g_sfdf_d[l_ac].sfdf007,g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf009,g_sfdf_d[l_ac].sfdf011,
                   g_sfdf_d[l_ac].sfdf012) #自訂欄位頁簽
                WHERE sfdfent = g_enterprise AND sfdfsite = g_site AND sfdfdocno = g_sfdadocno_t AND
                    sfdfseq = g_sfde_d[g_detail_idx].sfdeseq AND sfdfseq1 = g_sfdf_d_t.sfdfseq1
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_sfdf_d[l_ac].* = g_sfdf_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "sfdf_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_sfdf_d[l_ac].* = g_sfdf_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "sfdf_t:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                  OTHERWISE
                     ##資料多語言用-增/改
                     #INITIALIZE gs_keys TO NULL 
                     #LET gs_keys[1] = g_sfda_m.sfdadocno
                     #LET gs_keys_bak[1] = g_sfdadocno_t
                     #LET gs_keys[2] = g_sfde_d[g_detail_idx].sfdeseq
                     #LET gs_keys_bak[2] = g_sfde_d[g_detail_idx].sfdeseq
                     #LET gs_keys[3] = g_sfdf_d[g_detail_idx2].sfdfseq1
                     #LET gs_keys_bak[3] = g_sfdf_d_t.sfdfseq1
                     #CALL axmt500_update_b('sfdf_t',gs_keys,gs_keys_bak,"'5'")
               END CASE
               
               #160914-00019#1-s
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_sfdf_d),util.JSON.stringify(g_sfdf_d_t)
               LET g_log2 = util.JSON.stringify(g_sfdf_d),util.JSON.stringify(g_sfdf_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               #160914-00019#1-e
               
               #关联表处理
               IF g_intrans = 'Y' THEN  #若事务还没走rollback则(上面没有走commit)
                  LET l_success_tot = TRUE
                  #SELECT * INTO l_sfdf.* FROM sfdf_t #161109-00085#62 mark
                  #161109-00085#62 --s add
                  SELECT sfdfent,sfdfsite,sfdfdocno,sfdfseq,sfdfseq1,
                         sfdf001,sfdf002,sfdf003,sfdf004,sfdf005,
                         sfdf006,sfdf007,sfdf008,sfdf009,sfdf010,
                         sfdf011,sfdf012,sfdf013,sfdfud001,sfdfud002,
                         sfdfud003,sfdfud004,sfdfud005,sfdfud006,sfdfud007,
                         sfdfud008,sfdfud009,sfdfud010,sfdfud011,sfdfud012,
                         sfdfud013,sfdfud014,sfdfud015,sfdfud016,sfdfud017,
                         sfdfud018,sfdfud019,sfdfud020,sfdfud021,sfdfud022,
                         sfdfud023,sfdfud024,sfdfud025,sfdfud026,sfdfud027,
                         sfdfud028,sfdfud029,sfdfud030
                    INTO l_sfdf.sfdfent,l_sfdf.sfdfsite,l_sfdf.sfdfdocno,l_sfdf.sfdfseq,l_sfdf.sfdfseq1,
                         l_sfdf.sfdf001,l_sfdf.sfdf002,l_sfdf.sfdf003,l_sfdf.sfdf004,l_sfdf.sfdf005,
                         l_sfdf.sfdf006,l_sfdf.sfdf007,l_sfdf.sfdf008,l_sfdf.sfdf009,l_sfdf.sfdf010,
                         l_sfdf.sfdf011,l_sfdf.sfdf012,l_sfdf.sfdf013,l_sfdf.sfdfud001,l_sfdf.sfdfud002,
                         l_sfdf.sfdfud003,l_sfdf.sfdfud004,l_sfdf.sfdfud005,l_sfdf.sfdfud006,l_sfdf.sfdfud007,
                         l_sfdf.sfdfud008,l_sfdf.sfdfud009,l_sfdf.sfdfud010,l_sfdf.sfdfud011,l_sfdf.sfdfud012,
                         l_sfdf.sfdfud013,l_sfdf.sfdfud014,l_sfdf.sfdfud015,l_sfdf.sfdfud016,l_sfdf.sfdfud017,
                         l_sfdf.sfdfud018,l_sfdf.sfdfud019,l_sfdf.sfdfud020,l_sfdf.sfdfud021,l_sfdf.sfdfud022,
                         l_sfdf.sfdfud023,l_sfdf.sfdfud024,l_sfdf.sfdfud025,l_sfdf.sfdfud026,l_sfdf.sfdfud027,
                         l_sfdf.sfdfud028,l_sfdf.sfdfud029,l_sfdf.sfdfud030
                    FROM sfdf_t
                  #161109-00085#62 --e add
                   WHERE sfdfent   = g_enterprise
                     AND sfdfdocno = g_sfda_m.sfdadocno
                     AND sfdfseq   = g_sfde_d[g_detail_idx].sfdeseq
                     AND sfdfseq1  = g_sfdf_d[g_detail_idx2].sfdfseq1
                  #处理sfde
                  IF NOT s_asft310_chg_sfde_f_sfdf_upd(l_sfdf_t.*,l_sfdf.*) THEN
                     LET l_success_tot = FALSE
                  END IF
                  #处理sfdd,sfdc
                  IF NOT s_asft310_chg_sfdd_f_sfdf_upd(l_sfdf_t.*,l_sfdf.*) THEN
                     LET l_success_tot = FALSE
                  END IF
                  IF NOT l_success_tot THEN
                     CALL s_transaction_end('N','0')
                     LET g_sfdf_d[l_ac].* = g_sfdf_d_t.*
                  END IF
               END IF
            END IF

         AFTER FIELD sfdfseq1
            IF  g_sfda_m.sfdadocno IS NOT NULL AND g_sfde_d[g_detail_idx].sfdeseq IS NOT NULL AND g_sfdf_d[g_detail_idx2].sfdfseq1 IS NOT NULL THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfda_m.sfdadocno != g_sfdadocno_t OR g_sfde_d[g_detail_idx].sfdeseq != g_sfde_d[g_detail_idx].sfdeseq OR g_sfdf_d[g_detail_idx2].sfdfseq1 != g_sfdf_d_t.sfdfseq1)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfdf_t WHERE "||"sfdfent = '" ||g_enterprise|| "' AND sfdfsite = '" ||g_site|| "' AND "||"sfdfdocno = '"||g_sfda_m.sfdadocno ||"' AND "|| "sfdfseq = '"||g_sfde_d[g_detail_idx].sfdeseq ||"' AND "|| "sfdfseq1 = '"||g_sfdf_d[g_detail_idx2].sfdfseq1 ||"'",'std-00004',0) THEN
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            IF NOT cl_null(g_sfdf_d[l_ac].sfdfseq1) THEN
               IF g_sfdf_d[l_ac].sfdfseq1 < 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'amm-00002'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
            ELSE
               LET g_sfdf_d[l_ac].sfdfseq1 = g_sfdf_d_t.sfdfseq1
            END IF
            LET g_sfdf_d_o.sfdfseq1 = g_sfdf_d[l_ac].sfdfseq1

         #库位
         AFTER FIELD sfdf003
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdf003_switch = 'Y' THEN
               #160914-00019#1-s
               LET g_sfdf_d[l_ac].sfdf003_desc = ''
               IF NOT cl_null(g_sfdf_d[l_ac].sfdf003) THEN
                  IF g_sfdf_d[l_ac].sfdf003 != g_sfdf_d_o.sfdf003 OR cl_null(g_sfdf_d_o.sfdf003) THEN
                     IF NOT asft310_sfdf_loca_chk('sfdf003') THEN
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  LET g_sfdf_d[l_ac].sfdf003_desc = s_desc_get_stock_desc(g_site,g_sfdf_d[l_ac].sfdf003)
               #160914-00019#1-e
               END IF
            END IF
            LET g_sfdf_d_o.sfdf003 = g_sfdf_d[l_ac].sfdf003
         
         #储位
         AFTER FIELD sfdf004
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdf004_switch = 'Y' THEN
            #160914-00019#1-s
               LET g_sfdf_d[l_ac].sfdf004_desc = ''
               IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) THEN
                  IF g_sfdf_d[l_ac].sfdf004 != g_sfdf_d_o.sfdf004 OR cl_null(g_sfdf_d_o.sfdf004) THEN
                     IF NOT asft310_sfdf_loca_chk('sfdf004') THEN
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  LET g_sfdf_d[l_ac].sfdf004_desc = s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004)
               END IF
            END IF
            LET g_sfdf_d_o.sfdf004 = g_sfdf_d[l_ac].sfdf004
            LET g_sfdf_d_o.sfdf005 = g_sfdf_d[l_ac].sfdf005
            LET g_sfdf_d_o.sfdf010 = g_sfdf_d[l_ac].sfdf010
            #160914-00019#1-e

         #批号
         AFTER FIELD sfdf005
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdf005_switch = 'Y' THEN
            #160914-00019#1-s
               IF NOT cl_null(g_sfdf_d[l_ac].sfdf005) THEN
                  IF g_sfdf_d[l_ac].sfdf005 != g_sfdf_d_o.sfdf005 OR cl_null(g_sfdf_d_o.sfdf005) THEN
                     IF NOT asft310_sfdf_loca_chk('sfdf005') THEN
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdf_d_o.sfdf004 = g_sfdf_d[l_ac].sfdf004
            LET g_sfdf_d_o.sfdf005 = g_sfdf_d[l_ac].sfdf005
            LET g_sfdf_d_o.sfdf010 = g_sfdf_d[l_ac].sfdf010
            #160914-00019#1-e
            
         #库存管理特征
         AFTER FIELD sfdf010
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF g_sfdf010_switch = 'Y' THEN
               IF NOT cl_null(g_sfdf_d[l_ac].sfdf010) THEN
                  IF g_sfdf_d[l_ac].sfdf010 != g_sfdf_d_o.sfdf010 OR cl_null(g_sfdf_d_o.sfdf010) THEN
                     SELECT COUNT(1) INTO l_cnt FROM inag_t
                      WHERE inagent  = g_enterprise
                        AND inagsite = g_site
                        AND inag001  = g_sfdc_d[l_ac].sfdc001  #料件
                        AND inag002  = g_sfde_d[g_detail_idx].sfde002  #产品特征
                        AND inag003  = g_sfdf_d[l_ac].sfdf010  #库存管理特征
                     IF l_cnt = 0 THEN
                        #无此库存管理特征，请检查库存资料后从新输入
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00117'
                        LET g_errparam.extend = '' #g_sfdc_d[l_ac].sfdc001
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfdf_d[l_ac].sfdf010 = g_sfdf_d_o.sfdf010
                        NEXT FIELD CURRENT
                     END IF
                     IF NOT asft310_chk_sfdf_unique() THEN
                        LET g_sfdf_d[l_ac].sfdf010 = g_sfdf_d_o.sfdf010
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdf_d_o.sfdf004 = g_sfdf_d[l_ac].sfdf004
            LET g_sfdf_d_o.sfdf005 = g_sfdf_d[l_ac].sfdf005
            LET g_sfdf_d_o.sfdf010 = g_sfdf_d[l_ac].sfdf010

         #单位
         AFTER FIELD sfdf006
            #160914-00019#1-s
            LET g_sfdf_d[l_ac].sfdf006_desc = ''
            IF NOT cl_null(g_sfdf_d[l_ac].sfdf006) THEN
               IF g_sfdf_d[l_ac].sfdf006 != g_sfdf_d_o.sfdf006 OR cl_null(g_sfdf_d_o.sfdf006) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdf_d[l_ac].sfdf006
                  #160318-00025#22-s
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
                  #160318-00025#22-e
                  IF NOT cl_chk_exist("v_ooca001") THEN
                     LET g_sfdf_d[l_ac].sfdf006 = g_sfdf_d_o.sfdf006
                     LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)
                     NEXT FIELD CURRENT
                  END IF
                  #單位需與發料料號的基礎單位有轉換率
                  IF NOT s_aimi190_chk_base_convert(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006) THEN
                     LET g_sfdf_d[l_ac].sfdf006 = g_sfdf_d_o.sfdf006
                     LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)
                     NEXT FIELD CURRENT
                  END IF
                  #计算sfdf002替代率
                  #若是替代料，则不允许修改单位，因为无法指定到主件，因此无法计算替代率
                  IF g_sfdf_d[l_ac].sfdf001 != g_sfde_d[g_detail_idx].sfde001 OR
                     g_sfdf_d[l_ac].sfdf013 != g_sfde_d[g_detail_idx].sfde002 THEN
                     #汇总发退料时，若使用取替代料，不可修改单位；若确实需要修改单位元，请至“发料明细”页签进行修改
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00136'
                     LET g_errparam.extend = g_sfdf_d[l_ac].sfdf006
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdf_d[l_ac].sfdf006 = g_sfdf_d_o.sfdf006
                     LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)
                     NEXT FIELD CURRENT
                  END IF
                  #相同项目重复性检查
                  IF NOT asft310_chk_sfdf_unique() THEN
                     LET g_sfdf_d[l_ac].sfdf006 = g_sfdf_d_o.sfdf006
                     LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)
                     NEXT FIELD CURRENT
                  END IF
                  #预设参考数量=數量*單位轉換率
                  IF NOT cl_null(g_sfdf_d[l_ac].sfdf007) AND NOT cl_null(g_sfdf_d[l_ac].sfdf008) THEN
                     CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf007)
                        RETURNING l_success,g_sfdf_d[l_ac].sfdf009
                     IF NOT l_success THEN
                        LET g_sfdf_d[l_ac].sfdf009 = g_sfdf_d[l_ac].sfdf007
                     END IF
                  ELSE
                     LET g_sfdf_d[l_ac].sfdf009 = 0
                  END IF
               END IF
               LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)
            END IF 
            LET g_sfdf_d_o.sfdf006 = g_sfdf_d[l_ac].sfdf006
            LET g_sfdf_d_o.sfdf009 = g_sfdf_d[l_ac].sfdf009
            #160914-00019#1-e

         #数量
         AFTER FIELD sfdf007
            IF NOT cl_null(g_sfdf_d[l_ac].sfdf007) THEN
               IF g_sfdf_d[l_ac].sfdf007 != g_sfdf_d_o.sfdf007 OR cl_null(g_sfdf_d_o.sfdf007) THEN
                  IF NOT cl_null(g_sfdf_d[l_ac].sfdf006) THEN
                     CALL s_aooi250_take_decimals(g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf007)
                          RETURNING l_success,g_sfdf_d[l_ac].sfdf007
                  END IF
                  #mod 141211
                  IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單
                     #不可小于0，可以等于0 因为到倉庫那確實沒有庫存，那實際量就0，其他的有庫存還是要發
                     IF g_sfdf_d[l_ac].sfdf007 < 0 THEN
                        #數量不可小於0
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'agl-00041'
                        LET g_errparam.extend = g_sfdf_d[l_ac].sfdf007
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfdf_d[l_ac].sfdf007 = g_sfdf_d_o.sfdf007
                        NEXT FIELD CURRENT
                     END IF
                  ELSE  #退料单
                     #不可小于等于0
                     IF NOT cl_ap_chk_Range(g_sfdf_d[l_ac].sfdf007,"0.000","0","","","azz-00079",1) THEN
                        LET g_sfdf_d[l_ac].sfdf007 = g_sfdf_d_o.sfdf007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #mod 141211-end
                  #检查库位、储位、批号的范围，是否在需求指定发料库位、储位、批号允许的数量内
                  IF NOT asft310_chk_ware_range_qty('sfdf007') THEN
                     LET g_sfdf_d[l_ac].sfdf007 = g_sfdf_d_o.sfdf007
                     NEXT FIELD CURRENT
                  END IF
                  #數量總數不可超過申請數量
                  IF NOT asft310_chk_sfdf_amt(l_cmd,'sfdf007') THEN
                     LET g_sfdf_d[l_ac].sfdf007 = g_sfdf_d_o.sfdf007
                     NEXT FIELD CURRENT
                  END IF
                  #发料单做在捡量的检查
                  IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdf_d[l_ac].sfdf007) AND NOT cl_null(g_sfdf_d[l_ac].sfdf003) THEN  #在捡数量 库位
                     IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN LET g_sfdf_d[l_ac].sfdf010= ' ' END IF  #库存管理特征
                     IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN LET g_sfdf_d[l_ac].sfdf004= ' ' END IF  #储位
                     IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN LET g_sfdf_d[l_ac].sfdf005= ' ' END IF  #批号
                     #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
                     #                           据点   料件编号                产品特征                库存管理特征
                     CALL s_inventory_check_inan(g_site,g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013,g_sfdf_d[l_ac].sfdf010,
                     #                           库位                   储位                    批号
                                                 g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004,g_sfdf_d[l_ac].sfdf005,
                     #                           交易单位                在捡数量
                                                 g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf007,
                     #                           单据编号            项次                           项序
                                                 g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq,g_sfdf_d[l_ac].sfdfseq1,
                     #                           工單單號                 工單項次 
                                                 g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
                          RETURNING l_success,l_flag2
                     IF NOT l_flag2 THEN
                        LET g_sfdf_d[l_ac].sfdf007 = g_sfdf_d_o.sfdf007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #预设参考数量=數量*單位轉換率
                  IF NOT cl_null(g_sfdf_d[l_ac].sfdf006) AND NOT cl_null(g_sfdf_d[l_ac].sfdf008) THEN
                     CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf007)
                        RETURNING l_success,g_sfdf_d[l_ac].sfdf009
                     IF NOT l_success THEN
                        LET g_sfdf_d[l_ac].sfdf009 = g_sfdf_d[l_ac].sfdf007
                     END IF
                     #mod 150101 end
                  ELSE
                     LET g_sfdf_d[l_ac].sfdf009 = 0
                  END IF
               END IF
            END IF
            LET g_sfdf_d_o.sfdf007 = g_sfdf_d[l_ac].sfdf007
            LET g_sfdf_d_o.sfdf009 = g_sfdf_d[l_ac].sfdf009

         #参考单位
         AFTER FIELD sfdf008
            #160914-00019#1-s
            LET g_sfdf_d[l_ac].sfdf008_desc = ''
            IF NOT cl_null(g_sfdf_d[l_ac].sfdf008) THEN
               IF g_sfdf_d[l_ac].sfdf008 != g_sfdf_d_o.sfdf008 OR cl_null(g_sfdf_d_o.sfdf008) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdf_d[l_ac].sfdf008
                  #160318-00025#22-s
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
                  #160318-00025#22-e
                  IF NOT cl_chk_exist("v_ooca001") THEN
                     LET g_sfdf_d[l_ac].sfdf008 = g_sfdf_d_o.sfdf008
                     LET g_sfdf_d[l_ac].sfdf008_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008)
                     NEXT FIELD CURRENT
                  END IF
                  #單位需與發料料號的基礎單位有轉換率
                  IF NOT s_aimi190_chk_base_convert(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf008) THEN
                     LET g_sfdf_d[l_ac].sfdf008 = g_sfdf_d_o.sfdf008
                     LET g_sfdf_d[l_ac].sfdf008_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008)
                     NEXT FIELD CURRENT
                  END IF
                  #相同项目重复性检查
                  IF NOT asft310_chk_sfdf_unique() THEN
                     LET g_sfdf_d[l_ac].sfdf008 = g_sfdf_d_o.sfdf008
                     LET g_sfdf_d[l_ac].sfdf008_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008)
                     NEXT FIELD CURRENT
                  END IF
                  #预设参考数量=數量*單位轉換率
                  IF NOT cl_null(g_sfdf_d[l_ac].sfdf006) AND NOT cl_null(g_sfdf_d[l_ac].sfdf007) THEN
                     CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf007)
                        RETURNING l_success,g_sfdf_d[l_ac].sfdf009
                     IF NOT l_success THEN
                        LET g_sfdf_d[l_ac].sfdf009 = g_sfdf_d[l_ac].sfdf007
                     END IF
                     #mod 150101 end
                  END IF
               END IF
               LET g_sfdf_d[l_ac].sfdf008_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008)
            ELSE
               LET g_sfdf_d[l_ac].sfdf009 = 0
            END IF
            LET g_sfdf_d_o.sfdf008 = g_sfdf_d[l_ac].sfdf008
            LET g_sfdf_d_o.sfdf009 = g_sfdf_d[l_ac].sfdf009
            #160914-00019#1-e

         #参考数量
         AFTER FIELD sfdf009
            IF NOT cl_null(g_sfdf_d[l_ac].sfdf009) THEN
               IF g_sfdf_d[l_ac].sfdf009 != g_sfdf_d_o.sfdf009 OR cl_null(g_sfdf_d_o.sfdf009) THEN
                  #单位取位
                  IF NOT cl_null(g_sfdf_d[l_ac].sfdf008) THEN
                     CALL s_aooi250_take_decimals(g_sfdf_d[l_ac].sfdf008,g_sfdf_d[l_ac].sfdf009)
                          RETURNING l_success,g_sfdf_d[l_ac].sfdf009
                  END IF
                  #不可小於0
                  IF NOT cl_ap_chk_Range(g_sfdf_d[l_ac].sfdf009,"0.000","1","","","azz-00079",1) THEN
                     LET g_sfdf_d[l_ac].sfdf009 = g_sfdf_d_o.sfdf009
                     NEXT FIELD CURRENT
                  END IF
                  #检查库位、储位、批号的范围，是否在需求指定发料库位、储位、批号允许的数量内
                  IF NOT asft310_chk_ware_range_qty('sfdf009') THEN
                     LET g_sfdf_d[l_ac].sfdf009 = g_sfdf_d_o.sfdf009
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfdf_d_o.sfdf009 = g_sfdf_d[l_ac].sfdf009

         #包装容器
         AFTER FIELD sfdf011
            #輸入值須存在[T:料件包裝資料檔].[C:包裝容器編號]，錯誤訊息「此料沒有這種包裝方式，請重新輸入」
            IF NOT cl_null(g_sfdf_d[l_ac].sfdf011) THEN
               IF g_sfdf_d[l_ac].sfdf011 != g_sfdf_d_o.sfdf011 OR cl_null(g_sfdf_d_o.sfdf011) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdf_d[l_ac].sfdf011
                  IF NOT cl_chk_exist("v_imaa001_3") THEN
                     LET g_sfdf_d[l_ac].sfdf011 = g_sfdf_d_o.sfdf011
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfdf_d_o.sfdf011 = g_sfdf_d[l_ac].sfdf011

         #产品特征
         ON ACTION controlp INFIELD sfdf013
            CALL s_feature_single(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013,g_site,'')
               RETURNING l_success,g_sfdf_d[l_ac].sfdf013
            IF NOT l_success THEN
               LET g_sfdf_d[l_ac].sfdf013 = ' '
            END IF
            DISPLAY g_sfdf_d[l_ac].sfdf013 TO sfdf013
            CALL s_feature_description(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013)
               RETURNING l_success,g_sfdf_d[l_ac].sfdf013_desc
            NEXT FIELD sfdf013

         #仓库            
         ON ACTION controlp INFIELD sfdf003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf003
            LET g_qryparam.default2 = g_sfdf_d[l_ac].sfdf004
            LET g_qryparam.default3 = g_sfdf_d[l_ac].sfdf005
            LET g_qryparam.default4 = g_sfdf_d[l_ac].sfdf010
            #mod 141118 q_inag004_13修改成传参方式
            #LET g_qryparam.where = " inag001 ='",g_sfdf_d[l_ac].sfdf001,"' AND inag002 ='",g_sfdf_d[l_ac].sfdf013,"' "
            LET g_qryparam.arg1 = g_sfdf_d[l_ac].sfdf001
            IF cl_null(g_sfdf_d[l_ac].sfdf013) THEN
               LET g_qryparam.arg2 = ' '
            ELSE
               LET g_qryparam.arg2 = g_sfdf_d[l_ac].sfdf013
            END IF
            #已有指定不可输入
            LET g_qryparam.where = "1=1 "
            #IF g_sfdf003_switch = 'N' THEN
            #   IF cl_null(g_sfdf_d[l_ac].sfdf003) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdf_d[l_ac].sfdf003,"' "
            #   END IF
            #END IF
            IF g_sfdf004_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdf_d[l_ac].sfdf004,"' "
               END IF
            END IF
            IF g_sfdf005_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdf_d[l_ac].sfdf005,"' "
               END IF
            END IF
            IF g_sfdf010_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdf_d[l_ac].sfdf010,"' "
               END IF
            END IF
            #mod 141118 --end
            #关于控制组
            CALL s_control_get_doc_sql("inag004",g_sfda_m.sfdadocno,'6')
                 RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where ," AND ",l_where
            END IF
            #关于控制组--end
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag004_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag004_16()
            END IF
            LET g_sfdf_d[l_ac].sfdf003 = g_qryparam.return1
            LET g_sfdf_d[l_ac].sfdf004 = g_qryparam.return2
            LET g_sfdf_d[l_ac].sfdf005 = g_qryparam.return3
            LET g_sfdf_d[l_ac].sfdf010 = g_qryparam.return4
            DISPLAY g_sfdf_d[l_ac].sfdf003 TO sfdf003
            DISPLAY g_sfdf_d[l_ac].sfdf004 TO sfdf004
            DISPLAY g_sfdf_d[l_ac].sfdf005 TO sfdf005
            DISPLAY g_sfdf_d[l_ac].sfdf010 TO sfdf010
            LET g_sfdf_d[l_ac].sfdf003_desc = s_desc_get_stock_desc(g_site,g_sfdf_d[l_ac].sfdf003)
            LET g_sfdf_d[l_ac].sfdf004_desc = s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004)
            NEXT FIELD sfdf003

         #储位
         ON ACTION controlp INFIELD sfdf004
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf004
            LET g_qryparam.default2 = g_sfdf_d[l_ac].sfdf005
            LET g_qryparam.default3 = g_sfdf_d[l_ac].sfdf010
            LET g_qryparam.where = " inag001 ='",g_sfdf_d[l_ac].sfdf001,"' AND inag002 ='",g_sfdf_d[l_ac].sfdf013,"' AND inag004 ='",g_sfdf_d[l_ac].sfdf003,"' "
            #已有指定不可输入
            IF g_sfdf003_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf003) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdf_d[l_ac].sfdf003,"' "
               END IF
            END IF
            #IF g_sfdf004_switch = 'N' THEN
            #   IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdf_d[l_ac].sfdf004,"' "
            #   END IF
            #END IF
            IF g_sfdf005_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdf_d[l_ac].sfdf005,"' "
               END IF
            END IF
            IF g_sfdf010_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdf_d[l_ac].sfdf010,"' "
               END IF
            END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag005_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag005_14()
            END IF
            LET g_sfdf_d[l_ac].sfdf004 = g_qryparam.return1
            LET g_sfdf_d[l_ac].sfdf005 = g_qryparam.return2
            LET g_sfdf_d[l_ac].sfdf010 = g_qryparam.return3
            DISPLAY g_sfdf_d[l_ac].sfdf004 TO sfdf004
            DISPLAY g_sfdf_d[l_ac].sfdf005 TO sfdf005
            DISPLAY g_sfdf_d[l_ac].sfdf010 TO sfdf010 
            LET g_sfdf_d[l_ac].sfdf004_desc = s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004)
            NEXT FIELD sfdf004

         #批号
         ON ACTION controlp INFIELD sfdf005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf004
            LET g_qryparam.default2 = g_sfdf_d[l_ac].sfdf005
            LET g_qryparam.default3 = g_sfdf_d[l_ac].sfdf010
            LET g_qryparam.where = " inag001 ='",g_sfdf_d[l_ac].sfdf001,"' AND inag002 ='",g_sfdf_d[l_ac].sfdf013,"' AND inag004 ='",g_sfdf_d[l_ac].sfdf003,"' "
            #IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) THEN  #以防储位不可输入时误更新
            #   LET g_qryparam.where = g_qryparam.where CLIPPED," AND inag005 ='",g_sfdf_d[l_ac].sfdf004,"' "
            #END IF
            #已有指定不可输入
            IF g_sfdf003_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf003) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdf_d[l_ac].sfdf003,"' "
               END IF
            END IF
            IF g_sfdf004_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdf_d[l_ac].sfdf004,"' "
               END IF
            END IF
            #IF g_sfdf005_switch = 'N' THEN
            #   IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdf_d[l_ac].sfdf005,"' "
            #   END IF
            #END IF
            IF g_sfdf010_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdf_d[l_ac].sfdf010,"' "
               END IF
            END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag005_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag005_14()
            END IF
            LET g_sfdf_d[l_ac].sfdf004 = g_qryparam.return1
            LET g_sfdf_d[l_ac].sfdf005 = g_qryparam.return2
            LET g_sfdf_d[l_ac].sfdf010 = g_qryparam.return3
            DISPLAY g_sfdf_d[l_ac].sfdf004 TO sfdf004
            DISPLAY g_sfdf_d[l_ac].sfdf005 TO sfdf005
            DISPLAY g_sfdf_d[l_ac].sfdf010 TO sfdf010 
            LET g_sfdf_d[l_ac].sfdf004_desc = s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004)
            NEXT FIELD sfdf005

         #库存管理特征
         ON ACTION controlp INFIELD sfdf010
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf004
            LET g_qryparam.default2 = g_sfdf_d[l_ac].sfdf005
            LET g_qryparam.default3 = g_sfdf_d[l_ac].sfdf010
            LET g_qryparam.where = " inag001 ='",g_sfdf_d[l_ac].sfdf001,"' AND inag002 ='",g_sfdf_d[l_ac].sfdf013,"' AND inag004 ='",g_sfdf_d[l_ac].sfdf003,"' "
            #IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) THEN  #以防储位不可输入时误更新
            #   LET g_qryparam.where = g_qryparam.where CLIPPED," AND inag005 ='",g_sfdf_d[l_ac].sfdf004,"' "
            #END IF
            #已有指定不可输入
            IF g_sfdf003_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf003) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdf_d[l_ac].sfdf003,"' "
               END IF
            END IF
            IF g_sfdf004_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdf_d[l_ac].sfdf004,"' "
               END IF
            END IF
            IF g_sfdf005_switch = 'N' THEN
               IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdf_d[l_ac].sfdf005,"' "
               END IF
            END IF
            #IF g_sfdf010_switch = 'N' THEN
            #   IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdf_d[l_ac].sfdf010,"' "
            #   END IF
            #END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag005_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag005_14()
            END IF
            LET g_sfdf_d[l_ac].sfdf004 = g_qryparam.return1
            LET g_sfdf_d[l_ac].sfdf005 = g_qryparam.return2
            LET g_sfdf_d[l_ac].sfdf010 = g_qryparam.return3
            DISPLAY g_sfdf_d[l_ac].sfdf004 TO sfdf004
            DISPLAY g_sfdf_d[l_ac].sfdf005 TO sfdf005
            DISPLAY g_sfdf_d[l_ac].sfdf010 TO sfdf010
            LET g_sfdf_d[l_ac].sfdf004_desc = s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004)
            NEXT FIELD sfdf010

         #单位
         ON ACTION controlp INFIELD sfdf006
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf006
            CALL q_ooca001_1()
            LET g_sfdf_d[l_ac].sfdf006 = g_qryparam.return1
            DISPLAY g_sfdf_d[l_ac].sfdf006 TO sfdf006
            LET g_sfdf_d[l_ac].sfdf006_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006)  #160914-00019#1
            NEXT FIELD sfdf006  #160914-00019#1

         #参考单位
         ON ACTION controlp INFIELD sfdf008
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf008
            CALL q_ooca001_1()
            LET g_sfdf_d[l_ac].sfdf008 = g_qryparam.return1
            DISPLAY g_sfdf_d[l_ac].sfdf008 TO sfdf008
            LET g_sfdf_d[l_ac].sfdf008_desc = s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008)  #160914-00019#1
            NEXT FIELD sfdf008  #160914-00019#1

         #包装容器
         ON ACTION controlp INFIELD sfdf011
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdf_d[l_ac].sfdf011
            CALL q_imaa001_11()
            LET g_sfdf_d[l_ac].sfdf011 = g_qryparam.return1     #將開窗取得的值>
            DISPLAY g_sfdf_d[l_ac].sfdf011 TO sfdf011
            NEXT FIELD sfdf011

         AFTER ROW
            CALL asft310_b_fill() #單身填充
            CALL asft310_b_fill2('0') #單身填充
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_sfdf_d[l_ac].* = g_sfdf_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE asft310_bcl5
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF

            #其他table進行unlock

            CALL asft310_unlock_b("sfdf_t","'5'")
            CALL s_transaction_end('Y','0')

         AFTER INPUT

         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_sfdf_d[li_reproduce_target].* = g_sfdf_d[li_reproduce].*
               LET g_sfdf_d[li_reproduce_target].sfdfseq1 = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_sfdf_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_sfdf_d.getLength()+1
            END IF

      END INPUT

      INPUT ARRAY g_sfdd_d FROM s_detail6.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效! 
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)

         #自訂ACTION(detail_input,page_6)
         
         #製造批序號維護
         ON ACTION serialnum
            #LET g_action_choice="serialnum"
            IF cl_auth_chk_act("serialnum") THEN
            END IF

         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_sfdd_d.getLength()+1) 
              LET g_insert = 'N' 
            END IF 
 
            CALL asft310_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue(""))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_sfdd_d.getLength()
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_sfdd_d[l_ac].* TO NULL 
            INITIALIZE g_sfdd_d_t.* TO NULL 
            INITIALIZE g_sfdd_d_o.* TO NULL 
            #公用欄位給值(單身6)
            #项序
            SELECT MAX(sfddseq1)+1 INTO g_sfdd_d[l_ac].sfddseq1
              FROM sfdd_t
             WHERE sfddent  = g_enterprise
               AND sfddsite = g_site
               AND sfdddocno= g_sfda_m.sfdadocno
               AND sfddseq  = g_sfdc4_d[g_detail_idx].sfdcseq
            IF cl_null(g_sfdd_d[l_ac].sfddseq1) THEN LET g_sfdd_d[l_ac].sfddseq1 = 1 END IF
            #发料料号：预设带出需求料号
            LET g_sfdd_d[l_ac].sfdd001 = g_sfdc4_d[g_detail_idx].sfdc004
            CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001)
                 RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
            #产品特征：预设带出需求料号特征
            LET g_sfdd_d[l_ac].sfdd013 = g_sfdc4_d[g_detail_idx].sfdc005
            CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                 RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
            #替代率
            LET g_sfdd_d[l_ac].sfdd002 = 1
            #库位
            LET g_sfdd_d[l_ac].sfdd003 = g_sfdc4_d[g_detail_idx].sfdc012
            LET g_sfdd_d[l_ac].sfdd003_desc = s_desc_get_stock_desc(g_site,g_sfdd_d[l_ac].sfdd003)
            #储位
            LET g_sfdd_d[l_ac].sfdd004 = g_sfdc4_d[g_detail_idx].sfdc013
            LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
            #批号
            LET g_sfdd_d[l_ac].sfdd005 = g_sfdc4_d[g_detail_idx].sfdc014
            #库存管理特征
            LET g_sfdd_d[l_ac].sfdd010 = g_sfdc4_d[g_detail_idx].sfdc016
            #单位
            LET g_sfdd_d[l_ac].sfdd006 = g_sfdc4_d[g_detail_idx].sfdc006
            LET g_sfdd_d[l_ac].sfdd006_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006)
            #参考单位
            LET g_sfdd_d[l_ac].sfdd008 = g_sfdc4_d[g_detail_idx].sfdc009
            LET g_sfdd_d[l_ac].sfdd008_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008)
            #发料-1
            IF g_prog[1,6]='asft31' THEN LET g_sfdd_d[l_ac].sfdd012 = -1 END IF
            #退料1
            IF g_prog[1,6]='asft32' THEN LET g_sfdd_d[l_ac].sfdd012 =  1 END IF
            LET g_sfdd_d_t.* = g_sfdd_d[l_ac].*     #新輸入資料
            LET g_sfdd_d_o.* = g_sfdd_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL asft310_set_entry_b_sfdd(l_cmd)
            #160126-00022#1-s
            CALL asft310_set_no_required_sfdd(l_cmd)
            CALL asft310_set_required_sfdd(l_cmd)
            #160126-00022#1-e
            CALL asft310_set_no_entry_b_sfdd(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_sfdd_d[li_reproduce_target].* = g_sfdd_d[li_reproduce].*
               LET g_sfdd_d[li_reproduce_target].sfddseq1 = NULL
            END IF

         BEFORE ROW
            IF cl_null(g_detail_idx) OR g_detail_idx=0 THEN
               #请先选择需求申请资料
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  'asf-00666'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN
            END IF
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[6] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx2 = l_ac
            LET g_current_page = 6

            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx

            CALL s_transaction_begin()
            OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN asft310_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE asft310_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            OPEN asft310_bcl2 USING g_enterprise, g_site,g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  SQLCA.sqlcode
               LET g_errparam.extend = "OPEN asft310_bcl2:"
               LET g_errparam.popup = TRUE
               CLOSE asft310_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF

            LET g_rec_b = g_sfdd_d.getLength()

            IF g_rec_b >= l_ac AND g_sfdd_d[l_ac].sfddseq1 IS NOT NULL THEN
               LET l_cmd='u'
               LET g_sfdd_d_t.* = g_sfdd_d[l_ac].*  #BACKUP
               LET g_sfdd_d_o.* = g_sfdd_d[l_ac].*  #BACKUP
               INITIALIZE l_sfdd_t.* TO NULL
               #SELECT * INTO l_sfdd_t.* FROM sfdd_t #161109-00085#62 mark
               #161109-00085#62 --s add
               SELECT sfddent,sfddsite,sfdddocno,sfddseq,sfddseq1,
                      sfdd001,sfdd002,sfdd003,sfdd004,sfdd005,
                      sfdd006,sfdd007,sfdd008,sfdd009,sfdd010,
                      sfdd011,sfdd012,sfdd013,sfddud001,sfddud002,
                      sfddud003,sfddud004,sfddud005,sfddud006,sfddud007,
                      sfddud008,sfddud009,sfddud010,sfddud011,sfddud012,
                      sfddud013,sfddud014,sfddud015,sfddud016,sfddud017,
                      sfddud018,sfddud019,sfddud020,sfddud021,sfddud022,
                      sfddud023,sfddud024,sfddud025,sfddud026,sfddud027,
                      sfddud028,sfddud029,sfddud030,sfdd014,sfdd015
                 INTO l_sfdd_t.sfddent,l_sfdd_t.sfddsite,l_sfdd_t.sfdddocno,l_sfdd_t.sfddseq,l_sfdd_t.sfddseq1,
                      l_sfdd_t.sfdd001,l_sfdd_t.sfdd002,l_sfdd_t.sfdd003,l_sfdd_t.sfdd004,l_sfdd_t.sfdd005,
                      l_sfdd_t.sfdd006,l_sfdd_t.sfdd007,l_sfdd_t.sfdd008,l_sfdd_t.sfdd009,l_sfdd_t.sfdd010,
                      l_sfdd_t.sfdd011,l_sfdd_t.sfdd012,l_sfdd_t.sfdd013,l_sfdd_t.sfddud001,l_sfdd_t.sfddud002,
                      l_sfdd_t.sfddud003,l_sfdd_t.sfddud004,l_sfdd_t.sfddud005,l_sfdd_t.sfddud006,l_sfdd_t.sfddud007,
                      l_sfdd_t.sfddud008,l_sfdd_t.sfddud009,l_sfdd_t.sfddud010,l_sfdd_t.sfddud011,l_sfdd_t.sfddud012,
                      l_sfdd_t.sfddud013,l_sfdd_t.sfddud014,l_sfdd_t.sfddud015,l_sfdd_t.sfddud016,l_sfdd_t.sfddud017,
                      l_sfdd_t.sfddud018,l_sfdd_t.sfddud019,l_sfdd_t.sfddud020,l_sfdd_t.sfddud021,l_sfdd_t.sfddud022,
                      l_sfdd_t.sfddud023,l_sfdd_t.sfddud024,l_sfdd_t.sfddud025,l_sfdd_t.sfddud026,l_sfdd_t.sfddud027,
                      l_sfdd_t.sfddud028,l_sfdd_t.sfddud029,l_sfdd_t.sfddud030,l_sfdd_t.sfdd014,l_sfdd_t.sfdd015
                 FROM sfdd_t
               #161109-00085#62 --e add
                WHERE sfddent   = g_enterprise
                  AND sfdddocno = g_sfda_m.sfdadocno
                  AND sfddseq   = g_sfdc4_d[g_detail_idx].sfdcseq
                  AND sfddseq1  = g_sfdd_d_t.sfddseq1
               CALL asft310_set_entry_b_sfdd(l_cmd)
               #160126-00022#1-s
               CALL asft310_set_no_required_sfdd(l_cmd)
               CALL asft310_set_required_sfdd(l_cmd)
               #160126-00022#1-e
               CALL asft310_set_no_entry_b_sfdd(l_cmd)
               IF NOT asft310_lock_b("sfdd_t","'6'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft310_bcl6 INTO g_sfdd_d[l_ac].sfddseq1,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd001_desc,
                      g_sfdd_d[l_ac].sfdd001_desc2,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd013_desc,g_sfdd_d[l_ac].sfdd002,g_sfdd_d[l_ac].sfdd003,
                      g_sfdd_d[l_ac].sfdd003_desc,g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd004_desc,
                      g_sfdd_d[l_ac].sfdd005,g_sfdd_d[l_ac].sfdd010,g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd006_desc,
                      g_sfdd_d[l_ac].sfdd007,g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd008_desc,g_sfdd_d[l_ac].sfdd009,
                      g_sfdd_d[l_ac].sfdd011,g_sfdd_d[l_ac].sfdd012
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #mod 150121
                  #LET g_bfill = "N"
                  #CALL asft310_show()
                  #LET g_bfill = "Y"
                  CALL asft310_b_show('sfdd',l_ac)
                  #mod 150121 end
                  
                  CALL cl_show_fld_cont()
               END IF
               IF g_sfda_m.sfdastus = 'Y' THEN     #170120-00052#1 add
                  CALL s_asft310_do_inap_inan(g_sfda_m.sfdadocno,'-1') RETURNING l_success  #161006-00018#10
               END IF                              #170120-00052#1 add   
            ELSE
               LET l_cmd='a'
            END IF
            #其他table資料備份(確定是否更改用)

            #获取工单单头资讯
            LET l_sfaa010 = ''
            LET l_sfaa011 = ''
            LET l_sfba001 = ''  #抓取發料料號的上階料號
            SELECT sfaa010,sfaa011,sfba001 INTO l_sfaa010,l_sfaa011,l_sfba001
              FROM sfaa_t,sfba_t
             WHERE sfaaent = g_enterprise
               AND sfaasite = g_site
               AND sfaadocno = g_sfdc4_d[g_detail_idx].sfdc001  #工单
               AND sfbaent = sfaaent
               AND sfbadocno = sfaadocno
               AND sfbaseq = g_sfdc4_d[g_detail_idx].sfdc002
               AND sfbaseq1 = g_sfdc4_d[g_detail_idx].sfdc003
               
            #其他table進行lock

         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
            ELSE
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_sfda_m.sfdadocno
               LET gs_keys[02] = g_sfdc4_d[g_detail_idx].sfdcseq
               LET gs_keys[03] = g_sfdd_d_t.sfddseq1
            
               DELETE FROM sfdd_t
                WHERE sfddent = g_enterprise AND sfddsite = g_site
                  AND sfdddocno = g_sfda_m.sfdadocno
                  AND sfddseq = g_sfdc4_d[g_detail_idx].sfdcseq
                  AND sfddseq1 = g_sfdd_d_t.sfddseq1
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "DELETE FROM sfdd_t",SQLERRMESSAGE
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CALL s_transaction_end('N','0')  #需要有事务，如果没有事务，直接cancel delete ，回到单身状态就不在事务中了
                  LET l_flag = 'd'  #取消cancel的做法，本次事务回滚，重新走INPUT进入，回到当前笔状态
                  CLOSE asft310_bcl6 #重新进入单身需要先关闭游标
                  CONTINUE WHILE
                  #CANCEL DELETE
               END IF
               
               LET l_success_tot = TRUE
               
               #add 150831 --begin
               #删除inao
               IF NOT asft310_del_inao() THEN
                  LET l_success_tot = FALSE
               END IF
               #add 150831 --end
               #处理sfdf,sfde
               IF NOT s_asft310_chg_sfdf_f_sfdd_del('N',l_sfdd_t.*) THEN
                  LET l_success_tot = FALSE
               END IF
               #更新sfdc
               IF NOT s_asft310_chg_sfdc_f_sfdd_del('N',l_sfdd_t.*) THEN
                  LET l_success_tot = FALSE
               END IF
               #add 141222
               DELETE FROM ooff_t
                WHERE ooffent = g_enterprise
                  AND ooff001 = '7'
                  AND ooff002 = g_sfda_m.sfdadocno
                  AND ooff003 = g_sfdc4_d[g_detail_idx].sfdcseq
                  AND ooff004 = g_sfdd_d_t.sfddseq1
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "DELETE FROM ooff_t",SQLERRMESSAGE
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET l_success_tot = FALSE
               END IF
               #add 141222 end
               #add 150831 begin
               #删除sfdd中没有，而inao中有的资料
               DELETE FROM inao_t
                WHERE inaoent  = g_enterprise
                  AND inaosite = g_site
                  AND inaodocno= g_sfda_m.sfdadocno
                  AND inao000  = '2'  #实际
                  AND NOT EXISTS (SELECT 1 FROM sfdd_t
                                   WHERE sfddent=inaoent AND sfdddocno=inaodocno
                                     AND sfddseq=inaoseq AND sfddseq1=inaoseq1)
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "DELETE FROM inao_t",SQLERRMESSAGE
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET l_success_tot = FALSE
               END IF
               #add 150831 end
               #170120-00052#1 add --(S)--
               IF g_sfda_m.sfdastus = 'Y' THEN     
                  IF NOT s_asft310_do_inap_inan(g_sfda_m.sfdadocno,'1') THEN
                     LET l_success_tot = FALSE
                  END IF
               END IF   
               #170120-00052#1 add --(E)--  
               IF NOT l_success_tot THEN
                  CALL s_transaction_end('N','0')  #需要有事务，如果没有事务，直接cancel delete ，回到单身状态就不在事务中了
                  LET l_flag = 'd'  #取消cancel的做法，本次事务回滚，重新走INPUT进入，回到当前笔状态
                  CLOSE asft310_bcl6 #重新进入单身需要先关闭游标
                  CONTINUE WHILE
                  #CANCEL DELETE
               END IF
               
               CALL s_transaction_end('Y','0')
               CLOSE asft310_bcl6
               LET g_rec_b = g_rec_b-1
               LET l_count = g_sfdb_d.getLength()
            END IF

         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_sfdb_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            LET l_count = 1
            SELECT COUNT(1) INTO l_count FROM sfdd_t
             WHERE sfddent = g_enterprise AND sfddsite = g_site AND sfdddocno = g_sfda_m.sfdadocno
               AND sfddseq = g_sfdc4_d[g_detail_idx].sfdcseq AND sfddseq1 = g_sfdd_d[g_detail_idx2].sfddseq1
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfda_m.sfdadocno
               LET gs_keys[2] = g_sfdc4_d[g_detail_idx].sfdcseq
               LET gs_keys[3] = g_sfdd_d[g_detail_idx2].sfddseq1
               CALL asft310_insert_b('sfdd_t',gs_keys,"'6'")
            ELSE
               INITIALIZE g_sfdb_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.code = "std-00006"
               LET g_errparam.popup = TRUE
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF

            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = "sfdd_t",SQLERRMESSAGE
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.popup = TRUE
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            ELSE
               LET l_success_tot = TRUE
               #更新sfdc
               IF NOT s_asft310_chg_sfdc_f_sfdd_ins(g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[g_detail_idx2].sfddseq1) THEN
                  LET l_success_tot = FALSE
               END IF
               #处理sfdf,sfde：sfdd与sfdf总数应该平的
               IF NOT s_asft310_chg_sfdf_f_sfdd_ins(g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[g_detail_idx2].sfddseq1) THEN
                  LET l_success_tot = FALSE
               END IF
               #add 141222 
               #处理备注 
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd_ooff013) THEN
                  IF NOT s_aooi360_gen('7',g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[g_detail_idx2].sfddseq1,' ',' ',' ',' ',' ',' ',' ','4',g_sfdd_d[l_ac].sfdd_ooff013)  THEN
                     LET l_success_tot = FALSE
                  END IF
               END IF
               #add 141222 end
               #170120-00052#1 add --(S)--
               IF g_sfda_m.sfdastus = 'Y' THEN     
                  IF NOT s_asft310_do_inap_inan(g_sfda_m.sfdadocno,'1') THEN
                     LET l_success_tot = FALSE
                  END IF
               END IF   
               #170120-00052#1 add --(E)--  
               IF NOT l_success_tot THEN
                  CALL s_transaction_end('N','0')
                  CANCEL INSERT
               END IF
               #add--end
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code = 9001
               LET g_errparam.popup = FALSE
               CLOSE asft310_bcl6
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = ''
               LET g_errparam.code = -263
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
            ELSE
               #寫入修改者/修改日期資訊(單身6)
               IF cl_null(g_sfdd_d[l_ac].sfdd013) THEN LET g_sfdd_d[l_ac].sfdd013 = ' ' END IF
               IF cl_null(g_sfdd_d[l_ac].sfdd003) THEN LET g_sfdd_d[l_ac].sfdd003 = ' ' END IF
               IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN LET g_sfdd_d[l_ac].sfdd004 = ' ' END IF
               IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN LET g_sfdd_d[l_ac].sfdd005 = ' ' END IF
               IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN LET g_sfdd_d[l_ac].sfdd010 = ' ' END IF
               IF cl_null(g_sfdd_d[l_ac].sfdd009) THEN LET g_sfdd_d[l_ac].sfdd009 = 0 END IF #参考单位数量
               #add 150115 单位取位
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd006) AND NOT cl_null(g_sfdd_d[l_ac].sfdd007) THEN
                  CALL s_aooi250_take_decimals(g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007)
                       RETURNING l_success,g_sfdd_d[l_ac].sfdd007
               END IF
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd008) AND NOT cl_null(g_sfdd_d[l_ac].sfdd009) THEN
                  CALL s_aooi250_take_decimals(g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd009)
                       RETURNING l_success,g_sfdd_d[l_ac].sfdd009
               END IF
               #add 150115 end
               ##160408-00035#7 下面UPDATE增加sfdd014,sfdd015
               UPDATE sfdd_t SET (sfdddocno,sfddseq,sfddseq1,sfdd001,sfdd013,sfdd002,sfdd003,sfdd004,sfdd005,
                   sfdd010,sfdd006,sfdd007,sfdd008,sfdd009,sfdd011,sfdd012,sfdd014,sfdd015) = (g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,
                   g_sfdd_d[l_ac].sfddseq1,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd002,g_sfdd_d[l_ac].sfdd003,
                   g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd005,g_sfdd_d[l_ac].sfdd010,g_sfdd_d[l_ac].sfdd006,
                   g_sfdd_d[l_ac].sfdd007,g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd009,g_sfdd_d[l_ac].sfdd011,
                   g_sfdd_d[l_ac].sfdd012,g_sfdd_d[l_ac].sfdd014,g_sfdd_d[l_ac].sfdd015) #自訂欄位頁簽
                WHERE sfddent = g_enterprise AND sfddsite = g_site AND sfdddocno = g_sfda_m.sfdadocno
                  AND sfddseq = g_sfdc4_d[g_detail_idx].sfdcseq    AND sfddseq1 = g_sfdd_d_t.sfddseq1
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "sfdd_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "sfdd_t:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                  OTHERWISE
                     ##資料多語言用-增/改
                     #INITIALIZE gs_keys TO NULL 
                     #LET gs_keys[1] = g_sfda_m.sfdadocno
                     #LET gs_keys_bak[1] = g_sfdadocno_t
                     #LET gs_keys[2] = g_sfdc4_d[g_detail_idx].sfdcseq
                     #LET gs_keys_bak[2] = g_sfdc4_d[g_detail_idx].sfdcseq
                     #LET gs_keys[3] = g_sfdd_d[g_detail_idx2].sfddseq1
                     #LET gs_keys_bak[3] = g_sfdd_d_t.sfddseq1
                     #CALL asft310_update_b('sfdd_t',gs_keys,gs_keys_bak,"'6'")
               END CASE
               
               #160914-00019#1-s
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_sfdd_d),util.JSON.stringify(g_sfdd_d_t)
               LET g_log2 = util.JSON.stringify(g_sfdd_d),util.JSON.stringify(g_sfdd_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               #160914-00019#1-e
               
               #发料料件变化时,需删除原批序号资料(工单资料变化会对应发料料件的变化)
               IF (NOT cl_null(g_sfdd_d_t.sfdd001) AND g_sfdd_d[l_ac].sfdd001 != g_sfdd_d_t.sfdd001) OR
                  g_sfdd_d[l_ac].sfdd007 = 0 THEN
                  DELETE FROM inao_t
                   WHERE inaoent = g_enterprise AND inaosite = g_site
                     AND inaodocno = g_sfda_m.sfdadocno
                     AND inaoseq = g_sfdc4_d[g_detail_idx].sfdcseq #項次
                     AND (inaoseq1 = g_sfdd_d_t.sfddseq1 OR inaoseq1 = g_sfdd_d_o.sfddseq1) #项序
                     AND inao000  = '2'  #实际的
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = 'DELETE FROM inao_t',SQLERRMESSAGE
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               #add 150831 --end
               #160526-00011#1-s
               IF g_sfdd_d[l_ac].sfdd003 <> g_sfdd_d_t.sfdd003 OR
                  g_sfdd_d[l_ac].sfdd004 <> g_sfdd_d_t.sfdd004 OR
                  g_sfdd_d[l_ac].sfdd005 <> g_sfdd_d_t.sfdd005 OR
                  g_sfdd_d[l_ac].sfdd010 <> g_sfdd_d_t.sfdd010 THEN
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt
                    FROM inao_t
                   WHERE inaoent = g_enterprise
                     AND inaosite = g_site
                     AND inaodocno = g_sfda_m.sfdadocno
                     AND inaoseq = g_sfdc_d[l_ac].sfdcseq
                     AND inaoseq1 = g_sfdd_d[l_ac].sfddseq1
                     AND inao013 = '-1'
                  IF l_cnt > 0 THEN
                     IF cl_ask_confirm('ain-00675') THEN
                        DELETE FROM inao_t
                         WHERE inaoent = g_enterprise
                           AND inaosite = g_site
                           AND inaodocno = g_sfda_m.sfdadocno
                           AND inaoseq = g_sfdc_d[l_ac].sfdcseq
                           AND inaoseq1 = g_sfdd_d[l_ac].sfddseq1
                           AND inao013 = '-1'
                     ELSE
                        LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
                        CALL s_transaction_end('N','0')
                     END IF
                  END IF
               END IF
               #160526-00011#1-e
               #关联表处理
               IF g_intrans = 'Y' THEN  #若事务还没走rollback则(上面没有走commit)
                  LET l_success_tot = TRUE
                  INITIALIZE l_sfdd.* TO NULL
                  #SELECT * INTO l_sfdd.* FROM sfdd_t #161109-00085#62 mark
                  #161109-00085#62 --s add
                  SELECT sfddent,sfddsite,sfdddocno,sfddseq,sfddseq1,
                         sfdd001,sfdd002,sfdd003,sfdd004,sfdd005,
                         sfdd006,sfdd007,sfdd008,sfdd009,sfdd010,
                         sfdd011,sfdd012,sfdd013,sfddud001,sfddud002,
                         sfddud003,sfddud004,sfddud005,sfddud006,sfddud007,
                         sfddud008,sfddud009,sfddud010,sfddud011,sfddud012,
                         sfddud013,sfddud014,sfddud015,sfddud016,sfddud017,
                         sfddud018,sfddud019,sfddud020,sfddud021,sfddud022,
                         sfddud023,sfddud024,sfddud025,sfddud026,sfddud027,
                         sfddud028,sfddud029,sfddud030,sfdd014,sfdd015
                    INTO l_sfdd.sfddent,l_sfdd.sfddsite,l_sfdd.sfdddocno,l_sfdd.sfddseq,l_sfdd.sfddseq1,
                         l_sfdd.sfdd001,l_sfdd.sfdd002,l_sfdd.sfdd003,l_sfdd.sfdd004,l_sfdd.sfdd005,
                         l_sfdd.sfdd006,l_sfdd.sfdd007,l_sfdd.sfdd008,l_sfdd.sfdd009,l_sfdd.sfdd010,
                         l_sfdd.sfdd011,l_sfdd.sfdd012,l_sfdd.sfdd013,l_sfdd.sfddud001,l_sfdd.sfddud002,
                         l_sfdd.sfddud003,l_sfdd.sfddud004,l_sfdd.sfddud005,l_sfdd.sfddud006,l_sfdd.sfddud007,
                         l_sfdd.sfddud008,l_sfdd.sfddud009,l_sfdd.sfddud010,l_sfdd.sfddud011,l_sfdd.sfddud012,
                         l_sfdd.sfddud013,l_sfdd.sfddud014,l_sfdd.sfddud015,l_sfdd.sfddud016,l_sfdd.sfddud017,
                         l_sfdd.sfddud018,l_sfdd.sfddud019,l_sfdd.sfddud020,l_sfdd.sfddud021,l_sfdd.sfddud022,
                         l_sfdd.sfddud023,l_sfdd.sfddud024,l_sfdd.sfddud025,l_sfdd.sfddud026,l_sfdd.sfddud027,
                         l_sfdd.sfddud028,l_sfdd.sfddud029,l_sfdd.sfddud030,l_sfdd.sfdd014,l_sfdd.sfdd015
                    FROM sfdd_t
                  #161109-00085#62 --e add
                   WHERE sfddent   = g_enterprise
                     AND sfdddocno = g_sfda_m.sfdadocno
                     AND sfddseq   = g_sfdc4_d[g_detail_idx].sfdcseq
                     AND sfddseq1  = g_sfdd_d[g_detail_idx2].sfddseq1
                  #处理sfdc
                  IF NOT s_asft310_chg_sfdc_f_sfdd_upd(l_sfdd_t.*,l_sfdd.*) THEN
                     LET l_success_tot = FALSE
                  END IF
                  #处理sfdf,sfde
                  IF NOT s_asft310_chg_sfdf_f_sfdd_upd(l_sfdd_t.*,l_sfdd.*) THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 141222
                  #ooff资料
                  IF cl_null(g_sfdd_d[l_ac].sfdd_ooff013) THEN
                     CALL s_aooi360_del('7',g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d_t.sfddseq1,' ',' ',' ',' ',' ',' ',' ','4')
                          RETURNING l_success
                  ELSE
                     CALL s_aooi360_gen('7',g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d_t.sfddseq1,' ',' ',' ',' ',' ',' ',' ','4',g_sfdd_d[l_ac].sfdd_ooff013)
                          RETURNING l_success
                  END IF
                  IF NOT l_success THEN
                     LET l_success_tot = FALSE
                  END IF
                  #若key值变化
                  IF NOT asft310_update_ooff_key("d") THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 141222 end
                  #add 150831 --begin
                  #处理inao
                  IF NOT asft310_update_inao_key("d") THEN
                     LET l_success_tot = FALSE
                  END IF
                  #add 150831 --end
                  #161006-00018#10-s
                  IF g_sfda_m.sfdastus = 'Y' THEN     #170120-00052#1 add
                     IF NOT s_asft310_do_inap_inan(g_sfda_m.sfdadocno,'1') THEN
                        LET l_success_tot = FALSE
                     END IF
                  END IF                              #170120-00052#1 add   
                  #161006-00018#10-e
                  IF NOT l_success_tot THEN
                     LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
            END IF

         #项序
         AFTER FIELD sfddseq1
            IF cl_null(g_sfdd_d[l_ac].sfddseq1) THEN
               LET g_sfdd_d[l_ac].sfddseq1 = g_sfdd_d_t.sfddseq1
            ELSE
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfdd_d[l_ac].sfddseq1 != g_sfdd_d_t.sfddseq1)) THEN
                  #重复性检查
                  #IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfdd_t WHERE "||"sfddent = '" ||g_enterprise|| "' AND sfddsite = '" ||g_site|| "' AND "||"sfdddocno = '"||g_sfda_m.sfdadocno ||"' AND "|| "sfddseq = '"||g_sfdc4_d[g_detail_idx].sfdcseq ||"' AND "|| "sfddseq1 = '"||g_sfdd_d[l_ac].sfddseq1 ||"'",'std-00004',0) THEN
                  #   NEXT FIELD CURRENT
                  #END IF
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt FROM sfdd_t
                   WHERE sfddent  = g_enterprise AND sfddsite = g_site
                     AND sfdddocno= g_sfda_m.sfdadocno
                     AND sfddseq  = g_sfdc4_d[g_detail_idx].sfdcseq
                     AND sfddseq1 = g_sfdd_d[l_ac].sfddseq1
                  CASE
                      WHEN SQLCA.sqlcode
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = ""
                           LET g_errparam.popup = TRUE
                           LET g_errparam. sqlerr = SQLCA.SQLERRD[2]
                           CALL cl_err()
                           NEXT FIELD CURRENT
                      WHEN l_cnt > 0
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'std-00004'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           NEXT FIELD CURRENT
                  END CASE
               END IF
               IF g_sfdd_d[l_ac].sfddseq1 < 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'amm-00002'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               #CALL asft310_show_sfdd_ooff013(l_ac) #add 141222 备注说明
            END IF
            LET g_sfdd_d_o.sfddseq1 = g_sfdd_d[l_ac].sfddseq1
         
         #料件编号
         AFTER FIELD sfdd001
            #160914-00019#1-s
            LET g_sfdd_d[l_ac].sfdd001_desc = ''
            LET g_sfdd_d[l_ac].sfdd001_desc2 = ''
            IF NOT cl_null(g_sfdd_d[l_ac].sfdd001) THEN
               IF g_sfdd_d[l_ac].sfdd001 != g_sfdd_d_o.sfdd001 OR cl_null(g_sfdd_d_o.sfdd001) THEN
                  #取替代检查
                  IF g_sfdd_d[l_ac].sfdd001 != g_sfdc4_d[g_detail_idx].sfdc004 OR
                     g_sfdd_d[l_ac].sfdd013 != g_sfdc4_d[g_detail_idx].sfdc005 THEN
                     IF NOT asft310_chk_replace('sfdd001',l_sfaa010,l_sfaa011,l_sfba001) THEN
                        LET g_sfdd_d[l_ac].sfdd001 = g_sfdd_d_o.sfdd001
                        CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001)
                             RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #檢核輸入的料件的生命週期是否在單據別限制範圍內，若不在限制內則不允許雜收此料
                  CALL s_control_chk_doc('4',g_sfda_m.sfdadocno,g_sfdd_d[l_ac].sfdd001,'','','','')
                     RETURNING l_success,l_flag2
                  IF NOT l_success OR NOT l_flag2 THEN
                     LET g_sfdd_d[l_ac].sfdd001 = g_sfdd_d_o.sfdd001
                     CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001)
                          RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
                     NEXT FIELD CURRENT
                  END IF
                  #檢核輸入的料件的產品分類是否在單據別限制範圍內，若不在限制內則不允許雜收此料
                  CALL s_control_chk_doc('5',g_sfda_m.sfdadocno,g_sfdd_d[l_ac].sfdd001,'','','','')
                     RETURNING l_success,l_flag2
                  IF NOT l_success OR NOT l_flag2 THEN
                     LET g_sfdd_d[l_ac].sfdd001 = g_sfdd_d_o.sfdd001
                     CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001)
                          RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
                     NEXT FIELD CURRENT
                  END IF
                  #计算替代率
                  LET g_sfdd_d[l_ac].sfdd002 = s_asft310_get_sfdd002(l_sfaa010,l_sfaa011,    #主料，特性
                      g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,  #部位，作业
                      g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfdc006,  #需求料号，需求料件单位
                      g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd006)    #替代料号,替代发料单位
                  #检查产品特征
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd013) THEN
                     IF NOT s_feature_check(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013) THEN
                        NEXT FIELD sfdd013
                     END IF
                  END IF
               END IF
               CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001)
                    RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
            #160914-00019#1-e
            END IF
            #160126-00022#1-s
            CALL asft310_set_no_required_sfdd(l_cmd)
            CALL asft310_set_required_sfdd(l_cmd)
            #160126-00022#1-e
            CALL asft310_set_entry_b_sfdd(l_cmd)
            CALL asft310_set_no_entry_b_sfdd(l_cmd)
            LET g_sfdd_d_o.sfdd001 = g_sfdd_d[l_ac].sfdd001
            LET g_sfdd_d_o.sfdd002 = g_sfdd_d[l_ac].sfdd002
         
         #产品特征
         BEFORE FIELD sfdd013
            #160314-00009#15-s
            IF s_feature_auto_chk(g_sfdd_d[l_ac].sfdd001) AND cl_null(g_sfdd_d[l_ac].sfdd013) THEN
                CALL s_feature_single(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_site,'')
                   RETURNING l_success,g_sfdd_d[l_ac].sfdd013
                IF NOT l_success THEN
                   LET g_sfdd_d[l_ac].sfdd013 = ' '
                END IF
                CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                   RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
            END IF
            #160314-00009#15-e
         
         AFTER FIELD sfdd013
            LET g_sfdd_d[l_ac].sfdd013_desc = ''
            IF NOT cl_null(g_sfdd_d[l_ac].sfdd013) THEN
               IF g_sfdd_d[l_ac].sfdd013 != g_sfdd_d_o.sfdd013 OR cl_null(g_sfdd_d_o.sfdd013) THEN
                  #151224-00025#4-s
                  IF NOT s_feature_direct_input(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d_t.sfdd013,g_sfda_m.sfdadocno,g_site) THEN
                     NEXT FIELD CURRENT
                  END IF
                  #151224-00025#4-e
                  IF NOT s_feature_check(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013) THEN
                     LET g_sfdd_d[l_ac].sfdd013 = g_sfdd_d_o.sfdd013
                     CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                        RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
                     NEXT FIELD CURRENT
                  END IF
                  #取替代检查
                  IF g_sfdd_d[l_ac].sfdd013 != g_sfdc4_d[g_detail_idx].sfdc005 OR
                     g_sfdd_d[l_ac].sfdd001 != g_sfdc4_d[g_detail_idx].sfdc004 THEN
                     IF NOT asft310_chk_replace('sfdd013',l_sfaa010,l_sfaa011,l_sfba001) THEN
                        LET g_sfdd_d[l_ac].sfdd013 = g_sfdd_d_o.sfdd013
                        CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                           RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #计算替代率
                  LET g_sfdd_d[l_ac].sfdd002 = s_asft310_get_sfdd002(l_sfaa010,l_sfaa011,    #主料，特性
                      g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,  #部位，作业，作业序
                      g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfdc006,  #需求料号，需求料件单位
                      g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd006)    #替代料号,替代发料单位
               END IF
               CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                  RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
            END IF
            #160126-00022#1-s
            CALL asft310_set_no_required_sfdd(l_cmd)
            CALL asft310_set_required_sfdd(l_cmd)
            #160126-00022#1-e
            CALL asft310_set_entry_b_sfdd(l_cmd)
            CALL asft310_set_no_entry_b_sfdd(l_cmd)
            LET g_sfdd_d_o.sfdd002 = g_sfdd_d[l_ac].sfdd002
            LET g_sfdd_d_o.sfdd013 = g_sfdd_d[l_ac].sfdd013
         
         #库位
         AFTER FIELD sfdd003
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            #IF cl_null(g_sfdc4_d[g_detail_idx].sfdc012) THEN  #170116-00033#1
            #160914-00019#1-s
               LET g_sfdd_d[l_ac].sfdd003_desc = ''
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd003) THEN
                  IF g_sfdd_d[l_ac].sfdd003 != g_sfdd_d_o.sfdd003 OR cl_null(g_sfdd_d_o.sfdd003) THEN
                     IF NOT asft310_sfdd_loca_chk() THEN
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  LET g_sfdd_d[l_ac].sfdd003_desc = s_desc_get_stock_desc(g_site,g_sfdd_d[l_ac].sfdd003)
               END IF
            #END IF  #170116-00033#1
            LET g_sfdd_d_o.sfdd003 = g_sfdd_d[l_ac].sfdd003
            LET g_sfdd_d_o.sfdd004 = g_sfdd_d[l_ac].sfdd004
            LET g_sfdd_d_o.sfdd005 = g_sfdd_d[l_ac].sfdd005
            LET g_sfdd_d_o.sfdd010 = g_sfdd_d[l_ac].sfdd010
            #160914-00019#1-e
         
         #储位
         AFTER FIELD sfdd004
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            #IF cl_null(g_sfdc4_d[g_detail_idx].sfdc013) THEN  #170116-00033#1
            #160914-00019#1-s
               LET g_sfdd_d[l_ac].sfdd004_desc = ''
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd003) AND NOT cl_null(g_sfdd_d[l_ac].sfdd004) THEN
                  IF g_sfdd_d[l_ac].sfdd004 != g_sfdd_d_o.sfdd004 OR cl_null(g_sfdd_d_o.sfdd004) THEN
                     IF NOT asft310_sfdd_loca_chk() THEN
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
               END IF
            #END IF  #170116-00033#1
            LET g_sfdd_d_o.sfdd004 = g_sfdd_d[l_ac].sfdd004
            LET g_sfdd_d_o.sfdd005 = g_sfdd_d[l_ac].sfdd005
            LET g_sfdd_d_o.sfdd010 = g_sfdd_d[l_ac].sfdd010
            #160914-00019#1-e
         
         #批号
         AFTER FIELD sfdd005
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            #IF cl_null(g_sfdc4_d[g_detail_idx].sfdc014) THEN  #170116-00033#1
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd005) THEN
                  IF g_sfdd_d[l_ac].sfdd005 != g_sfdd_d_o.sfdd005 OR cl_null(g_sfdd_d_o.sfdd005) THEN
                     #发料单做在捡量的检查
                     IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdd_d[l_ac].sfdd007) AND NOT cl_null(g_sfdd_d[l_ac].sfdd003) THEN  #在捡数量 库位
                        IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN LET g_sfdd_d[l_ac].sfdd010= ' ' END IF  #库存管理特征
                        IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN LET g_sfdd_d[l_ac].sfdd004= ' ' END IF  #储位
                        IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN LET g_sfdd_d[l_ac].sfdd005= ' ' END IF  #批号
                        #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
                        #                           据点   料件编号                产品特征                库存管理特征
                        CALL s_inventory_check_inan(g_site,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd010,
                        #                           库位                   储位                    批号
                                                    g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd005,
                        #                           交易单位                在捡数量
                                                    g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007,
                        #                           单据编号            项次                            项序
                                                    g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[l_ac].sfddseq1,
                        #                           工單單號                 工單項次 
                                                    g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
                             RETURNING l_success,l_flag2
                        IF NOT l_flag2 THEN
                           LET g_sfdd_d[l_ac].sfdd005 = g_sfdd_d_o.sfdd005
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            #END IF  #170116-00033#1
            LET g_sfdd_d_o.sfdd004 = g_sfdd_d[l_ac].sfdd004
            LET g_sfdd_d_o.sfdd005 = g_sfdd_d[l_ac].sfdd005
            LET g_sfdd_d_o.sfdd010 = g_sfdd_d[l_ac].sfdd010
         
         #单位
         AFTER FIELD sfdd006
            #160914-00019#1-s
            LET g_sfdd_d[l_ac].sfdd006_desc = ''
            IF NOT cl_null(g_sfdd_d_t.sfdd006) THEN
               IF g_sfdd_d[l_ac].sfdd006 != g_sfdd_d_o.sfdd006 OR cl_null(g_sfdd_d_o.sfdd006) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdd_d[l_ac].sfdd006
                  #160318-00025#22-s
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
                  #160318-00025#22-e
                  IF NOT cl_chk_exist("v_ooca001") THEN
                     LET g_sfdd_d[l_ac].sfdd006 = g_sfdd_d_o.sfdd006
                     LET g_sfdd_d[l_ac].sfdd006_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006)
                     NEXT FIELD CURRENT
                  END IF
                  #單位需與發料料號的基礎單位有轉換率
                  IF NOT s_aimi190_chk_base_convert(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd006) THEN
                     LET g_sfdd_d[l_ac].sfdd006 = g_sfdd_d_o.sfdd006
                     LET g_sfdd_d[l_ac].sfdd006_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006)
                     NEXT FIELD CURRENT
                  END IF
                  #单位取位
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd007) THEN
                     CALL s_aooi250_take_decimals(g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007)
                          RETURNING l_success,g_sfdd_d[l_ac].sfdd007
                  END IF
                  #预设参考数量=數量*單位轉換率
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd007) AND NOT cl_null(g_sfdd_d[l_ac].sfdd008) THEN
                     CALL s_aooi250_convert_qty(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd007)
                          RETURNING l_success,g_sfdd_d[l_ac].sfdd009
                     IF NOT l_success THEN
                        LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d[l_ac].sfdd007
                     END IF
                  ELSE
                     LET g_sfdd_d[l_ac].sfdd009 = 0
                  END IF
                  #计算替代率
                  LET g_sfdd_d[l_ac].sfdd002 = s_asft310_get_sfdd002(l_sfaa010,l_sfaa011,    #主料，特性
                      g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,  #部位，作业，作业序
                      g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfdc006,  #需求料号，需求料件单位
                      g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd006)    #替代料号,替代发料单位
               END IF
               LET g_sfdd_d[l_ac].sfdd006_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006)
            #160914-00019#1-e
            END IF
            LET g_sfdd_d_o.sfdd002 = g_sfdd_d[l_ac].sfdd002
            LET g_sfdd_d_o.sfdd006 = g_sfdd_d[l_ac].sfdd006
            LET g_sfdd_d_o.sfdd007 = g_sfdd_d[l_ac].sfdd007
            LET g_sfdd_d_o.sfdd009 = g_sfdd_d[l_ac].sfdd009
          
         #数量
         AFTER FIELD sfdd007
            IF NOT cl_null(g_sfdd_d[l_ac].sfdd007) THEN
               IF g_sfdd_d[l_ac].sfdd007 != g_sfdd_d_o.sfdd007 OR cl_null(g_sfdd_d_o.sfdd007) THEN
                  #单位取位
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd006) THEN
                     CALL s_aooi250_take_decimals(g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007)
                          RETURNING l_success,g_sfdd_d[l_ac].sfdd007
                  END IF
                  #mod 141211
                  IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單
                     #不可小于0，可以等于0 因为到倉庫那確實沒有庫存，那實際量就0，其他的有庫存還是要發
                     IF g_sfdd_d[l_ac].sfdd007 < 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'agl-00041'
                        LET g_errparam.extend = g_sfdd_d[l_ac].sfdd007
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                        NEXT FIELD CURRENT
                     END IF
                  ELSE  #退料單
                     #不可小于等于0
                     IF NOT cl_ap_chk_Range(g_sfdd_d[l_ac].sfdd007,"0.000","0","","","azz-00079",1) THEN
                        LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #mod 141211-end
                  #替代料数量检查
                  IF g_sfdd_d[l_ac].sfdd001 != g_sfdc4_d[g_detail_idx].sfdc004 OR
                     g_sfdd_d[l_ac].sfdd013 != g_sfdc4_d[g_detail_idx].sfdc005 THEN  #替代料
                    #160111-00028#1-s
                    #抓取發料料號的上階料號
                     CALL s_asft310_get_bmea(l_sfba001,l_sfaa011,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                    #CALL s_asft310_get_bmea(l_sfaa010,l_sfaa011,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                    #160111-00028#1-e
                          #RETURNING l_success,l_bmea.* #161109-00085#62 mark
                          #161109-00085#62 --s add
                          RETURNING l_success,l_bmea.bmeaent,l_bmea.bmeasite,l_bmea.bmea001,l_bmea.bmea002,
                                    l_bmea.bmea003,l_bmea.bmea004,l_bmea.bmea005,l_bmea.bmea006,l_bmea.bmea007,
                                    l_bmea.bmea008,l_bmea.bmea009,l_bmea.bmea010,l_bmea.bmea011,l_bmea.bmea012,
                                    l_bmea.bmea013,l_bmea.bmea014,l_bmea.bmea015,l_bmea.bmea016,l_bmea.bmea017,
                                    l_bmea.bmea018,l_bmea.bmea019,l_bmea.bmeaud001,l_bmea.bmeaud002,l_bmea.bmeaud003,
                                    l_bmea.bmeaud004,l_bmea.bmeaud005,l_bmea.bmeaud006,l_bmea.bmeaud007,l_bmea.bmeaud008,
                                    l_bmea.bmeaud009,l_bmea.bmeaud010,l_bmea.bmeaud011,l_bmea.bmeaud012,l_bmea.bmeaud013,
                                    l_bmea.bmeaud014,l_bmea.bmeaud015,l_bmea.bmeaud016,l_bmea.bmeaud017,l_bmea.bmeaud018,
                                    l_bmea.bmeaud019,l_bmea.bmeaud020,l_bmea.bmeaud021,l_bmea.bmeaud022,l_bmea.bmeaud023,
                                    l_bmea.bmeaud024,l_bmea.bmeaud025,l_bmea.bmeaud026,l_bmea.bmeaud027,l_bmea.bmeaud028,
                                    l_bmea.bmeaud029,l_bmea.bmeaud030,l_bmea.bmea020
                          #161109-00085#62 --e add
                     IF NOT l_success THEN
                        LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                        NEXT FIELD CURRENT
                     END IF
                     #替代料为部分替代时，替代料的數量不可超过上限比率
                     IF l_bmea.bmea016 = '1' THEN
                        CALL asft310_get_sfdd007_replace(l_cmd) RETURNING l_success,l_sfdd007,l_sfdd009   #替换料件折合成元件的数量
                        IF NOT l_success THEN
                           LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                           NEXT FIELD CURRENT
                        END IF
                        #  实际发料数量 > 需求数量 * 部份替代上限比率 / 100
                        IF l_sfdd007 > g_sfdc4_d[g_detail_idx].sfdc007 * l_bmea.bmea017 / 100 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'asf-00327'
                           LET g_errparam.extend = g_sfdd_d[l_ac].sfdd007
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
                  #數量總數不可超過申請數量
                  IF NOT asft310_chk_sfdd_amt(l_cmd,'sfdd007') THEN
                     LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                     NEXT FIELD CURRENT
                  END IF
                  #发料单做在捡量的检查
                  IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdd_d[l_ac].sfdd007) AND NOT cl_null(g_sfdd_d[l_ac].sfdd003) THEN  #在捡数量 库位
                     IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN LET g_sfdd_d[l_ac].sfdd010= ' ' END IF  #库存管理特征
                     IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN LET g_sfdd_d[l_ac].sfdd004= ' ' END IF  #储位
                     IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN LET g_sfdd_d[l_ac].sfdd005= ' ' END IF  #批号
                     #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
                     #                           据点   料件编号                产品特征                库存管理特征
                     CALL s_inventory_check_inan(g_site,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd010,
                     #                           库位                   储位                    批号
                                                 g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd005,
                     #                           交易单位                在捡数量
                                                 g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007,
                     #                           单据编号            项次                            项序
                                                 g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[l_ac].sfddseq1,
                     #                           工單單號                 工單項次 
                                                 g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
                          RETURNING l_success,l_flag2
                     IF NOT l_flag2 THEN
                        LET g_sfdd_d[l_ac].sfdd007 = g_sfdd_d_o.sfdd007
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  #add 150831 --begin
                  #LET l_imaf071 = NULL  #mark 因为要从库存仓库中挑选，录入数量的时候往往仓库还不全，所以统一由按钮去实现
                  #LET l_imaf081 = NULL
                  #SELECT imaf071,imaf081 INTO l_imaf071,l_imaf081 FROM imaf_t
                  # WHERE imafent = g_enterprise
                  #   AND imafsite = g_site AND imaf001 = g_sfdd_d[l_ac].sfdd001
                  #
                  #IF (cl_null(g_sfdd_d_o.sfdd007) OR g_sfdd_d[l_ac].sfdd007!=g_sfdd_d_o.sfdd007) AND (l_imaf071 = '1' OR l_imaf081 = '1') THEN
                  #   IF g_sfdd_d[l_ac].sfdd007 > 0 THEN
                  #      IF g_prog[1,6]='asft31' THEN  #发料出库
                  #         LET l_inao013 = -1
                  #      ELSE
                  #         LET l_inao013 = 1   #入库
                  #      END IF
                  #      CALL s_lot_sel('2','2',
                  #                     #營運據點 單據編號
                  #                     g_site,g_sfda_m.sfdadocno,
                  #                     #單據項次                        單據項序(若單據沒有到項序層則此參數固定傳0)
                  #                     g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[l_ac].sfddseq1,
                  #                     #料件編號               產品特徵
                  #                     g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,
                  #                     #庫存管理特徵           庫位
                  #                     g_sfdd_d[l_ac].sfdd010,g_sfdd_d[l_ac].sfdd003,
                  #                     #儲位                   批號
                  #                     g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd005,
                  #                     #交易單位               交易數量
                  #                     g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007,
                  #                     #'-1出庫'  作業編號 營運據點
                  #                     l_inao013,g_prog,g_site,
                  #                     #来源單據編號       来源單據項次
                  #                     g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,
                  #                     #来源單據項序(若單據沒有到項序層則此參數固定傳0)  启用来源单据
                  #                     '0','1')
                  #           RETURNING l_success
                  #   END IF
                  #END IF
                  #add 150831 --end
                  #151217-00023#5-s
                  IF g_prog[1,6] = 'asft31' AND g_sfdd_d[l_ac].sfdd007 > 0 THEN  #发料
                    DELETE FROM inao_t
                     WHERE inaoent = g_enterprise
                       AND inaosite = g_site
                       AND inaodocno = g_sfda_m.sfdadocno
                       AND inaoseq = g_sfdc_d[g_detail_idx].sfdcseq
                       AND inao000 = '2'
                     CALL s_lot_sel('1','2',g_site,
                                    g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq,'1', #目的单号，项次，项序
                                    g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd010,
                                    g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd005,
                                    g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007,'-1',g_prog,'',
                                    '','','','0')  #来源单号，项次，项序,启用
                          RETURNING l_success
                  ELSE  #退料
                     CASE g_sfda_m.sfda002
                        WHEN '11'    LET l_prog='asft311'
                        WHEN '12'    LET l_prog='asft312'
                        WHEN '13'    LET l_prog='asft313'
                        WHEN '14'    LET l_prog='asft314'
                        WHEN '15'    LET l_prog='asft315'
                        WHEN '21'    LET l_prog='asft321'
                        WHEN '22'    LET l_prog='asft322'
                        WHEN '23'    LET l_prog='asft323'
                        WHEN '24'    LET l_prog='asft324'
                        WHEN '25'    LET l_prog='asft325'
                     END CASE
                     #                      发退料类型   工单                      项次 
                     CALL s_asft310_lot_sel(l_prog,g_sfdc4_d[g_detail_idx].sfdc001,g_sfdc4_d[g_detail_idx].sfdc002,
                     #                      料                             产品特征
                                            g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfdc005,
                     #                      库存管理特征                    库位
                                            g_sfdc4_d[g_detail_idx].sfdc016,g_sfdc4_d[g_detail_idx].sfdc012,
                     #                      储位                           批号
                                            g_sfdc4_d[g_detail_idx].sfdc013,g_sfdc4_d[g_detail_idx].sfdc014,
                     #                      目的单号            项次                           项序
                                            g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,0,
                     #                      单位                           数量
                                            g_sfdc4_d[g_detail_idx].sfdc006,g_sfdc4_d[g_detail_idx].sfdc007)
                          RETURNING l_success 
                  END IF
                  IF l_cmd = 'a' THEN
                     CALL asft310_ins_inao_2() RETURNING l_success
                  END IF
                  CALL asft310_b_fill_inao2()
                  #151217-00023#5-e
                  #160408-00035#7-s
                 #IF g_prog = 'asft311' THEN        #160623-00014#1
                  IF g_prog MATCHES 'asft311' THEN  #160623-00014#1
                     CALL s_asft310_get_sfbb008_sfbb009(g_sfdc4_d[g_detail_idx].sfdc001,g_sfdc4_d[g_detail_idx].sfdc002,g_sfdc4_d[g_detail_idx].sfdc003,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfdc005,g_sfdc4_d[g_detail_idx].sfdc016,g_sfdc4_d[g_detail_idx].sfdc012,g_sfdc4_d[g_detail_idx].sfdc013,g_sfdc4_d[g_detail_idx].sfdc014,g_sfdc4_d[g_detail_idx].sfdc006)
                          RETURNING l_qty
                     IF g_sfdd_d[l_ac].sfdd007 >= l_qty THEN 
                        LET g_sfdd_d[l_ac].sfdd014 = l_qty
                     ELSE   
                        LET g_sfdd_d[l_ac].sfdd014 = g_sfdd_d[l_ac].sfdd007 
                     END IF
                     LET g_sfdd_d[l_ac].sfdd015 = g_sfdd_d[l_ac].sfdd007 - g_sfdd_d[l_ac].sfdd014
                  END IF
                  ##160408-00035#7-e
                  #预设参考数量=數量*單位轉換率
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd006) AND NOT cl_null(g_sfdd_d[l_ac].sfdd008) THEN
                     CALL s_aooi250_convert_qty(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd007)
                        RETURNING l_success,g_sfdd_d[l_ac].sfdd009
                     IF NOT l_success THEN
                        LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d[l_ac].sfdd007
                     END IF
                  ELSE
                     LET g_sfdd_d[l_ac].sfdd009 = 0
                  END IF
               END IF
            END IF
            LET g_sfdd_d_o.sfdd007 = g_sfdd_d[l_ac].sfdd007
            LET g_sfdd_d_o.sfdd009 = g_sfdd_d[l_ac].sfdd009
             
         #参考单位
         AFTER FIELD sfdd008
            #160914-00019#1-s
            LET g_sfdd_d[l_ac].sfdd008_desc = ''
            IF NOT cl_null(g_sfdd_d[l_ac].sfdd008) THEN
               IF g_sfdd_d[l_ac].sfdd008 != g_sfdd_d_o.sfdd008 OR cl_null(g_sfdd_d_o.sfdd008) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdd_d[l_ac].sfdd008
                  #160318-00025#22-s
                  LET g_errshow = TRUE #是否開窗                   
                  LET g_chkparam.err_str[1] ="aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
                  #160318-00025#22-e
                  IF NOT cl_chk_exist("v_ooca001") THEN
                     LET g_sfdd_d[l_ac].sfdd008 = g_sfdd_d_o.sfdd008
                     LET g_sfdd_d[l_ac].sfdd008_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008)
                     NEXT FIELD CURRENT
                  END IF
                  #單位需與發料料號的基礎單位有轉換率
                  IF NOT s_aimi190_chk_base_convert(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd008) THEN
                     LET g_sfdd_d[l_ac].sfdd008 = g_sfdd_d_o.sfdd008
                     LET g_sfdd_d[l_ac].sfdd008_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008)
                     NEXT FIELD CURRENT
                  END IF
                  #预设参考数量=數量*單位轉換率
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd006) AND NOT cl_null(g_sfdd_d[l_ac].sfdd007) THEN
                     CALL s_aooi250_convert_qty(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd007)
                          RETURNING l_success,g_sfdd_d[l_ac].sfdd009
                     IF NOT l_success THEN
                        LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d[l_ac].sfdd007
                     END IF
                  END IF
               END IF
               LET g_sfdd_d[l_ac].sfdd008_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008)
            #160914-00019#1-e
            ELSE
               LET g_sfdd_d[l_ac].sfdd009 = 0
            END IF
            LET g_sfdd_d_o.sfdd008 = g_sfdd_d[l_ac].sfdd008
            LET g_sfdd_d_o.sfdd009 = g_sfdd_d[l_ac].sfdd009

         #参考数量
         AFTER FIELD sfdd009
            IF NOT cl_null(g_sfdd_d[l_ac].sfdd009) THEN
               IF g_sfdd_d[l_ac].sfdd009 != g_sfdd_d_o.sfdd009 OR cl_null(g_sfdd_d_o.sfdd009) THEN
                  #不可小於0 
                  IF NOT cl_ap_chk_Range(g_sfdd_d[l_ac].sfdd009,"0.000","1","","","azz-00079",1) THEN
                     LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d_o.sfdd009
                     NEXT FIELD sfdd009
                  END IF
                  #单位取位
                  IF NOT cl_null(g_sfdd_d[l_ac].sfdd008) THEN
                     CALL s_aooi250_take_decimals(g_sfdd_d[l_ac].sfdd008,g_sfdd_d[l_ac].sfdd009)
                          RETURNING l_success,g_sfdd_d[l_ac].sfdd009
                  END IF
                  #替代料数量检查
                  IF g_sfdd_d[l_ac].sfdd001 != g_sfdc4_d[g_detail_idx].sfdc004 OR
                     g_sfdd_d[l_ac].sfdd013 != g_sfdc4_d[g_detail_idx].sfdc005 THEN  #替代料
                    #160111-00028#1-s
                    #抓取發料料號的上階料號
                     CALL s_asft310_get_bmea(l_sfba001,l_sfaa011,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                    #CALL s_asft310_get_bmea(l_sfaa010,l_sfaa011,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                    #160111-00028#1-e
                          #RETURNING l_success,l_bmea.* #161109-00085#62 mark
                          #161109-00085#62 --s add
                          RETURNING l_success,l_bmea.bmeaent,l_bmea.bmeasite,l_bmea.bmea001,l_bmea.bmea002,
                                    l_bmea.bmea003,l_bmea.bmea004,l_bmea.bmea005,l_bmea.bmea006,l_bmea.bmea007,
                                    l_bmea.bmea008,l_bmea.bmea009,l_bmea.bmea010,l_bmea.bmea011,l_bmea.bmea012,
                                    l_bmea.bmea013,l_bmea.bmea014,l_bmea.bmea015,l_bmea.bmea016,l_bmea.bmea017,
                                    l_bmea.bmea018,l_bmea.bmea019,l_bmea.bmeaud001,l_bmea.bmeaud002,l_bmea.bmeaud003,
                                    l_bmea.bmeaud004,l_bmea.bmeaud005,l_bmea.bmeaud006,l_bmea.bmeaud007,l_bmea.bmeaud008,
                                    l_bmea.bmeaud009,l_bmea.bmeaud010,l_bmea.bmeaud011,l_bmea.bmeaud012,l_bmea.bmeaud013,
                                    l_bmea.bmeaud014,l_bmea.bmeaud015,l_bmea.bmeaud016,l_bmea.bmeaud017,l_bmea.bmeaud018,
                                    l_bmea.bmeaud019,l_bmea.bmeaud020,l_bmea.bmeaud021,l_bmea.bmeaud022,l_bmea.bmeaud023,
                                    l_bmea.bmeaud024,l_bmea.bmeaud025,l_bmea.bmeaud026,l_bmea.bmeaud027,l_bmea.bmeaud028,
                                    l_bmea.bmeaud029,l_bmea.bmeaud030,l_bmea.bmea020
                          #161109-00085#62 --e add
                     IF NOT l_success THEN
                        LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d_o.sfdd009
                        NEXT FIELD CURRENT
                     END IF
                     #替代料为部分替代时，替代料的數量不可超过上限比率
                     IF l_bmea.bmea016 = '1' THEN
                        CALL asft310_get_sfdd007_replace(l_cmd) RETURNING l_success,l_sfdd007,l_sfdd009   #替换料件折合成元件的数量
                        IF NOT l_success THEN
                           NEXT FIELD CURRENT
                        END IF
                        #  实际发料数量 > 需求数量 * 部份替代上限比率 / 100
                        IF l_sfdd009 > g_sfdc4_d[g_detail_idx].sfdc010 * l_bmea.bmea017 / 100 THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'asf-00327'
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d_o.sfdd009
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
                  #數量總數不可超過申請數量
                  IF NOT asft310_chk_sfdd_amt(l_cmd,'sfdd009') THEN
                     LET g_sfdd_d[l_ac].sfdd009 = g_sfdd_d_o.sfdd009
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfdd_d_o.sfdd009 = g_sfdd_d[l_ac].sfdd009

         #库存管理特征
         AFTER FIELD sfdd010
            #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
            IF cl_null(g_sfdc4_d[g_detail_idx].sfdc016) THEN
               IF NOT cl_null(g_sfdd_d[l_ac].sfdd010) THEN
                  IF g_sfdd_d[l_ac].sfdd010 != g_sfdd_d_o.sfdd010 OR cl_null(g_sfdd_d_o.sfdd010) THEN
                     LET l_cnt = 0
                     SELECT COUNT(1) INTO l_cnt FROM inag_t
                      WHERE inagent  = g_enterprise
                        AND inagsite = g_site
                        AND inag001  = g_sfdd_d[l_ac].sfdd001  #料件
                        AND inag002  = g_sfdd_d[l_ac].sfdd013  #产品特征
                        AND inag003  = g_sfdd_d[l_ac].sfdd010  #库存管理特征
                     IF l_cnt = 0 THEN
                        #无此库存管理特征，请检查库存资料后从新输入
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00117'
                        LET g_errparam.extend = '' #g_sfdd_d[l_ac].sfdd001
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfdd_d[l_ac].sfdd010 = g_sfdd_d_o.sfdd010
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfdd_d_o.sfdd004 = g_sfdd_d[l_ac].sfdd004
            LET g_sfdd_d_o.sfdd005 = g_sfdd_d[l_ac].sfdd005
            LET g_sfdd_d_o.sfdd010 = g_sfdd_d[l_ac].sfdd010

         #包装容器
         AFTER FIELD sfdd011
            #輸入值須存在[T:料件包裝資料檔].[C:包裝容器編號]，錯誤訊息「此料沒有這種包裝方式，請重新輸入」
            IF NOT cl_null(g_sfdd_d[l_ac].sfdd011) THEN
               IF g_sfdd_d[l_ac].sfdd011 != g_sfdd_d_o.sfdd011 OR cl_null(g_sfdd_d_o.sfdd011) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfdd_d[l_ac].sfdd011
                  IF NOT cl_chk_exist("v_imaa001_3") THEN
                     LET g_sfdd_d[l_ac].sfdd011 = g_sfdd_d_o.sfdd011
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfdd_d_o.sfdd011 = g_sfdd_d[l_ac].sfdd011
            
         #需求料号
         ON ACTION controlp INFIELD sfdd001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd001
           #160111-00028#1-s
           #LET g_qryparam.where = " (  (bmea001 ='",l_sfaa010,"' ",   #主件料號
            LET g_qryparam.where = " (  (bmea001 = (SELECT sfba001 FROM sfba_t WHERE sfbaent = ",g_enterprise," AND sfbadocno = '",g_sfdc4_d[g_detail_idx].sfdc001,"' AND sfbaseq = '",g_sfdc4_d[g_detail_idx].sfdc002,"' AND sfbaseq1 = '",g_sfdc4_d[g_detail_idx].sfdc003,"' ) ",
           #160111-00028#1-e
                                   " AND bmea002 = '",l_sfaa011,"' ",  #特性
                                   " AND bmea003 = '",g_sfdc4_d[g_detail_idx].sfdc004,"' ",  #元件料號
                                   " AND bmea004 = '",g_sfdc4_d[g_detail_idx].sfba002,"' ",  #部位
                                   " AND bmea005 = '",g_sfdc4_d[g_detail_idx].sfba003,"' ",  #作業
                                   " AND bmea006 = '",g_sfdc4_d[g_detail_idx].sfba004,"') ", #製程序
                                   " OR ",
                                   "(bmea001 ='ALL' ",   #主件料號
                                   " AND bmea003 = '",g_sfdc4_d[g_detail_idx].sfdc004,"')) ",  #元件料號
                                   " AND bmea009<= '",g_today,"' ",
                                   " AND (bmea010 > '",g_today,"' OR bmea010 IS NULL ) "
            #关于控制组
            CALL s_control_get_doc_sql("imaf016",g_sfda_m.sfdadocno,'4')   #下面开窗中的据点生命周期、需限制的单据、4代表产品生命周期检核
               RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND ",l_where
            END IF
            CALL s_control_get_doc_sql("imaa009",g_sfda_m.sfdadocno,'5')
               RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where CLIPPED," AND ",l_where
            END IF
            CALL q_bmea008_5()  #取替代中抓取
            LET g_sfdd_d[l_ac].sfdd001 = g_qryparam.return1
            DISPLAY g_sfdd_d[l_ac].sfdd001 TO sfdd001
            #160914-00019#1-s
            CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001)
                 RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
            #160914-00019#1-e
            NEXT FIELD sfdd001

         #产品特征
         ON ACTION controlp INFIELD sfdd013
            CALL s_feature_single(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_site,'')
               RETURNING l_success,g_sfdd_d[l_ac].sfdd013
            IF NOT l_success THEN
               LET g_sfdd_d[l_ac].sfdd013 = ' '
            END IF
            DISPLAY g_sfdd_d[l_ac].sfdd013 TO sfdd013
            CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
                 RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
            NEXT FIELD sfdd013

         #仓库
         ON ACTION controlp INFIELD sfdd003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd003
            LET g_qryparam.default2 = g_sfdd_d[l_ac].sfdd004
            LET g_qryparam.default3 = g_sfdd_d[l_ac].sfdd005
            LET g_qryparam.default4 = g_sfdd_d[l_ac].sfdd010
            #mod 141118 q_inag004_13修改成传参方式
            #LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"'"
            LET g_qryparam.arg1 = g_sfdd_d[l_ac].sfdd001
            IF cl_null(g_sfdd_d[l_ac].sfdd013) THEN
               LET g_qryparam.arg2 = ' '
            ELSE
               LET g_qryparam.arg2 = g_sfdd_d[l_ac].sfdd013
            END IF
            #已有指定不可输入
            LET g_qryparam.where = "1=1 "
            #IF g_sfdd003_switch = 'N' THEN
            #   IF cl_null(g_sfdd_d[l_ac].sfdd003) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdd_d[l_ac].sfdd003,"' "
            #   END IF
            #END IF
            IF g_sfdd004_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdd_d[l_ac].sfdd004,"' "
               END IF
            END IF
            IF g_sfdd005_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdd_d[l_ac].sfdd005,"' "
               END IF
            END IF
            IF g_sfdd010_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdd_d[l_ac].sfdd010,"' "
               END IF
            END IF
            #mod 141118 --end
            #关于控制组
            CALL s_control_get_doc_sql("inag004",g_sfda_m.sfdadocno,'6')
                 RETURNING l_success,l_where
            IF l_success THEN
               LET g_qryparam.where = g_qryparam.where ," AND ",l_where
            END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag004_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag004_16()
            END IF
            LET g_sfdd_d[l_ac].sfdd003 = g_qryparam.return1
            LET g_sfdd_d[l_ac].sfdd004 = g_qryparam.return2
            LET g_sfdd_d[l_ac].sfdd005 = g_qryparam.return3
            LET g_sfdd_d[l_ac].sfdd010 = g_qryparam.return4
            DISPLAY g_sfdd_d[l_ac].sfdd003 TO sfdd003
            DISPLAY g_sfdd_d[l_ac].sfdd004 TO sfdd004
            DISPLAY g_sfdd_d[l_ac].sfdd005 TO sfdd005
            DISPLAY g_sfdd_d[l_ac].sfdd010 TO sfdd010
            LET g_sfdd_d[l_ac].sfdd003_desc = s_desc_get_stock_desc(g_site,g_sfdd_d[l_ac].sfdd003)
            LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
            NEXT FIELD sfdd003
            
         #储位
         ON ACTION controlp INFIELD sfdd004
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd004
            LET g_qryparam.default2 = g_sfdd_d[l_ac].sfdd005
            LET g_qryparam.default3 = g_sfdd_d[l_ac].sfdd010
           #LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"' AND inag004 ='",g_sfdd_d[l_ac].sfdd003,"' "
            LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"' " #mod 141211
            #已有指定不可输入
            #add 141211
            IF g_sfdd003_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd003) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdd_d[l_ac].sfdd003,"' "
               END IF
            END IF
            #add 141211 end
            #IF g_sfdd004_switch = 'N' THEN
            #   IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdd_d[l_ac].sfdd004,"' "
            #   END IF
            #END IF
            IF g_sfdd005_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdd_d[l_ac].sfdd005,"' "
               END IF
            END IF
            IF g_sfdd010_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdd_d[l_ac].sfdd010,"' "
               END IF
            END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag005_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag005_14()
            END IF
            LET g_sfdd_d[l_ac].sfdd004 = g_qryparam.return1
            LET g_sfdd_d[l_ac].sfdd005 = g_qryparam.return2
            LET g_sfdd_d[l_ac].sfdd010 = g_qryparam.return3
            DISPLAY g_sfdd_d[l_ac].sfdd004 TO sfdd004
            DISPLAY g_sfdd_d[l_ac].sfdd005 TO sfdd005
            DISPLAY g_sfdd_d[l_ac].sfdd010 TO sfdd010 
            LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
            NEXT FIELD sfdd004

         #批号
         ON ACTION controlp INFIELD sfdd005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd004
            LET g_qryparam.default2 = g_sfdd_d[l_ac].sfdd005
            LET g_qryparam.default3 = g_sfdd_d[l_ac].sfdd010
           #LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"' AND inag004 ='",g_sfdd_d[l_ac].sfdd003,"' "
            LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"' " #mod 141211
            #IF NOT cl_null(g_sfdd_d[l_ac].sfdd004) THEN  #以防储位不可输入时误更新
            #   LET g_qryparam.where = g_qryparam.where CLIPPED," AND inag005 ='",g_sfdd_d[l_ac].sfdd004,"' "
            #END IF
            #已有指定不可输入
            #add 141211
            IF g_sfdd003_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd003) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdd_d[l_ac].sfdd003,"' "
               END IF
            END IF
            #add 141211 end
            IF g_sfdd004_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdd_d[l_ac].sfdd004,"' "
               END IF
            END IF
            #IF g_sfdd005_switch = 'N' THEN
            #   IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdd_d[l_ac].sfdd005,"' "
            #   END IF
            #END IF
            IF g_sfdd010_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdd_d[l_ac].sfdd010,"' "
               END IF
            END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag005_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag005_14()
            END IF
            LET g_sfdd_d[l_ac].sfdd004 = g_qryparam.return1
            LET g_sfdd_d[l_ac].sfdd005 = g_qryparam.return2
            LET g_sfdd_d[l_ac].sfdd010 = g_qryparam.return3
            DISPLAY g_sfdd_d[l_ac].sfdd004 TO sfdd004
            DISPLAY g_sfdd_d[l_ac].sfdd005 TO sfdd005
            DISPLAY g_sfdd_d[l_ac].sfdd010 TO sfdd010 
            LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
            NEXT FIELD sfdd005

         #库存管理特征
         ON ACTION controlp INFIELD sfdd010
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd004
            LET g_qryparam.default2 = g_sfdd_d[l_ac].sfdd005
            LET g_qryparam.default3 = g_sfdd_d[l_ac].sfdd010
           #LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"' AND inag004 ='",g_sfdd_d[l_ac].sfdd003,"' "
            LET g_qryparam.where = " inag001 ='",g_sfdd_d[l_ac].sfdd001,"' AND inag002 ='",g_sfdd_d[l_ac].sfdd013,"' " #mod 141211
            #IF NOT cl_null(g_sfdd_d[l_ac].sfdd004) THEN  #以防储位不可输入时误更新
            #   LET g_qryparam.where = g_qryparam.where CLIPPED," AND inag005 ='",g_sfdd_d[l_ac].sfdd004,"' "
            #END IF
            #已有指定不可输入
            #add 141211
            IF g_sfdd003_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd003) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfdd_d[l_ac].sfdd003,"' "
               END IF
            END IF
            #add 141211 end
            IF g_sfdd004_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfdd_d[l_ac].sfdd004,"' "
               END IF
            END IF
            IF g_sfdd005_switch = 'N' THEN
               IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = ' ' "
               ELSE
                  LET g_qryparam.where = g_qryparam.where ," AND inag006 = '",g_sfdd_d[l_ac].sfdd005,"' "
               END IF
            END IF
            #IF g_sfdd010_switch = 'N' THEN
            #   IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN
            #      LET g_qryparam.where = g_qryparam.where ," AND inag003 = ' ' "
            #   ELSE
            #      LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfdd_d[l_ac].sfdd010,"' "
            #   END IF
            #END IF
            IF g_sfda_m.sfda002[1,1]='1' THEN  #發料單 庫存>0
               CALL q_inag005_13()
            ELSE                               #退料單 不卡控库存
               CALL q_inag005_14()
            END IF
            LET g_sfdd_d[l_ac].sfdd004 = g_qryparam.return1
            LET g_sfdd_d[l_ac].sfdd005 = g_qryparam.return2
            LET g_sfdd_d[l_ac].sfdd010 = g_qryparam.return3
            DISPLAY g_sfdd_d[l_ac].sfdd004 TO sfdd004
            DISPLAY g_sfdd_d[l_ac].sfdd005 TO sfdd005
            DISPLAY g_sfdd_d[l_ac].sfdd010 TO sfdd010 
            LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
            NEXT FIELD sfdd010

         #单位
         ON ACTION controlp INFIELD sfdd006
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd006
            CALL q_ooca001_1()
            LET g_sfdd_d[l_ac].sfdd006 = g_qryparam.return1
            DISPLAY g_sfdd_d[l_ac].sfdd006 TO sfdd006
            LET g_sfdd_d[l_ac].sfdd006_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006)  #160914-00019#1
            NEXT FIELD sfdd006  #160914-00019#1

         #参考单位
         ON ACTION controlp INFIELD sfdd008
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd008
            CALL q_ooca001_1()
            LET g_sfdd_d[l_ac].sfdd008 = g_qryparam.return1
            DISPLAY g_sfdd_d[l_ac].sfdd008 TO sfdd008
            LET g_sfdd_d[l_ac].sfdd008_desc = s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008)  #160914-00019#1
            NEXT FIELD sfdd008  #160914-00019#1

         #包装容器
         ON ACTION controlp INFIELD sfdd011
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfdd_d[l_ac].sfdd011
            CALL q_imaa001_11()
            LET g_sfdd_d[l_ac].sfdd011 = g_qryparam.return1
            DISPLAY g_sfdd_d[l_ac].sfdd011 TO sfdd011
            NEXT FIELD sfdd011
         
         #add 141222
         #备注
         ON ACTION controlp INFIELD sfdd_ooff013
            CALL s_aooi360_edit('7',g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[l_ac].sfddseq1,' ',' ',' ',' ',' ',' ',' ','4',g_sfdd_d[l_ac].sfdd_ooff013)
               RETURNING g_sfdd_d[l_ac].sfdd_ooff013
            DISPLAY g_sfdd_d[l_ac].sfdd_ooff013 TO sfdd_ooff013
            NEXT FIELD sfdd_ooff013
         #add 141222 end
         
         AFTER ROW
            CALL asft310_b_fill() #單身填充
            CALL asft310_b_fill2('0') #單身填充
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_sfdd_d[l_ac].* = g_sfdd_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE asft310_bcl6
               CLOSE asft310_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            #170207-00014#1 add --(S)--
            LET l_cnt1 = g_sfdd_d.getLength()
            IF l_cnt1 > 0 AND g_sfda_m.sfdastus = 'Y' THEN 
               LET l_cnt = 0
               SELECT COUNT(1) INTO l_cnt
                 FROM inap_t
                WHERE inapent = g_enterprise
                  AND inapsite = g_site
                  AND inap001 = g_sfda_m.sfdadocno
               IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
               IF l_cnt = 0 THEN               
                  IF NOT s_asft310_do_inap_inan(g_sfda_m.sfdadocno,'1') THEN
                     CLOSE asft310_bcl6
                     CLOSE asft310_bcl2
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     EXIT DIALOG 
                  END IF
               END IF                  
            END IF
            #170207-00014#1 add --(E)--
            #其他table進行unlock
            
            CALL asft310_unlock_b("sfdd_t","'6'")
            CALL s_transaction_end('Y','0')
            
         AFTER INPUT
            
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_sfdd_d[li_reproduce_target].* = g_sfdd_d[li_reproduce].*
               LET g_sfdd_d[li_reproduce_target].sfddseq1 = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_sfdd_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_sfdd_d.getLength()+1
            END IF

      END INPUT

      BEFORE DIALOG
        #151217-00023#5 add -----(S)
         IF g_mdemand = 'Y' THEN
            NEXT FIELD sfddseq1
         END IF
        #151217-00023#5 add -----(E)
         IF g_sfda_m.sfdastus = 'Y' THEN #已审核的单据只能修改发料明细和料号汇总页签
            LET l_flag = 'f'
         END IF
         #新增時強制從單頭開始填
         IF cl_null(l_flag) THEN LET l_flag = '0' END IF
         CASE l_flag
            WHEN '0'
                 IF p_cmd = 'a' THEN
                    NEXT FIELD sfdadocno
                 ELSE
                    #LET g_curr_diag = ui.DIALOG.getCurrent()
                    #LET g_aw = g_curr_diag.getCurrentItem()
                    #DISPLAY "1=",g_aw
                    #
                    #LET g_aw =  DIALOG.getCurrentItem()
                    #DISPLAY "2=",g_aw
                    #
                    #LET g_aw =  DIALOG.getForm()
                    #DISPLAY "3=",g_aw
                    #
                    #LET g_aw =  g_curr_diag.getForm()
                    #DISPLAY "4=",g_aw
                    #
                    #LET g_aw =  g_curr_diag.getForm()
                    #DISPLAY "4=",g_aw
                    
                    CASE DIALOG.getCurrentItem()
                       WHEN "s_detail1"
                          NEXT FIELD sfdb001
                       WHEN "s_detail2"
                          NEXT FIELD sfdcseq
                       #WHEN "s_detail3"
                       #   NEXT FIELD sfdeseq
                       #WHEN "s_detail4"
                       #   NEXT FIELD sfdcseq_4
                       WHEN "s_detail5"
                          NEXT FIELD sfdfseq1
                       WHEN "s_detail6"
                          NEXT FIELD sfddseq1
                       #WHEN "s_detail7"
                       #   NEXT FIELD inaoseq
                    END CASE
                 END IF
            WHEN 'b'
                 LET l_flag = '0'
                 IF cl_null(l_ac) OR l_ac=0 THEN LET l_ac = 1 END IF
                 #LET l_ac = 1   #不能是当前笔，因为产生方式有可能全部删除再产生，当前笔可能虚大
                 CALL DIALOG.setCurrentRow("s_detail1",l_ac)
                 NEXT FIELD sfdb001
            WHEN 'c'
                 LET l_flag = '0'
                 IF cl_null(l_ac) OR l_ac=0 THEN LET l_ac = 1 END IF
                 #LET l_ac = 1   #不能是当前笔，因为产生方式有可能全部删除再产生，当前笔可能虚大
                 CALL DIALOG.setCurrentRow("s_detail2",l_ac)
                 NEXT FIELD sfdcseq
            WHEN 'f'
                 LET l_flag = '0'
                 IF cl_null(l_ac) OR l_ac=0 THEN LET l_ac = 1 END IF
                 #LET l_ac = 1   #不能是当前笔，因为产生方式有可能全部删除再产生，当前笔可能虚大
                 CALL DIALOG.setCurrentRow("s_detail5",l_ac)
                 NEXT FIELD sfdfseq1
            WHEN 'd'
                 LET l_flag = '0'
                 IF cl_null(l_ac) OR l_ac=0 THEN LET l_ac = 1 END IF
                 #LET l_ac = 1   #不能是当前笔，因为产生方式有可能全部删除再产生，当前笔可能虚大
                 CALL DIALOG.setCurrentRow("s_detail6",l_ac)
                 NEXT FIELD sfddseq1
         END CASE

      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)

      ON ACTION controlr
         CALL cl_show_req_fields()

      ON ACTION controls
         CALL cl_set_head_visible("","AUTO")

      ON ACTION accept
         ACCEPT DIALOG

      ON ACTION cancel      #在dialog button (放棄)
         LET INT_FLAG = TRUE
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         EXIT DIALOG

      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG

   END DIALOG
EXIT WHILE
END WHILE

END FUNCTION

PRIVATE FUNCTION asft310_show()
   LET g_sfda_m_t.* = g_sfda_m.*      #保存單頭舊值

   #发退料需求、料号汇总、发退料明细、制造批序号页签隐藏
   #部位  在制程中委外时隐藏不显示
   IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN
      CALL cl_set_comp_visible("page_3,page_4,page_5,page_6",FALSE)
      CALL cl_set_comp_visible("sfdb003,sfdb003_desc",FALSE)
   ELSE
      CALL cl_set_comp_visible("page_3,page_4,page_5,page_6",TRUE)
      CALL cl_set_comp_visible("sfdb003,sfdb003_desc",TRUE)
   END IF
   #用不到套数页签的类型，套数页签隐藏
   IF g_sfda_m.sfda002 = '14' OR g_sfda_m.sfda002 = '23' OR g_sfda_m.sfda002 = '24' THEN
      CALL cl_set_comp_visible("bpage_1",FALSE)
   ELSE
      CALL cl_set_comp_visible("bpage_1",TRUE)
   END IF
   #runcard在类型为非制程委外时隐藏
   IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN
      CALL cl_set_comp_visible("sfdb002",TRUE)
   ELSE
      CALL cl_set_comp_visible("sfdb002",FALSE)
   END IF
   
   IF g_bfill = "Y" THEN
      CALL asft310_b_fill() #單身填充
      CALL asft310_b_fill2('0') #單身填充
   END IF

   #顯示followup圖示
   #+ 此段落由子樣板a48產生
   CALL asft310_set_pk_array()
   #add-point:ON ACTION agendum

   #END add-point
   CALL cl_user_overview_set_follow_pic()

   #讀入ref值(單頭)
   #add-point:show段reference

   CALL s_aooi200_get_slip_desc(g_sfda_m.sfdadocno)
        RETURNING g_sfda_m.oobal004
   DISPLAY BY NAME g_sfda_m.oobal004
   
   #部门
   CALL asft310_sfda003_ref(g_sfda_m.sfda003) RETURNING g_sfda_m.sfda003_desc  #160914-00019#1
   DISPLAY BY NAME g_sfda_m.sfda003_desc

   #人员姓名
   CALL s_desc_get_person_desc(g_sfda_m.sfda004) RETURNING g_sfda_m.sfda004_desc
   DISPLAY BY NAME g_sfda_m.sfda004_desc

   #人员姓名
   CALL s_desc_get_person_desc(g_sfda_m.sfdaownid) RETURNING g_sfda_m.sfdaownid_desc
   DISPLAY BY NAME g_sfda_m.sfdaownid_desc

   CALL s_desc_get_department_desc(g_sfda_m.sfdaowndp) RETURNING g_sfda_m.sfdaowndp_desc
   DISPLAY BY NAME g_sfda_m.sfdaowndp_desc

   #人员姓名
   CALL s_desc_get_person_desc(g_sfda_m.sfdacrtid) RETURNING g_sfda_m.sfdacrtid_desc
   DISPLAY BY NAME g_sfda_m.sfdacrtid_desc

   CALL s_desc_get_department_desc(g_sfda_m.sfdacrtdp) RETURNING g_sfda_m.sfdacrtdp_desc
   DISPLAY BY NAME g_sfda_m.sfdacrtdp_desc

   #人员姓名
   CALL s_desc_get_person_desc(g_sfda_m.sfdamodid) RETURNING g_sfda_m.sfdamodid_desc
   DISPLAY BY NAME g_sfda_m.sfdamodid_desc

   #人员姓名
   CALL s_desc_get_person_desc(g_sfda_m.sfdacnfid) RETURNING g_sfda_m.sfdacnfid_desc
   DISPLAY BY NAME g_sfda_m.sfdacnfid_desc

   #人员姓名
   CALL s_desc_get_person_desc(g_sfda_m.sfdapstid) RETURNING g_sfda_m.sfdapstid_desc
   DISPLAY BY NAME g_sfda_m.sfdapstid_desc
   
   
   CALL asft310_show_sfda_ooff013()   #add 141222备注说明
   #end add-point

   #將資料輸出到畫面上
   DISPLAY BY NAME g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,
       g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,g_sfda_m.sfda005,
       g_sfda_m.sfda015,g_sfda_m.sfda014,
       g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,g_sfda_m.sfdaowndp_desc,
       g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,
       g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,
       g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt

   #顯示狀態(stus)圖片
   CASE g_sfda_m.sfdastus
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")  #unconfirmed
      WHEN "X"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      WHEN "S"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
      WHEN "W"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
      WHEN "D"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
   END CASE

   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()

   #讀入ref值(單身)
   #CALL asft310_detail_show() mark 150109 提高效能

END FUNCTION

PRIVATE FUNCTION asft310_reproduce()
   {<Local define>}
   DEFINE l_newno     LIKE sfda_t.sfdadocno
   DEFINE l_oldno     LIKE sfda_t.sfdadocno
   DEFINE l_master    RECORD LIKE sfda_t.*
   DEFINE l_detail    RECORD LIKE sfdb_t.*
   DEFINE l_detail2    RECORD LIKE sfdc_t.*
   DEFINE l_detail3    RECORD LIKE sfde_t.*
   DEFINE l_detail4    RECORD LIKE inao_t.*
   DEFINE l_detail5    RECORD LIKE sfdf_t.*
   DEFINE l_detail6    RECORD LIKE sfdd_t.*
   DEFINE l_cnt       LIKE type_t.num5
   {</Local define>}

   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF

   IF g_sfda_m.sfdadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   LET g_sfdadocno_t = g_sfda_m.sfdadocno

   LET g_sfda_m.sfdadocno = ""

   CALL asft310_set_entry('a')
   CALL asft310_set_no_entry('a')

   CALL cl_set_head_visible("","YES")

   #公用欄位給予預設值
   #此段落由子樣板a14產生
   LET g_sfda_m.sfdaownid = g_user
   LET g_sfda_m.sfdaowndp = g_dept
   LET g_sfda_m.sfdacrtid = g_user
   LET g_sfda_m.sfdacrtdp = g_dept
   LET g_sfda_m.sfdacrtdt = cl_get_current()
   LET g_sfda_m.sfdamodid = ""
   LET g_sfda_m.sfdamoddt = ""
   LET g_sfda_m.sfdacnfid = ""
   LET g_sfda_m.sfdacnfdt = ""
   LET g_sfda_m.sfdapstid = ""
   LET g_sfda_m.sfdapstdt = ""
   LET g_sfda_m.sfdadocdt = g_today
   LET g_sfda_m.sfda001   = g_today
   LET g_sfda_m.sfda015   = "01"  #人工输入
   LET g_sfda_m.sfda014   = ""
   LET g_sfda_m.sfdastus  = "N"

   CALL asft310_input("r")

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

   LET g_state = "Y"

   CALL asft310_set_act_visible()     #151217-00023#5 add
   CALL asft310_set_act_no_visible()  #151217-00023#5 add

   LET g_wc = g_wc,
              " OR (",
              " sfdadocno = '", g_sfda_m.sfdadocno CLIPPED, "' "
              , ") "
              
   #170217-00024#1-(S)-add
   #組合新增資料的條件
   LET g_add_browse = " sfdaent = '" ||g_enterprise|| "' AND",
		      		    " sfdadocno = '", g_sfda_m.sfdadocno, "' "     
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL asft310_browser_fill("")
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   #170217-00024#1-(E)-add           

END FUNCTION

PRIVATE FUNCTION asft310_detail_reproduce()
   {<Local define>}
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE sfdb_t.*
   DEFINE l_detail2    RECORD LIKE sfdc_t.*
   DEFINE l_detail3    RECORD LIKE sfde_t.*
   DEFINE l_detail4    RECORD LIKE inao_t.*
   DEFINE l_detail5    RECORD LIKE sfdf_t.*
   DEFINE l_detail6    RECORD LIKE sfdd_t.*
   DEFINE l_detail7    RECORD LIKE sfdd_t.*
   {</Local define>}

   CALL s_transaction_begin()

   LET ld_date = cl_get_current()

   DROP TABLE asft310_detail

   #CREATE TEMP TABLE
   LET ls_sql = "CREATE GLOBAL TEMPORARY TABLE asft310_detail AS ",
                "SELECT * FROM sfdb_t "
   PREPARE repro_tbl FROM ls_sql
   EXECUTE repro_tbl
   FREE repro_tbl

   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO asft310_detail
   SELECT * FROM sfdb_t
    WHERE sfdbent = g_enterprise 
      AND sfdbdocno = g_sfdadocno_t

   #將key修正為調整後
   UPDATE asft310_detail
      #更新key欄位
      SET sfdbdocno = g_sfda_m.sfdadocno

      #更新共用欄位



   #將資料塞回原table
   INSERT INTO sfdb_t SELECT * FROM asft310_detail
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "reproduce"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN
   END IF



   #刪除TEMP TABLE
   DROP TABLE asft310_detail
   #CREATE TEMP TABLE
   LET ls_sql =
      "CREATE GLOBAL TEMPORARY TABLE asft310_detail AS ",
      "SELECT * FROM sfdc_t "
   PREPARE repro_tbl2 FROM ls_sql
   EXECUTE repro_tbl2
   FREE repro_tbl2
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO asft310_detail
   SELECT * FROM sfdc_t
    WHERE sfdcent = g_enterprise AND sfdcdocno = g_sfdadocno_t
   #將key修正為調整後
   UPDATE asft310_detail SET sfdcdocno = g_sfda_m.sfdadocno
   #將資料塞回原table
   INSERT INTO sfdc_t SELECT * FROM asft310_detail

   #刪除TEMP TABLE
   DROP TABLE asft310_detail
   #CREATE TEMP TABLE
   LET ls_sql =
      "CREATE GLOBAL TEMPORARY TABLE asft310_detail AS ",
      "SELECT * FROM sfde_t "
   PREPARE repro_tbl3 FROM ls_sql
   EXECUTE repro_tbl3
   FREE repro_tbl3
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO asft310_detail
   SELECT * FROM sfde_t
    WHERE sfdeent = g_enterprise AND sfdedocno = g_sfdadocno_t
   #將key修正為調整後
   UPDATE asft310_detail SET sfdedocno = g_sfda_m.sfdadocno
   #將資料塞回原table
   INSERT INTO sfde_t SELECT * FROM asft310_detail
   
   #mark 批序号不适合用于赋值，不会有同批同序的多次发货退，且唯一性管控检核也不好做
   ##刪除TEMP TABLE
   #DROP TABLE asft310_detail
   ##CREATE TEMP TABLE
   #LET ls_sql =
   #   "CREATE GLOBAL TEMPORARY TABLE asft310_detail AS ",
   #   "SELECT * FROM inao_t "
   #PREPARE repro_tbl4 FROM ls_sql
   #EXECUTE repro_tbl4
   #FREE repro_tbl4
   #
   ##將符合條件的資料丟入TEMP TABLE
   #INSERT INTO asft310_detail
   #SELECT * FROM inao_t
   # WHERE inaoent = g_enterprise AND inaosite = g_site AND inaodocno = g_sfdadocno_t
   ##將key修正為調整後
   #UPDATE asft310_detail SET inaodocno = g_sfda_m.sfdadocno
   ##將資料塞回原table
   #INSERT INTO inao_t SELECT * FROM asft310_detail

   #刪除TEMP TABLE
   DROP TABLE asft310_detail
   #CREATE TEMP TABLE
   LET ls_sql =
      "CREATE GLOBAL TEMPORARY TABLE asft310_detail AS ",
      "SELECT * FROM sfdf_t "
   PREPARE repro_tbl5 FROM ls_sql
   EXECUTE repro_tbl5
   FREE repro_tbl5
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO asft310_detail
   SELECT * FROM sfdf_t
    WHERE sfdfent = g_enterprise AND sfdfdocno = g_sfdadocno_t
   #將key修正為調整後
   UPDATE asft310_detail SET sfdfdocno = g_sfda_m.sfdadocno
   #將資料塞回原table
   INSERT INTO sfdf_t SELECT * FROM asft310_detail

   #刪除TEMP TABLE
   DROP TABLE asft310_detail
   #CREATE TEMP TABLE
   LET ls_sql =
      "CREATE GLOBAL TEMPORARY TABLE asft310_detail AS ",
      "SELECT * FROM sfdd_t "
   PREPARE repro_tbl6 FROM ls_sql
   EXECUTE repro_tbl6
   FREE repro_tbl6
   #將符合條件的資料丟入TEMP TABLE
   INSERT INTO asft310_detail
   SELECT * FROM sfdd_t
    WHERE sfddent = g_enterprise AND sfdddocno = g_sfdadocno_t
   #將key修正為調整後
   UPDATE asft310_detail SET sfdddocno = g_sfda_m.sfdadocno
   #將資料塞回原table
   INSERT INTO sfdd_t SELECT * FROM asft310_detail

   #刪除TEMP TABLE
   DROP TABLE asft310_detail

   #多語言複製段落


   CALL s_transaction_end('Y','0')

   #已新增完, 調整資料內容(修改時使用)
   LET g_sfdadocno_t = g_sfda_m.sfdadocno

   DROP TABLE asft310_detail

END FUNCTION

PRIVATE FUNCTION asft310_delete()
   {<Local define>}
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   {</Local define>}
   DEFINE l_sfda014   LIKE sfda_t.sfda014
   DEFINE l_sfda015   LIKE sfda_t.sfda015

   IF g_sfda_m.sfdadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   SELECT UNIQUE sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,sfdaownid,sfdaowndp,
                 sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,sfdapstid,sfdapstdt
    INTO g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda004,
         g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,
         g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,
         g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt
    FROM sfda_t
   WHERE sfdaent = g_enterprise AND sfdadocno = g_sfda_m.sfdadocno
   
   #161208-00061#1-S
   #IF g_sfda_m.sfdastus != 'N' THEN
   #   #此筆資料狀態不為'N.未確認',不可對此單據資料進行刪除
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = "art-00031"
   #   LET g_errparam.extend = ""
   #   LET g_errparam.popup = FALSE
   #   CALL cl_err()
   #
   #   RETURN
   #END IF
   #161208-00061#1-E

   CALL s_transaction_begin()

   OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN asft310_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   FETCH asft310_cl INTO g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,
       g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,
       g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,g_sfda_m.sfdaowndp_desc,
       g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,
       g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,
       g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt
        #鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_sfda_m.sfdadocno
      LET g_errparam.popup = FALSE
      CALL cl_err()
          #資料被他人LOCK
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   #160818-00017#36-s
   #檢查是否允許此動作
   IF NOT asft310_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   #160818-00017#36-e
   CALL asft310_show()

   #IF NOT cl_ask_delete() THEN             #確認一下
   IF cl_ask_del_master() THEN              #確認一下


      #INITIALIZE g_doc.* TO NULL
      #LET g_doc.column1 = "sfdadocno"
      #LET g_doc.value1 = g_sfda_m.sfdadocno
      #CALL cl_doc_remove()
      #刪除相關文件
      #LET g_pk_array[1].values = g_enterprise
      #LET g_pk_array[1].column = "sfdaent"
      #LET g_pk_array[2].values = g_sfda_m.sfdadocno
      #LET g_pk_array[2].column = "sfdadocno"
      CALL asft310_set_pk_array()
      CALL cl_doc_remove()

      #資料備份
      LET g_sfdadocno_t = g_sfda_m.sfdadocno


      #更新下阶料报废上的退料单号
      SELECT sfda014,sfda015 INTO l_sfda014,l_sfda015
        FROM sfda_t
       WHERE sfdaent   = g_enterprise
         AND sfdadocno = g_sfda_m.sfdadocno
      IF l_sfda015 = '04' THEN
         UPDATE sfja_t SET sfja005 = NULL
          WHERE sfjaent   = g_enterprise
            AND sfjadocno = l_sfda014
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'upd sfja'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END IF


      DELETE FROM sfda_t
       WHERE sfdaent = g_enterprise AND sfdadocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = g_sfda_m.sfdadocno
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #add-point:單頭刪除後
      IF NOT s_aooi200_del_docno(g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #end add-point

      DELETE FROM sfdb_t
       WHERE sfdbent = g_enterprise AND sfdbdocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdb_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      DELETE FROM sfdc_t
       WHERE sfdcent = g_enterprise AND sfdcdocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdc_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      DELETE FROM sfde_t
       WHERE sfdeent = g_enterprise AND sfdedocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfde_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      DELETE FROM sfdf_t
       WHERE sfdfent = g_enterprise AND sfdfdocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdf_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      DELETE FROM sfdd_t
       WHERE sfddent = g_enterprise AND sfdddocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdd_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      #add 141222
      #删除备注--单头
      DELETE FROM ooff_t
       WHERE ooffent = g_enterprise
         AND ooff001 = '6'
         AND ooff002 = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "DELETE ooff_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF

      #删除备注--单身sfdd,sfdc
      DELETE FROM ooff_t
       WHERE ooffent = g_enterprise
         AND ooff001 = '7'
         AND ooff002 = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "DELETE ooff_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #add 141222 end

      #add 150831 --begin
      DELETE FROM inao_t
       WHERE inaoent = g_enterprise AND inaosite = g_site AND inaodocno = g_sfda_m.sfdadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdc_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #add 150831 --end

      #倒扣料需要更新sfea005入库单
      IF g_sfda_m.sfda002 = '14' THEN
         UPDATE sfea_t SET sfea005 = ''
          WHERE sfeaent = g_enterprise
            AND sfeasite= g_site
            AND sfea005 = g_sfda_m.sfdadocno
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'upd sfea'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         
         #160128-00023#1---add---begin---
         UPDATE pmds_t SET pmds058 = ''
           WHERE pmdsent = g_enterprise
             AND pmdssite = g_site
             AND pmds058 = g_sfda_m.sfdadocno
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = 'upd sfea'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
         #160128-00023#1---add---end---
      END IF
      
      
      CLEAR FORM
      CALL g_sfdb_d.clear()
      CALL g_sfdc_d.clear()
      CALL g_sfde_d.clear()
      CALL g_sfdc4_d.clear()
      CALL g_sfdf_d.clear()
      CALL g_sfdd_d.clear()
      CALL g_inao_d.clear() #add 150831
      CALL g_inao_d2.clear() #add 150831

      CALL asft310_ui_browser_refresh()
      CALL asft310_ui_headershow()
      CALL asft310_ui_detailshow()

      IF g_browser_cnt > 0 THEN
         CALL asft310_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
      ELSE
         #LET g_wc = " 1=1"
         #CALL asft310_browser_fill("F")
         CLEAR FORM
      END IF
   END IF

   #多語言刪除
   CLOSE asft310_cl
   CALL s_transaction_end('Y','0')

   #流程通知預埋點-D
   CALL cl_flow_notify(g_sfda_m.sfdadocno,'D')

END FUNCTION

PRIVATE FUNCTION asft310_b_fill()
   CALL asft310_b_fill_sfdb()
   CALL asft310_b_fill_sfdc()
   CALL asft310_b_fill_sfde()
END FUNCTION

PRIVATE FUNCTION asft310_delete_b(ps_table,ps_keys_bak,ps_page)
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num5

   ##判斷是否是同一群組的table
   #LET ls_group = "'1',"
   #IF ls_group.getIndexOf(ps_page,1) > 0 THEN
   #   DELETE FROM sfdb_t
   #    WHERE sfdbent = g_enterprise AND
   #      sfdbdocno = ps_keys_bak[1] AND sfdb001 = ps_keys_bak[2] AND sfdb002 = ps_keys_bak[3] AND sfdb003 = ps_keys_bak[4] AND sfdb004 = ps_keys_bak[5] AND sfdb005 = ps_keys_bak[6]
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("",SQLCA.sqlcode,0)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = ""
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #      RETURN FALSE
   #   END IF
   #END IF

   #LET ls_group = "'2','4',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 THEN
   #   DELETE FROM sfdc_t
   #    WHERE sfdcent = g_enterprise AND
   #      sfdcdocno = ps_keys_bak[1] AND sfdcseq = ps_keys_bak[2]
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("sfdc_t",SQLCA.sqlcode,0)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "sfdc_t"
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #      RETURN FALSE
   #   END IF
   #END IF

   #LET ls_group = "'3',"
   ##判斷是否是同一群組的table2
   #IF ls_group.getIndexOf(ps_page,1) > 0 THEN
   #   DELETE FROM sfdf_t
   #    WHERE sfdfent = g_enterprise AND sfdfdocno = ps_keys_bak[1] AND sfdfseq = ps_keys_bak[2]
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("sfdf_t",SQLCA.sqlcode,0)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "sfdf_t"
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #      RETURN FALSE
   #   END IF
   #END IF

   #LET ls_group = "'2','4',"
   ##判斷是否是同一群組的table2
   #IF ls_group.getIndexOf(ps_page,1) > 0 THEN
   #   DELETE FROM sfdd_t
   #    WHERE sfddent = g_enterprise AND sfdddocno = ps_keys_bak[1] AND sfddseq = ps_keys_bak[2]
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("sfdd_t",SQLCA.sqlcode,0)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "sfdd_t"
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #      RETURN FALSE
   #   END IF
   #END IF
   
   #RETURN TRUE
   
END FUNCTION

PRIVATE FUNCTION asft310_insert_b(ps_table,ps_keys,ps_page)
   {<Local define>}
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   {</Local define>}

   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      IF cl_null(ps_keys[3]) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00179'
         LET g_errparam.extend = ps_keys[2]
         LET g_errparam.popup = TRUE
         CALL cl_err()

      END IF
      IF cl_null(ps_keys[4]) THEN LET ps_keys[4] = ' ' END IF
      IF cl_null(ps_keys[5]) THEN LET ps_keys[5] = ' ' END IF
      IF cl_null(ps_keys[6]) THEN LET ps_keys[6] = ' ' END IF
      INSERT INTO sfdb_t
                  (sfdbent, sfdbsite,
                   sfdbdocno,
                   sfdb001,sfdb002,sfdb003,sfdb004,sfdb005
                   ,sfdb006,sfdb007,sfdb008)
            VALUES(g_enterprise, g_site,
                   ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5],ps_keys[6]
                   ,g_sfdb_d[g_detail_idx].sfdb006,g_sfdb_d[g_detail_idx].sfdb007,g_sfdb_d[g_detail_idx].sfdb008)
      IF SQLCA.sqlcode THEN
         ##CALL cl_err("sfdb_t",SQLCA.sqlcode,0)
         #INITIALIZE g_errparam TO NULL
         #LET g_errparam.code = SQLCA.sqlcode
         #LET g_errparam.extend = "sfdb_t"
         #LET g_errparam.popup = FALSE
         #CALL cl_err()
         RETURN
      END IF
   END IF

   LET ls_group = "'2','4',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc005) THEN LET g_sfdc_d[g_detail_idx].sfdc005 = ' ' END IF  #特征
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc012) THEN LET g_sfdc_d[g_detail_idx].sfdc012 = ' ' END IF
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc013) THEN LET g_sfdc_d[g_detail_idx].sfdc013 = ' ' END IF
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc014) THEN LET g_sfdc_d[g_detail_idx].sfdc014 = ' ' END IF
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc016) THEN LET g_sfdc_d[g_detail_idx].sfdc016 = ' ' END IF
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc010) THEN LET g_sfdc_d[g_detail_idx].sfdc010 = 0 END IF #参考单位需求数量
      IF cl_null(g_sfdc_d[g_detail_idx].sfdc011) THEN LET g_sfdc_d[g_detail_idx].sfdc011 = 0 END IF #参考单位实际数量
      #150115 add 单位取位
      CALL s_aooi250_get_msg(g_sfdc_d[g_detail_idx].sfdc006) RETURNING l_success,g_ooca002,g_ooca004
      IF l_success THEN
         #151118-00016 by whitney modify start g_ooca004-->'4'
         CALL s_num_round('4',g_sfdc_d[g_detail_idx].sfdc007,g_ooca002) RETURNING g_sfdc_d[g_detail_idx].sfdc007
         CALL s_num_round('4',g_sfdc_d[g_detail_idx].sfdc008,g_ooca002) RETURNING g_sfdc_d[g_detail_idx].sfdc008
         #151118-00016 by whitney modify end
      END IF
      IF NOT cl_null(g_sfdc_d[g_detail_idx].sfdc009) THEN
         CALL s_aooi250_get_msg(g_sfdc_d[g_detail_idx].sfdc009) RETURNING l_success,g_ooca002,g_ooca004
         IF l_success THEN
            #151118-00016 by whitney modify start g_ooca004-->'4'
            CALL s_num_round('4',g_sfdc_d[g_detail_idx].sfdc010,g_ooca002) RETURNING g_sfdc_d[g_detail_idx].sfdc010
            CALL s_num_round('4',g_sfdc_d[g_detail_idx].sfdc011,g_ooca002) RETURNING g_sfdc_d[g_detail_idx].sfdc011
            #151118-00016 by whitney modify end
         END IF
      END IF
      #150115 add end
      INSERT INTO sfdc_t(sfdcent, sfdcsite,sfdcdocno,sfdcseq,
                         sfdc001,sfdc002,sfdc003,
                         sfdc004,sfdc005,sfdc006,
                         sfdc007,sfdc008,sfdc009,
                         sfdc010,sfdc011,sfdc012,
                         sfdc013,sfdc014,sfdc016,
                         sfdc015,sfdc017)
            VALUES(g_enterprise, g_site,ps_keys[1],ps_keys[2],
                   g_sfdc_d[g_detail_idx].sfdc001,g_sfdc_d[g_detail_idx].sfdc002,g_sfdc_d[g_detail_idx].sfdc003,
                   g_sfdc_d[g_detail_idx].sfdc004,g_sfdc_d[g_detail_idx].sfdc005,g_sfdc_d[g_detail_idx].sfdc006,
                   g_sfdc_d[g_detail_idx].sfdc007,g_sfdc_d[g_detail_idx].sfdc008,g_sfdc_d[g_detail_idx].sfdc009,
                   g_sfdc_d[g_detail_idx].sfdc010,g_sfdc_d[g_detail_idx].sfdc011,g_sfdc_d[g_detail_idx].sfdc012,
                   g_sfdc_d[g_detail_idx].sfdc013,g_sfdc_d[g_detail_idx].sfdc014,g_sfdc_d[g_detail_idx].sfdc016,
                   g_sfdc_d[g_detail_idx].sfdc015,g_sfdc_d[g_detail_idx].sfdc017)
      IF SQLCA.sqlcode THEN
         ##CALL cl_err("sfdc_t",SQLCA.sqlcode,0)
         #INITIALIZE g_errparam TO NULL
         #LET g_errparam.code = SQLCA.sqlcode
         #LET g_errparam.extend = "sfdc_t"
         #LET g_errparam.popup = FALSE
         #CALL cl_err()
         RETURN
      END IF
   END IF

   #LET ls_group = "'3',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 THEN
   #   INSERT INTO sfde_t
   #               (sfdeent, sfdesite,
   #                sfdedocno,
   #                sfdeseq
   #                ,sfde001,sfde002,sfde009,sfde003,sfde004,sfde005,sfde006,sfde007,sfde008,sfde010)
   #         VALUES(g_enterprise, g_site,
   #                ps_keys[1],ps_keys[2]
   #                ,g_sfde_d[g_detail_idx].sfde001,g_sfde_d[g_detail_idx].sfde002,g_sfde_d[g_detail_idx].sfde009,
   #                    g_sfde_d[g_detail_idx].sfde003,g_sfde_d[g_detail_idx].sfde004,g_sfde_d[g_detail_idx].sfde005,
   #                    g_sfde_d[g_detail_idx].sfde006,g_sfde_d[g_detail_idx].sfde007,g_sfde_d[g_detail_idx].sfde008,
   #                    g_sfde_d[g_detail_idx].sfde010)
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("sfde_t",SQLCA.sqlcode,0)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "sfde_t"
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #   END IF
   #END IF
#
   #LET ls_group = "'7',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 THEN
   #   INSERT INTO inao_t
   #               (inaoent, inaosite,
   #                inaodocno,
   #                inaoseq,inaoseq1,inaoseq2,inao000
   #                ,inao001,inao008,inao009,inao010,inao012)
   #         VALUES(g_enterprise, g_site,
   #                ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5]
   #                ,g_inao_d[g_detail_idx].inao001,g_inao_d[g_detail_idx].inao008,g_inao_d[g_detail_idx].inao009,
   #                    g_inao_d[g_detail_idx].inao010,g_inao_d[g_detail_idx].inao012)
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("inao_t",SQLCA.sqlcode,0)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "inao_t"
   #      LET g_errparam.popup = FALSE
   #      CALL cl_err()
   #   END IF
   #END IF

   LET ls_group = "'5',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      IF cl_null(g_sfdf_d[g_detail_idx2].sfdf013) THEN LET g_sfdf_d[g_detail_idx2].sfdf013 = ' ' END IF  #产品特征
      IF cl_null(g_sfdf_d[g_detail_idx2].sfdf003) THEN LET g_sfdf_d[g_detail_idx2].sfdf003 = ' ' END IF
      IF cl_null(g_sfdf_d[g_detail_idx2].sfdf004) THEN LET g_sfdf_d[g_detail_idx2].sfdf004 = ' ' END IF
      IF cl_null(g_sfdf_d[g_detail_idx2].sfdf005) THEN LET g_sfdf_d[g_detail_idx2].sfdf005 = ' ' END IF
      IF cl_null(g_sfdf_d[g_detail_idx2].sfdf010) THEN LET g_sfdf_d[g_detail_idx2].sfdf010 = ' ' END IF
      IF cl_null(g_sfdf_d[g_detail_idx2].sfdf009) THEN LET g_sfdf_d[g_detail_idx2].sfdf009 = 0 END IF #参考单位数量
      #150115 add 单位取位
      CALL s_aooi250_get_msg(g_sfdf_d[g_detail_idx2].sfdf006) RETURNING l_success,g_ooca002,g_ooca004
      IF l_success THEN
         CALL s_num_round('4',g_sfdf_d[g_detail_idx2].sfdf007,g_ooca002) RETURNING g_sfdf_d[g_detail_idx2].sfdf007  #151118-00016 by whitney modify g_ooca004-->'4'
      END IF
      IF NOT cl_null(g_sfdf_d[g_detail_idx2].sfdf008) THEN
         CALL s_aooi250_get_msg(g_sfdf_d[g_detail_idx2].sfdf008) RETURNING l_success,g_ooca002,g_ooca004
         IF l_success THEN
            CALL s_num_round('4',g_sfdf_d[g_detail_idx2].sfdf009,g_ooca002) RETURNING g_sfdf_d[g_detail_idx2].sfdf009  #151118-00016 by whitney modify g_ooca004-->'4'
         END IF
      END IF
      #150115 add end
      INSERT INTO sfdf_t
                  (sfdfent, sfdfsite,
                   sfdfdocno,sfdfseq,
                   sfdfseq1
                   ,sfdf001,sfdf013,sfdf002,sfdf003,sfdf004,sfdf005,sfdf010,sfdf006,sfdf007,sfdf008,sfdf009,sfdf011,sfdf012)
            VALUES(g_enterprise, g_site,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_sfdf_d[g_detail_idx2].sfdf001,g_sfdf_d[g_detail_idx2].sfdf013,g_sfdf_d[g_detail_idx2].sfdf002,g_sfdf_d[g_detail_idx2].sfdf003,
                       g_sfdf_d[g_detail_idx2].sfdf004,g_sfdf_d[g_detail_idx2].sfdf005,g_sfdf_d[g_detail_idx2].sfdf010,
                       g_sfdf_d[g_detail_idx2].sfdf006,g_sfdf_d[g_detail_idx2].sfdf007,g_sfdf_d[g_detail_idx2].sfdf008,
                       g_sfdf_d[g_detail_idx2].sfdf009,g_sfdf_d[g_detail_idx2].sfdf011,g_sfdf_d[g_detail_idx2].sfdf012)
      IF SQLCA.sqlcode THEN
         ##CALL cl_err("sfdf_t",SQLCA.sqlcode,0)
         #INITIALIZE g_errparam TO NULL
         #LET g_errparam.code = SQLCA.sqlcode
         #LET g_errparam.extend = "sfdf_t"
         #LET g_errparam.popup = FALSE
         #CALL cl_err()
         RETURN
      END IF
   END IF

   LET ls_group = "'6',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      IF cl_null(g_sfdd_d[g_detail_idx2].sfdd013) THEN LET g_sfdd_d[g_detail_idx2].sfdd013 = ' ' END IF  #产品特征
      IF cl_null(g_sfdd_d[g_detail_idx2].sfdd003) THEN LET g_sfdd_d[g_detail_idx2].sfdd003 = ' ' END IF
      IF cl_null(g_sfdd_d[g_detail_idx2].sfdd004) THEN LET g_sfdd_d[g_detail_idx2].sfdd004 = ' ' END IF
      IF cl_null(g_sfdd_d[g_detail_idx2].sfdd005) THEN LET g_sfdd_d[g_detail_idx2].sfdd005 = ' ' END IF
      IF cl_null(g_sfdd_d[g_detail_idx2].sfdd010) THEN LET g_sfdd_d[g_detail_idx2].sfdd010 = ' ' END IF
      IF cl_null(g_sfdd_d[g_detail_idx2].sfdd009) THEN LET g_sfdd_d[g_detail_idx2].sfdd009 = 0 END IF #参考单位数量
      #150115 add 单位取位
      CALL s_aooi250_get_msg(g_sfdd_d[g_detail_idx2].sfdd006) RETURNING l_success,g_ooca002,g_ooca004
      IF l_success THEN
         CALL s_num_round('4',g_sfdd_d[g_detail_idx2].sfdd007,g_ooca002) RETURNING g_sfdd_d[g_detail_idx2].sfdd007  #151118-00016 by whitney modify g_ooca004-->'4'
      END IF
      IF NOT cl_null(g_sfdd_d[g_detail_idx2].sfdd008) THEN
         CALL s_aooi250_get_msg(g_sfdd_d[g_detail_idx2].sfdd008) RETURNING l_success,g_ooca002,g_ooca004
         IF l_success THEN
            CALL s_num_round('4',g_sfdd_d[g_detail_idx2].sfdd009,g_ooca002) RETURNING g_sfdd_d[g_detail_idx2].sfdd009  #151118-00016 by whitney modify g_ooca004-->'4'
         END IF
      END IF
      #150115 add end
      INSERT INTO sfdd_t
                  (sfddent, sfddsite,sfdddocno,sfddseq,sfddseq1
                   ,sfdd001,sfdd013,sfdd002,sfdd003,sfdd004,sfdd005,sfdd010,sfdd006,sfdd007,sfdd008,sfdd009,sfdd011,sfdd012,sfdd014,sfdd015)   #160408-00035#7 add sfdd014,sfdd015
            VALUES(g_enterprise, g_site,ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_sfdd_d[g_detail_idx2].sfdd001,g_sfdd_d[g_detail_idx2].sfdd013,g_sfdd_d[g_detail_idx2].sfdd002,g_sfdd_d[g_detail_idx2].sfdd003,
                       g_sfdd_d[g_detail_idx2].sfdd004,g_sfdd_d[g_detail_idx2].sfdd005,g_sfdd_d[g_detail_idx2].sfdd010,
                       g_sfdd_d[g_detail_idx2].sfdd006,g_sfdd_d[g_detail_idx2].sfdd007,g_sfdd_d[g_detail_idx2].sfdd008,
                       g_sfdd_d[g_detail_idx2].sfdd009,g_sfdd_d[g_detail_idx2].sfdd011,g_sfdd_d[g_detail_idx2].sfdd012,g_sfdd_d[g_detail_idx2].sfdd014,g_sfdd_d[g_detail_idx2].sfdd015)   #160408-00035#7 add sfdd014,sfdd015
      IF SQLCA.sqlcode THEN
         ##CALL cl_err("sfdd_t",SQLCA.sqlcode,0)
         #INITIALIZE g_errparam TO NULL
         #LET g_errparam.code = SQLCA.sqlcode
         #LET g_errparam.extend = "sfdd_t"
         #LET g_errparam.popup = FALSE
         #CALL cl_err()
         RETURN
      END IF
   END IF

END FUNCTION

PRIVATE FUNCTION asft310_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   {<Local define>}
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num5
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   {</Local define>}
   
   ##判斷key是否有改變
   #LET lb_chk = TRUE
   #FOR li_idx = 1 TO ps_keys.getLength()
   #   IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
   #      LET lb_chk = FALSE
   #      EXIT FOR
   #   END IF
   #END FOR
   #
   ##不需要做處理
   #IF lb_chk THEN
   #   RETURN
   #END IF
   #
   ##判斷是否是同一群組的table
   #LET ls_group = "'1',"
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfdb_t" THEN
   #   UPDATE sfdb_t
   #      SET (sfdbdocno,
   #           sfdb001,sfdb002,sfdb003,sfdb004,sfdb005
   #           ,sfdb006,sfdb007,sfdb008)
   #           =
   #          (ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5],ps_keys[6]
   #           ,g_sfdb_d[g_detail_idx].sfdb006,g_sfdb_d[g_detail_idx].sfdb007,g_sfdb_d[g_detail_idx].sfdb008)
   #
   #      WHERE sfdbent = g_enterprise AND sfdbsite = g_site AND sfdbdocno = ps_keys_bak[1] AND sfdb001 = ps_keys_bak[2] AND sfdb002 = ps_keys_bak[3] AND sfdb003 = ps_keys_bak[4] AND sfdb004 = ps_keys_bak[5] AND sfdb005 = ps_keys_bak[6]
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfdb_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfdb_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfdb_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfdb_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #END IF
   #
   #LET ls_group = "'2','4',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfdc_t" THEN
   #   UPDATE sfdc_t
   #      SET (sfdcdocno,
   #           sfdcseq
   #           ,sfdc001,sfdc002,sfdc003,sfdc004,sfdc005,sfdc006,sfdc007,sfdc008,sfdc009,sfdc010,sfdc011,sfdc012,sfdc013,sfdc014,sfdc016,sfdc015,sfdc017,sfdc001,sfdc002,sfdc003,sfdc004,sfdc005,sfdc006,sfdc007,sfdc008,sfdc009,sfdc010,sfdc011,sfdc012,sfdc013,sfdc014,sfdc016,sfdc015,sfdc017)
   #           =
   #          (ps_keys[1],ps_keys[2]
   #           ,g_sfdc_d[g_detail_idx].sfdc001,g_sfdc_d[g_detail_idx].sfdc002,g_sfdc_d[g_detail_idx].sfdc003,
   #               g_sfdc_d[g_detail_idx].sfdc004,g_sfdc_d[g_detail_idx].sfdc005,g_sfdc_d[g_detail_idx].sfdc006,
   #               g_sfdc_d[g_detail_idx].sfdc007,g_sfdc_d[g_detail_idx].sfdc008,g_sfdc_d[g_detail_idx].sfdc009,
   #               g_sfdc_d[g_detail_idx].sfdc010,g_sfdc_d[g_detail_idx].sfdc011,g_sfdc_d[g_detail_idx].sfdc012,
   #               g_sfdc_d[g_detail_idx].sfdc013,g_sfdc_d[g_detail_idx].sfdc014,g_sfdc_d[g_detail_idx].sfdc016,
   #               g_sfdc_d[g_detail_idx].sfdc015,g_sfdc_d[g_detail_idx].sfdc017,g_sfdc_d[g_detail_idx].sfdc001,
   #               g_sfdc_d[g_detail_idx].sfdc002,g_sfdc_d[g_detail_idx].sfdc003,g_sfdc_d[g_detail_idx].sfdc004,
   #               g_sfdc_d[g_detail_idx].sfdc005,g_sfdc_d[g_detail_idx].sfdc006,g_sfdc_d[g_detail_idx].sfdc007,
   #               g_sfdc_d[g_detail_idx].sfdc008,g_sfdc_d[g_detail_idx].sfdc009,g_sfdc_d[g_detail_idx].sfdc010,
   #               g_sfdc_d[g_detail_idx].sfdc011,g_sfdc_d[g_detail_idx].sfdc012,g_sfdc_d[g_detail_idx].sfdc013,
   #               g_sfdc_d[g_detail_idx].sfdc014,g_sfdc_d[g_detail_idx].sfdc016,g_sfdc_d[g_detail_idx].sfdc015,
   #               g_sfdc_d[g_detail_idx].sfdc017)
   #      WHERE sfdcent = g_enterprise AND sfdcsite = g_site AND sfdcdocno = ps_keys_bak[1] AND sfdcseq = ps_keys_bak[2]
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfdc_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfdc_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfdc_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfdc_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #END IF
   #
   #LET ls_group = "'3',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfde_t" THEN
   #   UPDATE sfde_t
   #      SET (sfdedocno,
   #           sfdeseq
   #           ,sfde001,sfde002,sfde009,sfde003,sfde004,sfde005,sfde006,sfde007,sfde008,sfde010)
   #           =
   #          (ps_keys[1],ps_keys[2]
   #           ,g_sfde_d[g_detail_idx].sfde001,g_sfde_d[g_detail_idx].sfde002,g_sfde_d[g_detail_idx].sfde009,
   #               g_sfde_d[g_detail_idx].sfde003,g_sfde_d[g_detail_idx].sfde004,g_sfde_d[g_detail_idx].sfde005,
   #               g_sfde_d[g_detail_idx].sfde006,g_sfde_d[g_detail_idx].sfde007,g_sfde_d[g_detail_idx].sfde008,
   #               g_sfde_d[g_detail_idx].sfde010)
   #      WHERE sfdeent = g_enterprise AND sfdesite = g_site AND sfdedocno = ps_keys_bak[1] AND sfdeseq = ps_keys_bak[2]
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfde_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfde_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfde_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfde_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #END IF
   #
   #LET ls_group = "'7',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "inao_t" THEN
   #   UPDATE inao_t
   #      SET (inaodocno,
   #           inaoseq,inaoseq1,inaoseq2,inao000
   #           ,inao001,inao008,inao009,inao010,inao012)
   #           =
   #          (ps_keys[1],ps_keys[2],ps_keys[3],ps_keys[4],ps_keys[5]
   #           ,g_inao_d[g_detail_idx].inao001,g_inao_d[g_detail_idx].inao008,g_inao_d[g_detail_idx].inao009,
   #               g_inao_d[g_detail_idx].inao010,g_inao_d[g_detail_idx].inao012)
   #      WHERE inaoent = g_enterprise AND inaosite = g_site AND inaodocno = ps_keys_bak[1] AND inaoseq = ps_keys_bak[2] AND inaoseq1 = ps_keys_bak[3] AND inaoseq2 = ps_keys_bak[4] AND inao000 = ps_keys_bak[5]
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("inao_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "inao_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("inao_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "inao_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #END IF
   #
   #
   #
   #LET ls_group = "'5',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfdf_t" THEN
   #   UPDATE sfdf_t
   #      SET (sfdfdocno,sfdfseq,
   #           sfdfseq1
   #           ,sfdf001,sfdf013,sfdf002,sfdf003,sfdf004,sfdf005,sfdf010,sfdf006,sfdf007,sfdf008,sfdf009,sfdf011,sfdf012)
   #           =
   #          (ps_keys[1],ps_keys[2],ps_keys[3]
   #           ,g_sfdf_d[g_detail_idx2].sfdf001,g_sfdf_d[g_detail_idx2].sfdf013,g_sfdf_d[g_detail_idx2].sfdf002,g_sfdf_d[g_detail_idx2].sfdf003,
   #               g_sfdf_d[g_detail_idx2].sfdf004,g_sfdf_d[g_detail_idx2].sfdf005,g_sfdf_d[g_detail_idx2].sfdf010,
   #               g_sfdf_d[g_detail_idx2].sfdf006,g_sfdf_d[g_detail_idx2].sfdf007,g_sfdf_d[g_detail_idx2].sfdf008,
   #               g_sfdf_d[g_detail_idx2].sfdf009,g_sfdf_d[g_detail_idx2].sfdf011,g_sfdf_d[g_detail_idx2].sfdf012)
   #
   #      WHERE sfdfent = g_enterprise AND sfdfsite = g_site AND sfdfdocno = ps_keys_bak[1] AND sfdfseq = ps_keys_bak[2] AND sfdfseq1 = ps_keys_bak[3]
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfdf_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfdf_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfdf_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfdf_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #END IF
   #
   #LET ls_group = "'6',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfdd_t" THEN
   #   UPDATE sfdd_t
   #      SET (sfdddocno,sfddseq,
   #           sfddseq1
   #           ,sfdd001,sfdd013,sfdd002,sfdd003,sfdd004,sfdd005,sfdd010,sfdd006,sfdd007,sfdd008,sfdd009,sfdd011,sfdd012)
   #           =
   #          (ps_keys[1],ps_keys[2],ps_keys[3]
   #           ,g_sfdd_d[g_detail_idx2].sfdd001,g_sfdd_d[g_detail_idx2].sfdd013,g_sfdd_d[g_detail_idx2].sfdd002,g_sfdd_d[g_detail_idx2].sfdd003,
   #               g_sfdd_d[g_detail_idx2].sfdd004,g_sfdd_d[g_detail_idx2].sfdd005,g_sfdd_d[g_detail_idx2].sfdd010,
   #               g_sfdd_d[g_detail_idx2].sfdd006,g_sfdd_d[g_detail_idx2].sfdd007,g_sfdd_d[g_detail_idx2].sfdd008,
   #               g_sfdd_d[g_detail_idx2].sfdd009,g_sfdd_d[g_detail_idx2].sfdd011,g_sfdd_d[g_detail_idx2].sfdd012)
   #
   #      WHERE sfddent = g_enterprise AND sfddsite = g_site AND sfdddocno = ps_keys_bak[1] AND sfddseq = ps_keys_bak[2] AND sfddseq1 = ps_keys_bak[3]
   #   #add-point:update_b段修改中
   #   
   #   #end add-point
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfdd_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfdd_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfdd_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfdd_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #   #add-point:update_b段修改後
   #   
   #   #end add-point
   #END IF
   #
   #
   #
   #LET ls_group = "'3',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfdf_t" THEN
   #   #add-point:update_b段修改前
   #   
   #   #end add-point
   #   UPDATE sfdf_t
   #      SET (sfdfdocno,sfdfseq)
   #           =
   #          (ps_keys[1],ps_keys[2])
   #      WHERE sfdfent = g_enterprise AND sfdfsite = g_site AND sfdfdocno = ps_keys_bak[1] AND sfdfseq = ps_keys_bak[2]
   #   #add-point:update_b段修改中
   #   
   #   #end add-point
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfdf_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfdf_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfdf_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfdf_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #   #add-point:update_b段修改後
   #   
   #   #end add-point
   #END IF
   #
   #LET ls_group = "'2','4',"
   ##判斷是否是同一群組的table
   #IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfdd_t" THEN
   #   #add-point:update_b段修改前
   #   
   #   #end add-point
   #   UPDATE sfdd_t
   #      SET (sfdddocno,sfddseq)
   #           =
   #          (ps_keys[1],ps_keys[2])
   #      WHERE sfddent = g_enterprise AND sfddsite = g_site AND sfdddocno = ps_keys_bak[1] AND sfddseq = ps_keys_bak[2]
   #   #add-point:update_b段修改中
   #   
   #   #end add-point
   #   CASE
   #      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
   #         #CALL cl_err("sfdd_t","std-00009",1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = "std-00009"
   #         LET g_errparam.extend = "sfdd_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      WHEN SQLCA.sqlcode #其他錯誤
   #         #CALL cl_err("sfdd_t",SQLCA.sqlcode,1)
   #         INITIALIZE g_errparam TO NULL
   #         LET g_errparam.code = SQLCA.sqlcode
   #         LET g_errparam.extend = "sfdd_t"
   #         LET g_errparam.popup = TRUE
   #         CALL cl_err()
   #         CALL s_transaction_end('N','0')
   #      OTHERWISE
   #
   #   END CASE
   #   #add-point:update_b段修改後
   #   
   #   #end add-point
   #END IF



END FUNCTION

PRIVATE FUNCTION asft310_lock_b(ps_table,ps_page)
   {<Local define>}
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   {</Local define>}

   #先刷新資料
   #CALL asft310_b_fill()

   #鎖定整組table
   #LET ls_group = "'1',"
   #僅鎖定自身table
   LET ls_group = "sfdb_t"

   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN asft310_bcl USING g_enterprise, g_site,
                             g_sfda_m.sfdadocno,g_sfdb_d[g_detail_idx].sfdb001,g_sfdb_d[g_detail_idx].sfdb002,
                             g_sfdb_d[g_detail_idx].sfdb003,g_sfdb_d[g_detail_idx].sfdb004,
                             g_sfdb_d[g_detail_idx].sfdb005
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "asft310_bcl"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN FALSE
      END IF
   END IF

   #鎖定整組table
   #LET ls_group = "'2','4',"
   #僅鎖定自身table
   LET ls_group = "sfdc_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN asft310_bcl2 USING g_enterprise, g_site,
                              g_sfda_m.sfdadocno,g_sfdc_d[g_detail_idx].sfdcseq
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "asft310_bcl2"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN FALSE
      END IF
   END IF

   #鎖定整組table
   #LET ls_group = "'3',"
   #僅鎖定自身table
   #LET ls_group = "sfde_t"
   #IF ls_group.getIndexOf(ps_table,1) THEN
   #   OPEN asft310_bcl3 USING g_enterprise, g_site,
   #                           g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("asft310_bcl3",SQLCA.sqlcode,1)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "asft310_bcl3"
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #      RETURN FALSE
   #   END IF
   #END IF

   #鎖定整組table
   #LET ls_group = "'7',"
   #僅鎖定自身table
   #LET ls_group = "inao_t"
   #IF ls_group.getIndexOf(ps_table,1) THEN
   #   OPEN asft310_bcl4 USING g_enterprise, g_site,
   #                           g_sfda_m.sfdadocno,g_inao_d[g_detail_idx].inaoseq,g_inao_d[g_detail_idx].inaoseq1,
   #                           g_inao_d[g_detail_idx].inaoseq2,g_inao_d[g_detail_idx].inao000
   #   IF SQLCA.sqlcode THEN
   #      #CALL cl_err("asft310_bcl4",SQLCA.sqlcode,1)
   #      INITIALIZE g_errparam TO NULL
   #      LET g_errparam.code = SQLCA.sqlcode
   #      LET g_errparam.extend = "asft310_bcl4"
   #      LET g_errparam.popup = TRUE
   #      CALL cl_err()
   #      RETURN FALSE
   #   END IF
   #END IF



   #鎖定整組table
   #LET ls_group = "'5',"
   #僅鎖定自身table
   LET ls_group = "sfdf_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN asft310_bcl5 USING g_enterprise, g_site,
                              g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq,
                              g_sfdf_d[g_detail_idx2].sfdfseq1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "asft310_bcl5"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN FALSE
      END IF
   END IF

   #鎖定整組table
   #LET ls_group = "'6',"
   #僅鎖定自身table
   LET ls_group = "sfdd_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN asft310_bcl6 USING g_enterprise, g_site,
                              g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,
                              g_sfdd_d[g_detail_idx2].sfddseq1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "asft310_bcl6"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN FALSE
      END IF
   END IF



   RETURN TRUE

END FUNCTION

PRIVATE FUNCTION asft310_unlock_b(ps_table,ps_page)
   {<Local define>}
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   {</Local define>}
   #add-point:unlock_b段define
   
   #end add-point

   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE asft310_bcl
   END IF

   LET ls_group = "'2','4',"
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE asft310_bcl2
   END IF

   #LET ls_group = "'3',"
   #IF ls_group.getIndexOf(ps_page,1) THEN
   #   CLOSE asft310_bcl3
   #END IF

   #LET ls_group = "'7',"
   #IF ls_group.getIndexOf(ps_page,1) THEN
   #   CLOSE asft310_bcl4
   #END IF

   LET ls_group = "'5',"
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE asft310_bcl5
   END IF

   LET ls_group = "'6',"
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE asft310_bcl6
   END IF

END FUNCTION

PRIVATE FUNCTION asft310_set_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1
   {</Local define>}
   #add-point:set_entry段define
   DEFINE l_fields      STRING
   #end add-point

   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("sfdadocno",TRUE)
      #160731-00253#1-s
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #160731-00253#1-e
      #add-point:set_entry段欄位控制
      
      #end add-point
   END IF

   #add-point:set_entry段欄位控制後
   IF NOT cl_null(g_sfda_m.sfdadocno) THEN
      LET l_fields = s_aooi200_get_doc_fields(g_site,'1',g_sfda_m.sfdadocno)
      CALL cl_set_comp_entry(l_fields,TRUE)
   END IF
   
   CALL cl_set_comp_entry("sfda002",TRUE)          {#ADP版次:1#}
   #end add-point

END FUNCTION

PRIVATE FUNCTION asft310_set_no_entry(p_cmd)
   {<Local define>}
   DEFINE p_cmd   LIKE type_t.chr1
   {</Local define>}
   #add-point:set_no_entry段define
   DEFINE l_fields      STRING
   #end add-point

   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("sfdadocno",FALSE)
      #160731-00253#1-s
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #160731-00253#1-e
      #add-point:set_no_entry段欄位控制
      
      #end add-point
   END IF

   #add-point:set_no_entry段欄位控制後
   IF NOT cl_null(g_sfda_m.sfdadocno) THEN
      LET l_fields = s_aooi200_get_doc_fields(g_site,'1',g_sfda_m.sfdadocno)
      CALL cl_set_comp_entry(l_fields,FALSE)
   END IF
   
   #160623-00014#1-mod-(S)
#   IF g_prog != 'asft310' AND g_prog != 'asft320' THEN
#      CALL cl_set_comp_entry("sfda002",FALSE)
#   END IF          {#ADP版次:1#}
   IF g_prog NOT MATCHES 'asft310' AND g_prog NOT MATCHES 'asft320' THEN
      CALL cl_set_comp_entry("sfda002",FALSE)
   END IF          {#ADP版次:1#}
   #160623-00014#1-mod-(E)
   #end add-point

END FUNCTION

PRIVATE FUNCTION asft310_default_search()
   {<Local define>}
   DEFINE li_idx  LIKE type_t.num5
   DEFINE li_cnt  LIKE type_t.num5
   DEFINE ls_wc   STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   {</Local define>}
   #add-point:default_search段define
   
   #end add-point

   #add-point:default_search段開始前
   
   #end add-point

   LET g_pagestart = 1

   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF

   #IF NOT cl_null(g_argv[1]) THEN
   #   LET ls_wc = ls_wc, " sfdadocno = '", g_argv[1], "' AND "
   #END IF
   
   #非固定参数
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " sfdadocno = '", g_argv[02], "' AND "
   END IF
   
   #非固定参数--傳單號範圍至asft310,一次查詢可查詢出多個單號資料
   IF NOT cl_null(g_argv[03]) THEN
      LET ls_wc = ls_wc,g_argv[03]," AND "
   END IF

   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      LET g_default = FALSE
      #預設查詢條件
      #mod pattern 修改调整150624
      #LET g_wc = cl_qbe_get_default_qryplan()
      #IF cl_null(g_wc) THEN
      #   LET g_wc = " 1=2"
      #END IF
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc2_table2 TO NULL
         INITIALIZE g_wc2_table3 TO NULL
         INITIALIZE g_wc2_table5 TO NULL
         INITIALIZE g_wc2_table6 TO NULL


         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "sfda_t"
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfdb_t"
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfdc_t"
                  LET g_wc2_table2 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfde_t"
                  LET g_wc2_table3 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfdf_t"
                  LET g_wc2_table5 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfdd_t"
                  LET g_wc2_table6 = la_wc[li_idx].wc


               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
            OR NOT cl_null(g_wc2_table2)
            OR NOT cl_null(g_wc2_table3)
            OR NOT cl_null(g_wc2_table5)
            OR NOT cl_null(g_wc2_table6)


            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
            END IF
            IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
            END IF
            IF g_wc2_table5 <> " 1=1" AND NOT cl_null(g_wc2_table5) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table5
            END IF
            IF g_wc2_table6 <> " 1=1" AND NOT cl_null(g_wc2_table6) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table6
            END IF


            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF

            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
      #mod pattern 修改调整150624 end
   END IF

   #add-point:default_search段結束前
   #160623-00014#1-mod-(S)
#   CASE g_prog
#      WHEN 'asft310'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
#      WHEN 'asft311'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11')"
#      WHEN 'asft312'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('12')"
#      WHEN 'asft313'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('13')"
#      WHEN 'asft314'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('14')"
#      WHEN 'asft315'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('15')"
#      WHEN 'asft320'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
#      WHEN 'asft321'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21')"
#      WHEN 'asft322'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('22')"
#      WHEN 'asft323'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('23')"
#      WHEN 'asft324'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('24')"
#      WHEN 'asft325'
#           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('25')"
#   END CASE          {#ADP版次:1#}
   CASE 
      WHEN g_prog MATCHES 'asft310'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11','12','13','14','15')"
      WHEN g_prog MATCHES 'asft311'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('11')"
      WHEN g_prog MATCHES 'asft312'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('12')"
      WHEN g_prog MATCHES 'asft313'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('13')"
      WHEN g_prog MATCHES 'asft314'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('14')"
      WHEN g_prog MATCHES 'asft315'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('15')"
      WHEN g_prog MATCHES 'asft320'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21','22','23','24','25')"
      WHEN g_prog MATCHES 'asft321'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('21')"
      WHEN g_prog MATCHES 'asft322'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('22')"
      WHEN g_prog MATCHES 'asft323'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('23')"
      WHEN g_prog MATCHES 'asft324'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('24')"
      WHEN g_prog MATCHES 'asft325'
           LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' AND sfda002 in ('25')"
   END CASE          {#ADP版次:1#}
   #160623-00014#1-mod-(E)
   #
   ##傳單號範圍至asft310,一次查詢可查詢出多個單號資料
   #IF NOT cl_null(g_argv[02]) THEN
   #   LET g_wc = g_wc," AND ",g_argv[02]
   #END IF

   #LET g_wc = g_wc CLIPPED," AND sfdasite ='",g_site,"' "
   #固定参数
   CASE g_argv[01]
      WHEN '10'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('11','12','13','14','15')"
      WHEN '11'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('11')"
      WHEN '12'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('12')"
      WHEN '13'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('13')"
      WHEN '14'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('14')"
      WHEN '15'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('15')"
      WHEN '20'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('21','22','23','24','25')"
      WHEN '21'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('21')"
      WHEN '22'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('22')"
      WHEN '23'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('23')"
      WHEN '24'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('24')"
      WHEN '25'
           LET ls_wc = ls_wc CLIPPED," AND sfda002 in ('25')"
   END CASE
   #end add-point
   
   IF g_wc.getIndexOf(" 1=2", 1) THEN  #此段版型写在最后感觉不是很好，应该写在上面的"LET g_wc = " 1=2""后面比较好
      LET g_default = TRUE
   END IF
END FUNCTION

PRIVATE FUNCTION asft310_statechange()
   {<Local define>}
   DEFINE lc_state   LIKE type_t.chr5
   DEFINE l_sfda014  LIKE sfda_t.sfda014   #liuym add 2015/3/2
   DEFINE l_sfda015  LIKE sfda_t.sfda015   #liuym add 2015/3/2
   DEFINE l_slip     LIKE ooba_t.ooba002   #151210-00012#1   
   {</Local define>}

   ERROR ""     #清空畫面右下側ERROR區塊

   IF g_sfda_m.sfdadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
   
           
   #161208-00061#1-S
   #IF g_sfda_m.sfdastus MATCHES '[X]' THEN  #已作废，不可取消作废
   IF g_sfda_m.sfdastus MATCHES '[XWD]' THEN  #已作废，不可取消作废
   #161208-00061#1-E
      #INITIALIZE g_errparam TO NULL
      #LET g_errparam.code = "asf-00380"
      #LET g_errparam.extend = ""
      #LET g_errparam.popup = FALSE
      #CALL cl_err()
      #mark 同apmt500的做法
      RETURN
   END IF
   #160818-00017#36-s
   #檢查是否允許此動作
   IF NOT asft310_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   #160818-00017#36-e
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_sfda_m.sfdastus
            WHEN "N" #未確認
               HIDE OPTION "unconfirmed"
               HIDE OPTION "posted"
               HIDE OPTION "unposted"
            WHEN "X" #作廢
               HIDE OPTION "invalid"
               HIDE OPTION "confirmed"
               HIDE OPTION "posted"
               HIDE OPTION "unposted"
            WHEN "Y" #已確認
               HIDE OPTION "confirmed"
               HIDE OPTION "invalid"
               HIDE OPTION "unposted"
            WHEN "A" #已核准
               HIDE OPTION "approved"   
            WHEN "D" #抽單         
               HIDE OPTION "withdraw"    
            WHEN "R" #已拒絕
               HIDE OPTION "rejection"       
            WHEN "W" #送簽中
               HIDE OPTION "signing"      
            WHEN "S" #已扣帳
               HIDE OPTION "posted"
               HIDE OPTION "confirmed"
               HIDE OPTION "unconfirmed"
               HIDE OPTION "invalid"
            WHEN "Z" #扣帳還原
               HIDE OPTION "unposted"
               
			#此段落由子樣板a35產生
            #狀況碼為『D.抽單』時，必須隱藏『抽單(draw_out)』按鈕
            #狀況碼為『W.已送簽』時，必須隱藏『提交(send)』按鈕
            #WHEN "D"    #D.抽單
            #   HIDE OPTION "draw_out"   #「抽單」action
            #WHEN "W"    #W.已送簽
            #   HIDE OPTION "send"       #「提交」action


         END CASE
         #add-point:menu前
         CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted,unposted",TRUE)        
         CALL cl_set_act_visible("signing,withdraw",FALSE)
         
         CASE g_sfda_m.sfdastus
            #未確認
            WHEN "N"
               CALL cl_set_act_visible("unconfirmed,posted,unposted",FALSE)               
               #161208-00061#1-S
               #需提交至BPM時，則顯示「提交」功能並隱藏「確認」功能
               #IF cl_bpm_chk() THEN
               #    CALL cl_set_act_visible("signing",TRUE)
               #    CALL cl_set_act_visible("confirmed",FALSE)
               #END IF           
               #161208-00061#1-E
            #已拒絕
            WHEN "R"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
               CALL cl_set_act_visible("confirmed,unconfirmed,posted,unposted",FALSE)
            #抽單
            WHEN "D"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
               CALL cl_set_act_visible("confirmed,unconfirmed,posted,unposted",FALSE)
            #作廢
            WHEN "X"
               CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted,unposted",FALSE)
            #已確認
            WHEN "Y"
               CALL cl_set_act_visible("invalid,confirmed,unposted",FALSE)
               
            #送簽中  
            WHEN "W"    #只能顯示抽單;其餘應用功能皆隱藏
                CALL cl_set_act_visible("withdraw",TRUE)  #抽单
                CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted,unposted",FALSE)  
            #已核准
            WHEN "A"     #只能顯示確認; 其餘應用功能皆隱藏
                CALL cl_set_act_visible("confirmed ",TRUE)
                CALL cl_set_act_visible("unconfirmed,invalid,posted,unposted",FALSE)
         
            WHEN "S" #已扣帳
                CALL cl_set_act_visible("unconfirmed,invalid,confirmed,posted",FALSE)
            #WHEN "Z" #扣帳還原
            #    CALL cl_set_act_visible("unposted",FALSE)
         END CASE
         #end add-point
	
      #ON ACTION withdraw
      #   LET lc_state = "D"
      #   #add-point:action控制
      #   #IF g_sfda_m.sfdastus MATCHES '[S]' THEN  #tmp
      #      RETURN
      #   #END IF
      #   #end add-point
      #   EXIT MENU
      ON ACTION unconfirmed
         #modify--151110-00030#1--By shiun--(S)
         LET g_action_choice="unconfirmed"   #151120 Sarah add
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制
            IF g_sfda_m.sfdastus = 'Y' THEN
               CALL s_transaction_begin()   
               CALL s_asft310_unconfirm(g_sfda_m.sfdadocno)
                    RETURNING l_success
               IF NOT l_success THEN
                  CALL s_transaction_end('N',0)   
               ELSE
                  LET g_sfda_m.sfdastus = 'N'
                  CALL s_transaction_end('Y',0)
               END IF
               RETURN 
            ELSE
               #目前单据状态不可更新成未确认状态，请确认当前状态是否为'X.作废'或'Y.已确认'
               IF g_sfda_m.sfdastus NOT MATCHES '[XY]' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'sub-00474'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
                  RETURN
               END IF
            END IF
            #end add-point
         #160819-00008-s
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF
         #modify--151110-00030#1--By shiun--(E)
         EXIT MENU

      #ON ACTION signing
      #   LET lc_state = "W"
      #   #add-point:action控制
      #   #IF g_sfda_m.sfdastus MATCHES '[S]' THEN  #tmp
      #      RETURN
      #   #END IF
      #   #end add-point
      #   EXIT MENU

      ON ACTION confirmed
         LET g_action_choice="confirmed"        #160810-00046#1
         IF cl_auth_chk_act("confirmed") THEN   #160810-00046#1
            LET lc_state = "Y"
         #add-point:action控制
            IF g_sfda_m.sfdastus = 'N' THEN
               CALL s_transaction_begin()   
               CALL s_asft310_confirm(g_sfda_m.sfdadocno)
                    RETURNING l_success
               IF NOT l_success THEN
                  CALL s_transaction_end('N',0)
               ELSE
                  LET g_sfda_m.sfdastus = 'Y'
                  CALL s_transaction_end('Y',0)   
                 #151210-00012#1 add by Sarah -----(S)
                 #確認後判斷D-BAS-0083參數=Y則自動過帳
                  CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,l_slip
                  IF cl_get_doc_para(g_enterprise,g_site,l_slip,'D-BAS-0083') = 'Y' THEN
                     #底下段落參考s_asft310_post(),但不詢問是否執行過帳
                     IF s_asft310_upd_sfcb_cre_tmp_table() THEN
                        CALL s_transaction_begin()   
                        CALL s_asft310_post_chk(g_sfda_m.sfdadocno) RETURNING l_success
                        IF l_success THEN
                           CALL s_asft310_post_input(g_sfda_m.sfdadocno)
                                RETURNING l_success,g_sfda_m.sfda001
                           IF l_success THEN
                              CALL s_asft310_post_upd(g_sfda_m.sfdadocno,g_sfda_m.sfda001)
                                   RETURNING l_success
                           END IF
                        END IF
                        IF NOT l_success THEN
                           CALL s_transaction_end('N',0)
                        ELSE                     
                           LET g_sfda_m.sfdastus = 'S'
                           CALL s_transaction_end('Y',0)
                        END IF
                        CALL s_asft310_upd_sfcb_drop_tmp_table()
                     END IF
                  END IF
                 #151210-00012#1 add by Sarah -----(E)
               END IF
               RETURN
            END IF
         #160819-00008-s
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF    #160810-00046#1
         #end add-point
         EXIT MENU
         
      ON ACTION unposted
         #modify--151110-00030#1--By shiun--(S)
         LET g_action_choice="unposted"   #151120 Sarah add
         IF cl_auth_chk_act("unposted") THEN
            LET lc_state = "Z"
            #add-point:action控制
            LET lc_state = "Y"
            IF g_sfda_m.sfdastus = 'S' THEN
               IF s_asft310_upd_sfcb_cre_tmp_table() THEN
                  CALL s_transaction_begin()   
                  CALL cl_err_collect_init()  #160311-00026 by whitney add
                  CALL s_asft310_unpost(g_sfda_m.sfdadocno)
                       RETURNING l_success
                  IF NOT l_success THEN
                     CALL s_transaction_end('N',0)
                  ELSE
                     LET g_sfda_m.sfdastus = 'Y'
                     CALL s_transaction_end('Y',0)
                  END IF
                  CALL s_asft310_upd_sfcb_drop_tmp_table()
                  CALL cl_err_collect_show()  #160311-00026 by whitney add
               END IF
               RETURN
            END IF 
            #end add-point
         #160819-00008-s
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF
         #modify--151110-00030#1--By shiun--(E)
         EXIT MENU
         
      ON ACTION approved
         IF cl_auth_chk_act("approved") THEN  #160914-00019#1
            LET lc_state = "A"
            #add-point:action控制
            #IF g_sfda_m.sfdastus MATCHES '[S]' THEN  #tmp
               CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
               RETURN
            #END IF
            #end add-point
         END IF  #160914-00019#1
         EXIT MENU

      ON ACTION rejection
         IF cl_auth_chk_act("rejection") THEN  #160914-00019#1
            LET lc_state = "R"
            #add-point:action控制
            #IF g_sfda_m.sfdastus MATCHES '[S]' THEN  #tmp
               CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
               RETURN
            #END IF
            #end add-point
         END IF  #160914-00019#1
         EXIT MENU

      ON ACTION posted
         LET g_action_choice="posted"        #160810-00046#1
         IF cl_auth_chk_act("posted") THEN   #160810-00046#1
            LET lc_state = "S"
         #add-point:action控制
            IF s_asft310_upd_sfcb_cre_tmp_table() THEN
               CALL s_transaction_begin()   
               CALL s_asft310_post(g_sfda_m.sfdadocno)
                    RETURNING l_success
               IF NOT l_success THEN
                  CALL s_transaction_end('N',0)
               ELSE
                  LET g_sfda_m.sfdastus = 'S'
                  CALL s_transaction_end('Y',0)
               END IF
               CALL s_asft310_upd_sfcb_drop_tmp_table()
            END IF
            RETURN
         #160819-00008-s
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF   #160810-00046#1
         #end add-point
         EXIT MENU


	
	  #此段落由子樣板a36產生
      #提交
      #ON ACTION send
      #   #IF g_sfda_m.sfdastus MATCHES '[S]' THEN  #tmp
      #      RETURN
      #   #END IF
      #   IF cl_auth_chk_act("send") THEN
      #      CALL asft310_send()
      #   END IF
      #   LET lc_state = 'W'
      #   EXIT MENU
            
      ON ACTION signing
         IF cl_auth_chk_act("signing") THEN
           IF NOT asft310_send() THEN
              CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
              RETURN
           END IF
         #160819-00008-s 
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF
         LET lc_state = ''  #因為_send()已有執行update動作 
         EXIT MENU
      

      #抽單
      #ON ACTION draw_out
      #   #IF g_sfda_m.sfdastus MATCHES '[S]' THEN  #tmp
      #      RETURN
      #   #END IF
      #   IF cl_auth_chk_act("draw_out") THEN
      #      CALL asft310_draw_out()
      #   END IF
      #   LET lc_state = 'D'
      #   EXIT MENU
      
      ON ACTION withdraw
         IF cl_auth_chk_act("withdraw") THEN  
            IF NOT asft310_draw_out() THEN
               CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
               RETURN
            END IF
         #160819-00008-s
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF
         LET lc_state = ''  #因為_draw_out()已有執行update動作
         EXIT MENU

      ON ACTION invalid
         LET g_action_choice="invalid"        #160810-00046#1
         IF cl_auth_chk_act("invalid") THEN   #160810-00046#1
            LET lc_state = "X"
         #add-point:action控制
            #161208-00061#1-S
            #仅当状态为 N.未审核 时,才可以切换为X.作废
            #IF g_sfda_m.sfdastus NOT MATCHES '[N]' THEN
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.code = 'asf-00186'
            #   LET g_errparam.extend = ''
            #   LET g_errparam.popup = TRUE
            #   CALL cl_err()
            #   CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
            #   RETURN
            #END IF
            #161208-00061#1-E
            IF NOT cl_ask_confirm('aim-00109') THEN
               CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
               RETURN
            END IF
            #2015/3/2 liuym add ----str----- 
            #更新下阶料报废上的退料单号 
            SELECT sfda014,sfda015 INTO l_sfda014,l_sfda015
              FROM sfda_t
             WHERE sfdaent   = g_enterprise
               AND sfdadocno = g_sfda_m.sfdadocno
            IF l_sfda015 = '04' THEN
               UPDATE sfja_t SET sfja005 = NULL
                WHERE sfjaent   = g_enterprise
                  AND sfjadocno = l_sfda014
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = 'upd sfja'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
            END IF
            #2015/3/2 liuym add ----end----- 
         #160819-00008-s
         ELSE
            LET lc_state = ''
         #160819-00008-e
         END IF    #160810-00046#1
         #end add-point
         EXIT MENU


	
      #add-point:stus控制
      
      #end add-point
	
   END MENU

   IF (lc_state <> "N"
      AND lc_state <> "X"
      AND lc_state <> "Y"
      AND lc_state <> "S"
      AND lc_state <> "A"
      AND lc_state <> "D"
      AND lc_state <> "R"
      AND lc_state <> "W"
      ) OR
      cl_null(lc_state) THEN
      CALL s_transaction_end('N',0)   #160812-00017#4 20160815 add by beckxie
      RETURN
   END IF

   UPDATE sfda_t SET sfdastus = lc_state
    WHERE sfdaent = g_enterprise AND sfdasite = g_site AND sfdadocno = g_sfda_m.sfdadocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      CALL s_transaction_end('N','0')   #160812-00017#4 20160815 add by beckxie
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/open.png")  #unconfirmed
         WHEN "X"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         WHEN "S"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/posted.png")
         WHEN "Z"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unposted.png")

		 #此段落由子樣板a37產生
         WHEN "W"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
         WHEN "A"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
         WHEN "D"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
         WHEN "R"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      END CASE
      CALL s_transaction_end('Y','0')   #160812-00017#4 20160815 add by beckxie
      LET g_sfda_m.sfdastus = lc_state
      DISPLAY BY NAME g_sfda_m.sfdastus
   END IF
   #add-point:stus修改後
   
   #end add-point

   #add-point:statechange段結束前
   
   #end add-point

END FUNCTION

PRIVATE FUNCTION asft310_idx_chk()
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_sfdb_d.getLength() THEN
         LET g_detail_idx = g_sfdb_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfdb_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfdb_d.getLength() TO FORMONLY.cnt
   END IF

   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail2")
      IF g_detail_idx > g_sfdc_d.getLength() THEN
         LET g_detail_idx = g_sfdc_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfdc_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfdc_d.getLength() TO FORMONLY.cnt
   END IF

   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail3")
      IF g_detail_idx > g_sfde_d.getLength() THEN
         LET g_detail_idx = g_sfde_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfde_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfde_d.getLength() TO FORMONLY.cnt
   END IF

   IF g_current_page = 4 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail4")
      IF g_detail_idx > g_sfdc4_d.getLength() THEN
         LET g_detail_idx = g_sfdc4_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfdc4_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfdc4_d.getLength() TO FORMONLY.cnt
   END IF

   IF g_current_page = 5 THEN
      LET g_detail_idx2 = g_curr_diag.getCurrentRow("s_detail5")
      IF g_detail_idx2 > g_sfdf_d.getLength() THEN
         LET g_detail_idx2 = g_sfdf_d.getLength()
      END IF
      IF g_detail_idx2 = 0 AND g_sfdf_d.getLength() <> 0 THEN
         LET g_detail_idx2 = 1
      END IF
      DISPLAY g_detail_idx2 TO FORMONLY.idx
      DISPLAY g_sfdf_d.getLength() TO FORMONLY.cnt
   END IF

   IF g_current_page = 6 THEN
      LET g_detail_idx2 = g_curr_diag.getCurrentRow("s_detail6")
      IF g_detail_idx2 > g_sfdd_d.getLength() THEN
         LET g_detail_idx2 = g_sfdd_d.getLength()
      END IF
      IF g_detail_idx2 = 0 AND g_sfdd_d.getLength() <> 0 THEN
         LET g_detail_idx2 = 1
      END IF
      DISPLAY g_detail_idx2 TO FORMONLY.idx
      DISPLAY g_sfdd_d.getLength() TO FORMONLY.cnt
   END IF

   IF g_current_page = 7 THEN
      #160408-00043#1-mod-(S)
#      DISPLAY g_d_idx_display, g_d_cnt_display TO FORMONLY.idx, FORMONLY.cnt
      LET g_detail_idx2 = g_curr_diag.getCurrentRow("s_detail7")
      IF g_detail_idx2 > g_inao_d2.getLength() THEN
         LET g_detail_idx2 = g_inao_d2.getLength()
      END IF
      IF g_detail_idx2 = 0 AND g_inao_d2.getLength() <> 0 THEN
         LET g_detail_idx2 = 1
      END IF
      DISPLAY g_detail_idx2 TO FORMONLY.idx
      DISPLAY g_inao_d2.getLength() TO FORMONLY.cnt
      #160408-00043#1-mod-(E)
      
   END IF

END FUNCTION

PRIVATE FUNCTION asft310_b_fill2(pi_idx)
DEFINE pi_idx          LIKE type_t.num5
DEFINE l_ac_t          LIKE type_t.num5

   #有在单身处理中，需先备份旧值
   LET l_ac_t = l_ac

   CASE pi_idx
      WHEN '0'
           CALL asft310_b_fill_sfdf()
           CALL asft310_b_fill_sfdd()
           CALL asft310_b_fill_inao2()
      WHEN '5'
           CALL asft310_b_fill_sfdf()
      WHEN '6'
           CALL asft310_b_fill_sfdd()
           CALL asft310_b_fill_inao2()
   END CASE

   #还原旧值
   LET l_ac = l_ac_t

   #CALL asft310_detail_show() #mark 150109 提高效能

END FUNCTION
#抽单
PRIVATE FUNCTION asft310_draw_out()
   #檢查資料是否存在
   IF g_sfda_m.sfdadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   #LOCK主檔資料
   CALL s_transaction_begin()

   #進行BPM抽單功能
   OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN asft310_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #鎖住將被更改的資料
   FETCH asft310_cl INTO g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,
       g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,
       g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,g_sfda_m.sfdaowndp_desc,
       g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,
       g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,
       g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt

   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_sfda_m.sfdadocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #抽單失敗
   IF NOT cl_bpm_draw_out() THEN
      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #完成狀態更新
   CLOSE asft310_cl
   CALL s_transaction_end('Y','0')

   #重新指定此筆單據資料狀態圖片=>抽單
   LET g_browser[g_current_row].b_statepic = "stus/16/draw_out.png"

   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL asft310_ui_headershow()
   CALL asft310_ui_detailshow()

   RETURN TRUE
END FUNCTION

PRIVATE FUNCTION asft310_send()
   IF g_sfda_m.sfdadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()

      RETURN
   END IF

   #重新取得與顯示完整單據資料(最新單據資料)
    SELECT UNIQUE sfdadocno,sfdadocdt,sfda001,sfda002,sfda003,sfda004,sfda005,sfda015,sfda014,sfdastus,sfdaownid,sfdaowndp,
                  sfdacrtid,sfdacrtdp,sfdacrtdt,sfdamodid,sfdamoddt,sfdacnfid,sfdacnfdt,sfdapstid,sfdapstdt
      INTO g_sfda_m.sfdadocno,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,g_sfda_m.sfda003,g_sfda_m.sfda004,
           g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaowndp,g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtdp,
           g_sfda_m.sfdacrtdt,g_sfda_m.sfdamodid,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfdt,
           g_sfda_m.sfdapstid,g_sfda_m.sfdapstdt
      FROM sfda_t
     WHERE sfdaent = g_enterprise AND sfdasite = g_site AND sfdadocno = g_sfda_m.sfdadocno

   ERROR ""

   CALL s_transaction_begin()

   OPEN asft310_cl USING g_enterprise,g_sfda_m.sfdadocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN asft310_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #鎖住將被更改的資料
   FETCH asft310_cl INTO g_sfda_m.sfdadocno,g_sfda_m.oobal004,g_sfda_m.sfdadocdt,g_sfda_m.sfda001,g_sfda_m.sfda002,
       g_sfda_m.sfda003,g_sfda_m.sfda003_desc,g_sfda_m.sfda004,g_sfda_m.sfda004_desc,g_sfda_m.sfda005,g_sfda_m.sfda015,g_sfda_m.sfda014,
       g_sfda_m.sfdastus,g_sfda_m.sfdaownid,g_sfda_m.sfdaownid_desc,g_sfda_m.sfdaowndp,g_sfda_m.sfdaowndp_desc,
       g_sfda_m.sfdacrtid,g_sfda_m.sfdacrtid_desc,g_sfda_m.sfdacrtdp,g_sfda_m.sfdacrtdp_desc,g_sfda_m.sfdacrtdt,
       g_sfda_m.sfdamodid,g_sfda_m.sfdamodid_desc,g_sfda_m.sfdamoddt,g_sfda_m.sfdacnfid,g_sfda_m.sfdacnfid_desc,
       g_sfda_m.sfdacnfdt,g_sfda_m.sfdapstid,g_sfda_m.sfdapstid_desc,g_sfda_m.sfdapstdt

   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = g_sfda_m.sfdadocno
      LET g_errparam.popup = FALSE
      CALL cl_err()

      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #依據單據個數，需要指定所有單身條件為" 1=1"  (單身有幾個就要設幾個)
   LET g_wc2_table1 = " 1=1"
   LET g_wc2_table2 = " 1=1"
   LET g_wc2_table3 = " 1=1"
   LET g_wc2_table5 = " 1=1"
   LET g_wc2_table6 = " 1=1"


   CALL asft310_show()
   CALL asft310_set_pk_array()
   #add-point: 提交前的ADP
   #確認前檢核段
   IF NOT s_asft310_confirm_chk(g_sfda_m.sfdadocno) THEN
      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN FALSE
   END IF
   #end add-point

   #公用變數初始化
   CALL cl_bpm_data_init()

   #依照主檔/單身個數產生 CALL cl_bpm_set_master_data() / cl_bpm_set_detail_data()
   #單頭固定為 CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(xxxx)) 傳入參數: (1)單頭陣列  ; 回傳值: 無
   CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(g_sfda_m))

   #單身固定為 CALL cl_bpm_set_detail_data(s_detailX, util.JSONArray.fromFGL(xxxx)) 傳入參數: (1)單身SR名稱  (2)單身陣列  ; 回傳值: 無
   CALL cl_bpm_set_detail_data("s_detail1", util.JSONArray.fromFGL(g_sfdb_d))
   CALL cl_bpm_set_detail_data("s_detail2", util.JSONArray.fromFGL(g_sfdc_d))
   CALL cl_bpm_set_detail_data("s_detail3", util.JSONArray.fromFGL(g_sfde_d))
   CALL cl_bpm_set_detail_data("s_detail4", util.JSONArray.fromFGL(g_sfdc4_d))
   CALL cl_bpm_set_detail_data("s_detail5", util.JSONArray.fromFGL(g_sfdf_d))
   CALL cl_bpm_set_detail_data("s_detail6", util.JSONArray.fromFGL(g_sfdd_d))
   #CALL cl_bpm_set_detail_data("s_detail1_s_lot_s01", util.JSONArray.fromFGL(g_inao_d2))  #add 150831
   CALL cl_bpm_set_detail_data("s_detail7", util.JSONArray.fromFGL(g_inao_d))  #add 150831


   # cl_bpm_cli() 裡有包含以前的aws_condition()=>送簽資料檢核和更新單據狀況碼為'W'
   # cl_bpm_cli() 傳入參數:無  ;  回傳值: 0 開單失敗; 1 開單成功

   #開單失敗
   IF NOT cl_bpm_cli() THEN
      CLOSE asft310_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF

   #add-point: 提交後的ADP
   
   #end add-point

   #完成狀態更新
   CLOSE asft310_cl
   CALL s_transaction_end('Y','0')

   #此段落不需要刪除資料,但是否需要refresh圖片樣式???
   #CALL asft310_ui_browser_refresh()

   #重新指定此筆單據資料狀態圖片=>送簽中
   LET g_browser[g_current_row].b_statepic = "stus/16/signing.png"

   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL asft310_ui_headershow()
   CALL asft310_ui_detailshow()

   RETURN TRUE
END FUNCTION

PRIVATE FUNCTION asft310_b_fill_sfdb()
   
   CALL g_sfdb_d.clear()
   
   #161205-00025#6-s
   #LET g_sql = "SELECT  UNIQUE sfdb001,sfdb002,sfdb003,'',sfdb004,'',sfdb005,'','','','','',sfdb006,sfdb007,sfdb008 ",
   #            "  FROM sfdb_t",
   #            #" INNER JOIN sfda_t ON sfdadocno = sfdbdocno AND sfdasite = sfdbsite AND sfdaent = sfdbent",
   #            " WHERE sfdbent=? AND sfdbsite=? AND sfdbdocno=?"
   LET g_sql = " SELECT UNIQUE sfdb001,sfdb002,sfdb003, ",
               "(SELECT oocql004 FROM oocql_t WHERE oocqlent=sfdbent AND oocql001='215' AND oocql002=sfdb003 AND oocql003='",g_dlang,"'), ",
               "        sfdb004, ",
               "(SELECT oocql004 FROM oocql_t WHERE oocqlent=sfdbent AND oocql001='221' AND oocql002=sfdb004 AND oocql003='",g_dlang,"'), ",
               "        sfdb005,sfaa010,imaal003,imaal004,sfaa012,sfaa013,sfdb006,sfdb007,sfdb008 ",
               "   FROM sfdb_t,sfaa_t ",
               "   LEFT JOIN imaal_t ON imaalent=sfaaent AND imaal001=sfaa010 AND imaal002='",g_dlang,"' ",
               "  WHERE sfdbent=? AND sfdbsite=? AND sfdbdocno=? ",
               "    AND sfaaent=sfdbent AND sfaasite=sfdbsite AND sfaadocno=sfdb001 "
   #161205-00025#6-e
   IF NOT cl_null(g_wc2_table1) THEN
      LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
   END IF
   #子單身的WC
   LET g_sql = g_sql, " ORDER BY sfdb_t.sfdb001,sfdb_t.sfdb002,sfdb_t.sfdb003,sfdb_t.sfdb004,sfdb_t.sfdb005" 
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料  #160731-00253#1
   PREPARE b_fill_sfdb_p FROM g_sql
   DECLARE b_fill_sfdb_c CURSOR FOR b_fill_sfdb_p
   LET g_cnt = l_ac
   LET l_ac = 1
   OPEN b_fill_sfdb_c USING g_enterprise, g_site,g_sfda_m.sfdadocno
   FOREACH b_fill_sfdb_c INTO g_sfdb_d[l_ac].sfdb001,g_sfdb_d[l_ac].sfdb002,g_sfdb_d[l_ac].sfdb003,g_sfdb_d[l_ac].sfdb003_desc,
       g_sfdb_d[l_ac].sfdb004,g_sfdb_d[l_ac].sfdb004_desc,g_sfdb_d[l_ac].sfdb005,g_sfdb_d[l_ac].sfaa010,
       g_sfdb_d[l_ac].sfaa010_desc,g_sfdb_d[l_ac].sfaa010_desc2,g_sfdb_d[l_ac].sfaa012,g_sfdb_d[l_ac].sfaa013,
       g_sfdb_d[l_ac].sfdb006,g_sfdb_d[l_ac].sfdb007,g_sfdb_d[l_ac].sfdb008
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #161205-00025#6-s
      ##add 150109
      ##部位说明
      #CALL s_desc_get_acc_desc('215',g_sfdb_d[l_ac].sfdb003) RETURNING g_sfdb_d[l_ac].sfdb003_desc
      ##作业说明
      #CALL s_desc_get_acc_desc('221',g_sfdb_d[l_ac].sfdb004) RETURNING g_sfdb_d[l_ac].sfdb004_desc
      #SELECT sfaa010,imaal003,imaal004,sfaa013,sfaa012
      #  INTO g_sfdb_d[l_ac].sfaa010,g_sfdb_d[l_ac].sfaa010_desc,g_sfdb_d[l_ac].sfaa010_desc2,
      #       g_sfdb_d[l_ac].sfaa013,g_sfdb_d[l_ac].sfaa012
      #  FROM sfaa_t LEFT JOIN imaal_t ON sfaaent = imaalent AND sfaa010 = imaal001 AND imaal002 = g_dlang
      # WHERE sfaaent   = g_enterprise
      #   AND sfaasite  = g_site
      #   AND sfaadocno = g_sfdb_d[l_ac].sfdb001
      ##add 150109 end
      #161205-00025#6-e
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec AND g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
   END FOREACH
   LET g_error_show = 0
   #CALL g_sfdb_d.deleteElement(g_sfdb_d.getLength())
   CALL g_sfdb_d.deleteElement(l_ac)
   LET l_ac = g_cnt
   LET g_cnt = 0
   FREE b_fill_sfdb_p
END FUNCTION

PRIVATE FUNCTION asft310_b_fill_sfdc()
DEFINE l_sfba001   LIKE sfba_t.sfba001  #生产料号
DEFINE l_sfaa011   LIKE sfaa_t.sfaa011  #特性
   
   CALL g_sfdc_d.clear()
   CALL g_sfdc4_d.clear()
   
   #161205-00025#6-s
   #LET g_sql = "SELECT  UNIQUE sfdcseq,sfdc001,sfdc002,sfdc003,'','','','','','',sfdc004,'','',sfdc005,'','','','',sfdc006,'','','',sfdc007,sfdc008,'',sfdc009,'',sfdc010,sfdc011,'',sfdc012,'',sfdc013,'',sfdc014,sfdc016,sfdc015,'',sfdc017 ",
   #            "  FROM sfdc_t",
   #            #" INNER JOIN sfda_t ON sfdadocno = sfdcdocno AND sfdasite = sfdcsite AND sfdaent = sfdcent ",
   #            " LEFT JOIN sfdd_t ON sfdcent = sfddent AND sfdcsite = sfddsite AND sfdcdocno = sfdddocno AND sfdcseq = sfddseq ",
   #            " WHERE sfdcent=? AND sfdcsite=? AND sfdcdocno=?"
   LET g_sql = " SELECT UNIQUE sfdcseq,sfdc001,sfdc002,sfdc003,sfba002, ",
               "(SELECT oocql004 FROM oocql_t WHERE oocqlent=sfdcent AND oocql001='215' AND oocql002=sfba002 AND oocql003='",g_dlang,"'), ",
               "        sfba003, ",
               "(SELECT oocql004 FROM oocql_t WHERE oocqlent=sfdcent AND oocql001='221' AND oocql002=sfba003 AND oocql003='",g_dlang,"'), ",
               "        sfba004,'',sfdc004,imaal003,imaal004,sfdc005, ",
               "(SELECT inaml004 FROM inaml_t WHERE inamlent=sfdcent AND inaml001=sfdc004 AND inaml002=sfdc005 AND inaml003='",g_dlang,"'), ",
               "(SELECT imaf034 FROM imaf_t WHERE imafent=sfdcent AND imafsite=sfdcsite AND imaf001=sfdc004), ",
               "(SELECT imae092 FROM imae_t WHERE imaeent=sfdcent AND imaesite=sfdcsite AND imae001=sfdc004), ",
               "        sfba028,sfdc006, ",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfdcent AND oocal001=sfdc006 AND oocal002='",g_dlang,"'), ",
               "        sfba013,sfba016,sfdc007,sfdc008,(sfdc007-sfdc008),sfdc009, ",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfdcent AND oocal001=sfdc009 AND oocal002='",g_dlang,"'), ",
               "        sfdc010,sfdc011,(sfdc010-sfdc011),sfdc012, ",
               "(SELECT inayl003 FROM inayl_t WHERE inaylent=sfdcent AND inayl001=sfdc012 AND inayl002='",g_dlang,"'), ",
               "        sfdc013, ",
               "(SELECT inab003 FROM inab_t WHERE inabent=sfdcent AND inabsite=sfdcsite AND inab001=sfdc012 AND inab002=sfdc013 ), ",
               "        sfdc014,sfdc016,sfdc015, ",
               "(SELECT oocql004 FROM oocql_t WHERE oocqlent=sfdcent AND oocql001='226' AND oocql002=sfba003 AND oocql003='",g_dlang,"'), ",
               "        sfdc017,sfba001, ",
               "(SELECT sfaa011 FROM sfaa_t WHERE sfaaent=sfdcent AND sfaadocno=sfdc001) ",
               "   FROM sfba_t,sfdc_t ",
               "   LEFT JOIN sfdd_t ON sfddent=sfdcent AND sfddsite=sfdcsite AND sfdddocno=sfdcdocno AND sfddseq=sfdcseq ",  #170209-00003#1
               "   LEFT JOIN imaal_t ON imaalent=sfdcent AND imaal001=sfdc004 AND imaal002='",g_dlang,"' ",
               "  WHERE sfdcent=? AND sfdcsite=? AND sfdcdocno=? ",
               "    AND sfbaent=sfdcent AND sfbasite=sfdcsite AND sfbadocno=sfdc001 AND sfbaseq=sfdc002 AND sfbaseq1=sfdc003 "
   #161205-00025#6-e
   IF NOT cl_null(g_wc2_table2) THEN
      LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
   END IF
   #子單身的WC
   IF NOT cl_null(g_wc2_table6) THEN
      LET g_sql = g_sql CLIPPED," AND ", g_wc2_table6 CLIPPED
   END IF
   LET g_sql = g_sql, " ORDER BY sfdc_t.sfdcseq" 
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料  #160731-00253#1
   PREPARE b_fill_sfdc_p FROM g_sql
   DECLARE b_fill_sfdc_c CURSOR FOR b_fill_sfdc_p
   LET l_ac = 1
   OPEN b_fill_sfdc_c USING g_enterprise, g_site,g_sfda_m.sfdadocno
   FOREACH b_fill_sfdc_c INTO g_sfdc_d[l_ac].sfdcseq,g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002,
                              g_sfdc_d[l_ac].sfdc003,g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba002_desc,
                              g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba003_desc,g_sfdc_d[l_ac].sfba004,
                              g_sfdc_d[l_ac].replace,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc004_desc,
                              g_sfdc_d[l_ac].sfdc004_desc2,g_sfdc_d[l_ac].sfdc005,
                              g_sfdc_d[l_ac].sfdc005_desc,g_sfdc_d[l_ac].imaf034,
                              g_sfdc_d[l_ac].imae092,g_sfdc_d[l_ac].sfba028,g_sfdc_d[l_ac].sfdc006,
                              g_sfdc_d[l_ac].sfdc006_desc,g_sfdc_d[l_ac].sfba013,g_sfdc_d[l_ac].sfba016,
                              g_sfdc_d[l_ac].sfdc007,g_sfdc_d[l_ac].sfdc008,g_sfdc_d[l_ac].diff,
                              g_sfdc_d[l_ac].sfdc009,g_sfdc_d[l_ac].sfdc009_desc,g_sfdc_d[l_ac].sfdc010,
                              g_sfdc_d[l_ac].sfdc011,g_sfdc_d[l_ac].diff2,g_sfdc_d[l_ac].sfdc012,
                              g_sfdc_d[l_ac].sfdc012_desc,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc013_desc,
                              g_sfdc_d[l_ac].sfdc014,g_sfdc_d[l_ac].sfdc016,g_sfdc_d[l_ac].sfdc015,
                              g_sfdc_d[l_ac].sfdc015_desc,g_sfdc_d[l_ac].sfdc017
                             ,l_sfba001,l_sfaa011  #161205-00025#6
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #161205-00025#6-s
      ##add 150109
      ##单位
      #CALL s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc006) RETURNING g_sfdc_d[l_ac].sfdc006_desc
      ##参考单位
      #IF NOT cl_null(g_sfdc_d[l_ac].sfdc009) THEN
      #   CALL s_desc_get_unit_desc(g_sfdc_d[l_ac].sfdc009) RETURNING g_sfdc_d[l_ac].sfdc009_desc
      #END IF
      ##理由码
      #IF NOT cl_null(g_sfdc_d[l_ac].sfdc015) THEN
      #   INITIALIZE g_ref_fields TO NULL
      #   LET g_ref_fields[1] = g_sfdc_d[l_ac].sfdc015
      #   CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='226' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      #   LET g_sfdc_d[l_ac].sfdc015_desc = '', g_rtn_fields[1] , ''
      #   CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='226' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
      #END IF
      ##需求料号品名规格
      #CALL s_desc_get_item_desc(g_sfdc_d[l_ac].sfdc004)
      #   RETURNING g_sfdc_d[l_ac].sfdc004_desc,g_sfdc_d[l_ac].sfdc004_desc2
      ##显示产品特征说明
      #IF NOT cl_null(g_sfdc_d[l_ac].sfdc005) THEN
      #   CALL s_feature_description(g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005)
      #      RETURNING l_success,g_sfdc_d[l_ac].sfdc005_desc
      #   IF NOT l_success THEN
      #      LET g_sfdc_d[l_ac].sfdc005_desc = ''
      #   END IF
      #END IF
      ##保税料
      #SELECT imaf034 INTO g_sfdc_d[l_ac].imaf034
      #  FROM imaf_t
      # WHERE imafent = g_enterprise
      #   AND imafsite= g_site
      #   AND imaf001 = g_sfdc_d[l_ac].sfdc004
      ##发料前调拨
      #SELECT imae092 INTO g_sfdc_d[l_ac].imae092
      #  FROM imae_t
      # WHERE imaeent = g_enterprise
      #   AND imaesite= g_site
      #   AND imae001 = g_sfdc_d[l_ac].sfdc004
      ##差异数量
      #LET g_sfdc_d[l_ac].diff  = g_sfdc_d[l_ac].sfdc007 - g_sfdc_d[l_ac].sfdc008
      ##参考单位差异数量
      #LET g_sfdc_d[l_ac].diff2 = g_sfdc_d[l_ac].sfdc010 - g_sfdc_d[l_ac].sfdc011
      ##库位名称
      #IF NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN
      #   CALL s_desc_get_stock_desc(g_site,g_sfdc_d[l_ac].sfdc012)
      #      RETURNING g_sfdc_d[l_ac].sfdc012_desc
      #END IF
      ##储位名称
      #IF NOT cl_null(g_sfdc_d[l_ac].sfdc013) THEN
      #   CALL s_desc_get_locator_desc(g_site,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
      #      RETURNING g_sfdc_d[l_ac].sfdc013_desc
      #END IF
      ##工单信息-部位、作业、作业序、客供料、应发料、已发量
      #SELECT sfba002,sfba003,sfba004,sfba028,sfba013,sfba016,sfba001,sfaa011
      #  INTO g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004,g_sfdc_d[l_ac].sfba028,
      #       g_sfdc_d[l_ac].sfba013,g_sfdc_d[l_ac].sfba016,l_sfba001,l_sfaa011
      #  FROM sfba_t,sfaa_t
      # WHERE sfbaent = sfaaent
      #   AND sfbasite= sfaasite
      #   AND sfbadocno=sfaadocno
      #   AND sfbaent = g_enterprise
      #   AND sfbasite= g_site
      #   AND sfbadocno=g_sfdc_d[l_ac].sfdc001
      #   AND sfbaseq = g_sfdc_d[l_ac].sfdc002
      #   AND sfbaseq1= g_sfdc_d[l_ac].sfdc003
      ##部位说明
      #IF NOT cl_null(g_sfdc_d[l_ac].sfba002) THEN
      #   INITIALIZE g_chkparam.* TO NULL
      #   LET g_chkparam.arg1 = '215'
      #   LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfba002
      #   CALL cl_ref_val("v_oocql002")
      #   LET g_sfdc_d[l_ac].sfba002_desc = g_chkparam.return1
      #END IF
      ##作业说明
      #IF NOT cl_null(g_sfdc_d[l_ac].sfba003) THEN
      #   INITIALIZE g_chkparam.* TO NULL
      #   LET g_chkparam.arg1 = '221'
      #   LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfba003
      #   CALL cl_ref_val("v_oocql002")
      #   LET g_sfdc_d[l_ac].sfba003_desc = g_chkparam.return1
      #END IF
      #161205-00025#6-e
      
      #replace取替代建议
      CALL s_abmm201_get_proposal(g_site,l_sfba001,l_sfaa011,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfba002,g_sfdc_d[l_ac].sfba003,g_sfdc_d[l_ac].sfba004)
         RETURNING g_sfdc_d[l_ac].replace 
      
      #备注说明
      CALL asft310_show_sfdc_ooff013(l_ac)
      #add 150109 end
      LET g_sfdc4_d[l_ac].* = g_sfdc_d[l_ac].*

      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
   END FOREACH
   #CALL g_sfdc_d.deleteElement(g_sfdc_d.getLength())
   CALL g_sfdc_d.deleteElement(l_ac)
   #CALL g_sfdc4_d.deleteElement(g_sfdc4_d.getLength())
   LET l_ac = g_cnt
   LET g_cnt = 0
   FREE b_fill_sfdc_p
END FUNCTION

PRIVATE FUNCTION asft310_b_fill_sfde()

   CALL g_sfde_d.clear()
   
   #161205-00025#6-s
   #LET g_sql = "SELECT  UNIQUE sfdeseq,sfde001,'','',sfde002,'','','',sfde009,sfde003,'',sfde004,sfde005,'',sfde006,'',sfde007,sfde008,'',sfde010 FROM sfde_t",
   #            #" INNER JOIN sfda_t ON sfdadocno = sfdedocno AND sfdasite = sfdesite AND sfdaent = sfdeent ",
   #            " LEFT JOIN sfdf_t ON sfdeent = sfdfent AND sfdesite = sfdfsite AND sfdedocno = sfdfdocno AND sfdeseq = sfdfseq ",
   #            " WHERE sfdeent=? AND sfdesite=? AND sfdedocno=?"
   LET g_sql = " SELECT UNIQUE sfdeseq,sfde001,imaal003,imaal004,sfde002, ",
               "(SELECT inaml004 FROM inaml_t WHERE inamlent=sfdeent AND inaml001=sfde001 AND inaml002=sfde002 AND inaml003='",g_dlang,"'), ",
               "(SELECT imaf034 FROM imaf_t WHERE imafent=sfdeent AND imafsite=sfdesite AND imaf001=sfde001), ",
               "(SELECT imae092 FROM imae_t WHERE imaeent=sfdeent AND imaesite=sfdesite AND imae001=sfde001), ",
               "        sfde009,sfde003, ",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfdeent AND oocal001=sfde003 AND oocal002='",g_dlang,"'), ",
               "        sfde004,sfde005,(sfde004-sfde005),sfde006, ",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfdeent AND oocal001=sfde006 AND oocal002='",g_dlang,"'), ",
               "        sfde007,sfde008,(sfde007-sfde008),sfde010 ",
               "   FROM sfde_t ",
               "   LEFT JOIN sfdf_t ON sfdfent=sfdeent AND sfdfsite=sfdesite AND sfdfdocno=sfdedocno AND sfdfseq=sfdeseq ",  #170209-00003#1
               "   LEFT JOIN imaal_t ON imaalent=sfdeent AND imaal001=sfde001 AND imaal002='",g_dlang,"' ",
               "  WHERE sfdeent=? AND sfdesite=? AND sfdedocno=? "
   #161205-00025#6-e
   IF NOT cl_null(g_wc2_table3) THEN
      LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
   END IF
   #子單身的WC
   IF NOT cl_null(g_wc2_table5) THEN
      LET g_sql = g_sql CLIPPED," AND ", g_wc2_table5 CLIPPED
   END IF
   LET g_sql = g_sql, " ORDER BY sfde_t.sfdeseq"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料  #160731-00253#1
   PREPARE b_fill_sfde_p FROM g_sql
   DECLARE b_fill_sfde_c CURSOR FOR b_fill_sfde_p
   LET l_ac = 1
   OPEN b_fill_sfde_c USING g_enterprise, g_site,g_sfda_m.sfdadocno
   FOREACH b_fill_sfde_c INTO g_sfde_d[l_ac].sfdeseq,g_sfde_d[l_ac].sfde001,g_sfde_d[l_ac].sfde001_desc,
       g_sfde_d[l_ac].sfde001_desc2,g_sfde_d[l_ac].sfde002,g_sfde_d[l_ac].sfde002_desc,g_sfde_d[l_ac].imaf034,g_sfde_d[l_ac].imae092,
       g_sfde_d[l_ac].sfde009,g_sfde_d[l_ac].sfde003,g_sfde_d[l_ac].sfde003_desc,g_sfde_d[l_ac].sfde004,
       g_sfde_d[l_ac].sfde005,g_sfde_d[l_ac].diff03,g_sfde_d[l_ac].sfde006,g_sfde_d[l_ac].sfde006_desc,
       g_sfde_d[l_ac].sfde007,g_sfde_d[l_ac].sfde008,g_sfde_d[l_ac].diff23,g_sfde_d[l_ac].sfde010
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #161205-00025#6-s
      ##add 150109
      ##需求料号
      #CALL s_desc_get_item_desc(g_sfde_d[l_ac].sfde001)
      #   RETURNING g_sfde_d[l_ac].sfde001_desc,g_sfde_d[l_ac].sfde001_desc2
      ##显示产品特征说明
      #IF NOT cl_null(g_sfde_d[l_ac].sfde002) THEN
      #   CALL s_feature_description(g_sfde_d[l_ac].sfde001,g_sfde_d[l_ac].sfde002)
      #      RETURNING l_success,g_sfde_d[l_ac].sfde002_desc
      #   IF NOT l_success THEN
      #      LET g_sfde_d[l_ac].sfde002_desc = ''
      #   END IF
      #END IF
      ##保税料
      #SELECT imaf034 INTO g_sfde_d[l_ac].imaf034
      #  FROM imaf_t
      # WHERE imafent = g_enterprise
      #   AND imafsite= g_site
      #   AND imaf001 = g_sfde_d[l_ac].sfde001
      ##发料前调拨
      #SELECT imae092 INTO g_sfde_d[l_ac].imae092
      #  FROM imae_t
      # WHERE imaeent = g_enterprise
      #   AND imaesite= g_site
      #   AND imae001 = g_sfde_d[l_ac].sfde001
      ##单位
      #CALL s_desc_get_unit_desc(g_sfde_d[l_ac].sfde003) RETURNING g_sfde_d[l_ac].sfde003_desc
      ##差异数量
      #LET g_sfde_d[l_ac].diff03 = g_sfde_d[l_ac].sfde004 - g_sfde_d[l_ac].sfde005
      ##参考单位
      #IF NOT cl_null(g_sfde_d[l_ac].sfde006) THEN
      #   CALL s_desc_get_unit_desc(g_sfde_d[l_ac].sfde006) RETURNING g_sfde_d[l_ac].sfde006_desc
      #END IF
      ##参考单位差异数量
      #LET g_sfde_d[l_ac].diff23 = g_sfde_d[l_ac].sfde007 - g_sfde_d[l_ac].sfde008
      ##add 150109 end
      #161205-00025#6-e
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = FALSE
         CALL cl_err()
         EXIT FOREACH
      END IF
   END FOREACH
   #CALL g_sfde_d.deleteElement(g_sfde_d.getLength())
   CALL g_sfde_d.deleteElement(l_ac)
   LET l_ac = g_cnt
   LET g_cnt = 0
   FREE b_fill_sfde_p
END FUNCTION

#申请單身 inao000 = '1'
#此FUNCTION无用，元件里有import过来
#add 150831
PRIVATE FUNCTION asft310_b_fill_inao1()
#DEFINE l_ac1       LIKE type_t.num5
#
#   CALL g_inao_d.clear()
#   
#   LET g_sql = "SELECT  UNIQUE inaoseq,inaoseq1,inaoseq2,inao001,'','',inao008,inao009,inao010,inao012 ",
#               "  FROM inao_t ",
#               " INNER JOIN sfda_t ON sfdadocno = inaodocno AND sfdaent = inaoent AND sfdasite = inaosite ",
#               " WHERE inaoent=? AND inaosite=? AND inaodocno=? AND inao000 = '1'"
# 
#   IF NOT cl_null(g_wc2_table1) THEN
#      LET g_sql = g_sql CLIPPED, " AND inaoseq IN ( SELECT sfdcseq FROM sfdc_t WHERE sfdcent='",g_enterprise,"' AND sfdcsite='",g_site,"' AND sfdcdocno='",g_sfda_m.sfdadocno,"' AND ", g_wc2_table2 CLIPPED, " ) "
#   END IF
#   LET g_sql = g_sql, " ORDER BY inaoseq,inaoseq1,inaoseq2"
#   
#   PREPARE asft310_b_fill_inao1_pb1 FROM g_sql
#   DECLARE asft310_b_fill_inao1_cs1 CURSOR FOR asft310_b_fill_inao1_pb1
#   LET g_cnt = l_ac1
#   LET l_ac1 = 1
#   OPEN asft310_b_fill_inao1_cs1 USING g_enterprise, g_site,g_sfda_m.sfdadocno
#   FOREACH asft310_b_fill_inao1_cs1 INTO g_inao_d[l_ac1].*
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = "FOREACH:"
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         EXIT FOREACH
#      END IF
#      #料件编号
#      CALL s_desc_get_item_desc(g_inao_d[l_ac1].inao001) RETURNING g_inao_d[l_ac1].inao001_desc,g_inao_d[l_ac1].inao001_desc2
#      DISPLAY BY NAME g_inao_d[l_ac1].inao001_desc,g_inao_d[l_ac1].inao001_desc2 
#      
#      LET l_ac1 = l_ac1 + 1
#      IF l_ac1 > g_max_rec AND g_error_show = 1 THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code =  9035
#         LET g_errparam.extend =  ''
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         EXIT FOREACH
#      END IF
#      
#   END FOREACH
#   LET g_error_show = 0
#   
#   CALL g_inao_d.deleteElement(g_inao_d.getLength())
#
#   
#   LET g_rec_b = g_inao_d.getLength()
#   LET l_ac1 = g_cnt
#   LET g_cnt = 0  
#   
#   FREE asft310_b_fill_inao1_pb1
END FUNCTION

#明細單身 inao000 = '2'
#add 150831
PRIVATE FUNCTION asft310_b_fill_inao2()
DEFINE l_ac1       LIKE type_t.num5

   CALL g_inao_d2.clear()
   
   #161205-00025#6-s
   #LET g_sql = "SELECT  UNIQUE inaoseq,inaoseq1,inaoseq2,inao001,'','',inao008,inao009,inao010,inao012 ",
   #            "  FROM inao_t",
   #            " INNER JOIN sfda_t ON sfdadocno = inaodocno AND sfdaent = inaoent AND sfdasite = inaosite ",
   #            " WHERE inaoent=? AND inaosite=? AND inaodocno=? AND inao000 = '2'"
   LET g_sql = " SELECT UNIQUE inaoseq,inaoseq1,inaoseq2,inao001,imaal003,imaal004,inao008,inao009,inao010,inao012 ",
               "   FROM inao_t",
               "   LEFT JOIN imaal_t ON imaalent=inaoent AND imaal001=inao001 AND imaal002='",g_dlang,"' ",
               "  WHERE inaoent=? AND inaosite=? AND inaodocno=? AND inao000 = '2' "
   #161205-00025#6-e
   IF NOT cl_null(g_wc2_table6) THEN
      #LET g_sql = g_sql CLIPPED, " AND (inaoseq,inaoseq1) IN ( SELECT sfddseq,sfddseq1 FROM sfdd_t WHERE sfddent='",g_enterprise,"' AND sfddsite='",g_site,"' AND sfdddocno='",g_sfda_m.sfdadocno,"' AND ", g_wc2_table6 CLIPPED, " )"
      LET g_sql = g_sql CLIPPED, " AND inaoseq IN ( SELECT sfdcseq FROM sfdc_t WHERE sfdcent='",g_enterprise,"' AND sfdcsite='",g_site,"' AND sfdcdocno='",g_sfda_m.sfdadocno,"' AND ", g_wc2_table2 CLIPPED, " ) "
   END IF
   #子單身的WC
   LET g_sql = g_sql CLIPPED, " ORDER BY inao_t.inaoseq,inao_t.inaoseq1,inao_t.inaoseq2 "
   PREPARE asft310_b_fill_inao2_p FROM g_sql
   DECLARE asft310_b_fill_inao2_c CURSOR FOR asft310_b_fill_inao2_p
   LET g_cnt = l_ac1
   LET l_ac1 = 1
   OPEN asft310_b_fill_inao2_c USING g_enterprise, g_site,g_sfda_m.sfdadocno
   #FOREACH asft310_b_fill_inao2_c INTO g_inao_d2[l_ac1].* #161109-00085#62 mark
   #161109-00085#62 --s add
   FOREACH asft310_b_fill_inao2_c INTO g_inao_d2[l_ac1].inaoseq,g_inao_d2[l_ac1].inaoseq1,g_inao_d2[l_ac1].inaoseq2,g_inao_d2[l_ac1].inao001,g_inao_d2[l_ac1].inao001_desc,
                                       g_inao_d2[l_ac1].inao001_desc2,g_inao_d2[l_ac1].inao008,g_inao_d2[l_ac1].inao009,g_inao_d2[l_ac1].inao010,g_inao_d2[l_ac1].inao012
   #161109-00085#62 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #161205-00025#6-s
      ##料件编号
      #CALL s_desc_get_item_desc(g_inao_d2[l_ac1].inao001) RETURNING g_inao_d2[l_ac1].inao001_desc,g_inao_d2[l_ac1].inao001_desc2
      #161205-00025#6-e
      LET l_ac1 = l_ac1 + 1
      IF l_ac1 > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = FALSE
         CALL cl_err()
         EXIT FOREACH
      END IF
   END FOREACH
   CALL g_inao_d2.deleteElement(g_inao_d2.getLength())
   LET g_rec_b = g_inao_d2.getLength()
   LET l_ac1 = g_cnt
   LET g_cnt = 0
   FREE asft310_b_fill_inao2_p
END FUNCTION

PRIVATE FUNCTION asft310_b_fill_sfdf()
   CALL g_sfdf_d.clear()

   #161205-00025#6-s
   #LET g_sql = "SELECT UNIQUE sfdfseq1,sfdf001,'','',sfdf013,'',sfdf002,sfdf003,'',sfdf004,'',sfdf005,sfdf010, ",
   #            "              sfdf006,'',sfdf007,sfdf008,'',sfdf009,sfdf011,sfdf012 ",
   #            "  FROM sfdf_t",
   #            " WHERE sfdfent=? AND sfdfsite=? AND sfdfdocno=? AND sfdfseq=?"
   LET g_sql = " SELECT UNIQUE sfdfseq1,sfdf001,imaal003,imaal004,sfdf013, ",
               "(SELECT inaml004 FROM inaml_t WHERE inamlent=sfdfent AND inaml001=sfdf001 AND inaml002=sfdf013 AND inaml003='",g_dlang,"'), ",
               "        sfdf002,sfdf003, ",
               "(SELECT inayl003 FROM inayl_t WHERE inaylent=sfdfent AND inayl001=sfdf003 AND inayl002='",g_dlang,"'), ",
               "        sfdf004, ",
               "(SELECT inab003 FROM inab_t WHERE inabent=sfdfent AND inabsite=sfdfsite AND inab001=sfdf003 AND inab002=sfdf004 ), ",
               "        sfdf005,sfdf010,sfdf006, ",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfdfent AND oocal001=sfdf006 AND oocal002='",g_dlang,"'), ",
               "        sfdf007,sfdf008, ",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfdfent AND oocal001=sfdf008 AND oocal002='",g_dlang,"'), ",
               "        sfdf009,sfdf011,sfdf012 ",
               "   FROM sfdf_t",
               "   LEFT JOIN imaal_t ON imaalent=sfdfent AND imaal001=sfdf001 AND imaal002='",g_dlang,"' ",
               "  WHERE sfdfent=? AND sfdfsite=? AND sfdfdocno=? AND sfdfseq=? "
   #161205-00025#6-e
   IF NOT cl_null(g_wc2_table5) THEN
      LET g_sql = g_sql CLIPPED," AND ",g_wc2_table5 CLIPPED
   END IF
   LET g_sql = g_sql, " ORDER BY  sfdf_t.sfdfseq1"
   #add-point:單身填充前
   IF cl_null(g_detail_idx) OR g_detail_idx=0 THEN
      LET g_detail_idx = 1
   END IF
   #end add-point
   PREPARE b_fill_sfdf_p FROM g_sql
   DECLARE b_fill_sfdf_c CURSOR FOR b_fill_sfdf_p
   OPEN b_fill_sfdf_c USING g_enterprise, g_site,g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq
   LET l_ac = 1
   FOREACH b_fill_sfdf_c INTO g_sfdf_d[l_ac].sfdfseq1,g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf001_desc,
       g_sfdf_d[l_ac].sfdf001_desc2,g_sfdf_d[l_ac].sfdf013,g_sfdf_d[l_ac].sfdf013_desc,
       g_sfdf_d[l_ac].sfdf002,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf003_desc,
       g_sfdf_d[l_ac].sfdf004,g_sfdf_d[l_ac].sfdf004_desc,g_sfdf_d[l_ac].sfdf005,g_sfdf_d[l_ac].sfdf010,
       g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf006_desc,g_sfdf_d[l_ac].sfdf007,g_sfdf_d[l_ac].sfdf008,
       g_sfdf_d[l_ac].sfdf008_desc,g_sfdf_d[l_ac].sfdf009,g_sfdf_d[l_ac].sfdf011,g_sfdf_d[l_ac].sfdf012
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #161205-00025#6-s
      ##add 150109
      ##发料料号
      #CALL s_desc_get_item_desc(g_sfdf_d[l_ac].sfdf001)
      #   RETURNING g_sfdf_d[l_ac].sfdf001_desc,g_sfdf_d[l_ac].sfdf001_desc2
      ##显示产品特征说明
      #IF NOT cl_null(g_sfdf_d[l_ac].sfdf013) THEN
      #   CALL s_feature_description(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013)
      #      RETURNING l_success,g_sfdf_d[l_ac].sfdf013_desc
      #   IF NOT l_success THEN
      #      LET g_sfdf_d[l_ac].sfdf013_desc = ''
      #   END IF
      #END IF
      ##库位
      #IF NOT cl_null(g_sfdf_d[l_ac].sfdf003) THEN
      #   CALL s_desc_get_stock_desc(g_site,g_sfdf_d[l_ac].sfdf003) RETURNING g_sfdf_d[l_ac].sfdf003_desc
      #END IF
      ##储位
      #IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) THEN
      #   CALL s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004) RETURNING g_sfdf_d[l_ac].sfdf004_desc
      #END IF
      ##单位
      #CALL s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf006) RETURNING g_sfdf_d[l_ac].sfdf006_desc
      ##参考单位
      #IF NOT cl_null(g_sfdf_d[l_ac].sfdf008) THEN
      #   CALL s_desc_get_unit_desc(g_sfdf_d[l_ac].sfdf008) RETURNING g_sfdf_d[l_ac].sfdf008_desc
      #END IF
      ##add 150109 end
      #161205-00025#6-e
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = FALSE
         CALL cl_err()
         EXIT FOREACH
      END IF
   END FOREACH
   #CALL g_sfdf_d.deleteElement(g_sfdf_d.getLength())
   CALL g_sfdf_d.deleteElement(l_ac)
   FREE b_fill_sfdf_p
END FUNCTION

PRIVATE FUNCTION asft310_b_fill_sfdd()

   CALL g_sfdd_d.clear()

   #161205-00025#6-s
   #LET g_sql = "SELECT UNIQUE sfddseq1,sfdd001,'','',sfdd013,'',sfdd002,sfdd003,'',sfdd004,'',sfdd005,sfdd010,",
   #            "              sfdd006,'',sfdd007,sfdd008,'',sfdd009,sfdd011,sfdd012,'',sfdd014,sfdd015 ",  #160408-00035#7  add sfdd014,sfdd015
   #            "  FROM sfdd_t",
   #            " WHERE sfddent=? AND sfddsite=? AND sfdddocno=? AND sfddseq=?"
   LET g_sql = " SELECT UNIQUE sfddseq1,sfdd001,imaal003,imaal004,sfdd013, ",
               "(SELECT inaml004 FROM inaml_t WHERE inamlent=sfddent AND inaml001=sfdd001 AND inaml002=sfdd013 AND inaml003='",g_dlang,"'), ",
               "        sfdd002,sfdd003, ",
               "(SELECT inayl003 FROM inayl_t WHERE inaylent=sfddent AND inayl001=sfdd003 AND inayl002='",g_dlang,"'), ",
               "        sfdd004, ",
               "(SELECT inab003 FROM inab_t WHERE inabent=sfddent AND inabsite=sfddsite AND inab001=sfdd003 AND inab002=sfdd004), ",
               "        sfdd005,sfdd010,sfdd006,",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfddent AND oocal001=sfdd006 AND oocal002='",g_dlang,"'), ",
               "        sfdd007,sfdd008,",
               "(SELECT oocal003 FROM oocal_t WHERE oocalent=sfddent AND oocal001=sfdd008 AND oocal002='",g_dlang,"'), ",
               "        sfdd009,sfdd011,sfdd012,'',sfdd014,sfdd015 ",
               "   FROM sfdd_t ",
               "   LEFT JOIN imaal_t ON imaalent=sfddent AND imaal001=sfdd001 AND imaal002='",g_dlang,"' ",
               "  WHERE sfddent=? AND sfddsite=? AND sfdddocno=? AND sfddseq=? "
   #161205-00025#6-e
   IF NOT cl_null(g_wc2_table6) THEN
      LET g_sql = g_sql CLIPPED," AND ",g_wc2_table6 CLIPPED
   END IF
   LET g_sql = g_sql, " ORDER BY  sfdd_t.sfddseq1"

   IF cl_null(g_detail_idx) OR g_detail_idx=0 THEN
      LET g_detail_idx = 1
   END IF
   PREPARE b_fill_sfdd_p FROM g_sql
   DECLARE b_fill_sfdd_c CURSOR FOR b_fill_sfdd_p
   OPEN b_fill_sfdd_c USING g_enterprise, g_site,g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq
   LET l_ac = 1
   FOREACH b_fill_sfdd_c INTO g_sfdd_d[l_ac].sfddseq1,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd001_desc,
       g_sfdd_d[l_ac].sfdd001_desc2,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd013_desc,g_sfdd_d[l_ac].sfdd002,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd003_desc,
       g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd004_desc,g_sfdd_d[l_ac].sfdd005,g_sfdd_d[l_ac].sfdd010,
       g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd006_desc,g_sfdd_d[l_ac].sfdd007,g_sfdd_d[l_ac].sfdd008,
       g_sfdd_d[l_ac].sfdd008_desc,g_sfdd_d[l_ac].sfdd009,g_sfdd_d[l_ac].sfdd011,g_sfdd_d[l_ac].sfdd012,
       g_sfdd_d[l_ac].sfdd_ooff013,g_sfdd_d[l_ac].sfdd014,g_sfdd_d[l_ac].sfdd015    #160408-00035#7 add  sfdd014,sfdd015
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      #161205-00025#6-s
      #add 150109
      ##发料料号
      #CALL s_desc_get_item_desc(g_sfdd_d[l_ac].sfdd001) 
      #   RETURNING g_sfdd_d[l_ac].sfdd001_desc,g_sfdd_d[l_ac].sfdd001_desc2
      ##显示产品特征说明
      #IF NOT cl_null(g_sfdd_d[l_ac].sfdd013) THEN
      #   CALL s_feature_description(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
      #      RETURNING l_success,g_sfdd_d[l_ac].sfdd013_desc
      #   IF NOT l_success THEN
      #      LET g_sfdd_d[l_ac].sfdd013_desc = ''
      #   END IF
      #END IF
      ##库位
      #IF NOT cl_null(g_sfdd_d[l_ac].sfdd003) THEN
      #   CALL s_desc_get_stock_desc(g_site,g_sfdd_d[l_ac].sfdd003) RETURNING g_sfdd_d[l_ac].sfdd003_desc
      #END IF
      ##储位
      #IF NOT cl_null(g_sfdd_d[l_ac].sfdd004) THEN
      #   CALL s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004) RETURNING g_sfdd_d[l_ac].sfdd004_desc
      #END IF
      ##单位
      #CALL s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd006) RETURNING g_sfdd_d[l_ac].sfdd006_desc
      ##参考单位
      #IF NOT cl_null(g_sfdd_d[l_ac].sfdd008) THEN
      #   CALL s_desc_get_unit_desc(g_sfdd_d[l_ac].sfdd008) RETURNING g_sfdd_d[l_ac].sfdd008_desc
      #END IF
      #161205-00025#6-s
      CALL asft310_show_sfdd_ooff013(l_ac)
      #add 150109 end
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code =  9035
         LET g_errparam.extend =  ''
         LET g_errparam.popup = FALSE
         CALL cl_err()
         EXIT FOREACH
      END IF
   END FOREACH
   #CALL g_sfdd_d.deleteElement(g_sfdd_d.getLength())
   CALL g_sfdd_d.deleteElement(l_ac)
   FREE b_fill_sfdd_p
END FUNCTION
#若单头key栏位有变更，单身的key一起变更
PRIVATE FUNCTION asft310_upd_key()
DEFINE r_success LIKE type_t.num5
DEFINE l_success LIKE type_t.num5

   LET r_success = FALSE
   
   #更新單身key值
   UPDATE sfdb_t SET sfdbdocno = g_sfda_m.sfdadocno
    WHERE sfdbent = g_enterprise AND sfdbdocno = g_sfdadocno_t
   CASE
      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "std-00009"
         LET g_errparam.extend = "sfdb_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      WHEN SQLCA.sqlcode #其他錯誤
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdb_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
   END CASE

   #更新單身key值
   UPDATE sfdc_t
      SET sfdcdocno = g_sfda_m.sfdadocno
    WHERE sfdcent = g_enterprise AND sfdcdocno = g_sfdadocno_t
   CASE
      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "std-00009"
         LET g_errparam.extend = "sfdc_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      WHEN SQLCA.sqlcode #其他錯誤
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdc_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
   END CASE

   #更新單身key值
   UPDATE sfde_t
      SET sfdedocno = g_sfda_m.sfdadocno
    WHERE sfdeent = g_enterprise AND sfdedocno = g_sfdadocno_t
   CASE
      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "std-00009"
         LET g_errparam.extend = "sfde_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      WHEN SQLCA.sqlcode #其他錯誤
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfde_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
   END CASE

   #add 150831 --begin
   #更新單身key值
   UPDATE inao_t
      SET inaodocno = g_sfda_m.sfdadocno
    WHERE inaoent = g_enterprise AND inaosite = g_site AND
          inaodocno = g_sfdadocno_t
   CASE
      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "std-00009"
         LET g_errparam.extend = "inao_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      WHEN SQLCA.sqlcode #其他錯誤
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "inao_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
   END CASE
   #add 150831 --end

   #更新單身key值
   UPDATE sfdf_t
      SET sfdfdocno = g_sfda_m.sfdadocno
    WHERE sfdfent = g_enterprise AND sfdfdocno = g_sfdadocno_t
   CASE
      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "std-00009"
         LET g_errparam.extend = "sfdf_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      WHEN SQLCA.sqlcode #其他錯誤
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdf_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
   END CASE

   #更新單身key值
   UPDATE sfdd_t
      SET sfdddocno = g_sfda_m.sfdadocno
    WHERE sfddent = g_enterprise AND sfdddocno = g_sfdadocno_t
   CASE
      WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = "std-00009"
         LET g_errparam.extend = "sfdd_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
      WHEN SQLCA.sqlcode #其他錯誤
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "sfdd_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN r_success
   END CASE

   #add 141222
   #更新ooff之key
   CALL asft310_update_ooff_key("a") RETURNING l_success
   IF NOT l_success THEN
      RETURN r_success
   END IF
   #add 141222 end
   
   LET r_success = TRUE
   RETURN r_success
   
END FUNCTION
#套数单身中某一笔可删除否检查
#在单身编辑状态
PRIVATE FUNCTION asft310_del_sfdb_chk()
DEFINE r_success       LIKE type_t.num5
DEFINE l_sfdb006       LIKE sfdb_t.sfdb006
DEFINE l_sfdc007       LIKE sfdc_t.sfdc007
DEFINE l_sfdc007_sum   LIKE sfdc_t.sfdc007   #已申请的数量
DEFINE l_sql           STRING
DEFINE l_sets          LIKE sfdc_t.sfdc007   #套数
DEFINE l_max_sets      LIKE sfdc_t.sfdc007   #最大套数
#DEFINE l_sfdc          RECORD LIKE sfdc_t.*  #160728-00032 by whitney add #161109-00085#62 mark
#161109-00085#62 --s add
DEFINE l_sfdc RECORD  #發退料需求檔
       sfdcent LIKE sfdc_t.sfdcent, #企業編號
       sfdcsite LIKE sfdc_t.sfdcsite, #營運據點
       sfdcdocno LIKE sfdc_t.sfdcdocno, #發退料單號
       sfdcseq LIKE sfdc_t.sfdcseq, #項次
       sfdc001 LIKE sfdc_t.sfdc001, #工單單號
       sfdc002 LIKE sfdc_t.sfdc002, #工單項次
       sfdc003 LIKE sfdc_t.sfdc003, #工單項序
       sfdc004 LIKE sfdc_t.sfdc004, #需求料號
       sfdc005 LIKE sfdc_t.sfdc005, #產品特徵
       sfdc006 LIKE sfdc_t.sfdc006, #單位
       sfdc007 LIKE sfdc_t.sfdc007, #申請數量
       sfdc008 LIKE sfdc_t.sfdc008, #實際數量
       sfdc009 LIKE sfdc_t.sfdc009, #參考單位
       sfdc010 LIKE sfdc_t.sfdc010, #參考單位需求數量
       sfdc011 LIKE sfdc_t.sfdc011, #參考單位實際數量
       sfdc012 LIKE sfdc_t.sfdc012, #指定庫位
       sfdc013 LIKE sfdc_t.sfdc013, #指定儲位
       sfdc014 LIKE sfdc_t.sfdc014, #指定批號
       sfdc015 LIKE sfdc_t.sfdc015, #理由碼
       sfdc016 LIKE sfdc_t.sfdc016, #庫存管理特徴
       sfdc017 LIKE sfdc_t.sfdc017, #正負
       sfdcud001 LIKE sfdc_t.sfdcud001, #自定義欄位(文字)001
       sfdcud002 LIKE sfdc_t.sfdcud002, #自定義欄位(文字)002
       sfdcud003 LIKE sfdc_t.sfdcud003, #自定義欄位(文字)003
       sfdcud004 LIKE sfdc_t.sfdcud004, #自定義欄位(文字)004
       sfdcud005 LIKE sfdc_t.sfdcud005, #自定義欄位(文字)005
       sfdcud006 LIKE sfdc_t.sfdcud006, #自定義欄位(文字)006
       sfdcud007 LIKE sfdc_t.sfdcud007, #自定義欄位(文字)007
       sfdcud008 LIKE sfdc_t.sfdcud008, #自定義欄位(文字)008
       sfdcud009 LIKE sfdc_t.sfdcud009, #自定義欄位(文字)009
       sfdcud010 LIKE sfdc_t.sfdcud010, #自定義欄位(文字)010
       sfdcud011 LIKE sfdc_t.sfdcud011, #自定義欄位(數字)011
       sfdcud012 LIKE sfdc_t.sfdcud012, #自定義欄位(數字)012
       sfdcud013 LIKE sfdc_t.sfdcud013, #自定義欄位(數字)013
       sfdcud014 LIKE sfdc_t.sfdcud014, #自定義欄位(數字)014
       sfdcud015 LIKE sfdc_t.sfdcud015, #自定義欄位(數字)015
       sfdcud016 LIKE sfdc_t.sfdcud016, #自定義欄位(數字)016
       sfdcud017 LIKE sfdc_t.sfdcud017, #自定義欄位(數字)017
       sfdcud018 LIKE sfdc_t.sfdcud018, #自定義欄位(數字)018
       sfdcud019 LIKE sfdc_t.sfdcud019, #自定義欄位(數字)019
       sfdcud020 LIKE sfdc_t.sfdcud020, #自定義欄位(數字)020
       sfdcud021 LIKE sfdc_t.sfdcud021, #自定義欄位(日期時間)021
       sfdcud022 LIKE sfdc_t.sfdcud022, #自定義欄位(日期時間)022
       sfdcud023 LIKE sfdc_t.sfdcud023, #自定義欄位(日期時間)023
       sfdcud024 LIKE sfdc_t.sfdcud024, #自定義欄位(日期時間)024
       sfdcud025 LIKE sfdc_t.sfdcud025, #自定義欄位(日期時間)025
       sfdcud026 LIKE sfdc_t.sfdcud026, #自定義欄位(日期時間)026
       sfdcud027 LIKE sfdc_t.sfdcud027, #自定義欄位(日期時間)027
       sfdcud028 LIKE sfdc_t.sfdcud028, #自定義欄位(日期時間)028
       sfdcud029 LIKE sfdc_t.sfdcud029, #自定義欄位(日期時間)029
       sfdcud030 LIKE sfdc_t.sfdcud030  #自定義欄位(日期時間)030
END RECORD
#161109-00085#62 --e add

   LET r_success = TRUE

   #备注：如果工单备料同工单+部位+作业编号+作业序的发料单位不同，又套数单身中维护了同工单不同的部位+作业+作业序，这个无法空管住的
   #因为不同单位的数量可多可少,无法确定套数单身是针对那一笔工单备料，也就无法对应到单位。
   #所以这里只空管这个工单+部位+作业+作业序已经有申请发料量了，就不允许删除
   
   #计算已申请的数量
   #160728-00032 by whitney modify start
   #SELECT SUM(sfdc007) INTO l_sfdc007_sum FROM sfdc_t,sfba_t
   # WHERE sfdcent = sfbaent
   #   AND sfdc001 = sfbadocno
   #   AND sfdc002 = sfbaseq
   #   AND sfdc003 = sfbaseq1
   #   AND sfdcent = g_enterprise
   #   AND sfdcdocno=g_sfda_m.sfdadocno       #发料单单号
   #   AND sfbadocno= g_sfdb_d_t.sfdb001  #工单
   #   AND sfba002  = g_sfdb_d_t.sfdb003  #部位
   #   AND sfba003  = g_sfdb_d_t.sfdb004  #作业编号
   #   AND sfba004  = g_sfdb_d_t.sfdb005  #作业序
   LET l_sfdc007_sum = 0
   LET l_sql = " SELECT SUM(sfdc007) FROM sfdc_t,sfba_t ",
               "  WHERE sfdcent = sfbaent ",
               "    AND sfdc001 = sfbadocno ",
               "    AND sfdc002 = sfbaseq ",
               "    AND sfdc003 = sfbaseq1 ",
               "    AND sfdcent = ",g_enterprise,
               "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",  #发料单单号
               "    AND sfbadocno = '",g_sfdb_d_t.sfdb001,"' "   #工单
   #部位
   IF NOT cl_null(g_sfdb_d_t.sfdb003) THEN
      LET l_sql = l_sql," AND sfba002  = '",g_sfdb_d_t.sfdb003,"' "
   END IF
   #作业编号
   IF NOT cl_null(g_sfdb_d_t.sfdb004) THEN
      LET l_sql = l_sql," AND sfba003  = '",g_sfdb_d_t.sfdb004,"' "
   END IF
   #作业序
   IF NOT cl_null(g_sfdb_d_t.sfdb005) THEN
      LET l_sql = l_sql," AND sfba004  = '",g_sfdb_d_t.sfdb005,"' "
   END IF
   PREPARE get_sfdc007_pre FROM l_sql
   EXECUTE get_sfdc007_pre INTO l_sfdc007_sum
   FREE get_sfdc007_pre
   #160728-00032 by whitney modify end
   IF cl_null(l_sfdc007_sum) THEN LET l_sfdc007_sum = 0 END IF

   #删除本笔单身后的預計發料套數
   #160728-00032 by whitney modify start
   #SELECT SUM(sfdb006) INTO l_sfdb006 FROM sfdb_t
   # WHERE sfdbent  = g_enterprise
   #   AND sfdbdocno= g_sfda_m.sfdadocno       #发料单单号
   #   AND sfdb001  = g_sfdb_d_t.sfdb001  #工单单号
   #   AND sfdb003  = g_sfdb_d_t.sfdb003  #部位
   #   AND sfdb004  = g_sfdb_d_t.sfdb004  #作业
   #   AND sfdb005  = g_sfdb_d_t.sfdb005  #作业序
   #   #AND sfdb002  = #run card
   LET l_sfdb006 = 0
   LET l_sql = " SELECT SUM(sfdb006) FROM sfdb_t ",
               "  WHERE sfdbent  = ",g_enterprise,
               "    AND sfdbdocno= '",g_sfda_m.sfdadocno,"' ",  #发料单单号
               "    AND sfdb001  = '",g_sfdb_d_t.sfdb001,"' "   #工单单号
   #部位
   IF NOT cl_null(g_sfdb_d_t.sfdb003) THEN
      LET l_sql = l_sql," AND sfdb003  = '",g_sfdb_d_t.sfdb003,"' "
   END IF
   #作业编号
   IF NOT cl_null(g_sfdb_d_t.sfdb004) THEN
      LET l_sql = l_sql," AND sfdb004  = '",g_sfdb_d_t.sfdb004,"' "
   END IF
   #作业序
   IF NOT cl_null(g_sfdb_d_t.sfdb005) THEN
      LET l_sql = l_sql," AND sfdb005  = '",g_sfdb_d_t.sfdb005,"' "
   END IF
   PREPARE get_sfdb006_pre FROM l_sql
   EXECUTE get_sfdb006_pre INTO l_sfdb006
   FREE get_sfdb006_pre
   #160728-00032 by whitney modify end
   IF cl_null(l_sfdb006) THEN LET l_sfdb006=0 END IF
   LET l_sfdb006 = l_sfdb006 - g_sfdb_d_t.sfdb006
   IF l_sfdc007_sum > 0 AND l_sfdb006 = 0 THEN
      #160728-00032 by whitney modify start
      ##已存在需求申請資料，不可刪除，請刪除需求申請資料后再重新操作
      #INITIALIZE g_errparam TO NULL
      #LET g_errparam.code = 'asf-00115'
      #LET g_errparam.extend = ''
      #LET g_errparam.popup = TRUE
      #CALL cl_err()
      #LET r_success = FALSE
      #RETURN r_success
      IF cl_ask_confirm("asf-00115") THEN
        #LET l_sql = " SELECT sfdc_t.* FROM sfdc_t,sfba_t ", #161109-00085#62 mark
         #161109-00085#62 --s add
         LET l_sql = " SELECT sfdcent,sfdcsite,sfdcdocno,sfdcseq,sfdc001, ",
                     "        sfdc002,sfdc003,sfdc004,sfdc005,sfdc006, ",
                     "        sfdc007,sfdc008,sfdc009,sfdc010,sfdc011, ",
                     "        sfdc012,sfdc013,sfdc014,sfdc015,sfdc016, ",
                     "        sfdc017,sfdcud001,sfdcud002,sfdcud003,sfdcud004, ",
                     "        sfdcud005,sfdcud006,sfdcud007,sfdcud008,sfdcud009, ",
                     "        sfdcud010,sfdcud011,sfdcud012,sfdcud013,sfdcud014, ",
                     "        sfdcud015,sfdcud016,sfdcud017,sfdcud018,sfdcud019, ",
                     "        sfdcud020,sfdcud021,sfdcud022,sfdcud023,sfdcud024, ",
                     "        sfdcud025,sfdcud026,sfdcud027,sfdcud028,sfdcud029, ",
                     "        sfdcud030 ",
                     "   FROM sfdc_t,sfba_t ",
         #161109-00085#62 --e add
                     "  WHERE sfdcent = sfbaent ",
                     "    AND sfdc001 = sfbadocno ",
                     "    AND sfdc002 = sfbaseq ",
                     "    AND sfdc003 = sfbaseq1 ",
                     "    AND sfdcent = ",g_enterprise,
                     "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",  #发料单单号
                     "    AND sfbadocno = '",g_sfdb_d_t.sfdb001,"' "   #工单
         #部位
         IF NOT cl_null(g_sfdb_d_t.sfdb003) THEN
            LET l_sql = l_sql," AND sfba002  = '",g_sfdb_d_t.sfdb003,"' "
         END IF
         #作业编号
         IF NOT cl_null(g_sfdb_d_t.sfdb004) THEN
            LET l_sql = l_sql," AND sfba003  = '",g_sfdb_d_t.sfdb004,"' "
         END IF
         #作业序
         IF NOT cl_null(g_sfdb_d_t.sfdb005) THEN
            LET l_sql = l_sql," AND sfba004  = '",g_sfdb_d_t.sfdb005,"' "
         END IF
         PREPARE del_sfdc_pre FROM l_sql
         DECLARE del_sfdc_cur CURSOR FOR del_sfdc_pre
         INITIALIZE l_sfdc.* TO NULL
        #FOREACH del_sfdc_cur INTO l_sfdc.* #161109-00085#62 mark
         #161109-00085#62 --s add
         FOREACH del_sfdc_cur INTO l_sfdc.sfdcent,l_sfdc.sfdcsite,l_sfdc.sfdcdocno,l_sfdc.sfdcseq,l_sfdc.sfdc001,
                                   l_sfdc.sfdc002,l_sfdc.sfdc003,l_sfdc.sfdc004,l_sfdc.sfdc005,l_sfdc.sfdc006,
                                   l_sfdc.sfdc007,l_sfdc.sfdc008,l_sfdc.sfdc009,l_sfdc.sfdc010,l_sfdc.sfdc011,
                                   l_sfdc.sfdc012,l_sfdc.sfdc013,l_sfdc.sfdc014,l_sfdc.sfdc015,l_sfdc.sfdc016,
                                   l_sfdc.sfdc017,l_sfdc.sfdcud001,l_sfdc.sfdcud002,l_sfdc.sfdcud003,l_sfdc.sfdcud004,
                                   l_sfdc.sfdcud005,l_sfdc.sfdcud006,l_sfdc.sfdcud007,l_sfdc.sfdcud008,l_sfdc.sfdcud009,
                                   l_sfdc.sfdcud010,l_sfdc.sfdcud011,l_sfdc.sfdcud012,l_sfdc.sfdcud013,l_sfdc.sfdcud014,
                                   l_sfdc.sfdcud015,l_sfdc.sfdcud016,l_sfdc.sfdcud017,l_sfdc.sfdcud018,l_sfdc.sfdcud019,
                                   l_sfdc.sfdcud020,l_sfdc.sfdcud021,l_sfdc.sfdcud022,l_sfdc.sfdcud023,l_sfdc.sfdcud024,
                                   l_sfdc.sfdcud025,l_sfdc.sfdcud026,l_sfdc.sfdcud027,l_sfdc.sfdcud028,l_sfdc.sfdcud029,
                                   l_sfdc.sfdcud030
         #161109-00085#62 --e add         
         IF NOT asft310_del_sfdc(l_sfdc.*) THEN
               LET r_success = FALSE
               EXIT FOREACH
            END IF
         END FOREACH
         FREE del_sfdc_pre
         CALL asft310_b_fill_sfdc()
      ELSE
         LET r_success = FALSE
      END IF
      #160728-00032 by whitney modify end
   END IF

#   #根据sfdc去判断所删除工单的各个项次，各项序中其最大的套数，是否超过套数单身的套数
#   #定义：抓出工单项次中，有项序的数量
#   LET l_sql = " SELECT sfba022,SUM(sfdc007) ",  #替代率，申请数量
#               "   FROM sfdc_t,sfba_t ",
#               "  WHERE sfdcent = sfbaent ",
#               "    AND sfdc001 = sfbadocno ",
#               "    AND sfdc002 = sfbaseq ",
#               "    AND sfdc003 = sfbaseq1 ",
#               "    AND sfdcent = ",g_enterprise,
#               "    AND sfdcdocno='",g_sfda_m.sfdadocno,"' ",      #发料单单号
#               "    AND sfdc001  ='",g_sfdb_d[l_ac].sfdb001,"' ",  #工单
#               "    AND sfba002  ='",g_sfdb_d[l_ac].sfdb003,"' ",  #部位
#               "    AND sfba003  ='",g_sfdb_d[l_ac].sfdb004,"' ",  #作业编号
#               "    AND sfba004  ='",g_sfdb_d[l_ac].sfdb005,"' ",  #作业序
#               "    AND sfdc002  = ? ",    #工单项次
#               "    AND sfdc003  != 0 ",   #工单项序
#               " GROUP BY sfba022 "
#   PREPARE s_asft310_del_sfdb_chk_p2 FROM l_sql
#   IF SQLCA.sqlcode THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = SQLCA.sqlcode
#      LET g_errparam.extend = 's_asft310_del_sfdb_chk_p2'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#
#      RETURN r_success
#   END IF
#   DECLARE s_asft310_del_sfdb_chk_cs2 CURSOR FOR s_asft310_del_sfdb_chk_p2
#   IF SQLCA.sqlcode THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = SQLCA.sqlcode
#      LET g_errparam.extend = 's_asft310_del_sfdb_chk_cs2'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#
#      RETURN r_success
#   END IF
#   
#   #工单项次、标准QPA分子、标准QPA分母
#   #发料单位、申请数量
#   LET l_sql = " SELECT sfdc002,sfba010,sfba011, ", 
#               "        sfdc006,SUM(sfdc007) ",
#               "   FROM sfdc_t,sfba_t ",
#               "  WHERE sfdcent = sfbaent ",
#               "    AND sfdc001 = sfbadocno ",
#               "    AND sfdc002 = sfbaseq ",
#               "    AND sfdc003 = sfbaseq1 ",
#               "    AND sfdcent = ",g_enterprise,
#               "    AND sfdcdocno='",g_sfda_m.sfdadocno,"' ",      #发料单单号
#               "    AND sfdc001  ='",g_sfdb_d[l_ac].sfdb001,"' ",  #工单
#               "    AND sfba002  ='",g_sfdb_d[l_ac].sfdb003,"' ",  #部位
#               "    AND sfba003  ='",g_sfdb_d[l_ac].sfdb004,"' ",  #作业编号
#               "    AND sfba004  ='",g_sfdb_d[l_ac].sfdb005,"' ",  #作业序
#               "    AND sfdc003  = 0 ",   #工单项序
#               " GROUP BY sfdc002,sfba010,sfba011, ", 
#               "        sfdc006 "
#   PREPARE s_asft310_del_sfdb_chk_p1 FROM l_sql
#   IF SQLCA.sqlcode THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = SQLCA.sqlcode
#      LET g_errparam.extend = 's_asft310_del_sfdb_chk_p1'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#
#      RETURN r_success
#   END IF
#   DECLARE s_asft310_del_sfdb_chk_cs1 CURSOR FOR s_asft310_del_sfdb_chk_p1
#   IF SQLCA.sqlcode THEN
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = SQLCA.sqlcode
#      LET g_errparam.extend = 's_asft310_del_sfdb_chk_cs1'
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#
#      RETURN r_success
#   END IF
#   LET l_max_sets = 0
#   LET l_tot_sfdc007 = 0
#   FOREACH s_asft310_del_sfdb_chk_cs1 INTO l_sfdc002,l_sfba010,l_sfba011,
#                l_sfdc006,l_sfdc007
#      IF SQLCA.sqlcode THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = SQLCA.sqlcode
#         LET g_errparam.extend = 's_asft310_del_sfdb_chk_cs1'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#
#         LET r_success = FALSE
#         RETURN r_success
#      END IF
#
#      LET l_tot_sfdc007 = l_tot_sfdc007 + l_sfdc007
#      
#      #抓出工单项次中，有项序的数量（取替代）
#      FOREACH s_asft310_del_sfdb_chk_cs2 USING l_tot.sfbaseq INTO l_sfba022,l_sfdc007
#         IF SQLCA.sqlcode THEN
#            INITIALIZE g_errparam TO NULL
#            LET g_errparam.code = SQLCA.sqlcode
#            LET g_errparam.extend = 's_asft310_del_sfdb_chk_cs1'
#            LET g_errparam.popup = TRUE
#            CALL cl_err()
#
#            LET r_success = FALSE
#            RETURN r_success
#         END IF
#         
#         LET l_tot_sfdc007 = l_tot_sfdc007 + l_sfdc007 * l_sfba022
#      
#      END FOREACH
#   
#      
#      #单项足套数=(SUM(已发数量*替代率) / 项序0的标准QPA分子 * 项序0的标准QPA分母 WHERE 相同工单+项次)
#      LET l_sets = l_tot_sfdc007 / l_sfba010 * l_sfba011 
#
#      IF l_max_sets < l_sets THEN
#         LET l_max_sets = l_sets
#      END IF
#
#      LET l_tot_sfdc007 = 0
#   END FOREACH
#
#   IF l_sfdb006 < l_max_sets THEN
#      #删除后已存在需求申请数量大于套数设定可申请数量，不可删除，请修改需求申请数据后再重新操作
#      INITIALIZE g_errparam TO NULL
#      LET g_errparam.code = 'asf-00116'
#      LET g_errparam.extend = ''
#      LET g_errparam.popup = TRUE
#      CALL cl_err()
#
#      LET r_success = FALSE
#      RETURN r_success
#   END IF

#      #计算删除此笔单身后可申请的数量
#      CASE
#        WHEN g_sfda_m.sfda002='11' OR g_sfda_m.sfda002='21'  #11.成套發料 21.成套退料 
#                       #计算此本发退料单中，删除此笔后的工单+项次+项序+料的可产生的发料数量（套数的数量）与sfdc中已存储的比较
#   
#   
#           IF l_sfdb006 = l_sfaa012 - l_sfaa049 THEN  #預計發料套數=生產數量-已發套數,即要把剩余
#              #應發總數量-已發數量-本发料单据其他项次的发料数量
#              LET l_sfdc007 = g_sfdc_d[l_ac].sfba013 - g_sfdc_d[l_ac].sfba016 - l_sfdc007
#           ELSE
#              #預計發料套數*標準QPA分子/標準QPA分母-本发料单据其他项次的发料数量
#              LET l_sfdc007 = l_sfdb006 * l_sfba010 / l_sfba011 - l_sfdc007
#           END IF
#                       #如果小于则不能删除
#        WHEN g_sfda_m.sfda002='13'   #13.欠料補料的单据  发料套数是不允许输入的
#                       #计算此本发退料单中，删除此笔后的工单+项次+项序+料的可产生的发料数量（补料的数量）与sfdc中已存储的比较
#                       #如果小于则不能删除
#           IF l_sfaa012 = l_sfaa049 THEN   #生產數量=已發套數
#              #應發總數量-已發數量-本发料单据其他项次的发料数量
#              LET r_sfdc007 = g_sfdc_d[l_ac].sfba013 - g_sfdc_d[l_ac].sfba016 - l_sfdc007
#           ELSE
#              #(已發料套數*標準QPA分子/標準QPA分母)-已發數量-本发料单据其他项次的发料数量
#              LET r_sfdc007 = l_sfaa049 * l_sfba010 / l_sfba011 - g_sfdc_d[l_ac].sfba016 - l_sfdc007
#           END IF
#        END CASE
#   
#   END FOREACH

   RETURN r_success
END FUNCTION
#检查库位、储位、批号的范围(sfdf)，是否在需求指定发料库位、储位、批号允许的数量内(sfdc)
#sfdf编辑状态时调用
#仓储批检查
PRIVATE FUNCTION asft310_chk_ware_range(p_column)
DEFINE p_column     LIKE type_t.chr10  #检查类型
DEFINE r_success    LIKE type_t.num5
DEFINE l_cnt        LIKE type_t.num5
DEFINE l_sql        STRING

   LET r_success = TRUE

   CASE p_column
      #add 141211
      WHEN 'sfdf003'  #库位
           IF cl_null(g_sfdf_d[l_ac].sfdf003) THEN
              ##若储位是空，检查sfdf对应的sfde对应的多笔sfdc中有储位为空的资料吗？
              #IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
              #   LET l_sql = " SELECT COUNT(sfdcseq) ",
              #               "   FROM sfdc_t ",
              #               "  WHERE sfdcent   = ",g_enterprise,
              #               "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
              #               "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
              #               "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
              #               "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
              #               "    AND sfdc012   = ' ' "    #庫位
              #   IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
              #      LET l_sql = l_sql CLIPPED,
              #            "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
              #            "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
              #            "         where sfbaent  = ",g_enterprise,
              #            "           and sfbasite = '",g_site,"') ",
              #            "       or (sfdc001,sfdc002,sfdc003) in ",
              #            "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
              #            "         where sfbaent  = ",g_enterprise,
              #            "           and sfbasite = '",g_site,"' ",
              #            "           and sfba028 IS NULL)) "
              #   END IF
              #ELSE
              #   LET l_sql = " SELECT COUNT(sfdcseq) ",
              #               "   FROM sfdc_t,sfba_t ",
              #               "  WHERE sfdcent   = sfbaent ",
              #               "    AND sfdc001   = sfbadocno ",
              #               "    AND sfdc002   = sfbaseq ",
              #               "    AND sfdc003   = sfbaseq1 ",
              #               "    AND sfdcent   = ",g_enterprise,
              #               "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
              #               "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
              #               "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
              #               "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
              #               "    AND sfdc012   = ' ' "    #庫位
              #   IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
              #      LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
              #   END IF
              #END IF
              #IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
              #   LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              #ELSE
              #   LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              #END IF
              #DECLARE asft310_chk_ware_range_c1 SCROLL CURSOR FROM l_sql
              #OPEN asft310_chk_ware_range_c1
              #FETCH asft310_chk_ware_range_c1 INTO l_cnt
              #CLOSE asft310_chk_ware_range_c1
              #IF l_cnt = 0 THEN
              #   #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
              #   INITIALIZE g_errparam TO NULL
              #   LET g_errparam.code = 'asf-00131'
              #   LET g_errparam.extend = ''
              #   LET g_errparam.popup = TRUE
              #   CALL cl_err()
              #   LET r_success = FALSE
              #   RETURN r_success
              #END IF
           ELSE
              #若储位非空，检查sfdf对应的sfde对应的多笔sfdc中有储位为空的资料或储位为输入的资料吗？
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') "    #庫位
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                        "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"') ",
                        "       or (sfdc001,sfdc002,sfdc003) in ",
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"' ",
                        "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') "    #庫位
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c01 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c01
              FETCH asft310_chk_ware_range_c01 INTO l_cnt
              CLOSE asft310_chk_ware_range_c01
              IF l_cnt = 0 THEN
                 #如果没有报错：库位、储位、批号不在需求指定储位范围内，请输入需求申请指定库位、储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
      #add 141211 end
      WHEN 'sfdf004'  #储位
           IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN
              #若储位是空，检查sfdf对应的sfde对应的多笔sfdc中有储位为空的资料吗？
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc013   = ' ' "  #儲位
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                          "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"') ",
                          "       or (sfdc001,sfdc002,sfdc003) in ",
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"' ",
                          "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位 #mod 141211
                             "    AND sfdc013   = ' ' "  #儲位
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c1 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c1
              FETCH asft310_chk_ware_range_c1 INTO l_cnt
              CLOSE asft310_chk_ware_range_c1
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           ELSE
              #若储位非空，检查sfdf对应的sfde对应的多笔sfdc中有储位为空的资料或储位为输入的资料吗？
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc013  = '",g_sfdf_d[l_ac].sfdf004,"' OR sfdc013 = ' ') "  #儲位
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                        "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"') ",
                        "       or (sfdc001,sfdc002,sfdc003) in ",
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"' ",
                        "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc013  = '",g_sfdf_d[l_ac].sfdf004,"' OR sfdc013 = ' ') "  #儲位
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c11 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c11
              FETCH asft310_chk_ware_range_c11 INTO l_cnt
              CLOSE asft310_chk_ware_range_c11
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
      WHEN 'sfdf005'  #批号
           IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN
              #若批号是空，检查sfdf对应的sfde对应的多笔sfdc中有批号为空的资料吗？
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc014   = ' ' "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                        "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"') ",
                        "       or (sfdc001,sfdc002,sfdc003) in ",
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"' ",
                        "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc014   = ' ' "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c2 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c2
              FETCH asft310_chk_ware_range_c2 INTO l_cnt
              CLOSE asft310_chk_ware_range_c2
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           ELSE
              #若批号非空，检查sfdf对应的sfde对应的多笔sfdc中有批号为空的资料或批号为输入的资料吗？
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc014  = '",g_sfdf_d[l_ac].sfdf005,"' OR sfdc014 = ' ') "  #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                          "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"') ",
                          "       or (sfdc001,sfdc002,sfdc003) in ",
                          "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                          "         where sfbaent  = ",g_enterprise,
                          "           and sfbasite = '",g_site,"' ",
                          "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",  #庫位#mod 141211
                             "    AND (sfdc014  = '",g_sfdf_d[l_ac].sfdf005,"' OR sfdc014 = ' ') "  #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c21 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c21
              FETCH asft310_chk_ware_range_c21 INTO l_cnt
              CLOSE asft310_chk_ware_range_c21
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
      WHEN 'ALL'  #单笔输入完后，储位+批号
           #如果储位和批号都是空，检查sfdf对应的sfde对应的多笔sfdc中是否有1.储位+批号都是空的资料
           IF cl_null(g_sfdf_d[l_ac].sfdf004) AND cl_null(g_sfdf_d[l_ac].sfdf005) THEN
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc013   = ' ' ",   #储位
                             "    AND sfdc014   = ' ' "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                         "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                         "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                         "         where sfbaent  = ",g_enterprise,
                         "           and sfbasite = '",g_site,"') ",
                         "       or (sfdc001,sfdc002,sfdc003) in ",
                         "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                         "         where sfbaent  = ",g_enterprise,
                         "           and sfbasite = '",g_site,"' ",
                         "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc013   = ' ' ",   #储位
                             "    AND sfdc014   = ' ' "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c3 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c3
              FETCH asft310_chk_ware_range_c3 INTO l_cnt
              CLOSE asft310_chk_ware_range_c3
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
           #如果储位和批号都非空，检查sfdf对应的sfde对应的多笔sfdc中是否有1.储位+批号都是空的资料   
           #                                                          2.储位为输入储位+批号是空的资料 
           #                                                          3.储位是空+批号为输入批号的资料 
           #                                                          4.储位+批号都为输入的资料 
           IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) AND NOT cl_null(g_sfdf_d[l_ac].sfdf005) THEN
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc013  = '",g_sfdf_d[l_ac].sfdf004,"' OR sfdc013 = ' ') ",   #储位
                             "    AND (sfdc014  = '",g_sfdf_d[l_ac].sfdf005,"' OR sfdc014 = ' ') "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                        "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"') ",
                        "       or (sfdc001,sfdc002,sfdc003) in ",
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"' ",
                        "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc013  = '",g_sfdf_d[l_ac].sfdf004,"' OR sfdc013 = ' ') ",   #储位
                             "    AND (sfdc014  = '",g_sfdf_d[l_ac].sfdf005,"' OR sfdc014 = ' ') "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c31 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c31
              FETCH asft310_chk_ware_range_c31 INTO l_cnt
              CLOSE asft310_chk_ware_range_c31
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
           #如果储位为空、批号非空，检查sfdf对应的sfde对应的多笔sfdc中是否有1.储位+批号都是空的资料
           #                                                            3.储位是空+批号为输入批号的资料
           IF cl_null(g_sfdf_d[l_ac].sfdf004) AND NOT cl_null(g_sfdf_d[l_ac].sfdf005) THEN
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc013 = ' ' ",   #储位
                             "    AND (sfdc014  = '",g_sfdf_d[l_ac].sfdf005,"' OR sfdc014 = ' ') "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                      "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                      "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                      "         where sfbaent  = ",g_enterprise,
                      "           and sfbasite = '",g_site,"') ",
                      "       or (sfdc001,sfdc002,sfdc003) in ",
                      "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                      "         where sfbaent  = ",g_enterprise,
                      "           and sfbasite = '",g_site,"' ",
                      "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND sfdc013 = ' ' ",   #储位
                             "    AND (sfdc014  = '",g_sfdf_d[l_ac].sfdf005,"' OR sfdc014 = ' ') "    #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c32 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c32
              FETCH asft310_chk_ware_range_c32 INTO l_cnt
              CLOSE asft310_chk_ware_range_c32
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
           #如果储位非空、批号为空，检查sfdf对应的sfde对应的多笔sfdc中是否有1.储位+批号都是空的资料
           #                                                            2.储位为输入储位+批号是空的资料
           IF NOT cl_null(g_sfdf_d[l_ac].sfdf004) AND cl_null(g_sfdf_d[l_ac].sfdf005) THEN
              IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t ",
                             "  WHERE sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc013  = '",g_sfdf_d[l_ac].sfdf004,"' OR sfdc013 = ' ') ",  #储位
                             "    AND sfdc014 = ' '  "   #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED,
                        "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"') ",
                        "       or (sfdc001,sfdc002,sfdc003) in ",
                        "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                        "         where sfbaent  = ",g_enterprise,
                        "           and sfbasite = '",g_site,"' ",
                        "           and sfba028 IS NULL)) "
                 END IF
              ELSE
                 LET l_sql = " SELECT COUNT(sfdcseq) ",
                             "   FROM sfdc_t,sfba_t ",
                             "  WHERE sfdcent   = sfbaent ",
                             "    AND sfdc001   = sfbadocno ",
                             "    AND sfdc002   = sfbaseq ",
                             "    AND sfdc003   = sfbaseq1 ",
                             "    AND sfdcent   = ",g_enterprise,
                             "    AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ", 
                             "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",    #需求料号
                             "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",    #特征
                             "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' ",    #单位
                             #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' ",    #庫位
                             "    AND (sfdc012  = '",g_sfdf_d[l_ac].sfdf003,"' OR sfdc012 = ' ') ",   #庫位#mod 141211
                             "    AND (sfdc013  = '",g_sfdf_d[l_ac].sfdf004,"' OR sfdc013 = ' ') ",  #储位
                             "    AND sfdc014 = ' '  "   #批号
                 IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
                    LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
                 END IF
              END IF
              IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
                 LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
              ELSE
                 LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
              END IF
              DECLARE asft310_chk_ware_range_c33 SCROLL CURSOR FROM l_sql
              OPEN asft310_chk_ware_range_c33
              FETCH asft310_chk_ware_range_c33 INTO l_cnt
              CLOSE asft310_chk_ware_range_c33
              IF l_cnt = 0 THEN
                 #如果没有报错：储位、批号不在需求指定储位范围内，请输入需求申请指定储位、批号
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00131'
                 LET g_errparam.extend = ''
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 LET r_success = FALSE
                 RETURN r_success
              END IF
           END IF
      OTHERWISE
           RETURN r_success
   END CASE

   RETURN r_success

END FUNCTION
#检查单身仓储批+库存管理特征+单位+参考单位不重复
#若不控管住，sfdf与sfdc,sfdd,sfde各表的分配关系会比较混乱
#同时相同资料，不应该存在多笔资料，造成资料冗余
PRIVATE FUNCTION asft310_chk_sfdf_unique()
DEFINE r_success    LIKE type_t.num5
DEFINE l_cnt        LIKE type_t.num5

   LET r_success = TRUE

   IF g_sfdf_d[l_ac].sfdf003 IS NULL OR g_sfdf_d[l_ac].sfdf004 IS NULL OR g_sfdf_d[l_ac].sfdf005 IS NULL
   OR g_sfdf_d[l_ac].sfdf010 IS NULL OR cl_null(g_sfdf_d[l_ac].sfdf006) OR cl_null(g_sfdf_d[l_ac].sfdf008) THEN
      RETURN r_success
   END IF

   #只可存在一笔
   IF g_sfdf_d[l_ac].sfdf008 IS NULL THEN
      SELECT COUNT(1) INTO l_cnt FROM sfdf_t
       WHERE sfdfent  = g_enterprise
         AND sfdfdocno= g_sfda_m.sfdadocno   #發退料單號
         AND sfdfseq  = g_sfde_d[g_detail_idx].sfdeseq  #項次
         AND sfdf003  = g_sfdf_d[l_ac].sfdf003 #庫位
         AND sfdf004  = g_sfdf_d[l_ac].sfdf004 #儲位
         AND sfdf005  = g_sfdf_d[l_ac].sfdf005 #批號
         AND sfdf010  = g_sfdf_d[l_ac].sfdf010 #库存管理特征
         AND sfdf006  = g_sfdf_d[l_ac].sfdf006 #单位
         AND sfdf008  IS NULL   #参考单位
   ELSE
      SELECT COUNT(1) INTO l_cnt FROM sfdf_t
       WHERE sfdfent  = g_enterprise
         AND sfdfdocno= g_sfda_m.sfdadocno   #發退料單號
         AND sfdfseq  = g_sfde_d[g_detail_idx].sfdeseq  #項次
         AND sfdf003  = g_sfdf_d[l_ac].sfdf003 #庫位
         AND sfdf004  = g_sfdf_d[l_ac].sfdf004 #儲位
         AND sfdf005  = g_sfdf_d[l_ac].sfdf005 #批號
         AND sfdf010  = g_sfdf_d[l_ac].sfdf010 #库存管理特征
         AND sfdf006  = g_sfdf_d[l_ac].sfdf006 #单位
         AND sfdf008  = g_sfdf_d[l_ac].sfdf008 #参考单位
   END IF
   IF l_cnt > 0 THEN
      #已存在相同数据，不可重复输入；请在已存在的数据中修改
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00123'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION
#回写sfde的实际数量，参考单位实际数量
#sfdf单身编辑状态调用
PRIVATE FUNCTION asft310_upd_sfde005()
DEFINE r_success      LIKE type_t.num5
DEFINE l_sfdf007_sum  LIKE sfdf_t.sfdf007
DEFINE l_sfdf009_sum  LIKE sfdf_t.sfdf009

   LET r_success = TRUE
   
   LET l_sfdf007_sum = 0
   LET l_sfdf009_sum = 0
   SELECT SUM(sfdf007),SUM(sfdf009) INTO l_sfdf007_sum,l_sfdf009_sum
     FROM sfdf_t
    WHERE sfdfent   = g_enterprise
      AND sfdfdocno = g_sfda_m.sfdadocno
      AND sfdfseq   = g_sfde_d[g_detail_idx].sfdeseq
   IF cl_null(l_sfdf007_sum) THEN LET l_sfdf007_sum = 0 END IF
   IF cl_null(l_sfdf009_sum) THEN LET l_sfdf009_sum = 0 END IF
   UPDATE sfde_t SET sfde005 = l_sfdf007_sum,
                     sfde008 = l_sfdf009_sum
    WHERE sfdeent   = g_enterprise
      AND sfdedocno = g_sfda_m.sfdadocno
      AND sfdeseq   = g_sfde_d[g_detail_idx].sfdeseq
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd sfde'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION
#检查库位、储位、批号的范围(sfdf)，是否在需求指定发料库位、储位、批号允许的数量内(sfdc)
#sfdf编辑状态时调用
#数量检查
PRIVATE FUNCTION asft310_chk_ware_range_qty(p_column)
DEFINE p_column      LIKE type_t.chr10  #检查类型
DEFINE r_success   LIKE type_t.num5
DEFINE l_sql       STRING
DEFINE l_sql1      STRING
DEFINE l_sfdc012   LIKE sfdc_t.sfdc012  #仓
DEFINE l_sfdc013   LIKE sfdc_t.sfdc013  #储
DEFINE l_sfdc014   LIKE sfdc_t.sfdc014  #批
DEFINE l_sfdc007   LIKE sfdc_t.sfdc007  #数量
DEFINE l_sfdc010   LIKE sfdc_t.sfdc010  #参考单位数量
DEFINE l_sfdc_d    DYNAMIC ARRAY OF RECORD
                   sfdc012    LIKE sfdc_t.sfdc012,  #仓
                   sfdc013    LIKE sfdc_t.sfdc013,  #储
                   sfdc014    LIKE sfdc_t.sfdc014,  #批
                   sfdc007    LIKE sfdc_t.sfdc007,  #数量
                   sfdc010    LIKE sfdc_t.sfdc010   #参考单位数量
                   END RECORD
DEFINE l_cnt_sfdc   LIKE type_t.num5  #笔数
#161109-00085#29-s   
#DEFINE l_sfdf         RECORD LIKE sfdf_t.*
DEFINE l_sfdf RECORD  #發退料倉儲批匯總檔
       sfdf001 LIKE sfdf_t.sfdf001, #發退料料號
       sfdf002 LIKE sfdf_t.sfdf002, #替代率
       sfdf003 LIKE sfdf_t.sfdf003, #庫位
       sfdf004 LIKE sfdf_t.sfdf004, #儲位
       sfdf005 LIKE sfdf_t.sfdf005, #批號
       sfdf006 LIKE sfdf_t.sfdf006, #單位
       sfdf007 LIKE sfdf_t.sfdf007, #數量
       sfdf009 LIKE sfdf_t.sfdf009  #參考單位數量
END RECORD
#161109-00085#29-e
DEFINE l_sfdf_d    DYNAMIC ARRAY OF RECORD
                   sfdf003    LIKE sfdf_t.sfdf003,  #仓
                   sfdf004    LIKE sfdf_t.sfdf004,  #储
                   sfdf005    LIKE sfdf_t.sfdf005,  #批
                   sfdf007    LIKE sfdf_t.sfdf007,  #按换算率折算成sfdc的数量
                   sfdf009    LIKE sfdf_t.sfdf009   #按换算率折算成sfdc的参考单位数量
                   END RECORD
DEFINE l_cnt_sfdf   LIKE type_t.num5  #笔数
DEFINE l_cnt_b      LIKE type_t.num5  #笔数
DEFINE l_rate       LIKE sfdf_t.sfdf002     #sfde与sfdf数量的换算率 目标sfde
DEFINE l_idx        LIKE type_t.num5
DEFINE l_idx2       LIKE type_t.num5

   LET r_success = TRUE

   #CASE p_column
   #   WHEN 'sfdf007'  #数量
   #   WHEN 'sfdf009'  #参考单位数量
   #   WHEN 'ALL'      #单笔输入完后，储位、批号数量是否超出需求指定范围内的数量、参考单位数量
   #   OTHERWISE
   #        RETURN r_success
   #END CASE
   #RETURN r_success

   #检查
   IF cl_null(g_sfdf_d[l_ac].sfdf003)  #仓储批 仓库画面控制必须输入
   OR cl_null(g_sfdf_d[l_ac].sfdf006) OR cl_null(g_sfdf_d[l_ac].sfdf007) #单位、数量
   OR cl_null(g_sfdf_d[l_ac].sfdf008) OR cl_null(g_sfdf_d[l_ac].sfdf009) #单位、数量
   OR cl_null(g_sfdf_d[l_ac].sfdf002) THEN #换算率
      RETURN r_success  #不满足检查条件，不需要检查
   END IF

   IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN LET g_sfdf_d[l_ac].sfdf004=' ' END IF
   IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN LET g_sfdf_d[l_ac].sfdf005=' ' END IF
   
   #-------->取出sfdf对应的sfde，所对应所有sfdc
   #库位为必输的排除一部分，提高效能
   IF g_sfde_d[g_detail_idx].sfde009 IS NULL THEN
      LET l_sql = " SELECT sfdc012,sfdc013,sfdc014,SUM(sfdc007),SUM(sfdc010) ",
                  "   FROM sfdc_t ",
                  "  WHERE sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno ='",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",  #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",  #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "   #单位
                  #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' "     #库位 #mark 141211
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED,
                  "   AND ((sfdc001,sfdc002,sfdc003) not in ",    #满足客供料：工单单号\项次\相序
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"') ",
                  "       or (sfdc001,sfdc002,sfdc003) in ",
                  "       (select sfbadocno,sfbaseq,sfbaseq1 from sfba_t ",
                  "         where sfbaent  = ",g_enterprise,
                  "           and sfbasite = '",g_site,"' ",
                  "           and sfba028 IS NULL)) "
      END IF
   ELSE
      LET l_sql = " SELECT sfdc012,sfdc013,sfdc014,SUM(sfdc007),SUM(sfdc010) ",
                  "   FROM sfdc_t,sfba_t ",
                  "  WHERE sfdcent   = sfbaent ",
                  "    AND sfdc001   = sfbadocno ",
                  "    AND sfdc002   = sfbaseq ",
                  "    AND sfdc003   = sfbaseq1 ",
                  "    AND sfdcent   = ",g_enterprise,
                  "    AND sfdcdocno ='",g_sfda_m.sfdadocno,"' ",
                  "    AND sfdc004   = '",g_sfde_d[g_detail_idx].sfde001,"' ",  #需求料号
                  "    AND sfdc005   = '",g_sfde_d[g_detail_idx].sfde002,"' ",  #特征
                  "    AND sfdc006   = '",g_sfde_d[g_detail_idx].sfde003,"' "   #单位
                  #"    AND sfdc012   = '",g_sfdf_d[l_ac].sfdf003,"' "     #库位 #mark 141211
      IF g_prog[1,6] = 'asft31' THEN  #退料不记录客供料
         LET l_sql = l_sql CLIPPED," AND sfba028 = '",g_sfde_d[g_detail_idx].sfde009,"' "    #客供料
      END IF
   END IF
   IF g_sfde_d[g_detail_idx].sfde006 IS NULL THEN
      LET l_sql = l_sql CLIPPED," AND sfdc009 IS NULL "
   ELSE
      LET l_sql = l_sql CLIPPED," AND sfdc009 = '",g_sfde_d[g_detail_idx].sfde006,"' "
   END IF
   LET l_sql = l_sql CLIPPED,"  GROUP BY sfdc012,sfdc013,sfdc014 ",
                             "  ORDER BY sfdc014 desc,sfdc013 desc "
   LET l_cnt_sfdc = 0
   PREPARE asft310_chk_ware_range_qty_p1 FROM l_sql
   DECLARE asft310_chk_ware_range_qty_c1 CURSOR FOR asft310_chk_ware_range_qty_p1
   FOREACH asft310_chk_ware_range_qty_c1 INTO l_sfdc012,l_sfdc013,l_sfdc014,l_sfdc007,l_sfdc010
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      LET l_cnt_sfdc = l_cnt_sfdc + 1
      LET l_sfdc_d[l_cnt_sfdc].sfdc012 = l_sfdc012  #仓
      LET l_sfdc_d[l_cnt_sfdc].sfdc013 = l_sfdc013  #储
      LET l_sfdc_d[l_cnt_sfdc].sfdc014 = l_sfdc014  #批
      LET l_sfdc_d[l_cnt_sfdc].sfdc007 = l_sfdc007  #数量--申请的
      LET l_sfdc_d[l_cnt_sfdc].sfdc010 = l_sfdc010  #参考单位数量--申请的
   END FOREACH

   #-------->取出当前sfdf单身除当笔sfdf外所有sfdf
   #库位为必输的排除一部分，提高效能
   #161109-00085#29-s   
   #LET l_sql = " SELECT * FROM sfdf_t ",               
   LET l_sql = " SELECT sfdf001,sfdf002,sfdf003,sfdf004,sfdf005,sfdf006,sfdf007,sfdf009 ",
               "   FROM sfdf_t ",               
   #161109-00085#29-e
               "  WHERE sfdfent   = ",g_enterprise,
               "    AND sfdfdocno ='",g_sfda_m.sfdadocno,"' ",
               "    AND sfdfseq   = '",g_sfde_d[g_detail_idx].sfdeseq,"' "   #项次
   IF NOT cl_null(g_sfdf_d_t.sfdfseq1) THEN #修改去除当笔
      LET l_sql = l_sql CLIPPED," AND sfdfseq1 != ",g_sfdf_d_t.sfdfseq1
   END IF
   LET l_sql = l_sql CLIPPED," ORDER BY sfdf005 desc,sfdf004 desc "
   PREPARE asft310_chk_ware_range_qty_p2 FROM l_sql
   DECLARE asft310_chk_ware_range_qty_c2 CURSOR FOR asft310_chk_ware_range_qty_p2
   LET l_cnt_sfdf = 0
   #161109-00085#29-s   
   #FOREACH asft310_chk_ware_range_qty_c2 INTO l_sfdf.*
   FOREACH asft310_chk_ware_range_qty_c2
      INTO l_sfdf.sfdf001,l_sfdf.sfdf002,l_sfdf.sfdf003,l_sfdf.sfdf004,l_sfdf.sfdf005,
           l_sfdf.sfdf006,l_sfdf.sfdf007,l_sfdf.sfdf009
   #161109-00085#29-e
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach:'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
      
      #计算sfde与sfdf数量的换算率l_rate
      #mod 150101
      #IF g_sfde_d[g_detail_idx].sfde001 = l_sfdf.sfdf001 THEN   #需求料=发料料号
      #   IF g_sfde_d[g_detail_idx].sfde003 = l_sfdf.sfdf006 THEN  #需求单位=实际发料单位
      #      LET l_rate = 1
      #   ELSE
      #      CALL s_aimi190_get_convert(l_sfdf.sfdf001,l_sfdf.sfdf006,g_sfde_d[g_detail_idx].sfde003) RETURNING r_success,l_rate
      #      IF NOT r_success THEN
      #         RETURN r_success
      #      END IF 
      #   END IF
      #ELSE
      #   LET l_rate = 1/l_sfdf.sfdf002
      #END IF
      #LET l_sfdc007 = l_sfdf.sfdf007 * l_rate #按换算率折算成sfdc的数量
      #LET l_sfdc010 = l_sfdf.sfdf009 * l_rate #按换算率折算成sfdc的参考单位数量
      IF g_sfde_d[g_detail_idx].sfde001 = l_sfdf.sfdf001 THEN   #需求料=发料料号
         IF g_sfde_d[g_detail_idx].sfde003 = l_sfdf.sfdf006 THEN  #需求单位=实际发料单位
            LET l_sfdc007 = l_sfdf.sfdf007 
            LET l_sfdc010 = l_sfdf.sfdf009 
         ELSE
            CALL s_aooi250_convert_qty(l_sfdf.sfdf001,l_sfdf.sfdf006,g_sfde_d[g_detail_idx].sfde003,l_sfdf.sfdf007)
               RETURNING r_success,l_sfdc007
            IF NOT r_success THEN
               RETURN r_success
            END IF 
            CALL s_aooi250_convert_qty(l_sfdf.sfdf001,l_sfdf.sfdf006,g_sfde_d[g_detail_idx].sfde003,l_sfdf.sfdf009)
               RETURNING r_success,l_sfdc010
            IF NOT r_success THEN
               RETURN r_success
            END IF 
         END IF
      ELSE
         LET l_sfdc007 = l_sfdf.sfdf007 / l_sfdf.sfdf002
         LET l_sfdc010 = l_sfdf.sfdf009 / l_sfdf.sfdf002
      END IF
      #mod 150101 end
      
      LET l_cnt_sfdf = l_cnt_sfdf + 1
      LET l_sfdf_d[l_cnt_sfdf].sfdf003 = l_sfdf.sfdf003  #仓
      LET l_sfdf_d[l_cnt_sfdf].sfdf004 = l_sfdf.sfdf004  #储
      LET l_sfdf_d[l_cnt_sfdf].sfdf005 = l_sfdf.sfdf005  #批
      LET l_sfdf_d[l_cnt_sfdf].sfdf007 = l_sfdc007  #按换算率折算成sfdc的数量
      LET l_sfdf_d[l_cnt_sfdf].sfdf009 = l_sfdc010  #按换算率折算成sfdc的参考单位数量
   END FOREACH
   #剩余当前异动笔sfdf
   #计算sfde与sfdf数量的换算率l_rate
   #mod 150101
   #IF g_sfde_d[g_detail_idx].sfde001 = g_sfdf_d[l_ac].sfdf001 THEN   #需求料=发料料号
   #   IF g_sfde_d[g_detail_idx].sfde003 = g_sfdf_d[l_ac].sfdf006 THEN  #需求单位=实际发料单位
   #      LET l_rate = 1
   #   ELSE
   #      CALL s_aimi190_get_convert(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfde_d[g_detail_idx].sfde003) RETURNING r_success,l_rate
   #      IF NOT r_success THEN
   #         RETURN r_success
   #      END IF 
   #   END IF
   #ELSE
   #   LET l_rate = 1/g_sfdf_d[l_ac].sfdf002
   #END IF
   #LET l_sfdc007 = g_sfdf_d[l_ac].sfdf007 * l_rate #按换算率折算成sfdc的数量
   #LET l_sfdc010 = g_sfdf_d[l_ac].sfdf009 * l_rate #按换算率折算成sfdc的参考单位数量
   IF g_sfde_d[g_detail_idx].sfde001 = g_sfdf_d[l_ac].sfdf001 THEN   #需求料=发料料号
      IF g_sfde_d[g_detail_idx].sfde003 = g_sfdf_d[l_ac].sfdf006 THEN  #需求单位=实际发料单位
         LET l_sfdc007 = g_sfdf_d[l_ac].sfdf007
         LET l_sfdc010 = g_sfdf_d[l_ac].sfdf009
      ELSE
         CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfde_d[g_detail_idx].sfde003,g_sfdf_d[l_ac].sfdf007)
            RETURNING r_success,l_sfdc007
         IF NOT r_success THEN
            RETURN r_success
         END IF
         CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfde_d[g_detail_idx].sfde003,g_sfdf_d[l_ac].sfdf009)
            RETURNING r_success,l_sfdc010
         IF NOT r_success THEN
            RETURN r_success
         END IF 
      END IF
   ELSE
      LET l_sfdc007 = g_sfdf_d[l_ac].sfdf007/g_sfdf_d[l_ac].sfdf002
      LET l_sfdc010 = g_sfdf_d[l_ac].sfdf009/g_sfdf_d[l_ac].sfdf002
   END IF
   #mod 150101 end
   
   LET l_cnt_sfdf = l_cnt_sfdf + 1
   LET l_sfdf_d[l_cnt_sfdf].sfdf003 = g_sfdf_d[l_ac].sfdf003  #仓
   LET l_sfdf_d[l_cnt_sfdf].sfdf004 = g_sfdf_d[l_ac].sfdf004  #储
   LET l_sfdf_d[l_cnt_sfdf].sfdf005 = g_sfdf_d[l_ac].sfdf005  #批
   LET l_sfdf_d[l_cnt_sfdf].sfdf007 = l_sfdc007  #按换算率折算成sfdc的数量
   LET l_sfdf_d[l_cnt_sfdf].sfdf009 = l_sfdc010  #按换算率折算成sfdc的参考单位数量
   
   #-------->检查库位、储位、批号的范围(sfdf)，是否在需求指定发料库位、储位、批号允许的数量内(sfdc)
   #--将sfdf分配给sfdc，分配顺序：储位和批号都是空->储位为空/批号非空->储位非空/批号为空->储位和批号都非空
   #将sfdf中“储位和批号都是空”的资料分配,扣减sfdc中:储位和批号都是空的数量
   FOR l_idx = 1 TO l_cnt_sfdf
       IF cl_null(l_sfdf_d[l_idx].sfdf004) AND cl_null(l_sfdf_d[l_idx].sfdf005) THEN
          #对sfdc进行分配
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              #扣减sfdc中:储位和批号都是空的数量
              IF cl_null(l_sfdc_d[l_idx2].sfdc013) AND cl_null(l_sfdc_d[l_idx2].sfdc014) THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf有未分配掉的，代表sfdf超出范围了
          IF l_sfdf_d[l_idx].sfdf007 > 0 OR l_sfdf_d[l_idx].sfdf009 > 0 THEN
             #输入资料不在需求指定发料库位、储位、批号允许的数量范围内，请查看“发料需求”页签资料，并重新输入
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'asf-00133'
             LET g_errparam.extend = ''
             LET g_errparam.popup = TRUE
             CALL cl_err()
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
   END FOR
   #将sfdf中“储位为空/批号非空”的资料分配,按顺序扣减sfdc中:1.储位是空+批号为输入批号的资料
   #                                                   2.储位+批号都是空的资料
   FOR l_idx = 1 TO l_cnt_sfdf
       IF cl_null(l_sfdf_d[l_idx].sfdf004) AND NOT cl_null(l_sfdf_d[l_idx].sfdf005) THEN
          #对sfdc进行分配：1.扣减sfdc中:储位是空+批号为输入批号的数量
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF cl_null(l_sfdc_d[l_idx2].sfdc013) AND l_sfdc_d[l_idx2].sfdc014=l_sfdf_d[l_idx].sfdf005 THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf都已分配掉，则继续分配下笔sfdf
          IF l_sfdf_d[l_idx].sfdf007 = 0 THEN
              CONTINUE FOR
          END IF
          #对sfdc进行分配,2.扣减sfdc中:储位和批号都是空的数量
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF cl_null(l_sfdc_d[l_idx2].sfdc013) AND cl_null(l_sfdc_d[l_idx2].sfdc014) THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf有未分配掉的，代表sfdf超出范围了
          IF l_sfdf_d[l_idx].sfdf007 > 0 OR l_sfdf_d[l_idx].sfdf009 > 0 THEN
             #输入资料不在需求指定发料库位、储位、批号允许的数量范围内，请查看“发料需求”页签资料，并重新输入
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'asf-00133'
             LET g_errparam.extend = ''
             LET g_errparam.popup = TRUE
             CALL cl_err()

             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
   END FOR
   #将sfdf中“储位非空/批号为空”的资料分配,按顺序扣减sfdc中:1.储位为输入储位+批号是空的资料
   #                                                   2.储位+批号都是空的资料
   FOR l_idx = 1 TO l_cnt_sfdf
       IF NOT cl_null(l_sfdf_d[l_idx].sfdf004) AND cl_null(l_sfdf_d[l_idx].sfdf005) THEN
          #对sfdc进行分配：1.扣减sfdc中:储位为输入储位+批号是空的数量
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF l_sfdc_d[l_idx2].sfdc013=l_sfdf_d[l_idx].sfdf004 AND cl_null(l_sfdc_d[l_idx2].sfdc014) THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf都已分配掉，则继续分配下笔sfdf
          IF l_sfdf_d[l_idx].sfdf007 = 0 THEN
              CONTINUE FOR
          END IF
          #对sfdc进行分配,2.扣减sfdc中:储位和批号都是空的数量
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF cl_null(l_sfdc_d[l_idx2].sfdc013) AND cl_null(l_sfdc_d[l_idx2].sfdc014) THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf有未分配掉的，代表sfdf超出范围了
          IF l_sfdf_d[l_idx].sfdf007 > 0 OR l_sfdf_d[l_idx].sfdf009 > 0 THEN
             #输入资料不在需求指定发料库位、储位、批号允许的数量范围内，请查看“发料需求”页签资料，并重新输入
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'asf-00133'
             LET g_errparam.extend = ''
             LET g_errparam.popup = TRUE
             CALL cl_err()

             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
   END FOR
   #将sfdf中“储位和批号都非空”的资料分配,按顺序扣减sfdc中:1.储位+批号都为输入的资料
   #                                                  2.储位为输入储位+批号是空的资料
   #                                                  3.储位是空+批号为输入批号的资料
   #                                                  4.储位+批号都是空的资料
   FOR l_idx = 1 TO l_cnt_sfdf
       IF NOT cl_null(l_sfdf_d[l_idx].sfdf004) AND NOT cl_null(l_sfdf_d[l_idx].sfdf005) THEN
          #对sfdc进行分配：1.扣减sfdc中:储位+批号都为输入的资料
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF l_sfdc_d[l_idx2].sfdc013=l_sfdf_d[l_idx].sfdf004 AND l_sfdc_d[l_idx2].sfdc014=l_sfdf_d[l_idx].sfdf005 THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf都已分配掉，则继续分配下笔sfdf
          IF l_sfdf_d[l_idx].sfdf007 = 0 THEN
              CONTINUE FOR
          END IF

          #对sfdc进行分配,2.扣减sfdc中:位为输入储位+批号是空的资料
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF l_sfdc_d[l_idx2].sfdc013=l_sfdf_d[l_idx].sfdf004 AND cl_null(l_sfdc_d[l_idx2].sfdc014) THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf都已分配掉，则继续分配下笔sfdf
          IF l_sfdf_d[l_idx].sfdf007 = 0 THEN
              CONTINUE FOR
          END IF

          #对sfdc进行分配,3.扣减sfdc中:储位是空+批号为输入批号的资料
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              
              IF cl_null(l_sfdc_d[l_idx2].sfdc013) AND l_sfdc_d[l_idx2].sfdc014=l_sfdf_d[l_idx].sfdf005 THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf都已分配掉，则继续分配下笔sfdf
          IF l_sfdf_d[l_idx].sfdf007 = 0 THEN
              CONTINUE FOR
          END IF

          #对sfdc进行分配,4.扣减sfdc中:储位+批号都是空的资料
          FOR l_idx2 = 1 TO l_cnt_sfdc
              IF l_sfdc_d[l_idx2].sfdc007 = 0 THEN
                 CONTINUE FOR
              END IF
              IF cl_null(l_sfdc_d[l_idx2].sfdc013) AND cl_null(l_sfdc_d[l_idx2].sfdc014) THEN
                 IF l_sfdf_d[l_idx].sfdf007 > l_sfdc_d[l_idx2].sfdc007 THEN
                    LET l_sfdf_d[l_idx].sfdf007 = l_sfdf_d[l_idx].sfdf007 - l_sfdc_d[l_idx2].sfdc007
                    LET l_sfdf_d[l_idx].sfdf009 = l_sfdf_d[l_idx].sfdf009 - l_sfdc_d[l_idx2].sfdc010
                    LET l_sfdc_d[l_idx2].sfdc007 = 0
                    LET l_sfdc_d[l_idx2].sfdc010 = 0
                    CONTINUE FOR
                 ELSE
                    LET l_sfdf_d[l_idx].sfdf007 = 0
                    LET l_sfdf_d[l_idx].sfdf009 = 0
                    LET l_sfdc_d[l_idx2].sfdc007 = l_sfdc_d[l_idx2].sfdc007 - l_sfdf_d[l_idx].sfdf007
                    LET l_sfdc_d[l_idx2].sfdc010 = l_sfdc_d[l_idx2].sfdc010 - l_sfdf_d[l_idx].sfdf009
                    EXIT FOR
                 END IF
              END IF
          END FOR
          #若sfdf有未分配掉的，代表sfdf超出范围了
          IF l_sfdf_d[l_idx].sfdf007 > 0 OR l_sfdf_d[l_idx].sfdf009 > 0 THEN
             #输入资料不在需求指定发料库位、储位、批号允许的数量范围内，请查看“发料需求”页签资料，并重新输入
             INITIALIZE g_errparam TO NULL
             LET g_errparam.code = 'asf-00133'
             LET g_errparam.extend = ''
             LET g_errparam.popup = TRUE
             CALL cl_err()
             LET r_success = FALSE
             RETURN r_success
          END IF
       END IF
   END FOR

   RETURN r_success
END FUNCTION
#检查sfdd数量汇总是否超过sfdc的数量，超过则检查失败
#在编辑状态时使用
#参考单位数量不检查，预留
PRIVATE FUNCTION asft310_chk_sfdd_amt(p_cmd,p_column)
DEFINE p_cmd            LIKE type_t.chr1
DEFINE p_column         LIKE type_t.chr10
DEFINE r_success        LIKE type_t.num5   #TRUE/FALSE
DEFINE l_sql            STRING
DEFINE l_sfdc007        LIKE sfdc_t.sfdc007   #申请数量
DEFINE l_sfdc010        LIKE sfdc_t.sfdc010   #参考单位申请数量
DEFINE l_sfdd001        LIKE sfdd_t.sfdd001  #发料料号
DEFINE l_sfdd013        LIKE sfdd_t.sfdd013  #发料料号产品特征
DEFINE l_sfdd002        LIKE sfdd_t.sfdd002  #替代率
DEFINE l_sfdd006        LIKE sfdd_t.sfdd006  #单位
DEFINE l_sfdd007        LIKE sfdd_t.sfdd007  #数量
DEFINE l_sfdd008        LIKE sfdd_t.sfdd008  #参考单位
DEFINE l_sfdd009        LIKE sfdd_t.sfdd009  #参考数量
DEFINE l_success        LIKE type_t.num5
DEFINE l_rate1          LIKE sfdd_t.sfdd002  #对sfdc006单位的换算率
DEFINE l_rate2          LIKE sfdd_t.sfdd002  #对sfdc009参考单位的换算率

   LET r_success = TRUE
   LET l_sfdc007 = 0
   LET l_sfdc010 = 0
   
   #获取除当笔以外其他所有笔数量的总和
   LET l_sql = " SELECT sfdd001,sfdd013,sfdd002,sfdd006,sfdd007,sfdd008,sfdd009 FROM sfdd_t ",
               " WHERE sfddent   = ",g_enterprise,
               "   AND sfdddocno = '",g_sfda_m.sfdadocno,"' ",
               "   AND sfddseq   = ",g_sfdc4_d[g_detail_idx].sfdcseq
   IF p_cmd = 'u' THEN
      LET l_sql = l_sql CLIPPED," AND sfddseq1 != ",g_sfdd_d_t.sfddseq1
   END IF
   PREPARE asft310_chk_sfdd_amt_p1 FROM l_sql
   DECLARE asft310_chk_sfdd_amt_c1 CURSOR FOR asft310_chk_sfdd_amt_p1
   FOREACH asft310_chk_sfdd_amt_c1 INTO l_sfdd001,l_sfdd013,l_sfdd002,l_sfdd006,l_sfdd007,l_sfdd008,l_sfdd009
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'asft310_chk_sfdd_amt_c1'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success
      END IF
      IF cl_null(l_sfdd007) THEN LET l_sfdd007 = 0 END IF
      IF cl_null(l_sfdd009) THEN LET l_sfdd009 = 0 END IF
      
      #--取当笔数量
      IF l_sfdd001 = g_sfdc4_d[g_detail_idx].sfdc004 THEN
         #没取替代,考虑单位不一致的情况
         #mod 150101
         ##计算对sfdc009单位的换算率l_rate1
         #IF l_sfdd006 = g_sfdc4_d[g_detail_idx].sfdc006 THEN
         #   LET l_rate1 = 1
         #ELSE
         #   CALL s_aimi190_get_convert(l_sfdd001,l_sfdd006,g_sfdc4_d[g_detail_idx].sfdc006) RETURNING l_success,l_rate1
         #   IF NOT l_success THEN
         #      LET l_rate1 = 1
         #   END IF
         #END IF
         ##计算对sfdc009参考单位的换算率l_rate2
         #IF cl_null(l_sfdd008) OR cl_null(g_sfdc4_d[g_detail_idx].sfdc009) THEN
         #   LET l_rate2 = 1
         #ELSE
         #   IF l_sfdd008 = g_sfdc4_d[g_detail_idx].sfdc009 THEN
         #      LET l_rate2 = 1
         #   ELSE
         #      CALL s_aimi190_get_convert(l_sfdd001,l_sfdd008,g_sfdc4_d[g_detail_idx].sfdc009) RETURNING l_success,l_rate2
         #      IF NOT l_success THEN
         #         LET l_rate2 = 1
         #      END IF
         #   END IF
         #END IF
         #LET l_sfdd007 = l_sfdd007 * l_rate1
         #LET l_sfdd009 = l_sfdd009 * l_rate2
         #计算对sfdc009单位的换算率l_rate1
         IF l_sfdd006 != g_sfdc4_d[g_detail_idx].sfdc006 THEN
            CALL s_aooi250_convert_qty(l_sfdd001,l_sfdd006,g_sfdc4_d[g_detail_idx].sfdc006,l_sfdd007)
               RETURNING l_success,g_qty_t
            IF l_success THEN
               LET l_sfdd007 = g_qty_t
            END IF
         END IF
         #计算对sfdc009参考单位的换算率l_rate2
         IF NOT cl_null(l_sfdd008) AND NOT cl_null(g_sfdc4_d[g_detail_idx].sfdc009) THEN
            IF l_sfdd008 != g_sfdc4_d[g_detail_idx].sfdc009 THEN
               CALL s_aooi250_convert_qty(l_sfdd001,l_sfdd008,g_sfdc4_d[g_detail_idx].sfdc009,l_sfdd009)
                  RETURNING l_success,g_qty_t
               IF l_success THEN
                  LET l_sfdd009 = g_qty_t
               END IF
            END IF
         END IF
         #mod 150101 end
      ELSE
         #取替代了,直接考虑取替代率
         LET l_sfdd007 = l_sfdd007 / l_sfdd002
         LET l_sfdd009 = l_sfdd009 / l_sfdd002
      END IF
      
      #计算汇总数量
      LET l_sfdc007 = l_sfdc007 + l_sfdd007
      LET l_sfdc010 = l_sfdc010 + l_sfdd009
   END FOREACH
   
   #取当前编辑笔的数量
   IF g_sfdd_d[l_ac].sfdd001 = g_sfdc4_d[g_detail_idx].sfdc004 THEN
      #没取替代,考虑单位不一致的情况
      #mod 150101
      ##计算对sfdc006单位的换算率l_rate1
      #IF g_sfdd_d[l_ac].sfdd006 = g_sfdc4_d[g_detail_idx].sfdc006 THEN
      #   LET l_rate1 = 1
      #ELSE
      #   CALL s_aimi190_get_convert(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd006,g_sfdc4_d[g_detail_idx].sfdc006) RETURNING l_success,l_rate1
      #   IF NOT l_success THEN
      #      LET l_rate1 = 1
      #   END IF
      #END IF
      ##计算对sfdc009参考单位的换算率l_rate2
      #IF cl_null(g_sfdd_d[l_ac].sfdd008) OR cl_null(g_sfdc4_d[g_detail_idx].sfdc009) THEN
      #   LET l_rate2 = 1
      #ELSE
      #   IF g_sfdd_d[l_ac].sfdd008 = g_sfdc4_d[g_detail_idx].sfdc009 THEN
      #      LET l_rate2 = 1
      #   ELSE
      #      CALL s_aimi190_get_convert(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd008,g_sfdc4_d[g_detail_idx].sfdc009) RETURNING l_success,l_rate2
      #      IF NOT l_success THEN
      #         LET l_rate2 = 1
      #      END IF
      #   END IF
      #END IF
      #LET l_sfdd007 = g_sfdd_d[l_ac].sfdd007 * l_rate1
      #LET l_sfdd009 = g_sfdd_d[l_ac].sfdd009 * l_rate2
      #计算对sfdc006单位的换算率l_rate1
      IF g_sfdd_d[l_ac].sfdd006 = g_sfdc4_d[g_detail_idx].sfdc006 THEN
         LET l_sfdd007 = g_sfdd_d[l_ac].sfdd007
      ELSE
         CALL s_aooi250_convert_qty(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd006,g_sfdc4_d[g_detail_idx].sfdc006,g_sfdd_d[l_ac].sfdd007)
            RETURNING l_success,l_sfdd007
         IF NOT l_success THEN
            LET l_sfdd007 = g_sfdd_d[l_ac].sfdd007
         END IF
      END IF
      #计算对sfdc009参考单位的换算率l_rate2
      IF cl_null(g_sfdd_d[l_ac].sfdd008) OR cl_null(g_sfdc4_d[g_detail_idx].sfdc009) THEN
         LET l_sfdd009 = g_sfdd_d[l_ac].sfdd009
      ELSE
         IF g_sfdd_d[l_ac].sfdd008 = g_sfdc4_d[g_detail_idx].sfdc009 THEN
            LET l_sfdd009 = g_sfdd_d[l_ac].sfdd009
         ELSE
            CALL s_aooi250_convert_qty(g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd008,g_sfdc4_d[g_detail_idx].sfdc009,g_sfdd_d[l_ac].sfdd009)
               RETURNING l_success,l_sfdd009
            IF NOT l_success THEN
               LET l_sfdd009 = g_sfdd_d[l_ac].sfdd009
            END IF
         END IF
      END IF
      #mod 150101 end
   ELSE
      #取替代了,直接考虑取替代率
      LET l_sfdd007 = g_sfdd_d[l_ac].sfdd007 / g_sfdd_d[l_ac].sfdd002
      LET l_sfdd009 = g_sfdd_d[l_ac].sfdd009 / g_sfdd_d[l_ac].sfdd002
   END IF
   
   #判断
   CASE p_column
      WHEN 'sfdd007'
           #數量總數不可超過申請數量sfdc007
           IF l_sfdc007 + l_sfdd007 > g_sfdc4_d[g_detail_idx].sfdc007 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asr-00010'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
      WHEN 'sfdd009'
           #數量總數不可超過申請數量sfdc010
           IF l_sfdc010 + l_sfdd009 > g_sfdc4_d[g_detail_idx].sfdc010 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asr-00010'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
              RETURN r_success
           END IF
   END CASE
   
   RETURN r_success
END FUNCTION
#检查sfdf数量汇总是否超过sfde的数量，超过则检查失败
#在编辑状态时使用
##参考单位数量不检查，预留
PRIVATE FUNCTION asft310_chk_sfdf_amt(p_cmd,p_column)
DEFINE p_cmd            LIKE type_t.chr1
DEFINE p_column         LIKE type_t.chr10
DEFINE r_success        LIKE type_t.num5   #TRUE/FALSE
DEFINE l_sql            STRING
DEFINE l_sfde004        LIKE sfde_t.sfde004   #申请数量
DEFINE l_sfde007        LIKE sfde_t.sfde007   #参考单位申请数量
DEFINE l_sfdf001        LIKE sfdf_t.sfdf001  #发料料号
DEFINE l_sfdf013        LIKE sfdf_t.sfdf013  #产品特征
DEFINE l_sfdf002        LIKE sfdf_t.sfdf002  #替代率
DEFINE l_sfdf006        LIKE sfdf_t.sfdf006  #单位
DEFINE l_sfdf007        LIKE sfdf_t.sfdf007  #数量
DEFINE l_sfdf008        LIKE sfdf_t.sfdf008  #参考单位
DEFINE l_sfdf009        LIKE sfdf_t.sfdf009  #参考数量
DEFINE l_success        LIKE type_t.num5
DEFINE l_rate1          LIKE sfdd_t.sfdd002  #对sfde004单位的换算率
DEFINE l_rate2          LIKE sfdd_t.sfdd002  #对sfde006参考单位的换算率

   LET r_success = TRUE

   LET l_sfde004 = 0
   LET l_sfde007 = 0
   
   #获取除当笔以外其他所有笔数量的总和
   LET l_sql = " SELECT sfdf001,sfdf013,sfdf002,sfdf006,sfdf007,sfdf008,sfdf009 FROM sfdf_t ",
               " WHERE sfdfent   = ",g_enterprise,
               "   AND sfdfdocno = '",g_sfda_m.sfdadocno,"' ",
               "   AND sfdfseq   = ",g_sfde_d[g_detail_idx].sfdeseq
   IF p_cmd = 'u' THEN
      LET l_sql = l_sql CLIPPED," AND sfdfseq1 != ",g_sfdf_d_t.sfdfseq1
   END IF
   PREPARE asft310_chk_sfdf_amt_p1 FROM l_sql
   DECLARE asft310_chk_sfdf_amt_c1 CURSOR FOR asft310_chk_sfdf_amt_p1
   FOREACH asft310_chk_sfdf_amt_c1 INTO l_sfdf001,l_sfdf013,l_sfdf002,l_sfdf006,l_sfdf007,l_sfdf008,l_sfdf009
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach asft310_chk_sfdf_amt_c1'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      IF cl_null(l_sfdf007) THEN LET l_sfdf007 = 0 END IF
      IF cl_null(l_sfdf009) THEN LET l_sfdf009 = 0 END IF
      
      #--取当笔数量
      IF l_sfdf001 = g_sfde_d[g_detail_idx].sfde001 AND l_sfdf013 = g_sfde_d[g_detail_idx].sfde002 THEN
         #没取替代,考虑单位不一致的情况
         #mod 150101
         ##计算对sfde004单位的换算率l_rate1
         #IF l_sfdf006 = g_sfde_d[g_detail_idx].sfde003 THEN
         #   LET l_rate1 = 1
         #ELSE
         #   CALL s_aimi190_get_convert(l_sfdf001,l_sfdf006,g_sfde_d[g_detail_idx].sfde003) RETURNING l_success,l_rate1
         #   IF NOT l_success THEN
         #      LET l_rate1 = 1
         #   END IF
         #END IF
         ##计算对sfde006参考单位的换算率l_rate2
         #IF cl_null(l_sfdf008) OR cl_null(g_sfde_d[g_detail_idx].sfde006) THEN
         #   LET l_rate2 = 1
         #ELSE
         #   IF l_sfdf008 = g_sfde_d[g_detail_idx].sfde006 THEN
         #      LET l_rate2 = 1
         #   ELSE
         #      CALL s_aimi190_get_convert(l_sfdf001,l_sfdf008,g_sfde_d[g_detail_idx].sfde006) RETURNING l_success,l_rate2
         #      IF NOT l_success THEN
         #         LET l_rate2 = 1
         #      END IF
         #   END IF
         #END IF
         #LET l_sfdf007 = l_sfdf007 * l_rate1
         #LET l_sfdf009 = l_sfdf009 * l_rate2
         #计算对sfde004单位的换算率l_rate1
         IF l_sfdf006 != g_sfde_d[g_detail_idx].sfde003 THEN
            CALL s_aooi250_convert_qty(l_sfdf001,l_sfdf006,g_sfde_d[g_detail_idx].sfde003,l_sfdf007)
               RETURNING l_success,g_qty_t
            IF l_success THEN
               LET l_sfdf007 = g_qty_t
            END IF
         END IF
         #计算对sfde006参考单位的换算率l_rate2
         IF NOT cl_null(l_sfdf008) AND NOT cl_null(g_sfde_d[g_detail_idx].sfde006) THEN
            IF l_sfdf008 != g_sfde_d[g_detail_idx].sfde006 THEN
               CALL s_aooi250_convert_qty(l_sfdf001,l_sfdf008,g_sfde_d[g_detail_idx].sfde006,l_sfdf009)
                  RETURNING l_success,g_qty_t
               IF l_success THEN
                  LET l_sfdf009 = g_qty_t
               END IF
            END IF
         END IF
         #mod 150101 end
      ELSE
         #取替代了,直接考虑取替代率
         LET l_sfdf007 = l_sfdf007 / l_sfdf002
         LET l_sfdf009 = l_sfdf009 / l_sfdf002
      END IF
      
      #计算汇总数量
      LET l_sfde004 = l_sfde004 + l_sfdf007
      LET l_sfde007 = l_sfde007 + l_sfdf009
   END FOREACH
   
   #取当前编辑笔的数量
   IF g_sfdf_d[l_ac].sfdf001 = g_sfde_d[g_detail_idx].sfde001 AND g_sfdf_d[l_ac].sfdf013 = g_sfde_d[g_detail_idx].sfde002 THEN
      #没取替代,考虑单位不一致的情况
      #mod 150101
      ##计算对sfde006单位的换算率l_rate1
      #IF g_sfdf_d[l_ac].sfdf006 = g_sfde_d[g_detail_idx].sfde003 THEN
      #   LET l_rate1 = 1
      #ELSE
      #   CALL s_aimi190_get_convert(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfde_d[g_detail_idx].sfde003) RETURNING l_success,l_rate1
      #   IF NOT l_success THEN
      #      LET l_rate1 = 1
      #   END IF
      #END IF
      ##计算对sfde006参考单位的换算率l_rate2
      #IF cl_null(g_sfdf_d[l_ac].sfdf008) OR cl_null(g_sfde_d[g_detail_idx].sfde006) THEN
      #   LET l_rate2 = 1
      #ELSE
      #   IF g_sfdf_d[l_ac].sfdf008 = g_sfde_d[g_detail_idx].sfde006 THEN
      #      LET l_rate2 = 1
      #   ELSE
      #      CALL s_aimi190_get_convert(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf008,g_sfde_d[g_detail_idx].sfde006) RETURNING l_success,l_rate2
      #      IF NOT l_success THEN
      #         LET l_rate2 = 1
      #      END IF
      #   END IF
      #END IF
      #LET l_sfdf007 = g_sfdf_d[l_ac].sfdf007 * l_rate1
      #LET l_sfdf009 = g_sfdf_d[l_ac].sfdf009 * l_rate2
      #计算对sfde006单位的换算率l_rate1
      IF g_sfdf_d[l_ac].sfdf006 = g_sfde_d[g_detail_idx].sfde003 THEN
         LET l_sfdf007 = g_sfdf_d[l_ac].sfdf007
      ELSE
         CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf006,g_sfde_d[g_detail_idx].sfde003,g_sfdf_d[l_ac].sfdf007)
            RETURNING l_success,l_sfdf007
         IF NOT l_success THEN
            LET l_sfdf007 = g_sfdf_d[l_ac].sfdf007
         END IF
      END IF
      #计算对sfde006参考单位的换算率l_rate2
      IF cl_null(g_sfdf_d[l_ac].sfdf008) OR cl_null(g_sfde_d[g_detail_idx].sfde006) THEN
         LET l_sfdf009 = g_sfdf_d[l_ac].sfdf009
      ELSE
         IF g_sfdf_d[l_ac].sfdf008 = g_sfde_d[g_detail_idx].sfde006 THEN
            LET l_sfdf009 = g_sfdf_d[l_ac].sfdf009
         ELSE
            CALL s_aooi250_convert_qty(g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf008,g_sfde_d[g_detail_idx].sfde006,g_sfdf_d[l_ac].sfdf009)
               RETURNING l_success,l_sfdf009
            IF NOT l_success THEN
               LET l_sfdf009 = g_sfdf_d[l_ac].sfdf009
            END IF
         END IF
      END IF
      #mod 150101 end
   ELSE
      #取替代了,直接考虑取替代率
      LET l_sfdf007 = g_sfdf_d[l_ac].sfdf007 / g_sfdf_d[l_ac].sfdf002
      LET l_sfdf009 = g_sfdf_d[l_ac].sfdf009 / g_sfdf_d[l_ac].sfdf002
   END IF
   
   #判断
   CASE p_column
      WHEN 'sfdf007'
           #數量總數不可超過申請數量sfde004
           IF l_sfde004 + l_sfdf007 > g_sfde_d[g_detail_idx].sfde004 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asr-00010'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
           END IF
      WHEN 'sfdf009'
           #數量總數不可超過申請數量sfde007
           IF l_sfde007 + l_sfdf009 > g_sfde_d[g_detail_idx].sfde007 THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asr-00010'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              LET r_success = FALSE
           END IF
   END CASE

   RETURN r_success
END FUNCTION
#退料预设值:若发料批号只有一个，预设发料的批号
PRIVATE FUNCTION asft310_def_sfdc014()
DEFINE l_cnt     LIKE type_t.num5
   
   IF g_prog[1,6] != 'asft32' THEN
      RETURN
   END IF
   
   SELECT COUNT(unique sfdd005) INTO l_cnt
     FROM sfdd_t,sfdc_t
    WHERE sfdcent  = sfddent
      AND sfdcdocno= sfdddocno
      AND sfdcseq  = sfddseq
      AND sfdcent  = g_enterprise
      AND sfdcsite = g_site
      AND sfdc001  = g_sfdc_d[l_ac].sfdc001  #工单
      AND sfdc002  = g_sfdc_d[l_ac].sfdc002  #项次
      AND sfdc003  = g_sfdc_d[l_ac].sfdc003  #项序
      AND sfdd001  = g_sfdc_d[l_ac].sfdc004  #发料料号
      AND sfdd013  = g_sfdc_d[l_ac].sfdc005  #发料料号产品特征
      AND sfdd003  = g_sfdc_d[l_ac].sfdc012  #库位
      AND sfdd004  = g_sfdc_d[l_ac].sfdc013  #储位
   IF l_cnt = 1 THEN
      SELECT unique sfdd005 INTO g_sfdc_d[l_ac].sfdc014
        FROM sfdd_t,sfdc_t
       WHERE sfdcent  = sfddent
         AND sfdcdocno= sfdddocno
         AND sfdcseq  = sfddseq
         AND sfdcent  = g_enterprise
         AND sfdcsite = g_site
         AND sfdc001  = g_sfdc_d[l_ac].sfdc001  #工单
         AND sfdc002  = g_sfdc_d[l_ac].sfdc002  #项次
         AND sfdc003  = g_sfdc_d[l_ac].sfdc003  #项序
         AND sfdd001  = g_sfdc_d[l_ac].sfdc004  #发料料号
         AND sfdd013  = g_sfdc_d[l_ac].sfdc005  #发料料号产品特征
         AND sfdd003  = g_sfdc_d[l_ac].sfdc012  #库位
         AND sfdd004  = g_sfdc_d[l_ac].sfdc013  #储位
   END IF
END FUNCTION

PRIVATE FUNCTION asft310_def_sfdb007()
   #实际套数
   IF g_sfda_m.sfda002 = '11' OR g_sfda_m.sfda002 = '21' THEN
      LET g_sfdb_d[g_detail_idx].sfdb007 = g_sfdb_d[g_detail_idx].sfdb006
   ELSE
      LET g_sfdb_d[g_detail_idx].sfdb007 = 0
   END IF
   DISPLAY BY NAME g_sfdb_d[g_detail_idx].sfdb007

END FUNCTION
# 給予pk_array內容
PRIVATE FUNCTION asft310_set_pk_array()
   
   CALL g_pk_array.clear()
   #LET g_pk_array[1].values = g_enterprise
   #LET g_pk_array[1].column = "sfdaent"
   #LET g_pk_array[2].values = g_sfda_m.sfdadocno
   #LET g_pk_array[2].column = "sfdadocno"
   LET g_pk_array[1].values = g_sfda_m.sfdadocno
   LET g_pk_array[1].column = "sfdadocno"
   #mod 见其他作业pattern的写法未将~ent的算进去，再，若算进去了待追踪的链接打开作业，带不出资料，所以这里也取消~ent
END FUNCTION
################################################################################
# Descriptions...: 取aooi200中BY单据别设定的栏位预设值
# Memo...........:
# Usage..........: CALL asft310_get_doc_default()
#                       RETURNING NULL
# Input parameter: NULL
# Return code....: NULL
# Date & Author..: 2014/06/23 By zhangllc
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_get_doc_default()
   LET g_sfda_m.sfdadocdt  = s_aooi200_get_doc_default(g_site,'1',g_sfda_m.sfdadocno,'sfdadocdt',g_sfda_m.sfdadocdt)     #單據日期
   LET g_sfda_m.sfda001    = s_aooi200_get_doc_default(g_site,'1',g_sfda_m.sfdadocno,'sfda001'  ,g_sfda_m.sfda001  )     #過帳日期
   LET g_sfda_m.sfda002    = s_aooi200_get_doc_default(g_site,'1',g_sfda_m.sfdadocno,'sfda002'  ,g_sfda_m.sfda002  )     #发退料类别
   LET g_sfda_m.sfda003    = s_aooi200_get_doc_default(g_site,'1',g_sfda_m.sfdadocno,'sfda003'  ,g_sfda_m.sfda003  )     #部門
   LET g_sfda_m.sfda004    = s_aooi200_get_doc_default(g_site,'1',g_sfda_m.sfdadocno,'sfda004'  ,g_sfda_m.sfda004  )     #申請人
   LET g_sfda_m.sfda005    = s_aooi200_get_doc_default(g_site,'1',g_sfda_m.sfdadocno,'sfda005'  ,g_sfda_m.sfda005  )     #PBI編號

   DISPLAY BY NAME g_sfda_m.sfdadocdt
   DISPLAY BY NAME g_sfda_m.sfda001
   DISPLAY BY NAME g_sfda_m.sfda002
   DISPLAY BY NAME g_sfda_m.sfda003
   DISPLAY BY NAME g_sfda_m.sfda004
   DISPLAY BY NAME g_sfda_m.sfda005
   
   #作业特殊性限制
   #160623-00014#1-mod-(S)
#   CASE g_prog
#      WHEN 'asft311'
#           LET g_sfda_m.sfda002 = '11'
#      WHEN 'asft312'
#           LET g_sfda_m.sfda002 = '12'
#      WHEN 'asft313'
#           LET g_sfda_m.sfda002 = '13'
#      WHEN 'asft314'
#           LET g_sfda_m.sfda002 = '14'
#      WHEN 'asft315'
#           LET g_sfda_m.sfda002 = '15'
#      WHEN 'asft321'
#           LET g_sfda_m.sfda002 = '21'
#      WHEN 'asft322'
#           LET g_sfda_m.sfda002 = '22'
#      WHEN 'asft323'
#           LET g_sfda_m.sfda002 = '23'
#      WHEN 'asft324'
#           LET g_sfda_m.sfda002 = '24'
#      WHEN 'asft325'
#           LET g_sfda_m.sfda002 = '25'
#      OTHERWISE
#   END CASE
   CASE 
      WHEN g_prog MATCHES 'asft311'
           LET g_sfda_m.sfda002 = '11'
      WHEN g_prog MATCHES 'asft312'
           LET g_sfda_m.sfda002 = '12'
      WHEN g_prog MATCHES 'asft313'
           LET g_sfda_m.sfda002 = '13'
      WHEN g_prog MATCHES 'asft314'
           LET g_sfda_m.sfda002 = '14'
      WHEN g_prog MATCHES 'asft315'
           LET g_sfda_m.sfda002 = '15'
      WHEN g_prog MATCHES 'asft321'
           LET g_sfda_m.sfda002 = '21'
      WHEN g_prog MATCHES 'asft322'
           LET g_sfda_m.sfda002 = '22'
      WHEN g_prog MATCHES 'asft323'
           LET g_sfda_m.sfda002 = '23'
      WHEN g_prog MATCHES 'asft324'
           LET g_sfda_m.sfda002 = '24'
      WHEN g_prog MATCHES 'asft325'
           LET g_sfda_m.sfda002 = '25'
      OTHERWISE
   END CASE
   #160623-00014#1-mod-(E)
   #部门说明
   CALL asft310_sfda003_ref(g_sfda_m.sfda003) RETURNING g_sfda_m.sfda003_desc  #160914-00019#1
   DISPLAY BY NAME g_sfda_m.sfda003_desc
   
   #申请人说明
   CALL s_desc_get_person_desc(g_sfda_m.sfda004) RETURNING g_sfda_m.sfda004_desc
   DISPLAY BY NAME g_sfda_m.sfda004_desc
END FUNCTION
#取替代检查
# Modify.........: #160914-00019#1 新增傳入參數p_sfaa010,p_sfaa011,p_sfba001
PRIVATE FUNCTION asft310_chk_replace(p_column,p_sfaa010,p_sfaa011,p_sfba001)
   DEFINE p_column         LIKE type_t.chr20
   DEFINE p_sfaa010        LIKE sfaa_t.sfaa010
   DEFINE p_sfaa011        LIKE sfaa_t.sfaa011
   DEFINE p_sfba001        LIKE sfba_t.sfba001
   DEFINE r_success        LIKE type_t.num5
   #DEFINE l_bmea           RECORD LIKE bmea_t.* #161109-00085#62 mark
   #161109-00085#62 --s add
   DEFINE l_bmea RECORD  #取替代料檔
          bmeaent LIKE bmea_t.bmeaent, #企業編號
          bmeasite LIKE bmea_t.bmeasite, #營運據點
          bmea001 LIKE bmea_t.bmea001, #主件料號
          bmea002 LIKE bmea_t.bmea002, #特性
          bmea003 LIKE bmea_t.bmea003, #元件料號
          bmea004 LIKE bmea_t.bmea004, #部位
          bmea005 LIKE bmea_t.bmea005, #作業
          bmea006 LIKE bmea_t.bmea006, #製程式
          bmea007 LIKE bmea_t.bmea007, #取代/替代
          bmea008 LIKE bmea_t.bmea008, #取替代料件編號
          bmea009 LIKE bmea_t.bmea009, #生效日期
          bmea010 LIKE bmea_t.bmea010, #失效日期
          bmea011 LIKE bmea_t.bmea011, #取替代量
          bmea012 LIKE bmea_t.bmea012, #元件底數
          bmea013 LIKE bmea_t.bmea013, #替代料發料單位
          bmea014 LIKE bmea_t.bmea014, #限定客戶
          bmea015 LIKE bmea_t.bmea015, #優先順序
          bmea016 LIKE bmea_t.bmea016, #替代方式
          bmea017 LIKE bmea_t.bmea017, #部份替代上限比率
          bmea018 LIKE bmea_t.bmea018, #參照研發中心
          bmea019 LIKE bmea_t.bmea019, #產品特徵
          bmeaud001 LIKE bmea_t.bmeaud001, #自定義欄位(文字)001
          bmeaud002 LIKE bmea_t.bmeaud002, #自定義欄位(文字)002
          bmeaud003 LIKE bmea_t.bmeaud003, #自定義欄位(文字)003
          bmeaud004 LIKE bmea_t.bmeaud004, #自定義欄位(文字)004
          bmeaud005 LIKE bmea_t.bmeaud005, #自定義欄位(文字)005
          bmeaud006 LIKE bmea_t.bmeaud006, #自定義欄位(文字)006
          bmeaud007 LIKE bmea_t.bmeaud007, #自定義欄位(文字)007
          bmeaud008 LIKE bmea_t.bmeaud008, #自定義欄位(文字)008
          bmeaud009 LIKE bmea_t.bmeaud009, #自定義欄位(文字)009
          bmeaud010 LIKE bmea_t.bmeaud010, #自定義欄位(文字)010
          bmeaud011 LIKE bmea_t.bmeaud011, #自定義欄位(數字)011
          bmeaud012 LIKE bmea_t.bmeaud012, #自定義欄位(數字)012
          bmeaud013 LIKE bmea_t.bmeaud013, #自定義欄位(數字)013
          bmeaud014 LIKE bmea_t.bmeaud014, #自定義欄位(數字)014
          bmeaud015 LIKE bmea_t.bmeaud015, #自定義欄位(數字)015
          bmeaud016 LIKE bmea_t.bmeaud016, #自定義欄位(數字)016
          bmeaud017 LIKE bmea_t.bmeaud017, #自定義欄位(數字)017
          bmeaud018 LIKE bmea_t.bmeaud018, #自定義欄位(數字)018
          bmeaud019 LIKE bmea_t.bmeaud019, #自定義欄位(數字)019
          bmeaud020 LIKE bmea_t.bmeaud020, #自定義欄位(數字)020
          bmeaud021 LIKE bmea_t.bmeaud021, #自定義欄位(日期時間)021
          bmeaud022 LIKE bmea_t.bmeaud022, #自定義欄位(日期時間)022
          bmeaud023 LIKE bmea_t.bmeaud023, #自定義欄位(日期時間)023
          bmeaud024 LIKE bmea_t.bmeaud024, #自定義欄位(日期時間)024
          bmeaud025 LIKE bmea_t.bmeaud025, #自定義欄位(日期時間)025
          bmeaud026 LIKE bmea_t.bmeaud026, #自定義欄位(日期時間)026
          bmeaud027 LIKE bmea_t.bmeaud027, #自定義欄位(日期時間)027
          bmeaud028 LIKE bmea_t.bmeaud028, #自定義欄位(日期時間)028
          bmeaud029 LIKE bmea_t.bmeaud029, #自定義欄位(日期時間)029
          bmeaud030 LIKE bmea_t.bmeaud030, #自定義欄位(日期時間)030
          bmea020 LIKE bmea_t.bmea020  #保稅否
   END RECORD
   #161109-00085#62 --e add
   DEFINE l_cnt            LIKE type_t.num5
   DEFINE l_sfaa009        LIKE sfaa_t.sfaa009   #参考客户
   DEFINE l_sql            STRING
   DEFINE l_success        LIKE type_t.num5

   LET r_success = TRUE
   IF cl_null(g_sfdd_d[l_ac].sfdd001) THEN #替代料
      RETURN r_success
   END IF
   IF g_sfdd_d[l_ac].sfdd001 = g_sfdc4_d[g_detail_idx].sfdc004 THEN #发料等於需求料號，未做取替代
      RETURN r_success
   END IF
   
   #检查是否存在取替代料
   IF cl_null(g_sfdd_d[l_ac].sfdd013) THEN #替代料产品特征
      SELECT COUNT(1) INTO l_cnt FROM bmea_t
       WHERE bmeaent = g_enterprise
         AND bmeasite = g_site
         AND (
             #160129-00010#1s
             #(bmea001 =p_sfaa010       #主件料號
              (bmea001 = p_sfba001
             #160129-00010#1-e
               AND bmea002 = p_sfaa011  #特性
               AND bmea003 = g_sfdc4_d[g_detail_idx].sfdc004  #元件料號
               AND bmea004 = g_sfdc4_d[g_detail_idx].sfba002  #部位
               AND bmea005 = g_sfdc4_d[g_detail_idx].sfba003  #作業
               AND bmea006 = g_sfdc4_d[g_detail_idx].sfba004  #製程序
               AND bmea008 = g_sfdd_d[l_ac].sfdd001)   #替代料
               OR 
              (bmea001 ='ALL' AND bmea003 = g_sfdc4_d[g_detail_idx].sfdc004   #主件、元件料號
               AND bmea008 = g_sfdd_d[l_ac].sfdd001)   #替代料
             )
         AND bmea009<= g_today
         AND (bmea010 > g_today OR bmea010 IS NULL )
   ELSE
      SELECT COUNT(1) INTO l_cnt FROM bmea_t
       WHERE bmeaent = g_enterprise
         AND bmeasite = g_site
         AND (
             #160129-00010#1-s
             #(bmea001 =p_sfaa010       #主件料號
              (bmea001 = p_sfba001
             #160129-00010#1-e
               AND bmea002 = p_sfaa011  #特性
               AND bmea003 = g_sfdc4_d[g_detail_idx].sfdc004  #元件料號
               AND bmea004 = g_sfdc4_d[g_detail_idx].sfba002  #部位
               AND bmea005 = g_sfdc4_d[g_detail_idx].sfba003  #作業
               AND bmea006 = g_sfdc4_d[g_detail_idx].sfba004  #製程序
               AND bmea008 = g_sfdd_d[l_ac].sfdd001    #替代料
               AND bmea019 = g_sfdd_d[l_ac].sfdd013)   #替代料产品特征
               OR 
              (bmea001 ='ALL' AND bmea003 = g_sfdc4_d[g_detail_idx].sfdc004   #主件、元件料號
               AND bmea008 = g_sfdd_d[l_ac].sfdd001)   #替代料
             )
         AND bmea009<= g_today
         AND (bmea010 > g_today OR bmea010 IS NULL )
   END IF
   IF l_cnt <= 0  THEN
      #輸入的資料不存在與 取替代料檔 中！，請檢查輸入是否正確，或至[產品結構維護作業abmm200]維護后，重新輸入！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'abm-00088'
      LET g_errparam.extend = g_sfdd_d[l_ac].sfdd001
      LET g_errparam.popup = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF

   IF p_column='sfdd001' THEN
      RETURN r_success   #sfdd013若尚未输入，下面元件中应该抓不到值的
   END IF
   #抓取替代档资料
   #LET l_sql = "SELECT * FROM bmea_t ",
   #            " WHERE bmeaent = ",g_enterprise,
   #            "   AND bmeasite = '",g_site,"' ",
   #            #"   AND bmea001 = '",p_item,"' ",     #主件料號
   #            #"   AND bmea002 = '",p_feature,"' ",  #特性
   #            #"   AND bmea003 = '",p_sitem,"' ",   #元件料號
   #            #"   AND bmea004 = '",p_bmea004,"' ",  #部位
   #            #"   AND bmea005 = '",p_bmea005,"' ",  #作業
   #            #"   AND bmea006 = '",p_bmea006,"' ",  #製程序
   #            #"   AND bmea008 = '",p_sitem_repl,"' ",  #替代料号
   #            "   AND ( ",
   #            "        (bmea001 = '",p_sfaa010,"' ",       #主件料號
   #            "         AND bmea002 = '",p_sfaa011,"' ",  #特性
   #            "         AND bmea003 = '",g_sfdc4_d[g_detail_idx].sfdc004,"' ",  #元件料號
   #            "         AND bmea004 = '",g_sfdc4_d[g_detail_idx].sfba002,"' ",  #部位
   #            "         AND bmea005 = '",g_sfdc4_d[g_detail_idx].sfba003,"' ",  #作業
   #            "         AND bmea006 = '",g_sfdc4_d[g_detail_idx].sfba004,"' ",  #製程序
   #            "         AND bmea008 = '",g_sfdd_d[l_ac].sfdd001,"') ",   #替代料
   #            "         OR ",
   #            "        (bmea001 ='ALL' AND bmea003 = '",g_sfdc4_d[g_detail_idx].sfdc004,"' ",   #主件、元件料號
   #            "         AND bmea008 = '",g_sfdd_d[l_ac].sfdd001,"') ",   #替代料
   #            "       ) ",
   #            "   AND bmea009<= '",g_today,"' ",
   #            "   AND (bmea010 > '",g_today,"' OR bmea010 IS NULL ) "
   #
   #DECLARE asft310_chk_replace_c1 SCROLL CURSOR FROM l_sql
   #IF SQLCA.sqlcode THEN
   #   #CALL cl_err('',SQLCA.sqlcode,1)
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = ''
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #   LET r_success = FALSE
   #   RETURN r_success
   #END IF
   #OPEN asft310_chk_replace_c1
   #IF SQLCA.sqlcode THEN
   #   #CALL cl_err('',SQLCA.sqlcode,1)
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = ''
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #   LET r_success = FALSE
   #   RETURN r_success
   #END IF
   #FETCH FIRST asft310_chk_replace_c1 INTO l_bmea.*
   #IF SQLCA.sqlcode THEN
   #   #CALL cl_err('',SQLCA.sqlcode,1)
   #   INITIALIZE g_errparam TO NULL
   #   LET g_errparam.code = SQLCA.sqlcode
   #   LET g_errparam.extend = ''
   #   LET g_errparam.popup = TRUE
   #   CALL cl_err()
   #   LET r_success = FALSE
   #   RETURN r_success
   #END IF
   #CLOSE asft310_chk_replace_c1
   
  #160111-00028#1-s
  #抓取發料料號的上階料號
   CALL s_asft310_get_bmea(p_sfba001,p_sfaa011,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
  #CALL s_asft310_get_bmea(p_sfaa010,p_sfaa011,g_sfdc4_d[g_detail_idx].sfdc004,g_sfdc4_d[g_detail_idx].sfba002,g_sfdc4_d[g_detail_idx].sfba003,g_sfdc4_d[g_detail_idx].sfba004,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013)
  #160111-00028#1-e
      #RETURNING l_success,l_bmea.* #161109-00085#62 mark
      #161109-00085#62 --s add
      RETURNING l_success,l_bmea.bmeaent,l_bmea.bmeasite,l_bmea.bmea001,l_bmea.bmea002,
                l_bmea.bmea003,l_bmea.bmea004,l_bmea.bmea005,l_bmea.bmea006,l_bmea.bmea007,
                l_bmea.bmea008,l_bmea.bmea009,l_bmea.bmea010,l_bmea.bmea011,l_bmea.bmea012,
                l_bmea.bmea013,l_bmea.bmea014,l_bmea.bmea015,l_bmea.bmea016,l_bmea.bmea017,
                l_bmea.bmea018,l_bmea.bmea019,l_bmea.bmeaud001,l_bmea.bmeaud002,l_bmea.bmeaud003,
                l_bmea.bmeaud004,l_bmea.bmeaud005,l_bmea.bmeaud006,l_bmea.bmeaud007,l_bmea.bmeaud008,
                l_bmea.bmeaud009,l_bmea.bmeaud010,l_bmea.bmeaud011,l_bmea.bmeaud012,l_bmea.bmeaud013,
                l_bmea.bmeaud014,l_bmea.bmeaud015,l_bmea.bmeaud016,l_bmea.bmeaud017,l_bmea.bmeaud018,
                l_bmea.bmeaud019,l_bmea.bmeaud020,l_bmea.bmeaud021,l_bmea.bmeaud022,l_bmea.bmeaud023,
                l_bmea.bmeaud024,l_bmea.bmeaud025,l_bmea.bmeaud026,l_bmea.bmeaud027,l_bmea.bmeaud028,
                l_bmea.bmeaud029,l_bmea.bmeaud030,l_bmea.bmea020
      #161109-00085#62 --e add
   IF NOT l_success THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #替代料有限定客戶,需检查
   IF l_bmea.bmea014 = 'Y' THEN
      SELECT sfaa009 INTO l_sfaa009 FROM sfaa_t
       WHERE sfaaent   = g_enterprise
         AND sfaadocno = g_sfdc4_d[g_detail_idx].sfdc001
      IF NOT cl_null(l_sfaa009) THEN
         SELECT COUNT(1) INTO l_cnt FROM bmeb_t
          WHERE bmebent  = l_bmea.bmeaent
            AND bmebsite = l_bmea.bmeasite
            AND bmeb001  = l_bmea.bmea001
            AND bmeb002  = l_bmea.bmea002
            AND bmeb003  = l_bmea.bmea003
            AND bmeb004  = l_bmea.bmea004
            AND bmeb005  = l_bmea.bmea005
            AND bmeb006  = l_bmea.bmea006
            AND bmeb007  = l_bmea.bmea007
            AND bmeb008  = l_bmea.bmea008
            AND bmeb010  = l_bmea.bmea019
            AND bmeb009  = l_sfaa009
         IF l_cnt = 0 THEN
            #替代料已作限定客户控制，此客户不在客户限定范围内！请检查[产品结构取替代维护作业abmm211]！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00344'
            LET g_errparam.extend = l_sfaa009
            LET g_errparam.popup = TRUE
            CALL cl_err()

            LET r_success = FALSE
            RETURN r_success
         END IF
      END IF
   END IF

   RETURN r_success
END FUNCTION

#替换料件折合成元件的数量之总和
PRIVATE FUNCTION asft310_get_sfdd007_replace(p_cmd)
DEFINE p_cmd            LIKE type_t.chr1
DEFINE r_success        LIKE type_t.num5
DEFINE r_sfdd007        LIKE sfdd_t.sfdd007  #數量
DEFINE r_sfdd009        LIKE sfdd_t.sfdd009  #參考單位數量
DEFINE l_sql            STRING
DEFINE l_sfdd001        LIKE sfdd_t.sfdd001  #发料料号
DEFINE l_sfdd013        LIKE sfdd_t.sfdd013  #产品特征
DEFINE l_sfdd002        LIKE sfdd_t.sfdd002  #替代率
DEFINE l_sfdd006        LIKE sfdd_t.sfdd006  #单位
DEFINE l_sfdd007        LIKE sfdd_t.sfdd007  #数量
DEFINE l_sfdd008        LIKE sfdd_t.sfdd008  #参考单位
DEFINE l_sfdd009        LIKE sfdd_t.sfdd009  #参考数量
DEFINE l_success        LIKE type_t.num5
DEFINE l_rate1          LIKE sfdd_t.sfdd002  #对sfdc006单位的换算率
DEFINE l_rate2          LIKE sfdd_t.sfdd002  #对sfdc009参考单位的换算率

   LET r_success = TRUE
   LET r_sfdd007 = 0
   LET r_sfdd009 = 0
   
   IF cl_null(g_sfdd_d[l_ac].sfdd013) THEN LET g_sfdd_d[l_ac].sfdd013 = ' ' END IF  #替代料产品特征
   #获取除当笔以外其他所有同替代料的数量的总和
   LET l_sql = " SELECT sfdd001,sfdd013,sfdd002,sfdd006,sfdd007,sfdd008,sfdd009 FROM sfdd_t ",
               " WHERE sfddent   = ",g_enterprise,
               "   AND sfdddocno = '",g_sfda_m.sfdadocno,"' ",
               "   AND sfddseq   = ",g_sfdc4_d[g_detail_idx].sfdcseq,
               "   AND sfdd001   ='",g_sfdd_d[l_ac].sfdd001,"' "
   IF NOT cl_null(g_sfdd_d[l_ac].sfdd013) THEN
      LET l_sql = l_sql CLIPPED," AND sfdd013   ='",g_sfdd_d[l_ac].sfdd013,"' "
   END IF
   IF p_cmd = 'u' THEN
      LET l_sql = l_sql CLIPPED," AND sfddseq1 != ",g_sfdd_d_t.sfddseq1
   END IF
   PREPARE asft310_get_sfdd007_replace_p1 FROM l_sql
   DECLARE asft310_get_sfdd007_replace_c1 CURSOR FOR asft310_get_sfdd007_replace_p1
   FOREACH asft310_get_sfdd007_replace_c1 INTO l_sfdd001,l_sfdd013,l_sfdd002,l_sfdd006,l_sfdd007,l_sfdd008,l_sfdd009
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach asft310_get_sfdd007_replace_c1'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         LET r_success = FALSE
         RETURN r_success,r_sfdd007,r_sfdd009
      END IF
      IF cl_null(l_sfdd007) THEN LET l_sfdd007 = 0 END IF
      IF cl_null(l_sfdd009) THEN LET l_sfdd009 = 0 END IF
      
      #取替代了,直接考虑取替代率
      LET l_sfdd007 = l_sfdd007 / l_sfdd002
      LET l_sfdd009 = l_sfdd009 / l_sfdd002
      
      #计算汇总数量
      LET r_sfdd007 = r_sfdd007 + l_sfdd007
      LET r_sfdd009 = r_sfdd009 + l_sfdd009
   END FOREACH
   
   #取当前编辑笔的数量
   #取替代了,直接考虑取替代率
   LET l_sfdd007 = g_sfdd_d[l_ac].sfdd007 / g_sfdd_d[l_ac].sfdd002
   LET l_sfdd009 = g_sfdd_d[l_ac].sfdd009 / g_sfdd_d[l_ac].sfdd002
   #计算汇总数量
   LET r_sfdd007 = r_sfdd007 + l_sfdd007
   LET r_sfdd009 = r_sfdd009 + l_sfdd009
   
   RETURN r_success,r_sfdd007,r_sfdd009
END FUNCTION

#add 150831 批序号资料处理（实际的）
PRIVATE FUNCTION asft310_del_inao()
DEFINE r_success  LIKE type_t.num5

   LET r_success = TRUE

   DELETE FROM inao_t
    WHERE inaoent = g_enterprise AND inaosite = g_site
      AND inaodocno = g_sfda_m.sfdadocno
      AND inaoseq = g_sfdc4_d[g_detail_idx].sfdcseq #項次
      AND inaoseq1 = g_sfdd_d_t.sfddseq1 #项序
      AND inao000  = '2'  #实际的
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "DELETE inao"
      LET g_errparam.popup = TRUE
      CALL cl_err()

      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

#检查传入特征可退数量（已发-已退-待退）
#add 141209
PRIVATE FUNCTION asft310_chk_feature2()
   DEFINE r_success  LIKE type_t.num5
   DEFINE l_imaa005  LIKE imaa_t.imaa005
   DEFINE l_sql      STRING
   DEFINE l_sfdd006  LIKE sfdd_t.sfdd006  #退料单位
   DEFINE l_sfdd007  LIKE sfdd_t.sfdd007  #发料数量
   DEFINE l_qty      LIKE sfdc_t.sfdc007  #此特征可退量
   DEFINE l_qty1     LIKE sfdc_t.sfdc007  #已发量
   DEFINE l_qty2     LIKE sfdc_t.sfdc007  #已退量
   DEFINE l_rate     LIKE inaj_t.inaj014  #单位换算率
   
   LET r_success = TRUE
   #做产品特征管理的料件检查该特征的退料量不可超过已发量
   IF cl_null(g_sfdc_d[l_ac].sfdc001) OR cl_null(g_sfdc_d[l_ac].sfdc002) OR cl_null(g_sfdc_d[l_ac].sfdc003)
   OR cl_null(g_sfdc_d[l_ac].sfdc004) OR cl_null(g_sfdc_d[l_ac].sfdc005) 
   OR cl_null(g_sfdc_d[l_ac].sfdc006)   #单位
   OR cl_null(g_sfdc_d[l_ac].sfdc007) OR g_sfdc_d[l_ac].sfdc007=0 THEN
      RETURN r_success
   END IF
   
   SELECT imaa005 INTO l_imaa005 FROM imaa_t 
    WHERE imaaent = g_enterprise
      AND imaa001 = g_sfdc_d[l_ac].sfdc004
   IF cl_null(l_imaa005) THEN
      RETURN r_success  #不做特征管理的不需要检查
   END IF
   
   #计算已发量，折算成此次退料的量
   LET l_sql = "SELECT sfdd006,SUM(sfdd007) ",
               "  FROM sfdd_t,sfdc_t,sfda_t ",
               " WHERE sfddent   = sfdcent ",
               "   AND sfdddocno = sfdcdocno ",
               "   AND sfddseq   = sfdcseq ",
               "   AND sfddent   = sfdaent ",
               "   AND sfdddocno = sfdadocno ",
               "   AND sfdcent   = ",g_enterprise,
               "   AND sfdc001   = '",g_sfdc_d[l_ac].sfdc001,"' ", #工单
               "   AND sfdc002   = ",g_sfdc_d[l_ac].sfdc002,         #项次
               "   AND sfdd001   = '",g_sfdc_d[l_ac].sfdc004,"' ",
               "   AND sfdd013   = '",g_sfdc_d[l_ac].sfdc005,"' ",
               "   AND sfdd012   = -1 ",   #发料
               "   AND sfdastus  = 'S' ",  #已扣帐的
               " GROUP BY sfdd006 "
   PREPARE asft310_chk_feature2_qty_p1 FROM l_sql
   DECLARE asft310_chk_feature2_qty_c1 CURSOR FOR asft310_chk_feature2_qty_p1
   LET l_qty1 = 0
   FOREACH asft310_chk_feature2_qty_c1 INTO l_sfdd006,l_sfdd007
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach asft310_chk_feature2_qty_c1 err'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF

      #统一折算成此次退料的单位进行计算
      IF l_sfdd006 != g_sfdc_d[l_ac].sfdc006 THEN   #发料单位，工单单位
         #mod 150101
         #CALL s_aimi190_get_convert(g_sfdc_d[l_ac].sfdc004,l_sfdd006,g_sfdc_d[l_ac].sfdc006)
         #  RETURNING l_success,l_rate
         #IF NOT l_success THEN
         #   LET l_rate = 1
         #END IF
         #LET l_sfdd007 = l_sfdd007 * l_rate  #发料数量
         CALL s_aooi250_convert_qty(g_sfdc_d[l_ac].sfdc004,l_sfdd006,g_sfdc_d[l_ac].sfdc006,l_sfdd007)
           RETURNING l_success,g_qty_t
         IF l_success THEN
            LET l_sfdd007 = g_qty_t
         END IF
         #mod 150101 end
      END IF
      
      LET l_qty1 = l_qty1 + l_sfdd007
   END FOREACH
   
   #计算已退量，折算成此次退料的量
   #  2.1其他退料单的
   LET l_sql = "SELECT sfdd006,SUM(sfdd007) ",
               " FROM sfdd_t,sfdc_t,sfda_t ",
               " WHERE sfddent   = sfdcent ",
               "   AND sfdddocno = sfdcdocno ",
               "   AND sfddseq   = sfdcseq ",
               "   AND sfddent   = sfdaent ",
               "   AND sfdddocno = sfdadocno ",
               "   AND sfdcent   = ",g_enterprise,
               "   AND sfdcdocno != '",g_sfda_m.sfdadocno,"' ",  #退料单号
               "   AND sfdc001   = '",g_sfdc_d[l_ac].sfdc001,"' ", #工单
               "   AND sfdc002   = ",g_sfdc_d[l_ac].sfdc002,         #项次
               "   AND sfdc003   = ",g_sfdc_d[l_ac].sfdc003,        #项序
               "   AND sfdd001   = '",g_sfdc_d[l_ac].sfdc004,"' ", #料号
               "   AND sfdd013   = '",g_sfdc_d[l_ac].sfdc005,"' ", #特征
               "   AND sfdd012   = 1 ",   #退料
               "   AND sfdastus != 'X' ", #作废
               " GROUP BY sfdd006 ",
               " UNION ",
   #  2.2本张退料单实体表中的
               "SELECT sfdc006,SUM(sfdc007) ",
               " FROM sfdc_t ",
               " WHERE sfdcent   = ",g_enterprise,
               "   AND sfdcdocno = '",g_sfda_m.sfdadocno,"' ",  #退料单号
               "   AND sfdc001   = '",g_sfdc_d[l_ac].sfdc001,"' ", #工单
               "   AND sfdc002   = ",g_sfdc_d[l_ac].sfdc002,         #项次
               "   AND sfdc003   = ",g_sfdc_d[l_ac].sfdc003,        #项序
               "   AND sfdc004   = '",g_sfdc_d[l_ac].sfdc004,"' ",  #料号
               "   AND sfdc005   = '",g_sfdc_d[l_ac].sfdc005,"' "   #特征
               IF NOT cl_null(g_sfdc_d_t.sfdcseq) AND g_sfdc_d_t.sfdcseq != 0 THEN  #排除当前笔
                  LET l_sql = l_sql CLIPPED," AND sfdcseq  != ",g_sfdc_d_t.sfdcseq
               END IF
               LET l_sql = l_sql CLIPPED," GROUP BY sfdc006 "
   PREPARE asft310_chk_feature2_qty_p2 FROM l_sql
   DECLARE asft310_chk_feature2_qty_c2 CURSOR FOR asft310_chk_feature2_qty_p2
   LET l_qty2 = 0
   FOREACH asft310_chk_feature2_qty_c2 INTO l_sfdd006,l_sfdd007
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach asft310_chk_feature2_qty_c2 err'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      
      #统一折算成此次退料的单位进行计算
      IF l_sfdd006 != g_sfdc_d[l_ac].sfdc006 THEN   #发料单位，工单单位
         #mod 150101
         #CALL s_aimi190_get_convert(g_sfdc_d[l_ac].sfdc004,l_sfdd006,g_sfdc_d[l_ac].sfdc006)
         #  RETURNING l_success,l_rate
         #IF NOT l_success THEN
         #   LET l_rate = 1
         #END IF
         #LET l_sfdd007 = l_sfdd007 * l_rate  #发料数量
         CALL s_aooi250_convert_qty(g_sfdc_d[l_ac].sfdc004,l_sfdd006,g_sfdc_d[l_ac].sfdc006,l_sfdd007)
           RETURNING l_success,g_qty_t
         IF l_success THEN
            LET l_sfdd007 = g_qty_t
         END IF
         #mod 150101 end
      END IF
      
      LET l_qty2 = l_qty2 + l_sfdd007
   END FOREACH
   
   LET l_qty = l_qty1-l_qty2  #已发-已退=此特征可退量l_qty
   IF l_qty < g_sfdc_d[l_ac].sfdc007 THEN
      #此特征总退料量不可大于已发料数量，最多可退量为%1
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00648'
      LET g_errparam.extend = g_sfdc_d[l_ac].sfdc005
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = l_qty
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

#单头备注显示
#add 141222
PRIVATE FUNCTION asft310_show_sfda_ooff013()
   IF cl_null(g_sfda_m.sfdadocno) THEN
      RETURN
   END IF

   CALL s_aooi360_sel('6',g_sfda_m.sfdadocno,'','','','','','','','','','4')
      RETURNING l_success,g_sfda_m.sfda_ooff013
   DISPLAY BY NAME g_sfda_m.sfda_ooff013
END FUNCTION

#sfdc单身备注显示
#add 141222
PRIVATE FUNCTION asft310_show_sfdc_ooff013(p_ac)
   DEFINE p_ac        LIKE type_t.num5

   IF cl_null(g_sfda_m.sfdadocno) OR cl_null(g_sfdc_d[p_ac].sfdcseq) THEN
      RETURN
   END IF

   #bom单身备注
   CALL s_aooi360_sel('7',g_sfda_m.sfdadocno,g_sfdc_d[p_ac].sfdcseq,'','','','','','','','','4')
      RETURNING l_success,g_sfdc_d[p_ac].sfdc_ooff013
   DISPLAY BY NAME g_sfdc_d[l_ac].sfdc_ooff013
END FUNCTION

#单身备注显示
#141222
PRIVATE FUNCTION asft310_show_sfdd_ooff013(p_ac)
   DEFINE p_ac        LIKE type_t.num5

   IF cl_null(g_sfda_m.sfdadocno) OR cl_null(g_sfdc4_d[g_detail_idx].sfdcseq) OR cl_null(g_sfdd_d[p_ac].sfddseq1) THEN
      RETURN
   END IF

   #bom单身备注
   CALL s_aooi360_sel('7',g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[p_ac].sfddseq1,'','','','','','','','4')
      RETURNING l_success,g_sfdd_d[p_ac].sfdd_ooff013
   DISPLAY BY NAME g_sfdd_d[l_ac].sfdd_ooff013
END FUNCTION

#add 141222
PRIVATE FUNCTION asft310_update_ooff_key(p_type)
DEFINE p_type       LIKE type_t.chr1   #a:sfda修改引起（预留） c:sfdc修改引起 d:sfdd修改引起
DEFINE r_success    LIKE type_t.num5
DEFINE l_ooff003    LIKE ooff_t.ooff003
DEFINE l_ooff004    LIKE ooff_t.ooff004

   LET r_success = TRUE

   CASE p_type
      WHEN "a"   #bmaa修改引起  预留，暂定单头key值不可修改
         #单头备注
         UPDATE ooff_t SET ooff002 = g_sfda_m.sfdadocno
          WHERE ooffent = g_enterprise AND ooff001 = '6'
            AND ooff002 = g_sfdadocno_t
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
         END IF

         #单身备注sfdd,sfdc
         UPDATE ooff_t SET ooff002 = g_sfda_m.sfdadocno
          WHERE ooffent = g_enterprise AND ooff001 = '7'
            AND ooff002 = g_sfdadocno_t
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
         END IF
      WHEN "c"   #sfdc修改引起  预留，暂定单头key值不可修改
         #单身备注sfdd,sfdc
         LET l_ooff003 = g_sfdc_d_t.sfdcseq
         UPDATE ooff_t SET ooff003 = g_sfdc_d[l_ac].sfdcseq
          WHERE ooffent = g_enterprise AND ooff001 = '7'
            AND ooff002 = g_sfda_m.sfdadocno
            AND ooff003 = l_ooff003
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
         END IF
      WHEN "d"   #bmba修改引起
         #单身备注sfdd
         LET l_ooff003 = g_sfdc4_d[g_detail_idx].sfdcseq
         LET l_ooff004 = g_sfdd_d_t.sfddseq1
         UPDATE ooff_t SET ooff004 = g_sfdd_d[l_ac].sfddseq1
          WHERE ooffent = g_enterprise AND ooff001 = '7'
            AND ooff002 = g_sfda_m.sfdadocno
            AND ooff003 = l_ooff003
            AND ooff004 = l_ooff004
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
         END IF
   END CASE
   IF NOT r_success THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "UPDATE ooff_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF

   RETURN r_success
END FUNCTION

#add 150831
PRIVATE FUNCTION asft310_update_inao_key(p_type)
DEFINE p_type       LIKE type_t.chr1   #c:sfdc修改引起 d:sfdd修改引起  sfdf的不考虑，在表联动间已经处理
DEFINE r_success    LIKE type_t.num5

   LET r_success = TRUE

   CASE p_type
      WHEN "c"   #sfdc修改引起  预留，暂定单头key值不可修改
         #申请key值变化，inao的申请和实际一起变化，因为sfdd也会一起变化
         UPDATE inao_t SET inaoseq = g_sfdc_d[l_ac].sfdcseq
          WHERE inaoent   = g_enterprise AND inaosite = g_site
            AND inaodocno = g_sfda_m.sfdadocno
            AND inaoseq   = g_sfdc_d_t.sfdcseq
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
         END IF
      WHEN "d"   #bmba修改引起
         #实际key值变化
         UPDATE inao_t SET inaoseq1 = g_sfdd_d[l_ac].sfddseq1
          WHERE inaoent  = g_enterprise AND inaosite = g_site
            AND inaodocno= g_sfda_m.sfdadocno
            AND inaoseq  = g_sfdc4_d[g_detail_idx].sfdcseq
            AND inaoseq1 = g_sfdd_d_t.sfddseq1
            AND inao000  = '2'
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
         END IF
   END CASE
   IF NOT r_success THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "UPDATE ooff_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF

   RETURN r_success
END FUNCTION

#欠料補料之工單有無欠料資訊
#add 141226
PRIVATE FUNCTION asft310_chk_13(p_workno)
   DEFINE p_workno      LIKE sfaa_t.sfaadocno  #工单单号
   DEFINE r_success     LIKE type_t.num5       #T:有 F：无
   DEFINE l_sql         STRING
   #DEFINE l_sfba            RECORD LIKE sfba_t.* #161109-00085#62
   #161109-00085#62 --s add
   DEFINE l_sfba RECORD  #工單備料單身檔
          sfbaent LIKE sfba_t.sfbaent, #企業編號
          sfbasite LIKE sfba_t.sfbasite, #營運據點
          sfbadocno LIKE sfba_t.sfbadocno, #單號
          sfbaseq LIKE sfba_t.sfbaseq, #項次
          sfbaseq1 LIKE sfba_t.sfbaseq1, #項序
          sfba001 LIKE sfba_t.sfba001, #上階料號
          sfba002 LIKE sfba_t.sfba002, #部位
          sfba003 LIKE sfba_t.sfba003, #作業編號
          sfba004 LIKE sfba_t.sfba004, #作業序
          sfba005 LIKE sfba_t.sfba005, #BOM料號
          sfba006 LIKE sfba_t.sfba006, #發料料號
          sfba007 LIKE sfba_t.sfba007, #投料時距
          sfba008 LIKE sfba_t.sfba008, #必要特性
          sfba009 LIKE sfba_t.sfba009, #倒扣料
          sfba010 LIKE sfba_t.sfba010, #標準QPA分子
          sfba011 LIKE sfba_t.sfba011, #標準QPA分母
          sfba012 LIKE sfba_t.sfba012, #允許誤差率
          sfba013 LIKE sfba_t.sfba013, #應發數量
          sfba014 LIKE sfba_t.sfba014, #單位
          sfba015 LIKE sfba_t.sfba015, #委外代買數量
          sfba016 LIKE sfba_t.sfba016, #已發數量
          sfba017 LIKE sfba_t.sfba017, #報廢數量
          sfba018 LIKE sfba_t.sfba018, #盤虧數量
          sfba019 LIKE sfba_t.sfba019, #指定發料倉庫
          sfba020 LIKE sfba_t.sfba020, #指定發料儲位
          sfba021 LIKE sfba_t.sfba021, #產品特徵
          sfba022 LIKE sfba_t.sfba022, #替代率
          sfba023 LIKE sfba_t.sfba023, #標準應發數量
          sfba024 LIKE sfba_t.sfba024, #調整應發數量
          sfba025 LIKE sfba_t.sfba025, #超領數量
          sfba026 LIKE sfba_t.sfba026, #SET替代狀態
          sfba027 LIKE sfba_t.sfba027, #SET替代群組
          sfba028 LIKE sfba_t.sfba028, #客供料
          sfba029 LIKE sfba_t.sfba029, #指定發料批號
          sfba030 LIKE sfba_t.sfba030, #指定庫存管理特徵
          sfba031 LIKE sfba_t.sfba031, #備置量
          sfba032 LIKE sfba_t.sfba032, #備置理由碼
          sfba033 LIKE sfba_t.sfba033, #保稅否
          sfba034 LIKE sfba_t.sfba034, #SET被替代群組
          sfba035 LIKE sfba_t.sfba035  #SET替代套數
   END RECORD
   #161109-00085#62 --e add
   DEFINE l_sfaa049     LIKE sfaa_t.sfaa049
   DEFINE l_sfaa012     LIKE sfaa_t.sfaa012
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   IF cl_null(p_workno) THEN
      LET r_success = TRUE
      RETURN r_success
   END IF
   
   #LET l_sql = "SELECT sfba_t.*,sfaa049,sfaa012 FROM sfba_t,sfaa_t ", #161109-00085#62 mark
   #161109-00085#62 --s add
   LET l_sql = "SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1, ",
               "       sfba001,sfba002,sfba003,sfba004,sfba005, ",
               "       sfba006,sfba007,sfba008,sfba009,sfba010, ",
               "       sfba011,sfba012,sfba013,sfba014,sfba015, ",
               "       sfba016,sfba017,sfba018,sfba019,sfba020, ",
               "       sfba021,sfba022,sfba023,sfba024,sfba025, ",
               "       sfba026,sfba027,sfba028,sfba029,sfba030, ",
               "       sfba031,sfba032,sfba033,sfba034,sfba035, ",
               "       sfaa049,sfaa012 FROM sfba_t,sfaa_t ",
  #161109-00085#62 --e add
               " WHERE sfaadocno = sfbadocno AND sfaaent = sfbaent ",
               "   AND sfbadocno = '",p_workno,"' ",
               "   AND sfbaent   = ",g_enterprise,
               "   AND sfba009  = 'N' ",          #倒扣料
               "   AND (sfba013 - sfba015) >0 ",  #应发-委外代买量>0
               "   AND sfba008 != '4' "           #非参考材料
   PREPARE asft310_chk_13_p FROM l_sql
   DECLARE asft310_chk_13_c CURSOR FOR asft310_chk_13_p
   #FOREACH asft310_chk_13_c INTO l_sfba.*,l_sfaa049,l_sfaa012 #161109-00085#62 mark
   #161109-00085#62 --s add
   FOREACH asft310_chk_13_c INTO l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1, 
                                 l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
                                 l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
                                 l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
                                 l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
                                 l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
                                 l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
                                 l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035,
                                 l_sfaa049,l_sfaa012
   #161109-00085#62 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach asft310_chk_13_c err'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      CALL asft310_chk_13_detail(l_sfba.*,l_sfaa049,l_sfaa012) RETURNING l_success
      IF l_success THEN
         LET r_success = TRUE
         RETURN r_success
      END IF
   END FOREACH
   FREE asft310_chk_13_p
   
   
   RETURN r_success
END FUNCTION

#工单单身明细有无欠料资讯
#add 141226
PRIVATE FUNCTION asft310_chk_13_detail(p_sfba,p_sfaa049,p_sfaa012)
   #DEFINE p_sfba        RECORD LIKE sfba_t.* #161109-00085#62 mark
   #161109-00085#62 --s add
   DEFINE p_sfba RECORD  #工單備料單身檔
          sfbaent LIKE sfba_t.sfbaent, #企業編號
          sfbasite LIKE sfba_t.sfbasite, #營運據點
          sfbadocno LIKE sfba_t.sfbadocno, #單號
          sfbaseq LIKE sfba_t.sfbaseq, #項次
          sfbaseq1 LIKE sfba_t.sfbaseq1, #項序
          sfba001 LIKE sfba_t.sfba001, #上階料號
          sfba002 LIKE sfba_t.sfba002, #部位
          sfba003 LIKE sfba_t.sfba003, #作業編號
          sfba004 LIKE sfba_t.sfba004, #作業序
          sfba005 LIKE sfba_t.sfba005, #BOM料號
          sfba006 LIKE sfba_t.sfba006, #發料料號
          sfba007 LIKE sfba_t.sfba007, #投料時距
          sfba008 LIKE sfba_t.sfba008, #必要特性
          sfba009 LIKE sfba_t.sfba009, #倒扣料
          sfba010 LIKE sfba_t.sfba010, #標準QPA分子
          sfba011 LIKE sfba_t.sfba011, #標準QPA分母
          sfba012 LIKE sfba_t.sfba012, #允許誤差率
          sfba013 LIKE sfba_t.sfba013, #應發數量
          sfba014 LIKE sfba_t.sfba014, #單位
          sfba015 LIKE sfba_t.sfba015, #委外代買數量
          sfba016 LIKE sfba_t.sfba016, #已發數量
          sfba017 LIKE sfba_t.sfba017, #報廢數量
          sfba018 LIKE sfba_t.sfba018, #盤虧數量
          sfba019 LIKE sfba_t.sfba019, #指定發料倉庫
          sfba020 LIKE sfba_t.sfba020, #指定發料儲位
          sfba021 LIKE sfba_t.sfba021, #產品特徵
          sfba022 LIKE sfba_t.sfba022, #替代率
          sfba023 LIKE sfba_t.sfba023, #標準應發數量
          sfba024 LIKE sfba_t.sfba024, #調整應發數量
          sfba025 LIKE sfba_t.sfba025, #超領數量
          sfba026 LIKE sfba_t.sfba026, #SET替代狀態
          sfba027 LIKE sfba_t.sfba027, #SET替代群組
          sfba028 LIKE sfba_t.sfba028, #客供料
          sfba029 LIKE sfba_t.sfba029, #指定發料批號
          sfba030 LIKE sfba_t.sfba030, #指定庫存管理特徵
          sfba031 LIKE sfba_t.sfba031, #備置量
          sfba032 LIKE sfba_t.sfba032, #備置理由碼
          sfba033 LIKE sfba_t.sfba033, #保稅否
          sfba034 LIKE sfba_t.sfba034, #SET被替代群組
          sfba035 LIKE sfba_t.sfba035  #SET替代套數
   END RECORD
   #161109-00085#62 --e add
   DEFINE p_sfaa049     LIKE sfaa_t.sfaa049    #已發套數
   DEFINE p_sfaa012     LIKE sfaa_t.sfaa012    #生產數量
   DEFINE r_success     LIKE type_t.num5       #T:有 F：无
   DEFINE issue_qty     LIKE sfba_t.sfba013
   DEFINE l_sfdc007     LIKE sfdc_t.sfdc007
   
   WHENEVER ERROR CONTINUE
   LET r_success = FALSE
   
   #计算发料单上已产生的发料数量
   #不用考虑不同单位、取替代,因为sfdc上的单位默认带出工单单位不能修改，sfdc上也不能增加取替代，在sfdd上才有这个功能
   SELECT SUM(sfdc007) INTO l_sfdc007 FROM sfdc_t
    WHERE sfdcent = g_enterprise
      AND sfdcdocno=g_sfda_m.sfdadocno
      AND sfdc001 = p_sfba.sfbadocno  #工单单号
      AND sfdc002 = p_sfba.sfbaseq    #工单项次
      AND sfdc003 = p_sfba.sfbaseq1   #工单项序
   IF cl_null(l_sfdc007 ) THEN LET l_sfdc007  = 0 END IF
   
   #工单单身某笔总共应发=应发-扣除委外代買量
   LET p_sfba.sfba013=p_sfba.sfba013-p_sfba.sfba015
   
   #欠料补料把已发套数中不足的部分补发出去
   IF p_sfaa049 = p_sfaa012 THEN  #已發套數=生產數量,即要把剩余
      #應發總數量-已發數量-发料单上已产生的发料数量
      LET issue_qty = p_sfba.sfba013 - p_sfba.sfba016 - l_sfdc007 
   ELSE
      LET issue_qty = p_sfaa049 * p_sfba.sfba010 / p_sfba.sfba011 - p_sfba.sfba016 - l_sfdc007 
   END IF
   
   #发料时的應發量 > 应发 - 已发
   IF issue_qty>(p_sfba.sfba013-p_sfba.sfba016) THEN
      LET issue_qty=(p_sfba.sfba013-p_sfba.sfba016)
   END IF
   
   IF issue_qty > 0 THEN #有欠料量
      LET r_success = TRUE
      RETURN r_success
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 检查 PBI sfda005 值的合法性
# Memo...........:
# Usage..........: CALL asft310_chk_sfda005()
#                       RETURNING r_success
# Input parameter: NULL
# Return code....: r_success 检查通过否标识位
# Date & Author..: 2014-12-29 By zhangllc
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_chk_sfda005()
   DEFINE r_success      LIKE type_t.num5
   DEFINE l_sfqastus     LIKE sfqa_t.sfqastus
   DEFINE l_success      LIKE type_t.num5
   DEFINE l_errno        LIKE gzze_t.gzze001
   DEFINE l_cnt          LIKE type_t.num5

   WHENEVER ERROR CONTINUE
   LET r_success = FALSE

   SELECT sfqastus INTO l_sfqastus FROM sfqa_t
    WHERE sfqaent   = g_enterprise
      AND sfqadocno = g_sfda_m.sfda005
   CASE
      WHEN SQLCA.sqlcode = 100  LET l_errno = 'asf-00470'   #无此PBI编号
      WHEN l_sfqastus <> 'Y'    LET l_errno = 'sub-00180'   #此笔资料未审核
      OTHERWISE                 LET l_errno = SQLCA.SQLCODE USING '-----'
   END CASE
   IF NOT cl_null(l_errno) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = l_errno
      LET g_errparam.extend = g_sfda_m.sfda005
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   
   #检查单身是否有非本BPI的工单
   SELECT COUNT(1) INTO l_cnt FROM sfdb_t
    WHERE sfdbent   = g_enterprise
      AND sfdbdocno = g_sfda_m.sfdadocno
      AND sfdb001 NOT IN (SELECT UNIQUE sfqb001 FROM sfqb_t
                           WHERE sfqbent   = g_enterprise
                             AND sfqbdocno = g_sfda_m.sfda005 
                         )
   IF l_cnt > 0 THEN
      #单身已有工资料，与此PBI不匹配；请先删除单身
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00472'
      LET g_errparam.extend = g_sfda_m.sfda005
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF
   SELECT COUNT(1) INTO l_cnt FROM sfdc_t
    WHERE sfdcent   = g_enterprise
      AND sfdcdocno = g_sfda_m.sfdadocno
      AND sfdc001 NOT IN (SELECT UNIQUE sfqb001 FROM sfqb_t
                           WHERE sfqbent   = g_enterprise
                             AND sfqbdocno = g_sfda_m.sfda005 
                         )
   IF l_cnt > 0 THEN
      #单身已有工资料，与此PBI不匹配；请先删除单身
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00472'
      LET g_errparam.extend = g_sfda_m.sfda005
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN r_success
   END IF

   LET r_success = TRUE
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 根据单头PBI编号自动产生单身资料
# Memo...........:
# Usage..........: CALL asft310_gen_b_sfda005()
# Input parameter: NULL
# Return code....: NULL
# Date & Author..: 2014/12/29 By zhangllc
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_gen_b_sfda005()
   DEFINE l_sfqb001   LIKE sfqb_t.sfqb001  #工單單號
   DEFINE l_sql       STRING
   #161109-00085#29-s 
   #DEFINE l_sfdc      RECORD LIKE sfdc_t.*
   #DEFINE l_sfdb      RECORD LIKE sfdb_t.*
   #DEFINE l_sfdb RECORD  #發退料套數檔
   #    sfdbent LIKE sfdb_t.sfdbent, #企業編號
   #    sfdbsite LIKE sfdb_t.sfdbsite, #營運據點
   #    sfdbdocno LIKE sfdb_t.sfdbdocno, #發退料單號
   #    sfdb001 LIKE sfdb_t.sfdb001, #工單單號
   #    sfdb002 LIKE sfdb_t.sfdb002, #Run Card
   #    sfdb003 LIKE sfdb_t.sfdb003, #部位
   #    sfdb004 LIKE sfdb_t.sfdb004, #作業
   #    sfdb005 LIKE sfdb_t.sfdb005, #作業序
   #    sfdb006 LIKE sfdb_t.sfdb006, #預計套數
   #    sfdb007 LIKE sfdb_t.sfdb007, #實際套數
   #    sfdb008 LIKE sfdb_t.sfdb008  #正負
   #END RECORD
   #161109-00085#29-e
   #161109-00085#62 --s add
   DEFINE l_sfdb RECORD  #發退料套數檔
          sfdbent LIKE sfdb_t.sfdbent, #企業編號
          sfdbsite LIKE sfdb_t.sfdbsite, #營運據點
          sfdbdocno LIKE sfdb_t.sfdbdocno, #發退料單號
          sfdb001 LIKE sfdb_t.sfdb001, #工單單號
          sfdb002 LIKE sfdb_t.sfdb002, #Run Card
          sfdb003 LIKE sfdb_t.sfdb003, #部位
          sfdb004 LIKE sfdb_t.sfdb004, #作業
          sfdb005 LIKE sfdb_t.sfdb005, #作業序
          sfdb006 LIKE sfdb_t.sfdb006, #預計套數
          sfdb007 LIKE sfdb_t.sfdb007, #實際套數
          sfdb008 LIKE sfdb_t.sfdb008, #正負
          sfdbud001 LIKE sfdb_t.sfdbud001, #自定義欄位(文字)001
          sfdbud002 LIKE sfdb_t.sfdbud002, #自定義欄位(文字)002
          sfdbud003 LIKE sfdb_t.sfdbud003, #自定義欄位(文字)003
          sfdbud004 LIKE sfdb_t.sfdbud004, #自定義欄位(文字)004
          sfdbud005 LIKE sfdb_t.sfdbud005, #自定義欄位(文字)005
          sfdbud006 LIKE sfdb_t.sfdbud006, #自定義欄位(文字)006
          sfdbud007 LIKE sfdb_t.sfdbud007, #自定義欄位(文字)007
          sfdbud008 LIKE sfdb_t.sfdbud008, #自定義欄位(文字)008
          sfdbud009 LIKE sfdb_t.sfdbud009, #自定義欄位(文字)009
          sfdbud010 LIKE sfdb_t.sfdbud010, #自定義欄位(文字)010
          sfdbud011 LIKE sfdb_t.sfdbud011, #自定義欄位(數字)011
          sfdbud012 LIKE sfdb_t.sfdbud012, #自定義欄位(數字)012
          sfdbud013 LIKE sfdb_t.sfdbud013, #自定義欄位(數字)013
          sfdbud014 LIKE sfdb_t.sfdbud014, #自定義欄位(數字)014
          sfdbud015 LIKE sfdb_t.sfdbud015, #自定義欄位(數字)015
          sfdbud016 LIKE sfdb_t.sfdbud016, #自定義欄位(數字)016
          sfdbud017 LIKE sfdb_t.sfdbud017, #自定義欄位(數字)017
          sfdbud018 LIKE sfdb_t.sfdbud018, #自定義欄位(數字)018
          sfdbud019 LIKE sfdb_t.sfdbud019, #自定義欄位(數字)019
          sfdbud020 LIKE sfdb_t.sfdbud020, #自定義欄位(數字)020
          sfdbud021 LIKE sfdb_t.sfdbud021, #自定義欄位(日期時間)021
          sfdbud022 LIKE sfdb_t.sfdbud022, #自定義欄位(日期時間)022
          sfdbud023 LIKE sfdb_t.sfdbud023, #自定義欄位(日期時間)023
          sfdbud024 LIKE sfdb_t.sfdbud024, #自定義欄位(日期時間)024
          sfdbud025 LIKE sfdb_t.sfdbud025, #自定義欄位(日期時間)025
          sfdbud026 LIKE sfdb_t.sfdbud026, #自定義欄位(日期時間)026
          sfdbud027 LIKE sfdb_t.sfdbud027, #自定義欄位(日期時間)027
          sfdbud028 LIKE sfdb_t.sfdbud028, #自定義欄位(日期時間)028
          sfdbud029 LIKE sfdb_t.sfdbud029, #自定義欄位(日期時間)029
          sfdbud030 LIKE sfdb_t.sfdbud030  #自定義欄位(日期時間)030
   END RECORD
   #161109-00085#62 --e add
   WHENEVER ERROR CONTINUE
   
   IF cl_null(g_sfda_m.sfda005) THEN
      RETURN
   END IF
   
   #倒扣料和一般退料不预设
   IF g_sfda_m.sfda002='14' OR g_sfda_m.sfda002='23' OR g_sfda_m.sfda002= '24' THEN
      RETURN
   END IF
   
   #自动产生sfdb
   LET l_sql = "SELECT sfqb001 FROM sfqb_t ",
               " WHERE sfqbent   = ",g_enterprise,
               "   AND sfqbdocno = '",g_sfda_m.sfda005,"' "
   PREPARE asft310_gen_b_sfda005_p FROM l_sql
   DECLARE asft310_gen_b_sfda005_c CURSOR FOR asft310_gen_b_sfda005_p
   
   CALL cl_err_collect_init()
   #CALL s_transaction_begin()
   
   FOREACH asft310_gen_b_sfda005_c INTO l_sfqb001
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'foreach asft310_gen_b_sfda005_c err'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      #检查是否存在工单中，且为发放状态
      IF NOT s_asft300_chk_stus(l_sfqb001,'F') THEN
         CONTINUE FOREACH
      END IF
       
      #欠料补料检查是否有需补料的
      IF g_sfda_m.sfda002 = '13' THEN
         IF NOT asft310_chk_13(l_sfqb001) THEN
            #无欠料，不需补料
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00665'
            LET g_errparam.extend = l_sfqb001
            LET g_errparam.popup = FALSE
            CALL cl_err()
            CONTINUE FOREACH
         END IF
      END IF

      INITIALIZE l_sfdb.* TO NULL
      LET l_sfdb.sfdbent   = g_enterprise   #企業編號
      LET l_sfdb.sfdbsite  = g_site         #營運據點
      LET l_sfdb.sfdbdocno = g_sfda_m.sfdadocno   #發退料單號
      LET l_sfdb.sfdb001   = l_sfqb001   #工單單號
      LET l_sfdb.sfdb002   = ''   #Run Card
      LET l_sfdb.sfdb003   = ' '   #部位
      LET l_sfdb.sfdb004   = ' '   #作業
      LET l_sfdb.sfdb005   = ' '   #作業序
      LET l_sfdb.sfdb006   = 0   #預計套數
      LET l_sfdb.sfdb007   = 0   #實際套數
      IF g_prog[1,6]='asft31' THEN
         LET l_sfdb.sfdb008 = -1  #正负 发料-1
      END IF
      IF g_prog[1,6]='asft32' THEN
         LET l_sfdb.sfdb008 = 1   #正负 退料1
      END IF

      #runcard
      SELECT sfca001 INTO l_sfdb.sfdb002 FROM sfca_t
       WHERE sfcaent = g_enterprise
         AND sfcasite= g_site
         AND sfcadocno=l_sfqb001   #工单单号
      
      #预计套数
      IF g_sfda_m.sfda002 = '11' THEN
         CALL s_asft310_get_max_set('a','11',g_sfda_m.sfdadocno,
                                    l_sfdb.sfdb001,l_sfdb.sfdb002,l_sfdb.sfdb003,
                                    l_sfdb.sfdb004,l_sfdb.sfdb005,
                                    '','','','','','')
            RETURNING l_sfdb.sfdb006
      ELSE
         LET l_sfdb.sfdb006 = 0
      END IF
      IF g_sfda_m.sfda002 = '15' THEN #制程中委外发料
         CALL s_asft310_get_max_set('a','15',g_sfda_m.sfdadocno,
                                    l_sfdb.sfdb001,l_sfdb.sfdb002,l_sfdb.sfdb003,
                                    l_sfdb.sfdb004,l_sfdb.sfdb005,
                                    '','','','','','')
            RETURNING l_sfdb.sfdb006
      END IF

      #实际套数
      IF g_sfda_m.sfda002 = '11' OR g_sfda_m.sfda002 = '21' THEN
         LET l_sfdb.sfdb007 = l_sfdb.sfdb006
      ELSE
         LET l_sfdb.sfdb007 = 0
      END IF
      #161109-00085#29-s
      #INSERT INTO sfdb_t VALUES l_sfdb.*
      #161109-00085#62 --s mark
      #INSERT INTO sfdb_t(sfdbent,sfdbsite,sfdbdocno,sfdb001,sfdb002,sfdb003,sfdb004,sfdb005,sfdb006,sfdb007,sfdb008)
      #           VALUES (l_sfdb.sfdbent,l_sfdb.sfdbsite,l_sfdb.sfdbdocno,l_sfdb.sfdb001,l_sfdb.sfdb002,
      #                   l_sfdb.sfdb003,l_sfdb.sfdb004,l_sfdb.sfdb005,l_sfdb.sfdb006,l_sfdb.sfdb007,l_sfdb.sfdb008)
      #161109-00085#62 --e mark
      #161109-00085#29-e
      #161109-00085#62 --s add
      INSERT INTO sfdb_t(sfdbent,sfdbsite,sfdbdocno,sfdb001,sfdb002,
                         sfdb003,sfdb004,sfdb005,sfdb006,sfdb007,
                         sfdb008,sfdbud001,sfdbud002,sfdbud003,sfdbud004,
                         sfdbud005,sfdbud006,sfdbud007,sfdbud008,sfdbud009,
                         sfdbud010,sfdbud011,sfdbud012,sfdbud013,sfdbud014,
                         sfdbud015,sfdbud016,sfdbud017,sfdbud018,sfdbud019,
                         sfdbud020,sfdbud021,sfdbud022,sfdbud023,sfdbud024,
                         sfdbud025,sfdbud026,sfdbud027,sfdbud028,sfdbud029,
                         sfdbud030)
      VALUES (l_sfdb.sfdbent,l_sfdb.sfdbsite,l_sfdb.sfdbdocno,l_sfdb.sfdb001,l_sfdb.sfdb002,
              l_sfdb.sfdb003,l_sfdb.sfdb004,l_sfdb.sfdb005,l_sfdb.sfdb006,l_sfdb.sfdb007,
              l_sfdb.sfdb008,l_sfdb.sfdbud001,l_sfdb.sfdbud002,l_sfdb.sfdbud003,l_sfdb.sfdbud004,
              l_sfdb.sfdbud005,l_sfdb.sfdbud006,l_sfdb.sfdbud007,l_sfdb.sfdbud008,l_sfdb.sfdbud009,
              l_sfdb.sfdbud010,l_sfdb.sfdbud011,l_sfdb.sfdbud012,l_sfdb.sfdbud013,l_sfdb.sfdbud014,
              l_sfdb.sfdbud015,l_sfdb.sfdbud016,l_sfdb.sfdbud017,l_sfdb.sfdbud018,l_sfdb.sfdbud019,
              l_sfdb.sfdbud020,l_sfdb.sfdbud021,l_sfdb.sfdbud022,l_sfdb.sfdbud023,l_sfdb.sfdbud024,
              l_sfdb.sfdbud025,l_sfdb.sfdbud026,l_sfdb.sfdbud027,l_sfdb.sfdbud028,l_sfdb.sfdbud029,
              l_sfdb.sfdbud030)
      #161109-00085#62 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'insert sfdb'
         LET g_errparam.popup = FALSE
         CALL cl_err()
         CONTINUE FOREACH
      END IF
   END FOREACH
   FREE asft310_gen_b_sfda005_p
   
   #CALL s_transaction_end('Y','0')
   CALL cl_err_collect_show()
END FUNCTION

#单身单笔的formonly显示
#150121 add
PRIVATE FUNCTION asft310_b_show(p_table,p_ac)
DEFINE p_table     LIKE type_t.chr4
DEFINE p_ac        LIKE type_t.num5
DEFINE l_sfba001   LIKE sfba_t.sfba001  #生产料号
DEFINE l_sfaa011   LIKE sfaa_t.sfaa011  #特性

   CASE p_table
      WHEN 'sfdb'
           #部位说明
           CALL s_desc_get_acc_desc('215',g_sfdb_d[p_ac].sfdb003) RETURNING g_sfdb_d[p_ac].sfdb003_desc
     
           #作业说明
           CALL s_desc_get_acc_desc('221',g_sfdb_d[p_ac].sfdb004) RETURNING g_sfdb_d[p_ac].sfdb004_desc
     
           SELECT sfaa010,imaal003,imaal004,sfaa013,sfaa012
             INTO g_sfdb_d[p_ac].sfaa010,g_sfdb_d[p_ac].sfaa010_desc,g_sfdb_d[p_ac].sfaa010_desc2,
                  g_sfdb_d[p_ac].sfaa013,g_sfdb_d[p_ac].sfaa012
             FROM sfaa_t LEFT JOIN imaal_t ON sfaaent = imaalent AND sfaa010 = imaal001 AND imaal002 = g_dlang
            WHERE sfaaent   = g_enterprise
              AND sfaasite  = g_site
              AND sfaadocno = g_sfdb_d[p_ac].sfdb001
      WHEN 'sfdc'
           #单位
           CALL s_desc_get_unit_desc(g_sfdc_d[p_ac].sfdc006) RETURNING g_sfdc_d[p_ac].sfdc006_desc
           
           #参考单位
           CALL s_desc_get_unit_desc(g_sfdc_d[p_ac].sfdc009) RETURNING g_sfdc_d[p_ac].sfdc009_desc
           
           #理由码
           INITIALIZE g_ref_fields TO NULL
           LET g_ref_fields[1] = g_sfdc_d[p_ac].sfdc015
           CALL ap_ref_array2(g_ref_fields,"SELECT oocql004 FROM oocql_t WHERE oocqlent='"||g_enterprise||"' AND oocql001='226' AND oocql002=? AND oocql003='"||g_dlang||"'","") RETURNING g_rtn_fields
           LET g_sfdc_d[p_ac].sfdc015_desc = '', g_rtn_fields[1] , ''
           
           #需求料号品名规格
           CALL s_desc_get_item_desc(g_sfdc_d[p_ac].sfdc004) RETURNING g_sfdc_d[p_ac].sfdc004_desc,g_sfdc_d[p_ac].sfdc004_desc2
           #显示产品特征说明
           CALL s_feature_description(g_sfdc_d[p_ac].sfdc004,g_sfdc_d[p_ac].sfdc005)
              RETURNING l_success,g_sfdc_d[p_ac].sfdc005_desc
           IF NOT l_success THEN
              LET g_sfdc_d[p_ac].sfdc005_desc = ''
           END IF

           #保税料
           SELECT imaf034 INTO g_sfdc_d[p_ac].imaf034
             FROM imaf_t
            WHERE imafent = g_enterprise
              AND imafsite= g_site
              AND imaf001 = g_sfdc_d[p_ac].sfdc004
           
           #发料前调拨
           SELECT imae092 INTO g_sfdc_d[p_ac].imae092
             FROM imae_t
            WHERE imaeent = g_enterprise
              AND imaesite= g_site
              AND imae001 = g_sfdc_d[p_ac].sfdc004
           
           #差异数量
           LET g_sfdc_d[p_ac].diff  = g_sfdc_d[p_ac].sfdc007 - g_sfdc_d[p_ac].sfdc008
           #参考单位差异数量
           LET g_sfdc_d[p_ac].diff2 = g_sfdc_d[p_ac].sfdc010  - g_sfdc_d[p_ac].sfdc011
           
           #库位名称
           CALL s_desc_get_stock_desc(g_site,g_sfdc_d[p_ac].sfdc012) RETURNING g_sfdc_d[p_ac].sfdc012_desc
           
           #储位名称
           IF NOT cl_null(g_sfdc_d[p_ac].sfdc013) THEN
              CALL s_desc_get_locator_desc(g_site,g_sfdc_d[p_ac].sfdc012,g_sfdc_d[p_ac].sfdc013) RETURNING g_sfdc_d[p_ac].sfdc013_desc
           END IF

           #工单信息-部位、作业、作业序、客供料、应发料、已发量
           SELECT sfba002,sfba003,sfba004,sfba028,sfba013,sfba016,sfba001,sfaa011
             INTO g_sfdc_d[p_ac].sfba002,g_sfdc_d[p_ac].sfba003,g_sfdc_d[p_ac].sfba004,g_sfdc_d[p_ac].sfba028,
                  g_sfdc_d[p_ac].sfba013,g_sfdc_d[p_ac].sfba016,l_sfba001,l_sfaa011
             FROM sfba_t,sfaa_t
            WHERE sfbaent = sfaaent
              AND sfbasite= sfaasite
              AND sfbadocno=sfaadocno
              AND sfbaent = g_enterprise
              AND sfbasite= g_site
              AND sfbadocno=g_sfdc_d[p_ac].sfdc001
              AND sfbaseq = g_sfdc_d[p_ac].sfdc002
              AND sfbaseq1= g_sfdc_d[p_ac].sfdc003

           #部位说明
           INITIALIZE g_chkparam.* TO NULL
           LET g_chkparam.arg1 = '215'
           LET g_chkparam.arg2 = g_sfdc_d[p_ac].sfba002
           CALL cl_ref_val("v_oocql002")
           LET g_sfdc_d[p_ac].sfba002_desc = g_chkparam.return1
           
           #作业说明
           INITIALIZE g_chkparam.* TO NULL
           LET g_chkparam.arg1 = '221'
           LET g_chkparam.arg2 = g_sfdc_d[p_ac].sfba003
           CALL cl_ref_val("v_oocql002")
           LET g_sfdc_d[p_ac].sfba003_desc = g_chkparam.return1
           
           #replace取替代建议
           CALL s_abmm201_get_proposal(g_site,l_sfba001,l_sfaa011,g_sfdc_d[p_ac].sfdc004,g_sfdc_d[p_ac].sfba002,g_sfdc_d[p_ac].sfba003,g_sfdc_d[p_ac].sfba004) RETURNING g_sfdc_d[p_ac].replace 
           
           CALL asft310_show_sfdc_ooff013(p_ac) #add 141222 备注说明
      WHEN 'sfdf'
           #发料料号
           CALL s_desc_get_item_desc(g_sfdf_d[p_ac].sfdf001) RETURNING g_sfdf_d[p_ac].sfdf001_desc,g_sfdf_d[p_ac].sfdf001_desc2
           #显示产品特征说明
           CALL s_feature_description(g_sfdf_d[p_ac].sfdf001,g_sfdf_d[p_ac].sfdf013)
              RETURNING l_success,g_sfdf_d[p_ac].sfdf013_desc
           IF NOT l_success THEN
              LET g_sfdf_d[p_ac].sfdf013_desc = ''
           END IF
     
           #库位
           CALL s_desc_get_stock_desc(g_site,g_sfdf_d[p_ac].sfdf003) RETURNING g_sfdf_d[p_ac].sfdf003_desc
     
           #储位
           IF NOT cl_null(g_sfdf_d[p_ac].sfdf004) THEN
              CALL s_desc_get_locator_desc(g_site,g_sfdf_d[p_ac].sfdf003,g_sfdf_d[p_ac].sfdf004) RETURNING g_sfdf_d[p_ac].sfdf004_desc
           END IF

           #单位
           CALL s_desc_get_unit_desc(g_sfdf_d[p_ac].sfdf006) RETURNING g_sfdf_d[p_ac].sfdf006_desc
           DISPLAY BY NAME g_sfdf_d[p_ac].sfdf006_desc
     
           #参考单位
           CALL s_desc_get_unit_desc(g_sfdf_d[p_ac].sfdf008) RETURNING g_sfdf_d[p_ac].sfdf008_desc
           DISPLAY BY NAME g_sfdf_d[p_ac].sfdf008_desc
      WHEN 'sfdd'
           #发料料号
           CALL s_desc_get_item_desc(g_sfdd_d[p_ac].sfdd001) RETURNING g_sfdd_d[p_ac].sfdd001_desc,g_sfdd_d[p_ac].sfdd001_desc2
           DISPLAY BY NAME g_sfdd_d[p_ac].sfdd001_desc
           DISPLAY BY NAME g_sfdd_d[p_ac].sfdd001_desc2
           #显示产品特征说明
           CALL s_feature_description(g_sfdd_d[p_ac].sfdd001,g_sfdd_d[p_ac].sfdd013)
              RETURNING l_success,g_sfdd_d[p_ac].sfdd013_desc
           IF NOT l_success THEN
              LET g_sfdd_d[p_ac].sfdd013_desc = ''
           END IF
           DISPLAY BY NAME g_sfdd_d[p_ac].sfdd013_desc
           
           #库位
           CALL s_desc_get_stock_desc(g_site,g_sfdd_d[p_ac].sfdd003) RETURNING g_sfdd_d[p_ac].sfdd003_desc

           #储位
           IF NOT cl_null(g_sfdd_d[p_ac].sfdd004) THEN
              CALL s_desc_get_locator_desc(g_site,g_sfdd_d[p_ac].sfdd003,g_sfdd_d[p_ac].sfdd004) RETURNING g_sfdd_d[p_ac].sfdd004_desc
           END IF

           #单位
           CALL s_desc_get_unit_desc(g_sfdd_d[p_ac].sfdd006) RETURNING g_sfdd_d[p_ac].sfdd006_desc
           DISPLAY BY NAME g_sfdd_d[p_ac].sfdd006_desc

           #参考单位
           CALL s_desc_get_unit_desc(g_sfdd_d[p_ac].sfdd008) RETURNING g_sfdd_d[p_ac].sfdd008_desc
           DISPLAY BY NAME g_sfdd_d[p_ac].sfdd008_desc
           
           CALL asft310_show_sfdd_ooff013(p_ac) #add 141222 备注说明
   END CASE

END FUNCTION

PRIVATE FUNCTION asft310_set_act_visible()
   CALL cl_set_act_visible("modify_detail,mdemand,s_lot_sel",TRUE)  #151217-00023#5 add
END FUNCTION

PRIVATE FUNCTION asft310_set_act_no_visible()
  #151217-00023#5 add -----(S)
   IF g_sfda_m.sfdastus <> 'Y' THEN    
      CALL cl_set_act_visible("mdemand,s_lot_sel",FALSE)
   ELSE
      CALL cl_set_act_visible("modify_detail",FALSE)
   END IF 
  #151217-00023#5 add -----(E)
END FUNCTION

################################################################################
# Descriptions...: 產生申請資料的同時產生實際異動資料
# Memo...........:
# Usage..........: CALL asft310_ins_inao_2()
#                  RETURNING r_success
# Input parameter: 無
# Return code....: r_success   執行結果(TRUE/FALSE)
# Date & Author..: 15/12/30 By Sarah
# Modify.........: 151217-00023#5
################################################################################
PRIVATE FUNCTION asft310_ins_inao_2()
DEFINE  l_sql       STRING
#161109-00085#29-s
#DEFINE  l_inao      RECORD LIKE inao_t.* 
DEFINE l_inao RECORD  #製造批序號庫存異動明細檔
       inaoent LIKE inao_t.inaoent, #企業編號
       inaosite LIKE inao_t.inaosite, #營運據點
       inaodocno LIKE inao_t.inaodocno, #單號
       inaoseq LIKE inao_t.inaoseq, #項次
       inaoseq1 LIKE inao_t.inaoseq1, #項序
       inaoseq2 LIKE inao_t.inaoseq2, #序號
       inao000 LIKE inao_t.inao000, #資料類型
       inao001 LIKE inao_t.inao001, #料件編號
       inao002 LIKE inao_t.inao002, #產品特徵
       inao003 LIKE inao_t.inao003, #庫存管理特徵
       inao004 LIKE inao_t.inao004, #包裝容器編號
       inao005 LIKE inao_t.inao005, #庫位
       inao006 LIKE inao_t.inao006, #儲位
       inao007 LIKE inao_t.inao007, #批號
       inao008 LIKE inao_t.inao008, #製造批號
       inao009 LIKE inao_t.inao009, #製造序號
       inao010 LIKE inao_t.inao010, #製造日期
       inao011 LIKE inao_t.inao011, #有效日期
       inao012 LIKE inao_t.inao012, #數量
       inao013 LIKE inao_t.inao013, #出入庫碼
       #161109-00085#62 --s add
       inaoud001 LIKE inao_t.inaoud001, #自定義欄位(文字)001
       inaoud002 LIKE inao_t.inaoud002, #自定義欄位(文字)002
       inaoud003 LIKE inao_t.inaoud003, #自定義欄位(文字)003
       inaoud004 LIKE inao_t.inaoud004, #自定義欄位(文字)004
       inaoud005 LIKE inao_t.inaoud005, #自定義欄位(文字)005
       inaoud006 LIKE inao_t.inaoud006, #自定義欄位(文字)006
       inaoud007 LIKE inao_t.inaoud007, #自定義欄位(文字)007
       inaoud008 LIKE inao_t.inaoud008, #自定義欄位(文字)008
       inaoud009 LIKE inao_t.inaoud009, #自定義欄位(文字)009
       inaoud010 LIKE inao_t.inaoud010, #自定義欄位(文字)010
       inaoud011 LIKE inao_t.inaoud011, #自定義欄位(數字)011
       inaoud012 LIKE inao_t.inaoud012, #自定義欄位(數字)012
       inaoud013 LIKE inao_t.inaoud013, #自定義欄位(數字)013
       inaoud014 LIKE inao_t.inaoud014, #自定義欄位(數字)014
       inaoud015 LIKE inao_t.inaoud015, #自定義欄位(數字)015
       inaoud016 LIKE inao_t.inaoud016, #自定義欄位(數字)016
       inaoud017 LIKE inao_t.inaoud017, #自定義欄位(數字)017
       inaoud018 LIKE inao_t.inaoud018, #自定義欄位(數字)018
       inaoud019 LIKE inao_t.inaoud019, #自定義欄位(數字)019
       inaoud020 LIKE inao_t.inaoud020, #自定義欄位(數字)020
       inaoud021 LIKE inao_t.inaoud021, #自定義欄位(日期時間)021
       inaoud022 LIKE inao_t.inaoud022, #自定義欄位(日期時間)022
       inaoud023 LIKE inao_t.inaoud023, #自定義欄位(日期時間)023
       inaoud024 LIKE inao_t.inaoud024, #自定義欄位(日期時間)024
       inaoud025 LIKE inao_t.inaoud025, #自定義欄位(日期時間)025
       inaoud026 LIKE inao_t.inaoud026, #自定義欄位(日期時間)026
       inaoud027 LIKE inao_t.inaoud027, #自定義欄位(日期時間)027
       inaoud028 LIKE inao_t.inaoud028, #自定義欄位(日期時間)028
       inaoud029 LIKE inao_t.inaoud029, #自定義欄位(日期時間)029
       inaoud030 LIKE inao_t.inaoud030, #自定義欄位(日期時間)030
       #161109-00085#62 --e add
       inao014 LIKE inao_t.inao014, #庫存單位
       inao020 LIKE inao_t.inao020, #檢驗合格量
       inao021 LIKE inao_t.inao021, #已入庫/出貨/簽收量
       inao022 LIKE inao_t.inao022, #已驗退/簽退量
       inao023 LIKE inao_t.inao023, #已倉退/銷退量
       inao024 LIKE inao_t.inao024, #已轉QC量
       inao025 LIKE inao_t.inao025  #已退品量
END RECORD
#161109-00085#29-e
DEFINE  r_success   LIKE type_t.num5

   #先刪除實際資料
   DELETE FROM inao_t 
    WHERE inaoent = g_enterprise
      AND inaodocno = g_sfda_m.sfdadocno
      AND inaosite = g_site
      AND inaoseq = g_sfdc_d[l_ac].sfdcseq
      AND inao000 = '2'
            
   #161109-00085#29-s
   #LET l_sql = "SELECT * FROM inao_t ",
   #161109-00085#62 --s mark
   #LET l_sql = "SELECT inaoent,inaosite,inaodocno,inaoseq,inaoseq1,inaoseq2,inao000,inao001,inao002,inao003, ",
   #            "       inao004,inao005,inao006,inao007,inao008,inao009,inao010,inao011,inao012,inao013, ",
   #            "       inao014,inao020,inao021,inao022,inao023,inao024,inao025 ",
   #            "FROM inao_t ",
   #161109-00085#62 --e mark
   #161109-00085#29-e
   #161109-00085#62 --s add
   LET l_sql = "SELECT inaoent,inaosite,inaodocno,inaoseq,inaoseq1,inaoseq2,inao000,inao001,inao002,inao003, ",
               "       inao004,inao005,inao006,inao007,inao008,inao009,inao010,inao011,inao012,inao013, ",
               "       inaoud001,inaoud002,inaoud003,inaoud004,inaoud005,inaoud006,inaoud007,inaoud008,inaoud009,inaoud010, ",
               "       inaoud011,inaoud012,inaoud013,inaoud014,inaoud015,inaoud016,inaoud017,inaoud018,inaoud019,inaoud020, ",
               "       inaoud021,inaoud022,inaoud023,inaoud024,inaoud025,inaoud026,inaoud027,inaoud028,inaoud029,inaoud030, ",
               "       inao014,inao020,inao021,inao022,inao023,inao024,inao025",
               "FROM inao_t ",
   #161109-00085#62 --e add
               " WHERE inaoent = ",g_enterprise,
               "   AND inaodocno = '",g_sfda_m.sfdadocno,"'",
               "   AND inaoseq = ",g_sfdc_d[l_ac].sfdcseq,
               "   AND inao000 = '1' "               
   PREPARE asft310_inao_pre FROM l_sql
   DECLARE asft310_inao_ins CURSOR FOR asft310_inao_pre  
   
   LET r_success = TRUE
   #161109-00085#29-s
   #FOREACH asft310_inao_ins INTO l_inao.*
   #161109-00085#62 --s mark
   #FOREACH asft310_inao_ins 
   #   INTO l_inao.inaoent,l_inao.inaosite,l_inao.inaodocno,l_inao.inaoseq,l_inao.inaoseq1,
   #        l_inao.inaoseq2,l_inao.inao000,l_inao.inao001,l_inao.inao002,l_inao.inao003,
   #        l_inao.inao004,l_inao.inao005,l_inao.inao006,l_inao.inao007,l_inao.inao008,
   #        l_inao.inao009,l_inao.inao010,l_inao.inao011,l_inao.inao012,l_inao.inao013,
   #        l_inao.inao014,l_inao.inao020,l_inao.inao021,l_inao.inao022,l_inao.inao023,
   #        l_inao.inao024,l_inao.inao025
   #161109-00085#62 --e mark
   #161109-00085#62 --s add
   FOREACH asft310_inao_ins 
      INTO l_inao.inaoent,l_inao.inaosite,l_inao.inaodocno,l_inao.inaoseq,l_inao.inaoseq1,
           l_inao.inaoseq2,l_inao.inao000,l_inao.inao001,l_inao.inao002,l_inao.inao003,
           l_inao.inao004,l_inao.inao005,l_inao.inao006,l_inao.inao007,l_inao.inao008,
           l_inao.inao009,l_inao.inao010,l_inao.inao011,l_inao.inao012,l_inao.inao013,
           l_inao.inaoud001,l_inao.inaoud002,l_inao.inaoud003,l_inao.inaoud004,l_inao.inaoud005,
           l_inao.inaoud006,l_inao.inaoud007,l_inao.inaoud008,l_inao.inaoud009,l_inao.inaoud010,
           l_inao.inaoud011,l_inao.inaoud012,l_inao.inaoud013,l_inao.inaoud014,l_inao.inaoud015,
           l_inao.inaoud016,l_inao.inaoud017,l_inao.inaoud018,l_inao.inaoud019,l_inao.inaoud020,
           l_inao.inaoud021,l_inao.inaoud022,l_inao.inaoud023,l_inao.inaoud024,l_inao.inaoud025,
           l_inao.inaoud026,l_inao.inaoud027,l_inao.inaoud028,l_inao.inaoud029,l_inao.inaoud030,
           l_inao.inao014,l_inao.inao020,l_inao.inao021,l_inao.inao022,l_inao.inao023,
           l_inao.inao024,l_inao.inao025
   #161109-00085#62 --e add
   #161109-00085#29-e
      LET l_inao.inao000 = '2'
      LET l_inao.inaoseq1 = 1
      #161109-00085#62 --s mark
      #161109-00085#29-s
      #INSERT INTO inao_t (inaoent,inaosite,inaodocno,inaoseq,inaoseq1,inaoseq2,inao000,inao001,inao002,inao003,
      #                    inao004,inao005,inao006,inao007,inao008,inao009,inao010,inao011,inao012,inao013,
      #                    inao014,inao020,inao021,inao022,inao023,inao024,inao025)
      #            VALUES (l_inao.inaoent,l_inao.inaosite,l_inao.inaodocno,l_inao.inaoseq,l_inao.inaoseq1,
      #                    l_inao.inaoseq2,l_inao.inao000,l_inao.inao001,l_inao.inao002,l_inao.inao003,
      #                    l_inao.inao004,l_inao.inao005,l_inao.inao006,l_inao.inao007,l_inao.inao008,
      #                    l_inao.inao009,l_inao.inao010,l_inao.inao011,l_inao.inao012,l_inao.inao013,
      #                    l_inao.inao014,l_inao.inao020,l_inao.inao021,l_inao.inao022,l_inao.inao023,
      #                    l_inao.inao024,l_inao.inao025)
      #161109-00085#29-e
      #161109-00085#62 --e mark
      #161109-00085#62 --s add
      INSERT INTO inao_t (inaoent,inaosite,inaodocno,inaoseq,inaoseq1,
                          inaoseq2,inao000,inao001,inao002,inao003,
                          inao004,inao005,inao006,inao007,inao008,
                          inao009,inao010,inao011,inao012,inao013,
                          inaoud001,inaoud002,inaoud003,inaoud004,inaoud005,
                          inaoud006,inaoud007,inaoud008,inaoud009,inaoud010,
                          inaoud011,inaoud012,inaoud013,inaoud014,inaoud015,
                          inaoud016,inaoud017,inaoud018,inaoud019,inaoud020,
                          inaoud021,inaoud022,inaoud023,inaoud024,inaoud025,
                          inaoud026,inaoud027,inaoud028,inaoud029,inaoud030,
                          inao014,inao020,inao021,inao022,inao023,
                          inao024,inao025)
                  VALUES (l_inao.inaoent,l_inao.inaosite,l_inao.inaodocno,l_inao.inaoseq,l_inao.inaoseq1,
                          l_inao.inaoseq2,l_inao.inao000,l_inao.inao001,l_inao.inao002,l_inao.inao003,
                          l_inao.inao004,l_inao.inao005,l_inao.inao006,l_inao.inao007,l_inao.inao008,
                          l_inao.inao009,l_inao.inao010,l_inao.inao011,l_inao.inao012,l_inao.inao013,
                          l_inao.inaoud001,l_inao.inaoud002,l_inao.inaoud003,l_inao.inaoud004,l_inao.inaoud005,
                          l_inao.inaoud006,l_inao.inaoud007,l_inao.inaoud008,l_inao.inaoud009,l_inao.inaoud010,
                          l_inao.inaoud011,l_inao.inaoud012,l_inao.inaoud013,l_inao.inaoud014,l_inao.inaoud015,
                          l_inao.inaoud016,l_inao.inaoud017,l_inao.inaoud018,l_inao.inaoud019,l_inao.inaoud020,
                          l_inao.inaoud021,l_inao.inaoud022,l_inao.inaoud023,l_inao.inaoud024,l_inao.inaoud025,
                          l_inao.inaoud026,l_inao.inaoud027,l_inao.inaoud028,l_inao.inaoud029,l_inao.inaoud030,
                          l_inao.inao014,l_inao.inao020,l_inao.inao021,l_inao.inao022,l_inao.inao023,
                          l_inao.inao024,l_inao.inao025)
      #161109-00085#62 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "inao_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         LET r_success = FALSE               
      END IF                          
   END FOREACH
   
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: 倉庫校驗
# Memo...........:
# Usage..........: CALL asft310_sfdc012_chk()
#                  RETURNING TRUE OR FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: 160408-00029 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdc012_chk()
DEFINE r_success    LIKE type_t.num5
DEFINE l_sfaa005    LIKE sfaa_t.sfaa005  #add by lixh 20150529
DEFINE l_sfaa010    LIKE sfaa_t.sfaa010  #add by lixh 20150529
DEFINE l_inaa010    LIKE inaa_t.inaa010  #成本库否
DEFINE l_inaa015    LIKE inaa_t.inaa015  #保税仓否
#add 150107
DEFINE l_sfba019    LIKE sfba_t.sfba019  #指定库位
DEFINE l_sfba020    LIKE sfba_t.sfba020  #指定储位
DEFINE l_sfba029    LIKE sfba_t.sfba029  #指定批号
DEFINE l_sfba030    LIKE sfba_t.sfba030  #指定库存管理特征
#add 150107 end
DEFINE l_where      STRING
DEFINE l_imaf034    LIKE imaf_t.imaf034  #生产料号是否保税料
DEFINE l_flag       LIKE type_t.num5

   LET r_success = TRUE
   
   #仓库
   #不可输入的栏位不做检查，以防死循环（工單指定的時候庫存不一定有了，可能是還在在製的東西，等庫存有了就能發了）
   IF g_sfdc012_switch = 'N' THEN
      RETURN r_success
   END IF
   
   #add by lixh 20150529
   #檢查倉庫是否未非成本倉
   LET l_sfaa005 = ''
   LET l_sfaa010 = ''
   SELECT sfaa005,sfaa010 INTO l_sfaa005,l_sfaa010
     FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaadocno = g_sfdc_d[l_ac].sfdc001
   IF l_sfaa005 = '5' AND l_sfaa010 = g_sfdc_d[l_ac].sfdc004 THEN
      LET l_inaa010 = ''
      SELECT inaa010 INTO l_inaa010
        FROM inaa_t
       WHERE inaaent = g_enterprise
         AND inaasite = g_site
         AND inaa001 = g_sfdc_d[l_ac].sfdc012
      IF l_inaa010 <> 'N' THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'arm-00011'
         LET g_errparam.extend = g_sfdc_d[l_ac].sfdc012
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF                     
   END IF
   #add by lixh 20150529
   
   #校验带值说明，保税否，成本仓否
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_sfdc_d[l_ac].sfdc012
   #160318-00025#22  by 07900 --add-str
   LET g_errshow = TRUE #是否開窗                   
   LET g_chkparam.err_str[1] ="aim-00065:sub-01302|aini001|",cl_get_progname("aini001",g_lang,"2"),"|:EXEPROGaini001"
   #160318-00025#22  by 07900 --add-end
   IF cl_chk_exist_and_ref_val("v_inaa002_2") THEN
      #檢查成功時後續處理
      LET g_sfdc_d[l_ac].sfdc012_desc = g_chkparam.return1
      LET l_inaa015 = g_chkparam.return2
      LET l_inaa010 = g_chkparam.return3
      IF cl_null(l_inaa015) THEN LET l_inaa015='N' END IF
      IF cl_null(l_inaa010) THEN LET l_inaa010='N' END IF
   ELSE
      #檢查失敗時後續處理
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #160128-00004#1-add-(S)
   #庫位檢查 
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_sfdc_d[l_ac].sfdc004
   IF cl_null(g_sfdc_d[l_ac].sfdc005) THEN
      LET g_chkparam.arg2 = ' '
   ELSE
      LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfdc005
   END IF
   LET g_chkparam.arg3 = g_sfdc_d[l_ac].sfdc012
   #已有指定不可输入
   LET g_chkparam.where = "1=1 "
   LET l_sfba019=''
   LET l_sfba020=''
   LET l_sfba029=''
   LET l_sfba030=''
   SELECT sfba019,sfba020,sfba029,sfba030
     INTO l_sfba019,l_sfba020,l_sfba029,l_sfba030
     FROM sfba_t
    WHERE sfbaent  = g_enterprise
      AND sfbadocno= g_sfdc_d[l_ac].sfdc001
      AND sfbaseq  = g_sfdc_d[l_ac].sfdc002
      AND sfbaseq1 = g_sfdc_d[l_ac].sfdc003
   IF g_sfdc013_switch = 'N' THEN
      IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN
         IF NOT cl_null(l_sfba020) THEN
            LET g_chkparam.where = g_chkparam.where ," AND inag005 = '",l_sfba020,"' "
         ELSE
            LET g_chkparam.where = g_chkparam.where ," AND inag005 = ' ' "
         END IF
         #mod 150107 end
      ELSE
         LET g_chkparam.where = g_chkparam.where ," AND inag005 = '",g_sfdc_d[l_ac].sfdc013,"' "
      END IF
   END IF
   IF g_sfdc014_switch = 'N' THEN
      IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN
         IF NOT cl_null(l_sfba029) THEN
            LET g_chkparam.where = g_chkparam.where ," AND inag006 = '",l_sfba029,"' "
         ELSE
            LET g_chkparam.where = g_chkparam.where ," AND inag006 = ' ' "
         END IF
      ELSE
         LET g_chkparam.where = g_chkparam.where ," AND inag006 = '",g_sfdc_d[l_ac].sfdc014,"' "
      END IF
   END IF
   IF g_sfdc016_switch = 'N' THEN
      IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN
         IF NOT cl_null(l_sfba030) THEN
            LET g_chkparam.where = g_chkparam.where ," AND inag003 = '",l_sfba030,"' "
         ELSE
            LET g_chkparam.where = g_chkparam.where ," AND inag003 = ' ' "
         END IF
      ELSE
         LET g_chkparam.where = g_chkparam.where ," AND inag003 = '",g_sfdc_d[l_ac].sfdc016,"' "
      END IF
   END IF
   #控制組
   CALL s_control_get_doc_sql("inag004",g_sfda_m.sfdadocno,'6')
        RETURNING l_success,l_where
   IF l_success THEN
      LET g_chkparam.where = g_chkparam.where ," AND ",l_where
   END IF
   #sfdc012開窗有依「g_sfda.sfda002[1,1]='1'」判斷要開哪個窗，其差別在於這個條件→「inag008 > 0」
   IF g_sfda_m.sfda002[1,1]='1' THEN #發料單 庫存>0
      LET g_chkparam.where = g_chkparam.where," AND inag008 > 0"
   END IF
#160804-00045#1 mark-------s-------
#   IF NOT cl_chk_exist("v_inag004_6") THEN
#      #檢查失敗時後續處理
#      LET r_success = FALSE
#      RETURN r_success
#   END IF
#160804-00045#1 mark-------e-------
   #160128-00004#1-add-(E)
   
   #檢核輸入的庫位是否在單據別限制範圍內，若不在限制內則不允許使用此庫位
   CALL s_control_chk_doc('6',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc012,'','','','')
        RETURNING l_success,l_flag
   IF NOT l_success OR NOT l_flag THEN
      #控制组检查错误,请检查单别设定的相关内容
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00122'
      LET g_errparam.extend = g_sfdc_d[l_ac].sfdc012
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
#   #如果储位已有，检查储位
#   IF NOT cl_null(g_sfdc_d[l_ac].sfdc013) THEN
#      #校验带值说明
#      CALL asft310_chk_loca(g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013)
#         RETURNING l_success,g_sfdc_d[l_ac].sfdc013_desc
#      IF NOT l_success THEN
#         LET r_success = FALSE
#         RETURN r_success
#      END IF
#   END IF
   
   #参数：生產非保稅料號，可由保稅倉發料
   CALL s_aooi200_get_slip(g_sfda_m.sfdadocno) RETURNING l_success,g_ooba002
   CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0031') RETURNING g_para
   #生产料号保税否
   LET l_imaf034 = ''
   SELECT imaf034 INTO l_imaf034
     FROM imaf_t,sfaa_t
    WHERE imafent  = sfaaent
      AND imafsite = g_site
      AND imaf001  = sfaa010
      AND sfaaent  = g_enterprise
      AND sfaadocno= g_sfdc_d[l_ac].sfdc001
   IF cl_null(l_imaf034) THEN LET l_imaf034 = 'N' END IF
   #當工單的生產料號=非保稅料，不可由保稅倉發料。
   IF l_imaf034='N' AND l_inaa015='Y' AND g_para MATCHES '[12]' THEN #拒绝或警告
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asr-00008'
      LET g_errparam.extend = g_sfdc_d[l_ac].sfdc012
      LET g_errparam.popup = TRUE
      CALL cl_err()
      IF g_para = '1' THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #參數：客供料可由成本倉料領料
   CALL cl_get_doc_para(g_enterprise,g_site,g_ooba002,'D-MFG-0052') RETURNING g_para
   #1.拒絕時，只可輸入非成本倉。(2為警告)
   IF g_sfdc_d[l_ac].sfba028='Y' AND l_inaa010='Y' AND g_para MATCHES '[12]' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00048'
      LET g_errparam.extend = g_sfdc_d[l_ac].sfdc012
      LET g_errparam.popup = TRUE
      CALL cl_err()
      IF g_para = '1' THEN  #拒绝
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF
   
   #发料单做在捡量的检查
   IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdc_d[l_ac].sfdc007) AND NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN  #在捡数量 库位
      IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN LET g_sfdc_d[l_ac].sfdc016= ' ' END IF  #库存管理特征
      IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN LET g_sfdc_d[l_ac].sfdc013= ' ' END IF  #储位
      IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN LET g_sfdc_d[l_ac].sfdc014= ' ' END IF  #批号
      #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
      #                           据点   料件编号                产品特征                库存管理特征
      CALL s_inventory_check_inan(g_site,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc016,
      #                           库位                   储位                    批号
                                  g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
      #                           交易单位                在捡数量
                                  g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
      #                           单据编号            项次                   项序
                                  g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',
      #                           工單單號                 工單項次 
                                  g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
           RETURNING l_success,l_flag
      IF NOT l_flag THEN
         LET r_success = FALSE
         RETURN r_success
      END IF
   END IF

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 欄位必輸
# Memo...........:
# Usage..........: CALL asft310_set_required_sfdd(p_cmd)
# Input parameter: p_cm   行數
# Return code....: 
# Date & Author..: 2016/05/30 By dorislai(160126-00022#1)
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_set_required_sfdd(p_cmd)
   DEFINE p_cmd  LIKE type_t.num5
   DEFINE  l_imaf055  LIKE imaf_t.imaf055
   DEFINE  l_imaf061  LIKE imaf_t.imaf061
    #庫存管理特微
   CALL s_axmt540_get_imaf(g_sfdd_d[l_ac].sfdd001) RETURNING l_imaf055,l_imaf061
   #---是"必須有庫存管理特徵"
   IF l_imaf055 = '1' THEN
      CALL cl_set_comp_required("sfdd010",TRUE)   
   END IF
   #160519-00022#18-s-add
   IF l_imaf061 = '1' THEN
      CALL cl_set_comp_required("sfdd005",TRUE)   
   END IF   
   #160519-00022#18-e-add   
END FUNCTION

################################################################################
# Descriptions...: 關閉欄位必輸
# Memo...........:
# Usage..........: CALL asft310_set_no_required_sfdd(p_cmd)
# Input parameter: p_cm   行數
# Return code....: 
# Date & Author..: 2016/05/30 By dorislai(160126-00022#1)
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_set_no_required_sfdd(p_cmd)
   DEFINE p_cmd  LIKE type_t.num5
   
   CALL cl_set_comp_required("sfdd010",FALSE)   
   CALL cl_set_comp_required("sfdd005",FALSE)   #160519-00022#18 add
   
END FUNCTION

################################################################################
# Descriptions...: 
# Memo...........:
# Usage..........: CALL asft310_del_sfdc(p_sfdc)
#                  RETURNING TRUE OR FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: 160728-00032 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_del_sfdc(p_sfdc)
#DEFINE p_sfdc          RECORD LIKE sfdc_t.* #161109-00085#62 mark
#161109-00085#62 --s add
DEFINE p_sfdc RECORD  #發退料需求檔
       sfdcent LIKE sfdc_t.sfdcent, #企業編號
       sfdcsite LIKE sfdc_t.sfdcsite, #營運據點
       sfdcdocno LIKE sfdc_t.sfdcdocno, #發退料單號
       sfdcseq LIKE sfdc_t.sfdcseq, #項次
       sfdc001 LIKE sfdc_t.sfdc001, #工單單號
       sfdc002 LIKE sfdc_t.sfdc002, #工單項次
       sfdc003 LIKE sfdc_t.sfdc003, #工單項序
       sfdc004 LIKE sfdc_t.sfdc004, #需求料號
       sfdc005 LIKE sfdc_t.sfdc005, #產品特徵
       sfdc006 LIKE sfdc_t.sfdc006, #單位
       sfdc007 LIKE sfdc_t.sfdc007, #申請數量
       sfdc008 LIKE sfdc_t.sfdc008, #實際數量
       sfdc009 LIKE sfdc_t.sfdc009, #參考單位
       sfdc010 LIKE sfdc_t.sfdc010, #參考單位需求數量
       sfdc011 LIKE sfdc_t.sfdc011, #參考單位實際數量
       sfdc012 LIKE sfdc_t.sfdc012, #指定庫位
       sfdc013 LIKE sfdc_t.sfdc013, #指定儲位
       sfdc014 LIKE sfdc_t.sfdc014, #指定批號
       sfdc015 LIKE sfdc_t.sfdc015, #理由碼
       sfdc016 LIKE sfdc_t.sfdc016, #庫存管理特徴
       sfdc017 LIKE sfdc_t.sfdc017, #正負
       sfdcud001 LIKE sfdc_t.sfdcud001, #自定義欄位(文字)001
       sfdcud002 LIKE sfdc_t.sfdcud002, #自定義欄位(文字)002
       sfdcud003 LIKE sfdc_t.sfdcud003, #自定義欄位(文字)003
       sfdcud004 LIKE sfdc_t.sfdcud004, #自定義欄位(文字)004
       sfdcud005 LIKE sfdc_t.sfdcud005, #自定義欄位(文字)005
       sfdcud006 LIKE sfdc_t.sfdcud006, #自定義欄位(文字)006
       sfdcud007 LIKE sfdc_t.sfdcud007, #自定義欄位(文字)007
       sfdcud008 LIKE sfdc_t.sfdcud008, #自定義欄位(文字)008
       sfdcud009 LIKE sfdc_t.sfdcud009, #自定義欄位(文字)009
       sfdcud010 LIKE sfdc_t.sfdcud010, #自定義欄位(文字)010
       sfdcud011 LIKE sfdc_t.sfdcud011, #自定義欄位(數字)011
       sfdcud012 LIKE sfdc_t.sfdcud012, #自定義欄位(數字)012
       sfdcud013 LIKE sfdc_t.sfdcud013, #自定義欄位(數字)013
       sfdcud014 LIKE sfdc_t.sfdcud014, #自定義欄位(數字)014
       sfdcud015 LIKE sfdc_t.sfdcud015, #自定義欄位(數字)015
       sfdcud016 LIKE sfdc_t.sfdcud016, #自定義欄位(數字)016
       sfdcud017 LIKE sfdc_t.sfdcud017, #自定義欄位(數字)017
       sfdcud018 LIKE sfdc_t.sfdcud018, #自定義欄位(數字)018
       sfdcud019 LIKE sfdc_t.sfdcud019, #自定義欄位(數字)019
       sfdcud020 LIKE sfdc_t.sfdcud020, #自定義欄位(數字)020
       sfdcud021 LIKE sfdc_t.sfdcud021, #自定義欄位(日期時間)021
       sfdcud022 LIKE sfdc_t.sfdcud022, #自定義欄位(日期時間)022
       sfdcud023 LIKE sfdc_t.sfdcud023, #自定義欄位(日期時間)023
       sfdcud024 LIKE sfdc_t.sfdcud024, #自定義欄位(日期時間)024
       sfdcud025 LIKE sfdc_t.sfdcud025, #自定義欄位(日期時間)025
       sfdcud026 LIKE sfdc_t.sfdcud026, #自定義欄位(日期時間)026
       sfdcud027 LIKE sfdc_t.sfdcud027, #自定義欄位(日期時間)027
       sfdcud028 LIKE sfdc_t.sfdcud028, #自定義欄位(日期時間)028
       sfdcud029 LIKE sfdc_t.sfdcud029, #自定義欄位(日期時間)029
       sfdcud030 LIKE sfdc_t.sfdcud030  #自定義欄位(日期時間)030
END RECORD
#161109-00085#62 --e add

   DELETE FROM sfdc_t
    WHERE sfdcent  = g_enterprise
      AND sfdcdocno= p_sfdc.sfdcdocno
      AND sfdcseq  = p_sfdc.sfdcseq
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE sfdc_t:",SQLERRMESSAGE
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF

   #sfdd
   IF NOT s_asft310_chg_sfdd_f_sfdc_del(p_sfdc.sfdcdocno,p_sfdc.sfdcseq) THEN  #其中有处理inao
      RETURN FALSE
   END IF

   #sfde,sfdf
   IF NOT s_asft310_chg_sfde_f_sfdc_del(p_sfdc.*) THEN
      RETURN FALSE
   END IF

   #add 141222
   DELETE FROM ooff_t
    WHERE ooffent = g_enterprise
      AND ooff001 = '7'
      AND ooff002 = p_sfdc.sfdcdocno
      AND ooff003 = p_sfdc.sfdcseq
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE ooff_t:",SQLERRMESSAGE
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF
   #add 141222 end

   #add 150831 begin 删除sfdc、sfdd的inao资料
   DELETE FROM inao_t
    WHERE inaoent  = g_enterprise
      AND inaosite = g_site
      AND inaodocno= p_sfdc.sfdcdocno
      AND inaoseq  = p_sfdc.sfdcseq
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "DELETE inao_t:",SQLERRMESSAGE
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF
   #add 150831 end

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: + 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
# Memo...........:
# Usage..........: CALL asft310_action_chk()
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By lixh
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_action_chk()
   #160818-00017#36-s
   SELECT sfdastus INTO g_sfda_m.sfdastus FROM sfda_t
    WHERE sfdaent = g_enterprise
      AND sfdasite = g_site
      AND sfdadocno = g_sfda_m.sfdadocno
   IF (g_action_choice="modify" OR g_action_choice="delete" OR g_action_choice="modify_detail")  THEN
     LET g_errno = NULL
     CASE g_sfda_m.sfdastus
        WHEN 'W'
           LET g_errno = 'sub-01347'
        WHEN 'X'
           LET g_errno = 'sub-00229'
        WHEN 'Y'
           LET g_errno = 'sub-00178'
        WHEN 'S'
           LET g_errno = 'sub-00230'


     END CASE

     IF NOT cl_null(g_errno) THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = g_errno
        LET g_errparam.extend = g_sfda_m.sfdadocno
        LET g_errparam.popup = TRUE
        CALL cl_err()
        LET g_errno = NULL
        CALL asft310_set_act_visible()
        CALL asft310_set_act_no_visible()
        CALL asft310_show()
        RETURN FALSE
     END IF     
   END IF   
   RETURN TRUE   
   #160818-00017#36-e
END FUNCTION

################################################################################
# Descriptions...: 部门说明
# Memo...........:
# Usage..........: CALL asft310_sfda003_ref(p_sfda003)
#                  RETURNING r_sfda003_desc
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfda003_ref(p_sfda003)
DEFINE p_sfda003       LIKE sfda_t.sfda003
DEFINE r_sfda003_desc  LIKE type_t.chr80

   IF g_sfda_m.sfda002 = '15' OR g_sfda_m.sfda002 = '25' THEN  #製程中委外時，顯示名稱為委外廠商
      #帶值:廠商名稱
      CALL s_desc_get_trading_partner_abbr_desc(p_sfda003) RETURNING r_sfda003_desc
   ELSE
      #帶值:部门名稱
      CALL s_desc_get_department_desc(p_sfda003) RETURNING r_sfda003_desc
   END IF

   RETURN r_sfda003_desc
END FUNCTION

################################################################################
# Descriptions...: 部位检查
# Memo...........:
# Usage..........: CALL asft310_sfdb003_chk()
#                  RETURNING TRUE/FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdb003_chk()
DEFINE l_n          LIKE type_t.num5

   IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN
   　 #检查是否存在工单单身的部位
      LET l_n = 0
      SELECT COUNT(1) INTO l_n
        FROM sfba_t
       WHERE sfbaent = g_enterprise
         AND sfbasite= g_site
         AND sfbadocno=g_sfdb_d[l_ac].sfdb001  #工单单号
         AND sfba002 = g_sfdb_d[l_ac].sfdb003  #部位
      IF l_n = 0 THEN
         #該部位%1不存在於工單%2備料單身檔中！
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00799'
         LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb003
         LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF
      
      #检查+作业编号是否存在工单单身
      IF NOT cl_null(g_sfdb_d[l_ac].sfdb004) THEN
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM sfba_t
          WHERE sfbaent = g_enterprise
            AND sfbasite= g_site
            AND sfbadocno=g_sfdb_d[l_ac].sfdb001  #工单单号
            AND sfba002 = g_sfdb_d[l_ac].sfdb003  #部位
            AND sfba003 = g_sfdb_d[l_ac].sfdb004  #作业编号
         IF l_n = 0 THEN
            #該部位%1且作業%2作业序%3不存在於工單%4備料單身檔中！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00059'
            LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb003
            LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb004
            LET g_errparam.replace[3] = ''
            LET g_errparam.replace[4] = g_sfdb_d[l_ac].sfdb001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 作业检查
# Memo...........:
# Usage..........: CALL asft310_sfdb004_chk()
#                  RETURNING TRUE/FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdb004_chk()
DEFINE l_n          LIKE type_t.num5

   IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN
      #作业+作业序需存在工单制程档中(sfcb003+sfcb004)，且为可委外(sfcb012=Y)
      IF g_sfda_m.sfda002='15' OR g_sfda_m.sfda002='25' THEN
         IF NOT cl_null(g_sfdb_d[l_ac].sfdb002) THEN
            LET l_n = 0
            SELECT COUNT(1) INTO l_n
              FROM sfcb_t
             WHERE sfcbent = g_enterprise
               AND sfcbsite= g_site
               AND sfcbdocno=g_sfdb_d[l_ac].sfdb001  #工单单号
               AND sfcb001 = g_sfdb_d[l_ac].sfdb002  #run card
               AND sfcb003 = g_sfdb_d[l_ac].sfdb004  #作业
               AND sfcb012 = 'Y'                     #委外
            IF l_n = 0 THEN
               #工單%1+runcard%2+作業%3+作業序%4不存在於工單製程單身檔中！
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00040'
               LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb001
               LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb002
               LET g_errparam.replace[3] = g_sfdb_d[l_ac].sfdb004
               LET g_errparam.replace[4] = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN FALSE
            END IF
         END IF
      END IF
      #检查是否存在工单单身
      #IF g_sfda_m.sfda002 != '15'THEN    #170102-00013#1 06694 add  #170206-00019#1
      IF g_sfda_m.sfda002 != '15' AND g_sfda_m.sfda002 != '25' THEN  #170206-00019#1
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM sfba_t
          WHERE sfbaent = g_enterprise
            AND sfbasite= g_site
            AND sfbadocno=g_sfdb_d[l_ac].sfdb001  #工单单号
            AND sfba003 = g_sfdb_d[l_ac].sfdb004  #作业
         IF l_n = 0 THEN
            #作業%1且作業序%2不存在於工單%3的備料單身檔中！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00039'
            LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb004
            LET g_errparam.replace[2] = ''
            LET g_errparam.replace[3] = g_sfdb_d[l_ac].sfdb001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF #170102-00013#1 06694 add
      IF NOT cl_null(g_sfdb_d[l_ac].sfdb003) THEN
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM sfba_t
          WHERE sfbaent = g_enterprise
            AND sfbasite= g_site
            AND sfbadocno=g_sfdb_d[l_ac].sfdb001  #工单单号
            AND sfba002 = g_sfdb_d[l_ac].sfdb003  #部位
            AND sfba003 = g_sfdb_d[l_ac].sfdb004  #作业编号
         IF l_n = 0 THEN
            #該部位%1且作業%2作业序%3不存在於工單%4備料單身檔中！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00059'
            LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb003
            LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb004
            LET g_errparam.replace[3] = ''
            LET g_errparam.replace[4] = g_sfdb_d[l_ac].sfdb001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF
   END IF
   IF NOT cl_null(g_sfdb_d[l_ac].sfdb005) THEN
      IF NOT asft310_sfdb005_chk() THEN
         RETURN FALSE
      END IF
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 作业序检查
# Memo...........:
# Usage..........: CALL asft310_sfdb005_chk()
#                  RETURNING TRUE/FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdb005_chk()
DEFINE l_n          LIKE type_t.num5

   IF NOT cl_null(g_sfdb_d[l_ac].sfdb001) THEN
      #作业+作业序需存在工单制程档中(sfcb003+sfcb004)，且为可委外(sfcb012=Y)
      IF g_sfda_m.sfda002='15' OR g_sfda_m.sfda002='25' THEN
         IF NOT cl_null(g_sfdb_d[l_ac].sfdb002) THEN
            LET l_n = 0
            SELECT COUNT(1) INTO l_n
              FROM sfcb_t
             WHERE sfcbent = g_enterprise
               AND sfcbsite= g_site
               AND sfcbdocno=g_sfdb_d[l_ac].sfdb001  #工单单号
               AND sfcb001 = g_sfdb_d[l_ac].sfdb002  #run card
               AND sfcb003 = g_sfdb_d[l_ac].sfdb004  #作业
               AND sfcb004 = g_sfdb_d[l_ac].sfdb005  #作业序
               AND sfcb012 = 'Y'                     #委外
            IF l_n = 0 THEN
               #工單%1+runcard%2+作業%3+作業序%4不存在於工單製程單身檔中！
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00040'
               LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb001
               LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb002
               LET g_errparam.replace[3] = g_sfdb_d[l_ac].sfdb004
               LET g_errparam.replace[4] = g_sfdb_d[l_ac].sfdb005
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN FALSE
            END IF
         END IF
      END IF
      #检查是否存在工单单身
      #IF g_sfda_m.sfda002 != '15'THEN #170102-00013#1 06694 add  #170206-00019#1
      IF g_sfda_m.sfda002 != '15' AND g_sfda_m.sfda002 != '25' THEN  #170206-00019#1
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM sfba_t
          WHERE sfbaent = g_enterprise
            AND sfbasite= g_site
            AND sfbadocno=g_sfdb_d[l_ac].sfdb001  #工单单号
            AND sfba003 = g_sfdb_d[l_ac].sfdb004  #作业
            AND sfba004 = g_sfdb_d[l_ac].sfdb005  #作业序
         IF l_n = 0 THEN
            #作業%1且作業序%2不存在於工單%3的備料單身檔中！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00039'
            LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb004
            LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb005
            LET g_errparam.replace[3] = g_sfdb_d[l_ac].sfdb001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF #170102-00013#1 06694 add
      IF NOT cl_null(g_sfdb_d[l_ac].sfdb003) THEN
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM sfba_t
          WHERE sfbaent = g_enterprise
            AND sfbasite= g_site
            AND sfbadocno=g_sfdb_d[l_ac].sfdb001  #工单单号
            AND sfba002 = g_sfdb_d[l_ac].sfdb003  #部位
            AND sfba003 = g_sfdb_d[l_ac].sfdb004  #作业编号
            AND sfba004 = g_sfdb_d[l_ac].sfdb005  #作业序
         IF l_n = 0 THEN
            #該部位%1且作業%2作业序%3不存在於工單%4備料單身檔中！
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00059'
            LET g_errparam.replace[1] = g_sfdb_d[l_ac].sfdb003
            LET g_errparam.replace[2] = g_sfdb_d[l_ac].sfdb004
            LET g_errparam.replace[3] = g_sfdb_d[l_ac].sfdb005
            LET g_errparam.replace[4] = g_sfdb_d[l_ac].sfdb001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 储位检查
# Memo...........:
# Usage..........: CALL asft310_sfdc013_chk()
#                  RETURNING TRUE/FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdc013_chk()
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5

   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_site
   LET g_chkparam.arg2 = g_sfdc_d[l_ac].sfdc012
   LET g_chkparam.arg3 = g_sfdc_d[l_ac].sfdc013
   LET g_errshow = TRUE
   LET g_chkparam.err_str[1] = "aim-00063:sub-01302|aini002|",cl_get_progname("aini002",g_lang,"2"),"|:EXEPROGaini002"
   IF NOT cl_chk_exist("v_inab002") THEN
      RETURN FALSE
   END IF
   
   #檢核輸入的庫位是否在單據別限制範圍內，若不在限制內則不允許使用此庫位
   CALL s_control_chk_doc('6',g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,'','','')
      RETURNING l_success,l_flag
   IF NOT l_success OR NOT l_flag THEN
      RETURN FALSE
   END IF
               
   #发料单做在捡量的检查
   IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdc_d[l_ac].sfdc007) AND NOT cl_null(g_sfdc_d[l_ac].sfdc012) THEN  #在捡数量 库位
      IF cl_null(g_sfdc_d[l_ac].sfdc016) THEN LET g_sfdc_d[l_ac].sfdc016= ' ' END IF  #库存管理特征
      IF cl_null(g_sfdc_d[l_ac].sfdc013) THEN LET g_sfdc_d[l_ac].sfdc013= ' ' END IF  #储位
      IF cl_null(g_sfdc_d[l_ac].sfdc014) THEN LET g_sfdc_d[l_ac].sfdc014= ' ' END IF  #批号
      #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
      #                           据点   料件编号                产品特征                库存管理特征
      CALL s_inventory_check_inan(g_site,g_sfdc_d[l_ac].sfdc004,g_sfdc_d[l_ac].sfdc005,g_sfdc_d[l_ac].sfdc016,
      #                           库位                   储位                    批号
                                  g_sfdc_d[l_ac].sfdc012,g_sfdc_d[l_ac].sfdc013,g_sfdc_d[l_ac].sfdc014,
      #                           交易单位                在捡数量
                                  g_sfdc_d[l_ac].sfdc006,g_sfdc_d[l_ac].sfdc007,
      #                           单据编号            项次                   项序
                                  g_sfda_m.sfdadocno,g_sfdc_d[l_ac].sfdcseq,'0',
      #                           工單單號                 工單項次 
                                  g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
           RETURNING l_success,l_flag
      IF NOT l_flag THEN
         RETURN FALSE
      END IF
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 库储檢查
# Memo...........:
# Usage..........: CALL asft310_sfdf_loca_chk(p_column)
#                  RETURNING r_success
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdf_loca_chk(p_column)
DEFINE p_column     LIKE type_t.chr10  #检查类型
DEFINE r_success    LIKE type_t.num5
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5
DEFINE l_inaa007    LIKE inaa_t.inaa007   #161205-00031#1 add

   LET r_success = TRUE

   IF cl_null(g_sfdf_d[l_ac].sfdf010) THEN LET g_sfdf_d[l_ac].sfdf010= ' ' END IF  #库存管理特征
   IF cl_null(g_sfdf_d[l_ac].sfdf004) THEN LET g_sfdf_d[l_ac].sfdf004= ' ' END IF  #储位
   IF cl_null(g_sfdf_d[l_ac].sfdf005) THEN LET g_sfdf_d[l_ac].sfdf005= ' ' END IF  #批号

   #发料单做在捡量的检查
   IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdf_d[l_ac].sfdf007) AND NOT cl_null(g_sfdf_d[l_ac].sfdf003) THEN  #在捡数量 库位
      #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
      #                           据点   料件编号                产品特征                库存管理特征
      CALL s_inventory_check_inan(g_site,g_sfdf_d[l_ac].sfdf001,g_sfdf_d[l_ac].sfdf013,g_sfdf_d[l_ac].sfdf010,
      #                           库位                   储位                    批号
                                  g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004,g_sfdf_d[l_ac].sfdf005,
      #                           交易单位                在捡数量
                                  g_sfdf_d[l_ac].sfdf006,g_sfdf_d[l_ac].sfdf007,
      #                           单据编号            项次                           项序
                                  g_sfda_m.sfdadocno,g_sfde_d[g_detail_idx].sfdeseq,g_sfdf_d[l_ac].sfdfseq1,
      #                           工單單號                 工單項次 
                                  g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9-add
           RETURNING l_success,l_flag
      IF NOT l_flag THEN
         LET r_success = FALSE
      END IF
   END IF

   #相同项目重复性检查
   IF NOT asft310_chk_sfdf_unique() THEN
      LET r_success = FALSE
   END IF
   
   #检查库位、储位、批号的范围，是否在需求指定发料库位、储位、批号允许的数量内
   IF NOT asft310_chk_ware_range(p_column) THEN
      LET r_success = FALSE
   END IF
   
   IF (p_column = 'sfdf003' OR p_column = 'sfdf004') AND NOT cl_null(g_sfdf_d[l_ac].sfdf003) THEN
#161205-00031#1-s add
      #單身倉庫不做儲位管理，輸入庫位後不應提示儲位不存在
      LET l_inaa007 = ''
      SELECT inaa007 INTO l_inaa007
        FROM inaa_t
       WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_sfdf_d[l_ac].sfdf003
      IF l_inaa007 MATCHES '[12]' THEN
#161205-00031#1-e add   
         INITIALIZE g_chkparam.* TO NULL
         LET g_chkparam.arg1 = g_site
         LET g_chkparam.arg2 = g_sfdf_d[l_ac].sfdf003
         LET g_chkparam.arg3 = g_sfdf_d[l_ac].sfdf004
         LET g_errshow = TRUE
         LET g_chkparam.err_str[1] = "aim-00063:sub-01302|aini002|",cl_get_progname("aini002",g_lang,"2"),"|:EXEPROGaini002"
         IF NOT cl_chk_exist("v_inab002") THEN
            LET r_success = FALSE
         END IF
      END IF   #161205-00031#1 add
      
      #檢核輸入的庫位是否在單據別限制範圍內，若不在限制內則不允許使用此庫位
      CALL s_control_chk_doc('6',g_sfda_m.sfdadocno,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004,'','','')
         RETURNING l_success,l_flag
      IF NOT l_success OR NOT l_flag THEN
         LET r_success = FALSE
      END IF
   END IF

   IF NOT r_success THEN
      LET g_sfdf_d[l_ac].sfdf003 = g_sfdf_d_o.sfdf003
      LET g_sfdf_d[l_ac].sfdf004 = g_sfdf_d_o.sfdf004
      LET g_sfdf_d[l_ac].sfdf005 = g_sfdf_d_o.sfdf005
      LET g_sfdf_d[l_ac].sfdf010 = g_sfdf_d_o.sfdf010
      LET g_sfdf_d[l_ac].sfdf003_desc = s_desc_get_stock_desc(g_site,g_sfdf_d[l_ac].sfdf003)
      LET g_sfdf_d[l_ac].sfdf004_desc = s_desc_get_locator_desc(g_site,g_sfdf_d[l_ac].sfdf003,g_sfdf_d[l_ac].sfdf004)
   END IF

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 库储檢查
# Memo...........:
# Usage..........: CALL asft310_sfdd_loca_chk()
#                  RETURNING r_success
# Input parameter: 
# Return code....: 
# Date & Author..: #160914-00019#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft310_sfdd_loca_chk()
DEFINE r_success    LIKE type_t.num5
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5
DEFINE l_inaa007    LIKE inaa_t.inaa007   #161205-00031#1 add

   LET r_success = TRUE
   
   IF cl_null(g_sfdd_d[l_ac].sfdd010) THEN LET g_sfdd_d[l_ac].sfdd010= ' ' END IF  #库存管理特征
   IF cl_null(g_sfdd_d[l_ac].sfdd004) THEN LET g_sfdd_d[l_ac].sfdd004= ' ' END IF  #储位
   IF cl_null(g_sfdd_d[l_ac].sfdd005) THEN LET g_sfdd_d[l_ac].sfdd005= ' ' END IF  #批号
   
   #发料单做在捡量的检查
   IF g_prog[1,6]='asft31' AND NOT cl_null(g_sfdd_d[l_ac].sfdd007) AND NOT cl_null(g_sfdd_d[l_ac].sfdd003) THEN  #在捡数量 库位
      #指定庫位、儲位、批號時，判斷參數是否檢查在檢量，如需檢查在檢量，在庫存數-在檢數不足申請數量時不允許輸入
      #                           据点   料件编号                产品特征                库存管理特征
      CALL s_inventory_check_inan(g_site,g_sfdd_d[l_ac].sfdd001,g_sfdd_d[l_ac].sfdd013,g_sfdd_d[l_ac].sfdd010,
      #                           库位                   储位                    批号
                                  g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004,g_sfdd_d[l_ac].sfdd005,
      #                           交易单位                在捡数量
                                  g_sfdd_d[l_ac].sfdd006,g_sfdd_d[l_ac].sfdd007,
      #                           单据编号            项次                            项序
                                  g_sfda_m.sfdadocno,g_sfdc4_d[g_detail_idx].sfdcseq,g_sfdd_d[l_ac].sfddseq1,
      #                           工單單號                 工單項次 
                                  g_sfdc_d[l_ac].sfdc001,g_sfdc_d[l_ac].sfdc002) #160408-00035#9
           RETURNING l_success,l_flag
      IF NOT l_flag THEN
         LET r_success = FALSE
      END IF
   END IF
   
   
#161205-00031#1-s add
   #單身倉庫不做儲位管理，輸入庫位後不應提示儲位不存在
   LET l_inaa007 = ''
   SELECT inaa007 INTO l_inaa007
     FROM inaa_t
    WHERE inaaent = g_enterprise AND inaasite = g_site AND inaa001 = g_sfdd_d[l_ac].sfdd003
   IF l_inaa007 MATCHES '[12]' THEN
#161205-00031#1-e add
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = g_site
      LET g_chkparam.arg2 = g_sfdd_d[l_ac].sfdd003
      LET g_chkparam.arg3 = g_sfdd_d[l_ac].sfdd004
      LET g_errshow = TRUE
      LET g_chkparam.err_str[1] = "aim-00063:sub-01302|aini002|",cl_get_progname("aini002",g_lang,"2"),"|:EXEPROGaini002"
      IF NOT cl_chk_exist("v_inab002") THEN
         LET r_success = FALSE
      END IF
   END IF   #161205-00031#1 add
   
   #檢核輸入的庫位是否在單據別限制範圍內，若不在限制內則不允許使用此庫位
   CALL s_control_chk_doc('6',g_sfda_m.sfdadocno,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004,'','','')
        RETURNING l_success,l_flag
   IF NOT l_success OR NOT l_flag THEN
      LET r_success = FALSE
   END IF
   
   IF NOT r_success THEN
      LET g_sfdd_d[l_ac].sfdd003 = g_sfdd_d_o.sfdd003
      LET g_sfdd_d[l_ac].sfdd004 = g_sfdd_d_o.sfdd004
      LET g_sfdd_d[l_ac].sfdd005 = g_sfdd_d_o.sfdd005
      LET g_sfdd_d[l_ac].sfdd010 = g_sfdd_d_o.sfdd010
      LET g_sfdd_d[l_ac].sfdd003_desc = s_desc_get_stock_desc(g_site,g_sfdd_d[l_ac].sfdd003)
      LET g_sfdd_d[l_ac].sfdd004_desc = s_desc_get_locator_desc(g_site,g_sfdd_d[l_ac].sfdd003,g_sfdd_d[l_ac].sfdd004)
   END IF
   
   RETURN r_success
END FUNCTION

#end add-point
 
{</section>}
 
