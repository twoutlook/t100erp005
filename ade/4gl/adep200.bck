#該程式未解開Section, 採用最新樣板產出!
{<section id="adep200.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0006(2016-01-29 17:06:23), PR版次:0006(2016-08-02 11:02:52)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000057
#+ Filename...: adep200
#+ Description: 銷售收入收款日結批次處理作業
#+ Creator....: 04226(2015-04-27 11:08:09)
#+ Modifier...: 06137 -SD/PR- 00940
 
{</section>}
 
{<section id="adep200.global" >}
#應用 p01 樣板自動產生(Version:18)
#add-point:填寫註解說明
#Memos
#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_schedule
#add-point:增加匯入項目

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
GLOBALS "../../cfg/top_schedule.inc"
GLOBALS
   DEFINE gwin_curr2  ui.Window
   DEFINE gfrm_curr2  ui.Form
   DEFINE gi_hiden_asign       LIKE type_t.num5
   DEFINE gi_hiden_exec        LIKE type_t.num5
   DEFINE gi_hiden_spec        LIKE type_t.num5
   DEFINE gi_hiden_exec_end    LIKE type_t.num5
   DEFINE g_chk_jobid          LIKE type_t.num5
END GLOBALS
 
PRIVATE TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
       rtjadocdt LIKE rtja_t.rtjadocdt, 
       l_a       LIKE type_t.chr80, 
   #end add-point
        wc               STRING
                     END RECORD
 
DEFINE g_sql             STRING        #組 sql 用
DEFINE g_forupd_sql      STRING        #SELECT ... FOR UPDATE  SQL
DEFINE g_error_show      LIKE type_t.num5
DEFINE g_jobid           STRING
DEFINE g_wc              STRING
 
PRIVATE TYPE type_master RECORD
       rtjasite LIKE rtja_t.rtjasite, 
   rtjadocdt LIKE rtja_t.rtjadocdt, 
   l_a LIKE type_t.chr1, 
   stagenow LIKE type_t.chr80,
       wc               STRING
       END RECORD
 
#模組變數(Module Variables)
DEFINE g_master type_master
 
#add-point:自定義模組變數(Module Variable)

#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)

#end add-point
 
#add-point:傳入參數說明

#end add-point
 
{</section>}
 
{<section id="adep200.main" >}
MAIN
   #add-point:main段define (客製用)
   
   #end add-point 
   DEFINE ls_js    STRING
   DEFINE lc_param type_parameter  
   #add-point:main段define 
   DEFINE l_success LIKE type_t.num5
   #end add-point 
  
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("ade","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   
   #end add-point
 
   #背景(Y) 或半背景(T) 時不做主畫面開窗
   IF g_bgjob = "Y" OR g_bgjob = "T" THEN
      #排程參數由01開始，若不是1開始，表示有保留參數
      LET ls_js = g_argv[01]
     #CALL util.JSON.parse(ls_js,g_master)   #p類主要使用l_param,此處不解析
      #add-point:Service Call
      
      #end add-point
      CALL adep200_process(ls_js)
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_adep200 WITH FORM cl_ap_formpath("ade",g_code)
 
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
 
      #程式初始化
      CALL adep200_init()
 
      #進入選單 Menu (="N")
      CALL adep200_ui_dialog()
 
      #add-point:畫面關閉前
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_adep200
   END IF
 
   #add-point:作業離開前
   CALL s_aooi500_drop_temp() RETURNING l_success
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="adep200.init" >}
#+ 初始化作業
PRIVATE FUNCTION adep200_init()
 
   #add-point:init段define (客製用)
   
   #end add-point
   #add-point:ui_dialog段define 
   DEFINE l_success LIKE type_t.num5
   #end add-point
 
   LET g_error_show = 1
   LET gwin_curr2 = ui.Window.getCurrent()
   LET gfrm_curr2 = gwin_curr2.getForm()
   CALL cl_schedule_import_4fd()
   CALL cl_set_combo_scc("gzpa003","75")
   IF cl_get_para(g_enterprise,"","E-SYS-0005") = "N" THEN
       CALL cl_set_comp_visible("scheduling_page,history_page",FALSE)
   END IF 
   #add-point:畫面資料初始化
   CALL s_aooi500_create_temp() RETURNING l_success
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="adep200.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION adep200_ui_dialog()
 
   #add-point:ui_dialog段define (客製用)
   
   #end add-point
   DEFINE li_exit  LIKE type_t.num5    #判別是否為離開作業
   DEFINE li_idx   LIKE type_t.num10
   DEFINE ls_js    STRING
   DEFINE ls_wc    STRING
   DEFINE l_dialog ui.DIALOG
   DEFINE lc_param type_parameter
   #add-point:ui_dialog段define 
   
   #end add-point
   
   #add-point:ui_dialog段before dialog
   
   #end add-point
 
   WHILE TRUE
      #add-point:ui_dialog段before dialog2
      
      #end add-point
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #應用 a57 樣板自動產生(Version:3)
         INPUT BY NAME g_master.rtjadocdt,g_master.l_a 
            ATTRIBUTE(WITHOUT DEFAULTS)
            
            #自訂ACTION(master_input)
            
         
            BEFORE INPUT
               #add-point:資料輸入前 name="input.m.before_input"
               LET g_master.rtjadocdt = g_today
               #end add-point
         
                     #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD rtjadocdt
            #add-point:BEFORE FIELD rtjadocdt name="input.b.rtjadocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD rtjadocdt
            
            #add-point:AFTER FIELD rtjadocdt name="input.a.rtjadocdt"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE rtjadocdt
            #add-point:ON CHANGE rtjadocdt name="input.g.rtjadocdt"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_a
            #add-point:BEFORE FIELD l_a name="input.b.l_a"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_a
            
            #add-point:AFTER FIELD l_a name="input.a.l_a"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_a
            #add-point:ON CHANGE l_a name="input.g.l_a"
            
            #END add-point 
 
 
 
                     #Ctrlp:input.c.rtjadocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD rtjadocdt
            #add-point:ON ACTION controlp INFIELD rtjadocdt name="input.c.rtjadocdt"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_a
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_a
            #add-point:ON ACTION controlp INFIELD l_a name="input.c.l_a"
            
            #END add-point
 
 
 
               
            AFTER INPUT
               #add-point:資料輸入後 name="input.m.after_input"
               
               #end add-point
               
            #add-point:其他管控(on row change, etc...) name="input.other"
            
            #end add-point
         END INPUT
 
 
 
         
         #應用 a58 樣板自動產生(Version:3)
         CONSTRUCT BY NAME g_master.wc ON rtjasite
            BEFORE CONSTRUCT
               #add-point:cs段before_construct name="cs.head.before_construct"
               
               #end add-point 
         
            #公用欄位開窗相關處理
            
               
            #一般欄位開窗相關處理    
                     #Ctrlp:construct.c.rtjasite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD rtjasite
            #add-point:ON ACTION controlp INFIELD rtjasite name="construct.c.rtjasite"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = s_aooi500_q_where(g_prog,'rtjasite',g_site,'c')
            CALL q_ooef001_24()                     #呼叫開窗
            DISPLAY g_qryparam.return1 TO rtjasite  #顯示到畫面上
            NEXT FIELD rtjasite                     #返回原欄位
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD rtjasite
            #add-point:BEFORE FIELD rtjasite name="construct.b.rtjasite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD rtjasite
            
            #add-point:AFTER FIELD rtjasite name="construct.a.rtjasite"
            
            #END add-point
            
 
 
 
            
            #add-point:其他管控 name="cs.other"
            
            #end add-point
            
         END CONSTRUCT
 
 
 
      
         #add-point:ui_dialog段construct
         
         #end add-point
         #add-point:ui_dialog段input
         
         #end add-point
         #add-point:ui_dialog段自定義display array
         
         #end add-point
 
         SUBDIALOG lib_cl_schedule.cl_schedule_setting
         SUBDIALOG lib_cl_schedule.cl_schedule_setting_exec_call
         SUBDIALOG lib_cl_schedule.cl_schedule_select_show_history
         SUBDIALOG lib_cl_schedule.cl_schedule_show_history
 
         BEFORE DIALOG
            LET l_dialog = ui.DIALOG.getCurrent()
            CALL adep200_get_buffer(l_dialog)
            #add-point:ui_dialog段before dialog
            LET g_master.rtjadocdt = g_today
            LET g_master.l_a = 'N'
            #end add-point
 
         ON ACTION batch_execute
            LET g_action_choice = "batch_execute"
            ACCEPT DIALOG
 
         #add-point:ui_dialog段before_qbeclear
            
         #end add-point
 
         ON ACTION qbeclear         
            CLEAR FORM
            INITIALIZE g_master.* TO NULL   #畫面變數清空
            INITIALIZE lc_param.* TO NULL   #傳遞參數變數清空
            #add-point:ui_dialog段qbeclear
            
            #end add-point
 
         ON ACTION history_fill
            CALL cl_schedule_history_fill()
 
         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT DIALOG
         
         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT DIALOG
 
         #add-point:ui_dialog段action
         
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM   
         INITIALIZE g_master.* TO NULL
         LET g_wc  = ' 1=2'
         LET g_action_choice = ""
         CALL adep200_init()
         CONTINUE WHILE
      END IF
 
      #檢查批次設定是否有錯(或未設定完成)
      IF NOT cl_schedule_exec_check() THEN
         CONTINUE WHILE
      END IF
      
      LET lc_param.wc = g_master.wc    #把畫面上的wc傳遞到參數變數
      #請在下方的add-point內進行把畫面的輸入資料(g_master)轉換到傳遞參數變數(lc_param)的動作
      #add-point:ui_dialog段exit dialog
      LET lc_param.rtjadocdt = g_master.rtjadocdt
      LET lc_param.l_a = g_master.l_a
      LET lc_param.wc = g_master.wc
      #end add-point
 
      LET ls_js = util.JSON.stringify(lc_param)  #r類使用g_master/p類使用lc_param
 
      IF INT_FLAG THEN
         LET INT_FLAG = FALSE
         EXIT WHILE
      ELSE
         IF g_chk_jobid THEN 
            LET g_jobid = g_schedule.gzpa001
         ELSE 
            LET g_jobid = cl_schedule_get_jobid(g_prog)
         END IF 
 
         #依照指定模式執行報表列印
         CASE 
            WHEN g_schedule.gzpa003 = "0"
                 CALL adep200_process(ls_js)
 
            WHEN g_schedule.gzpa003 = "1"
                 LET ls_js = adep200_transfer_argv(ls_js)
                 CALL cl_cmdrun(ls_js)
 
            WHEN g_schedule.gzpa003 = "2"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
 
            WHEN g_schedule.gzpa003 = "3"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
         END CASE  
 
         IF g_schedule.gzpa003 = "2" OR g_schedule.gzpa003 = "3" THEN 
            CALL cl_ask_confirm3("std-00014","") #設定完成
         END IF    
         LET g_schedule.gzpa003 = "0" #預設一開始 立即於前景執行
 
         #add-point:ui_dialog段after schedule
         
         #end add-point
 
         #欄位初始資訊 
         CALL cl_schedule_init_info("all",g_schedule.gzpa003) 
         LET gi_hiden_asign = FALSE 
         LET gi_hiden_exec = FALSE 
         LET gi_hiden_spec = FALSE 
         LET gi_hiden_exec_end = FALSE 
         CALL cl_schedule_hidden()
      END IF
   END WHILE
 
END FUNCTION
 
{</section>}
 
{<section id="adep200.transfer_argv" >}
#+ 轉換本地參數至cmdrun參數內,準備進入背景執行
PRIVATE FUNCTION adep200_transfer_argv(ls_js)
 
   #add-point:transfer_agrv段define (客製用)
   
   #end add-point
   DEFINE ls_js       STRING
   DEFINE la_cmdrun   RECORD
             prog       STRING,
             actionid   STRING,
             background LIKE type_t.chr1,
             param      DYNAMIC ARRAY OF STRING
                  END RECORD
   DEFINE la_param    type_parameter
   #add-point:transfer_agrv段define 
   
   #end add-point
 
   LET la_cmdrun.prog = g_prog
   LET la_cmdrun.background = "Y"
   LET la_cmdrun.param[1] = ls_js
 
   #add-point:transfer.argv段程式內容
 
   #end add-point
 
   RETURN util.JSON.stringify( la_cmdrun )
END FUNCTION
 
{</section>}
 
{<section id="adep200.process" >}
#+ 資料處理   (r類使用g_master為主處理/p類使用l_param為主)
PRIVATE FUNCTION adep200_process(ls_js)
 
   #add-point:process段define (客製用)
   
   #end add-point
   DEFINE ls_js         STRING
   DEFINE lc_param      type_parameter
   DEFINE li_stus       LIKE type_t.num5
   DEFINE li_count      LIKE type_t.num10  #progressbar計量
   DEFINE ls_sql        STRING             #主SQL
   DEFINE li_p01_status LIKE type_t.num5
   #add-point:process段define 
   DEFINE l_loop        LIKE type_t.num5   #160225-00040#4 Add By Ken 160401
   DEFINE l_msg         STRING             #160225-00040#4 Add By Ken 160401  
   #end add-point
 
  #INITIALIZE lc_param TO NULL           #p類不可以清空
   CALL util.JSON.parse(ls_js,lc_param)  #r類作業被t類呼叫時使用, p類主要解開參數處
   LET li_p01_status = 1
 
  #IF lc_param.wc IS NOT NULL THEN
  #   LET g_bgjob = "T"       #特殊情況,此為t類作業鬆耦合串入報表主程式使用
  #END IF
 
   #add-point:process段前處理
   CALL adep200_create_tmp()
   #end add-point
 
   #預先計算progressbar迴圈次數
   IF g_bgjob <> "Y" THEN
      #add-point:process段count_progress
      #160225-00040#4 Add By Ken 160401(S)
      LET l_loop = 6
      CALL cl_progress_bar_no_window(l_loop)  
      #160225-00040#4 Add By Ken 160401(E)
      #end add-point
   END IF
 
   #主SQL及相關FOREACH前置處理
#  DECLARE adep200_process_cs CURSOR FROM ls_sql
#  FOREACH adep200_process_cs INTO
   #add-point:process段process
   CALL adep200_gen(lc_param.rtjadocdt,lc_param.l_a,lc_param.wc)   
   #end add-point
#  END FOREACH
 
   IF g_bgjob = "N" THEN
      #前景作業完成處理
      #add-point:process段foreground完成處理
      
      #end add-point
      CALL cl_ask_confirm3("std-00012","")
   ELSE
      #背景作業完成處理
      #add-point:process段background完成處理
      
      #end add-point
      CALL cl_schedule_exec_call(li_p01_status)
   END IF
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL adep200_msgcentre_notify()
 
END FUNCTION
 
{</section>}
 
{<section id="adep200.get_buffer" >}
PRIVATE FUNCTION adep200_get_buffer(p_dialog)
 
   #add-point:process段define (客製用)
   
   #end add-point
   DEFINE p_dialog   ui.DIALOG
   #add-point:process段define
   
   #end add-point
 
   
   LET g_master.rtjadocdt = p_dialog.getFieldBuffer('rtjadocdt')
   LET g_master.l_a = p_dialog.getFieldBuffer('l_a')
 
   CALL cl_schedule_get_buffer(p_dialog)
 
   #add-point:get_buffer段其他欄位處理
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="adep200.msgcentre_notify" >}
PRIVATE FUNCTION adep200_msgcentre_notify()
 
   #add-point:process段define (客製用)
   
   #end add-point
   DEFINE lc_state LIKE type_t.chr5
   #add-point:process段define
   
   #end add-point
 
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = "process"
 
   #add-point:msgcentre其他通知
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
{</section>}
 
{<section id="adep200.other_function" readonly="Y" >}
#add-point:自定義元件(Function)

################################################################################
# Descriptions...: 建立temp table
# Memo...........:
# Usage..........: CALL adep200_create_tmp()
# Input parameter: 無
# Return code....: 無
# Date & Author..: 2015/04/27 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_create_tmp()

   DROP TABLE adep200_debz
   CREATE TEMP TABLE adep200_debz(            #門店收入日結檔
      debzent        LIKE debz_t.debzent,     #企業編號
      debzsite       LIKE debz_t.debzsite,    #營運據點
      debz001        LIKE debz_t.debz001,     #層級類型
      debz002        LIKE debz_t.debz002,     #統計日期
      debz003        LIKE debz_t.debz003,     #會計週
      debz004        LIKE debz_t.debz004,     #會計期
      debz005        LIKE debz_t.debz005,     #專櫃編號
      debz006        LIKE debz_t.debz006,     #專櫃類型
      debz007        LIKE debz_t.debz007,     #品類編號
      debz008        LIKE debz_t.debz008,     #稅別編號
      debz009        LIKE debz_t.debz009,     #稅額
      debz010        LIKE debz_t.debz010,     #銷售額
      debz011        LIKE debz_t.debz011,     #收貨折讓總額
      debz012        LIKE debz_t.debz012,     #應收金額
      debz013        LIKE debz_t.debz013,     #銷售收入
      debz014        LIKE debz_t.debz014,     #庫區
      debz015        LIKE debz_t.debz015,     #主帳套立帳數量
      debz016        LIKE debz_t.debz016,     #次帳套一立帳金額
      debz017        LIKE debz_t.debz017,     #次帳套二立帳金額
      debz018        LIKE debz_t.debz018,     #經營方式         #150611-00005#1 Add By Ken 150611
      imaa001        LIKE rtjb_t.rtjb004,     #商品編號
      rtja032        LIKE rtja_t.rtja032)     #資料來源
   DROP TABLE adep200_deby
   CREATE TEMP TABLE adep200_deby(            #門店收款日結檔
      debyent        LIKE deby_t.debyent,     #企業編號
      debysite       LIKE deby_t.debysite,    #營運據點
      deby001        LIKE deby_t.deby001,     #款別類型
      deby002        LIKE deby_t.deby002,     #款別編號
      deby003        LIKE deby_t.deby003,     #統計日期
      deby004        LIKE deby_t.deby004,     #收款金額
      deby005        LIKE deby_t.deby005,     #款別類型對應憑證號
      deby006        LIKE deby_t.deby006,     #支票面額
      deby007        LIKE deby_t.deby007,     #票據到期日
      deby008        LIKE deby_t.deby008,     #票據付款銀行
      deby009        LIKE deby_t.deby009,     #開客票
      deby010        LIKE deby_t.deby010,     #開票人全名
      deby011        LIKE deby_t.deby011,     #卡/券種編號
      deby012        LIKE deby_t.deby012,     #票券溢交金額
      deby013        LIKE deby_t.deby013,     #沖預收款類型
      deby014        LIKE deby_t.deby014,     #抵現積點
      deby015        LIKE deby_t.deby015,     #退款類型
      deby016        LIKE deby_t.deby016,     #主帳套立帳金額
      deby017        LIKE deby_t.deby017,     #次帳套一立帳金額
      deby018        LIKE deby_t.deby018)     #次帳套二立帳金額

   DROP TABLE adep200_debz_temp
   CREATE TEMP TABLE adep200_debz_temp(     #已經結算過門店收入日結檔
      debzent        LIKE debz_t.debzent,     #企業編號
      debzsite       LIKE debz_t.debzsite,    #營運據點
      debz002        LIKE debz_t.debz002      #統計日期
   )
   
   DROP TABLE adep200_deby_temp
   CREATE TEMP TABLE adep200_deby_temp(     #已經結算過門店收款日結檔
      debyent        LIKE deby_t.debyent,     #企業編號
      debysite       LIKE deby_t.debysite,    #營運據點
      deby003        LIKE deby_t.deby003      #統計日期
   )
END FUNCTION

################################################################################
# Descriptions...: 產生門店收入/收款日結檔
# Memo...........:
# Usage..........: CALL adep200_gen(p_rtjadocdt,p_a,p_wc)
# Input parameter: p_rtjadocdt    銷售日期
#                : p_a            已存在日結資料刪除重新結算
#                : p_wc           條件
# Return code....: 無
# Date & Author..: 2015/04/27 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_gen(p_rtjadocdt,p_a,p_wc)
DEFINE p_rtjadocdt       LIKE rtja_t.rtjadocdt
DEFINE p_a               LIKE type_t.chr1
DEFINE p_wc              STRING
DEFINE l_success         LIKE type_t.num5
DEFINE l_deby_cnt        LIKE type_t.num5
DEFINE l_debz_cnt        LIKE type_t.num5
DEFINE l_loop            LIKE type_t.num5   #160225-00040#4 Add By Ken 160401
DEFINE l_msg             STRING             #160225-00040#4 Add By Ken 160401 

   #160225-00040#4 Add By Ken 160401(S)  資料準備 
   LET l_msg = cl_getmsg('ade-00114',g_lang)   
   CALL cl_progress_no_window_ing(l_msg)   
   #160225-00040#4 Add By Ken 160401(E)      
   CALL cl_err_collect_init()
   CALL s_transaction_begin()
   
   #抓取資料新增到temp table
   IF NOT adep200_ins_tmp(p_rtjadocdt,p_a,p_wc) THEN
      CALL s_transaction_end('N','0')
      CALL adep200_msg_show(4)   #160225-00040#4 Add By Ken 160401      
      CALL cl_err_collect_show()
      RETURN
   END IF
      
   #160225-00040#4 Add By Ken 160401(S)   產生資料
   LET l_msg = cl_getmsg('ast-00330',g_lang)
   CALL cl_progress_no_window_ing(l_msg)   
   #160225-00040#4 Add By Ken 160401(e)   
   #門店收入日結檔
   IF NOT adep200_gen_debz(p_a) THEN
      CALL s_transaction_end('N','0')
      CALL adep200_msg_show(3)   #160225-00040#4 Add By Ken 160401            
      CALL cl_err_collect_show()     
      RETURN
   END IF
   #160604-00009#129 S
   #門店收入日結檔
   IF NOT adep200_gen_debz5(p_rtjadocdt,p_a,p_wc) THEN
      CALL s_transaction_end('N','0')
      CALL adep200_msg_show(3)  
      CALL cl_err_collect_show()
      RETURN
   END IF
   #160604-00009#129 E

   #160225-00040#4 Add By Ken 160401(S)   產生資料
   LET l_msg = cl_getmsg('ast-00330',g_lang)
   CALL cl_progress_no_window_ing(l_msg)   
   #160225-00040#4 Add By Ken 160401(e)  
   #門店收款日結檔
   IF NOT adep200_gen_deby(p_a) THEN
      CALL s_transaction_end('N','0')
      CALL adep200_msg_show(2)   #160225-00040#4 Add By Ken 160401          
      CALL cl_err_collect_show()       
      RETURN
   END IF
   
   #160225-00040#4 Add By Ken 160401(S)   產生資料
   LET l_msg = cl_getmsg('ast-00330',g_lang)
   CALL cl_progress_no_window_ing(l_msg)   
   #160225-00040#4 Add By Ken 160401(e)     
   #門店收入日結檔是否有符合條件的資料
   LET l_debz_cnt = 0
   SELECT COUNT(debzsite) INTO l_debz_cnt
     FROM adep200_debz
   IF l_debz_cnt = 0 THEN
      #無符合的資料，無法進行門店日結收入結算！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ade-00079'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
   ELSE
      CALL adep200_debz_remind(p_a)
   END IF
   
   #160225-00040#4 Add By Ken 160401(S)   產生資料
   LET l_msg = cl_getmsg('ast-00330',g_lang)
   CALL cl_progress_no_window_ing(l_msg)   
   #160225-00040#4 Add By Ken 160401(e)     
   #門店收款日結檔是否有符合條件的資料
   LET l_deby_cnt = 0
   SELECT COUNT(debysite) INTO l_deby_cnt
     FROM adep200_deby
   IF l_deby_cnt = 0 THEN
      #無符合的資料，無法進行門店日結收款結算！
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ade-00080'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
   ELSE
      CALL adep200_deby_remind(p_a)
   END IF
   
   #160225-00040#4 Add By Ken 160401(S)
   LET l_msg = cl_getmsg('std-00012',g_lang)
   CALL cl_progress_no_window_ing(l_msg) 
   #160225-00040#4 Add By Ken 160401(E)    
   CALL s_transaction_end('Y','0')  
   CALL cl_err_collect_show() 
END FUNCTION

################################################################################
# Descriptions...: 新增資料的temp
# Memo...........:
# Usage..........: CALL adep200_ins_tmp(p_rtjadocdt,p_a,p_wc)
# Input parameter: p_rtjadocdt    銷售日期
#                : p_a            已存在日結資料刪除重新結算
#                : p_wc           條件
# Return code....: 無
# Date & Author..: 2015/04/27 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_ins_tmp(p_rtjadocdt,p_a,p_wc)
DEFINE p_rtjadocdt       LIKE rtja_t.rtjadocdt
DEFINE p_a               LIKE type_t.chr1
DEFINE p_wc              STRING
DEFINE r_success         LIKE type_t.num5
DEFINE l_sql             STRING
DEFINE l_where           STRING
DEFINE l_cnt             LIKE type_t.num5   #150417-00007#81

   LET r_success = TRUE
   CALL s_aooi500_sql_where(g_prog,'rtjasite') RETURNING l_where
   
   #門店收入日結檔
   LET l_sql = " INSERT INTO adep200_debz(debzent, debzsite, debz001, debz002,",
               "                          debz003, debz004,  debz005, debz006,",
               "                          debz007, debz008,  debz009, debz010,",
               "                          debz011, debz012,  debz013, debz014,",
               "                          debz015, debz016,  debz017, debz018 ",  #150611-00005#1 Add By Ken 150611 加debz018欄位
               "                          ,imaa001,rtja032) ",#151029-00011#6 s983961--add             
               " SELECT rtjaent, rtjasite, '',      rtjadocdt,",
               "        '',      '',       COALESCE(rtjb028,' '), '',",
               "        COALESCE(imaa009,' '),  COALESCE(rtjb006,' '),  COALESCE(rtjb021,0)-COALESCE(rtjb022,0), COALESCE(rtjb021,0)+COALESCE(rtjb020,0),",
               "        rtjb020, rtjb021,  rtjb021, rtjb025,",
               "        0,       0,        0,       rtdx003 ",   #150611-00005#1 Add By Ken 150611 加rtdx003欄位
               "        ,rtjb004,rtja032 ",#151029-00011#6 s983961--add      
               "  FROM rtja_t,rtjb_t,imaa_t,rtdx_t",     #150611-00005#1 Add By Ken 150611 加rtdx_t資料表
               " WHERE rtjaent = rtjbent",
               "   AND rtjadocno = rtjbdocno",
               "   AND imaaent = rtjbent",
               "   AND imaa001 = rtjb004",
               #150611-00005#1 Add By Ken 150611(S)
               "   AND rtjaent  = rtdxent  ",
               "   AND rtjasite = rtdxsite ",
               "   AND imaa001  = rtdx001  ",
               #150611-00005#1 Add By Ken 150611(E)
               "   AND rtjaent = ",g_enterprise,
               "   AND rtjadocdt = '",p_rtjadocdt,"'",
               #"   AND rtja032 != '1'",   #150515-00002#1 150521 By pomelo mark
               "   AND rtdx003 <> '5' ",   #160604-00009#129
               "   AND rtjastus != 'X'",
               "   AND ",p_wc,
               "   AND ",l_where
   PREPARE adep200_ins_tmp_debz FROM l_sql
   EXECUTE adep200_ins_tmp_debz
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins adep200_debz"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   #150417-00007#81 By benson --- S
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM rtjf_t,rtja_t,adep200_debz 
    WHERE rtjfent   = rtjaent   AND rtjaent = debzent
      AND rtjfdocno = rtjadocno AND rtjasite = debzsite
      AND debz002  = rtjadocdt
      AND rtjf037 = 'Y'
   IF l_cnt > 0 THEN
      #日結的條件範圍內已有資料產生立帳,不可重新結算
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ade-00126'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150417-00007#81 By benson --- E
   
   
   LET l_sql = "UPDATE adep200_debz",
               "   SET debz001 = (SELECT ooef101",
               "                    FROM ooef_t",
               "                   WHERE ooefent = debzent",
               "                     AND ooef001 = debzsite),",
               "       (debz003,debz004) = (SELECT oogc008,oogc006",
               "                              FROM oogc_t,ooef_t",
               "                             WHERE oogcent = ooefent",
               "                               AND oogc001 = ooef008",    #行事曆參照表號
               "                               AND oogcent = debzent",
               "                               AND oogc002 = '4'",        #行事曆類別
               "                               AND ooef001 = debzsite",   #營運據點
               "                               AND oogc003 = debz002),",  #日期
               "       debz006 = (SELECT mhae002",
               "                    FROM mhae_t",
               "                   WHERE mhaeent = debzent",
               "                     AND mhaesite = debzsite",
               "                     AND mhae001 = debz005)"
   PREPARE adep200_upd_tmp_debz FROM l_sql
   EXECUTE adep200_upd_tmp_debz
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Upd adep200_debz"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   #門店收款日結檔  非5.租赁
   LET l_sql = " INSERT INTO adep200_deby(debyent, debysite, deby001, deby002,",
               "                          deby003, deby004,  deby005, deby006,",
               "                          deby007, deby008,  deby009, deby010,",
               "                          deby011, deby012,  deby013, deby014,",
               "                          deby015, deby016,  deby017, deby018)",
               " SELECT rtjaent,   rtjasite, rtjf001, rtjf002,",
               "        rtjadocdt, rtjf003,  rtjf004, rtjf008,",
               "        rtjf009,   rtjf010,  rtjf011, rtjf012,",
               "        rtjf013,   rtjf020,  rtjf021, rtjf022,",
               "        rtjf024,   0,        0,       0",     
               "  FROM rtjf_t,rtja_t",
               " WHERE rtjfent = rtjaent",
               "   AND rtjfdocno = rtjadocno",
               "   AND rtjaent = ",g_enterprise,
               "   AND rtjadocdt = '",p_rtjadocdt,"'",
               #"   AND rtja032 != '1'",   #150515-00002#1 150521 By pomelo mark
               "   AND (rtjf103 is null OR rtjf103 = ' ') ",   #160604-00009#129
               "   AND rtjastus != 'X'",
               #當款別類型 != 91.賒銷
#               "   AND rtjf001 != '91'",   #150515-00002#1 150521 By pomelo add   #150819-00015#1 mark by beckxie
               "   AND rtjf001 NOT IN ('91','92')",                                #150819-00015#1  add by beckxie
               "   AND ",p_wc,
               "   AND ",l_where
   PREPARE adep200_ins_tmp_deby FROM l_sql
   EXECUTE adep200_ins_tmp_deby
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins adep200_deby"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   #160604-00009#129 S---
   #門店收款日結檔 5.租赁  用rtjf025的日期当作认列收入的日期 
   LET l_sql = " INSERT INTO adep200_deby(debyent, debysite, deby001, deby002,",
               "                          deby003, deby004,  deby005, deby006,",
               "                          deby007, deby008,  deby009, deby010,",
               "                          deby011, deby012,  deby013, deby014,",
               "                          deby015, deby016,  deby017, deby018)",
               " SELECT rtjaent,   rtjasite, rtjf001, rtjf002,",
               "        rtjf025,   rtjf003,  rtjf004, rtjf008,",
               "        rtjf009,   rtjf010,  rtjf011, rtjf012,",
               "        rtjf013,   rtjf020,  rtjf021, rtjf022,",
               "        rtjf024,   0,        0,       0",     
               "  FROM rtjf_t,rtja_t",
               " WHERE rtjfent = rtjaent",
               "   AND rtjfdocno = rtjadocno",
               "   AND rtjaent = ",g_enterprise,
               "   AND rtjf025 = '",p_rtjadocdt,"'",
               "   AND rtjf103 IS NOT NULL ",   #160604-00009#129
               "   AND rtjastus != 'X'",
               "   AND rtjf001 NOT IN ('91','92')",
               "   AND ",p_wc,
               "   AND ",l_where
   PREPARE adep200_ins_tmp_deby_5 FROM l_sql
   EXECUTE adep200_ins_tmp_deby_5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins adep200_deby"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   #160604-00009#129 E---
   
   #150515-00002#1 150521 By pomelo add(S)
   #當款別類型 = 91.賒銷    
   LET l_sql = " INSERT INTO adep200_deby(debyent, debysite, deby001, deby002,",
               "                          deby003, deby004,  deby005, deby006,",
               "                          deby007, deby008,  deby009, deby010,",
               "                          deby011, deby012,  deby013, deby014,",
               "                          deby015, deby016,  deby017, deby018)",
               " SELECT rtjaent,   rtjasite, rtjf001, rtjf002,",
               "        rtjadocdt, rtjf003,  rtja002, rtjf008,",
               "        rtjf009,   rtjf010,  rtjf011, rtjf012,",
               "        rtjf013,   rtjf020,  rtjf021, rtjf022,",
               "        rtjf024,   0,        0,       0",
               "  FROM rtjf_t,rtja_t",
               " WHERE rtjfent = rtjaent",
               "   AND rtjfdocno = rtjadocno",
               "   AND rtjaent = ",g_enterprise,
               "   AND rtjadocdt = '",p_rtjadocdt,"'",
               "   AND rtjastus != 'X'",
#               "   AND rtjf001 = '91'",          #150819-00015#1 mark by beckxie  
               "   AND rtjf001 IN ('91','92')",   #150819-00015#1  add by beckxie               
               "   AND ",p_wc,
               "   AND ",l_where        
   PREPARE adep200_ins_tmp_deby1 FROM l_sql
   EXECUTE adep200_ins_tmp_deby1
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins adep200_deby1"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   #150515-00002#1 150521 By pomelo add(E)   
   
   #150417-00007#81 By benson --- S
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM rtjf_t,rtja_t,adep200_deby 
    WHERE rtjfent   = rtjaent   AND rtjaent = debyent
      AND rtjfdocno = rtjadocno AND rtjasite = debysite
      AND deby003  = rtjadocdt
      AND rtjf037 = 'Y'
   IF l_cnt > 0 THEN
      #日結的條件範圍內已有資料產生立帳,不可重新結算
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ade-00126'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #150417-00007#81 By benson --- E
   
   #紀錄銷售組織+單據日期已經存在門店收入日結檔
   LET l_sql = " INSERT INTO adep200_debz_temp(debzent,debzsite,debz002)",
               " SELECT UNIQUE a.debzent,a.debzsite,a.debz002",
               "   FROM debz_t a",
               "  WHERE EXISTS(SELECT 1",
               "                 FROM adep200_debz b",
               "                WHERE a.debzent = b.debzent",
               "                  AND a.debzsite = b.debzsite",
               "                  AND a.debz002 = b.debz002)"
   PREPARE adep200_ins_exists_debz FROM l_sql
   EXECUTE adep200_ins_exists_debz
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins adep200_debz_temp"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   #150417-00007#81 By benson --- S
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM debz_t a
    WHERE a.debzent = g_enterprise
      AND EXISTS(SELECT 1 FROM adep200_debz_temp b
                  WHERE a.debzent = b.debzent
                    AND a.debzsite = b.debzsite
                    AND a.debz002 = b.debz002)
      AND (debz015 > 0 OR debz016 > 0 OR debz017 > 0 ) #150826-00020#1 Add By Ken 150827      
      #AND debz015 > 0   #Mark By Ken 150827
   IF l_cnt > 0 AND p_a = 'Y' THEN
      #日結的條件範圍內已有"收入"資料產生立帳,不可重新結算
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ade-00127'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE      
   END IF
   #150417-00007#81 By benson --- E
   
   #紀錄銷售組織+單據日期已經存在門店收款日結檔
   LET l_sql = " INSERT INTO adep200_deby_temp(debyent,debysite,deby003)",
               " SELECT UNIQUE a.debyent,a.debysite,a.deby003",
               "   FROM deby_t a",
               "  WHERE EXISTS(SELECT 1",
               "                 FROM adep200_deby b",
               "                WHERE a.debyent = b.debyent",
               "                  AND a.debysite = b.debysite",
               "                  AND a.deby003 = b.deby003)"
   PREPARE adep200_ins_exists_deby FROM l_sql
   EXECUTE adep200_ins_exists_deby
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = ''
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   #150417-00007#81 By benson --- S
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM deby_t a
    WHERE a.debyent = g_enterprise
      AND EXISTS(SELECT 1 FROM adep200_deby_temp b
                  WHERE a.debyent = b.debyent
                    AND a.debysite = b.debysite
                    AND a.deby003 = b.deby003)
      AND (deby016 > 0 OR deby017 > 0 OR deby018 > 0 ) #150826-00020#1 Add By Ken 150827
      #AND deby016 > 0    #Mark By Ken 150827
   IF l_cnt > 0 AND p_a = 'Y' THEN
      #日結的條件範圍內已有"收款"資料產生立帳,不可重新結算
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'ade-00128'
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   #150417-00007#81 By benson --- S
   
   #151029-00011#6 20151103 s983961--add(s)
   #非ERP單據,屬於自營的資料,庫區取值方式調整
   #1.產生的artt610單據為主
   #非ERP單據,屬於自營的資料,庫區取值方式調整
   #1.產生的artt610單據為主
   LET g_sql = "UPDATE adep200_debz ",
               "   SET debz014 = (SELECT UNIQUE rtib025 FROM rtia_t,rtib_t ",
               "                   WHERE rtiaent = rtibent  AND rtiadocno = rtibdocno ", 
               "                     AND debzent = rtibent  AND imaa001 = rtib004 ",
               "                     AND rtiadocdt = debz002 AND rtiasite = debzsite ",
               "                     AND rtia032 = '4' )",
              #" WHERE rtdx003 IN ('1','3')",
              #聯營的庫區 以POS上傳的為主,因為聯營會分常規庫區和促銷庫區 
              #不能用標準的取庫區方式 (先取門店清單的庫區(rtdx044),取不到再取門店預設的出貨庫區(ooef124))
               " WHERE debz018 != '4'", #經營方式
               "   AND rtja032 != '1'"  #資料來源
   PREPARE adep200_debz_p13 FROM g_sql
   EXECUTE adep200_debz_p13

   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "adep200_debz_p13"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   FREE adep200_debz_p13
   
   #2.找組織商品清單的資料 
   LET g_sql = "UPDATE adep200_debz ",
               "   SET debz014 = (SELECT UNIQUE rtdx044 FROM rtdx_t ",
               "                   WHERE debzent = rtdxent  AND debzsite = rtdxsite AND imaa001 = rtdx001) ",
              #" WHERE rtdx003 IN ('1','3')",
               " WHERE debz018 != '4'",  #經營方式
               "   AND rtja032 != '1'",
               "   AND debz014 IS NULL "            
   PREPARE adep200_debz_p14 FROM g_sql
   EXECUTE adep200_debz_p14

   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "adep200_debz_p14"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   FREE adep200_debz_p14

   #3.取組織預設出貨倉
   LET g_sql = "UPDATE adep200_debz ",
               "   SET debz014 = COALESCE((SELECT UNIQUE ooef124 FROM ooef_t ",
               "                   WHERE debzent = ooefent  AND debzsite = ooef001),' ') ",
              #" WHERE rtdx003 IN ('1','3')",
               " WHERE debz018 != '4'",
               "   AND rtja032 != '1'",
               "   AND debz014 IS NULL "
   PREPARE adep200_debz_p15 FROM g_sql
   EXECUTE adep200_debz_p15

   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "adep200_debz_p15"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   FREE adep200_debz_p15
   
   #取組織商品清單稅別為的資料來源
   LET g_sql = "UPDATE adep200_debz ",
               "   SET debz008 = COALESCE((SELECT UNIQUE rtdx014 FROM rtdx_t ",
               "                   WHERE debzent = rtdxent  AND debzsite = rtdxsite AND imaa001 = rtdx001),' ') "
   PREPARE adep200_debz_p16 FROM g_sql
   EXECUTE adep200_debz_p16

   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "adep200_debz_p16"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   FREE adep200_debz_p16
   

   #151029-00011#6 20151103 s983961--add(e)

   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 產生門店收入日結檔
# Memo...........:
# Usage..........: CALL adep200_gen_debz(p_a)
#                  RETURNING r_success
# Input parameter: p_a            已存在日結資料刪除重新結算
# Return code....: r_success      True/False
# Date & Author..: 2015/04/27 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_gen_debz(p_a)
DEFINE p_a               LIKE type_t.chr1
DEFINE r_success         LIKE type_t.num5
DEFINE l_sql             STRING
DEFINE l_where           STRING

   LET r_success = TRUE
   
   LET l_where = " 1=1"
   #已存在日結資料刪除重新結算 = 'Y'，刪除已經存在門店收入日結檔資料
   IF p_a = 'Y' THEN
      LET l_sql = "DELETE FROM debz_t a",
                  " WHERE EXISTS(SELECT 1",
                  "                FROM adep200_debz_temp b",
                  "               WHERE a.debzent = b.debzent",
                  "                 AND a.debzsite = b.debzsite",
                  "                 AND a.debz002 = b.debz002)"
      PREPARE adep200_del_debz FROM l_sql
      EXECUTE adep200_del_debz
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Del debz_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   ELSE
      LET l_where = " NOT EXISTS(SELECT 1",
                    "              FROM adep200_debz_temp b",
                    "             WHERE a.debzent = b.debzent",
                    "               AND a.debzsite = b.debzsite",
                    "               AND a.debz002 = b.debz002)"
   END IF
   
   LET l_sql = " INSERT INTO debz_t(debzent, debzsite, debz001, debz002,",
               "                    debz003, debz004,  debz005, debz006,",
               "                    debz007, debz008,  debz009, debz010,",
               "                    debz011, debz012,  debz013, debz014,",
               "                    debz015, debz016,  debz017, debz018)",   #150611-00005#1 Add By Ken 150611 加debz018欄位
               " SELECT a.debzent,                  a.debzsite,                 a.debz001,                  a.debz002,",
               "        a.debz003,                  a.debz004,                  COALESCE(a.debz005,' '),    COALESCE(a.debz006,' '),",
               "        COALESCE(a.debz007,' '),    a.debz008,                  SUM(COALESCE(a.debz009,0)), SUM(COALESCE(a.debz010,0)),",
               "        SUM(COALESCE(a.debz011,0)), SUM(COALESCE(a.debz012,0)), SUM(COALESCE(a.debz013,0)), COALESCE(a.debz014,' '),",
               "        0,                          0,                          0,                          COALESCE(a.debz018,' ')",   #150611-00005#1 Add By Ken 150611 加rtdx003欄位
               "   FROM adep200_debz a",
               "  WHERE ",l_where,
               "  GROUP BY a.debzent, a.debzsite, a.debz001, a.debz002,",
               "           a.debz003, a.debz004,  a.debz005, a.debz006,",
               "           a.debz007, a.debz008,  a.debz014, a.debz018"   #150611-00005#1 Add By Ken 150611 加rtdx003欄位
   PREPARE adep200_ins_debz FROM l_sql
   EXECUTE adep200_ins_debz
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins debz_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 產生門店收款日結檔
# Memo...........:
# Usage..........: CALL adep200_gen_deby(p_a)
#                  RETURNING r_success
# Input parameter: p_a            已存在日結資料刪除重新結算
# Return code....: r_success      True/False
# Date & Author..: 2015/04/27 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_gen_deby(p_a)
DEFINE p_a               LIKE type_t.chr1
DEFINE r_success         LIKE type_t.num5
DEFINE l_sql             STRING
DEFINE l_where           STRING

   LET r_success = TRUE
   
   LET l_where = " 1=1"
   #已存在日結資料刪除重新結算 = 'Y'，刪除已經存在門店收款日結檔資料
   IF p_a = 'Y' THEN
      LET l_sql = "DELETE FROM deby_t a",
                  " WHERE EXISTS(SELECT 1",
                  "                FROM adep200_deby_temp b",
                  "               WHERE a.debyent = b.debyent",
                  "                 AND a.debysite = b.debysite",
                  "                 AND a.deby003 = b.deby003)"
      PREPARE adep200_del_deby FROM l_sql
      EXECUTE adep200_del_deby
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Del deby_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   ELSE
      LET l_where = " NOT EXISTS(SELECT 1",
                    "              FROM adep200_deby_temp b",
                    "             WHERE a.debyent = b.debyent",
                    "               AND a.debysite = b.debysite",
                    "               AND a.deby003 = b.deby003)"
   END IF
   
   LET l_sql = " INSERT INTO deby_t(debyent, debysite, deby001, deby002,",
               "                    deby003, deby004,  deby005, deby006,",
               "                    deby007, deby008,  deby009, deby010,",
               "                    deby011, deby012,  deby013, deby014,",
               "                    deby015, deby016,  deby017, deby018)",
               " SELECT a.debyent,               a.debysite,                 a.deby001,               a.deby002,",
               "        a.deby003,               SUM(COALESCE(a.deby004,0)), COALESCE(a.deby005,' '), a.deby006,",
               "        a.deby007,               a.deby008,                  a.deby009,               a.deby010,",
               "        COALESCE(a.deby011,' '), SUM(COALESCE(a.deby012,0)), a.deby013,               SUM(COALESCE(a.deby014,0)),",
               "        a.deby015,               0,                          0,                       0",
               "   FROM adep200_deby a",
               "  WHERE ",l_where,
               "  GROUP BY a.debyent, a.debysite, a.deby001, a.deby002,",
               "           a.deby003, a.deby005,  a.deby006, a.deby007,",
               "           a.deby008, a.deby009,  a.deby010, a.deby011,",
               "           a.deby013, a.deby015"
   PREPARE adep200_ins_deby FROM l_sql
   EXECUTE adep200_ins_deby
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins deby_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 提示使用者門店收入日結資料(已存在/重新結算)
# Memo...........:
# Usage..........: CALL adep200_debz_remind(p_a)
# Input parameter: p_a            已存在日結資料刪除重新結算
# Return code....: 無
# Date & Author..: 2015/04/28 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_debz_remind(p_a)
DEFINE p_a               LIKE type_t.chr1
DEFINE l_debzsite        LIKE debz_t.debzsite
DEFINE l_debz002         LIKE debz_t.debz002
DEFINE l_sql             STRING

   LET l_sql = "SELECT debzsite,debz002",
               "  FROM adep200_debz_temp",
               " ORDER BY debzsite,debz002"
   PREPARE adep200_debz_temp_pre FROM l_sql
   DECLARE adep200_debz_temp_cs CURSOR FOR adep200_debz_temp_pre
   
   FOREACH adep200_debz_temp_cs INTO l_debzsite,l_debz002
      INITIALIZE g_errparam TO NULL
      IF p_a = 'Y' THEN
         #銷售組織%1+銷售日期%2 重新結轉[門店收入日結檔(debz_t)]!
         LET g_errparam.code = 'ade-00083'
      ELSE
         #銷售組織%1+銷售日期%2 資料已存在[門店收入日結檔(debz_t)]，未重新結轉！
         LET g_errparam.code = 'ade-00081'
      END IF
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = l_debzsite
      LET g_errparam.replace[2] = l_debz002
      CALL cl_err()
   END FOREACH
   
END FUNCTION

################################################################################
# Descriptions...: 提示使用者門店收款日結資料(已存在/重新結算)
# Memo...........:
# Usage..........: CALL adep200_deby_remind(p_a)
# Input parameter: p_a            已存在日結資料刪除重新結算
# Return code....: 無
# Date & Author..: 2015/04/28 By pomelo
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_deby_remind(p_a)
DEFINE p_a               LIKE type_t.chr1
DEFINE l_debysite        LIKE deby_t.debysite
DEFINE l_deby003         LIKE deby_t.deby003
DEFINE l_sql             STRING

   LET l_sql = "SELECT debysite,deby003",
               "  FROM adep200_deby_temp",
               " ORDER BY debysite,deby003"
   PREPARE adep200_deby_temp_pre FROM l_sql
   DECLARE adep200_deby_temp_cs CURSOR FOR adep200_deby_temp_pre
   
   FOREACH adep200_deby_temp_cs INTO l_debysite,l_deby003
      INITIALIZE g_errparam TO NULL
      IF p_a = 'Y' THEN
         #銷售組織%1+銷售日期%2 重新結轉[門店收款日結檔(deby_t)]!
         LET g_errparam.code = 'ade-00084'
      ELSE
         #銷售組織%1+銷售日期%2 資料已存在[門店收款日結檔(deby_t)]，未重新結轉！
         LET g_errparam.code = 'ade-00082'
      END IF
      LET g_errparam.extend = ""
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = l_debysite
      LET g_errparam.replace[2] = l_deby003
      CALL cl_err()
   END FOREACH
END FUNCTION

################################################################################
# Descriptions...: 批次產生資料的進度條顯示次數
# Memo...........:
# Usage..........: CALL adep200_msg_show(p_cnt)
# Input parameter: p_cnt          要顯示的次數
# Return code....: 
# Date & Author..: 2016/5/5 By Ken
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_msg_show(p_cnt)
DEFINE p_cnt            LIKE type_t.num5
DEFINE l_min_cnt        LIKE type_t.num5
DEFINE l_i              LIKE type_t.num5
DEFINE l_msg            STRING             #160225-00040#4 Add By Ken 160401

   LET l_min_cnt = 1
   FOR l_i = l_min_cnt TO p_cnt
      LET l_msg = cl_getmsg('ast-00330',g_lang)
      CALL cl_progress_no_window_ing(l_msg)     
   END FOR
   
   LET l_msg = cl_getmsg('std-00012',g_lang)
   CALL cl_progress_no_window_ing(l_msg)    
   
END FUNCTION

################################################################################
# Descriptions...: 新增debz
# Memo...........:
# Usage..........: CALL adep200_gen_debz5(p_rtjadocdt,p_a,p_wc) RETURNING r_success
# Input parameter: p_rtjadocdt    銷售日期
#                : p_a            已存在日結資料刪除重新結算
#                : p_wc           條件
# Return code....: 無
# Date & Author..: #160604-00009#129 2016/07/04 By shiwy
# Modify.........:
################################################################################
PRIVATE FUNCTION adep200_gen_debz5(p_rtjadocdt,p_a,p_wc)
DEFINE p_rtjadocdt       LIKE rtja_t.rtjadocdt
DEFINE p_a               LIKE type_t.chr1
DEFINE p_wc              STRING
DEFINE r_success         LIKE type_t.num5
DEFINE l_sql             STRING
DEFINE l_where           STRING
DEFINE l_where1          STRING

   LET r_success = TRUE
   CALL s_aooi500_sql_where(g_prog,'rtjasite') RETURNING l_where
   LET l_where1 = cl_str_replace(l_where, "rtjasite","debzsite" )
   
   #已存在日結資料刪除重新結算 = 'Y'，刪除已經存在門店收入日結檔資料
   IF p_a = 'Y' THEN
      LET l_sql = " DELETE FROM debz_t ",
                  "  WHERE debz018 = '5' AND debzent = ",g_enterprise,
                  "    AND debz002 = '",p_rtjadocdt,"' AND ",l_where1
      PREPARE adep200_del_debz_5 FROM l_sql
      EXECUTE adep200_del_debz_5
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "Del debz_t5"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success
      END IF
   ELSE
      LET l_where = l_where," AND ",
                    " NOT EXISTS(SELECT 1",
                    "              FROM debz_t ",
                    "             WHERE debzent = ",g_enterprise,
                    "               AND debzsite = rtjasite AND debz002 = rtjf025 ",
                    "               AND debz002 = '",p_rtjadocdt,"' AND ",l_where1,")"
   END IF
   
   LET l_sql = " INSERT INTO debz_t(debzent, debzsite, debz001, debz002,",
               "                          debz003, debz004,  debz005, debz006,",
               "                          debz007, debz008,  debz009, debz010,", --品类/税种/税额/销售额
               "                          debz011, debz012,  debz013, debz014,", --折让/应收/收入/库区
               "                          debz015, debz016,  debz017, debz018 ",
               "                          ) ",
               " SELECT rtjaent, rtjasite, '',      rtjf025,",
               "        '',      '',       rtja101, '',",
              #"         stje028 ,   stje038 ,  0, SUM(COALESCE(rtjf031,0)),",
              #"        0, SUM(COALESCE(rtjf031,0)),  SUM(COALESCE(rtjf031,0)), ' ',",
               "         stje028 ,   stje038 ,  SUM(COALESCE(rtjf031,0))-ROUND(SUM(COALESCE(rtjf031,0))/(1+oodb006/100),2), SUM(COALESCE(rtjf031,0)),",
               "        0, SUM(COALESCE(rtjf031,0)),  SUM(COALESCE(rtjf031,0)), ' ',",
               "        0,       0,        0,       '5' ",
               "  FROM rtja_t,rtjf_t,stje_t,oodb_t,ooef_t",
               " WHERE rtjaent = rtjfent AND rtjadocno = rtjfdocno", 
               "   AND rtjastus != 'X' AND rtjaent = ",g_enterprise,
               "   AND rtjf025 = '",p_rtjadocdt,"' ",
               "   AND ooefent = rtjaent AND ooef001 = rtjasite AND ooefent = oodbent AND oodb001 = ooef019 AND oodb002 = stje038 ",
               "   AND stjeent = rtjaent AND stjesite = rtjasite AND stje001 = rtja105 ",
               "   AND rtja105 IS NOT NULL AND ",p_wc,
               "   AND ",l_where,
               " GROUP BY rtjaent,rtjasite,'',rtjf025,rtja101,stje028,stje038,oodb006 "
   PREPARE adep200_ins_tmp_debz_5 FROM l_sql
   EXECUTE adep200_ins_tmp_debz_5
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "Ins adep200_debz_5"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

#end add-point
 
{</section>}
 
