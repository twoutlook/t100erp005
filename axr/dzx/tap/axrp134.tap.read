<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="axrp134" std_prog="axrp134" erpver="1.0" module="AXR" ver="6" env="s" zone="t10prd" booking="N" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="W" status="u"/>
    <free_style value="N" status="u"/>
    <start_arg value="" status="u"/>
  </other>
  <point name="function.axrp134_def" order="1" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_def()
   DEFINE l_sql         STRING
   DEFINE l_xrcasite    LIKE xrca_t.xrcasite
   DEFINE l_success     LIKE type_t.chr1
   DEFINE l_cnt         LIKE type_t.num5
   DEFINE l_ooefl003    LIKE ooefl_t.ooefl003

   IF cl_null(g_xrca_m.xrcasite) OR cl_null(g_xrca_m.xrcald) THEN
      #帳務中心
      #取得預設的帳務中心,因新增階段的時候,並不會知道site,所以以登入人員做為依據
      CALL s_fin_get_account_center('',g_user,'3',g_today) RETURNING l_success,g_xrca_m.xrcasite,g_errno
      CALL s_desc_get_department_desc(g_xrca_m.xrcasite) RETURNING g_xrca_m.xrcasite_desc
      #該帳務中心與帳別無法勾稽到,以登入人員g_user取得預設帳別/法人
      IF l_success THEN
         CALL s_fin_ld_carry('',g_user) RETURNING l_success,g_xrca_m.xrcald,g_xrca_m.xrcacomp,g_errno
         CALL s_fin_account_center_with_ld_chk(g_xrca_m.xrcasite,g_xrca_m.xrcald,g_user,'3','N','',g_today) RETURNING l_success,g_errno
      END IF
       
      #若取不出資料,則不預設帳別
      IF NOT l_success THEN
         LET g_xrca_m.xrcald   = ''
         LET g_xrca_m.xrcacomp = ''
      END IF
      CALL s_axrt300_xrca_ref('xrcald',g_xrca_m.xrcald,'','') RETURNING l_success,g_xrca_m.xrcald_desc
      SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_xrca_m.xrcald
      CALL s_axrt300_xrca_ref('xrcasite',g_xrca_m.xrcasite,'','') RETURNING l_success,g_xrca_m.xrcasite_desc
      CALL s_axrt300_xrca_ref('xrcasite',g_xrca_m.xrcacomp,'','') RETURNING l_success,l_ooefl003
      LET g_xrca_m.xrcacomp = g_xrca_m.xrcacomp,'(',l_ooefl003,')'
      DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc,
                      g_xrca_m.xrcald,  g_xrca_m.xrcald_desc,
                      g_xrca_m.xrcacomp
   END IF

   IF cl_null(g_xrca_m.comb1)  THEN LET g_xrca_m.comb1 = '1' END IF
   IF cl_null(g_xrca_m.check1) THEN LET g_xrca_m.check1= 'N' END IF
   DISPLAY BY NAME g_xrca_m.comb1,g_xrca_m.check1

END FUNCTION]]>
  </point>
  <point name="function.axrp134_create_tmp" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_create_tmp()
   DEFINE r_success         LIKE type_t.chr1

   LET r_success = 'Y'

   DROP TABLE axrp134_xmdk_tmp;
   CREATE TEMP TABLE axrp134_xmdk_tmp (
      xmdldocno     LIKE xmdl_t.xmdldocno,
      xmdlseq       LIKE xmdl_t.xmdlseq,
      xmdk0171      LIKE xmdk_t.xmdk017,
      xmdl048       LIKE xmdl_t.xmdl048,
      xmdl049       LIKE xmdl_t.xmdl049,
      xrcb007       LIKE xrcb_t.xrcb007,
      xrcb103       LIKE xrcb_t.xrcb103,
      xrcb105       LIKE xrcb_t.xrcb105
   );

   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'create'
      LET g_errparam.popup = TRUE
      CALL cl_err()

      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION]]>
  </point>
  <point name="function.axrp134_s01" order="3" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_s01()
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_ooef004         LIKE ooef_t.ooef004
   DEFINE l_oobn003         LIKE oobn_t.oobn003
   DEFINE l_slip            LIKE ooba_t.ooba002
   DEFINE l_s_fin_3007      LIKE type_t.chr20
   DEFINE l_s_fin_2011      LIKE type_t.chr20
   DEFINE l_s_bas_0012      LIKE type_t.chr20
   DEFINE l_s_bas_0011      LIKE type_t.chr20
   DEFINE l_sql             STRING
   DEFINE l_xmdk            RECORD LIKE xmdk_t.*
   DEFINE l_xmdl            RECORD LIKE xmdl_t.*
   DEFINE l_xmdk001         LIKE xmdk_t.xmdk001
   DEFINE l_xmdk042         LIKE xmdk_t.xmdk042
   DEFINE l_xmdk043         LIKE xmdk_t.xmdk043
   DEFINE l_xmdl001         LIKE xmdl_t.xmdl001
   DEFINE li_idx            LIKE type_t.num5
   #add--2015/05/08 By shiun--(S)
   DEFINE l_success_1       LIKE type_t.num5
   DEFINE l_oofg_return     DYNAMIC ARRAY OF RECORD
                    oofg019     LIKE oofg_t.oofg019,   #field
                    oofg020     LIKE oofg_t.oofg020    #value
                            END RECORD
   #add--2015/05/08 By shiun--(E)
   
   OPEN WINDOW w_axrp134_s01 WITH FORM cl_ap_formpath("axr",'axrp134_s01')

      CALL cl_set_combo_scc("comb1",8325)

      IF g_lang = 'zh_CN' THEN
         CALL cl_set_comp_att_text('lbl_comb1','红字发票开立')
      END IF

      LET g_conditions.xrcasite = g_xrca_m.xrcasite
      LET g_conditions.xrcasite_desc = g_xrca_m.xrcasite_desc
      LET g_conditions.xrcald = g_xrca_m.xrcald
      LET g_conditions.xrcald_desc = g_xrca_m.xrcald_desc
      LET g_conditions.xrcacomp = g_xrca_m.xrcacomp
      LET g_conditions.comb1 = g_xrca_m.comb1
      LET g_conditions.comb2 = '0'
      LET g_conditions.check1 = 'Y'
      LET g_conditions.xrcadocdt = NULL
      CALL cl_set_comp_entry('xrcadocdt',FALSE)
      LET g_conditions.check2 = 'Y'
      IF g_conditions.check2 = 'Y' THEN
         LET g_conditions.xrca007 = NULL
         CALL cl_set_comp_entry('xrca007',FALSE)
      ELSE
         CALL cl_set_comp_entry('xrca007',TRUE)
      END IF
      #[帳款單別xrcadocno]是否須走簽流程? (此判別式尚未定,預留)
      LET g_conditions.check3 = 'Y'
      
      LET g_conditions.xrca003 = g_user
      CALL s_axrt300_xrca_ref('xrca003',g_user,'','') RETURNING l_success,g_conditions.xrca003_desc
      DISPLAY BY NAME g_conditions.xrcasite,g_conditions.xrcasite_desc
      DISPLAY BY NAME g_conditions.xrcald,g_conditions.xrcald_desc
      DISPLAY BY NAME g_conditions.xrcacomp,g_conditions.comb1
      DISPLAY BY NAME g_conditions.comb2
      DISPLAY BY NAME g_conditions.xrcadocdt,g_conditions.check1
      DISPLAY BY NAME g_conditions.check2,g_conditions.check3
      DISPLAY BY NAME g_conditions.xrca003,g_conditions.xrca003_desc

      CALL s_aooi200_fin_get_slip(g_detail_d[1].xmdldocno) RETURNING l_success,l_slip
      SELECT ooef004 INTO l_ooef004 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = g_glaa.glaacomp
      LET l_sql = " SELECT oobn003  FROM oobm_t,oobn_t ",
                  "  WHERE oobment = oobnent ",
                  "    AND oobm001 = oobn001 ",
                  "    AND oobment = '",g_enterprise,"'",
                  "    AND oobm002 = '",l_ooef004,"'",
                  "    AND oobn002 = '",l_slip,"'"
      PREPARE axrp134_oobn_pre FROM l_sql
      DECLARE axrp134_oobn_cur CURSOR FOR axrp134_oobn_pre
      LET l_oobn003 = ''
      LET g_conditions.xrcadocno = ''
      FOREACH axrp134_oobn_cur INTO l_oobn003
         IF NOT cl_null(l_oobn003) THEN
            CALL s_fin_get_doc_para(g_conditions.xrcald,g_glaa.glaacomp,l_oobn003,"S-FIN-2011") RETURNING l_s_fin_2011
            IF cl_null(g_conditions.xrcadocno) THEN
               IF l_s_fin_2011 <> '02' AND g_conditions.comb1 = '1' THEN
                  LET g_conditions.xrcadocno = l_oobn003
               END IF
               
               IF l_s_fin_2011 <> '22' AND g_conditions.comb1 = '2' THEN
                  LET g_conditions.xrcadocno = l_oobn003
               END IF
            END IF
         END IF
         IF NOT cl_null(g_conditions.xrcadocno) THEN
            EXIT FOREACH
         END IF
      END FOREACH
      CALL s_aooi200_fin_get_slip_desc(g_conditions.xrcadocno) RETURNING g_conditions.xrcadocno_desc
      DISPLAY g_conditions.xrcadocno_desc TO xrcadocno_desc

      INPUT BY NAME g_conditions.comb2,g_conditions.xrcadocno,g_conditions.xrca003,
                    g_conditions.check1,g_conditions.check2,g_conditions.check3,g_conditions.xrcadocdt,
                    g_conditions.xrca007,g_conditions.xrca063
         ATTRIBUTE(WITHOUT DEFAULTS)

         BEFORE INPUT

         AFTER FIELD xrcadocno
            IF NOT cl_null(g_conditions.xrcadocno) THEN
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_glaa.glaa024
               LET g_chkparam.arg2 = g_conditions.xrcadocno
               IF NOT cl_chk_exist("v_oobx001_1") THEN
                  LET g_conditions.xrcadocno = ''
                  NEXT FIELD CURRENT
               END IF
               CALL s_fin_get_doc_para(g_conditions.xrcald,g_glaa.glaacomp,g_conditions.xrcadocno,"S-FIN-2011")
                  RETURNING l_s_fin_2011
               IF (g_conditions.comb1 = '1' AND l_s_fin_2011 <> '02') OR (g_conditions.comb1 = '2' AND l_s_fin_2011 <> '22') THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'axr-00124'
                  LET g_errparam.extend = g_conditions.xrcadocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_conditions.xrcadocno = ''
                  NEXT FIELD CURRENT
               END IF
            END IF
            CALL s_aooi200_fin_get_slip_desc(g_conditions.xrcadocno) RETURNING g_conditions.xrcadocno_desc
            DISPLAY g_conditions.xrcadocno_desc TO xrcadocno_desc
 
         ON CHANGE check1
            IF NOT cl_null(g_conditions.check1) THEN
               IF g_conditions.check1 = 'Y' THEN
                  LET g_conditions.xrcadocdt = NULL
                  CALL cl_set_comp_entry('xrcadocdt',FALSE)
               ELSE
                  LET g_conditions.xrcadocdt = g_today
                  CALL cl_set_comp_entry('xrcadocdt',TRUE)
               END IF
            END IF
            DISPLAY BY NAME g_conditions.xrcadocdt
 
         AFTER FIELD xrcadocdt
            IF NOT cl_null(g_conditions.xrcadocdt) THEN
               CALL cl_get_para(g_enterprise,'','S-FIN-3007') RETURNING l_s_fin_3007
               IF l_s_fin_3007 > g_conditions.xrcadocdt THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'axr-00125'
                  LET g_errparam.extend = g_conditions.xrcadocdt
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_conditions.xrcadocdt = g_today
                  NEXT FIELD CURRENT
               END IF
            END IF
 
         ON CHANGE check2
            IF NOT cl_null(g_conditions.check2) THEN
               IF g_conditions.check2 = 'Y' THEN
                  LET g_conditions.xrca007 = NULL
                  LET g_conditions.xrca007_desc = NULL
                  CALL cl_set_comp_entry('xrca007',FALSE)
               ELSE
                  CALL cl_set_comp_entry('xrca007',TRUE)
               END IF
            END IF
            DISPLAY BY NAME g_conditions.xrca007
 
         AFTER FIELD xrca007
            IF NOT cl_null(g_conditions.xrca007) THEN
                INITIALIZE g_chkparam.* TO NULL
                LET g_chkparam.arg1 = g_conditions.xrca007
                IF NOT cl_chk_exist("v_oocq002_3111") THEN
                   LET g_conditions.xrca007 = ''
                   CALL s_axrt300_xrca_ref('xrca007',g_conditions.xrca007,'','') RETURNING l_success,g_conditions.xrca007_desc
                   NEXT FIELD CURRENT
                END IF
            END IF
 
         ON ACTION controlp INFIELD xrcadocno
 			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
 		   	LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_conditions.xrcadocno      #給予default值
            #給予arg
            SELECT ooef004 INTO l_ooef004 from ooef_t where ooefent = g_enterprise AND ooef001 = g_glaa.glaacomp
            LET g_qryparam.arg1 = g_glaa.glaa024
            LET g_qryparam.arg2 = "axrt300"
            LET g_qryparam.where = " oobx004 IN ('axrt320','axrt340')"
            CALL q_ooba002_3()                                       #呼叫開窗
            LET g_conditions.xrcadocno = g_qryparam.return1       #將開窗取得的值回傳到變數
            CALL s_aooi200_fin_get_slip_desc(g_conditions.xrcadocno) RETURNING g_conditions.xrcadocno_desc
            DISPLAY g_conditions.xrcadocno TO xrcadocno        #顯示到畫面上
            DISPLAY g_conditions.xrcadocno_desc TO xrcadocno_desc        #顯示到畫面上
            NEXT FIELD xrcadocno                                  #返回原欄位
 
         ON ACTION controlp INFIELD xrca007
 	   		INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
 			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_conditions.xrca007           #給予default值
            #給予arg
            LET g_qryparam.arg1 = "3111"
            CALL q_oocq002()                                         #呼叫開窗
            LET g_conditions.xrca007 = g_qryparam.return1            #將開窗取得的值回傳到變數
            CALL s_axrt300_xrca_ref('xrca007',g_conditions.xrca007,'','') RETURNING l_success,g_conditions.xrca007_desc
            DISPLAY g_conditions.xrca007 TO xrca007                  #顯示到畫面上
            DISPLAY g_conditions.xrca007_desc TO xrca007_desc        #顯示到畫面上
            NEXT FIELD xrca007                                       #返回原欄位
 
         ON ACTION controlp INFIELD xrca063
#            CALL s_aooi390('14') RETURNING g_success,g_conditions.xrca063   #mark--2015/05/08 By shiun
            CALL s_aooi390_gen('14') RETURNING l_success_1,g_conditions.xrca063,l_oofg_return   #add--2015/05/08 By shiun
            DISPLAY BY NAME g_conditions.xrca063
            NEXT FIELD xrca063
 
         ON ACTION accept
            ACCEPT INPUT
 
         ON ACTION cancel
            LET INT_FLAG = TRUE
            EXIT INPUT
 
         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT INPUT
 
         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT INPUT

      END INPUT

   CLOSE WINDOW w_axrp134_s01

   IF INT_FLAG = 0 THEN
      CALL axrp134_create_tmp() RETURNING l_success

      FOR li_idx = 1 TO g_detail_d.getLength()
         IF g_detail_d[li_idx].sel = 'N' THEN CONTINUE FOR END IF

         SELECT * INTO l_xmdk.* FROM xmdk_t WHERE xmdkent = g_enterprise AND xmdkdocno = g_detail_d[li_idx].xmdldocno
         SELECT * INTO l_xmdl.* FROM xmdl_t WHERE xmdlent = g_enterprise AND xmdldocno = g_detail_d[li_idx].xmdldocno
         CASE
            WHEN l_xmdk.xmdk043 = '1'   #依訂單日匯率
               IF NOT cl_null(l_xmdl.xmdl003) THEN
                  SELECT xmda016 INTO l_xmdk.xmdk017 FROM xmda_t WHERE xmdadocno = l_xmdl.xmdl003
               END IF
            WHEN l_xmdk.xmdk043 = '2'   #依Invoice日匯率
               SELECT xmdo017 INTO l_xmdk.xmdk017 FROM xmdo_t 
 		          WHERE (xmdo005 = l_xmdl.xmdldocno OR xmdo005 = l_xmdl.xmdl001) AND xmdostus='Y'
            WHEN l_xmdk.xmdk043 = '3'   #依出貨日匯率
               #---
            WHEN l_xmdk.xmdk043 = '4'   #依立帳日匯率
               CALL cl_get_para(g_enterprise,l_xmdl.xmdlsite,'S-BAS-0011') RETURNING l_s_bas_0011
               CALL cl_get_para(g_enterprise,l_xmdl.xmdlsite,'S-BAS-0012') RETURNING l_s_bas_0012
               IF l_xmdk.xmdk042 = '1' THEN LET l_s_bas_0011 = l_s_bas_0012 END IF
               IF g_conditions.check1 = 'Y' THEN
                  CALL s_aooi160_get_exrate('2',g_glaa.glaald,l_xmdk.xmdk001,l_xmdk.xmdk016,g_glaa.glaa001,0,l_s_bas_0011)
                     RETURNING l_xmdk.xmdk017
               ELSE
                  CALL s_aooi160_get_exrate('2',g_glaa.glaald,g_conditions.xrcadocdt,l_xmdk.xmdk016,g_glaa.glaa001,0,l_s_bas_0011)
                     RETURNING l_xmdk.xmdk017
               END IF
            WHEN l_xmdk.xmdk043 = '5'   #依立帳日月平均匯率
               #因為月平均匯率取得方式AOO模組正在開發中
               #所以暫用日平均匯率代替取值
               #By zhangwei 2014/06/04
               CALL cl_get_para(g_enterprise,l_xmdl.xmdlsite,'S-BAS-0011') RETURNING l_s_bas_0011
               CALL cl_get_para(g_enterprise,l_xmdl.xmdlsite,'S-BAS-0012') RETURNING l_s_bas_0012
               IF l_xmdk.xmdk042 = '1' THEN LET l_s_bas_0011 = l_s_bas_0012 END IF
               IF g_conditions.check1 = 'Y' THEN
                  CALL s_aooi160_get_exrate('2',g_glaa.glaald,l_xmdk.xmdk001,l_xmdk.xmdk016,g_glaa.glaa001,0,l_s_bas_0011)
                     RETURNING l_xmdk.xmdk017
               ELSE
                  CALL s_aooi160_get_exrate('2',g_glaa.glaald,g_conditions.xrcadocdt,l_xmdk.xmdk016,g_glaa.glaa001,0,l_s_bas_0011)
                     RETURNING l_xmdk.xmdk017
               END IF 
 
         END CASE
 
         INSERT INTO axrp134_xmdk_tmp(xmdldocno,xmdlseq,xmdk0171,xmdl048,xmdl049,xrcb007,xrcb103,xrcb105) 
            VALUES(l_xmdk.xmdkdocno,l_xmdl.xmdlseq,l_xmdk.xmdk017,l_xmdl.xmdl048,l_xmdl.xmdl049,
                   g_detail_d[li_idx].xrcb007,g_detail_d[li_idx].xrcb103,g_detail_d[li_idx].xrcb105)

      END FOR

      CALL s_axrt300_create_tmp()

      CALL s_transaction_begin()
      CALL axrp134_get_ar()
      CALL s_transaction_end('Y','1')
   ELSE
      LET INT_FLAG = 0
      RETURN
   END IF

END FUNCTION]]>
  </point>
  <point name="function.axrp134_get_ar" order="4" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_get_ar()
   DEFINE l_sql         STRING
   DEFINE l_str         STRING
   DEFINE l_orders      STRING
   DEFINE l_order       LIKE type_t.chr200
   DEFINE l_order_t     LIKE type_t.chr200
   DEFINE l_xmdk0001    LIKE type_t.chr200
   DEFINE l_xmdldocno   LIKE xmdl_t.xmdldocno
   DEFINE l_xmdlseq     LIKE xmdl_t.xmdlseq
   DEFINE l_xrcb007     LIKE xrcb_t.xrcb007
   DEFINE l_xmdk        RECORD LIKE xmdk_t.*
   DEFINE l_xmdl        RECORD LIKE xmdl_t.*
   DEFINE l_success     LIKE type_t.chr1
   DEFINE l_xrca001     LIKE xrca_t.xrca001
   DEFINE l_slip        LIKE xrca_t.xrcadocno
   DEFINE l_xmdk008     LIKE xmdk_t.xmdk008
   DEFINE l_pmaa071     LIKE pmaa_t.pmaa071
   DEFINE l_xmdk016     LIKE xmdk_t.xmdk016
   DEFINE l_xmdk017     LIKE xmdk_t.xmdk017
   DEFINE l_xmdk010     LIKE xmdk_t.xmdk010
   DEFINE l_xmdk012     LIKE xmdk_t.xmdk012
   DEFINE l_xrcadocno   LIKE xrca_t.xrcadocno
   DEFINE l_xrca        RECORD
          xrca005       LIKE xrca_t.xrca005,
          xrca006       LIKE xrca_t.xrca006,
          xrca007       LIKE xrca_t.xrca007,
          xrca008       LIKE xrca_t.xrca008,
          xrca009       LIKE xrca_t.xrca009,
          xrca010       LIKE xrca_t.xrca010,
          xrca011       LIKE xrca_t.xrca011,
          xrca012       LIKE xrca_t.xrca012,
          xrca013       LIKE xrca_t.xrca013,
          xrca014       LIKE xrca_t.xrca014,
          xrca015       LIKE xrca_t.xrca015,
          xrca046       LIKE xrca_t.xrca046,
          xrca058       LIKE xrca_t.xrca058,
          xrca061       LIKE xrca_t.xrca061,
          xrca100       LIKE xrca_t.xrca100,
          xrca101       LIKE xrca_t.xrca101,
          xrca121       LIKE xrca_t.xrca121,
          xrca131       LIKE xrca_t.xrca131
                        END RECORD
DEFINE r_xrca           RECORD
          xrca103          LIKE xrca_t.xrca103,
          xrca104          LIKE xrca_t.xrca104,
          xrca108          LIKE xrca_t.xrca108,
          xrca113          LIKE xrca_t.xrca113,
          xrca114          LIKE xrca_t.xrca114,
          xrca118          LIKE xrca_t.xrca118,
          xrca123          LIKE xrca_t.xrca123,
          xrca128          LIKE xrca_t.xrca124,
          xrca124          LIKE xrca_t.xrca128,
          xrca133          LIKE xrca_t.xrca133,
          xrca134          LIKE xrca_t.xrca134,
          xrca138          LIKE xrca_t.xrca138
                         END RECORD
   DEFINE l_oodbl004     LIKE oodbl_t.oodbl004
   DEFINE l_oodb011      LIKE oodb_t.oodb011
   DEFINE l_prog         LIKE gzza_t.gzza001
   DEFINE l_cnt          LIKE type_t.chr1
   DEFINE l_s            LIKE type_t.chr1
   DEFINE l_xrca034      LIKE xrca_t.xrca034
   DEFINE l_xrca035      LIKE xrca_t.xrca035
   DEFINE l_xrca036      LIKE xrca_t.xrca036
   DEFINE l_xrcb005      LIKE xrcb_t.xrcb005
   DEFINE l_xmdksite     LIKE xmdk_t.xmdksite
   DEFINE l_xmdk007      LIKE xmdk_t.xmdk007
   DEFINE l_xmdk003      LIKE xmdk_t.xmdk003
   DEFINE l_xmdl048      LIKE xmdl_t.xmdl048
   DEFINE l_xmdl049      LIKE xmdl_t.xmdl049
   DEFINE l_xrcb103      LIKE xrcb_t.xrcb103
   DEFINE l_xrcb105      LIKE xrcb_t.xrcb105
   DEFINE l_success_1    LIKE type_t.num5

   #STEP1.依照匯總條件將出貨單資料匯總、排序
   #STEP2.將資料插入xrca_t
   #STEP3.將出貨單資料插入xrcb_t、xrcd_t
   #STEP4.将单身金额回写至单头
   #STEP5.產生多帳期資料

   CALL s_axrt300_sel_ld(g_xrca_m.xrcald) RETURNING l_success,l_s

   LET l_str  = "xmdksite||xmdk007||xmdk008||xmdk016||xmdk0171||xmdk010||xmdk012"
   LET l_order= "xmdksite,xmdk007,xmdk008,xmdk016,xmdk0171,xmdk010,xmdk012,xmdldocno,xmdk003,xmdl048,xmdl049"
   CASE
      WHEN g_xrca_m.comb1 = '0'   #銷退單
         LET l_str  = l_str,"||xmdldocno"
      WHEN g_xrca_m.comb1 = '1'   #業務人員
         LET l_str  = l_str,"||xmdk003"
      WHEN g_xrca_m.comb1 = '2'   #發票號碼
         LET l_str  = l_str,"||xmdl048||xmdl049"
   END CASE

   LET l_sql = "SELECT ",l_order,",xmdlseq,xrcb007,xrcb103,xrcb105,",l_str," FROM axrp134_xmdk_tmp,xmdk_t",
               " WHERE xmdkdocno = xmdldocno                                                         ",
               " ORDER BY ",l_order
   PREPARE axrp134_xmdk_prep FROM l_sql
   DECLARE axrp134_xmdk_curs CURSOR FOR axrp134_xmdk_prep

   FOREACH axrp134_xmdk_curs INTO l_xmdksite,l_xmdk007,l_xmdk008,l_xmdk016,l_xmdk017,l_xmdk010,l_xmdk012,l_xmdldocno,
                                  l_xmdk003, l_xmdl048,l_xmdl049,l_xmdlseq,l_xrcb007,l_xrcb103,l_xrcb105,l_order
      SELECT * INTO l_xmdk.* FROM xmdk_t WHERE xmdkent = g_enterprise AND xmdkdocno = l_xmdldocno
      SELECT * INTO l_xmdl.* FROM xmdl_t WHERE xmdlent = g_enterprise AND xmdldocno = l_xmdldocno AND xmdlseq = l_xmdlseq
      IF g_conditions.check1 = 'Y' THEN LET g_conditions.xrcadocdt = l_xmdk.xmdk001 END IF
      LET l_prog = 'axmt600'
      IF cl_null(l_order_t) OR l_order_t <> l_order THEN
         CALL s_aooi200_fin_gen_docno(g_xrca_m.xrcald,g_glaa.glaa024,g_glaa.glaa003,g_conditions.xrcadocno,g_conditions.xrcadocdt,'axrt340')
            RETURNING l_success,l_xrcadocno
         IF g_conditions.comb1 = '1' THEN LET l_xrca001 = '02' ELSE LET l_xrca001 = '22' END IF

         LET l_cnt = 0 
         SELECT COUNT(*) INTO l_cnt FROM xrcb_t
          WHERE xrcbent = g_enterprise AND xrcbld = g_xrca.xrcald AND xrcbdocno = g_xrca.xrcadocno 
         IF l_cnt > 0 THEN  
            SELECT SUM(xrcb103),SUM(xrcb104),SUM(xrcb113),SUM(xrcb114),SUM(xrcb123),SUM(xrcb124),SUM(xrcb133),SUM(xrcb134)  
              INTO g_xrca.xrca103,g_xrca.xrca104,g_xrca.xrca113,g_xrca.xrca114, 
                   g_xrca.xrca123,g_xrca.xrca124,g_xrca.xrca133,g_xrca.xrca134     
              FROM xrcb_t
             WHERE xrcbent = g_enterprise AND xrcbld = g_xrca.xrcald AND xrcbdocno = g_xrca.xrcadocno
            IF cl_null(g_xrca.xrca103) THEN LET g_xrca.xrca103 = 0 END IF 
            IF cl_null(g_xrca.xrca104) THEN LET g_xrca.xrca104 = 0 END IF 
            IF cl_null(g_xrca.xrca113) THEN LET g_xrca.xrca113 = 0 END IF 
            IF cl_null(g_xrca.xrca114) THEN LET g_xrca.xrca114 = 0 END IF
            IF cl_null(g_xrca.xrca123) THEN LET g_xrca.xrca123 = 0 END IF 
            IF cl_null(g_xrca.xrca124) THEN LET g_xrca.xrca124 = 0 END IF
            IF cl_null(g_xrca.xrca133) THEN LET g_xrca.xrca133 = 0 END IF 
            IF cl_null(g_xrca.xrca134) THEN LET g_xrca.xrca134 = 0 END IF
            UPDATE xrca_t SET (xrca103,xrca104,xrca113,xrca114,xrca123,xrca124,xrca133,xrca134) = (g_xrca.xrca103,g_xrca.xrca104,g_xrca.xrca113,g_xrca.xrca114,g_xrca.xrca123,g_xrca.xrca124,g_xrca.xrca133,g_xrca.xrca134) 
             WHERE xrcaent = g_enterprise AND xrcald = g_xrca.xrcald AND xrcadocno = g_xrca.xrcadocno
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "xrca_t"
               LET g_errparam.popup = FALSE
               CALL cl_err()

            END IF
            CALL s_axrt300_installments(g_xrca.xrcald,g_xrca.xrcadocno) RETURNING l_success
            CALL s_axrt300_xrca_upd(g_xrca.xrcald,g_xrca.xrcadocno) RETURNING l_success
         END IF

         INITIALIZE g_xrca TO NULL

         LET g_xrca.xrcaent   = g_enterprise
         LET g_xrca.xrcaownid = g_user
         LET g_xrca.xrcaowndp = g_dept
         LET g_xrca.xrcacrtid = g_user
         LET g_xrca.xrcacrtdp = g_dept
         LET g_xrca.xrcacrtdt = g_today
         LET g_xrca.xrcastus  = 'N'
         LET g_xrca.xrcacomp  = g_glaa.glaacomp
         LET g_xrca.xrcald    = g_xrca_m.xrcald
         LET g_xrca.xrcadocno = l_xrcadocno
         LET g_xrca.xrcadocdt = g_conditions.xrcadocdt
         LET g_xrca.xrca001   = l_xrca001
         LET g_xrca.xrcasite  = g_xrca_m.xrcasite
         LET g_xrca.xrca003   = g_user
         LET g_xrca.xrca004   = l_xmdk008
         CALL axrp134_xrca004_ref() RETURNING l_xrca.*
         LET g_xrca.xrca005   = l_xrca.xrca005
         LET g_xrca.xrca006   = l_xrca.xrca006
         LET g_xrca.xrca007   = l_xrca.xrca007

         SELECT glab005 INTO l_xrca035 FROM glab_t 
          WHERE glabld = g_xrca_m.xrcald 
            AND glabent = g_enterprise
            AND glab002 = l_xrca.xrca007   # 帳款類別
            AND glab001 = '13'             # 應收帳務類型科目設定
           AND glab003 = '8304_01'
         
         SELECT glab005 INTO l_xrca036 FROM glab_t 
          WHERE glabld = g_xrca_m.xrcald 
            AND glabent = g_enterprise
            AND glab002 = l_xrca.xrca007   # 帳款類別
            AND glab001 = '13'             # 應收帳務類型科目設定
           AND glab003 = '8304_22'

         SELECT ooeg004 INTO l_xrca034 FROM ooeg_t WHERE ooegent = g_enterprise AND ooeg001 = l_xrca.xrca015

         LET g_xrca.xrca008   = l_xmdk010
         LET g_xrca.xrca009   = l_xrca.xrca009
         LET g_xrca.xrca010   = l_xrca.xrca010
         LET g_xrca.xrca011   = l_xmdk012
         CALL s_tax_chk(g_xrca.xrcasite,g_xrca.xrca011)
            RETURNING l_success,l_oodbl004,l_xrca.xrca013,l_xrca.xrca012,l_oodb011
         LET g_xrca.xrca012   = l_xrca.xrca012
         LET g_xrca.xrca013   = l_xrca.xrca013
         LET g_xrca.xrca014   = l_xrca.xrca014
         LET g_xrca.xrca015   = l_xrca.xrca015
         LET g_xrca.xrca016   = ''
         LET g_xrca.xrca017   = 0
         LET g_xrca.xrca018   = ''
         LET g_xrca.xrca019   = ''
         LET g_xrca.xrca020   = 'N'
         LET g_xrca.xrca021   = ''
         LET g_xrca.xrca022   = ''
         LET g_xrca.xrca023   = ''
         LET g_xrca.xrca024   = ''
         LET g_xrca.xrca025   = ''
         LET g_xrca.xrca026   = ''
         LET g_xrca.xrca028   = ''
         LET g_xrca.xrca029   = 1
         LET g_xrca.xrca030   = 0
         LET g_xrca.xrca031   = 0
         LET g_xrca.xrca032   = 0
         LET g_xrca.xrca033   = ''
         LET g_xrca.xrca034   = l_xrca034
         LET g_xrca.xrca035   = l_xrca035
         LET g_xrca.xrca036   = l_xrca036
         LET g_xrca.xrca037   = 'N'
         LET g_xrca.xrca038   = ''
         LET g_xrca.xrca039   = 0
         LET g_xrca.xrca040   = 'N'
         LET g_xrca.xrca041   = ''
         LET g_xrca.xrca042   = ''
         LET g_xrca.xrca043   = ''
         LET g_xrca.xrca044   = 0
         LET g_xrca.xrca045   = ''
         LET g_xrca.xrca046   = l_xrca.xrca046
         LET g_xrca.xrca047   = ''
         LET g_xrca.xrca048   = ''
         LET g_xrca.xrca049   = ''
         LET g_xrca.xrca050   = ''
         LET g_xrca.xrca051   = ''
         LET g_xrca.xrca052   = 0
         LET g_xrca.xrca053   = ''
         LET g_xrca.xrca054   = ''
         LET g_xrca.xrca055   = ''
         LET g_xrca.xrca056   = ''
         LET g_xrca.xrca057   = ''
         LET g_xrca.xrca058   = l_xrca.xrca058
         LET g_xrca.xrca059   = ''
         LET g_xrca.xrca060   = 1
         LET g_xrca.xrca061   = l_xrca.xrca061
         LET g_xrca.xrca062   = '1'
         LET g_xrca.xrca063   = ''
         LET g_xrca.xrca100   = l_xmdk016
         LET g_xrca.xrca101   = l_xmdk017
         LET g_xrca.xrca103   = 0
         LET g_xrca.xrca104   = 0
         LET g_xrca.xrca106   = 0
         LET g_xrca.xrca107   = 0
         LET g_xrca.xrca108   = 0
         LET g_xrca.xrca113   = 0
         LET g_xrca.xrca114   = 0
         LET g_xrca.xrca116   = 0
         LET g_xrca.xrca117   = 0
         LET g_xrca.xrca118   = 0
         LET g_xrca.xrca120   = 0
         LET g_xrca.xrca121   = l_xrca.xrca121
         LET g_xrca.xrca123   = 0
         LET g_xrca.xrca124   = 0
         LET g_xrca.xrca126   = 0
         LET g_xrca.xrca127   = 0
         LET g_xrca.xrca128   = 0
         LET g_xrca.xrca130   = 0
         LET g_xrca.xrca131   = l_xrca.xrca131
         LET g_xrca.xrca133   = 0
         LET g_xrca.xrca134   = 0
         LET g_xrca.xrca136   = 0
         LET g_xrca.xrca137   = 0
         LET g_xrca.xrca138   = 0
         
         CALL s_aooi390_oofi_upd('14',g_xrca.xrca063) RETURNING l_success_1  #add--2015/05/08 By shiun 增加編碼功能
         INSERT INTO xrca_t VALUES (g_xrca.*)

         LET g_xrcb.xrcbseq = 0

      END IF

      SELECT imaal003 INTO l_xrcb005 FROM imaal_t
       WHERE imaalent = g_enterprise AND imaal002 = g_lang
         AND imaal001 = l_xmdl.xmdl008

      LET g_xrcb.xrcbent = g_enterprise
      LET g_xrcb.xrcbld  = g_xrca_m.xrcald
      LET g_xrcb.xrcbdocno = g_xrca.xrcadocno
      LET g_xrcb.xrcbseq = g_xrcb.xrcbseq + 1
      LET g_xrcb.xrcbsite= g_xrca_m.xrcasite
      LET g_xrcb.xrcborga= l_xmdk.xmdksite
      LET g_xrcb.xrcb001 = l_prog
      LET g_xrcb.xrcb002 = l_xmdl.xmdldocno
      LET g_xrcb.xrcb003 = l_xmdl.xmdlseq
      LET g_xrcb.xrcb004 = l_xmdl.xmdl008
      LET g_xrcb.xrcb005 = l_xrcb005
      LET g_xrcb.xrcb006 = l_xmdl.xmdl017
      LET g_xrcb.xrcb007 = l_xrcb007
      LET g_xrcb.xrcb008 = l_xmdl.xmdl003
      LET g_xrcb.xrcb009 = l_xmdl.xmdl004
      LET g_xrcb.xrcblegl= g_xrca.xrcacomp
      LET g_xrcb.xrcb010 = g_xrca.xrca015
      LET g_xrcb.xrcb011 = g_xrca.xrca034
      LET g_xrcb.xrcb012 = ''
      LET g_xrcb.xrcb013 = ''
      LET g_xrcb.xrcb014 = ''
      LET g_xrcb.xrcb015 = ''
      LET g_xrcb.xrcb016 = ''
      LET g_xrcb.xrcb017 = ''
      LET g_xrcb.xrcb018 = ''
      LET g_xrcb.xrcb019 = ''
      LET g_xrcb.xrcb020 = l_xmdl.xmdl025
      LET g_xrcb.xrcb021 = ''
      LET g_xrcb.xrcb022 = -1
      LET g_xrcb.xrcb024 = ''
      LET g_xrcb.xrcb023 = 'N'
      LET g_xrcb.xrcb025 = ''
      LET g_xrcb.xrcb026 = ''
      LET g_xrcb.xrcb027 = ''
      LET g_xrcb.xrcb028 = ''
      LET g_xrcb.xrcb029 = ''
      LET g_xrcb.xrcb030 = 0
      LET g_xrcb.xrcb100 = g_xrca.xrca100
      LET g_xrcb.xrcb101 = l_xmdl.xmdl024
      CALL s_axrt300_exrate(g_glaa.glaa002,g_xrca.xrcadocdt,g_xrca.xrca100,g_glaa.glaa001,g_xrcb.xrcb101,g_xrca.xrca101,g_glaa.glaacomp)
         RETURNING l_success,g_xrcb.xrcb111
      CALL s_tax_ins(g_xrca.xrcadocno,g_xrcb.xrcbseq,0,g_xrcb.xrcborga,
                     g_xrcb.xrcb007*g_xrcb.xrcb101,g_xrcb.xrcb020,
                     g_xrcb.xrcb007,g_xrcb.xrcb100,g_xrca.xrca101,g_xrca.xrcald,g_xrca.xrca121,g_xrca.xrca131)
         RETURNING g_xrcb.xrcb103,g_xrcb.xrcb104,g_xrcb.xrcb105,
                   g_xrcb.xrcb113,g_xrcb.xrcb114,g_xrcb.xrcb115,
                   g_xrcb.xrcb123,g_xrcb.xrcb124,g_xrcb.xrcb125,
                   g_xrcb.xrcb133,g_xrcb.xrcb134,g_xrcb.xrcb135
      LET g_xrcb.xrcb106 = 0
      LET g_xrcb.xrcb116 = 0
      LET g_xrcb.xrcb117 = 0
      LET g_xrcb.xrcb118 = g_xrcb.xrcb113
      LET g_xrcb.xrcb119 = g_xrcb.xrcb115
      LET g_xrcb.xrcb126 = 0
      LET g_xrcb.xrcb136 = 0

      INSERT INTO xrcb_t VALUES (g_xrcb.*)

      LET l_order_t = l_order

   END FOREACH

   LET l_cnt = 0 
   SELECT COUNT(*) INTO l_cnt FROM xrcb_t
    WHERE xrcbent = g_enterprise AND xrcbld = g_xrca.xrcald AND xrcbdocno = g_xrca.xrcadocno 
   IF l_cnt > 0 THEN  
      SELECT SUM(xrcb103),SUM(xrcb104),SUM(xrcb113),SUM(xrcb114),SUM(xrcb123),SUM(xrcb124),SUM(xrcb133),SUM(xrcb134)  
        INTO g_xrca.xrca103,g_xrca.xrca104,g_xrca.xrca113,g_xrca.xrca114, 
             g_xrca.xrca123,g_xrca.xrca124,g_xrca.xrca133,g_xrca.xrca134     
        FROM xrcb_t
       WHERE xrcbent = g_enterprise AND xrcbld = g_xrca.xrcald AND xrcbdocno = g_xrca.xrcadocno
      IF cl_null(g_xrca.xrca103) THEN LET g_xrca.xrca103 = 0 END IF 
      IF cl_null(g_xrca.xrca104) THEN LET g_xrca.xrca104 = 0 END IF 
      IF cl_null(g_xrca.xrca113) THEN LET g_xrca.xrca113 = 0 END IF 
      IF cl_null(g_xrca.xrca114) THEN LET g_xrca.xrca114 = 0 END IF
      IF cl_null(g_xrca.xrca123) THEN LET g_xrca.xrca123 = 0 END IF 
      IF cl_null(g_xrca.xrca124) THEN LET g_xrca.xrca124 = 0 END IF
      IF cl_null(g_xrca.xrca133) THEN LET g_xrca.xrca133 = 0 END IF 
      IF cl_null(g_xrca.xrca134) THEN LET g_xrca.xrca134 = 0 END IF
      UPDATE xrca_t SET (xrca103,xrca104,xrca113,xrca114,xrca123,xrca124,xrca133,xrca134) = (g_xrca.xrca103,g_xrca.xrca104,g_xrca.xrca113,g_xrca.xrca114,g_xrca.xrca123,g_xrca.xrca124,g_xrca.xrca133,g_xrca.xrca134) 
       WHERE xrcaent = g_enterprise AND xrcald = g_xrca.xrcald AND xrcadocno = g_xrca.xrcadocno
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "xrca_t"
               LET g_errparam.popup = FALSE
               CALL cl_err()

      END IF
      CALL s_axrt300_installments(g_xrca.xrcald,g_xrca.xrcadocno) RETURNING l_success 
      CALL s_axrt300_xrca_upd(g_xrca.xrcald,g_xrca.xrcadocno) RETURNING l_success
   END IF

END FUNCTION]]>
  </point>
  <point name="function.axrp134_upd_tmp" order="5" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_upd_tmp(p_chr)
   DEFINE p_chr       LIKE type_t.chr1
   DEFINE l_sql       STRING


   LET l_sql = "UPDATE axrp134_xmdk_tmp SET flag = '",p_chr,"' WHERE"

   CASE
      WHEN g_xrca_m.comb1 = '0'
         LET l_sql = l_sql," xmdldocno = '",g_detail_d[l_ac].xmdldocno,"'"
      WHEN g_xrca_m.comb1 = '1'
         IF cl_null(g_detail_d[l_ac].xmdl003) THEN LET g_detail_d[l_ac].xmdl003 = ' ' END IF
         LET l_sql = l_sql," xmdl003   = '",g_detail_d[l_ac].xmdl003  ,"'"
      WHEN g_xrca_m.comb1 = '2'
         IF cl_null(g_detail_d[l_ac].xmdk003) THEN LET g_detail_d[l_ac].xmdk003 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl017) THEN LET g_detail_d[l_ac].xmdl017 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl021) THEN LET g_detail_d[l_ac].xmdl021 = ' ' END IF
         LET l_sql = l_sql," xmdk003   = '",g_detail_d[l_ac].xmdk003  ,"'",
                       " AND xmdl017   = '",g_detail_d[l_ac].xmdl017  ,"'",
                       " AND xmdl021   = '",g_detail_d[l_ac].xmdl021  ,"'"
      WHEN g_xrca_m.comb1 = '3'
         IF cl_null(g_detail_d[l_ac].xmdk004) THEN LET g_detail_d[l_ac].xmdk004 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl017) THEN LET g_detail_d[l_ac].xmdl017 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl021) THEN LET g_detail_d[l_ac].xmdl021 = ' ' END IF
         LET l_sql = l_sql," xmdk004   = '",g_detail_d[l_ac].xmdk004  ,"'",
                       " AND xmdl017   = '",g_detail_d[l_ac].xmdl017  ,"'",
                       " AND xmdl021   = '",g_detail_d[l_ac].xmdl021  ,"'"
      WHEN g_xrca_m.comb1 = '4'
         IF cl_null(g_detail_d[l_ac].xmdl048_1) THEN LET g_detail_d[l_ac].xmdl048_1 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl049_1) THEN LET g_detail_d[l_ac].xmdl049_1 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl017) THEN LET g_detail_d[l_ac].xmdl017 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl021) THEN LET g_detail_d[l_ac].xmdl021 = ' ' END IF
         LET l_sql = l_sql," xmdl048   = '",g_detail_d[l_ac].xmdl048_1,"'",
                       " AND xmdl049   = '",g_detail_d[l_ac].xmdl049_1,"'",
                       " AND xmdl017   = '",g_detail_d[l_ac].xmdl017  ,"'",
                       " AND xmdl021   = '",g_detail_d[l_ac].xmdl021  ,"'"
      WHEN g_xrca_m.comb1 = '5'
         IF cl_null(g_detail_d[l_ac].xmdl008) THEN LET g_detail_d[l_ac].xmdl008 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl017) THEN LET g_detail_d[l_ac].xmdl017 = ' ' END IF
         IF cl_null(g_detail_d[l_ac].xmdl021) THEN LET g_detail_d[l_ac].xmdl021 = ' ' END IF
         LET l_sql = l_sql," xmdl008   = '",g_detail_d[l_ac].xmdl008  ,"'",
                       " AND xmdl017   = '",g_detail_d[l_ac].xmdl017  ,"'",
                       " AND xmdl021   = '",g_detail_d[l_ac].xmdl021  ,"'"
   END CASE

   PREPARE axrp134_upd_tmp FROM l_sql
   EXECUTE axrp134_upd_tmp

END FUNCTION]]>
  </point>
  <point name="function.axrp134_xrca004_ref" order="6" ver="6" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_xrca004_ref()
DEFINE l_site         LIKE xrca_t.xrcasite
DEFINE l_ooba002      LIKE ooba_t.ooba002
DEFINE l_success      LIKE type_t.num5
DEFINE l_pmab085      LIKE pmab_t.pmab085
DEFINE l_oodbl004     LIKE oodbl_t.oodbl004
DEFINE l_oodb011      LIKE oodb_t.oodb011
DEFINE l_ooib         RECORD LIKE ooib_t.*
DEFINE r_xrca         RECORD
          xrca005     LIKE xrca_t.xrca005,
          xrca006     LIKE xrca_t.xrca006,
          xrca007     LIKE xrca_t.xrca007,
          xrca008     LIKE xrca_t.xrca008,
          xrca009     LIKE xrca_t.xrca009,
          xrca010     LIKE xrca_t.xrca010,
          xrca011     LIKE xrca_t.xrca011,
          xrca012     LIKE xrca_t.xrca012,
          xrca013     LIKE xrca_t.xrca013,
          xrca014     LIKE xrca_t.xrca014,
          xrca015     LIKE xrca_t.xrca015,
          xrca046     LIKE xrca_t.xrca046,
          xrca058     LIKE xrca_t.xrca058,
          xrca061     LIKE xrca_t.xrca061,
          xrca100     LIKE xrca_t.xrca100,
          xrca101     LIKE xrca_t.xrca101,
          xrca121     LIKE xrca_t.xrca121,
          xrca131     LIKE xrca_t.xrca131
                      END RECORD
#150518-00044#5
DEFINE ls_js         STRING
DEFINE lc_param      RECORD
         apca004     LIKE apca_t.apca004
                 END RECORD
#150518-00044#5

   #新增/修改帳款對象後,依帳款對象更新客戶慣用資料
   
   ################################################
   #      STEP1-7 欄位取用原則:
   #      依帳務人員所屬 site  取出該客戶的相關欄位
   #      若取不到時再取 xrcacomp =pmabsite  為條件取  
   ################################################  
   
   SELECT DISTINCT ooag004 INTO l_site
     FROM ooag_t
    WHERE ooag001 = g_user AND ooagstus ='Y' 
   
   #STEP1.獲取交易對象簡稱
   
   #STEP2.帶出主要應收條件
   SELECT pmab087 INTO r_xrca.xrca008 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004
   IF SQLCA.sqlcode = 100 THEN 
      SELECT pmab087 INTO r_xrca.xrca008 FROM pmab_t
       WHERE pmabent = g_enterprise AND pmabsite = g_xrca.xrcacomp AND pmab001 = g_xrca.xrca004
   END IF
   
   #應收日期/票據到期日
   SELECT * INTO l_ooib.* FROM ooib_t WHERE ooibent = g_enterprise AND ooib001 = '2' AND ooib002 = r_xrca.xrca008
   CALL s_fin_date_ap_payable(g_xrca.xrcasite,g_xrca.xrca004,r_xrca.xrca008,g_xrca.xrcadocdt,
     g_xrca.xrcadocdt,g_xrca.xrcadocdt,'') RETURNING l_success,r_xrca.xrca009,r_xrca.xrca010
   
   #STEP3.帳款類別
   SELECT pmab105 INTO r_xrca.xrca007 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004 
   IF SQLCA.sqlcode = 100 THEN 
      SELECT pmab105 INTO r_xrca.xrca007 FROM pmab_t
       WHERE pmabent = g_enterprise AND pmabsite = g_xrca.xrcacomp AND pmab001 = g_xrca.xrca004
   END IF
   #若取不到時依單別參數S-FIN-2011 取得預設帳款類別
   IF cl_null(r_xrca.xrca007) THEN 
      CALL s_aooi200_fin_get_slip(g_xrca.xrcadocno) RETURNING l_success,l_ooba002
      CALL s_fin_get_doc_para(g_xrca.xrcald,g_xrca.xrcacomp,l_ooba002,'S-FIN-2011') RETURNING r_xrca.xrca007
   END IF
   
   #STEP4.業務人員/業務部門
   SELECT pmab081 INTO r_xrca.xrca014 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004 
   IF SQLCA.sqlcode = 100 THEN 
      SELECT pmab081 INTO r_xrca.xrca014 FROM pmab_t
       WHERE pmabent = g_enterprise AND pmabsite = g_xrca.xrcacomp AND pmab001 = g_xrca.xrca004
   END IF
   SELECT ooag003 INTO r_xrca.xrca015 FROM ooag_t
    WHERE ooagent = g_enterprise AND ooag001 = r_xrca.xrca014
   
   #STEP5.稅別/含稅否/稅率
   SELECT isak002 INTO r_xrca.xrca011 FROM isak_t
    WHERE isakent = g_enterprise AND isaksite = l_site AND isak001 = g_xrca.xrca004   
   CALL s_tax_chk(g_xrca.xrcasite,r_xrca.xrca011) RETURNING l_success,l_oodbl004,r_xrca.xrca013,r_xrca.xrca012,l_oodb011
   
   #STEP6.慣用幣別/匯率
   SELECT pmab083 INTO r_xrca.xrca100 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004 
   IF SQLCA.sqlcode = 100 THEN 
      SELECT pmab083 INTO r_xrca.xrca100 FROM pmab_t
       WHERE pmabent = g_enterprise AND pmabsite = g_xrca.xrcacomp AND pmab001 = g_xrca.xrca004
   END IF
   #計算各個本位筆匯率
   IF NOT cl_null(r_xrca.xrca100) THEN 
     #150518-00044#5--Mark
     #CALL s_axrt300_get_exrate(g_xrca.xrcadocdt,g_xrca.xrcald,g_xrca.xrcacomp,r_xrca.xrca100)
     #   RETURNING l_success,r_xrca.xrca101,r_xrca.xrca121,r_xrca.xrca131
     #150518-00044#5--Mark
     #150518-00044#5--(S)
      LET lc_param.apca004 = g_xrca.xrca004
      LET ls_js = util.JSON.stringify(lc_param)
      CALL s_fin_get_curr_rate(g_xrca.xrcacomp,g_xrca.xrcald,g_xrca.xrcadocdt,r_xrca.xrca100,ls_js)
           RETURNING r_xrca.xrca101,r_xrca.xrca121,r_xrca.xrca131
     #150518-00044#5--(E)
   END IF
   
   #STEP7.預開發票日
   SELECT pmab085 INTO l_pmab085 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004 
   IF SQLCA.sqlcode = 100 THEN 
      SELECT pmab083 INTO l_pmab085 FROM pmab_t
       WHERE pmabent = g_enterprise AND pmabsite = g_xrca.xrcacomp AND pmab001 = g_xrca.xrca004
   END IF
   IF NOT cl_null(l_pmab085) THEN
      IF l_pmab085 = '30' THEN
         #月結彙總開立發票
         IF MONTH(g_xrca.xrcadocdt) = 12 THEN
            #立帳日期為12月份,則依照條件開立發票日為12月31號
            LET r_xrca.xrca061 = MDY(12,31,YEAR(g_xrca.xrcadocdt))
         ELSE
            #立帳日期的下一個月減一天
            LET r_xrca.xrca061 = MDY(MONTH(g_xrca.xrcadocdt) + 1,1,YEAR(g_xrca.xrcadocdt)) - 1
         END IF
      ELSE
         LET r_xrca.xrca061 = g_xrca.xrcadocdt
      END IF
   END IF

   #SETP8.收款客戶   
   SELECT pmac002 INTO r_xrca.xrca005 FROM pmac_t
    WHERE pmacent = g_enterprise AND pmac001 = g_xrca.xrca004 
      AND pmac003 = '1' AND pmac004 = 'Y' AND pmacstus = 'Y'
   IF SQLCA.sqlcode = 100 THEN
      LET r_xrca.xrca005 = g_xrca.xrca004
   END IF
      
   #SETP9.關係人   
   SELECT pmaa047 INTO r_xrca.xrca046 FROM pmaa_t
    WHERE pmaaent = g_enterprise AND pmaa001 = g_xrca.xrca004     

   #SETP10.慣用銷售分類取
   SELECT pmab089 INTO r_xrca.xrca058 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004 
   
   #SETP11.客戶分類
   SELECT pmab090 INTO r_xrca.xrca006 FROM pmab_t
    WHERE pmabent = g_enterprise AND pmabsite = l_site AND pmab001 = g_xrca.xrca004 

   RETURN r_xrca.*

END FUNCTION]]>
  </point>
  <point name="function.axrp134_get_ooef001_wc" order="7" ver="4" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: sub產生的數據集轉換
# Memo...........: DSCNJ,DSCTP,DSCTC --> ('DSCNJ','DSCTP','DSCTC')
# Usage..........: CALL axrp134_get_ooef001_wc(p_wc)
#                  RETURNING r_wc
# Input parameter: p_wc           sub产生的数据集
# Return code....: r_wc           SQ可用的数据集
# Date & Author..: 2014/12/08 By zhangweib
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp134_get_ooef001_wc(p_wc)
   DEFINE p_wc       STRING
   DEFINE r_wc       STRING
   DEFINE tok        base.StringTokenizer
   DEFINE l_str      STRING

   LET tok = base.StringTokenizer.create(p_wc,",")
   WHILE tok.hasMoreTokens()
      IF cl_null(l_str) THEN
         LET l_str = tok.nextToken()
      ELSE
         LET l_str = l_str,"','",tok.nextToken()
      END IF      
   END WHILE   
   LET r_wc = "('",l_str,"')"
   
   RETURN r_wc

END FUNCTION]]>
  </point>
  <point name="b_fill.after_b_fill" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="b_fill.clear" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="b_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_imaal003      LIKE imaal_t.imaal003
   DEFINE l_imaal004      LIKE imaal_t.imaal004
   DEFINE ls_wc1          STRING
   DEFINE ls_wc2          STRING
   DEFINE l_s             LIKE type_t.chr1
   DEFINE l_success       LIKE type_t.chr1
   DEFINE l_xrcd103       LIKE xrcd_t.xrcd103
   DEFINE l_xrcd104       LIKE xrcd_t.xrcd104
   DEFINE l_xrcd105       LIKE xrcd_t.xrcd105
   DEFINE l_xrcd113       LIKE xrcd_t.xrcd113
   DEFINE l_xrcd114       LIKE xrcd_t.xrcd114
   DEFINE l_xrcd115       LIKE xrcd_t.xrcd115
   DEFINE l_xmdk017       LIKE xmdk_t.xmdk017
   DEFINE l_xmdl024       LIKE xmdl_t.xmdl024
   DEFINE l_xmdl025       LIKE xmdl_t.xmdl025]]>
  </point>
  <point name="b_fill.foreach_into" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   g_detail_d[l_ac].*,l_xmdk017,l_xmdl024,l_xmdl025]]>
  </point>
  <point name="b_fill.foreach_iside" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
      IF NOT cl_null(l_xmdl024) AND NOT cl_null(l_xmdl025) AND NOT cl_null(g_detail_d[l_ac].xrcb007) THEN
         CALL s_tax_count(g_detail_d[l_ac].xmdlsite,l_xmdl025,g_detail_d[l_ac].xrcb007 * l_xmdl024,
                          g_detail_d[l_ac].xrcb007,g_detail_d[l_ac].xmdk016,l_xmdk017)
            RETURNING l_xrcd103,l_xrcd104,l_xrcd105,
                      l_xrcd113,l_xrcd114,l_xrcd115
         LET g_detail_d[l_ac].xrcb103 = l_xrcd103
         LET g_detail_d[l_ac].xrcb105 = l_xrcd105
      ELSE
         LET g_detail_d[l_ac].xrcb103 = 0
         LET g_detail_d[l_ac].xrcb105 = 0
      END IF

      LET g_detail_d[l_ac].xrcb007_t = g_detail_d[l_ac].xrcb007
      LET g_detail_d[l_ac].xrcb103_t = g_detail_d[l_ac].xrcb103
      LET g_detail_d[l_ac].xrcb105_t = g_detail_d[l_ac].xrcb105

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_detail_d[l_ac].xmdk010
      CALL ap_ref_array2(g_ref_fields,"SELECT ooibl004 FROM ooibl_t WHERE ooiblent='"||g_enterprise||"' AND ooibl002=? AND ooibl003='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_detail_d[l_ac].xmdk010 = g_detail_d[l_ac].xmdk010,'(', g_rtn_fields[1] , ')'

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_detail_d[l_ac].xmdlsite
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_detail_d[l_ac].xmdlsite = g_detail_d[l_ac].xmdlsite,'(', g_rtn_fields[1] , ')'

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_detail_d[l_ac].xmdk003
      CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
      LET g_detail_d[l_ac].xmdk003_s = g_detail_d[l_ac].xmdk003,'(', g_rtn_fields[1] , ')'

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_detail_d[l_ac].xmdk004
      CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_detail_d[l_ac].xmdk004_s = g_detail_d[l_ac].xmdk003,'(', g_rtn_fields[1] , ')'

      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_detail_d[l_ac].xmdk008
      CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_detail_d[l_ac].xmdk008 = g_detail_d[l_ac].xmdk008,'(', g_rtn_fields[1] , ')'
]]>
  </point>
  <point name="b_fill.other_table" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL g_detail_d.deleteElement(l_ac)]]>
  </point>
  <point name="b_fill.sql_before" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   IF cl_null(g_wc) THEN LET g_wc = " 1=1" END IF

   CALL s_axrt300_sel_ld(g_xrca_m.xrcald) RETURNING l_success,l_s

   IF g_xrca_m.comb1 = '1' THEN
      LET ls_wc1 = " xmdk083 = 'N'"
   ELSE
      LET ls_wc1 = " xmdk083 = 'N'"
   END IF

   IF g_xrca_m.check1 = 'Y' THEN   #銷退單顯示
      LET ls_wc2 = " (xmdk000 <> '5' OR (xmdk000 = '5' AND xmdk082 IN (SELECT gzcb002 FROM gzcb_t WHERE gzcb001='2088' AND gzcb003='Y')))"
   ELSE
      LET ls_wc2 = " xmdk000 <> '5'"
   END IF

   LET g_sql = "SELECT 'N',xmdk007,xmdk082,xmdldocno,xmdlseq,xmdl008,                 ",
               "       imaal003 || '\n' || imaal004,xmdl003,xmdl001,                  ",
               "       xmdl018 || ' ' || xmdl017 || '\n' || xmdl022 || ' ' || xmdl021,",
               "       xmdk016,xmdl027 || '\n' || xmdl028,xrcb007,0,0,                ",
               "       xmdl048 || '\n' || xmdl049,xmdk008,xmdlsite,xmdk003,'',        ",
               "       xmdk004,'',xmdk010,'',xmdl017,xmdl021,xmdl048,xmdl049,0,0,0,   ",
               "       xmdk017,xmdl024,xmdl025                                        ",
               "  FROM (SELECT xmdk007,xmdk082,xmdlseq,xmdl008,xmdl049,xmdldocno,     ",
               "               xmdl003,xmdl001,xmdl018,xmdl017,xmdl022,imaal003,      ",
               "               xmdl021,xmdk016,xmdl027,xmdl028,xmdl048,xmdlsite,      ",
               "               xmdk008,xmdk003,xmdk004,xmdk010,imaal004,xmdk000,      ",
               "               xmdk017,xmdl024,xmdl025,                               ",
               "               CASE                                                   ",
               "                  WHEN '",l_s,"' = '1' THEN                           ",
               "                     CASE WHEN xmdl022 IS NULL THEN 0 ELSE xmdl022 END",
               "                   - CASE WHEN xmdl038 IS NULL THEN 0 ELSE xmdl038 END",
               "                  WHEN '",l_s,"' = '2' THEN                           ",
               "                     CASE WHEN xmdl022 IS NULL THEN 0 ELSE xmdl022 END",
               "                   - CASE WHEN xmdl039 IS NULL THEN 0 ELSE xmdl039 END",
               "                  WHEN '",l_s,"' = '3' THEN                           ",
               "                     CASE WHEN xmdl022 IS NULL THEN 0 ELSE xmdl022 END",
               "                   - CASE WHEN xmdl040 IS NULL THEN 0 ELSE xmdl040 END",
               "               END xrcb007                                            ",
               "          FROM xmdk_t, xmdl_t, imaal_t                                ",
               "         WHERE     xmdkdocno = xmdldocno        AND xmdkent = xmdlent ",
               "               AND xmdkent = ?                  AND imaalent = xmdkent",
               "               AND imaal002 = '",g_lang,"'      AND imaal001 = xmdl008",
               "               AND xmdkstus = 'S'               AND xmdl087 = 'Y'     ",
          #    "               AND xmdk000 IN ('5','6')                               ",
               "               AND ", g_wc CLIPPED,
               "               AND ",ls_wc1 CLIPPED,
               "               AND ",ls_wc2 CLIPPED,"                                 )"]]>
  </point>
  <point name="global.argv" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[DEFINE g_rec_b       LIKE type_t.num5              #單身筆數
DEFINE g_detail_idx  LIKE type_t.num5 
DEFINE g_rec_b1      LIKE type_t.num5              #單身筆數
DEFINE g_detail_idx1 LIKE type_t.num5 
DEFINE l_ac1         LIKE type_t.num5 ]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[        sel             LIKE type_t.chr1,
        xmdk007         LIKE xmdk_t.xmdk007,
        xmdk082         LIKE xmdk_t.xmdk082,
        xmdldocno       LIKE xmdl_t.xmdldocno,
        xmdlseq         LIKE xmdl_t.xmdlseq,
        xmdl008         LIKE xmdl_t.xmdl008,
        imaal003        LIKE type_t.chr200,
        xmdl003         LIKE xmdl_t.xmdl003,
        xmdl001         LIKE xmdl_t.xmdl003,
        xmdl018         LIKE type_t.chr200,
        xmdk016         LIKE xmdk_t.xmdk016,
        xmdl027         LIKE type_t.chr200,
        xrcb007         LIKE xrcb_t.xrcb007,
        xrcb103         LIKE xrcb_t.xrcb103,
        xrcb105         LIKE xrcb_t.xrcb105,
        xmdl048         LIKE xmdl_t.xmdl048,
        xmdk008         LIKE type_t.chr200,
        xmdlsite        LIKE type_t.chr200,
        xmdk003         LIKE xmdk_t.xmdk003,
        xmdk003_s       LIKE type_t.chr200,
        xmdk004         LIKE xmdk_t.xmdk004,
        xmdk004_s       LIKE type_t.chr200,
        xmdk010         LIKE type_t.chr200,
        lbl_hide        LIKE type_t.chr1,
        xmdl017         LIKE xmdl_t.xmdl017,
        xmdl021         LIKE xmdl_t.xmdl021,
        xmdl048_1       LIKE xmdl_t.xmdl048,
        xmdl049_1       LIKE xmdl_t.xmdl049,
        xrcb007_t       LIKE xrcb_t.xrcb007,
        xrcb103_t       LIKE xrcb_t.xrcb103,
        xrcb105_t       LIKE xrcb_t.xrcb105
                     END RECORD
TYPE type_g_xrca_m   RECORD
        xrcasite        LIKE xrca_t.xrcasite,
        xrcasite_desc   LIKE ooefl_t.ooefl003,
        xrcald          LIKE xrca_t.xrcald,
        xrcald_desc     LIKE glaal_t.glaal002,
        xrcacomp        LIKE type_t.chr80,
        comb1           LIKE type_t.chr1,
        check1          LIKE type_t.chr1
                     END RECORD
DEFINE g_xrca_m      type_g_xrca_m
DEFINE g_conditions  RECORD
          xrcasite           LIKE xrca_t.xrcasite,
          xrcasite_desc      LIKE ooefl_t.ooefl003,
          xrcald             LIKE xrca_t.xrcald,
          xrcald_desc        LIKE glaal_t.glaal002,
          xrcacomp           LIKE type_t.chr200,
          comb1              LIKE type_t.chr1,
          comb2              LIKE type_t.chr1,
          xrcadocno          LIKE oobx_t.oobx001,
          xrcadocno_desc     LIKE oobxl_t.oobxl003,
          xrca003            LIKE xrca_t.xrca003,
          xrca003_desc       LIKE oofa_t.oofa011,
          check1             LIKE type_t.chr1,
          check2             LIKE type_t.chr1,
          check3             LIKE type_t.chr1,
          xrcadocdt          LIKE xrca_t.xrcadocdt,
          xrca007            LIKE xrca_t.xrca007,
          xrca007_desc       LIKE oocql_t.oocql004,
          xrca063            LIKE xrca_t.xrca063
                     END RECORD
DEFINE g_glaa        RECORD LIKE glaa_t.*
DEFINE g_sel         DYNAMIC ARRAY OF VARCHAR(500)
DEFINE g_xrca        RECORD LIKE xrca_t.*
DEFINE g_xrcb        RECORD LIKE xrcb_t.*]]>
  </point>
  <point name="init.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="init.init" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL cl_set_combo_scc("comb1",8325)
   CALL s_fin_create_account_center_tmp()   ]]>
  </point>
  <point name="main.background" order="" ver="5" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL s_aooi390_cre_tmp_table() RETURNING l_success   #add--2015/03/19 By shiun]]>
  </point>
  <point name="main.before_close" order="" ver="5" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="main.define" order="" ver="5" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success    LIKE type_t.num5   #add--2015/03/19 By shiun]]>
  </point>
  <point name="main.exit" order="" ver="5" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL s_aooi390_drop_tmp_table()   #add--2015/03/19 By shiun]]>
  </point>
  <point name="query.after_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="query.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success     LIKE type_t.chr1
   DEFINE l_xrcd103     LIKE xrcd_t.xrcd103
   DEFINE l_xrcd104     LIKE xrcd_t.xrcd104
   DEFINE l_xrcd105     LIKE xrcd_t.xrcd105
   DEFINE l_xrcd113     LIKE xrcd_t.xrcd113
   DEFINE l_xrcd114     LIKE xrcd_t.xrcd114
   DEFINE l_xrcd115     LIKE xrcd_t.xrcd115
   DEFINE ls_wc1        STRING
   DEFINE ls_wc2        STRING
   DEFINE ls_wc3        STRING
   DEFINE l_xmdk        RECORD
             flag          LIKE type_t.chr1,
             xmdk007       LIKE xmdk_t.xmdk007,
             xmdk000       LIKE xmdk_t.xmdk000,
             xmdl003       LIKE xmdl_t.xmdl003,
             xmdl048       LIKE xmdl_t.xmdl048,
             xmdl049       LIKE xmdl_t.xmdl049,
             xmdldocno     LIKE xmdl_t.xmdldocno,
             xmdlseq       LIKE xmdl_t.xmdlseq,
             xmdl008       LIKE xmdl_t.xmdl008,
             imaal003      LIKE imaal_t.imaal003,
             imaal004      LIKE imaal_t.imaal004,
             xmdk003       LIKE xmdk_t.xmdk003,
             xmdk004       LIKE xmdk_t.xmdk004,
             xmdk010       LIKE xmdk_t.xmdk010,
             xmdl018       LIKE xmdl_t.xmdl018,
             xmdl017       LIKE xmdl_t.xmdl017,
             xmdl022       LIKE xmdl_t.xmdl022,
             xmdl021       LIKE xmdl_t.xmdl021,
             xmdk016       LIKE xmdk_t.xmdk016,
             xmdl027       LIKE xmdl_t.xmdl027,
             xmdl028       LIKE xmdl_t.xmdl028,
             xmdk008       LIKE xmdk_t.xmdk008,
             xmdlsite      LIKE xmdl_t.xmdlsite,
             xmdl026       LIKE xmdl_t.xmdl026,
             xmdl024       LIKE xmdl_t.xmdl024,
             xrcb007       LIKE xrcb_t.xrcb007,
             xrcb103       LIKE xrcb_t.xrcb103,
             xrcb105       LIKE xrcb_t.xrcb105,
             xmdk017       LIKE xmdk_t.xmdk017,
             xmdl025       LIKE xmdl_t.xmdl025,
             xmdk012       LIKE xmdk_t.xmdk012,
             xrca001       LIKE xrca_t.xrca001
                        END RECORD
   DEFINE l_s_bas_0012  LIKE gzsz_t.gzsz008
   DEFINE l_s_bas_0011  LIKE gzsz_t.gzsz008]]>
  </point>
  <point name="ui_dialog.before_dialog2" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
            NEXT FIELD xrcasite]]>
  </point>
  <point name="ui_dialog.define" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_s               LIKE type_t.chr1
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_cnt             LIKE type_t.num5
   DEFINE l_comb1           LIKE type_t.chr1
   DEFINE l_xrcacomp        LIKE xrca_t.xrcacomp
   DEFINE ls_wc             STRING]]>
  </point>
  <point name="ui_dialog.more_action" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
         ON ACTION open_axrp134_s01
            LET g_action_choice="open_axrp134_s01"
            IF cl_auth_chk_act("open_axrp134_s01") THEN
               CALL axrp134_s01()
               EXIT DIALOG
            END IF

         ON ACTION batch_execute
            LET g_action_choice="batch_execute"
            IF cl_auth_chk_act("batch_execute") THEN
               CALL axrp134_s01()
               EXIT DIALOG
            END IF
]]>
  </point>
  <point name="ui_dialog.more_construct" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[        INPUT BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcald,g_xrca_m.comb1,g_xrca_m.check1
        
           BEFORE INPUT
              CALL axrp134_def()
          
           AFTER FIELD xrcald
              IF NOT cl_null(g_xrca_m.xrcald) THEN 
                 CALL s_axrt300_site_geared_ld(g_xrca_m.xrcasite,g_xrca_m.xrcald,g_user,g_today,'ld')
                    RETURNING l_success,g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc,g_xrca_m.xrcald,g_xrca_m.xrcald_desc
                 DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc
                 DISPLAY BY NAME g_xrca_m.xrcald,g_xrca_m.xrcald_desc
                 DISPLAY BY NAME g_xrca_m.xrcacomp
                 IF NOT l_success THEN
                    SELECT * INTO g_glaa.* FROM FROM glaa_t WHERE glaaent = g_enterprise AND glaald  = g_xrca_m.xrcald
                    NEXT FIELD CURRENT
                 END IF
              ELSE
                 LET g_xrca_m.xrcald_desc = ''
              END IF
              SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_xrca_m.xrcald
              IF NOT cl_null(g_glaa.glaacomp) THEN
                 CALL s_axrt300_xrca_ref('xrcasite',g_glaa.glaacomp,'','') RETURNING l_success,g_xrca_m.xrcacomp
                 LET g_xrca_m.xrcacomp = g_glaa.glaacomp,'(', g_xrca_m.xrcacomp , ')'
              ELSE
                 LET g_xrca_m.xrcacomp = ''
              END IF
              DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc
              DISPLAY BY NAME g_xrca_m.xrcald,g_xrca_m.xrcald_desc
              DISPLAY BY NAME g_xrca_m.xrcacomp
             
           AFTER FIELD xrcasite
              IF NOT cl_null(g_xrca_m.xrcasite) THEN
                 CALL s_axrt300_site_geared_ld(g_xrca_m.xrcasite,g_xrca_m.xrcald,g_user,g_today,'site')
                    RETURNING l_success,g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc,g_xrca_m.xrcald,g_xrca_m.xrcald_desc
                 DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc
                 DISPLAY BY NAME g_xrca_m.xrcald,g_xrca_m.xrcald_desc
                 DISPLAY BY NAME g_xrca_m.xrcacomp
                 IF NOT l_success THEN NEXT FIELD CURRENT END IF
              ELSE
                 LET g_xrca_m.xrcasite_desc = ''
              END IF
              SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_xrca_m.xrcald
              IF NOT cl_null(g_glaa.glaacomp) THEN
                 CALL s_axrt300_xrca_ref('xrcasite',g_glaa.glaacomp,'','') RETURNING l_success,g_xrca_m.xrcacomp
                 LET g_xrca_m.xrcacomp = g_glaa.glaacomp,'(', g_xrca_m.xrcacomp , ')'
              ELSE
                 LET g_xrca_m.xrcacomp = ''
              END IF
              DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc
              DISPLAY BY NAME g_xrca_m.xrcald,g_xrca_m.xrcald_desc
              DISPLAY BY NAME g_xrca_m.xrcacomp

           BEFORE FIELD comb1

           ON CHANGE comb1

           ON ACTION controlp INFIELD xrcald
              #取得帳務組織下所屬成員
              CALL s_fin_account_center_sons_query('3',g_xrca_m.xrcasite,g_today,'1')
              #取得帳務組織下所屬成員之帳別   
              CALL s_fin_account_center_comp_str() RETURNING ls_wc
              #將取回的字串轉換為SQL條件
              CALL axrp134_get_ooef001_wc(ls_wc) RETURNING ls_wc  
              #開窗i段
			     INITIALIZE g_qryparam.* TO NULL
              LET g_qryparam.state = 'i'
			     LET g_qryparam.reqry = FALSE
              LET g_qryparam.default1 = g_xrca_m.xrcald             #給予default值
              IF NOT cl_null(ls_wc) AND ls_wc <> '(\'\')' THEN
                 LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y') AND glaacomp IN ",ls_wc,""
              ELSE
                 LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y')"
              END IF
              LET g_qryparam.arg1 = g_user
              LET g_qryparam.arg2 = g_dept
              CALL  q_authorised_ld()                                  #呼叫開窗
              LET g_xrca_m.xrcald = g_qryparam.return1       #將開窗取得的值回傳到變數
              IF NOT cl_null(g_xrca_m.xrcald) THEN
                 CALL s_axrt300_site_geared_ld(g_xrca_m.xrcasite,g_xrca_m.xrcald,g_user,g_today,'ld')
                    RETURNING l_success,g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc,g_xrca_m.xrcald,g_xrca_m.xrcald_desc
                 SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_xrca_m.xrcald
                 IF NOT cl_null(g_glaa.glaacomp) THEN
                    CALL s_axrt300_xrca_ref('xrcasite',g_glaa.glaacomp,'','') RETURNING l_success,g_xrca_m.xrcacomp
                    LET g_xrca_m.xrcacomp = g_glaa.glaacomp,'(', g_xrca_m.xrcacomp , ')'
                 ELSE
                    LET g_xrca_m.xrcacomp = ''
                 END IF
              END IF
              DISPLAY BY NAME g_xrca_m.xrcald,g_xrca_m.xrcald_desc,g_xrca_m.xrcacomp
              NEXT FIELD xrcald                              #返回原欄位  
        
           ON ACTION controlp INFIELD xrcasite
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_xrca_m.xrcasite             #給予default值
            LET g_qryparam.where = " ooef201 = 'Y' "

            #給予arg

            CALL q_ooef001()                                        #呼叫開窗
            LET g_xrca_m.xrcasite = g_qryparam.return1              #將開窗取得的值回傳到變數
            CALL s_axrt300_xrca_ref('xrcasite',g_xrca_m.xrcasite,'','') RETURNING l_success,g_xrca_m.xrcasite_desc
            IF NOT cl_null(g_xrca_m.xrcasite) THEN
               CALL s_axrt300_site_geared_ld(g_xrca_m.xrcasite,g_xrca_m.xrcald,g_user,g_today,'site')
                  RETURNING l_success,g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc,g_xrca_m.xrcald,g_xrca_m.xrcald_desc
               SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_xrca_m.xrcald
               IF NOT cl_null(g_glaa.glaacomp) THEN
                  CALL s_axrt300_xrca_ref('xrcasite',g_glaa.glaacomp,'','') RETURNING l_success,g_xrca_m.xrcacomp
                  LET g_xrca_m.xrcacomp = g_glaa.glaacomp,'(', g_xrca_m.xrcacomp , ')'
               ELSE
                  LET g_xrca_m.xrcacomp = ''
               END IF
            END IF
            DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc
            DISPLAY BY NAME g_xrca_m.xrcald,g_xrca_m.xrcald_desc
            DISPLAY BY NAME g_xrca_m.xrcacomp
            DISPLAY BY NAME g_xrca_m.xrcasite,g_xrca_m.xrcasite_desc
            NEXT FIELD xrcasite

        END INPUT 
        
        #螢幕上取條件
         CONSTRUCT BY NAME g_wc ON xmdk007,xmdk001,xmdk003,xmdl003,xmdldocno,xmdl001
           
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
        
            ON ACTION controlp INFIELD xmdk007              #開窗c段
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE      
               LET g_qryparam.arg1  = 'ALL'
               CALL q_pmaa001_6()                           #呼叫開窗
               DISPLAY g_qryparam.return1 TO xmdk007        #顯示到畫面上
               NEXT FIELD xmdk007                           #返回原欄位

            ON ACTION controlp INFIELD xmdk003              #開窗c段
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE      
               CALL q_ooag001_6()                           #呼叫開窗
               DISPLAY g_qryparam.return1 TO xmdk003        #顯示到畫面上
               NEXT FIELD xmdk003                           #返回原欄位

            ON ACTION controlp INFIELD xmdl003              #開窗c段
               CALL s_axrt300_sel_ld(g_xrca_m.xrcald) RETURNING l_success,l_s
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.arg1  = g_xrca_m.xrcasite
               LET g_qryparam.arg2  = l_s
               CALL q_xmdl003()                             #呼叫開窗
               DISPLAY g_qryparam.return1 TO xmdl003        #顯示到畫面上
               NEXT FIELD xmdl003                           #返回原欄位

            ON ACTION controlp INFIELD xmdldocno            #開窗c段
               CALL s_axrt300_sel_ld(g_xrca_m.xrcald) RETURNING l_success,l_s
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.arg1  = g_xrca_m.xrcasite
               LET g_qryparam.arg2  = l_s
               CALL q_xmdl_101()                            #呼叫開窗
               DISPLAY g_qryparam.return1 TO xmdldocno      #顯示到畫面上
               NEXT FIELD xmdldocno                         #返回原欄位

            ON ACTION controlp INFIELD xmdl001              #開窗c段
               CALL s_axrt300_sel_ld(g_xrca_m.xrcald) RETURNING l_success,l_s
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.arg1  = g_xrca_m.xrcasite
               LET g_qryparam.arg2  = l_s
               CALL q_xmdl_10()                             #呼叫開窗
               DISPLAY g_qryparam.return1 TO xmdl001        #顯示到畫面上
               NEXT FIELD xmdl001                           #返回原欄位

         END CONSTRUCT]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         INPUT ARRAY g_detail_d FROM s_detail1.* 
            ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                  INSERT ROW = FALSE, 
                  DELETE ROW = FALSE,
                  APPEND ROW = FALSE)
    
            BEFORE INPUT
               LET l_ac = DIALOG.getCurrentRow("s_detail1")

            BEFORE ROW
               IF l_ac > 0 THEN
                  IF g_detail_d[l_ac].sel = 'N' THEN
                     CALL cl_set_comp_entry('b_xrcb007,b_xrcb103,b_xrcb105',FALSE)
                     NEXT FIELD sel
                  ELSE
                     CALL cl_set_comp_entry('b_xrcb007,b_xrcb103,b_xrcb105',TRUE)
                  END IF
               END IF

            ON CHANGE sel
               IF NOT cl_null(g_detail_d[l_ac].sel) THEN
                  IF g_detail_d[l_ac].sel = 'N' THEN
                     CALL cl_set_comp_entry('b_xrcb007,b_xrcb103,b_xrcb105',FALSE)
                     NEXT FIELD sel
                  ELSE
                     CALL cl_set_comp_entry('b_xrcb007,b_xrcb103,b_xrcb105',TRUE)
                  END IF
               END IF

            BEFORE FIELD b_xrcb007
               IF g_detail_d[l_ac].sel = 'N' THEN
                  NEXT FIELD sel
               END IF

            AFTER FIELD b_xrcb007
               IF NOT cl_null(g_detail_d[l_ac].xrcb007) THEN
                  IF g_detail_d[l_ac].xrcb007 > g_detail_d[l_ac].xrcb007_t OR g_detail_d[l_ac].xrcb007 < 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00126'
                     LET g_errparam.extend = g_detail_d[l_ac].xrcb007
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_detail_d[l_ac].xrcb007 = g_detail_d[l_ac].xrcb007_t
                     DISPLAY g_detail_d[l_ac].xrcb007 TO s_detail1[l_ac].xrcb007
                     NEXT FIELD CURRENT
                  END IF
               END IF

            BEFORE FIELD b_xrcb103
               IF g_detail_d[l_ac].sel = 'N' THEN
                  NEXT FIELD sel
               END IF

            AFTER FIELD b_xrcb103
               IF NOT cl_null(g_detail_d[l_ac].xrcb103) THEN
                  IF g_detail_d[l_ac].xrcb103 < 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00127'
                     LET g_errparam.extend = g_detail_d[l_ac].xrcb103
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_detail_d[l_ac].xrcb103 = g_detail_d[l_ac].xrcb103_t
                     DISPLAY g_detail_d[l_ac].xrcb103 TO s_detail1[l_ac].xrcb103
                     NEXT FIELD CURRENT
                  END IF
                  IF g_detail_d[l_ac].xrcb103 > g_detail_d[l_ac].xrcb103_t THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00128'
                     LET g_errparam.extend = g_detail_d[l_ac].xrcb103
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_detail_d[l_ac].xrcb103 = g_detail_d[l_ac].xrcb103_t
                     DISPLAY g_detail_d[l_ac].xrcb103 TO s_detail1[l_ac].xrcb103
                     NEXT FIELD CURRENT
                  END IF
               END IF

            BEFORE FIELD b_xrcb105
               IF g_detail_d[l_ac].sel = 'N' THEN
                  NEXT FIELD sel
               END IF

            AFTER FIELD b_xrcb105
               IF NOT cl_null(g_detail_d[l_ac].xrcb105) THEN
                  IF g_detail_d[l_ac].xrcb105 < 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00127'
                     LET g_errparam.extend = g_detail_d[l_ac].xrcb105
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_detail_d[l_ac].xrcb105 = g_detail_d[l_ac].xrcb105_t
                     DISPLAY g_detail_d[l_ac].xrcb105 TO s_detail1[l_ac].xrcb105
                     NEXT FIELD CURRENT
                  END IF
                  IF g_detail_d[l_ac].xrcb105 > g_detail_d[l_ac].xrcb105_t THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00128'
                     LET g_errparam.extend = g_detail_d[l_ac].xrcb105
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_detail_d[l_ac].xrcb105 = g_detail_d[l_ac].xrcb105_t
                     DISPLAY g_detail_d[l_ac].xrcb105 TO s_detail1[l_ac].xrcb105
                     NEXT FIELD CURRENT
                  END IF
               END IF

         END INPUT]]>
  </point>
  <point name="ui_dialog.onaction_sel" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="ui_dialog.onaction_selall" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="ui_dialog.onaction_selnone" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            NEXT FIELD xrcasite]]>
  </point>
  <point name="ui_dialog.onaction_unsel" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            NEXT FIELD xrcasite]]>
  </point>
  <point name="ui_dialog.qbeclear" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CLEAR FORM
            INITIALIZE g_xrca_m.* TO NULL
            CALL axrp134_def()]]>
  </point>
  <section id="axrp134.b_fill" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION axrp134_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   {<point name="b_fill.define" edit="s"/>}
   #end add-point
   #add-point:b_fill段define
   {<point name="b_fill.define_customerization" edit="c"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
 
   PREPARE axrp134_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR axrp134_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   {<point name="b_fill.clear"/>}
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   {<point name="b_fill.foreach_into"/>}
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      {<point name="b_fill.foreach_iside"/>}
      #end add-point
      
      CALL axrp134_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.other_table"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE axrp134_sel
   
   LET l_ac = 1
   CALL axrp134_fetch()
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.after_b_fill"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="axrp134.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:6,PR版次:6) Build-000133
#+ 
#+ Filename...: axrp134
#+ Description: 銷退單批次立應收帳款作業
#+ Creator....: 01727(2014-06-06 00:00:00)
#+ Modifier...: 01727(2014-06-09 15:51:44) -SD/PR-
]]>
  </section>
  <section id="axrp134.detail_show" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION axrp134_detail_show()
   #add-point:show段define
   {<point name="detail_show.define" edit="s"/>}
   #end add-point
   #add-point:show段define
   {<point name="detail_show.define_customerization" edit="c"/>}
   #end add-point
   
   #add-point:detail_show段
   {<point name="detail_show.detail_show"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="axrp134.fetch" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION axrp134_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   {<point name="fetch.define" edit="s"/>}
   #end add-point
   #add-point:fetch段define
   {<point name="fetch.define_customerization" edit="c"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="axrp134.filter" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION axrp134_filter()
   #add-point:filter段define
   {<point name="filter.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter.define_customerization" edit="c"/>}
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   {<point name="filter.detail_cnt"/>}
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL axrp134_b_fill()
   
END FUNCTION
]]>
  </section>
  <section id="axrp134.filter_parser" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter欄位解析
PRIVATE FUNCTION axrp134_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   {<point name="filter_parser.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter_parser.define_customerization" edit="c"/>}
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
  </section>
  <section id="axrp134.filter_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION axrp134_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = axrp134_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
  </section>
  <section id="axrp134.global" ver="8" status="" src="s" readonly="">
    <![CDATA[#應用 p02 樣板自動產生(Version:13)
{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#{<point name="global.inc" />}
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="axrp134.init" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION axrp134_init()
   #add-point:init段define
   {<point name="init.define" edit="s"/>}
   #end add-point   
   #add-point:init段define
   {<point name="init.define_customerization" edit="c"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp134.main" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   {<point name="main.define" edit="s"/>}
   #end add-point   
   #add-point:main段define
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("axr","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_axrp134 WITH FORM cl_ap_formpath("axr",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL axrp134_init()   
 
      #進入選單 Menu (="N")
      CALL axrp134_ui_dialog() 
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_axrp134
   END IF 
   
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
  </section>
  <section id="axrp134.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="axrp134.query" ver="5" status="" src="s" readonly="">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION axrp134_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   {<point name="query.define" edit="s" />}
   #end add-point 
   #add-point:query段define
   {<point name="query.define_customerization" edit="c" />}
   #end add-point 
    
   #add-point:cs段after_construct
   {<point name="query.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL axrp134_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   {<point name="query.cs段after_query" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp134.ui_dialog" ver="8" status="" src="s" readonly="">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION axrp134_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define" edit="s"/>}
   #end add-point 
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define_customerization" edit="c"/>}
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL axrp134_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.selall.befroe"/>}
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               {<point name="ui_dialog.for.onaction_selall"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               {<point name="ui_dialog.for.onaction_selnone"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL axrp134_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            {<point name="ui_dialog.before_accept"/>}
            #end add-point
            CALL axrp134_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            {<point name="ui_dialog.datarefresh"/>}
            #end add-point
            CALL axrp134_b_fill()
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
  </section>
</add_points>
