<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="axrp910" std_prog="axrp910" erpver="1.0" module="AXR" ver="5" env="s" zone="t10prd" booking="N" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="W" status=""/>
    <free_style value="N" status=""/>
    <start_arg value="" status=""/>
  </other>
  <point name="function.axrp910_def" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 默認設置
# Memo...........:
# Usage..........: CALL axrp910_def()
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_def()
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_flag            LIKE type_t.dat
   DEFINE l_ooef017         LIKE ooef_t.ooef017
   
   IF NOT cl_null(g_master.xreasite) THEN RETURN END IF
   #帳務中心
   #取得預設的帳務中心,因新增階段的時候,並不會知道site,所以以登入人員做為依據
   CALL s_fin_get_account_center('',g_user,'3',g_today) RETURNING l_success,g_master.xreasite,g_errno
   CALL s_desc_get_department_desc(g_master.xreasite) RETURNING g_master.xreasite_desc

   #取得帳務中心歸屬法人 141223
   SELECT ooef017 INTO l_ooef017 FROM ooef_t WHERE ooefent = g_enterprise
      AND ooef001 = g_master.xreasite
   LET l_flag = cl_get_para(g_enterprise,l_ooef017,'S-FIN-2007')   #关账日期

   LET g_master.xrea001 = YEAR(l_flag)
   LET g_master.xrea002 = MONTH(l_flag)
END FUNCTION]]>
  </point>
  <point name="function.axrp910_date_chk" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 會計年度期別檢查
# Memo...........:
# Usage..........: CALL axrp910_date_chk()
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_date_chk()
   DEFINE l_flag         LIKE type_t.dat
   DEFINE l_xrea001      LIKE xrea_t.xrea001
   DEFINE l_xrea002      LIKE xrea_t.xrea002
   DEFINE l_ooef017      LIKE ooef_t.ooef017
   
   IF cl_null(g_master.xreasite) THEN RETURN END IF
   IF cl_null(g_master.xrea001) THEN RETURN END IF
   IF cl_null(g_master.xrea002) THEN RETURN END IF

   #取得帳務中心歸屬法人 141223
   SELECT ooef017 INTO l_ooef017 FROM ooef_t WHERE ooefent = g_enterprise
      AND ooef001 = g_master.xreasite
   LET l_flag = cl_get_para(g_enterprise,l_ooef017,'S-FIN-2007')   #关账日期

   LET l_xrea001 = YEAR(l_flag)
   LET l_xrea002 = MONTH(l_flag)

   LET g_errno = ' '
   IF g_master.xrea001 < l_xrea001 THEN
      LET g_errno = 'anm-00248'
   END IF

   IF g_master.xrea001 = l_xrea001  AND g_master.xrea002 < l_xrea002 THEN
      LET g_errno = 'anm-00249'
   END IF
END FUNCTION]]>
  </point>
  <point name="function.axrp910_cycle_ld" order="3" ver="4" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_cycle_ld()
   DEFINE l_i               LIKE type_t.num5
   DEFINE l_title           LIKE gzzd_t.gzzd005
   DEFINE l_glca002         LIKE glca_t.glca002
   DEFINE l_success         LIKE type_t.num5
   DEFINE l_tot_success     LIKE type_t.num5
   DEFINE l_cnt             LIKE type_t.num5
   DEFINE l_flag            LIKE type_t.num5
   DEFINE l_flag1           LIKE type_t.num5
   DEFINE l_msg             STRING

   SELECT gzzd005 INTO l_title FROM gzzd_t 
   WHERE gzzd001 = 'axrt300' AND gzzd002 = g_lang AND gzzd003 = 'lbl_xrcadocno'

   LET l_flag = FALSE
   LET g_errno = NULL
   LET l_tot_success = TRUE
   FOR l_i = 1 TO g_detail_d.getLength()
      IF g_detail_d[l_i].sel = 'Y' THEN
         CALL axrp910_clik_chk(l_i,'0') RETURNING l_success      #150518-00043#5 Add
         IF NOT l_success THEN LET l_tot_success = FALSE END IF
         LET l_flag = TRUE
      END IF
   END FOR

   IF NOT l_flag THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axr-00159'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN
   END IF

   IF NOT l_tot_success THEN
      LET l_msg = cl_getmsg('axr-00339',g_lang) CLIPPED
      IF NOT cl_ask_confirm2('',l_msg)THEN
         RETURN
      END IF
   END IF

   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   LET g_coll_title[1] = l_title
   LET g_success = 'Y'
   LET l_success = TRUE
   LET l_flag = FALSE #是否產生資料
   LET l_flag1 = FALSE #是否勾選拋轉帳套

   FOR l_i = 1 TO g_detail_d.getLength()
      IF g_detail_d[l_i].sel = "Y" THEN
         LET l_flag1 = TRUE
         SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_detail_d[l_i].xreald

         #檢查是否已有月結資料產生
        #CALL axrp910_clik_chk(l_i,'2')      #150518-00043#5 Mark
         IF NOT cl_null(g_errno) AND g_errno = 'axr-00291' THEN
            CALL axrp910_axrp970(l_i) RETURNING l_success
            IF NOT l_success THEN LET g_success = 'N' END IF
         END IF
         IF g_success = 'N' THEN CONTINUE FOR END IF   #若刪除月結檔失敗,則不可繼續往下執行產生月結檔邏輯

         CALL axrp910_get_xrea(g_detail_d[l_i].xreald,g_detail_d[l_i].glav004_s,g_detail_d[l_i].glav004_e)
         IF g_success = 'Y' AND l_flag=FALSE THEN
            #判斷是否產生月結資料
            SELECT COUNT(*) INTO l_cnt FROM  xrea_t 
            WHERE xreaent = g_enterprise AND xreald = g_detail_d[l_i].xreald
              AND xrea001 = g_master.xrea001
              AND xrea002 = g_master.xrea002
              AND xrea003 = 'AR'
            IF l_cnt> 0 THEN
               LET l_flag=TRUE
            END IF
        END IF
      END IF
   END FOR
   #提示選取預處理資料
   IF l_flag1 = FALSE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = '-400'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET g_success = 'N'
   END IF
   #判斷是否產生月結資料
   IF g_success = 'Y' AND l_flag1 = TRUE AND l_flag=FALSE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 'axc-00530'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      LET g_success = 'N'
   END IF

   IF g_success = 'N' THEN
      CALL cl_err_collect_show()
      CALL s_transaction_end('N','0')
   ELSE
      CALL s_transaction_end('Y','0')
      CALL cl_err_collect_init()
      CALL cl_err_collect_show()
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 'axm-00088'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      IF cl_ask_confirm('axr-00304') THEN
         CALL axrp910_aglp590()
      END IF
   END IF

END FUNCTION]]>
  </point>
  <point name="function.axrp910_get_xrea" order="4" ver="4" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_get_xrea(p_ld,p_glav004_s,p_glav004_e)
   DEFINE p_ld          LIKE xreb_t.xrebld
   DEFINE p_glav004_s   LIKE glav_t.glav004
   DEFINE p_glav004_e   LIKE xreb_t.xreb008
   DEFINE l_sql         STRING
   DEFINE l_xrea        RECORD LIKE xrea_t.*
   DEFINE l_success     LIKE type_t.chr1
   DEFINE l_flag        LIKE type_t.chr1
   DEFINE l_xrce109     LIKE xrce_t.xrce109
   DEFINE l_xrce119     LIKE xrce_t.xrce119
   DEFINE l_xrce129     LIKE xrce_t.xrce129
   DEFINE l_xrce139     LIKE xrce_t.xrce139
   DEFINE l_apce109     LIKE apce_t.apce109
   DEFINE l_apce119     LIKE apce_t.apce119
   DEFINE l_apce129     LIKE apce_t.apce129
   DEFINE l_apce139     LIKE apce_t.apce139
   DEFINE l_xrcc113     LIKE xrcc_t.xrcc113
   DEFINE l_glca002     LIKE glca_t.glca003
   DEFINE l_oodbl004    LIKE oodbl_t.oodbl004
   DEFINE l_oodb005     LIKE oodb_t.oodb005
   DEFINE l_oodb011     LIKE oodb_t.oodb004
   
#   #刪除已產生的月結資料
#   DELETE FROM xrea_t 
#   WHERE xreaent = g_enterprise AND xreald = p_ld
#     AND xrea001 = g_master.xrea001
#     AND xrea002 = g_master.xrea002
#     AND xrea003 = 'AR'

   #150315 add ------
   SELECT glca002 INTO l_glca002
     FROM glaa_t,glca_t 
    WHERE glaaent = g_enterprise
      AND glaaent = glcaent
      AND glaald = glcald 
      AND glca001 = 'AR' 
      AND glca002 <> '1'     #無重評不撈出           
      AND glaald = p_ld
   #150315 add end---

   #沖帳方式            
   CALL cl_get_para(g_enterprise,g_glaa.glaacomp,'S-FIN-1002') RETURNING l_flag
   
   LET l_sql = "SELECT xrccent,xrcacomp,xrcasite,xrcald,xrca001,xrccdocno,xrccseq,xrcc001,xrcadocdt,xrca004,xrca005,"
   IF l_flag = '1' OR l_flag = '2' THEN
      LET l_sql = l_sql," '','','','','',xrca014,'',''," ,
                        " xrca035,xrcacomp,'','','',",
                        " '','','','','','','','','','','',", #10個自由核算項+摘要
                        " xrca011,xrca012,"  #稅別、稅率
   ELSE
      LET l_sql = l_sql," xrcb010,xrcb011,xrcb024,xrcb014,xrcb012,xrca014,xrcb015,xrcb016,",
                        " xrcb029,xrcborga,xrcb034,xrcb035,xrcb036,",
                        " xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,",    #10個自由核算項+摘要
                        " xrcb042,xrcb043,xrcb044,xrcb045,xrcb046,xrcb047,",
                        " xrcb020,'',"   #稅別、稅率
   END IF   
   LET l_sql = l_sql," xrcc010,xrcc011,xrcc013,xrcc014,xrcc003,xrcc100,xrcc101,xrcc102,",
                     " xrcc108-xrcc109,xrcc118-xrcc119+xrcc113,",
                     " xrcc122,xrcc128-xrcc129+xrcc123,xrcc132,xrcc138-xrcc139+xrcc133",
                     " FROM xrca_t,xrcb_t,xrcc_t",
                     " WHERE xrcaent = xrcbent AND xrcadocno = xrcbdocno AND xrcald  = xrcbld ",
                     " AND xrccent = xrcbent AND xrccdocno = xrcbdocno AND xrccld = xrcbld AND xrccseq = xrcbseq ",
                     " AND xrcaent = '",g_enterprise,"' ",
                     " AND xrcald  = '",p_ld,"' ",
                     " AND xrcadocdt <='",p_glav004_e,"' ",
                     " AND xrcastus ='Y' ",
                     " ORDER BY xrccdocno,xrccseq,xrcc001"
   
   PREPARE axrp910_xrea_prep1 FROM l_sql
   DECLARE axrp910_xrea_curs1  CURSOR FOR axrp910_xrea_prep1

   FOREACH axrp910_xrea_curs1 INTO l_xrea.xreaent,l_xrea.xreacomp,l_xrea.xreasite,l_xrea.xreald,
                                   l_xrea.xrea004,l_xrea.xrea005,l_xrea.xrea006,l_xrea.xrea007,
                                   l_xrea.xrea008,l_xrea.xrea009,l_xrea.xrea010,
                                   l_xrea.xrea011,l_xrea.xrea012,l_xrea.xrea013,l_xrea.xrea014,
                                   l_xrea.xrea015,l_xrea.xrea016,l_xrea.xrea017,l_xrea.xrea018,
                                   l_xrea.xrea019,l_xrea.xreaorga,l_xrea.xrea020,l_xrea.xrea021,
                                   l_xrea.xrea022,l_xrea.xrea023,l_xrea.xrea024,l_xrea.xrea025,
                                   l_xrea.xrea026,l_xrea.xrea027,l_xrea.xrea028,l_xrea.xrea029,
                                   l_xrea.xrea030,l_xrea.xrea031,l_xrea.xrea032,l_xrea.xrea033,
                                   l_xrea.xrea040,l_xrea.xrea041,  #稅別、稅率
                                   l_xrea.xrea034,l_xrea.xrea035,l_xrea.xrea036,l_xrea.xrea037,
                                   l_xrea.xrea038,l_xrea.xrea100,l_xrea.xrea101,l_xrea.xrea102,
                                   l_xrea.xrea103,l_xrea.xrea113,l_xrea.xrea122,l_xrea.xrea123,
                                   l_xrea.xrea132,l_xrea.xrea133
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET g_success = 'N'
         EXIT FOREACH
      END IF

      IF l_flag = '3' THEN
         CALL s_tax_chk(g_glaa.glaacomp,l_xrea.xrea040)
            RETURNING l_success,l_oodbl004,l_oodb005,l_xrea.xrea041,l_oodb011
      END IF

      #原幣未沖金額
      #xrcc108-xrcc109(扣除大於當期的沖帳金額,反推)
      IF l_xrea.xrea004[1,1] <> '0' THEN
         SELECT SUM(xrce109),SUM(xrce119),SUM(xrce129),SUM(xrce139)
         INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
         FROM xrce_t,xrda_t
         WHERE xrceent=xrdaent AND xrcedocno=xrdadocno AND xrceld=xrdald
         AND xrceent=g_enterprise AND xrceld=l_xrea.xreald 
         AND xrce003=l_xrea.xrea005 AND xrce004=l_xrea.xrea006 AND xrce005=l_xrea.xrea007
         AND xrdadocdt > p_glav004_e AND xrdastus='Y'
      ELSE
         SELECT SUM(xrcf105),SUM(xrcf115),SUM(xrcf125),SUM(xrcf135)
         INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
         FROM xrcf_t,xrca_t
         WHERE xrcfent=xrcaent AND xrcfdocno=xrcadocno AND xrcfld=xrcald
         AND xrcfent=g_enterprise AND xrcfld=l_xrea.xreald
         AND xrcf008=l_xrea.xrea005 AND xrcf009=l_xrea.xrea006
         AND xrcadocdt > p_glav004_e AND xrcastus='Y'
      END IF
      IF cl_null(l_xrce109) THEN LET l_xrce109=0 END IF
      IF cl_null(l_xrce119) THEN LET l_xrce119=0 END IF
      IF cl_null(l_xrce129) THEN LET l_xrce129=0 END IF
      IF cl_null(l_xrce139) THEN LET l_xrce139=0 END IF
      IF cl_null(l_xrea.xrea103) THEN LET l_xrea.xrea103=0 END IF
      IF cl_null(l_xrea.xrea113) THEN LET l_xrea.xrea113=0 END IF
      IF cl_null(l_xrea.xrea123) THEN LET l_xrea.xrea123=0 END IF
      IF cl_null(l_xrea.xrea133) THEN LET l_xrea.xrea133=0 END IF
      LET l_xrea.xrea103=l_xrea.xrea103 + l_xrce109
      LET l_xrea.xrea113=l_xrea.xrea113 + l_xrce119
      LET l_xrea.xrea123=l_xrea.xrea123 + l_xrce129
      LET l_xrea.xrea133=l_xrea.xrea133 + l_xrce139

      #20150315--add--str--#直接冲帐
      SELECT SUM(xrce109),SUM(xrce119),SUM(xrce129),SUM(xrce139)
         INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
         FROM xrce_t,xrca_t
         WHERE xrceent=xrcaent AND xrcedocno=xrcadocno AND xrceld=xrcald
         AND xrceent=g_enterprise AND xrceld=l_xrea.xreald
         AND xrce003=l_xrea.xrea005 AND xrce004=l_xrea.xrea006 AND xrce005=l_xrea.xrea007
         AND xrcadocdt > p_glav004_e AND xrcastus='Y'
      IF cl_null(l_xrce109) THEN LET l_xrce109=0 END IF
      IF cl_null(l_xrce119) THEN LET l_xrce119=0 END IF
      IF cl_null(l_xrce129) THEN LET l_xrce129=0 END IF
      IF cl_null(l_xrce139) THEN LET l_xrce139=0 END IF
      IF cl_null(l_xrea.xrea103) THEN LET l_xrea.xrea103=0 END IF
      IF cl_null(l_xrea.xrea113) THEN LET l_xrea.xrea113=0 END IF
      IF cl_null(l_xrea.xrea123) THEN LET l_xrea.xrea123=0 END IF
      IF cl_null(l_xrea.xrea133) THEN LET l_xrea.xrea133=0 END IF
      LET l_xrea.xrea103=l_xrea.xrea103 + l_xrce109
      LET l_xrea.xrea113=l_xrea.xrea113 + l_xrce119
      LET l_xrea.xrea123=l_xrea.xrea123 + l_xrce129
      LET l_xrea.xrea133=l_xrea.xrea133 + l_xrce139
      #20150315--add--end

      #應付回沖
      SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139)
        INTO l_apce109,l_apce119,l_apce129,l_apce139
        FROM apda_t,apce_t 
       WHERE apdaent = apceent AND apdald = apceld AND apdadocno = apcedocno
         AND apdaent = g_enterprise 
         AND apdadocdt > p_glav004_e
         AND apdasite = l_xrea.xreasite    #同一帳務中心
         AND apdald   = l_xrea.xreald       #同一帳套
         AND apce003 = l_xrea.xrea005 #AR 單號 
         AND apce004 = l_xrea.xrea006 #AR 項次 
         AND apce005 = l_xrea.xrea007 #AR 期別
         AND apdastus= 'Y'
      IF cl_null(l_apce109) THEN LET l_apce109=0 END IF
      IF cl_null(l_apce119) THEN LET l_apce119=0 END IF
      IF cl_null(l_apce129) THEN LET l_apce129=0 END IF
      IF cl_null(l_apce139) THEN LET l_apce139=0 END IF
      LET l_xrea.xrea103=l_xrea.xrea103 + l_apce109
      LET l_xrea.xrea113=l_xrea.xrea113 + l_apce119
      LET l_xrea.xrea123=l_xrea.xrea123 + l_apce129
      LET l_xrea.xrea133=l_xrea.xrea133 + l_apce139

      #150315 add 匯差調整-------
      IF l_glca002 = '3' THEN
         LET l_xrcc113 = 0 
         SELECT SUM(xreb115) INTO l_xrcc113
           FROM xreb_t
          WHERE xrebent = g_enterprise
            AND xrebld  = l_apca.apcald
            AND (xreb001 = g_master.xrea001 AND xreb002 > g_master.xrea002 OR xreb001 > g_master.xrea001)
            AND xreb003 = 'AR'
            AND xreb005 = l_tmp.apccdocno
            AND xreb006 = l_tmp.apccseq
            AND xreb007 = l_tmp.apcc001
         IF cl_null(l_xrcc113) THEN LET l_xrcc113 = 0 END IF
         LET l_xrea.xrea113=l_xrea.xrea113 - l_xrcc113
      END IF
      #150315 add 匯差調整 end---

      LET l_xrea.xrea103=s_curr_round(l_xrea.xreacomp,l_xrea.xrea100,l_xrea.xrea103,'2')
      LET l_xrea.xrea113=s_curr_round(l_xrea.xreacomp,l_xrea.xrea100,l_xrea.xrea113,'2')
      LET l_xrea.xrea123=s_curr_round(l_xrea.xreacomp,l_xrea.xrea100,l_xrea.xrea123,'2')
      LET l_xrea.xrea133=s_curr_round(l_xrea.xreacomp,l_xrea.xrea100,l_xrea.xrea133,'2')
      
      IF l_xrea.xrea103=0 AND l_xrea.xrea113=0 AND l_xrea.xrea123=0 AND l_xrea.xrea133=0 THEN
         CONTINUE FOREACH
      END IF
      
      #原幣暫估未沖未稅金額
      IF l_xrea.xrea004[1,1] ='0' THEN
         #含稅金額 = xrea103  
         #未稅金額 =  含稅金額 /(1+(稅率oodb006/100)) 
         # 依幣別設定小數位數四捨五入
         # 稅額 =  未稅金額 * 稅率     # 依幣別設定小數位數四捨五入
         #(未稅金額 +  稅額)  - 含稅金額 <> 0 表示有差額, 差額歸在未稅金額
         #原幣
         LET l_xrea.xrea106=l_xrea.xrea103
         LET l_xrea.xrea104=l_xrea.xrea106 / (1+(l_xrea.xrea041/100))
         LET l_xrea.xrea104=s_curr_round(l_xrea.xreacomp,l_xrea.xrea100,l_xrea.xrea104,'2')
         LET l_xrea.xrea105=l_xrea.xrea104 * l_xrea.xrea041/100
         LET l_xrea.xrea105=s_curr_round(l_xrea.xreacomp,l_xrea.xrea100,l_xrea.xrea105,'2')
         IF (l_xrea.xrea104 + l_xrea.xrea105 - l_xrea.xrea106) <> 0 THEN
            LET l_xrea.xrea104= l_xrea.xrea104 + (l_xrea.xrea104 + l_xrea.xrea105 - l_xrea.xrea106)
         END IF
         #本幣
         LET l_xrea.xrea116=l_xrea.xrea113
         LET l_xrea.xrea114=l_xrea.xrea116 / (1+(l_xrea.xrea041/100))
         LET l_xrea.xrea114=s_curr_round(l_xrea.xreacomp,g_glaa.glaa001,l_xrea.xrea114,'2')
         LET l_xrea.xrea115=l_xrea.xrea114 * l_xrea.xrea041/100
         LET l_xrea.xrea115=s_curr_round(l_xrea.xreacomp,g_glaa.glaa001,l_xrea.xrea115,'2')
         IF (l_xrea.xrea114 + l_xrea.xrea115 - l_xrea.xrea116) <> 0 THEN
            LET l_xrea.xrea114= l_xrea.xrea114 + (l_xrea.xrea114 + l_xrea.xrea115 - l_xrea.xrea116)
         END IF
      ELSE
         LET l_xrea.xrea104=0
         LET l_xrea.xrea105=0
         LET l_xrea.xrea106=0
         LET l_xrea.xrea114=0
         LET l_xrea.xrea115=0
         LET l_xrea.xrea116=0
      END IF
      LET l_xrea.xrea001 = g_master.xrea001 #年度
      LET l_xrea.xrea002 = g_master.xrea002 #期別
      LET l_xrea.xrea003 = 'AR'  #來源模組
      #責任中心（部門對應的責任中心）
      IF l_flag = '1' OR l_flag = '2' THEN
         SELECT ooeg004 INTO l_xrea.xrea012 FROM ooeg_t
         WHERE ooegent=g_enterprise AND ooeg001=l_xrea.xrea011
      END IF
      #信評等級
      SELECT pmab004 INTO l_xrea.xrea039 FROM pmab_t  
       WHERE pmabent = g_enterprise AND pmab001 = l_xrea.xrea009 AND pmabsite = l_xrea.xreacomp 
      #稅率
      IF l_flag='3' THEN
         SELECT oodb006 INTO l_xrea.xrea041 FROM oodb_t
         WHERE oodbent=g_enterprise AND oodb002=l_xrea.xrea040
         AND oodb001=(SELECT ooef019 FROM ooef_t WHERE ooefent=g_enterprise AND ooef001=l_xrea.xreacomp)
      END IF
       
      INSERT INTO xrea_t VALUES (l_xrea.*)
      IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "insert xrea_t" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         LET g_success = 'N'
      END IF
   END FOREACH
END FUNCTION]]>
  </point>
  <point name="function.axrp910_clik_chk" order="5" ver="4" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 勾選單身時的檢核
# Memo...........: 因為規格變更,如果已經有產生過月結資料
#                : 就一定要做還原,所以把檢核拉前到勾選的位置
# Usage..........: CALL axrp910_clik_chk(p_ac)
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_clik_chk(p_ac,p_type)
   DEFINE p_ac              LIKE type_t.num5
   DEFINE p_type            LIKE type_t.chr1    #0:檢查不報錯   1:檢查、報錯   #2:僅檢查是否已存在月結資料
   DEFINE l_count           LIKE type_t.num5
   DEFINE l_glca002         LIKE glca_t.glca002
   DEFINE l_msg             STRING
   DEFINE r_success         LIKE type_t.num5
   
   LET g_errno = NULL
   LET r_success = TRUE
   IF cl_null(p_ac) OR p_ac <= 0 THEN
      RETURN 
   END IF
   
   #檢核 帳別+年度+期別+AR 有存在就提示要做還原
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM xrea_t
    WHERE xreaent = g_enterprise
      AND xreald  = g_detail_d[p_ac].xreald
      AND xrea001 = g_master.xrea001
      AND xrea002 = g_master.xrea002
      AND xrea003 = 'AR'
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   IF l_count > 0 THEN
      LET g_errno   = 'axr-00291'
   END IF

   IF NOT cl_null(g_errno) AND p_type = '1' THEN
      LET l_msg = cl_getmsg('aap-00152',g_lang) CLIPPED,':',g_detail_d[l_ac].xreald,
                  cl_getmsg(g_errno,g_lang) CLIPPED
      IF NOT cl_ask_confirm2('',l_msg)THEN
         LET g_detail_d[l_ac].sel = 'N'
         DISPLAY g_detail_d[l_ac].sel TO b_sel
      END IF
   END IF

   IF NOT cl_null(g_errno) THEN LET r_success = FALSE END IF

   IF NOT cl_null(g_errno) AND p_type = '0' THEN RETURN r_success END IF

   IF p_type = '2' THEN RETURN r_success END IF

   LET g_errno = NULL
   #檢查重評價檔是否計算
   SELECT glca002 INTO l_glca002
     FROM glca_t
    WHERE glcald = g_detail_d[p_ac].xreald AND glca001 = 'AR'
   IF l_glca002 MATCHES '[23]' THEN    
      LET l_count = NULL
      SELECT COUNT(*) INTO l_count FROM xreb_t
       WHERE xrebent = g_enterprise
         AND xrebld  = g_detail_d[p_ac].xreald
         AND xreb001 = g_master.xrea001
         AND xreb002 = g_master.xrea002
         AND xreb003 = 'AR'
         
      IF cl_null(l_count)THEN LET l_count = 0 END IF
      IF l_count = 0 THEN       
         LET g_errno   = 'aap-00321'
      END IF
   END IF

   IF NOT cl_null(g_errno) AND p_type = '1' THEN
      LET l_msg = cl_getmsg('aap-00152',g_lang) CLIPPED,':',g_detail_d[l_ac].xreald,
                  cl_getmsg(g_errno,g_lang) CLIPPED
      IF NOT cl_ask_confirm2('',l_msg)THEN
         LET g_detail_d[l_ac].sel = 'N'
         DISPLAY g_detail_d[l_ac].sel TO b_sel
      END IF
   END IF

   IF NOT cl_null(g_errno) THEN LET r_success = FALSE END IF

   RETURN r_success

END FUNCTION]]>
  </point>
  <point name="function.axrp910_axrp970" order="6" ver="2" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 若再次拋轉已做月結的帳套,需要先執行月結還原
# Memo...........:
# Usage..........: CALL axrp910_axrp970(p_ac)
#                  RETURNING r_success
# Input parameter: 
# Return code....: 
# Date & Author..: 2015/01/28 By zhangweib
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_axrp970(p_ac)
   DEFINE p_ac              LIKE type_t.num5
   DEFINE l_count           LIKE type_t.num5
   DEFINE l_success         LIKE type_t.num5
   DEFINE l_msg             STRING
   DEFINE r_success         LIKE type_t.num5

   #由axrp970複製到此處,如果修改就必須同步axrp970!!!

   LET r_success = TRUE
   LET l_success = TRUE

   #檢查是否有暫估傳票(xrem005) 及壞帳提列傳票(xrej005) 
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM xrem_t
    WHERE xrement = g_enterprise
      AND xremld  = g_detail_d[p_ac].xreald
      AND xrem001 = g_master.xrea001
      AND xrem002 = g_master.xrea002
      AND xrem003 = 'AR'
      AND xrem005 IS NOT NULL
   IF cl_null(l_count)THEN LET l_count = 0 END IF      
   IF l_count <> 0 THEN
      LET l_success = FALSE
      INITIALIZE g_errparam TO NULL
      LET l_msg = "ld:",g_detail_d[p_ac].xreald," "
      LET g_errparam.extend = l_msg CLIPPED
      LET g_errparam.code   = "aap-00220"
      LET g_errparam.replace[1] = g_master.xrea001
      LET g_errparam.replace[2] = g_master.xrea002
      LET g_errparam.popup  = TRUE
      CALL cl_err()
   END IF
   IF NOT l_success THEN LET r_success = FALSE END IF

   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM xrej_t
    WHERE xrejent = g_enterprise
      AND xrejld  = g_detail_d[p_ac].xreald
      AND xrej001 = g_master.xrea001
      AND xrej002 = g_master.xrea002
      AND xrej003 = 'AR'
      AND xrej005 IS NOT NULL
   IF cl_null(l_count)THEN LET l_count = 0 END IF      
   IF l_count <> 0 THEN
      INITIALIZE g_errparam TO NULL
      LET l_msg = "ld:",g_detail_d[p_ac].xreald," "
      LET g_errparam.extend = l_msg CLIPPED
      LET g_errparam.code   = "aap-00221"
      LET g_errparam.replace[1] = g_master.xrea001
      LET g_errparam.replace[2] = g_master.xrea002
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      LET l_success = FALSE
   END IF
   IF NOT l_success THEN LET r_success = FALSE END IF

   IF NOT r_success THEN RETURN r_success END IF

   #刪除暫估主檔(XREM_T)
   DELETE FROM xrem_t
    WHERE xrement = g_enterprise
      AND xremld  = g_detail_d[p_ac].xreald
      AND xrem001 = g_master.xrea001
      AND xrem002 = g_master.xrea002
      AND xrem003 = 'AR'            
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "ld:",g_detail_d[p_ac].xreald," xrem_t del "
      LET g_errparam.code   = SQLCA.SQLCODE
      LET g_errparam.popup  = TRUE
      CALL cl_err() 
      LET l_success = FALSE 
   END IF
   IF NOT l_success THEN LET r_success = FALSE END IF   

   #刪除暫估明細檔(XREN_T)
   DELETE FROM xren_t
    WHERE xrenent = g_enterprise
      AND xren001 = g_master.xrea001
      AND xren002 = g_master.xrea002    
      AND EXISTS(SELECT COUNT(*) FROM xrem_t
                  WHERE xrement = xrenent
                    AND xremdocno = xrendocno
                    AND xremld    = g_detail_d[p_ac].xreald
                    AND xrem003   = 'AR')                          
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "ld:",g_detail_d[p_ac].xreald," xren_t del "
      LET g_errparam.code   = SQLCA.SQLCODE
      LET g_errparam.popup  = TRUE
      CALL cl_err()        
      LET l_success = FALSE   
   END IF  
   IF NOT l_success THEN LET r_success = FALSE END IF      

   #刪除壞帳主檔(XREJ_T)
   DELETE FROM xrej_t
    WHERE xrejent = g_enterprise
      AND xrejld  = g_detail_d[p_ac].xreald
      AND xrej001 = g_master.xrea001
      AND xrej002 = g_master.xrea002             
      AND xrej003 = 'AR'
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "ld:",g_detail_d[p_ac].xreald," xrej_t del "
      LET g_errparam.code   = SQLCA.SQLCODE
      LET g_errparam.popup  = TRUE
      CALL cl_err()        
      LET l_success = FALSE  
   END IF  
   IF NOT l_success THEN LET r_success = FALSE END IF  

   #刪除壞帳明細檔(XREK_T)
   DELETE FROM xrek_t
    WHERE xrekent = g_enterprise
      AND xrek001 = g_master.xrea001
      AND xrek002 = g_master.xrea002    
      AND EXISTS(SELECT COUNT(*) FROM xrej_t
                  WHERE xrejent = xrekent
                    AND xrejdocno = xrekdocno
                    AND xrejld    = g_detail_d[p_ac].xreald
                    AND xrej003   = 'AR')                          
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "ld:",g_detail_d[p_ac].xreald," xrek_t del "
      LET g_errparam.code   = SQLCA.SQLCODE
      LET g_errparam.popup  = TRUE
      CALL cl_err()        
      LET l_success = FALSE  
   END IF    
   IF NOT l_success THEN LET r_success = FALSE END IF 

   #刪除月結檔(XREA_T)
   DELETE FROM xrea_t
    WHERE xreaent = g_enterprise
      AND xrea001 = g_master.xrea001
      AND xrea002 = g_master.xrea002
      AND xreald  = g_detail_d[p_ac].xreald
      AND xrea003 = 'AR'
   IF SQLCA.SQLCODE THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "ld:",g_detail_d[p_ac].xreald," xrea_t del "
      LET g_errparam.code   = SQLCA.SQLCODE
      LET g_errparam.popup  = TRUE
      CALL cl_err()        
      LET l_success = FALSE 
   END IF            
   IF NOT l_success THEN LET r_success = FALSE END IF 

   RETURN r_success

END FUNCTION]]>
  </point>
  <point name="function.axrp910_aglp590" order="7" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 底稿月结
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp910_aglp590()
   DEFINE l_success      LIKE type_t.num5
   DEFINE t_success      LIKE type_t.num5
   DEFINE l_i            LIKE type_t.num5

   LET l_success = TRUE
   LET t_success = TRUE
   CALL s_transaction_begin()
   CALL cl_err_collect_init()
   FOR l_i = 1 TO g_detail_d.getLength()
      IF g_detail_d[l_i].sel = "Y" THEN
         CALL s_aglp590_ins(g_detail_d[l_i].xreald,g_master.xrea001,g_master.xrea002,'AR') RETURNING l_success
         IF NOT l_success THEN
            LET t_success = FALSE
         END IF
      END IF

   END FOR

   IF NOT t_success THEN
      CALL cl_err_collect_show()
      CALL s_transaction_end('N','0')
   ELSE
      CALL s_transaction_end('Y','0')
      CALL cl_err_collect_init()
      CALL cl_err_collect_show()
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 'axm-00088'
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF

END FUNCTION]]>
  </point>
  <point name="b_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success       LIKE type_t.chr1
   DEFINE l_glaa003       LIKE glaa_t.glaa003]]>
  </point>
  <point name="b_fill.foreach_into" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   g_detail_d[l_ac].sel,g_detail_d[l_ac].xreald,g_detail_d[l_ac].xreald_desc,g_detail_d[l_ac].xreacomp,
   g_detail_d[l_ac].xreacomp_desc,g_detail_d[l_ac].period,g_detail_d[l_ac].glav004_s,g_detail_d[l_ac].glav004_e]]>
  </point>
  <point name="b_fill.foreach_iside" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      CALL s_axrt300_xrca_ref('xrcald',g_detail_d[l_ac].xreald,'','')
         RETURNING l_success,g_detail_d[l_ac].xreald_desc
      LET g_detail_d[l_ac].xreald_desc = g_detail_d[l_ac].xreald,"(",g_detail_d[l_ac].xreald_desc,")"

      CALL s_axrt300_xrca_ref('xrcasite',g_detail_d[l_ac].xreacomp,'','')
         RETURNING l_success,g_detail_d[l_ac].xreacomp_desc
      LET g_detail_d[l_ac].xreacomp_desc = g_detail_d[l_ac].xreacomp,"(",g_detail_d[l_ac].xreacomp_desc,")"

      SELECT MAX(xrea001 ||'/'||xrea002) INTO g_detail_d[l_ac].period
        FROM xrea_t
       WHERE xreaent = g_enterprise
         AND xreald = g_detail_d[l_ac].xreald
         AND xrea003 = 'AR'
       GROUP BY xreald,xreacomp

      SELECT glaa003 INTO l_glaa003 FROM glaa_t 
       WHERE glaaent = g_enterprise AND glaald = g_detail_d[l_ac].xreald

      SELECT MIN(glav004),MAX(glav004) 
        INTO g_detail_d[l_ac].glav004_s,g_detail_d[l_ac].glav004_e
        FROM glav_t 
       WHERE glavent = g_enterprise
         AND glav001 = l_glaa003
         AND glav002 = g_master.xrea001
         AND glav006 = g_master.xrea002]]>
  </point>
  <point name="b_fill.other_table" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL g_detail_d.deleteElement(g_detail_d.getLength())]]>
  </point>
  <point name="b_fill.sql_before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   #取得帳務組織下所屬成員
   CALL s_fin_account_center_sons_query('3',g_master.xreasite,g_today,'1')
   #取得帳務組織下所屬成員之帳別   
   CALL s_fin_account_center_ld_str() RETURNING ls_wc
   #將取回的字串轉換為SQL條件
   CALL s_fin_get_wc_str(ls_wc) RETURNING ls_wc
   
   LET g_sql =" SELECT 'N',glaald,'',glaacomp,'','','','' FROM glaa_t ",
              "  WHERE glaaent = ? ",
              "    AND glaald IN ",ls_wc,    
              "  ORDER BY glaald,glaacomp "]]>
  </point>
  <point name="global.argv" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#單头 type 宣告
TYPE type_g_master RECORD
       xreasite           LIKE xrea_t.xreasite, 
       xreasite_desc      LIKE ooefl_t.ooefl003,
       xrea001            LIKE xrea_t.xrea001,
       xrea002            LIKE xrea_t.xrea002
       END RECORD

#模組變數(Module Variables)
DEFINE g_master         type_g_master
DEFINE g_master_t       type_g_master
DEFINE g_glaa           RECORD LIKE glaa_t.*
DEFINE g_success        LIKE type_t.chr1
DEFINE g_detail_idx     LIKE type_t.num5]]>
  </point>
  <point name="global.memo" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[# Modify.....: 150126-00011#01 15/01/28 By zhangwei      1.單身勾選帳套或toolbar單選時,已有月結資料,則詢問"已有月結資料,是否重新執行月結?"
#                                                          若確定勾選則 執行時背景 CALL axrp970 
#                                                          若axrp970　檢核時重評或暫估已有轉傳票不可還原時，也要回饋完整訊息
#                                                        ２.toolbar 全選時 已有月結資料的帳套不可自動打勾
#150518-00043#5 2015/05/26 By 01727 不依帳套詢問是重覆執行,只在執行時詢問一次]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[     sel               LIKE type_t.chr1,
     xreald            LIKE xrea_t.xreald,
     xreald_desc       LIKE type_t.chr500,
     xreacomp          LIKE xrea_t.xreacomp,
     xreacomp_desc     LIKE type_t.chr500,
     period            LIKE type_t.chr20,
     glav004_s         LIKE glav_t.glav004,
     glav004_e         LIKE glav_t.glav004
                  END RECORD ]]>
  </point>
  <point name="init.init" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL s_fin_set_comp_scc('xrea001','43')
   CALL s_fin_set_comp_scc('xrea002','111')
   CALL s_fin_create_account_center_tmp() ]]>
  </point>
  <point name="query.define" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[]]>
  </point>
  <point name="ui_dialog.define" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_xrea001         LIKE xrea_t.xrea001
   DEFINE l_xrea002         LIKE xrea_t.xrea002
   DEFINE l_site            LIKE xrcb_t.xrcbsite
   DEFINE l_ooef017         LIKE ooef_t.ooef017
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_flag            LIKE type_t.dat]]>
  </point>
  <point name="ui_dialog.for.onaction_selall" order="" ver="5" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[              #CALL axrp910_clik_chk(li_idx,'0') RETURNING l_success
              #IF NOT cl_null(g_errno) THEN
              #   LET g_detail_d[li_idx].sel = 'N'                    
              #END IF]]>
  </point>
  <point name="ui_dialog.more_action" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ON ACTION batch_execute
            CALL axrp910_cycle_ld()
            CALL axrp910_b_fill()]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#         DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
# 
#            BEFORE DISPLAY
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
#               LET l_ac = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_ac
#               CALL axrp910_b_fill()
# 
#         END DISPLAY]]>
  </point>
  <point name="ui_dialog.more_input" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         INPUT BY NAME g_master.xreasite,g_master.xrea001,g_master.xrea002

            BEFORE INPUT
               IF cl_null(g_master_t.xreasite) THEN
                  CALL axrp910_def()
               ELSE
                  LET g_master.* = g_master_t.*
               END IF
               DISPLAY g_master.xreasite,g_master.xreasite_desc,g_master.xrea001,g_master.xrea002
                    TO xreasite,xreasite_desc,xrea001,xrea002

            BEFORE FIELD xreasite
               LET l_site = g_master.xreasite

            AFTER FIELD xreasite
               IF NOT cl_null(g_master.xreasite) THEN
                  #資料存在性、有效性檢查
                  LET g_errno = ' '
                  CALL s_fin_account_center_chk(g_master.xreasite,'',3,g_today) RETURNING l_success,g_errno
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_master.xreasite
                     LET g_errparam.code   = g_errno
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET g_master.xreasite = l_site
                     CALL s_desc_get_department_desc(g_master.xreasite) RETURNING g_master.xreasite_desc
                     DISPLAY g_master.xreasite_desc TO xreasite_desc
                     NEXT FIELD CURRENT
                  END IF
                  SELECT ooef017 INTO l_ooef017 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_master.xreasite
               END IF
               CALL s_desc_get_department_desc(g_master.xreasite) RETURNING g_master.xreasite_desc
               #取得帳務中心歸屬法人 141223
               SELECT ooef017 INTO l_ooef017 FROM ooef_t WHERE ooefent = g_enterprise
                  AND ooef001 = g_master.xreasite
               LET l_flag = cl_get_para(g_enterprise,l_ooef017,'S-FIN-2007')   #关账日期

               LET g_master.xrea001 = YEAR(l_flag)
               LET g_master.xrea002 = MONTH(l_flag)
               DISPLAY g_master.xreasite_desc,g_master.xrea001,g_master.xrea002 TO xreasite_desc,xrea001,xrea002

            BEFORE FIELD xrea001
               LET l_xrea001 = g_master.xrea001

            ON CHANGE xrea001
               IF NOT cl_null(g_master.xrea001) THEN
                  CALL axrp910_date_chk()
                  IF NOT cl_null(g_errno) THEN
                     LET g_errparam.extend = g_master.xrea001
                     LET g_errparam.code   = g_errno
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET g_master.xrea001 = l_xrea001
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_master.xrea002) THEN
                     CALL axrp910_b_fill()
                  END IF
               END IF

            BEFORE FIELD xrea002
               LET l_xrea002 = g_master.xrea002

            ON CHANGE xrea002
               IF NOT cl_null(g_master.xrea002) THEN
                  CALL axrp910_date_chk()
                  IF NOT cl_null(g_errno) THEN
                     LET g_errparam.extend = g_master.xrea002
                     LET g_errparam.code   = g_errno
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET g_master.xrea002 = l_xrea002
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_master.xrea001) THEN
                     CALL axrp910_b_fill()
                  END IF
               END IF

            ON ACTION controlp INFIELD xreasite
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.xreasite       #給予default值
               LET g_qryparam.where = " ooef201 = 'Y' "
               CALL q_ooef001()                                #呼叫開窗
               LET g_master.xreasite = g_qryparam.return1        #將開窗取得的值回傳到變數
               DISPLAY g_master.xreasite TO xreasite               #顯示到畫面上
               CALL s_desc_get_department_desc(g_master.xreasite) RETURNING g_master.xreasite_desc
               DISPLAY g_master.xreasite_desc TO xreasite_desc
               NEXT FIELD xreasite                               #返回原欄位

         END INPUT  
         INPUT ARRAY g_detail_d FROM s_detail1.*
             ATTRIBUTE(COUNT = g_detail_cnt,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                       INSERT ROW = FALSE,
                       DELETE ROW = FALSE,
                       APPEND ROW = FALSE)    
            ON CHANGE sel
               LET l_ac = ARR_CURR()
               IF g_detail_d[l_ac].sel = 'Y' THEN
                 #CALL axrp910_clik_chk(l_ac,'1')   #150518-00043#5 Mark
               END IF
         END INPUT]]>
  </point>
  <point name="ui_dialog.onaction_sel" order="" ver="4" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
                 #CALL axrp910_clik_chk(li_idx,'1')   #150518-00043#5 Mark
                 #IF NOT cl_null(g_errno) THEN
                 #   INITIALIZE g_errparam TO NULL
                 #   LET g_errparam.code = g_errno
                 #   LET g_errparam.extend = ''
                 #   LET g_errparam.popup = TRUE
                 #   CALL cl_err()
                 #   LET g_detail_d[li_idx].sel = 'N'                     
                 #END IF
               END IF
            END FOR]]>
  </point>
  <point name="ui_dialog.qbeclear" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CLEAR FORM
            INITIALIZE g_master.* TO NULL
            CALL axrp910_def()]]>
  </point>
  <section id="axrp910.b_fill" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION axrp910_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   {<point name="b_fill.define" edit="s"/>}
   #end add-point
   #add-point:b_fill段define
   {<point name="b_fill.define_customerization" edit="c"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
 
   PREPARE axrp910_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR axrp910_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   {<point name="b_fill.clear"/>}
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   {<point name="b_fill.foreach_into"/>}
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      {<point name="b_fill.foreach_iside"/>}
      #end add-point
      
      CALL axrp910_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.other_table"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE axrp910_sel
   
   LET l_ac = 1
   CALL axrp910_fetch()
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.after_b_fill"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="axrp910.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:5,PR版次:5) Build-000213
#+ 
#+ Filename...: axrp910
#+ Description: 應收帳款期末月結作業
#+ Creator....: 02599(2014-10-27 17:25:08)
#+ Modifier...: 02599(2014-11-07 11:24:28) -SD/PR-
]]>
  </section>
  <section id="axrp910.detail_show" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION axrp910_detail_show()
   #add-point:show段define
   {<point name="detail_show.define" edit="s"/>}
   #end add-point
   #add-point:show段define
   {<point name="detail_show.define_customerization" edit="c"/>}
   #end add-point
   
   #add-point:detail_show段
   {<point name="detail_show.detail_show"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="axrp910.fetch" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION axrp910_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   {<point name="fetch.define" edit="s"/>}
   #end add-point
   #add-point:fetch段define
   {<point name="fetch.define_customerization" edit="c"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="axrp910.filter" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION axrp910_filter()
   #add-point:filter段define
   {<point name="filter.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter.define_customerization" edit="c"/>}
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   {<point name="filter.detail_cnt"/>}
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL axrp910_b_fill()
   
END FUNCTION
]]>
  </section>
  <section id="axrp910.filter_parser" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ filter欄位解析
PRIVATE FUNCTION axrp910_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   {<point name="filter_parser.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter_parser.define_customerization" edit="c"/>}
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
  </section>
  <section id="axrp910.filter_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION axrp910_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = axrp910_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
  </section>
  <section id="axrp910.global" ver="11" status="" src="s" readonly="">
    <![CDATA[#應用 p02 樣板自動產生(Version:13)
{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#{<point name="global.inc" />}
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="axrp910.init" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION axrp910_init()
   #add-point:init段define
   {<point name="init.define" edit="s"/>}
   #end add-point   
   #add-point:init段define
   {<point name="init.define_customerization" edit="c"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp910.main" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   {<point name="main.define" edit="s"/>}
   #end add-point   
   #add-point:main段define
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("axr","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_axrp910 WITH FORM cl_ap_formpath("axr",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL axrp910_init()   
 
      #進入選單 Menu (="N")
      CALL axrp910_ui_dialog() 
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_axrp910
   END IF 
   
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
  </section>
  <section id="axrp910.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="axrp910.query" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION axrp910_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   {<point name="query.define" edit="s" />}
   #end add-point 
   #add-point:query段define
   {<point name="query.define_customerization" edit="c" />}
   #end add-point 
    
   #add-point:cs段after_construct
   {<point name="query.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL axrp910_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   {<point name="query.cs段after_query" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp910.ui_dialog" ver="8" status="" src="s" readonly="">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION axrp910_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define" edit="s"/>}
   #end add-point 
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define_customerization" edit="c"/>}
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL axrp910_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.selall.befroe"/>}
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               {<point name="ui_dialog.for.onaction_selall"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               {<point name="ui_dialog.for.onaction_selnone"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL axrp910_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            {<point name="ui_dialog.before_accept"/>}
            #end add-point
            CALL axrp910_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            {<point name="ui_dialog.datarefresh"/>}
            #end add-point
            CALL axrp910_b_fill()
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
  </section>
</add_points>
