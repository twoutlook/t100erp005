<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="axrp400" std_prog="axrp400" erpver="1.0" module="AXR" ver="1" env="s" zone="t10prd" booking="Y" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="W" status=""/>
    <free_style value="N" status=""/>
    <start_arg value="" status=""/>
  </other>
  <point name="function.axrp400_xrcasite_chk" order="1" ver="1" cite_std="N" new="Y" status="d" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_xrcasite_chk(p_site,p_user,p_ld)
   DEFINE p_site      LIKE xrca_t.xrcasite
   DEFINE p_user      LIKE xrca_t.xrca003
   DEFINE p_ld        LIKE xrca_t.xrcald
   DEFINE l_ooeastus  LIKE ooea_t.ooeastus
   DEFINE l_xrahstus  LIKE xrah_t.xrahstus
   DEFINE l_xrah007   LIKE xrah_t.xrah007
   DEFINE l_ooagstus  LIKE ooag_t.ooagstus
   DEFINE l_cnt       LIKE type_t.num5
   DEFINE l_success   LIKE type_t.num5
   
   LET g_errno = ' '
   
   IF cl_null(p_site) THEN RETURN END IF
   IF cl_null(p_ld)   THEN RETURN END IF
   
   #帳套下屬於法人否檢查
    SELECT COUNT(*) INTO l_cnt FROM glaa_t,ooef_t,xrah_t 
    WHERE glaald   = p_ld
      AND glaacomp = ooef017 
      AND glaaent  = ooefent 
      AND ooef001  = xrah004 
      AND ooefent  = xrahent 
      AND xrah002  = p_site
      AND xrah001  = 1
      
   IF l_cnt < 1 OR cl_null(l_cnt) THEN
      LET g_errno = 'axr-00089' RETURN
   END IF
   
   IF cl_null(p_user) THEN RETURN g_errno END IF
   
   #人員對應帳套使用權限檢查
   IF NOT cl_null(p_ld) AND NOT cl_null(p_user) THEN
      CALL s_ld_chk_authorization(p_user,p_ld) 
         RETURNING l_success
      IF l_success = FALSE THEN
         LET g_errno = 'axr-00022' RETURN
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="function.axrp400_xrdasite_chk" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_xrdasite_chk(p_site,p_user,p_ld)
   DEFINE p_site      LIKE xrda_t.xrdasite
   DEFINE p_user      LIKE xrca_t.xrca003
   DEFINE p_ld        LIKE xrca_t.xrcald
   DEFINE l_ooeastus  LIKE ooea_t.ooeastus
   DEFINE l_xrahstus  LIKE xrah_t.xrahstus
   DEFINE l_xrah007   LIKE xrah_t.xrah007
   DEFINE l_ooagstus  LIKE ooag_t.ooagstus
   DEFINE l_cnt       LIKE type_t.num5
   DEFINE l_success   LIKE type_t.num5
   
   LET g_errno = ' '
   
   IF cl_null(p_site) THEN RETURN END IF
   IF cl_null(p_ld)   THEN RETURN END IF
   
   #帳套下屬於法人否檢查
    SELECT COUNT(*) INTO l_cnt FROM glaa_t,ooef_t,xrah_t 
    WHERE glaald   = p_ld
      AND glaacomp = ooef017 
      AND glaaent  = ooefent 
      AND ooef001  = xrah004 
      AND ooefent  = xrahent 
      AND xrah002  = p_site
      AND xrah001  = 1
      
   IF l_cnt < 1 OR cl_null(l_cnt) THEN
      LET g_errno = 'axr-00089' RETURN
   END IF
   
   IF cl_null(p_user) THEN RETURN g_errno END IF
   
   #人員對應帳套使用權限檢查
   IF NOT cl_null(p_ld) AND NOT cl_null(p_user) THEN
      CALL s_ld_chk_authorization(p_user,p_ld) 
         RETURNING l_success
      IF l_success = FALSE THEN
         LET g_errno = 'axr-00022' RETURN
      END IF
   END IF
END FUNCTION]]>
  </point>
  <point name="function.axrp400_xrca_dis" order="2" ver="1" cite_std="N" new="Y" status="d" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_xrca_dis(p_lab)
   DEFINE p_lab             LIKE type_t.chr10
   DEFINE l_xrcacomp_desc   LIKE type_t.chr80
   DEFINE l_success         LIKE type_t.chr1

   CASE
      WHEN p_lab = 'site'
         CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdasite,'','') RETURNING l_success,g_master.xrdasite_desc
         DISPLAY BY NAME g_master.xrdasite_desc

      WHEN p_lab = 'ld'
         CALL s_axrt300_xrca_ref('xrcald',g_master.xrdald,'','') RETURNING l_success,g_master.xrdald_desc
         SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
         LET g_master.xrdacomp_desc = g_glaa.glaacomp
         CALL s_axrt300_xrda_ref('xrcasite',g_master.xrdacomp_desc,'','') RETURNING l_success,l_xrcacomp_desc
         IF NOT cl_null(g_master.xrdacomp_desc) THEN LET g_master.xrdacomp_desc = g_master.xrdacomp_desc,'(',l_xrcacomp_desc,')' END IF
         CALL s_axrt300_sel_ld(g_master.xrdald) RETURNING l_success,g_ls
         DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc

   END CASE
END FUNCTION]]>
  </point>
  <point name="function.axrp400_xrda_dis" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_xrda_dis(p_lab)
   DEFINE p_lab             LIKE type_t.chr10
   DEFINE l_xrcacomp_desc   LIKE type_t.chr80
   DEFINE l_success         LIKE type_t.chr1

   CASE
      WHEN p_lab = 'site'
         CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdasite,'','') RETURNING l_success,g_master.xrdasite_desc
         DISPLAY BY NAME g_master.xrdasite_desc

      WHEN p_lab = 'ld'
         CALL s_axrt300_xrca_ref('xrcald',g_master.xrdald,'','') RETURNING l_success,g_master.xrdald_desc
         SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
         LET g_master.xrdacomp_desc = g_glaa.glaacomp
         CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdacomp_desc,'','') RETURNING l_success,l_xrcacomp_desc
         IF NOT cl_null(g_master.xrdacomp_desc) THEN LET g_master.xrdacomp_desc = g_master.xrdacomp_desc,'(',l_xrcacomp_desc,')' END IF
         CALL s_axrt300_sel_ld(g_master.xrdald) RETURNING l_success,g_ls
         DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc

   END CASE
END FUNCTION]]>
  </point>
  <point name="function.axrp400_def" order="3" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_def()
   DEFINE l_xrcacomp_desc         LIKE type_t.chr500
   DEFINE l_success               LIKE type_t.chr1
   DEFINE l_cnt                   LIKE type_t.num5
   DEFINE l_sql                   STRING
   DEFINE l_xrcacomp              LIKE xrca_t.xrcacomp

   IF cl_null(g_master.diff) THEN LET g_master.diff = '1' END IF
   IF cl_null(g_master.chk) THEN LET g_master.chk = 'N' END IF
   
   #帳務中心
   #取得預設的帳務中心,因新增階段的時候,並不會知道site,所以以登入人員做為依據
   CALL s_fin_get_account_center('',g_user,'3',g_today) RETURNING l_success,g_master.xrdasite,g_errno
   #該帳務中心與帳別無法勾稽到,以登入人員g_user取得預設帳別/法人
   CALL s_fin_orga_get_comp_ld(g_master.xrdasite) RETURNING l_success,g_errno,l_xrcacomp,g_master.xrdald
    
   #若取不出資料,則不預設帳別
   IF NOT l_success THEN
      LET g_master.xrdald   = ''
   END IF
   CALL s_axrt300_sel_ld(g_master.xrdald) RETURNING l_success,g_ls
   SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
   LET g_master.xrdacomp_desc = g_glaa.glaacomp

   CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdasite,'','') RETURNING l_success,g_master.xrdasite_desc
   CALL s_axrt300_xrca_ref('xrcald',g_master.xrdald,'','') RETURNING l_success,g_master.xrdald_desc
   CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdacomp_desc,'','') RETURNING l_success,l_xrcacomp_desc
   IF NOT cl_null(g_master.xrdacomp_desc) THEN LET g_master.xrdacomp_desc = g_master.xrdacomp_desc,'(',l_xrcacomp_desc,')' END IF
   IF cl_null(g_master.xrda003) THEN LET g_master.xrda003_desc = '' END IF
   DISPLAY BY NAME g_master.xrda003_desc
   DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdasite_desc,g_master.xrdacomp_desc
END FUNCTION]]>
  </point>
  <point name="function.axrp400_ref_xrda003" order="4" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ref_xrda003()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_master.xrda003
   CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
   LET g_master.xrda003_desc = '', g_rtn_fields[1] , ''
   DISPLAY BY NAME g_master.xrda003,g_master.xrda003_desc
END FUNCTION]]>
  </point>
  <point name="function.axrp400_get_sql" order="5" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_get_sql()
   DEFINE ls_ac         LIKE type_t.num5
   DEFINE l_cmd         LIKE type_t.num5
   DEFINE l_flag        LIKE type_t.chr1
   DEFINE l_str         STRING
   DEFINE l_sub_sql     STRING
   DEFINE ls_wc         STRING
   DEFINE ls_wc1        STRING
   DEFINE ls_wc2        STRING
   DEFINE ls_wc3        STRING

   #NM  資料的獲取
   LET g_wc_nm = "SELECT nmbbdocno,nmbbseq FROM axrp400_tmp ",
                 " WHERE nmbb026 = ? AND sel = 'Y' "
    
   #AR  資料的獲取
   LET g_wc_ar = "SELECT xrcadocno,xrccseq,xrcc001",
                 "  FROM axrp400_tmp",
                 " WHERE nmbb026 = ? AND sel1 = 'Y' "
                 
   #計算帳款部分
   LET g_wc_ap ="SELECT * FROM apcc_t,apca_t,gzcb_t",
           " WHERE apccent = '",g_enterprise,"'",
           "   AND apccld = apcald",
           "   AND apccdocno = apcadocno",
           "   AND apccent = apcaent ",
           "   AND apcastus = 'Y'",
           "   AND apcacomp = '",g_glaa.glaacomp,"'",
           "   AND apcald = '",g_master.xrdald,"'",
           "   AND apca001 = gzcb002",
           "   AND gzcb003 = '1'",
           "   AND gzcb001 = '8502'",
           "   AND apca005 = ?",
           "   AND apcc108 - apcc109 > 0"

   PREPARE axrp400_nm_prep FROM g_wc_nm
   DECLARE axrp400_nm_curs CURSOR FOR axrp400_nm_prep

   PREPARE axrp400_ar_prep FROM g_wc_ar
   DECLARE axrp400_ar_curs CURSOR FOR axrp400_ar_prep
   
   PREPARE axrp400_sel_apcc_prep FROM g_wc_ap
   DECLARE axrp400_sel_apcc_curs CURSOR FOR axrp400_sel_apcc_prep
END FUNCTION]]>
  </point>
  <point name="function.axrp400_get_ar" order="6" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_get_ar()
   DEFINE l_sql          STRING 
   DEFINE l_nmbb026      LIKE nmbb_t.nmbb026
   DEFINE l_nmbb027      LIKE nmbb_t.nmbb027
   DEFINE l_nmbb004      LIKE nmbb_t.nmbb004
   DEFINE l_success      LIKE type_t.chr1
   DEFINE i              LIKE type_t.num5
   DEFINE j              LIKE type_t.num5
   DEFINE l_start_no     LIKE xrca_t.xrcadocno
   DEFINE l_end_no       LIKE xrca_t.xrcadocno
   
   LET g_success = 'Y'
   LET j = 1
   LET l_start_no = '' 
   CALL axrp400_get_sql()
   LET l_sql = " SELECT UNIQUE nmbb026 FROM axrp400_tmp WHERE (sel='Y' OR sel1 = 'Y')"
   PREPARE axrp400_nmbb026_prep FROM l_sql
   DECLARE axrp400_nmbb026_curs CURSOR FOR axrp400_nmbb026_prep
   FOREACH axrp400_nmbb026_curs INTO g_nmbb026_d[j].*
      LET j = j + 1
   END FOREACH
   LET j = j - 1
   CALL cl_err_collect_init()
   FOR i = 1 TO g_nmbb026_d.getLength() 
      CALL s_transaction_begin()
      #資料匯入沖帳單單頭檔
      CALL axrp400_ins_xrda(g_nmbb026_d[i].nmbb026) RETURNING l_success

      #資料匯入沖帳單單身檔
      CALL axrp400_ins_xrce(g_nmbb026_d[i].nmbb026)
      IF l_success = 'Y' AND g_success ='Y' THEN
         IF cl_null(l_start_no) THEN
            LET l_start_no = g_xrdadocno
         END IF
         LET l_end_no = g_xrdadocno
         CALL s_transaction_end('Y','1')
      ELSE
         CALL s_transaction_end('N','1')     
      END IF
      
   END FOR
#   IF l_success = 'Y' AND g_success = 'Y' THEN
      IF NOT cl_null(l_start_no) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00251'
         LET g_errparam.replace[1] = l_start_no
         LET g_errparam.replace[2] = l_end_no
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
#   END IF
   CALL cl_err_collect_show()
END FUNCTION]]>
  </point>
  <point name="function.axrp400_ins_xrda" order="7" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ins_xrda(p_nmbb026)
   DEFINE p_nmbb026      LIKE nmbb_t.nmbb026
   DEFINE l_xrda         RECORD LIKE xrda_t.*
   DEFINE l_xrce         RECORD LIKE xrce_t.*
   DEFINE l_success      LIKE type_t.chr1
   DEFINE l_success_1    LIKE type_t.num5

   LET g_xrdadocno = ''

   CALL s_aooi200_fin_gen_docno(g_master.xrdald,g_glaa.glaa024,g_glaa.glaa003,g_master.xrdadocno,g_master.xrdadocdt,'axrt400')
   RETURNING l_success,g_xrdadocno
   IF l_success  = 0  THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00003'
      LET g_errparam.extend = g_xrdadocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF

   INITIALIZE l_xrda.* TO NULL

   LET l_xrda.xrdaent  = g_enterprise
   LET l_xrda.xrdacomp = g_glaa.glaacomp
   LET l_xrda.xrdald   = g_master.xrdald
   LET l_xrda.xrdadocno= g_xrdadocno
   LET l_xrda.xrdadocdt= g_master.xrdadocdt
   LET l_xrda.xrdasite = g_master.xrdasite
   LET l_xrda.xrda001  = '41'
   LET l_xrda.xrda003  = g_master.xrda003
   LET l_xrda.xrda004  = p_nmbb026
   LET l_xrda.xrda005  = p_nmbb026
   LET l_xrda.xrda006  = p_nmbb026
   LET l_xrda.xrda007  = '1'
   LET l_xrda.xrda008  = ''
  #LET l_xrda.xrda009  = g_conditions.xrda009
   LET l_xrda.xrda010  = ''
   LET l_xrda.xrda011  = g_master.diff
   LET l_xrda.xrda012  = ''
   LET l_xrda.xrda013  = 'Y'
   LET l_xrda.xrda014  = ''
   LET l_xrda.xrda015  = ''
   LET l_xrda.xrda016  = 0
   LET l_xrda.xrda017  = ''
   LET l_xrda.xrdastus = 'N'
   LET l_xrda.xrdaownid= g_user
   LET l_xrda.xrdaowndp= g_dept
   LET l_xrda.xrdacrtid= g_user
   LET l_xrda.xrdacrtdp= g_dept
   LET l_xrda.xrdacrtdt= cl_get_current()
   LET l_xrda.xrdamodid= ""
   LET l_xrda.xrdamoddt= ""
   IF NOT cl_null(g_master.xrca063) THEN
      LET l_xrda.xrda009 = g_master.xrca063
   END IF
   CALL s_aooi390_oofi_upd('14',l_xrda.xrda009) RETURNING l_success_1  
   INSERT INTO xrda_t VALUES (l_xrda.*)
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'xrda_t'
      LET g_errparam.extend = SQLCA.sqlcode
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET g_success = 'N'
   END IF

   RETURN g_success
END FUNCTION]]>
  </point>
  <point name="function.axrp400_b_fill1" order="8" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 填充第二个单身
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_b_fill1()
   DEFINE l_success     LIKE type_t.num5
   
   LET g_wc2 = cl_replace_str(g_wc2,'b_xrca','xrca')
   LET g_wc2 = cl_replace_str(g_wc2,'b_xrcc','xrcc')
   #AR  資料的獲取
   LET g_sql = "SELECT 'N',xrcadocno,xrccseq,xrcc001,xrca001,xrcasite,'',xrca003,'',",
               "xrca005,'',xrcald,'',xrcadocdt,xrcc108,xrcc109,SUM(xrcc108 - xrcc109)",
                 "  FROM xrca_t,xrcb_t,xrcc_t",
                 " WHERE xrcaent   = xrcbent   AND xrcaent   = xrccent",
                 "   AND xrcadocno = xrcbdocno AND xrcadocno = xrccdocno",
                 "   AND xrcald    = xrcbld    AND xrcald    = xrccld",
                 "   AND xrcbseq   = xrccseq",
                 "   AND xrcaent   = '",g_enterprise,"'",
                 "   AND xrca001 NOT IN ('01','02','03','04','31','141','142')",
                 "   AND xrcald = '",g_master.xrdald,"'",
                 "   AND xrcacomp = '",g_glaa.glaacomp,"'",
                 "   AND xrcastus = 'Y' ",
                 "   AND ", g_wc2 CLIPPED,
                 " GROUP BY xrcadocno,xrccseq,xrcc001,xrca001,xrcasite,xrca003,xrca005,xrcald,xrcadocdt,xrcc108,xrcc109",
                 " HAVING SUM(xrcc108 - xrcc109) > 0"
                 
   PREPARE axrp400_sel1 FROM g_sql
   DECLARE b_fill_curs1 CURSOR FOR axrp400_sel1
   
   CALL g_detail2_d.clear()

   LET l_ac1 = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs1 INTO g_detail2_d[l_ac1].*
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      CALL s_axrt300_xrca_ref('xrcasite',g_detail2_d[l_ac1].xrcasite,'','') RETURNING l_success,g_detail2_d[l_ac1].xrcasite_desc
      CALL s_axrt300_xrca_ref('xrcald',g_detail2_d[l_ac1].xrcald,'','') RETURNING l_success,g_detail2_d[l_ac1].xrcald_desc
      CALL s_axrt300_xrca_ref('xrca003',g_detail2_d[l_ac1].xrca003,'','') RETURNING l_success,g_detail2_d[l_ac1].xrca003_desc
      CALL s_axrt300_xrca_ref('xrca005',g_detail2_d[l_ac1].xrca005,'','') RETURNING l_success,g_detail2_d[l_ac1].xrca005_desc
      
      INSERT INTO axrp400_tmp(nmbb026,sel1,xrcadocno,xrccseq,xrcc001) 
         VALUES(g_detail2_d[l_ac1].xrca005,g_detail2_d[l_ac1].sel1,g_detail2_d[l_ac1].xrcadocno,
                g_detail2_d[l_ac1].xrccseq,g_detail2_d[l_ac1].xrcc001)
      #end add-point
      
      CALL axrp400_detail_show()      
 
      LET l_ac1 = l_ac1 + 1
      IF l_ac1 > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   CALL g_detail2_d.deleteElement(g_detail2_d.getLength())
   LET g_error_show = 0

   CLOSE b_fill_curs1
   FREE axrp400_sel1
   
   LET l_ac1 = 1
END FUNCTION]]>
  </point>
  <point name="function.axrp400_create_tmp_table" order="9" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_create_tmp_table()
    DEFINE r_success       LIKE type_t.num5

   DROP TABLE axrp400_tmp;
   CREATE TEMP TABLE axrp400_tmp(
   sel         LIKE type_t.chr1,
   nmbbdocno   LIKE nmbb_t.nmbbdocno,
   nmbbseq     LIKE nmbb_t.nmbbseq,
   nmbb026     LIKE nmbb_t.nmbb026,
   sel1        LIKE type_t.chr1,
   xrcadocno   LIKE xrca_t.xrcadocno,
   xrccseq     LIKE xrcc_t.xrccseq,
   xrcc001     LIKE xrcc_t.xrcc001
   );
     
   DROP TABLE s_voucher_ar_tmp;
   CREATE TEMP TABLE s_voucher_ar_tmp(
   docno       LIKE glaq_t.glaqdocno,
   docdt       LIKE glap_t.glapdocdt,
   sw          LIKE type_t.chr1,
   glaqent     LIKE glaq_t.glaqent,
   glaqcomp    LIKE glaq_t.glaqcomp,
   glaqld      LIKE glaq_t.glaqld,
   glaq001     LIKE glaq_t.glaq001,
   glaq002     LIKE glaq_t.glaq002,
   glaq005     LIKE glaq_t.glaq005,
   glaq006     LIKE glaq_t.glaq006,
   glaq007     LIKE glaq_t.glaq007,
   glaq009     LIKE glaq_t.glaq009,
   glaq011     LIKE glaq_t.glaq011,
   glaq012     LIKE glaq_t.glaq012,
   glaq013     LIKE glaq_t.glaq013,
   glaq014     LIKE glaq_t.glaq014,
   glaq015     LIKE glaq_t.glaq015,
   glaq016     LIKE glaq_t.glaq016,
   glaq017     LIKE glaq_t.glaq017,
   glaq018     LIKE glaq_t.glaq018,
   glaq019     LIKE glaq_t.glaq019,
   glaq020     LIKE glaq_t.glaq020,
   glaq021     LIKE glaq_t.glaq021,
   glaq022     LIKE glaq_t.glaq022,
   glaq023     LIKE glaq_t.glaq023,
   glaq024     LIKE glaq_t.glaq024,
   glaq025     LIKE glaq_t.glaq025,
   glaq027     LIKE glaq_t.glaq027,
   glaq028     LIKE glaq_t.glaq028,
   glaq051     LIKE glaq_t.glaq051,  #經營方式
   glaq052     LIKE glaq_t.glaq052,  #渠道
   glaq053     LIKE glaq_t.glaq053,  #品牌
   glaq029     LIKE glaq_t.glaq029,
   glaq030     LIKE glaq_t.glaq030,
   glaq031     LIKE glaq_t.glaq031,
   glaq032     LIKE glaq_t.glaq032,
   glaq033     LIKE glaq_t.glaq033,
   glaq034     LIKE glaq_t.glaq034,
   glaq035     LIKE glaq_t.glaq035,
   glaq036     LIKE glaq_t.glaq036,
   glaq037     LIKE glaq_t.glaq037,
   glaq038     LIKE glaq_t.glaq038,
   glbc004     LIKE glbc_t.glbc004,  #现金变动码
   d           LIKE glaq_t.glaq003,
   c           LIKE glaq_t.glaq004,
   qty         LIKE glaq_t.glaq008,
   sum         LIKE glaq_t.glaq010,
   glaq039     LIKE glaq_t.glaq039,
   glaq040     LIKE glaq_t.glaq040,
   glaq041     LIKE glaq_t.glaq041,
   glaq042     LIKE glaq_t.glaq042,
   glaq043     LIKE glaq_t.glaq043,
   glaq044     LIKE glaq_t.glaq044,
   seq         LIKE glaq_t.glaqseq,
   source      LIKE type_t.chr100,
   glaqseq     LIKE glaq_t.glaqseq,
   xrca039     LIKE xrca_t.xrca039,
   b_glaq021   LIKE glaq_t.glaq021,
   b_glaq022   LIKE glaq_t.glaq022,
   red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh
   );
   
   DROP TABLE s_voucher_ar_group;
   CREATE TEMP TABLE s_voucher_ar_group(
   docno       LIKE glaq_t.glaqdocno,
   docdt       LIKE glap_t.glapdocdt,
   sw          LIKE type_t.chr1,
   glaqent     LIKE glaq_t.glaqent,
   glaqcomp    LIKE glaq_t.glaqcomp,
   glaqld      LIKE glaq_t.glaqld,
   glaq001     LIKE glaq_t.glaq001,
   glaq002     LIKE glaq_t.glaq002,
   glaq005     LIKE glaq_t.glaq005,
   glaq006     LIKE glaq_t.glaq006,
   glaq007     LIKE glaq_t.glaq007,
   glaq009     LIKE glaq_t.glaq009,
   glaq011     LIKE glaq_t.glaq011,
   glaq012     LIKE glaq_t.glaq012,
   glaq013     LIKE glaq_t.glaq013,
   glaq014     LIKE glaq_t.glaq014,
   glaq015     LIKE glaq_t.glaq015,
   glaq016     LIKE glaq_t.glaq016,
   glaq017     LIKE glaq_t.glaq017,
   glaq018     LIKE glaq_t.glaq018,
   glaq019     LIKE glaq_t.glaq019,
   glaq020     LIKE glaq_t.glaq020,
   glaq021     LIKE glaq_t.glaq021,
   glaq022     LIKE glaq_t.glaq022,
   glaq023     LIKE glaq_t.glaq023,
   glaq024     LIKE glaq_t.glaq024,
   glaq025     LIKE glaq_t.glaq025,
   glaq027     LIKE glaq_t.glaq027,
   glaq028     LIKE glaq_t.glaq028,
   glaq051     LIKE glaq_t.glaq051,  #經營方式
   glaq052     LIKE glaq_t.glaq052,  #渠道
   glaq053     LIKE glaq_t.glaq053,  #品牌
   glaq029     LIKE glaq_t.glaq029,
   glaq030     LIKE glaq_t.glaq030,
   glaq031     LIKE glaq_t.glaq031,
   glaq032     LIKE glaq_t.glaq032,
   glaq033     LIKE glaq_t.glaq033,
   glaq034     LIKE glaq_t.glaq034,
   glaq035     LIKE glaq_t.glaq035,
   glaq036     LIKE glaq_t.glaq036,
   glaq037     LIKE glaq_t.glaq037,
   glaq038     LIKE glaq_t.glaq038,
   glbc004     LIKE glbc_t.glbc004,  #现金变动码
   d           LIKE glaq_t.glaq003,
   c           LIKE glaq_t.glaq004,
   qty         LIKE glaq_t.glaq008,
   sum         LIKE glaq_t.glaq010,
   glaq039     LIKE glaq_t.glaq039,
   glaq040     LIKE glaq_t.glaq040,
   glaq041     LIKE glaq_t.glaq041,
   glaq042     LIKE glaq_t.glaq042,
   glaq043     LIKE glaq_t.glaq043,
   glaq044     LIKE glaq_t.glaq044,
   seq         LIKE glaq_t.glaqseq,
   source      LIKE type_t.chr100,
   glaqseq     LIKE glaq_t.glaqseq,
   xrca039     LIKE xrca_t.xrca039,
   b_glaq021   LIKE glaq_t.glaq021,
   b_glaq022   LIKE glaq_t.glaq022,
   red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh
   );

   DROP TABLE s_voucher_glbc;
   CREATE TEMP TABLE s_voucher_glbc(
   glbcent    LIKE glbc_t.glbcent,
   glbcld     LIKE glbc_t.glbcld,
   glbccomp   LIKE glbc_t.glbccomp,
   glbcdocno  LIKE glbc_t.glbcdocno,
   glbcseq    LIKE glbc_t.glbcseq,
   glbc001    LIKE glbc_t.glbc001,
   glbc002    LIKE glbc_t.glbc002,
   glbc003    LIKE glbc_t.glbc003,
   glbc004    LIKE glbc_t.glbc004,
   glbc005    LIKE glbc_t.glbc005,
   glbc006    LIKE glbc_t.glbc006,
   glbc007    LIKE glbc_t.glbc007,
   glbc008    LIKE glbc_t.glbc008,
   glbc009    LIKE glbc_t.glbc009,
   glbc010    LIKE glbc_t.glbc010,
   glbc011    LIKE glbc_t.glbc011,
   glbc012    LIKE glbc_t.glbc012,
   glbc013    LIKE glbc_t.glbc013,
   glbc014    LIKE glbc_t.glbc014,
   xrdadocno  LIKE xrda_t.xrdadocno
   )
END FUNCTION]]>
  </point>
  <point name="function.axrp400_ins_xrce" order="10" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ins_xrce(p_nmbb026)
   DEFINE p_nmbb026        LIKE nmbb_t.nmbb026
   DEFINE l_nmbbdocno      LIKE nmbb_t.nmbbdocno
   DEFINE l_nmbbseq        LIKE nmbb_t.nmbbseq
   DEFINE l_nmba           RECORD LIKE nmba_t.*
   DEFINE l_nmbb           RECORD LIKE nmbb_t.*
   DEFINE l_xrca           RECORD LIKE xrca_t.*
   DEFINE l_xrcb           RECORD LIKE xrcb_t.*
   DEFINE l_xrcc           RECORD LIKE xrcc_t.*
   DEFINE l_xrde           RECORD LIKE xrde_t.*
   DEFINE l_xrce           RECORD LIKE xrce_t.*
   DEFINE l_xrce_t         RECORD LIKE xrce_t.*
   DEFINE l_xrccdocno      LIKE xrcc_t.xrccdocno
   DEFINE l_xrccseq        LIKE xrcc_t.xrccseq
   DEFINE l_xrcc001        LIKE xrcc_t.xrcc001
   DEFINE l_seq            LIKE xrcc_t.xrccseq
   DEFINE l_xrce016        LIKE xrce_t.xrce016
   DEFINE l_trans          LIKE xrce_t.xrce109   #收款原幣金額
   DEFINE l_xrde109        LIKE xrde_t.xrde109
   DEFINE l_xrde119        LIKE xrde_t.xrde119
   DEFINE l_xrde129        LIKE xrde_t.xrde129
   DEFINE l_xrde139        LIKE xrde_t.xrde139
   DEFINE l_xrce109        LIKE xrce_t.xrce109
   DEFINE l_xrce119        LIKE xrce_t.xrce119
   DEFINE l_xrce129        LIKE xrce_t.xrce129
   DEFINE l_xrce139        LIKE xrce_t.xrce139
   DEFINE l_xrde109_1      LIKE xrde_t.xrde109
   DEFINE l_xrde119_1      LIKE xrde_t.xrde119
   DEFINE l_xrde129_1      LIKE xrde_t.xrde129
   DEFINE l_xrde139_1      LIKE xrde_t.xrde139
   DEFINE l_gzcb003        LIKE gzcb_t.gzcb003
   DEFINE l_apca_t         RECORD LIKE apca_t.*
   DEFINE l_apcb_t         RECORD LIKE apcb_t.*
   DEFINE l_apcc_t         RECORD LIKE apcc_t.*
   DEFINE l_ooab002        LIKE ooab_t.ooab002
   DEFINE l_xrca001_str    STRING
   DEFINE l_apca001_str    STRING
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_tot1           LIKE nmbb_t.nmbb006   #原幣金額
   DEFINE l_tot2           LIKE nmbb_t.nmbb007   #本幣金額
   DEFINE l_amt1           LIKE nmbb_t.nmbb008   #已沖原幣金額  主帳套
   DEFINE l_amt2           LIKE nmbb_t.nmbb009   #已沖本幣金額  主帳套
   DEFINE l_amt3           LIKE nmbb_t.nmbb020   #已沖原幣金額  次帳套一
   DEFINE l_amt4           LIKE nmbb_t.nmbb021   #已沖本幣金額  次帳套一
   DEFINE l_amt5           LIKE nmbb_t.nmbb023   #已沖原幣金額  次帳套二
   DEFINE l_amt6           LIKE nmbb_t.nmbb024   #已沖本幣金額  次帳套二
   DEFINE l_count          LIKE type_t.num5
   DEFINE l_xrcc108        LIKE xrcc_t.xrcc108
   DEFINE l_xrcc118        LIKE xrcc_t.xrcc118
   DEFINE l_xrcc128        LIKE xrcc_t.xrcc128
   DEFINE l_xrcc138        LIKE xrcc_t.xrcc138
   DEFINE l_apcc108        LIKE apcc_t.apcc108
   DEFINE l_apcc118        LIKE apcc_t.apcc118
   DEFINE l_apcc128        LIKE apcc_t.apcc128
   DEFINE l_apcc138        LIKE apcc_t.apcc138
   DEFINE l_str            LIKE type_t.chr500
  

   LET g_cnt1 = 0
   LET g_cnt2 = 0
   LET g_cnt3 = 0
   #主畫面選擇未沖帳款全部產生時不考慮差異問題
   #主畫面選擇依收款金額顯示相符未沖帳款時且存在差異金額時,需要考慮差異處理
   
   LET l_seq = 0
   LET l_trans = 0
   #匯入收款資料
   FOREACH axrp400_nm_curs USING p_nmbb026 INTO l_nmbbdocno,l_nmbbseq
      
      #賬務資料獲取
      INITIALIZE l_nmbb.* TO NULL
      SELECT * INTO l_nmbb.* FROM nmbb_t
       WHERE nmbbent = g_enterprise AND nmbbdocno = l_nmbbdocno AND nmbbseq = l_nmbbseq
      SELECT * INTO l_nmba.* FROM nmba_t
       WHERE nmbaent = g_enterprise AND nmbadocno = l_nmbbdocno
       
      SELECT nmbb006,nmbb007,nmbb008,nmbb009,nmbb020,nmbb021,nmbb023,nmbb024
        INTO l_tot1,l_tot2,l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6
        FROM nmbb_t
       WHERE nmbbent  = g_enterprise
         AND nmbbdocno= l_nmbb.nmbbdocno
         AND nmbbseq  = l_nmbb.nmbbseq
      IF g_ls = 1 THEN
         LET l_tot1 = l_tot1 - l_amt1
         LET l_tot2 = l_tot2 - l_amt2
      ELSE
         IF g_ls = 2 THEN
           LET l_tot1 = l_tot1 - l_amt3
           LET l_tot2 = l_tot2 - l_amt4
         ELSE
           LET l_tot1 = l_tot1 - l_amt5
           LET l_tot2 = l_tot2 - l_amt6
         END IF
      END IF
      LET l_str = l_nmbb.nmbbdocno,"|",l_nmbb.nmbbseq
      IF l_tot1 = 0 OR l_tot2 = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_str
         LET g_errparam.code = 'axr-00054'
#         LET g_errparam.replace[1] = l_nmbb.nmbbdocno
#         LET g_errparam.replace[2] = l_nmbb.nmbbseq
         
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CONTINUE FOREACH
      END IF

      #其他資料獲取
      SELECT glab005 INTO l_xrce016 FROM glab_t
       WHERE glabld = g_master.xrdald
         AND glab001= '40'
         AND glab002= '40'
         AND glab003= l_nmbb.nmbb003
      IF l_nmba.nmba003 = 'anmt510' THEN
         LET l_xrde.xrde006 = '10'
      END IF
      IF l_nmba.nmba003 = 'anmt540' THEN
         SELECT ooia002 INTO l_xrde.xrde006 FROM ooia_t
          WHERE ooiaent = g_enterprise AND ooia001 = l_nmbb.nmbb028
      END IF

      LET l_xrde.xrdeent = g_enterprise
      LET l_xrde.xrdecomp= g_glaa.glaacomp
      LET l_xrde.xrdeld  = g_master.xrdald
      LET l_xrde.xrdedocno= g_xrdadocno
      LET l_xrde.xrdeseq = l_seq + 1
      LET l_xrde.xrdesite= l_nmbb.nmbbcomp
      LET l_xrde.xrdeorga= l_nmbb.nmbborga
      LET l_xrde.xrde001 = l_nmba.nmba003
      LET l_xrde.xrde002 = 10
      LET l_xrde.xrde003 = l_nmbb.nmbbdocno
      LET l_xrde.xrde004 = l_nmbb.nmbbseq
      LET l_xrde.xrde006 = l_nmbb.nmbb029
     #LET l_xrde.xrde007 = l_nmbb.nmbb006
     #LET l_xrde.xrde008 = l_nmbb.nmbb003
      LET l_xrde.xrde010 = ''
      LET l_xrde.xrde011 = l_nmbb.nmbb002
      LET l_xrde.xrde012 = l_nmbb.nmbb010
      LET l_xrde.xrde013 = ''
      LET l_xrde.xrde014 = ''
      SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
       WHERE gzcb002 = '10'
         AND gzcb001 = '8306'
      IF l_gzcb003 = 'D' THEN
         LET l_xrde.xrde015 = 'D'
      ELSE
         LET l_xrde.xrde015 = 'C'
      END IF
      LET l_xrde.xrde016 = l_xrce016
      LET l_xrde.xrde017 = ''
      LET l_xrde.xrde018 = ''
      LET l_xrde.xrde019 = ''
      LET l_xrde.xrde020 = ''
      LET l_xrde.xrde022 = ''
      LET l_xrde.xrde023 = ''
      LET l_xrde.xrde028 = ''
      LET l_xrde.xrde029 = ''
      LET l_xrde.xrde030 = ''
      LET l_xrde.xrde035 = ''
      LET l_xrde.xrde036 = ''
      LET l_xrde.xrde038 = ''
      LET l_xrde.xrde039 = ''
      LET l_xrde.xrde040 = ''
      LET l_xrde.xrde041 = ''
      LET l_xrde.xrde042 = ''
      LET l_xrde.xrde043 = ''
      LET l_xrde.xrde044 = ''
      LET l_xrde.xrde045 = ''
      LET l_xrde.xrde046 = ''
      LET l_xrde.xrde047 = ''
      LET l_xrde.xrde048 = ''
      LET l_xrde.xrde049 = ''
      LET l_xrde.xrde050 = ''
      LET l_xrde.xrde051 = ''
      LET l_xrde.xrde100 = l_nmbb.nmbb004
      LET l_xrde.xrde101 = l_nmbb.nmbb005
      SELECT SUM(xrde109),SUM(xrde119),SUM(xrde129),SUM(xrde139) INTO l_xrde109,l_xrde119,l_xrde129,l_xrde139 FROM xrde_t,xrca_t
       WHERE xrcaent   = g_enterprise
         AND xrcaent   = xrdeent
         AND xrcald    = xrdeld
         AND xrcadocno = xrdedocno
         AND xrde003   = l_nmbb.nmbbdocno
         AND xrde004   = l_nmbb.nmbbseq
         AND xrcastus  = 'N'
      IF cl_null(l_xrde109) THEN LET l_xrde109 = 0 END IF
      IF cl_null(l_xrde119) THEN LET l_xrde119 = 0 END IF
      IF cl_null(l_xrde129) THEN LET l_xrde129 = 0 END IF
      IF cl_null(l_xrde139) THEN LET l_xrde139 = 0 END IF
      CASE
         WHEN g_ls = 1
            LET l_xrde.xrde109 = l_nmbb.nmbb006 - l_nmbb.nmbb008 - l_xrde109
            LET l_xrde.xrde119 = l_nmbb.nmbb007 - l_nmbb.nmbb009 - l_xrde119
         WHEN g_ls = 2
            LET l_xrde.xrde109 = l_nmbb.nmbb006 - l_nmbb.nmbb020 - l_xrde109
            LET l_xrde.xrde119 = l_nmbb.nmbb007 - l_nmbb.nmbb021 - l_xrde119
         WHEN g_ls = 3
            LET l_xrde.xrde109 = l_nmbb.nmbb006 - l_nmbb.nmbb023 - l_xrde109
            LET l_xrde.xrde119 = l_nmbb.nmbb007 - l_nmbb.nmbb024 - l_xrde119
      END CASE
      LET l_xrde.xrde120 = l_nmbb.nmbb011
      LET l_xrde.xrde121 = l_nmbb.nmbb012
      LET l_xrde.xrde129 = l_nmbb.nmbb013 - l_nmbb.nmbb014 - l_xrde129
      LET l_xrde.xrde130 = l_nmbb.nmbb015
      LET l_xrde.xrde131 = l_nmbb.nmbb016
      LET l_xrde.xrde139 = l_nmbb.nmbb017 - l_nmbb.nmbb018 - l_xrde139

      INSERT INTO xrde_t VALUES (l_xrde.*)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'xrde_t'
         LET g_errparam.extend = SQLCA.sqlcode
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_success = 'N'
         EXIT FOREACH
      ELSE
         LET g_cnt1 = g_cnt1 + 1
      END IF

      LET l_seq = l_seq + 1

      LET l_trans = l_trans + l_xrde.xrde109

   END FOREACH
   IF g_success = 'N' THEN
      RETURN
   END IF

  #IF l_seq > 1 THEN LET l_seq = l_seq - 1 END IF

   LET l_seq = 0
   #匯入帳款資料
   FOREACH axrp400_ar_curs USING p_nmbb026 INTO l_xrccdocno,l_xrccseq,l_xrcc001
      #獲取AR資料
      SELECT * INTO l_xrca.* FROM xrca_t WHERE xrcaent = g_enterprise AND xrcald = g_master.xrdald
         AND xrcadocno = l_xrccdocno
      SELECT * INTO l_xrcb.* FROM xrcb_t WHERE xrcbent = g_enterprise AND xrcbld = g_master.xrdald
         AND xrcbdocno = l_xrccdocno AND xrcbseq = l_xrccseq
      SELECT * INTO l_xrcc.* FROM xrcc_t WHERE xrccent = g_enterprise AND xrccld = g_master.xrdald
         AND xrccdocno = l_xrccdocno AND xrccseq = l_xrccseq AND xrcc001 = l_xrcc001

      #其他資料獲取
      LET l_xrca001_str = l_xrca.xrca001
      IF l_xrca001_str.substring(1,1) = '1' THEN
         LET l_xrce.xrce002 = '30'
      END IF 
      IF l_xrca001_str.substring(1,1) = '2' THEN
         LET l_xrce.xrce002 = '31'
      END IF
      
      IF l_xrce.xrce002 = '30' OR l_xrce.xrce002 = '31' THEN
         #檢查資料1:存在性;2.可沖金額大於0
         SELECT COUNT(*) INTO l_count FROM xrca_t,xrcc_t
          WHERE xrcaent = g_enterprise
            AND xrcaent = xrccent
            AND xrcadocno = xrccdocno
            AND xrcald = xrccld
            AND xrccld = g_master.xrdald
            AND xrccdocno = l_xrcc.xrccdocno
            AND xrccseq = l_xrcc.xrccseq
            AND xrcc001 = l_xrcc.xrcc001
         SELECT SUM(xrcc108 - xrcc109),SUM(xrcc118 - xrcc119 + xrcc113),SUM(xrcc128 - xrcc129 + xrcc123),SUM(xrcc138 - xrcc139 + xrcc133) 
           INTO l_xrcc108,l_xrcc118,l_xrcc128,l_xrcc138
           FROM xrcc_t
          WHERE xrccent = g_enterprise
            AND xrccld = g_master.xrdald
            AND xrccdocno = l_xrcc.xrccdocno
            AND xrccseq = l_xrcc.xrccseq
            AND xrcc001 = l_xrcc.xrcc001
       
         IF cl_null(l_xrcc108) THEN LET l_xrcc108 = 0 END IF
         IF cl_null(l_xrcc118) THEN LET l_xrcc118 = 0 END IF
         IF cl_null(l_xrcc128) THEN LET l_xrcc128 = 0 END IF
         IF cl_null(l_xrcc138) THEN LET l_xrcc138 = 0 END IF
         LET l_str = l_xrcc.xrccdocno,"|",l_xrcc.xrccseq,"|",l_xrcc.xrcc001
         CASE
            WHEN l_count = 0
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'axr-00067'
               LET g_errparam.extend = l_str
#               LET g_errparam.replace[1] = l_xrcc.xrccdocno
#               LET g_errparam.replace[2] = l_xrcc.xrccseq
#               LET g_errparam.replace[3] = l_xrcc.xrcc001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CONTINUE FOREACH
            WHEN l_xrcc108 = 0 OR l_xrcc118 = 0
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'axr-00058'
               LET g_errparam.extend = l_str
#               LET g_errparam.replace[1] = l_xrcc.xrccdocno
#               LET g_errparam.replace[2] = l_xrcc.xrccseq
#               LET g_errparam.replace[3] = l_xrcc.xrcc001
               
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CONTINUE FOREACH
         END CASE
      END IF
      SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
       WHERE gzcb002 = l_xrce.xrce002
         AND gzcb001 = '8306'
      IF l_gzcb003 = 'D' THEN
         LET l_xrce.xrce015   =  'D'
      ELSE
         LET l_xrce.xrce015   =  'C'
      END IF
      LET l_xrce.xrceent = g_enterprise
      LET l_xrce.xrcecomp= l_xrcc.xrcccomp
      LET l_xrce.xrceld  = g_master.xrdald
      LET l_xrce.xrcedocno= g_xrdadocno
      LET l_xrce.xrceseq = l_seq + 1
      LET l_xrce.xrcelegl= l_xrcc.xrcclegl
      LET l_xrce.xrcesite= l_xrcc.xrccsite
      LET l_xrce.xrceorga= l_xrcb.xrcborga
      LET l_xrce.xrce001 = l_xrcb.xrcb001
     #LET l_xrce.xrce002 = '30'
      LET l_xrce.xrce003 = l_xrcc.xrccdocno
      LET l_xrce.xrce004 = l_xrccseq
      LET l_xrce.xrce005 = l_xrcc.xrcc001
      LET l_xrce.xrce006 = ''
      LET l_xrce.xrce007 = l_xrcc.xrcc108 - l_xrcc.xrcc109
      LET l_xrce.xrce008 = l_xrcc.xrccdocno
      LET l_xrce.xrce009 = ''
      LET l_xrce.xrce010 = ''
      LET l_xrce.xrce011 = ''
      LET l_xrce.xrce012 = ''
      LET l_xrce.xrce013 = ''
      LET l_xrce.xrce014 = ''
     #LET l_xrce.xrce015 = 'C'
      LET l_xrce.xrce016 = l_xrca.xrca035
      LET l_xrce.xrce017 = l_xrca.xrca014
      LET l_xrce.xrce018 = l_xrcb.xrcb010
      LET l_xrce.xrce019 = l_xrcb.xrcb011
      LET l_xrce.xrce020 = l_xrcb.xrcb012
      LET l_xrce.xrce021 = l_xrcb.xrcb017
      LET l_xrce.xrce022 = l_xrcb.xrcb015
      LET l_xrce.xrce023 = l_xrcb.xrcb016
      LET l_xrce.xrce024 = l_xrcb.xrcb002
      LET l_xrce.xrce025 = l_xrcb.xrcb003
      LET l_xrce.xrce026 = ''
      LET l_xrce.xrce027 = ''
      LET l_xrce.xrce028 = ''
      LET l_xrce.xrce029 = ''
      LET l_xrce.xrce030 = ''
      LET l_xrce.xrce035 = ''
      LET l_xrce.xrce036 = ''
      LET l_xrce.xrce037 = ''
      LET l_xrce.xrce038 = ''
      LET l_xrce.xrce104 = 0
      LET l_xrce.xrce114 = 0
      LET l_xrce.xrce124 = 0
      LET l_xrce.xrce134 = 0
      LET l_xrce.xrce100 = l_xrcc.xrcc100
      LET l_xrce.xrce101 = l_xrcc.xrcc102
      LET l_xrce.xrce120 = l_xrcc.xrcc120
      LET l_xrce.xrce121 = l_xrcc.xrcc122
      LET l_xrce.xrce130 = l_xrcc.xrcc130
      LET l_xrce.xrce131 = l_xrcc.xrcc132
      CALL axrp400_ar_amt(l_xrccdocno,l_xrccseq,l_xrcc001)
         RETURNING l_xrce.xrce109,l_xrce.xrce119,l_xrce.xrce129,l_xrce.xrce139

      INSERT INTO xrce_t VALUES (l_xrce.*)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'xrce_t'
         LET g_errparam.extend = SQLCA.sqlcode
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_success = 'N' 
         EXIT FOREACH
      ELSE
            LET g_cnt2 = g_cnt2 + 1
      END IF

      LET l_seq = l_seq + 1

   END FOREACH
   IF g_success = 'N' THEN
      RETURN
   END IF
   
   LET l_count = 0
   IF g_master.chk = 'Y' THEN 
      
      FOREACH axrp400_sel_apcc_curs USING p_nmbb026 INTO l_apcc_t.*,l_apca_t.*
         SELECT * INTO l_apcb_t.* FROM apcb_t WHERE apcbent = g_enterprise AND apcbld = g_master.xrdald
            AND apcbdocno = l_apcc_t.apccdocno AND apcbseq = l_apcc_t.apccseq
         #計算預沖金額
         LET l_xrce109 = 0   LET l_xrce119 = 0
         LET l_xrce129 = 0   LET l_xrce139 = 0
         SELECT SUM(xrce109),SUM(xrce119),SUM(xrce129),SUM(xrce139) INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
           FROM xrce_t,xrda_t
          WHERE xrdaent   = xrceent
            AND xrdald    = xrceld
            AND xrdadocno = xrcedocno
            AND xrce003   = l_apcc_t.apccdocno
            AND xrce004   = l_apcc_t.apccseq
            AND xrce005   = l_apcc_t.apcc001
            AND xrdastus  = 'N'
         IF cl_null(l_xrce109) THEN LET l_xrce109 = 0 END IF
         IF cl_null(l_xrce119) THEN LET l_xrce119 = 0 END IF
         IF cl_null(l_xrce129) THEN LET l_xrce129 = 0 END IF
         IF cl_null(l_xrce139) THEN LET l_xrce139 = 0 END IF
         
         SELECT MAX(xrceseq) INTO l_xrce_t.xrceseq
           FROM xrce_t
          WHERE xrceent = g_enterprise 
            AND xrceld = g_master.xrdald
            AND xrcedocno = g_xrdadocno
         IF cl_null(l_xrce_t.xrceseq) THEN
            LET l_xrce_t.xrceseq = 1
         ELSE
            LET l_xrce_t.xrceseq = l_xrce_t.xrceseq + 1
         END IF
         
         
         LET l_xrce_t.xrceent = g_enterprise
         LET l_xrce_t.xrceld = g_master.xrdald
         LET l_xrce_t.xrcedocno = g_xrdadocno
         LET l_xrce_t.xrcesite  = g_master.xrdasite
         LET l_xrce_t.xrceorga  = l_apcb_t.apcborga
         LET l_apca001_str = l_apca_t.apca001
         LET l_apca001_str = l_apca001_str.substring(1,1)
         IF l_apca001_str = '1' THEN
            LET l_xrce_t.xrce002   = '40'
         END IF
         IF l_apca001_str = '2' AND l_apca_t.apca001 <> '25' THEN 
            LET l_xrce_t.xrce002   = '41'
         END IF
         IF l_apca_t.apca001 = '25' THEN 
            LET l_xrce_t.xrce002   = '42'
         END IF
         
         IF l_xrce_t.xrce002 = '40' OR l_xrce_t.xrce002 = '41' OR l_xrce_t.xrce002 = '42' THEN       
            #檢查資料1:存在性;2.可沖金額大於0
            SELECT COUNT(*) INTO l_count FROM apca_t,apcc_t
             WHERE apcaent = g_enterprise
               AND apcaent = apccent
               AND apcadocno = apccdocno
               AND apcald = apccld
               AND apccld = g_master.xrdald
               AND apccdocno = l_apcc_t.apccdocno
               AND apccseq = l_apcc_t.apccseq
               AND apcc001 = l_apcc_t.apcc001
            SELECT SUM(apcc108 - apcc109),SUM(apcc118 - apcc119 + apcc113),SUM(apcc128 - apcc129 + apcc123),SUM(apcc138 - apcc139 + apcc133) 
              INTO l_apcc108,l_apcc118,l_apcc128,l_apcc138
              FROM apcc_t
             WHERE apccent = g_enterprise
               AND apccld = g_master.xrdald
               AND apccdocno = l_apcc_t.apccdocno
               AND apccseq = l_apcc_t.apccseq
               AND apcc001 = l_apcc_t.apcc001
        
            IF cl_null(l_apcc108) THEN LET l_apcc108 = 0 END IF
            IF cl_null(l_apcc118) THEN LET l_apcc118 = 0 END IF
            IF cl_null(l_apcc128) THEN LET l_apcc128 = 0 END IF
            IF cl_null(l_apcc138) THEN LET l_apcc138 = 0 END IF
            
            LET l_str = l_apcc_t.apccdocno,"|",l_apcc_t.apccseq,"|",l_apcc_t.apcc001
            CASE
               WHEN l_count = 0
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_str
                  LET g_errparam.code = 'axr-00333'
#                  LET g_errparam.replace[1] = l_apcc_t.apccdocno
#                  LET g_errparam.replace[2] = l_apcc_t.apccseq
#                  LET g_errparam.replace[3] = l_apcc_t.apcc001
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CONTINUE FOREACH
               WHEN l_apcc108 = 0 OR l_apcc118 = 0
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_str
                  LET g_errparam.code = 'axr-00058'
#                  LET g_errparam.replace[1] = l_apcc_t.apccdocno
#                  LET g_errparam.replace[2] = l_apcc_t.apccseq
#                  LET g_errparam.replace[3] = l_apcc_t.apcc001
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CONTINUE FOREACH
            END CASE
         END IF
         
         LET l_xrce_t.xrce010   = ''
         SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
          WHERE gzcb002 = l_xrce_t.xrce002
            AND gzcb001 = '8306'
         IF l_gzcb003 = 'D' THEN
            LET l_xrce_t.xrce015   =  'D'
         ELSE
            LET l_xrce_t.xrce015   =  'C'
         END IF
         
         
         LET l_xrce_t.xrcecomp = l_apcc_t.apcccomp
         LET l_xrce_t.xrce001  = 'axrt400'
         LET l_xrce_t.xrce003  = l_apcc_t.apccdocno
         LET l_xrce_t.xrce004  = l_apcc_t.apccseq
         LET l_xrce_t.xrce005  = l_apcc_t.apcc001
         LET l_xrce_t.xrce016  = l_apca_t.apca035
         LET l_xrce_t.xrce017  = l_apca_t.apca014
         LET l_xrce_t.xrce018  = l_apca_t.apca015
         LET l_xrce_t.xrce027	 = 'N'
         LET l_xrce_t.xrce028	 = 0
         LET l_xrce_t.xrce036	 = l_apca_t.apca006
         LET l_xrce_t.xrce053  = l_apcc_t.apcc008
         LET l_xrce_t.xrce054  = l_apcc_t.apcc009
         LET l_xrce_t.xrce100  = l_apcc_t.apcc100
         LET l_xrce_t.xrce101  = l_apcc_t.apcc102     #20150313  apcc101 ---->apcc102
         LET l_xrce_t.xrce104   = 0
         LET l_xrce_t.xrce114   = 0
         LET l_xrce_t.xrce120  = l_apcc_t.apcc120
         LET l_xrce_t.xrce121  = l_apcc_t.apcc122
         LET l_xrce_t.xrce130  = l_apcc_t.apcc130
         LET l_xrce_t.xrce131  = l_apcc_t.apcc132
         
         LET l_xrce_t.xrce109  = l_apcc_t.apcc108 - l_apcc_t.apcc109 - l_xrce109
         LET l_xrce_t.xrce119  = l_apcc_t.apcc118 - l_apcc_t.apcc119 - l_xrce119
         IF l_xrce_t.xrce109 <= 0 THEN CONTINUE FOREACH END IF
         LET l_xrce_t.xrce129  = l_apcc_t.apcc128 - l_apcc_t.apcc129 - l_xrce129
         LET l_xrce_t.xrce139  = l_apcc_t.apcc138 - l_apcc_t.apcc139 - l_xrce139
      
         IF g_glaa.glaa015 = 'N' THEN
            LET l_xrce_t.xrce120 = ''
            LET l_xrce_t.xrce121 = 0
            LET l_xrce_t.xrce129 = 0
         END IF
         
         IF g_glaa.glaa019 = 'N' THEN
            LET l_xrce_t.xrce130 = ''
            LET l_xrce_t.xrce131 = 0
            LET l_xrce_t.xrce139 = 0
         END IF
      
      
         #INSERT INTO xrce_t VALUES(l_xrce_t.*)
         INSERT INTO xrce_t(xrceent,xrcecomp,xrceorga,xrcesite,xrceld,xrcedocno,xrceseq,xrce001,xrce002,xrce003,
                            xrce004,xrce005,xrce010,xrce015,xrce016,xrce017,xrce018,xrce027,xrce028,xrce036,
                            xrce053,xrce054,xrce100,xrce101,xrce104,xrce114,xrce109,
                            xrce119,xrce120,xrce121,xrce129,xrce130,xrce131,xrce139)
                     VALUES(l_xrce_t.xrceent,l_xrce_t.xrcecomp ,l_xrce_t.xrceorga,l_xrce_t.xrcesite,
                            l_xrce_t.xrceld ,l_xrce_t.xrcedocno,l_xrce_t.xrceseq ,l_xrce_t.xrce001 ,
                            l_xrce_t.xrce002,l_xrce_t.xrce003  ,l_xrce_t.xrce004 ,l_xrce_t.xrce005 ,
                            l_xrce_t.xrce010,l_xrce_t.xrce015  ,l_xrce_t.xrce016 ,l_xrce_t.xrce017 ,
                            l_xrce_t.xrce018,l_xrce_t.xrce027  ,l_xrce_t.xrce028 ,l_xrce_t.xrce036 ,
                            l_xrce_t.xrce053,l_xrce_t.xrce054  ,l_xrce_t.xrce100 ,l_xrce_t.xrce101 ,
                            l_xrce_t.xrce104,l_xrce_t.xrce114  ,l_xrce_t.xrce109 ,l_xrce_t.xrce119 ,
                            l_xrce_t.xrce120,l_xrce_t.xrce121  ,l_xrce_t.xrce129 ,l_xrce_t.xrce130 ,
                            l_xrce_t.xrce131,l_xrce_t.xrce139
                           )
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'xrce_t'
            LET g_errparam.extend = SQLCA.sqlcode
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET g_success = 'N' 
            EXIT FOREACH
         ELSE
            LET g_cnt3 = g_cnt3 + 1
         END IF
      
      END FOREACH
      IF g_success = 'N' THEN
         RETURN
      END IF
   END IF
   
   IF g_cnt1 = 0 AND g_cnt2 = 0 AND g_cnt3 = 0 THEN
      LET g_success = 'N'
      RETURN
   END IF
   
   IF g_master.diff = '2' THEN
      CALL axrp400_ar_diff()
   END IF
   
  #CALL s_transaction_begin()
   IF NOT cl_null(g_xrdadocno) THEN 
      CALL s_pre_voucher_ins('AR','R20',g_master.xrdald,g_xrdadocno,g_master.xrdadocdt,'2') RETURNING l_success
      
      IF l_success THEN
         LET g_success = 'Y'   
      ELSE
         LET g_success = 'N' 
      END IF
#    CALL cl_err_collect_show() 
   END IF

END FUNCTION]]>
  </point>
  <point name="function.axrp400_ar_amt" order="11" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ar_amt(p_xrccdocno,p_xrccseq,p_xrcc001)
   DEFINE p_xrccdocno         LIKE xrcc_t.xrccdocno
   DEFINE p_xrccseq           LIKE xrcc_t.xrccseq
   DEFINE p_xrcc001           LIKE xrcc_t.xrcc001
   DEFINE l_xrca              RECORD LIKE xrca_t.*
   DEFINE l_flag              LIKE type_t.chr1
   DEFINE l_xrce109           LIKE xrce_t.xrce109
   DEFINE l_xrce119           LIKE xrce_t.xrce119
   DEFINE l_xrce129           LIKE xrce_t.xrce129
   DEFINE l_xrce139           LIKE xrce_t.xrce139
   DEFINE r_xrcc              RECORD
             xrcc109             LIKE xrcc_t.xrcc109,
             xrcc119             LIKE xrcc_t.xrcc119,
             xrcc129             LIKE xrcc_t.xrcc129,
             xrcc139             LIKE xrcc_t.xrcc139
                              END RECORD

   #獲取該應收單可沖金額：應收-已收-預收
      #應收 - 已收
      SELECT xrcc108 - xrcc109,xrcc118 - xrcc119,xrcc128 - xrcc129,xrcc138 - xrcc139
        INTO r_xrcc.xrcc109,r_xrcc.xrcc119,r_xrcc.xrcc129,r_xrcc.xrcc139
        FROM xrcc_t
       WHERE xrccent = g_enterprise   AND xrccdocno = p_xrccdocno
         AND xrccld  = g_master.xrdald AND xrccseq = p_xrccseq
         AND xrcc001 = p_xrcc001
      IF cl_null(r_xrcc.xrcc109) THEN LET r_xrcc.xrcc109 = 0 END IF
      IF cl_null(r_xrcc.xrcc119) THEN LET r_xrcc.xrcc119 = 0 END IF
      IF cl_null(r_xrcc.xrcc129) THEN LET r_xrcc.xrcc129 = 0 END IF
      IF cl_null(r_xrcc.xrcc139) THEN LET r_xrcc.xrcc139 = 0 END IF

      #預收
      SELECT SUM(xrce109),SUM(xrce119),SUM(xrce129),SUM(xrce139)
        INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
        FROM xrce_t
       WHERE xrce003 = p_xrccdocno AND xrce004 = p_xrccseq AND xrce005 = p_xrcc001
      IF cl_null(l_xrce109) THEN LET l_xrce109 = 0 END IF
      IF cl_null(l_xrce119) THEN LET l_xrce119 = 0 END IF
      IF cl_null(l_xrce129) THEN LET l_xrce129 = 0 END IF
      IF cl_null(l_xrce139) THEN LET l_xrce139 = 0 END IF
      LET r_xrcc.xrcc109 = r_xrcc.xrcc109 - l_xrce109
      LET r_xrcc.xrcc119 = r_xrcc.xrcc119 - l_xrce119
      LET r_xrcc.xrcc129 = r_xrcc.xrcc129 - l_xrce129
      LET r_xrcc.xrcc139 = r_xrcc.xrcc139 - l_xrce139


   RETURN r_xrcc.*
END FUNCTION]]>
  </point>
  <point name="function.axrp400_ar_diff" order="12" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ar_diff()
   DEFINE l_glab003     LIKE glab_t.glab003
   DEFINE l_xrde_t      RECORD LIKE xrde_t.*
   DEFINE l_sql         STRING
   DEFINE l_xrde100     LIKE xrde_t.xrde100
   DEFINE l_xrde109     LIKE xrde_t.xrde109
   DEFINE l_xrde119     LIKE xrde_t.xrde119
   DEFINE l_xrde109_1   LIKE xrde_t.xrde109
   DEFINE l_xrde119_1   LIKE xrde_t.xrde119
   DEFINE l_xrde109_2   LIKE xrde_t.xrde109
   DEFINE l_xrde119_2   LIKE xrde_t.xrde119
   DEFINE l_ooab002     LIKE ooab_t.ooab002
   DEFINE l_amt         LIKE xrde_t.xrde119   #匯差
 
    CALL axrp400_get_amt()
   IF g_amt1 = 0 THEN
      RETURN
   END IF
   SELECT MAX(xrdeseq) + 1 INTO l_xrde_t.xrdeseq
     FROM xrde_t
    WHERE xrdeent = g_enterprise 
      AND xrdeld = g_master.xrdald
      AND xrdedocno = g_xrdadocno
      
   IF cl_null(l_xrde_t.xrdeseq) THEN 
      LET l_xrde_t.xrdeseq = 1
   END IF
   
   IF l_xrde_t.xrdeseq > 1 THEN 
      SELECT xrde010 INTO l_xrde_t.xrde010
        FROM xrde_t
       WHERE xrdeent = g_enterprise
         AND xrdeld = g_master.xrdald
         AND xrdedocno = g_xrdadocno
         AND xrdeseq = l_xrde_t.xrdeseq - 1 
   END IF

   LET l_xrde_t.xrdeent  = g_enterprise
   LET l_xrde_t.xrdecomp = g_glaa.glaacomp
   LET l_xrde_t.xrdeld   = g_master.xrdald
   LET l_xrde_t.xrdesite = g_master.xrdasite
   LET l_xrde_t.xrdedocno= g_xrdadocno  
   LET l_xrde_t.xrdeorga = g_glaa.glaacomp   
   #本幣
   LET l_sql ="SELECT SUM(xrde109),SUM(xrde119),SUM(xrde109_1),SUM(xrde119_1),SUM(xrde109_2),SUM(xrde119_2)",
              "  FROM (",
              "       SELECT SUM(xrde109) xrde109,SUM(xrde119) xrde119,0 xrde109_1,0 xrde119_1,0 xrde109_2,0 xrde119_2 FROM xrde_t",       #收款金額
              "        WHERE xrde002 = 10",
              "          AND xrdeent = '",g_enterprise,"'",
              "          AND xrdedocno = '",g_xrdadocno,"'",
              "          AND xrdeld = '",g_master.xrdald,"'",
              "        UNION ",
              "       SELECT 0 xrde109,0 xrde119,SUM(xrce109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde109_1,SUM(xrce119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde119_1,0 xrde109_2,0 xrde119_2 FROM xrce_t,gzcb_t",#帳款金額
              "        WHERE xrce002 = gzcb002",
              "          AND gzcb001 = '8306'",
              "          AND gzcb004 = '2'",
              "          AND xrceent = '",g_enterprise,"'",
              "          AND xrcedocno = '",g_xrdadocno,"'",
              "          AND xrceld = '",g_master.xrdald,"'",
              "        UNION ",
              "       SELECT 0 xrde109,0 xrde119,0 xrde109_1,0 xrde119_1,SUM(xrde109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde109_2,SUM(xrde119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde119_2 FROM xrde_t,gzcb_t",#帳款金額
              "        WHERE xrde002 = gzcb002",
              "          AND gzcb001 = '8306'",
              "          AND gzcb004 = '1'",
              "          AND xrde002 <> 10",
              "          AND xrdeent = '",g_enterprise,"'",
              "          AND xrdedocno = '",g_xrdadocno,"'",
              "          AND xrdeld = '",g_master.xrdald,"'",
              "      )"
   PREPARE axrt400_01_prep31 FROM l_sql
   DECLARE axrt400_01_xrde1 CURSOR FOR axrt400_01_prep31

   FOREACH axrt400_01_xrde1 INTO l_xrde109,l_xrde119,l_xrde109_1,l_xrde119_1,l_xrde109_2,l_xrde119_2
      IF cl_null(l_xrde109)   THEN LET l_xrde109   = 0 END IF
      IF cl_null(l_xrde119)   THEN LET l_xrde119   = 0 END IF
      IF cl_null(l_xrde109_1) THEN LET l_xrde109_1 = 0 END IF
      IF cl_null(l_xrde119_1) THEN LET l_xrde119_1 = 0 END IF
      IF cl_null(l_xrde109_2) THEN LET l_xrde109_2 = 0 END IF
      IF cl_null(l_xrde119_2) THEN LET l_xrde119_2 = 0 END IF
      #本幣帳款 < 收款:12.匯兌收益;　反之(11.匯損).
      #需要考慮本位幣二、三產生的匯兌損益
      IF l_xrde119 - l_xrde119_2 != l_xrde119_1 THEN
         LET l_amt = l_xrde119 + l_xrde119_1 + l_xrde119_2

         IF l_amt < 0 THEN
            LET l_xrde_t.xrde002  = '11'
            LET l_glab003 = '9711_11'
            LET l_amt = l_amt * -1
         ELSE
            LET l_xrde_t.xrde002  = '12'
            LET l_glab003 = '9711_12'
         END IF
         SELECT gzcb003 INTO l_xrde_t.xrde015 FROM gzcb_t
          WHERE gzcb002 = l_xrde_t.xrde002
            AND gzcb001 = '8306'
         LET l_xrde_t.xrde006  = ''
#         IF g_prog = 'axrt400' THEN 
            LET l_xrde_t.xrde001  = 'axrt400'
#         ELSE
#            LET l_xrde_t.xrde001  = 'axrt300'
#         END IF
         LET l_xrde_t.xrde003  = ''
         LET l_xrde_t.xrde004  = ''
         LET l_xrde_t.xrde008  = ''
         LET l_xrde_t.xrde013  = ''
         LET l_xrde_t.xrde014  = ''
         LET l_xrde_t.xrde100  = g_glaa.glaa001
         LET l_xrde_t.xrde101  = 1
         LET l_xrde_t.xrde109  = 0
         LET l_xrde_t.xrde119  = l_amt
         LET l_xrde_t.xrde120 = g_glaa.glaa016
         LET l_xrde_t.xrde121 = 0
         LET l_xrde_t.xrde129 = 0
         LET l_xrde_t.xrde130 = g_glaa.glaa020
         LET l_xrde_t.xrde131 = 0
         LET l_xrde_t.xrde139 = 0
         LET l_xrde_t.xrde017  = g_master.xrda003
         
         SELECT ooag003 INTO l_xrde_t.xrde018 FROM ooag_t
          WHERE ooagent = g_enterprise
            AND ooag001 = g_master.xrda003
         
         SELECT glaacomp INTO l_xrde_t.xrdeorga 
           FROM glaa_t
          WHERE glaaent = g_enterprise
            AND glaald  = g_ld
         LET l_xrde_t.xrde019  = l_xrde_t.xrdeorga
         LET l_xrde_t.xrde020  = ''
         LET l_xrde_t.xrde022  = ''
         LET l_xrde_t.xrde023  = ''
         
             
         SELECT glab005,glab010 INTO l_xrde_t.xrde016,l_xrde_t.xrde011 FROM glab_t
          WHERE glabent = g_enterprise
            AND glabld = g_master.xrdald
            AND glab003 = l_glab003
         
         SELECT nmad003 INTO l_xrde_t.xrde012 FROM nmad_t
          WHERE nmadent = g_enterprise
            AND nmad001 = g_glaa.glaa005
            AND nmad002 = l_xrde_t.xrde011
           
         #SELECT gzcb003 INTO l_xrde_t.xrde015 FROM gzcb_t
         # WHERE gzcb002 = '20'
         #   AND gzcb001 = '8306'
            
         IF l_xrde_t.xrde119 < 0 THEN 
            LET l_xrde_t.xrde119 = l_xrde_t.xrde119 * -1
         END IF
         
         IF l_xrde_t.xrde129 < 0 THEN 
            LET l_xrde_t.xrde129 = l_xrde_t.xrde129 * -1
         END IF
         
         IF l_xrde_t.xrde139 < 0 THEN 
            LET l_xrde_t.xrde139 = l_xrde_t.xrde139 * -1
         END IF

         #INSERT INTO xrde_t VALUES(l_xrde_t.*)
         INSERT INTO xrde_t(xrdeent,xrdecomp,xrdeld,xrdesite,xrdeorga,xrdedocno,xrdeseq,xrde001,
                            xrde002,xrde003,xrde004,xrde006,xrde008,xrde010,xrde011,xrde012,xrde013,
                            xrde014,xrde015,xrde016,xrde017,xrde018,xrde019,xrde020,xrde022,xrde023,
                            xrde100,xrde101,xrde109,xrde119,xrde120,xrde121,xrde129,xrde130,xrde131,xrde139)
                     VALUES(l_xrde_t.xrdeent ,l_xrde_t.xrdecomp ,l_xrde_t.xrdeld ,l_xrde_t.xrdesite,
                            l_xrde_t.xrdeorga,l_xrde_t.xrdedocno,l_xrde_t.xrdeseq,l_xrde_t.xrde001,
                            l_xrde_t.xrde002 ,l_xrde_t.xrde003  ,l_xrde_t.xrde004,l_xrde_t.xrde006,
                            l_xrde_t.xrde008 ,l_xrde_t.xrde010  ,l_xrde_t.xrde011,l_xrde_t.xrde012,
                            l_xrde_t.xrde013 ,l_xrde_t.xrde014  ,l_xrde_t.xrde015,l_xrde_t.xrde016,
                            l_xrde_t.xrde017 ,l_xrde_t.xrde018  ,l_xrde_t.xrde019,l_xrde_t.xrde020,
                            l_xrde_t.xrde022 ,l_xrde_t.xrde023  ,l_xrde_t.xrde100,l_xrde_t.xrde101,
                            l_xrde_t.xrde109 ,l_xrde_t.xrde119  ,l_xrde_t.xrde120,l_xrde_t.xrde121,
                            l_xrde_t.xrde129 ,l_xrde_t.xrde130  ,l_xrde_t.xrde131,l_xrde_t.xrde139
                            )
         
         
         IF SQLCA.sqlcode THEN
            LET g_success = 'N' RETURN
         END IF
         
         LET l_xrde_t.xrdeseq = l_xrde_t.xrdeseq + 1
         
      END IF

   END FOREACH
END FUNCTION]]>
  </point>
  <point name="function.axrp400_get_amt" order="13" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_get_amt()
  DEFINE l_amt1,l_amt2      LIKE xrde_t.xrde109     #收款金額
   DEFINE l_amt3,l_amt4      LIKE xrce_t.xrce109     #帳款金額
   DEFINE l_amt5,l_amt6      LIKE xrce_t.xrce109     #匯差及調整金額
   DEFINE l_amt7,l_amt8      LIKE xrce_t.xrce109     #差異金額
   DEFINE l_amt1_1,l_amt2_1  LIKE xrde_t.xrde109     #收款金額         本位幣二/三
   DEFINE l_amt3_1,l_amt4_1  LIKE xrce_t.xrce109     #帳款金額         本位幣二/三
   DEFINE l_amt5_1,l_amt6_1  LIKE xrce_t.xrce109     #匯差及調整金額    本位幣二/三
   DEFINE l_amt7_1,l_amt8_1  LIKE xrce_t.xrce109     #差異金額         本位幣二/三
   DEFINE l_xrde109_d        LIKE xrde_t.xrde109
   DEFINE l_xrde119_d        LIKE xrde_t.xrde109
   DEFINE l_xrde129_d        LIKE xrde_t.xrde109
   DEFINE l_xrde139_d        LIKE xrde_t.xrde109
   DEFINE l_xrce109_d        LIKE xrce_t.xrce109
   DEFINE l_xrce119_d        LIKE xrce_t.xrce109
   DEFINE l_xrce129_d        LIKE xrce_t.xrce109
   DEFINE l_xrce139_d        LIKE xrce_t.xrce109
   DEFINE l_xrde109_c        LIKE xrde_t.xrde109
   DEFINE l_xrde119_c        LIKE xrde_t.xrde109
   DEFINE l_xrde129_c        LIKE xrde_t.xrde109
   DEFINE l_xrde139_c        LIKE xrde_t.xrde109
   DEFINE l_xrce109_c        LIKE xrce_t.xrce109
   DEFINE l_xrce119_c        LIKE xrce_t.xrce109
   DEFINE l_xrce129_c        LIKE xrce_t.xrce109
   DEFINE l_xrce139_c        LIKE xrce_t.xrce109
   
   #計算收款
   SELECT SUM(xrde109),SUM(xrde119) INTO l_amt1,l_amt2 FROM xrde_t,gzcb_t
    WHERE xrdeent = g_enterprise
      AND xrdeld  = g_master.xrdald
      AND xrdedocno = g_xrdadocno
      AND xrde002 = gzcb002
      AND gzcb001 = '8306'
      AND gzcb004 = '1'
      AND xrde002 = '10'
   IF cl_null(l_amt1) THEN LET l_amt1 = 0 END IF
   IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
   
   #計算帳款
   SELECT SUM(xrce109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END),SUM(xrce119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END)
     INTO l_amt3,l_amt4
     FROM xrce_t,gzcb_t
    WHERE xrceent = g_enterprise
      AND xrceld  = g_master.xrdald
      AND xrcedocno = g_xrdadocno
      AND gzcb001 = '8306'
      AND gzcb004 = '2'
      AND gzcb002 = xrce002
   IF cl_null(l_amt3) THEN LET l_amt3 = 0 END IF
   IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
   
   #計算匯差及調整帳款
   SELECT SUM(xrde109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END),SUM(xrde119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END)
     INTO l_amt5,l_amt6
     FROM xrde_t,gzcb_t
    WHERE xrdeent = g_enterprise
      AND xrdeld  = g_master.xrdald
      AND xrdedocno = g_xrdadocno
      AND xrde002 = gzcb002
      AND gzcb001 = '8306'
      AND xrde002 <> 10
      AND gzcb004 = '1'
   IF cl_null(l_amt5) THEN LET l_amt5 = 0 END IF
   IF cl_null(l_amt6) THEN LET l_amt6 = 0 END IF
   
   LET l_amt7 = 0
   LET l_amt8 = l_amt2 + l_amt4 + l_amt6
   LET g_amt1 = l_amt8
END FUNCTION]]>
  </point>
  <point name="function.axrp400_change_to_sql" order="14" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 將取回的字串轉換為SQL條件
################################################################################
PRIVATE FUNCTION axrp400_change_to_sql(p_wc)
   DEFINE p_wc       STRING
   DEFINE r_wc       STRING
   DEFINE tok        base.StringTokenizer
   DEFINE l_str      STRING

   LET tok = base.StringTokenizer.create(p_wc,",")
   WHILE tok.hasMoreTokens()
      IF cl_null(l_str) THEN
         LET l_str = tok.nextToken()
      ELSE
         LET l_str = l_str,"','",tok.nextToken()
      END IF
   END WHILE
   LET r_wc = "'",l_str,"'"

   RETURN r_wc
END FUNCTION]]>
  </point>
  <point name="function.axrp400_construct" order="15" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_construct()
    DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE li_idx1           LIKE type_t.num10
   DEFINE l_n               LIKE type_t.num10
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_xrdasite        LIKE xrda_t.xrdasite
   DEFINE l_xrdald          LIKE xrda_t.xrdald
   DEFINE l_xrda003         LIKE xrda_t.xrda003
   DEFINE l_xrdadocdt       LIKE xrda_t.xrdadocdt
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_success_1    LIKE type_t.num5
   DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                   oofg019     LIKE oofg_t.oofg019,   #field
                   oofg020     LIKE oofg_t.oofg020    #value
                           END RECORD
   DEFINE l_origin_str      STRING
   #end add-point 

   CLEAR FORM
   INITIALIZE g_wc  TO NULL
   INITIALIZE g_wc2 TO NULL
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         #add-point:ui_dialog段input
         INPUT BY NAME g_master.xrdasite,g_master.xrdald,g_master.xrdadocno,g_master.xrda003,g_master.xrdadocdt, 
                       g_master.xrca063,g_master.chk,g_master.diff
             
            BEFORE INPUT
               CALL axrp400_def()
               LET g_master.xrdadocdt = g_today
               DISPLAY BY NAME g_master.*
               
            ON ACTION controlp INFIELD xrdasite
                INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.xrdasite       #給予default值
               LET g_qryparam.where = " ooef201 = 'Y' "

               #給予arg

               CALL q_ooef001()                                #呼叫開窗
               LET g_master.xrdasite = g_qryparam.return1        #將開窗取得的值回傳到變數
               IF NOT cl_null(g_master.xrdasite) THEN
                  CALL s_axrt300_site_geared_ld(g_master.xrdasite,g_master.xrdald,g_user,g_today,'site')
                     RETURNING l_success,g_master.xrdasite,g_master.xrdasite_desc,g_master.xrdald,g_master.xrdald_desc
                  SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
               END IF
               DISPLAY g_master.xrdasite TO xrdasite             #顯示到畫面上
               CALL axrp400_xrda_dis('site')
               NEXT FIELD xrdasite                               #返回原欄位
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrdasite
            #add-point:BEFORE FIELD xrdasite
            LET l_xrdasite = g_master.xrdasite
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrdasite
            
            #add-point:AFTER FIELD xrdasite
             LET g_master.xrdasite_desc = ' '
               DISPLAY BY NAME g_master.xrdasite_desc
               IF NOT cl_null(g_master.xrdasite) THEN
                  IF NOT cl_null(g_master.xrdasite) THEN
                     CALL s_axrt300_site_geared_ld(g_master.xrdasite,g_master.xrdald,g_user,g_today,'site')
                        RETURNING l_success,g_master.xrdasite,g_master.xrdasite_desc,g_master.xrdald,g_master.xrdald_desc
                     DISPLAY BY NAME g_master.xrdasite,g_master.xrdasite_desc
                     DISPLAY BY NAME g_master.xrdald,g_master.xrdald_desc
                     IF NOT l_success THEN NEXT FIELD CURRENT END IF
                  ELSE
                     LET g_master.xrdasite_desc = ''
                  END IF
                  CALL s_fin_create_account_center_tmp()
                  CALL s_fin_account_center_sons_query('3',g_master.xrdasite,g_today,'1')
                  IF cl_null(g_master.xrdasite) THEN
                    CALL s_fin_orga_get_comp_ld(g_master.xrdasite) RETURNING l_success,g_errno,g_master.xrdacomp_desc,g_master.xrdald
                  END IF
                  CALL s_fin_account_center_with_ld_chk(g_master.xrdasite,g_master.xrdald,g_user,'3','N','',g_master.xrdadocdt) RETURNING l_success,g_errno
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_master.xrdasite
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_master.xrdasite = ''
                     LET g_master.xrdald = ''
                     LET g_master.xrdacomp_desc = ''
                     
                     CALL axrp400_xrda_dis('site')
                     DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc
                     NEXT FIELD CURRENT
                  END IF
                  CALL s_axrt300_date_chk(g_master.xrdasite,g_master.xrdadocdt) RETURNING l_success
                  IF NOT l_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = ""
                     LET g_errparam.code   = "axr-00299"
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     LET g_master.xrdasite = ''
                     LET g_master.xrdald = ''
                     LET g_master.xrdacomp_desc = ''
                     DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc
                     NEXT FIELD CURRENT
                  END IF
#                  
               END IF
               CALL axrp400_xrda_dis('site')
               CALL axrp400_xrda_dis('ld')
            #END add-point
            
 
            #Ctrlp:construct.c.xrdald
            #應用 a03 樣板自動產生(Version:2)
            ON ACTION controlp INFIELD xrdald
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.xrdald         #給予default值
               #取得帳務組織下所屬成員
               CALL s_fin_account_center_sons_query('3',g_master.xrdasite,g_master.xrdadocdt,'1')
               #取得帳務組織下所屬成員之帳別
               CALL s_fin_account_center_comp_str() RETURNING l_origin_str
               #將取回的字串轉換為SQL條件
               CALL axrp400_change_to_sql(l_origin_str) RETURNING l_origin_str
               IF l_origin_str <> '''' THEN
                  LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y') AND glaacomp IN (",l_origin_str," )"
               ELSE
                  LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y')"
               END IF
               LET g_qryparam.arg1 = g_user
               LET g_qryparam.arg2 = g_dept
               CALL  q_authorised_ld()                           #呼叫開窗
               LET g_master.xrdald = g_qryparam.return1          #將開窗取得的值回傳到變數
               DISPLAY g_master.xrdald TO xrdald                 #顯示到畫面上
               LET g_qryparam.where = ''
               CALL axrp400_xrda_dis('ld')
               NEXT FIELD xrdald                                 #返回原欄位
 
            #應用 a01 樣板自動產生(Version:1)
            BEFORE FIELD xrdald
               #add-point:BEFORE FIELD xrdald
               LET l_xrdald = g_master.xrdald
               #END add-point
 
            #應用 a02 樣板自動產生(Version:1)
            AFTER FIELD xrdald
            
               #add-point:AFTER FIELD xrdald
               LET g_master.xrdald_desc = ' '
               DISPLAY BY NAME g_master.xrdald_desc
               IF NOT cl_null(g_master.xrdald) THEN
                  CALL s_fin_account_center_with_ld_chk(g_master.xrdasite,g_master.xrdald,g_user,'3','N','',g_master.xrdadocdt) RETURNING l_success,g_errno
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_master.xrdald
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.xrdald = ''
                     CALL axrp400_xrda_dis('ld')
                     NEXT FIELD CURRENT
                  END IF
               END IF
               CALL axrp400_xrda_dis('ld')
            #END add-point
            
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD glaacomp_desc
            #add-point:BEFORE FIELD glaacomp_desc

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD glaacomp_desc
            
            #add-point:AFTER FIELD glaacomp_desc

            #END add-point
            
 
         #Ctrlp:construct.c.glaacomp_desc
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD glaacomp_desc
            #add-point:ON ACTION controlp INFIELD glaacomp_desc

            #END add-point
 
         #Ctrlp:construct.c.xrdadocno
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrdadocno
            #add-point:ON ACTION controlp INFIELD xrdadocno
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_master.xrdadocno             #給予default值
            LET l_glaa024 = ''
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
            #給予arg
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = "axrt400"
            
            CALL q_ooba002_1()                                #呼叫開窗

            LET g_master.xrdadocno = g_qryparam.return1              

            DISPLAY g_master.xrdadocno TO xrdadocno              #

            NEXT FIELD xrdadocno                          #返回原欄位
    


            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrdadocno
            #add-point:BEFORE FIELD xrdadocno

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrdadocno
            
            #add-point:AFTER FIELD xrdadocno

            #END add-point
            
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrda003
            #add-point:BEFORE FIELD xrda003
            LET l_xrda003 = g_master.xrda003
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrda003
            
            #add-point:AFTER FIELD xrda003
            IF NOT cl_null(g_master.xrda003) THEN 
#此段落由子樣板a19產生
               #校驗代值
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_master.xrda003

                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooag001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 
               ELSE
                  #檢查失敗時後續處理
                  LET g_master.xrda003 = l_xrda003
                  CALL axrp400_ref_xrda003()
                  NEXT FIELD CURRENT
               END IF
            
               CALL axrp400_ref_xrda003() 
            END IF 
            #END add-point
            
 
         #Ctrlp:construct.c.xrda003
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrda003
            #add-point:ON ACTION controlp INFIELD xrda003
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_master.xrda003             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #

            
            CALL q_ooag001()                                #呼叫開窗

            LET g_master.xrda003 = g_qryparam.return1       
            CALL axrp400_ref_xrda003()            

            DISPLAY g_master.xrda003 TO xrda003              #

            NEXT FIELD xrda003                          #返回原欄位
            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrdadocdt
            #add-point:BEFORE FIELD xrdadocdt
            LET l_xrdadocdt = g_master.xrdadocdt
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrdadocdt
            
            #add-point:AFTER FIELD xrdadocdt
            IF NOT cl_null(g_master.xrdadocdt) THEN
               CALL s_axrt300_date_chk(g_master.xrdasite,g_master.xrdadocdt) RETURNING l_success
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = "axr-00299"
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET g_master.xrdadocdt = l_xrdadocdt
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
         #Ctrlp:construct.c.xrdadocdt
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrdadocdt
            #add-point:ON ACTION controlp INFIELD xrdadocdt

            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrca063
            #add-point:BEFORE FIELD xrca063

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrca063
            
            #add-point:AFTER FIELD xrca063

            #END add-point
            
 
         #Ctrlp:construct.c.xrca063
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrca063
            #add-point:ON ACTION controlp INFIELD xrca063
            CALL s_aooi390_gen('14') RETURNING l_success_1,g_master.xrca063,l_oofg_return
            DISPLAY BY NAME g_master.xrca063
            NEXT FIELD xrca063
            #END add-point
 
  
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD diff
            #add-point:BEFORE FIELD diff

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD diff
            
            #add-point:AFTER FIELD diff

            #END add-point
            
 
         #Ctrlp:construct.c.diff
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD diff
            #add-point:ON ACTION controlp INFIELD diff

            #END add-point
 
         END INPUT
         
      CONSTRUCT BY NAME g_wc1 ON b_nmbbdocno,b_nmbbseq,b_nmbb026,b_nmbadocdt,b_nmbb029,b_nmbb004,b_nmbb053,b_nmbb031,b_nmbb030,b_nmbb003
             BEFORE CONSTRUCT
                  
         #Ctrlp:construct.c.nmbbdocno
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbbdocno
            #add-point:ON ACTION controlp INFIELD nmbbdocno
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " nmbbcomp = '",g_glaa.glaacomp,"'"
            CALL q_nmbbdocno()                           #呼叫開窗
            LET g_qryparam.where = ""
            DISPLAY g_qryparam.return1 TO b_nmbbdocno  #顯示到畫面上
            NEXT FIELD b_nmbbdocno                     #返回原欄位
            #END add-point
 
         
         #Ctrlp:construct.c.nmbb026
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb026
            #add-point:ON ACTION controlp INFIELD nmbb026
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_glaa.glaacomp
            CALL q_pmaa001_13()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb026      #顯示到畫面上
            NEXT FIELD b_nmbb026                         #返回原欄位
            #END add-point
           

         #Ctrlp:construct.c.nmbb004
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb004
            #add-point:ON ACTION controlp INFIELD nmbb004
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_aooi001_1()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb004      #顯示到畫面上
            NEXT FIELD b_nmbb004                         #返回原欄位
            #END add-point
            
         #Ctrlp:construct.c.nmbb053
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb053
            #add-point:ON ACTION controlp INFIELD nmbb053
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb053  #顯示到畫面上
            NEXT FIELD b_nmbb053                     #返回原欄位
            #END add-point
 
         #Ctrlp:construct.c.nmbb030
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb030
            #add-point:ON ACTION controlp INFIELD nmbb030
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_nmbb030_02()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb030      #顯示到畫面上
            NEXT FIELD b_nmbb030                         #返回原欄位
            #END add-point
        
         #Ctrlp:construct.c.nmbb003
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb003
            #add-point:ON ACTION controlp INFIELD nmbb003
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_nmas_01()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb003  #顯示到畫面上
            NEXT FIELD b_nmbb003                     #返回原欄位

            #END add-point
            
         END CONSTRUCT
        
        #應用 a58 樣板自動產生(Version:2)
         CONSTRUCT BY NAME g_wc2 ON b_xrcadocno,b_xrccseq,b_xrcc001,b_xrcasite,b_xrca003,b_xrca005,b_xrcald
            BEFORE CONSTRUCT
         
            #Ctrlp:construct.c.xrcadocno
            #應用 a03 樣板自動產生(Version:2)
            ON ACTION controlp INFIELD b_xrcadocno
               #add-point:ON ACTION controlp INFIELD xrcadocno
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               LET g_qryparam.where= "xrcadocdt <= '",g_master.xrdadocdt,"'",
                                     " AND xrca001 NOT IN ('01','02','03','04','31','141','142')"
               CALL q_xrcadocno_12()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrcadocno      #顯示到畫面上
               NEXT FIELD b_xrcadocno                        #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrcasite
               #add-point:ON ACTION controlp INFIELD xrcasite
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_ooef001()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrcasite      #顯示到畫面上
               NEXT FIELD b_xrcasite                       #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrca003
               #add-point:ON ACTION controlp INFIELD xrca003
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_ooag001()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca003      #顯示到畫面上
               NEXT FIELD b_xrca003                      #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrca005
               #add-point:ON ACTION controlp INFIELD xrca005
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_pmaa001_13()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca005      #顯示到畫面上
               NEXT FIELD b_xrca005                      #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrcald
               #add-point:ON ACTION controlp INFIELD xrcald
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_authorised_ld()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrcald     #顯示到畫面上
               NEXT FIELD b_xrcld                      #返回原欄位
               #END add-point
            
         END CONSTRUCT
         
#         DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
#      
#            BEFORE DISPLAY 
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
#               LET l_cnt = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_cnt
#         
#         END DISPLAY
#         DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt) 
#      
#            BEFORE DISPLAY 
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
#               LET l_cnt = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_cnt
#
#            
#               
#         END DISPLAY
         #end add-point
      ON ACTION qbe_select      
 
      ON ACTION qbe_save       
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   
 
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0 
      RETURN
   END IF
END FUNCTION]]>
  </point>
  <point name="function.axrp400_ui_dialog_1" order="16" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ui_dialog_1()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE li_idx1           LIKE type_t.num10
   DEFINE l_n               LIKE type_t.num10
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_xrdasite        LIKE xrda_t.xrdasite
   DEFINE l_xrdald          LIKE xrda_t.xrdald
   DEFINE l_xrda003         LIKE xrda_t.xrda003
   DEFINE l_xrdadocdt       LIKE xrda_t.xrdadocdt
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_success_1    LIKE type_t.num5
   DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                   oofg019     LIKE oofg_t.oofg019,   #field
                   oofg020     LIKE oofg_t.oofg020    #value
                           END RECORD
   DEFINE l_origin_str      STRING
   #end add-point 
   #add-point:ui_dialog段define

   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 

   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         CALL g_detail2_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc1 = ' 1=1'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL axrp400_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
          

         #end add-point
         #add-point:ui_dialog段input
         
         INPUT ARRAY g_detail_d FROM s_detail1.* 
              ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)
            BEFORE INPUT
               IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
                 CALL FGL_SET_ARR_CURR(g_detail_d.getLength()+1) 
                 LET g_insert = 'N' 
               END IF 
               CALL cl_set_comp_entry("b_nmbbdocno,b_nmbbseq,b_nmbb026,b_nmbadocdt,b_nmbb029,b_nmbb004,b_nmbb006,b_nmbb008,
                                       b_nmbb053,b_nmbb031,b_nmbb030,b_nmbb040,b_nmbb003,b_nmbb005,b_nmbb009",FALSE)
             
            BEFORE ROW
               LET l_ac = ARR_CURR()
               LET g_master_idx = l_ac
               DISPLAY l_ac TO FORMONLY.h_index
              #CALL axrp400_fetch()              
               
            ON CHANGE sel
               UPDATE axrp400_tmp 
                  SET sel = g_detail_d[l_ac].sel 
                WHERE nmbbdocno = g_detail_d[l_ac].nmbbdocno  
                  AND nmbbseq = g_detail_d[l_ac].nmbbseq
                  
         END INPUT
         

          INPUT ARRAY g_detail2_d FROM s_detail2.* 
              ATTRIBUTE(COUNT = g_rec_b1,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)
            BEFORE INPUT
                LET g_rec_b = g_detail2_d.getLength()
                CALL cl_set_comp_entry("b_xrcadocno,b_xrccseq,b_xrcc001,b_xrca001,b_xrcasite,b_xrca003,b_xrca005,b_xrcald,
                                        b_xrcadocdt",FALSE)
             
            BEFORE ROW
               LET l_ac1 = ARR_CURR()
               LET g_master_idx = l_ac1
              #DISPLAY l_ac TO FORMONLY.h_index
              #CALL axrp400_fetch()              
               
            ON CHANGE sel1
            
               UPDATE axrp400_tmp 
                  SET sel1 = g_detail2_d[l_ac1].sel1
                WHERE xrcadocno = g_detail2_d[l_ac1].xrcadocno  
                  AND xrccseq = g_detail2_d[l_ac1].xrccseq    
                  AND xrcc001 = g_detail2_d[l_ac1].xrcc001
            
         END INPUT
         #end add-point
         #add-point:ui_dialog段自定義display array
         #應用 a58 樣板自動產生(Version:2)
         
#         DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
#      
#            BEFORE DISPLAY 
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
#               LET l_cnt = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_cnt
#         
#         END DISPLAY
#         DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt) 
#      
#            BEFORE DISPLAY 
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
#               LET l_cnt = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_cnt
#
#            
#               
#         END DISPLAY

         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.sel1", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.sel1", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            CALL axrp400_construct()
            CALL axrp400_b_fill()
            CALL axrp400_b_fill1()
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall

            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 1)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "Y"
               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 0)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "N"
               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
                  UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                   WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                     AND nmbbseq = g_detail_d[li_idx].nmbbseq
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  LET g_detail2_d[li_idx1].sel1 = "Y"
                  UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                   WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                     AND xrccseq = g_detail2_d[li_idx1].xrccseq
                     AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               END IF
            END FOR
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
                  UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                   WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                     AND nmbbseq = g_detail_d[li_idx].nmbbseq
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  LET g_detail2_d[li_idx1].sel1 = "N"
                  UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                   WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                     AND xrccseq = g_detail2_d[li_idx1].xrccseq
                     AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               END IF
            END FOR
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL axrp400_filter()
            #add-point:ON ACTION filter

            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
           #LET INT_FLAG=FALSE
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前

            #end add-point
            CALL axrp400_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            CLEAR FORM
            INITIALIZE g_master.* TO NULL
            CALL axrp400_def()
            CALL g_detail_d.clear()
            CALL g_detail2_d.clear()
            CALL axrp400_construct()
            CALL axrp400_b_fill()
            CALL axrp400_b_fill1()
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh

            #end add-point
            CALL axrp400_b_fill()
 
         #add-point:ui_dialog段action
         ON ACTION cancel
            #清除畫面及相關資料
            CLEAR FORM
            CALL g_detail_d.clear()
            CALL g_detail2_d.clear()
            LET g_wc  = ' 1=2'
            LET g_wc1 = ' 1=1'
            LET g_wc2 = ' 1=1'
            LET g_action_choice = ""
            CALL axrp400_init()
            LET INT_FLAG = 0
            EXIT DIALOG 
            
         ON ACTION batch_execute
            SELECT COUNT(*) INTO l_n
              FROM axrp400_tmp
             WHERE (sel = 'Y' OR sel1 = 'Y')
            IF l_n = 0 THEN 
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = 'axr-00159' 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               
               EXIT DIALOG
            END IF
            
            CALL axrp400_get_ar()
            DROP TABLE axrp400_tmp;
            DROP TABLE s_voucher_ar_tmp;
            DROP TABLE s_voucher_ar_group;
            DROP TABLE s_voucher_glbc;
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
#      IF INT_FLAG THEN
#         LET INT_FLAG = FALSE
#         EXIT WHILE
#      END IF
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
    CALL cl_set_act_visible("accept,cancel", TRUE)
END FUNCTION]]>
  </point>
  <point name="b_fill.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_sql       STRING
   DEFINE l_sql1      STRING
   DEFINE ls_ac         LIKE type_t.num5
   DEFINE l_cmd         LIKE type_t.num5
   DEFINE l_flag        LIKE type_t.chr1
   DEFINE l_str         STRING
   DEFINE l_sub_sql     STRING
   DEFINE ls_wc1        STRING
   DEFINE ls_wc2        STRING
   DEFINE ls_wc3        STRING
   DEFINE l_success     LIKE type_t.num5]]>
  </point>
  <point name="b_fill.foreach_into" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   g_detail_d[l_ac].*]]>
  </point>
  <point name="b_fill.foreach_iside" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      CALL s_axrt300_xrca_ref('xrca003',g_detail_d[l_ac].nmbb053,'','') RETURNING l_success,g_detail_d[l_ac].nmbb053_desc
      CALL s_axrt300_xrca_ref('xrca005',g_detail_d[l_ac].nmbb026,'','') RETURNING l_success,g_detail_d[l_ac].nmbb026_desc
      
      INITIALIZE g_ref_fields TO NULL
      LET g_ref_fields[1] = g_detail_d[l_ac].nmbb003
      CALL ap_ref_array2(g_ref_fields,"SELECT nmaal003 FROM nmaal_t WHERE nmaalent='"||g_enterprise||"' AND nmaal001=? AND nmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
      LET g_detail_d[l_ac].nmbb003_desc =  g_rtn_fields[1]
      
      INSERT INTO axrp400_tmp(sel,nmbbdocno,nmbbseq,nmbb026) 
        VALUES(g_detail_d[l_ac].sel,g_detail_d[l_ac].nmbbdocno,g_detail_d[l_ac].nmbbseq,g_detail_d[l_ac].nmbb026)]]>
  </point>
  <point name="b_fill.other_table" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL g_detail_d.deleteElement(g_detail_d.getLength())]]>
  </point>
  <point name="b_fill.sql_before" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   LET g_wc1 = cl_replace_str(g_wc1,'b_nmbb','nmbb')
   LET g_wc1 = cl_replace_str(g_wc1,'b_nmba','nmba')
   CASE
      WHEN g_ls = '1'
         LET ls_wc = "nmbb006 > nmbb008"
      WHEN g_ls = '2'
         LET ls_wc = "nmbb020 > nmbb021"
      WHEN g_ls = '3'
         LET ls_wc = "nmbb023 > nmbb024"
   END CASE
   
   LET l_sql = " SELECT 'N',nmbbdocno,nmbbseq,nmbb026,'',nmbadocdt,nmbb029,nmbb004,nmbb006,nmbb006-nmbb008, ",
               "         nmbb053,'',nmbb031,nmbb030,nmbb040,nmbb003,'',nmbb005,nmbb009 "
               
               
   LET g_sql = l_sql CLIPPED ,
               "  FROM nmba_t,nmbb_t ",
	            " WHERE nmbbent = nmbaent ",
               "   AND nmbbcomp = nmbacomp ",
               "   AND nmbbdocno = nmbadocno",
               "   AND nmbaent = ?",
	            "   AND nmbbcomp = '",g_glaa.glaacomp,"'",
	            "   AND nmbastus = 'Y' ",
	            "   AND nmbb001= '1' ",
               "   AND nmbadocdt <= '",g_master.xrdadocdt,"'",
               "   AND nmba003 ='anmt510'",
               "   AND nmbb029 IN ('10','30')",
               "   AND ",ls_wc CLIPPED,
               "   AND ",g_wc1 CLIPPED,
               " UNION ",
               l_sql CLIPPED,
               "  FROM nmba_t,nmbb_t,ooia_t ",
               " WHERE nmbbent = nmbaent ",
               "   AND nmbbcomp = nmbacomp ",
               "   AND nmbbdocno = nmbadocno",
               "   AND nmbbent = nmbaent AND nmbb028 = ooia001 ",
               "   AND (ooia002 = '10' OR ooia002 = '20')",
               "   AND nmbaent = ",g_enterprise,
	            "   AND nmbbcomp = '",g_glaa.glaacomp,"'",
	            "   AND (nmbastus = 'Y' OR nmbastus = 'V')",
	            "   AND nmbb001= '1' ",
               "   AND nmbadocdt <= '",g_master.xrdadocdt,"'",
               "   AND nmba003 = 'anmt540'",
               "   AND nmbb029 IN ('10','30')",
               "   AND ",ls_wc CLIPPED,
               "   AND ",g_wc1 CLIPPED]]>
  </point>
  <point name="fetch.after_fill" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL axrp400_b_fill1()]]>
  </point>
  <point name="filter.detail_cnt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY]]>
  </point>
  <point name="global.argv" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[ TYPE type_master RECORD
       xrdasite LIKE type_t.chr10, 
   xrdasite_desc LIKE type_t.chr80, 
   xrdald LIKE type_t.chr5, 
   xrdald_desc LIKE type_t.chr80, 
   xrdacomp_desc LIKE type_t.chr500, 
   xrdadocno LIKE type_t.chr20, 
   xrdadocno_desc LIKE type_t.chr80, 
   xrda003 LIKE type_t.chr500, 
   xrda003_desc LIKE type_t.chr80, 
   xrdadocdt LIKE type_t.dat, 
   xrca063 LIKE type_t.chr500, 
   chk LIKE type_t.chr500, 
   diff LIKE type_t.chr500, 
   stagenow LIKE type_t.chr80,
       wc               STRING
       END RECORD
 
#模組變數(Module Variables)
DEFINE g_master type_master
DEFINE g_detail2_d   DYNAMIC ARRAY OF type_g_detail2
DEFINE g_detail2_t   type_g_detail2
DEFINE g_glaa            RECORD LIKE glaa_t.*
DEFINE g_ls              LIKE type_t.chr1
DEFINE g_wc1             STRING
DEFINE g_wc_ar           STRING
DEFINE g_wc_nm           STRING
DEFINE g_wc_ap           STRING
DEFINE g_xrdadocno       LIKE xrda_t.xrdadocno
DEFINE g_amt1            LIKE xrce_t.xrce109
 TYPE type_g_nmbb_d        RECORD
       nmbb026 LIKE nmbb_t.nmbb026
     END RECORD  
DEFINE g_nmbb026_d         DYNAMIC ARRAY OF type_g_nmbb_d
DEFINE g_cnt1             LIKE type_t.num5
DEFINE g_cnt2             LIKE type_t.num5
DEFINE g_cnt3             LIKE type_t.num5
DEFINE l_ac1              LIKE type_t.num10  
DEFINE g_rec_b        LIKE type_t.num5 
DEFINE g_rec_b1       LIKE type_t.num5
DEFINE l_cnt          LIKE type_t.num5
DEFINE g_detail_idx   LIKE type_t.num5]]>
  </point>
  <point name="global.variable" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[     sel LIKE type_t.chr1, 
   nmbbdocno LIKE nmbb_t.nmbbdocno,
   nmbbseq LIKE nmbb_t.nmbbseq, 
   nmbb026 LIKE nmbb_t.nmbb026,
   nmbb026_desc LIKE type_t.chr80,
   nmbadocdt LIKE nmba_t.nmbadocdt,
   nmbb029 LIKE nmbb_t.nmbb029, 
   nmbb004 LIKE nmbb_t.nmbb004, 
   nmbb006 LIKE nmbb_t.nmbb006, 
   nmbb008 LIKE nmbb_t.nmbb008, 
   nmbb053 LIKE nmbb_t.nmbb053, 
   nmbb053_desc LIKE type_t.chr80, 
   nmbb031 LIKE nmbb_t.nmbb031, 
   nmbb030 LIKE nmbb_t.nmbb030, 
   nmbb040 LIKE nmbb_t.nmbb040, 
   nmbb003 LIKE nmbb_t.nmbb003, 
   nmbb003_desc LIKE type_t.chr80, 
   nmbb005 LIKE nmbb_t.nmbb005, 
   nmbb009 LIKE nmbb_t.nmbb009
       END RECORD
       
TYPE type_g_detail2 RECORD
       sel1 LIKE type_t.chr1, 
   xrcadocno LIKE xrca_t.xrcadocno,
   xrccseq LIKE xrcc_t.xrccseq,
   xrcc001 LIKE xrcc_t.xrcc001,
   xrca001 LIKE xrca_t.xrca001, 
   xrcasite LIKE xrca_t.xrcasite,
   xrcasite_desc LIKE type_t.chr80,
   xrca003 LIKE xrca_t.xrca003,
   xrca003_desc LIKE type_t.chr80,
   xrca005 LIKE xrca_t.xrca005,
   xrca005_desc LIKE type_t.chr80,
   xrcald LIKE xrca_t.xrcald,
   xrcald_desc LIKE type_t.chr80,
   xrcadocdt LIKE xrca_t.xrcadocdt, 
   xrcc108 LIKE xrcc_t.xrcc108,
   xrcc109 LIKE xrcc_t.xrcc109,
   xrcc108_1 LIKE xrcc_t.xrcc108
       END RECORD]]>
  </point>
  <point name="init.init" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL axrp400_create_tmp_table()
   CALL cl_set_combo_scc('b_xrca001','8302')
   CALL cl_set_combo_scc('b_nmbb029','8310') ]]>
  </point>
  <point name="ui_dialog.before_dialog" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   CALL axrp400_ui_dialog_1()
   RETURN]]>
  </point>
  <point name="ui_dialog.before_dialog2" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL axrp400_construct()]]>
  </point>
  <point name="ui_dialog.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE li_idx1           LIKE type_t.num10
   DEFINE l_n               LIKE type_t.num10
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_xrdasite        LIKE xrda_t.xrdasite
   DEFINE l_xrdald          LIKE xrda_t.xrdald
   DEFINE l_xrda003         LIKE xrda_t.xrda003
   DEFINE l_xrdadocdt       LIKE xrda_t.xrdadocdt
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_success_1    LIKE type_t.num5
   DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                   oofg019     LIKE oofg_t.oofg019,   #field
                   oofg020     LIKE oofg_t.oofg020    #value
                           END RECORD
   DEFINE l_origin_str      STRING]]>
  </point>
  <point name="ui_dialog.for.onaction_selall" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq]]>
  </point>
  <point name="ui_dialog.for.onaction_selnone" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq]]>
  </point>
  <point name="ui_dialog.more_action" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         ON ACTION batch_execute
            SELECT COUNT(*) INTO l_n
              FROM axrp400_tmp
             WHERE (sel = 'Y' OR sel1 = 'Y')
            IF l_n = 0 THEN 
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = 'axr-00159' 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               
               EXIT DIALOG
            END IF
            
            CALL axrp400_get_ar()
            ]]>
  </point>
  <point name="ui_dialog.more_construct" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[          
]]>
  </point>
  <point name="ui_dialog.more_displayarray" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[         #應用 a58 樣板自動產生(Version:2)
         
         DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_cnt = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_cnt
         
         END DISPLAY
         DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
               LET l_cnt = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_cnt

            
               
         END DISPLAY
]]>
  </point>
  <point name="ui_dialog.more_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[       
#         INPUT ARRAY g_detail_d FROM s_detail1.* 
#              ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
#                        INSERT ROW = FALSE,
#                        DELETE ROW = FALSE,
#                        APPEND ROW = FALSE)
#            BEFORE INPUT
#               IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
#                 CALL FGL_SET_ARR_CURR(g_detail_d.getLength()+1) 
#                 LET g_insert = 'N' 
#               END IF 
#             
#            BEFORE ROW
#               LET l_ac = ARR_CURR()
#               LET g_master_idx = l_ac
#               DISPLAY l_ac TO FORMONLY.h_index
#               CALL axrp400_fetch()              
#               
#            ON CHANGE sel
#               UPDATE axrp400_tmp 
#                  SET sel = g_detail_d[l_ac].sel 
#                WHERE nmbbdocno = g_detail_d[l_ac].nmbbdocno  
#                  AND nmbbseq = g_detail_d[l_ac].nmbbseq
#                  
#         END INPUT
         

#          INPUT ARRAY g_detail2_d FROM s_detail2.* 
#              ATTRIBUTE(COUNT = g_rec_b1,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
#                        INSERT ROW = FALSE,
#                        DELETE ROW = FALSE,
#                        APPEND ROW = FALSE)
#            BEFORE INPUT
#                LET g_rec_b = g_detail2_d.getLength()
#                CALL cl_set_comp_entry("xrcadocno,xrccseq,xrcc001,xrcasite,xrca003,xrca005,xrcald",FALSE)
#             
#            BEFORE ROW
#               LET l_ac1 = ARR_CURR()
#               LET g_master_idx = l_ac1
#               DISPLAY l_ac TO FORMONLY.h_index
#               CALL axrp400_fetch()              
#               
#            ON CHANGE sel1
#            
#               UPDATE axrp400_tmp 
#                  SET sel1 = g_detail2_d[l_ac1].sel1
#                WHERE xrcadocno = g_detail2_d[l_ac1].xrcadocno  
#                  AND xrccseq = g_detail2_d[l_ac1].xrccseq    
#                  AND xrcc001 = g_detail2_d[l_ac1].xrcc001
#            
#         END INPUT]]>
  </point>
  <point name="ui_dialog.onaction_sel" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
                  UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                   WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                     AND nmbbseq = g_detail_d[li_idx].nmbbseq
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  LET g_detail2_d[li_idx1].sel1 = "Y"
                  UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                   WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                     AND xrccseq = g_detail2_d[li_idx1].xrccseq
                     AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               END IF
            END FOR]]>
  </point>
  <point name="ui_dialog.onaction_selall" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 1)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "Y"
               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR]]>
  </point>
  <point name="ui_dialog.onaction_selnone" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 0)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "N"
               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR]]>
  </point>
  <point name="ui_dialog.onaction_unsel" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
                  UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                   WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                     AND nmbbseq = g_detail_d[li_idx].nmbbseq
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  LET g_detail2_d[li_idx1].sel1 = "N"
                  UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1
                   WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                     AND xrccseq = g_detail2_d[li_idx1].xrccseq
                     AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               END IF
            END FOR]]>
  </point>
  <section id="axrp400.b_fill" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充
PRIVATE FUNCTION axrp400_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   {<point name="b_fill.define" edit="s"/>}
   #end add-point
   #add-point:b_fill段define
   {<point name="b_fill.define_customerization" edit="c"/>}
   #end add-point
 
   #add-point:b_fill段sql_before
   {<point name="b_fill.sql_before"/>}
   #end add-point
 
   PREPARE axrp400_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR axrp400_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   {<point name="b_fill.clear"/>}
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   {<point name="b_fill.foreach_into"/>}
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      {<point name="b_fill.foreach_iside"/>}
      #end add-point
      
      CALL axrp400_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.other_table"/>}
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE axrp400_sel
   
   LET l_ac = 1
   CALL axrp400_fetch()
   #add-point:b_fill段資料填充(其他單身)
   {<point name="b_fill.after_b_fill"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="axrp400.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:1,PR版次:1) Build-000023
#+ 
#+ Filename...: axrp400
#+ Description: 收款沖帳批次產生作業
#+ Creator....: 02291(2015-07-10 13:40:13)
#+ Modifier...: 02291(2015-07-14 16:30:59) -SD/PR-
]]>
  </section>
  <section id="axrp400.detail_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 顯示相關資料
PRIVATE FUNCTION axrp400_detail_show()
   #add-point:show段define
   {<point name="detail_show.define" edit="s"/>}
   #end add-point
   #add-point:show段define
   {<point name="detail_show.define_customerization" edit="c"/>}
   #end add-point
   
   #add-point:detail_show段
   {<point name="detail_show.detail_show"/>}
   #end add-point
 
END FUNCTION
]]>
  </section>
  <section id="axrp400.fetch" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 單身陣列填充2
PRIVATE FUNCTION axrp400_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   {<point name="fetch.define" edit="s"/>}
   #end add-point
   #add-point:fetch段define
   {<point name="fetch.define_customerization" edit="c"/>}
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
   {<point name="fetch.after_fill" />}
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
]]>
  </section>
  <section id="axrp400.filter" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ filter過濾功能
PRIVATE FUNCTION axrp400_filter()
   #add-point:filter段define
   {<point name="filter.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter.define_customerization" edit="c"/>}
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   {<point name="filter.detail_cnt"/>}
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL axrp400_b_fill()
   
END FUNCTION
]]>
  </section>
  <section id="axrp400.filter_parser" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ filter欄位解析
PRIVATE FUNCTION axrp400_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   {<point name="filter_parser.define" edit="s"/>}
   #end add-point    
   #add-point:filter段define
   {<point name="filter_parser.define_customerization" edit="c"/>}
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
]]>
  </section>
  <section id="axrp400.filter_show" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION axrp400_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = axrp400_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
]]>
  </section>
  <section id="axrp400.global" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 p02 樣板自動產生(Version:13)
{<point name="global.memo" />}
 
IMPORT os
IMPORT util
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#{<point name="global.inc" />}
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="axrp400.init" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 畫面資料初始化
PRIVATE FUNCTION axrp400_init()
   #add-point:init段define
   {<point name="init.define" edit="s"/>}
   #end add-point   
   #add-point:init段define
   {<point name="init.define_customerization" edit="c"/>}
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp400.main" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   {<point name="main.define" edit="s"/>}
   #end add-point   
   #add-point:main段define
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("axr","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_axrp400 WITH FORM cl_ap_formpath("axr",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL axrp400_init()   
 
      #進入選單 Menu (="N")
      CALL axrp400_ui_dialog() 
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_axrp400
   END IF 
   
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
  </section>
  <section id="axrp400.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="axrp400.query" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ QBE資料查詢
PRIVATE FUNCTION axrp400_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   {<point name="query.define" edit="s" />}
   #end add-point 
   #add-point:query段define
   {<point name="query.define_customerization" edit="c" />}
   #end add-point 
    
   #add-point:cs段after_construct
   {<point name="query.after_construct" />}
   #end add-point
        
   LET g_error_show = 1
   CALL axrp400_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   {<point name="query.cs段after_query" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp400.ui_dialog" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION axrp400_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define" edit="s"/>}
   #end add-point 
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define_customerization" edit="c"/>}
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL axrp400_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            {<point name="ui_dialog.before_dialog2"/>}
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.selall.befroe"/>}
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               {<point name="ui_dialog.for.onaction_selall"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            {<point name="ui_dialog.onaction_selall"/>}
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               {<point name="ui_dialog.for.onaction_selnone"/>}
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            {<point name="ui_dialog.onaction_selnone"/>}
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            {<point name="ui_dialog.onaction_sel"/>}
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            {<point name="ui_dialog.onaction_unsel"/>}
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL axrp400_filter()
            #add-point:ON ACTION filter
            {<point name="menu.filter" />}
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            {<point name="ui_dialog.before_accept"/>}
            #end add-point
            CALL axrp400_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            {<point name="ui_dialog.datarefresh"/>}
            #end add-point
            CALL axrp400_b_fill()
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
]]>
  </section>
</add_points>
