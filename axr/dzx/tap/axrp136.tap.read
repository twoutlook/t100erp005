<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<add_points prog="axrp136" std_prog="axrp136" erpver="1.0" module="AXR" ver="4" env="s" zone="t10prd" booking="N" type="M" identity="s" section_flag="N" designer_ver="1.0">
  <other>
    <code_template value="P" status=""/>
    <free_style value="N" status=""/>
    <start_arg value="" status=""/>
  </other>
  <point name="function.axrp136_def" order="1" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 給帳務中心、帳套賦默認值
# Memo...........:
# Usage..........: CALL axrp136_def()
#                  RETURNING ---
# Input parameter: ---
# Return code....: ---
# Date & Author..: 2015/04/20 By 01727
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp136_def()
   DEFINE l_sql         STRING
   DEFINE l_xrcasite    LIKE xrca_t.xrcasite
   DEFINE l_xrcacomp    LIKE xrca_t.xrcacomp
   DEFINE l_success     LIKE type_t.chr1
   DEFINE l_cnt         LIKE type_t.num5
   DEFINE l_ooefl003    LIKE ooefl_t.ooefl003

   IF cl_null(g_master.xrcasite) OR cl_null(g_master.xrcald) THEN
      #帳務中心
      #取得預設的帳務中心,因新增階段的時候,並不會知道site,所以以登入人員做為依據
      CALL s_fin_get_account_center('',g_user,'3',g_today) RETURNING l_success,g_master.xrcasite,g_errno
      #該帳務中心與帳別無法勾稽到,以登入人員g_user取得預設帳別/法人
      CALL s_fin_orga_get_comp_ld(g_master.xrcasite) RETURNING l_success,g_errno,l_xrcacomp,g_master.xrcald   

      #若取不出資料,則不預設帳別
      IF NOT l_success THEN
         LET g_master.xrcald   = ''
      END IF

      CALL s_axrt300_xrca_ref('xrcald',g_master.xrcald,'','') RETURNING l_success,g_master.xrcald_desc
      CALL s_axrt300_xrca_ref('xrcasite',g_master.xrcasite,'','') RETURNING l_success,g_master.xrcasite_desc
      DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc,g_master.xrcald,g_master.xrcald_desc
   END IF

   IF cl_null(g_master.xrcadocdt) THEN LET g_master.xrcadocdt = g_today END IF

   IF cl_null(g_master.b_comb)  THEN LET g_master.b_comb = '1' END IF
   IF cl_null(g_master.debz002) THEN LET g_master.debz002 = g_today END IF
   DISPLAY BY NAME g_master.xrcadocdt,g_master.b_comb,g_master.debz002

END FUNCTION]]>
  </point>
  <point name="function.axrp136_get_ooef001_wc" order="2" ver="1" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: sub產生的數據集轉換
# Memo...........: DSCNJ,DSCTP,DSCTC --> ('DSCNJ','DSCTP','DSCTC')
# Usage..........: CALL axrp136_get_ooef001_wc(p_wc)
#                  RETURNING r_wc
# Input parameter: p_wc           sub产生的数据集
# Return code....: r_wc           SQL可用的数据集
# Date & Author..: 2015/04/20 By 01727
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp136_get_ooef001_wc(p_wc)
   DEFINE p_wc       STRING
   DEFINE r_wc       STRING
   DEFINE tok        base.StringTokenizer
   DEFINE l_str      STRING

   LET tok = base.StringTokenizer.create(p_wc,",")
   WHILE tok.hasMoreTokens()
      IF cl_null(l_str) THEN
         LET l_str = tok.nextToken()
      ELSE
         LET l_str = l_str,"','",tok.nextToken()
      END IF      
   END WHILE   
   LET r_wc = "('",l_str,"')"
   
   RETURN r_wc

END FUNCTION]]>
  </point>
  <point name="function.axrp136_get_ar" order="3" ver="4" cite_std="N" new="Y" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[
################################################################################
# Descriptions...: 產生日結單據
# Memo...........:
# Usage..........: CALL axrp136_get_ar()
#                  RETURNING ---
# Input parameter: ---
# Return code....: ---
# Date & Author..: 2015/04/20 By 01727
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp136_get_ar()
   DEFINE l_xrca          type_xrca
   DEFINE l_xrcb          type_xrcb
   DEFINE l_xrde          type_xrde
   DEFINE l_debz          type_debz
   DEFINE l_rtja          type_rtja   #130726-00001#95 Add
   DEFINE l_deaf          type_deaf   #130726-00001#95 Add
   DEFINE l_debz_site     DYNAMIC ARRAY OF RECORD
             debzsite     LIKE debz_t.debzsite
                          END RECORD
   DEFINE l_sql           STRING
   DEFINE l_origin_str    STRING
   DEFINE l_success       LIKE type_t.num5
   DEFINE l_tot_success   LIKE type_t.num5
   DEFINE l_ac            LIKE type_t.num5
   DEFINE l_glaa001       LIKE glaa_t.glaa001
   DEFINE l_glaa003       LIKE glaa_t.glaa003
   DEFINE l_glaa016       LIKE glaa_t.glaa016
   DEFINE l_glaa020       LIKE glaa_t.glaa020
   DEFINE l_glaa024       LIKE glaa_t.glaa024
   DEFINE l_glaacomp      LIKE glaa_t.glaacomp
   DEFINE l_glaa121       LIKE glaa_t.glaa121
   DEFINE l_xrcadocno     LIKE xrca_t.xrcadocno
   DEFINE l_sfin2017      LIKE xrca_t.xrca007
   DEFINE l_dfin0030      LIKE type_t.chr1
   DEFINE l_dfin00301     LIKE type_t.chr1
   DEFINE l_xrca035       LIKE xrca_t.xrca035
   DEFINE l_xrca036       LIKE xrca_t.xrca036
   DEFINE l_imaa003       LIKE imaa_t.imaa003
   DEFINE l_ooeg004       LIKE ooeg_t.ooeg004
   DEFINE l_imaal003      LIKE imaal_t.imaal003
   DEFINE l_imaal004      LIKE imaal_t.imaal004
   DEFINE l_glab005       LIKE glab_t.glab005
   DEFINE l_cnt           LIKE type_t.num5
   DEFINE l_oodbl004      LIKE oodbl_t.oodbl004
   DEFINE l_oodb011       LIKE oodb_t.oodb011
   DEFINE l_pcab002       LIKE pcab_t.pcab002
   DEFINE l_pcab005       LIKE pcab_t.pcab005
   DEFINE l_deag004       LIKE deag_t.deag004
   DEFINE l_rtjf030       LIKE rtjf_t.rtjf030
   DEFINE l_pcab003       LIKE pcab_t.pcab003
   DEFINE l_xrcbseq       LIKE xrcb_t.xrcbseq
   DEFINE l_xrcb019       LIKE xrcb_t.xrcb019
   DEFINE l_xrdeseq       LIKE xrde_t.xrdeseq
   DEFINE l_xrcb021       LIKE xrcb_t.xrcb021
   DEFINE l_glab002       LIKE glab_t.glab002
   DEFINE l_flag          LIKE type_t.chr1
   DEFINE l_ooef108       LIKE ooef_t.ooef108
   DEFINE l_pmab105       LIKE pmab_t.pmab105
   DEFINE l_order         LIKE type_t.chr200      #130726-00001#95 Add
   DEFINE l_pmab084       LIKE pmab_t.pmab084     #130726-00001#95 Add
   DEFINE l_sfin2018      LIKE xrca_t.xrca011     #130726-00001#95 Add
   DEFINE l_start_no_14   LIKE xrca_t.xrcadocno   #130726-00001#95 Add
   DEFINE l_end_no_14     LIKE xrca_t.xrcadocno   #130726-00001#95 Add
   DEFINE l_start_no_141  LIKE xrca_t.xrcadocno   #130726-00001#95 Add
   DEFINE l_end_no_141    LIKE xrca_t.xrcadocno   #130726-00001#95 Add
   #2015/06/11--add--str--
   DEFINE l_ooaa002       LIKE ooaa_t.ooaa002
   DEFINE l_rtax001       LIKE rtax_t.rtax001
   DEFINE l_rtax003       LIKE rtax_t.rtax003
   DEFINE l_rtax004       LIKE rtax_t.rtax004
   
   #品类管理层级aoos010
   CALL cl_get_para(g_enterprise,'','E-CIR-0001') RETURNING l_ooaa002
   #2015/06/11--add--end

   INITIALIZE l_xrca TO NULL
   INITIALIZE l_debz TO NULL

   LET l_flag = 'N'

   #因為通過帳務中心、帳套、統計日期,已經把產生的單據限定了，
   #只會產生一筆axrt350的資料，所以這裡就不再用FOREACH的方式撰寫了
   #根據門店進行拆單

   #STEP1.根據程序畫面上的初始值和debz_t表上的值在應收單單頭檔(xrca_t)產生一筆資料
   #STEP2.將debz_t內符合條件的資料匯入應收單單身檔(xrcb_t)中
   #      限定條件:1.統計日期等于画面上的日期
   #      　　　　 2.營運據點屬於帳套法人的下屬據點
   #STEP3.將deby_t內符合條件的資料匯入應收單收款檔(xrde_t)中
   #      限定條件:1.統計日期等于画面上的日期
   #      　　　　 2.營運據點屬於帳套法人的下屬據點
   #STEP4.取得adet416中的長短款資料,每一筆資料都要往xrcb_t、xrde_t各匯入一筆資料
   #      限定條件:1.單據日期等于画面上的日期
   #      　　　　 2.營運據點屬於帳套法人的下屬據點
   #STEP5.單身金額回寫單頭金額、直接收款金額回寫單頭金額、產生多帳期、產生分錄(帳套+單別都需要產生的情況下)

   IF cl_null(g_master.xrcadocdt) THEN LET g_master.xrcadocdt = g_master.debz002 END IF

   CALL s_fin_account_center_sons_query('3',g_master.xrcasite,g_master.xrcadocdt,'')
   CALL s_fin_account_center_sons_str()RETURNING l_origin_str
   IF cl_null(l_origin_str) THEN LET l_origin_str = g_master.xrcasite END IF
   CALL axrp136_get_ooef001_wc(l_origin_str)RETURNING l_origin_str

   #150417-00007#29 Add  ---(S)---
   LET l_sql = "SELECT rtjadocdt||'@'||rtja002||'@'||rtja025||'@'||rtja026,",
               "       rtja000,rtjasite,rtjadocno,rtja002,rtja025,rtja026,rtja028,rtjf003,rtjf027 ",
               "  FROM rtja_t,rtjf_t",
               " WHERE rtjaent   = rtjfent",
               "   AND rtjadocno = rtjfdocno",
               "   AND rtjadocdt = '",g_master.debz002,"'",
               "   AND rtjaent = '",g_enterprise,"'",
               "   AND rtjasite  = ? ",
               "   AND rtjf001   = '91' ",
               "   AND rtjastus = 'S'",
               "   AND NOT EXISTS (SELECT 1 FROM xrca_t,xrcb_t WHERE xrcaent = xrcbent ",
               "                      AND xrcadocno = xrcbdocno AND xrcald = xrcbld    ",
               "                      AND xrcastus <> 'X' AND xrcb002 = rtjadocno)     ",
               "   AND rtja000 IN ('ammt405','agct405','artt600','artt610')"
   PREPARE axrp136_rtjf_prep FROM l_sql
   DECLARE axrp136_rtjf_curs CURSOR FOR axrp136_rtjf_prep
   #150417-00007#29 Add  ---(E)---

   LET l_sql = "SELECT debzsite,debz001,debz002,debz003,debz004,debz005,debz006,debz007,debz008,",
               "       debz009 ,debz010,debz011,debz012,debz013,debz014,debz015,debz016,debz017,",
               "       debz018",           #150417-00007#60   Add
               "  FROM debz_t ",
               " WHERE debzent = '",g_enterprise,"'",
               "   AND debz002 = '",g_master.debz002,"'",
               "   AND (debz015 IS NULL OR debz015 =0)",
               "   AND debzsite = ?"
   PREPARE axrp136_debz_prep FROM l_sql
   DECLARE axrp136_debz_curs CURSOR FOR axrp136_debz_prep

   LET l_sql = "SELECT deafsite,deafdocno,deafstatu,deafdocdt,         ",
               "       deaf001,deaf002,deaf003,deaf004,deaf005,deaf006,",
               "       deaf007,deaf008,deaf009,deaf010,deaf011,deaf012,",
               "       deaf013,deaf014,deaf015,deaf016,deaf017,deaf018 FROM deaf_t,deag_t ",
               " WHERE deagent = deafent AND deagdocno = deafdocno",
               "   AND deagent = deafent                          ",
               "   AND deagdocdt = '",g_master.debz002,"'",
               "   AND deagent = '",g_enterprise,"'",
               "   AND deaf011 = 'N'",
               "   AND deafsite = ?"
   PREPARE axrp136_deaf_prep FROM l_sql
   DECLARE axrp136_deaf_curs CURSOR FOR axrp136_deaf_prep

   LET l_sql = "SELECT DISTINCT debzsite FROM debz_t ",
               " WHERE debzent = '",g_enterprise,"'",
               "   AND debz002 = '",g_master.debz002,"'",
               "   AND debzent = '",g_enterprise,"'",
               "   AND debz015 IS NULL OR debz015 =0",
               "   AND debzsite IN ",l_origin_str CLIPPED,
               " UNION ",
               "SELECT DISTINCT debysite FROM deby_t ",
               " WHERE debyent = '",g_enterprise,"'",
               "   AND deby003 = '",g_master.debz002,"'",
               "   AND debyent = '",g_enterprise,"'",
               "   AND deby016 IS NULL OR deby016 =0",
               "   AND debysite IN ",l_origin_str CLIPPED,
               " UNION ",
               "SELECT deafsite FROM deaf_t,deag_t ",
               " WHERE deagent = deafent AND deagdocno = deafdocno",
               "   AND deagent = deafent                          ",
               "   AND deagdocdt = '",g_master.debz002,"'",
               "   AND deagent = '",g_enterprise,"'",
               "   AND deaf009 IN ('1','2','4','6','7')",
               "   AND deaf011 = 'N'",
               "   AND deagsite IN ",l_origin_str CLIPPED
   PREPARE axrp136_site_prep FROM l_sql
   DECLARE axrp136_site_curs CURSOR FOR axrp136_site_prep

   SELECT glaa001,glaa003,glaa016,glaa020,glaa024,glaacomp,glaa121
     INTO l_glaa001,l_glaa003,l_glaa016,l_glaa020,l_glaa024,l_glaacomp,l_glaa121
     FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrcald

   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2017') RETURNING l_sfin2017
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-2018') RETURNING l_sfin2018
   CALL s_fin_get_doc_para(g_master.xrcald,l_glaacomp,g_master.xrcadocno,'D-FIN-0030') RETURNING l_dfin0030
   CALL s_fin_get_doc_para(g_master.xrcald,l_glaacomp,g_master.l_xrcadocno,'D-FIN-0030') RETURNING l_dfin00301

   LET l_ac = 1
   FOREACH axrp136_site_curs INTO l_debz_site[l_ac].debzsite
      IF cl_null(l_debz_site[l_ac].debzsite) THEN CONTINUE FOREACH END IF
      LET l_ac = l_ac + 1
   END FOREACH
   CALL l_debz_site.deleteElement(l_ac)
   IF l_debz_site.getLength() < 1 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 'agl-00167'
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN
   END IF

   #2015/06/16 Add
   LET l_sql = "SELECT rtjf030,deag004 FROM",
               "(SELECT DISTINCT rtjf030 FROM rtja_t,rtjf_t",
               " WHERE rtjaent   = rtjfent",
               "   AND rtjadocno = rtjfdocno",
               "   AND rtjaent = '",g_enterprise,"'",
               "   AND rtjadocdt = '",g_master.debz002,"'",
               "   AND rtjasite  = ? ",
               "   AND NOT EXISTS (SELECT 1 FROM xrca_t,xrcb_t WHERE xrcaent = xrcbent ",
               "                      AND xrcadocno = xrcbdocno AND xrcald = xrcbld    ",
               "                      AND xrcastus <> 'X' AND xrcb002 = rtjadocno)     ",
               "   AND rtjastus = 'S'",
               "   AND rtja000 IN ('ammt405','agct405','artt600','artt610')) LEFT JOIN ",
               "(SELECT DISTINCT deag004 FROM deaf_t,deag_t ",
               " WHERE deagent = deafent AND deagdocno = deafdocno",
               "   AND deagent = deafent                          ",
               "   AND deagdocdt = '",g_master.debz002,"'",
               "   AND deagent = '",g_enterprise,"'",
               "   AND deaf011 = 'N'",
               "   AND deagstus = 'Y'",
               "   AND deafsite = ?)",
               " ON rtjf030 = deag004"
   PREPARE axrp136_rtjf030_prep FROM l_sql
   DECLARE axrp136_rtjf030_curs CURSOR FOR axrp136_rtjf030_prep
   #錯誤訊息匯總初始化
   CALL cl_err_collect_init()
   LET l_success = TRUE
   FOR l_ac = 1 TO l_debz_site.getLength()
      FOREACH axrp136_rtjf030_curs USING l_debz_site[l_ac].debzsite,l_debz_site[l_ac].debzsite INTO l_rtjf030,l_deag004
         IF cl_null(l_deag004) THEN
            SELECT pcab003 INTO l_pcab003 FROM pcab_t WHERE pcabent = g_enterprise
               AND pcab001 = l_rtjf030
            LET l_success = FALSE
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_rtjf030
            LET g_errparam.code   = 'axr-00344'
            LET g_errparam.popup  = TRUE
            LET g_errparam.replace[1] = l_pcab003
            CALL cl_err()
         END IF
      END FOREACH

   END FOR
   IF NOT l_success THEN
      CALL cl_err_collect_show()
      RETURN
   END IF
   #2015/06/16 Add

   #錯誤訊息匯總初始化
   CALL cl_err_collect_init()
   LET l_tot_success = TRUE
   CALL s_transaction_begin()

   FOR l_ac = 1 TO l_debz_site.getLength()
      SELECT ooef108 INTO l_ooef108 FROM ooef_t WHERE ooefent = g_enterprise
         AND ooef001 = l_debz_site[l_ac].debzsite
      SELECT pmab105 INTO l_pmab105 FROM pmab_t
       WHERE pmabent = g_enterprise AND pmabsite = l_glaacomp AND pmab001 = l_ooef108

      IF NOT cl_null(l_pmab105) THEN
         LET l_sfin2017 = l_pmab105
      END IF

      SELECT glab005 INTO l_xrca035 FROM glab_t 
       WHERE glabld = g_master.xrcald 
         AND glabent = g_enterprise
         AND glab002 = l_sfin2017       # 帳款類別
         AND glab001 = '13'             # 應收帳務類型科目設定
         AND glab003 = '8304_01'

      SELECT glab005 INTO l_xrca036 FROM glab_t 
       WHERE glabld = g_master.xrcald 
         AND glabent = g_enterprise
         AND glab002 = l_sfin2017       # 帳款類別
         AND glab001 = '13'             # 應收帳務類型科目設定
         AND glab003 = '8304_21'

      CALL s_aooi200_fin_gen_docno(g_master.xrcald,l_glaa024,l_glaa003,g_master.xrcadocno,g_master.xrcadocdt,'axrt350')
         RETURNING l_success,l_xrcadocno
      IF NOT l_success THEN
         LET l_tot_success = l_success
      END IF

     #150417-00007#29 Add  ---(S)---
      IF cl_null(l_start_no_14) THEN LET l_start_no_14 = l_xrcadocno END IF
      LET l_end_no_14 = l_xrcadocno
     #150417-00007#29 Add  ---(E)---

      LET l_xrca.xrcaent = g_enterprise
      LET l_xrca.xrcastus = 'N'
      LET l_xrca.xrcacomp = l_glaacomp
      LET l_xrca.xrcald = g_master.xrcald
      LET l_xrca.xrcadocno = l_xrcadocno
      LET l_xrca.xrcadocdt = g_master.xrcadocdt
      LET l_xrca.xrcasite = g_master.xrcasite
      LET l_xrca.xrca001 = '14'
      LET l_xrca.xrca003 = g_user
      LET l_xrca.xrca004 = l_ooef108
      LET l_xrca.xrca005 = l_ooef108
      LET l_xrca.xrca006 = ''
      LET l_xrca.xrca007 = l_sfin2017
      LET l_xrca.xrca008 = ''
      LET l_xrca.xrca009 = g_master.debz002
      LET l_xrca.xrca010 = g_master.debz002
      LET l_xrca.xrca011 = ''   #由單身第一筆回寫
      LET l_xrca.xrca012 = 0    #由單身第一筆回寫
      LET l_xrca.xrca013 = ''   #由單身第一筆回寫
      LET l_xrca.xrca014 = g_user
      LET l_xrca.xrca015 = g_dept
      LET l_xrca.xrca016 = '13'
      LET l_xrca.xrca017 = '0'
      LET l_xrca.xrca018 = ''
      LET l_xrca.xrca019 = ''
      LET l_xrca.xrca020 = ''
      LET l_xrca.xrca021 = 'N'
      LET l_xrca.xrca022 = ''
      LET l_xrca.xrca023 = ''
      LET l_xrca.xrca024 = ''
      LET l_xrca.xrca025 = ''
      LET l_xrca.xrca026 = ''
      LET l_xrca.xrca028 = ''
      LET l_xrca.xrca029 = 1
      LET l_xrca.xrca030 = 0
      LET l_xrca.xrca031 = 0
      LET l_xrca.xrca032 = 0
      LET l_xrca.xrca033 = ''
      LET l_xrca.xrca034 = ''
      LET l_xrca.xrca035 = l_xrca035
      LET l_xrca.xrca036 = l_xrca036
      LET l_xrca.xrca037 = 'Y'   #需要再看
      LET l_xrca.xrca038 = ''
      LET l_xrca.xrca039 = 0
      LET l_xrca.xrca040 = 'N'
      LET l_xrca.xrca041 = ''
      LET l_xrca.xrca042 = ''
      LET l_xrca.xrca043 = ''
      LET l_xrca.xrca044 = 0
      LET l_xrca.xrca045 = ''
      LET l_xrca.xrca046 = 'N'
      LET l_xrca.xrca047 = ''
      LET l_xrca.xrca048 = ''
      LET l_xrca.xrca049 = ''
      LET l_xrca.xrca050 = 0
      LET l_xrca.xrca051 = ''
      LET l_xrca.xrca052 = 0
      LET l_xrca.xrca053 = ''
      LET l_xrca.xrca054 = ''
      LET l_xrca.xrca055 = ''
      LET l_xrca.xrca056 = ''
      LET l_xrca.xrca057 = ''
      LET l_xrca.xrca058 = ''
      LET l_xrca.xrca059 = ''
      LET l_xrca.xrca060 = ''
      LET l_xrca.xrca061 = ''
      LET l_xrca.xrca062 = ''
      LET l_xrca.xrca063 = ''
      LET l_xrca.xrca064 = 0
      LET l_xrca.xrca065 = ''
      LET l_xrca.xrca066 = ''
      LET l_xrca.xrca100 = l_glaa001
      LET l_xrca.xrca101 = 1
      LET l_xrca.xrca103 = 0
      LET l_xrca.xrca104 = 0
      LET l_xrca.xrca106 = 0
      LET l_xrca.xrca107 = 0
      LET l_xrca.xrca108 = 0
      LET l_xrca.xrca113 = 0
      LET l_xrca.xrca114 = 0
      LET l_xrca.xrca116 = 0
      LET l_xrca.xrca117 = 0
      LET l_xrca.xrca118 = 0
      LET l_xrca.xrca120 = l_glaa016
      LET l_xrca.xrca121 = 0
      LET l_xrca.xrca123 = 0
      LET l_xrca.xrca124 = 0
      LET l_xrca.xrca126 = 0
      LET l_xrca.xrca127 = 0
      LET l_xrca.xrca128 = 0
      LET l_xrca.xrca130 = l_glaa020
      LET l_xrca.xrca131 = 0
      LET l_xrca.xrca133 = 0
      LET l_xrca.xrca134 = 0
      LET l_xrca.xrca136 = 0
      LET l_xrca.xrca137 = 0
      LET l_xrca.xrca138 = 0
      LET l_xrca.xrcaownid = g_user
      LET l_xrca.xrcaowndp = g_dept
      LET l_xrca.xrcacrtid = g_user
      LET l_xrca.xrcacrtdp = g_dept 
      LET l_xrca.xrcacrtdt = cl_get_current()
      LET l_xrca.xrcamodid = g_user
      LET l_xrca.xrcamoddt = cl_get_current()
      LET l_xrca.xrcacnfid = ''
      LET l_xrca.xrcacnfdt = ''
      LET l_xrca.xrcapstid = ''
      LET l_xrca.xrcapstdt = ''

      INSERT INTO xrca_t(xrcaent,xrcastus,xrcacomp,xrcald,xrcadocno,xrcadocdt,xrcasite,
                         xrca001,xrca003,xrca004,xrca005,xrca006,xrca007,
                         xrca008,xrca009,xrca010,xrca011,xrca012,xrca013,
                         xrca014,xrca015,xrca016,xrca017,xrca018,xrca019,
                         xrca020,xrca021,xrca022,xrca023,xrca024,xrca025,
                         xrca026,xrca028,xrca029,xrca030,xrca031,xrca032,
                         xrca033,xrca034,xrca035,xrca036,xrca037,xrca038,
                         xrca039,xrca040,xrca041,xrca042,xrca043,xrca044,
                         xrca045,xrca046,xrca047,xrca048,xrca049,xrca050,
                         xrca051,xrca052,xrca053,xrca054,xrca055,xrca056,
                         xrca057,xrca058,xrca059,xrca060,xrca061,xrca062,
                         xrca063,xrca064,xrca065,xrca066,xrca100,xrca101,
                         xrca103,xrca104,xrca106,xrca107,xrca108,xrca113,
                         xrca114,xrca116,xrca117,xrca118,xrca120,xrca121,
                         xrca123,xrca124,xrca126,xrca127,xrca128,xrca130,
                         xrca131,xrca133,xrca134,xrca136,xrca137,xrca138,
                         xrcaownid,xrcaowndp,xrcacrtid,xrcacrtdp,
                         xrcacrtdt,xrcamodid,xrcamoddt,xrcacnfid,
                         xrcacnfdt,xrcapstid,xrcapstdt)
                  VALUES(l_xrca.xrcaent,l_xrca.xrcastus,l_xrca.xrcacomp,l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcadocdt,l_xrca.xrcasite,
                         l_xrca.xrca001,l_xrca.xrca003,l_xrca.xrca004,l_xrca.xrca005,l_xrca.xrca006,l_xrca.xrca007,
                         l_xrca.xrca008,l_xrca.xrca009,l_xrca.xrca010,l_xrca.xrca011,l_xrca.xrca012,l_xrca.xrca013,
                         l_xrca.xrca014,l_xrca.xrca015,l_xrca.xrca016,l_xrca.xrca017,l_xrca.xrca018,l_xrca.xrca019,
                         l_xrca.xrca020,l_xrca.xrca021,l_xrca.xrca022,l_xrca.xrca023,l_xrca.xrca024,l_xrca.xrca025,
                         l_xrca.xrca026,l_xrca.xrca028,l_xrca.xrca029,l_xrca.xrca030,l_xrca.xrca031,l_xrca.xrca032,
                         l_xrca.xrca033,l_xrca.xrca034,l_xrca.xrca035,l_xrca.xrca036,l_xrca.xrca037,l_xrca.xrca038,
                         l_xrca.xrca039,l_xrca.xrca040,l_xrca.xrca041,l_xrca.xrca042,l_xrca.xrca043,l_xrca.xrca044,
                         l_xrca.xrca045,l_xrca.xrca046,l_xrca.xrca047,l_xrca.xrca048,l_xrca.xrca049,l_xrca.xrca050,
                         l_xrca.xrca051,l_xrca.xrca052,l_xrca.xrca053,l_xrca.xrca054,l_xrca.xrca055,l_xrca.xrca056,
                         l_xrca.xrca057,l_xrca.xrca058,l_xrca.xrca059,l_xrca.xrca060,l_xrca.xrca061,l_xrca.xrca062,
                         l_xrca.xrca063,l_xrca.xrca064,l_xrca.xrca065,l_xrca.xrca066,l_xrca.xrca100,l_xrca.xrca101,
                         l_xrca.xrca103,l_xrca.xrca104,l_xrca.xrca106,l_xrca.xrca107,l_xrca.xrca108,l_xrca.xrca113,
                         l_xrca.xrca114,l_xrca.xrca116,l_xrca.xrca117,l_xrca.xrca118,l_xrca.xrca120,l_xrca.xrca121,
                         l_xrca.xrca123,l_xrca.xrca124,l_xrca.xrca126,l_xrca.xrca127,l_xrca.xrca128,l_xrca.xrca130,
                         l_xrca.xrca131,l_xrca.xrca133,l_xrca.xrca134,l_xrca.xrca136,l_xrca.xrca137,l_xrca.xrca138,
                         l_xrca.xrcaownid,l_xrca.xrcaowndp,l_xrca.xrcacrtid,l_xrca.xrcacrtdp,
                         l_xrca.xrcacrtdt,l_xrca.xrcamodid,l_xrca.xrcamoddt,l_xrca.xrcacnfid,
                         l_xrca.xrcacnfdt,l_xrca.xrcapstid,l_xrca.xrcapstdt)
      IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_xrca.xrcadocno
         LET g_errparam.code   = SQLCA.SQLCODE
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         LET l_tot_success = FALSE
      END IF

      LET l_xrcbseq = 0

      FOREACH axrp136_debz_curs USING l_debz_site[l_ac].debzsite INTO l_debz.*

         INITIALIZE l_xrcb TO NULL

         LET l_imaal003 = NULL
         SELECT rtaxl003 INTO l_imaal003 FROM rtaxl_t
          WHERE rtaxlent = g_enterprise AND rtaxl001 = l_debz.debz007 AND rtaxl002 = g_lang

         LET l_ooeg004 = NULL
         SELECT ooeg004 INTO l_ooeg004 FROM ooeg_t
          WHERE ooegent = g_enterprise AND ooeg001 = l_xrca.xrca015

         SELECT imaal003,imaal004 INTO l_imaal003,l_imaal004 FROM imaal_t
          WHERE imaalent = g_enterprise AND imaal001 = l_debz.debz007 AND imaal002 = g_lang

         LET l_xrcb019 = NULL
         SELECT inaa110 INTO l_xrcb019 FROM inaa_t WHERE inaaent = g_enterprise
            AND inaasite = l_debz.debzsite
            AND inaa001  = l_debz.debz014

         LET l_xrcb.xrcbent   = l_xrca.xrcaent
         LET l_xrcb.xrcbld    = l_xrca.xrcald
         LET l_xrcb.xrcbdocno = l_xrca.xrcadocno
         LET l_xrcb.xrcbseq   = l_xrcbseq + 1
         LET l_xrcb.xrcbsite  = l_xrca.xrcasite
         LET l_xrcb.xrcborga  = l_debz.debzsite
         LET l_xrcb.xrcblegl  = l_xrca.xrcacomp
         LET l_xrcb.xrcb001   = '13'
         LET l_xrcb.xrcb002   = ''
         LET l_xrcb.xrcb003   = ''
         LET l_xrcb.xrcb004   = l_debz.debz007
         LET l_xrcb.xrcb005   = l_imaal003
         LET l_xrcb.xrcb006   = ''
         LET l_xrcb.xrcb007   = 1
         LET l_xrcb.xrcb008   = ''
         LET l_xrcb.xrcb009   = ''
         LET l_xrcb.xrcb010   = l_xrca.xrca015
         LET l_xrcb.xrcb011   = l_ooeg004
         #LET l_xrcb.xrcb012   = l_imaa003 #2015/6/11 mark
         #2015/6/11--add--str--
         #根据系统参数设置aoos010设定的品类管理层数抓取的产品类别
         LET l_rtax001=l_debz.debz007
         WHILE TRUE
            SELECT rtax003,rtax004 INTO l_rtax003,l_rtax004 FROM rtax_t
             WHERE rtaxent=g_enterprise AND rtax001=l_rtax001
            IF l_rtax004 = l_ooaa002 THEN
               LET l_xrcb.xrcb012 = l_rtax001
               EXIT WHILE
            ELSE
               LET l_rtax001 = l_rtax003
            END IF
            IF l_rtax004 < l_ooaa002 THEN
               EXIT WHILE
            END IF
         END WHILE
         #2015/6/11--add--end
         LET l_xrcb.xrcb013   = ''
         LET l_xrcb.xrcb014   = ''
         LET l_xrcb.xrcb015   = ''
         LET l_xrcb.xrcb016   = ''
         LET l_xrcb.xrcb017   = ''
         LET l_xrcb.xrcb018   = l_debz.debz005
         LET l_xrcb.xrcb019   = l_xrcb019
         LET l_xrcb.xrcb020   = l_debz.debz008
        #150417-00007#25 Add  ---(S)---
        #根據品類取得科目
         CALL axrp136_get_glab005(l_xrcb.xrcbld,l_debz.debz018,l_debz.debz007) RETURNING l_xrcb.xrcb021
         IF cl_null(l_xrcb.xrcb021) THEN
            LET l_xrcb.xrcb021   = l_xrca.xrca035
         END IF
        #150417-00007#25 Add  ---(E)---
        #LET l_xrcb.xrcb021   = l_xrca.xrca035   #150417-00007#25 Mark
         LET l_xrcb.xrcb022   = 1
         LET l_xrcb.xrcb023   = 'N'
         LET l_xrcb.xrcb024   = ''
         LET l_xrcb.xrcb025   = ''
         LET l_xrcb.xrcb026   = ''
         LET l_xrcb.xrcb027   = ''   #流通待補欄位
         LET l_xrcb.xrcb028   = ''
         LET l_xrcb.xrcb029   = l_xrca.xrca035
         LET l_xrcb.xrcb030   = ''
         LET l_xrcb.xrcb031   = ''
         LET l_xrcb.xrcb032   = ''
         LET l_xrcb.xrcb033   = ''
         LET l_xrcb.xrcb034   = ''
         LET l_xrcb.xrcb035   = ''
         LET l_xrcb.xrcb036   = ''
         LET l_xrcb.xrcb037   = ''
         LET l_xrcb.xrcb038   = ''
         LET l_xrcb.xrcb039   = ''
         LET l_xrcb.xrcb040   = ''
         LET l_xrcb.xrcb041   = ''
         LET l_xrcb.xrcb042   = ''
         LET l_xrcb.xrcb043   = ''
         LET l_xrcb.xrcb044   = ''
         LET l_xrcb.xrcb045   = ''
         LET l_xrcb.xrcb046   = ''
         LET l_xrcb.xrcb047   = ''
         LET l_xrcb.xrcb048   = ''
         LET l_xrcb.xrcb049   = ''
         LET l_xrcb.xrcb050   = ''
         LET l_xrcb.xrcb051   = l_xrca.xrca014
         LET l_xrcb.xrcb100   = l_xrca.xrca100

         CALL s_tax_chk(l_glaacomp,l_xrcb.xrcb020)
            RETURNING l_success,l_oodbl004,l_xrca.xrca013,l_xrca.xrca012,l_oodb011
         IF l_xrca.xrca013 = 'Y' THEN
            LET l_xrcb.xrcb101   = l_debz.debz012
         ELSE
            LET l_xrcb.xrcb101   = l_debz.debz012 - l_debz.debz009
         END IF

         CALL s_tax_ins(l_xrca.xrcadocno,l_xrcb.xrcbseq,0,l_glaacomp,
                        l_xrcb.xrcb101 * l_xrcb.xrcb007,l_xrcb.xrcb020,
                        l_xrcb.xrcb007,l_xrcb.xrcb100,l_xrca.xrca101,l_xrca.xrcald,l_xrca.xrca121,l_xrca.xrca131)
            RETURNING l_xrcb.xrcb103,l_xrcb.xrcb104,l_xrcb.xrcb105,
                      l_xrcb.xrcb113,l_xrcb.xrcb114,l_xrcb.xrcb115,
                      l_xrcb.xrcb123,l_xrcb.xrcb124,l_xrcb.xrcb125,
                      l_xrcb.xrcb133,l_xrcb.xrcb134,l_xrcb.xrcb135
      
         LET l_xrcb.xrcb102   = l_xrca.xrca101
         LET l_xrcb.xrcb106   = 0
         LET l_xrcb.xrcb111   = l_debz.debz012 - l_debz.debz009
         LET l_xrcb.xrcb116   = 0
         LET l_xrcb.xrcb117   = 0
         LET l_xrcb.xrcb118   = 0
         LET l_xrcb.xrcb119   = 0
         #其他本位幣留下接口，暫不處理
         LET l_xrcb.xrcb121   = 0
         LET l_xrcb.xrcb126   = 0
         LET l_xrcb.xrcb131   = 0
         LET l_xrcb.xrcb136   = 0

         INSERT INTO xrcb_t(xrcbent,xrcbld,xrcbdocno,xrcbseq,xrcbsite,xrcborga,xrcblegl,
                            xrcb001,xrcb002,xrcb003,xrcb004,xrcb005,xrcb006,
                            xrcb007,xrcb008,xrcb009,xrcb010,xrcb011,xrcb012,
                            xrcb013,xrcb014,xrcb015,xrcb016,xrcb017,xrcb018,
                            xrcb019,xrcb020,xrcb021,xrcb022,xrcb023,xrcb024,
                            xrcb025,xrcb026,xrcb027,xrcb028,xrcb029,xrcb030,
                            xrcb031,xrcb032,xrcb033,xrcb034,xrcb035,xrcb036,
                            xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,xrcb042,
                            xrcb043,xrcb044,xrcb045,xrcb046,xrcb047,xrcb048,
                            xrcb049,xrcb050,xrcb051,xrcb100,xrcb101,xrcb102,
                            xrcb103,xrcb104,xrcb105,xrcb106,xrcb111,xrcb113,
                            xrcb114,xrcb115,xrcb116,xrcb117,xrcb118,xrcb119,
                            xrcb121,xrcb123,xrcb124,xrcb125,xrcb126,xrcb131,
                            xrcb133,xrcb134,xrcb135,xrcb136)
                     VALUES(l_xrcb.xrcbent,l_xrcb.xrcbld,l_xrcb.xrcbdocno,l_xrcb.xrcbseq,l_xrcb.xrcbsite,l_xrcb.xrcborga,l_xrcb.xrcblegl,
                            l_xrcb.xrcb001,l_xrcb.xrcb002,l_xrcb.xrcb003,l_xrcb.xrcb004,l_xrcb.xrcb005,l_xrcb.xrcb006,
                            l_xrcb.xrcb007,l_xrcb.xrcb008,l_xrcb.xrcb009,l_xrcb.xrcb010,l_xrcb.xrcb011,l_xrcb.xrcb012,
                            l_xrcb.xrcb013,l_xrcb.xrcb014,l_xrcb.xrcb015,l_xrcb.xrcb016,l_xrcb.xrcb017,l_xrcb.xrcb018,
                            l_xrcb.xrcb019,l_xrcb.xrcb020,l_xrcb.xrcb021,l_xrcb.xrcb022,l_xrcb.xrcb023,l_xrcb.xrcb024,
                            l_xrcb.xrcb025,l_xrcb.xrcb026,l_xrcb.xrcb027,l_xrcb.xrcb028,l_xrcb.xrcb029,l_xrcb.xrcb030,
                            l_xrcb.xrcb031,l_xrcb.xrcb032,l_xrcb.xrcb033,l_xrcb.xrcb034,l_xrcb.xrcb035,l_xrcb.xrcb036,
                            l_xrcb.xrcb037,l_xrcb.xrcb038,l_xrcb.xrcb039,l_xrcb.xrcb040,l_xrcb.xrcb041,l_xrcb.xrcb042,
                            l_xrcb.xrcb043,l_xrcb.xrcb044,l_xrcb.xrcb045,l_xrcb.xrcb046,l_xrcb.xrcb047,l_xrcb.xrcb048,
                            l_xrcb.xrcb049,l_xrcb.xrcb050,l_xrcb.xrcb051,l_xrcb.xrcb100,l_xrcb.xrcb101,l_xrcb.xrcb102,
                            l_xrcb.xrcb103,l_xrcb.xrcb104,l_xrcb.xrcb105,l_xrcb.xrcb106,l_xrcb.xrcb111,l_xrcb.xrcb113,
                            l_xrcb.xrcb114,l_xrcb.xrcb115,l_xrcb.xrcb116,l_xrcb.xrcb117,l_xrcb.xrcb118,l_xrcb.xrcb119,
                            l_xrcb.xrcb121,l_xrcb.xrcb123,l_xrcb.xrcb124,l_xrcb.xrcb125,l_xrcb.xrcb126,l_xrcb.xrcb131,
                            l_xrcb.xrcb133,l_xrcb.xrcb134,l_xrcb.xrcb135,l_xrcb.xrcb136)
         IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_xrca.xrcadocno
            LET g_errparam.code   = SQLCA.SQLCODE
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            LET l_tot_success = FALSE
         ELSE
            LET l_flag = 'Y'
         END IF

         IF l_xrcb.xrcbseq = 1 THEN
            CALL s_tax_chk(l_glaacomp,l_xrcb.xrcb020)
               RETURNING l_success,l_oodbl004,l_xrca.xrca013,l_xrca.xrca012,l_oodb011

            UPDATE xrca_t SET xrca011 = l_xrcb.xrcb020,
                              xrca012 = l_xrca.xrca012,
                              xrca013 = l_xrca.xrca013
             WHERE xrcaent = g_enterprise
               AND xrcadocno = l_xrca.xrcadocno
               AND xrcald    = l_xrca.xrcald
         END IF

         UPDATE debz_t SET debz015 = l_xrcb.xrcb101
          WHERE debzent = g_enterprise
            AND debzsite = l_xrcb.xrcborga
            AND debz005 = l_debz.debz005
            AND debz007 = l_debz.debz007
            AND debz008 = l_debz.debz008

         LET l_xrcbseq = l_xrcbseq + 1

      END FOREACH

      LET l_xrdeseq = 0

      #處理直接收款与長短款
      LET l_xrcbseq = l_xrcb.xrcbseq
      LET l_xrdeseq = l_xrde.xrdeseq

      FOREACH axrp136_deaf_curs USING l_debz_site[l_ac].debzsite INTO l_deaf.*

         #處理直接收款  ---(S)---
         INITIALIZE l_xrde TO NULL

         SELECT glab002,glab007 INTO l_glab002,l_glab005 FROM glab_t WHERE glabent = g_enterprise
            AND glab001 = '21' AND glab003 = l_deaf.deaf005
            AND glabld = l_xrca.xrcald
         IF cl_null(l_glab005) THEN
            SELECT glab002,glab005 INTO l_glab002,l_glab005 FROM glab_t WHERE glabent = g_enterprise
               AND glab001 = '21' AND glab003 = l_deaf.deaf005
               AND glabld = l_xrca.xrcald
         END IF

         LET l_xrde.xrdeent  = l_xrca.xrcaent
         LET l_xrde.xrdecomp = l_xrca.xrcacomp
         LET l_xrde.xrdeld   = l_xrca.xrcald
         LET l_xrde.xrdedocno= l_xrca.xrcadocno
         LET l_xrde.xrdeseq  = l_xrdeseq + 1
         LET l_xrde.xrdesite = l_xrca.xrcasite
         LET l_xrde.xrdeorga = l_deaf.deafsite
         LET l_xrde.xrde001  = 'axrt350'
         LET l_xrde.xrde002  = '10'
         LET l_xrde.xrde003  = ''
         LET l_xrde.xrde004  = ''
         LET l_xrde.xrde006  = l_glab002
         LET l_xrde.xrde007  = l_deaf.deaf005
         LET l_xrde.xrde008  = ''
         LET l_xrde.xrde010  = ''
         LET l_xrde.xrde011  = ''
         LET l_xrde.xrde012  = ''
         LET l_xrde.xrde013  = ''
         LET l_xrde.xrde014  = ''
         LET l_xrde.xrde015  = 'D'
         LET l_xrde.xrde016  = l_glab005
         LET l_xrde.xrde017  = l_xrca.xrca014
         LET l_xrde.xrde018  = ''
         LET l_xrde.xrde019  = ''
         LET l_xrde.xrde020  = ''
         LET l_xrde.xrde022  = ''
         LET l_xrde.xrde023  = ''
         LET l_xrde.xrde028  = '0'
         LET l_xrde.xrde029  = ''
         LET l_xrde.xrde030  = ''
         LET l_xrde.xrde035  = ''
         LET l_xrde.xrde036  = ''
         LET l_xrde.xrde038  = ''
         LET l_xrde.xrde039  = ''
         LET l_xrde.xrde040  = ''
         LET l_xrde.xrde041  = ''
         LET l_xrde.xrde042  = ''
         LET l_xrde.xrde043  = ''
         LET l_xrde.xrde044  = ''
         LET l_xrde.xrde045  = ''
         LET l_xrde.xrde046  = ''
         LET l_xrde.xrde047  = ''
         LET l_xrde.xrde048  = ''
         LET l_xrde.xrde049  = ''
         LET l_xrde.xrde050  = ''
         LET l_xrde.xrde051  = ''
         LET l_xrde.xrde100  = l_xrca.xrca100
         LET l_xrde.xrde101  = 1
         LET l_xrde.xrde109  = l_deaf.deaf006
         LET l_xrde.xrde119  = l_deaf.deaf006
         #其他本位幣留出接口暫不處理
         LET l_xrde.xrde120  = ''
         LET l_xrde.xrde121  = 0
         LET l_xrde.xrde129  = 0
         LET l_xrde.xrde130  = ''
         LET l_xrde.xrde131  = 0
         LET l_xrde.xrde139  = 0

         INSERT INTO xrde_t(xrdeent,xrdecomp,xrdeld,xrdedocno,xrdeseq,xrdesite,xrdeorga,
                            xrde001,xrde002,xrde003,xrde004,xrde006,xrde007,xrde008,
                            xrde010,xrde011,xrde012,xrde013,xrde014,xrde015,
                            xrde016,xrde017,xrde018,xrde019,xrde020,xrde022,
                            xrde023,xrde028,xrde029,xrde030,xrde035,xrde036,
                            xrde038,xrde039,xrde040,xrde041,xrde042,xrde043,
                            xrde044,xrde045,xrde046,xrde047,xrde048,xrde049,
                            xrde050,xrde051,xrde100,xrde101,xrde109,xrde119,
                            xrde120,xrde121,xrde129,xrde130,xrde131,xrde139)
                     VALUES(l_xrde.xrdeent,l_xrde.xrdecomp,l_xrde.xrdeld,l_xrde.xrdedocno,l_xrde.xrdeseq,l_xrde.xrdesite,l_xrde.xrdeorga,
                            l_xrde.xrde001,l_xrde.xrde002,l_xrde.xrde003,l_xrde.xrde004,l_xrde.xrde006,l_xrde.xrde007,l_xrde.xrde008,
                            l_xrde.xrde010,l_xrde.xrde011,l_xrde.xrde012,l_xrde.xrde013,l_xrde.xrde014,l_xrde.xrde015,
                            l_xrde.xrde016,l_xrde.xrde017,l_xrde.xrde018,l_xrde.xrde019,l_xrde.xrde020,l_xrde.xrde022,
                            l_xrde.xrde023,l_xrde.xrde028,l_xrde.xrde029,l_xrde.xrde030,l_xrde.xrde035,l_xrde.xrde036,
                            l_xrde.xrde038,l_xrde.xrde039,l_xrde.xrde040,l_xrde.xrde041,l_xrde.xrde042,l_xrde.xrde043,
                            l_xrde.xrde044,l_xrde.xrde045,l_xrde.xrde046,l_xrde.xrde047,l_xrde.xrde048,l_xrde.xrde049,
                            l_xrde.xrde050,l_xrde.xrde051,l_xrde.xrde100,l_xrde.xrde101,l_xrde.xrde109,l_xrde.xrde119,
                            l_xrde.xrde120,l_xrde.xrde121,l_xrde.xrde129,l_xrde.xrde130,l_xrde.xrde131,l_xrde.xrde139)

         IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_xrca.xrcadocno
            LET g_errparam.code   = SQLCA.SQLCODE
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            LET l_tot_success = FALSE
         ELSE
            LET l_flag = 'Y'
         END IF

         LET l_xrdeseq = l_xrdeseq + 1
         #處理直接收款  ---(E)---


         IF l_deaf.deaf009 = '1' OR l_deaf.deaf009 = '7' THEN
            LET l_deaf.deaf008 = l_deaf.deaf008 * -1
         END IF

         SELECT pcab002,pcab005 INTO l_pcab002,l_pcab005 FROM pcab_t WHERE pcabent = g_enterprise AND pcab001 = l_deag004

         #處理長短款  ---(S)---
         IF l_deaf.deaf009 = '1' OR l_deaf.deaf009 = '2' OR l_deaf.deaf009 = '6' OR l_deaf.deaf009 = '7' THEN
            SELECT glab005 INTO l_xrcb021 FROM glab_t 
             WHERE glabld = g_master.xrcald
               AND glabent = g_enterprise
               AND glab001 = '13'             # 應收帳務類型科目設定
               AND glab002 = '6736'
               AND glab003 = l_deaf.deaf009

            INITIALIZE l_xrcb TO NULL

            LET l_xrcb.xrcbent   = l_xrca.xrcaent
            LET l_xrcb.xrcbld    = l_xrca.xrcald
            LET l_xrcb.xrcbdocno = l_xrca.xrcadocno
            LET l_xrcb.xrcbseq   = l_xrcbseq + 1
            LET l_xrcb.xrcbsite  = l_xrca.xrcasite
            LET l_xrcb.xrcborga  = l_xrca.xrcasite
            LET l_xrcb.xrcblegl  = l_xrca.xrcacomp
           #2015/06/29 Mod  ---(S)---
           #全部放到其他加项
           #1.营业员赔款算其他应收款
           #2.营业员多收营业外收入
           #LET l_xrcb.xrcb001   = '19'
           #LET l_xrcb.xrcb022   = 1
            IF l_deaf.deaf009 = '1' OR l_deaf.deaf009 = '7' THEN
               LET l_xrcb.xrcb001   = '29'
               LET l_xrcb.xrcb022   = -1
            ELSE
               LET l_xrcb.xrcb001   = '19'
               LET l_xrcb.xrcb022   = 1
            END IF
           #2015/06/29 Mod  ---(E)---
            LET l_xrcb.xrcb002   = ''
            LET l_xrcb.xrcb003   = ''
            LET l_xrcb.xrcb004   = ''
            LET l_xrcb.xrcb005   = ''
            LET l_xrcb.xrcb006   = ''
            LET l_xrcb.xrcb007   = 1
            LET l_xrcb.xrcb008   = l_deaf.deafdocno
            LET l_xrcb.xrcb009   = ''
            LET l_xrcb.xrcb010   = l_pcab005
            LET l_xrcb.xrcb011   = l_ooeg004
            LET l_xrcb.xrcb012   = ''
            LET l_xrcb.xrcb013   = ''
            LET l_xrcb.xrcb014   = ''
            LET l_xrcb.xrcb015   = ''
            LET l_xrcb.xrcb016   = ''
            LET l_xrcb.xrcb017   = ''
            LET l_xrcb.xrcb018   = ''
            LET l_xrcb.xrcb019   = ''
            LET l_xrcb.xrcb020   = ''
           #150417-00007#25 Add  ---(S)---
           #根據品類取得科目
            SELECT glab005 INTO l_xrcb.xrcb021 FROM glab_t WHERE glabent = g_enterprise
               AND glabld  = l_xrcb.xrcbld
               AND glab001 = '13'
               AND glab002 = '6736'
               AND glab003 = l_deaf.deaf009
            IF cl_null(l_xrcb.xrcb021) THEN
               LET l_xrcb.xrcb021   = l_xrcb021
            END IF
           #150417-00007#25 Add  ---(E)---
           #LET l_xrcb.xrcb021   = l_xrcb021
            LET l_xrcb.xrcb023   = 'N'
            LET l_xrcb.xrcb024   = ''
            LET l_xrcb.xrcb025   = ''
            LET l_xrcb.xrcb026   = ''
            LET l_xrcb.xrcb027   = ''   #流通待補欄位
            LET l_xrcb.xrcb028   = ''
            LET l_xrcb.xrcb029   = l_xrca.xrca035
            LET l_xrcb.xrcb030   = ''
            LET l_xrcb.xrcb031   = ''
            LET l_xrcb.xrcb032   = ''
            LET l_xrcb.xrcb033   = ''
            LET l_xrcb.xrcb034   = ''
            LET l_xrcb.xrcb035   = ''
            LET l_xrcb.xrcb036   = ''
            LET l_xrcb.xrcb037   = ''
            LET l_xrcb.xrcb038   = ''
            LET l_xrcb.xrcb039   = ''
            LET l_xrcb.xrcb040   = ''
            LET l_xrcb.xrcb041   = ''
            LET l_xrcb.xrcb042   = ''
            LET l_xrcb.xrcb043   = ''
            LET l_xrcb.xrcb044   = ''
            LET l_xrcb.xrcb045   = ''
            LET l_xrcb.xrcb046   = ''
            LET l_xrcb.xrcb047   = ''
            LET l_xrcb.xrcb048   = ''
            LET l_xrcb.xrcb049   = ''
            LET l_xrcb.xrcb050   = ''
            LET l_xrcb.xrcb051   = l_pcab002
            LET l_xrcb.xrcb100   = l_xrca.xrca100
            LET l_xrcb.xrcb101   = l_deaf.deaf008
            LET l_xrcb.xrcb102   = l_xrca.xrca101
            LET l_xrcb.xrcb103   = l_deaf.deaf008
            LET l_xrcb.xrcb104   = 0
            LET l_xrcb.xrcb105   = l_deaf.deaf008
            LET l_xrcb.xrcb106   = 0
            LET l_xrcb.xrcb111   = l_deaf.deaf008
            LET l_xrcb.xrcb113   = l_deaf.deaf008
            LET l_xrcb.xrcb114   = 0
            LET l_xrcb.xrcb115   = l_deaf.deaf008
            LET l_xrcb.xrcb116   = 0
            LET l_xrcb.xrcb117   = 0
            LET l_xrcb.xrcb118   = 0
            LET l_xrcb.xrcb119   = 0
            LET l_xrcb.xrcb123   = l_deaf.deaf008
            LET l_xrcb.xrcb124   = 0
            LET l_xrcb.xrcb125   = l_deaf.deaf008
            LET l_xrcb.xrcb133   = l_deaf.deaf008
            LET l_xrcb.xrcb134   = 0
            LET l_xrcb.xrcb135   = l_deaf.deaf008
            #其他本位幣留下接口，暫不處理
            LET l_xrcb.xrcb121   = 0
            LET l_xrcb.xrcb126   = 0
            LET l_xrcb.xrcb131   = 0
            LET l_xrcb.xrcb136   = 0

            INSERT INTO xrcb_t(xrcbent,xrcbld,xrcbdocno,xrcbseq,xrcbsite,xrcborga,xrcblegl,
                               xrcb001,xrcb002,xrcb003,xrcb004,xrcb005,xrcb006,
                               xrcb007,xrcb008,xrcb009,xrcb010,xrcb011,xrcb012,
                               xrcb013,xrcb014,xrcb015,xrcb016,xrcb017,xrcb018,
                               xrcb019,xrcb020,xrcb021,xrcb022,xrcb023,xrcb024,
                               xrcb025,xrcb026,xrcb027,xrcb028,xrcb029,xrcb030,
                               xrcb031,xrcb032,xrcb033,xrcb034,xrcb035,xrcb036,
                               xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,xrcb042,
                               xrcb043,xrcb044,xrcb045,xrcb046,xrcb047,xrcb048,
                               xrcb049,xrcb050,xrcb051,xrcb100,xrcb101,xrcb102,
                               xrcb103,xrcb104,xrcb105,xrcb106,xrcb111,xrcb113,
                               xrcb114,xrcb115,xrcb116,xrcb117,xrcb118,xrcb119,
                               xrcb121,xrcb123,xrcb124,xrcb125,xrcb126,xrcb131,
                               xrcb133,xrcb134,xrcb135,xrcb136)
                        VALUES(l_xrcb.xrcbent,l_xrcb.xrcbld,l_xrcb.xrcbdocno,l_xrcb.xrcbseq,l_xrcb.xrcbsite,l_xrcb.xrcborga,l_xrcb.xrcblegl,
                               l_xrcb.xrcb001,l_xrcb.xrcb002,l_xrcb.xrcb003,l_xrcb.xrcb004,l_xrcb.xrcb005,l_xrcb.xrcb006,
                               l_xrcb.xrcb007,l_xrcb.xrcb008,l_xrcb.xrcb009,l_xrcb.xrcb010,l_xrcb.xrcb011,l_xrcb.xrcb012,
                               l_xrcb.xrcb013,l_xrcb.xrcb014,l_xrcb.xrcb015,l_xrcb.xrcb016,l_xrcb.xrcb017,l_xrcb.xrcb018,
                               l_xrcb.xrcb019,l_xrcb.xrcb020,l_xrcb.xrcb021,l_xrcb.xrcb022,l_xrcb.xrcb023,l_xrcb.xrcb024,
                               l_xrcb.xrcb025,l_xrcb.xrcb026,l_xrcb.xrcb027,l_xrcb.xrcb028,l_xrcb.xrcb029,l_xrcb.xrcb030,
                               l_xrcb.xrcb031,l_xrcb.xrcb032,l_xrcb.xrcb033,l_xrcb.xrcb034,l_xrcb.xrcb035,l_xrcb.xrcb036,
                               l_xrcb.xrcb037,l_xrcb.xrcb038,l_xrcb.xrcb039,l_xrcb.xrcb040,l_xrcb.xrcb041,l_xrcb.xrcb042,
                               l_xrcb.xrcb043,l_xrcb.xrcb044,l_xrcb.xrcb045,l_xrcb.xrcb046,l_xrcb.xrcb047,l_xrcb.xrcb048,
                               l_xrcb.xrcb049,l_xrcb.xrcb050,l_xrcb.xrcb051,l_xrcb.xrcb100,l_xrcb.xrcb101,l_xrcb.xrcb102,
                               l_xrcb.xrcb103,l_xrcb.xrcb104,l_xrcb.xrcb105,l_xrcb.xrcb106,l_xrcb.xrcb111,l_xrcb.xrcb113,
                               l_xrcb.xrcb114,l_xrcb.xrcb115,l_xrcb.xrcb116,l_xrcb.xrcb117,l_xrcb.xrcb118,l_xrcb.xrcb119,
                               l_xrcb.xrcb121,l_xrcb.xrcb123,l_xrcb.xrcb124,l_xrcb.xrcb125,l_xrcb.xrcb126,l_xrcb.xrcb131,
                               l_xrcb.xrcb133,l_xrcb.xrcb134,l_xrcb.xrcb135,l_xrcb.xrcb136)

            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = l_xrca.xrcadocno
               LET g_errparam.code   = SQLCA.SQLCODE
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               LET l_tot_success = FALSE
            END IF
            LET l_xrcbseq = l_xrcbseq + 1

         END IF
         #處理長短款  ---(E)---
         
         #處理串幣  ---(S)---
         IF l_deaf.deaf015 <> 0 THEN
            LET l_xrde.xrdeent  = l_xrca.xrcaent
            LET l_xrde.xrdecomp = l_xrca.xrcacomp
            LET l_xrde.xrdeld   = l_xrca.xrcald
            LET l_xrde.xrdedocno= l_xrca.xrcadocno
            LET l_xrde.xrdeseq  = l_xrdeseq + 1
            LET l_xrde.xrdesite = l_xrca.xrcasite
            LET l_xrde.xrdeorga = l_xrca.xrcasite
            LET l_xrde.xrde001  = 'axrt350'
            LET l_xrde.xrde002  = '10'
            LET l_xrde.xrde003  = ''
            LET l_xrde.xrde004  = ''
            LET l_xrde.xrde006  = l_glab002
            LET l_xrde.xrde007  = l_deaf.deaf005
            LET l_xrde.xrde008  = ''
            LET l_xrde.xrde010  = ''
            LET l_xrde.xrde011  = ''
            LET l_xrde.xrde012  = ''
            LET l_xrde.xrde013  = ''
            LET l_xrde.xrde014  = ''
            IF l_deaf.deaf015 > 0 THEN
               LET l_deaf.deaf008 = l_deaf.deaf015
               LET l_xrde.xrde015  = 'C'
            ELSE
               LET l_deaf.deaf008 = l_deaf.deaf015 * -1
               LET l_xrde.xrde015  = 'D'
            END IF
            LET l_xrde.xrde016  = l_glab005
            LET l_xrde.xrde017  = l_xrca.xrca014
            LET l_xrde.xrde018  = ''
            LET l_xrde.xrde019  = ''
            LET l_xrde.xrde020  = ''
            LET l_xrde.xrde022  = ''
            LET l_xrde.xrde023  = ''
            LET l_xrde.xrde028  = '0'
            LET l_xrde.xrde029  = ''
            LET l_xrde.xrde030  = ''
            LET l_xrde.xrde035  = ''
            LET l_xrde.xrde036  = ''
            LET l_xrde.xrde038  = ''
            LET l_xrde.xrde039  = ''
            LET l_xrde.xrde040  = ''
            LET l_xrde.xrde041  = ''
            LET l_xrde.xrde042  = ''
            LET l_xrde.xrde043  = ''
            LET l_xrde.xrde044  = ''
            LET l_xrde.xrde045  = ''
            LET l_xrde.xrde046  = ''
            LET l_xrde.xrde047  = ''
            LET l_xrde.xrde048  = ''
            LET l_xrde.xrde049  = ''
            LET l_xrde.xrde050  = ''
            LET l_xrde.xrde051  = ''
            LET l_xrde.xrde100  = l_xrca.xrca100
            LET l_xrde.xrde101  = 1
            LET l_xrde.xrde109  = l_deaf.deaf008
            LET l_xrde.xrde119  = l_deaf.deaf008
            #其他本位幣留出接口暫不處理
            LET l_xrde.xrde120  = ''
            LET l_xrde.xrde121  = 0
            LET l_xrde.xrde129  = 0
            LET l_xrde.xrde130  = ''
            LET l_xrde.xrde131  = 0
            LET l_xrde.xrde139  = 0

            INSERT INTO xrde_t(xrdeent,xrdecomp,xrdeld,xrdedocno,xrdeseq,xrdesite,xrdeorga,
                               xrde001,xrde002,xrde003,xrde004,xrde006,xrde007,xrde008,
                               xrde010,xrde011,xrde012,xrde013,xrde014,xrde015,
                               xrde016,xrde017,xrde018,xrde019,xrde020,xrde022,
                               xrde023,xrde028,xrde029,xrde030,xrde035,xrde036,
                               xrde038,xrde039,xrde040,xrde041,xrde042,xrde043,
                               xrde044,xrde045,xrde046,xrde047,xrde048,xrde049,
                               xrde050,xrde051,xrde100,xrde101,xrde109,xrde119,
                               xrde120,xrde121,xrde129,xrde130,xrde131,xrde139)
                        VALUES(l_xrde.xrdeent,l_xrde.xrdecomp,l_xrde.xrdeld,l_xrde.xrdedocno,l_xrde.xrdeseq,l_xrde.xrdesite,l_xrde.xrdeorga,
                               l_xrde.xrde001,l_xrde.xrde002,l_xrde.xrde003,l_xrde.xrde004,l_xrde.xrde006,l_xrde.xrde007,l_xrde.xrde008,
                               l_xrde.xrde010,l_xrde.xrde011,l_xrde.xrde012,l_xrde.xrde013,l_xrde.xrde014,l_xrde.xrde015,
                               l_xrde.xrde016,l_xrde.xrde017,l_xrde.xrde018,l_xrde.xrde019,l_xrde.xrde020,l_xrde.xrde022,
                               l_xrde.xrde023,l_xrde.xrde028,l_xrde.xrde029,l_xrde.xrde030,l_xrde.xrde035,l_xrde.xrde036,
                               l_xrde.xrde038,l_xrde.xrde039,l_xrde.xrde040,l_xrde.xrde041,l_xrde.xrde042,l_xrde.xrde043,
                               l_xrde.xrde044,l_xrde.xrde045,l_xrde.xrde046,l_xrde.xrde047,l_xrde.xrde048,l_xrde.xrde049,
                               l_xrde.xrde050,l_xrde.xrde051,l_xrde.xrde100,l_xrde.xrde101,l_xrde.xrde109,l_xrde.xrde119,
                               l_xrde.xrde120,l_xrde.xrde121,l_xrde.xrde129,l_xrde.xrde130,l_xrde.xrde131,l_xrde.xrde139)

            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = l_xrca.xrcadocno
               LET g_errparam.code   = SQLCA.SQLCODE
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               LET l_tot_success = FALSE
            END IF
            LET l_xrdeseq = l_xrdeseq + 1
         END IF
         #處理串幣  ---(E)---

         UPDATE deaf_t SET deaf011 = 'Y'
          WHERE deafent = g_enterprise
            AND deafdocno = l_deaf.deafdocno
            AND deaf005 = l_deaf.deaf005

      END FOREACH

      SELECT ABS(SUM(xrcb103 * xrcb022)),ABS(SUM(xrcb104 * xrcb022)),ABS(SUM(xrcb113 * xrcb022)),ABS(SUM(xrcb114 * xrcb022)),
             ABS(SUM(xrcb123 * xrcb022)),ABS(SUM(xrcb124 * xrcb022)),ABS(SUM(xrcb133 * xrcb022)),ABS(SUM(xrcb134 * xrcb022))  
        INTO l_xrca.xrca103,l_xrca.xrca104,l_xrca.xrca113,l_xrca.xrca114, 
             l_xrca.xrca123,l_xrca.xrca124,l_xrca.xrca133,l_xrca.xrca134     
        FROM xrcb_t
       WHERE xrcbent = g_enterprise AND xrcbld = l_xrca.xrcald AND xrcbdocno = l_xrca.xrcadocno
         AND xrcb001 NOT IN ('19','29')
      IF cl_null(l_xrca.xrca103) THEN LET l_xrca.xrca103 = 0 END IF 
      IF cl_null(l_xrca.xrca104) THEN LET l_xrca.xrca104 = 0 END IF 
      IF cl_null(l_xrca.xrca113) THEN LET l_xrca.xrca113 = 0 END IF 
      IF cl_null(l_xrca.xrca114) THEN LET l_xrca.xrca114 = 0 END IF
      IF cl_null(l_xrca.xrca123) THEN LET l_xrca.xrca123 = 0 END IF 
      IF cl_null(l_xrca.xrca124) THEN LET l_xrca.xrca124 = 0 END IF
      IF cl_null(l_xrca.xrca133) THEN LET l_xrca.xrca133 = 0 END IF 
      IF cl_null(l_xrca.xrca134) THEN LET l_xrca.xrca134 = 0 END IF

      LET l_xrca.xrca107 = 0
      LET l_xrca.xrca117 = 0
      SELECT SUM(xrde109 * CASE WHEN xrde015 = 'D' THEN 1 ELSE -1 END),
             SUM(xrde119 * CASE WHEN xrde015 = 'D' THEN 1 ELSE -1 END)
        INTO l_xrca.xrca107,l_xrca.xrca117
        FROM xrde_t
       WHERE xrdeent = g_enterprise   AND xrdedocno = l_xrca.xrcadocno
         AND xrdeld  = l_xrca.xrcald

      UPDATE xrca_t SET (xrca103,xrca104,xrca107,
                         xrca113,xrca114,xrca117,
                         xrca123,xrca124,xrca133,xrca134)
                      = (l_xrca.xrca103,l_xrca.xrca104,l_xrca.xrca107,
                         l_xrca.xrca113,l_xrca.xrca114,l_xrca.xrca117,
                         l_xrca.xrca123,l_xrca.xrca124,l_xrca.xrca133,l_xrca.xrca134) 
       WHERE xrcaent = g_enterprise AND xrcald = l_xrca.xrcald AND xrcadocno = l_xrca.xrcadocno
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_xrca.xrcadocno
         LET g_errparam.code   = SQLCA.SQLCODE
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         LET l_tot_success = FALSE
      END IF
      #2015/06/29 Mod  ---(S)---
     #CALL s_axrt300_installments(l_xrca.xrcald,l_xrca.xrcadocno) RETURNING l_success 
     #IF NOT l_success THEN
     #   LET l_tot_success = l_success
     #END IF
      UPDATE xrca_t SET xrca108 = xrca103 + xrca104,
                        xrca118 = xrca113 + xrca114
       WHERE xrcaent = g_enterprise AND xrcald = l_xrca.xrcald AND xrcadocno = l_xrca.xrcadocno
      #2015/06/29 Mod  ---(S)---

      IF l_glaa121 = 'Y' AND l_dfin0030 = 'Y' THEN
         CALL s_pre_voucher_ins('AR','R10',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcadocdt,'1') RETURNING l_success
         IF NOT l_success THEN
         LET l_tot_success = l_success
         END IF
      END IF

      IF l_flag = 'N' THEN
         LET l_tot_success = FALSE
      END IF

     #130726-00001#95 Add  ---(S)---
      INITIALIZE l_xrca TO NULL
      OPEN axrp136_rtjf_curs USING l_debz_site[l_ac].debzsite
      FOREACH axrp136_rtjf_curs INTO l_rtja.*
         IF cl_null(l_order) OR (NOT cl_null(l_order) AND l_order <> l_rtja.orders) THEN
            #非第一筆FOREACH資料,需要更新上一筆資料單頭金額
            IF NOT cl_null(l_order) THEN
               SELECT ABS(SUM(xrcb103 * xrcb022)),ABS(SUM(xrcb104 * xrcb022)),
                      ABS(SUM(xrcb113 * xrcb022)),ABS(SUM(xrcb114 * xrcb022)),
                      ABS(SUM(xrcb123 * xrcb022)),ABS(SUM(xrcb124 * xrcb022)),
                      ABS(SUM(xrcb133 * xrcb022)),ABS(SUM(xrcb134 * xrcb022))  
                 INTO l_xrca.xrca103,l_xrca.xrca104,
                      l_xrca.xrca113,l_xrca.xrca114, 
                      l_xrca.xrca123,l_xrca.xrca124,
                      l_xrca.xrca133,l_xrca.xrca134     
                 FROM xrcb_t
                WHERE xrcbent = g_enterprise AND xrcbld = l_xrca.xrcald AND xrcbdocno = l_xrca.xrcadocno
                  AND xrcb001 NOT IN ('19','29')
               IF cl_null(l_xrca.xrca103) THEN LET l_xrca.xrca103 = 0 END IF 
               IF cl_null(l_xrca.xrca104) THEN LET l_xrca.xrca104 = 0 END IF 
               IF cl_null(l_xrca.xrca113) THEN LET l_xrca.xrca113 = 0 END IF 
               IF cl_null(l_xrca.xrca114) THEN LET l_xrca.xrca114 = 0 END IF
               IF cl_null(l_xrca.xrca123) THEN LET l_xrca.xrca123 = 0 END IF 
               IF cl_null(l_xrca.xrca124) THEN LET l_xrca.xrca124 = 0 END IF
               IF cl_null(l_xrca.xrca133) THEN LET l_xrca.xrca133 = 0 END IF 
               IF cl_null(l_xrca.xrca134) THEN LET l_xrca.xrca134 = 0 END IF

               LET l_xrca.xrca107 = 0
               LET l_xrca.xrca117 = 0
               SELECT SUM(xrde109 * CASE WHEN xrde015 = 'D' THEN 1 ELSE -1 END),
                      SUM(xrde119 * CASE WHEN xrde015 = 'D' THEN 1 ELSE -1 END)
                 INTO l_xrca.xrca107,l_xrca.xrca117
                 FROM xrde_t
                WHERE xrdeent = g_enterprise   AND xrdedocno = l_xrca.xrcadocno
                  AND xrdeld  = l_xrca.xrcald
              
               UPDATE xrca_t SET (xrca103,xrca104,xrca107,
                                  xrca113,xrca114,xrca117,
                                  xrca123,xrca124,xrca133,xrca134)
                               = (l_xrca.xrca103,l_xrca.xrca104,l_xrca.xrca107,
                                  l_xrca.xrca113,l_xrca.xrca114,l_xrca.xrca117,
                                  l_xrca.xrca123,l_xrca.xrca124,l_xrca.xrca133,l_xrca.xrca134) 
                WHERE xrcaent = g_enterprise AND xrcald = l_xrca.xrcald AND xrcadocno = l_xrca.xrcadocno
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_xrca.xrcadocno
                  LET g_errparam.code   = SQLCA.SQLCODE
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
                  LET l_tot_success = FALSE
               END IF
               #2015/06/29 Mod  ---(S)---
              #CALL s_axrt300_installments(l_xrca.xrcald,l_xrca.xrcadocno) RETURNING l_success 
              #IF NOT l_success THEN
              #   LET l_tot_success = l_success
              #END IF
               UPDATE xrca_t SET xrca108 = xrca103 + xrca104,
                                 xrca118 = xrca113 + xrca114
                WHERE xrcaent = g_enterprise AND xrcald = l_xrca.xrcald AND xrcadocno = l_xrca.xrcadocno
               #2015/06/29 Mod  ---(S)---

               IF l_glaa121 = 'Y' AND l_dfin0030 = 'Y' THEN
                  CALL s_pre_voucher_ins('AR','R10',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcadocdt,'1') RETURNING l_success
                  IF NOT l_success THEN
                  LET l_tot_success = l_success
                  END IF
               END IF
            END IF

            #符合拆單原則進行拆單
            INITIALIZE l_xrca TO NULL

            CALL s_aooi200_fin_gen_docno(g_master.xrcald,l_glaa024,l_glaa003,g_master.l_xrcadocno,g_master.xrcadocdt,'axrt370')
               RETURNING l_success,l_xrcadocno
            IF NOT l_success THEN
               LET l_tot_success = l_success
            END IF
            SELECT pmab105 INTO l_pmab105 FROM pmab_t
             WHERE pmabent = g_enterprise AND pmabsite = l_glaacomp AND pmab001 = l_rtja.rtja002

            SELECT glab005 INTO l_xrca035 FROM glab_t 
             WHERE glabld = g_master.xrcald 
               AND glabent = g_enterprise
               AND glab002 = l_sfin2017       # 帳款類別
               AND glab001 = '13'             # 應收帳務類型科目設定
               AND glab003 = '8304_01'

            SELECT glab005 INTO l_xrca036 FROM glab_t 
             WHERE glabld = g_master.xrcald 
               AND glabent = g_enterprise
               AND glab002 = l_sfin2017       # 帳款類別
               AND glab001 = '13'             # 應收帳務類型科目設定
               AND glab003 = '8304_21'

            SELECT pmab084 INTO l_pmab084
              FROM pmab_t    
             WHERE pmabent = g_enterprise AND pmabsite = l_glaacomp AND pmab001 = l_rtja.rtja002

            LET l_xrca.xrcaent = g_enterprise
            LET l_xrca.xrcastus = 'N'
            LET l_xrca.xrcacomp = l_glaacomp
            LET l_xrca.xrcald = g_master.xrcald
            LET l_xrca.xrcadocno = l_xrcadocno
            LET l_xrca.xrcadocdt = g_master.xrcadocdt
            LET l_xrca.xrcasite = g_master.xrcasite
            LET l_xrca.xrca001 = '141'
            LET l_xrca.xrca003 = g_user
            LET l_xrca.xrca004 = l_rtja.rtja002
            LET l_xrca.xrca005 = l_rtja.rtja002
            LET l_xrca.xrca006 = ''
            LET l_xrca.xrca007 = l_pmab105
            LET l_xrca.xrca008 = l_rtja.rtja025
            LET l_xrca.xrca009 = g_master.debz002
            LET l_xrca.xrca010 = g_master.debz002
            LET l_xrca.xrca011 = l_sfin2018
            CALL s_tax_chk(l_glaacomp,l_xrca.xrca011)
               RETURNING l_success,l_oodbl004,l_xrca.xrca013,l_xrca.xrca012,l_oodb011
            LET l_xrca.xrca014 = g_user
            LET l_xrca.xrca015 = g_dept
            LET l_xrca.xrca016 = '13'            #20150601
            LET l_xrca.xrca017 = '0'
            LET l_xrca.xrca018 = ''
            LET l_xrca.xrca019 = ''
            LET l_xrca.xrca020 = 'N'
            LET l_xrca.xrca021 = 'N'
            LET l_xrca.xrca022 = ''
            LET l_xrca.xrca023 = ''
            LET l_xrca.xrca024 = ''
            LET l_xrca.xrca025 = ''
            LET l_xrca.xrca026 = ''
            LET l_xrca.xrca028 = ''
            LET l_xrca.xrca029 = 1
            LET l_xrca.xrca030 = 0
            LET l_xrca.xrca031 = 0
            LET l_xrca.xrca032 = 0
            LET l_xrca.xrca033 = ''
            LET l_xrca.xrca034 = ''
            LET l_xrca.xrca035 = l_xrca035
            LET l_xrca.xrca036 = l_xrca036
            LET l_xrca.xrca037 = 'Y'   #需要再看
            LET l_xrca.xrca038 = ''
            LET l_xrca.xrca039 = 0
            LET l_xrca.xrca040 = 'N'
            LET l_xrca.xrca041 = ''
            LET l_xrca.xrca042 = ''
            LET l_xrca.xrca043 = ''
            LET l_xrca.xrca044 = 0
            LET l_xrca.xrca045 = ''
            LET l_xrca.xrca046 = 'N'
            LET l_xrca.xrca047 = ''
            LET l_xrca.xrca048 = ''
            LET l_xrca.xrca049 = ''
            LET l_xrca.xrca050 = 0
            LET l_xrca.xrca051 = ''
            LET l_xrca.xrca052 = 0
            LET l_xrca.xrca053 = ''
            LET l_xrca.xrca054 = ''
            LET l_xrca.xrca055 = ''
            LET l_xrca.xrca056 = ''
            LET l_xrca.xrca057 = ''
            LET l_xrca.xrca058 = ''
            LET l_xrca.xrca059 = ''
            LET l_xrca.xrca060 = ''
            LET l_xrca.xrca061 = ''
            LET l_xrca.xrca062 = ''
            LET l_xrca.xrca063 = ''
            LET l_xrca.xrca064 = 0
            LET l_xrca.xrca065 = ''
            LET l_xrca.xrca066 = ''
            LET l_xrca.xrca100 = l_rtja.rtja026
            LET l_xrca.xrca101 = 1
            LET l_xrca.xrca103 = 0
            LET l_xrca.xrca104 = 0
            LET l_xrca.xrca106 = 0
            LET l_xrca.xrca107 = 0
            LET l_xrca.xrca108 = 0
            LET l_xrca.xrca113 = 0
            LET l_xrca.xrca114 = 0
            LET l_xrca.xrca116 = 0
            LET l_xrca.xrca117 = 0
            LET l_xrca.xrca118 = 0
            LET l_xrca.xrca120 = l_glaa016
            LET l_xrca.xrca121 = 0
            LET l_xrca.xrca123 = 0
            LET l_xrca.xrca124 = 0
            LET l_xrca.xrca126 = 0
            LET l_xrca.xrca127 = 0
            LET l_xrca.xrca128 = 0
            LET l_xrca.xrca130 = l_glaa020
            LET l_xrca.xrca131 = 0
            LET l_xrca.xrca133 = 0
            LET l_xrca.xrca134 = 0
            LET l_xrca.xrca136 = 0
            LET l_xrca.xrca137 = 0
            LET l_xrca.xrca138 = 0
            LET l_xrca.xrcaownid = g_user
            LET l_xrca.xrcaowndp = g_dept
            LET l_xrca.xrcacrtid = g_user
            LET l_xrca.xrcacrtdp = g_dept 
            LET l_xrca.xrcacrtdt = cl_get_current()
            LET l_xrca.xrcamodid = g_user
            LET l_xrca.xrcamoddt = cl_get_current()
            LET l_xrca.xrcacnfid = ''
            LET l_xrca.xrcacnfdt = ''
            LET l_xrca.xrcapstid = ''
            LET l_xrca.xrcapstdt = ''

            INSERT INTO xrca_t(xrcaent,xrcastus,xrcacomp,xrcald,xrcadocno,xrcadocdt,xrcasite,
                               xrca001,xrca003,xrca004,xrca005,xrca006,xrca007,
                               xrca008,xrca009,xrca010,xrca011,xrca012,xrca013,
                               xrca014,xrca015,xrca016,xrca017,xrca018,xrca019,
                               xrca020,xrca021,xrca022,xrca023,xrca024,xrca025,
                               xrca026,xrca028,xrca029,xrca030,xrca031,xrca032,
                               xrca033,xrca034,xrca035,xrca036,xrca037,xrca038,
                               xrca039,xrca040,xrca041,xrca042,xrca043,xrca044,
                               xrca045,xrca046,xrca047,xrca048,xrca049,xrca050,
                               xrca051,xrca052,xrca053,xrca054,xrca055,xrca056,
                               xrca057,xrca058,xrca059,xrca060,xrca061,xrca062,
                               xrca063,xrca064,xrca065,xrca066,xrca100,xrca101,
                               xrca103,xrca104,xrca106,xrca107,xrca108,xrca113,
                               xrca114,xrca116,xrca117,xrca118,xrca120,xrca121,
                               xrca123,xrca124,xrca126,xrca127,xrca128,xrca130,
                               xrca131,xrca133,xrca134,xrca136,xrca137,xrca138,
                               xrcaownid,xrcaowndp,xrcacrtid,xrcacrtdp,
                               xrcacrtdt,xrcamodid,xrcamoddt,xrcacnfid,
                               xrcacnfdt,xrcapstid,xrcapstdt)
                        VALUES(l_xrca.xrcaent,l_xrca.xrcastus,l_xrca.xrcacomp,l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcadocdt,l_xrca.xrcasite,
                               l_xrca.xrca001,l_xrca.xrca003,l_xrca.xrca004,l_xrca.xrca005,l_xrca.xrca006,l_xrca.xrca007,
                               l_xrca.xrca008,l_xrca.xrca009,l_xrca.xrca010,l_xrca.xrca011,l_xrca.xrca012,l_xrca.xrca013,
                               l_xrca.xrca014,l_xrca.xrca015,l_xrca.xrca016,l_xrca.xrca017,l_xrca.xrca018,l_xrca.xrca019,
                               l_xrca.xrca020,l_xrca.xrca021,l_xrca.xrca022,l_xrca.xrca023,l_xrca.xrca024,l_xrca.xrca025,
                               l_xrca.xrca026,l_xrca.xrca028,l_xrca.xrca029,l_xrca.xrca030,l_xrca.xrca031,l_xrca.xrca032,
                               l_xrca.xrca033,l_xrca.xrca034,l_xrca.xrca035,l_xrca.xrca036,l_xrca.xrca037,l_xrca.xrca038,
                               l_xrca.xrca039,l_xrca.xrca040,l_xrca.xrca041,l_xrca.xrca042,l_xrca.xrca043,l_xrca.xrca044,
                               l_xrca.xrca045,l_xrca.xrca046,l_xrca.xrca047,l_xrca.xrca048,l_xrca.xrca049,l_xrca.xrca050,
                               l_xrca.xrca051,l_xrca.xrca052,l_xrca.xrca053,l_xrca.xrca054,l_xrca.xrca055,l_xrca.xrca056,
                               l_xrca.xrca057,l_xrca.xrca058,l_xrca.xrca059,l_xrca.xrca060,l_xrca.xrca061,l_xrca.xrca062,
                               l_xrca.xrca063,l_xrca.xrca064,l_xrca.xrca065,l_xrca.xrca066,l_xrca.xrca100,l_xrca.xrca101,
                               l_xrca.xrca103,l_xrca.xrca104,l_xrca.xrca106,l_xrca.xrca107,l_xrca.xrca108,l_xrca.xrca113,
                               l_xrca.xrca114,l_xrca.xrca116,l_xrca.xrca117,l_xrca.xrca118,l_xrca.xrca120,l_xrca.xrca121,
                               l_xrca.xrca123,l_xrca.xrca124,l_xrca.xrca126,l_xrca.xrca127,l_xrca.xrca128,l_xrca.xrca130,
                               l_xrca.xrca131,l_xrca.xrca133,l_xrca.xrca134,l_xrca.xrca136,l_xrca.xrca137,l_xrca.xrca138,
                               l_xrca.xrcaownid,l_xrca.xrcaowndp,l_xrca.xrcacrtid,l_xrca.xrcacrtdp,
                               l_xrca.xrcacrtdt,l_xrca.xrcamodid,l_xrca.xrcamoddt,l_xrca.xrcacnfid,
                               l_xrca.xrcacnfdt,l_xrca.xrcapstid,l_xrca.xrcapstdt)
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = l_xrca.xrcadocno
               LET g_errparam.code   = SQLCA.SQLCODE
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               LET l_tot_success = FALSE
            END IF

            LET l_xrcbseq = 0
         END IF
         LET l_order = l_rtja.orders

         IF cl_null(l_start_no_141) THEN LET l_start_no_141 = l_xrcadocno END IF
         LET l_end_no_141 = l_xrcadocno

         INITIALIZE l_xrcb TO NULL

         LET l_ooeg004 = NULL
         SELECT ooeg004 INTO l_ooeg004 FROM ooeg_t
          WHERE ooegent = g_enterprise AND ooeg001 = l_xrca.xrca015

         LET l_xrcb.xrcbent   = l_xrca.xrcaent
         LET l_xrcb.xrcbld    = l_xrca.xrcald
         LET l_xrcb.xrcbdocno = l_xrca.xrcadocno
         LET l_xrcb.xrcbseq   = l_xrcbseq + 1
         LET l_xrcb.xrcbsite  = l_xrca.xrcasite
         LET l_xrcb.xrcborga  = l_rtja.rtjasite
         LET l_xrcb.xrcblegl  = l_xrca.xrcacomp
         LET l_xrcb.xrcb001   = '13'      #20150601
         LET l_xrcb.xrcb002   = l_rtja.rtjadocno
         LET l_xrcb.xrcb003   = ''
         LET l_xrcb.xrcb004   = ''
         LET l_xrcb.xrcb005   = ''
         LET l_xrcb.xrcb006   = ''
         LET l_xrcb.xrcb007   = 1
         LET l_xrcb.xrcb008   = ''
         LET l_xrcb.xrcb009   = ''
         LET l_xrcb.xrcb010   = l_xrca.xrca015
         LET l_xrcb.xrcb011   = l_ooeg004
         LET l_xrcb.xrcb012   = ''
         LET l_xrcb.xrcb013   = ''
         LET l_xrcb.xrcb014   = ''
         LET l_xrcb.xrcb015   = ''
         LET l_xrcb.xrcb016   = ''
         LET l_xrcb.xrcb017   = ''
         LET l_xrcb.xrcb018   = l_rtja.rtjf027
         LET l_xrcb.xrcb019   = ''
         LET l_xrcb.xrcb020   = l_sfin2018
         LET l_xrcb.xrcb021   = l_xrca.xrca035
         LET l_xrcb.xrcb022   = 1
         LET l_xrcb.xrcb023   = 'N'
         LET l_xrcb.xrcb024   = ''
         LET l_xrcb.xrcb025   = ''
         LET l_xrcb.xrcb026   = ''
         LET l_xrcb.xrcb027   = ''   #流通待補欄位
         LET l_xrcb.xrcb028   = ''
         LET l_xrcb.xrcb029   = l_xrca.xrca035
         LET l_xrcb.xrcb030   = ''
         LET l_xrcb.xrcb031   = ''
         LET l_xrcb.xrcb032   = ''
         LET l_xrcb.xrcb033   = ''
         LET l_xrcb.xrcb034   = ''
         LET l_xrcb.xrcb035   = ''
         LET l_xrcb.xrcb036   = ''
         LET l_xrcb.xrcb037   = ''
         LET l_xrcb.xrcb038   = ''
         LET l_xrcb.xrcb039   = ''
         LET l_xrcb.xrcb040   = ''
         LET l_xrcb.xrcb041   = ''
         LET l_xrcb.xrcb042   = ''
         LET l_xrcb.xrcb043   = ''
         LET l_xrcb.xrcb044   = ''
         LET l_xrcb.xrcb045   = ''
         LET l_xrcb.xrcb046   = ''
         LET l_xrcb.xrcb047   = ''
         LET l_xrcb.xrcb048   = ''
         LET l_xrcb.xrcb049   = ''
         LET l_xrcb.xrcb050   = ''
         LET l_xrcb.xrcb051   = l_xrca.xrca014
         LET l_xrcb.xrcb100   = l_xrca.xrca100

         LET l_xrcb.xrcb101   = l_rtja.rtjf003

         CALL s_tax_ins(l_xrca.xrcadocno,l_xrcb.xrcbseq,0,l_glaacomp,
                        l_xrcb.xrcb101 * l_xrcb.xrcb007,l_xrcb.xrcb020,
                        l_xrcb.xrcb007,l_xrcb.xrcb100,l_xrca.xrca101,l_xrca.xrcald,l_xrca.xrca121,l_xrca.xrca131)
            RETURNING l_xrcb.xrcb103,l_xrcb.xrcb104,l_xrcb.xrcb105,
                      l_xrcb.xrcb113,l_xrcb.xrcb114,l_xrcb.xrcb115,
                      l_xrcb.xrcb123,l_xrcb.xrcb124,l_xrcb.xrcb125,
                      l_xrcb.xrcb133,l_xrcb.xrcb134,l_xrcb.xrcb135
      
         LET l_xrcb.xrcb102   = l_xrca.xrca101
         LET l_xrcb.xrcb106   = 0
         LET l_xrcb.xrcb111   = l_xrcb.xrcb101 * l_xrca.xrca101
         LET l_xrcb.xrcb116   = 0
         LET l_xrcb.xrcb117   = 0
         LET l_xrcb.xrcb118   = 0
         LET l_xrcb.xrcb119   = 0
         #其他本位幣留下接口，暫不處理
         LET l_xrcb.xrcb121   = 0
         LET l_xrcb.xrcb126   = 0
         LET l_xrcb.xrcb131   = 0
         LET l_xrcb.xrcb136   = 0

         INSERT INTO xrcb_t(xrcbent,xrcbld,xrcbdocno,xrcbseq,xrcbsite,xrcborga,xrcblegl,
                            xrcb001,xrcb002,xrcb003,xrcb004,xrcb005,xrcb006,
                            xrcb007,xrcb008,xrcb009,xrcb010,xrcb011,xrcb012,
                            xrcb013,xrcb014,xrcb015,xrcb016,xrcb017,xrcb018,
                            xrcb019,xrcb020,xrcb021,xrcb022,xrcb023,xrcb024,
                            xrcb025,xrcb026,xrcb027,xrcb028,xrcb029,xrcb030,
                            xrcb031,xrcb032,xrcb033,xrcb034,xrcb035,xrcb036,
                            xrcb037,xrcb038,xrcb039,xrcb040,xrcb041,xrcb042,
                            xrcb043,xrcb044,xrcb045,xrcb046,xrcb047,xrcb048,
                            xrcb049,xrcb050,xrcb051,xrcb100,xrcb101,xrcb102,
                            xrcb103,xrcb104,xrcb105,xrcb106,xrcb111,xrcb113,
                            xrcb114,xrcb115,xrcb116,xrcb117,xrcb118,xrcb119,
                            xrcb121,xrcb123,xrcb124,xrcb125,xrcb126,xrcb131,
                            xrcb133,xrcb134,xrcb135,xrcb136)
                     VALUES(l_xrcb.xrcbent,l_xrcb.xrcbld,l_xrcb.xrcbdocno,l_xrcb.xrcbseq,l_xrcb.xrcbsite,l_xrcb.xrcborga,l_xrcb.xrcblegl,
                            l_xrcb.xrcb001,l_xrcb.xrcb002,l_xrcb.xrcb003,l_xrcb.xrcb004,l_xrcb.xrcb005,l_xrcb.xrcb006,
                            l_xrcb.xrcb007,l_xrcb.xrcb008,l_xrcb.xrcb009,l_xrcb.xrcb010,l_xrcb.xrcb011,l_xrcb.xrcb012,
                            l_xrcb.xrcb013,l_xrcb.xrcb014,l_xrcb.xrcb015,l_xrcb.xrcb016,l_xrcb.xrcb017,l_xrcb.xrcb018,
                            l_xrcb.xrcb019,l_xrcb.xrcb020,l_xrcb.xrcb021,l_xrcb.xrcb022,l_xrcb.xrcb023,l_xrcb.xrcb024,
                            l_xrcb.xrcb025,l_xrcb.xrcb026,l_xrcb.xrcb027,l_xrcb.xrcb028,l_xrcb.xrcb029,l_xrcb.xrcb030,
                            l_xrcb.xrcb031,l_xrcb.xrcb032,l_xrcb.xrcb033,l_xrcb.xrcb034,l_xrcb.xrcb035,l_xrcb.xrcb036,
                            l_xrcb.xrcb037,l_xrcb.xrcb038,l_xrcb.xrcb039,l_xrcb.xrcb040,l_xrcb.xrcb041,l_xrcb.xrcb042,
                            l_xrcb.xrcb043,l_xrcb.xrcb044,l_xrcb.xrcb045,l_xrcb.xrcb046,l_xrcb.xrcb047,l_xrcb.xrcb048,
                            l_xrcb.xrcb049,l_xrcb.xrcb050,l_xrcb.xrcb051,l_xrcb.xrcb100,l_xrcb.xrcb101,l_xrcb.xrcb102,
                            l_xrcb.xrcb103,l_xrcb.xrcb104,l_xrcb.xrcb105,l_xrcb.xrcb106,l_xrcb.xrcb111,l_xrcb.xrcb113,
                            l_xrcb.xrcb114,l_xrcb.xrcb115,l_xrcb.xrcb116,l_xrcb.xrcb117,l_xrcb.xrcb118,l_xrcb.xrcb119,
                            l_xrcb.xrcb121,l_xrcb.xrcb123,l_xrcb.xrcb124,l_xrcb.xrcb125,l_xrcb.xrcb126,l_xrcb.xrcb131,
                            l_xrcb.xrcb133,l_xrcb.xrcb134,l_xrcb.xrcb135,l_xrcb.xrcb136)
         IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] <> 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_xrca.xrcadocno
            LET g_errparam.code   = SQLCA.SQLCODE
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            LET l_tot_success = FALSE
         END IF
         LET l_xrcbseq = l_xrcbseq + 1

      END FOREACH
      IF NOT cl_null(l_xrca.xrcadocno) THEN
         SELECT ABS(SUM(xrcb103 * xrcb022)),ABS(SUM(xrcb104 * xrcb022)),
                ABS(SUM(xrcb113 * xrcb022)),ABS(SUM(xrcb114 * xrcb022)),
                ABS(SUM(xrcb123 * xrcb022)),ABS(SUM(xrcb124 * xrcb022)),
                ABS(SUM(xrcb133 * xrcb022)),ABS(SUM(xrcb134 * xrcb022))  
           INTO l_xrca.xrca103,l_xrca.xrca104,
                l_xrca.xrca113,l_xrca.xrca114, 
                l_xrca.xrca123,l_xrca.xrca124,
                l_xrca.xrca133,l_xrca.xrca134     
           FROM xrcb_t
          WHERE xrcbent = g_enterprise AND xrcbld = l_xrca.xrcald AND xrcbdocno = l_xrca.xrcadocno
            AND xrcb001 NOT IN ('19','29')
         IF cl_null(l_xrca.xrca103) THEN LET l_xrca.xrca103 = 0 END IF 
         IF cl_null(l_xrca.xrca104) THEN LET l_xrca.xrca104 = 0 END IF 
         IF cl_null(l_xrca.xrca113) THEN LET l_xrca.xrca113 = 0 END IF 
         IF cl_null(l_xrca.xrca114) THEN LET l_xrca.xrca114 = 0 END IF
         IF cl_null(l_xrca.xrca123) THEN LET l_xrca.xrca123 = 0 END IF 
         IF cl_null(l_xrca.xrca124) THEN LET l_xrca.xrca124 = 0 END IF
         IF cl_null(l_xrca.xrca133) THEN LET l_xrca.xrca133 = 0 END IF 
         IF cl_null(l_xrca.xrca134) THEN LET l_xrca.xrca134 = 0 END IF

         LET l_xrca.xrca107 = 0
         LET l_xrca.xrca117 = 0
         SELECT SUM(xrde109 * CASE WHEN xrde015 = 'D' THEN 1 ELSE -1 END),
                SUM(xrde119 * CASE WHEN xrde015 = 'D' THEN 1 ELSE -1 END)
           INTO l_xrca.xrca107,l_xrca.xrca117
           FROM xrde_t
          WHERE xrdeent = g_enterprise   AND xrdedocno = l_xrca.xrcadocno
            AND xrdeld  = l_xrca.xrcald

         UPDATE xrca_t SET (xrca103,xrca104,xrca107,
                            xrca113,xrca114,xrca117,
                            xrca123,xrca124,xrca133,xrca134)
                         = (l_xrca.xrca103,l_xrca.xrca104,l_xrca.xrca107,
                            l_xrca.xrca113,l_xrca.xrca114,l_xrca.xrca117,
                            l_xrca.xrca123,l_xrca.xrca124,l_xrca.xrca133,l_xrca.xrca134) 
          WHERE xrcaent = g_enterprise AND xrcald = l_xrca.xrcald AND xrcadocno = l_xrca.xrcadocno
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_xrca.xrcadocno
            LET g_errparam.code   = SQLCA.SQLCODE
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            LET l_tot_success = FALSE
         END IF
         #2015/06/29 Mod  ---(S)---
        #CALL s_axrt300_installments(l_xrca.xrcald,l_xrca.xrcadocno) RETURNING l_success 
        #IF NOT l_success THEN
        #   LET l_tot_success = l_success
        #END IF
         UPDATE xrca_t SET xrca108 = xrca103 + xrca104,
                           xrca118 = xrca113 + xrca114
          WHERE xrcaent = g_enterprise AND xrcald = l_xrca.xrcald AND xrcadocno = l_xrca.xrcadocno
         #2015/06/29 Mod  ---(S)---

         IF l_glaa121 = 'Y' AND l_dfin00301 = 'Y' THEN
            CALL s_pre_voucher_ins('AR','R10',l_xrca.xrcald,l_xrca.xrcadocno,l_xrca.xrcadocdt,'1') RETURNING l_success
            IF NOT l_success THEN
            LET l_tot_success = l_success
            END IF
         END IF
      END IF
     #130726-00001#95 Add  ---(E)---

   END FOR

   IF l_tot_success THEN
      CALL s_transaction_end('Y','0')
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axr-00341'
      LET g_errparam.replace[1] = l_start_no_14      #l_xrca.xrcadocno #130726-00001#95 Mark
      LET g_errparam.replace[2] = l_end_no_14        #l_xrca.xrcadocno #130726-00001#95 Mark
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
     #130726-00001#95 Add  ---(S)---
      IF NOT cl_null(l_start_no_141) THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'axr-00342'
         LET g_errparam.replace[1] = l_start_no_141
         LET g_errparam.replace[2] = l_end_no_141
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
     #130726-00001#95 Add  ---(E)---
   ELSE
      CALL s_transaction_end('N','0')
   END IF
   CALL cl_err_collect_show()

END FUNCTION]]>
  </point>
  <point name="function.axrp136_get_glab005" order="4" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 取得品類對應科目
# Memo...........:
# Usage..........: CALL axrp136_get_glab005(p_glabld,p_glab002,p_glab003)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp136_get_glab005(p_glabld,p_glab002,p_glab003)
   DEFINE p_glabld         LIKE glab_t.glabld
   DEFINE p_glab002        LIKE glab_t.glab002
   DEFINE p_glab003        LIKE glab_t.glab003
   DEFINE r_glab005        LIKE glab_t.glab005
   DEFINE l_ooaa002        LIKE ooaa_t.ooaa002
   
   #品类管理层级aoos010
   CALL cl_get_para(g_enterprise,'','E-CIR-0001') RETURNING l_ooaa002

   CALL axrp136_get_rtax001(p_glab003,l_ooaa002) RETURNING p_glab003

   #根據品類取得科目
    SELECT glab005 INTO r_glab005 FROM glab_t WHERE glabent = g_enterprise
       AND glabld  = p_glabld
       AND glab001 = 'RTAX'
       AND glab002 = p_glab002
       AND glab003 = p_glab003

   RETURN r_glab005

END FUNCTION]]>
  </point>
  <point name="function.axrp136_get_rtax001" order="5" ver="3" cite_std="N" new="Y" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp136_get_rtax001(p_rtax001,p_rtax004)
   DEFINE p_rtax001         LIKE rtax_t.rtax001
   DEFINE p_rtax004         LIKE rtax_t.rtax004
   DEFINE r_rtax001         LIKE rtax_t.rtax001
   DEFINE l_rtax003         LIKE rtax_t.rtax003
   DEFINE l_rtax004         LIKE rtax_t.rtax004

   SELECT rtax001,rtax003,rtax004 INTO r_rtax001,l_rtax003,l_rtax004 FROM rtax_t WHERE rtaxent = g_enterprise
      AND rtax001 = p_rtax001

   IF l_rtax004 <> p_rtax004 THEN
      CALL axrp136_get_rtax001(l_rtax003,p_rtax004) RETURNING r_rtax001
   END IF

   RETURN r_rtax001

END FUNCTION]]>
  </point>
  <point name="global.memo" order="" ver="3" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[#150417-00007#29 2015/06/01 BY 01727 增加賒銷作業
#150417-00007#60 2015/06/11 By 01727 產生axrt350 axrt370部分,根據經營方式+品類取得收入科目,若取不到再走之前邏輯
#150417-00007#69 2015/06/16 By 01727 axri201差异处理的SCC加入4，免赔贷方，axrp136差异处理的逻辑段的免赔的借贷方以axri201的科目直接写入]]>
  </point>
  <point name="global.variable" order="" ver="4" cite_std="N" new="N" status="u" src="s" readonly="" mark_hard="N">
    <![CDATA[ TYPE type_xrca RECORD
         xrcaent        LIKE xrca_t.xrcaent,
         xrcastus       LIKE xrca_t.xrcastus,
         xrcacomp       LIKE xrca_t.xrcacomp,
         xrcald         LIKE xrca_t.xrcald,
         xrcadocno      LIKE xrca_t.xrcadocno,
         xrcadocdt      LIKE xrca_t.xrcadocdt,
         xrcasite       LIKE xrca_t.xrcasite,
         xrca001        LIKE xrca_t.xrca001,
         xrca003        LIKE xrca_t.xrca003,
         xrca004        LIKE xrca_t.xrca004,
         xrca005        LIKE xrca_t.xrca005,
         xrca006        LIKE xrca_t.xrca006,
         xrca007        LIKE xrca_t.xrca007,
         xrca008        LIKE xrca_t.xrca008,
         xrca009        LIKE xrca_t.xrca009,
         xrca010        LIKE xrca_t.xrca010,
         xrca011        LIKE xrca_t.xrca011,
         xrca012        LIKE xrca_t.xrca012,
         xrca013        LIKE xrca_t.xrca013,
         xrca014        LIKE xrca_t.xrca014,
         xrca015        LIKE xrca_t.xrca015,
         xrca016        LIKE xrca_t.xrca016,
         xrca017        LIKE xrca_t.xrca017,
         xrca018        LIKE xrca_t.xrca018,
         xrca019        LIKE xrca_t.xrca019,
         xrca020        LIKE xrca_t.xrca020,
         xrca021        LIKE xrca_t.xrca021,
         xrca022        LIKE xrca_t.xrca022,
         xrca023        LIKE xrca_t.xrca023,
         xrca024        LIKE xrca_t.xrca024,
         xrca025        LIKE xrca_t.xrca025,
         xrca026        LIKE xrca_t.xrca026,
         xrca028        LIKE xrca_t.xrca028,
         xrca029        LIKE xrca_t.xrca029,
         xrca030        LIKE xrca_t.xrca030,
         xrca031        LIKE xrca_t.xrca031,
         xrca032        LIKE xrca_t.xrca032,
         xrca033        LIKE xrca_t.xrca033,
         xrca034        LIKE xrca_t.xrca034,
         xrca035        LIKE xrca_t.xrca035,
         xrca036        LIKE xrca_t.xrca036,
         xrca037        LIKE xrca_t.xrca037,
         xrca038        LIKE xrca_t.xrca038,
         xrca039        LIKE xrca_t.xrca039,
         xrca040        LIKE xrca_t.xrca040,
         xrca041        LIKE xrca_t.xrca041,
         xrca042        LIKE xrca_t.xrca042,
         xrca043        LIKE xrca_t.xrca043,
         xrca044        LIKE xrca_t.xrca044,
         xrca045        LIKE xrca_t.xrca045,
         xrca046        LIKE xrca_t.xrca046,
         xrca047        LIKE xrca_t.xrca047,
         xrca048        LIKE xrca_t.xrca048,
         xrca049        LIKE xrca_t.xrca049,
         xrca050        LIKE xrca_t.xrca050,
         xrca051        LIKE xrca_t.xrca051,
         xrca052        LIKE xrca_t.xrca052,
         xrca053        LIKE xrca_t.xrca053,
         xrca054        LIKE xrca_t.xrca054,
         xrca055        LIKE xrca_t.xrca055,
         xrca056        LIKE xrca_t.xrca056,
         xrca057        LIKE xrca_t.xrca057,
         xrca058        LIKE xrca_t.xrca058,
         xrca059        LIKE xrca_t.xrca059,
         xrca060        LIKE xrca_t.xrca060,
         xrca061        LIKE xrca_t.xrca061,
         xrca062        LIKE xrca_t.xrca062,
         xrca063        LIKE xrca_t.xrca063,
         xrca064        LIKE xrca_t.xrca064,
         xrca065        LIKE xrca_t.xrca065,
         xrca066        LIKE xrca_t.xrca066,
         xrca100        LIKE xrca_t.xrca100,
         xrca101        LIKE xrca_t.xrca101,
         xrca103        LIKE xrca_t.xrca103,
         xrca104        LIKE xrca_t.xrca104,
         xrca106        LIKE xrca_t.xrca106,
         xrca107        LIKE xrca_t.xrca107,
         xrca108        LIKE xrca_t.xrca108,
         xrca113        LIKE xrca_t.xrca113,
         xrca114        LIKE xrca_t.xrca114,
         xrca116        LIKE xrca_t.xrca116,
         xrca117        LIKE xrca_t.xrca117,
         xrca118        LIKE xrca_t.xrca118,
         xrca120        LIKE xrca_t.xrca120,
         xrca121        LIKE xrca_t.xrca121,
         xrca123        LIKE xrca_t.xrca123,
         xrca124        LIKE xrca_t.xrca124,
         xrca126        LIKE xrca_t.xrca126,
         xrca127        LIKE xrca_t.xrca127,
         xrca128        LIKE xrca_t.xrca128,
         xrca130        LIKE xrca_t.xrca130,
         xrca131        LIKE xrca_t.xrca131,
         xrca133        LIKE xrca_t.xrca133,
         xrca134        LIKE xrca_t.xrca134,
         xrca136        LIKE xrca_t.xrca136,
         xrca137        LIKE xrca_t.xrca137,
         xrca138        LIKE xrca_t.xrca138,
         xrcaownid      LIKE xrca_t.xrcaownid,
         xrcaowndp      LIKE xrca_t.xrcaowndp,
         xrcacrtid      LIKE xrca_t.xrcacrtid,
         xrcacrtdp      LIKE xrca_t.xrcacrtdp,
         xrcacrtdt      LIKE xrca_t.xrcacrtdt,
         xrcamodid      LIKE xrca_t.xrcamodid,
         xrcamoddt      LIKE xrca_t.xrcamoddt,
         xrcacnfid      LIKE xrca_t.xrcacnfid,
         xrcacnfdt      LIKE xrca_t.xrcacnfdt,
         xrcapstid      LIKE xrca_t.xrcapstid,
         xrcapstdt      LIKE xrca_t.xrcapstdt
END RECORD

 TYPE type_xrcb RECORD
         xrcbent        LIKE xrcb_t.xrcbent,
         xrcbld         LIKE xrcb_t.xrcbld, 
         xrcbdocno      LIKE xrcb_t.xrcbdocno,
         xrcbseq        LIKE xrcb_t.xrcbseq,
         xrcbsite       LIKE xrcb_t.xrcbsite,
         xrcborga       LIKE xrcb_t.xrcborga,
         xrcblegl       LIKE xrcb_t.xrcblegl,
         xrcb001        LIKE xrcb_t.xrcb001,
         xrcb002        LIKE xrcb_t.xrcb002,
         xrcb003        LIKE xrcb_t.xrcb003,
         xrcb004        LIKE xrcb_t.xrcb004,
         xrcb005        LIKE xrcb_t.xrcb005,
         xrcb006        LIKE xrcb_t.xrcb006,
         xrcb007        LIKE xrcb_t.xrcb007,
         xrcb008        LIKE xrcb_t.xrcb008,
         xrcb009        LIKE xrcb_t.xrcb009,
         xrcb010        LIKE xrcb_t.xrcb010,
         xrcb011        LIKE xrcb_t.xrcb011,
         xrcb012        LIKE xrcb_t.xrcb012,
         xrcb013        LIKE xrcb_t.xrcb013,
         xrcb014        LIKE xrcb_t.xrcb014,
         xrcb015        LIKE xrcb_t.xrcb015,
         xrcb016        LIKE xrcb_t.xrcb016,
         xrcb017        LIKE xrcb_t.xrcb017,
         xrcb018        LIKE xrcb_t.xrcb018,
         xrcb019        LIKE xrcb_t.xrcb019,
         xrcb020        LIKE xrcb_t.xrcb020,
         xrcb021        LIKE xrcb_t.xrcb021,
         xrcb022        LIKE xrcb_t.xrcb022,
         xrcb023        LIKE xrcb_t.xrcb023,
         xrcb024        LIKE xrcb_t.xrcb024,
         xrcb025        LIKE xrcb_t.xrcb025,
         xrcb026        LIKE xrcb_t.xrcb026,
         xrcb027        LIKE xrcb_t.xrcb027,
         xrcb028        LIKE xrcb_t.xrcb028,
         xrcb029        LIKE xrcb_t.xrcb029,
         xrcb030        LIKE xrcb_t.xrcb030,
         xrcb031        LIKE xrcb_t.xrcb031,
         xrcb032        LIKE xrcb_t.xrcb032,
         xrcb033        LIKE xrcb_t.xrcb033,
         xrcb034        LIKE xrcb_t.xrcb034,
         xrcb035        LIKE xrcb_t.xrcb035,
         xrcb036        LIKE xrcb_t.xrcb036,
         xrcb037        LIKE xrcb_t.xrcb037,
         xrcb038        LIKE xrcb_t.xrcb038,
         xrcb039        LIKE xrcb_t.xrcb039,
         xrcb040        LIKE xrcb_t.xrcb040,
         xrcb041        LIKE xrcb_t.xrcb041,
         xrcb042        LIKE xrcb_t.xrcb042,
         xrcb043        LIKE xrcb_t.xrcb043,
         xrcb044        LIKE xrcb_t.xrcb044,
         xrcb045        LIKE xrcb_t.xrcb045,
         xrcb046        LIKE xrcb_t.xrcb046,
         xrcb047        LIKE xrcb_t.xrcb047,
         xrcb048        LIKE xrcb_t.xrcb048,
         xrcb049        LIKE xrcb_t.xrcb049,
         xrcb050        LIKE xrcb_t.xrcb050,
         xrcb051        LIKE xrcb_t.xrcb051,
         xrcb100        LIKE xrcb_t.xrcb100,
         xrcb101        LIKE xrcb_t.xrcb101,
         xrcb102        LIKE xrcb_t.xrcb102,
         xrcb103        LIKE xrcb_t.xrcb103,
         xrcb104        LIKE xrcb_t.xrcb104,
         xrcb105        LIKE xrcb_t.xrcb105,
         xrcb106        LIKE xrcb_t.xrcb106,
         xrcb111        LIKE xrcb_t.xrcb111,
         xrcb113        LIKE xrcb_t.xrcb113,
         xrcb114        LIKE xrcb_t.xrcb114,
         xrcb115        LIKE xrcb_t.xrcb115,
         xrcb116        LIKE xrcb_t.xrcb116,
         xrcb117        LIKE xrcb_t.xrcb117,
         xrcb118        LIKE xrcb_t.xrcb118,
         xrcb119        LIKE xrcb_t.xrcb119,
         xrcb121        LIKE xrcb_t.xrcb121,
         xrcb123        LIKE xrcb_t.xrcb123,
         xrcb124        LIKE xrcb_t.xrcb124,
         xrcb125        LIKE xrcb_t.xrcb125,
         xrcb126        LIKE xrcb_t.xrcb126,
         xrcb131        LIKE xrcb_t.xrcb131,
         xrcb133        LIKE xrcb_t.xrcb133,
         xrcb134        LIKE xrcb_t.xrcb134,
         xrcb135        LIKE xrcb_t.xrcb135,
         xrcb136        LIKE xrcb_t.xrcb136
END RECORD
 TYPE type_xrde RECORD
         xrdeent        LIKE xrde_t.xrdeent,
         xrdecomp       LIKE xrde_t.xrdecomp,
         xrdeld         LIKE xrde_t.xrdeld,
         xrdedocno      LIKE xrde_t.xrdedocno,
         xrdeseq        LIKE xrde_t.xrdeseq,
         xrdesite       LIKE xrde_t.xrdesite,
         xrdeorga       LIKE xrde_t.xrdeorga,
         xrde001        LIKE xrde_t.xrde001,
         xrde002        LIKE xrde_t.xrde002,
         xrde003        LIKE xrde_t.xrde003,
         xrde004        LIKE xrde_t.xrde004,
         xrde006        LIKE xrde_t.xrde006,
         xrde007        LIKE xrde_t.xrde007,
         xrde008        LIKE xrde_t.xrde008,
         xrde010        LIKE xrde_t.xrde010,
         xrde011        LIKE xrde_t.xrde011,
         xrde012        LIKE xrde_t.xrde012,
         xrde013        LIKE xrde_t.xrde013,
         xrde014        LIKE xrde_t.xrde014,
         xrde015        LIKE xrde_t.xrde015,
         xrde016        LIKE xrde_t.xrde016,
         xrde017        LIKE xrde_t.xrde017,
         xrde018        LIKE xrde_t.xrde018,
         xrde019        LIKE xrde_t.xrde019,
         xrde020        LIKE xrde_t.xrde020,
         xrde022        LIKE xrde_t.xrde022,
         xrde023        LIKE xrde_t.xrde023,
         xrde028        LIKE xrde_t.xrde028,
         xrde029        LIKE xrde_t.xrde029,
         xrde030        LIKE xrde_t.xrde030,
         xrde035        LIKE xrde_t.xrde035,
         xrde036        LIKE xrde_t.xrde036,
         xrde038        LIKE xrde_t.xrde038,
         xrde039        LIKE xrde_t.xrde039,
         xrde040        LIKE xrde_t.xrde040,
         xrde041        LIKE xrde_t.xrde041,
         xrde042        LIKE xrde_t.xrde042,
         xrde043        LIKE xrde_t.xrde043,
         xrde044        LIKE xrde_t.xrde044,
         xrde045        LIKE xrde_t.xrde045,
         xrde046        LIKE xrde_t.xrde046,
         xrde047        LIKE xrde_t.xrde047,
         xrde048        LIKE xrde_t.xrde048,
         xrde049        LIKE xrde_t.xrde049,
         xrde050        LIKE xrde_t.xrde050,
         xrde051        LIKE xrde_t.xrde051,
         xrde100        LIKE xrde_t.xrde100,
         xrde101        LIKE xrde_t.xrde101,
         xrde109        LIKE xrde_t.xrde109,
         xrde119        LIKE xrde_t.xrde119,
         xrde120        LIKE xrde_t.xrde120,
         xrde121        LIKE xrde_t.xrde121,
         xrde129        LIKE xrde_t.xrde129,
         xrde130        LIKE xrde_t.xrde130,
         xrde131        LIKE xrde_t.xrde131,
         xrde139        LIKE xrde_t.xrde139
END RECORD
 TYPE type_debz RECORD
         debzsite       LIKE debz_t.debzsite,
         debz001        LIKE debz_t.debz001,
         debz002        LIKE debz_t.debz002,
         debz003        LIKE debz_t.debz003,
         debz004        LIKE debz_t.debz004,
         debz005        LIKE debz_t.debz005,
         debz006        LIKE debz_t.debz006,
         debz007        LIKE debz_t.debz007,
         debz008        LIKE debz_t.debz008,
         debz009        LIKE debz_t.debz009,
         debz010        LIKE debz_t.debz010,
         debz011        LIKE debz_t.debz011,
         debz012        LIKE debz_t.debz012,
         debz013        LIKE debz_t.debz013,
         debz014        LIKE debz_t.debz014,
         debz015        LIKE debz_t.debz015,
         debz016        LIKE debz_t.debz016,
         debz017        LIKE debz_t.debz017,
         debz018        LIKE debz_t.debz018   ##150417-00007#60 Add
END RECORD
 TYPE type_deby RECORD
         debysite       LIKE deby_t.debysite,
         deby001        LIKE deby_t.deby001,
         deby002        LIKE deby_t.deby002,
         deby003        LIKE deby_t.deby003,
         deby004        LIKE deby_t.deby004,
         deby005        LIKE deby_t.deby005,
         deby006        LIKE deby_t.deby006,
         deby007        LIKE deby_t.deby007,
         deby008        LIKE deby_t.deby008,
         deby009        LIKE deby_t.deby009,
         deby010        LIKE deby_t.deby010,
         deby011        LIKE deby_t.deby011,
         deby012        LIKE deby_t.deby012,
         deby013        LIKE deby_t.deby013,
         deby014        LIKE deby_t.deby014,
         deby015        LIKE deby_t.deby015,
         deby016        LIKE deby_t.deby016,
         deby017        LIKE deby_t.deby017,
         deby018        LIKE deby_t.deby018
END RECORD
 TYPE type_deaf RECORD
         deafsite       LIKE deaf_t.deafsite,
         deafdocno      LIKE deaf_t.deafdocno,
         deafstatu      LIKE deaf_t.deafstatu,
         deafdocdt      LIKE deaf_t.deafdocdt,
         deaf001        LIKE deaf_t.deaf001,
         deaf002        LIKE deaf_t.deaf002,
         deaf003        LIKE deaf_t.deaf003,
         deaf004        LIKE deaf_t.deaf004,
         deaf005        LIKE deaf_t.deaf005,
         deaf006        LIKE deaf_t.deaf006,
         deaf007        LIKE deaf_t.deaf007,
         deaf008        LIKE deaf_t.deaf008,
         deaf009        LIKE deaf_t.deaf009,
         deaf010        LIKE deaf_t.deaf010,
         deaf011        LIKE deaf_t.deaf011,
         deaf012        LIKE deaf_t.deaf012,
         deaf013        LIKE deaf_t.deaf013,
         deaf014        LIKE deaf_t.deaf014,
         deaf015        LIKE deaf_t.deaf015,
         deaf016        LIKE deaf_t.deaf016,
         deaf017        LIKE deaf_t.deaf017,
         deaf018        LIKE deaf_t.deaf018
END RECORD

#130726-00001#95 Add  ---(S)---
 TYPE type_rtja RECORD
         orders         LIKE type_t.chr200,
         rtja000        LIKE rtja_t.rtja000,
         rtjasite       LIKE rtja_t.rtjasite,
         rtjadocno      LIKE rtja_t.rtjadocno,
         rtja002        LIKE rtja_t.rtja002,
         rtja025        LIKE rtja_t.rtja025,
         rtja026        LIKE rtja_t.rtja026,
         rtja028        LIKE rtja_t.rtja028,
         rtjf003        LIKE rtjf_t.rtjf003,
         rtjf027        LIKE rtjf_t.rtjf027
END RECORD
#130726-00001#95 Add  ---(E)---
]]>
  </point>
  <point name="init.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success         LIKE type_t.num5]]>
  </point>
  <point name="init.init" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   LET g_master.xrcadocdt = NULL
   LET g_master.debz002   = NULL
   CALL s_fin_create_account_center_tmp()   
   CALL s_voucher_cre_ar_tmp_table() RETURNING l_success]]>
  </point>
  <point name="input.a.debz002" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_master.xrcadocdt) AND NOT cl_null(g_master.debz002) THEN
               IF MONTH(g_master.xrcadocdt) <> MONTH(g_master.debz002) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = g_master.debz002
                  LET g_errparam.code   = 'axr-00324'
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.a.l_xrcadocno" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_master.l_xrcadocno) THEN
               SELECT glaa024 INTO l_glaa024 FROM glaa_t
                 WHERE glaaent = g_enterprise AND glaald = g_master.xrcald
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = l_glaa024
               LET g_chkparam.arg2 = g_master.l_xrcadocno
               IF NOT s_aooi200_fin_chk_slip(g_master.xrcald,l_glaa024,g_master.l_xrcadocno,'axrt370') THEN
                  LET g_master.l_xrcadocno = ''
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.a.xrcadocdt" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_master.xrcadocdt) AND NOT cl_null(g_master.debz002) THEN
               IF MONTH(g_master.xrcadocdt) <> MONTH(g_master.debz002) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = g_master.xrcadocdt
                  LET g_errparam.code   = 'axr-00324'
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.a.xrcadocno" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_master.xrcadocno) THEN
               SELECT glaa024 INTO l_glaa024 FROM glaa_t
                 WHERE glaaent = g_enterprise AND glaald = g_master.xrcald
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = l_glaa024
               LET g_chkparam.arg2 = g_master.xrcadocno
               IF NOT s_aooi200_fin_chk_slip(g_master.xrcald,l_glaa024,g_master.xrcadocno,'axrt350') THEN
                  LET g_master.xrcadocno = ''
                  NEXT FIELD CURRENT
               END IF
            END IF]]>
  </point>
  <point name="input.a.xrcald" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_master.xrcald) THEN 
               CALL s_axrt300_site_geared_ld(g_master.xrcasite,g_master.xrcald,g_user,g_today,'ld')
                  RETURNING l_success,g_master.xrcasite,g_master.xrcasite_desc,g_master.xrcald,g_master.xrcald_desc
               DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc
               DISPLAY BY NAME g_master.xrcald,g_master.xrcald_desc
               IF NOT l_success THEN
                  NEXT FIELD CURRENT
               END IF
            ELSE
               LET g_master.xrcald_desc = ''
            END IF
            DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc
            DISPLAY BY NAME g_master.xrcald,g_master.xrcald_desc
]]>
  </point>
  <point name="input.a.xrcasite" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            IF NOT cl_null(g_master.xrcasite) THEN
               CALL s_axrt300_site_geared_ld(g_master.xrcasite,g_master.xrcald,g_user,g_today,'site')
                  RETURNING l_success,g_master.xrcasite,g_master.xrcasite_desc,g_master.xrcald,g_master.xrcald_desc
               DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc
               DISPLAY BY NAME g_master.xrcald,g_master.xrcald_desc
               IF NOT l_success THEN NEXT FIELD CURRENT END IF
               CALL s_axrt300_date_chk(g_master.xrcasite,g_master.xrcadocdt) RETURNING l_success
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = "axr-00299"
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err() 
                  NEXT FIELD CURRENT
               END IF
            ELSE
               LET g_master.xrcasite_desc = ''
            END IF
            DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc
            DISPLAY BY NAME g_master.xrcald,g_master.xrcald_desc
]]>
  </point>
  <point name="input.c.l_xrcadocno" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_xrcadocno             #給予default值
            #給予arg
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrcald
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = 'axrt370'

            CALL q_ooba002_1()                                #呼叫開窗

            LET g_master.l_xrcadocno = g_qryparam.return1              
            DISPLAY g_master.l_xrcadocno TO l_xrcadocno              #
            NEXT FIELD l_xrcadocno                          #返回原欄位
]]>
  </point>
  <point name="input.c.xrcadocno" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.xrcadocno             #給予default值
            #給予arg
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrcald
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = 'axrt350'

            CALL q_ooba002_1()                                #呼叫開窗

            LET g_master.xrcadocno = g_qryparam.return1              
            DISPLAY g_master.xrcadocno TO xrcadocno              #
            NEXT FIELD xrcadocno                          #返回原欄位
]]>
  </point>
  <point name="input.c.xrcald" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #取得帳務組織下所屬成員
            CALL s_fin_account_center_sons_query('3',g_master.xrcasite,g_today,'1')
            #取得帳務組織下所屬成員之帳別   
            CALL s_fin_account_center_comp_str() RETURNING ls_wc
            #將取回的字串轉換為SQL條件
            CALL axrp136_get_ooef001_wc(ls_wc) RETURNING ls_wc  
            #開窗i段
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.xrcald             #給予default值
            IF NOT cl_null(ls_wc) AND ls_wc <> '(\'\')' THEN
               LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y') AND glaacomp IN ",ls_wc,""
            ELSE
               LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y')"
            END IF
            LET g_qryparam.arg1 = g_user
            LET g_qryparam.arg2 = g_dept
            CALL  q_authorised_ld()                                  #呼叫開窗
            LET g_master.xrcald = g_qryparam.return1       #將開窗取得的值回傳到變數
            IF NOT cl_null(g_master.xrcald) THEN
               CALL s_axrt300_site_geared_ld(g_master.xrcasite,g_master.xrcald,g_user,g_today,'ld')
                  RETURNING l_success,g_master.xrcasite,g_master.xrcasite_desc,g_master.xrcald,g_master.xrcald_desc
            END IF
            DISPLAY BY NAME g_master.xrcald,g_master.xrcald_desc
            NEXT FIELD xrcald                              #返回原欄位  
]]>
  </point>
  <point name="input.c.xrcasite" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.xrcasite             #給予default值
            LET g_qryparam.where = " ooef201 = 'Y' "

            #給予arg

            CALL q_ooef001()                                        #呼叫開窗
            LET g_master.xrcasite = g_qryparam.return1              #將開窗取得的值回傳到變數
            CALL s_axrt300_xrca_ref('xrcasite',g_master.xrcasite,'','') RETURNING l_success,g_master.xrcasite_desc
            IF NOT cl_null(g_master.xrcasite) THEN
               CALL s_axrt300_site_geared_ld(g_master.xrcasite,g_master.xrcald,g_user,g_today,'site')
                  RETURNING l_success,g_master.xrcasite,g_master.xrcasite_desc,g_master.xrcald,g_master.xrcald_desc
            END IF
            DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc
            DISPLAY BY NAME g_master.xrcald,g_master.xrcald_desc
            DISPLAY BY NAME g_master.xrcasite,g_master.xrcasite_desc
            NEXT FIELD xrcasite
]]>
  </point>
  <point name="input.m.before_input" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[               CALL axrp136_def()]]>
  </point>
  <point name="process.define" order="" ver="2" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   #2015/06/11--add--str--
   DEFINE l_ooaa002       LIKE ooaa_t.ooaa002
  
   #品类管理层级aoos010
   CALL cl_get_para(g_enterprise,'','E-CIR-0001') RETURNING l_ooaa002
   IF cl_null(l_ooaa002) THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "cxr-00001"
      LET g_errparam.popup  = TRUE 
      CALL cl_err() 
      RETURN
   END IF
   #2015/06/11--add--end]]>
  </point>
  <point name="process.foreground_finish" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[      CALL axrp136_get_ar()]]>
  </point>
  <point name="ui_dialog.define" order="" ver="1" cite_std="N" new="N" status="" src="s" readonly="" mark_hard="N">
    <![CDATA[   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_glaa024         LIKE glaa_t.glaa024]]>
  </point>
  <section id="axrp136.description" ver="1" status="" src="s" readonly="">
    <![CDATA[#應用 a00 樣板自動產生(Version:1)
#+ Version..: T100-ERP-1.00.00(SD版次:4,PR版次:4) Build-000014
#+ 
#+ Filename...: axrp136
#+ Description: 零售日結帳款單批次生成作業
#+ Creator....: 01727(2015-04-20 14:38:31)
#+ Modifier...: 01727(2015-04-22 16:46:41) -SD/PR-
]]>
  </section>
  <section id="axrp136.get_buffer" ver="2" status="" src="s" readonly="">
    <![CDATA[PRIVATE FUNCTION axrp136_get_buffer(p_dialog)
   DEFINE p_dialog   ui.DIALOG
   
   LET g_master.xrcasite = p_dialog.getFieldBuffer('xrcasite')
   LET g_master.xrcald = p_dialog.getFieldBuffer('xrcald')
   LET g_master.b_comb = p_dialog.getFieldBuffer('b_comb')
   LET g_master.xrcadocno = p_dialog.getFieldBuffer('xrcadocno')
   LET g_master.xrcadocdt = p_dialog.getFieldBuffer('xrcadocdt')
   LET g_master.l_xrcadocno = p_dialog.getFieldBuffer('l_xrcadocno')
   LET g_master.debz002 = p_dialog.getFieldBuffer('debz002')
 
   CALL cl_schedule_get_buffer(p_dialog)
 
   #add-point:get_buffer段其他欄位處理
   {<point name="get_buffer.others"/>}
   #end add-point
END FUNCTION
]]>
  </section>
  <section id="axrp136.global" ver="3" status="" src="s" readonly="">
    <![CDATA[#應用 p01 樣板自動產生(Version:10)
{<point name="global.memo" />}
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_schedule
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
GLOBALS "../../cfg/top_schedule.inc"
GLOBALS
   DEFINE gwin_curr2  ui.Window
   DEFINE gfrm_curr2  ui.Form
   DEFINE gi_hiden_asign       LIKE type_t.num5
   DEFINE gi_hiden_exec        LIKE type_t.num5
   DEFINE gi_hiden_spec        LIKE type_t.num5
   DEFINE gi_hiden_exec_end    LIKE type_t.num5
   DEFINE g_chk_jobid          LIKE type_t.num5
END GLOBALS
 
PRIVATE TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
DEFINE g_sql             STRING        #組 sql 用
DEFINE g_forupd_sql      STRING        #SELECT ... FOR UPDATE  SQL
DEFINE g_error_show      LIKE type_t.num5
DEFINE g_jobid           STRING
DEFINE g_wc              STRING
 
PRIVATE TYPE type_master RECORD
       xrcasite LIKE xrca_t.xrcasite, 
   xrcasite_desc LIKE type_t.chr80, 
   xrcald LIKE xrca_t.xrcald, 
   xrcald_desc LIKE type_t.chr80, 
   b_comb LIKE type_t.chr500, 
   xrcadocno LIKE xrca_t.xrcadocno, 
   xrcadocdt LIKE xrca_t.xrcadocdt, 
   l_xrcadocno LIKE type_t.chr500, 
   debz002 LIKE debz_t.debz002, 
   stagenow LIKE type_t.chr80,
       wc               STRING
       END RECORD
 
#模組變數(Module Variables)
DEFINE g_master type_master
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable" edit="s"/>}
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)
{<point name="global.variable_customerization" edit="c"/>}
#end add-point
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
  </section>
  <section id="axrp136.init" ver="1" status="" src="s" readonly="">
    <![CDATA[#+ 初始化作業
PRIVATE FUNCTION axrp136_init()
   #add-point:init段define 
   {<point name="init.define" edit="s"/>}
   #end add-point
   #add-point:init段define (客製用)
   {<point name="init.define_customerization" edit="c"/>}
   #end add-point
 
   LET g_error_show = 1
   LET gwin_curr2 = ui.Window.getCurrent()
   LET gfrm_curr2 = gwin_curr2.getForm()
   CALL cl_schedule_import_4fd()
   CALL cl_set_combo_scc("gzpa003","75")
   IF cl_get_para(g_enterprise,"","E-SYS-0005") = "N" THEN
       CALL cl_set_comp_visible("scheduling_page,history_page",FALSE)
   END IF 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
  </section>
  <section id="axrp136.main" ver="2" status="" src="s" readonly="">
    <![CDATA[MAIN
   DEFINE ls_js    STRING
   DEFINE lc_param type_parameter  
   #add-point:main段define 
   {<point name="main.define" edit="s"/>}
   #end add-point 
   #add-point:main段define (客製用)
   {<point name="main.define_customerization" edit="c"/>}
   #end add-point 
  
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("axr","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   #背景(Y) 或半背景(T) 時不做主畫面開窗
   IF g_bgjob = "Y" OR g_bgjob = "T" THEN
      #排程參數由01開始，若不是1開始，表示有保留參數
      LET ls_js = g_argv[01]
     #CALL util.JSON.parse(ls_js,g_master)   #p類主要使用l_param,此處不解析
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
      CALL axrp136_process(ls_js)
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_axrp136 WITH FORM cl_ap_formpath("axr",g_code)
 
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
 
      #程式初始化
      CALL axrp136_init()
 
      #進入選單 Menu (="N")
      CALL axrp136_ui_dialog()
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_axrp136
   END IF
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
  </section>
  <section id="axrp136.msgcentre_notify" ver="1" status="" src="s" readonly="">
    <![CDATA[PRIVATE FUNCTION axrp136_msgcentre_notify()
 
   DEFINE lc_state LIKE type_t.chr5
 
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = "process"
 
   #add-point:msgcentre其他通知
   {<point name="msg_centre.process"/>}
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
]]>
  </section>
  <section id="axrp136.other_function" ver="1" status="" src="s" readonly="">
    <![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
  </section>
  <section id="axrp136.process" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 資料處理   (r類使用g_master為主處理/p類使用l_param為主)
PRIVATE FUNCTION axrp136_process(ls_js)
   DEFINE ls_js         STRING
   DEFINE lc_param      type_parameter
   DEFINE li_stus       LIKE type_t.num5
   DEFINE li_count      LIKE type_t.num10  #progressbar計量
   DEFINE ls_sql        STRING             #主SQL
   DEFINE li_p01_status LIKE type_t.num5
   #add-point:process段define 
   {<point name="process.define" edit="s"/>}
   #end add-point
   #add-point:process段define (客製用)
   {<point name="process.define_customerization" edit="c"/>}
   #end add-point
 
  #INITIALIZE lc_param TO NULL           #p類不可以清空
   CALL util.JSON.parse(ls_js,lc_param)  #r類作業被t類呼叫時使用, p類主要解開參數處
 
  #IF lc_param.wc IS NOT NULL THEN
  #   LET g_bgjob = "T"       #特殊情況,此為t類作業鬆耦合串入報表主程式使用
  #END IF
 
   #add-point:process段前處理
   {<point name="process.pre_process"/>}
   #end add-point
 
   #預先計算progressbar迴圈次數
   IF g_bgjob <> "Y" THEN
      #add-point:process段count_progress
      {<point name="process.count_progress"/>}
      #end add-point
   END IF
 
   #主SQL及相關FOREACH前置處理
#  DECLARE axrp136_process_cs CURSOR FROM ls_sql
#  FOREACH axrp136_process_cs INTO
   #add-point:process段process
   {<point name="process.process"/>}
   #end add-point
#  END FOREACH
 
   IF g_bgjob = "N" THEN
      #前景作業完成處理
      #add-point:process段foreground完成處理
      {<point name="process.foreground_finish"/>}
      #end add-point
      CALL cl_ask_confirm3("std-00012","")
   ELSE
      #背景作業完成處理
      #add-point:process段background完成處理
      {<point name="process.background_finish"/>}
      #end add-point
      CALL cl_schedule_exec_call(li_p01_status)
   END IF
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL axrp136_msgcentre_notify()
 
END FUNCTION
]]>
  </section>
  <section id="axrp136.transfer_argv" ver="2" status="" src="s" readonly="">
    <![CDATA[#+ 轉換本地參數至cmdrun參數內,準備進入背景執行
PRIVATE FUNCTION axrp136_transfer_argv(ls_js)
   DEFINE ls_js       STRING
   DEFINE la_cmdrun   RECORD
             prog       STRING,
             actionid   STRING,
             background LIKE type_t.chr1,
             param      DYNAMIC ARRAY OF STRING
                  END RECORD
   DEFINE la_param    type_parameter
   #add-point:transfer_agrv段define 
   {<point name="transfer_agrv.define" edit="s"/>}
   #end add-point
   #add-point:transfer_agrv段define (客製用)
   {<point name="transfer_agrv.define_customerization" edit="c"/>}
   #end add-point
 
   LET la_cmdrun.prog = g_prog
   LET la_cmdrun.background = "Y"
   LET la_cmdrun.param[1] = ls_js
 
   #add-point:transfer.argv段程式內容
   {<point name="transfer.argv.define"/>}
   #end add-point
 
   RETURN util.JSON.stringify( la_cmdrun )
END FUNCTION
]]>
  </section>
  <section id="axrp136.ui_dialog" ver="3" status="" src="s" readonly="">
    <![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION axrp136_ui_dialog()
   DEFINE li_exit  LIKE type_t.num5    #判別是否為離開作業
   DEFINE li_idx   LIKE type_t.num10
   DEFINE ls_js    STRING
   DEFINE ls_wc    STRING
   DEFINE l_dialog ui.DIALOG
   DEFINE lc_param type_parameter
   #add-point:ui_dialog段define 
   {<point name="ui_dialog.define" edit="s"/>}
   #end add-point
   #add-point:ui_dialog段define (客製用)
   {<point name="ui_dialog.define_customerization" edit="c"/>}
   #end add-point
   
   #add-point:ui_dialog段before dialog
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
 
   WHILE TRUE
      #add-point:ui_dialog段before dialog2
      {<point name="ui_dialog.before_dialog2"/>}
      #end add-point
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #應用 a57 樣板自動產生(Version:2)
         INPUT BY NAME g_master.xrcasite,g_master.xrcald,g_master.b_comb,g_master.xrcadocno,g_master.xrcadocdt, 
             g_master.l_xrcadocno,g_master.debz002 
            ATTRIBUTE(WITHOUT DEFAULTS)
            
            #自訂ACTION(master_input)
            
         
            BEFORE INPUT
               #add-point:資料輸入前
               {<point name="input.m.before_input"/>}
               #end add-point
         
                     #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcasite
            
            #add-point:AFTER FIELD xrcasite
            {<point name="input.a.xrcasite" />}
            #END add-point
            
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcasite
            #add-point:BEFORE FIELD xrcasite
            {<point name="input.b.xrcasite" />}
            #END add-point
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE xrcasite
            #add-point:ON CHANGE xrcasite
            {<point name="input.g.xrcasite" />}
            #END add-point 
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcald
            
            #add-point:AFTER FIELD xrcald
            {<point name="input.a.xrcald" />}
            #END add-point
            
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcald
            #add-point:BEFORE FIELD xrcald
            {<point name="input.b.xrcald" />}
            #END add-point
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE xrcald
            #add-point:ON CHANGE xrcald
            {<point name="input.g.xrcald" />}
            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD b_comb
            #add-point:BEFORE FIELD b_comb
            {<point name="input.b.b_comb" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD b_comb
            
            #add-point:AFTER FIELD b_comb
            {<point name="input.a.b_comb" />}
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE b_comb
            #add-point:ON CHANGE b_comb
            {<point name="input.g.b_comb" />}
            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcadocno
            #add-point:BEFORE FIELD xrcadocno
            {<point name="input.b.xrcadocno" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcadocno
            
            #add-point:AFTER FIELD xrcadocno
            {<point name="input.a.xrcadocno" />}
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE xrcadocno
            #add-point:ON CHANGE xrcadocno
            {<point name="input.g.xrcadocno" />}
            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcadocdt
            #add-point:BEFORE FIELD xrcadocdt
            {<point name="input.b.xrcadocdt" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcadocdt
            
            #add-point:AFTER FIELD xrcadocdt
            {<point name="input.a.xrcadocdt" />}
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE xrcadocdt
            #add-point:ON CHANGE xrcadocdt
            {<point name="input.g.xrcadocdt" />}
            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD l_xrcadocno
            #add-point:BEFORE FIELD l_xrcadocno
            {<point name="input.b.l_xrcadocno" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD l_xrcadocno
            
            #add-point:AFTER FIELD l_xrcadocno
            {<point name="input.a.l_xrcadocno" />}
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE l_xrcadocno
            #add-point:ON CHANGE l_xrcadocno
            {<point name="input.g.l_xrcadocno" />}
            #END add-point 
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD debz002
            #add-point:BEFORE FIELD debz002
            {<point name="input.b.debz002" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD debz002
            
            #add-point:AFTER FIELD debz002
            {<point name="input.a.debz002" />}
            #END add-point
            
 
         #應用 a04 樣板自動產生(Version:2)
         ON CHANGE debz002
            #add-point:ON CHANGE debz002
            {<point name="input.g.debz002" />}
            #END add-point 
 
 
                     #Ctrlp:input.c.xrcasite
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcasite
            #add-point:ON ACTION controlp INFIELD xrcasite
            {<point name="input.c.xrcasite" />}
            #END add-point
 
         #Ctrlp:input.c.xrcald
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcald
            #add-point:ON ACTION controlp INFIELD xrcald
            {<point name="input.c.xrcald" />}
            #END add-point
 
         #Ctrlp:input.c.b_comb
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_comb
            #add-point:ON ACTION controlp INFIELD b_comb
            {<point name="input.c.b_comb" />}
            #END add-point
 
         #Ctrlp:input.c.xrcadocno
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcadocno
            #add-point:ON ACTION controlp INFIELD xrcadocno
            {<point name="input.c.xrcadocno" />}
            #END add-point
 
         #Ctrlp:input.c.xrcadocdt
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcadocdt
            #add-point:ON ACTION controlp INFIELD xrcadocdt
            {<point name="input.c.xrcadocdt" />}
            #END add-point
 
         #Ctrlp:input.c.l_xrcadocno
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD l_xrcadocno
            #add-point:ON ACTION controlp INFIELD l_xrcadocno
            {<point name="input.c.l_xrcadocno" />}
            #END add-point
 
         #Ctrlp:input.c.debz002
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD debz002
            #add-point:ON ACTION controlp INFIELD debz002
            {<point name="input.c.debz002" />}
            #END add-point
 
 
               
            AFTER INPUT
               #add-point:資料輸入後
               {<point name="input.m.after_input"/>}
               #end add-point
               
            #add-point:其他管控(on row change, etc...)
            {<point name="input.other"/>}
            #end add-point
         END INPUT
 
 
         
         #應用 a58 樣板自動產生(Version:2)
         CONSTRUCT BY NAME g_master.wc ON xrcasite_desc,xrcald_desc
            BEFORE CONSTRUCT
               #add-point:cs段before_construct
               {<point name="cs.head.before_construct"/>}
               #end add-point 
         
            #公用欄位開窗相關處理
            
               
            #一般欄位開窗相關處理    
                     #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcasite
            #add-point:BEFORE FIELD xrcasite
            {<point name="construct.b.xrcasite" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcasite
            
            #add-point:AFTER FIELD xrcasite
            {<point name="construct.a.xrcasite" />}
            #END add-point
            
 
         #Ctrlp:construct.c.xrcasite
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcasite
            #add-point:ON ACTION controlp INFIELD xrcasite
            {<point name="construct.c.xrcasite" />}
            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcasite_desc
            #add-point:BEFORE FIELD xrcasite_desc
            {<point name="construct.b.xrcasite_desc" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcasite_desc
            
            #add-point:AFTER FIELD xrcasite_desc
            {<point name="construct.a.xrcasite_desc" />}
            #END add-point
            
 
         #Ctrlp:construct.c.xrcasite_desc
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcasite_desc
            #add-point:ON ACTION controlp INFIELD xrcasite_desc
            {<point name="construct.c.xrcasite_desc" />}
            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcald
            #add-point:BEFORE FIELD xrcald
            {<point name="construct.b.xrcald" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcald
            
            #add-point:AFTER FIELD xrcald
            {<point name="construct.a.xrcald" />}
            #END add-point
            
 
         #Ctrlp:construct.c.xrcald
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcald
            #add-point:ON ACTION controlp INFIELD xrcald
            {<point name="construct.c.xrcald" />}
            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrcald_desc
            #add-point:BEFORE FIELD xrcald_desc
            {<point name="construct.b.xrcald_desc" />}
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrcald_desc
            
            #add-point:AFTER FIELD xrcald_desc
            {<point name="construct.a.xrcald_desc" />}
            #END add-point
            
 
         #Ctrlp:construct.c.xrcald_desc
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrcald_desc
            #add-point:ON ACTION controlp INFIELD xrcald_desc
            {<point name="construct.c.xrcald_desc" />}
            #END add-point
 
 
            
            #add-point:其他管控
            {<point name="cs.other"/>}
            #end add-point
            
         END CONSTRUCT
 
 
      
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         SUBDIALOG lib_cl_schedule.cl_schedule_setting
         SUBDIALOG lib_cl_schedule.cl_schedule_setting_exec_call
         SUBDIALOG lib_cl_schedule.cl_schedule_select_show_history
         SUBDIALOG lib_cl_schedule.cl_schedule_show_history
 
         BEFORE DIALOG
            LET l_dialog = ui.DIALOG.getCurrent()
            CALL axrp136_get_buffer(l_dialog)
            #add-point:ui_dialog段before dialog
            {<point name="ui_dialog.before_dialog3"/>}
            #end add-point
 
         ON ACTION batch_execute
            LET g_action_choice = "batch_execute"
            ACCEPT DIALOG
 
         #add-point:ui_dialog段before_qbeclear
         {<point name="ui_dialog.before_qbeclear" mark="Y"/>}
         #end add-point
 
         ON ACTION qbeclear         
            CLEAR FORM
            INITIALIZE g_master.* TO NULL   #畫面變數清空
            INITIALIZE lc_param.* TO NULL   #傳遞參數變數清空
            #add-point:ui_dialog段qbeclear
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         ON ACTION history_fill
            CALL cl_schedule_history_fill()
 
         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT DIALOG
         
         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT DIALOG
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM   
         INITIALIZE g_master.* TO NULL
         LET g_wc  = ' 1=2'
         LET g_action_choice = ""
         CALL axrp136_init()
         CONTINUE WHILE
      END IF
 
      #檢查批次設定是否有錯(或未設定完成)
      IF NOT cl_schedule_exec_check() THEN
         CONTINUE WHILE
      END IF
      
      LET lc_param.wc = g_master.wc    #把畫面上的wc傳遞到參數變數
      #請在下方的add-point內進行把畫面的輸入資料(g_master)轉換到傳遞參數變數(lc_param)的動作
      #add-point:ui_dialog段exit dialog
      {<point name="process.exit_dialog"/>}
      #end add-point
 
      LET ls_js = util.JSON.stringify(lc_param)  #r類使用g_master/p類使用lc_param
 
      IF INT_FLAG THEN
         LET INT_FLAG = FALSE
         EXIT WHILE
      ELSE
         IF g_chk_jobid THEN 
            LET g_jobid = g_schedule.gzpa001
         ELSE 
            LET g_jobid = cl_schedule_get_jobid(g_prog)
         END IF 
 
         #依照指定模式執行報表列印
         CASE 
            WHEN g_schedule.gzpa003 = "0"
                 CALL axrp136_process(ls_js)
 
            WHEN g_schedule.gzpa003 = "1"
                 LET ls_js = axrp136_transfer_argv(ls_js)
                 CALL cl_cmdrun(ls_js)
 
            WHEN g_schedule.gzpa003 = "2"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
 
            WHEN g_schedule.gzpa003 = "3"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
         END CASE  
 
         IF g_schedule.gzpa003 = "2" OR g_schedule.gzpa003 = "3" THEN 
            CALL cl_ask_confirm3("std-00014","") #設定完成
         END IF    
         LET g_schedule.gzpa003 = "0" #預設一開始 立即於前景執行
 
         #add-point:ui_dialog段after schedule
         {<point name="process.after_schedule"/>}
         #end add-point
 
         #欄位初始資訊 
         CALL cl_schedule_init_info("all",g_schedule.gzpa003) 
         LET gi_hiden_asign = FALSE 
         LET gi_hiden_exec = FALSE 
         LET gi_hiden_spec = FALSE 
         LET gi_hiden_exec_end = FALSE 
         CALL cl_schedule_hidden()
      END IF
   END WHILE
 
END FUNCTION
]]>
  </section>
</add_points>
