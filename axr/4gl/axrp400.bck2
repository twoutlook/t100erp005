#該程式未解開Section, 採用最新樣板產出!
{<section id="axrp400.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0020(2016-10-13 16:04:08), PR版次:0020(2016-10-27 10:54:18)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000099
#+ Filename...: axrp400
#+ Description: 收款沖帳批次產生作業
#+ Creator....: 02291(2015-07-10 13:40:13)
#+ Modifier...: 01727 -SD/PR- 08729
 
{</section>}
 
{<section id="axrp400.global" >}
#應用 p02 樣板自動產生(Version:19)
#add-point:填寫註解說明
#151013-00019#11 2015/11/11 By Reanna    帳款明細增加備註apca053
#151125-00006#1  2015/12/05 By 06862     生成單據后立即審核，立即拋轉傳票
#160329-00029#1  2016/03/30 By fengmy    anmt540的款别设置为银行电汇的资料未查出
#160318-00025#35 2016/04/15 By pengxin   將重複內容的錯誤訊息置換為公用錯誤訊息(r.v)
#160426-00016#1  2016/04/26 By Dido      xrce038 要記錄 apca004
#160530-00017#1  2016/06/12 By 07900     1: 立帳金額減 (已沖+預沖 ) 若為0 ,則不產生到 axrt400 
#                                        2:调整未冲销金额，本币金额
#160530-00005#5  2016/06/20 By 01727     1.收款單若有勾選暫收,則產生到 axrt400 的科目應取 anmi152 收款待沖銷科目
#                                        2.若條件沒有勾"同對象的應付帳款一併沖銷" , 則帳款明細的來源模組請預設為 AXR , 現在會是空白, 帳款單號開窗時會開  AP 單
#                                        來源模組,簡繁體請確認, 現在繁體環境會出現" 1:AXR应收" 
#                                        3.若無差異時,請不要跳到 axrp400_s01 的視窗
#160620-00010#1  2016/06/20 by 01727     增加收款明細/帳款明細二次篩選功能
#160607-00015#2  2016/06/23 By 01727     抓取沖帳資料時,剔除存在於aist340中的單據
#160727-00019#6  2016/07/28 By 08734     临时表长度超过15码的减少到15码以下  s_voucher_ar_tmp ——> s_voucher_tmp09, s_voucher_ar_group ——> s_voucher_tmp05 
#160325-00025#1  2016/08/01 By Ann_Huang 修正若按選取資料/取消選擇資料後,帳款明細的合計金額會重複累加或累扣 
#160802-00006#1  2016/08/10 By 01727     axrp400重复定义了新建分录底稿临时表的逻辑,应该取消
#160811-00009#4  2016/08/19 By 01531     账务中心/法人/账套权限控管
#160905-00002#7  2016/09/05 By 08171     SQL補上ent
#160901-00020#1  2016/09/08 By 00768     anmt540的账款性质为'30'的未查出
#160912-00038#1  2016/09/13 By 00768     xrde032缺少赋值
#160912-00011#2  2016/09/20 By 01727     收款單開窗時, 要抓出預沖金額顯示, 若已沖+預沖=收款金, 則不可選
#160926-00026#1  2016/09/26 By 01727     產生到axrt400 款別30 沒有沖銷科目
#160929-00026#1  2016/09/26 By 01727     產生到axrt400 款別30 沒有沖銷科目
#161003-00015#1  2016/10/10 By 02599     点‘筛选已存在资料’和‘重新整理’按钮后，刷新‘收付款金额’、‘核销账款单金额’和‘差异金额’这个三个栏位的值
#161013-00003#2  2016/10/13 BY 01727     1.帳款明細增加幣別(xrcc100)顯示
#                                        2.收款單身為 2000 帳款單身 2000 此時仍會跳出差異視窗,請檢查
#                                        3.收款單身為 2000 帳款單身 5000 時(收款>帳款)核銷帳款單金額應該等於收款金額.
#                                        4.無法產生 axrt400 帳款單身資料
#161013-00013#1  2016/10/17 By 01727     axrp400批处理生成收款核销整单axrt400，第一单身有带出银行对应会计科目，但收款账号变为空
#161021-00050#3  2016/10/27 By 08729     處理組織開窗

#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT util
#add-point:增加匯入項目

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc" 
#add-point:增加匯入變數檔
#
##end add-point
 
#模組變數(Module Variables)
DEFINE g_wc                 STRING
DEFINE g_wc_t               STRING                        #儲存 user 的查詢條件
DEFINE g_wc2                STRING
DEFINE g_wc_filter          STRING
DEFINE g_wc_filter_t        STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10              
DEFINE l_ac_d               LIKE type_t.num10             #單身idx 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_current_page       LIKE type_t.num10             #目前所在頁數
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_master_idx         LIKE type_t.num10
 
TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   
   #end add-point
        wc               STRING
                     END RECORD
 
TYPE type_g_detail_d RECORD
#add-point:自定義模組變數(Module Variable)  #注意要在add-point內寫入END RECORD
     sel LIKE type_t.chr1, 
   nmbbdocno LIKE nmbb_t.nmbbdocno,
   nmbbseq LIKE nmbb_t.nmbbseq, 
   nmbb026 LIKE nmbb_t.nmbb026,
   nmbb026_desc LIKE type_t.chr80,
   nmbadocdt LIKE nmba_t.nmbadocdt,
   nmbb029 LIKE nmbb_t.nmbb029, 
   nmbb004 LIKE nmbb_t.nmbb004, 
   nmbb006 LIKE nmbb_t.nmbb006, 
   nmbb008 LIKE nmbb_t.nmbb008, 
   nmba008 LIKE nmba_t.nmba008, 
   nmba008_desc LIKE type_t.chr80, 
   nmbb031 LIKE nmbb_t.nmbb031, 
   nmbb030 LIKE nmbb_t.nmbb030, 
   nmbb040 LIKE nmbb_t.nmbb040, 
   nmbb003 LIKE nmbb_t.nmbb003, 
   nmbb003_desc LIKE type_t.chr80, 
   nmbb005 LIKE nmbb_t.nmbb005, 
   nmbb009 LIKE nmbb_t.nmbb009
       END RECORD
       
TYPE type_g_detail2 RECORD
   sel1          LIKE type_t.chr1, 
   flag          LIKE type_t.chr1,
   xrcadocno     LIKE xrca_t.xrcadocno,
   xrccseq       LIKE xrcc_t.xrccseq,
   xrcc001       LIKE xrcc_t.xrcc001,
   xrca001       LIKE type_t.chr80, 
   xrcasite      LIKE xrca_t.xrcasite,
   xrcasite_desc LIKE type_t.chr80,
   xrca003       LIKE xrca_t.xrca003,
   xrca003_desc  LIKE type_t.chr80,
   xrca005       LIKE xrca_t.xrca005,
   xrca005_desc  LIKE type_t.chr80,
   xrcald        LIKE xrca_t.xrcald,
   xrcald_desc   LIKE type_t.chr80,
   xrcadocdt     LIKE xrca_t.xrcadocdt, 
   xrcc100       LIKE xrcc_t.xrcc100,
   xrcc108       LIKE xrcc_t.xrcc108,
   xrcc109       LIKE xrcc_t.xrcc109,
   xrcc109_1     LIKE xrcc_t.xrcc109,    #160530-00017#1  Add
   xrcc108_1     LIKE xrcc_t.xrcc108,    #151013-00019#11 add ,
   xrca053       LIKE xrca_t.xrca053     #151013-00019#11
       END RECORD
DEFINE g_wc_filter2         STRING   #160620-00010#1 Add
DEFINE g_wc_filter2_t       STRING   #160620-00010#1 Add
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)

#end add-point
DEFINE g_detail_cnt         LIKE type_t.num10              #單身 總筆數(所有資料)
DEFINE g_detail_d  DYNAMIC ARRAY OF type_g_detail_d
 
#add-point:傳入參數說明
 TYPE type_master RECORD
       xrdasite LIKE type_t.chr10, 
   xrdasite_desc LIKE type_t.chr80, 
   xrdald LIKE type_t.chr5, 
   xrdald_desc LIKE type_t.chr80, 
   xrdacomp_desc LIKE type_t.chr500, 
   xrdadocno LIKE type_t.chr20, 
   xrdadocno_desc LIKE type_t.chr80, 
   xrda003 LIKE type_t.chr500, 
   xrda003_desc LIKE type_t.chr80, 
   xrdadocdt LIKE type_t.dat, 
   xrca063 LIKE type_t.chr500, 
   chk LIKE type_t.chr500, 
   diff LIKE type_t.chr500, 
   stagenow LIKE type_t.chr80,
       wc               STRING
       END RECORD
 
#模組變數(Module Variables)
DEFINE g_master type_master
DEFINE g_detail2_d   DYNAMIC ARRAY OF type_g_detail2
DEFINE g_detail2_t   type_g_detail2
DEFINE g_glaa            RECORD LIKE glaa_t.*
DEFINE g_ls              LIKE type_t.chr1
DEFINE g_wc1             STRING
DEFINE g_wc3             STRING
DEFINE g_wc_ar           STRING
DEFINE g_wc_nm           STRING
DEFINE g_wc_ap           STRING
DEFINE g_xrdadocno       LIKE xrda_t.xrdadocno
DEFINE g_amt1            LIKE xrce_t.xrce109
 TYPE type_g_nmbb_d        RECORD
       nmbb026 LIKE nmbb_t.nmbb026
     END RECORD  
DEFINE g_nmbb026_d         DYNAMIC ARRAY OF type_g_nmbb_d
DEFINE g_cnt1             LIKE type_t.num5
DEFINE g_cnt2             LIKE type_t.num5
DEFINE g_cnt3             LIKE type_t.num5
DEFINE l_ac1              LIKE type_t.num10  
DEFINE l_ac2              LIKE type_t.num10 
DEFINE g_rec_b        LIKE type_t.num5 
DEFINE g_rec_b1       LIKE type_t.num5
DEFINE l_cnt          LIKE type_t.num5
DEFINE g_detail_idx   LIKE type_t.num5

TYPE type_g_detail_s RECORD
   diff1 LIKE type_t.chr1,
   xrdadocno LIKE xrda_t.xrdadocno,
   amt1 LIKE xrcc_t.xrcc108,
   amt2 LIKE xrcc_t.xrcc108,
   amt3 LIKE xrcc_t.xrcc108
       END RECORD
DEFINE g_detail_s   DYNAMIC ARRAY OF type_g_detail_s

DEFINE g_amt        LIKE type_t.num10   #151125-00006#1---add by aiqq
DEFINE g_amt_xrde119      LIKE xrde_t.xrde119   #161013-00003#2 Add
DEFINE g_amt_xrce119      LIKE xrce_t.xrce119   #161013-00003#2 Add
#end add-point
 
{</section>}
 
{<section id="axrp400.main" >}
#+ 作業開始 
MAIN
   DEFINE ls_js  STRING
   #add-point:main段define
   DEFINE l_success         LIKE type_t.num5   #151125-00006#1---add
   #end add-point   
   #add-point:main段define
   
   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("axr","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   #151125-00006#1---add---s
   CALL s_fin_create_account_center_tmp()
   CALL s_voucher_cre_ar_tmp_table() RETURNING l_success    
   CALL s_pre_voucher_cre_tmp_table() RETURNING l_success 
   CALL s_fin_continue_no_tmp() 
   #151125-00006#1---add---e
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_axrp400 WITH FORM cl_ap_formpath("axr",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL axrp400_init()   
 
      #進入選單 Menu (="N")
      CALL axrp400_ui_dialog() 
 
      #add-point:畫面關閉前
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_axrp400
   END IF 
   
   #add-point:作業離開前
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="axrp400.init" >}
#+ 畫面資料初始化
PRIVATE FUNCTION axrp400_init()
   #add-point:init段define
 
   #end add-point   
   #add-point:init段define
   
   #end add-point   
   
   LET g_error_show  = 1
   LET g_wc_filter   = " 1=1"
   LET g_wc_filter_t = " 1=1"
 
   #add-point:畫面資料初始化
   CALL axrp400_create_tmp_table()
  #CALL cl_set_combo_scc('b_xrca001','8302')
   CALL cl_set_combo_scc('b_nmbb029','8310')
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="axrp400.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION axrp400_ui_dialog()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE li_idx1           LIKE type_t.num10
   DEFINE l_n               LIKE type_t.num10
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_xrdasite        LIKE xrda_t.xrdasite
   DEFINE l_xrdald          LIKE xrda_t.xrdald
   DEFINE l_xrda003         LIKE xrda_t.xrda003
   DEFINE l_xrdadocdt       LIKE xrda_t.xrdadocdt
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_success_1    LIKE type_t.num5
   DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                   oofg019     LIKE oofg_t.oofg019,   #field
                   oofg020     LIKE oofg_t.oofg020    #value
                           END RECORD
   DEFINE l_origin_str      STRING
   #end add-point 
   #add-point:ui_dialog段define
   
   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 
   CALL axrp400_ui_dialog_1()
   RETURN
   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL axrp400_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
          

         #end add-point
         #add-point:ui_dialog段input
       
#         INPUT ARRAY g_detail_d FROM s_detail1.* 
#              ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
#                        INSERT ROW = FALSE,
#                        DELETE ROW = FALSE,
#                        APPEND ROW = FALSE)
#            BEFORE INPUT
#               IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
#                 CALL FGL_SET_ARR_CURR(g_detail_d.getLength()+1) 
#                 LET g_insert = 'N' 
#               END IF 
#             
#            BEFORE ROW
#               LET l_ac = ARR_CURR()
#               LET g_master_idx = l_ac
#               DISPLAY l_ac TO FORMONLY.h_index
#               CALL axrp400_fetch()              
#               
#            ON CHANGE sel
#               UPDATE axrp400_tmp 
#                  SET sel = g_detail_d[l_ac].sel 
#                WHERE nmbbdocno = g_detail_d[l_ac].nmbbdocno  
#                  AND nmbbseq = g_detail_d[l_ac].nmbbseq
#                  
#         END INPUT
         

#          INPUT ARRAY g_detail2_d FROM s_detail2.* 
#              ATTRIBUTE(COUNT = g_rec_b1,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
#                        INSERT ROW = FALSE,
#                        DELETE ROW = FALSE,
#                        APPEND ROW = FALSE)
#            BEFORE INPUT
#                LET g_rec_b = g_detail2_d.getLength()
#                CALL cl_set_comp_entry("xrcadocno,xrccseq,xrcc001,xrcasite,xrca003,xrca005,xrcald",FALSE)
#             
#            BEFORE ROW
#               LET l_ac1 = ARR_CURR()
#               LET g_master_idx = l_ac1
#               DISPLAY l_ac TO FORMONLY.h_index
#               CALL axrp400_fetch()              
#               
#            ON CHANGE sel1
#            
#               UPDATE axrp400_tmp 
#                  SET sel1 = g_detail2_d[l_ac1].sel1
#                WHERE xrcadocno = g_detail2_d[l_ac1].xrcadocno  
#                  AND xrccseq = g_detail2_d[l_ac1].xrccseq    
#                  AND xrcc001 = g_detail2_d[l_ac1].xrcc001
#            
#         END INPUT
         #end add-point
         #add-point:ui_dialog段自定義display array
         #應用 a58 樣板自動產生(Version:2)
         
         DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_cnt = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_cnt
         
         END DISPLAY
         DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               LET g_current_page = 1
 
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
               LET l_cnt = g_detail_idx
               DISPLAY g_detail_idx TO FORMONLY.h_index
               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
               LET g_master_idx = l_cnt

            
               
         END DISPLAY

         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            CALL axrp400_construct()
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall
            
            #end add-point            
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 1)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "Y"
#               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
               UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 0)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "N"
#               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
               UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "Y"
                  UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                   WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                     AND nmbbseq = g_detail_d[li_idx].nmbbseq
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  LET g_detail2_d[li_idx1].sel1 = "Y"
#                  UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
                  UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                   WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                     AND xrccseq = g_detail2_d[li_idx1].xrccseq
                     AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               END IF
            END FOR
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET g_detail_d[li_idx].sel = "N"
                  UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                   WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                     AND nmbbseq = g_detail_d[li_idx].nmbbseq
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  LET g_detail2_d[li_idx1].sel1 = "N"
#                  UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
                  UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                   WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                     AND xrccseq = g_detail2_d[li_idx1].xrccseq
                     AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               END IF
            END FOR
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL axrp400_filter()
            #add-point:ON ACTION filter
            
            #END add-point
            EXIT DIALOG
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            EXIT DIALOG
 
         ON ACTION accept
            #add-point:ui_dialog段accept之前
            
            #end add-point
            CALL axrp400_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            
            #end add-point
            CALL axrp400_b_fill()
 
         #add-point:ui_dialog段action
         ON ACTION batch_execute
            SELECT COUNT(*) INTO l_n
              FROM axrp400_tmp
             WHERE (sel = 'Y' OR sel1 = 'Y')
            IF l_n = 0 THEN 
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = 'axr-00159' 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               
               EXIT DIALOG
            END IF
            
            CALL axrp400_get_ar()
            
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
{</section>}
 
{<section id="axrp400.query" >}
#+ QBE資料查詢
PRIVATE FUNCTION axrp400_query()
   DEFINE ls_wc      STRING
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define
   
   #end add-point 
   #add-point:query段define
   
   #end add-point 
    
   #add-point:cs段after_construct
   RETURN
   #end add-point
        
   LET g_error_show = 1
   CALL axrp400_b_fill()
   LET l_ac = g_master_idx
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
 
   END IF
   
   #add-point:cs段after_query
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="axrp400.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION axrp400_b_fill()
 
   DEFINE ls_wc           STRING
   #add-point:b_fill段define
   DEFINE l_sql       STRING
   DEFINE l_sql1      STRING
   DEFINE ls_ac         LIKE type_t.num5
   DEFINE l_cmd         LIKE type_t.num5
   DEFINE l_flag        LIKE type_t.chr1
   DEFINE l_str         STRING
   DEFINE l_sub_sql     STRING
   DEFINE ls_wc1        STRING
   DEFINE ls_wc2        STRING
   DEFINE ls_wc3        STRING
   DEFINE l_success     LIKE type_t.num5  
   DEFINE l_n           LIKE xrde_t.xrde109
   DEFINE l_n1          LIKE xrde_t.xrde109
   #end add-point
   #add-point:b_fill段define
   
   #end add-point
 
   #add-point:b_fill段sql_before
   LET g_wc1 = cl_replace_str(g_wc1,'b_nmbb','nmbb')
   LET g_wc1 = cl_replace_str(g_wc1,'b_nmba','nmba')
  #160620-00010#1 Add  ---(S)---
   LET g_wc_filter = cl_replace_str(g_wc_filter,'b_nmbb','nmbb')
   LET g_wc_filter = cl_replace_str(g_wc_filter,'b_nmbb','nmbb')
   IF cl_null(g_wc_filter) THEN LET g_wc_filter = " 1=1" END IF
  #160620-00010#1 Add  ---(E)---
   CASE
      WHEN g_ls = '1'
         LET ls_wc = "nmbb006 > nmbb008"
      WHEN g_ls = '2'
         LET ls_wc = "nmbb020 > nmbb021"
      WHEN g_ls = '3'
         LET ls_wc = "nmbb023 > nmbb024"
   END CASE
   
   LET l_sql = " SELECT 'N',nmbbdocno,nmbbseq,nmbb026,'',nmbadocdt,nmbb029,nmbb004,nmbb006,nmbb006-nmbb008, ",
               "         nmba008,'',nmbb031,nmbb030,nmbb040,nmbb003,'',nmbb005,nmbb009 "

  #160607-00015#2  Add  ---(S)---
   LET ls_wc1 = " NOT EXISTS (SELECT 1 FROM isba_t,isbb_t WHERE isbaent = isbbent AND isbadocno = isbbdocno ",
                " AND isbacomp = isbbcomp AND isbbent = nmbbent AND isbastus <> 'X' ",
                " AND isbb002 = nmbbdocno AND isbb003 = nmbbseq)"
  #160607-00015#2  Add  ---(E)---

   LET g_sql = l_sql CLIPPED ,
               "  FROM nmba_t,nmbb_t ",
	            " WHERE nmbbent = nmbaent ",
               "   AND nmbbcomp = nmbacomp ",
               "   AND nmbbdocno = nmbadocno",
               "   AND nmbaent = ?",
	            "   AND nmbbcomp = '",g_glaa.glaacomp,"'",
	            "   AND nmbastus = 'Y' ",
	            "   AND nmbb001= '1' ",
               "   AND nmbadocdt <= '",g_master.xrdadocdt,"'",
               "   AND nmba003 ='anmt510'",
               "   AND nmbb029 IN ('10','30')",
               "   AND ",ls_wc CLIPPED,
               "   AND ",g_wc1 CLIPPED,
               "   AND ",g_wc_filter CLIPPED,   #160620-00010#1  Add
               "   AND ",ls_wc1 CLIPPED,        #160607-00015#2  Add
               " UNION ",
               l_sql CLIPPED,
               "  FROM nmba_t,nmbb_t,ooia_t ",
               " WHERE nmbbent = nmbaent ",
               "   AND nmbbcomp = nmbacomp ",
               "   AND nmbbdocno = nmbadocno",
               "   AND nmbbent = nmbaent AND nmbb028 = ooia001 ",
               #"   AND (ooia002 = '10' OR ooia002 = '20')",
               "   AND (ooia002 = '10' OR ooia002 = '20' OR ooia002 = '30')",   #160901-00020#1 mod
               "   AND nmbaent = ",g_enterprise,
	            "   AND nmbbcomp = '",g_glaa.glaacomp,"'",
	            "   AND (nmbastus = 'Y' OR nmbastus = 'V')",
	            "   AND nmbb001= '1' ",
               "   AND nmbadocdt <= '",g_master.xrdadocdt,"'",
               "   AND nmba003 = 'anmt540'",
               "   AND nmbb029 IN ('10','20','30')",   #160329-00029#1 add '20'
               "   AND ",ls_wc CLIPPED,
               "   AND ",g_wc1 CLIPPED,
               "   AND ",ls_wc1 CLIPPED,        #160607-00015#2  Add
               "   AND ",g_wc_filter CLIPPED   #160620-00010#1  Add
   #end add-point
 
   PREPARE axrp400_sel FROM g_sql
   DECLARE b_fill_curs CURSOR FOR axrp400_sel
   
   CALL g_detail_d.clear()
   #add-point:b_fill段其他頁簽清空
   LET g_wc_filter = " 1=1"  #160620-00010#1  Add
   DELETE FROM axrp400_tmp   #160620-00010#1  Add
   #end add-point
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs USING g_enterprise INTO 
   #add-point:b_fill段foreach_into
   g_detail_d[l_ac].*
   #end add-point
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      CALL s_axrt300_xrca_ref('xrca003',g_detail_d[l_ac].nmba008,'','') RETURNING l_success,g_detail_d[l_ac].nmba008_desc
      CALL s_axrt300_xrca_ref('xrca005',g_detail_d[l_ac].nmbb026,'','') RETURNING l_success,g_detail_d[l_ac].nmbb026_desc
      
      SELECT nmaal003 INTO g_detail_d[l_ac].nmbb003_desc FROM nmaal_t WHERE nmaalent=g_enterprise AND nmaal001=g_detail_d[l_ac].nmbb003 AND nmaal002=g_dlang
      #160530-00017#1  2016/06/12 By 07900 -add -str      
      LET l_n1 =0
      LET l_n =0
      SELECT SUM(xrde109) INTO l_n
        FROM xrde_t,xrda_t
       WHERE xrdeent = xrdaent AND xrdald = xrdeld AND xrdadocno = xrdedocno 
         AND xrde003 = g_detail_d[l_ac].nmbbdocno AND xrde004 = g_detail_d[l_ac].nmbbseq AND xrdastus='N' AND xrdeent = g_enterprise
       IF cl_null(l_n) THEN
          LET l_n =0  
       END IF
       
      SELECT SUM(xrde109) INTO l_n1
        FROM xrde_t,xrca_t
       WHERE xrdeent = xrcaent AND xrdeld = xrcald AND xrdedocno = xrcadocno 
         AND xrde003 = g_detail_d[l_ac].nmbbdocno AND xrde004 = g_detail_d[l_ac].nmbbseq AND xrcastus='N' AND xrdeent = g_enterprise  
       IF cl_null(l_n1) THEN
          LET l_n1 =0  
       END IF 
       
      
       
       IF g_detail_d[l_ac].nmbb008-l_n-l_n1 <=0 THEN
          CONTINUE FOREACH
       END IF     
              
        #调整 未冲销金额,本币金额
       LET g_detail_d[l_ac].nmbb008 = g_detail_d[l_ac].nmbb008 -l_n-l_n1
       LET g_detail_d[l_ac].nmbb009 = g_detail_d[l_ac].nmbb008 * g_detail_d[l_ac].nmbb005       
      #160530-00017#1  2016/06/12 By 07900 -add -end
      
      INSERT INTO axrp400_tmp(sel,nmbbdocno,nmbbseq,nmbb026) 
        VALUES(g_detail_d[l_ac].sel,g_detail_d[l_ac].nmbbdocno,g_detail_d[l_ac].nmbbseq,g_detail_d[l_ac].nmbb026)
      #end add-point
      
      CALL axrp400_detail_show()      
 
      LET l_ac = l_ac + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   LET g_error_show = 0
   
   #add-point:b_fill段資料填充(其他單身)
   CALL g_detail_d.deleteElement(g_detail_d.getLength())
   #end add-point
    
   LET g_detail_cnt = l_ac - 1 
   DISPLAY g_detail_cnt TO FORMONLY.h_count
   LET l_ac = g_cnt
   LET g_cnt = 0
   
   CLOSE b_fill_curs
   FREE axrp400_sel
   
   LET l_ac = 1
   CALL axrp400_fetch()
   #add-point:b_fill段資料填充(其他單身)
   CALL axrp400_b_fill1()
   DISPLAY 0,0,0 TO sum5,sum6,sum7 #161003-00015#1 add
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="axrp400.fetch" >}
#+ 單身陣列填充2
PRIVATE FUNCTION axrp400_fetch()
 
   DEFINE li_ac           LIKE type_t.num10
   #add-point:fetch段define
   
   #end add-point
   #add-point:fetch段define
   
   #end add-point
   
   LET li_ac = l_ac 
   
   #add-point:單身填充後
 
   #end add-point 
   
   LET l_ac = li_ac
   
END FUNCTION
 
{</section>}
 
{<section id="axrp400.detail_show" >}
#+ 顯示相關資料
PRIVATE FUNCTION axrp400_detail_show()
   #add-point:show段define
   
   #end add-point
   #add-point:show段define
   
   #end add-point
   
   #add-point:detail_show段
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="axrp400.filter" >}
#+ filter過濾功能
PRIVATE FUNCTION axrp400_filter()
   #add-point:filter段define
   DEFINE l_str         STRING
   {   #160620-00010#1 Add
   #end add-point    
   #add-point:filter段define
   
   #end add-point    
   
   DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt)
      ON UPDATE
 
   END DISPLAY
 
   LET l_ac = 1
   LET g_detail_cnt = 1
   #add-point:filter段define
   }   #160620-00010#1 Add
  #160620-00010#1 Mark ---(S)---
  #DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt)
  #   ON UPDATE
  #
  #END DISPLAY
  #160620-00010#1 Mark ---(S)---

  #160620-00010#1 Add  ---(S)---
   CALL cl_set_act_visible("accept,cancel", FALSE)
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         CONSTRUCT BY NAME g_wc_filter ON b_nmbbdocno,b_nmbbseq,b_nmbb026,b_nmbadocdt,b_nmbb029,b_nmbb004,b_nmba008,b_nmbb031,b_nmbb030,b_nmbb003
             BEFORE CONSTRUCT

         ON ACTION controlp INFIELD b_nmbbdocno
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " nmbbcomp = '",g_glaa.glaacomp,"'"
            CALL q_nmbbdocno()                           #呼叫開窗
            LET g_qryparam.where = ""
            DISPLAY g_qryparam.return1 TO b_nmbbdocno    #顯示到畫面上
            NEXT FIELD b_nmbbdocno                       #返回原欄位

         ON ACTION controlp INFIELD b_nmbb026
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_glaa.glaacomp
            CALL q_pmaa001_13()                          #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb026      #顯示到畫面上
            NEXT FIELD b_nmbb026                         #返回原欄位

         ON ACTION controlp INFIELD b_nmbb004
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_aooi001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb004      #顯示到畫面上
            NEXT FIELD b_nmbb004                         #返回原欄位

         ON ACTION controlp INFIELD b_nmba008
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                             #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmba008      #顯示到畫面上
            NEXT FIELD b_nmba008                         #返回原欄位

         ON ACTION controlp INFIELD b_nmbb030
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_nmbb030_02()                          #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb030      #顯示到畫面上
            NEXT FIELD b_nmbb030                         #返回原欄位

         ON ACTION controlp INFIELD b_nmbb003
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_nmas_01()                             #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb003      #顯示到畫面上
            NEXT FIELD b_nmbb003                         #返回原欄位

         END CONSTRUCT

        CONSTRUCT BY NAME g_wc_filter2 ON flag,b_xrcadocno,b_xrccseq,b_xrcc001,b_xrcasite,b_xrca003,b_xrca005,b_xrcald
           BEFORE CONSTRUCT

           AFTER FIELD flag
            CALL FGL_DIALOG_GETBUFFER() RETURNING l_str

            ON ACTION controlp INFIELD b_xrcadocno
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
			      IF l_str = "flag='1'" OR l_str = " 1=1" OR cl_null(l_str) THEN
                  LET g_qryparam.where= "xrcadocdt <= '",g_master.xrdadocdt,"'",
                                        " AND xrca001 NOT IN ('01','02','03','04','31','141','142')",
                                        " AND xrcald ='",g_master.xrdald,"'",
                                        " AND xrcadocno IN (SELECT UNIQUE xrcadocno FROM axrp400_cum_tmp )"
                  CALL q_xrcadocno_12()                         #呼叫開窗
               ELSE
                  LET g_qryparam.where= "apcadocdt <= '",g_master.xrdadocdt,"'",
                                        " AND apcald ='",g_master.xrdald,"'",
                                        " AND apcadocno IN (SELECT UNIQUE xrcadocno FROM axrp400_cum_tmp )"
                  CALL q_apcadocno_14()
               END IF
               DISPLAY g_qryparam.return1 TO b_xrcadocno      #顯示到畫面上
               LET g_qryparam.where=NULL
               NEXT FIELD b_xrcadocno                        #返回原欄位

            ON ACTION controlp INFIELD b_xrcasite
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               #CALL q_ooef001()                           #呼叫開窗   #161021-00050#3 mark
               CALL q_ooef001_46()                                    #161021-00050#3 add
               DISPLAY g_qryparam.return1 TO b_xrcasite    #顯示到畫面上
               NEXT FIELD b_xrcasite                       #返回原欄位

            ON ACTION controlp INFIELD b_xrca003
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
               CALL q_ooag001()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca003      #顯示到畫面上
               NEXT FIELD b_xrca003                      #返回原欄位

            ON ACTION controlp INFIELD b_xrca005
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_glaa.glaacomp
               CALL q_pmaa001_13()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca005      #顯示到畫面上
               NEXT FIELD b_xrca005                      #返回原欄位

            ON ACTION controlp INFIELD b_xrcald
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_authorised_ld()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrcald     #顯示到畫面上
               NEXT FIELD b_xrcld                      #返回原欄位

         END CONSTRUCT

      ON ACTION qbe_select      
 
      ON ACTION qbe_save       
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG

   CALL cl_set_act_visible("accept,cancel", TRUE)
  #160620-00010#1 Add  ---(E)---

   CALL axrp400_filter_show('b_nmbbdocno','b_nmbbdocno')
   CALL axrp400_filter_show('b_nmbbseq','b_nmbbseq')
   CALL axrp400_filter_show('b_nmbb026','b_nmbb026')
   CALL axrp400_filter_show('b_nmbadocdt','b_nmbadocdt')
   CALL axrp400_filter_show('b_nmbb029','b_nmbb029')
   CALL axrp400_filter_show('b_nmbb004','b_nmbb004')
   CALL axrp400_filter_show('b_nmba008','b_nmba008')
   CALL axrp400_filter_show('b_nmbb031','b_nmbb031')
   CALL axrp400_filter_show('b_nmbb030','b_nmbb030')
   CALL axrp400_filter_show('b_nmbb003','b_nmbb003')
   CALL axrp400_filter_show('flag','flag')
   CALL axrp400_filter_show('b_xrcadocno','b_xrcadocno')
   CALL axrp400_filter_show('b_xrccseq','b_xrccseq')
   CALL axrp400_filter_show('b_xrcc001','b_xrcc001')
   CALL axrp400_filter_show('b_xrcasite','b_xrcasite')
   CALL axrp400_filter_show('b_xrca003','b_xrca003')
   CALL axrp400_filter_show('b_xrca005','b_xrca005')
   CALL axrp400_filter_show('b_xrcald','b_xrcald')
 
   #end add-point    
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter
   LET g_wc_t = g_wc
   
   LET g_wc = cl_replace_str(g_wc, g_wc_filter, '')
   
   CALL axrp400_b_fill()
   
END FUNCTION
 
{</section>}
 
{<section id="axrp400.filter_parser" >}
#+ filter欄位解析
PRIVATE FUNCTION axrp400_filter_parser(ps_field)
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define
   
   #end add-point    
   #add-point:filter段define
   
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="axrp400.filter_show" >}
#+ Browser標題欄位顯示搜尋條件
PRIVATE FUNCTION axrp400_filter_show(ps_field,ps_object)
   DEFINE ps_field         STRING
   DEFINE ps_object        STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.", ps_object
 
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = axrp400_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="axrp400.other_function" readonly="Y" >}
#add-point:自定義元件(Function)

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_xrdasite_chk(p_site,p_user,p_ld)
   DEFINE p_site      LIKE xrda_t.xrdasite
   DEFINE p_user      LIKE xrca_t.xrca003
   DEFINE p_ld        LIKE xrca_t.xrcald
   DEFINE l_ooeastus  LIKE ooea_t.ooeastus
   DEFINE l_xrahstus  LIKE xrah_t.xrahstus
   DEFINE l_xrah007   LIKE xrah_t.xrah007
   DEFINE l_ooagstus  LIKE ooag_t.ooagstus
   DEFINE l_cnt       LIKE type_t.num5
   DEFINE l_success   LIKE type_t.num5
   
   LET g_errno = ' '
   
   IF cl_null(p_site) THEN RETURN END IF
   IF cl_null(p_ld)   THEN RETURN END IF
   
   #帳套下屬於法人否檢查
    SELECT COUNT(*) INTO l_cnt FROM glaa_t,ooef_t,xrah_t 
    WHERE glaald   = p_ld
      AND glaacomp = ooef017 
      AND glaaent  = ooefent 
      AND ooef001  = xrah004 
      AND ooefent  = xrahent 
      AND xrah002  = p_site
      AND xrah001  = 1
      
   IF l_cnt < 1 OR cl_null(l_cnt) THEN
      LET g_errno = 'axr-00089' RETURN
   END IF
   
   IF cl_null(p_user) THEN RETURN g_errno END IF
   
   #人員對應帳套使用權限檢查
   IF NOT cl_null(p_ld) AND NOT cl_null(p_user) THEN
      CALL s_ld_chk_authorization(p_user,p_ld) 
         RETURNING l_success
      IF l_success = FALSE THEN
         LET g_errno = 'axr-00022' RETURN
      END IF
   END IF
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_xrda_dis(p_lab)
   DEFINE p_lab             LIKE type_t.chr10
   DEFINE l_xrcacomp_desc   LIKE type_t.chr80
   DEFINE l_success         LIKE type_t.chr1

   CASE
      WHEN p_lab = 'site'
         CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdasite,'','') RETURNING l_success,g_master.xrdasite_desc
         DISPLAY BY NAME g_master.xrdasite_desc

      WHEN p_lab = 'ld'
         CALL s_axrt300_xrca_ref('xrcald',g_master.xrdald,'','') RETURNING l_success,g_master.xrdald_desc
         SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
         LET g_master.xrdacomp_desc = g_glaa.glaacomp
         CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdacomp_desc,'','') RETURNING l_success,l_xrcacomp_desc
         IF NOT cl_null(g_master.xrdacomp_desc) THEN LET g_master.xrdacomp_desc = g_master.xrdacomp_desc,'(',l_xrcacomp_desc,')' END IF
         CALL s_axrt300_sel_ld(g_master.xrdald) RETURNING l_success,g_ls
         DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc

   END CASE
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_def()
   DEFINE l_xrcacomp_desc         LIKE type_t.chr500
   DEFINE l_success               LIKE type_t.chr1
   DEFINE l_cnt                   LIKE type_t.num5
   DEFINE l_sql                   STRING
   DEFINE l_xrcacomp              LIKE xrca_t.xrcacomp

   IF cl_null(g_master.diff) THEN LET g_master.diff = '1' END IF
   IF cl_null(g_master.chk) THEN LET g_master.chk = 'N' END IF
   
   #帳務中心
   #取得預設的帳務中心,因新增階段的時候,並不會知道site,所以以登入人員做為依據
   CALL s_fin_get_account_center('',g_user,'3',g_today) RETURNING l_success,g_master.xrdasite,g_errno
   #該帳務中心與帳別無法勾稽到,以登入人員g_user取得預設帳別/法人
   CALL s_fin_orga_get_comp_ld(g_master.xrdasite) RETURNING l_success,g_errno,l_xrcacomp,g_master.xrdald
    
   #若取不出資料,則不預設帳別
   IF NOT l_success THEN
      LET g_master.xrdald   = ''
   END IF
   CALL s_axrt300_sel_ld(g_master.xrdald) RETURNING l_success,g_ls
   SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
   LET g_master.xrdacomp_desc = g_glaa.glaacomp

   CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdasite,'','') RETURNING l_success,g_master.xrdasite_desc
   CALL s_axrt300_xrca_ref('xrcald',g_master.xrdald,'','') RETURNING l_success,g_master.xrdald_desc
   CALL s_axrt300_xrca_ref('xrcasite',g_master.xrdacomp_desc,'','') RETURNING l_success,l_xrcacomp_desc
   IF NOT cl_null(g_master.xrdacomp_desc) THEN LET g_master.xrdacomp_desc = g_master.xrdacomp_desc,'(',l_xrcacomp_desc,')' END IF
   IF cl_null(g_master.xrda003) THEN LET g_master.xrda003_desc = '' END IF
   DISPLAY BY NAME g_master.xrda003_desc
   DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdasite_desc,g_master.xrdacomp_desc

   LET g_amt_xrde119 = 0   #161013-00003#2 Add
   LET g_amt_xrce119 = 0   #161013-00003#2 Add

END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ref_xrda003()
   SELECT ooag011 INTO g_master.xrda003_desc FROM ooag_t WHERE ooagent=g_enterprise AND ooag001=g_master.xrda003
   DISPLAY BY NAME g_master.xrda003,g_master.xrda003_desc
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_get_sql()
   DEFINE ls_ac         LIKE type_t.num5
   DEFINE l_cmd         LIKE type_t.num5
   DEFINE l_flag        LIKE type_t.chr1
   DEFINE l_str         STRING
   DEFINE l_sub_sql     STRING
   DEFINE ls_wc         STRING
   DEFINE ls_wc1        STRING
   DEFINE ls_wc2        STRING
   DEFINE ls_wc3        STRING

   #NM  資料的獲取
   LET g_wc_nm = "SELECT nmbbdocno,nmbbseq FROM axrp400_tmp ",
                 " WHERE nmbb026 = ? AND sel = 'Y' "
    
   #AR  資料的獲取
   #161013-00003#2 Mark ---(S)---
  #LET g_wc_ar = "SELECT xrcadocno,xrccseq,xrcc001",
  #              "  FROM axrp400_tmp",
  #              " WHERE nmbb026 = ? AND sel1 = 'Y' ",
  #              "   AND flag = '1'"
   #161013-00003#2 Mark ---(E)---
   #161013-00003#2 Mark ---(S)---
   LET g_wc_ar ="SELECT xrcadocno,xrccseq,xrcc001",
                "  FROM axrp400_cum_tmp",
                " WHERE xrca005 = ? AND sel1 = 'Y' ",
                "   AND flag = '1'"
   #161013-00003#2 Mark ---(E)---
                 
   #計算帳款部分
   #161013-00003#2 Mark ---(S)---
  #LET g_wc_ap ="SELECT xrcadocno,xrccseq,xrcc001",
  #             "  FROM axrp400_tmp",
  #             " WHERE nmbb026 = ? AND sel1 = 'Y' ",
  #             "   AND flag = '2'"
   #161013-00003#2 Mark ---(E)---
   #161013-00003#2 Mark ---(S)---
   LET g_wc_ap ="SELECT xrcadocno,xrccseq,xrcc001",
                "  FROM axrp400_cum_tmp",
                " WHERE xrca005 = ? AND sel1 = 'Y' ",
                "   AND flag = '2'"
   #161013-00003#2 Mark ---(E)---

   PREPARE axrp400_nm_prep FROM g_wc_nm
   DECLARE axrp400_nm_curs CURSOR FOR axrp400_nm_prep

   PREPARE axrp400_ar_prep FROM g_wc_ar
   DECLARE axrp400_ar_curs CURSOR FOR axrp400_ar_prep
   
   PREPARE axrp400_sel_apcc_prep FROM g_wc_ap
   DECLARE axrp400_sel_apcc_curs CURSOR FOR axrp400_sel_apcc_prep
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_get_ar()
   DEFINE l_sql          STRING 
   DEFINE l_nmbb026      LIKE nmbb_t.nmbb026
   DEFINE l_nmbb027      LIKE nmbb_t.nmbb027
   DEFINE l_nmbb004      LIKE nmbb_t.nmbb004
   DEFINE l_success      LIKE type_t.chr1
   DEFINE i              LIKE type_t.num5
   DEFINE j              LIKE type_t.num5
   DEFINE l_start_no     LIKE xrca_t.xrcadocno
   DEFINE l_end_no       LIKE xrca_t.xrcadocno
   DEFINE l_xrdadocno    LIKE xrda_t.xrdadocno
   #151125-00006#1----add--s
   DEFINE  l_ooba002        LIKE ooba_t.ooba002
   DEFINE  l_slip_success   LIKE type_t.num5
   DEFINE  l_conf_success   LIKE type_t.num5
   DEFINE  l_dfin0031       LIKE type_t.chr1
   DEFINE  l_dfin0032       LIKE type_t.chr1
   DEFINE  l_gl_slip        LIKE ooba_t.ooba002 
   #151125-00006#1----add--e
   
   LET g_success = 'Y'
   LET j = 1
   LET l_start_no = '' 
   CALL axrp400_get_sql()
   DELETE FROM axrp400_s01_tmp
   LET l_sql = " SELECT UNIQUE nmbb026 FROM axrp400_tmp WHERE (sel='Y' OR sel1 = 'Y')",
               " UNION ",                                                                 #161013-00003#2 Add
               " SELECT UNIQUE xrca005 FROM axrp400_cum_tmp WHERE sel1 = 'Y'         "    #161013-00003#2 Add
   PREPARE axrp400_nmbb026_prep FROM l_sql
   DECLARE axrp400_nmbb026_curs CURSOR FOR axrp400_nmbb026_prep
   FOREACH axrp400_nmbb026_curs INTO g_nmbb026_d[j].*
      LET j = j + 1
   END FOREACH
   CALL g_nmbb026_d.deleteElement(g_nmbb026_d.getLength())
   LET j = j - 1
   CALL cl_err_collect_init()
   CALL s_transaction_begin()
   FOR i = 1 TO g_nmbb026_d.getLength() 
     #CALL s_transaction_begin()
      #資料匯入沖帳單單頭檔
      CALL axrp400_ins_xrda(g_nmbb026_d[i].nmbb026) RETURNING l_success

      #資料匯入沖帳單單身檔
      CALL axrp400_ins_xrce(g_nmbb026_d[i].nmbb026)
      CALL axrp400_get_amt()
      
      IF l_success = 'Y' AND g_success ='Y' THEN
         IF cl_null(l_start_no) THEN
            LET l_start_no = g_xrdadocno
         END IF
         LET l_end_no = g_xrdadocno
        #CALL s_transaction_end('Y','1')
      ELSE
        #CALL s_transaction_end('N','1')     
      END IF
      
   END FOR
   
   IF g_amt1 > 0 OR cl_null(g_amt1) THEN   #160530-00005#5 Add
      CALL axrp400_s01()
   END IF                                  #160530-00005#5 Add
   
  #LET g_success ='Y'
  #CALL s_transaction_begin()
   IF g_success ='Y' THEN
      #差异处理
      LET l_sql = " SELECT xrdadocno FROM axrp400_s01_tmp ",
                  "  WHERE diff1 = '2' ",
                  "    AND amt3 > 0"   #161013-00003#2 Add
      PREPARE axrp400_s01_diff_prep FROM l_sql
      DECLARE axrp400_s01_diff_curs CURSOR FOR axrp400_s01_diff_prep
      FOREACH axrp400_s01_diff_curs INTO l_xrdadocno
         CALL axrp400_ar_diff(l_xrdadocno)
      END FOREACH
      
      LET l_xrdadocno = ''
      DELETE FROM s_voucher_tmp09    #160727-00019#6  2016/07/28 By 08734     s_voucher_ar_tmp ——> s_voucher_tmp09       
      DELETE FROM s_voucher_tmp05     #160727-00019#6  2016/07/29 By 08734     s_voucher_ar_group ——> s_voucher_tmp05      
      DELETE FROM s_voucher_glbc
      #产生分录底稿
      LET l_sql = " SELECT UNIQUE xrdadocno FROM axrp400_s01_tmp "
      PREPARE axrp400_s01_diff_prep1 FROM l_sql
      DECLARE axrp400_s01_diff_curs1 CURSOR FOR axrp400_s01_diff_prep1
      FOREACH axrp400_s01_diff_curs1 INTO l_xrdadocno
         CALL s_pre_voucher_ins('AR','R20',g_master.xrdald,l_xrdadocno,g_master.xrdadocdt,'2') RETURNING l_success
         
        IF l_success THEN  
            LET g_success = 'Y'   
         ELSE
            LET g_success = 'N' 
         END IF
      END FOREACH
      
      CALL s_transaction_end('Y','0')
   ELSE
      LET l_start_no = ''
      CALL s_transaction_end('N','0')     
   END IF
   
   IF NOT cl_null(l_start_no) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00251'
      LET g_errparam.replace[1] = l_start_no
      LET g_errparam.replace[2] = l_end_no
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   
   
   #151125-00006#1---add---s  #执行立即审核及抛砖总账传票
   IF g_success = 'Y' THEN
      
      CALL s_aooi200_fin_get_slip(g_xrdadocno) RETURNING l_slip_success,l_ooba002
      CALL s_fin_get_doc_para(g_master.xrdald,g_glaa.glaacomp,l_ooba002,'D-FIN-0031') RETURNING l_dfin0031
      CALL s_fin_get_doc_para(g_master.xrdald,g_glaa.glaacomp,l_ooba002,'D-FIN-0032') RETURNING l_dfin0032
      CALL s_fin_get_doc_para(g_master.xrdald,g_glaa.glaacomp,l_ooba002,'D-FIN-2002') RETURNING l_gl_slip
      
      IF NOT cl_null(l_dfin0031) AND l_dfin0031 MATCHES '[Yy]' THEN 
         CALL axrp400_immediately_conf(l_start_no,l_end_no) RETURNING l_conf_success
      END IF  
      
      IF NOT cl_null(l_gl_slip) THEN 
         IF NOT cl_null(l_dfin0032) AND l_dfin0032 MATCHES '[Yy]' THEN           
                CALL axrp400_immediately_gen(l_start_no,l_end_no,l_gl_slip)
         END IF 
       ELSE
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "" 
         LET g_errparam.code   = "axr-00987" 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
    END IF 
   #151125-00006#1---add---e
   
   CALL cl_err_collect_show()
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ins_xrda(p_nmbb026)
   DEFINE p_nmbb026      LIKE nmbb_t.nmbb026
   DEFINE l_xrda         RECORD LIKE xrda_t.*
   DEFINE l_xrce         RECORD LIKE xrce_t.*
   DEFINE l_success      LIKE type_t.chr1
   DEFINE l_success_1    LIKE type_t.num5

   LET g_xrdadocno = ''

   CALL s_aooi200_fin_gen_docno(g_master.xrdald,g_glaa.glaa024,g_glaa.glaa003,g_master.xrdadocno,g_master.xrdadocdt,'axrt400')
   RETURNING l_success,g_xrdadocno
   IF l_success  = 0  THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00003'
      LET g_errparam.extend = g_xrdadocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF

   INITIALIZE l_xrda.* TO NULL

   LET l_xrda.xrdaent  = g_enterprise
   LET l_xrda.xrdacomp = g_glaa.glaacomp
   LET l_xrda.xrdald   = g_master.xrdald
   LET l_xrda.xrdadocno= g_xrdadocno
   LET l_xrda.xrdadocdt= g_master.xrdadocdt
   LET l_xrda.xrdasite = g_master.xrdasite
   LET l_xrda.xrda001  = '41'
   LET l_xrda.xrda003  = g_master.xrda003
   LET l_xrda.xrda004  = p_nmbb026
   LET l_xrda.xrda005  = p_nmbb026
   LET l_xrda.xrda006  = p_nmbb026
   LET l_xrda.xrda007  = '1'
   LET l_xrda.xrda008  = ''
  #LET l_xrda.xrda009  = g_conditions.xrda009
   LET l_xrda.xrda010  = ''
   LET l_xrda.xrda011  = g_master.diff
   LET l_xrda.xrda012  = ''
   LET l_xrda.xrda013  = 'Y'
   LET l_xrda.xrda014  = ''
   LET l_xrda.xrda015  = ''
   LET l_xrda.xrda016  = 0
   LET l_xrda.xrda017  = ''
   LET l_xrda.xrdastus = 'N'
   LET l_xrda.xrdaownid= g_user
   LET l_xrda.xrdaowndp= g_dept
   LET l_xrda.xrdacrtid= g_user
   LET l_xrda.xrdacrtdp= g_dept
   LET l_xrda.xrdacrtdt= cl_get_current()
   LET l_xrda.xrdamodid= ""
   LET l_xrda.xrdamoddt= ""
   IF NOT cl_null(g_master.xrca063) THEN
      LET l_xrda.xrda009 = g_master.xrca063
   END IF
   CALL s_aooi390_oofi_upd('14',l_xrda.xrda009) RETURNING l_success_1  
   INSERT INTO xrda_t VALUES (l_xrda.*)
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'xrda_t'
      LET g_errparam.extend = SQLCA.sqlcode
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET g_success = 'N'
   END IF

   RETURN g_success
END FUNCTION

################################################################################
# Descriptions...: 填充第二个单身
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_b_fill1()
   DEFINE l_success      LIKE type_t.num5
   DEFINE l_n            LIKE type_t.num5
   DEFINE l_flag         LIKE type_t.chr1
   DEFINE l_xrca001_desc LIKE type_t.chr80
   DEFINE l_sel1         LIKE type_t.chr1
   DEFINE l_n3           LIKE xrce_t.xrce109
   DEFINE l_n1           LIKE xrce_t.xrce109
   DEFINE l_n2           LIKE apce_t.apce109
   DEFINE ls_wc1         STRING                #160607-00015#2 Add
   
   LET g_wc2 = cl_replace_str(g_wc2,'apca','xrca')
   LET g_wc2 = cl_replace_str(g_wc2,'apcc','xrcc')
   LET g_wc2 = cl_replace_str(g_wc2,'b_xrca','xrca')
   LET g_wc2 = cl_replace_str(g_wc2,'b_xrcc','xrcc')
  #160620-00010#1 Add  ---(S)---
   LET g_wc_filter2 = cl_replace_str(g_wc_filter2,'b_xrca','xrca')
   LET g_wc_filter2 = cl_replace_str(g_wc_filter2,'b_xrcc','xrcc')
   IF cl_null(g_wc_filter2) THEN LET g_wc_filter2 = " 1=1" END IF
   DELETE FROM axrp400_cum_tmp
  #160620-00010#1 Add  ---(E)---

  #160607-00015#2  Add  ---(S)---
   LET ls_wc1 = " NOT EXISTS (SELECT 1 FROM isba_t,isbc_t WHERE isbaent = isbcent AND isbadocno = isbcdocno ",
                " AND isbacomp = isbccomp AND isbcent = xrccent AND isbastus <> 'X' ",
                " AND isbc007 = xrccdocno AND isbc008 = xrcc001)"
  #160607-00015#2  Add  ---(E)---

   #161013-00003#2 Mark ---(S)---
  ##AR  資料的獲取
  #LET g_sql = " SELECT 'N','1',xrcadocno,xrccseq,xrcc001,xrca001,xrcasite,'',xrca003,'',",
  #            "xrca005,'',xrcald,'',xrcadocdt,xrcc108,xrcc109,0,SUM(xrcc108 - xrcc109)", #160530-00017#1  Add 0
  #            "  FROM xrca_t,xrcb_t,xrcc_t",
  #            " WHERE xrcaent   = xrcbent   AND xrcaent   = xrccent",
  #            "   AND xrcadocno = xrcbdocno AND xrcadocno = xrccdocno",
  #            "   AND xrcald    = xrcbld    AND xrcald    = xrccld",
  #            "   AND xrcbseq   = xrccseq",
  #            "   AND xrcaent   = ",g_enterprise,
  #            "   AND xrca001 NOT IN ('01','02','03','04','31','141','142')",
  #            "   AND xrcald = '",g_master.xrdald,"'",
  #            "   AND xrcacomp = '",g_glaa.glaacomp,"'",
  #            "   AND xrcastus = 'Y' ",
  #            "   AND ", g_wc2 CLIPPED,
  #            "   AND ", ls_wc1 CLIPPED,   #160607-00015#2  Add
  #            " GROUP BY xrcadocno,xrccseq,xrcc001,xrca001,xrcasite,xrca003,xrca005,xrcald,xrcadocdt,xrcc108,xrcc109",
  #            " HAVING SUM(xrcc108 - xrcc109) > 0"
  #IF g_master.chk = 'Y' THEN
  #   LET g_wc2 = cl_replace_str(g_wc2,'xrca','apca')
  #   LET g_wc2 = cl_replace_str(g_wc2,'xrcc','apcc')
  #  #IF g_wc3 = "flag='2'" THEN
  #   LET g_sql = g_sql CLIPPED," UNION ",
  #            " SELECT 'N','2',apcadocno,apccseq,apcc001,apca001,apcasite,'',apca003,'',",
  #            "apca005,'',apcald,'',apcadocdt,apcc108,apcc109,0,SUM(apcc108 - apcc109)",  #160530-00017#1  Add 0
  #            "  FROM apcc_t,apca_t,gzcb_t",
  #            " WHERE apccent = ",g_enterprise,
  #            "   AND apccld = apcald",
  #            "   AND apccdocno = apcadocno",
  #            "   AND apccent = apcaent ",
  #            "   AND apcastus = 'Y'",
  #            "   AND apcacomp = '",g_glaa.glaacomp,"'",
  #            "   AND apcald = '",g_master.xrdald,"'",
  #            "   AND apca001 = gzcb002",
  #            "   AND gzcb003 = '1'",
  #            "   AND gzcb001 = '8502'",
  #            "   AND ", g_wc2 CLIPPED,
  #            "   AND apcc108 - apcc109 > 0",
  #            " GROUP BY apcadocno,apccseq,apcc001,apca001,apcasite,apca003,apca005,apcald,apcadocdt,apcc108,apcc109"
  #END IF
   #161013-00003#2 Mark ---(E)---
   #161013-00003#2 Add  ---(S)---
   #AR  資料的獲取
   LET g_sql = " SELECT 'N','1',xrcadocno,xrccseq,xrcc001,xrca001,xrcasite,'',xrca003,'',",
               "xrca005,'',xrcald,'',xrcadocdt,xrcc100,xrcc108,xrcc109,0,SUM(xrcc108 - xrcc109)",
               "  FROM xrca_t,xrcc_t",
               " WHERE xrcaent   = xrccent   AND xrcadocno = xrccdocno",
               "   AND xrcald    = xrccld    AND xrcaent   = ",g_enterprise,
               "   AND xrca001 NOT IN ('01','02','03','04','31','141','142')",
               "   AND xrcald = '",g_master.xrdald,"'",
               "   AND xrcacomp = '",g_glaa.glaacomp,"'",
               "   AND xrcastus = 'Y' ",
               "   AND ", g_wc2 CLIPPED,
               "   AND ", ls_wc1 CLIPPED,
               " GROUP BY xrcadocno,xrccseq,xrcc001,xrca001,xrcasite,xrca003,xrca005,xrcald,xrcadocdt,xrcc100,xrcc108,xrcc109",
               " HAVING SUM(xrcc108 - xrcc109) > 0"
   #AP  資料的獲取
   IF g_master.chk = 'Y' THEN
      LET g_wc2 = cl_replace_str(g_wc2,'xrca','apca')
      LET g_wc2 = cl_replace_str(g_wc2,'xrcc','apcc')
      LET g_sql = g_sql CLIPPED," UNION ",
               " SELECT 'N','2',apcadocno,apccseq,apcc001,apca001,apcasite,'',apca003,'',",
               "apca005,'',apcald,'',apcadocdt,apcc100,apcc108,apcc109,0,SUM(apcc108 - apcc109)",
               "  FROM apcc_t,apca_t,gzcb_t",
               " WHERE apccent = ",g_enterprise,
               "   AND apccld = apcald",
               "   AND apccdocno = apcadocno",
               "   AND apccent = apcaent ",
               "   AND apcastus = 'Y'",
               "   AND apcacomp = '",g_glaa.glaacomp,"'",
               "   AND apcald = '",g_master.xrdald,"'",
               "   AND apca001 = gzcb002",
               "   AND gzcb003 = '1'",
               "   AND gzcb001 = '8502'",
               "   AND ", g_wc2 CLIPPED,
               "   AND apcc108 - apcc109 > 0",
               " GROUP BY apcadocno,apccseq,apcc001,apca001,apcasite,apca003,apca005,apcald,apcc100,apcadocdt,apcc108,apcc109"
   END IF
   #161013-00003#2 Add  ---(E)---
   LET l_ac1 = 1
   PREPARE axrp400_sum_prep FROM g_sql
   DECLARE axrp400_sum_curs CURSOR FOR axrp400_sum_prep
   FOREACH axrp400_sum_curs INTO g_detail2_d[l_ac1].*
      SELECT COUNT(*) INTO l_n FROM axrp400_cum_tmp WHERE xrcadocno = g_detail2_d[l_ac1].xrcadocno
      IF l_n > 0 THEN 
         CONTINUE FOREACH 
      END IF
      #151013-00019#11 add ------
      #這裡取備註
      SELECT xrca053 INTO g_detail2_d[l_ac1].xrca053
        FROM xrca_t
       WHERE xrcaent = g_enterprise
         AND xrcald = g_master.xrdald
         AND xrcadocno = g_detail2_d[l_ac1].xrcadocno
      #151013-00019#11 add end---
      INSERT INTO axrp400_cum_tmp VALUES(g_detail2_d[l_ac1].*)
   END FOREACH
   
   SELECT COUNT(*) INTO l_n FROM axrp400_cum_tmp
   DISPLAY "axrp400_cum_tmp: ",l_n
   
   LET g_sql = "SELECT t1.* FROM axrp400_cum_tmp t1 ",
               " WHERE 1=1",
               "   AND ",g_wc_filter2 CLIPPED #160620-00010#1 Add
#               " LEFT OUTER JOIN axrp400_tmp t2 ON t1.xrcadocno = t2.xrcadocno ",
#               "   AND t1.xrccseq = t2.xrccseq AND t1.xrcc001 = t2.xrcc001 "
   
   PREPARE axrp400_sel1 FROM g_sql
   DECLARE b_fill_curs1 CURSOR FOR axrp400_sel1
   
   CALL g_detail2_d.clear()
   LET g_wc_filter2 = " 1=1"   #160620-00010#1 Add
   
   SELECT COUNT(*) INTO l_n FROM axrp400_cum_tmp t1 
    LEFT OUTER JOIN axrp400_tmp t2 ON t1.xrcadocno = t2.xrcadocno 
      AND t1.xrccseq = t2.xrccseq AND t1.xrcc001 = t2.xrcc001 
   DISPLAY "b_fill_curs1: ",l_n
   
   LET l_ac1 = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs1 INTO g_detail2_d[l_ac1].*
   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      #add-point:b_fill段資料填充
      IF g_detail2_d[l_ac1].flag = '1' THEN  #应收
        #CALL cl_set_combo_scc('b_xrca001','8302')
         SELECT gzcbl004 INTO l_xrca001_desc FROM gzcbl_t 
          WHERE gzcbl001 = '8302' 
            AND gzcbl002 = g_detail2_d[l_ac1].xrca001 AND gzcbl003 = g_dlang
          #160530-00017#1  2016/06/12 By 07900 -add -str      
           LET l_n1 =0
           LET l_n3 =0
           LET l_n2 =0 
           SELECT SUM(xrce109) INTO l_n3
             FROM xrce_t,xrda_t
            WHERE xrceent = xrdaent AND xrdald = xrceld AND xrdadocno = xrcedocno 
              AND xrce003 = g_detail2_d[l_ac1].xrcadocno AND xrce004 = g_detail2_d[l_ac1].xrccseq AND xrdastus='N' AND xrceent = g_enterprise
            IF cl_null(l_n3) THEN
               LET l_n3 =0  
            END IF
            
           SELECT SUM(xrce109) INTO l_n1
             FROM xrce_t,xrca_t
            WHERE xrceent = xrcaent AND xrceld = xrcald AND xrcedocno = xrcadocno 
              AND xrce003 = g_detail2_d[l_ac1].xrcadocno AND xrce004 = g_detail2_d[l_ac1].xrccseq AND xrcastus='N' AND xrceent = g_enterprise  
            IF cl_null(l_n1) THEN
               LET l_n1 =0  
            END IF 
            
            SELECT SUM(apce109) INTO l_n2
              FROM apce_t,apda_t
             WHERE apceent = apdaent AND apceld = apdald AND apcedocno=apdadocno
               AND apce003= g_detail2_d[l_ac1].xrcadocno AND apce004 = g_detail2_d[l_ac1].xrccseq AND apdastus='N' AND apceent= g_enterprise
             IF cl_null(l_n2) THEN
               LET l_n2 =0  
            END IF
                                         
            
            IF g_detail2_d[l_ac1].xrcc108 - g_detail2_d[l_ac1].xrcc109-l_n3-l_n1-l_n2 <=0 THEN
               CONTINUE FOREACH
            END IF  
            #调整原币未冲金额       
            LET g_detail2_d[l_ac1].xrcc108_1 = g_detail2_d[l_ac1].xrcc108_1-l_n3-l_n1-l_n2  
                          
           #160530-00017#1  2016/06/12 By 07900 -add -end    
           
      ELSE   #应付
        #CALL cl_set_combo_scc('b_xrca001','8502')
         SELECT gzcbl004 INTO l_xrca001_desc FROM gzcbl_t 
          WHERE gzcbl001 = '8502' 
            AND gzcbl002 = g_detail2_d[l_ac1].xrca001 AND gzcbl003 = g_dlang
         #160530-00017#1  2016/06/12 By 07900 -add -str      
           LET l_n1 =0
           LET l_n3 =0
           LET l_n2 =0 
           SELECT SUM(apce109) INTO l_n3
             FROM apce_t,apda_t
            WHERE apceent = apdaent AND apdald = apceld AND apdadocno = apcedocno 
              AND apce003 = g_detail2_d[l_ac1].xrcadocno AND apce004 = g_detail2_d[l_ac1].xrccseq AND apdastus='N' AND apceent = g_enterprise
            IF cl_null(l_n3) THEN
               LET l_n3 =0  
            END IF
            
           SELECT SUM(apce109) INTO l_n1
             FROM apce_t,apca_t
            WHERE apceent = apcaent AND apceld = apcald AND apcedocno = apcadocno 
              AND apce003 = g_detail2_d[l_ac1].xrcadocno AND apce004 = g_detail2_d[l_ac1].xrccseq AND apcastus='N' AND apceent = g_enterprise  
            IF cl_null(l_n1) THEN
               LET l_n1 =0  
            END IF 
            
            SELECT SUM(xrce109) INTO l_n2
              FROM xrce_t,xrda_t
             WHERE xrceent = xrdaent AND xrceld = xrdald AND xrcedocno=xrdadocno
               AND xrce003= g_detail2_d[l_ac1].xrcadocno AND xrce004 = g_detail2_d[l_ac1].xrccseq AND xrdastus='N' AND xrceent= g_enterprise
             IF cl_null(l_n2) THEN
               LET l_n2 =0  
            END IF
                  
                               
            IF g_detail2_d[l_ac1].xrcc108 - g_detail2_d[l_ac1].xrcc109-l_n3-l_n1-l_n2 <=0 THEN
               CONTINUE FOREACH
            END IF  
            #调整原币未冲金额       
            LET g_detail2_d[l_ac1].xrcc108_1 = g_detail2_d[l_ac1].xrcc108_1-l_n3-l_n1-l_n2  
            
           #160530-00017#1  2016/06/12 By 07900 -add -end    
      END IF
      LET g_detail2_d[l_ac1].xrcc109_1 = l_n1 + l_n2 + l_n3#160530-00017#1  Add
      LET g_detail2_d[l_ac1].xrca001 = g_detail2_d[l_ac1].xrca001,":",l_xrca001_desc
      CALL s_axrt300_xrca_ref('xrcasite',g_detail2_d[l_ac1].xrcasite,'','') RETURNING l_success,g_detail2_d[l_ac1].xrcasite_desc
      CALL s_axrt300_xrca_ref('xrcald',g_detail2_d[l_ac1].xrcald,'','') RETURNING l_success,g_detail2_d[l_ac1].xrcald_desc
      CALL s_axrt300_xrca_ref('xrca003',g_detail2_d[l_ac1].xrca003,'','') RETURNING l_success,g_detail2_d[l_ac1].xrca003_desc
      CALL s_axrt300_xrca_ref('xrca005',g_detail2_d[l_ac1].xrca005,'','') RETURNING l_success,g_detail2_d[l_ac1].xrca005_desc
      
      LET l_sel1 = 'N'
      SELECT sel1 INTO l_sel1 FROM axrp400_tmp
       WHERE xrcadocno = g_detail2_d[l_ac1].xrcadocno 
         AND xrccseq = g_detail2_d[l_ac1].xrccseq AND xrcc001 = g_detail2_d[l_ac1].xrcc001 
      LET g_detail2_d[l_ac1].sel1 = l_sel1
      IF cl_null(g_detail2_d[l_ac1].sel1) THEN LET g_detail2_d[l_ac1].sel1 = 'N' END IF
     
      INSERT INTO axrp400_tmp(nmbb026,sel1,xrcadocno,xrccseq,xrcc001,flag) 
         VALUES(g_detail2_d[l_ac1].xrca005,g_detail2_d[l_ac1].sel1,g_detail2_d[l_ac1].xrcadocno,
                g_detail2_d[l_ac1].xrccseq,g_detail2_d[l_ac1].xrcc001,g_detail2_d[l_ac1].flag)
      #end add-point
      
      CALL axrp400_detail_show()      
 
      LET l_ac1 = l_ac1 + 1
      IF l_ac1 > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   CALL g_detail2_d.deleteElement(g_detail2_d.getLength())
   LET g_error_show = 0

   CLOSE b_fill_curs1
   FREE axrp400_sel1
   
   LET l_ac1 = 1
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_create_tmp_table()
DEFINE r_success       LIKE type_t.num5

   DROP TABLE axrp400_tmp;
   CREATE TEMP TABLE axrp400_tmp(
      sel         LIKE type_t.chr1,
      nmbbdocno   LIKE nmbb_t.nmbbdocno,
      nmbbseq     LIKE nmbb_t.nmbbseq,
      nmbb026     LIKE nmbb_t.nmbb026,
      sel1        LIKE type_t.chr1,
      xrcadocno   LIKE xrca_t.xrcadocno,
      xrccseq     LIKE xrcc_t.xrccseq,
      xrcc001     LIKE xrcc_t.xrcc001,
      flag        LIKE type_t.chr1    #区分资料来源是AX还是AP
   );
   
   DROP TABLE axrp400_s01_tmp;
   CREATE TEMP TABLE axrp400_s01_tmp(
      diff1       LIKE type_t.chr1,
      xrdadocno   LIKE xrda_t.xrdadocno,
      amt1        LIKE xrcc_t.xrcc108,
      amt2        LIKE xrcc_t.xrcc108,
      amt3        LIKE xrcc_t.xrcc108
   );
     
   DROP TABLE axrp400_cum_tmp;
   CREATE TEMP TABLE axrp400_cum_tmp(
      sel1          LIKE type_t.chr1,
      flag          LIKE type_t.chr1,
      xrcadocno     LIKE xrca_t.xrcadocno,
      xrccseq       LIKE xrcc_t.xrccseq,
      xrcc001       LIKE xrcc_t.xrcc001,
      xrca001       LIKE type_t.chr80,
      xrcasite      LIKE xrca_t.xrcasite,
      xrcasite_desc LIKE type_t.chr80,
      xrca003       LIKE xrca_t.xrca003,
      xrca003_desc  LIKE type_t.chr80,
      xrca005       LIKE xrca_t.xrca005,
      xrca005_desc  LIKE type_t.chr80,
      xrcald        LIKE xrca_t.xrcald,
      xrcald_desc   LIKE type_t.chr80,
      xrcadocdt     LIKE xrca_t.xrcadocdt,
      xrcc100       LIKE xrcc_t.xrcc100,    #161013-00003#2 Add
      xrcc108       LIKE xrcc_t.xrcc108,
      xrcc109       LIKE xrcc_t.xrcc109,
      xrcc109_1     LIKE xrcc_t.xrcc109,    #160530-00017#1  Add
      xrcc108_1     LIKE xrcc_t.xrcc108,    #151013-00019#11 add ,
      xrca053       LIKE xrca_t.xrca053     #151013-00019#11
   );

  #160802-00006#1 Mark ---(S)---
  #DROP TABLE s_voucher_tmp09;      #160727-00019#6  2016/07/28 By 08734     s_voucher_ar_tmp ——> s_voucher_tmp09  
  #   
  #CREATE TEMP TABLE s_voucher_tmp09(       #160727-00019#6  2016/07/28 By 08734     s_voucher_ar_tmp ——> s_voucher_tmp09
  #   docno       LIKE glaq_t.glaqdocno,
  #   docdt       LIKE glap_t.glapdocdt,
  #   sw          LIKE type_t.chr1,
  #   glaqent     LIKE glaq_t.glaqent,
  #   glaqcomp    LIKE glaq_t.glaqcomp,
  #   glaqld      LIKE glaq_t.glaqld,
  #   glaq001     LIKE glaq_t.glaq001,
  #   glaq002     LIKE glaq_t.glaq002,
  #   glaq005     LIKE glaq_t.glaq005,
  #   glaq006     LIKE glaq_t.glaq006,
  #   glaq007     LIKE glaq_t.glaq007,
  #   glaq009     LIKE glaq_t.glaq009,
  #   glaq011     LIKE glaq_t.glaq011,
  #   glaq012     LIKE glaq_t.glaq012,
  #   glaq013     LIKE glaq_t.glaq013,
  #   glaq014     LIKE glaq_t.glaq014,
  #   glaq015     LIKE glaq_t.glaq015,
  #   glaq016     LIKE glaq_t.glaq016,
  #   glaq017     LIKE glaq_t.glaq017,
  #   glaq018     LIKE glaq_t.glaq018,
  #   glaq019     LIKE glaq_t.glaq019,
  #   glaq020     LIKE glaq_t.glaq020,
  #   glaq021     LIKE glaq_t.glaq021,
  #   glaq022     LIKE glaq_t.glaq022,
  #   glaq023     LIKE glaq_t.glaq023,
  #   glaq024     LIKE glaq_t.glaq024,
  #   glaq025     LIKE glaq_t.glaq025,
  #   glaq027     LIKE glaq_t.glaq027,
  #   glaq028     LIKE glaq_t.glaq028,
  #   glaq051     LIKE glaq_t.glaq051,  #經營方式
  #   glaq052     LIKE glaq_t.glaq052,  #渠道
  #   glaq053     LIKE glaq_t.glaq053,  #品牌
  #   glaq029     LIKE glaq_t.glaq029,
  #   glaq030     LIKE glaq_t.glaq030,
  #   glaq031     LIKE glaq_t.glaq031,
  #   glaq032     LIKE glaq_t.glaq032,
  #   glaq033     LIKE glaq_t.glaq033,
  #   glaq034     LIKE glaq_t.glaq034,
  #   glaq035     LIKE glaq_t.glaq035,
  #   glaq036     LIKE glaq_t.glaq036,
  #   glaq037     LIKE glaq_t.glaq037,
  #   glaq038     LIKE glaq_t.glaq038,
  #   glbc004     LIKE glbc_t.glbc004,  #现金变动码
  #   d           LIKE glaq_t.glaq003,
  #   c           LIKE glaq_t.glaq004,
  #   qty         LIKE glaq_t.glaq008,
  #   sum         LIKE glaq_t.glaq010,
  #   glaq039     LIKE glaq_t.glaq039,
  #   glaq040     LIKE glaq_t.glaq040,
  #   glaq041     LIKE glaq_t.glaq041,
  #   glaq042     LIKE glaq_t.glaq042,
  #   glaq043     LIKE glaq_t.glaq043,
  #   glaq044     LIKE glaq_t.glaq044,
  #   seq         LIKE glaq_t.glaqseq,
  #   source      LIKE type_t.chr100,
  #   glaqseq     LIKE glaq_t.glaqseq,
  #   xrca039     LIKE xrca_t.xrca039,
  #   b_glaq021   LIKE glaq_t.glaq021,
  #   b_glaq022   LIKE glaq_t.glaq022,
  #   red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh
  #);
  ##160727-00019#6  2016/07/29 By 08734     s_voucher_ar_group ——> s_voucher_tmp05
  #DROP TABLE s_voucher_tmp05;  
  ##160727-00019#6  2016/07/29 By 08734     s_voucher_ar_group ——> s_voucher_tmp05   
  #CREATE TEMP TABLE s_voucher_tmp05(   
  #   docno       LIKE glaq_t.glaqdocno,
  #   docdt       LIKE glap_t.glapdocdt,
  #   sw          LIKE type_t.chr1,
  #   glaqent     LIKE glaq_t.glaqent,
  #   glaqcomp    LIKE glaq_t.glaqcomp,
  #   glaqld      LIKE glaq_t.glaqld,
  #   glaq001     LIKE glaq_t.glaq001,
  #   glaq002     LIKE glaq_t.glaq002,
  #   glaq005     LIKE glaq_t.glaq005,
  #   glaq006     LIKE glaq_t.glaq006,
  #   glaq007     LIKE glaq_t.glaq007,
  #   glaq009     LIKE glaq_t.glaq009,
  #   glaq011     LIKE glaq_t.glaq011,
  #   glaq012     LIKE glaq_t.glaq012,
  #   glaq013     LIKE glaq_t.glaq013,
  #   glaq014     LIKE glaq_t.glaq014,
  #   glaq015     LIKE glaq_t.glaq015,
  #   glaq016     LIKE glaq_t.glaq016,
  #   glaq017     LIKE glaq_t.glaq017,
  #   glaq018     LIKE glaq_t.glaq018,
  #   glaq019     LIKE glaq_t.glaq019,
  #   glaq020     LIKE glaq_t.glaq020,
  #   glaq021     LIKE glaq_t.glaq021,
  #   glaq022     LIKE glaq_t.glaq022,
  #   glaq023     LIKE glaq_t.glaq023,
  #   glaq024     LIKE glaq_t.glaq024,
  #   glaq025     LIKE glaq_t.glaq025,
  #   glaq027     LIKE glaq_t.glaq027,
  #   glaq028     LIKE glaq_t.glaq028,
  #   glaq051     LIKE glaq_t.glaq051,  #經營方式
  #   glaq052     LIKE glaq_t.glaq052,  #渠道
  #   glaq053     LIKE glaq_t.glaq053,  #品牌
  #   glaq029     LIKE glaq_t.glaq029,
  #   glaq030     LIKE glaq_t.glaq030,
  #   glaq031     LIKE glaq_t.glaq031,
  #   glaq032     LIKE glaq_t.glaq032,
  #   glaq033     LIKE glaq_t.glaq033,
  #   glaq034     LIKE glaq_t.glaq034,
  #   glaq035     LIKE glaq_t.glaq035,
  #   glaq036     LIKE glaq_t.glaq036,
  #   glaq037     LIKE glaq_t.glaq037,
  #   glaq038     LIKE glaq_t.glaq038,
  #   glbc004     LIKE glbc_t.glbc004,  #现金变动码
  #   d           LIKE glaq_t.glaq003,
  #   c           LIKE glaq_t.glaq004,
  #   qty         LIKE glaq_t.glaq008,
  #   sum         LIKE glaq_t.glaq010,
  #   glaq039     LIKE glaq_t.glaq039,
  #   glaq040     LIKE glaq_t.glaq040,
  #   glaq041     LIKE glaq_t.glaq041,
  #   glaq042     LIKE glaq_t.glaq042,
  #   glaq043     LIKE glaq_t.glaq043,
  #   glaq044     LIKE glaq_t.glaq044,
  #   seq         LIKE glaq_t.glaqseq,
  #   source      LIKE type_t.chr100,
  #   glaqseq     LIKE glaq_t.glaqseq,
  #   xrca039     LIKE xrca_t.xrca039,
  #   b_glaq021   LIKE glaq_t.glaq021,
  #   b_glaq022   LIKE glaq_t.glaq022,
  #   red         LIKE type_t.chr1       #红冲否(待抵单使用) #20150612 add lujh
  #);
  #
  #DROP TABLE s_voucher_glbc;
  #CREATE TEMP TABLE s_voucher_glbc(
  #   glbcent    LIKE glbc_t.glbcent,
  #   glbcld     LIKE glbc_t.glbcld,
  #   glbccomp   LIKE glbc_t.glbccomp,
  #   glbcdocno  LIKE glbc_t.glbcdocno,
  #   glbcseq    LIKE glbc_t.glbcseq,
  #   glbc001    LIKE glbc_t.glbc001,
  #   glbc002    LIKE glbc_t.glbc002,
  #   glbc003    LIKE glbc_t.glbc003,
  #   glbc004    LIKE glbc_t.glbc004,
  #   glbc005    LIKE glbc_t.glbc005,
  #   glbc006    LIKE glbc_t.glbc006,
  #   glbc007    LIKE glbc_t.glbc007,
  #   glbc008    LIKE glbc_t.glbc008,
  #   glbc009    LIKE glbc_t.glbc009,
  #   glbc010    LIKE glbc_t.glbc010,
  #   glbc011    LIKE glbc_t.glbc011,
  #   glbc012    LIKE glbc_t.glbc012,
  #   glbc013    LIKE glbc_t.glbc013,
  #   glbc014    LIKE glbc_t.glbc014,
  #   xrdadocno  LIKE xrda_t.xrdadocno
  #)
  #160802-00006#1 Mark ---(E)---
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ins_xrce(p_nmbb026)
   DEFINE p_nmbb026        LIKE nmbb_t.nmbb026
   DEFINE l_nmbbdocno      LIKE nmbb_t.nmbbdocno
   DEFINE l_nmbbseq        LIKE nmbb_t.nmbbseq
   DEFINE l_nmba           RECORD LIKE nmba_t.*
   DEFINE l_nmbb           RECORD LIKE nmbb_t.*
   DEFINE l_xrca           RECORD LIKE xrca_t.*
   DEFINE l_xrcb           RECORD LIKE xrcb_t.*
   DEFINE l_xrcc           RECORD LIKE xrcc_t.*
   DEFINE l_xrde           RECORD LIKE xrde_t.*
   DEFINE l_xrce           RECORD LIKE xrce_t.*
   DEFINE l_xrce_t         RECORD LIKE xrce_t.*
   DEFINE l_xrccdocno      LIKE xrcc_t.xrccdocno
   DEFINE l_xrccseq        LIKE xrcc_t.xrccseq
   DEFINE l_xrcc001        LIKE xrcc_t.xrcc001
   DEFINE l_apccdocno      LIKE apcc_t.apccdocno
   DEFINE l_apccseq        LIKE apcc_t.apccseq
   DEFINE l_apcc001        LIKE apcc_t.apcc001
   DEFINE l_seq            LIKE xrcc_t.xrccseq
   DEFINE l_xrce016        LIKE xrce_t.xrce016
   DEFINE l_trans          LIKE xrce_t.xrce109   #收款原幣金額
   DEFINE l_xrde109        LIKE xrde_t.xrde109
   DEFINE l_xrde119        LIKE xrde_t.xrde119
   DEFINE l_xrde129        LIKE xrde_t.xrde129
   DEFINE l_xrde139        LIKE xrde_t.xrde139
   DEFINE l_xrce109        LIKE xrce_t.xrce109
   DEFINE l_xrce119        LIKE xrce_t.xrce119
   DEFINE l_xrce129        LIKE xrce_t.xrce129
   DEFINE l_xrce139        LIKE xrce_t.xrce139
   DEFINE l_xrde109_1      LIKE xrde_t.xrde109
   DEFINE l_xrde119_1      LIKE xrde_t.xrde119
   DEFINE l_xrde129_1      LIKE xrde_t.xrde129
   DEFINE l_xrde139_1      LIKE xrde_t.xrde139
   DEFINE l_gzcb003        LIKE gzcb_t.gzcb003
   DEFINE l_apca_t         RECORD LIKE apca_t.*
   DEFINE l_apcb_t         RECORD LIKE apcb_t.*
   DEFINE l_apcc_t         RECORD LIKE apcc_t.*
   DEFINE l_ooab002        LIKE ooab_t.ooab002
   DEFINE l_xrca001_str    STRING
   DEFINE l_apca001_str    STRING
   DEFINE l_success        LIKE type_t.num5
   DEFINE l_tot1           LIKE nmbb_t.nmbb006   #原幣金額
   DEFINE l_tot2           LIKE nmbb_t.nmbb007   #本幣金額
   DEFINE l_amt1           LIKE nmbb_t.nmbb008   #已沖原幣金額  主帳套
   DEFINE l_amt2           LIKE nmbb_t.nmbb009   #已沖本幣金額  主帳套
   DEFINE l_amt3           LIKE nmbb_t.nmbb020   #已沖原幣金額  次帳套一
   DEFINE l_amt4           LIKE nmbb_t.nmbb021   #已沖本幣金額  次帳套一
   DEFINE l_amt5           LIKE nmbb_t.nmbb023   #已沖原幣金額  次帳套二
   DEFINE l_amt6           LIKE nmbb_t.nmbb024   #已沖本幣金額  次帳套二
   DEFINE l_count          LIKE type_t.num5
   DEFINE l_xrcc108        LIKE xrcc_t.xrcc108
   DEFINE l_xrcc118        LIKE xrcc_t.xrcc118
   DEFINE l_xrcc128        LIKE xrcc_t.xrcc128
   DEFINE l_xrcc138        LIKE xrcc_t.xrcc138
   DEFINE l_apcc108        LIKE apcc_t.apcc108
   DEFINE l_apcc118        LIKE apcc_t.apcc118
   DEFINE l_apcc128        LIKE apcc_t.apcc128
   DEFINE l_apcc138        LIKE apcc_t.apcc138
   DEFINE l_str            LIKE type_t.chr500
   DEFINE l_amt_xrce119    LIKE xrce_t.xrce119   #161013-00003#2 Add
  

   LET g_cnt1 = 0
   LET g_cnt2 = 0
   LET g_cnt3 = 0
   #主畫面選擇未沖帳款全部產生時不考慮差異問題
   #主畫面選擇依收款金額顯示相符未沖帳款時且存在差異金額時,需要考慮差異處理
   
   LET l_seq = 0
   LET l_trans = 0
   #匯入收款資料
   FOREACH axrp400_nm_curs USING p_nmbb026 INTO l_nmbbdocno,l_nmbbseq
      
      #賬務資料獲取
      INITIALIZE l_nmbb.* TO NULL
      SELECT * INTO l_nmbb.* FROM nmbb_t
       WHERE nmbbent = g_enterprise AND nmbbdocno = l_nmbbdocno AND nmbbseq = l_nmbbseq
      SELECT * INTO l_nmba.* FROM nmba_t
       WHERE nmbaent = g_enterprise AND nmbadocno = l_nmbbdocno
       
      SELECT nmbb006,nmbb007,nmbb008,nmbb009,nmbb020,nmbb021,nmbb023,nmbb024
        INTO l_tot1,l_tot2,l_amt1,l_amt2,l_amt3,l_amt4,l_amt5,l_amt6
        FROM nmbb_t
       WHERE nmbbent  = g_enterprise
         AND nmbbdocno= l_nmbb.nmbbdocno
         AND nmbbseq  = l_nmbb.nmbbseq
      IF g_ls = 1 THEN
         LET l_tot1 = l_tot1 - l_amt1
         LET l_tot2 = l_tot2 - l_amt2
      ELSE
         IF g_ls = 2 THEN
           LET l_tot1 = l_tot1 - l_amt3
           LET l_tot2 = l_tot2 - l_amt4
         ELSE
           LET l_tot1 = l_tot1 - l_amt5
           LET l_tot2 = l_tot2 - l_amt6
         END IF
      END IF
      LET l_str = l_nmbb.nmbbdocno,"|",l_nmbb.nmbbseq
      IF l_tot1 = 0 OR l_tot2 = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = l_str
         LET g_errparam.code = 'axr-00054'
#         LET g_errparam.replace[1] = l_nmbb.nmbbdocno
#         LET g_errparam.replace[2] = l_nmbb.nmbbseq
         
         LET g_errparam.popup = TRUE
         CALL cl_err()
         CONTINUE FOREACH
      END IF

      #其他資料獲取
      IF l_nmba.nmba006 = 'N' THEN   #160530-00005#5 Add
         #160926-00026#1 Mark ---(S)---
        #SELECT glab005 INTO l_xrce016 FROM glab_t
        # #WHERE glabld = g_master.xrdald  #160905-00002#7 mark
        # WHERE glabent= g_enterprise    #160905-00002#7
        #   AND glabld = g_master.xrdald #160905-00002#7
        #   AND glab001= '40'
        #   AND glab002= '40'
        #   AND glab003= l_nmbb.nmbb003
         #160926-00026#1 Mark ---(E)---
         #160926-00026#1 Add  ---(S)---
         #抓取科目
         IF l_nmbb.nmbb029 = '10' OR l_nmbb.nmbb029 = '20' THEN   #160929-00026#1 Mod
            #借方科目: 依 anmi121  設定 
            SELECT DISTINCT glab005 INTO l_xrce016
              FROM glab_t
             WHERE glabent = g_enterprise 
               AND glabld  = g_master.xrdald   #160929-00026#1 Mod
               AND glab001 = '40'
               AND glab002 = '40'     
               AND glab003 = l_nmbb.nmbb003  #交易帳戶編號
         END IF
         #依agli190设定
         IF l_nmbb.nmbb029 MATCHES '[3456]0' THEN   #160929-00026#1 Mod
            SELECT DISTINCT glab005 INTO l_xrce016
              FROM glab_t
             WHERE glabent = g_enterprise 
               AND glabld  = g_master.xrdald   #160929-00026#1 Mod
               AND glab001 = '21'
               AND glab002 = l_nmbb.nmbb029   #160929-00026#1 Mod
               AND glab003 = l_nmbb.nmbb028
         END IF
         #160926-00026#1 Add  ---(E)---
     #160530-00005#5 Add  ---(S)---
      ELSE
         SELECT glab005 INTO l_xrce016 FROM glab_t
          #WHERE glabld = g_master.xrdald  #160905-00002#7 mark
          WHERE glabent= g_enterprise    #160905-00002#7
            AND glabld = g_master.xrdald #160905-00002#7
            AND glab001= '41'
            AND glab002= '8714'
            AND glab003= 'F'
      END IF
     #160530-00005#5 Add  ---(E)---
      IF l_nmba.nmba003 = 'anmt510' THEN
         LET l_xrde.xrde006 = '10'
      END IF
      IF l_nmba.nmba003 = 'anmt540' THEN
         SELECT ooia002 INTO l_xrde.xrde006 FROM ooia_t
          WHERE ooiaent = g_enterprise AND ooia001 = l_nmbb.nmbb028
      END IF

      LET l_xrde.xrdeent = g_enterprise
      LET l_xrde.xrdecomp= g_glaa.glaacomp
      LET l_xrde.xrdeld  = g_master.xrdald
      LET l_xrde.xrdedocno= g_xrdadocno
      LET l_xrde.xrdeseq = l_seq + 1
      LET l_xrde.xrdesite= l_nmbb.nmbbcomp
      LET l_xrde.xrdeorga= l_nmbb.nmbborga
      LET l_xrde.xrde001 = l_nmba.nmba003
      LET l_xrde.xrde002 = 10
      LET l_xrde.xrde003 = l_nmbb.nmbbdocno
      LET l_xrde.xrde004 = l_nmbb.nmbbseq
      LET l_xrde.xrde006 = l_nmbb.nmbb029
     #LET l_xrde.xrde007 = l_nmbb.nmbb006
      LET l_xrde.xrde008 = l_nmbb.nmbb003   #161013-00013#1 Umark
      LET l_xrde.xrde010 = ''
      LET l_xrde.xrde011 = l_nmbb.nmbb002
      LET l_xrde.xrde012 = l_nmbb.nmbb010
      LET l_xrde.xrde013 = ''
      LET l_xrde.xrde014 = ''
      SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
       WHERE gzcb002 = '10'
         AND gzcb001 = '8306'
      IF l_gzcb003 = 'D' THEN
         LET l_xrde.xrde015 = 'D'
      ELSE
         LET l_xrde.xrde015 = 'C'
      END IF
      LET l_xrde.xrde016 = l_xrce016
      LET l_xrde.xrde017 = ''
      LET l_xrde.xrde018 = ''
      LET l_xrde.xrde019 = ''
      LET l_xrde.xrde020 = ''
      LET l_xrde.xrde022 = ''
      LET l_xrde.xrde023 = ''
      LET l_xrde.xrde028 = ''
      LET l_xrde.xrde029 = ''
      LET l_xrde.xrde030 = ''
      LET l_xrde.xrde035 = ''
      LET l_xrde.xrde036 = ''
      LET l_xrde.xrde038 = ''
      LET l_xrde.xrde039 = ''
      LET l_xrde.xrde040 = ''
      LET l_xrde.xrde041 = ''
      LET l_xrde.xrde042 = ''
      LET l_xrde.xrde043 = ''
      LET l_xrde.xrde044 = ''
      LET l_xrde.xrde045 = ''
      LET l_xrde.xrde046 = ''
      LET l_xrde.xrde047 = ''
      LET l_xrde.xrde048 = ''
      LET l_xrde.xrde049 = ''
      LET l_xrde.xrde050 = ''
      LET l_xrde.xrde051 = ''
      LET l_xrde.xrde100 = l_nmbb.nmbb004
      LET l_xrde.xrde101 = l_nmbb.nmbb005
      SELECT SUM(xrde109),SUM(xrde119),SUM(xrde129),SUM(xrde139) INTO l_xrde109,l_xrde119,l_xrde129,l_xrde139 FROM xrde_t,xrda_t
       WHERE xrdaent   = g_enterprise
         AND xrdaent   = xrdeent
         AND xrdald    = xrdeld
         AND xrdadocno = xrdedocno
         AND xrde003   = l_nmbb.nmbbdocno
         AND xrde004   = l_nmbb.nmbbseq
         AND xrdastus  = 'N'
      IF cl_null(l_xrde109) THEN LET l_xrde109 = 0 END IF
      IF cl_null(l_xrde119) THEN LET l_xrde119 = 0 END IF
      IF cl_null(l_xrde129) THEN LET l_xrde129 = 0 END IF
      IF cl_null(l_xrde139) THEN LET l_xrde139 = 0 END IF
      CASE
         WHEN g_ls = 1
            LET l_xrde.xrde109 = l_nmbb.nmbb006 - l_nmbb.nmbb008 - l_xrde109
            LET l_xrde.xrde119 = l_nmbb.nmbb007 - l_nmbb.nmbb009 - l_xrde119
         WHEN g_ls = 2
            LET l_xrde.xrde109 = l_nmbb.nmbb006 - l_nmbb.nmbb020 - l_xrde109
            LET l_xrde.xrde119 = l_nmbb.nmbb007 - l_nmbb.nmbb021 - l_xrde119
         WHEN g_ls = 3
            LET l_xrde.xrde109 = l_nmbb.nmbb006 - l_nmbb.nmbb023 - l_xrde109
            LET l_xrde.xrde119 = l_nmbb.nmbb007 - l_nmbb.nmbb024 - l_xrde119
      END CASE
      LET l_xrde.xrde120 = l_nmbb.nmbb011
      LET l_xrde.xrde121 = l_nmbb.nmbb012
      LET l_xrde.xrde129 = l_nmbb.nmbb013 - l_nmbb.nmbb014 - l_xrde129
      LET l_xrde.xrde130 = l_nmbb.nmbb015
      LET l_xrde.xrde131 = l_nmbb.nmbb016
      LET l_xrde.xrde139 = l_nmbb.nmbb017 - l_nmbb.nmbb018 - l_xrde139
      #160912-00038#1 add--s
      LET l_xrde.xrde032 = NULL
      SELECT nmbadocdt INTO l_xrde.xrde032 FROM nmba_t
       WHERE nmbaent  = g_enterprise
         AND nmbacomp = l_nmbb.nmbbcomp
         AND nmbadocno= l_nmbb.nmbbdocno
      #160912-00038#1 add--

      INSERT INTO xrde_t VALUES (l_xrde.*)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'xrde_t'
         LET g_errparam.extend = SQLCA.sqlcode
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_success = 'N'
         EXIT FOREACH
      ELSE
         LET g_cnt1 = g_cnt1 + 1
      END IF

      LET l_seq = l_seq + 1

      LET l_trans = l_trans + l_xrde.xrde109

   END FOREACH
   IF g_success = 'N' THEN
      RETURN
   END IF

  #IF l_seq > 1 THEN LET l_seq = l_seq - 1 END IF

   #161013-00003#2 Add  ---(S)---
   LET g_amt_xrce119 = 0
   SELECT SUM(xrde119) INTO g_amt_xrce119 FROM xrde_t WHERE xrdeent = g_enterprise
      AND xrdedocno = l_xrde.xrdedocno
      AND xrdeld = l_xrde.xrdeld
   #161013-00003#2 Add  ---(E)---

   LET l_seq = 0
   #匯入帳款資料
   FOREACH axrp400_ar_curs USING p_nmbb026 INTO l_xrccdocno,l_xrccseq,l_xrcc001
      #獲取AR資料
      SELECT * INTO l_xrca.* FROM xrca_t WHERE xrcaent = g_enterprise AND xrcald = g_master.xrdald
         AND xrcadocno = l_xrccdocno
      SELECT * INTO l_xrcb.* FROM xrcb_t WHERE xrcbent = g_enterprise AND xrcbld = g_master.xrdald
         AND xrcbdocno = l_xrccdocno AND xrcbseq = l_xrccseq
      SELECT * INTO l_xrcc.* FROM xrcc_t WHERE xrccent = g_enterprise AND xrccld = g_master.xrdald
         AND xrccdocno = l_xrccdocno AND xrccseq = l_xrccseq AND xrcc001 = l_xrcc001

      #其他資料獲取
      LET l_xrca001_str = l_xrca.xrca001
      IF l_xrca001_str.substring(1,1) = '1' THEN
         LET l_xrce.xrce002 = '30'
      END IF 
      IF l_xrca001_str.substring(1,1) = '2' THEN
         LET l_xrce.xrce002 = '31'
      END IF
      
      IF l_xrce.xrce002 = '30' OR l_xrce.xrce002 = '31' THEN
         #檢查資料1:存在性;2.可沖金額大於0
         SELECT COUNT(*) INTO l_count FROM xrca_t,xrcc_t
          WHERE xrcaent = g_enterprise
            AND xrcaent = xrccent
            AND xrcadocno = xrccdocno
            AND xrcald = xrccld
            AND xrccld = g_master.xrdald
            AND xrccdocno = l_xrcc.xrccdocno
            AND xrccseq = l_xrcc.xrccseq
            AND xrcc001 = l_xrcc.xrcc001
         SELECT SUM(xrcc108 - xrcc109),SUM(xrcc118 - xrcc119 + xrcc113),SUM(xrcc128 - xrcc129 + xrcc123),SUM(xrcc138 - xrcc139 + xrcc133) 
           INTO l_xrcc108,l_xrcc118,l_xrcc128,l_xrcc138
           FROM xrcc_t
          WHERE xrccent = g_enterprise
            AND xrccld = g_master.xrdald
            AND xrccdocno = l_xrcc.xrccdocno
            AND xrccseq = l_xrcc.xrccseq
            AND xrcc001 = l_xrcc.xrcc001
       
         IF cl_null(l_xrcc108) THEN LET l_xrcc108 = 0 END IF
         IF cl_null(l_xrcc118) THEN LET l_xrcc118 = 0 END IF
         IF cl_null(l_xrcc128) THEN LET l_xrcc128 = 0 END IF
         IF cl_null(l_xrcc138) THEN LET l_xrcc138 = 0 END IF
         LET l_str = l_xrcc.xrccdocno,"|",l_xrcc.xrccseq,"|",l_xrcc.xrcc001
         CASE
            WHEN l_count = 0
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'axr-00067'
               LET g_errparam.extend = l_str
#               LET g_errparam.replace[1] = l_xrcc.xrccdocno
#               LET g_errparam.replace[2] = l_xrcc.xrccseq
#               LET g_errparam.replace[3] = l_xrcc.xrcc001
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CONTINUE FOREACH
            WHEN l_xrcc108 = 0 OR l_xrcc118 = 0
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'axr-00058'
               LET g_errparam.extend = l_str
#               LET g_errparam.replace[1] = l_xrcc.xrccdocno
#               LET g_errparam.replace[2] = l_xrcc.xrccseq
#               LET g_errparam.replace[3] = l_xrcc.xrcc001
               
               LET g_errparam.popup = TRUE
               CALL cl_err()
               CONTINUE FOREACH
         END CASE
      END IF
      SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
       WHERE gzcb002 = l_xrce.xrce002
         AND gzcb001 = '8306'
      IF l_gzcb003 = 'D' THEN
         LET l_xrce.xrce015   =  'D'
      ELSE
         LET l_xrce.xrce015   =  'C'
      END IF
      LET l_xrce.xrceent = g_enterprise
      LET l_xrce.xrcecomp= l_xrcc.xrcccomp
      LET l_xrce.xrceld  = g_master.xrdald
      LET l_xrce.xrcedocno= g_xrdadocno
      LET l_xrce.xrceseq = l_seq + 1
      LET l_xrce.xrcelegl= l_xrcc.xrcclegl
      LET l_xrce.xrcesite= l_xrcc.xrccsite
      LET l_xrce.xrceorga= l_xrcb.xrcborga
      LET l_xrce.xrce001 = l_xrcb.xrcb001
     #LET l_xrce.xrce002 = '30'
      LET l_xrce.xrce003 = l_xrcc.xrccdocno
      LET l_xrce.xrce004 = l_xrccseq
      LET l_xrce.xrce005 = l_xrcc.xrcc001
      LET l_xrce.xrce006 = ''
      LET l_xrce.xrce007 = l_xrcc.xrcc108 - l_xrcc.xrcc109
      LET l_xrce.xrce008 = l_xrcc.xrccdocno
      LET l_xrce.xrce009 = ''
      LET l_xrce.xrce010 = ''
      LET l_xrce.xrce011 = ''
      LET l_xrce.xrce012 = ''
      LET l_xrce.xrce013 = ''
      LET l_xrce.xrce014 = ''
     #LET l_xrce.xrce015 = 'C'
      LET l_xrce.xrce016 = l_xrca.xrca035
      LET l_xrce.xrce017 = l_xrca.xrca014
      LET l_xrce.xrce018 = l_xrcb.xrcb010
      LET l_xrce.xrce019 = l_xrcb.xrcb011
      LET l_xrce.xrce020 = l_xrcb.xrcb012
      LET l_xrce.xrce021 = l_xrcb.xrcb017
      LET l_xrce.xrce022 = l_xrcb.xrcb015
      LET l_xrce.xrce023 = l_xrcb.xrcb016
      LET l_xrce.xrce024 = l_xrcb.xrcb002
      LET l_xrce.xrce025 = l_xrcb.xrcb003
      LET l_xrce.xrce026 = ''
      LET l_xrce.xrce027 = ''
      LET l_xrce.xrce028 = ''
      LET l_xrce.xrce029 = ''
      LET l_xrce.xrce030 = ''
      LET l_xrce.xrce035 = ''
      LET l_xrce.xrce036 = ''
      LET l_xrce.xrce037 = ''
      LET l_xrce.xrce038 = ''
      LET l_xrce.xrce104 = 0
      LET l_xrce.xrce114 = 0
      LET l_xrce.xrce124 = 0
      LET l_xrce.xrce134 = 0
      LET l_xrce.xrce100 = l_xrcc.xrcc100
      LET l_xrce.xrce101 = l_xrcc.xrcc102
      LET l_xrce.xrce120 = l_xrcc.xrcc120
      LET l_xrce.xrce121 = l_xrcc.xrcc122
      LET l_xrce.xrce130 = l_xrcc.xrcc130
      LET l_xrce.xrce131 = l_xrcc.xrcc132
      CALL axrp400_ar_amt(l_xrccdocno,l_xrccseq,l_xrcc001)
         RETURNING l_xrce.xrce109,l_xrce.xrce119,l_xrce.xrce129,l_xrce.xrce139
      
      IF l_xrce.xrce109 <=0 THEN CONTINUE FOREACH END IF
      #161013-00003#2 Add  ---(S)---
      IF l_xrce.xrce119 <= g_amt_xrce119 THEN
         LET g_amt_xrce119 = l_xrce.xrce119
      ELSE
         LET l_xrce.xrce119= g_amt_xrce119
         LET l_xrce.xrce109=l_xrce.xrce119 / l_xrce.xrce101
         CALL s_curr_round_ld('1',l_xrce.xrceld,l_xrce.xrce100,l_xrce.xrce109,2)
            RETURNING l_success,g_errno,l_xrce.xrce109
         LET g_amt_xrce119 = 0
      END IF
      #161013-00003#2 Add  ---(E)---

      INSERT INTO xrce_t VALUES (l_xrce.*)
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'xrce_t'
         LET g_errparam.extend = SQLCA.sqlcode
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET g_success = 'N' 
         EXIT FOREACH
      ELSE
         LET g_cnt2 = g_cnt2 + 1
      END IF

      LET l_seq = l_seq + 1

      #161013-00003#2 Add  ---(S)---
      IF g_amt_xrce119 = 0 THEN
         EXIT FOREACH
      END IF
      #161013-00003#2 Add  ---(E)---

   END FOREACH
   IF g_success = 'N' THEN
      RETURN
   END IF
   
   #161013-00003#2 Add  ---(S)---
   IF g_amt_xrce119 = 0 THEN
      RETURN
   END IF
   #161013-00003#2 Add  ---(E)---

   LET l_count = 0
   IF g_master.chk = 'Y' THEN 
      
      FOREACH axrp400_sel_apcc_curs USING p_nmbb026 INTO l_apccdocno,l_apccseq,l_apcc001#獲取AR資料
         SELECT * INTO l_apca_t.* FROM apca_t WHERE apcaent = g_enterprise AND apcald = g_master.xrdald
            AND apcadocno = l_apccdocno
         SELECT * INTO l_apcc_t.* FROM apcc_t WHERE apccent = g_enterprise AND apccld = g_master.xrdald
            AND apccdocno = l_apccdocno AND apccseq = l_apccseq AND apcc001 = l_apcc001
         SELECT * INTO l_apcb_t.* FROM apcb_t WHERE apcbent = g_enterprise AND apcbld = g_master.xrdald
            AND apcbdocno = l_apcc_t.apccdocno AND apcbseq = l_apcc_t.apccseq
         #計算預沖金額
         LET l_xrce109 = 0   LET l_xrce119 = 0
         LET l_xrce129 = 0   LET l_xrce139 = 0
         SELECT SUM(xrce109),SUM(xrce119),SUM(xrce129),SUM(xrce139) INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
           FROM xrce_t,xrda_t
          WHERE xrdaent   = xrceent
            AND xrdald    = xrceld
            AND xrdadocno = xrcedocno
            AND xrce003   = l_apcc_t.apccdocno
            AND xrce004   = l_apcc_t.apccseq
            AND xrce005   = l_apcc_t.apcc001
            AND xrdastus  = 'N'
         IF cl_null(l_xrce109) THEN LET l_xrce109 = 0 END IF
         IF cl_null(l_xrce119) THEN LET l_xrce119 = 0 END IF
         IF cl_null(l_xrce129) THEN LET l_xrce129 = 0 END IF
         IF cl_null(l_xrce139) THEN LET l_xrce139 = 0 END IF
         
         SELECT MAX(xrceseq) INTO l_xrce_t.xrceseq
           FROM xrce_t
          WHERE xrceent = g_enterprise 
            AND xrceld = g_master.xrdald
            AND xrcedocno = g_xrdadocno
         IF cl_null(l_xrce_t.xrceseq) THEN
            LET l_xrce_t.xrceseq = 1
         ELSE
            LET l_xrce_t.xrceseq = l_xrce_t.xrceseq + 1
         END IF
         
         
         LET l_xrce_t.xrceent = g_enterprise
         LET l_xrce_t.xrceld = g_master.xrdald
         LET l_xrce_t.xrcedocno = g_xrdadocno
         LET l_xrce_t.xrcesite  = g_master.xrdasite
         LET l_xrce_t.xrceorga  = l_apcb_t.apcborga
         LET l_apca001_str = l_apca_t.apca001
         LET l_apca001_str = l_apca001_str.substring(1,1)
         IF l_apca001_str = '1' THEN
            LET l_xrce_t.xrce002   = '40'
         END IF
         IF l_apca001_str = '2' AND l_apca_t.apca001 <> '25' THEN 
            LET l_xrce_t.xrce002   = '41'
         END IF
         IF l_apca_t.apca001 = '25' THEN 
            LET l_xrce_t.xrce002   = '42'
         END IF
         
         IF l_xrce_t.xrce002 = '40' OR l_xrce_t.xrce002 = '41' OR l_xrce_t.xrce002 = '42' THEN       
            #檢查資料1:存在性;2.可沖金額大於0
            SELECT COUNT(*) INTO l_count FROM apca_t,apcc_t
             WHERE apcaent = g_enterprise
               AND apcaent = apccent
               AND apcadocno = apccdocno
               AND apcald = apccld
               AND apccld = g_master.xrdald
               AND apccdocno = l_apcc_t.apccdocno
               AND apccseq = l_apcc_t.apccseq
               AND apcc001 = l_apcc_t.apcc001
            SELECT SUM(apcc108 - apcc109),SUM(apcc118 - apcc119 + apcc113),SUM(apcc128 - apcc129 + apcc123),SUM(apcc138 - apcc139 + apcc133) 
              INTO l_apcc108,l_apcc118,l_apcc128,l_apcc138
              FROM apcc_t
             WHERE apccent = g_enterprise
               AND apccld = g_master.xrdald
               AND apccdocno = l_apcc_t.apccdocno
               AND apccseq = l_apcc_t.apccseq
               AND apcc001 = l_apcc_t.apcc001
        
            IF cl_null(l_apcc108) THEN LET l_apcc108 = 0 END IF
            IF cl_null(l_apcc118) THEN LET l_apcc118 = 0 END IF
            IF cl_null(l_apcc128) THEN LET l_apcc128 = 0 END IF
            IF cl_null(l_apcc138) THEN LET l_apcc138 = 0 END IF
            
            LET l_str = l_apcc_t.apccdocno,"|",l_apcc_t.apccseq,"|",l_apcc_t.apcc001
            CASE
               WHEN l_count = 0
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_str
                  LET g_errparam.code = 'axr-00333'
#                  LET g_errparam.replace[1] = l_apcc_t.apccdocno
#                  LET g_errparam.replace[2] = l_apcc_t.apccseq
#                  LET g_errparam.replace[3] = l_apcc_t.apcc001
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CONTINUE FOREACH
               WHEN l_apcc108 = 0 OR l_apcc118 = 0
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = l_str
                  LET g_errparam.code = 'axr-00058'
#                  LET g_errparam.replace[1] = l_apcc_t.apccdocno
#                  LET g_errparam.replace[2] = l_apcc_t.apccseq
#                  LET g_errparam.replace[3] = l_apcc_t.apcc001
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CONTINUE FOREACH
            END CASE
         END IF
         
         LET l_xrce_t.xrce010   = ''
         SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
          WHERE gzcb002 = l_xrce_t.xrce002
            AND gzcb001 = '8306'
         IF l_gzcb003 = 'D' THEN
            LET l_xrce_t.xrce015   =  'D'
         ELSE
            LET l_xrce_t.xrce015   =  'C'
         END IF
         
         
         LET l_xrce_t.xrcecomp = l_apcc_t.apcccomp
         LET l_xrce_t.xrce001  = 'axrt400'
         LET l_xrce_t.xrce003  = l_apcc_t.apccdocno
         LET l_xrce_t.xrce004  = l_apcc_t.apccseq
         LET l_xrce_t.xrce005  = l_apcc_t.apcc001
         LET l_xrce_t.xrce016  = l_apca_t.apca035
         LET l_xrce_t.xrce017  = l_apca_t.apca014
         LET l_xrce_t.xrce018  = l_apca_t.apca015
         LET l_xrce_t.xrce027  = 'N'
         LET l_xrce_t.xrce028  = 0
         LET l_xrce_t.xrce036  = l_apca_t.apca006
         LET l_xrce_t.xrce038  = l_apca_t.apca004     #160426-00016
         LET l_xrce_t.xrce053  = l_apcc_t.apcc008
         LET l_xrce_t.xrce054  = l_apcc_t.apcc009
         LET l_xrce_t.xrce100  = l_apcc_t.apcc100
         LET l_xrce_t.xrce101  = l_apcc_t.apcc102     #20150313  apcc101 ---->apcc102
         LET l_xrce_t.xrce104   = 0
         LET l_xrce_t.xrce114   = 0
         LET l_xrce_t.xrce120  = l_apcc_t.apcc120
         LET l_xrce_t.xrce121  = l_apcc_t.apcc122
         LET l_xrce_t.xrce130  = l_apcc_t.apcc130
         LET l_xrce_t.xrce131  = l_apcc_t.apcc132
         
         LET l_xrce_t.xrce109  = l_apcc_t.apcc108 - l_apcc_t.apcc109 - l_xrce109
         LET l_xrce_t.xrce119  = l_apcc_t.apcc118 - l_apcc_t.apcc119 - l_xrce119
         IF l_xrce_t.xrce109 <= 0 THEN CONTINUE FOREACH END IF
         LET l_xrce_t.xrce129  = l_apcc_t.apcc128 - l_apcc_t.apcc129 - l_xrce129
         LET l_xrce_t.xrce139  = l_apcc_t.apcc138 - l_apcc_t.apcc139 - l_xrce139
      
         IF g_glaa.glaa015 = 'N' THEN
            LET l_xrce_t.xrce120 = ''
            LET l_xrce_t.xrce121 = 0
            LET l_xrce_t.xrce129 = 0
         END IF
         
         IF g_glaa.glaa019 = 'N' THEN
            LET l_xrce_t.xrce130 = ''
            LET l_xrce_t.xrce131 = 0
            LET l_xrce_t.xrce139 = 0
         END IF

         #161013-00003#2 Add  ---(S)---
         IF l_xrce.xrce119 <= g_amt_xrce119 THEN
            LET g_amt_xrce119 = l_xrce.xrce119
         ELSE
            LET l_xrce.xrce119= g_amt_xrce119
            LET l_xrce.xrce109=l_xrce.xrce119 / l_xrce.xrce101
            CALL s_curr_round_ld('1',l_xrce.xrceld,l_xrce.xrce100,l_xrce.xrce109,2)
               RETURNING l_success,g_errno,l_xrce.xrce109
            LET g_amt_xrce119 = 0
         END IF
         #161013-00003#2 Add  ---(E)---

      
         #INSERT INTO xrce_t VALUES(l_xrce_t.*)
         INSERT INTO xrce_t(xrceent,xrcecomp,xrceorga,xrcesite,xrceld,xrcedocno,xrceseq,xrce001,xrce002,xrce003,
                            xrce004,xrce005,xrce010,xrce015,xrce016,xrce017,xrce018,xrce027,xrce028,xrce036,
                            xrce053,xrce054,xrce100,xrce101,xrce104,xrce114,xrce109,
                            xrce119,xrce120,xrce121,xrce129,xrce130,xrce131,xrce139)
                     VALUES(l_xrce_t.xrceent,l_xrce_t.xrcecomp ,l_xrce_t.xrceorga,l_xrce_t.xrcesite,
                            l_xrce_t.xrceld ,l_xrce_t.xrcedocno,l_xrce_t.xrceseq ,l_xrce_t.xrce001 ,
                            l_xrce_t.xrce002,l_xrce_t.xrce003  ,l_xrce_t.xrce004 ,l_xrce_t.xrce005 ,
                            l_xrce_t.xrce010,l_xrce_t.xrce015  ,l_xrce_t.xrce016 ,l_xrce_t.xrce017 ,
                            l_xrce_t.xrce018,l_xrce_t.xrce027  ,l_xrce_t.xrce028 ,l_xrce_t.xrce036 ,
                            l_xrce_t.xrce053,l_xrce_t.xrce054  ,l_xrce_t.xrce100 ,l_xrce_t.xrce101 ,
                            l_xrce_t.xrce104,l_xrce_t.xrce114  ,l_xrce_t.xrce109 ,l_xrce_t.xrce119 ,
                            l_xrce_t.xrce120,l_xrce_t.xrce121  ,l_xrce_t.xrce129 ,l_xrce_t.xrce130 ,
                            l_xrce_t.xrce131,l_xrce_t.xrce139
                           )
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'xrce_t'
            LET g_errparam.extend = SQLCA.sqlcode
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET g_success = 'N' 
            EXIT FOREACH
         ELSE
            LET g_cnt3 = g_cnt3 + 1
         END IF

         #161013-00003#2 Add  ---(S)---
         IF g_amt_xrce119 = 0 THEN
            EXIT FOREACH
         END IF
         #161013-00003#2 Add  ---(E)---

      END FOREACH
      IF g_success = 'N' THEN
         RETURN
      END IF
   END IF
   
   IF g_cnt1 = 0 AND g_cnt2 = 0 AND g_cnt3 = 0 THEN
      LET g_success = 'N'
      RETURN
   END IF
   
#   IF g_master.diff = '2' THEN
#      CALL axrp400_ar_diff()
#   END IF

#   IF NOT cl_null(g_xrdadocno) THEN 
#      CALL s_pre_voucher_ins('AR','R20',g_master.xrdald,g_xrdadocno,g_master.xrdadocdt,'2') RETURNING l_success
#      
#      IF l_success THEN
#         LET g_success = 'Y'   
#      ELSE
#         LET g_success = 'N' 
#      END IF
#   END IF

END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ar_amt(p_xrccdocno,p_xrccseq,p_xrcc001)
   DEFINE p_xrccdocno         LIKE xrcc_t.xrccdocno
   DEFINE p_xrccseq           LIKE xrcc_t.xrccseq
   DEFINE p_xrcc001           LIKE xrcc_t.xrcc001
   DEFINE l_xrca              RECORD LIKE xrca_t.*
   DEFINE l_flag              LIKE type_t.chr1
   DEFINE l_xrce109           LIKE xrce_t.xrce109
   DEFINE l_xrce119           LIKE xrce_t.xrce119
   DEFINE l_xrce129           LIKE xrce_t.xrce129
   DEFINE l_xrce139           LIKE xrce_t.xrce139
   DEFINE r_xrcc              RECORD
             xrcc109             LIKE xrcc_t.xrcc109,
             xrcc119             LIKE xrcc_t.xrcc119,
             xrcc129             LIKE xrcc_t.xrcc129,
             xrcc139             LIKE xrcc_t.xrcc139
                              END RECORD

   #獲取該應收單可沖金額：應收-已收-預收
      #應收 - 已收
      SELECT xrcc108 - xrcc109,xrcc118 - xrcc119,xrcc128 - xrcc129,xrcc138 - xrcc139
        INTO r_xrcc.xrcc109,r_xrcc.xrcc119,r_xrcc.xrcc129,r_xrcc.xrcc139
        FROM xrcc_t
       WHERE xrccent = g_enterprise   AND xrccdocno = p_xrccdocno
         AND xrccld  = g_master.xrdald AND xrccseq = p_xrccseq
         AND xrcc001 = p_xrcc001
      IF cl_null(r_xrcc.xrcc109) THEN LET r_xrcc.xrcc109 = 0 END IF
      IF cl_null(r_xrcc.xrcc119) THEN LET r_xrcc.xrcc119 = 0 END IF
      IF cl_null(r_xrcc.xrcc129) THEN LET r_xrcc.xrcc129 = 0 END IF
      IF cl_null(r_xrcc.xrcc139) THEN LET r_xrcc.xrcc139 = 0 END IF

      #預收
      SELECT SUM(xrce109),SUM(xrce119),SUM(xrce129),SUM(xrce139)
        INTO l_xrce109,l_xrce119,l_xrce129,l_xrce139
        FROM xrce_t,xrda_t
       WHERE xrceent = xrdaent AND xrdadocno = xrcedocno 
         AND xrdald    = xrceld
         AND xrce003 = p_xrccdocno AND xrce004 = p_xrccseq 
         AND xrce005 = p_xrcc001 AND xrdastus = 'N'
      IF cl_null(l_xrce109) THEN LET l_xrce109 = 0 END IF
      IF cl_null(l_xrce119) THEN LET l_xrce119 = 0 END IF
      IF cl_null(l_xrce129) THEN LET l_xrce129 = 0 END IF
      IF cl_null(l_xrce139) THEN LET l_xrce139 = 0 END IF
      LET r_xrcc.xrcc109 = r_xrcc.xrcc109 - l_xrce109
      LET r_xrcc.xrcc119 = r_xrcc.xrcc119 - l_xrce119
      LET r_xrcc.xrcc129 = r_xrcc.xrcc129 - l_xrce129
      LET r_xrcc.xrcc139 = r_xrcc.xrcc139 - l_xrce139


   RETURN r_xrcc.*
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ar_diff(p_xrdadocno)
   DEFINE p_xrdadocno   LIKE xrda_t.xrdadocno
   DEFINE l_glab003     LIKE glab_t.glab003
   DEFINE l_xrde_t      RECORD LIKE xrde_t.*
   DEFINE l_sql         STRING
   DEFINE l_xrde100     LIKE xrde_t.xrde100
   DEFINE l_xrde109     LIKE xrde_t.xrde109
   DEFINE l_xrde119     LIKE xrde_t.xrde119
   DEFINE l_xrde109_1   LIKE xrde_t.xrde109
   DEFINE l_xrde119_1   LIKE xrde_t.xrde119
   DEFINE l_xrde109_2   LIKE xrde_t.xrde109
   DEFINE l_xrde119_2   LIKE xrde_t.xrde119
   DEFINE l_ooab002     LIKE ooab_t.ooab002
   DEFINE l_amt         LIKE xrde_t.xrde119   #匯差
 
   SELECT MAX(xrdeseq) + 1 INTO l_xrde_t.xrdeseq
     FROM xrde_t
    WHERE xrdeent = g_enterprise 
      AND xrdeld = g_master.xrdald
      AND xrdedocno = p_xrdadocno
      
   IF cl_null(l_xrde_t.xrdeseq) THEN 
      LET l_xrde_t.xrdeseq = 1
   END IF
   
   IF l_xrde_t.xrdeseq > 1 THEN 
      SELECT xrde010 INTO l_xrde_t.xrde010
        FROM xrde_t
       WHERE xrdeent = g_enterprise
         AND xrdeld = g_master.xrdald
         AND xrdedocno = p_xrdadocno
         AND xrdeseq = l_xrde_t.xrdeseq - 1 
   END IF

   LET l_xrde_t.xrdeent  = g_enterprise
   LET l_xrde_t.xrdecomp = g_glaa.glaacomp
   LET l_xrde_t.xrdeld   = g_master.xrdald
   LET l_xrde_t.xrdesite = g_master.xrdasite
   LET l_xrde_t.xrdedocno= p_xrdadocno  
   LET l_xrde_t.xrdeorga = g_glaa.glaacomp   
   #本幣
   LET l_sql ="SELECT SUM(xrde109),SUM(xrde119),SUM(xrde109_1),SUM(xrde119_1),SUM(xrde109_2),SUM(xrde119_2)",
              "  FROM (",
              "       SELECT SUM(xrde109) xrde109,SUM(xrde119) xrde119,0 xrde109_1,0 xrde119_1,0 xrde109_2,0 xrde119_2 FROM xrde_t",       #收款金額
              "        WHERE xrde002 = 10",
              "          AND xrdeent = ",g_enterprise,
              "          AND xrdedocno = '",p_xrdadocno,"'",
              "          AND xrdeld = '",g_master.xrdald,"'",
              "        UNION ",
              "       SELECT 0 xrde109,0 xrde119,SUM(xrce109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde109_1,SUM(xrce119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde119_1,0 xrde109_2,0 xrde119_2 FROM xrce_t,gzcb_t",#帳款金額
              "        WHERE xrce002 = gzcb002",
              "          AND gzcb001 = '8306'",
              "          AND gzcb004 = '2'",
              "          AND xrceent = ",g_enterprise,
              "          AND xrcedocno = '",p_xrdadocno,"'",
              "          AND xrceld = '",g_master.xrdald,"'",
              "        UNION ",
              "       SELECT 0 xrde109,0 xrde119,0 xrde109_1,0 xrde119_1,SUM(xrde109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde109_2,SUM(xrde119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END) xrde119_2 FROM xrde_t,gzcb_t",#帳款金額
              "        WHERE xrde002 = gzcb002",
              "          AND gzcb001 = '8306'",
              "          AND gzcb004 = '1'",
              "          AND xrde002 <> 10",
              "          AND xrdeent = ",g_enterprise,
              "          AND xrdedocno = '",p_xrdadocno,"'",
              "          AND xrdeld = '",g_master.xrdald,"'",
              "      )"
   PREPARE axrt400_01_prep31 FROM l_sql
   DECLARE axrt400_01_xrde1 CURSOR FOR axrt400_01_prep31

   FOREACH axrt400_01_xrde1 INTO l_xrde109,l_xrde119,l_xrde109_1,l_xrde119_1,l_xrde109_2,l_xrde119_2
      IF cl_null(l_xrde109)   THEN LET l_xrde109   = 0 END IF
      IF cl_null(l_xrde119)   THEN LET l_xrde119   = 0 END IF
      IF cl_null(l_xrde109_1) THEN LET l_xrde109_1 = 0 END IF
      IF cl_null(l_xrde119_1) THEN LET l_xrde119_1 = 0 END IF
      IF cl_null(l_xrde109_2) THEN LET l_xrde109_2 = 0 END IF
      IF cl_null(l_xrde119_2) THEN LET l_xrde119_2 = 0 END IF
      #本幣帳款 < 收款:12.匯兌收益;　反之(11.匯損).
      #需要考慮本位幣二、三產生的匯兌損益
      IF l_xrde119 - l_xrde119_2 != l_xrde119_1 THEN
         LET l_amt = l_xrde119 + l_xrde119_1 + l_xrde119_2

         IF l_amt < 0 THEN
            LET l_xrde_t.xrde002  = '11'
            LET l_glab003 = '9711_11'
            LET l_amt = l_amt * -1
         ELSE
            LET l_xrde_t.xrde002  = '12'
            LET l_glab003 = '9711_12'
         END IF
         SELECT gzcb003 INTO l_xrde_t.xrde015 FROM gzcb_t
          WHERE gzcb002 = l_xrde_t.xrde002
            AND gzcb001 = '8306'
         LET l_xrde_t.xrde006  = ''
#         IF g_prog = 'axrt400' THEN 
            LET l_xrde_t.xrde001  = 'axrt400'
#         ELSE
#            LET l_xrde_t.xrde001  = 'axrt300'
#         END IF
         LET l_xrde_t.xrde003  = ''
         LET l_xrde_t.xrde004  = ''
         LET l_xrde_t.xrde008  = ''
         LET l_xrde_t.xrde013  = ''
         LET l_xrde_t.xrde014  = ''
         LET l_xrde_t.xrde100  = g_glaa.glaa001
         LET l_xrde_t.xrde101  = 1
         LET l_xrde_t.xrde109  = 0
         LET l_xrde_t.xrde119  = l_amt
         LET l_xrde_t.xrde120 = g_glaa.glaa016
         LET l_xrde_t.xrde121 = 0
         LET l_xrde_t.xrde129 = 0
         LET l_xrde_t.xrde130 = g_glaa.glaa020
         LET l_xrde_t.xrde131 = 0
         LET l_xrde_t.xrde139 = 0
         LET l_xrde_t.xrde017  = g_master.xrda003
         
         SELECT ooag003 INTO l_xrde_t.xrde018 FROM ooag_t
          WHERE ooagent = g_enterprise
            AND ooag001 = g_master.xrda003
         
         SELECT glaacomp INTO l_xrde_t.xrdeorga 
           FROM glaa_t
          WHERE glaaent = g_enterprise
            AND glaald  = g_ld
         LET l_xrde_t.xrde019  = l_xrde_t.xrdeorga
         LET l_xrde_t.xrde020  = ''
         LET l_xrde_t.xrde022  = ''
         LET l_xrde_t.xrde023  = ''
         
             
         SELECT glab005,glab010 INTO l_xrde_t.xrde016,l_xrde_t.xrde011 FROM glab_t
          WHERE glabent = g_enterprise
            AND glabld = g_master.xrdald
            AND glab003 = l_glab003
         
         SELECT nmad003 INTO l_xrde_t.xrde012 FROM nmad_t
          WHERE nmadent = g_enterprise
            AND nmad001 = g_glaa.glaa005
            AND nmad002 = l_xrde_t.xrde011
           
         #SELECT gzcb003 INTO l_xrde_t.xrde015 FROM gzcb_t
         # WHERE gzcb002 = '20'
         #   AND gzcb001 = '8306'
            
         IF l_xrde_t.xrde119 < 0 THEN 
            LET l_xrde_t.xrde119 = l_xrde_t.xrde119 * -1
         END IF
         
         IF l_xrde_t.xrde129 < 0 THEN 
            LET l_xrde_t.xrde129 = l_xrde_t.xrde129 * -1
         END IF
         
         IF l_xrde_t.xrde139 < 0 THEN 
            LET l_xrde_t.xrde139 = l_xrde_t.xrde139 * -1
         END IF

         #INSERT INTO xrde_t VALUES(l_xrde_t.*)
         INSERT INTO xrde_t(xrdeent,xrdecomp,xrdeld,xrdesite,xrdeorga,xrdedocno,xrdeseq,xrde001,
                            xrde002,xrde003,xrde004,xrde006,xrde008,xrde032,xrde010,xrde011,xrde012,xrde013,  #160912-00038#1 add xede032
                            xrde014,xrde015,xrde016,xrde017,xrde018,xrde019,xrde020,xrde022,xrde023,
                            xrde100,xrde101,xrde109,xrde119,xrde120,xrde121,xrde129,xrde130,xrde131,xrde139)
                     VALUES(l_xrde_t.xrdeent ,l_xrde_t.xrdecomp ,l_xrde_t.xrdeld ,l_xrde_t.xrdesite,
                            l_xrde_t.xrdeorga,l_xrde_t.xrdedocno,l_xrde_t.xrdeseq,l_xrde_t.xrde001,
                            l_xrde_t.xrde002 ,l_xrde_t.xrde003  ,l_xrde_t.xrde004,l_xrde_t.xrde006,
                            l_xrde_t.xrde008 ,'',l_xrde_t.xrde010  ,l_xrde_t.xrde011,l_xrde_t.xrde012,     #160912-00038#1 add ''
                            l_xrde_t.xrde013 ,l_xrde_t.xrde014  ,l_xrde_t.xrde015,l_xrde_t.xrde016,
                            l_xrde_t.xrde017 ,l_xrde_t.xrde018  ,l_xrde_t.xrde019,l_xrde_t.xrde020,
                            l_xrde_t.xrde022 ,l_xrde_t.xrde023  ,l_xrde_t.xrde100,l_xrde_t.xrde101,
                            l_xrde_t.xrde109 ,l_xrde_t.xrde119  ,l_xrde_t.xrde120,l_xrde_t.xrde121,
                            l_xrde_t.xrde129 ,l_xrde_t.xrde130  ,l_xrde_t.xrde131,l_xrde_t.xrde139
                            )
         
         
         IF SQLCA.sqlcode THEN
            LET g_success = 'N' RETURN
         END IF
         
         LET l_xrde_t.xrdeseq = l_xrde_t.xrdeseq + 1
         
      END IF

   END FOREACH
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_get_amt()
   DEFINE l_amt1,l_amt2      LIKE xrde_t.xrde109     #收款金額
   DEFINE l_amt3,l_amt4      LIKE xrce_t.xrce109     #帳款金額
   DEFINE l_amt5,l_amt6      LIKE xrce_t.xrce109     #匯差及調整金額
   DEFINE l_amt7,l_amt8      LIKE xrce_t.xrce109     #差異金額
   DEFINE l_amt1_1,l_amt2_1  LIKE xrde_t.xrde109     #收款金額         本位幣二/三
   DEFINE l_amt3_1,l_amt4_1  LIKE xrce_t.xrce109     #帳款金額         本位幣二/三
   DEFINE l_amt5_1,l_amt6_1  LIKE xrce_t.xrce109     #匯差及調整金額    本位幣二/三
   DEFINE l_amt7_1,l_amt8_1  LIKE xrce_t.xrce109     #差異金額         本位幣二/三
   DEFINE l_xrde109_d        LIKE xrde_t.xrde109
   DEFINE l_xrde119_d        LIKE xrde_t.xrde109
   DEFINE l_xrde129_d        LIKE xrde_t.xrde109
   DEFINE l_xrde139_d        LIKE xrde_t.xrde109
   DEFINE l_xrce109_d        LIKE xrce_t.xrce109
   DEFINE l_xrce119_d        LIKE xrce_t.xrce109
   DEFINE l_xrce129_d        LIKE xrce_t.xrce109
   DEFINE l_xrce139_d        LIKE xrce_t.xrce109
   DEFINE l_xrde109_c        LIKE xrde_t.xrde109
   DEFINE l_xrde119_c        LIKE xrde_t.xrde109
   DEFINE l_xrde129_c        LIKE xrde_t.xrde109
   DEFINE l_xrde139_c        LIKE xrde_t.xrde109
   DEFINE l_xrce109_c        LIKE xrce_t.xrce109
   DEFINE l_xrce119_c        LIKE xrce_t.xrce109
   DEFINE l_xrce129_c        LIKE xrce_t.xrce109
   DEFINE l_xrce139_c        LIKE xrce_t.xrce109
   
   #計算收款
   SELECT SUM(xrde109),SUM(xrde119) INTO l_amt1,l_amt2 FROM xrde_t,gzcb_t
    WHERE xrdeent = g_enterprise
      AND xrdeld  = g_master.xrdald
      AND xrdedocno = g_xrdadocno
      AND xrde002 = gzcb002
      AND gzcb001 = '8306'
      AND gzcb004 = '1'
      AND xrde002 = '10'
   IF cl_null(l_amt1) THEN LET l_amt1 = 0 END IF
   IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
   
   #計算帳款
   SELECT SUM(xrce109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END),SUM(xrce119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END)
     INTO l_amt3,l_amt4
     FROM xrce_t,gzcb_t
    WHERE xrceent = g_enterprise
      AND xrceld  = g_master.xrdald
      AND xrcedocno = g_xrdadocno
      AND gzcb001 = '8306'
      AND gzcb004 = '2'
      AND gzcb002 = xrce002
   IF cl_null(l_amt3) THEN LET l_amt3 = 0 END IF
   IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
   
   #計算匯差及調整帳款
   SELECT SUM(xrde109 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END),SUM(xrde119 * CASE WHEN gzcb003 = 'D' THEN 1 ELSE -1 END)
     INTO l_amt5,l_amt6
     FROM xrde_t,gzcb_t
    WHERE xrdeent = g_enterprise
      AND xrdeld  = g_master.xrdald
      AND xrdedocno = g_xrdadocno
      AND xrde002 = gzcb002
      AND gzcb001 = '8306'
      AND xrde002 <> 10
      AND gzcb004 = '1'
   IF cl_null(l_amt5) THEN LET l_amt5 = 0 END IF
   IF cl_null(l_amt6) THEN LET l_amt6 = 0 END IF
   
   LET l_amt7 = 0
   LET l_amt8 = l_amt2 + l_amt4 + l_amt6
   INSERT INTO axrp400_s01_tmp VALUES(g_master.diff,g_xrdadocno,l_amt2,l_amt4,l_amt8)
   LET g_amt1 = l_amt8
END FUNCTION

################################################################################
# Descriptions...: 將取回的字串轉換為SQL條件
################################################################################
PRIVATE FUNCTION axrp400_change_to_sql(p_wc)
   DEFINE p_wc       STRING
   DEFINE r_wc       STRING
   DEFINE tok        base.StringTokenizer
   DEFINE l_str      STRING

   LET tok = base.StringTokenizer.create(p_wc,",")
   WHILE tok.hasMoreTokens()
      IF cl_null(l_str) THEN
         LET l_str = tok.nextToken()
      ELSE
         LET l_str = l_str,"','",tok.nextToken()
      END IF
   END WHILE
   LET r_wc = "'",l_str,"'"

   RETURN r_wc
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_construct()
    DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE li_idx1           LIKE type_t.num10
   DEFINE l_n               LIKE type_t.num10
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_xrdasite        LIKE xrda_t.xrdasite
   DEFINE l_xrdald          LIKE xrda_t.xrdald
   DEFINE l_xrda003         LIKE xrda_t.xrda003
   DEFINE l_xrdadocdt       LIKE xrda_t.xrdadocdt
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_success_1    LIKE type_t.num5
   DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                   oofg019     LIKE oofg_t.oofg019,   #field
                   oofg020     LIKE oofg_t.oofg020    #value
                           END RECORD
   DEFINE l_origin_str      STRING
   #end add-point 

   CLEAR FORM
   INITIALIZE g_wc  TO NULL
   INITIALIZE g_wc2 TO NULL
   CALL cl_set_act_visible("accept,cancel", FALSE)
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

         #add-point:ui_dialog段input
         INPUT BY NAME g_master.xrdasite,g_master.xrdald,g_master.xrdadocno,g_master.xrda003,g_master.xrdadocdt, 
                       g_master.xrca063,g_master.chk,g_master.diff
             
            BEFORE INPUT
               CALL axrp400_def()
               LET g_master.xrdadocdt = g_today
               DISPLAY BY NAME g_master.*
               
            ON ACTION controlp INFIELD xrdasite
                INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.xrdasite       #給予default值
               #LET g_qryparam.where = " ooef201 = 'Y' " #160811-00009#4 

               #給予arg

               #CALL q_ooef001()                                 #呼叫開窗    #161021-00050#3 mark
               LET g_qryparam.where = " ooefstus = 'Y' "                     #161021-00050#3 add
               CALL q_ooef001_46()                                           #161021-00050#3 add
               LET g_master.xrdasite = g_qryparam.return1        #將開窗取得的值回傳到變數
               IF NOT cl_null(g_master.xrdasite) THEN
                  CALL s_axrt300_site_geared_ld(g_master.xrdasite,g_master.xrdald,g_user,g_today,'site')
                     RETURNING l_success,g_master.xrdasite,g_master.xrdasite_desc,g_master.xrdald,g_master.xrdald_desc
                  SELECT * INTO g_glaa.* FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
               END IF
               DISPLAY g_master.xrdasite TO xrdasite             #顯示到畫面上
               CALL axrp400_xrda_dis('site')
               NEXT FIELD xrdasite                               #返回原欄位
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrdasite
            #add-point:BEFORE FIELD xrdasite
            LET l_xrdasite = g_master.xrdasite
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrdasite
            
            #add-point:AFTER FIELD xrdasite
             LET g_master.xrdasite_desc = ' '
               DISPLAY BY NAME g_master.xrdasite_desc
               IF NOT cl_null(g_master.xrdasite) THEN
                  IF NOT cl_null(g_master.xrdasite) THEN
                     CALL s_axrt300_site_geared_ld(g_master.xrdasite,g_master.xrdald,g_user,g_today,'site')
                        RETURNING l_success,g_master.xrdasite,g_master.xrdasite_desc,g_master.xrdald,g_master.xrdald_desc
                     DISPLAY BY NAME g_master.xrdasite,g_master.xrdasite_desc
                     DISPLAY BY NAME g_master.xrdald,g_master.xrdald_desc
                     IF NOT l_success THEN NEXT FIELD CURRENT END IF
                  ELSE
                     LET g_master.xrdasite_desc = ''
                  END IF
                  CALL s_fin_create_account_center_tmp()
                  CALL s_fin_account_center_sons_query('3',g_master.xrdasite,g_today,'1')
                  IF cl_null(g_master.xrdasite) THEN
                    CALL s_fin_orga_get_comp_ld(g_master.xrdasite) RETURNING l_success,g_errno,g_master.xrdacomp_desc,g_master.xrdald
                  END IF
                  CALL s_fin_account_center_with_ld_chk(g_master.xrdasite,g_master.xrdald,g_user,'3','N','',g_master.xrdadocdt) RETURNING l_success,g_errno
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_master.xrdasite
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_master.xrdasite = ''
                     LET g_master.xrdald = ''
                     LET g_master.xrdacomp_desc = ''
                     
                     CALL axrp400_xrda_dis('site')
                     DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc
                     NEXT FIELD CURRENT
                  END IF
                  CALL s_axrt300_date_chk(g_master.xrdasite,g_master.xrdadocdt) RETURNING l_success
                  IF NOT l_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = ""
                     LET g_errparam.code   = "axr-00299"
                     LET g_errparam.popup  = TRUE
                     CALL cl_err()
                     LET g_master.xrdasite = ''
                     LET g_master.xrdald = ''
                     LET g_master.xrdacomp_desc = ''
                     DISPLAY BY NAME g_master.xrdald_desc,g_master.xrdacomp_desc
                     NEXT FIELD CURRENT
                  END IF
#                  
               END IF
               CALL axrp400_xrda_dis('site')
               CALL axrp400_xrda_dis('ld')
            #END add-point
            
 
            #Ctrlp:construct.c.xrdald
            #應用 a03 樣板自動產生(Version:2)
            ON ACTION controlp INFIELD xrdald
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_master.xrdald         #給予default值
               #取得帳務組織下所屬成員
               CALL s_fin_account_center_sons_query('3',g_master.xrdasite,g_master.xrdadocdt,'1')
               #取得帳務組織下所屬成員之帳別
               CALL s_fin_account_center_comp_str() RETURNING l_origin_str
               #將取回的字串轉換為SQL條件
               CALL axrp400_change_to_sql(l_origin_str) RETURNING l_origin_str
#160811-00009#4 mod s---               
#               IF l_origin_str <> '''' THEN
#                  LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y') AND glaacomp IN (",l_origin_str," )"
#               ELSE
#                  LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y')"
#               END IF
                LET g_qryparam.where = " (glaa008 = 'Y' OR glaa014 = 'Y') AND glaacomp IN (",l_origin_str," )"
#160811-00009#4 mod e---
               LET g_qryparam.arg1 = g_user
               LET g_qryparam.arg2 = g_dept
               CALL  q_authorised_ld()                           #呼叫開窗
               LET g_master.xrdald = g_qryparam.return1          #將開窗取得的值回傳到變數
               DISPLAY g_master.xrdald TO xrdald                 #顯示到畫面上
               LET g_qryparam.where = ''
               CALL axrp400_xrda_dis('ld')
               NEXT FIELD xrdald                                 #返回原欄位
 
            #應用 a01 樣板自動產生(Version:1)
            BEFORE FIELD xrdald
               #add-point:BEFORE FIELD xrdald
               LET l_xrdald = g_master.xrdald
               #END add-point
 
            #應用 a02 樣板自動產生(Version:1)
            AFTER FIELD xrdald
            
               #add-point:AFTER FIELD xrdald
               LET g_master.xrdald_desc = ' '
               DISPLAY BY NAME g_master.xrdald_desc
               IF NOT cl_null(g_master.xrdald) THEN
                  CALL s_fin_account_center_with_ld_chk(g_master.xrdasite,g_master.xrdald,g_user,'3','N','',g_master.xrdadocdt) RETURNING l_success,g_errno
                  IF NOT cl_null(g_errno) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = g_master.xrdald
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.xrdald = ''
                     CALL axrp400_xrda_dis('ld')
                     NEXT FIELD CURRENT
                  END IF
               END IF
               CALL axrp400_xrda_dis('ld')
            #END add-point
            
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD glaacomp_desc
            #add-point:BEFORE FIELD glaacomp_desc

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD glaacomp_desc
            
            #add-point:AFTER FIELD glaacomp_desc

            #END add-point
            
 
         #Ctrlp:construct.c.glaacomp_desc
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD glaacomp_desc
            #add-point:ON ACTION controlp INFIELD glaacomp_desc

            #END add-point
 
         #Ctrlp:construct.c.xrdadocno
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrdadocno
            #add-point:ON ACTION controlp INFIELD xrdadocno
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_master.xrdadocno             #給予default值
            LET l_glaa024 = ''
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
            #給予arg
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = "axrt400"
            
            CALL q_ooba002_1()                                #呼叫開窗

            LET g_master.xrdadocno = g_qryparam.return1              

            DISPLAY g_master.xrdadocno TO xrdadocno              #

            NEXT FIELD xrdadocno                          #返回原欄位
    


            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrdadocno
            #add-point:BEFORE FIELD xrdadocno

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrdadocno
            
            #add-point:AFTER FIELD xrdadocno
            LET l_glaa024 = ''
            SELECT glaa024 INTO l_glaa024 FROM glaa_t WHERE glaaent = g_enterprise AND glaald = g_master.xrdald
            IF NOT cl_null(g_master.xrdadocno) THEN
               CALL s_aooi200_fin_chk_slip(g_master.xrdald,l_glaa024,g_master.xrdadocno,'axrt400') RETURNING l_success
               IF l_success = FALSE THEN
                  LET g_master.xrdadocno = ''
                  NEXT FIELD xrdadocno
               END IF
            END IF
            #END add-point
            
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrda003
            #add-point:BEFORE FIELD xrda003
            LET l_xrda003 = g_master.xrda003
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrda003
            
            #add-point:AFTER FIELD xrda003
            IF NOT cl_null(g_master.xrda003) THEN 
#此段落由子樣板a19產生
               #校驗代值
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_master.xrda003
               #160318-00025#35  2016/05/15  by pengxin  add(S)
               LET g_errshow = TRUE #是否開窗 
               LET g_chkparam.err_str[1] = "aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"
               #160318-00025#35  2016/05/15  by pengxin  add(E)
                  
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooag001") THEN
                  #檢查成功時後續處理
                  #LET  = g_chkparam.return1
                  #DISPLAY BY NAME 
               ELSE
                  #檢查失敗時後續處理
                  LET g_master.xrda003 = l_xrda003
                  CALL axrp400_ref_xrda003()
                  NEXT FIELD CURRENT
               END IF
            
               CALL axrp400_ref_xrda003() 
            END IF 
            #END add-point
            
 
         #Ctrlp:construct.c.xrda003
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrda003
            #add-point:ON ACTION controlp INFIELD xrda003
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_master.xrda003             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #

            
            CALL q_ooag001()                                #呼叫開窗

            LET g_master.xrda003 = g_qryparam.return1       
            CALL axrp400_ref_xrda003()            

            DISPLAY g_master.xrda003 TO xrda003              #

            NEXT FIELD xrda003                          #返回原欄位
            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrdadocdt
            #add-point:BEFORE FIELD xrdadocdt
            LET l_xrdadocdt = g_master.xrdadocdt
            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrdadocdt
            
            #add-point:AFTER FIELD xrdadocdt
            IF NOT cl_null(g_master.xrdadocdt) THEN
               CALL s_axrt300_date_chk(g_master.xrdasite,g_master.xrdadocdt) RETURNING l_success
               IF NOT l_success THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = "axr-00299"
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET g_master.xrdadocdt = l_xrdadocdt
                  NEXT FIELD CURRENT
               END IF
            END IF
            #END add-point
            
 
         #Ctrlp:construct.c.xrdadocdt
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrdadocdt
            #add-point:ON ACTION controlp INFIELD xrdadocdt

            #END add-point
 
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD xrca063
            #add-point:BEFORE FIELD xrca063

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD xrca063
            
            #add-point:AFTER FIELD xrca063

            #END add-point
            
 
         #Ctrlp:construct.c.xrca063
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD xrca063
            #add-point:ON ACTION controlp INFIELD xrca063
            CALL s_aooi390_gen('14') RETURNING l_success_1,g_master.xrca063,l_oofg_return
            DISPLAY BY NAME g_master.xrca063
            NEXT FIELD xrca063
            #END add-point
 
  
         #應用 a01 樣板自動產生(Version:1)
         BEFORE FIELD diff
            #add-point:BEFORE FIELD diff

            #END add-point
 
         #應用 a02 樣板自動產生(Version:1)
         AFTER FIELD diff
            
            #add-point:AFTER FIELD diff

            #END add-point
            
 
         #Ctrlp:construct.c.diff
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD diff
            #add-point:ON ACTION controlp INFIELD diff

            #END add-point
 
         END INPUT
         
      CONSTRUCT BY NAME g_wc1 ON b_nmbbdocno,b_nmbbseq,b_nmbb026,b_nmbadocdt,b_nmbb029,b_nmbb004,b_nmba008,b_nmbb031,b_nmbb030,b_nmbb003
             BEFORE CONSTRUCT
                  
         #Ctrlp:construct.c.nmbbdocno
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbbdocno
            #add-point:ON ACTION controlp INFIELD nmbbdocno
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " nmbbcomp = '",g_glaa.glaacomp,"'"
           #CALL q_nmbbdocno()                           #呼叫開窗   #160912-00011#2 Mark
            CALL q_nmbbdocno_1()                           #呼叫開窗   #160912-00011#2 Add
            LET g_qryparam.where = ""
            DISPLAY g_qryparam.return1 TO b_nmbbdocno  #顯示到畫面上
            NEXT FIELD b_nmbbdocno                     #返回原欄位
            #END add-point
 
         
         #Ctrlp:construct.c.nmbb026
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb026
            #add-point:ON ACTION controlp INFIELD nmbb026
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_glaa.glaacomp
            CALL q_pmaa001_13()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb026      #顯示到畫面上
            NEXT FIELD b_nmbb026                         #返回原欄位
            #END add-point
           

         #Ctrlp:construct.c.nmbb004
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb004
            #add-point:ON ACTION controlp INFIELD nmbb004
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_aooi001_1()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb004      #顯示到畫面上
            NEXT FIELD b_nmbb004                         #返回原欄位
            #END add-point
            
         #Ctrlp:construct.c.nmba008
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmba008
            #add-point:ON ACTION controlp INFIELD nmba008
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmba008  #顯示到畫面上
            NEXT FIELD b_nmba008                    #返回原欄位
            #END add-point
 
         #Ctrlp:construct.c.nmbb030
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb030
            #add-point:ON ACTION controlp INFIELD nmbb030
            #應用 a08 樣板自動產生(Version:2)
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_nmbb030_02()                         #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb030      #顯示到畫面上
            NEXT FIELD b_nmbb030                         #返回原欄位
            #END add-point
        
         #Ctrlp:construct.c.nmbb003
         #應用 a03 樣板自動產生(Version:2)
         ON ACTION controlp INFIELD b_nmbb003
            #add-point:ON ACTION controlp INFIELD nmbb003
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_nmas_01()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO b_nmbb003  #顯示到畫面上
            NEXT FIELD b_nmbb003                     #返回原欄位

            #END add-point
            
         END CONSTRUCT
        
         CONSTRUCT BY NAME g_wc3 ON flag
          
           AFTER CONSTRUCT
             IF g_wc3 = "flag='1'" THEN
                CALL cl_set_combo_scc('b_xrca001','8302')
             ELSE
                CALL cl_set_combo_scc('b_xrca001','8502')
             END IF
        END CONSTRUCT
       
        CONSTRUCT BY NAME g_wc2 ON b_xrcadocno,b_xrccseq,b_xrcc001,b_xrcasite,b_xrca003,b_xrca005,b_xrcald
           BEFORE CONSTRUCT
            IF g_wc3 = "flag='1'" THEN
                CALL cl_set_combo_scc('b_xrca001','8302')
             ELSE
                CALL cl_set_combo_scc('b_xrca001','8502')
             END IF
         
            #Ctrlp:construct.c.xrcadocno
            #應用 a03 樣板自動產生(Version:2)
            ON ACTION controlp INFIELD b_xrcadocno
               #add-point:ON ACTION controlp INFIELD xrcadocno
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
			      IF g_wc3 = "flag='1'" OR g_wc3 = " 1=1" THEN   #160530-00005#5 Add g_wc3 = " 1=1"
                  LET g_qryparam.where= "xrcadocdt <= '",g_master.xrdadocdt,"'",
                                        " AND xrca001 NOT IN ('01','02','03','04','31','141','142')",
                                        " AND xrcald ='",g_master.xrdald,"'",
                                        " AND xrcadocno IN (SELECT UNIQUE xrcadocno FROM axrp400_cum_tmp )"  #160530-00005#5 Del NOT
                  CALL q_xrcadocno_12()                         #呼叫開窗
               ELSE
                  LET g_qryparam.where= "apcadocdt <= '",g_master.xrdadocdt,"'",
                                        " AND apcald ='",g_master.xrdald,"'",
                                        " AND apcadocno IN (SELECT UNIQUE xrcadocno FROM axrp400_cum_tmp )"  #160530-00005#5 Del NOT
                  CALL q_apcadocno_14()
               END IF
               DISPLAY g_qryparam.return1 TO b_xrcadocno      #顯示到畫面上
               LET g_qryparam.where=NULL
               NEXT FIELD b_xrcadocno                        #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrcasite
               #add-point:ON ACTION controlp INFIELD xrcasite
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               #CALL q_ooef001()                           #呼叫開窗   #161021-00050#3 mark
               CALL q_ooef001_46()                                    #161021-00050#3 add
               DISPLAY g_qryparam.return1 TO b_xrcasite    #顯示到畫面上
               NEXT FIELD b_xrcasite                       #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrca003
               #add-point:ON ACTION controlp INFIELD xrca003
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_ooag001()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca003      #顯示到畫面上
               NEXT FIELD b_xrca003                      #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrca005
               #add-point:ON ACTION controlp INFIELD xrca005
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
			      LET g_qryparam.arg1 = g_glaa.glaacomp
               CALL q_pmaa001_13()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca005      #顯示到畫面上
               NEXT FIELD b_xrca005                      #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrcald
               #add-point:ON ACTION controlp INFIELD xrcald
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_authorised_ld()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrcald     #顯示到畫面上
               NEXT FIELD b_xrcld                      #返回原欄位
               #END add-point
            
         END CONSTRUCT
         #end add-point
      
#      ON ACTION cum_query  #累計查詢
#         CALL axrp400_cum_query()
#         ACCEPT DIALOG
      
      ON ACTION qbe_select      
 
      ON ACTION qbe_save       
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0 
      RETURN
   END IF
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ui_dialog_1()
   DEFINE li_idx   LIKE type_t.num10
   #add-point:ui_dialog段define
   DEFINE li_idx1           LIKE type_t.num10
   DEFINE l_n               LIKE type_t.num10
   DEFINE l_success         LIKE type_t.chr1
   DEFINE l_xrdasite        LIKE xrda_t.xrdasite
   DEFINE l_xrdald          LIKE xrda_t.xrdald
   DEFINE l_xrda003         LIKE xrda_t.xrda003
   DEFINE l_xrdadocdt       LIKE xrda_t.xrdadocdt
   DEFINE l_glaa024         LIKE glaa_t.glaa024
   DEFINE l_success_1    LIKE type_t.num5
   DEFINE l_oofg_return    DYNAMIC ARRAY OF RECORD
                   oofg019     LIKE oofg_t.oofg019,   #field
                   oofg020     LIKE oofg_t.oofg020    #value
                           END RECORD
   DEFINE l_origin_str      STRING
   DEFINE l_amt2             LIKE xrde_t.xrde109     #收款金額
   DEFINE l_amt4             LIKE xrce_t.xrce109     #帳款金額
   DEFINE l_amt6             LIKE xrce_t.xrce109     #匯差及調整金額
   DEFINE l_amt8             LIKE xrce_t.xrce109     #差異金額
   #160325-00025#1---(S)
   DEFINE l_set_o            DYNAMIC ARRAY OF RECORD 
                               sel  LIKE type_t.chr1,    #第1單身紀錄選取狀況  
                               sel1 LIKE type_t.chr1     #第2單身紀錄選取狀況 
                             END RECORD                               
   #160325-00025#1---(E)                          
   #end add-point 
   #add-point:ui_dialog段define

   #end add-point 
   
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()   
   
   LET g_action_choice = " "  
   CALL cl_set_act_visible("accept,cancel", FALSE)
         
   LET g_detail_cnt = g_detail_d.getLength()
   #add-point:ui_dialog段before dialog 

   #end add-point
   
   WHILE TRUE
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_detail_d.clear()
         CALL g_detail2_d.clear()
         LET g_wc  = ' 1=2'
         LET g_wc1 = ' 1=1'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL axrp400_init()
      END IF
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
          

         #end add-point
         #add-point:ui_dialog段input
         
         INPUT ARRAY g_detail_d FROM s_detail1.* 
              ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)
            BEFORE INPUT
               IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
                 CALL FGL_SET_ARR_CURR(g_detail_d.getLength()+1) 
                 LET g_insert = 'N' 
               END IF 
               CALL cl_set_comp_entry("b_nmbbdocno,b_nmbbseq,b_nmbb026,b_nmbadocdt,b_nmbb029,b_nmbb004,b_nmbb006,b_nmbb008,
                                       b_nmba008,b_nmbb031,b_nmbb030,b_nmbb040,b_nmbb003,b_nmbb005,b_nmbb009",FALSE)
             
            BEFORE ROW
               LET l_ac = ARR_CURR()
               LET g_master_idx = l_ac
               DISPLAY l_ac TO FORMONLY.h_index
              #CALL axrp400_fetch()              
               
            ON CHANGE sel
               #161003-00015#1--add--str--
               LET l_ac = ARR_CURR()
               LET g_master_idx = l_ac
               DISPLAY l_ac TO FORMONLY.h_index
               #161003-00015#1--add--end
               UPDATE axrp400_tmp 
                  SET sel = g_detail_d[l_ac].sel 
                WHERE nmbbdocno = g_detail_d[l_ac].nmbbdocno  
                  AND nmbbseq = g_detail_d[l_ac].nmbbseq
               
               CALL axrp400_ref_nmbb_amt(g_detail_d[l_ac].sel,g_detail_d[l_ac].nmbbdocno,g_detail_d[l_ac].nmbbseq,l_amt2) RETURNING l_amt2
               IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
               LET l_amt8 = l_amt2 + l_amt4
               DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
                  
         END INPUT
         

          INPUT ARRAY g_detail2_d FROM s_detail2.* 
              ATTRIBUTE(COUNT = g_rec_b1,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)
            BEFORE INPUT
                LET g_rec_b = g_detail2_d.getLength()
                CALL cl_set_comp_entry("flag,b_xrcadocno,b_xrccseq,b_xrcc001,b_xrca001,b_xrcasite,b_xrca003,b_xrca005,b_xrcald,
                                        b_xrcadocdt,b_xrcc108,b_xrcc109,b_xrcc108_1",FALSE)
             
            BEFORE ROW
               LET l_ac1 = ARR_CURR()
               LET g_master_idx = l_ac1
              #DISPLAY l_ac TO FORMONLY.h_index
              #CALL axrp400_fetch()              
               
            ON CHANGE sel1
               #161003-00015#1--add--str--
               LET l_ac1 = ARR_CURR()
               LET g_master_idx = l_ac1
               #161003-00015#1--add--end
#               UPDATE axrp400_tmp    #161003-00015#1 mark
               UPDATE axrp400_cum_tmp #161003-00015#1 add
                  SET sel1 = g_detail2_d[l_ac1].sel1
                WHERE xrcadocno = g_detail2_d[l_ac1].xrcadocno  
                  AND xrccseq = g_detail2_d[l_ac1].xrccseq    
                  AND xrcc001 = g_detail2_d[l_ac1].xrcc001
            
               CALL axrp400_ref_amt1(g_detail2_d[l_ac1].flag,g_detail2_d[l_ac1].sel1,g_detail2_d[l_ac1].xrcadocno,g_detail2_d[l_ac1].xrca001,g_detail2_d[l_ac1].xrccseq,g_detail2_d[l_ac1].xrcc001,l_amt4) RETURNING l_amt4
               IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
               LET l_amt8 = l_amt2 + l_amt4
               DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
               LET g_amt_xrde119 = l_amt2   #161013-00003#2 Add
               LET g_amt_xrce119 = l_amt4   #161013-00003#2 Add
         END INPUT
         #end add-point
         #add-point:ui_dialog段自定義display array
         #應用 a58 樣板自動產生(Version:2)
         
#         DISPLAY ARRAY g_detail_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
#      
#            BEFORE DISPLAY 
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
#               LET l_cnt = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_cnt
#         
#         END DISPLAY
#         DISPLAY ARRAY g_detail2_d TO s_detail2.* ATTRIBUTE(COUNT=g_detail_cnt) 
#      
#            BEFORE DISPLAY 
#               LET g_current_page = 1
# 
#            BEFORE ROW
#               LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
#               LET l_cnt = g_detail_idx
#               DISPLAY g_detail_idx TO FORMONLY.h_index
#               DISPLAY g_detail2_d.getLength() TO FORMONLY.h_count
#               LET g_master_idx = l_cnt
#
#            
#               
#         END DISPLAY

         #end add-point
 
         BEFORE DIALOG
            IF g_detail_d.getLength() > 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.sel1", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.sel1", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #add-point:ui_dialog段before_dialog2
            CALL axrp400_construct()
            CALL axrp400_b_fill()
            #160929-00026#1 Add  ---(S)---
            IF g_detail_d.getLength() = 0 THEN
               CALL gfrm_curr.setFieldHidden("formonly.sel", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.sel1", TRUE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", TRUE)
            ELSE
               CALL gfrm_curr.setFieldHidden("formonly.sel", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.sel1", FALSE)
               CALL gfrm_curr.setFieldHidden("formonly.statepic", FALSE)
            END IF
            #160929-00026#1 Add  ---(E)---
            LET l_amt2 = 0
            LET l_amt4 = 0
            LET l_amt8 = 0
           #CALL axrp400_b_fill1()
            #end add-point
 
         #選擇全部
         ON ACTION selall
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 1)
            #add-point:ui_dialog段on action selall

            #end add-point            
            LET l_amt2 = 0
            LET l_amt4 = 0
            LET l_amt8 = 0
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "Y"
               #add-point:ui_dialog段on action selall
               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq
               CALL axrp400_ref_nmbb_amt(g_detail_d[li_idx].sel,g_detail_d[li_idx].nmbbdocno,g_detail_d[li_idx].nmbbseq,l_amt2) RETURNING l_amt2
               IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
               LET l_amt8 = l_amt2 + l_amt4
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selall
            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 1)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "Y"
#               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
               UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
               CALL axrp400_ref_amt1(g_detail2_d[li_idx1].flag,g_detail2_d[li_idx1].sel1,g_detail2_d[li_idx1].xrcadocno,g_detail2_d[li_idx1].xrca001,g_detail2_d[li_idx1].xrccseq,g_detail2_d[li_idx1].xrcc001,l_amt4)
                 RETURNING l_amt4
               IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
               IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
               IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
               LET l_amt8 = l_amt2 + l_amt4 
            END FOR
            DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
            LET g_amt_xrde119 = l_amt2   #161013-00003#2 Add
            LET g_amt_xrce119 = l_amt4   #161013-00003#2 Add
            #end add-point
 
         #取消全部
         ON ACTION selnone
            CALL DIALOG.setSelectionRange("s_detail1", 1, -1, 0)
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               #add-point:ui_dialog段on action selnone
               
               #end add-point
            END FOR
            #add-point:ui_dialog段on action selnone
            FOR li_idx = 1 TO g_detail_d.getLength()
               LET g_detail_d[li_idx].sel = "N"
               UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                  AND nmbbseq = g_detail_d[li_idx].nmbbseq
            END FOR
            CALL DIALOG.setSelectionRange("s_detail2", 1, -1, 0)
            FOR li_idx1 = 1 TO g_detail2_d.getLength()
               LET g_detail2_d[li_idx1].sel1 = "N"
#               UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
               UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                  AND xrccseq = g_detail2_d[li_idx1].xrccseq
                  AND xrcc001 = g_detail2_d[li_idx1].xrcc001
            END FOR
            LET l_amt2 = 0
            LET l_amt4 = 0
            LET l_amt8 = 0
            DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
            #end add-point
 
         #勾選所選資料
         ON ACTION sel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET l_set_o[li_idx].sel  = g_detail_d[li_idx].sel  #160325-00025#1 add                  
                  LET g_detail_d[li_idx].sel = "Y"
               END IF
            END FOR
            #add-point:ui_dialog段on action sel
            FOR li_idx = 1 TO g_detail_d.getLength()               
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  #有異動才計算               
                  IF l_set_o[li_idx].sel = 'N' THEN                  #160325-00025#1 add
                     LET g_detail_d[li_idx].sel = "Y"
                     UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                      WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                        AND nmbbseq = g_detail_d[li_idx].nmbbseq
                     CALL axrp400_ref_nmbb_amt(g_detail_d[li_idx].sel,g_detail_d[li_idx].nmbbdocno,g_detail_d[li_idx].nmbbseq,l_amt2) RETURNING l_amt2
                     IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
                     IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
                     IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
                     LET l_amt8 = l_amt2 + l_amt4                     
                     DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
                  END IF  #160325-00025#1 add
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()     
               LET l_set_o[li_idx1].sel1 = g_detail2_d[li_idx1].sel1 #160325-00025#1 add            
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN
                  #有異動才計算               
                  IF l_set_o[li_idx1].sel1 ='N' THEN                 #160325-00025#1 add
                     LET g_detail2_d[li_idx1].sel1 = "Y"
#                     UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
                     UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                      WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                        AND xrccseq = g_detail2_d[li_idx1].xrccseq
                        AND xrcc001 = g_detail2_d[li_idx1].xrcc001
                     CALL axrp400_ref_amt1(g_detail2_d[li_idx1].flag,g_detail2_d[li_idx1].sel1,g_detail2_d[li_idx1].xrcadocno,g_detail2_d[li_idx1].xrca001,g_detail2_d[li_idx1].xrccseq,g_detail2_d[li_idx1].xrcc001,l_amt4)
                       RETURNING l_amt4
                     IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
                     IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
                     IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
                     LET l_amt8 = l_amt2 + l_amt4
                     DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
                     LET g_amt_xrde119 = l_amt2   #161013-00003#2 Add
                     LET g_amt_xrce119 = l_amt4   #161013-00003#2 Add
                  END IF  #160325-00025#1 add   
               END IF
            END FOR
            #end add-point
 
         #取消所選資料
         ON ACTION unsel
            FOR li_idx = 1 TO g_detail_d.getLength()
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  LET l_set_o[li_idx].sel  = g_detail_d[li_idx].sel  #160325-00025#1 add
                  LET g_detail_d[li_idx].sel = "N"
               END IF
            END FOR
            #add-point:ui_dialog段on action unsel
            FOR li_idx = 1 TO g_detail_d.getLength()               
               IF DIALOG.isRowSelected("s_detail1", li_idx) THEN
                  #有異動才計算               
                  IF l_set_o[li_idx].sel = 'Y' THEN                   #160325-00025#1 add
                     LET g_detail_d[li_idx].sel = "N"
                     UPDATE axrp400_tmp SET sel = g_detail_d[li_idx].sel 
                      WHERE nmbbdocno = g_detail_d[li_idx].nmbbdocno
                        AND nmbbseq = g_detail_d[li_idx].nmbbseq
                     CALL axrp400_ref_nmbb_amt(g_detail_d[li_idx].sel,g_detail_d[li_idx].nmbbdocno,g_detail_d[li_idx].nmbbseq,l_amt2) RETURNING l_amt2
                     IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
                     IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
                     IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
                     #LET l_amt8 = l_amt8 - l_amt2            #160325-00025#1 mark
                     LET l_amt8 = l_amt2 + l_amt4             #160325-00025#1 add
                     DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
                  END IF  #160325-00025#1 add
               END IF
            END FOR
            FOR li_idx1 = 1 TO g_detail2_d.getLength()   
               LET l_set_o[li_idx1].sel1 = g_detail2_d[li_idx1].sel1  #160325-00025#1 add              
               IF DIALOG.isRowSelected("s_detail2", li_idx1) THEN  
                  #有異動才計算               
                  IF l_set_o[li_idx1].sel1 = 'Y' THEN                 #160325-00025#1 add
                     LET g_detail2_d[li_idx1].sel1 = "N"
#                     UPDATE axrp400_tmp SET sel1 = g_detail2_d[li_idx1].sel1    #161003-00015#1 mark
                     UPDATE axrp400_cum_tmp SET sel1 = g_detail2_d[li_idx1].sel1 #161003-00015#1 add
                      WHERE xrcadocno = g_detail2_d[li_idx1].xrcadocno
                        AND xrccseq = g_detail2_d[li_idx1].xrccseq
                        AND xrcc001 = g_detail2_d[li_idx1].xrcc001
                     CALL axrp400_ref_amt1(g_detail2_d[li_idx1].flag,g_detail2_d[li_idx1].sel1,g_detail2_d[li_idx1].xrcadocno,g_detail2_d[li_idx1].xrca001,g_detail2_d[li_idx1].xrccseq,g_detail2_d[li_idx1].xrcc001,l_amt4)
                       RETURNING l_amt4
                     IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
                     IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
                     IF cl_null(l_amt8) THEN LET l_amt8 = 0 END IF
                     #LET l_amt8 = l_amt8 - l_amt4            #160325-00025#1 mark 
                     LET l_amt8 = l_amt2 + l_amt4             #160325-00025#1 add
                     DISPLAY l_amt2,l_amt4,l_amt8 TO sum5,sum6,sum7
                     LET g_amt_xrde119 = l_amt2   #161013-00003#2 Add
                     LET g_amt_xrce119 = l_amt4   #161013-00003#2 Add
                  END IF  #160325-00025#1 add
               END IF
            END FOR
            #end add-point
      
         ON ACTION filter
            LET g_action_choice="filter"
            CALL axrp400_filter()
            #add-point:ON ACTION filter
            LET l_amt2=0  #161003-00015#1 add
            LET l_amt4=0  #161003-00015#1 add
            LET l_amt8=0  #161003-00015#1 add
            #END add-point
           #EXIT DIALOG   #160620-00010#1 Mark
      
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice = "exit"
            EXIT DIALOG
      
         ON ACTION exit
           #LET INT_FLAG=FALSE
            LET g_action_choice="exit"
            EXIT DIALOG
 
#         ON ACTION accept
#            #add-point:ui_dialog段accept之前
#
#            #end add-point
#            CALL axrp400_query()
             
         # 條件清除
         ON ACTION qbeclear
            #add-point:ui_dialog段
            CLEAR FORM
            INITIALIZE g_master.* TO NULL
            CALL axrp400_def()
            CALL g_detail_d.clear()
            CALL g_detail2_d.clear()
            CALL axrp400_construct()
            CALL axrp400_b_fill()
            LET l_amt2=0  #161003-00015#1 add
            LET l_amt4=0  #161003-00015#1 add
            LET l_amt8=0  #161003-00015#1 add
            DISPLAY 0,0,0 TO sum5,sum6,sum7
           #CALL axrp400_b_fill1()
            #end add-point
 
         # 重新整理
         ON ACTION datarefresh
            LET g_error_show = 1
            #add-point:ui_dialog段datarefresh
            LET l_amt2=0  #161003-00015#1 add
            LET l_amt4=0  #161003-00015#1 add
            LET l_amt8=0  #161003-00015#1 add
            #end add-point
            CALL axrp400_b_fill()
 
         #add-point:ui_dialog段action
         ON ACTION cancel
            #清除畫面及相關資料
            CLEAR FORM
            CALL g_detail_d.clear()
            CALL g_detail2_d.clear()
            LET g_wc  = ' 1=2'
            LET g_wc1 = ' 1=1'
            LET g_wc2 = ' 1=1'
            LET g_action_choice = ""
            CALL axrp400_init()
            DISPLAY 0,0,0 TO sum5,sum6,sum7
            LET INT_FLAG = 0
            EXIT DIALOG 
            
         ON ACTION batch_execute
            SELECT COUNT(*) INTO l_n
              FROM axrp400_tmp
             WHERE (sel = 'Y' OR sel1 = 'Y')
            IF l_n = 0 THEN 
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "" 
               LET g_errparam.code   = 'axr-00159' 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               
               EXIT DIALOG
            END IF
            
            CALL axrp400_get_ar()
            EXIT DIALOG   #160620-00010#1 Add
         
         ON ACTION cum_query  #累計查詢
            CALL axrp400_cum_query()
            CALL axrp400_b_fill1()
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
#      IF INT_FLAG THEN
#         LET INT_FLAG = FALSE
#         EXIT WHILE
#      END IF
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         EXIT WHILE
      END IF
      
   END WHILE
   DROP TABLE axrp400_tmp;
   DROP TABLE axrp400_s01_tmp;
   DROP TABLE s_voucher_ar_tmp;       #160727-00019#6  2016/07/28 By 08734   临时表长度超过15码的减少到15码以下  s_voucher_ar_tmp ——> s_voucher_tmp09 
   DROP TABLE s_voucher_ar_group;     #160727-00019#6  2016/07/29 By 08734   s_voucher_ar_group ——> s_voucher_tmp05         
   DROP TABLE s_voucher_glbc;
   CALL cl_set_act_visible("accept,cancel", TRUE)
END FUNCTION

################################################################################
# Descriptions...: 金額欄位顯示
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ref_amt1(p_flag,p_sel1,p_xrcadocno,p_xrca001,p_xrccseq,p_xrcc001,p_amt4)
   DEFINE p_flag             LIKE type_t.chr1
   DEFINE p_sel1             LIKE type_t.chr1
   DEFINE p_xrcadocno        LIKE xrca_t.xrcadocno
   DEFINE p_xrca001          LIKE xrca_t.xrca001
   DEFINE p_xrccseq          LIKE xrcc_t.xrccseq
   DEFINE p_xrcc001          LIKE xrcc_t.xrcc001
   DEFINE p_amt4             LIKE xrce_t.xrce109
   DEFINE l_amt2             LIKE xrde_t.xrde109     #收款金額
   DEFINE l_amt4             LIKE xrce_t.xrce109     #帳款金額
   DEFINE l_amt6             LIKE xrce_t.xrce109     #匯差及調整金額
   DEFINE l_amt8             LIKE xrce_t.xrce109     #差異金額
   DEFINE l_xrca001_str      STRING
   DEFINE l_amt2_1           LIKE xrde_t.xrde109
   DEFINE l_xrce002          LIKE xrce_t.xrce002
   DEFINE l_gzcb003          LIKE gzcb_t.gzcb003
   DEFINE l_xrcc119          LIKE xrcc_t.xrcc119
   
   IF cl_null(p_amt4) THEN LET p_amt4 = 0 END IF
   IF cl_null(l_amt4) THEN LET l_amt4 = 0 END IF
   #計算帳款
   LET l_xrca001_str = p_xrca001
   LET l_xrca001_str = l_xrca001_str.substring(1,1)
   IF p_flag = '1' THEN
      IF l_xrca001_str = '1' THEN
         LET l_xrce002 = '30'
      END IF 
      IF l_xrca001_str = '2' THEN
         LET l_xrce002 = '31'
      END IF
      SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
       WHERE gzcb001 = '8306'
         AND gzcb002 = l_xrce002
      #應收 - 已收
      SELECT xrcc118 - xrcc119 INTO l_xrcc119
        FROM xrcc_t
       WHERE xrccent = g_enterprise   AND xrccdocno = p_xrcadocno
         AND xrccld  = g_master.xrdald AND xrccseq = p_xrccseq
         AND xrcc001 = p_xrcc001
   ELSE
      IF l_xrca001_str = '1' THEN
         LET l_xrce002   = '40'
      END IF
      IF l_xrca001_str = '2' AND p_xrca001 <> '25' THEN 
         LET l_xrce002   = '41'
      END IF
      IF p_xrca001 = '25' THEN 
         LET l_xrce002   = '42'
      END IF
      SELECT gzcb003 INTO l_gzcb003 FROM gzcb_t
       WHERE gzcb001 = '8306'
         AND gzcb002 = l_xrce002
      #應收 - 已收
      SELECT apcc118 - apcc119 INTO l_xrcc119
        FROM apcc_t
       WHERE apccent = g_enterprise   AND apccdocno = p_xrcadocno
         AND apccld  = g_master.xrdald AND apccseq = p_xrccseq
         AND apcc001 = p_xrcc001
   END IF
   IF l_gzcb003 = 'D' THEN
      LET l_amt4 = l_xrcc119
   ELSE
      LET l_amt4 = l_xrcc119 * -1
   END IF
   IF p_sel1 = 'N' THEN
      LET l_amt4 = p_amt4 - l_amt4
   ELSE
      LET l_amt4 = p_amt4 + l_amt4
   END IF

   RETURN l_amt4
   
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_ref_nmbb_amt(p_sel,p_nmbbdocno,p_nmbbseq,p_amt2)
   DEFINE p_sel              LIKE type_t.chr1
   DEFINE p_nmbbdocno        LIKE nmbb_t.nmbbdocno
   DEFINE p_nmbbseq        LIKE nmbb_t.nmbbseq
   DEFINE p_amt2             LIKE xrde_t.xrde109
   DEFINE l_amt2             LIKE xrde_t.xrde109     #收款金額
   DEFINE l_amt2_1           LIKE xrde_t.xrde109     
   DEFINE l_nmbb007_1        LIKE xrde_t.xrde109
   DEFINE l_nmbb007_2        LIKE xrde_t.xrde109
   DEFINE l_nmbb007_3        LIKE xrde_t.xrde109
   
   IF cl_null(p_amt2) THEN LET p_amt2 = 0 END IF
   IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
   #計算收款
   SELECT nmbb007-nmbb009,nmbb007-nmbb021,nmbb007-nmbb024 INTO l_nmbb007_1,l_nmbb007_2,l_nmbb007_3
     FROM nmbb_t
    WHERE nmbbent = g_enterprise AND nmbbdocno = p_nmbbdocno 
      AND nmbbseq = p_nmbbseq
   CASE
      WHEN g_ls = 1
         LET l_amt2 = l_nmbb007_1
      WHEN g_ls = 2
         LET l_amt2 = l_nmbb007_2
      WHEN g_ls = 3
         LET l_amt2 = l_nmbb007_3
   END CASE
   IF cl_null(l_amt2) THEN LET l_amt2 = 0 END IF
   IF p_sel = 'N' THEN
      LET l_amt2 = p_amt2 - l_amt2
   ELSE
      LET l_amt2 = p_amt2 + l_amt2
   END IF
   RETURN l_amt2
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_s01()
   OPEN WINDOW w_axrp400_s01 WITH FORM cl_ap_formpath("axr","axrp400_s01")

   INPUT ARRAY g_detail_s FROM s_detail3.* 
              ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS, 
                        INSERT ROW = FALSE,
                        DELETE ROW = FALSE,
                        APPEND ROW = FALSE)
      BEFORE INPUT
         CALL axrp400_s01_b_fill()
         CALL cl_set_comp_entry("xrdadocno,amt1,amt2,amt3",FALSE)
      
      BEFORE ROW
         LET l_ac2 = ARR_CURR() 
      
      ON CHANGE diff1
         UPDATE axrp400_s01_tmp SET diff1 = g_detail_s[l_ac2].diff1
          WHERE xrdadocno = g_detail_s[l_ac2].xrdadocno
      
      ON ACTION accept1
         ACCEPT INPUT
   
#      ON ACTION cancel1
#         UPDATE axrp400_s01_tmp SET diff1 = '1'
#         LET INT_FLAG = TRUE
#         EXIT INPUT
   
      ON ACTION close
         LET INT_FLAG = TRUE
         LET g_success = 'N'
         EXIT INPUT
   
      ON ACTION exit
         LET INT_FLAG = TRUE
         LET g_success = 'N'
         EXIT INPUT
   
   END INPUT
   
   #畫面關閉
   CLOSE WINDOW w_axrp400_s01

END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_s01_b_fill()
   DEFINE l_glab003     LIKE glab_t.glab003
   DEFINE l_xrde_t      RECORD LIKE xrde_t.*
   DEFINE l_sql         STRING
   DEFINE l_xrde100     LIKE xrde_t.xrde100
   DEFINE l_xrde109     LIKE xrde_t.xrde109
   DEFINE l_xrde119     LIKE xrde_t.xrde119
   DEFINE l_xrde109_1   LIKE xrde_t.xrde109
   DEFINE l_xrde119_1   LIKE xrde_t.xrde119
   DEFINE l_xrde109_2   LIKE xrde_t.xrde109
   DEFINE l_xrde119_2   LIKE xrde_t.xrde119
   DEFINE l_ooab002     LIKE ooab_t.ooab002
   DEFINE l_amt         LIKE xrde_t.xrde119   #匯差
 
   #本幣
   LET l_sql ="SELECT diff1,xrdadocno,amt1,amt2,amt3",
              "  FROM axrp400_s01_tmp WHERE amt3<>0"
   PREPARE axrt400_s01_prep FROM l_sql
   DECLARE axrt400_s01_curs CURSOR FOR axrt400_s01_prep

   CALL g_detail_s.clear()

   LET l_ac2 = 1   
   ERROR "Searching!" 
      
      
   FOREACH axrt400_s01_curs INTO g_detail_s[l_ac2].*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
 
         EXIT FOREACH
      END IF
      
      LET l_ac2 = l_ac2 + 1
      
   END FOREACH
  #CALL g_detail_s.deleteElement(g_detail_s.getLength())
   LET g_error_show = 0

   CLOSE axrt400_s01_curs
   
   LET l_ac2 = 1
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_cum_query()
    
    DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
       CONSTRUCT BY NAME g_wc3 ON flag
          
          AFTER CONSTRUCT
             IF g_wc3 = "flag='1'" THEN
                CALL cl_set_combo_scc('b_xrca001','8302')
             ELSE
                CALL cl_set_combo_scc('b_xrca001','8502')
             END IF
       END CONSTRUCT
       
       CONSTRUCT BY NAME g_wc2 ON b_xrcadocno,b_xrccseq,b_xrcc001,b_xrcasite,b_xrca003,b_xrca005,b_xrcald
          BEFORE CONSTRUCT
            IF g_wc3 = "flag='1'" THEN
                CALL cl_set_combo_scc('b_xrca001','8302')
             ELSE
                CALL cl_set_combo_scc('b_xrca001','8502')
             END IF
         
            #Ctrlp:construct.c.xrcadocno
            #應用 a03 樣板自動產生(Version:2)
            ON ACTION controlp INFIELD b_xrcadocno
               #add-point:ON ACTION controlp INFIELD xrcadocno
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
			      IF g_wc3 = "flag='1'" OR g_wc3 = " 1=1" THEN   #160530-00005#5 Add g_wc3 = " 1=1"
                  LET g_qryparam.where= "xrcadocdt <= '",g_master.xrdadocdt,"'",
                                        " AND xrca001 NOT IN ('01','02','03','04','31','141','142')",
                                        " AND xrcald ='",g_master.xrdald,"'",
                                        " AND xrcadocno IN (SELECT UNIQUE xrcadocno FROM axrp400_cum_tmp )"  #160530-00005#5 Del NOT
                  CALL q_xrcadocno_12()                         #呼叫開窗
               ELSE
                  LET g_qryparam.where= "apcadocdt <= '",g_master.xrdadocdt,"'",
                                        " AND apcald ='",g_master.xrdald,"'",
                                        " AND apcadocno IN (SELECT UNIQUE xrcadocno FROM axrp400_cum_tmp )"  #160530-00005#5 Del NOT
                  CALL q_apcadocno_14()
               END IF
               DISPLAY g_qryparam.return1 TO b_xrcadocno      #顯示到畫面上
               LET g_qryparam.where=NULL
               NEXT FIELD b_xrcadocno                        #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrcasite
               #add-point:ON ACTION controlp INFIELD xrcasite
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               #CALL q_ooef001()                           #呼叫開窗    #161021-00050#3 mark
               CALL q_ooef001_46()                                     #161021-00050#3 add
               DISPLAY g_qryparam.return1 TO b_xrcasite    #顯示到畫面上
               NEXT FIELD b_xrcasite                       #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrca003
               #add-point:ON ACTION controlp INFIELD xrca003
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_ooag001()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca003      #顯示到畫面上
               NEXT FIELD b_xrca003                      #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrca005
               #add-point:ON ACTION controlp INFIELD xrca005
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
			      LET g_qryparam.arg1 = g_glaa.glaacomp
               CALL q_pmaa001_13()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrca005      #顯示到畫面上
               NEXT FIELD b_xrca005                      #返回原欄位
               #END add-point
            
            ON ACTION controlp INFIELD b_xrcald
               #add-point:ON ACTION controlp INFIELD xrcald
               #應用 a08 樣板自動產生(Version:2)
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
			      LET g_qryparam.reqry = FALSE
               CALL q_authorised_ld()                         #呼叫開窗
               DISPLAY g_qryparam.return1 TO b_xrcald     #顯示到畫面上
               NEXT FIELD b_xrcld                      #返回原欄位
               #END add-point
            
         END CONSTRUCT
       ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   
 
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0 
      RETURN
   END IF
END FUNCTION

################################################################################
# Descriptions...: 直接审核功能
# Memo...........:
# Usage..........: CALL axrp400_immediately_conf(p_start_no,p_end_no)
#                  RETURNING r_success
#
# Date & Author..: 2015/12/07 By 06862
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_immediately_conf(p_start_no,p_end_no)
   DEFINE p_nmbb026         LIKE nmbb_t.nmbb026
   DEFINE p_start_no        LIKE xrda_t.xrdadocno 
   DEFINE p_end_no          LIKE xrda_t.xrdadocno 
   DEFINE l_xrdacomp        LIKE xrda_t.xrdacomp
   DEFINE l_success         LIKE type_t.num5
   DEFINE l_doc_success     LIKE type_t.num5
   DEFINE l_slip            LIKE ooba_t.ooba002
   DEFINE l_dfin0031        LIKE type_t.chr1
   DEFINE l_count           LIKE type_t.num5
   DEFINE r_success         LIKE type_t.num5
   DEFINE l_efin5001        LIKE type_t.chr1
   DEFINE l_ooba002         LIKE ooba_t.ooba002
   DEFINE l_flag            LIKE type_t.chr1
   DEFINE l_xrdamoddt       LIKE xrda_t.xrdamoddt
   DEFINE l_xrda            RECORD LIKE xrda_t.*
   DEFINE l_sql             STRING 

   LET r_success = TRUE 
   
   LET l_sql = "SELECT * FROM xrda_t where xrdaent = '",g_enterprise,"' 
                          and xrdadocno between '",p_start_no,"' and '",p_end_no,"'
                          AND xrdald = '",g_master.xrdald,"' "
   PREPARE axrp400_immediately_conf_pre FROM l_sql
   DECLARE axrp400_immediately_conf_cs CURSOR FOR axrp400_immediately_conf_pre
   
   CALL s_transaction_begin()
   
   FOREACH axrp400_immediately_conf_cs INTO l_xrda.*
   
           #無資料直接返回不做處理
           IF cl_null(l_xrda.xrdald)  THEN 
              LET  r_success=FALSE   
              RETURN r_success 
           END IF 
           #無資料直接返回不做處理   
           IF cl_null(l_xrda.xrdacomp)  THEN 
              LET  r_success=FALSE   
              RETURN r_success 
           END IF 
           #無資料直接返回不做處理   
           IF cl_null(l_xrda.xrdadocno) THEN 
              LET  r_success=FALSE   
              RETURN r_success 
           END IF                            
           
           LET l_doc_success = TRUE
           
           CALL s_axrt400_conf_chk(l_xrda.xrdald,l_xrda.xrdadocno) RETURNING l_doc_success,l_flag
           
           IF NOT l_doc_success THEN
              LET r_success = FALSE
           ELSE 
              IF NOT s_axrt400_conf_upd(l_xrda.xrdald,l_xrda.xrdadocno) THEN
                 LET r_success = FALSE
              END IF
           END IF
           
           #異動狀態碼欄位/修改人/修改日期
           LET l_xrdamoddt = cl_get_current()
           UPDATE xrda_t SET xrdastus = 'Y',
                             xrdamodid= g_user,
                             xrdamoddt= l_xrdamoddt
            WHERE xrdaent = g_enterprise AND xrdald = l_xrda.xrdald
              AND xrdadocno = l_xrda.xrdadocno
           IF SQLCA.sqlcode THEN
              INITIALIZE g_errparam TO NULL 
              LET g_errparam.extend = "" 
              LET g_errparam.code   = SQLCA.sqlcode 
              LET g_errparam.popup  = FALSE 
              CALL cl_err()
              LET l_doc_success = FALSE
           END IF
           
           IF l_flag = 'S' OR l_doc_success=FALSE THEN
              LET r_success = FALSE 
           END IF 
   END FOREACH 
   
   IF r_success THEN 
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF 
   
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: 直接抛转总账传票功能
# Memo...........:
# input..........: p_slip  默认总账单据别
# Usage..........: axrp400_immediately_gen()
# Date & Author..: 2015/12/07 By 06862
# Modify.........:
################################################################################
PRIVATE FUNCTION axrp400_immediately_gen(p_start_no,p_end_no,p_slip)
   DEFINE p_slip            LIKE type_t.chr20
   DEFINE p_start_no        LIKE xrda_t.xrdadocno
   DEFINE p_end_no          LIKE xrda_t.xrdadocno 
   DEFINE l_success         LIKE type_t.num5
   DEFINE l_doc_success     LIKE type_t.num5
   DEFINE l_slip            LIKE ooba_t.ooba002
   DEFINE l_dfin0032        LIKE type_t.chr1
   DEFINE l_count           LIKE type_t.num5
   DEFINE l_glap001         LIKE glap_t.glap001
   DEFINE l_glaa121         LIKE glaa_t.glaa121
   DEFINE l_xrdastus        LIKE xrda_t.xrdastus
   DEFINE l_xrdamoddt       LIKE xrda_t.xrdamoddt
   DEFINE r_success         LIKE type_t.num5
   DEFINE r_start_no        LIKE glap_t.glapdocno
   DEFINE r_end_no          LIKE glap_t.glapdocno
   DEFINE l_wc              STRING 
   DEFINE l_sql             STRING 
   DEFINE l_xrda            RECORD LIKE xrda_t.*  
     
   LET r_success = TRUE 
   LET l_sql = "SELECT * FROM xrda_t where xrdaent = '",g_enterprise,"' 
                          and xrdadocno between '",p_start_no,"' and '",p_end_no,"'
                          AND xrdald = '",g_master.xrdald,"' "
   PREPARE axrp400_immediately_gen_pre FROM l_sql
   DECLARE axrp400_immediately_gen_cs CURSOR FOR axrp400_immediately_gen_pre
   
   CALL s_transaction_begin()
   FOREACH axrp400_immediately_gen_cs INTO l_xrda.*
  
           IF cl_null(l_xrda.xrdald)    THEN RETURN END IF   #無資料直接返回不做處理
           IF cl_null(l_xrda.xrdadocno) THEN RETURN END IF   #無資料直接返回不做處理
           IF NOT cl_null(l_xrda.xrda014)   THEN RETURN END IF   #無傳票單號不做處理
           IF l_xrda.xrdastus <> 'Y' THEN RETURN END IF 
           
           #是否产生分录底稿
           SELECT glaa121 INTO l_glaa121
             FROM glaa_t
            WHERE glaaent = g_enterprise
              AND glaald = l_xrda.xrdald
           
           IF l_glaa121 = 'Y' THEN 
              LET l_wc =" glgbdocno = '", l_xrda.xrdadocno,"' "
              CALL s_pre_voucher_ins_glap('AR','R20',g_master.xrdald,g_master.xrdadocdt,p_slip,1,l_wc) 
                   RETURNING l_success,r_start_no,r_end_no
           ELSE
              LET l_wc =" xrdadocno IN (SELECT xrdadocno FROM axrp420_tmp WHERE sel = 'Y')"   
              CALL s_voucher_gen_ar('2',g_master.xrdald,g_master.xrdadocdt,p_slip,1,l_wc,'N') 
                   RETURNING l_success,r_start_no,r_end_no
           END IF
           
           IF NOT l_success THEN 
              LET r_success = FALSE 
           END IF 
           
           #更新传票单号
           LET l_xrdamoddt = cl_get_current()
           UPDATE xrda_t SET xrda014 = r_start_no,
                             xrdamodid= g_user,
                             xrdamoddt= l_xrdamoddt
                       WHERE xrdaent = g_enterprise
                         AND xrdadocno = l_xrda.xrdadocno                 
           IF SQLCA.sqlcode THEN
              INITIALIZE g_errparam TO NULL 
              LET g_errparam.extend = "" 
              LET g_errparam.code   = SQLCA.sqlcode 
              LET g_errparam.popup  = FALSE 
              CALL cl_err()
              LET r_success = FALSE
           END IF
           
   END FOREACH 
   
   IF r_success THEN
      CALL s_transaction_end('Y','0')
   ELSE
      IF cl_null(r_start_no) THEN 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ''
         LET g_errparam.code   = 'axc-00530' 
         LET g_errparam.popup = TRUE
         CALL cl_err()
      ELSE
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = ''
         LET g_errparam.code   = 'axr-00120' 
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      CALL s_transaction_end('N','0')    
   END IF
   
END FUNCTION

#end add-point
 
{</section>}
 
