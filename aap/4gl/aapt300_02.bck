#該程式未解開Section, 採用最新樣板產出!
{<section id="aapt300_02.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0016(2016-07-19 10:30:45), PR版次:0016(2016-12-12 17:35:25)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000298
#+ Filename...: aapt300_02
#+ Description: 直接沖帳
#+ Creator....: 03538(2015-01-14 17:26:55)
#+ Modifier...: 02599 -SD/PR- 08729
 
{</section>}
 
{<section id="aapt300_02.global" >}
#應用 i02 樣板自動產生(Version:38)
#add-point:填寫註解說明 name="global.memo"
#141218-00011#6              By Belle    單身維護時：其他信息的核算，不必檢核是否有輸入及合理性。
#150205-00012#1              BY Hans     進欄位之後只顯示編號不顯示中文名稱
#150512-00036#1   15/06/29   By apo      帳款單號開窗改為開窗多選寫入
#151029           15/10/29   By 03538    多帳期的key只要到帳期為止即可,因為不同發票會拆成不同項次
#150916-00015#1   2015/12/7  By Xiaozg   1.快捷带出类似科目编号 2. 当有账套时，科目检查改为检查是否存在于glad_t中
#151130-00015#4   2015/12/23 By 02097    訂金沖銷依aoos020 參數S-FIN-2020(是否依單核銷訂金)/IF Y  則只能沖同一張採購單之訂金
#160321-00016#20  2016/03/23 By Jessy    修正azzi920重複定義之錯誤訊息
#160707-00030#1   160707     By albireo  原幣金額需取位再做後續處理
#160628-00002#2   2016/07/13 By 02599    往來帳款沖銷待抵單時,需要將含稅待抵單的稅額拆分出來顯示
#160905-00002#1   2016/09/05 By Reanna   SQL條件少ENT補上(硬框架調整)
#161006-00005#4   2016/10/12 By 08732    組織類型與職能開窗調整
#161104-00024#2   2016/11/10 By 08729    處理DEFINE有星號
#161208-00026#5   2016/12/09 By 08729    針對SELECT有星號的部分進行展開
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT util
#add-point:增加匯入項目 name="global.import"

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
GLOBALS   #(ver:36) add
   DEFINE mc_data_owner_check LIKE type_t.num5   #(ver:36) add
END GLOBALS   #(ver:36) add
 
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
#單身 type 宣告
PRIVATE TYPE type_g_apce_d RECORD
       apcedocno LIKE apce_t.apcedocno, 
   apceld LIKE apce_t.apceld, 
   apceseq LIKE apce_t.apceseq, 
   apce002 LIKE apce_t.apce002, 
   apceorga LIKE apce_t.apceorga, 
   apceorga_desc LIKE type_t.chr500, 
   apce003 LIKE apce_t.apce003, 
   apce004 LIKE apce_t.apce004, 
   apce005 LIKE apce_t.apce005, 
   apce048 LIKE apce_t.apce048, 
   apce015 LIKE apce_t.apce015, 
   apce016 LIKE apce_t.apce016, 
   apce016_desc LIKE type_t.chr500, 
   apce100 LIKE apce_t.apce100, 
   apce101 LIKE apce_t.apce101, 
   apce103 LIKE apce_t.apce103, 
   apce104 LIKE apce_t.apce104, 
   apce109 LIKE apce_t.apce109, 
   apce113 LIKE apce_t.apce113, 
   apce114 LIKE apce_t.apce114, 
   apce119 LIKE apce_t.apce119, 
   apce027 LIKE apce_t.apce027, 
   apce011 LIKE apce_t.apce011, 
   apce011_desc LIKE type_t.chr500, 
   apce010 LIKE apce_t.apce010, 
   apce024 LIKE apce_t.apce024, 
   apce038 LIKE apce_t.apce038, 
   apce038_desc LIKE type_t.chr500, 
   apce031 LIKE apce_t.apce031, 
   apcecomp LIKE apce_t.apcecomp, 
   apcesite LIKE apce_t.apcesite, 
   apce001 LIKE apce_t.apce001
       END RECORD
PRIVATE TYPE type_g_apce2_d RECORD
       apcedocno LIKE apce_t.apcedocno, 
   apceld LIKE apce_t.apceld, 
   apceseq LIKE apce_t.apceseq, 
   apce0022 LIKE type_t.chr20, 
   apce0152 LIKE type_t.chr1, 
   apce0162 LIKE type_t.chr500, 
   apce0162_desc LIKE type_t.chr500, 
   apce017 LIKE apce_t.apce017, 
   apce017_desc LIKE type_t.chr500, 
   apce018 LIKE apce_t.apce018, 
   apce018_desc LIKE type_t.chr500, 
   apce019 LIKE apce_t.apce019, 
   apce019_desc LIKE type_t.chr500, 
   apce020 LIKE apce_t.apce020, 
   apce020_desc LIKE type_t.chr500, 
   apce022 LIKE apce_t.apce022, 
   apce022_desc LIKE type_t.chr500, 
   apce023 LIKE apce_t.apce023, 
   apce023_desc LIKE type_t.chr500, 
   apce035 LIKE apce_t.apce035, 
   apce035_desc LIKE type_t.chr500, 
   apce036 LIKE apce_t.apce036, 
   apce036_desc LIKE type_t.chr500, 
   apce044 LIKE apce_t.apce044, 
   apce044_desc LIKE type_t.chr500, 
   apce045 LIKE apce_t.apce045, 
   apce045_desc LIKE type_t.chr500, 
   apce046 LIKE apce_t.apce046, 
   apce046_desc LIKE type_t.chr500, 
   apce051 LIKE apce_t.apce051, 
   apce051_desc LIKE type_t.chr500, 
   apce052 LIKE apce_t.apce052, 
   apce052_desc LIKE type_t.chr500, 
   apce053 LIKE apce_t.apce053, 
   apce053_desc LIKE type_t.chr500, 
   apce054 LIKE apce_t.apce054, 
   apce054_desc LIKE type_t.chr500, 
   apce055 LIKE apce_t.apce055, 
   apce055_desc LIKE type_t.chr500, 
   apce056 LIKE apce_t.apce056, 
   apce056_desc LIKE type_t.chr500, 
   apce057 LIKE apce_t.apce057, 
   apce057_desc LIKE type_t.chr500, 
   apce058 LIKE apce_t.apce058, 
   apce058_desc LIKE type_t.chr500, 
   apce059 LIKE apce_t.apce059, 
   apce059_desc LIKE type_t.chr500, 
   apce060 LIKE apce_t.apce060, 
   apce060_desc LIKE type_t.chr500
       END RECORD
PRIVATE TYPE type_g_apce3_d RECORD
       apcedocno LIKE apce_t.apcedocno, 
   apceld LIKE apce_t.apceld, 
   apceseq LIKE apce_t.apceseq, 
   apce0023 LIKE type_t.chr20, 
   apce0033 LIKE type_t.chr20, 
   apce0043 LIKE type_t.num10, 
   apce0053 LIKE type_t.num10, 
   apce1003 LIKE type_t.chr10, 
   apce1033 LIKE type_t.num20_6, 
   apce1043 LIKE type_t.num20_6, 
   apce1093 LIKE type_t.num20_6, 
   apce1013 LIKE type_t.num26_10, 
   apce1133 LIKE type_t.num20_6, 
   apce1143 LIKE type_t.num20_6, 
   apce1193 LIKE type_t.num20_6, 
   apce120 LIKE apce_t.apce120, 
   apce121 LIKE apce_t.apce121, 
   apce123 LIKE apce_t.apce123, 
   apce124 LIKE apce_t.apce124, 
   apce129 LIKE apce_t.apce129, 
   apce130 LIKE apce_t.apce130, 
   apce131 LIKE apce_t.apce131, 
   apce133 LIKE apce_t.apce133, 
   apce134 LIKE apce_t.apce134, 
   apce139 LIKE apce_t.apce139
       END RECORD
 
 
 
#add-point:自定義模組變數(Module Variable) (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="global.variable"
DEFINE g_apcald                   LIKE apca_t.apcald
DEFINE g_apcadocno                LIKE apca_t.apcadocno   
DEFINE l_lock_sw                  LIKE type_t.chr1
DEFINE l_n                        LIKE type_t.num10
DEFINE g_bfill                    LIKE type_t.chr5              #是否刷新單身
DEFINE lb_reproduce               BOOLEAN
DEFINE li_reproduce               LIKE type_t.num5
DEFINE li_reproduce_target        LIKE type_t.num5
DEFINE g_sfin3008                 LIKE type_t.chr80             #S-FIN-3008-付款單直接產生銀存支付帳
DEFINE g_sfin2002               LIKE type_t.chr80             #S-FIN-2002-應付沖銷參數
#總計頁簽
DEFINE g_apce_sum RECORD
                  apca100         LIKE apca_t.apca100,
                  glaa001         LIKE glaa_t.glaa001,
                  glaa016         LIKE glaa_t.glaa016,
                  glaa020         LIKE glaa_t.glaa020,
                  sum_apca103     LIKE apca_t.apca103,
                  sum_apca113     LIKE apca_t.apca113,
                  sum_apca123     LIKE apca_t.apca123,
                  sum_apca133     LIKE apca_t.apca133,
                  sum_apce1091    LIKE apce_t.apce109,
                  sum_apce1191    LIKE apce_t.apce119,
                  sum_apce1291    LIKE apce_t.apce129,
                  sum_apce1391    LIKE apce_t.apce139,
                  sum_apce1092    LIKE apce_t.apce109,
                  sum_apce1192    LIKE apce_t.apce119,
                  sum_apce1292    LIKE apce_t.apce129,
                  sum_apce1392    LIKE apce_t.apce139,
                  sum_apce1093    LIKE apce_t.apce109,
                  sum_apce1193    LIKE apce_t.apce119,
                  sum_apce1293    LIKE apce_t.apce129,
                  sum_apce1393    LIKE apce_t.apce139,                  
                  sum_apce1094    LIKE apce_t.apce109,
                  sum_apce1194    LIKE apce_t.apce119,
                  sum_apce1294    LIKE apce_t.apce129,
                  sum_apce1394    LIKE apce_t.apce139
                  END RECORD
DEFINE g_glaa     RECORD
                  glaald    LIKE glaa_t.glaald,
                  glaacomp  LIKE glaa_t.glaacomp,
                  glaa001   LIKE glaa_t.glaa001,
                  glaa004   LIKE glaa_t.glaa004,
                  glaa005   LIKE glaa_t.glaa005,
                  glaa015   LIKE glaa_t.glaa015,
                  glaa016   LIKE glaa_t.glaa016,
                  glaa017   LIKE glaa_t.glaa017,
                  glaa019   LIKE glaa_t.glaa019,
                  glaa020   LIKE glaa_t.glaa020,
                  glaa021   LIKE glaa_t.glaa021,
                  glaa024   LIKE glaa_t.glaa024,
                  glaa025   LIKE glaa_t.glaa025,
                  glaa026   LIKE glaa_t.glaa026,
                  glaa121   LIKE glaa_t.glaa121
                  END RECORD
DEFINE g_glad     RECORD
                  glad0171    LIKE  glad_t.glad0171, 
                  glad0172    LIKE  glad_t.glad0172,
                  glad0181    LIKE  glad_t.glad0181,
                  glad0182    LIKE  glad_t.glad0182,
                  glad0191    LIKE  glad_t.glad0191,
                  glad0192    LIKE  glad_t.glad0192,
                  glad0201    LIKE  glad_t.glad0201,
                  glad0202    LIKE  glad_t.glad0202,
                  glad0211    LIKE  glad_t.glad0211,
                  glad0212    LIKE  glad_t.glad0212,
                  glad0221    LIKE  glad_t.glad0221,
                  glad0222    LIKE  glad_t.glad0222,
                  glad0231    LIKE  glad_t.glad0231,
                  glad0232    LIKE  glad_t.glad0232,
                  glad0241    LIKE  glad_t.glad0241,
                  glad0242    LIKE  glad_t.glad0242,
                  glad0251    LIKE  glad_t.glad0251,
                  glad0252    LIKE  glad_t.glad0252,
                  glad0261    LIKE  glad_t.glad0261,
                  glad0262    LIKE  glad_t.glad0262
                  END RECORD
#DEFINE g_apca                     RECORD LIKE apca_t.* #161104-00024#2 mark
#161104-00024#2-add(s)
DEFINE g_apca  RECORD  #應付憑單單頭
       apcaent   LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus  LIKE apca_t.apcastus, #狀態碼
       apcald    LIKE apca_t.apcald, #帳套
       apcacomp  LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite  LIKE apca_t.apcasite, #帳務中心
       apca001   LIKE apca_t.apca001, #帳款單性質
       apca003   LIKE apca_t.apca003, #帳務人員
       apca004   LIKE apca_t.apca004, #帳款對象編號
       apca005   LIKE apca_t.apca005, #付款對象
       apca006   LIKE apca_t.apca006, #供應商分類
       apca007   LIKE apca_t.apca007, #帳款類別
       apca008   LIKE apca_t.apca008, #付款條件編號
       apca009   LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010   LIKE apca_t.apca010, #容許票據到期日
       apca011   LIKE apca_t.apca011, #稅別
       apca012   LIKE apca_t.apca012, #稅率
       apca013   LIKE apca_t.apca013, #含稅否
       apca014   LIKE apca_t.apca014, #人員編號
       apca015   LIKE apca_t.apca015, #部門編號
       apca016   LIKE apca_t.apca016, #來源作業類型
       apca017   LIKE apca_t.apca017, #產生方式
       apca018   LIKE apca_t.apca018, #來源參考單號
       apca019   LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020   LIKE apca_t.apca020, #信用狀付款否
       apca021   LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022   LIKE apca_t.apca022, #進口報單號碼
       apca025   LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026   LIKE apca_t.apca026, #原幣未稅差異
       apca027   LIKE apca_t.apca027, #原幣稅額差異
       apca028   LIKE apca_t.apca028, #本幣未稅差異
       apca029   LIKE apca_t.apca029, #本幣幣稅額差異
       apca030   LIKE apca_t.apca030, #差異科目
       apca031   LIKE apca_t.apca031, #產生之差異折讓單號
       apca032   LIKE apca_t.apca032, #發票類型
       apca033   LIKE apca_t.apca033, #專案編號
       apca034   LIKE apca_t.apca034, #責任中心
       apca035   LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036   LIKE apca_t.apca036, #費用(借方)科目編號
       apca037   LIKE apca_t.apca037, #產生傳票否
       apca038   LIKE apca_t.apca038, #拋轉傳票號碼
       apca039   LIKE apca_t.apca039, #會計檢核附件份數
       apca040   LIKE apca_t.apca040, #留置否
       apca041   LIKE apca_t.apca041, #留置理由碼
       apca042   LIKE apca_t.apca042, #留置設定日期
       apca043   LIKE apca_t.apca043, #留置解除日期
       apca044   LIKE apca_t.apca044, #留置原幣金額
       apca045   LIKE apca_t.apca045, #留置說明
       apca046   LIKE apca_t.apca046, #關係人否
       apca047   LIKE apca_t.apca047, #多角序號
       apca048   LIKE apca_t.apca048, #集團代付/代付單號
       apca049   LIKE apca_t.apca049, #來源營運中心編號
       apca050   LIKE apca_t.apca050, #交易原始單據份數
       apca051   LIKE apca_t.apca051, #作廢理由碼
       apca052   LIKE apca_t.apca052, #列印次數
       apca053   LIKE apca_t.apca053, #備註
       apca054   LIKE apca_t.apca054, #多帳期設定
       apca055   LIKE apca_t.apca055, #繳款優惠條件
       apca056   LIKE apca_t.apca056, #會計檢核附件狀態
       apca057   LIKE apca_t.apca057, #交易對象識別碼
       apca058   LIKE apca_t.apca058, #稅別交易類型
       apca059   LIKE apca_t.apca059, #預算編號
       apca060   LIKE apca_t.apca060, #發票開立方式
       apca061   LIKE apca_t.apca061, #預開發票基準日
       apca062   LIKE apca_t.apca062, #多角性質
       apca063   LIKE apca_t.apca063, #整帳批序號
       apca064   LIKE apca_t.apca064, #訂金序次
       apca065   LIKE apca_t.apca065, #發票編號
       apca066   LIKE apca_t.apca066, #發票號碼
       apca100   LIKE apca_t.apca100, #交易原幣別
       apca101   LIKE apca_t.apca101, #原幣匯率
       apca103   LIKE apca_t.apca103, #原幣未稅金額
       apca104   LIKE apca_t.apca104, #原幣稅額
       apca106   LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107   LIKE apca_t.apca107, #NO USE
       apca108   LIKE apca_t.apca108, #原幣應付金額
       apca113   LIKE apca_t.apca113, #本幣未稅金額
       apca114   LIKE apca_t.apca114, #本幣稅額
       apca116   LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117   LIKE apca_t.apca117, #NO USE
       apca118   LIKE apca_t.apca118, #本幣應付金額
       apca120   LIKE apca_t.apca120, #本位幣二幣別
       apca121   LIKE apca_t.apca121, #本位幣二匯率
       apca123   LIKE apca_t.apca123, #本位幣二未稅金額
       apca124   LIKE apca_t.apca124, #本位幣二稅額
       apca126   LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127   LIKE apca_t.apca127, #NO USE
       apca128   LIKE apca_t.apca128, #本位幣二應付金額
       apca130   LIKE apca_t.apca130, #本位幣三幣別
       apca131   LIKE apca_t.apca131, #本位幣三匯率
       apca133   LIKE apca_t.apca133, #本位幣三未稅金額
       apca134   LIKE apca_t.apca134, #本位幣三稅額
       apca136   LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137   LIKE apca_t.apca137, #NO USE
       apca138   LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067   LIKE apca_t.apca067, #管理品類
       apca068   LIKE apca_t.apca068, #經營方式
       apca069   LIKE apca_t.apca069, #no use
       apca070   LIKE apca_t.apca070, #no use
       apca071   LIKE apca_t.apca071, #no use
       apca072   LIKE apca_t.apca072, #no use
       apca073   LIKE apca_t.apca073  #信用狀申請單號
           END RECORD
#161104-00024#2-add(e)
DEFINE g_dfin0030                 LIKE type_t.chr1
DEFINE g_wc_cs_orga               STRING                  #161006-00005#4  add
#end add-point
 
#模組變數(Module Variables)
DEFINE g_apce_d          DYNAMIC ARRAY OF type_g_apce_d #單身變數
DEFINE g_apce_d_t        type_g_apce_d                  #單身備份
DEFINE g_apce_d_o        type_g_apce_d                  #單身備份
DEFINE g_apce_d_mask_o   DYNAMIC ARRAY OF type_g_apce_d #單身變數
DEFINE g_apce_d_mask_n   DYNAMIC ARRAY OF type_g_apce_d #單身變數
DEFINE g_apce2_d   DYNAMIC ARRAY OF type_g_apce2_d
DEFINE g_apce2_d_t type_g_apce2_d
DEFINE g_apce2_d_o type_g_apce2_d
DEFINE g_apce2_d_mask_o DYNAMIC ARRAY OF type_g_apce2_d
DEFINE g_apce2_d_mask_n DYNAMIC ARRAY OF type_g_apce2_d
DEFINE g_apce3_d   DYNAMIC ARRAY OF type_g_apce3_d
DEFINE g_apce3_d_t type_g_apce3_d
DEFINE g_apce3_d_o type_g_apce3_d
DEFINE g_apce3_d_mask_o DYNAMIC ARRAY OF type_g_apce3_d
DEFINE g_apce3_d_mask_n DYNAMIC ARRAY OF type_g_apce3_d
 
      
DEFINE g_wc2                STRING
DEFINE g_sql                STRING
DEFINE g_forupd_sql         STRING                        #SELECT ... FOR UPDATE SQL
DEFINE g_before_input_done  LIKE type_t.num5
DEFINE g_cnt                LIKE type_t.num10    
DEFINE l_ac                 LIKE type_t.num10             #目前處理的ARRAY CNT 
DEFINE g_curr_diag          ui.Dialog                     #Current Dialog
DEFINE gwin_curr            ui.Window                     #Current Window
DEFINE gfrm_curr            ui.Form                       #Current Form
DEFINE g_temp_idx           LIKE type_t.num10             #單身 所在筆數(暫存用)
DEFINE g_detail_idx         LIKE type_t.num10             #單身 所在筆數(所有資料)
DEFINE g_detail_cnt         LIKE type_t.num10             #單身 總筆數(所有資料)
DEFINE g_ref_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields         DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars           DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys              DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak          DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_insert             LIKE type_t.chr5              #是否導到其他page
DEFINE g_error_show         LIKE type_t.num5
DEFINE g_chk                BOOLEAN
DEFINE g_aw                 STRING                        #確定當下點擊的單身
DEFINE g_log1               STRING                        #log用
DEFINE g_log2               STRING                        #log用
 
#多table用wc
DEFINE g_wc_table           STRING
 
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明(global.argv) name="global.argv"

#end add-point
 
{</section>}
 
{<section id="aapt300_02.main" >}
#應用 a27 樣板自動產生(Version:6)
#+ 作業開始(子程式類型)
PUBLIC FUNCTION aapt300_02(--)
   #add-point:main段變數傳入 name="main.get_var"
   p_apcald,
   p_apcadocno
   #end add-point
   )
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"
   DEFINE p_apcald         LIKE apca_t.apcald
   DEFINE p_apcadocno      LIKE apca_t.apcadocno

   #end add-point   
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:作業初始化 name="main.init"
   IF cl_null(p_apcald) OR cl_null(p_apcadocno) THEN
      RETURN
   ELSE
      LET g_apcald = p_apcald
      LET g_apcadocno = p_apcadocno
   END IF   

   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
 
   
   #add-point:main段define_sql name="main.body.define_sql"
   #應付單頭LOCK CURSOR
   #LET g_sql = "SELECT * FROM apca_t ",   #161208-00026#5 mark
   #161208-00026#5-add(s)
   LET g_sql = "SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
                       apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
                       apcapstid,apcapstdt,apcastus,apcald,apcacomp,
                       apcadocno,apcadocdt,apcasite,apca001,apca003,
                       apca004,apca005,apca006,apca007,apca008,
                       apca009,apca010,apca011,apca012,apca013,
                       apca014,apca015,apca016,apca017,apca018,
                       apca019,apca020,apca021,apca022,apca025,
                       apca026,apca027,apca028,apca029,apca030,
                       apca031,apca032,apca033,apca034,apca035,
                       apca036,apca037,apca038,apca039,apca040,
                       apca041,apca042,apca043,apca044,apca045,
                       apca046,apca047,apca048,apca049,apca050,
                       apca051,apca052,apca053,apca054,apca055,
                       apca056,apca057,apca058,apca059,apca060,
                       apca061,apca062,apca063,apca064,apca065,
                       apca066,apca100,apca101,apca103,apca104,
                       apca106,apca107,apca108,apca113,apca114,
                       apca116,apca117,apca118,apca120,apca121,
                       apca123,apca124,apca126,apca127,apca128,
                       apca130,apca131,apca133,apca134,apca136,
                       apca137,apca138,apcaud001,apcaud002,apcaud003,
                       apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
                       apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
                       apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
                       apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
                       apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
                       apcaud029,apcaud030,apca067,apca068,apca069,
                       apca070,apca071,apca072,apca073 
                  FROM apca_t ",
   #161208-00026#5-add(e)
               " WHERE apcaent = ? AND apcald = ? AND apcadocno = ? ",
               "   FOR UPDATE "
   LET g_sql = cl_sql_forupd(g_sql)
   DECLARE aapt300_02_cl CURSOR FROM g_sql
   #end add-point 
   LET g_forupd_sql = "SELECT apcedocno,apceld,apceseq,apce002,apceorga,apce003,apce004,apce005,apce048, 
       apce015,apce016,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119,apce027,apce011, 
       apce010,apce024,apce038,apce031,apcecomp,apcesite,apce001,apcedocno,apceld,apceseq,apce017,apce018, 
       apce019,apce020,apce022,apce023,apce035,apce036,apce044,apce045,apce046,apce051,apce052,apce053, 
       apce054,apce055,apce056,apce057,apce058,apce059,apce060,apcedocno,apceld,apceseq,apce120,apce121, 
       apce123,apce124,apce129,apce130,apce131,apce133,apce134,apce139 FROM apce_t WHERE apceent=? AND  
       apceld=? AND apcedocno=? AND apceseq=? FOR UPDATE"
   #add-point:main段define_sql name="main.body.after_define_sql"
   
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aapt300_02_bcl CURSOR FROM g_forupd_sql
 
 
   
   #畫面開啟 (identifier)
   OPEN WINDOW w_aapt300_02 WITH FORM cl_ap_formpath("aap","aapt300_02")
   
   #瀏覽頁簽資料初始化
   CALL cl_ui_init()
   
   #程式初始化
   CALL aapt300_02_init()   
 
   #進入選單 Menu (="N")
   CALL aapt300_02_ui_dialog() 
 
   #畫面關閉
   CLOSE WINDOW w_aapt300_02
 
   
   
 
   #add-point:離開前 name="main.exit"
 
   #end add-point
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aapt300_02.init" >}
#+ 畫面資料初始化
PRIVATE FUNCTION aapt300_02_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
   DEFINE l_str            STRING
   DEFINE l_ap_slip        LIKE apca_t.apcadocno  
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"
   
   #end add-point
   
   
   
   LET g_error_show = 1
   
   #add-point:畫面資料初始化 name="init.init"
   CALL s_aapp330_cre_tmp() RETURNING g_sub_success
   
   #根據傳入參數抓取資料應付單頭資料
   INITIALIZE g_apca.* TO NULL
   #SELECT * INTO g_apca.* FROM apca_t     #161208-00026#5 mark
   #161208-00026#5-add(s)
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073  
     INTO g_apca.* 
     FROM apca_t
   #161208-00026#5-add(e)
    WHERE apcaent = g_enterprise
       AND apcald = g_apcald AND apcadocno = g_apcadocno    

   #取得參數
   CALL cl_get_para(g_enterprise,g_apca.apcacomp,'S-FIN-3008') RETURNING g_sfin3008  #應付產生銀存支付帳否
   CALL cl_get_para(g_enterprise,g_apca.apcacomp,'S-FIN-2002') RETURNING g_sfin2002  #應付沖銷參數
   
   #取得帳別相關資訊
   CALL s_ld_sel_glaa(g_apcald,'glaald|glaacomp|glaa001|glaa004|glaa005|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa024|glaa025|glaa026|glaa121')
        RETURNING g_sub_success,g_glaa.*   
   CALL s_aooi200_fin_get_slip(g_apcadocno) RETURNING g_sub_success,l_ap_slip               
   CALL s_fin_get_doc_para(g_apcald,g_apca.apcacomp,l_ap_slip,'D-FIN-0030') RETURNING g_dfin0030
   IF g_glaa.glaa015 = 'Y' OR g_glaa.glaa019 = 'Y' THEN
      CALL cl_set_comp_visible('page_2',TRUE)
      IF g_glaa.glaa015 = 'Y' THEN
         CALL cl_set_comp_visible('apce120,apce121,apce129',TRUE)
         CALL cl_set_comp_visible('glaa016,sum_apca123,sum_apce1291,sum_apce1292,sum_apce1293,sum_apce1294',TRUE)
      END IF
      IF g_glaa.glaa019 = 'Y' THEN
         CALL cl_set_comp_visible('apce130,apce131,apce139',TRUE)
         CALL cl_set_comp_visible('glaa020,sum_apca133,sum_apce1391,sum_apce1392,sum_apce1393,sum_apce1394',TRUE)
      END IF
   END IF         
   #帳款明細單身   
   LET l_str = s_aap_get_acc_str('8506',"gzcb004 = '1' AND gzcb002 IN('41','42') ") CLIPPED   #限定41/42  #150114 carol:直沖不開放30:沖AR應收單
   CALL cl_set_combo_scc_part('apce002','8506',l_str)
   CALL cl_set_combo_scc_part('apce0022','8506',l_str)
   CALL cl_set_combo_scc_part('apce0023','8506',l_str)
   #本位幣二、三相關欄位預設隱藏,後續判斷是否使用才開啟
   CALL cl_set_comp_visible('page_2',FALSE)
   CALL cl_set_comp_visible('apce120,apce121,apce129',FALSE)
   CALL cl_set_comp_visible('apce130,apce131,apce139',FALSE)   
   CALL cl_set_comp_visible('glaa016,sum_apca123,sum_apce1291,sum_apce1292,sum_apce1293,sum_apce1294',FALSE)
   CALL cl_set_comp_visible('glaa020,sum_apca133,sum_apce1391,sum_apce1392,sum_apce1393,sum_apce1394',FALSE)  
   #其他訊息
   CALL cl_set_combo_scc('apce044','6013')
   CALL cl_set_combo_scc('apce044_desc','6013')
   CALL s_fin_azzi800_sons_query(g_today)                        #161006-00005#4  add
   CALL s_fin_account_center_sons_str() RETURNING g_wc_cs_orga   #161006-00005#4  add
   CALL s_fin_get_wc_str(g_wc_cs_orga) RETURNING g_wc_cs_orga    #161006-00005#4  add
   #end add-point
   
   CALL aapt300_02_default_search()
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.ui_dialog" >}
#+ 功能選單 
PRIVATE FUNCTION aapt300_02_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_idx   LIKE type_t.num10
   DEFINE la_param  RECORD #串查用
             prog   STRING,
             param  DYNAMIC ARRAY OF STRING
                    END RECORD
   DEFINE ls_js     STRING
   DEFINE l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   DEFINE l_nmag002        LIKE nmag_t.nmag002
   DEFINE l_sum            LIKE apcc_t.apcc108
   DEFINE l_ld          LIKE glaa_t.glaald      #160225-00001#1
   DEFINE l_dfin0033    LIKE type_t.chr1        #160225-00001#1
   DEFINE l_slip        LIKE apca_t.apcadocno   #160225-00001#1
   #end add-point 
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"
   
   #end add-point
   
   LET g_action_choice = " "  
   LET gwin_curr = ui.Window.getCurrent()
   LET gfrm_curr = gwin_curr.getForm()      
 
   CALL cl_set_act_visible("accept,cancel", FALSE)
   
   LET g_detail_idx = 1
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"
   
   #end add-point
   
   WHILE TRUE
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_apce_d.clear()
         CALL g_apce2_d.clear()
         CALL g_apce3_d.clear()
 
         LET g_wc2 = ' 1=2'
         LET g_action_choice = ""
         CALL aapt300_02_init()
      END IF
   
      CALL aapt300_02_b_fill(g_wc2)
   
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         DISPLAY ARRAY g_apce_d TO s_detail1.* ATTRIBUTE(COUNT=g_detail_cnt) 
      
            BEFORE DISPLAY 
               #add-point:ui_dialog段before display  name="ui_dialog.body.before_display"
               
               #end add-point
               #讓各頁籤能夠同步指到特定資料
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               #add-point:ui_dialog段before display2 name="ui_dialog.body.before_display2"
               
               #end add-point
               
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
               LET l_ac = g_detail_idx
               LET g_temp_idx = l_ac
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL cl_show_fld_cont() 
               #顯示followup圖示
               #應用 a48 樣板自動產生(Version:3)
   CALL aapt300_02_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
               #add-point:display array-before row name="ui_dialog.before_row"
               
               #end add-point
         
            #自訂ACTION(detail_show,page_1)
            
               
         END DISPLAY
      
         DISPLAY ARRAY g_apce2_d TO s_detail2.*
            ATTRIBUTES(COUNT=g_detail_cnt)  
         
            BEFORE DISPLAY 
               #add-point:ui_dialog段before display  name="ui_dialog.body2.before_display"
               
               #end add-point
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               #add-point:ui_dialog段before display2 name="ui_dialog.body2.before_display2"
               
               #end add-point
         
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
               LET l_ac = g_detail_idx
               LET g_temp_idx = l_ac
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL cl_show_fld_cont() 
               #顯示followup圖示
               #應用 a48 樣板自動產生(Version:3)
   CALL aapt300_02_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
               #add-point:display array-before row name="ui_dialog.before_row2"
               
               #end add-point
               
            #自訂ACTION(detail_show,page_2)
            
               
         END DISPLAY
         DISPLAY ARRAY g_apce3_d TO s_detail3.*
            ATTRIBUTES(COUNT=g_detail_cnt)  
         
            BEFORE DISPLAY 
               #add-point:ui_dialog段before display  name="ui_dialog.body3.before_display"
               
               #end add-point
               CALL FGL_SET_ARR_CURR(g_detail_idx)
               #add-point:ui_dialog段before display2 name="ui_dialog.body3.before_display2"
               
               #end add-point
         
            BEFORE ROW
               LET g_detail_idx = DIALOG.getCurrentRow("s_detail3")
               LET l_ac = g_detail_idx
               LET g_temp_idx = l_ac
               DISPLAY g_detail_idx TO FORMONLY.idx
               CALL cl_show_fld_cont() 
               #顯示followup圖示
               #應用 a48 樣板自動產生(Version:3)
   CALL aapt300_02_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
               #add-point:display array-before row name="ui_dialog.before_row3"
               
               #end add-point
               
            #自訂ACTION(detail_show,page_3)
            
               
         END DISPLAY
 
      
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         
         #end add-point
    
         BEFORE DIALOG
            IF g_temp_idx > 0 THEN
               LET l_ac = g_temp_idx
               CALL DIALOG.setCurrentRow("s_detail1",l_ac)
               LET g_temp_idx = 1
            END IF
            LET g_curr_diag = ui.DIALOG.getCurrent()         
            CALL DIALOG.setSelectionMode("s_detail1", 1)
            CALL DIALOG.setSelectionMode("s_detail2", 1)
            CALL DIALOG.setSelectionMode("s_detail3", 1)
 
            #add-point:ui_dialog段before name="ui_dialog.b_dialog"
            CALL cl_set_act_visible("logistics", FALSE)
            IF g_apca.apcastus NOT MATCHES "[N]" THEN   
               CALL cl_set_act_visible("insert,modify,delete,modify_detail", FALSE)
            END IF         
            #160225-00001#1--(S)
            IF NOT cl_null(g_apca.apcadocno) THEN
               SELECT glaald INTO l_ld FROM glaa_t
                WHERE glaaent = g_enterprise
                  AND glaacomp = g_apca.apcacomp
                  AND glaa014 = 'Y'
               CALL s_aooi200_fin_get_slip(g_apca.apcadocno) RETURNING g_sub_success,l_slip
               CALL s_fin_get_doc_para(l_ld,g_apca.apcacomp,l_slip,'D-FIN-0033') RETURNING l_dfin0033
               CALL s_fin_date_close_chk('@',g_apca.apcacomp,'AAP',g_apca.apcadocdt) RETURNING g_sub_success
               IF l_dfin0033 = "N" AND NOT g_sub_success THEN 
                  CALL cl_set_act_visible("insert,modify,delete,modify_detail", FALSE)
               END IF
            END IF
            #160225-00001#1--(E)            
            #end add-point
            NEXT FIELD CURRENT
      
         
         #應用 a67 樣板自動產生(Version:1)
         ON ACTION modify
            LET g_action_choice="modify"
            LET g_aw = ''
            CALL aapt300_02_show_ownid_msg()
            #因為不呼叫cl_auth_chk_act()，所以需另外紀錄log，
            #但紀錄log時需紀錄status，與鴻傑討論後，決議先一律紀錄成功
            CALL cl_log_act(g_action_choice,TRUE)
            CALL aapt300_02_modify()
            #add-point:ON ACTION modify name="menu.modify"
            
            #END add-point
            
 
 
 
 
         #應用 a67 樣板自動產生(Version:1)
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            LET g_aw = g_curr_diag.getCurrentItem()
            CALL aapt300_02_show_ownid_msg()
            #因為不呼叫cl_auth_chk_act()，所以需另外紀錄log，
            #但紀錄log時需紀錄status，與鴻傑討論後，決議先一律紀錄成功
            CALL cl_log_act(g_action_choice,TRUE)
            CALL aapt300_02_modify()
            #add-point:ON ACTION modify_detail name="menu.modify_detail"
            
            #END add-point
            
 
 
 
 
         #應用 a67 樣板自動產生(Version:1)
         ON ACTION delete
            LET g_action_choice="delete"
            CALL aapt300_02_show_ownid_msg()
            #因為不呼叫cl_auth_chk_act()，所以需另外紀錄log，
            #但紀錄log時需紀錄status，與鴻傑討論後，決議先一律紀錄成功
            CALL cl_log_act(g_action_choice,TRUE)
            CALL aapt300_02_delete()
            #add-point:ON ACTION delete name="menu.delete"
            
            #END add-point
            
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL aapt300_02_insert()
               #add-point:ON ACTION insert name="menu.insert"
               
               #END add-point
               
            END IF
 
 
 
 
      
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               CALL g_export_node.clear()
               LET g_export_node[1] = base.typeInfo.create(g_apce_d)
               LET g_export_id[1]   = "s_detail1"
               LET g_export_node[2] = base.typeInfo.create(g_apce2_d)
               LET g_export_id[2]   = "s_detail2"
               LET g_export_node[3] = base.typeInfo.create(g_apce3_d)
               LET g_export_id[3]   = "s_detail3"
 
               #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
               
               #END add-point
               CALL cl_export_to_excel_getpage()
               CALL cl_export_to_excel()
            END IF
            
         ON ACTION close
            LET INT_FLAG=FALSE         
            LET g_action_choice="exit"
            CANCEL DIALOG
      
         ON ACTION exit
            LET g_action_choice="exit"
            CANCEL DIALOG
            
         
         
         #應用 a46 樣板自動產生(Version:3)
         #新增相關文件
         ON ACTION related_document
            CALL aapt300_02_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"
               
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL aapt300_02_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"
            
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL aapt300_02_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"
            
            #END add-point
            CALL cl_user_overview_follow('')
 
 
 
         
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         EXIT WHILE
      END IF
      
   END WHILE
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.query" >}
#+ QBE資料查詢
PRIVATE FUNCTION aapt300_02_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point
   DEFINE ls_wc      LIKE type_t.chr500
   DEFINE ls_return  STRING
   DEFINE ls_result  STRING 
   #add-point:query段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
   
   #end add-point 
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   LET INT_FLAG = 0
   CLEAR FORM
   CALL g_apce_d.clear()
   
   LET g_qryparam.state = "c"
   
   #wc備份
   LET ls_wc = g_wc2
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      CONSTRUCT g_wc2 ON apcedocno,apceld,apceseq,apce002,apceorga,apce003,apce004,apce005,apce048,apce015, 
          apce016,apce016_desc,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119,apce027, 
          apce011,apce010,apce024,apce038,apce031,apce0162,apce0162_desc,apce017,apce017_desc,apce018, 
          apce018_desc,apce019,apce019_desc,apce020,apce020_desc,apce022,apce022_desc,apce023,apce023_desc, 
          apce035,apce035_desc,apce036,apce036_desc,apce044,apce044_desc,apce045,apce045_desc,apce046, 
          apce046_desc,apce121,apce123,apce124,apce129,apce131,apce133,apce134,apce139 
 
         FROM s_detail1[1].apcedocno,s_detail1[1].apceld,s_detail1[1].apceseq,s_detail1[1].apce002,s_detail1[1].apceorga, 
             s_detail1[1].apce003,s_detail1[1].apce004,s_detail1[1].apce005,s_detail1[1].apce048,s_detail1[1].apce015, 
             s_detail1[1].apce016,s_detail1[1].apce016_desc,s_detail1[1].apce100,s_detail1[1].apce101, 
             s_detail1[1].apce103,s_detail1[1].apce104,s_detail1[1].apce109,s_detail1[1].apce113,s_detail1[1].apce114, 
             s_detail1[1].apce119,s_detail1[1].apce027,s_detail1[1].apce011,s_detail1[1].apce010,s_detail1[1].apce024, 
             s_detail1[1].apce038,s_detail1[1].apce031,s_detail2[1].apce0162,s_detail2[1].apce0162_desc, 
             s_detail2[1].apce017,s_detail2[1].apce017_desc,s_detail2[1].apce018,s_detail2[1].apce018_desc, 
             s_detail2[1].apce019,s_detail2[1].apce019_desc,s_detail2[1].apce020,s_detail2[1].apce020_desc, 
             s_detail2[1].apce022,s_detail2[1].apce022_desc,s_detail2[1].apce023,s_detail2[1].apce023_desc, 
             s_detail2[1].apce035,s_detail2[1].apce035_desc,s_detail2[1].apce036,s_detail2[1].apce036_desc, 
             s_detail2[1].apce044,s_detail2[1].apce044_desc,s_detail2[1].apce045,s_detail2[1].apce045_desc, 
             s_detail2[1].apce046,s_detail2[1].apce046_desc,s_detail3[1].apce121,s_detail3[1].apce123, 
             s_detail3[1].apce124,s_detail3[1].apce129,s_detail3[1].apce131,s_detail3[1].apce133,s_detail3[1].apce134, 
             s_detail3[1].apce139 
      
         
      
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apcedocno
            #add-point:BEFORE FIELD apcedocno name="query.b.page1.apcedocno"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apcedocno
            
            #add-point:AFTER FIELD apcedocno name="query.a.page1.apcedocno"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apcedocno
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apcedocno
            #add-point:ON ACTION controlp INFIELD apcedocno name="query.c.page1.apcedocno"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apceld
            #add-point:BEFORE FIELD apceld name="query.b.page1.apceld"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apceld
            
            #add-point:AFTER FIELD apceld name="query.a.page1.apceld"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apceld
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apceld
            #add-point:ON ACTION controlp INFIELD apceld name="query.c.page1.apceld"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apceseq
            #add-point:BEFORE FIELD apceseq name="query.b.page1.apceseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apceseq
            
            #add-point:AFTER FIELD apceseq name="query.a.page1.apceseq"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apceseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apceseq
            #add-point:ON ACTION controlp INFIELD apceseq name="query.c.page1.apceseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce002
            #add-point:BEFORE FIELD apce002 name="query.b.page1.apce002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce002
            
            #add-point:AFTER FIELD apce002 name="query.a.page1.apce002"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce002
            #add-point:ON ACTION controlp INFIELD apce002 name="query.c.page1.apce002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apceorga
            #add-point:BEFORE FIELD apceorga name="query.b.page1.apceorga"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apceorga
            
            #add-point:AFTER FIELD apceorga name="query.a.page1.apceorga"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apceorga
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apceorga
            #add-point:ON ACTION controlp INFIELD apceorga name="query.c.page1.apceorga"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce003
            #add-point:BEFORE FIELD apce003 name="query.b.page1.apce003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce003
            
            #add-point:AFTER FIELD apce003 name="query.a.page1.apce003"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce003
            #add-point:ON ACTION controlp INFIELD apce003 name="query.c.page1.apce003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce004
            #add-point:BEFORE FIELD apce004 name="query.b.page1.apce004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce004
            
            #add-point:AFTER FIELD apce004 name="query.a.page1.apce004"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce004
            #add-point:ON ACTION controlp INFIELD apce004 name="query.c.page1.apce004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce005
            #add-point:BEFORE FIELD apce005 name="query.b.page1.apce005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce005
            
            #add-point:AFTER FIELD apce005 name="query.a.page1.apce005"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce005
            #add-point:ON ACTION controlp INFIELD apce005 name="query.c.page1.apce005"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce048
            #add-point:BEFORE FIELD apce048 name="query.b.page1.apce048"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce048
            
            #add-point:AFTER FIELD apce048 name="query.a.page1.apce048"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce048
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce048
            #add-point:ON ACTION controlp INFIELD apce048 name="query.c.page1.apce048"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce015
            #add-point:BEFORE FIELD apce015 name="query.b.page1.apce015"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce015
            
            #add-point:AFTER FIELD apce015 name="query.a.page1.apce015"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce015
            #add-point:ON ACTION controlp INFIELD apce015 name="query.c.page1.apce015"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce016
            #add-point:BEFORE FIELD apce016 name="query.b.page1.apce016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce016
            
            #add-point:AFTER FIELD apce016 name="query.a.page1.apce016"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce016
            #add-point:ON ACTION controlp INFIELD apce016 name="query.c.page1.apce016"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce016_desc
            #add-point:BEFORE FIELD apce016_desc name="query.b.page1.apce016_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce016_desc
            
            #add-point:AFTER FIELD apce016_desc name="query.a.page1.apce016_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce016_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce016_desc
            #add-point:ON ACTION controlp INFIELD apce016_desc name="query.c.page1.apce016_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce100
            #add-point:BEFORE FIELD apce100 name="query.b.page1.apce100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce100
            
            #add-point:AFTER FIELD apce100 name="query.a.page1.apce100"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce100
            #add-point:ON ACTION controlp INFIELD apce100 name="query.c.page1.apce100"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce101
            #add-point:BEFORE FIELD apce101 name="query.b.page1.apce101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce101
            
            #add-point:AFTER FIELD apce101 name="query.a.page1.apce101"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce101
            #add-point:ON ACTION controlp INFIELD apce101 name="query.c.page1.apce101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce103
            #add-point:BEFORE FIELD apce103 name="query.b.page1.apce103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce103
            
            #add-point:AFTER FIELD apce103 name="query.a.page1.apce103"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce103
            #add-point:ON ACTION controlp INFIELD apce103 name="query.c.page1.apce103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce104
            #add-point:BEFORE FIELD apce104 name="query.b.page1.apce104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce104
            
            #add-point:AFTER FIELD apce104 name="query.a.page1.apce104"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce104
            #add-point:ON ACTION controlp INFIELD apce104 name="query.c.page1.apce104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce109
            #add-point:BEFORE FIELD apce109 name="query.b.page1.apce109"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce109
            
            #add-point:AFTER FIELD apce109 name="query.a.page1.apce109"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce109
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce109
            #add-point:ON ACTION controlp INFIELD apce109 name="query.c.page1.apce109"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce113
            #add-point:BEFORE FIELD apce113 name="query.b.page1.apce113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce113
            
            #add-point:AFTER FIELD apce113 name="query.a.page1.apce113"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce113
            #add-point:ON ACTION controlp INFIELD apce113 name="query.c.page1.apce113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce114
            #add-point:BEFORE FIELD apce114 name="query.b.page1.apce114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce114
            
            #add-point:AFTER FIELD apce114 name="query.a.page1.apce114"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce114
            #add-point:ON ACTION controlp INFIELD apce114 name="query.c.page1.apce114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce119
            #add-point:BEFORE FIELD apce119 name="query.b.page1.apce119"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce119
            
            #add-point:AFTER FIELD apce119 name="query.a.page1.apce119"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce119
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce119
            #add-point:ON ACTION controlp INFIELD apce119 name="query.c.page1.apce119"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce027
            #add-point:BEFORE FIELD apce027 name="query.b.page1.apce027"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce027
            
            #add-point:AFTER FIELD apce027 name="query.a.page1.apce027"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce027
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce027
            #add-point:ON ACTION controlp INFIELD apce027 name="query.c.page1.apce027"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce011
            #add-point:BEFORE FIELD apce011 name="query.b.page1.apce011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce011
            
            #add-point:AFTER FIELD apce011 name="query.a.page1.apce011"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce011
            #add-point:ON ACTION controlp INFIELD apce011 name="query.c.page1.apce011"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce010
            #add-point:BEFORE FIELD apce010 name="query.b.page1.apce010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce010
            
            #add-point:AFTER FIELD apce010 name="query.a.page1.apce010"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce010
            #add-point:ON ACTION controlp INFIELD apce010 name="query.c.page1.apce010"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce024
            #add-point:BEFORE FIELD apce024 name="query.b.page1.apce024"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce024
            
            #add-point:AFTER FIELD apce024 name="query.a.page1.apce024"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce024
            #add-point:ON ACTION controlp INFIELD apce024 name="query.c.page1.apce024"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce038
            #add-point:BEFORE FIELD apce038 name="query.b.page1.apce038"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce038
            
            #add-point:AFTER FIELD apce038 name="query.a.page1.apce038"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce038
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce038
            #add-point:ON ACTION controlp INFIELD apce038 name="query.c.page1.apce038"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce031
            #add-point:BEFORE FIELD apce031 name="query.b.page1.apce031"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce031
            
            #add-point:AFTER FIELD apce031 name="query.a.page1.apce031"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page1.apce031
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce031
            #add-point:ON ACTION controlp INFIELD apce031 name="query.c.page1.apce031"
            
            #END add-point
 
 
  
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce0162
            #add-point:BEFORE FIELD apce0162 name="query.b.page2.apce0162"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce0162
            
            #add-point:AFTER FIELD apce0162 name="query.a.page2.apce0162"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce0162
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce0162
            #add-point:ON ACTION controlp INFIELD apce0162 name="query.c.page2.apce0162"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce0162_desc
            #add-point:BEFORE FIELD apce0162_desc name="query.b.page2.apce0162_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce0162_desc
            
            #add-point:AFTER FIELD apce0162_desc name="query.a.page2.apce0162_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce0162_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce0162_desc
            #add-point:ON ACTION controlp INFIELD apce0162_desc name="query.c.page2.apce0162_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce017
            #add-point:BEFORE FIELD apce017 name="query.b.page2.apce017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce017
            
            #add-point:AFTER FIELD apce017 name="query.a.page2.apce017"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce017
            #add-point:ON ACTION controlp INFIELD apce017 name="query.c.page2.apce017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce017_desc
            #add-point:BEFORE FIELD apce017_desc name="query.b.page2.apce017_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce017_desc
            
            #add-point:AFTER FIELD apce017_desc name="query.a.page2.apce017_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce017_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce017_desc
            #add-point:ON ACTION controlp INFIELD apce017_desc name="query.c.page2.apce017_desc"
            #業務人員
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.state = 'c'
            CALL q_ooag001_8()
            DISPLAY g_qryparam.return1 TO apce017
            DISPLAY g_qryparam.return1 TO apce017_desc
            NEXT FIELD apce017_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce018
            #add-point:BEFORE FIELD apce018 name="query.b.page2.apce018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce018
            
            #add-point:AFTER FIELD apce018 name="query.a.page2.apce018"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce018
            #add-point:ON ACTION controlp INFIELD apce018 name="query.c.page2.apce018"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce018_desc
            #add-point:BEFORE FIELD apce018_desc name="query.b.page2.apce018_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce018_desc
            
            #add-point:AFTER FIELD apce018_desc name="query.a.page2.apce018_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce018_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce018_desc
            #add-point:ON ACTION controlp INFIELD apce018_desc name="query.c.page2.apce018_desc"
            #業務部門
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_today
            CALL q_ooeg001_4()
            DISPLAY g_qryparam.return1 TO apce018
            DISPLAY g_qryparam.return1 TO apce018_desc
            NEXT FIELD apce018_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce019
            #add-point:BEFORE FIELD apce019 name="query.b.page2.apce019"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce019
            
            #add-point:AFTER FIELD apce019 name="query.a.page2.apce019"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce019
            #add-point:ON ACTION controlp INFIELD apce019 name="query.c.page2.apce019"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce019_desc
            #add-point:BEFORE FIELD apce019_desc name="query.b.page2.apce019_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce019_desc
            
            #add-point:AFTER FIELD apce019_desc name="query.a.page2.apce019_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce019_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce019_desc
            #add-point:ON ACTION controlp INFIELD apce019_desc name="query.c.page2.apce019_desc"
            #責任中心
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_today
            LET g_qryparam.where = " ooeg003 IN ('1','2','3')"
            CALL q_ooeg001_4()
            DISPLAY g_qryparam.return1 TO apce019
            DISPLAY g_qryparam.return1 TO apce019_desc
            NEXT FIELD apce019_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce020
            #add-point:BEFORE FIELD apce020 name="query.b.page2.apce020"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce020
            
            #add-point:AFTER FIELD apce020 name="query.a.page2.apce020"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce020
            #add-point:ON ACTION controlp INFIELD apce020 name="query.c.page2.apce020"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce020_desc
            #add-point:BEFORE FIELD apce020_desc name="query.b.page2.apce020_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce020_desc
            
            #add-point:AFTER FIELD apce020_desc name="query.a.page2.apce020_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce020_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce020_desc
            #add-point:ON ACTION controlp INFIELD apce020_desc name="query.c.page2.apce020_desc"
            #產品類別
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_rtax001()
            DISPLAY g_qryparam.return1 TO apce020
            DISPLAY g_qryparam.return1 TO apce020_desc
            NEXT FIELD apce020_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce022
            #add-point:BEFORE FIELD apce022 name="query.b.page2.apce022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce022
            
            #add-point:AFTER FIELD apce022 name="query.a.page2.apce022"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce022
            #add-point:ON ACTION controlp INFIELD apce022 name="query.c.page2.apce022"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce022_desc
            #add-point:BEFORE FIELD apce022_desc name="query.b.page2.apce022_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce022_desc
            
            #add-point:AFTER FIELD apce022_desc name="query.a.page2.apce022_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce022_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce022_desc
            #add-point:ON ACTION controlp INFIELD apce022_desc name="query.c.page2.apce022_desc"
            #專案代號
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_pjba001()
            DISPLAY g_qryparam.return1 TO apce022
            DISPLAY g_qryparam.return1 TO apce022_desc
            NEXT FIELD apce022_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce023
            #add-point:BEFORE FIELD apce023 name="query.b.page2.apce023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce023
            
            #add-point:AFTER FIELD apce023 name="query.a.page2.apce023"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce023
            #add-point:ON ACTION controlp INFIELD apce023 name="query.c.page2.apce023"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce023_desc
            #add-point:BEFORE FIELD apce023_desc name="query.b.page2.apce023_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce023_desc
            
            #add-point:AFTER FIELD apce023_desc name="query.a.page2.apce023_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce023_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce023_desc
            #add-point:ON ACTION controlp INFIELD apce023_desc name="query.c.page2.apce023_desc"
            #WBS
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = "pjbb012='1'"
            CALL q_pjbb002()
            DISPLAY g_qryparam.return1 TO apce023
            DISPLAY g_qryparam.return1 TO apce023_desc
            NEXT FIELD apce023_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce035
            #add-point:BEFORE FIELD apce035 name="query.b.page2.apce035"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce035
            
            #add-point:AFTER FIELD apce035 name="query.a.page2.apce035"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce035
            #add-point:ON ACTION controlp INFIELD apce035 name="query.c.page2.apce035"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce035_desc
            #add-point:BEFORE FIELD apce035_desc name="query.b.page2.apce035_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce035_desc
            
            #add-point:AFTER FIELD apce035_desc name="query.a.page2.apce035_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce035_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce035_desc
            #add-point:ON ACTION controlp INFIELD apce035_desc name="query.c.page2.apce035_desc"
            #區域
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002_287()
            DISPLAY g_qryparam.return1 TO apce035
            DISPLAY g_qryparam.return1 TO apce035_desc
            NEXT FIELD apce035_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce036
            #add-point:BEFORE FIELD apce036 name="query.b.page2.apce036"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce036
            
            #add-point:AFTER FIELD apce036 name="query.a.page2.apce036"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce036
            #add-point:ON ACTION controlp INFIELD apce036 name="query.c.page2.apce036"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce036_desc
            #add-point:BEFORE FIELD apce036_desc name="query.b.page2.apce036_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce036_desc
            
            #add-point:AFTER FIELD apce036_desc name="query.a.page2.apce036_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce036_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce036_desc
            #add-point:ON ACTION controlp INFIELD apce036_desc name="query.c.page2.apce036_desc"
            #客群
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002_281()
            DISPLAY g_qryparam.return1 TO apce036
            DISPLAY g_qryparam.return1 TO apce036_desc
            NEXT FIELD apce036_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce044
            #add-point:BEFORE FIELD apce044 name="query.b.page2.apce044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce044
            
            #add-point:AFTER FIELD apce044 name="query.a.page2.apce044"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce044
            #add-point:ON ACTION controlp INFIELD apce044 name="query.c.page2.apce044"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce044_desc
            #add-point:BEFORE FIELD apce044_desc name="query.b.page2.apce044_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce044_desc
            
            #add-point:AFTER FIELD apce044_desc name="query.a.page2.apce044_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce044_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce044_desc
            #add-point:ON ACTION controlp INFIELD apce044_desc name="query.c.page2.apce044_desc"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce045
            #add-point:BEFORE FIELD apce045 name="query.b.page2.apce045"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce045
            
            #add-point:AFTER FIELD apce045 name="query.a.page2.apce045"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce045
            #add-point:ON ACTION controlp INFIELD apce045 name="query.c.page2.apce045"
 
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce045_desc
            #add-point:BEFORE FIELD apce045_desc name="query.b.page2.apce045_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce045_desc
            
            #add-point:AFTER FIELD apce045_desc name="query.a.page2.apce045_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce045_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce045_desc
            #add-point:ON ACTION controlp INFIELD apce045_desc name="query.c.page2.apce045_desc"
            #渠道
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oojd001_2()
            DISPLAY g_qryparam.return1 TO apce045
            DISPLAY g_qryparam.return1 TO apce045_desc
            NEXT FIELD apce045_desc
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce046
            #add-point:BEFORE FIELD apce046 name="query.b.page2.apce046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce046
            
            #add-point:AFTER FIELD apce046 name="query.a.page2.apce046"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce046
            #add-point:ON ACTION controlp INFIELD apce046 name="query.c.page2.apce046"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce046_desc
            #add-point:BEFORE FIELD apce046_desc name="query.b.page2.apce046_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce046_desc
            
            #add-point:AFTER FIELD apce046_desc name="query.a.page2.apce046_desc"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page2.apce046_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce046_desc
            #add-point:ON ACTION controlp INFIELD apce046_desc name="query.c.page2.apce046_desc"
            #品牌
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_oocq002_2002()
            DISPLAY g_qryparam.return1 TO apce046
            DISPLAY g_qryparam.return1 TO apce046_desc
            NEXT FIELD apce046_desc
            #END add-point
 
 
  
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce121
            #add-point:BEFORE FIELD apce121 name="query.b.page3.apce121"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce121
            
            #add-point:AFTER FIELD apce121 name="query.a.page3.apce121"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce121
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce121
            #add-point:ON ACTION controlp INFIELD apce121 name="query.c.page3.apce121"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce123
            #add-point:BEFORE FIELD apce123 name="query.b.page3.apce123"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce123
            
            #add-point:AFTER FIELD apce123 name="query.a.page3.apce123"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce123
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce123
            #add-point:ON ACTION controlp INFIELD apce123 name="query.c.page3.apce123"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce124
            #add-point:BEFORE FIELD apce124 name="query.b.page3.apce124"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce124
            
            #add-point:AFTER FIELD apce124 name="query.a.page3.apce124"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce124
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce124
            #add-point:ON ACTION controlp INFIELD apce124 name="query.c.page3.apce124"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce129
            #add-point:BEFORE FIELD apce129 name="query.b.page3.apce129"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce129
            
            #add-point:AFTER FIELD apce129 name="query.a.page3.apce129"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce129
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce129
            #add-point:ON ACTION controlp INFIELD apce129 name="query.c.page3.apce129"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce131
            #add-point:BEFORE FIELD apce131 name="query.b.page3.apce131"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce131
            
            #add-point:AFTER FIELD apce131 name="query.a.page3.apce131"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce131
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce131
            #add-point:ON ACTION controlp INFIELD apce131 name="query.c.page3.apce131"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce133
            #add-point:BEFORE FIELD apce133 name="query.b.page3.apce133"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce133
            
            #add-point:AFTER FIELD apce133 name="query.a.page3.apce133"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce133
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce133
            #add-point:ON ACTION controlp INFIELD apce133 name="query.c.page3.apce133"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce134
            #add-point:BEFORE FIELD apce134 name="query.b.page3.apce134"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce134
            
            #add-point:AFTER FIELD apce134 name="query.a.page3.apce134"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce134
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce134
            #add-point:ON ACTION controlp INFIELD apce134 name="query.c.page3.apce134"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce139
            #add-point:BEFORE FIELD apce139 name="query.b.page3.apce139"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce139
            
            #add-point:AFTER FIELD apce139 name="query.a.page3.apce139"
            
            #END add-point
            
 
 
         #Ctrlp:query.c.page3.apce139
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce139
            #add-point:ON ACTION controlp INFIELD apce139 name="query.c.page3.apce139"
            
            #END add-point
 
 
  
 
      
         BEFORE CONSTRUCT
            #add-point:cs段more_construct name="cs.before_construct"
            
            #end add-point 
      
      END CONSTRUCT
  
      #add-point:query段more_construct name="query.more_construct"
      
      #end add-point 
  
      BEFORE DIALOG 
         CALL cl_qbe_init()
         #add-point:query段before_dialog name="query.before_dialog"
         
         #end add-point 
      
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
      
      ON ACTION qbe_save
         CALL cl_qbe_save()
      
      ON ACTION accept
         ACCEPT DIALOG
         
      ON ACTION cancel
         LET INT_FLAG = 1
         CANCEL DIALOG
      
      #交談指令共用ACTION
      &include "common_action.4gl"
      CONTINUE DIALOG 
   END DIALOG
 
   #add-point:query段after_construct name="query.after_construct"
   
   #end add-point
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      #還原
      #LET g_wc2 = ls_wc
      LET g_wc2 = " 1=2"
      RETURN
   ELSE
      LET g_error_show = 1
      LET g_detail_idx = 1
   END IF
    
   CALL aapt300_02_b_fill(g_wc2)
 
   IF g_detail_cnt = 0 AND NOT INT_FLAG THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = -100 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   END IF
   
   LET INT_FLAG = FALSE
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.insert" >}
#+ 資料新增
PRIVATE FUNCTION aapt300_02_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"
   
   #end add-point
   #add-point:delete段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"
   
   #end add-point                
   
   #add-point:Function前置處理  name="insert.pre_function"
   
   #end add-point
   
   #add-point:單身新增前 name="insert.b_insert"
   
   #end add-point
   
   LET g_insert = 'Y'
   CALL aapt300_02_modify()
            
   #add-point:單身新增後 name="insert.a_insert"
   
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.modify" >}
#+ 資料修改
PRIVATE FUNCTION aapt300_02_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"
   
   #end add-point
   DEFINE  l_cmd                  LIKE type_t.chr1
   DEFINE  l_ac_t                 LIKE type_t.num10               #未取消的ARRAY CNT 
   DEFINE  l_n                    LIKE type_t.num10               #檢查重複用  
   DEFINE  l_cnt                  LIKE type_t.num10               #檢查重複用  
   DEFINE  l_lock_sw              LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert         LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete         LIKE type_t.num5                #可刪除否  
   DEFINE  l_count                LIKE type_t.num10
   DEFINE  l_i                    LIKE type_t.num10
   DEFINE  ls_return              STRING
   DEFINE  l_var_keys             DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys           DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                 DYNAMIC ARRAY OF STRING
   DEFINE  l_fields               DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak         DYNAMIC ARRAY OF STRING
   DEFINE  li_reproduce           LIKE type_t.num10
   DEFINE  li_reproduce_target    LIKE type_t.num10
   DEFINE  lb_reproduce           BOOLEAN
   DEFINE  l_insert               BOOLEAN
   #add-point:modify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"
   DEFINE  l_apceorga_comp        LIKE glaa_t.glaacomp
   DEFINE  l_apceorga_ld          LIKE glaa_t.glaald  
   DEFINE  l_glaa001              LIKE glaa_t.glaa001  
   DEFINE  l_amt               RECORD
                                  apcc10x    LIKE type_t.num20_6,
                                  apcc11x    LIKE type_t.num20_6,
                                  apcc12x    LIKE type_t.num20_6,
                                  apcc13x    LIKE type_t.num20_6
                               END RECORD
   DEFINE  l_glae009              LIKE glae_t.glae009    #自由核算項使用                                    
   DEFINE  l_apcc_used         RECORD
                                  apcc10x    LIKE type_t.num20_6,
                                  apcc11x    LIKE type_t.num20_6,
                                  apcc12x    LIKE type_t.num20_6,
                                  apcc13x    LIKE type_t.num20_6
                               END RECORD         
   #150512-00036#1--(s)
   DEFINE l_wc                   STRING
   DEFINE l_flag                 LIKE type_t.chr1       #開窗多筆寫入後,標記繼續留在輸入中
   #150512-00036#1--(e) 
   #XZG20151130
   DEFINE l_glaa004             LIKE glaa_t.glaa004
   #XZG20151130
   #160628-00002#2--add--str--
   DEFINE r_apce_w            RECORD
          apce103             LIKE apce_t.apce103,
          apce104             LIKE apce_t.apce104,
          apce109             LIKE apce_t.apce109,
          apce113             LIKE apce_t.apce113,
          apce114             LIKE apce_t.apce114,
          apce119             LIKE apce_t.apce119,
          apce123             LIKE apce_t.apce123,
          apce124             LIKE apce_t.apce124,
          apce129             LIKE apce_t.apce129,
          apce133             LIKE apce_t.apce133,
          apce134             LIKE apce_t.apce134,
          apce139             LIKE apce_t.apce139
          END RECORD
   DEFINE l_apca011           LIKE apca_t.apca011
   DEFINE l_oodb005           LIKE oodb_t.oodb005
   DEFINE l_oodb006           LIKE oodb_t.oodb006
   DEFINE l_oodb011           LIKE oodb_t.oodb011
   DEFINE l_oodbl004          LIKE oodbl_t.oodbl004
   DEFINE l_success           LIKE type_t.num5
   #160628-00002#2--add--end
   #end add-point 
   
   #add-point:Function前置處理  name="modify.pre_function"
   
   #end add-point
   
#  LET g_action_choice = ""   #(ver:35) mark
   
   LET g_qryparam.state = "i"
 
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   
   #add-point:modify開始前 name="modify.define_sql"
   CASE g_apca.apcastus
        WHEN 'Y'
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = ''
            LET g_errparam.code   = 'axr-00037'
            LET g_errparam.popup  = FALSE
            CALL cl_err()
            RETURN
        WHEN 'X'
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = ''
            LET g_errparam.code   = 'apr-00207'
            LET g_errparam.popup  = FALSE
            CALL cl_err()
            RETURN
   END CASE
   #end add-point
   
   LET INT_FLAG = FALSE
   LET lb_reproduce = FALSE
   LET l_insert = FALSE
 
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
 
   #add-point:modify段修改前 name="modify.before_input"
   #150512-00036#1--(s)
   WHILE TRUE
      LET l_flag = 'N'
   #150512-00036#1--(e)
   #end add-point
 
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #Page1 預設值產生於此處
      INPUT ARRAY g_apce_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_detail_cnt,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
         
         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_apce_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aapt300_02_b_fill(g_wc2)
            LET g_detail_cnt = g_apce_d.getLength()
         
         BEFORE ROW
            #add-point:modify段before row name="input.body.before_row2"
            CALL s_transaction_begin()   #150419
            #end add-point  
            LET l_insert = FALSE
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail1")
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = g_detail_idx
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            DISPLAY g_apce_d.getLength() TO FORMONLY.cnt
         
            CALL s_transaction_begin()
            LET g_detail_cnt = g_apce_d.getLength()
            
            IF g_detail_cnt >= l_ac 
               AND g_apce_d[l_ac].apceld IS NOT NULL
               AND g_apce_d[l_ac].apcedocno IS NOT NULL
               AND g_apce_d[l_ac].apceseq IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_apce_d_t.* = g_apce_d[l_ac].*  #BACKUP
               LET g_apce_d_o.* = g_apce_d[l_ac].*  #BACKUP
               IF NOT aapt300_02_lock_b("apce_t") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aapt300_02_bcl INTO g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq, 
                      g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004, 
                      g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016, 
                      g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104, 
                      g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119, 
                      g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024, 
                      g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031,g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite, 
                      g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apcedocno,g_apce2_d[l_ac].apceld,g_apce2_d[l_ac].apceseq, 
                      g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020, 
                      g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036, 
                      g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051, 
                      g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055, 
                      g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059, 
                      g_apce2_d[l_ac].apce060,g_apce3_d[l_ac].apcedocno,g_apce3_d[l_ac].apceld,g_apce3_d[l_ac].apceseq, 
                      g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
                      g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
                      g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_apce_d_t.apceld,":",SQLERRMESSAGE  
                     LET g_errparam.code = SQLCA.SQLCODE
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_apce_d_mask_o[l_ac].* =  g_apce_d[l_ac].*
                  CALL aapt300_02_apce_t_mask()
                  LET g_apce_d_mask_n[l_ac].* =  g_apce_d[l_ac].*
                  
                  CALL aapt300_02_detail_show()
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            CALL aapt300_02_set_entry_b(l_cmd)
            CALL aapt300_02_set_no_entry_b(l_cmd)
            #add-point:modify段before row name="input.body.before_row"
            #取得來源組織所屬法人
            CALL s_fin_orga_get_comp_ld(g_apce_d[l_ac].apceorga) RETURNING g_sub_success,g_errno,l_apceorga_comp,l_apceorga_ld
            CALL s_ld_sel_glaa(l_apceorga_ld,'glaa001') RETURNING  g_sub_success,l_glaa001
            #160628-00002#2--add--str--
            IF l_cmd = 'u' THEN
               IF g_apce_d[l_ac].apce027 = 'Y' THEN
                  #判断是否冲抵完，如果全冲销完，未税金额和税额不可修改
                  CALL s_aapt300_not_washed_amt(g_apce_d[l_ac].apceld,g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005)
                  RETURNING r_apce_w.*
                  IF r_apce_w.apce109 = g_apce_d[l_ac].apce109 THEN
                     CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                  ELSE
                     CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",TRUE)
                  END IF
               ELSE
                  CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
               END IF
            END IF
            #160628-00002#2--add--end
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
 
 
            #其他table進行lock
            
 
 
 
        
         BEFORE INSERT
            
            LET l_insert = TRUE
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_apce_d_t.* TO NULL
            INITIALIZE g_apce_d_o.* TO NULL
            INITIALIZE g_apce_d[l_ac].* TO NULL 
            #公用欄位給值(單身)
            
            #自定義預設值(單身3)
                  LET g_apce_d[l_ac].apce002 = "41"
      LET g_apce_d[l_ac].apce103 = "0"
      LET g_apce_d[l_ac].apce113 = "0"
 
            #add-point:modify段before備份 name="input.body.before_bak"
            LET g_apce_d[l_ac].apceld = g_apca.apcald
            LET g_apce_d[l_ac].apcedocno = g_apca.apcadocno            
            LET g_apce_d[l_ac].apce001 = g_prog
            LET g_apce_d[l_ac].apce002 = "41"
            #帶出借貸別(正負值)
            LET g_apce_d[l_ac].apce015 = s_fin_get_scc_value('8506',g_apce_d[l_ac].apce002,'3')              
            LET g_apce_d[l_ac].apcecomp = g_apca.apcacomp
            LET g_apce_d[l_ac].apcesite = g_apca.apcasite   
            LET g_apce_d[l_ac].apceorga = g_apca.apcacomp 
            LET g_apce_d[l_ac].apceorga_desc = s_desc_get_department_desc(g_apce_d[l_ac].apceorga)
            DISPLAY BY NAME g_apce_d[l_ac].apceorga_desc
            #取得來源組織所屬法人
            CALL s_fin_orga_get_comp_ld(g_apce_d[l_ac].apceorga) RETURNING g_sub_success,g_errno,l_apceorga_comp,l_apceorga_ld
            CALL s_ld_sel_glaa(l_apceorga_ld,'glaa001') RETURNING  g_sub_success,l_glaa001            
            LET g_apce_d[l_ac].apce027 = 'N'
            #end add-point
            LET g_apce_d_t.* = g_apce_d[l_ac].*     #新輸入資料
            LET g_apce_d_o.* = g_apce_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_apce_d[li_reproduce_target].* = g_apce_d[li_reproduce].*
               LET g_apce2_d[li_reproduce_target].* = g_apce2_d[li_reproduce].*
               LET g_apce3_d[li_reproduce_target].* = g_apce3_d[li_reproduce].*
 
               LET g_apce_d[g_apce_d.getLength()].apceld = NULL
               LET g_apce_d[g_apce_d.getLength()].apcedocno = NULL
               LET g_apce_d[g_apce_d.getLength()].apceseq = NULL
 
            END IF
            
 
 
 
            CALL aapt300_02_set_entry_b(l_cmd)
            CALL aapt300_02_set_no_entry_b(l_cmd)
            #add-point:modify段before insert name="input.body.before_insert"
            #預帶項次
            LET g_apce_d[l_ac].apceseq = NULL
            SELECT MAX(apceseq) INTO g_apce_d[l_ac].apceseq FROM apce_t
             WHERE apceent = g_enterprise
               AND apceld  = g_apca.apcald
               AND apcedocno = g_apca.apcadocno
            IF cl_null(g_apce_d[l_ac].apceseq) THEN
               LET g_apce_d[l_ac].apceseq = 0 
            END IF            
            LET g_apce_d[l_ac].apceseq = g_apce_d[l_ac].apceseq + 1
            #end add-point  
  
         AFTER INSERT
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM apce_t 
             WHERE apceent = g_enterprise AND apceld = g_apce_d[l_ac].apceld
                                       AND apcedocno = g_apce_d[l_ac].apcedocno
                                       AND apceseq = g_apce_d[l_ac].apceseq
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身新增前 name="input.body.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce_d[g_detail_idx].apceld
               LET gs_keys[2] = g_apce_d[g_detail_idx].apcedocno
               LET gs_keys[3] = g_apce_d[g_detail_idx].apceseq
               CALL aapt300_02_insert_b('apce_t',gs_keys,"'1'")
                           
               #add-point:單身新增後 name="input.body.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_apce_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aapt300_02_b_fill(g_wc2)
               #資料多語言用-增/改
               
               #add-point:input段-after_insert name="input.body.a_insert2"
               #應付單可沖金額 < 直接沖帳金額
               CALL aapt300_02_get_contra_amount(g_apca.apcald,g_apca.apcadocno,'','') RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x
               IF l_amt.apcc11x < 0 OR (aapt300_02_contra_curr_chk(g_apca.apcald,g_apca.apcadocno,g_apce_d[l_ac].apce100) AND l_amt.apcc10x < 0 ) OR
                 (g_glaa.glaa015 = 'Y' AND l_amt.apcc12x < 0) OR (g_glaa.glaa019 = 'Y' AND l_amt.apcc13x < 0) THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = '' 
                  LET g_errparam.code   = 'aap-00064' 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()         
                  CALL s_transaction_end('N','0')      
                  CANCEL INSERT   
               ELSE                                #150419
                  CALL s_transaction_end('Y','0')  #150419               
               END IF
               #end add-point
               ##ERROR 'INSERT O.K'
               LET g_detail_cnt = g_detail_cnt + 1
               
               LET g_wc2 = g_wc2, " OR (apceld = '", g_apce_d[l_ac].apceld, "' "
                                  ," AND apcedocno = '", g_apce_d[l_ac].apcedocno, "' "
                                  ," AND apceseq = '", g_apce_d[l_ac].apceseq, "' "
 
                                  ,")"
            END IF                
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
            ELSE
               #add-point:單身刪除ask前 name="input.body.b_delete_ask"
               
               #end add-point   
               
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身刪除前 name="input.body.b_delete"
               
               #end add-point   
               
               DELETE FROM apce_t
                WHERE apceent = g_enterprise AND 
                      apceld = g_apce_d_t.apceld
                      AND apcedocno = g_apce_d_t.apcedocno
                      AND apceseq = g_apce_d_t.apceseq
 
                      
               #add-point:單身刪除中 name="input.body.m_delete"
               
               #end add-point  
                      
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE   
               ELSE
                  LET g_detail_cnt = g_detail_cnt-1
                  
 
 
 
                  #add-point:單身刪除後 name="input.body.a_delete"
                  
                  #end add-point
                  #修改歷程記錄(刪除)
                  CALL aapt300_02_set_pk_array()
                  LET g_log1 = util.JSON.stringify(g_apce_d[l_ac])   #(ver:38)
                  IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:38)
                  ELSE
                  END IF
               END IF 
               CLOSE aapt300_02_bcl
               #add-point:單身關閉bcl name="input.body.close"
               
               #end add-point
               LET l_count = g_apce_d.getLength()
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce_d_t.apceld
               LET gs_keys[2] = g_apce_d_t.apcedocno
               LET gs_keys[3] = g_apce_d_t.apceseq
 
               #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL aapt300_02_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
 
            END IF 
              
         AFTER DELETE 
            IF l_cmd <> 'd' THEN
               #add-point:單身刪除後2 name="input.body.after_delete"
               
               #end add-point
                              CALL aapt300_02_delete_b('apce_t',gs_keys,"'1'")
            END IF
            #如果是最後一筆
            IF l_ac = (g_apce_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
            #add-point:單身刪除後3 name="input.body.after_delete3"
            
            #end add-point
 
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apceld
            #add-point:BEFORE FIELD apceld name="input.b.page1.apceld"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apceld
            
            #add-point:AFTER FIELD apceld name="input.a.page1.apceld"
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_apce_d[g_detail_idx].apceld IS NOT NULL AND g_apce_d[g_detail_idx].apcedocno IS NOT NULL AND g_apce_d[g_detail_idx].apceseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_apce_d[g_detail_idx].apceld != g_apce_d_t.apceld OR g_apce_d[g_detail_idx].apcedocno != g_apce_d_t.apcedocno OR g_apce_d[g_detail_idx].apceseq != g_apce_d_t.apceseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apce_t WHERE "||"apceent = '" ||g_enterprise|| "' AND "||"apceld = '"||g_apce_d[g_detail_idx].apceld ||"' AND "|| "apcedocno = '"||g_apce_d[g_detail_idx].apcedocno ||"' AND "|| "apceseq = '"||g_apce_d[g_detail_idx].apceseq ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apceld
            #add-point:ON CHANGE apceld name="input.g.page1.apceld"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apceseq
            #add-point:BEFORE FIELD apceseq name="input.b.page1.apceseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apceseq
            
            #add-point:AFTER FIELD apceseq name="input.a.page1.apceseq"
            #此段落由子樣板a05產生
            #確認資料無重複
            IF  g_apce_d[g_detail_idx].apceld IS NOT NULL AND g_apce_d[g_detail_idx].apcedocno IS NOT NULL AND g_apce_d[g_detail_idx].apceseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_apce_d[g_detail_idx].apceld != g_apce_d_t.apceld OR g_apce_d[g_detail_idx].apcedocno != g_apce_d_t.apcedocno OR g_apce_d[g_detail_idx].apceseq != g_apce_d_t.apceseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apce_t WHERE "||"apceent = '" ||g_enterprise|| "' AND "||"apceld = '"||g_apce_d[g_detail_idx].apceld ||"' AND "|| "apcedocno = '"||g_apce_d[g_detail_idx].apcedocno ||"' AND "|| "apceseq = '"||g_apce_d[g_detail_idx].apceseq ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apceseq
            #add-point:ON CHANGE apceseq name="input.g.page1.apceseq"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce002
            #add-point:BEFORE FIELD apce002 name="input.b.page1.apce002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce002
            
            #add-point:AFTER FIELD apce002 name="input.a.page1.apce002"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce002
            #add-point:ON CHANGE apce002 name="input.g.page1.apce002"
            LET g_apce_d[l_ac].apce015 = s_fin_get_scc_value('8506',g_apce_d[l_ac].apce002,'3')
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apceorga
            
            #add-point:AFTER FIELD apceorga name="input.a.page1.apceorga"
            LET g_apce_d[l_ac].apceorga_desc = ' ' 
            DISPLAY BY NAME g_apce_d[l_ac].apceorga_desc
            IF NOT cl_null(g_apce_d[l_ac].apceorga) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apceorga != g_apce_d_t.apceorga OR g_apce_d_t.apceorga IS NULL )) THEN
                  #CALL s_fin_comp_chk(g_apce_d[l_ac].apceorga) RETURNING g_sub_success,g_errno        #161006-00005#4   mark
                  CALL s_aap_apcborga_chk(g_apcald,g_apcadocno,g_apce_d[l_ac].apceorga,g_wc_cs_orga)   #161006-00005#4   add
                       RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     #160321-00016#20 --s add
                     LET g_errparam.replace[1] = 'aooi100'
                     LET g_errparam.replace[2] = cl_get_progname('aooi100',g_lang,"2")
                     LET g_errparam.exeprog = 'aooi100'
                     #160321-00016#20 --e add
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_apce_d[l_ac].apceorga = g_apce_d_t.apceorga
                     LET g_apce_d[l_ac].apceorga_desc = s_desc_get_department_desc(g_apce_d[l_ac].apceorga)
                     DISPLAY BY NAME g_apce_d[l_ac].apceorga_desc
                     NEXT FIELD CURRENT
                  END IF 
                  #161006-00005#4   add---s
                  LET l_count = NULL
                  SELECT count(1) INTO l_count 
                    FROM s_fin_tmp1
                   WHERE ooef001 = g_apce_d[l_ac].apceorga
                     
                  IF cl_null(l_count) THEN LET l_count = 0 END IF  
                     
                  IF l_count = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00342'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apceorga = g_apce_d_t.apceorga
                     LET g_apce_d[l_ac].apceorga_desc = s_desc_get_department_desc(g_apce_d[l_ac].apceorga)
                     DISPLAY BY NAME g_apce_d[l_ac].apceorga_desc
                     NEXT FIELD CURRENT
                  END IF
                  #161006-00005#4   add---e                  
                  #取得來源組織所屬法人
                  CALL s_fin_orga_get_comp_ld(g_apce_d[l_ac].apceorga) RETURNING g_sub_success,g_errno,l_apceorga_comp,l_apceorga_ld            
                  CALL s_ld_sel_glaa(l_apceorga_ld,'glaa001') RETURNING  g_sub_success,l_glaa001                                     
               END IF
            ELSE
               LET l_apceorga_comp = ''
               LET l_apceorga_ld = ''               
            END IF           
            LET g_apce_d[l_ac].apceorga_desc = s_desc_get_department_desc(g_apce_d[l_ac].apceorga)
            DISPLAY BY NAME g_apce_d[l_ac].apceorga_desc

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apceorga
            #add-point:BEFORE FIELD apceorga name="input.b.page1.apceorga"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apceorga
            #add-point:ON CHANGE apceorga name="input.g.page1.apceorga"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce003
            #add-point:BEFORE FIELD apce003 name="input.b.page1.apce003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce003
            
            #add-point:AFTER FIELD apce003 name="input.a.page1.apce003"
            IF NOT cl_null(g_apce_d[l_ac].apce003) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce003 != g_apce_d_t.apce003 OR g_apce_d_t.apce003 IS NULL )) THEN
                  IF NOT cl_null(g_apce_d[l_ac].apce004)
                     AND NOT cl_null(g_apce_d[l_ac].apce005) THEN    
                     IF NOT cl_null(g_apce_d[l_ac].apce003) AND NOT cl_null(g_apce_d[l_ac].apce004) AND 
                        NOT cl_null(g_apce_d[l_ac].apce005) THEN
                        CALL s_aapt420_exist_chk(g_apce_d[l_ac].apce002,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apca.apca005,g_apcadocno) #151130-00015#4
                           RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce_d[l_ac].apce003 = g_apce_d_t.apce003
                           DISPLAY BY NAME g_apce_d[l_ac].apce003
                           NEXT FIELD CURRENT
                        END IF                                
                        #帶回開窗帳款單資訊
                        CALL s_aapt420_source_doc_carry(g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,l_apceorga_ld,
                                                                               g_apca.apcadocno,g_apce_d[l_ac].apceseq,g_apca.apcald,
                                                                               g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_sfin2002)                                                
                         RETURNING g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce101,
                                   g_apce_d[l_ac].apce119,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,
                                   g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce139,g_apce_d[l_ac].apce031,g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,
                                   g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,
                                   g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051,
                                   g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056,
                                   g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060,g_apce_d[l_ac].apce010,
                                   g_apce_d[l_ac].apce048   #151029
                        LET g_apce_d[l_ac].apce038_desc = s_desc_get_trading_partner_abbr_desc(g_apce_d[l_ac].apce038)
                        #應付單剩餘可沖金額 < 直接沖銷單據帶回金額時,直接給予應付單剩餘金額
                        CALL aapt300_02_get_contra_amount(g_apca.apcald,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1') RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x 
                        IF g_apce_d[l_ac].apce119 > l_amt.apcc11x THEN
                           LET g_apce_d[l_ac].apce119 = l_amt.apcc11x
                           #原幣金額
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce119 / g_apce_d[l_ac].apce101
                           IF cl_null(g_apce_d[l_ac].apce109) THEN LET g_apce_d[l_ac].apce109 = 0 END IF
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,2) RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce109               
                           IF g_glaa.glaa015 = 'Y' THEN
                              #本位幣二金額
                              LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                              IF cl_null(g_apce3_d[l_ac].apce129) THEN LET g_apce3_d[l_ac].apce129 = 0 END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce129,2) RETURNING g_sub_success,g_errno,g_apce3_d[l_ac].apce129                                
                           END IF
                           IF g_glaa.glaa019 = 'Y' THEN
                              #本位幣三金額
                              LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                              IF cl_null(g_apce3_d[l_ac].apce139) THEN LET g_apce3_d[l_ac].apce139 = 0 END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce139,2) RETURNING g_sub_success,g_errno,g_apce3_d[l_ac].apce139                                
                           END IF                           
                        END IF                        
                        
                        #160628-00002#2--add--str--
                        #判断是否为应税折抵，如果时，抓取可冲抵未税金额、税额、含税金额
                        IF g_apce_d[l_ac].apce027 = 'Y' THEN
                           CALL s_aapt300_not_washed_amt(g_apce_d[l_ac].apceld,g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005)
                           RETURNING r_apce_w.*
                           IF g_apce_d[l_ac].apce119 <= l_amt.apcc11x THEN
                              LET g_apce_d[l_ac].apce103=r_apce_w.apce103
                              LET g_apce_d[l_ac].apce104=r_apce_w.apce104
                              LET g_apce_d[l_ac].apce113=r_apce_w.apce113
                              LET g_apce_d[l_ac].apce114=r_apce_w.apce114
                              IF g_glaa.glaa015='Y' THEN
                                 LET g_apce3_d[l_ac].apce123=r_apce_w.apce123
                                 LET g_apce3_d[l_ac].apce124=r_apce_w.apce124
                                 LET g_apce3_d[l_ac].apce129=r_apce_w.apce129
                              END IF
                              IF g_glaa.glaa019='Y' THEN
                                 LET g_apce3_d[l_ac].apce133=r_apce_w.apce133
                                 LET g_apce3_d[l_ac].apce134=r_apce_w.apce134
                                 LET g_apce3_d[l_ac].apce139=r_apce_w.apce139
                              END IF
                           ELSE
                              SELECT apca011 INTO l_apca011 FROM apca_t 
                              WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
                              #根據單身稅別-含稅否 
                              CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                                  RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                              IF l_oodb005 = 'Y' THEN
                                 CALL s_tax_ins(g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,0,g_glaa.glaacomp,
                                                g_apce_d[l_ac].apce109,l_apca011,
                                                1,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apceld,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce131)
                                   RETURNING g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,
                                             g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,
                                             g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,
                                             g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                                 IF g_apce_d[l_ac].apce100 = g_glaa.glaa001 THEN
                                    LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce103
                                    LET g_apce_d[l_ac].apce114=g_apce_d[l_ac].apce104
                                    LET g_apce_d[l_ac].apce119=g_apce_d[l_ac].apce109
                                 END IF
                              ELSE
                                 #原币未税金额
                                 LET g_apce_d[l_ac].apce103 = r_apce_w.apce103 * g_apce_d[l_ac].apce109/r_apce_w.apce109
                                 CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce103,2) 
                                    RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce103          
                                 #原币税额
                                 LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce103
                                 #本币未税金额
                                 LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce103 * g_apce_d[l_ac].apce101
                                 CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce113,2)
                                    RETURNING l_success,g_errno,g_apce_d[l_ac].apce113
                                 #本币税额
                                 LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce113
                                 #本位币二
                                 IF g_glaa.glaa015 = 'Y' THEN
                                    IF g_glaa.glaa017='1' THEN
                                       LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                                       LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce121
                                    ELSE
                                       LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                                       LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce121
                                    END IF
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129 
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce123,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce123     
                                    LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                                 END IF
                                 #本位币三
                                 IF g_glaa.glaa019 = 'Y' THEN
                                    IF g_glaa.glaa021 = '1' THEN
                                       LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                                       LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce131
                                    ELSE
                                       LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                                       LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce131
                                    END IF
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce133,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce133
                                    LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                                 END IF
                              END IF 
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce103=g_apce_d[l_ac].apce109
                           LET g_apce_d[l_ac].apce104=0
                           LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce119
                           LET g_apce_d[l_ac].apce114=0
                           IF g_glaa.glaa015='Y' THEN
                              LET g_apce3_d[l_ac].apce123=g_apce3_d[l_ac].apce129
                              LET g_apce3_d[l_ac].apce124=0
                           END IF
                           IF g_glaa.glaa019='Y' THEN
                              LET g_apce3_d[l_ac].apce133=g_apce3_d[l_ac].apce139
                              LET g_apce3_d[l_ac].apce134=0
                           END IF
                        END IF
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                        #160628-00002#2--add--end
                        
                        #檢核金額不可超出可沖金額
                        CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                                     g_apce_d[l_ac].apce109,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','0')
                           RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce_d[l_ac].apce003 = g_apce_d_t.apce003
                           DISPLAY BY NAME g_apce_d[l_ac].apce003
                           NEXT FIELD CURRENT
                        END IF         
                        #帶預設會計科目
                        LET g_apce_d[l_ac].apce016 = s_aapt420_bring_acc_code(l_apceorga_ld,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_sfin2002)  #150209-00008#9                       
                        LET g_apce_d[l_ac].apce016_desc = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)                                                      #150209-00008#9 
                        LET g_apce2_d[l_ac].apce0162 = s_aapt420_bring_acc_code(l_apceorga_ld,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_sfin2002)                        
                        LET g_apce2_d[l_ac].apce0162_desc = s_desc_show1(g_apce2_d[l_ac].apce0162,s_desc_get_account_desc(g_apca.apcald,g_apce2_d[l_ac].apce0162))
                        DISPLAY BY NAME g_apce2_d[l_ac].apce0162 ,g_apce2_d[l_ac].apce0162_desc,
                                        g_apce_d[l_ac].apce016   ,g_apce_d[l_ac].apce016_desc                                                                                 #150209-00008#9 
                        #應稅折抵否
                        LET g_apce_d[l_ac].apce027 = aapt300_02_get_apce027(g_apce_d[l_ac].apce003)
                        DISPLAY BY NAME g_apce_d[l_ac].apce027
                       
                     END IF
                  END IF
               END IF
            END IF                     
            DISPLAY BY NAME g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce101,
                            g_apce_d[l_ac].apce119,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce139,
                            g_apce_d[l_ac].apce031,g_apce_d[l_ac].apce038_desc,g_apce_d[l_ac].apce010,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce130,
                            g_apce_d[l_ac].apce048   #151029
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce003
            #add-point:ON CHANGE apce003 name="input.g.page1.apce003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce004
            #add-point:BEFORE FIELD apce004 name="input.b.page1.apce004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce004
            
            #add-point:AFTER FIELD apce004 name="input.a.page1.apce004"
            IF NOT cl_null(g_apce_d[l_ac].apce004) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce004 != g_apce_d_t.apce004 OR g_apce_d_t.apce004 IS NULL )) THEN
                  IF NOT cl_null(g_apce_d[l_ac].apce004)
                     AND NOT cl_null(g_apce_d[l_ac].apce005) THEN            
                     IF NOT cl_null(g_apce_d[l_ac].apce003) AND NOT cl_null(g_apce_d[l_ac].apce004) AND 
                        NOT cl_null(g_apce_d[l_ac].apce005) THEN
                        CALL s_aapt420_exist_chk(g_apce_d[l_ac].apce002,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apca.apca005,g_apcadocno) #151130-00015#4
                           RETURNING g_sub_success,g_errno                        
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce_d[l_ac].apce004 = g_apce_d_t.apce004
                           DISPLAY BY NAME g_apce_d[l_ac].apce004
                           NEXT FIELD CURRENT
                        END IF                
                     
                        #帶回開窗帳款單資訊
                        CALL s_aapt420_source_doc_carry(g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,l_apceorga_ld,
                                                                               g_apca.apcadocno,g_apce_d[l_ac].apceseq,g_apca.apcald,
                                                                               g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_sfin2002)                                                                        
                         RETURNING g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce101,
                                   g_apce_d[l_ac].apce119,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,
                                   g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce139,g_apce_d[l_ac].apce031,g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,
                                   g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,
                                   g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051,
                                   g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056,
                                   g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060,g_apce_d[l_ac].apce010,
                                   g_apce_d[l_ac].apce048   #151029
                        
                        LET g_apce_d[l_ac].apce038_desc = s_desc_get_trading_partner_abbr_desc(g_apce_d[l_ac].apce038)
                        #應付單剩餘可沖金額 < 直接沖銷單據帶回金額時,直接給予應付單剩餘金額
                        CALL aapt300_02_get_contra_amount(g_apca.apcald,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1') RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x 
                        IF g_apce_d[l_ac].apce119 > l_amt.apcc11x THEN
                           LET g_apce_d[l_ac].apce119 = l_amt.apcc11x 
                           #原幣金額
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce119 / g_apce_d[l_ac].apce101
                           IF cl_null(g_apce_d[l_ac].apce109) THEN LET g_apce_d[l_ac].apce109 = 0 END IF
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,2) RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce109                            
                           IF g_glaa.glaa015 = 'Y' THEN
                              #本位幣二金額
                              LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                              IF cl_null(g_apce3_d[l_ac].apce129) THEN LET g_apce3_d[l_ac].apce129 = 0 END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce129,2) RETURNING g_sub_success,g_errno,g_apce3_d[l_ac].apce129                                
                           END IF
                           IF g_glaa.glaa019 = 'Y' THEN
                              #本位幣三金額
                              LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                              IF cl_null(g_apce3_d[l_ac].apce139) THEN LET g_apce3_d[l_ac].apce139 = 0 END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce139,2) RETURNING g_sub_success,g_errno,g_apce3_d[l_ac].apce139                                
                           END IF                            
                        END IF                     

                        #160628-00002#2--add--str--
                        #判断是否为应税折抵，如果时，抓取可冲抵未税金额、税额、含税金额
                        IF g_apce_d[l_ac].apce027 = 'Y' THEN
                           CALL s_aapt300_not_washed_amt(g_apce_d[l_ac].apceld,g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005)
                           RETURNING r_apce_w.*
                           IF g_apce_d[l_ac].apce119 <= l_amt.apcc11x THEN
                              LET g_apce_d[l_ac].apce103=r_apce_w.apce103
                              LET g_apce_d[l_ac].apce104=r_apce_w.apce104
                              LET g_apce_d[l_ac].apce113=r_apce_w.apce113
                              LET g_apce_d[l_ac].apce114=r_apce_w.apce114
                              IF g_glaa.glaa015='Y' THEN
                                 LET g_apce3_d[l_ac].apce123=r_apce_w.apce123
                                 LET g_apce3_d[l_ac].apce124=r_apce_w.apce124
                                 LET g_apce3_d[l_ac].apce129=r_apce_w.apce129
                              END IF
                              IF g_glaa.glaa019='Y' THEN
                                 LET g_apce3_d[l_ac].apce133=r_apce_w.apce133
                                 LET g_apce3_d[l_ac].apce134=r_apce_w.apce134
                                 LET g_apce3_d[l_ac].apce139=r_apce_w.apce139
                              END IF
                           ELSE
                              SELECT apca011 INTO l_apca011 FROM apca_t 
                              WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
                              #根據單身稅別-含稅否 
                              CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                                  RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                              IF l_oodb005 = 'Y' THEN
                                 CALL s_tax_ins(g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,0,g_glaa.glaacomp,
                                                g_apce_d[l_ac].apce109,l_apca011,
                                                1,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apceld,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce131)
                                   RETURNING g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,
                                             g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,
                                             g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,
                                             g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                                 IF g_apce_d[l_ac].apce100 = g_glaa.glaa001 THEN
                                    LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce103
                                    LET g_apce_d[l_ac].apce114=g_apce_d[l_ac].apce104
                                    LET g_apce_d[l_ac].apce119=g_apce_d[l_ac].apce109
                                 END IF
                              ELSE
                                 #原币未税金额
                                 LET g_apce_d[l_ac].apce103 = r_apce_w.apce103 * g_apce_d[l_ac].apce109/r_apce_w.apce109
                                 CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce103,2) 
                                    RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce103          
                                 #原币税额
                                 LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce103
                                 #本币未税金额
                                 LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce103 * g_apce_d[l_ac].apce101
                                 CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce113,2)
                                    RETURNING l_success,g_errno,g_apce_d[l_ac].apce113
                                 #本币税额
                                 LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce113
                                 #本位币二
                                 IF g_glaa.glaa015 = 'Y' THEN
                                    IF g_glaa.glaa017='1' THEN
                                       LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                                       LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce121
                                    ELSE
                                       LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                                       LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce121
                                    END IF
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129 
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce123,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce123     
                                    LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                                 END IF
                                 #本位币三
                                 IF g_glaa.glaa019 = 'Y' THEN
                                    IF g_glaa.glaa021 = '1' THEN
                                       LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                                       LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce131
                                    ELSE
                                       LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                                       LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce131
                                    END IF
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce133,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce133
                                    LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                                 END IF
                              END IF 
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce103=g_apce_d[l_ac].apce109
                           LET g_apce_d[l_ac].apce104=0
                           LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce119
                           LET g_apce_d[l_ac].apce114=0
                           IF g_glaa.glaa015='Y' THEN
                              LET g_apce3_d[l_ac].apce123=g_apce3_d[l_ac].apce129
                              LET g_apce3_d[l_ac].apce124=0
                           END IF
                           IF g_glaa.glaa019='Y' THEN
                              LET g_apce3_d[l_ac].apce133=g_apce3_d[l_ac].apce139
                              LET g_apce3_d[l_ac].apce134=0
                           END IF
                        END IF
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                        #160628-00002#2--add--end
                        
                        #檢核金額不可超出可沖金額                        
                        CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                                     g_apce_d[l_ac].apce109,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','0')
                           RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce_d[l_ac].apce004 = g_apce_d_t.apce004
                           DISPLAY BY NAME g_apce_d[l_ac].apce004
                           NEXT FIELD CURRENT
                        END IF 
                        #帶預設會計科目
                        LET g_apce_d[l_ac].apce016 = s_aapt420_bring_acc_code(l_apceorga_ld,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_sfin2002)  #150209-00008#9                       
                        LET g_apce_d[l_ac].apce016_desc = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)                                                       #150209-00008#9                
                        LET g_apce2_d[l_ac].apce0162 = s_aapt420_bring_acc_code(l_apceorga_ld,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_sfin2002)                        
                        LET g_apce2_d[l_ac].apce0162_desc = s_desc_show1(g_apce2_d[l_ac].apce0162,s_desc_get_account_desc(g_apca.apcald,g_apce2_d[l_ac].apce0162))
                        DISPLAY BY NAME g_apce2_d[l_ac].apce0162 ,g_apce2_d[l_ac].apce0162_desc,
                                        g_apce_d[l_ac].apce016  ,g_apce_d[l_ac].apce016_desc      
                        #151001--s
                        #應稅折抵否
                        LET g_apce_d[l_ac].apce027 = aapt300_02_get_apce027(g_apce_d[l_ac].apce003)
                        DISPLAY BY NAME g_apce_d[l_ac].apce027                        
                        #151001--e                                        
                     END IF                     
                  END IF
               END IF
            END IF                     
            DISPLAY BY NAME g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce101,
                            g_apce_d[l_ac].apce119,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce139,
                            g_apce_d[l_ac].apce031,g_apce_d[l_ac].apce038_desc,g_apce_d[l_ac].apce010,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce130,
                            g_apce_d[l_ac].apce048   #151029
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce004
            #add-point:ON CHANGE apce004 name="input.g.page1.apce004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce005
            #add-point:BEFORE FIELD apce005 name="input.b.page1.apce005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce005
            
            #add-point:AFTER FIELD apce005 name="input.a.page1.apce005"
            IF NOT cl_null(g_apce_d[l_ac].apce005) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce005 != g_apce_d_t.apce005 OR g_apce_d_t.apce005 IS NULL )) THEN
                  IF NOT cl_null(g_apce_d[l_ac].apce004)
                     AND NOT cl_null(g_apce_d[l_ac].apce005) THEN   
                     IF NOT cl_null(g_apce_d[l_ac].apce003) AND NOT cl_null(g_apce_d[l_ac].apce004) AND 
                        NOT cl_null(g_apce_d[l_ac].apce005) THEN
                        CALL s_aapt420_exist_chk(g_apce_d[l_ac].apce002,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apca.apca005,g_apcadocno) #151130-00015#4
                           RETURNING g_sub_success,g_errno                           
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce_d[l_ac].apce005 = g_apce_d_t.apce005
                           DISPLAY BY NAME g_apce_d[l_ac].apce005
                           NEXT FIELD CURRENT
                        END IF
              
                        #帶回開窗帳款單資訊     
                        CALL s_aapt420_source_doc_carry(g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,l_apceorga_ld,
                                                                               g_apca.apcadocno,g_apce_d[l_ac].apceseq,g_apca.apcald,
                                                                               g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_sfin2002)                                                                                                
                         RETURNING g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce101,
                                   g_apce_d[l_ac].apce119,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,
                                   g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce139,g_apce_d[l_ac].apce031,g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,
                                   g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,
                                   g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051,
                                   g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056,
                                   g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060,g_apce_d[l_ac].apce010,
                                   g_apce_d[l_ac].apce048   #151029                         
                        LET g_apce_d[l_ac].apce038_desc = s_desc_get_trading_partner_abbr_desc(g_apce_d[l_ac].apce038)
                        #應付單剩餘可沖金額 < 直接沖銷單據帶回金額時,直接給予應付單剩餘金額
                        CALL aapt300_02_get_contra_amount(g_apca.apcald,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1') RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x 
                        IF g_apce_d[l_ac].apce119 > l_amt.apcc11x THEN
                           LET g_apce_d[l_ac].apce119 = l_amt.apcc11x 
                           #原幣金額
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce119 / g_apce_d[l_ac].apce101
                           IF cl_null(g_apce_d[l_ac].apce109) THEN LET g_apce_d[l_ac].apce109 = 0 END IF
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,2) RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce109                            
                           IF g_glaa.glaa015 = 'Y' THEN
                              #本位幣二金額
                              LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                              IF cl_null(g_apce3_d[l_ac].apce129) THEN LET g_apce3_d[l_ac].apce129 = 0 END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce129,2) RETURNING g_sub_success,g_errno,g_apce3_d[l_ac].apce129                                
                           END IF
                           IF g_glaa.glaa019 = 'Y' THEN
                              #本位幣三金額
                              LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                              IF cl_null(g_apce3_d[l_ac].apce139) THEN LET g_apce3_d[l_ac].apce139 = 0 END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce139,2) RETURNING g_sub_success,g_errno,g_apce3_d[l_ac].apce139                                
                           END IF                            
                        END IF                       

                        #160628-00002#2--add--str--
                        #判断是否为应税折抵，如果时，抓取可冲抵未税金额、税额、含税金额
                        IF g_apce_d[l_ac].apce027 = 'Y' THEN
                           CALL s_aapt300_not_washed_amt(g_apce_d[l_ac].apceld,g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005)
                           RETURNING r_apce_w.*
                           IF g_apce_d[l_ac].apce119 <= l_amt.apcc11x THEN
                              LET g_apce_d[l_ac].apce103=r_apce_w.apce103
                              LET g_apce_d[l_ac].apce104=r_apce_w.apce104
                              LET g_apce_d[l_ac].apce113=r_apce_w.apce113
                              LET g_apce_d[l_ac].apce114=r_apce_w.apce114
                              IF g_glaa.glaa015='Y' THEN
                                 LET g_apce3_d[l_ac].apce123=r_apce_w.apce123
                                 LET g_apce3_d[l_ac].apce124=r_apce_w.apce124
                                 LET g_apce3_d[l_ac].apce129=r_apce_w.apce129
                              END IF
                              IF g_glaa.glaa019='Y' THEN
                                 LET g_apce3_d[l_ac].apce133=r_apce_w.apce133
                                 LET g_apce3_d[l_ac].apce134=r_apce_w.apce134
                                 LET g_apce3_d[l_ac].apce139=r_apce_w.apce139
                              END IF
                           ELSE
                              SELECT apca011 INTO l_apca011 FROM apca_t 
                              WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
                              #根據單身稅別-含稅否 
                              CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                                  RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
                              IF l_oodb005 = 'Y' THEN
                                 CALL s_tax_ins(g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,0,g_glaa.glaacomp,
                                                g_apce_d[l_ac].apce109,l_apca011,
                                                1,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apceld,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce131)
                                   RETURNING g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,
                                             g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,
                                             g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,
                                             g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                                 IF g_apce_d[l_ac].apce100 = g_glaa.glaa001 THEN
                                    LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce103
                                    LET g_apce_d[l_ac].apce114=g_apce_d[l_ac].apce104
                                    LET g_apce_d[l_ac].apce119=g_apce_d[l_ac].apce109
                                 END IF
                              ELSE
                                 #原币未税金额
                                 LET g_apce_d[l_ac].apce103 = r_apce_w.apce103 * g_apce_d[l_ac].apce109/r_apce_w.apce109
                                 CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce103,2) 
                                    RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce103          
                                 #原币税额
                                 LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce103
                                 #本币未税金额
                                 LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce103 * g_apce_d[l_ac].apce101
                                 CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce113,2)
                                    RETURNING l_success,g_errno,g_apce_d[l_ac].apce113
                                 #本币税额
                                 LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce113
                                 #本位币二
                                 IF g_glaa.glaa015 = 'Y' THEN
                                    IF g_glaa.glaa017='1' THEN
                                       LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                                       LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce121
                                    ELSE
                                       LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                                       LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce121
                                    END IF
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129 
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce123,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce123     
                                    LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                                 END IF
                                 #本位币三
                                 IF g_glaa.glaa019 = 'Y' THEN
                                    IF g_glaa.glaa021 = '1' THEN
                                       LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                                       LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce131
                                    ELSE
                                       LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                                       LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce131
                                    END IF
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                                    CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce133,2)
                                        RETURNING l_success,g_errno,g_apce3_d[l_ac].apce133
                                    LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                                 END IF
                              END IF 
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce103=g_apce_d[l_ac].apce109
                           LET g_apce_d[l_ac].apce104=0
                           LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce119
                           LET g_apce_d[l_ac].apce114=0
                           IF g_glaa.glaa015='Y' THEN
                              LET g_apce3_d[l_ac].apce123=g_apce3_d[l_ac].apce129
                              LET g_apce3_d[l_ac].apce124=0
                           END IF
                           IF g_glaa.glaa019='Y' THEN
                              LET g_apce3_d[l_ac].apce133=g_apce3_d[l_ac].apce139
                              LET g_apce3_d[l_ac].apce134=0
                           END IF
                        END IF
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                        #160628-00002#2--add--end

                        #檢核金額不可超出可沖金額                        
                        CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                                     g_apce_d[l_ac].apce109,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','0')
                           RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce_d[l_ac].apce005 = g_apce_d_t.apce005
                           DISPLAY BY NAME g_apce_d[l_ac].apce005
                           NEXT FIELD CURRENT
                        END IF         
                        #151001--s                        
                        #帶預設會計科目
                        LET g_apce_d[l_ac].apce016 = s_aapt420_bring_acc_code(l_apceorga_ld,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_sfin2002)  #150209-00008#9                       
                        LET g_apce_d[l_ac].apce016_desc = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)                                                       #150209-00008#9                
                        LET g_apce2_d[l_ac].apce0162 = s_aapt420_bring_acc_code(l_apceorga_ld,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_sfin2002)                        
                        LET g_apce2_d[l_ac].apce0162_desc = s_desc_show1(g_apce2_d[l_ac].apce0162,s_desc_get_account_desc(g_apca.apcald,g_apce2_d[l_ac].apce0162))
                        DISPLAY BY NAME g_apce2_d[l_ac].apce0162 ,g_apce2_d[l_ac].apce0162_desc,
                                        g_apce_d[l_ac].apce016  ,g_apce_d[l_ac].apce016_desc      
                        #應稅折抵否
                        LET g_apce_d[l_ac].apce027 = aapt300_02_get_apce027(g_apce_d[l_ac].apce003)
                        DISPLAY BY NAME g_apce_d[l_ac].apce027                        
                        #151001--e                             
                      
                     END IF
                  END IF
               END IF
            END IF                     
            DISPLAY BY NAME g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce101,
                            g_apce_d[l_ac].apce119,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce139,
                            g_apce_d[l_ac].apce031,g_apce_d[l_ac].apce038_desc,g_apce_d[l_ac].apce010,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce130,
                            g_apce_d[l_ac].apce048   #151029
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce005
            #add-point:ON CHANGE apce005 name="input.g.page1.apce005"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce016
            
            #add-point:AFTER FIELD apce016 name="input.a.page1.apce016"
          
            #150209-00008#9   ---(s)---
            IF NOT cl_null(g_apce_d[l_ac].apce016) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce016 != g_apce_d_t.apce016 OR g_apce_d_t.apce016 IS NULL )) THEN
 #  150916-00015#1 BEGIN    快捷带出类似科目编号     ADD BY XZG201511207
              IF  s_aglt310_getlike_lc_subject(g_apca.apcald,g_apce_d[l_ac].apce016,"") THEN
                 INITIALIZE g_qryparam.* TO NULL
                 SELECT glaa004 INTO l_glaa004
                  FROM glaa_t
                 WHERE glaaent = g_enterprise
                   AND glaald = g_apca.apcald
                LET g_qryparam.state = 'i'
                LET g_qryparam.reqry = 'FALSE'
                LET g_qryparam.default1 = g_apce_d[l_ac].apce016
                
                LET g_qryparam.arg1 = l_glaa004
                LET g_qryparam.arg2 = g_apce_d[l_ac].apce016
                LET g_qryparam.arg3 = g_apca.apcald
                LET g_qryparam.arg4 = "1 "
                CALL q_glac002_6()
               
                 LET g_apce_d[l_ac].apce016 = g_qryparam.return1
                 LET g_apce_d[l_ac].apce016_desc  = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)
                 DISPLAY BY NAME g_apce_d[l_ac].apce016_desc
                
              END IF
              IF NOT s_aglt310_lc_subject(g_apca.apcald,g_apce_d[l_ac].apce016,'N') THEN
                   LET g_apce_d[l_ac].apce016      = g_apce_d_t.apce016
                     LET g_apce_d[l_ac].apce016_desc = g_apce_d_t.apce016_desc
                     DISPLAY BY NAME g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce016_desc
                     NEXT FIELD CURRENT 
              END IF
 #  150916-00015#1 END
                  CALL s_aap_glac002_chk(g_apce_d[l_ac].apce016,g_apca.apcald) RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     #160321-00016#20 --s add
                     LET g_errparam.replace[1] = 'agli020'
                     LET g_errparam.replace[2] = cl_get_progname('agli020',g_lang,"2")
                     LET g_errparam.exeprog = 'agli020'
                     #160321-00016#20 --e add
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce016      = g_apce_d_t.apce016
                     LET g_apce_d[l_ac].apce016_desc = g_apce_d_t.apce016_desc
                     DISPLAY BY NAME g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce016_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               #取得自由核算項資訊
               CALL s_fin_sel_glad(g_apca.apcald,g_apce_d[l_ac].apce016,'glad0171|glad0172|glad0181|glad0182|glad0191|glad0192|glad0201|glad0202|glad0211|glad0212|glad0221|glad0222|glad0231|glad0232|glad0241|glad0242|glad0251|glad0252|glad0261|glad0262') 
                    RETURNING g_errno,g_glad.*               
            ELSE
               INITIALIZE g_glad.* TO NULL
               LET g_apce_d[l_ac].apce016 = ''
            END IF
            LET g_apce_d[l_ac].apce016_desc = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)
            DISPLAY BY NAME g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce016_desc 
            #150209-00008#9   ---(e)---
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce016
            #add-point:BEFORE FIELD apce016 name="input.b.page1.apce016"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce016
            #add-point:ON CHANGE apce016 name="input.g.page1.apce016"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce016_desc
            #add-point:BEFORE FIELD apce016_desc name="input.b.page1.apce016_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce016_desc
            
            #add-point:AFTER FIELD apce016_desc name="input.a.page1.apce016_desc"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce016_desc
            #add-point:ON CHANGE apce016_desc name="input.g.page1.apce016_desc"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce101
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce_d[l_ac].apce101,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce101
            END IF 
 
 
 
            #add-point:AFTER FIELD apce101 name="input.a.page1.apce101"
            IF NOT cl_null(g_apce_d[l_ac].apce101) THEN 
            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce101
            #add-point:BEFORE FIELD apce101 name="input.b.page1.apce101"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce101
            #add-point:ON CHANGE apce101 name="input.g.page1.apce101"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce103
            #add-point:BEFORE FIELD apce103 name="input.b.page1.apce103"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce103
            
            #add-point:AFTER FIELD apce103 name="input.a.page1.apce103"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce_d[l_ac].apce103) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce_d[l_ac].apce103 <> g_apce_d_t.apce103) THEN
                  IF g_apce_d[l_ac].apce103 > r_apce_w.apce103 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce_d[l_ac].apce103,'>', r_apce_w.apce103
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce103 = g_apce_d_t.apce103
                     NEXT FIELD apce103
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #完全冲销
                     IF g_apce_d[l_ac].apce103 = r_apce_w.apce103 THEN
                        LET g_apce_d[l_ac].apce104 = r_apce_w.apce104
                        LET g_apce_d[l_ac].apce109 = r_apce_w.apce109
                        LET g_apce_d[l_ac].apce113 = r_apce_w.apce113
                        LET g_apce_d[l_ac].apce114 = r_apce_w.apce114
                        LET g_apce_d[l_ac].apce119 = r_apce_w.apce119
                        IF g_glaa.glaa015 = 'Y' THEN 
                           LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                           LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                           LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                        END IF
                        IF g_glaa.glaa019 = 'Y' THEN 
                           LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                           LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                           LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                        END IF
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce103
                           LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce104 * g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce114,2)
                               RETURNING l_success,g_errno,g_apce_d[l_ac].apce114
                           LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce114
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce124,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce124
                              LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                           END IF
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce134,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce134
                              LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                           END IF
                        ELSE
                           CALL s_tax_ins(g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,0,g_glaa.glaacomp,
                                    g_apce_d[l_ac].apce103,l_apca011,1,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,
                                    g_apca.apcald,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce131)
                           RETURNING g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,
                                     g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,
                                     g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,
                                     g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                           IF g_apce_d[l_ac].apce100 = g_glaa.glaa001 THEN
                              LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce103
                              LET g_apce_d[l_ac].apce114=g_apce_d[l_ac].apce104
                              LET g_apce_d[l_ac].apce119=g_apce_d[l_ac].apce109
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce103
            #add-point:ON CHANGE apce103 name="input.g.page1.apce103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce104
            #add-point:BEFORE FIELD apce104 name="input.b.page1.apce104"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce104
            
            #add-point:AFTER FIELD apce104 name="input.a.page1.apce104"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce_d[l_ac].apce104) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce_d[l_ac].apce104 <> g_apce_d_t.apce104) THEN
                  IF g_apce_d[l_ac].apce104 > r_apce_w.apce104 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce_d[l_ac].apce104,'>', r_apce_w.apce104
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce104 = g_apce_d_t.apce104
                     NEXT FIELD apce104
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce_d[l_ac].apce104 = r_apce_w.apce104 THEN
                        LET g_apce_d[l_ac].apce103 = r_apce_w.apce103
                        LET g_apce_d[l_ac].apce109 = r_apce_w.apce109
                        LET g_apce_d[l_ac].apce113 = r_apce_w.apce113
                        LET g_apce_d[l_ac].apce114 = r_apce_w.apce114
                        LET g_apce_d[l_ac].apce119 = r_apce_w.apce119
                        IF g_glaa.glaa015 = 'Y' THEN 
                           LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                           LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                           LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                        END IF
                        IF g_glaa.glaa019 = 'Y' THEN 
                           LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                           LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                           LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                        END IF
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce104
                           LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce104 * g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce114,2)
                               RETURNING l_success,g_errno,g_apce_d[l_ac].apce114
                           LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce114
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce124,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce124
                              LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                           END IF
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce134,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce134
                              LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce103 + g_apce_d[l_ac].apce104
                           LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce104 * g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce114,2)
                               RETURNING l_success,g_errno,g_apce_d[l_ac].apce114
                           LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce113 + g_apce_d[l_ac].apce114
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce124,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce124
                              LET g_apce3_d[l_ac].apce129 = g_apce3_d[l_ac].apce123 + g_apce3_d[l_ac].apce124
                           END IF
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce134,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce134
                              LET g_apce3_d[l_ac].apce139 = g_apce3_d[l_ac].apce133 + g_apce3_d[l_ac].apce134
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce104
            #add-point:ON CHANGE apce104 name="input.g.page1.apce104"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce109
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce_d[l_ac].apce109,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce109
            END IF 
 
 
 
            #add-point:AFTER FIELD apce109 name="input.a.page1.apce109"
            IF NOT cl_null(g_apce_d[l_ac].apce109) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce109 != g_apce_d_t.apce109 OR g_apce_d_t.apce109 IS NULL )) THEN
                  CALL s_curr_round_ld('1',g_apca.apcald,g_apca.apca100,g_apce_d[l_ac].apce109,2) RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce109   #160707-00030#1 add

                  #檢核金額不可超出可沖金額
                  CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                               g_apce_d[l_ac].apce109,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','0')
                     RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce109 = g_apce_d_t.apce109
                     DISPLAY BY NAME g_apce_d[l_ac].apce109
                     NEXT FIELD CURRENT
                  END IF
#160628-00002#2--mark--str--                  
#                  IF NOT cl_null(g_apce_d[l_ac].apce101)THEN
#                     #計算可用金額(原幣)
#                     #如果=剩下全額就直接讓apce119 = 剩下全額
#                     INITIALIZE l_apcc_used.* TO NULL
#                     CALL s_aapt420_apcc_used_num(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
#                     g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1')
#                         RETURNING g_sub_success,g_errno,l_apcc_used.apcc10x,l_apcc_used.apcc11x,l_apcc_used.apcc12x,l_apcc_used.apcc13x
#                         
#                     IF l_apcc_used.apcc10x = g_apce_d[l_ac].apce109 THEN
#                        LET g_apce_d[l_ac].apce119 = l_apcc_used.apcc11x
#
#                     ELSE                     
#                        #部分又不是全額的話
#                        LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce109 * g_apce_d[l_ac].apce101
#                        IF cl_null(g_apce_d[l_ac].apce119) THEN LET g_apce_d[l_ac].apce119 = 0 END IF
#                        CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce119,2) RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce119                        
#                     END IF
#                     #幣別取位
#                     
#                     DISPLAY BY NAME g_apce_d[l_ac].apce119
#                  END IF
#160628-00002#2--mark--end                  
                  #160628-00002#2--add--str--
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     IF g_apce_d[l_ac].apce109 = r_apce_w.apce109 THEN
                        #当含税金额全部冲抵时，未税金额和税额也要全部冲抵
                        LET g_apce_d[l_ac].apce103 = r_apce_w.apce103
                        LET g_apce_d[l_ac].apce104 = r_apce_w.apce104
                        LET g_apce_d[l_ac].apce113 = r_apce_w.apce113
                        LET g_apce_d[l_ac].apce114 = r_apce_w.apce114
                        LET g_apce_d[l_ac].apce119 = r_apce_w.apce119
                        LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                        LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                        LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                        LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                        LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                        LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                     ELSE
                        #当含税部分冲抵时，根据单价是否含税计算未税金额和税额
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",TRUE)
                        IF l_oodb005 = 'Y' THEN
                           CALL s_tax_ins(g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,0,g_glaa.glaacomp,
                                          g_apce_d[l_ac].apce109,l_apca011,
                                          1,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apceld,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce131)
                             RETURNING g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,
                                       g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,
                                       g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,
                                       g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                           IF g_apce_d[l_ac].apce100 = g_glaa.glaa001 THEN
                              LET g_apce_d[l_ac].apce113=g_apce_d[l_ac].apce103
                              LET g_apce_d[l_ac].apce114=g_apce_d[l_ac].apce104
                              LET g_apce_d[l_ac].apce119=g_apce_d[l_ac].apce109
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce103
                           #本币
                           LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce109 * g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce119,2)
                              RETURNING l_success,g_errno,g_apce_d[l_ac].apce119
                           LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce113
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129   
                              LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021 = '1' THEN
                                 LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                                  RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                              LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                           END IF
                        END IF
                     END IF
                  ELSE
                     #非应税折抵时，未税金额=含税金额，税额=0，且不可录入
                     LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce109
                     LET g_apce_d[l_ac].apce104 = 0
                     #本币
                     LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce109 * g_apce_d[l_ac].apce101
                     CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce119,2)
                         RETURNING l_success,g_errno,g_apce_d[l_ac].apce119
                     LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce119
                     LET g_apce_d[l_ac].apce114 = 0
                     #本位币二
                    IF g_glaa.glaa015 = 'Y' THEN
                       IF g_glaa.glaa017='1' THEN
                          LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                       ELSE
                          LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                       END IF
                       CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                           RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129
                        LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129
                        LET g_apce3_d[l_ac].apce124 = 0
                     END IF
                     #本位币三
                     IF g_glaa.glaa019 = 'Y' THEN
                        IF g_glaa.glaa021 = '1' THEN
                           LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                        ELSE
                           LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                        END IF
                        CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                            RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                        LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139
                        LET g_apce3_d[l_ac].apce134 = 0
                     END IF
                  END IF
                  #160628-00002#2--add--end
               END IF
            END IF
            LET g_apce_d_t.apce109 = g_apce_d[l_ac].apce109

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce109
            #add-point:BEFORE FIELD apce109 name="input.b.page1.apce109"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce109
            #add-point:ON CHANGE apce109 name="input.g.page1.apce109"
            LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce109 * g_apce_d[l_ac].apce101
            IF cl_null(g_apce_d[l_ac].apce119) THEN LET g_apce_d[l_ac].apce119 = 0 END IF
            CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa001,g_apce_d[l_ac].apce119,2) RETURNING g_sub_success,g_errno,g_apce_d[l_ac].apce119  
            DISPLAY BY NAME g_apce_d[l_ac].apce119
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce113
            #add-point:BEFORE FIELD apce113 name="input.b.page1.apce113"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce113
            
            #add-point:AFTER FIELD apce113 name="input.a.page1.apce113"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce_d[l_ac].apce113) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce_d[l_ac].apce113 <> g_apce_d_t.apce113) THEN
                  IF g_apce_d[l_ac].apce113 > r_apce_w.apce113 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce_d[l_ac].apce113,'>', r_apce_w.apce113
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce113 = g_apce_d_t.apce113
                     NEXT FIELD apce113
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce_d[l_ac].apce113 = r_apce_w.apce113 THEN
                        LET g_apce_d[l_ac].apce114 = r_apce_w.apce114
                        LET g_apce_d[l_ac].apce119 = r_apce_w.apce119
                        LET g_apce_d[l_ac].apce103 = r_apce_w.apce103
                        LET g_apce_d[l_ac].apce104 = r_apce_w.apce104
                        LET g_apce_d[l_ac].apce109 = r_apce_w.apce109
                        IF g_glaa.glaa015='Y' THEN
                           LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                           LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                           LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                        END IF
                        IF g_glaa.glaa019='Y' THEN
                           LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                           LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                           LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                        END IF
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce113
                           #原币
                           LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce114 / g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce104,2)
                                 RETURNING l_success,g_errno,g_apce_d[l_ac].apce104
                           LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce104
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce124,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce124
                              LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce134,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce134
                              LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce113 + g_apce_d[l_ac].apce114
                           #原币
                           LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce113 / g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce103,2)
                                 RETURNING l_success,g_errno,g_apce_d[l_ac].apce103
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce103 + g_apce_d[l_ac].apce104
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce123,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce123
                              LET g_apce3_d[l_ac].apce129 = g_apce3_d[l_ac].apce123 + g_apce3_d[l_ac].apce124
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce133,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce133
                              LET g_apce3_d[l_ac].apce139 = g_apce3_d[l_ac].apce133 + g_apce3_d[l_ac].apce134
                           END IF
                        END IF
                     END IF 
                  END IF   
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce113
            #add-point:ON CHANGE apce113 name="input.g.page1.apce113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce114
            #add-point:BEFORE FIELD apce114 name="input.b.page1.apce114"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce114
            
            #add-point:AFTER FIELD apce114 name="input.a.page1.apce114"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce_d[l_ac].apce114) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce_d[l_ac].apce114 <> g_apce_d_t.apce114) THEN
                  IF g_apce_d[l_ac].apce114 > r_apce_w.apce114 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce_d[l_ac].apce114,'>', r_apce_w.apce114
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce114 = g_apce_d_t.apce114
                     NEXT FIELD apce114
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce_d[l_ac].apce114 = r_apce_w.apce114 THEN
                        LET g_apce_d[l_ac].apce113 = r_apce_w.apce113
                        LET g_apce_d[l_ac].apce119 = r_apce_w.apce119
                        LET g_apce_d[l_ac].apce103 = r_apce_w.apce103
                        LET g_apce_d[l_ac].apce104 = r_apce_w.apce104
                        LET g_apce_d[l_ac].apce109 = r_apce_w.apce109
                        IF g_glaa.glaa015='Y' THEN
                           LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                           LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                           LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                        END IF
                        IF g_glaa.glaa019='Y' THEN
                           LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                           LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                           LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                        END IF
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce114
                           #原币
                           LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce114 / g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce104,2)
                                 RETURNING l_success,g_errno,g_apce_d[l_ac].apce104
                           LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce104
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce124 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce124,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce124
                              LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce104 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce134 = g_apce_d[l_ac].apce114 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce134,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce134
                              LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce119 = g_apce_d[l_ac].apce113 + g_apce_d[l_ac].apce114
                           #原币
                           LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce113 / g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce103,2)
                                 RETURNING l_success,g_errno,g_apce_d[l_ac].apce103
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce103 + g_apce_d[l_ac].apce104
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce123 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce123,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce123
                              LET g_apce3_d[l_ac].apce129 = g_apce3_d[l_ac].apce123 + g_apce3_d[l_ac].apce124
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce103 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce133 = g_apce_d[l_ac].apce113 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce133,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce133
                              LET g_apce3_d[l_ac].apce139 = g_apce3_d[l_ac].apce133 + g_apce3_d[l_ac].apce134
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce114
            #add-point:ON CHANGE apce114 name="input.g.page1.apce114"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce119
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce_d[l_ac].apce119,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce119
            END IF 
 
 
 
            #add-point:AFTER FIELD apce119 name="input.a.page1.apce119"
            IF NOT cl_null(g_apce_d[l_ac].apce119) THEN 
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce119 != g_apce_d_t.apce119 OR g_apce_d_t.apce119 IS NULL )) THEN
                  #檢核金額不可超出可沖金額
                  CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                               g_apce_d[l_ac].apce119,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','1')
                     RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce_d[l_ac].apce119 = g_apce_d_t.apce119
                     DISPLAY BY NAME g_apce_d[l_ac].apce119
                     NEXT FIELD CURRENT
                  END IF 
#160628-00002#2--mark--str--                  
#                  INITIALIZE l_apcc_used.* TO NULL
#                  CALL s_aapt420_apcc_used_num(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
#                  g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1')
#                      RETURNING g_sub_success,g_errno,l_apcc_used.apcc10x,l_apcc_used.apcc11x,l_apcc_used.apcc12x,l_apcc_used.apcc13x
#                                             
#                  IF l_apcc_used.apcc10x = g_apce_d[l_ac].apce109 THEN
#                     LET g_apce_d[l_ac].apce119 = l_apcc_used.apcc11x                     
#                  END IF
#                  IF l_apcc_used.apcc11x = g_apce_d[l_ac].apce119 THEN
#                     LET g_apce_d[l_ac].apce109 = l_apcc_used.apcc10x                     
#                  END IF       
#                  DISPLAY BY NAME g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce119    
#160628-00002#2--mark--end
                  #160628-00002#2--add--str--
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce_d[l_ac].apce119 = r_apce_w.apce119 THEN
                        LET g_apce_d[l_ac].apce113 = r_apce_w.apce113
                        LET g_apce_d[l_ac].apce114 = r_apce_w.apce114
                        LET g_apce_d[l_ac].apce103 = r_apce_w.apce103
                        LET g_apce_d[l_ac].apce104 = r_apce_w.apce104
                        LET g_apce_d[l_ac].apce109 = r_apce_w.apce109
                        IF g_glaa.glaa015='Y' THEN
                           LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                           LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                           LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                        END IF
                        IF g_glaa.glaa019='Y' THEN
                           LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                           LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                           LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                        END IF
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                     ELSE
                     #部分冲销
                        CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",TRUE)
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce114
                           #原币
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce119 / g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,2)
                                 RETURNING l_success,g_errno,g_apce_d[l_ac].apce109
                           LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce104
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129
                              LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                              LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                           END IF
                        ELSE
                           LET g_apce_d[l_ac].apce114 = g_apce_d[l_ac].apce119 - g_apce_d[l_ac].apce113
                           #原币
                           LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce119 / g_apce_d[l_ac].apce101
                           CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,2)
                                 RETURNING l_success,g_errno,g_apce_d[l_ac].apce109
                           LET g_apce_d[l_ac].apce104 = g_apce_d[l_ac].apce109 - g_apce_d[l_ac].apce103
                           #本位币二
                           IF g_glaa.glaa015 = 'Y' THEN
                              IF g_glaa.glaa017='1' THEN
                                 LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                              ELSE
                                 LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129
                              LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                           END IF
                           #本位币三
                           IF g_glaa.glaa019 = 'Y' THEN
                              IF g_glaa.glaa021='1' THEN
                                 LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                              ELSE
                                 LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                              END IF
                              CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                                 RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                              LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                           END IF
                        END IF
                     END IF
                  ELSE
                     #非应税折抵
                     LET g_apce_d[l_ac].apce113 = g_apce_d[l_ac].apce119
                     LET g_apce_d[l_ac].apce114 = 0
                     #本币
                     LET g_apce_d[l_ac].apce109 = g_apce_d[l_ac].apce119 / g_apce_d[l_ac].apce101
                     CALL s_curr_round_ld('1',g_apca.apcald,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce109,2)
                         RETURNING l_success,g_errno,g_apce_d[l_ac].apce109
                     LET g_apce_d[l_ac].apce103 = g_apce_d[l_ac].apce109
                     LET g_apce_d[l_ac].apce104 = 0
                     #本位币二
                    IF g_glaa.glaa015 = 'Y' THEN
                       IF g_glaa.glaa017='1' THEN
                          LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce121
                       ELSE
                          LET g_apce3_d[l_ac].apce129 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce121
                       END IF
                       CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa016,g_apce3_d[l_ac].apce129,2)
                           RETURNING l_success,g_errno,g_apce3_d[l_ac].apce129
                        LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129
                        LET g_apce3_d[l_ac].apce124 = 0
                     END IF
                     #本位币三
                     IF g_glaa.glaa019 = 'Y' THEN
                        IF g_glaa.glaa021 = '1' THEN
                           LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce109 * g_apce3_d[l_ac].apce131
                        ELSE
                           LET g_apce3_d[l_ac].apce139 = g_apce_d[l_ac].apce119 * g_apce3_d[l_ac].apce131
                        END IF
                        CALL s_curr_round_ld('1',g_apca.apcald,g_glaa.glaa020,g_apce3_d[l_ac].apce139,2)
                            RETURNING l_success,g_errno,g_apce3_d[l_ac].apce139
                        LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139
                        LET g_apce3_d[l_ac].apce134 = 0
                     END IF 
                  END IF
                  #160628-00002#2--add--end
               END IF
            END IF
            LET g_apce_d_t.apce119 = g_apce_d[l_ac].apce119            


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce119
            #add-point:BEFORE FIELD apce119 name="input.b.page1.apce119"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce119
            #add-point:ON CHANGE apce119 name="input.g.page1.apce119"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce011
            
            #add-point:AFTER FIELD apce011 name="input.a.page1.apce011"
            LET g_apce_d[l_ac].apce011_desc = ''
            DISPLAY BY NAME g_apce_d[l_ac].apce011_desc                     
            IF NOT cl_null(g_apce_d[l_ac].apce011) THEN
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce_d[l_ac].apce011 != g_apce_d_t.apce011 OR g_apce_d_t.apce011 IS NULL )) THEN
                  IF NOT s_azzi650_chk_exist('3113',g_apce_d[l_ac].apce011) THEN
                     LET g_apce_d[l_ac].apce011 = g_apce_d_t.apce011
                     CALL s_desc_get_acc_desc('3113',g_apce_d[l_ac].apce011) RETURNING g_apce_d[l_ac].apce011_desc
                     DISPLAY BY NAME g_apce_d[l_ac].apce011_desc                     
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            CALL s_desc_get_acc_desc('3113',g_apce_d[l_ac].apce011) RETURNING g_apce_d[l_ac].apce011_desc
            DISPLAY BY NAME g_apce_d[l_ac].apce011_desc            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce011
            #add-point:BEFORE FIELD apce011 name="input.b.page1.apce011"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce011
            #add-point:ON CHANGE apce011 name="input.g.page1.apce011"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce010
            #add-point:BEFORE FIELD apce010 name="input.b.page1.apce010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce010
            
            #add-point:AFTER FIELD apce010 name="input.a.page1.apce010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce010
            #add-point:ON CHANGE apce010 name="input.g.page1.apce010"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page1.apceld
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apceld
            #add-point:ON ACTION controlp INFIELD apceld name="input.c.page1.apceld"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apceseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apceseq
            #add-point:ON ACTION controlp INFIELD apceseq name="input.c.page1.apceseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce002
            #add-point:ON ACTION controlp INFIELD apce002 name="input.c.page1.apce002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apceorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apceorga
            #add-point:ON ACTION controlp INFIELD apceorga name="input.c.page1.apceorga"
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce_d[l_ac].apceorga
            LET g_qryparam.where =" ooef201 = 'Y' AND ooef001 IN ",g_wc_cs_orga   #161006-00005#4  add
            CALL q_ooef001()
            LET g_apce_d[l_ac].apceorga = g_qryparam.return1
            CALL s_fin_orga_get_comp_ld(g_apce_d[l_ac].apceorga) RETURNING g_sub_success,g_errno,l_apceorga_comp,l_apceorga_ld            
            CALL s_ld_sel_glaa(l_apceorga_ld,'glaa001') RETURNING  g_sub_success,l_glaa001                
            CALL s_desc_get_department_desc(g_apce_d[l_ac].apceorga) RETURNING g_apce_d[l_ac].apceorga_desc
            DISPLAY BY NAME g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apceorga_desc
            NEXT FIELD apceorga
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce003
            #add-point:ON ACTION controlp INFIELD apce003 name="input.c.page1.apce003"
            #依帳款類型開窗
            IF NOT cl_null(l_apceorga_comp) THEN
              #-150512-00036#1--mod--(s)
              #CALL s_aapt420_source_doc_query2(g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,l_apceorga_comp,g_apca.apca005,g_apca.apcadocdt) 
              # RETURNING g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048                         
               CALL s_aapt420_source_doc_query(g_apca.apcald,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,l_apceorga_comp,g_apca.apca005,g_apca.apcadocdt,g_apcadocno) #151130-00015#4
                RETURNING l_wc
              #-150512-00036#1--mod--(e)
               
            ELSE
              #-150512-00036#1--mod--(s)
              #CALL s_aapt420_source_doc_query2(g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apca.apcacomp,g_apca.apca005,g_apca.apcadocdt)
              # RETURNING g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048            
               CALL s_aapt420_source_doc_query(g_apca.apcald,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apce003,g_apca.apcacomp,g_apca.apca005,g_apca.apcadocdt,g_apcadocno) #151130-00015#4
                RETURNING l_wc              
              #-150512-00036#1--mod--(e)
            END IF
            #150512-00036#1--(S)
            #無選擇任何一筆
            IF g_qryparam.str_array.getLength() = 0 THEN
               NEXT FIELD apce003
            ELSE
               CALL cl_err_collect_init() 
               #寫入帳款單身
               CALL s_aapt420_ins_payable_detail(g_apca.apcasite,g_apca.apcadocno,g_apca.apcacomp,g_apca.apcald,g_apca.apca005,
                                                 g_apca.apcadocdt,g_sfin2002,l_wc,g_apce_d[l_ac].apce002[1,1]) RETURNING g_sub_success   
               IF NOT g_sub_success THEN
                  CALL cl_err_collect_show() 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL cl_err_collect_show()    
                  CALL s_transaction_end('Y','0')
               END IF  
               LET l_flag = 'Y'
               CALL aapt300_02_detail_show()
               EXIT DIALOG               
            END IF              
            #150512-00036#1--(E)            
            DISPLAY BY NAME g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048
            NEXT FIELD apce003
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce004
            #add-point:ON ACTION controlp INFIELD apce004 name="input.c.page1.apce004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce005
            #add-point:ON ACTION controlp INFIELD apce005 name="input.c.page1.apce005"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce016
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce016
            #add-point:ON ACTION controlp INFIELD apce016 name="input.c.page1.apce016"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce_d[l_ac].apce016
            LET g_qryparam.where = "glac001 = '",g_glaa.glaa004,"' AND  glac003 <>'1' ",  
                                   " AND glac002 IN (SELECT glad001 FROM glad_t,glac_t WHERE glad001= glac002 ",
                                   "AND gladld='",g_apca.apcald,"' AND gladent='",g_enterprise,"'",
                                   " AND gladstus = 'Y' )"
            CALL aglt310_04()
            LET g_apce_d[l_ac].apce016 = g_qryparam.return1
            LET g_apce_d[l_ac].apce016_desc  = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)
            DISPLAY BY NAME g_apce_d[l_ac].apce016_desc
            NEXT FIELD apce016
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce016_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce016_desc
            #add-point:ON ACTION controlp INFIELD apce016_desc name="input.c.page1.apce016_desc"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce101
            #add-point:ON ACTION controlp INFIELD apce101 name="input.c.page1.apce101"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce103
            #add-point:ON ACTION controlp INFIELD apce103 name="input.c.page1.apce103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce104
            #add-point:ON ACTION controlp INFIELD apce104 name="input.c.page1.apce104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce109
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce109
            #add-point:ON ACTION controlp INFIELD apce109 name="input.c.page1.apce109"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce113
            #add-point:ON ACTION controlp INFIELD apce113 name="input.c.page1.apce113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce114
            #add-point:ON ACTION controlp INFIELD apce114 name="input.c.page1.apce114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce119
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce119
            #add-point:ON ACTION controlp INFIELD apce119 name="input.c.page1.apce119"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce011
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce011
            #add-point:ON ACTION controlp INFIELD apce011 name="input.c.page1.apce011"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce_d[l_ac].apce011
            LET g_qryparam.arg1 = "3113"
            CALL q_oocq002()
            LET g_apce_d[l_ac].apce011 = g_qryparam.return1
            CALL s_desc_get_acc_desc('3113',g_apce_d[l_ac].apce011) RETURNING g_apce_d[l_ac].apce011_desc
            DISPLAY BY NAME g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce011_desc
            NEXT FIELD apce011
            #END add-point
 
 
         #Ctrlp:input.c.page1.apce010
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce010
            #add-point:ON ACTION controlp INFIELD apce010 name="input.c.page1.apce010"
            #摘要
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce_d[l_ac].apce010
            CALL q_oocq002_2()
            LET g_apce_d[l_ac].apce010 = g_qryparam.return1
            DISPLAY g_apce_d[l_ac].apce010 TO apce010
            NEXT FIELD apce010
            #END add-point
 
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               CLOSE aapt300_02_bcl
               LET INT_FLAG = 0
               LET g_apce_d[l_ac].* = g_apce_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               #add-point:單身取消時 name="input.body.cancel"
               
               #end add-point
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = g_apce_d[l_ac].apceld 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_apce_d[l_ac].* = g_apce_d_t.*
            ELSE
               #寫入修改者/修改日期資訊(單身)
               
            
               #add-point:單身修改前 name="input.body.b_update"
               
               #end add-point
               
               #將遮罩欄位還原
               CALL aapt300_02_apce_t_mask_restore('restore_mask_o')
 
               UPDATE apce_t SET (apcedocno,apceld,apceseq,apce002,apceorga,apce003,apce004,apce005, 
                   apce048,apce015,apce016,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119, 
                   apce027,apce011,apce010,apce024,apce038,apce031,apcecomp,apcesite,apce001,apce017, 
                   apce018,apce019,apce020,apce022,apce023,apce035,apce036,apce044,apce045,apce046,apce051, 
                   apce052,apce053,apce054,apce055,apce056,apce057,apce058,apce059,apce060,apce120,apce121, 
                   apce123,apce124,apce129,apce130,apce131,apce133,apce134,apce139) = (g_apce_d[l_ac].apcedocno, 
                   g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga, 
                   g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048, 
                   g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101, 
                   g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113, 
                   g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011, 
                   g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031, 
                   g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite,g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apce017, 
                   g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce022, 
                   g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044, 
                   g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051,g_apce2_d[l_ac].apce052, 
                   g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056, 
                   g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060, 
                   g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
                   g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
                   g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139)
                WHERE apceent = g_enterprise AND
                  apceld = g_apce_d_t.apceld #項次   
                  AND apcedocno = g_apce_d_t.apcedocno  
                  AND apceseq = g_apce_d_t.apceseq  
 
                  
               #add-point:單身修改中 name="input.body.m_update"
               
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "apce_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                  WHEN SQLCA.SQLCODE #其他錯誤
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce_d[g_detail_idx].apceld
               LET gs_keys_bak[1] = g_apce_d_t.apceld
               LET gs_keys[2] = g_apce_d[g_detail_idx].apcedocno
               LET gs_keys_bak[2] = g_apce_d_t.apcedocno
               LET gs_keys[3] = g_apce_d[g_detail_idx].apceseq
               LET gs_keys_bak[3] = g_apce_d_t.apceseq
               CALL aapt300_02_update_b('apce_t',gs_keys,gs_keys_bak,"'1'")
                     #資料多語言用-增/改
                     
                     #修改歷程記錄(修改)
                     LET g_log1 = util.JSON.stringify(g_apce_d_t)
                     LET g_log2 = util.JSON.stringify(g_apce_d[l_ac])
                     IF NOT cl_log_modified_record(g_log1,g_log2) THEN
                     END IF
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aapt300_02_apce_t_mask_restore('restore_mask_n')
               
               #add-point:單身修改後 name="input.body.a_update"
               #應付單可沖金額 < 直接沖帳金額
               CALL aapt300_02_get_contra_amount(g_apca.apcald,g_apca.apcadocno,'','') RETURNING l_amt.apcc10x,l_amt.apcc11x,l_amt.apcc12x,l_amt.apcc13x 
               IF l_amt.apcc11x < 0 OR (aapt300_02_contra_curr_chk(g_apca.apcald,g_apca.apcadocno,g_apce_d[l_ac].apce100) AND l_amt.apcc10x < 0 ) OR
                  (g_glaa.glaa015 = 'Y' AND l_amt.apcc12x < 0) OR (g_glaa.glaa019 = 'Y' AND l_amt.apcc13x < 0) THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = '' 
                  LET g_errparam.code   = 'aap-00064' 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  LET g_apce_d[l_ac].* = g_apce_d_t.*           
                  CALL s_transaction_end('N','0')  
               ELSE                                #150419
                  CALL s_transaction_end('Y','0')  #150419                    
               END IF   
               
               #150209-00008#9   ---(s)--- 重新填充第二單身
               IF (g_apce_d[l_ac].apce016 != g_apce_d_t.apce016 OR g_apce_d_t.apce016 IS NULL) THEN                  
                  CALL aapt300_02_b_fill(g_wc2)  
               END IF
               #150209-00008#9   ---(s)---
               #end add-point
 
            END IF
            
         AFTER ROW
            CALL aapt300_02_unlock_b("apce_t")
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_apce_d[l_ac].* = g_apce_d_t.*
               END IF
               #add-point:單身after row name="input.body.a_close"
               
               #end add-point
            ELSE
            END IF
            #其他table進行unlock
            
             #add-point:單身after row name="input.body.a_row"
             CALL aapt300_02_sum_page_show()
            #end add-point
            
         AFTER INPUT
            #add-point:單身input後 name="input.body.a_input"
            #重算帳款單頭
            CALL s_transaction_begin()
            CALL aapt300_02_clac_bill_master() RETURNING g_sub_success
            IF g_sub_success THEN 
               CALL s_transaction_end('Y','0')
            ELSE
               CALL s_transaction_end('N','0')
            END IF        
            #141202-00061-15--(S)
            IF g_glaa.glaa121 = 'Y' AND g_dfin0030 = 'Y'THEN
               CALL s_transaction_begin()
               CALL s_pre_voucher_ins('AP','P10',g_apca.apcald,g_apca.apcadocno,g_apca.apcadocdt,'1')
                    RETURNING g_sub_success
               IF g_sub_success THEN 
                  CALL s_transaction_end('Y','0')
               ELSE
                  CALL s_transaction_end('N','0')
               END IF
            END IF         
            #141202-00061-15--(E)
            #end add-point
            #錯誤訊息統整顯示
            #CALL cl_err_collect_show()
            #CALL cl_showmsg()
            
         ON ACTION controlo   
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_apce_d[li_reproduce_target].* = g_apce_d[li_reproduce].*
               LET g_apce2_d[li_reproduce_target].* = g_apce2_d[li_reproduce].*
               LET g_apce3_d[li_reproduce_target].* = g_apce3_d[li_reproduce].*
 
               LET g_apce_d[li_reproduce_target].apceld = NULL
               LET g_apce_d[li_reproduce_target].apcedocno = NULL
               LET g_apce_d[li_reproduce_target].apceseq = NULL
 
            ELSE
               CALL FGL_SET_ARR_CURR(g_apce_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_apce_d.getLength()+1
            END IF
            
      END INPUT
      
      INPUT ARRAY g_apce2_d FROM s_detail2.*
         ATTRIBUTE(COUNT = g_detail_cnt,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = FALSE, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = FALSE,
                 APPEND ROW = FALSE)
                 
         #自訂ACTION(detail_input,page_2)
         
         
         BEFORE INPUT
          CALL FGL_SET_ARR_CURR(g_detail_idx)
            
            CALL aapt300_02_b_fill(g_wc2)
            LET g_detail_cnt = g_apce2_d.getLength()
    
         BEFORE INSERT
            LET g_insert = 'Y' 
            NEXT FIELD apceld
 
            LET l_insert = TRUE
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_apce2_d[l_ac].* TO NULL 
            INITIALIZE g_apce2_d_t.* TO NULL
            INITIALIZE g_apce2_d_o.* TO NULL
            #公用欄位給值(單身2)
            
            #自定義預設值(單身2)
            
            #add-point:modify段before備份 name="input.body2.before_bak"
            
            #end add-point
            LET g_apce2_d_t.* = g_apce2_d[l_ac].*     #新輸入資料
            LET g_apce2_d_o.* = g_apce2_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_apce_d[li_reproduce_target].* = g_apce_d[li_reproduce].*
               LET g_apce2_d[li_reproduce_target].* = g_apce2_d[li_reproduce].*
               LET g_apce3_d[li_reproduce_target].* = g_apce3_d[li_reproduce].*
 
               LET g_apce2_d[li_reproduce_target].apceld = NULL
               LET g_apce2_d[li_reproduce_target].apcedocno = NULL
               LET g_apce2_d[li_reproduce_target].apceseq = NULL
            END IF
            
 
 
 
            CALL aapt300_02_set_entry_b(l_cmd)
            CALL aapt300_02_set_no_entry_b(l_cmd)
            #add-point:modify段before insert name="input.body2.before_insert"
            
            #end add-point  
            
         BEFORE ROW 
            #add-point:modify段before row name="input.body2.before_row2"
            CALL s_transaction_begin()  #150419
            #end add-point  
            LET l_insert = FALSE
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail2")
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = g_detail_idx
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            DISPLAY g_apce2_d.getLength() TO FORMONLY.cnt
         
            CALL s_transaction_begin()
            
            LET g_detail_cnt = g_apce2_d.getLength()
            
            IF g_detail_cnt >= l_ac 
               AND g_apce2_d[l_ac].apceld IS NOT NULL
               AND g_apce2_d[l_ac].apcedocno IS NOT NULL
               AND g_apce2_d[l_ac].apceseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_apce2_d_t.* = g_apce2_d[l_ac].*  #BACKUP
               LET g_apce2_d_o.* = g_apce2_d[l_ac].*  #BACKUP
               IF NOT aapt300_02_lock_b("apce_t") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aapt300_02_bcl INTO g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq, 
                      g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004, 
                      g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016, 
                      g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104, 
                      g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119, 
                      g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024, 
                      g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031,g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite, 
                      g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apcedocno,g_apce2_d[l_ac].apceld,g_apce2_d[l_ac].apceseq, 
                      g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020, 
                      g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036, 
                      g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051, 
                      g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055, 
                      g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059, 
                      g_apce2_d[l_ac].apce060,g_apce3_d[l_ac].apcedocno,g_apce3_d[l_ac].apceld,g_apce3_d[l_ac].apceseq, 
                      g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
                      g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
                      g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "FETCH aapt300_02_bcl:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_apce2_d_mask_o[l_ac].* =  g_apce2_d[l_ac].*
                  CALL aapt300_02_apce_t_mask()
                  LET g_apce2_d_mask_n[l_ac].* =  g_apce2_d[l_ac].*
                  
                  CALL cl_show_fld_cont()
                  CALL aapt300_02_detail_show()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            CALL aapt300_02_set_entry_b(l_cmd)
            CALL aapt300_02_set_no_entry_b(l_cmd)
            #add-point:modify段before row name="input.body2.before_row"
            #取得自由核算項資訊 
            IF NOT cl_null(g_apce_d[l_ac].apce016) THEN                                              #150209-00008#9
               CALL s_fin_sel_glad(g_apca.apcald,g_apce_d[l_ac].apce016,'glad0171|glad0172|glad0181|glad0182|glad0191|glad0192|glad0201|glad0202|glad0211|glad0212|glad0221|glad0222|glad0231|glad0232|glad0241|glad0242|glad0251|glad0252|glad0261|glad0262') 
                    RETURNING g_errno,g_glad.*                 
            ELSE
               INITIALIZE g_glad.* TO NULL
            END IF  
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
 
 
            #其他table進行lock
            
 
 
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
            ELSE
               #add-point:單身2ask刪除前 name="input.body2.b_delete_ask"
               
               #end add-point 
            
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身2刪除前 name="input.body2.b_delete"
               
               #end add-point 
               
               DELETE FROM apce_t
                WHERE apceent = g_enterprise AND
                  apceld = g_apce2_d_t.apceld
                  AND apcedocno = g_apce2_d_t.apcedocno
                  AND apceseq = g_apce2_d_t.apceseq
                  
               #add-point:單身2刪除中 name="input.body2.m_delete"
               
               #end add-point 
                  
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE   
               ELSE
                  LET g_detail_cnt = g_detail_cnt-1
                  
 
 
 
                  #add-point:單身2刪除後 name="input.body2.a_delete"
                  
                  #end add-point
                  #修改歷程記錄(刪除)
                  CALL aapt300_02_set_pk_array()
                  LET g_log1 = util.JSON.stringify(g_apce2_d[l_ac])   #(ver:38)
                  IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:38)
                  ELSE
                  END IF
               END IF 
               CLOSE aapt300_02_bcl
               #add-point:單身2刪除關閉bcl name="input.body2.close"
               
               #end add-point
               LET l_count = g_apce_d.getLength()
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce2_d_t.apceld
               LET gs_keys[2] = g_apce2_d_t.apcedocno
               LET gs_keys[3] = g_apce2_d_t.apceseq
 
               #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL aapt300_02_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
 
            END IF 
            
         AFTER DELETE 
            IF l_cmd <> 'd' THEN
               #add-point:單身刪除後2 name="input.body2.after_delete"
               
               #end add-point
                              CALL aapt300_02_delete_b('apce_t',gs_keys,"'2'")
            END IF
            #如果是最後一筆
            IF l_ac = (g_apce2_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
            #add-point:單身刪除後3 name="input.body2.after_delete3"
            
            #end add-point
 
         AFTER INSERT    
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM apce_t 
             WHERE apceent = g_enterprise AND
                   apceld = g_apce2_d[l_ac].apceld
                   AND apcedocno = g_apce2_d[l_ac].apcedocno
                   AND apceseq = g_apce2_d[l_ac].apceseq
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身2新增前 name="input.body2.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce2_d[g_detail_idx].apceld
               LET gs_keys[2] = g_apce2_d[g_detail_idx].apcedocno
               LET gs_keys[3] = g_apce2_d[g_detail_idx].apceseq
               CALL aapt300_02_insert_b('apce_t',gs_keys,"'2'")
                           
               #add-point:單身新增後2 name="input.body2.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_apce_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aapt300_02_b_fill(g_wc2)
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body2.after_insert"
               
               #end add-point
               ##ERROR 'INSERT O.K'
               LET g_detail_cnt = g_detail_cnt + 1
               LET g_wc2 = g_wc2, " OR (apceld = '", g_apce2_d[l_ac].apceld, "' "
                                  ," AND apcedocno = '", g_apce2_d[l_ac].apcedocno, "' "
                                  ," AND apceseq = '", g_apce2_d[l_ac].apceseq, "' "
                                  ,")"
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               LET g_apce2_d[l_ac].* = g_apce2_d_t.*
               CLOSE aapt300_02_bcl
               #add-point:單身page2取消後 name="input.body2.cancel"
               
               #end add-point
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_apce2_d[l_ac].* = g_apce2_d_t.*
            ELSE
               
               #寫入修改者/修改日期資訊(單身2)
               
               
               #add-point:單身page2修改前 name="input.body2.b_update"
               
               #end add-point
               
               #將遮罩欄位還原
               CALL aapt300_02_apce_t_mask_restore('restore_mask_o')
               
               UPDATE apce_t SET (apcedocno,apceld,apceseq,apce002,apceorga,apce003,apce004,apce005, 
                   apce048,apce015,apce016,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119, 
                   apce027,apce011,apce010,apce024,apce038,apce031,apcecomp,apcesite,apce001,apce017, 
                   apce018,apce019,apce020,apce022,apce023,apce035,apce036,apce044,apce045,apce046,apce051, 
                   apce052,apce053,apce054,apce055,apce056,apce057,apce058,apce059,apce060,apce120,apce121, 
                   apce123,apce124,apce129,apce130,apce131,apce133,apce134,apce139) = (g_apce_d[l_ac].apcedocno, 
                   g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga, 
                   g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048, 
                   g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101, 
                   g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113, 
                   g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011, 
                   g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031, 
                   g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite,g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apce017, 
                   g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce022, 
                   g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044, 
                   g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051,g_apce2_d[l_ac].apce052, 
                   g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056, 
                   g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060, 
                   g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
                   g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
                   g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139) #自訂欄位頁簽
                WHERE apceent = g_enterprise AND
                  apceld = g_apce2_d_t.apceld #項次 
                  AND apcedocno = g_apce2_d_t.apcedocno
                  AND apceseq = g_apce2_d_t.apceseq
                  
               #add-point:單身page2修改中 name="input.body2.m_update"
               
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "apce_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                  WHEN SQLCA.SQLCODE #其他錯誤
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce2_d[g_detail_idx].apceld
               LET gs_keys_bak[1] = g_apce2_d_t.apceld
               LET gs_keys[2] = g_apce2_d[g_detail_idx].apcedocno
               LET gs_keys_bak[2] = g_apce2_d_t.apcedocno
               LET gs_keys[3] = g_apce2_d[g_detail_idx].apceseq
               LET gs_keys_bak[3] = g_apce2_d_t.apceseq
               CALL aapt300_02_update_b('apce_t',gs_keys,gs_keys_bak,"'2'")
                     #資料多語言用-增/改
                     
                     
                     #修改歷程記錄(修改)
                     LET g_log1 = util.JSON.stringify(g_apce2_d_t)
                     LET g_log2 = util.JSON.stringify(g_apce2_d[l_ac])
                     IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                     END IF
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aapt300_02_apce_t_mask_restore('restore_mask_n')
               
               #add-point:單身page2修改後 name="input.body2.a_update"
               
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce0162
            #add-point:BEFORE FIELD apce0162 name="input.b.page2.apce0162"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce0162
            
            #add-point:AFTER FIELD apce0162 name="input.a.page2.apce0162"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce0162
            #add-point:ON CHANGE apce0162 name="input.g.page2.apce0162"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce0162_desc
            #add-point:BEFORE FIELD apce0162_desc name="input.b.page2.apce0162_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce0162_desc
            
            #add-point:AFTER FIELD apce0162_desc name="input.a.page2.apce0162_desc"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce0162_desc
            #add-point:ON CHANGE apce0162_desc name="input.g.page2.apce0162_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce017
            #add-point:BEFORE FIELD apce017 name="input.b.page2.apce017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce017
            
            #add-point:AFTER FIELD apce017 name="input.a.page2.apce017"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce017
            #add-point:ON CHANGE apce017 name="input.g.page2.apce017"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce017_desc
            #add-point:BEFORE FIELD apce017_desc name="input.b.page2.apce017_desc"
            LET g_apce2_d[l_ac].apce017_desc = g_apce2_d[l_ac].apce017   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce017_desc
            
            #add-point:AFTER FIELD apce017_desc name="input.a.page2.apce017_desc"
            #業務人員
            IF NOT cl_null(g_apce2_d[l_ac].apce017_desc) THEN
               IF ( g_apce2_d[l_ac].apce017_desc != g_apce2_d_t.apce017_desc OR g_apce2_d_t.apce017_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce017 = g_apce2_d[l_ac].apce017_desc   
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce017 != g_apce2_d_t.apce017 OR g_apce2_d_t.apce017 IS NULL) THEN
                        CALL s_employee_chk(g_apce2_d[l_ac].apce017) RETURNING g_sub_success
                        IF NOT g_sub_success THEN
                           LET g_apce2_d[l_ac].apce017      = g_apce2_d_t.apce017
                           LET g_apce2_d[l_ac].apce017_desc = g_apce2_d_t.apce017_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce017 ,g_apce2_d[l_ac].apce017_desc
                           NEXT FIELD CURRENT
                        END IF 
                     END IF                  
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce017 = ''
            END IF
            LET g_apce2_d[l_ac].apce017_desc = s_desc_show1(g_apce2_d[l_ac].apce017,s_desc_get_person_desc(g_apce2_d[l_ac].apce017))         
            DISPLAY BY NAME g_apce2_d[l_ac].apce017 ,g_apce2_d[l_ac].apce017_desc
            LET g_apce2_d_t.apce017_desc = g_apce2_d[l_ac].apce017_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce017_desc
            #add-point:ON CHANGE apce017_desc name="input.g.page2.apce017_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce018
            #add-point:BEFORE FIELD apce018 name="input.b.page2.apce018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce018
            
            #add-point:AFTER FIELD apce018 name="input.a.page2.apce018"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce018
            #add-point:ON CHANGE apce018 name="input.g.page2.apce018"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce018_desc
            #add-point:BEFORE FIELD apce018_desc name="input.b.page2.apce018_desc"
            LET g_apce2_d[l_ac].apce018_desc = g_apce2_d[l_ac].apce018   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce018_desc
            
            #add-point:AFTER FIELD apce018_desc name="input.a.page2.apce018_desc"
            #部門
            IF NOT cl_null(g_apce2_d[l_ac].apce018_desc) THEN
               IF ( g_apce2_d[l_ac].apce018_desc != g_apce2_d_t.apce018_desc OR g_apce2_d_t.apce018_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce018 = g_apce2_d[l_ac].apce018_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce018 != g_apce2_d_t.apce018 OR g_apce2_d_t.apce018 IS NULL) THEN
                        CALL s_department_chk(g_apce2_d[l_ac].apce018_desc,g_apca.apcadocdt) RETURNING g_sub_success
                        IF NOT g_sub_success THEN
                           LET g_apce2_d[l_ac].apce018      = g_apce2_d_t.apce018
                           LET g_apce2_d[l_ac].apce018_desc = g_apce2_d_t.apce018_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce018 ,g_apce2_d[l_ac].apce018_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF                  
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce018 = ''               
            END IF
            LET g_apce2_d[l_ac].apce018_desc = s_desc_show1(g_apce2_d[l_ac].apce018,s_desc_get_department_desc(g_apce2_d[l_ac].apce018))         
            DISPLAY BY NAME g_apce2_d[l_ac].apce018 ,g_apce2_d[l_ac].apce018_desc
            LET g_apce2_d_t.apce018_desc = g_apce2_d[l_ac].apce018_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce018_desc
            #add-point:ON CHANGE apce018_desc name="input.g.page2.apce018_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce019
            #add-point:BEFORE FIELD apce019 name="input.b.page2.apce019"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce019
            
            #add-point:AFTER FIELD apce019 name="input.a.page2.apce019"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce019
            #add-point:ON CHANGE apce019 name="input.g.page2.apce019"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce019_desc
            #add-point:BEFORE FIELD apce019_desc name="input.b.page2.apce019_desc"
            LET g_apce2_d[l_ac].apce019_desc = g_apce2_d[l_ac].apce019   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce019_desc
            
            #add-point:AFTER FIELD apce019_desc name="input.a.page2.apce019_desc"
            #責任中心
            IF NOT cl_null(g_apce2_d[l_ac].apce019_desc) THEN
               IF ( g_apce2_d[l_ac].apce019_desc != g_apce2_d_t.apce019_desc OR g_apce2_d_t.apce019_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce019 = g_apce2_d[l_ac].apce019_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce019 != g_apce2_d_t.apce019 OR g_apce2_d_t.apce019 IS NULL) THEN
                        #CALL s_department_chk(g_apce2_d[l_ac].apce019_desc,g_apca.apcadocdt) RETURNING g_sub_success
                        LET g_errno = ''   
                        CALL s_voucher_glaq019_chk(g_apce2_d[l_ac].apce019_desc,g_apca.apcadocdt) #20150302
                        IF NOT cl_null(g_errno) THEN 
                           LET g_apce2_d[l_ac].apce019      = g_apce2_d_t.apce019
                           LET g_apce2_d[l_ac].apce019_desc = g_apce2_d_t.apce019_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce019 ,g_apce2_d[l_ac].apce019_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF                         
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce019 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce019_desc = s_desc_show1(g_apce2_d[l_ac].apce019,s_desc_get_department_desc(g_apce2_d[l_ac].apce019))         
            DISPLAY BY NAME g_apce2_d[l_ac].apce019 ,g_apce2_d[l_ac].apce019_desc 
            LET g_apce2_d_t.apce019_desc = g_apce2_d[l_ac].apce019_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce019_desc
            #add-point:ON CHANGE apce019_desc name="input.g.page2.apce019_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce020
            #add-point:BEFORE FIELD apce020 name="input.b.page2.apce020"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce020
            
            #add-point:AFTER FIELD apce020 name="input.a.page2.apce020"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce020
            #add-point:ON CHANGE apce020 name="input.g.page2.apce020"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce020_desc
            #add-point:BEFORE FIELD apce020_desc name="input.b.page2.apce020_desc"
            LET g_apce2_d[l_ac].apce020_desc = g_apce2_d[l_ac].apce020   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce020_desc
            
            #add-point:AFTER FIELD apce020_desc name="input.a.page2.apce020_desc"
            #產品類別
            IF NOT cl_null(g_apce2_d[l_ac].apce020_desc) THEN
               IF ( g_apce2_d[l_ac].apce020_desc != g_apce2_d_t.apce020_desc OR g_apce2_d_t.apce020_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce020 = g_apce2_d[l_ac].apce020_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce020 != g_apce2_d_t.apce020 OR g_apce2_d_t.apce020 IS NULL) THEN
                        CALL s_voucher_glaq024_chk(g_apce2_d[l_ac].apce020)
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'arti202'
                           LET g_errparam.replace[2] = cl_get_progname('arti202',g_lang,"2")
                           LET g_errparam.exeprog = 'arti202'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce020      = g_apce2_d_t.apce020
                           LET g_apce2_d[l_ac].apce020_desc = g_apce2_d_t.apce020_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce020 ,g_apce2_d[l_ac].apce020_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF                  
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce020 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce020_desc = s_desc_show1(g_apce2_d[l_ac].apce020,s_desc_get_rtaxl003_desc(g_apce2_d[l_ac].apce020))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce020 ,g_apce2_d[l_ac].apce020_desc 
            LET g_apce2_d_t.apce020_desc = g_apce2_d[l_ac].apce020_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce020_desc
            #add-point:ON CHANGE apce020_desc name="input.g.page2.apce020_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce022
            #add-point:BEFORE FIELD apce022 name="input.b.page2.apce022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce022
            
            #add-point:AFTER FIELD apce022 name="input.a.page2.apce022"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce022
            #add-point:ON CHANGE apce022 name="input.g.page2.apce022"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce022_desc
            #add-point:BEFORE FIELD apce022_desc name="input.b.page2.apce022_desc"
            LET g_apce2_d[l_ac].apce022_desc = g_apce2_d[l_ac].apce022   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce022_desc
            
            #add-point:AFTER FIELD apce022_desc name="input.a.page2.apce022_desc"
            #專案代號
            IF NOT cl_null(g_apce2_d[l_ac].apce022_desc) THEN
               IF ( g_apce2_d[l_ac].apce022_desc != g_apce2_d_t.apce022_desc OR g_apce2_d_t.apce022_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce022 = g_apce2_d[l_ac].apce022_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce022 != g_apce2_d_t.apce022 OR g_apce2_d_t.apce022 IS NULL) THEN
                        CALL s_aap_project_chk(g_apce2_d[l_ac].apce022) RETURNING g_sub_success,g_errno
                        IF NOT g_sub_success THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'apjm200'
                           LET g_errparam.replace[2] = cl_get_progname('apjm200',g_lang,"2")
                           LET g_errparam.exeprog = 'apjm200'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce022      = g_apce2_d_t.apce022
                           LET g_apce2_d[l_ac].apce022_desc = g_apce2_d_t.apce022_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce022 ,g_apce2_d[l_ac].apce022_desc
                           NEXT FIELD CURRENT
                        END IF      
                     END IF                     
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce022 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce022_desc = s_desc_show1(g_apce2_d[l_ac].apce022,s_desc_get_project_desc(g_apce2_d[l_ac].apce022))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce022 ,g_apce2_d[l_ac].apce022_desc 
            LET g_apce2_d_t.apce022_desc = g_apce2_d[l_ac].apce022_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce022_desc
            #add-point:ON CHANGE apce022_desc name="input.g.page2.apce022_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce023
            #add-point:BEFORE FIELD apce023 name="input.b.page2.apce023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce023
            
            #add-point:AFTER FIELD apce023 name="input.a.page2.apce023"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce023
            #add-point:ON CHANGE apce023 name="input.g.page2.apce023"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce023_desc
            #add-point:BEFORE FIELD apce023_desc name="input.b.page2.apce023_desc"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce023_desc
            
            #add-point:AFTER FIELD apce023_desc name="input.a.page2.apce023_desc"
            #WBS
            IF NOT cl_null(g_apce2_d[l_ac].apce023_desc)  THEN
               IF ( g_apce2_d[l_ac].apce023_desc != g_apce2_d_t.apce023_desc OR g_apce2_d_t.apce023_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce023 = g_apce2_d[l_ac].apce023_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce023 != g_apce2_d_t.apce023 OR g_apce2_d_t.apce023 IS NULL) THEN
                        CALL s_voucher_glaq028_chk(g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023)
                       #CALL s_aap_project_chk( g_apce2_d[l_ac].apce023) RETURNING g_sub_success,g_errno
                        IF NOT cl_null(g_errno) THEN
                            INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = g_errno
                           LET g_errparam.extend = ''
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce023        = g_apce2_d_t.apce023
                           LET g_apce2_d[l_ac].apce023_desc = g_apce2_d_t.apce023_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce023_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce023 = ''
            END IF
            LET g_apce2_d[l_ac].apce023_desc = s_desc_show1(g_apce2_d[l_ac].apce023,s_desc_get_pjbbl004_desc(g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023))
            DISPLAY BY NAME g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce023_desc
            LET g_apce2_d_t.apce023_desc = g_apce2_d[l_ac].apce023_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce023_desc
            #add-point:ON CHANGE apce023_desc name="input.g.page2.apce023_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce035
            #add-point:BEFORE FIELD apce035 name="input.b.page2.apce035"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce035
            
            #add-point:AFTER FIELD apce035 name="input.a.page2.apce035"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce035
            #add-point:ON CHANGE apce035 name="input.g.page2.apce035"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce035_desc
            #add-point:BEFORE FIELD apce035_desc name="input.b.page2.apce035_desc"
            LET g_apce2_d[l_ac].apce035_desc = g_apce2_d[l_ac].apce035   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce035_desc
            
            #add-point:AFTER FIELD apce035_desc name="input.a.page2.apce035_desc"
            #區域
            IF NOT cl_null(g_apce2_d[l_ac].apce035_desc) THEN
               IF ( g_apce2_d[l_ac].apce035_desc != g_apce2_d_t.apce035_desc OR g_apce2_d_t.apce035_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce035 = g_apce2_d[l_ac].apce035_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce035 != g_apce2_d_t.apce035 OR g_apce2_d_t.apce035 IS NULL) THEN
                        IF NOT s_azzi650_chk_exist('287',g_apce2_d[l_ac].apce035) THEN
                           LET g_apce2_d[l_ac].apce035      = g_apce2_d_t.apce035
                           LET g_apce2_d[l_ac].apce035_desc = g_apce2_d_t.apce035_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce035 ,g_apce2_d[l_ac].apce035_desc
                           NEXT FIELD CURRENT
                        END IF                  
                     END IF 
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce035 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce035_desc = s_desc_show1(g_apce2_d[l_ac].apce035,s_desc_get_acc_desc('287',g_apce2_d[l_ac].apce035))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce035 ,g_apce2_d[l_ac].apce035_desc
            LET g_apce2_d_t.apce035_desc = g_apce2_d[l_ac].apce035_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce035_desc
            #add-point:ON CHANGE apce035_desc name="input.g.page2.apce035_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce036
            #add-point:BEFORE FIELD apce036 name="input.b.page2.apce036"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce036
            
            #add-point:AFTER FIELD apce036 name="input.a.page2.apce036"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce036
            #add-point:ON CHANGE apce036 name="input.g.page2.apce036"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce036_desc
            #add-point:BEFORE FIELD apce036_desc name="input.b.page2.apce036_desc"
            LET g_apce2_d[l_ac].apce036_desc = g_apce2_d[l_ac].apce036   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce036_desc
            
            #add-point:AFTER FIELD apce036_desc name="input.a.page2.apce036_desc"
            #客群
            IF NOT cl_null(g_apce2_d[l_ac].apce036_desc) THEN
               IF ( g_apce2_d[l_ac].apce036_desc != g_apce2_d_t.apce036_desc OR g_apce2_d_t.apce036_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce036 = g_apce2_d[l_ac].apce036_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce036 != g_apce2_d_t.apce036 OR g_apce2_d_t.apce036 IS NULL) THEN
                        IF NOT s_azzi650_chk_exist('281',g_apce2_d[l_ac].apce036) THEN
                           LET g_apce2_d[l_ac].apce036      = g_apce2_d_t.apce036
                           LET g_apce2_d[l_ac].apce036_desc = g_apce2_d_t.apce036_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce036 ,g_apce2_d[l_ac].apce036_desc
                           NEXT FIELD CURRENT
                        END IF                  
                     END IF 
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce036 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce036_desc = s_desc_show1(g_apce2_d[l_ac].apce036,s_desc_get_acc_desc('281',g_apce2_d[l_ac].apce036))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce036 ,g_apce2_d[l_ac].apce036_desc 
            LET g_apce2_d_t.apce036_desc = g_apce2_d[l_ac].apce036_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce036_desc
            #add-point:ON CHANGE apce036_desc name="input.g.page2.apce036_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce044
            #add-point:BEFORE FIELD apce044 name="input.b.page2.apce044"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce044
            
            #add-point:AFTER FIELD apce044 name="input.a.page2.apce044"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce044
            #add-point:ON CHANGE apce044 name="input.g.page2.apce044"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce044_desc
            #add-point:BEFORE FIELD apce044_desc name="input.b.page2.apce044_desc"
            LET g_apce2_d[l_ac].apce044_desc = g_apce2_d[l_ac].apce044   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce044_desc
            
            #add-point:AFTER FIELD apce044_desc name="input.a.page2.apce044_desc"
            #經營方式
            IF NOT cl_null(g_apce2_d[l_ac].apce044_desc) THEN
               IF ( g_apce2_d[l_ac].apce044_desc != g_apce2_d_t.apce044_desc OR g_apce2_d_t.apce044_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce044 = g_apce2_d[l_ac].apce044_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce044 != g_apce2_d_t.apce044 OR g_apce2_d_t.apce044 IS NULL) THEN
                        CALL s_voucher_glaq052_chk(g_apce2_d[l_ac].apce044) 
                        IF NOT cl_null(g_errno) THEN
                           LET g_apce2_d[l_ac].apce044      = g_apce2_d_t.apce044
                           LET g_apce2_d[l_ac].apce044_desc = g_apce2_d_t.apce044_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce044 ,g_apce2_d[l_ac].apce044_desc
                           NEXT FIELD CURRENT
                        END IF                  
                     END IF 
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce044 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce044_desc = s_desc_show1(g_apce2_d[l_ac].apce044,s_desc_get_oojdl003_desc(g_apce2_d[l_ac].apce044))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce044 ,g_apce2_d[l_ac].apce044_desc 
            LET g_apce2_d_t.apce044_desc = g_apce2_d[l_ac].apce044_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce044_desc
            #add-point:ON CHANGE apce044_desc name="input.g.page2.apce044_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce045
            #add-point:BEFORE FIELD apce045 name="input.b.page2.apce045"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce045
            
            #add-point:AFTER FIELD apce045 name="input.a.page2.apce045"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce045
            #add-point:ON CHANGE apce045 name="input.g.page2.apce045"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce045_desc
            #add-point:BEFORE FIELD apce045_desc name="input.b.page2.apce045_desc"
            LET g_apce2_d[l_ac].apce045_desc = g_apce2_d[l_ac].apce045   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce045_desc
            
            #add-point:AFTER FIELD apce045_desc name="input.a.page2.apce045_desc"
            #渠道
            IF NOT cl_null(g_apce2_d[l_ac].apce045_desc) THEN
               IF ( g_apce2_d[l_ac].apce045_desc != g_apce2_d_t.apce045_desc OR g_apce2_d_t.apce045_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce045 = g_apce2_d[l_ac].apce045_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce045 != g_apce2_d_t.apce045 OR g_apce2_d_t.apce045 IS NULL) THEN
                        CALL s_voucher_glaq052_chk(g_apce2_d[l_ac].apce045) 
                        IF NOT cl_null(g_errno) THEN
                           LET g_apce2_d[l_ac].apce045      = g_apce2_d_t.apce045
                           LET g_apce2_d[l_ac].apce045_desc = g_apce2_d_t.apce045_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce045 ,g_apce2_d[l_ac].apce045_desc
                           NEXT FIELD CURRENT
                        END IF                  
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce045 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce045_desc = s_desc_show1(g_apce2_d[l_ac].apce045,s_desc_get_oojdl003_desc(g_apce2_d[l_ac].apce045))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce045 ,g_apce2_d[l_ac].apce045_desc 
            LET g_apce2_d_t.apce045_desc = g_apce2_d[l_ac].apce045_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce045_desc
            #add-point:ON CHANGE apce045_desc name="input.g.page2.apce045_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce046
            #add-point:BEFORE FIELD apce046 name="input.b.page2.apce046"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce046
            
            #add-point:AFTER FIELD apce046 name="input.a.page2.apce046"
 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce046
            #add-point:ON CHANGE apce046 name="input.g.page2.apce046"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce046_desc
            #add-point:BEFORE FIELD apce046_desc name="input.b.page2.apce046_desc"
            LET g_apce2_d[l_ac].apce046_desc = g_apce2_d[l_ac].apce046   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce046_desc
            
            #add-point:AFTER FIELD apce046_desc name="input.a.page2.apce046_desc"
            #品牌
            IF NOT cl_null(g_apce2_d[l_ac].apce046_desc) THEN
               IF ( g_apce2_d[l_ac].apce046_desc != g_apce2_d_t.apce046_desc OR g_apce2_d_t.apce046_desc IS NULL ) THEN
                  LET g_apce2_d[l_ac].apce046 = g_apce2_d[l_ac].apce046_desc
                  IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                     IF (g_apce2_d[l_ac].apce046 != g_apce2_d_t.apce046 OR g_apce2_d_t.apce046 IS NULL) THEN
                        IF NOT s_azzi650_chk_exist('2002',g_apce2_d[l_ac].apce046) THEN
                           LET g_apce2_d[l_ac].apce046      = g_apce2_d_t.apce046
                           LET g_apce2_d[l_ac].apce046_desc = g_apce2_d_t.apce046_desc
                           DISPLAY BY NAME g_apce2_d[l_ac].apce046 ,g_apce2_d[l_ac].apce046_desc
                           NEXT FIELD CURRENT
                        END IF                  
                     END IF  
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce046 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce046_desc = s_desc_show1(g_apce2_d[l_ac].apce046,s_desc_get_acc_desc('2002',g_apce2_d[l_ac].apce046))      
            DISPLAY BY NAME g_apce2_d[l_ac].apce046 ,g_apce2_d[l_ac].apce046_desc 
            LET g_apce2_d_t.apce046_desc = g_apce2_d[l_ac].apce046_desc
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce046_desc
            #add-point:ON CHANGE apce046_desc name="input.g.page2.apce046_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce051
            #add-point:BEFORE FIELD apce051 name="input.b.page2.apce051"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce051
            
            #add-point:AFTER FIELD apce051 name="input.a.page2.apce051"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce051
            #add-point:ON CHANGE apce051 name="input.g.page2.apce051"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce051_desc
            #add-point:BEFORE FIELD apce051_desc name="input.b.page2.apce051_desc"
            #自由核算項一
            CALL s_fin_get_glae009(g_glad.glad0171) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce051_desc = g_apce2_d[l_ac].apce051   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce051_desc
            
            #add-point:AFTER FIELD apce051_desc name="input.a.page2.apce051_desc"
            #自由核算項一
            IF NOT cl_null(g_apce2_d[l_ac].apce051_desc) THEN
               IF (g_apce2_d[l_ac].apce051_desc != g_apce2_d_t.apce051_desc OR g_apce2_d_t.apce051_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce051 = g_apce2_d[l_ac].apce051_desc
                  IF (g_apce2_d[l_ac].apce051 != g_apce2_d_t.apce051 OR g_apce2_d_t.apce051 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0171,g_apce2_d[l_ac].apce051,g_glad.glad0172) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce051 = g_apce2_d_t.apce051
                           LET g_apce2_d[l_ac].apce051_desc = s_desc_show1(g_apce2_d[l_ac].apce051,s_fin_get_accting_desc(g_glad.glad0171,g_apce2_d[l_ac].apce051))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce051_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce051 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce051_desc = s_desc_show1(g_apce2_d[l_ac].apce051,s_fin_get_accting_desc(g_glad.glad0171,g_apce2_d[l_ac].apce051))
            DISPLAY BY NAME g_apce2_d[l_ac].apce051_desc
            LET g_apce2_d_t.apce051_desc = g_apce2_d[l_ac].apce051_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce051_desc
            #add-point:ON CHANGE apce051_desc name="input.g.page2.apce051_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce052
            #add-point:BEFORE FIELD apce052 name="input.b.page2.apce052"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce052
            
            #add-point:AFTER FIELD apce052 name="input.a.page2.apce052"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce052
            #add-point:ON CHANGE apce052 name="input.g.page2.apce052"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce052_desc
            #add-point:BEFORE FIELD apce052_desc name="input.b.page2.apce052_desc"
            CALL s_fin_get_glae009(g_glad.glad0181) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce052_desc = g_apce2_d[l_ac].apce052   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce052_desc
            
            #add-point:AFTER FIELD apce052_desc name="input.a.page2.apce052_desc"
            #自由核算項二
            IF NOT cl_null(g_apce2_d[l_ac].apce052_desc) THEN
               IF (g_apce2_d[l_ac].apce052_desc != g_apce2_d_t.apce052_desc OR g_apce2_d_t.apce052_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce052 = g_apce2_d[l_ac].apce052_desc
                  IF (g_apce2_d[l_ac].apce052 != g_apce2_d_t.apce052 OR g_apce2_d_t.apce052 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0181,g_apce2_d[l_ac].apce052,g_glad.glad0182) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce052 = g_apce2_d_t.apce052
                           LET g_apce2_d[l_ac].apce052_desc = s_desc_show1(g_apce2_d[l_ac].apce052,s_fin_get_accting_desc(g_glad.glad0181,g_apce2_d[l_ac].apce052))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce052_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce052 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce052_desc = s_desc_show1(g_apce2_d[l_ac].apce052,s_fin_get_accting_desc(g_glad.glad0181,g_apce2_d[l_ac].apce052))
            DISPLAY BY NAME g_apce2_d[l_ac].apce052_desc
            LET g_apce2_d_t.apce052_desc = g_apce2_d[l_ac].apce052_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce052_desc
            #add-point:ON CHANGE apce052_desc name="input.g.page2.apce052_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce053
            #add-point:BEFORE FIELD apce053 name="input.b.page2.apce053"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce053
            
            #add-point:AFTER FIELD apce053 name="input.a.page2.apce053"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce053
            #add-point:ON CHANGE apce053 name="input.g.page2.apce053"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce053_desc
            #add-point:BEFORE FIELD apce053_desc name="input.b.page2.apce053_desc"
            CALL s_fin_get_glae009(g_glad.glad0191) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce053_desc = g_apce2_d[l_ac].apce053   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce053_desc
            
            #add-point:AFTER FIELD apce053_desc name="input.a.page2.apce053_desc"
            #自由核算項三
            IF NOT cl_null(g_apce2_d[l_ac].apce053_desc) THEN
               IF (g_apce2_d[l_ac].apce053_desc != g_apce2_d_t.apce053_desc OR g_apce2_d_t.apce053_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce053 = g_apce2_d[l_ac].apce053_desc
                  IF (g_apce2_d[l_ac].apce053 != g_apce2_d_t.apce053 OR g_apce2_d_t.apce053 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0191,g_apce2_d[l_ac].apce053,g_glad.glad0192) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce053 = g_apce2_d_t.apce053
                           LET g_apce2_d[l_ac].apce053_desc = s_desc_show1(g_apce2_d[l_ac].apce053,s_fin_get_accting_desc(g_glad.glad0191,g_apce2_d[l_ac].apce053))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce053_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce053 = ''                    
            END IF
            LET g_apce2_d[l_ac].apce053_desc = s_desc_show1(g_apce2_d[l_ac].apce053,s_fin_get_accting_desc(g_glad.glad0191,g_apce2_d[l_ac].apce053))
            DISPLAY BY NAME g_apce2_d[l_ac].apce053_desc
            LET g_apce2_d_t.apce053_desc = g_apce2_d[l_ac].apce053_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce053_desc
            #add-point:ON CHANGE apce053_desc name="input.g.page2.apce053_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce054
            #add-point:BEFORE FIELD apce054 name="input.b.page2.apce054"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce054
            
            #add-point:AFTER FIELD apce054 name="input.a.page2.apce054"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce054
            #add-point:ON CHANGE apce054 name="input.g.page2.apce054"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce054_desc
            #add-point:BEFORE FIELD apce054_desc name="input.b.page2.apce054_desc"
            CALL s_fin_get_glae009(g_glad.glad0201) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce054_desc = g_apce2_d[l_ac].apce054   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce054_desc
            
            #add-point:AFTER FIELD apce054_desc name="input.a.page2.apce054_desc"
            #自由核算項四
            IF NOT cl_null(g_apce2_d[l_ac].apce054_desc) THEN
               IF (g_apce2_d[l_ac].apce054_desc != g_apce2_d_t.apce054_desc OR g_apce2_d_t.apce054_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce054 = g_apce2_d[l_ac].apce054_desc
                  IF (g_apce2_d[l_ac].apce054 != g_apce2_d_t.apce054 OR g_apce2_d_t.apce054 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0201,g_apce2_d[l_ac].apce054,g_glad.glad0202) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce054 = g_apce2_d_t.apce054
                           LET g_apce2_d[l_ac].apce054_desc = s_desc_show1(g_apce2_d[l_ac].apce054,s_fin_get_accting_desc(g_glad.glad0201,g_apce2_d[l_ac].apce054))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce054_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce054 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce054_desc = s_desc_show1(g_apce2_d[l_ac].apce054,s_fin_get_accting_desc(g_glad.glad0201,g_apce2_d[l_ac].apce054))
            DISPLAY BY NAME g_apce2_d[l_ac].apce054_desc
            LET g_apce2_d_t.apce054_desc = g_apce2_d[l_ac].apce054_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce054_desc
            #add-point:ON CHANGE apce054_desc name="input.g.page2.apce054_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce055
            #add-point:BEFORE FIELD apce055 name="input.b.page2.apce055"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce055
            
            #add-point:AFTER FIELD apce055 name="input.a.page2.apce055"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce055
            #add-point:ON CHANGE apce055 name="input.g.page2.apce055"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce055_desc
            #add-point:BEFORE FIELD apce055_desc name="input.b.page2.apce055_desc"
            CALL s_fin_get_glae009(g_glad.glad0211) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce055_desc = g_apce2_d[l_ac].apce055   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce055_desc
            
            #add-point:AFTER FIELD apce055_desc name="input.a.page2.apce055_desc"
            #自由核算項五
            IF NOT cl_null(g_apce2_d[l_ac].apce055_desc) THEN
               IF (g_apce2_d[l_ac].apce055_desc != g_apce2_d_t.apce055_desc OR g_apce2_d_t.apce055_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce055 = g_apce2_d[l_ac].apce055_desc
                  IF (g_apce2_d[l_ac].apce055 != g_apce2_d_t.apce055 OR g_apce2_d_t.apce055 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0211,g_apce2_d[l_ac].apce055,g_glad.glad0212) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce055 = g_apce2_d_t.apce055
                           LET g_apce2_d[l_ac].apce055_desc = s_desc_show1(g_apce2_d[l_ac].apce055,s_fin_get_accting_desc(g_glad.glad0211,g_apce2_d[l_ac].apce055))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce055_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce055 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce055_desc = s_desc_show1(g_apce2_d[l_ac].apce055,s_fin_get_accting_desc(g_glad.glad0211,g_apce2_d[l_ac].apce055))
            DISPLAY BY NAME g_apce2_d[l_ac].apce055_desc
            LET g_apce2_d_t.apce055_desc = g_apce2_d[l_ac].apce055_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce055_desc
            #add-point:ON CHANGE apce055_desc name="input.g.page2.apce055_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce056
            #add-point:BEFORE FIELD apce056 name="input.b.page2.apce056"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce056
            
            #add-point:AFTER FIELD apce056 name="input.a.page2.apce056"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce056
            #add-point:ON CHANGE apce056 name="input.g.page2.apce056"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce056_desc
            #add-point:BEFORE FIELD apce056_desc name="input.b.page2.apce056_desc"
            CALL s_fin_get_glae009(g_glad.glad0221) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce056_desc = g_apce2_d[l_ac].apce056   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce056_desc
            
            #add-point:AFTER FIELD apce056_desc name="input.a.page2.apce056_desc"
            #自由核算項六
            IF NOT cl_null(g_apce2_d[l_ac].apce056_desc) THEN
               IF (g_apce2_d[l_ac].apce056_desc != g_apce2_d_t.apce056_desc OR g_apce2_d_t.apce056_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce056 = g_apce2_d[l_ac].apce056_desc
                  IF (g_apce2_d[l_ac].apce056 != g_apce2_d_t.apce056 OR g_apce2_d_t.apce056 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0221,g_apce2_d[l_ac].apce056,g_glad.glad0222) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce056 = g_apce2_d_t.apce056
                           LET g_apce2_d[l_ac].apce056_desc = s_desc_show1(g_apce2_d[l_ac].apce056,s_fin_get_accting_desc(g_glad.glad0221,g_apce2_d[l_ac].apce056))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce056_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce056 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce056_desc = s_desc_show1(g_apce2_d[l_ac].apce056,s_fin_get_accting_desc(g_glad.glad0221,g_apce2_d[l_ac].apce056))
            DISPLAY BY NAME g_apce2_d[l_ac].apce056_desc
            LET g_apce2_d_t.apce056_desc = g_apce2_d[l_ac].apce056_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce056_desc
            #add-point:ON CHANGE apce056_desc name="input.g.page2.apce056_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce057
            #add-point:BEFORE FIELD apce057 name="input.b.page2.apce057"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce057
            
            #add-point:AFTER FIELD apce057 name="input.a.page2.apce057"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce057
            #add-point:ON CHANGE apce057 name="input.g.page2.apce057"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce057_desc
            #add-point:BEFORE FIELD apce057_desc name="input.b.page2.apce057_desc"
            CALL s_fin_get_glae009(g_glad.glad0231) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce057_desc = g_apce2_d[l_ac].apce057   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce057_desc
            
            #add-point:AFTER FIELD apce057_desc name="input.a.page2.apce057_desc"
            #自由核算項七
            IF NOT cl_null(g_apce2_d[l_ac].apce057_desc) THEN
               IF (g_apce2_d[l_ac].apce057_desc != g_apce2_d_t.apce057_desc OR g_apce2_d_t.apce057_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce057 = g_apce2_d[l_ac].apce057_desc
                  IF (g_apce2_d[l_ac].apce057 != g_apce2_d_t.apce057 OR g_apce2_d_t.apce057 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0231,g_apce2_d[l_ac].apce057,g_glad.glad0232) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce057 = g_apce2_d_t.apce057
                           LET g_apce2_d[l_ac].apce057_desc = s_desc_show1(g_apce2_d[l_ac].apce057,s_fin_get_accting_desc(g_glad.glad0231,g_apce2_d[l_ac].apce057))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce057_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce057 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce057_desc = s_desc_show1(g_apce2_d[l_ac].apce057,s_fin_get_accting_desc(g_glad.glad0231,g_apce2_d[l_ac].apce057))
            DISPLAY BY NAME g_apce2_d[l_ac].apce057_desc
            LET g_apce2_d_t.apce057_desc = g_apce2_d[l_ac].apce057_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce057_desc
            #add-point:ON CHANGE apce057_desc name="input.g.page2.apce057_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce058
            #add-point:BEFORE FIELD apce058 name="input.b.page2.apce058"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce058
            
            #add-point:AFTER FIELD apce058 name="input.a.page2.apce058"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce058
            #add-point:ON CHANGE apce058 name="input.g.page2.apce058"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce058_desc
            #add-point:BEFORE FIELD apce058_desc name="input.b.page2.apce058_desc"
            CALL s_fin_get_glae009(g_glad.glad0241) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce058_desc = g_apce2_d[l_ac].apce058   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce058_desc
            
            #add-point:AFTER FIELD apce058_desc name="input.a.page2.apce058_desc"
            #自由核算項八
            IF NOT cl_null(g_apce2_d[l_ac].apce058_desc) THEN
               IF (g_apce2_d[l_ac].apce058_desc != g_apce2_d_t.apce058_desc OR g_apce2_d_t.apce058_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce058 = g_apce2_d[l_ac].apce058_desc
                  IF (g_apce2_d[l_ac].apce058 != g_apce2_d_t.apce058 OR g_apce2_d_t.apce058 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0241,g_apce2_d[l_ac].apce058,g_glad.glad0242) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce058 = g_apce2_d_t.apce058
                           LET g_apce2_d[l_ac].apce058_desc = s_desc_show1(g_apce2_d[l_ac].apce058,s_fin_get_accting_desc(g_glad.glad0241,g_apce2_d[l_ac].apce058))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce058_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce058 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce058_desc = s_desc_show1(g_apce2_d[l_ac].apce058,s_fin_get_accting_desc(g_glad.glad0241,g_apce2_d[l_ac].apce058))
            DISPLAY BY NAME g_apce2_d[l_ac].apce058_desc
            LET g_apce2_d_t.apce058_desc = g_apce2_d[l_ac].apce058_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce058_desc
            #add-point:ON CHANGE apce058_desc name="input.g.page2.apce058_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce059
            #add-point:BEFORE FIELD apce059 name="input.b.page2.apce059"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce059
            
            #add-point:AFTER FIELD apce059 name="input.a.page2.apce059"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce059
            #add-point:ON CHANGE apce059 name="input.g.page2.apce059"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce059_desc
            #add-point:BEFORE FIELD apce059_desc name="input.b.page2.apce059_desc"
            CALL s_fin_get_glae009(g_glad.glad0251) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce059_desc = g_apce2_d[l_ac].apce059   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce059_desc
            
            #add-point:AFTER FIELD apce059_desc name="input.a.page2.apce059_desc"
            #自由核算項九
            IF NOT cl_null(g_apce2_d[l_ac].apce059_desc) THEN
               IF (g_apce2_d[l_ac].apce059_desc != g_apce2_d_t.apce059_desc OR g_apce2_d_t.apce059_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce059 = g_apce2_d[l_ac].apce059_desc
                  IF (g_apce2_d[l_ac].apce059 != g_apce2_d_t.apce059 OR g_apce2_d_t.apce059 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0251,g_apce2_d[l_ac].apce059,g_glad.glad0252) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce059 = g_apce2_d_t.apce059
                           LET g_apce2_d[l_ac].apce059_desc = s_desc_show1(g_apce2_d[l_ac].apce059,s_fin_get_accting_desc(g_glad.glad0251,g_apce2_d[l_ac].apce059))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce059_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce059 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce059_desc = s_desc_show1(g_apce2_d[l_ac].apce059,s_fin_get_accting_desc(g_glad.glad0251,g_apce2_d[l_ac].apce059))
            DISPLAY BY NAME g_apce2_d[l_ac].apce059_desc
            LET g_apce2_d_t.apce059_desc = g_apce2_d[l_ac].apce059_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce059_desc
            #add-point:ON CHANGE apce059_desc name="input.g.page2.apce059_desc"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce060
            #add-point:BEFORE FIELD apce060 name="input.b.page2.apce060"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce060
            
            #add-point:AFTER FIELD apce060 name="input.a.page2.apce060"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce060
            #add-point:ON CHANGE apce060 name="input.g.page2.apce060"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce060_desc
            #add-point:BEFORE FIELD apce060_desc name="input.b.page2.apce060_desc"
            CALL s_fin_get_glae009(g_glad.glad0261) RETURNING l_glae009
            LET g_apce2_d[l_ac].apce060_desc = g_apce2_d[l_ac].apce060   #150205-00012#1
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce060_desc
            
            #add-point:AFTER FIELD apce060_desc name="input.a.page2.apce060_desc"
            #自由核算項十
            IF NOT cl_null(g_apce2_d[l_ac].apce060_desc) THEN
               IF (g_apce2_d[l_ac].apce060_desc != g_apce2_d_t.apce060_desc OR g_apce2_d_t.apce060_desc IS NULL) THEN
                  LET g_apce2_d[l_ac].apce060 = g_apce2_d[l_ac].apce060_desc
                  IF (g_apce2_d[l_ac].apce060 != g_apce2_d_t.apce060 OR g_apce2_d_t.apce060 IS NULL) THEN
                     IF g_glaa.glaa121 = 'N' THEN     #141218-00011#6
                        CALL s_voucher_free_account_chk(g_glad.glad0261,g_apce2_d[l_ac].apce060,g_glad.glad0262) RETURNING g_errno
                        IF NOT cl_null(g_errno) THEN
                           INITIALIZE g_errparam TO NULL 
                           LET g_errparam.extend = "" 
                           LET g_errparam.code   = g_errno
                           #160321-00016#20 --s add
                           LET g_errparam.replace[1] = 'agli041'
                           LET g_errparam.replace[2] = cl_get_progname('agli041',g_lang,"2")
                           LET g_errparam.exeprog = 'agli041'
                           #160321-00016#20 --e add
                           LET g_errparam.popup  = TRUE 
                           CALL cl_err()
                           LET g_apce2_d[l_ac].apce060 = g_apce2_d_t.apce060
                           LET g_apce2_d[l_ac].apce060_desc = s_desc_show1(g_apce2_d[l_ac].apce060,s_fin_get_accting_desc(g_glad.glad0261,g_apce2_d[l_ac].apce060))
                           DISPLAY BY NAME g_apce2_d[l_ac].apce060_desc
                           NEXT FIELD CURRENT
                        END IF
                     END IF
                  END IF
               END IF
            ELSE
               LET g_apce2_d[l_ac].apce060 = ''                 
            END IF
            LET g_apce2_d[l_ac].apce060_desc = s_desc_show1(g_apce2_d[l_ac].apce060,s_fin_get_accting_desc(g_glad.glad0261,g_apce2_d[l_ac].apce060))
            DISPLAY BY NAME g_apce2_d[l_ac].apce060_desc
            LET g_apce2_d_t.apce060_desc = g_apce2_d[l_ac].apce060_desc            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce060_desc
            #add-point:ON CHANGE apce060_desc name="input.g.page2.apce060_desc"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page2.apce0162
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce0162
            #add-point:ON ACTION controlp INFIELD apce0162 name="input.c.page2.apce0162"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce0162_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce0162_desc
            #add-point:ON ACTION controlp INFIELD apce0162_desc name="input.c.page2.apce0162_desc"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce017
            #add-point:ON ACTION controlp INFIELD apce017 name="input.c.page2.apce017"
 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce017_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce017_desc
            #add-point:ON ACTION controlp INFIELD apce017_desc name="input.c.page2.apce017_desc"
            #業務人員
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		    	LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce017
            CALL q_ooag001_8()                          
            LET g_apce2_d[l_ac].apce017 = g_qryparam.return1    
            LET g_apce2_d[l_ac].apce017_desc = g_qryparam.return1    
            DISPLAY BY NAME  g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce017_desc
            NEXT FIELD apce017_desc 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce018
            #add-point:ON ACTION controlp INFIELD apce018 name="input.c.page2.apce018"
 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce018_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce018_desc
            #add-point:ON ACTION controlp INFIELD apce018_desc name="input.c.page2.apce018_desc"
            #業務部門
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce018
            LET g_qryparam.arg1 = g_apca.apcadocdt         #應以單據日期
            CALL q_ooeg001_4()  
            LET g_apce2_d[l_ac].apce018 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce018_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce018_desc
            NEXT FIELD apce018_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce019
            #add-point:ON ACTION controlp INFIELD apce019 name="input.c.page2.apce019"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce019_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce019_desc
            #add-point:ON ACTION controlp INFIELD apce019_desc name="input.c.page2.apce019_desc"
            #責任中心
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce019
            LET g_qryparam.arg1 = g_apca.apcadocdt
            LET g_qryparam.where = " ooeg003 IN ('1','2','3')"
            CALL q_ooeg001_5()    
            LET g_apce2_d[l_ac].apce019 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce019_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce019_desc
            NEXT FIELD apce019_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce020
            #add-point:ON ACTION controlp INFIELD apce020 name="input.c.page2.apce020"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce020_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce020_desc
            #add-point:ON ACTION controlp INFIELD apce020_desc name="input.c.page2.apce020_desc"
            #產品類別
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		    	LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce020
            CALL q_rtax001()                          
            LET g_apce2_d[l_ac].apce020 = g_qryparam.return1    
            LET g_apce2_d[l_ac].apce020_desc = g_qryparam.return1    
            DISPLAY BY NAME  g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce020_desc
            NEXT FIELD apce020_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce022
            #add-point:ON ACTION controlp INFIELD apce022 name="input.c.page2.apce022"
 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce022_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce022_desc
            #add-point:ON ACTION controlp INFIELD apce022_desc name="input.c.page2.apce022_desc"
            #專案代號
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce022
            CALL q_pjba001()
            LET g_apce2_d[l_ac].apce022 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce022_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce022_desc
            NEXT FIELD apce022_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce023
            #add-point:ON ACTION controlp INFIELD apce023 name="input.c.page2.apce023"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce023_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce023_desc
            #add-point:ON ACTION controlp INFIELD apce023_desc name="input.c.page2.apce023_desc"
            #WBS
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce023
            IF NOT cl_null(g_apce2_d[l_ac].apce022) THEN
               LET g_qryparam.where = "pjbb012='1' AND pjbb001='",g_apce2_d[l_ac].apce022,"'"
            ELSE
               LET g_qryparam.where = "pjbb012='1'"
            END IF

            CALL q_pjbb002()
            LET g_apce2_d[l_ac].apce023        = g_qryparam.return1
            LET g_apce2_d[l_ac].apce023_desc = g_apce2_d[l_ac].apce023
            DISPLAY BY NAME g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce023_desc
            NEXT FIELD apce023_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce035
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce035
            #add-point:ON ACTION controlp INFIELD apce035 name="input.c.page2.apce035"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce035_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce035_desc
            #add-point:ON ACTION controlp INFIELD apce035_desc name="input.c.page2.apce035_desc"
            #區域
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce035
            CALL q_oocq002_287()
            LET g_apce2_d[l_ac].apce035 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce035_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce035_desc
            NEXT FIELD apce035_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce036
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce036
            #add-point:ON ACTION controlp INFIELD apce036 name="input.c.page2.apce036"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce036_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce036_desc
            #add-point:ON ACTION controlp INFIELD apce036_desc name="input.c.page2.apce036_desc"
            #客群
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce036
            CALL q_oocq002_281()
            LET g_apce2_d[l_ac].apce036 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce036_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce036_desc
            NEXT FIELD apce036_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce044
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce044
            #add-point:ON ACTION controlp INFIELD apce044 name="input.c.page2.apce044"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce044_desc
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce044_desc
            #add-point:ON ACTION controlp INFIELD apce044_desc name="input.c.page2.apce044_desc"
 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce045
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce045
            #add-point:ON ACTION controlp INFIELD apce045 name="input.c.page2.apce045"
 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce045_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce045_desc
            #add-point:ON ACTION controlp INFIELD apce045_desc name="input.c.page2.apce045_desc"
            #渠道
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce045
            CALL q_oojd001_2()
            LET g_apce2_d[l_ac].apce045 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce045_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce045_desc
            NEXT FIELD apce045_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce046
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce046
            #add-point:ON ACTION controlp INFIELD apce046 name="input.c.page2.apce046"
 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce046_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce046_desc
            #add-point:ON ACTION controlp INFIELD apce046_desc name="input.c.page2.apce046_desc"
            #品牌
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
		      LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apce2_d[l_ac].apce046
            CALL q_oocq002_2002()
            LET g_apce2_d[l_ac].apce046 = g_qryparam.return1   
            LET g_apce2_d[l_ac].apce046_desc = g_qryparam.return1 
            DISPLAY BY NAME  g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce046_desc
            NEXT FIELD apce046_desc
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce051
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce051
            #add-point:ON ACTION controlp INFIELD apce051 name="input.c.page2.apce051"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce051_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce051_desc
            #add-point:ON ACTION controlp INFIELD apce051_desc name="input.c.page2.apce051_desc"
            #自由核算項一
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce051
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0171,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce051      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce051_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce051,g_apce2_d[l_ac].apce051_desc
               NEXT FIELD apce051_desc
            END IF
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce052
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce052
            #add-point:ON ACTION controlp INFIELD apce052 name="input.c.page2.apce052"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce052_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce052_desc
            #add-point:ON ACTION controlp INFIELD apce052_desc name="input.c.page2.apce052_desc"
            #自由核算項二
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce052
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0181,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce052      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce052_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce052_desc
               NEXT FIELD apce052_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce053
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce053
            #add-point:ON ACTION controlp INFIELD apce053 name="input.c.page2.apce053"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce053_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce053_desc
            #add-point:ON ACTION controlp INFIELD apce053_desc name="input.c.page2.apce053_desc"
            #自由核算項三
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce053
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0191,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce053      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce053_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce053_desc
               NEXT FIELD apce053_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce054
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce054
            #add-point:ON ACTION controlp INFIELD apce054 name="input.c.page2.apce054"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce054_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce054_desc
            #add-point:ON ACTION controlp INFIELD apce054_desc name="input.c.page2.apce054_desc"
            #自由核算項四
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce054
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0201,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce054      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce054_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce054_desc
               NEXT FIELD apce054_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce055
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce055
            #add-point:ON ACTION controlp INFIELD apce055 name="input.c.page2.apce055"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce055_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce055_desc
            #add-point:ON ACTION controlp INFIELD apce055_desc name="input.c.page2.apce055_desc"
            #自由核算項五
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce055
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0211,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce055      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce055_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce055_desc
               NEXT FIELD apce055_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce056
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce056
            #add-point:ON ACTION controlp INFIELD apce056 name="input.c.page2.apce056"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce056_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce056_desc
            #add-point:ON ACTION controlp INFIELD apce056_desc name="input.c.page2.apce056_desc"
            #自由核算項六
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce056
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0221,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce056      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce056_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce056_desc
               NEXT FIELD apce056_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce057
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce057
            #add-point:ON ACTION controlp INFIELD apce057 name="input.c.page2.apce057"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce057_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce057_desc
            #add-point:ON ACTION controlp INFIELD apce057_desc name="input.c.page2.apce057_desc"
            #自由核算項七
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce057
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0231,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce057      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce057_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce057_desc
               NEXT FIELD apce057_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce058
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce058
            #add-point:ON ACTION controlp INFIELD apce058 name="input.c.page2.apce058"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce058_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce058_desc
            #add-point:ON ACTION controlp INFIELD apce058_desc name="input.c.page2.apce058_desc"
            #自由核算項八
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce058
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0241,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce058      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce058_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce058_desc
               NEXT FIELD apce058_desc
            END IF
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce059
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce059
            #add-point:ON ACTION controlp INFIELD apce059 name="input.c.page2.apce059"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce059_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce059_desc
            #add-point:ON ACTION controlp INFIELD apce059_desc name="input.c.page2.apce059_desc"
            #自由核算項九
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce059
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0251,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce059      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce059_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce059_desc
               NEXT FIELD apce059_desc
            END IF 
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce060
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce060
            #add-point:ON ACTION controlp INFIELD apce060 name="input.c.page2.apce060"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.apce060_desc
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce060_desc
            #add-point:ON ACTION controlp INFIELD apce060_desc name="input.c.page2.apce060_desc"
            #自由核算項十
            IF NOT cl_null(l_glae009) THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.state = "i"
               LET g_qryparam.default1 = g_apce2_d[l_ac].apce060
               
               IF l_glae009 = 'q_glaf002' THEN    
                  LET g_qryparam.where = "glaf001 = '",g_glad.glad0261,"'" #自由核算項類型
               END IF 
               CALL q_agli041(l_glae009) 
               LET g_apce2_d[l_ac].apce060      = g_qryparam.return1
               LET g_apce2_d[l_ac].apce060_desc = g_qryparam.return1
               DISPLAY BY NAME g_apce2_d[l_ac].apce060,g_apce2_d[l_ac].apce060_desc
               NEXT FIELD apce060_desc
            END IF 
            #END add-point
 
 
 
 
         AFTER ROW
            LET l_ac = ARR_CURR()
            LET l_ac_t = l_ac
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_apce2_d[l_ac].* = g_apce2_d_t.*
               END IF
               CLOSE aapt300_02_bcl
               #add-point:單身after row name="input.body2.a_close"
               
               #end add-point
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
 
            CALL aapt300_02_unlock_b("apce_t")
            #add-point:單身after row name="input.body2.a_row"
            CALL aapt300_02_sum_page_show()
            #end add-point
            
         AFTER INPUT
            #add-point:單身2input後 name="input.body2.a_input"
            #重算帳款單頭
            CALL s_transaction_begin()
            CALL aapt300_02_clac_bill_master() RETURNING g_sub_success
            IF g_sub_success THEN 
               CALL s_transaction_end('Y','0')
            ELSE
               CALL s_transaction_end('N','0')
            END IF  
            IF g_glaa.glaa121 = 'Y' AND g_dfin0030 = 'Y'THEN
               CALL s_transaction_begin()
               CALL s_pre_voucher_ins('AP','P10',g_apca.apcald,g_apca.apcadocno,g_apca.apcadocdt,'1')
                    RETURNING g_sub_success
               IF g_sub_success THEN 
                  CALL s_transaction_end('Y','0')
               ELSE
                  CALL s_transaction_end('N','0')
               END IF
            END IF
            #end add-point
         
         #複製上一次指定的單身資料至最下方
         ON ACTION controlo   
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_apce_d[li_reproduce_target].* = g_apce_d[li_reproduce].*
               LET g_apce2_d[li_reproduce_target].* = g_apce2_d[li_reproduce].*
               LET g_apce3_d[li_reproduce_target].* = g_apce3_d[li_reproduce].*
 
               LET g_apce2_d[li_reproduce_target].apceld = NULL
               LET g_apce2_d[li_reproduce_target].apcedocno = NULL
               LET g_apce2_d[li_reproduce_target].apceseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_apce2_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_apce2_d.getLength()+1
            END IF
      END INPUT
      INPUT ARRAY g_apce3_d FROM s_detail3.*
         ATTRIBUTE(COUNT = g_detail_cnt,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = FALSE, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = FALSE,
                 APPEND ROW = FALSE)
                 
         #自訂ACTION(detail_input,page_3)
         
         
         BEFORE INPUT
          CALL FGL_SET_ARR_CURR(g_detail_idx)
            
            CALL aapt300_02_b_fill(g_wc2)
            LET g_detail_cnt = g_apce3_d.getLength()
    
         BEFORE INSERT
            LET g_insert = 'Y' 
            NEXT FIELD apceld
 
            LET l_insert = TRUE
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_apce3_d[l_ac].* TO NULL 
            INITIALIZE g_apce3_d_t.* TO NULL
            INITIALIZE g_apce3_d_o.* TO NULL
            #公用欄位給值(單身3)
            
            #自定義預設值(單身3)
                  LET g_apce3_d[l_ac].apce1033 = "0"
      LET g_apce3_d[l_ac].apce1133 = "0"
      LET g_apce3_d[l_ac].apce123 = "0"
      LET g_apce3_d[l_ac].apce133 = "0"
 
            #add-point:modify段before備份 name="input.body3.before_bak"
            
            #end add-point
            LET g_apce3_d_t.* = g_apce3_d[l_ac].*     #新輸入資料
            LET g_apce3_d_o.* = g_apce3_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_apce_d[li_reproduce_target].* = g_apce_d[li_reproduce].*
               LET g_apce2_d[li_reproduce_target].* = g_apce2_d[li_reproduce].*
               LET g_apce3_d[li_reproduce_target].* = g_apce3_d[li_reproduce].*
 
               LET g_apce3_d[li_reproduce_target].apceld = NULL
               LET g_apce3_d[li_reproduce_target].apcedocno = NULL
               LET g_apce3_d[li_reproduce_target].apceseq = NULL
            END IF
            
 
 
 
            CALL aapt300_02_set_entry_b(l_cmd)
            CALL aapt300_02_set_no_entry_b(l_cmd)
            #add-point:modify段before insert name="input.body3.before_insert"
            
            #end add-point  
            
         BEFORE ROW 
            #add-point:modify段before row name="input.body3.before_row2"
            CALL s_transaction_begin()  #150419
            #end add-point  
            LET l_insert = FALSE
            LET g_detail_idx = DIALOG.getCurrentRow("s_detail3")
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = g_detail_idx
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
            DISPLAY g_apce3_d.getLength() TO FORMONLY.cnt
         
            CALL s_transaction_begin()
            
            LET g_detail_cnt = g_apce3_d.getLength()
            
            IF g_detail_cnt >= l_ac 
               AND g_apce3_d[l_ac].apceld IS NOT NULL
               AND g_apce3_d[l_ac].apcedocno IS NOT NULL
               AND g_apce3_d[l_ac].apceseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_apce3_d_t.* = g_apce3_d[l_ac].*  #BACKUP
               LET g_apce3_d_o.* = g_apce3_d[l_ac].*  #BACKUP
               IF NOT aapt300_02_lock_b("apce_t") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aapt300_02_bcl INTO g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq, 
                      g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004, 
                      g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016, 
                      g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104, 
                      g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119, 
                      g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024, 
                      g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031,g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite, 
                      g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apcedocno,g_apce2_d[l_ac].apceld,g_apce2_d[l_ac].apceseq, 
                      g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020, 
                      g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036, 
                      g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051, 
                      g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055, 
                      g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059, 
                      g_apce2_d[l_ac].apce060,g_apce3_d[l_ac].apcedocno,g_apce3_d[l_ac].apceld,g_apce3_d[l_ac].apceseq, 
                      g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
                      g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
                      g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
                  IF SQLCA.SQLCODE THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "FETCH aapt300_02_bcl:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_apce3_d_mask_o[l_ac].* =  g_apce3_d[l_ac].*
                  CALL aapt300_02_apce_t_mask()
                  LET g_apce3_d_mask_n[l_ac].* =  g_apce3_d[l_ac].*
                  
                  CALL cl_show_fld_cont()
                  CALL aapt300_02_detail_show()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            CALL aapt300_02_set_entry_b(l_cmd)
            CALL aapt300_02_set_no_entry_b(l_cmd)
            #add-point:modify段before row name="input.body3.before_row"
            #160628-00002#2--add--str--
            IF l_cmd = 'u' THEN
               IF g_apce_d[l_ac].apce027 = 'Y' THEN
                  #判断是否冲抵完，如果全冲销完，未税金额和税额不可修改
                  CALL s_axrt300_not_washed_amt(g_apce_d[l_ac].apceld,g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005)
                  RETURNING r_apce_w.*
                  IF r_apce_w.apce109 = g_apce_d[l_ac].apce109 THEN
                     CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
                  ELSE
                     CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",TRUE)
                  END IF
               ELSE
                  CALL cl_set_comp_entry("apce103,apce104,apce113,apce114,apce123,apce124,apce133,apce134",FALSE)
               END IF
            END IF
            #160628-00002#2--add--end 
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
 
 
            #其他table進行lock
            
 
 
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
            ELSE
               #add-point:單身3ask刪除前 name="input.body3.b_delete_ask"
               
               #end add-point 
            
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身3刪除前 name="input.body3.b_delete"
               
               #end add-point 
               
               DELETE FROM apce_t
                WHERE apceent = g_enterprise AND
                  apceld = g_apce3_d_t.apceld
                  AND apcedocno = g_apce3_d_t.apcedocno
                  AND apceseq = g_apce3_d_t.apceseq
                  
               #add-point:單身3刪除中 name="input.body3.m_delete"
               
               #end add-point 
                  
               IF SQLCA.SQLCODE THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
                  LET g_errparam.code = SQLCA.SQLCODE
                  LET g_errparam.popup = TRUE 
                  CALL cl_err()
                  CANCEL DELETE   
               ELSE
                  LET g_detail_cnt = g_detail_cnt-1
                  
 
 
 
                  #add-point:單身3刪除後 name="input.body3.a_delete"
                  
                  #end add-point
                  #修改歷程記錄(刪除)
                  CALL aapt300_02_set_pk_array()
                  LET g_log1 = util.JSON.stringify(g_apce3_d[l_ac])   #(ver:38)
                  IF NOT cl_log_modified_record(g_log1,'') THEN    #(ver:38)
                  ELSE
                  END IF
               END IF 
               CLOSE aapt300_02_bcl
               #add-point:單身3刪除關閉bcl name="input.body3.close"
               
               #end add-point
               LET l_count = g_apce_d.getLength()
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce3_d_t.apceld
               LET gs_keys[2] = g_apce3_d_t.apcedocno
               LET gs_keys[3] = g_apce3_d_t.apceseq
 
               #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL aapt300_02_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
 
            END IF 
            
         AFTER DELETE 
            IF l_cmd <> 'd' THEN
               #add-point:單身刪除後2 name="input.body3.after_delete"
               
               #end add-point
                              CALL aapt300_02_delete_b('apce_t',gs_keys,"'3'")
            END IF
            #如果是最後一筆
            IF l_ac = (g_apce3_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
            #add-point:單身刪除後3 name="input.body3.after_delete3"
            
            #end add-point
 
         AFTER INSERT    
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM apce_t 
             WHERE apceent = g_enterprise AND
                   apceld = g_apce3_d[l_ac].apceld
                   AND apcedocno = g_apce3_d[l_ac].apcedocno
                   AND apceseq = g_apce3_d[l_ac].apceseq
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身3新增前 name="input.body3.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce3_d[g_detail_idx].apceld
               LET gs_keys[2] = g_apce3_d[g_detail_idx].apcedocno
               LET gs_keys[3] = g_apce3_d[g_detail_idx].apceseq
               CALL aapt300_02_insert_b('apce_t',gs_keys,"'3'")
                           
               #add-point:單身新增後3 name="input.body3.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_apce_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLCODE THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
               LET g_errparam.code = SQLCA.SQLCODE
               LET g_errparam.popup = TRUE 
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aapt300_02_b_fill(g_wc2)
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body3.after_insert"
               
               #end add-point
               ##ERROR 'INSERT O.K'
               LET g_detail_cnt = g_detail_cnt + 1
               LET g_wc2 = g_wc2, " OR (apceld = '", g_apce3_d[l_ac].apceld, "' "
                                  ," AND apcedocno = '", g_apce3_d[l_ac].apcedocno, "' "
                                  ," AND apceseq = '", g_apce3_d[l_ac].apceseq, "' "
                                  ,")"
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               LET g_apce3_d[l_ac].* = g_apce3_d_t.*
               CLOSE aapt300_02_bcl
               #add-point:單身page3取消後 name="input.body3.cancel"
               
               #end add-point
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_apce3_d[l_ac].* = g_apce3_d_t.*
            ELSE
               
               #寫入修改者/修改日期資訊(單身3)
               
               
               #add-point:單身page3修改前 name="input.body3.b_update"
               
               #end add-point
               
               #將遮罩欄位還原
               CALL aapt300_02_apce_t_mask_restore('restore_mask_o')
               
               UPDATE apce_t SET (apcedocno,apceld,apceseq,apce002,apceorga,apce003,apce004,apce005, 
                   apce048,apce015,apce016,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119, 
                   apce027,apce011,apce010,apce024,apce038,apce031,apcecomp,apcesite,apce001,apce017, 
                   apce018,apce019,apce020,apce022,apce023,apce035,apce036,apce044,apce045,apce046,apce051, 
                   apce052,apce053,apce054,apce055,apce056,apce057,apce058,apce059,apce060,apce120,apce121, 
                   apce123,apce124,apce129,apce130,apce131,apce133,apce134,apce139) = (g_apce_d[l_ac].apcedocno, 
                   g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga, 
                   g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048, 
                   g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101, 
                   g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113, 
                   g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119,g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011, 
                   g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024,g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031, 
                   g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite,g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apce017, 
                   g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce022, 
                   g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044, 
                   g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051,g_apce2_d[l_ac].apce052, 
                   g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056, 
                   g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060, 
                   g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
                   g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
                   g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139) #自訂欄位頁簽
                WHERE apceent = g_enterprise AND
                  apceld = g_apce3_d_t.apceld #項次 
                  AND apcedocno = g_apce3_d_t.apcedocno
                  AND apceseq = g_apce3_d_t.apceseq
                  
               #add-point:單身page3修改中 name="input.body3.m_update"
               
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "apce_t" 
                     LET g_errparam.code = "std-00009" 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                  WHEN SQLCA.SQLCODE #其他錯誤
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
                     LET g_errparam.code = SQLCA.SQLCODE 
                     LET g_errparam.popup = TRUE 
                     CALL cl_err()
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce3_d[g_detail_idx].apceld
               LET gs_keys_bak[1] = g_apce3_d_t.apceld
               LET gs_keys[2] = g_apce3_d[g_detail_idx].apcedocno
               LET gs_keys_bak[2] = g_apce3_d_t.apcedocno
               LET gs_keys[3] = g_apce3_d[g_detail_idx].apceseq
               LET gs_keys_bak[3] = g_apce3_d_t.apceseq
               CALL aapt300_02_update_b('apce_t',gs_keys,gs_keys_bak,"'3'")
                     #資料多語言用-增/改
                     
                     
                     #修改歷程記錄(修改)
                     LET g_log1 = util.JSON.stringify(g_apce3_d_t)
                     LET g_log2 = util.JSON.stringify(g_apce3_d[l_ac])
                     IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                     END IF
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aapt300_02_apce_t_mask_restore('restore_mask_n')
               
               #add-point:單身page3修改後 name="input.body3.a_update"
               
               #end add-point
            END IF
         
                  #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce121
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce3_d[l_ac].apce121,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce121
            END IF 
 
 
 
            #add-point:AFTER FIELD apce121 name="input.a.page3.apce121"
            IF NOT cl_null(g_apce3_d[l_ac].apce121) THEN 
            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce121
            #add-point:BEFORE FIELD apce121 name="input.b.page3.apce121"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce121
            #add-point:ON CHANGE apce121 name="input.g.page3.apce121"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce123
            #add-point:BEFORE FIELD apce123 name="input.b.page3.apce123"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce123
            
            #add-point:AFTER FIELD apce123 name="input.a.page3.apce123"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce3_d[l_ac].apce123) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce3_d[l_ac].apce123 <> g_apce3_d_t.apce123) THEN
                  IF g_apce3_d[l_ac].apce123 > r_apce_w.apce123 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce3_d[l_ac].apce123,'>', r_apce_w.apce123
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce3_d[l_ac].apce123 = g_apce3_d_t.apce123
                     NEXT FIELD apce123
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce3_d[l_ac].apce123 = r_apce_w.apce123 THEN
                        LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                        LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                        ELSE
                           LET g_apce3_d[l_ac].apce129 = g_apce3_d[l_ac].apce123 + g_apce3_d[l_ac].apce124
                        END IF
                     END IF 
                  END IF   
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce123
            #add-point:ON CHANGE apce123 name="input.g.page3.apce123"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce124
            #add-point:BEFORE FIELD apce124 name="input.b.page3.apce124"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce124
            
            #add-point:AFTER FIELD apce124 name="input.a.page3.apce124"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce3_d[l_ac].apce124) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce3_d[l_ac].apce124 <> g_apce3_d_t.apce124) THEN
                  IF g_apce3_d[l_ac].apce124 > r_apce_w.apce124 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce3_d[l_ac].apce124,'>', r_apce_w.apce124
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce3_d[l_ac].apce124 = g_apce3_d_t.apce124
                     NEXT FIELD apce124
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce3_d[l_ac].apce124 = r_apce_w.apce124 THEN
                        LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                        LET g_apce3_d[l_ac].apce129 = r_apce_w.apce129
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                        ELSE
                           LET g_apce3_d[l_ac].apce129 = g_apce3_d[l_ac].apce123 + g_apce3_d[l_ac].apce124
                        END IF
                     END IF 
                  END IF   
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce124
            #add-point:ON CHANGE apce124 name="input.g.page3.apce124"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce129
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce3_d[l_ac].apce129,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce129
            END IF 
 
 
 
            #add-point:AFTER FIELD apce129 name="input.a.page3.apce129"
            IF NOT cl_null(g_apce3_d[l_ac].apce129) THEN 
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce3_d[l_ac].apce129 != g_apce3_d_t.apce129 OR g_apce3_d_t.apce129 IS NULL )) THEN
                  #檢核金額不可超出可沖金額
                  CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                               g_apce3_d[l_ac].apce129,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','2')
                     RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce3_d[l_ac].apce129 = g_apce3_d_t.apce129
                     DISPLAY BY NAME g_apce3_d[l_ac].apce129
                     NEXT FIELD CURRENT
                  END IF 
#160628-00002#2--mark--str--                  
#                  INITIALIZE l_apcc_used.* TO NULL
#                  CALL s_aapt420_apcc_used_num(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
#                  g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1')
#                      RETURNING g_sub_success,g_errno,l_apcc_used.apcc10x,l_apcc_used.apcc12x,l_apcc_used.apcc12x,l_apcc_used.apcc13x
#                                             
#                  IF l_apcc_used.apcc10x = g_apce_d[l_ac].apce109 THEN
#                     LET g_apce3_d[l_ac].apce129 = l_apcc_used.apcc12x                     
#                  END IF
#                  IF l_apcc_used.apcc12x = g_apce3_d[l_ac].apce129 THEN
#                     LET g_apce_d[l_ac].apce109 = l_apcc_used.apcc10x                     
#                  END IF       
#                  DISPLAY BY NAME g_apce_d[l_ac].apce109,g_apce3_d[l_ac].apce129  
#160628-00002#2--mark--end
                  #160628-00002#2--add--str--
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce3_d[l_ac].apce129 = r_apce_w.apce129 THEN
                        LET g_apce3_d[l_ac].apce123 = r_apce_w.apce123
                        LET g_apce3_d[l_ac].apce124 = r_apce_w.apce124
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce124
                        ELSE
                           LET g_apce3_d[l_ac].apce124 = g_apce3_d[l_ac].apce129 - g_apce3_d[l_ac].apce123
                        END IF
                     END IF
                  ELSE
                     LET g_apce3_d[l_ac].apce123 = g_apce3_d[l_ac].apce129
                     LET g_apce3_d[l_ac].apce123 = 0
                  END IF
                  #160628-00002#2--add--end
               END IF
            END IF
            LET g_apce3_d_t.apce129 = g_apce3_d[l_ac].apce129 

            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce129
            #add-point:BEFORE FIELD apce129 name="input.b.page3.apce129"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end 
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce129
            #add-point:ON CHANGE apce129 name="input.g.page3.apce129"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce131
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce3_d[l_ac].apce131,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce131
            END IF 
 
 
 
            #add-point:AFTER FIELD apce131 name="input.a.page3.apce131"
            IF NOT cl_null(g_apce3_d[l_ac].apce131) THEN 
            END IF 


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce131
            #add-point:BEFORE FIELD apce131 name="input.b.page3.apce131"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce131
            #add-point:ON CHANGE apce131 name="input.g.page3.apce131"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce133
            #add-point:BEFORE FIELD apce133 name="input.b.page3.apce133"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce133
            
            #add-point:AFTER FIELD apce133 name="input.a.page3.apce133"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce3_d[l_ac].apce133) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce3_d[l_ac].apce133 <> g_apce3_d_t.apce133) THEN
                  IF g_apce3_d[l_ac].apce133 > r_apce_w.apce133 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce3_d[l_ac].apce133,'>', r_apce_w.apce133
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce3_d[l_ac].apce133 = g_apce3_d_t.apce133
                     NEXT FIELD apce133
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce3_d[l_ac].apce133 = r_apce_w.apce133 THEN
                        LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                        LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                        ELSE
                           LET g_apce3_d[l_ac].apce139 = g_apce3_d[l_ac].apce133 + g_apce3_d[l_ac].apce134
                        END IF
                     END IF 
                  END IF   
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce133
            #add-point:ON CHANGE apce133 name="input.g.page3.apce133"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce134
            #add-point:BEFORE FIELD apce134 name="input.b.page3.apce134"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end 
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce134
            
            #add-point:AFTER FIELD apce134 name="input.a.page3.apce134"
            #160628-00002#2--add--str--
            IF NOT cl_null(g_apce3_d[l_ac].apce134) THEN
               IF l_cmd='a' OR (l_cmd='u' AND g_apce3_d[l_ac].apce134 <> g_apce3_d_t.apce134) THEN
                  IF g_apce3_d[l_ac].apce134 > r_apce_w.apce134 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'axr-00054'
                     LET g_errparam.extend = g_apce3_d[l_ac].apce134,'>', r_apce_w.apce134
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce3_d[l_ac].apce134 = g_apce3_d_t.apce134
                     NEXT FIELD apce134
                  END IF
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce3_d[l_ac].apce134 = r_apce_w.apce134 THEN
                        LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                        LET g_apce3_d[l_ac].apce139 = r_apce_w.apce139
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                        ELSE
                           LET g_apce3_d[l_ac].apce139 = g_apce3_d[l_ac].apce133 + g_apce3_d[l_ac].apce134
                        END IF
                     END IF 
                  END IF   
               END IF
            END IF
            #160628-00002#2--add--end
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce134
            #add-point:ON CHANGE apce134 name="input.g.page3.apce134"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apce139
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_apce3_d[l_ac].apce139,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD apce139
            END IF 
 
 
 
            #add-point:AFTER FIELD apce139 name="input.a.page3.apce139"
            IF NOT cl_null(g_apce3_d[l_ac].apce139) THEN 
               IF l_cmd = 'a' OR (l_cmd = 'u' AND (g_apce3_d[l_ac].apce139 != g_apce3_d_t.apce139 OR g_apce3_d_t.apce139 IS NULL )) THEN
                  #檢核金額不可超出可沖金額
                  CALL s_aapt420_apcc_used_chk(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
                                               g_apce3_d[l_ac].apce139,g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1','3')
                     RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_apce3_d[l_ac].apce139 = g_apce3_d_t.apce139
                     DISPLAY BY NAME g_apce3_d[l_ac].apce139
                     NEXT FIELD CURRENT
                  END IF 
#160628-00002#2--mark--str--
#                  INITIALIZE l_apcc_used.* TO NULL
#                  CALL s_aapt420_apcc_used_num(g_apce_d[l_ac].apce002,g_apca.apcald,l_apceorga_ld,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005,
#                  g_apca.apcadocno,g_apce_d[l_ac].apceseq,'1')
#                      RETURNING g_sub_success,g_errno,l_apcc_used.apcc10x,l_apcc_used.apcc13x,l_apcc_used.apcc13x,l_apcc_used.apcc13x
#                                             
#                  IF l_apcc_used.apcc10x = g_apce_d[l_ac].apce109 THEN
#                     LET g_apce3_d[l_ac].apce139 = l_apcc_used.apcc13x                     
#                  END IF
#                  IF l_apcc_used.apcc13x = g_apce3_d[l_ac].apce139 THEN
#                     LET g_apce_d[l_ac].apce109 = l_apcc_used.apcc10x                     
#                  END IF       
#                  DISPLAY BY NAME g_apce_d[l_ac].apce109,g_apce3_d[l_ac].apce139  
#160628-00002#2--mark--end
                  #160628-00002#2--add--str--
                  IF g_apce_d[l_ac].apce027 = 'Y' THEN
                     #全部冲销
                     IF g_apce3_d[l_ac].apce139 = r_apce_w.apce139 THEN
                        LET g_apce3_d[l_ac].apce133 = r_apce_w.apce133
                        LET g_apce3_d[l_ac].apce134 = r_apce_w.apce134
                     ELSE
                     #部分冲销
                        IF l_oodb005 = 'Y' THEN
                           LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce134
                        ELSE
                           LET g_apce3_d[l_ac].apce134 = g_apce3_d[l_ac].apce139 - g_apce3_d[l_ac].apce133
                        END IF
                     END IF
                  ELSE
                     LET g_apce3_d[l_ac].apce133 = g_apce3_d[l_ac].apce139
                     LET g_apce3_d[l_ac].apce133 = 0
                  END IF 
                  #160628-00002#2--add--end
               END IF
            END IF
            LET g_apce3_d_t.apce139 = g_apce3_d[l_ac].apce139 
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apce139
            #add-point:BEFORE FIELD apce139 name="input.b.page3.apce139"
            #160628-00002#2--add--str--
            IF g_apce_d[l_ac].apce027 = 'Y' THEN
               SELECT apca011 INTO l_apca011 FROM apca_t 
               WHERE apcaent=g_enterprise AND apcald=g_apca.apcald AND apcadocno=g_apce_d[l_ac].apce003
               #根據單身稅別-含稅否 
               CALL s_tax_chk(g_glaa.glaacomp,l_apca011) 
                   RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
            END IF
            #160628-00002#2--add--end 
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apce139
            #add-point:ON CHANGE apce139 name="input.g.page3.apce139"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page3.apce121
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce121
            #add-point:ON ACTION controlp INFIELD apce121 name="input.c.page3.apce121"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce123
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce123
            #add-point:ON ACTION controlp INFIELD apce123 name="input.c.page3.apce123"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce124
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce124
            #add-point:ON ACTION controlp INFIELD apce124 name="input.c.page3.apce124"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce129
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce129
            #add-point:ON ACTION controlp INFIELD apce129 name="input.c.page3.apce129"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce131
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce131
            #add-point:ON ACTION controlp INFIELD apce131 name="input.c.page3.apce131"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce133
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce133
            #add-point:ON ACTION controlp INFIELD apce133 name="input.c.page3.apce133"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce134
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce134
            #add-point:ON ACTION controlp INFIELD apce134 name="input.c.page3.apce134"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.apce139
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apce139
            #add-point:ON ACTION controlp INFIELD apce139 name="input.c.page3.apce139"
            
            #END add-point
 
 
 
 
         AFTER ROW
            LET l_ac = ARR_CURR()
            LET l_ac_t = l_ac
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_apce3_d[l_ac].* = g_apce3_d_t.*
               END IF
               CLOSE aapt300_02_bcl
               #add-point:單身after row name="input.body3.a_close"
               
               #end add-point
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
 
            CALL aapt300_02_unlock_b("apce_t")
            #add-point:單身after row name="input.body3.a_row"
            CALL aapt300_02_sum_page_show()
            #end add-point
            
         AFTER INPUT
            #add-point:單身3input後 name="input.body3.a_input"
            #重算帳款單頭
            CALL s_transaction_begin()
            CALL aapt300_02_clac_bill_master() RETURNING g_sub_success
            IF g_sub_success THEN 
               CALL s_transaction_end('Y','0')
            ELSE
               CALL s_transaction_end('N','0')
            END IF     
            IF g_glaa.glaa121 = 'Y' AND g_dfin0030 = 'Y'THEN
               CALL s_transaction_begin()
               CALL s_pre_voucher_ins('AP','P10',g_apca.apcald,g_apca.apcadocno,g_apca.apcadocdt,'1')
                    RETURNING g_sub_success
               IF g_sub_success THEN 
                  CALL s_transaction_end('Y','0')
               ELSE
                  CALL s_transaction_end('N','0')
               END IF
            END IF
            #end add-point
         
         #複製上一次指定的單身資料至最下方
         ON ACTION controlo   
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_apce_d[li_reproduce_target].* = g_apce_d[li_reproduce].*
               LET g_apce2_d[li_reproduce_target].* = g_apce2_d[li_reproduce].*
               LET g_apce3_d[li_reproduce_target].* = g_apce3_d[li_reproduce].*
 
               LET g_apce3_d[li_reproduce_target].apceld = NULL
               LET g_apce3_d[li_reproduce_target].apcedocno = NULL
               LET g_apce3_d[li_reproduce_target].apceseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_apce3_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_apce3_d.getLength()+1
            END IF
      END INPUT
 
      
 
      
      #add-point:before_more_input name="input.more_input"
      
      #end add-point
      
      BEFORE DIALOG
         #CALL cl_err_collect_init()      
         IF g_temp_idx > 0 THEN
            LET l_ac = g_temp_idx
            CALL DIALOG.setCurrentRow("s_detail1",l_ac)
            LET g_temp_idx = 1
         END IF
         #LET g_curr_diag = ui.DIALOG.getCurrent()
         #add-point:before_dialog name="input.before_dialog"
         
         #end add-point
         CASE g_aw
            WHEN "s_detail1"
               NEXT FIELD apcedocno
            WHEN "s_detail2"
               NEXT FIELD apcedocno_2
            WHEN "s_detail3"
               NEXT FIELD apcedocno_3
 
         END CASE
   
      ON ACTION accept
         ACCEPT DIALOG
      
      ON ACTION cancel
         LET INT_FLAG = TRUE 
         CANCEL DIALOG
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) 
              RETURNING g_fld_name,g_frm_name 
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) 
           
      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG
   
   END DIALOG 
    
   #新增後取消
   IF l_cmd = 'a' THEN
      #當取消或無輸入資料按確定時刪除對應資料
      IF INT_FLAG OR cl_null(g_apce_d[g_detail_idx].apceld) THEN
         CALL g_apce_d.deleteElement(g_detail_idx)
         CALL g_apce2_d.deleteElement(g_detail_idx)
         CALL g_apce3_d.deleteElement(g_detail_idx)
 
      END IF
   END IF
   
   #修改後取消
   IF l_cmd = 'u' AND INT_FLAG THEN
      LET g_apce_d[g_detail_idx].* = g_apce_d_t.*
   END IF
   
   #add-point:modify段修改後 name="modify.after_input"
#150512-00036#1--(s)
   IF l_flag = 'Y' THEN
      CONTINUE WHILE
   ELSE
      EXIT WHILE
   END IF
   
END WHILE   
#150512-00036#1--(e)
   #end add-point
 
   CLOSE aapt300_02_bcl
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.delete" >}
#+ 資料刪除
PRIVATE FUNCTION aapt300_02_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"
   
   #end add-point
   DEFINE li_idx          LIKE type_t.num10
   DEFINE li_ac_t         LIKE type_t.num10
   DEFINE li_detail_tmp   LIKE type_t.num10
   DEFINE l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak  DYNAMIC ARRAY OF STRING
   DEFINE l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE l_vars          DYNAMIC ARRAY OF STRING
   DEFINE l_fields        DYNAMIC ARRAY OF STRING
   #add-point:delete段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
   
   #end add-point 
   
   #add-point:Function前置處理  name="delete.body.before_delete"
   CALL s_transaction_begin()  #150419
   #end add-point
   
   CALL s_transaction_begin()
   
   LET li_ac_t = l_ac
   
   LET li_detail_tmp = g_detail_idx
    
   #lock所有所選資料
   FOR li_idx = 1 TO g_apce_d.getLength()
      LET g_detail_idx = li_idx
      #已選擇的資料
      IF g_curr_diag.isRowSelected(g_curr_diag.getCurrentItem(), li_idx) THEN 
         #確定是否有被鎖定
         IF NOT aapt300_02_lock_b("apce_t") THEN
            #已被他人鎖定
            RETURN
         END IF
 
         #(ver:35) ---add start---
         #確定是否有刪除的權限
         #先確定該table有ownid
         IF cl_getField("apce_t","") THEN
            IF NOT cl_auth_chk_act_permission("delete") THEN
               #有目前權限無法刪除的資料
               RETURN
            END IF
         END IF
         #(ver:35) --- add end ---
      END IF
   END FOR
   
   #add-point:單身刪除詢問前 name="delete.body.b_delete_ask"
   
   #end add-point  
   
   #詢問是否確定刪除所選資料
   IF NOT cl_ask_del_detail() THEN
      RETURN
   END IF
   
   FOR li_idx = 1 TO g_apce_d.getLength()
      IF g_apce_d[li_idx].apceld IS NOT NULL
         AND g_apce_d[li_idx].apcedocno IS NOT NULL
         AND g_apce_d[li_idx].apceseq IS NOT NULL
 
         AND g_curr_diag.isRowSelected(g_curr_diag.getCurrentItem(), li_idx) THEN 
         
         #add-point:單身刪除前 name="delete.body.b_delete"
         
         #end add-point   
         
         DELETE FROM apce_t
          WHERE apceent = g_enterprise AND 
                apceld = g_apce_d[li_idx].apceld
                AND apcedocno = g_apce_d[li_idx].apcedocno
                AND apceseq = g_apce_d[li_idx].apceseq
 
         #add-point:單身刪除中 name="delete.body.m_delete"
         
         #end add-point  
                
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE
            LET g_errparam.popup = TRUE 
            CALL cl_err()
            RETURN
         ELSE
            LET g_detail_cnt = g_detail_cnt-1
            LET l_ac = li_idx
            
 
 
 
            
 
 
 
            
 
 
 
 
            
 
 
 
            
 
 
 
            
 
 
 
 
            #add-point:單身同步刪除前(同層table) name="delete.body.a_delete"
            
            #end add-point
            LET g_detail_idx = li_idx
                           INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_apce_d_t.apceld
               LET gs_keys[2] = g_apce_d_t.apcedocno
               LET gs_keys[3] = g_apce_d_t.apceseq
 
            #add-point:單身同步刪除中(同層table) name="delete.body.a_delete2"
            
            #end add-point
                           CALL aapt300_02_delete_b('apce_t',gs_keys,"'1'")
            #add-point:單身同步刪除後(同層table) name="delete.body.a_delete3"
            
            #end add-point
            #刪除相關文件
            #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL aapt300_02_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove.func"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
 
            
         END IF 
      END IF 
    
   END FOR
   
   LET g_detail_idx = li_detail_tmp
            
   #add-point:單身刪除後 name="delete.after"
   CALL s_transaction_end('Y','0')  #150419
   #重算帳款單頭
   CALL s_transaction_begin()
   CALL aapt300_02_clac_bill_master() RETURNING g_sub_success
   IF g_sub_success THEN 
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF  
   #end add-point  
   
   LET l_ac = li_ac_t
   
   #刷新資料
   CALL aapt300_02_b_fill(g_wc2)
            
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION aapt300_02_b_fill(p_wc2)              #BODY FILL UP
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point
   DEFINE p_wc2            STRING
   DEFINE ls_owndept_list  STRING  #(ver:35) add
   DEFINE ls_ownuser_list  STRING  #(ver:35) add
   #add-point:b_fill段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="b_fill.pre_function"
   
   #end add-point
   
   IF cl_null(p_wc2) THEN
      LET p_wc2 = " 1=1"
   END IF
   
   #add-point:b_fill段sql之前 name="b_fill.sql_before"
   LET p_wc2 = " apceld = '",g_apcald,"' AND apcedocno = '",g_apcadocno,"'"
   #end add-point
 
   LET g_sql = "SELECT  DISTINCT t0.apcedocno,t0.apceld,t0.apceseq,t0.apce002,t0.apceorga,t0.apce003, 
       t0.apce004,t0.apce005,t0.apce048,t0.apce015,t0.apce016,t0.apce100,t0.apce101,t0.apce103,t0.apce104, 
       t0.apce109,t0.apce113,t0.apce114,t0.apce119,t0.apce027,t0.apce011,t0.apce010,t0.apce024,t0.apce038, 
       t0.apce031,t0.apcecomp,t0.apcesite,t0.apce001,t0.apcedocno,t0.apceld,t0.apceseq,t0.apce017,t0.apce018, 
       t0.apce019,t0.apce020,t0.apce022,t0.apce023,t0.apce035,t0.apce036,t0.apce044,t0.apce045,t0.apce046, 
       t0.apce051,t0.apce052,t0.apce053,t0.apce054,t0.apce055,t0.apce056,t0.apce057,t0.apce058,t0.apce059, 
       t0.apce060,t0.apcedocno,t0.apceld,t0.apceseq,t0.apce120,t0.apce121,t0.apce123,t0.apce124,t0.apce129, 
       t0.apce130,t0.apce131,t0.apce133,t0.apce134,t0.apce139  FROM apce_t t0",
               "",
               
               " WHERE t0.apceent= ?  AND  1=1 AND (", p_wc2, ") "
 
   #(ver:35) ---add start---
   
   #(ver:35) --- add end ---
 
   #add-point:b_fill段sql wc name="b_fill.sql_wc"
   
   #end add-point
   LET g_sql = g_sql, cl_sql_add_filter("apce_t"),
                      " ORDER BY t0.apceld,t0.apcedocno,t0.apceseq"
   
   #add-point:b_fill段sql之後 name="b_fill.sql_after"
   
   #end add-point
   
   #LET g_sql = cl_sql_add_tabid(g_sql,"apce_t")            #WC重組
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   PREPARE aapt300_02_pb FROM g_sql
   DECLARE b_fill_curs CURSOR FOR aapt300_02_pb
   
   OPEN b_fill_curs USING g_enterprise
 
   CALL g_apce_d.clear()
   CALL g_apce2_d.clear()   
   CALL g_apce3_d.clear()   
 
 
   LET g_cnt = l_ac
   LET l_ac = 1   
   ERROR "Searching!" 
 
   FOREACH b_fill_curs INTO g_apce_d[l_ac].apcedocno,g_apce_d[l_ac].apceld,g_apce_d[l_ac].apceseq,g_apce_d[l_ac].apce002, 
       g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004,g_apce_d[l_ac].apce005, 
       g_apce_d[l_ac].apce048,g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016,g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101, 
       g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104,g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114, 
       g_apce_d[l_ac].apce119,g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024, 
       g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031,g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite, 
       g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apcedocno,g_apce2_d[l_ac].apceld,g_apce2_d[l_ac].apceseq, 
       g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019,g_apce2_d[l_ac].apce020, 
       g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035,g_apce2_d[l_ac].apce036, 
       g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046,g_apce2_d[l_ac].apce051, 
       g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054,g_apce2_d[l_ac].apce055, 
       g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058,g_apce2_d[l_ac].apce059, 
       g_apce2_d[l_ac].apce060,g_apce3_d[l_ac].apcedocno,g_apce3_d[l_ac].apceld,g_apce3_d[l_ac].apceseq, 
       g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121,g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124, 
       g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130,g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133, 
       g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH b_fill_curs:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF
  
      #add-point:b_fill段資料填充 name="b_fill.fill"
      #帳款其他訊息
      LET g_apce2_d[l_ac].apce0022 = g_apce_d[l_ac].apce002        
      LET g_apce2_d[l_ac].apce0152 = g_apce_d[l_ac].apce015
      LET g_apce_d[l_ac].apce016_desc  = s_desc_get_account_desc(g_apca.apcald,g_apce_d[l_ac].apce016)  #150209-00008#9
      LET g_apce2_d[l_ac].apce0162 = g_apce_d[l_ac].apce016                                             #150209-00008#9
      LET g_apce2_d[l_ac].apce0162_desc = s_desc_show1(g_apce2_d[l_ac].apce0162,s_desc_get_account_desc(g_apca.apcald,g_apce2_d[l_ac].apce0162))
      DISPLAY BY NAME g_apce2_d[l_ac].apce0162_desc     
      LET g_apce3_d[l_ac].apce0033 = g_apce_d[l_ac].apce003         
      LET g_apce3_d[l_ac].apce0043 = g_apce_d[l_ac].apce004
      LET g_apce3_d[l_ac].apce0053 = g_apce_d[l_ac].apce005
      #固定核算項
      LET g_apce2_d[l_ac].apce017_desc = s_desc_show1(g_apce2_d[l_ac].apce017,s_desc_get_person_desc(g_apce2_d[l_ac].apce017))                  
      LET g_apce2_d[l_ac].apce018_desc = s_desc_show1(g_apce2_d[l_ac].apce018,s_desc_get_department_desc(g_apce2_d[l_ac].apce018))         
      LET g_apce2_d[l_ac].apce019_desc = s_desc_show1(g_apce2_d[l_ac].apce019,s_desc_get_department_desc(g_apce2_d[l_ac].apce019))         
      LET g_apce2_d[l_ac].apce020_desc = s_desc_show1(g_apce2_d[l_ac].apce020,s_desc_get_rtaxl003_desc(g_apce2_d[l_ac].apce020))      
      LET g_apce2_d[l_ac].apce022_desc = s_desc_show1(g_apce2_d[l_ac].apce022,s_desc_get_project_desc(g_apce2_d[l_ac].apce022))      
      LET g_apce2_d[l_ac].apce023_desc = s_desc_show1(g_apce2_d[l_ac].apce023,s_desc_get_pjbbl004_desc(g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023))
      LET g_apce2_d[l_ac].apce035_desc = s_desc_show1(g_apce2_d[l_ac].apce035,s_desc_get_acc_desc('287',g_apce2_d[l_ac].apce035))      
      LET g_apce2_d[l_ac].apce036_desc = s_desc_show1(g_apce2_d[l_ac].apce036,s_desc_get_acc_desc('281',g_apce2_d[l_ac].apce036))             
      LET g_apce2_d[l_ac].apce045_desc = s_desc_show1(g_apce2_d[l_ac].apce045,s_desc_get_oojdl003_desc(g_apce2_d[l_ac].apce045))      
      LET g_apce2_d[l_ac].apce046_desc = s_desc_show1(g_apce2_d[l_ac].apce046,s_desc_get_acc_desc('2002',g_apce2_d[l_ac].apce046))      
      DISPLAY BY NAME g_apce2_d[l_ac].apce017_desc,g_apce2_d[l_ac].apce018_desc,g_apce2_d[l_ac].apce019_desc,g_apce2_d[l_ac].apce020_desc,g_apce2_d[l_ac].apce035_desc,
                      g_apce2_d[l_ac].apce036_desc

      #取得自由核算項類型
      CALL s_fin_sel_glad(g_apca.apcald,g_apce_d[l_ac].apce016,'glad0171|glad0172|glad0181|glad0182|glad0191|glad0192|glad0201|glad0202|glad0211|glad0212|glad0221|glad0222|glad0231|glad0232|glad0241|glad0242|glad0251|glad0252|glad0261|glad0262') 
           RETURNING g_errno,g_glad.*        
      IF NOT cl_null(g_apce2_d[l_ac].apce051) THEN
         LET g_apce2_d[l_ac].apce051_desc = s_desc_show1(g_apce2_d[l_ac].apce051,s_fin_get_accting_desc(g_glad.glad0171,g_apce2_d[l_ac].apce051))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce052) THEN
         LET g_apce2_d[l_ac].apce052_desc = s_desc_show1(g_apce2_d[l_ac].apce052,s_fin_get_accting_desc(g_glad.glad0181,g_apce2_d[l_ac].apce052))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce053) THEN
         LET g_apce2_d[l_ac].apce053_desc = s_desc_show1(g_apce2_d[l_ac].apce053,s_fin_get_accting_desc(g_glad.glad0191,g_apce2_d[l_ac].apce053))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce054) THEN
         LET g_apce2_d[l_ac].apce054_desc = s_desc_show1(g_apce2_d[l_ac].apce054,s_fin_get_accting_desc(g_glad.glad0201,g_apce2_d[l_ac].apce054))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce055) THEN
         LET g_apce2_d[l_ac].apce055_desc = s_desc_show1(g_apce2_d[l_ac].apce055,s_fin_get_accting_desc(g_glad.glad0211,g_apce2_d[l_ac].apce055))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce056) THEN
         LET g_apce2_d[l_ac].apce056_desc = s_desc_show1(g_apce2_d[l_ac].apce056,s_fin_get_accting_desc(g_glad.glad0221,g_apce2_d[l_ac].apce056))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce057) THEN
         LET g_apce2_d[l_ac].apce057_desc = s_desc_show1(g_apce2_d[l_ac].apce057,s_fin_get_accting_desc(g_glad.glad0231,g_apce2_d[l_ac].apce057))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce058) THEN
         LET g_apce2_d[l_ac].apce058_desc = s_desc_show1(g_apce2_d[l_ac].apce058,s_fin_get_accting_desc(g_glad.glad0241,g_apce2_d[l_ac].apce058))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce059) THEN
         LET g_apce2_d[l_ac].apce059_desc = s_desc_show1(g_apce2_d[l_ac].apce059,s_fin_get_accting_desc(g_glad.glad0251,g_apce2_d[l_ac].apce059))
      END IF
      IF NOT cl_null(g_apce2_d[l_ac].apce060) THEN
         LET g_apce2_d[l_ac].apce060_desc = s_desc_show1(g_apce2_d[l_ac].apce060,s_fin_get_accting_desc(g_glad.glad0261,g_apce2_d[l_ac].apce060))  
      END IF
      #帳款其他本位幣                       
      LET g_apce3_d[l_ac].apce0023 = g_apce_d[l_ac].apce002
      LET g_apce3_d[l_ac].apce1003 = g_apce_d[l_ac].apce100
      LET g_apce3_d[l_ac].apce1093 = g_apce_d[l_ac].apce109
      LET g_apce3_d[l_ac].apce1013 = g_apce_d[l_ac].apce101
      LET g_apce3_d[l_ac].apce1193 = g_apce_d[l_ac].apce119
      #帶說明
      LET g_apce_d[l_ac].apceorga_desc = s_desc_get_department_desc(g_apce_d[l_ac].apceorga)
      LET g_apce_d[l_ac].apce011_desc = s_desc_get_acc_desc('3113',g_apce_d[l_ac].apce011)
      LET g_apce_d[l_ac].apce038_desc = s_desc_get_trading_partner_abbr_desc(g_apce_d[l_ac].apce038)      
      #end add-point
      
      CALL aapt300_02_detail_show()      
 
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
         END IF
         EXIT FOREACH
      END IF
 
      LET l_ac = l_ac + 1
      
   END FOREACH
 
   LET g_error_show = 0
   
 
   
   CALL g_apce_d.deleteElement(g_apce_d.getLength())   
   CALL g_apce2_d.deleteElement(g_apce2_d.getLength())
   CALL g_apce3_d.deleteElement(g_apce3_d.getLength())
 
   
   #將key欄位填到每個page
   FOR l_ac = 1 TO g_apce_d.getLength()
      LET g_apce2_d[l_ac].apceld = g_apce_d[l_ac].apceld 
      LET g_apce2_d[l_ac].apcedocno = g_apce_d[l_ac].apcedocno 
      LET g_apce2_d[l_ac].apceseq = g_apce_d[l_ac].apceseq 
      LET g_apce3_d[l_ac].apceld = g_apce_d[l_ac].apceld 
      LET g_apce3_d[l_ac].apcedocno = g_apce_d[l_ac].apcedocno 
      LET g_apce3_d[l_ac].apceseq = g_apce_d[l_ac].apceseq 
 
      #add-point:b_fill段key值相關欄位 name="b_fill.keys.fill"
      
      #end add-point
   END FOR
   
   IF g_cnt > g_apce_d.getLength() THEN
      LET l_ac = g_apce_d.getLength()
   ELSE
      LET l_ac = g_cnt
   END IF
   LET g_cnt = l_ac
 
   #遮罩相關處理
   FOR l_ac = 1 TO g_apce_d.getLength()
      LET g_apce_d_mask_o[l_ac].* =  g_apce_d[l_ac].*
      CALL aapt300_02_apce_t_mask()
      LET g_apce_d_mask_n[l_ac].* =  g_apce_d[l_ac].*
   END FOR
   
   LET g_apce2_d_mask_o.* =  g_apce2_d.*
   FOR l_ac = 1 TO g_apce2_d.getLength()
      LET g_apce2_d_mask_o[l_ac].* =  g_apce2_d[l_ac].*
      CALL aapt300_02_apce_t_mask()
      LET g_apce2_d_mask_n[l_ac].* =  g_apce2_d[l_ac].*
   END FOR
   LET g_apce3_d_mask_o.* =  g_apce3_d.*
   FOR l_ac = 1 TO g_apce3_d.getLength()
      LET g_apce3_d_mask_o[l_ac].* =  g_apce3_d[l_ac].*
      CALL aapt300_02_apce_t_mask()
      LET g_apce3_d_mask_n[l_ac].* =  g_apce3_d[l_ac].*
   END FOR
 
   
   LET l_ac = g_cnt
 
   #add-point:b_fill段資料填充(其他單身) name="b_fill.others.fill"
   CALL aapt300_02_sum_page_show()
   #end add-point
   
   ERROR "" 
 
   LET g_detail_cnt = g_apce_d.getLength()
   DISPLAY g_detail_idx TO FORMONLY.idx
   DISPLAY g_detail_cnt TO FORMONLY.cnt
   
   CLOSE b_fill_curs
   FREE aapt300_02_pb
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.detail_show" >}
#+ 顯示相關資料
PRIVATE FUNCTION aapt300_02_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point
   #add-point:show段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="detail_show.before"
   
   #end add-point
   
   
   
   #帶出公用欄位reference值page1
   
    
   #帶出公用欄位reference值page2
   
   #帶出公用欄位reference值page3
   
 
   
   #讀入ref值
   #add-point:show段單身reference name="detail_show.reference"
   
   #end add-point
   
   #add-point:show段單身reference name="detail_show.body2.reference"
   
   #end add-point
   #add-point:show段單身reference name="detail_show.body3.reference"
   
   #end add-point
 
   #add-point:detail_show段之後 name="detail_show.after"
 
   #end add-point
 
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.set_entry_b" >}
#+ 單身欄位開啟設定
PRIVATE FUNCTION aapt300_02_set_entry_b(p_cmd)                                                  
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"
   
   #end add-point
   DEFINE p_cmd   LIKE type_t.chr1         
   #add-point:set_entry_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
   
   #end add-point
 
   IF p_cmd = "a" THEN
      CALL cl_set_comp_entry("",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry_b段欄位控制 name="set_entry_b.field_control"
      
      #end add-point 
   END IF
   
   #add-point:set_entry_b段control name="set_entry_b.set_entry_b"
   
   #end add-point                                                                   
                                                                                
END FUNCTION                                                                 
 
{</section>}
 
{<section id="aapt300_02.set_no_entry_b" >}
#+ 單身欄位關閉設定
PRIVATE FUNCTION aapt300_02_set_no_entry_b(p_cmd)                                               
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"
   
   #end add-point   
   DEFINE p_cmd   LIKE type_t.chr1           
   #add-point:set_no_entry_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"
      
      #end add-point 
   END IF
   
   #add-point:set_no_entry_b段control name="set_no_entry_b.set_no_entry_b"
   
   #end add-point       
                                                                                
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.default_search" >}
#+ 外部參數搜尋
PRIVATE FUNCTION aapt300_02_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"
   
   #end add-point
   DEFINE li_idx  LIKE type_t.num10
   DEFINE li_cnt  LIKE type_t.num10
   DEFINE ls_wc   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
   
   #end add-point  
   
   #add-point:Function前置處理  name="default_search.before"
   
   #end add-point  
   
   IF NOT cl_null(g_argv[01]) THEN
      LET ls_wc = ls_wc, " apceld = '", g_argv[01], "' AND "
   END IF
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " apcedocno = '", g_argv[02], "' AND "
   END IF
   IF NOT cl_null(g_argv[03]) THEN
      LET ls_wc = ls_wc, " apceseq = '", g_argv[03], "' AND "
   END IF
 
   
   #add-point:default_search段after sql name="default_search.after_sql"
   
   #end add-point  
   
   IF NOT cl_null(ls_wc) THEN
      LET ls_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_wc2 = ls_wc
   ELSE
      LET g_wc2 = " 1=1"
      #預設查詢條件
      LET g_wc2 = cl_qbe_get_default_qryplan()
      IF cl_null(g_wc2) THEN
         LET g_wc2 = " 1=1"
      END IF
   END IF
 
   #add-point:default_search段結束前 name="default_search.after"
   
   #end add-point  
 
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.delete_b" >}
#+ 刪除單身後其他table連動
PRIVATE FUNCTION aapt300_02_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"
   
   #end add-point
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="delete_b.pre_function"
   
   #end add-point
   
   #判斷是否是同一群組的table
   LET ls_group = "apce_t,"
   IF ls_group.getIndexOf(ps_table,1) > 0 THEN
      IF ps_table <> 'apce_t' THEN
         #add-point:delete_b段刪除前 name="delete_b.b_delete"
         
         #end add-point     
         
         DELETE FROM apce_t
          WHERE apceent = g_enterprise AND
            apceld = ps_keys_bak[1] AND apcedocno = ps_keys_bak[2] AND apceseq = ps_keys_bak[3]
         
         #add-point:delete_b段刪除中 name="delete_b.m_delete"
         
         #end add-point  
            
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = ":",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE
            LET g_errparam.popup = FALSE 
            CALL cl_err()
         END IF
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_apce_d.deleteElement(li_idx) 
      END IF 
      IF ps_page <> "'2'" THEN 
         CALL g_apce2_d.deleteElement(li_idx) 
      END IF 
      IF ps_page <> "'3'" THEN 
         CALL g_apce3_d.deleteElement(li_idx) 
      END IF 
 
      
      #add-point:delete_b段刪除後 name="delete_b.a_delete"
      
      #end add-point
      
      RETURN
   END IF
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.insert_b" >}
#+ 新增單身後其他table連動
PRIVATE FUNCTION aapt300_02_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"
   
   #end add-point
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   #add-point:insert_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="insert_b.pre_function"
   
   #end add-point
   
   #判斷是否是同一群組的table
   LET ls_group = "apce_t,"
   #IF ls_group.getIndexOf(ps_table,1) > 0 THEN
      
      #add-point:insert_b段新增前 name="insert_b.b_insert"
      
      #end add-point    
      INSERT INTO apce_t
                  (apceent,
                   apceld,apcedocno,apceseq
                   ,apce002,apceorga,apce003,apce004,apce005,apce048,apce015,apce016,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119,apce027,apce011,apce010,apce024,apce038,apce031,apcecomp,apcesite,apce001,apce017,apce018,apce019,apce020,apce022,apce023,apce035,apce036,apce044,apce045,apce046,apce051,apce052,apce053,apce054,apce055,apce056,apce057,apce058,apce059,apce060,apce120,apce121,apce123,apce124,apce129,apce130,apce131,apce133,apce134,apce139) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004, 
                       g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016, 
                       g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104, 
                       g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119, 
                       g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024, 
                       g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031,g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite, 
                       g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019, 
                       g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035, 
                       g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046, 
                       g_apce2_d[l_ac].apce051,g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054, 
                       g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058, 
                       g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121, 
                       g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130, 
                       g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139) 
 
      #add-point:insert_b段新增中 name="insert_b.m_insert"
      
      #end add-point    
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE
         LET g_errparam.popup = FALSE 
         CALL cl_err()
      END IF
      #add-point:insert_b段新增後 name="insert_b.a_insert"
      
      #end add-point    
   #END IF
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.update_b" >}
#+ 修改單身後其他table連動
PRIVATE FUNCTION aapt300_02_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"
   
   #end add-point
   DEFINE ps_page          STRING
   DEFINE ps_table         STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="update_b.pre_function"
   
   #end add-point
   
   #比對新舊值, 判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #若key無變動, 不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
    
   #若key有變動, 則連動其他table的資料   
   #判斷是否是同一群組的table
   LET ls_group = "apce_t,"
   IF ls_group.getIndexOf(ps_table,1) > 0 AND ps_table <> "apce_t" THEN
      #add-point:update_b段修改前 name="update_b.b_update"
      
      #end add-point     
      UPDATE apce_t 
         SET (apceld,apcedocno,apceseq
              ,apce002,apceorga,apce003,apce004,apce005,apce048,apce015,apce016,apce100,apce101,apce103,apce104,apce109,apce113,apce114,apce119,apce027,apce011,apce010,apce024,apce038,apce031,apcecomp,apcesite,apce001,apce017,apce018,apce019,apce020,apce022,apce023,apce035,apce036,apce044,apce045,apce046,apce051,apce052,apce053,apce054,apce055,apce056,apce057,apce058,apce059,apce060,apce120,apce121,apce123,apce124,apce129,apce130,apce131,apce133,apce134,apce139) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_apce_d[l_ac].apce002,g_apce_d[l_ac].apceorga,g_apce_d[l_ac].apce003,g_apce_d[l_ac].apce004, 
                  g_apce_d[l_ac].apce005,g_apce_d[l_ac].apce048,g_apce_d[l_ac].apce015,g_apce_d[l_ac].apce016, 
                  g_apce_d[l_ac].apce100,g_apce_d[l_ac].apce101,g_apce_d[l_ac].apce103,g_apce_d[l_ac].apce104, 
                  g_apce_d[l_ac].apce109,g_apce_d[l_ac].apce113,g_apce_d[l_ac].apce114,g_apce_d[l_ac].apce119, 
                  g_apce_d[l_ac].apce027,g_apce_d[l_ac].apce011,g_apce_d[l_ac].apce010,g_apce_d[l_ac].apce024, 
                  g_apce_d[l_ac].apce038,g_apce_d[l_ac].apce031,g_apce_d[l_ac].apcecomp,g_apce_d[l_ac].apcesite, 
                  g_apce_d[l_ac].apce001,g_apce2_d[l_ac].apce017,g_apce2_d[l_ac].apce018,g_apce2_d[l_ac].apce019, 
                  g_apce2_d[l_ac].apce020,g_apce2_d[l_ac].apce022,g_apce2_d[l_ac].apce023,g_apce2_d[l_ac].apce035, 
                  g_apce2_d[l_ac].apce036,g_apce2_d[l_ac].apce044,g_apce2_d[l_ac].apce045,g_apce2_d[l_ac].apce046, 
                  g_apce2_d[l_ac].apce051,g_apce2_d[l_ac].apce052,g_apce2_d[l_ac].apce053,g_apce2_d[l_ac].apce054, 
                  g_apce2_d[l_ac].apce055,g_apce2_d[l_ac].apce056,g_apce2_d[l_ac].apce057,g_apce2_d[l_ac].apce058, 
                  g_apce2_d[l_ac].apce059,g_apce2_d[l_ac].apce060,g_apce3_d[l_ac].apce120,g_apce3_d[l_ac].apce121, 
                  g_apce3_d[l_ac].apce123,g_apce3_d[l_ac].apce124,g_apce3_d[l_ac].apce129,g_apce3_d[l_ac].apce130, 
                  g_apce3_d[l_ac].apce131,g_apce3_d[l_ac].apce133,g_apce3_d[l_ac].apce134,g_apce3_d[l_ac].apce139)  
 
         WHERE apceent = g_enterprise AND apceld = ps_keys_bak[1] AND apcedocno = ps_keys_bak[2] AND apceseq = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update"
      
      #end add-point 
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "apce_t" 
            LET g_errparam.code = "std-00009" 
            LET g_errparam.popup = TRUE 
            CALL cl_err()
         WHEN SQLCA.SQLCODE #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "apce_t:",SQLERRMESSAGE 
            LET g_errparam.code = SQLCA.SQLCODE
            LET g_errparam.popup = TRUE 
            CALL cl_err()
         OTHERWISE
            
      END CASE
      #add-point:update_b段修改後 name="update_b.a_update"
      
      #end add-point 
      RETURN
   END IF
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.lock_b" >}
#+ 連動lock其他單身table資料
PRIVATE FUNCTION aapt300_02_lock_b(ps_table)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"
   
   #end add-point
   DEFINE ps_table STRING
   DEFINE ls_group STRING
   #add-point:lock_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"
 
   #end add-point   
   
   #add-point:Function前置處理  name="lock_b.pre_function"
   
   #end add-point
   
   #先刷新資料
   #CALL aapt300_02_b_fill(g_wc2)
   
   #鎖定整組table
   #LET ls_group = ""
   #僅鎖定自身table
   LET ls_group = "apce_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aapt300_02_bcl USING g_enterprise,
                                       g_apce_d[g_detail_idx].apceld,g_apce_d[g_detail_idx].apcedocno, 
                                           g_apce_d[g_detail_idx].apceseq
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aapt300_02_bcl:",SQLERRMESSAGE 
         LET g_errparam.code = SQLCA.SQLCODE
         LET g_errparam.popup = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   
   END IF
                                    
 
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.unlock_b" >}
#+ 連動unlock其他單身table資料
PRIVATE FUNCTION aapt300_02_unlock_b(ps_table)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"
   
   #end add-point
   DEFINE ps_table STRING
   DEFINE ls_group STRING
   #add-point:unlock_b段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"
 
   #end add-point  
   
   #add-point:Function前置處理  name="unlock_b.pre_function"
   
   #end add-point
   
   LET ls_group = ""
   
   #IF ls_group.getIndexOf(ps_table,1) THEN
      CLOSE aapt300_02_bcl
   #END IF
   
 
   
   #add-point:unlock_b段結束前 name="unlock_b.after"
 
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.modify_detail_chk" >}
#+ 單身輸入判定(因應modify_detail)
PRIVATE FUNCTION aapt300_02_modify_detail_chk(ps_record)
   #add-point:modify_detail_chk段define(客製用) name="modify_detail_chk.define_customerization"
   
   #end add-point
   DEFINE ps_record STRING
   DEFINE ls_return STRING
   #add-point:modify_detail_chk段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify_detail_chk.define"
   
   #end add-point
   
   #add-point:modify_detail_chk段開始前 name="modify_detail_chk.before"
   
   #end add-point
   
   #根據sr名稱確定該page第一個欄位的名稱
   CASE ps_record
      WHEN "s_detail1" 
         LET ls_return = "apcedocno"
      WHEN "s_detail2"
         LET ls_return = "apcedocno_2"
      WHEN "s_detail3"
         LET ls_return = "apcedocno_3"
 
      #add-point:modify_detail_chk段自訂page控制 name="modify_detail_chk.page_control"
      
      #end add-point
   END CASE
    
   #add-point:modify_detail_chk段結束前 name="modify_detail_chk.after"
   
   #end add-point
   
   RETURN ls_return
   
END FUNCTION
 
{</section>}
 
{<section id="aapt300_02.show_ownid_msg" >}
#+ 判斷是否顯示只能修改自己權限資料的訊息
#(ver:35) ---add start---
PRIVATE FUNCTION aapt300_02_show_ownid_msg()
   #add-point:show_ownid_msg段define(客製用) name="show_ownid_msg.define_customerization"
   
   #end add-point
   #add-point:show_ownid_msg段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show_ownid_msg.define"
   
   #end add-point
  
 
   
 
END FUNCTION
#(ver:35) --- add end ---
 
{</section>}
 
{<section id="aapt300_02.mask_functions" >}
&include "erp/aap/aapt300_02_mask.4gl"
 
{</section>}
 
{<section id="aapt300_02.set_pk_array" >}
   #應用 a51 樣板自動產生(Version:8)
#+ 給予pk_array內容
PRIVATE FUNCTION aapt300_02_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point  
   
   #若l_ac<=0代表沒有資料
   IF l_ac <= 0 THEN
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_apce_d[l_ac].apceld
   LET g_pk_array[1].column = 'apceld'
   LET g_pk_array[2].values = g_apce_d[l_ac].apcedocno
   LET g_pk_array[2].column = 'apcedocno'
   LET g_pk_array[3].values = g_apce_d[l_ac].apceseq
   LET g_pk_array[3].column = 'apceseq'
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point  
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aapt300_02.state_change" >}
   
 
{</section>}
 
{<section id="aapt300_02.other_dialog" readonly="Y" >}

 
{</section>}
 
{<section id="aapt300_02.other_function" readonly="Y" >}
################################################################################
# Descriptions...: 匯總計算單身金額並顯示
# Memo...........:
# Usage..........: CALL aapt300_02_sum_page_show()
# Input parameter: 
# Return code....: 
# Date & Author..: 14/10/24 By apo
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt300_02_sum_page_show()
   DEFINE l_apce_plus  RECORD    #沖帳金額正的部分
              apce109  LIKE apce_t.apce109,
              apce119  LIKE apce_t.apce119,
              apce129  LIKE apce_t.apce129,
              apce139  LIKE apce_t.apce139
                       END RECORD 
   DEFINE l_apce_minus RECORD   #沖帳金額負的部分
              apce109  LIKE apce_t.apce109,
              apce119  LIKE apce_t.apce119,
              apce129  LIKE apce_t.apce129,
              apce139  LIKE apce_t.apce139
                       END RECORD

   INITIALIZE g_apce_sum.* TO NULL
   
   #本幣 本位幣二 本位幣三
   LET g_apce_sum.glaa001 = g_glaa.glaa001
   LET g_apce_sum.glaa016 = g_glaa.glaa016
   LET g_apce_sum.glaa020 = g_glaa.glaa020
   
   #交易合計金額
   SELECT (apca103+apca104),(apca113+apca114),(apca123+apca124),(apca133+apca134) 
     INTO g_apce_sum.sum_apca103,g_apce_sum.sum_apca113,g_apce_sum.sum_apca123,g_apce_sum.sum_apca133
     FROM apca_t
    WHERE apcaent = g_enterprise
      AND apcald  = g_apca.apcald
      AND apcadocno = g_apca.apcadocno
   IF cl_null(g_apce_sum.sum_apca103)THEN LET g_apce_sum.sum_apca103 = 0 END IF
   IF cl_null(g_apce_sum.sum_apca113)THEN LET g_apce_sum.sum_apca113 = 0 END IF
   IF cl_null(g_apce_sum.sum_apca123)THEN LET g_apce_sum.sum_apca123 = 0 END IF
   IF cl_null(g_apce_sum.sum_apca133)THEN LET g_apce_sum.sum_apca133 = 0 END IF

   #稅前折抵金額
   #正
   INITIALIZE l_apce_plus.* TO NULL
   SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139) 
     INTO l_apce_plus.* 
     FROM apce_t
    WHERE apceent = g_enterprise
      AND apceld  = g_apca.apcald
      AND apcedocno = g_apca.apcadocno
      AND apce015 = 'C' 
      AND apce027 = 'Y'
   IF cl_null(l_apce_plus.apce109)THEN LET l_apce_plus.apce109 = 0 END IF
   IF cl_null(l_apce_plus.apce119)THEN LET l_apce_plus.apce119 = 0 END IF
   IF cl_null(l_apce_plus.apce129)THEN LET l_apce_plus.apce129 = 0 END IF
   IF cl_null(l_apce_plus.apce139)THEN LET l_apce_plus.apce139 = 0 END IF

   #負
   INITIALIZE l_apce_minus.* TO NULL
   SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139) 
     INTO l_apce_minus.* 
     FROM apce_t
    WHERE apceent = g_enterprise
      AND apceld  = g_apca.apcald
      AND apcedocno = g_apca.apcadocno
      AND apce015 = 'D' 
      AND apce027 = 'Y'
   IF cl_null(l_apce_minus.apce109)THEN LET l_apce_minus.apce109 = 0 END IF
   IF cl_null(l_apce_minus.apce119)THEN LET l_apce_minus.apce119 = 0 END IF
   IF cl_null(l_apce_minus.apce129)THEN LET l_apce_minus.apce129 = 0 END IF
   IF cl_null(l_apce_minus.apce139)THEN LET l_apce_minus.apce139 = 0 END IF

   LET g_apce_sum.sum_apce1091 = l_apce_plus.apce109 - l_apce_minus.apce109
   LET g_apce_sum.sum_apce1191 = l_apce_plus.apce119 - l_apce_minus.apce119
   LET g_apce_sum.sum_apce1291 = l_apce_plus.apce129 - l_apce_minus.apce129
   LET g_apce_sum.sum_apce1391 = l_apce_plus.apce139 - l_apce_minus.apce139


   #直接沖帳金額
   #正
   INITIALIZE l_apce_plus.* TO NULL
   SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139) 
     INTO l_apce_plus.* 
     FROM apce_t
    WHERE apceent = g_enterprise
      AND apceld  = g_apca.apcald
      AND apcedocno = g_apca.apcadocno
      AND apce015 = 'C' 
      AND (apce027 = 'N' OR apce027 IS NULL)
   IF cl_null(l_apce_plus.apce109)THEN LET l_apce_plus.apce109 = 0 END IF
   IF cl_null(l_apce_plus.apce119)THEN LET l_apce_plus.apce119 = 0 END IF
   IF cl_null(l_apce_plus.apce129)THEN LET l_apce_plus.apce129 = 0 END IF
   IF cl_null(l_apce_plus.apce139)THEN LET l_apce_plus.apce139 = 0 END IF

   #負
   INITIALIZE l_apce_minus.* TO NULL
   SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139) 
     INTO l_apce_minus.* 
     FROM apce_t
    WHERE apceent = g_enterprise
      AND apceld  = g_apca.apcald
      AND apcedocno = g_apca.apcadocno
      AND apce015 = 'D' 
      AND (apce027 = 'N' OR apce027 IS NULL)
   IF cl_null(l_apce_minus.apce109)THEN LET l_apce_minus.apce109 = 0 END IF
   IF cl_null(l_apce_minus.apce119)THEN LET l_apce_minus.apce119 = 0 END IF
   IF cl_null(l_apce_minus.apce129)THEN LET l_apce_minus.apce129 = 0 END IF
   IF cl_null(l_apce_minus.apce139)THEN LET l_apce_minus.apce139 = 0 END IF

   LET g_apce_sum.sum_apce1092 = l_apce_plus.apce109 - l_apce_minus.apce109
   LET g_apce_sum.sum_apce1192 = l_apce_plus.apce119 - l_apce_minus.apce119
   LET g_apce_sum.sum_apce1292 = l_apce_plus.apce129 - l_apce_minus.apce129
   LET g_apce_sum.sum_apce1392 = l_apce_plus.apce139 - l_apce_minus.apce139
   
   #付款及其他金額
   #正                                                                     
   INITIALIZE l_apce_plus.* TO NULL                                        
   SELECT SUM(apde109),SUM(apde119),SUM(apde129),SUM(apde139)              
     INTO l_apce_plus.*                                                    
     FROM apde_t                                                           
    WHERE apdeent = g_enterprise                                           
      AND apdeld  = g_apca.apcald                                          
      AND apdedocno = g_apca.apcadocno                                     
      AND apde015 = 'C'                                                    
   IF cl_null(l_apce_plus.apce109)THEN LET l_apce_plus.apce109 = 0 END IF  
   IF cl_null(l_apce_plus.apce119)THEN LET l_apce_plus.apce119 = 0 END IF  
   IF cl_null(l_apce_plus.apce129)THEN LET l_apce_plus.apce129 = 0 END IF  
   IF cl_null(l_apce_plus.apce139)THEN LET l_apce_plus.apce139 = 0 END IF  
                                                                           
   #負                                                                     
   INITIALIZE l_apce_minus.* TO NULL                                       
   SELECT SUM(apde109),SUM(apde119),SUM(apde129),SUM(apde139)              
     INTO l_apce_minus.*                                                   
     FROM apde_t                                                           
    WHERE apdeent = g_enterprise                                           
      AND apdeld  = g_apca.apcald                                          
      AND apdedocno = g_apca.apcadocno                                     
      AND apde015 = 'D'                                                    
   IF cl_null(l_apce_minus.apce109)THEN LET l_apce_minus.apce109 = 0 END IF
   IF cl_null(l_apce_minus.apce119)THEN LET l_apce_minus.apce119 = 0 END IF
   IF cl_null(l_apce_minus.apce129)THEN LET l_apce_minus.apce129 = 0 END IF
   IF cl_null(l_apce_minus.apce139)THEN LET l_apce_minus.apce139 = 0 END IF
                                                                           
   LET g_apce_sum.sum_apce1093 = l_apce_plus.apce109 - l_apce_minus.apce109
   LET g_apce_sum.sum_apce1193 = l_apce_plus.apce119 - l_apce_minus.apce119
   LET g_apce_sum.sum_apce1293 = l_apce_plus.apce129 - l_apce_minus.apce129
   LET g_apce_sum.sum_apce1393 = l_apce_plus.apce139 - l_apce_minus.apce139    

   #合計金額 = 交易合計金額　-　稅前折抵金額 - 直接沖銷帳金額 -　直接繳款金額
   LET g_apce_sum.sum_apce1094 =g_apce_sum.sum_apca103 - g_apce_sum.sum_apce1091 - g_apce_sum.sum_apce1092 - g_apce_sum.sum_apce1093 
   LET g_apce_sum.sum_apce1194 =g_apce_sum.sum_apca113 - g_apce_sum.sum_apce1191 - g_apce_sum.sum_apce1192 - g_apce_sum.sum_apce1193
   LET g_apce_sum.sum_apce1294 =g_apce_sum.sum_apca123 - g_apce_sum.sum_apce1291 - g_apce_sum.sum_apce1292 - g_apce_sum.sum_apce1293
   LET g_apce_sum.sum_apce1394 =g_apce_sum.sum_apca133 - g_apce_sum.sum_apce1391 - g_apce_sum.sum_apce1392 - g_apce_sum.sum_apce1393  

   DISPLAY BY NAME g_apce_sum.sum_apce1094,g_apce_sum.sum_apce1091,g_apce_sum.sum_apce1092,g_apce_sum.sum_apce1093,
                   g_apce_sum.sum_apce1194,g_apce_sum.sum_apce1191,g_apce_sum.sum_apce1192,g_apce_sum.sum_apce1193,
                   g_apce_sum.sum_apce1294,g_apce_sum.sum_apce1291,g_apce_sum.sum_apce1292,g_apce_sum.sum_apce1293,
                   g_apce_sum.sum_apce1394,g_apce_sum.sum_apce1391,g_apce_sum.sum_apce1392,g_apce_sum.sum_apce1393,
                   g_apce_sum.glaa001,g_apce_sum.glaa016,g_apce_sum.glaa020,
                   g_apce_sum.sum_apca103,g_apce_sum.sum_apca113,g_apce_sum.sum_apca123,g_apce_sum.sum_apca133 
END FUNCTION
################################################################################
# Descriptions...: 檢查渠道編號是否存在
# Memo...........:
# Usage..........: aapt300_02_oojd001_chk(p_oojd001)
#                  RETURN r_success,r_errno
# Input parameter: p_oojd001      渠道編號

# Date & Author..: 14/10/21 By apo
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt300_02_oojd001_chk(p_oojd001)
DEFINE p_oojd001    LIKE oojd_t.oojd001
DEFINE l_count      LIKE type_t.num5
DEFINE r_success    LIKE type_t.num5
DEFINE r_errno      LIKE gzze_t.gzze001

   LET r_success = TRUE
   LET r_errno = ''
   LET l_count = ''
   SELECT COUNT (*) INTO l_count
     FROM oojd_t
    WHERE oojdent = g_enterprise
      AND oojd001 = p_oojd001

   IF cl_null(l_count) THEN LET l_count = 0 END IF
   IF l_count = 0 THEN
      LET r_success = FALSE
      LET r_errno = 'abg-00043'
   END IF

   RETURN r_success,r_errno
END FUNCTION

################################################################################
# Descriptions...: 取得應稅折抵否
# Memo...........:
# Usage..........: CALL aapt300_02_get_apce027(p_apca019)
#                  RETURNING r_apce027
# Input parameter: p_apca019      待抵單號
# Return code....: r_apce027      應稅折抵否
# Date & Author..: 14/10/26 By apo
# Modify.........:
################################################################################
PUBLIC FUNCTION aapt300_02_get_apce027(p_apca019)
DEFINE p_apca019     LIKE apca_t.apca019
DEFINE r_apce027     LIKE apce_t.apce027
DEFINE l_apca060     LIKE apca_t.apca060

   SELECT apca060 INTO l_apca060 FROM apca_t
    WHERE apcaent = g_enterprise
#      AND apca019 = p_apca019   #160628-00002#2 mark
      AND apcadocno = p_apca019  #160628-00002#2 add #抓取单据单头是否开立发票
      
   IF l_apca060 = '2' THEN   #開立增值稅發票
      LET r_apce027 = 'Y'
   ELSE 
      LET r_apce027 = 'N'
   END IF
   RETURN r_apce027
END FUNCTION

################################################################################
# Descriptions...: 取得單頭應付單可沖金額
# Memo...........:
# Usage..........: CALL aapt300_02_get_contra_amount(p_apcald,p_apcadocno,p_seq,p_type)
# Input parameter: p_apcald        帳套
#                : p_apcadocno     應付單號
#                : p_seq           項次
#                : p_type          1:直接沖帳 2.直接付款
# Return code....: r_amt1          原幣可沖金額
#                : r_amt2          本幣可沖金額
# Date & Author..: 14/10/27 By apo
# Modify.........:
################################################################################
PUBLIC FUNCTION aapt300_02_get_contra_amount(p_apcald,p_apcadocno,p_seq,p_type)
DEFINE p_apcald         LIKE apca_t.apcald
DEFINE p_apcadocno      LIKE apca_t.apcadocno
DEFINE p_seq            LIKE apce_t.apceseq
DEFINE p_type           LIKE type_t.chr1
DEFINE r_amt1           LIKE apcc_t.apcc108               #原幣可沖
DEFINE r_amt2           LIKE apcc_t.apcc108               #本幣可沖
DEFINE r_amt3           LIKE apcc_t.apcc108               #本位幣二可沖
DEFINE r_amt4           LIKE apcc_t.apcc108               #本位幣三可沖
#DEFINE l_apca           RECORD LIKE apca_t.* #161104-00024#2 mark
#161104-00024#2-add(s)
DEFINE l_apca  RECORD  #應付憑單單頭
       apcaent   LIKE apca_t.apcaent, #企業編號
       apcaownid LIKE apca_t.apcaownid, #資料所有者
       apcaowndp LIKE apca_t.apcaowndp, #資料所有部門
       apcacrtid LIKE apca_t.apcacrtid, #資料建立者
       apcacrtdp LIKE apca_t.apcacrtdp, #資料建立部門
       apcacrtdt LIKE apca_t.apcacrtdt, #資料創建日
       apcamodid LIKE apca_t.apcamodid, #資料修改者
       apcamoddt LIKE apca_t.apcamoddt, #最近修改日
       apcacnfid LIKE apca_t.apcacnfid, #資料確認者
       apcacnfdt LIKE apca_t.apcacnfdt, #資料確認日
       apcapstid LIKE apca_t.apcapstid, #資料過帳者
       apcapstdt LIKE apca_t.apcapstdt, #資料過帳日
       apcastus  LIKE apca_t.apcastus, #狀態碼
       apcald    LIKE apca_t.apcald, #帳套
       apcacomp  LIKE apca_t.apcacomp, #法人
       apcadocno LIKE apca_t.apcadocno, #應付帳款單號碼
       apcadocdt LIKE apca_t.apcadocdt, #帳款日期
       apcasite  LIKE apca_t.apcasite, #帳務中心
       apca001   LIKE apca_t.apca001, #帳款單性質
       apca003   LIKE apca_t.apca003, #帳務人員
       apca004   LIKE apca_t.apca004, #帳款對象編號
       apca005   LIKE apca_t.apca005, #付款對象
       apca006   LIKE apca_t.apca006, #供應商分類
       apca007   LIKE apca_t.apca007, #帳款類別
       apca008   LIKE apca_t.apca008, #付款條件編號
       apca009   LIKE apca_t.apca009, #應付款日/應扣抵日
       apca010   LIKE apca_t.apca010, #容許票據到期日
       apca011   LIKE apca_t.apca011, #稅別
       apca012   LIKE apca_t.apca012, #稅率
       apca013   LIKE apca_t.apca013, #含稅否
       apca014   LIKE apca_t.apca014, #人員編號
       apca015   LIKE apca_t.apca015, #部門編號
       apca016   LIKE apca_t.apca016, #來源作業類型
       apca017   LIKE apca_t.apca017, #產生方式
       apca018   LIKE apca_t.apca018, #來源參考單號
       apca019   LIKE apca_t.apca019, #系統產生對應單號(待抵帳款-預付)
       apca020   LIKE apca_t.apca020, #信用狀付款否
       apca021   LIKE apca_t.apca021, #商業發票號碼(IV no.)
       apca022   LIKE apca_t.apca022, #進口報單號碼
       apca025   LIKE apca_t.apca025, #差異處理(發票與帳款差異)
       apca026   LIKE apca_t.apca026, #原幣未稅差異
       apca027   LIKE apca_t.apca027, #原幣稅額差異
       apca028   LIKE apca_t.apca028, #本幣未稅差異
       apca029   LIKE apca_t.apca029, #本幣幣稅額差異
       apca030   LIKE apca_t.apca030, #差異科目
       apca031   LIKE apca_t.apca031, #產生之差異折讓單號
       apca032   LIKE apca_t.apca032, #發票類型
       apca033   LIKE apca_t.apca033, #專案編號
       apca034   LIKE apca_t.apca034, #責任中心
       apca035   LIKE apca_t.apca035, #應付(貸方)科目編號
       apca036   LIKE apca_t.apca036, #費用(借方)科目編號
       apca037   LIKE apca_t.apca037, #產生傳票否
       apca038   LIKE apca_t.apca038, #拋轉傳票號碼
       apca039   LIKE apca_t.apca039, #會計檢核附件份數
       apca040   LIKE apca_t.apca040, #留置否
       apca041   LIKE apca_t.apca041, #留置理由碼
       apca042   LIKE apca_t.apca042, #留置設定日期
       apca043   LIKE apca_t.apca043, #留置解除日期
       apca044   LIKE apca_t.apca044, #留置原幣金額
       apca045   LIKE apca_t.apca045, #留置說明
       apca046   LIKE apca_t.apca046, #關係人否
       apca047   LIKE apca_t.apca047, #多角序號
       apca048   LIKE apca_t.apca048, #集團代付/代付單號
       apca049   LIKE apca_t.apca049, #來源營運中心編號
       apca050   LIKE apca_t.apca050, #交易原始單據份數
       apca051   LIKE apca_t.apca051, #作廢理由碼
       apca052   LIKE apca_t.apca052, #列印次數
       apca053   LIKE apca_t.apca053, #備註
       apca054   LIKE apca_t.apca054, #多帳期設定
       apca055   LIKE apca_t.apca055, #繳款優惠條件
       apca056   LIKE apca_t.apca056, #會計檢核附件狀態
       apca057   LIKE apca_t.apca057, #交易對象識別碼
       apca058   LIKE apca_t.apca058, #稅別交易類型
       apca059   LIKE apca_t.apca059, #預算編號
       apca060   LIKE apca_t.apca060, #發票開立方式
       apca061   LIKE apca_t.apca061, #預開發票基準日
       apca062   LIKE apca_t.apca062, #多角性質
       apca063   LIKE apca_t.apca063, #整帳批序號
       apca064   LIKE apca_t.apca064, #訂金序次
       apca065   LIKE apca_t.apca065, #發票編號
       apca066   LIKE apca_t.apca066, #發票號碼
       apca100   LIKE apca_t.apca100, #交易原幣別
       apca101   LIKE apca_t.apca101, #原幣匯率
       apca103   LIKE apca_t.apca103, #原幣未稅金額
       apca104   LIKE apca_t.apca104, #原幣稅額
       apca106   LIKE apca_t.apca106, #原幣應稅折抵合計金額
       apca107   LIKE apca_t.apca107, #NO USE
       apca108   LIKE apca_t.apca108, #原幣應付金額
       apca113   LIKE apca_t.apca113, #本幣未稅金額
       apca114   LIKE apca_t.apca114, #本幣稅額
       apca116   LIKE apca_t.apca116, #本幣應稅折抵合計金額
       apca117   LIKE apca_t.apca117, #NO USE
       apca118   LIKE apca_t.apca118, #本幣應付金額
       apca120   LIKE apca_t.apca120, #本位幣二幣別
       apca121   LIKE apca_t.apca121, #本位幣二匯率
       apca123   LIKE apca_t.apca123, #本位幣二未稅金額
       apca124   LIKE apca_t.apca124, #本位幣二稅額
       apca126   LIKE apca_t.apca126, #本位幣二應稅折抵合計金額
       apca127   LIKE apca_t.apca127, #NO USE
       apca128   LIKE apca_t.apca128, #本位幣二應付金額
       apca130   LIKE apca_t.apca130, #本位幣三幣別
       apca131   LIKE apca_t.apca131, #本位幣三匯率
       apca133   LIKE apca_t.apca133, #本位幣三未稅金額
       apca134   LIKE apca_t.apca134, #本位幣三稅額
       apca136   LIKE apca_t.apca136, #本位幣三應稅折抵合計金額
       apca137   LIKE apca_t.apca137, #NO USE
       apca138   LIKE apca_t.apca138, #本位幣三應付金額
       apcaud001 LIKE apca_t.apcaud001, #自定義欄位(文字)001
       apcaud002 LIKE apca_t.apcaud002, #自定義欄位(文字)002
       apcaud003 LIKE apca_t.apcaud003, #自定義欄位(文字)003
       apcaud004 LIKE apca_t.apcaud004, #自定義欄位(文字)004
       apcaud005 LIKE apca_t.apcaud005, #自定義欄位(文字)005
       apcaud006 LIKE apca_t.apcaud006, #自定義欄位(文字)006
       apcaud007 LIKE apca_t.apcaud007, #自定義欄位(文字)007
       apcaud008 LIKE apca_t.apcaud008, #自定義欄位(文字)008
       apcaud009 LIKE apca_t.apcaud009, #自定義欄位(文字)009
       apcaud010 LIKE apca_t.apcaud010, #自定義欄位(文字)010
       apcaud011 LIKE apca_t.apcaud011, #自定義欄位(數字)011
       apcaud012 LIKE apca_t.apcaud012, #自定義欄位(數字)012
       apcaud013 LIKE apca_t.apcaud013, #自定義欄位(數字)013
       apcaud014 LIKE apca_t.apcaud014, #自定義欄位(數字)014
       apcaud015 LIKE apca_t.apcaud015, #自定義欄位(數字)015
       apcaud016 LIKE apca_t.apcaud016, #自定義欄位(數字)016
       apcaud017 LIKE apca_t.apcaud017, #自定義欄位(數字)017
       apcaud018 LIKE apca_t.apcaud018, #自定義欄位(數字)018
       apcaud019 LIKE apca_t.apcaud019, #自定義欄位(數字)019
       apcaud020 LIKE apca_t.apcaud020, #自定義欄位(數字)020
       apcaud021 LIKE apca_t.apcaud021, #自定義欄位(日期時間)021
       apcaud022 LIKE apca_t.apcaud022, #自定義欄位(日期時間)022
       apcaud023 LIKE apca_t.apcaud023, #自定義欄位(日期時間)023
       apcaud024 LIKE apca_t.apcaud024, #自定義欄位(日期時間)024
       apcaud025 LIKE apca_t.apcaud025, #自定義欄位(日期時間)025
       apcaud026 LIKE apca_t.apcaud026, #自定義欄位(日期時間)026
       apcaud027 LIKE apca_t.apcaud027, #自定義欄位(日期時間)027
       apcaud028 LIKE apca_t.apcaud028, #自定義欄位(日期時間)028
       apcaud029 LIKE apca_t.apcaud029, #自定義欄位(日期時間)029
       apcaud030 LIKE apca_t.apcaud030, #自定義欄位(日期時間)030
       apca067   LIKE apca_t.apca067, #管理品類
       apca068   LIKE apca_t.apca068, #經營方式
       apca069   LIKE apca_t.apca069, #no use
       apca070   LIKE apca_t.apca070, #no use
       apca071   LIKE apca_t.apca071, #no use
       apca072   LIKE apca_t.apca072, #no use
       apca073   LIKE apca_t.apca073  #信用狀申請單號
           END RECORD
#161104-00024#2-add(e)
DEFINE l_apca_amt       RECORD                            #付款單可沖餘額
                        apcc10x    LIKE type_t.num20_6,
                        apcc11x    LIKE type_t.num20_6,
                        apcc12x    LIKE type_t.num20_6,
                        apcc13x    LIKE type_t.num20_6
                        END RECORD
DEFINE l_apce_amt       RECORD                            #直接沖帳金額
                        apce10x    LIKE type_t.num20_6,
                        apce11x    LIKE type_t.num20_6,
                        apce12x    LIKE type_t.num20_6,
                        apce13x    LIKE type_t.num20_6
                        END RECORD
DEFINE l_apde_amt       RECORD                            #直接付款金額
                        apde10x    LIKE type_t.num20_6,
                        apde11x    LIKE type_t.num20_6,
                        apde12x    LIKE type_t.num20_6,
                        apde13x    LIKE type_t.num20_6
                        END RECORD                        
DEFINE l_glaa001        LIKE glaa_t.glaa001                        
DEFINE l_apca044        LIKE apca_t.apca044                        
DEFINE l_self_amt       RECORD                            #自身金額
                        apce10x    LIKE type_t.num20_6,
                        apce11x    LIKE type_t.num20_6,
                        apce12x    LIKE type_t.num20_6,
                        apce13x    LIKE type_t.num20_6
                        END RECORD 
                        
   #取得單頭資訊
   #SELECT * INTO l_apca.* FROM apca_t   #161208-00026#5 mark
   #161208-00026#5-add(s)
   SELECT apcaent,apcaownid,apcaowndp,apcacrtid,apcacrtdp,
          apcacrtdt,apcamodid,apcamoddt,apcacnfid,apcacnfdt,
          apcapstid,apcapstdt,apcastus,apcald,apcacomp,
          apcadocno,apcadocdt,apcasite,apca001,apca003,
          apca004,apca005,apca006,apca007,apca008,
          apca009,apca010,apca011,apca012,apca013,
          apca014,apca015,apca016,apca017,apca018,
          apca019,apca020,apca021,apca022,apca025,
          apca026,apca027,apca028,apca029,apca030,
          apca031,apca032,apca033,apca034,apca035,
          apca036,apca037,apca038,apca039,apca040,
          apca041,apca042,apca043,apca044,apca045,
          apca046,apca047,apca048,apca049,apca050,
          apca051,apca052,apca053,apca054,apca055,
          apca056,apca057,apca058,apca059,apca060,
          apca061,apca062,apca063,apca064,apca065,
          apca066,apca100,apca101,apca103,apca104,
          apca106,apca107,apca108,apca113,apca114,
          apca116,apca117,apca118,apca120,apca121,
          apca123,apca124,apca126,apca127,apca128,
          apca130,apca131,apca133,apca134,apca136,
          apca137,apca138,apcaud001,apcaud002,apcaud003,
          apcaud004,apcaud005,apcaud006,apcaud007,apcaud008,
          apcaud009,apcaud010,apcaud011,apcaud012,apcaud013,
          apcaud014,apcaud015,apcaud016,apcaud017,apcaud018,
          apcaud019,apcaud020,apcaud021,apcaud022,apcaud023,
          apcaud024,apcaud025,apcaud026,apcaud027,apcaud028,
          apcaud029,apcaud030,apca067,apca068,apca069,
          apca070,apca071,apca072,apca073           
     INTO l_apca.* 
     FROM apca_t
   #161208-00026#5-add(e)
    WHERE apcaent = g_enterprise
       AND apcald = p_apcald AND apcadocno = p_apcadocno   
   CALL s_ld_sel_glaa(l_apca.apcald,'glaa001') RETURNING g_sub_success,l_glaa001       


   #取得單頭應付帳款單可沖金額
   LET l_apca_amt.apcc10x = l_apca.apca103 + l_apca.apca104
   LET l_apca_amt.apcc11x = l_apca.apca113 + l_apca.apca114
   LET l_apca_amt.apcc12x = l_apca.apca123 + l_apca.apca124
   LET l_apca_amt.apcc13x = l_apca.apca133 + l_apca.apca134

   #直接沖帳單身合計
   SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139) 
     INTO l_apce_amt.apce10x,l_apce_amt.apce11x,l_apce_amt.apce12x,l_apce_amt.apce13x
     FROM apce_t
    WHERE apceent = g_enterprise
      AND apceld = l_apca.apcald
      AND apcedocno = l_apca.apcadocno
   IF cl_null(l_apce_amt.apce10x) THEN LET l_apce_amt.apce10x = 0 END IF 
   IF cl_null(l_apce_amt.apce11x) THEN LET l_apce_amt.apce11x = 0 END IF 
   IF cl_null(l_apce_amt.apce12x) THEN LET l_apce_amt.apce12x = 0 END IF 
   IF cl_null(l_apce_amt.apce13x) THEN LET l_apce_amt.apce13x = 0 END IF 

   IF p_type = '1' AND NOT cl_null(p_seq) THEN
      #直接沖帳自身合計
      SELECT SUM(apce109),SUM(apce119),SUM(apce129),SUM(apce139)
        INTO l_self_amt.apce10x,l_self_amt.apce11x,l_self_amt.apce12x,l_self_amt.apce13x FROM apce_t
       WHERE apceent = g_enterprise
         AND apceld = l_apca.apcald
         AND apcedocno = l_apca.apcadocno  
         AND apceseq = p_seq
   END IF
   IF cl_null(l_self_amt.apce10x) THEN LET l_self_amt.apce10x = 0 END IF 
   IF cl_null(l_self_amt.apce11x) THEN LET l_self_amt.apce11x = 0 END IF  
   IF cl_null(l_self_amt.apce12x) THEN LET l_self_amt.apce12x = 0 END IF 
   IF cl_null(l_self_amt.apce13x) THEN LET l_self_amt.apce13x = 0 END IF 
   
   #直接付款單身合計
   SELECT (SUM(CASE apde015 WHEN 'C' THEN apde109 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde109 ELSE 0 END)),
          (SUM(CASE apde015 WHEN 'C' THEN apde119 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde119 ELSE 0 END)),
          (SUM(CASE apde015 WHEN 'C' THEN apde129 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde129 ELSE 0 END)),
          (SUM(CASE apde015 WHEN 'C' THEN apde139 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde139 ELSE 0 END))
     INTO l_apde_amt.apde10x,l_apde_amt.apde11x,l_apde_amt.apde12x,l_apde_amt.apde13x
     FROM apde_t
    WHERE apdeent = g_enterprise
      AND apdeld = l_apca.apcald
      AND apdedocno = l_apca.apcadocno
   IF cl_null(l_apde_amt.apde10x) THEN LET l_apde_amt.apde10x = 0 END IF 
   IF cl_null(l_apde_amt.apde11x) THEN LET l_apde_amt.apde11x = 0 END IF    
   IF cl_null(l_apde_amt.apde12x) THEN LET l_apde_amt.apde12x = 0 END IF    
   IF cl_null(l_apde_amt.apde13x) THEN LET l_apde_amt.apde13x = 0 END IF    

   IF p_type = '2' AND NOT cl_null(p_seq) THEN
      #直接付款自身合計
      SELECT (SUM(CASE apde015 WHEN 'C' THEN apde109 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde109 ELSE 0 END)),
             (SUM(CASE apde015 WHEN 'C' THEN apde119 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde119 ELSE 0 END)),
             (SUM(CASE apde015 WHEN 'C' THEN apde129 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde129 ELSE 0 END)),
             (SUM(CASE apde015 WHEN 'C' THEN apde139 ELSE 0 END) - SUM(CASE apde015 WHEN 'D' THEN apde139 ELSE 0 END))
        INTO l_self_amt.apce10x,l_self_amt.apce11x,l_self_amt.apce12x,l_self_amt.apce13x
        FROM apde_t
       WHERE apdeent = g_enterprise
         AND apdeld = l_apca.apcald
         AND apdedocno = l_apca.apcadocno
         AND apdeseq = p_seq
   END IF
   IF cl_null(l_self_amt.apce10x) THEN LET l_self_amt.apce10x = 0 END IF 
   IF cl_null(l_self_amt.apce11x) THEN LET l_self_amt.apce11x = 0 END IF 
   IF cl_null(l_self_amt.apce12x) THEN LET l_self_amt.apce12x = 0 END IF 
   IF cl_null(l_self_amt.apce13x) THEN LET l_self_amt.apce13x = 0 END IF 

   #原幣可沖
   IF l_apca_amt.apcc10x > 0 THEN
      #扣除單頭留置金額  
      IF NOT cl_null(l_apca.apca044) THEN   
         LET l_apca_amt.apcc10x = l_apca_amt.apcc10x - l_apca.apca044 
      END IF
      #可沖金額-直接沖帳金額-直接付款金額+自身金額
      LET r_amt1 = l_apca_amt.apcc10x - l_apce_amt.apce10x - l_apde_amt.apde10x + l_self_amt.apce10x
      #若計算後的可沖金額>原可沖金額,則視為超過
      IF r_amt1 > l_apca_amt.apcc10x THEN
         LET r_amt1 = l_apca_amt.apcc10x - r_amt1
      END IF
   ELSE
      LET r_amt1 = 0   
   END IF 
   #本幣可沖
   IF l_apca_amt.apcc11x > 0 THEN
      #扣除單頭留置金額  
      IF NOT cl_null(l_apca.apca044) THEN   
         #求本幣留置金額
         LET l_apca044 = 0
         LET l_apca044 = l_apca.apca044 * l_apca.apca101
         IF cl_null(l_apca044) THEN LET l_apca044 = 0 END IF
         CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apca044,2) RETURNING g_sub_success,g_errno,l_apca044         
         LET l_apca_amt.apcc11x = l_apca_amt.apcc11x - l_apca044
      END IF
      ##可沖金額-直接沖帳金額-直接付款金額+自身金額
      LET r_amt2 = l_apca_amt.apcc11x - l_apce_amt.apce11x - l_apde_amt.apde11x + l_self_amt.apce11x
      #若計算後的可沖金額>原可沖金額,則視為超過
      IF r_amt2 > l_apca_amt.apcc11x THEN
         LET r_amt2 = l_apca_amt.apcc11x - r_amt2
      END IF      
   ELSE
      LET r_amt2 = 0   
   END IF    
   #本位幣二可沖
   IF l_apca_amt.apcc12x > 0 THEN
      #扣除單頭留置金額  
      IF NOT cl_null(l_apca.apca044) THEN   
         #求本位幣二留置金額
         LET l_apca044 = 0         
         LET l_apca044 = l_apca.apca044 * l_apca.apca121
         IF cl_null(l_apca044) THEN LET l_apca044 = 0 END IF
         CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apca044,2) RETURNING g_sub_success,g_errno,l_apca044         
         LET l_apca_amt.apcc12x = l_apca_amt.apcc12x - l_apca044
      END IF
      ##可沖金額-直接沖帳金額-直接付款金額+自身金額
      LET r_amt3 = l_apca_amt.apcc12x - l_apce_amt.apce12x - l_apde_amt.apde12x + l_self_amt.apce12x
      #若計算後的可沖金額>原可沖金額,則視為超過
      IF r_amt3 > l_apca_amt.apcc12x THEN
         LET r_amt3 = l_apca_amt.apcc12x - r_amt3
      END IF         
   ELSE
      LET r_amt3 = 0   
   END IF   
   #本位幣三可沖
   IF l_apca_amt.apcc13x > 0 THEN
      #扣除單頭留置金額  
      IF NOT cl_null(l_apca.apca044) THEN   
         #求本位幣三留置金額
         LET l_apca044 = 0         
         LET l_apca044 = l_apca.apca044 * l_apca.apca131
         IF cl_null(l_apca044) THEN LET l_apca044 = 0 END IF
         CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apca044,2) RETURNING g_sub_success,g_errno,l_apca044         
         LET l_apca_amt.apcc13x = l_apca_amt.apcc13x - l_apca044
      END IF
      ##可沖金額-直接沖帳金額-直接付款金額+自身金額
      LET r_amt4 = l_apca_amt.apcc13x - l_apce_amt.apce13x - l_apde_amt.apde13x + l_self_amt.apce13x
      #若計算後的可沖金額>原可沖金額,則視為超過
      IF r_amt4 > l_apca_amt.apcc13x THEN
         LET r_amt4 = l_apca_amt.apcc13x - r_amt4
      END IF         
   ELSE
      LET r_amt4 = 0   
   END IF      
   
   RETURN r_amt1,r_amt2,r_amt3,r_amt4
   
END FUNCTION

################################################################################
# Descriptions...: 檢核直接沖銷中是否與應付單單頭之原幣幣別完全相同
# Memo...........:
# Usage..........: CALL aapt300_02_contra_curr_chk(p_ld,p_docno,p_apce100)
#                  RETURNING r_success
# Input parameter: p_ld           帳別
#                : p_docno        單號
#                : p_apce100      幣別
# Return code....: r_success      原幣幣別相同否
# Date & Author..: 14/10/31 By apo
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt300_02_contra_curr_chk(p_ld,p_docno,p_apce100)
   DEFINE p_ld             LIKE apca_t.apcald
   DEFINE p_docno          LIKE apca_t.apcadocno
   DEFINE p_apce100        LIKE apce_t.apce100   
   DEFINE r_success        LIKE type_t.num5
   DEFINE l_cnt            LIKE type_t.num5
   DEFINE l_apca100        LIKE apca_t.apca100
   
   LET r_success = TRUE
   
   #取得應付單原幣幣別
   SELECT apca100 INTO l_apca100 FROM apca_t
    WHERE apcaent = g_enterprise
       AND apcald = p_ld AND apcadocno = p_docno    
       
   SELECT COUNT(apceseq) INTO l_cnt FROM apce_t
    WHERE apceent = g_enterprise
      AND apceld  = p_ld
      AND apcedocno = p_docno   
      AND apce100 <> l_apca100
   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
   
   #直接沖銷中有原幣幣別與應付單單頭不同
   IF l_cnt > 0 THEN
      LET r_success = FALSE
   END IF
   #當本筆幣別與應付單頭不同則不檢核原幣
   IF NOT cl_null(p_apce100) AND p_apce100 <> l_apca100 THEN
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

PRIVATE FUNCTION aapt300_02_clac_bill_master()
   DEFINE l_amount         RECORD
                 apcb103      LIKE apcb_t.apcb103,
                 apcb113      LIKE apcb_t.apcb113,
                 apcb123      LIKE apcb_t.apcb123,
                 apcb133      LIKE apcb_t.apcb133,
                 xrcd104      LIKE xrcd_t.xrcd104,
                 xrcd114      LIKE xrcd_t.xrcd114,
                 xrcd124      LIKE xrcd_t.xrcd124,
                 xrcd134      LIKE xrcd_t.xrcd134,
                 apca106      LIKE apca_t.apca106,
                 apca116      LIKE apca_t.apca116,
                 apca126      LIKE apca_t.apca126,
                 apca136      LIKE apca_t.apca136,
                 apca107      LIKE apca_t.apca107,
                 apca117      LIKE apca_t.apca117,
                 apca127      LIKE apca_t.apca127,
                 apca137      LIKE apca_t.apca137,
                 apca108      LIKE apca_t.apca108,
                 apca118      LIKE apca_t.apca118,
                 apca128      LIKE apca_t.apca128,
                 apca138      LIKE apca_t.apca138
                           END RECORD    
   DEFINE r_success        LIKE type_t.num5                           
   
   LET r_success = TRUE
   OPEN aapt300_02_cl USING g_enterprise,g_apca.apcald,g_apca.apcadocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aapt300_02_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      CLOSE aapt300_02_cl
      LET r_success = FALSE
      RETURN r_success
   END IF

   #重新計算金額(單頭及多帳期)
   CALL s_aap_create_multi_bill_perod_tmp()   
   INITIALIZE l_amount.* TO NULL
   CALL s_aap_clac_bill_master(g_apca.apcald,g_apca.apcadocno) RETURNING l_amount.*
   
   LET g_apca.apcamodid = g_user 
   LET g_apca.apcamoddt = cl_get_current()
   
   UPDATE apca_t SET (apca103,apca104,apca106,apca107,apca108,
                      apca113,apca114,apca116,apca117,apca118,
                      apca123,apca124,apca126,apca127,apca128,
                      apca133,apca134,apca136,apca137,apca138,
                      apcamodid,apcamoddt) =
                     (l_amount.apcb103,l_amount.xrcd104,l_amount.apca106,l_amount.apca107,l_amount.apca108,
                      l_amount.apcb113,l_amount.xrcd114,l_amount.apca116,l_amount.apca117,l_amount.apca118,
                      l_amount.apcb123,l_amount.xrcd124,l_amount.apca126,l_amount.apca127,l_amount.apca128,
                      l_amount.apcb133,l_amount.xrcd134,l_amount.apca136,l_amount.apca137,l_amount.apca138,
                      g_user,g_apca.apcamoddt)
     WHERE apcaent = g_enterprise AND apcald = g_apca.apcald
       AND apcadocno = g_apca.apcadocno
       
   IF SQLCA.sqlerrd[3] = 0 THEN
     #CALL s_transaction_end('N','0')   #150419 mark
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00009"
      LET g_errparam.extend = "upd apca_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()   
      LET r_success = FALSE
   END IF
   
   CALL s_aap_multi_bill_period(g_apca.apcald,g_apca.apcadocno) RETURNING g_sub_success,g_errno
   IF NOT g_sub_success THEN
     #CALL s_transaction_end('N','0')   #150419 mark
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "aap-00092"
      LET g_errparam.extend = "upd apcc_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
   END IF   
   CLOSE aapt300_02_cl                              
   RETURN r_success
END FUNCTION

 
{</section>}
 
