#該程式未解開Section, 採用最新樣板產出!
{<section id="aapt560_03.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0005(2016-06-21 19:22:02), PR版次:0005(2016-10-28 10:27:32)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000027
#+ Filename...: aapt560_03
#+ Description: 信用狀作業產生帳務單
#+ Creator....: 03080(2016-06-21 19:20:34)
#+ Modifier...: 03080 -SD/PR- 08732
 
{</section>}
 
{<section id="aapt560_03.global" >}
#應用 c01b 樣板自動產生(Version:9)
#add-point:填寫註解說明
#161018-00036#1   2016/10/24 By dorishsu   修正aapt560_03_ins_ap_4()函式,apcb113/apcb115/apcb123/apcb133依幣別取位
#161006-00005#30  2016/10/28 By 08732      組織類型與職能開窗調整
#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目
IMPORT util
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔

#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_apca_m        RECORD
       apcald LIKE apca_t.apcald, 
   apcasite LIKE apca_t.apcasite, 
   apcasite_desc LIKE type_t.chr80, 
   apcacomp LIKE apca_t.apcacomp, 
   apcacomp_desc LIKE type_t.chr80, 
   apcadocno LIKE apca_t.apcadocno, 
   apcadocdt LIKE apca_t.apcadocdt, 
   apca003 LIKE apca_t.apca003, 
   apca003_desc LIKE type_t.chr80, 
   apca016 LIKE apca_t.apca016, 
   apca018 LIKE apca_t.apca018, 
   apca064 LIKE apca_t.apca064
       END RECORD
	   
#add-point:自定義模組變數(Module Variable)(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理)
DEFINE g_apcacomp   LIKE apca_t.apcacomp
#end add-point
 
DEFINE g_apca_m        type_g_apca_m
 
   DEFINE g_apcald_t LIKE apca_t.apcald
DEFINE g_apcadocno_t LIKE apca_t.apcadocno
 
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
 
#add-point:自定義客戶專用模組變數(Module Variable)

#end add-point
 
#add-point:傳入參數說明(global.argv)

#end add-point
 
{</section>}
 
{<section id="aapt560_03.input" >}
#+ 資料輸入
PUBLIC FUNCTION aapt560_03(--)
   #add-point:input段變數傳入
   p_lsjs
   #end add-point
   )
   #add-point:input段define
   
   #end add-point
   DEFINE l_ac_t          LIKE type_t.num10       #未取消的ARRAY CNT 
   DEFINE l_allow_insert  LIKE type_t.num5        #可新增否 
   DEFINE l_allow_delete  LIKE type_t.num5        #可刪除否  
   DEFINE l_count         LIKE type_t.num10
   DEFINE l_insert        LIKE type_t.num5
   DEFINE p_cmd           LIKE type_t.chr5
   #add-point:input段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理)
   DEFINE p_lsjs          STRING
   DEFINE l_comp          LIKE ooef_t.ooef001
   DEFINE l_glaa024       LIKE glaa_t.glaa024
   DEFINE r_docno         LIKE apca_t.apcadocno
   DEFINE r_success       LIKE type_t.num5
   #end add-point
   
   #畫面開啟 (identifier)
   OPEN WINDOW w_aapt560_03 WITH FORM cl_ap_formpath("aap","aapt560_03")
 
   #瀏覽頁簽資料初始化
   CALL cl_ui_init()
   
   LET g_qryparam.state = "i"
   LET p_cmd = 'a'
   
   #輸入前處理
   #add-point:單頭前置處理
   LET r_success = TRUE
   LET r_docno = NULL
   INITIALIZE g_apca_m.* TO NULL
   
   LET l_comp = NULL
   SELECT ooef017 INTO l_comp FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_site
   SELECT glaald INTO g_apca_m.apcald
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaacomp = l_comp
      AND glaa014 = 'Y'

   CALL cl_set_combo_scc_part('apca016','8548','31,32,33,34,35,36')   #來源作業類型
   LET g_apca_m.apcadocdt = g_today
   LET g_apca_m.apca003 = g_user
   LEt g_apca_m.apca064 = 0
   CALL s_aap_get_default_apcasite('1','','') RETURNING g_sub_success,g_errno,g_apca_m.apcasite,g_apca_m.apcald,g_apca_m.apcacomp
   LET g_apcacomp = g_apca_m.apcacomp
   
   CALL s_desc_get_department_desc(g_apca_m.apcasite) RETURNING g_apca_m.apcasite_desc    #albrieo 160729
   CALL s_desc_get_department_desc(g_apca_m.apcacomp) RETURNING g_apca_m.apcacomp_desc    #albireo 160729
   DISPLAY BY NAME g_apca_m.apcasite_desc,g_apca_m.apcacomp_desc                          #albireo 160729
   #end add-point
  
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      #輸入開始
      INPUT BY NAME g_apca_m.apcald,g_apca_m.apcasite,g_apca_m.apcacomp,g_apca_m.apcadocno,g_apca_m.apcadocdt, 
          g_apca_m.apca003,g_apca_m.apca016,g_apca_m.apca018,g_apca_m.apca064 ATTRIBUTE(WITHOUT DEFAULTS) 
 
         
         #自訂ACTION
         #add-point:單頭前置處理
         
         #end add-point
         
         #自訂ACTION(master_input)
         
         
         BEFORE INPUT
            #add-point:單頭輸入前處理
            
            #end add-point
          
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apcald
            #add-point:BEFORE FIELD apcald name="input.b.apcald"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apcald
            
            #add-point:AFTER FIELD apcald name="input.a.apcald"
            #應用 a05 樣板自動產生(Version:3)
            #確認資料無重複
            IF  NOT cl_null(g_apca_m.apcald) AND NOT cl_null(g_apca_m.apcadocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_apca_m.apcald != g_apcald_t  OR g_apca_m.apcadocno != g_apcadocno_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apca_t WHERE "||"apcaent = '" ||g_enterprise|| "' AND "||"apcald = '"||g_apca_m.apcald ||"' AND "|| "apcadocno = '"||g_apca_m.apcadocno ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF




            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apcald
            #add-point:ON CHANGE apcald name="input.g.apcald"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apcasite
            
            #add-point:AFTER FIELD apcasite name="input.a.apcasite"
            IF NOT cl_null(g_apca_m.apcasite)THEN
               CALL s_fin_account_center_with_ld_chk(g_apca_m.apcasite,'',g_user,'3','N','',g_today) RETURNING g_sub_success,g_errno
               IF NOT g_sub_success THEN
                  INITIALIZE g_errparam.* TO NULL
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_apca_m.apcasite = ''
                  LET g_apca_m.apcasite_desc = ''
                  LET g_apca_m.apcacomp = ''
                  LET g_apca_m.apcacomp_desc = ''
                  DISPLAY BY NAME g_apca_m.apcasite   ,g_apca_m.apcasite_desc,g_apca_m.apcacomp,g_apca_m.apcacomp_desc
                  NEXT FIELD apcasite
               END IF
               CALL s_fin_orga_get_comp_ld(g_apca_m.apcasite) RETURNING g_sub_success,g_errno,g_apca_m.apcacomp,g_apca_m.apcald
               LET g_apcacomp = g_apca_m.apcacomp
               CALL s_desc_get_department_desc(g_apca_m.apcacomp) RETURNING g_apca_m.apcacomp_desc
               DISPLAY BY NAME g_apca_m.apcacomp_desc,g_apca_m.apcacomp
            END IF
            CALL s_desc_get_department_desc(g_apca_m.apcasite) RETURNING g_apca_m.apcasite_desc
            DISPLAY BY NAME g_apca_m.apcacomp_desc,g_apca_m.apcacomp
            DISPLAY BY NAME g_apca_m.apcasite_desc,g_apca_m.apcasite   #albireo 160729
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apcasite
            #add-point:BEFORE FIELD apcasite name="input.b.apcasite"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apcasite
            #add-point:ON CHANGE apcasite name="input.g.apcasite"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apcacomp
            
            #add-point:AFTER FIELD apcacomp name="input.a.apcacomp"


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apcacomp
            #add-point:BEFORE FIELD apcacomp name="input.b.apcacomp"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apcacomp
            #add-point:ON CHANGE apcacomp name="input.g.apcacomp"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apcadocno
            #add-point:BEFORE FIELD apcadocno name="input.b.apcadocno"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apcadocno
            
            #add-point:AFTER FIELD apcadocno name="input.a.apcadocno"
            #應用 a05 樣板自動產生(Version:3)
            #確認資料無重複
            IF NOT cl_null(g_apca_m.apcald) AND NOT cl_null(g_apca_m.apcadocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (g_apca_m.apcald != g_apcald_t  OR g_apca_m.apcadocno != g_apcadocno_t )) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM apca_t WHERE "||"apcaent = '" ||g_enterprise|| "' AND "||"apcald = '"||g_apca_m.apcald ||"' AND "|| "apcadocno = '"||g_apca_m.apcadocno ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
               CALL s_aooi200_fin_chk_slip(g_apca_m.apcald,'',g_apca_m.apcadocno,'aapt560')
                  RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  LET g_apca_m.apcadocno = ''
                  DISPLAY BY NAME g_apca_m.apcadocno
                  NEXT FIELD apcadocno
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apcadocno
            #add-point:ON CHANGE apcadocno name="input.g.apcadocno"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apcadocdt
            #add-point:BEFORE FIELD apcadocdt name="input.b.apcadocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apcadocdt
            
            #add-point:AFTER FIELD apcadocdt name="input.a.apcadocdt"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apcadocdt
            #add-point:ON CHANGE apcadocdt name="input.g.apcadocdt"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apca003
            
            #add-point:AFTER FIELD apca003 name="input.a.apca003"

            IF NOT cl_null(g_apca_m.apca003)THEN
               LET g_errno = ''
               CALL s_employee_chk(g_apca_m.apca003) RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  LET g_apca_m.apca003 = ''
                  LET g_apca_m.apca003_desc = ''
                  DISPLAY BY NAME g_apca_m.apca003,g_apca_m.apca003_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_apca_m.apca003
            CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
            LET g_apca_m.apca003_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_apca_m.apca003_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apca003
            #add-point:BEFORE FIELD apca003 name="input.b.apca003"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apca003
            #add-point:ON CHANGE apca003 name="input.g.apca003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apca016
            #add-point:BEFORE FIELD apca016 name="input.b.apca016"
            CALL cl_set_comp_entry('apca064',TRUE)
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apca016
            
            #add-point:AFTER FIELD apca016 name="input.a.apca016"
            IF g_apca_m.apca016 <> '32' THEN
               CALL cl_set_comp_entry('apca064',FALSE)
            ELSE
               LET g_apca_m.apca018 = NULL
               LET g_apca_m.apca064 = NULL
               DISPLAY BY NAME g_apca_m.apca018,g_apca_m.apca064
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apca016
            #add-point:ON CHANGE apca016 name="input.g.apca016"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apca018
            #add-point:BEFORE FIELD apca018 name="input.b.apca018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apca018
            
            #add-point:AFTER FIELD apca018 name="input.a.apca018"
            IF NOT cl_null(g_apca_m.apca018)THEN
               IF NOT cl_null(g_apca_m.apca018)THEN
                  IF g_apca_m.apca016 <> '32' OR (g_apca_m.apca016 = '32' AND NOT cl_null(g_apca_m.apca064))THEN
                     CALL aapt560_03_apca018_chk()RETURNING g_sub_success,g_errno 
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam.* TO NULL
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        LET g_errparam.code = g_errno
                        CALL cl_err()
                        LET g_apca_m.apca018 = NULL
                        DISPLAY BY NAME g_apca_m.apca018
                        NEXT FIELD apca018
                     END IF
                  END IF
               END IF
               
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apca018
            #add-point:ON CHANGE apca018 name="input.g.apca018"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD apca064
            #add-point:BEFORE FIELD apca064 name="input.b.apca064"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD apca064
            
            #add-point:AFTER FIELD apca064 name="input.a.apca064"
            IF NOT cl_null(g_apca_m.apca064)THEN
               IF NOT cl_null(g_apca_m.apca064)THEN
                  CALL aapt560_03_apca018_chk()RETURNING g_sub_success,g_errno 
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     LET g_errparam.code = g_errno
                     CALL cl_err()
                     LET g_apca_m.apca064= NULL
                     DISPLAY BY NAME g_apca_m.apca064
                     NEXT FIELD apca064
                  END IF
               END IF               
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE apca064
            #add-point:ON CHANGE apca064 name="input.g.apca064"
            
            #END add-point 
 
 
 #欄位檢查
                  #Ctrlp:input.c.apcald
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apcald
            #add-point:ON ACTION controlp INFIELD apcald name="input.c.apcald"
            #應用 a07 樣板自動產生(Version:3)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
 
            LET g_qryparam.default1 = g_apca_m.apcald             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #s
            LET g_qryparam.arg2 = "" #s
 
            CALL q_authorised_ld()                                #呼叫開窗
 
            LET g_apca_m.apcald = g_qryparam.return1              

            DISPLAY g_apca_m.apcald TO apcald              #

            NEXT FIELD apcald                          #返回原欄位



            #END add-point
 
 
         #Ctrlp:input.c.apcasite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apcasite
            #add-point:ON ACTION controlp INFIELD apcasite name="input.c.apcasite"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apca_m.apcasite       
            #LET g_qryparam.where = " ooef204 = 'Y' "   #161006-00005#30   mark 
            #CALL q_ooef001()     #161006-00005#30   mark     
            CALL q_ooef001_46()   #161006-00005#30   add     
            LET g_apca_m.apcasite = g_qryparam.return1        
            DISPLAY BY NAME g_apca_m.apcasite
            NEXT FIELD apcasite                  
            #END add-point
 
 
         #Ctrlp:input.c.apcacomp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apcacomp
            #add-point:ON ACTION controlp INFIELD apcacomp name="input.c.apcacomp"
            #應用 a07 樣板自動產生(Version:3)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
 
            LET g_qryparam.default1 = g_apca_m.apcacomp             #給予default值
            LET g_qryparam.default2 = "" #g_apca_m.ooef001 #组织编号
            #給予arg
            LET g_qryparam.arg1 = "" #s

 
            CALL q_ooef001()                                #呼叫開窗
 
            LET g_apca_m.apcacomp = g_qryparam.return1              
            #LET g_apca_m.ooef001 = g_qryparam.return2 
            DISPLAY g_apca_m.apcacomp TO apcacomp              #
            #DISPLAY g_apca_m.ooef001 TO ooef001 #组织编号
            NEXT FIELD apcacomp                          #返回原欄位



            #END add-point
 
 
         #Ctrlp:input.c.apcadocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apcadocno
            #add-point:ON ACTION controlp INFIELD apcadocno name="input.c.apcadocno"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_apca_m.apcadocno
            LET l_glaa024 = NULL
            SELECT glaa024 INTO l_glaa024 FROM glaa_t
             WHERE glaaent = g_enterprise
               AND glaald = g_apca_m.apcald
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = g_prog
            CALL q_ooba002_1()
            LET g_apca_m.apcadocno = g_qryparam.return1
            DISPLAY BY NAME g_apca_m.apcadocno
            NEXT FIELD apcadocno
            #END add-point
 
 
         #Ctrlp:input.c.apcadocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apcadocdt
            #add-point:ON ACTION controlp INFIELD apcadocdt name="input.c.apcadocdt"
            
            #END add-point
 
 
         #Ctrlp:input.c.apca003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apca003
            #add-point:ON ACTION controlp INFIELD apca003 name="input.c.apca003"
            #應用 a07 樣板自動產生(Version:3)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
 
            LET g_qryparam.default1 = g_apca_m.apca003             #給予default值

            #給予arg
            LET g_qryparam.arg1 = "" #s

 
            CALL q_ooag001()                                #呼叫開窗
 
            LET g_apca_m.apca003 = g_qryparam.return1              

            DISPLAY g_apca_m.apca003 TO apca003              #

            NEXT FIELD apca003                          #返回原欄位



            #END add-point
 
 
         #Ctrlp:input.c.apca016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apca016
            #add-point:ON ACTION controlp INFIELD apca016 name="input.c.apca016"
            
            #END add-point
 
 
         #Ctrlp:input.c.apca018
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apca018
            #add-point:ON ACTION controlp INFIELD apca018 name="input.c.apca018"
            CASE
               WHEN g_apca_m.apca016 = '31'
                  INITIALIZE g_qryparam.* TO NULL
                  LET g_qryparam.state = 'i'
			         LET g_qryparam.reqry = FALSE
                  LET g_qryparam.default1 = g_apca_m.apca018  
                  LET g_qryparam.where = "apgacomp = '",g_apca_m.apcacomp,"' AND apgastus = 'Y' " ,
                                         #160824-00049#7-----s
                                         " AND NOT EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apgaent AND apca016 = '31' AND apca018 = apgadocno AND apcastus <> 'X') "
                                         #160824-00049#7-----e                                         
                  CALL q_apgadocno()
                  LET g_apca_m.apca018 = g_qryparam.return1
                  DISPLAY BY NAME g_apca_m.apca018 
                  NEXT FIELD apca018                  
               WHEN g_apca_m.apca016 = '32'
                  INITIALIZE g_qryparam.* TO NULL
                  LET g_qryparam.state = 'i'
			         LET g_qryparam.reqry = FALSE
                  LET g_qryparam.default1 = g_apca_m.apca018 
                                         #160824-00049#7-----s                  
                  #LET g_qryparam.where = #" EXISTS (SELECT 1 FROM apgd_t WHERE apgdent = apgaent AND apgddocno = apgadocno AND apgdcomp = apgdcomp) ",   #160824-00049#7
                                         #" AND apgacomp = '",g_apca_m.apcacomp,"' ",
                  LET g_qryparam.where = " apgdcomp = '",g_apca_m.apcacomp,"' AND apgdstus = 'Y' ",
                                         " AND NOT EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apgdent AND apca016 = '32' AND apca018 = apgddocno AND apca064 = apgd900 AND apcastus <> 'X') "
                                         #160824-00049#7-----e
                  CALL q_apgddocno()
                  LET g_apca_m.apca018 = g_qryparam.return1
                  LET g_apca_m.apca064 = g_qryparam.return2
                  DISPLAY BY NAME g_apca_m.apca018 ,g_apca_m.apca064
                  NEXT FIELD apca018  
               WHEN g_apca_m.apca016 = '33'
                  INITIALIZE g_qryparam.* TO NULL
                  LET g_qryparam.state = 'i'
			         LET g_qryparam.reqry = FALSE
                  LET g_qryparam.default1 = g_apca_m.apca018     
                  LET g_qryparam.where = "apgicomp = '",g_apca_m.apcacomp,"' AND apgistus = 'Y' ",
                                         #160824-00049#7-----s
                                         " AND NOT EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apgient AND apca016 = '33' AND apca018 = apgidocno AND apcastus <> 'X') "
                                         #160824-00049#7-----e                  
                  CALL q_apgidocno()
                  LET g_apca_m.apca018 = g_qryparam.return1
                  DISPLAY BY NAME g_apca_m.apca018 
                  NEXT FIELD apca018                    
               WHEN g_apca_m.apca016 = '34'
                  INITIALIZE g_qryparam.* TO NULL
                  LET g_qryparam.state = 'i'
			         LET g_qryparam.reqry = FALSE
                  LET g_qryparam.default1 = g_apca_m.apca018     
                  LET g_qryparam.where = "apgkcomp = '",g_apca_m.apcacomp,"' AND apgkstus = 'Y' ",
                                         #160824-00049#7-----s
                                         " AND NOT EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apgkent AND apca016 = '34' AND apca018 = apgkdocno AND apcastus <> 'X') "
                                         #160824-00049#7-----e
                  CALL q_apgkdocno()
                  LET g_apca_m.apca018 = g_qryparam.return1
                  DISPLAY BY NAME g_apca_m.apca018 
                  NEXT FIELD apca018    
               WHEN g_apca_m.apca016 = '35'
                  INITIALIZE g_qryparam.* TO NULL
                  LET g_qryparam.state = 'i'
			         LET g_qryparam.reqry = FALSE
                  LET g_qryparam.default1 = g_apca_m.apca018     
                  LET g_qryparam.where = "apglcomp = '",g_apca_m.apcacomp,"' AND apglstus = 'Y' ",
                                         #160824-00049#7-----s
                                         " AND NOT EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apglent AND apca016 = '35' AND apca018 = apgldocno AND apcastus <> 'X') "
                                         #160824-00049#7-----e
                  CALL q_apgldocno()
                  LET g_apca_m.apca018 = g_qryparam.return1
                  DISPLAY BY NAME g_apca_m.apca018 
                  NEXT FIELD apca018    
               WHEN g_apca_m.apca016 = '36'               
                  INITIALIZE g_qryparam.* TO NULL
                  LET g_qryparam.state = 'i'
			         LET g_qryparam.reqry = FALSE
                  LET g_qryparam.default1 = g_apca_m.apca018     
                  LET g_qryparam.where = "apgncomp = '",g_apca_m.apcacomp,"' AND apgnstus = 'Y' ",
                                         #160824-00049#7-----s
                                         " AND NOT EXISTS(SELECT 1 FROM apca_t WHERE apcaent = apgnent AND apca016 = '36' AND apca018 = apgndocno AND apcastus <> 'X') "
                                         #160824-00049#7-----e
                  CALL q_apgndocno_2()
                  LET g_apca_m.apca018 = g_qryparam.return1
                  DISPLAY BY NAME g_apca_m.apca018 
                  NEXT FIELD apca018                
               OTHERWISE
            END CASE
            
            #END add-point
 
 
         #Ctrlp:input.c.apca064
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD apca064
            #add-point:ON ACTION controlp INFIELD apca064 name="input.c.apca064"
            
            #END add-point
 
 
 #欄位開窗
 
         AFTER INPUT
            #add-point:單頭輸入後處理
            
            #end add-point
            
      END INPUT
    
      #add-point:自定義input
      
      #end add-point
    
      #公用action
      ON ACTION accept
         ACCEPT DIALOG
        
      ON ACTION cancel
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION close
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit
         LET INT_FLAG = TRUE 
         EXIT DIALOG
   
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
 
   #add-point:畫面關閉前
   
   #end add-point
   
   #畫面關閉
   CLOSE WINDOW w_aapt560_03 
   
   #add-point:input段after input 
   IF INT_FLAG THEN
      LET r_success= FALSE
      LET r_docno  = NULL
      LET INT_FLAG = 0
   ELSE
      CALL s_transaction_begin()
      LET g_apcacomp = g_apca_m.apcacomp
      CASE
         WHEN g_apca_m.apca016 = '31'
            CALL aapt560_03_ins_ap_1() RETURNING g_sub_success,r_docno
         WHEN g_apca_m.apca016 = '32'
            CALL aapt560_03_ins_ap_2() RETURNING g_sub_success,r_docno
         WHEN g_apca_m.apca016 = '33'
            CALL aapt560_03_ins_ap_3() RETURNING g_sub_success,r_docno
         WHEN g_apca_m.apca016 = '34'
            CALL aapt560_03_ins_ap_4() RETURNING g_sub_success,r_docno
         WHEN g_apca_m.apca016 = '35'
            CALL aapt560_03_ins_ap_5() RETURNING g_sub_success,r_docno
         WHEN g_apca_m.apca016 = '36'
            CALL aapt560_03_ins_ap_6() RETURNING g_sub_success,r_docno
      END CASE
      IF NOT g_sub_success THEN LET r_success = FALSE END IF
      CALL s_transaction_end('Y',0)
   END IF
   
   RETURN r_success,r_docno
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="aapt560_03.other_dialog" readonly="Y" >}

 
{</section>}
 
{<section id="aapt560_03.other_function" readonly="Y" >}

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_ap_1()
DEFINE l_apca   RECORD LIKE apca_t.*
DEFINE l_desc   LIKE type_t.chr1000
DEFINE ls_js            STRING   
DEFINE lc_param_apca    RECORD
         apcald         LIKE apca_t.apcald,
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca001        LIKE apca_t.apca001,
         apca004        LIKE apca_t.apca004,
         ooef019        LIKE ooef_t.ooef019
                        END RECORD
DEFINE lc_param_info    RECORD
            apca005        LIKE apca_t.apca005,
            apca005_desc   LIKE type_t.chr80,
            apca006        LIKE apca_t.apca006,    #供應商分類
            apca007        LIKE apca_t.apca007,
            apca007_desc   LIKE type_t.chr80,
            apca008        LIKE apca_t.apca008,
            apca008_desc   LIKE type_t.chr80,
            apca009        LIKE apca_t.apca009,
            apca010        LIKE apca_t.apca010,
            apca011        LIKE apca_t.apca011,
            apca011_desc   LIKE type_t.chr80,
            apca012        LIKE apca_t.apca012,
            apca013        LIKE apca_t.apca013,
            apca014        LIKE apca_t.apca014,
            apca014_desc   LIKE type_t.chr80,
            apca015        LIKE apca_t.apca015,
            apca015_desc   LIKE type_t.chr80,
            apca034        LIKE apca_t.apca034,
            apca034_desc   LIKE type_t.chr80,
            apca035        LIKE apca_t.apca035,
            apca035_desc   LIKE type_t.chr80,
            apca036        LIKE apca_t.apca036,
            apca036_desc   LIKE type_t.chr80,
            apca046        LIKE apca_t.apca046,
            apca054        LIKE apca_t.apca054,
            apca054_desc   LIKE type_t.chr80,
            apca055        LIKE apca_t.apca055,
            apca055_desc   LIKE type_t.chr80,
            apca056        LIKE apca_t.apca056,
            apca058        LIKE apca_t.apca058,
            apca058_desc   LIKE type_t.chr80,
            apca060        LIKE apca_t.apca060,
            apca100        LIKE apca_t.apca100,
            apca101        LIKE apca_t.apca101,
            apca121        LIKE apca_t.apca121,
            apca131        LIKE apca_t.apca131
                       END RECORD
   DEFINE lc_param2        RECORD
         type           LIKE type_t.chr1,       #類型
         apca004        LIKE apca_t.apca004,
         sfin2009       LIKE type_t.chr1        #汇率基本    
         END RECORD
   DEFINE l_apga    RECORD LIKE apga_t.*
   DEFINE r_success LIKE type_t.num5
   DEFINE l_apgc    RECORD LIKE apgc_t.*
   DEFINE l_apcb    RECORD LIKE apcb_t.*
   DEFINE l_sql     STRING
   DEFINE l_isam    RECORD LIKE isam_t.*
   DEFINE l_ooef002     LIKE ooef_t.ooef002
   DEFINE l_ooefl006    LIKE ooefl_t.ooefl006
   DEFINE l_pmaal003    LIKE pmaal_t.pmaal003
   DEFINE l_isao001     LIKE isao_t.isao001
   DEFINE l_dummy1      LIKE type_t.num20_6
   DEFINE l_apde        RECORD LIKE apde_t.*
   DEFINE l_pmab055     LIKE pmab_t.pmab055
   DEFINE l_glaa121     LIKE glaa_t.glaa121
   DEFINE l_glaa016     LIKE glaa_t.glaa016
   DEFINE l_glaa020     LIKE glaa_t.glaa020
   DEFINE l_glaa019     LIKE glaa_t.glaa019
   DEFINE l_glaa015     LIKE glaa_t.glaa015
   DEFINE l_glaa001     LIKE glaa_t.glaa001
   DEFINE r_docno       LIKE apga_t.apgadocno
   DEFINE l_date        DATETIME YEAR TO SECOND
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   DEFINE l_apcb113sum  LIKE type_t.num20_6
   DEFINE l_apcb114sum  LIKE type_t.num20_6
   DEFINE l_apcb115sum  LIKE type_t.num20_6
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   DEFINE l_oodb004     LIKE oodb_t.oodb004
   DEFINE l_apca013     LIKE apca_t.apca013
   DEFINE l_apca012     LIKE apca_t.apca012
   DEFINE l_oodb011     LIKE oodb_t.oodb011
   DEFINE l_count       LIKE type_t.num10
   #161004-00019#1-----s
   DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
   #161004-00019#1-----e
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE
   LET r_docno   = NULL
   INITIALIZE l_apga.* TO NULL
   SELECT * INTO l_apga.* FROM apga_t WHERE apgaent = g_enterprise AND apgacomp = g_apcacomp AND apgadocno = g_apca_m.apca018
   
   INITIALIZE l_apca.* TO NULL
   LET l_apca.apcaent = g_enterprise
   LET l_apca.apcacomp = l_apga.apgacomp
   LET l_apca.apcald = NULL
   SELECT glaald,glaa001,glaa016,glaa020
     INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
     FROM glaa_t
    WHERE glaaent  = g_enterprise
      AND glaacomp = l_apca.apcacomp
      AND glaa014  = 'Y'
   LET l_apca.apcadocdt = g_apca_m.apcadocdt
   LET l_apca.apca003   = g_apca_m.apca003
   LET l_apca.apca016   = g_apca_m.apca016
   LET l_apca.apca018   = g_apca_m.apca018
   LET l_apca.apcadocno = g_apca_m.apcadocno
   CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
      RETURNING g_sub_success,l_apca.apcadocno                                            
   IF NOT g_sub_success THEN
      LET r_success = FALSE
      RETURN r_success,r_docno
   END IF
   LET l_apca.apcastus  = 'N' # 狀態碼 
   LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
   LET l_apca.apca001 =  '31'   #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
   LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
   LET l_apca.apca004 = l_apga.apga004 # 帳款對象編號                        apca004    = 廠商(受益人)apga004   
   CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
   IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
   SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
     FROM pmaa_t
    WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
   LET lc_param_apca.apcald   = l_apca.apcald
   LET lc_param_apca.apcacomp = l_apca.apcacomp
   LET lc_param_apca.apcasite = l_apca.apcasite
   LET lc_param_apca.apcadocdt= l_apca.apcadocdt
   #LET lc_param_apca.apca001  = l_apca.apca001
   LET lc_param_apca.apca001  = '19'
   LET lc_param_apca.apca004  = l_apca.apca004
   SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = l_apca.apcacomp
   LET ls_js = util.JSON.stringify(lc_param_apca)
   CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
   CALL util.JSON.parse(ls_js,lc_param_info)
   LET l_apca.apca006 = lc_param_info.apca006  
   LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
   LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
   LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
   LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
   LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
   LET l_apca.apca014 = l_apga.apga005          # 人員編號           apca014    = apga005
   LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
   SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apca.apca014 
   LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
   LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
   LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
   LET l_apca.apca046 = lc_param_info.apca046       
   LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
   LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
   LET l_apca.apca058 = lc_param_info.apca058
   LET l_apca.apca060 = lc_param_info.apca060
   LET l_apca.apca016 = '31'
   LET l_apca.apca017 = '1'
   LET l_apca.apca018 = l_apga.apgadocno
   LET l_apca.apca020 = 'N'         # 信用狀付款否 
   LET l_apca.apca026 = 0
   LET l_apca.apca027 = 0
   LET l_apca.apca028 = 0
   LET l_apca.apca029 = 0
   LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
   LET l_apca.apca067 = l_apga.apgadocno
   LET l_apca.apca101 = 1
   LET l_apca.apca103 = 0
   LET l_apca.apca104 = 0
   LET l_apca.apca106 = 0 
   LET l_apca.apca107 = 0
   LET l_apca.apca108 = 0 
   LET l_apca.apca113 = 0
   LET l_apca.apca114 = 0 
   LET l_apca.apca116 = 0
   LEt l_apca.apca117 = 0 
   LET l_apca.apca118 = 0 
   LET lc_param2.apca004 = l_apca.apca004
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
   LET ls_js = util.JSON.stringify(lc_param2)   
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
        RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
   LET l_apca.apca123 = 0
   LET l_apca.apca124 = 0
   LET l_apca.apca126 = 0 
   LET l_apca.apca127 = 0 
   LET l_apca.apca128 = 0
   LET l_apca.apca133 = 0 
   LET l_apca.apca134 = 0 
   LET l_apca.apca136 = 0 
   LET l_apca.apca137 = 0
   LET l_apca.apca138 = 0 
   LET l_apca.apca071 = 0
   LET l_apca.apca072 = 0
   #albireo 160624-----s
   LEt l_apca.apca073 = l_apga.apga001
   LET l_apca.apcaownid = g_user
   LET l_apca.apcaowndp = g_dept
   LET l_apca.apcacrtid = g_user
   LET l_apca.apcacrtdp = g_dept
   LET l_date = cl_get_current()
   LET l_apca.apcacrtdt = l_date
   #albireo 160624-----e
   INSERT INTO apca_t VALUES(l_apca.*)
   
   #apgc產生 apcb xrcd_t
   LET l_sql = "SELECT * FROM apgc_t ",
               " WHERE apgcent = ",g_enterprise," ",
               "   AND apgccomp = '",l_apga.apgacomp,"' ",
               "   AND apgcdocno = '",l_apga.apgadocno,"' ",
               "   AND apgc900 = '0' "
   PREPARE sel_apgcp1 FROM l_sql
   DECLARE sel_apgcc1 CURSOR FOR sel_apgcp1
   
   FOREACH sel_apgcc1 INTO l_apgc.*
      IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
      #r2.產生apcb-----s
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '54'
      LET l_apcb.apcb002 = l_apgc.apgcdocno
      LET l_apcb.apcb003 = l_apgc.apgcseq
      LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = l_apgc.apgc006
      LET l_apcb.apcb021 = l_apgc.apgc004
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
      LET l_apcb.apcb023 = 'N'
      LET l_apcb.apcb027 = l_apgc.apgc008
      LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apgc.apgc100
      LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
      LET l_apcb.apcb102 = l_apgc.apgc101
      LET l_apcb.apcb103 = l_apgc.apgc103
      LET l_apcb.apcb104 = l_apgc.apgc104
      LET l_apcb.apcb105 = l_apgc.apgc105
      LET l_apcb.apcb108 = l_apcb.apcb103
      LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
      LET l_apcb.apcb113 = l_apgc.apgc113
      LET l_apcb.apcb114 = l_apgc.apgc114
      LET l_apcb.apcb115 = l_apgc.apgc115
      LET l_apcb.apcborga = l_apgc.apgcorga
      CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
      IF l_apca013 = 'Y' THEN
         LET l_apcb.apcb105 = l_apcb.apcb105
      ELSE
         LET l_apcb.apcb105 = l_apcb.apcb103
      END IF
      CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
                l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                    l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                    l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                    l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
         LET r_success = FALSE
      END IF
      #r2.產生apcb-----e
      
      #r3.產生直接付款apde-----s
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent  =l_apca.apcaent
      LET l_apde.apdeld =l_apca.apcald
      LET l_apde.apdecomp =l_apca.apcacomp
      LET l_apde.apdeorga =l_apca.apcacomp
      LET l_apde.apdesite =l_apca.apcasite
      LET l_apde.apdedocno =l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      LET l_apde.apde001 = 'aapt560'
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde028 = '0'
      LET l_apde.apde002 = '10'
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
      #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
      LET l_apde.apde109 =  l_apgc.apgc105
      LET l_apde.apde119 =  l_apgc.apgc115
      LET l_apde.apde006 = '10'   
      #銀行存提碼
      LET l_apde.apde011 = l_apgc.apgc015
      #現金變動碼
      LET l_apde.apde012 = l_apgc.apgc016
      LET l_apde.apde013 = ''
      LET l_apde.apde014 = ''
      LET l_apde.apde016 = ''
      LET l_apde.apde100 = l_apgc.apgc100
      LET l_apde.apde101 = l_apgc.apgc101
      LET l_apde.apde039 = l_apga.apga007
      LET l_apde.apde041 = NULL
      SELECT nmabl003 INTO l_apde.apde041
        FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
      LET l_apde.apde032 = l_apca.apcadocdt
      LET l_apde.apde061 = '54'
      #LET l_apde.apde016 = l_apgc.apgc004
      LET l_apde.apde008 = l_apgc.apgc014
      CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
      INSERT INTO apde_t(apdeent,
                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                         apde001,apde009,apde028,apde002,apde015,
                         apde003,apde004,apdeorga,apde006,apde011,
                         apde012,apde013,apde014,apde016,apde017,
                         apde018,apde021,apde032,apde100,apde101,
                         apde039,apde040,apde041,
                         apde008,
                         apde109,apde119,apde061)
             VALUES(l_apde.apdeent,
                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                    l_apde.apde039,l_apde.apde040,l_apde.apde041,
                    l_apde.apde008,
                    l_apde.apde109,l_apde.apde119,l_apde.apde061)
      IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
      #r3.產生直接付款apde-----e
      
      #INSERT isam
      INITIALIZE l_isam.* TO NULL
      LET l_isam.isament = l_apca.apcaent
      LET l_isam.isamdocno = l_apca.apcadocno
      SELECT MAX(isamseq)+1 INTO l_isam.isamseq
        FROM isam_t
       WHERE isament = g_enterprise
         AND isamdocno = l_apca.apcadocno
         AND isam001 = 'aapt560'
      IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
      LET l_isam.isam001 = 'aapt560'
      LET l_isam.isam002 = l_apca.apca004                           
      LET l_isam.isam008 = l_apgc.apgc007                           
      LET l_isam.isam009 = l_apgc.apgc008                           
      LET l_isam.isam010 = l_apgc.apgc009                           
      LET l_isam.isam011 = l_apgc.apgc010                           
      LET l_isam.isam012 = l_apgc.apgc006        
      LET l_isam.isam0121= l_apca.apca013                  
      LET l_isam.isam013 = l_apca.apca012
      LET l_isam.isam014 = l_apgc.apgc100                           
      LET l_isam.isam015 = l_apgc.apgc101                           
      LET l_isam.isam016 = l_ooefl006
      LET l_isam.isam017 = l_ooef002
      CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
                 l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
      LET l_isam.isam023 = l_apgc.apgc103                           
      LET l_isam.isam024 = l_apgc.apgc104                           
      LET l_isam.isam025 = l_apgc.apgc105                           
      LET l_isam.isam026 = l_apgc.apgc113                           
      LET l_isam.isam027 = l_apgc.apgc114                           
      LET l_isam.isam028 = l_apgc.apgc115                           
      LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  

      SELECT isak008,isak009,isak010,isak011,isak012
        INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
             l_isam.isam033,l_isam.isam034
        FROM isak_t
       WHERE isakent = g_enterprise
         AND isak001 = l_apca.apca004
         AND isak002 = lc_param_apca.ooef019
        
      LET l_isam.isam035 = '1'                                 
      LET l_isam.isam036 = '11'                                
      LET l_isam.isam037 = l_apgc.apgc011                           
      LET l_isam.isam050 = l_apca.apcadocno                         
      LET l_isam.isam107    = 0                                 
      LET l_isam.isam108    = 0                                 
      LET l_isam.isam117    = 0                                 
      LET l_isam.isam118    = 0
      IF NOT cl_null(l_isam.isam010)THEN
         INSERT INTO isam_t VALUES(l_isam.*)      
      END IF
   END FOREACH
   
   #161004-00019#1-----s
   CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
   UPDATE xrcd_t SET xrcd009 = l_xrcd009
    WHERE xrcdent= g_enterprise
      AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
      AND xrcd009 IS NULL
   #161004-00019#1-----e
   
   
   LET l_pmab055 = NULL
   SELECT pmab055 INTO l_pmab055 FROM pmab_t
    WHERE pmabsite = l_apca.apcacomp
      AND pmab001 = l_apca.apca004
      AND pmabent = g_enterprise
   
   #自備款-----s
   IF l_apga.apga026 = 'Y' THEN   #albireo 160711 add
      LET l_glaa121 = NULL LET l_glaa016 = NULL
      LET l_glaa020 = NULL LET l_glaa019 = NULL
      LET l_glaa015 = NULL
      SELECT glaa121,glaa016,glaa020 ,
             glaa015,glaa019
        INTO l_glaa121,l_glaa016,l_glaa020,
             l_glaa015,l_glaa019
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = l_apca.apcald
      
      
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent   = g_enterprise
      LET l_apde.apdecomp  = l_apca.apcacomp
      LET l_apde.apdeld    = l_apca.apcald
      LET l_apde.apdedocno = l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      #albireo 160624-----s
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      #albireo 160624-----e
      LET l_apde.apdesite  = l_apca.apcasite
      LET l_apde.apdeorga  = l_apca.apcasite
      LET l_apde.apde001   = 'aapt560'
      LET l_apde.apde002   = '23'
      LET l_apde.apde006   = '10'
      LET l_apde.apde008   = l_apga.apga040
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde011 = l_apga.apga036
      LET l_apde.apde012 = l_apga.apga037
      LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
      LET l_apde.apde016 = NULL
      #SELECT glab005 INTO l_apde.apde016 FROM glab_t
      # WHERE glabent = g_enterprise
      #   AND glabld = l_apde.apdeld
      #   AND glab001 = '13'
      #   AND glab002 = l_pmab055
      #   AND glab003 = '8504_31'
      CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
         RETURNING l_apde.apde016   #albireo 160630 add
      
      LET l_apde.apde017 = l_apga.apga005
      LET l_apde.apde018 = NULL
      SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
       WHERE ooagent = g_enterprise
         AND ooag001 = l_apde.apde017
      #LET l_apde.apde019 =          
      CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
                 RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
      LET l_apde.apde028 = '2'
      LET l_apde.apde032 = l_apga.apga003
      LET l_apde.apde038 = l_apca.apca004
      LET l_apde.apde039 = l_apga.apga007
      SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      LET l_apde.apde100 = l_apga.apga100
      LET l_apde.apde101 = l_apga.apga101
      LET l_apde.apde104 = 0 
      LET l_apde.apde109 = l_apga.apga104
      #LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
      LET l_apde.apde119 = l_apga.apga114
      #s_curr_round
      CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
      LET lc_param2.apca004 = l_apca.apca004
      LET ls_js = util.JSON.stringify(lc_param2)
      CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
           RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
      #s_curr_round
      LET l_apde.apde101 = l_apga.apga101
      LET l_apde.apde120 = l_apca.apca120
      
      IF l_glaa015 = 'Y' THEN
         LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
         CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
      END IF
      
      LET l_apde.apde130 = l_apca.apca130
      IF l_glaa019 = 'Y' THEN
         LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
         CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
      END IF
      LET l_apde.apde061 = '51'
      IF l_apde.apde109 > 0 THEN
         INSERT INTO apde_t VALUES(l_apde.*)
      END IF
      
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '51'
      LET l_apcb.apcb002 = l_apga.apgadocno
      LET l_apcb.apcb003 = 0
      
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = ''
      #LET l_apcb.apcb021 = l_apgc.apgc004
      SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
       WHERE glabent = g_enterprise
         AND glabld = l_apde.apdeld
         AND glab001 = '15'      #albireo 160630
         AND glab002 = '3117'    #albireo 160630
         AND glab003 = '8504_32' #albireo 1606301
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
      LET l_apcb.apcb023 = 'N'
      #LET l_apcb.apcb027 = l_apgc.apgc008
      #LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apga.apga100   #albireo 160630
      LET l_apcb.apcb101 = l_apga.apga104   #albireo 160624 
      LET l_apcb.apcb102 = l_apga.apga101   #albireo 160630
      LET l_apcb.apcb103 = l_apga.apga104
      LET l_apcb.apcb104 = 0
      LET l_apcb.apcb105 = l_apga.apga104
      LET l_apcb.apcb108 = l_apga.apga104
      LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
      LET l_apcb.apcb113 = l_apga.apga114
      LET l_apcb.apcb114 = 0
      LET l_apcb.apcb115 = l_apga.apga114
      LET l_apcb.apcborga = l_apca.apcacomp
      LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
      LET l_apcb.apcb124 = 0
      LET l_apcb.apcb125 = l_apcb.apcb125
      LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
      LET l_apcb.apcb134 = 0
      LET l_apcb.apcb135 = l_apcb.apcb135
      IF l_apcb.apcb115 > 0 THEN
         INSERT INTO apcb_t VALUES(l_apcb.*)
         IF SQLCA.SQLCODE THEN
            LET r_success = FALSE
         END IF
      END IF
   END IF    #albireo 160711
   #自備款-----e
   
   #保證金-----s
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
    WHERE apdeent   = l_apde.apdeent
      AND apdeld    = l_apde.apdeld
      AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '23'
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apga.apga034    #albireo 160630
   LET l_apde.apde012 = l_apga.apga035    #albireo 160630
   LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_32'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apga.apga108   #albireo 1606301
   #LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
   LET l_apde.apde119 = l_apga.apga118
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '52'
   IF l_apde.apde109 > 0 THEN
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '52'
   LET l_apcb.apcb002 = l_apga.apgadocno
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
    WHERE glabent = g_enterprise
      AND glabld = l_apde.apdeld
      AND glab001 = '15'     #albireo 160630
      AND glab002 = '3117'   #albireo 160630
      AND glab003 = '8504_31'#albireo 1606301
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apga.apga100   #albireo 160630
   LET l_apcb.apcb101 = l_apga.apga108   #160624 albireo
   LET l_apcb.apcb102 = l_apga.apga101   #albireo 160630
   LET l_apcb.apcb103 = l_apga.apga108
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apga.apga108
   LET l_apcb.apcb108 = l_apga.apga108
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apga.apga118
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apga.apga118
   LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   
   IF l_apcb.apcb115 > 0 THEN
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF
   #保證金-----e
   
   #預付款-----s
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
    WHERE apdeent   = l_apde.apdeent
      AND apdeld    = l_apde.apdeld
      AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '23'
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apga.apga038    #albireo 160630
   LET l_apde.apde012 = l_apga.apga039    #albireo 160630
   LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '15'   #albireo 160630
   #   AND glab002 = '3117' #albireo 160630
   #   AND glab003 = '8504_33'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apga.apga102
   #LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
   LEt l_apde.apde119 = l_apga.apga112
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '53'
   IF l_apde.apde109 > 0 THEN
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '53'
   LET l_apcb.apcb002 = l_apga.apgadocno
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
    WHERE glabent = g_enterprise
      AND glabld = l_apde.apdeld
      AND glab001 = '15'    #albireo 160630
      AND glab002 = '3117'  #albireo 160630
      AND glab003 = '8504_33'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apga.apga100   #albireo 160630
   LET l_apcb.apcb101 = l_apga.apga102   #albireo 160624 add
   LET l_apcb.apcb102 = l_apga.apga101   #albireo 160630
   LET l_apcb.apcb103 = l_apga.apga102
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apga.apga102
   LET l_apcb.apcb108 = l_apga.apga102
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apga.apga112
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apga.apga112
     LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   IF l_apcb.apcb113 > 0 THEN
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF
   #預付款-----e
   
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
      
   LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
   SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
     INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld  = l_apca.apcald
      AND apcbdocno = l_apca.apcadocno
   IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
   IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
   IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
   
   UPDATE apca_t SET apca103 = l_apcb113sum,
                     apca104 = l_apcb114sum,
                     apca108 = l_apcb115sum,
                     apca113 = l_apcb113sum,
                     apca114 = l_apcb114sum,
                     apca118 = l_apcb115sum,
                     apca107 = l_apcb115sum,
                     apca117 = l_apcb115sum
    WHERE apcaent = g_enterprise
      AND apcald  = l_apca.apcald
      AND apcadocno = l_apca.apcadocno

   CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno

   UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
    WHERE apccent   = g_enterprise
      AND apccdocno = l_apca.apcadocno
      AND apccld    = l_apca.apcald
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e

   CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
                       RETURNING g_sub_success
   IF NOT g_sub_success THEN
      LET r_success = FALSE
   END IF
   
   #160824-00049#7-----s
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbdocno = l_apca.apcadocno
      AND apcbld = l_apca.apcald
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   
   IF l_count = 0 THEN
      LET r_success = FALSE
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'agl-00167'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   #160824-00049#7-----e
   
   UPDATE apga_t SET apga028 = l_apca.apcadocno
    WHERE apgaent = g_enterprise
      AND apgacomp = l_apca.apcacomp
      AND apgadocno = g_apca_m.apca018
   
   LET r_docno = l_apca.apcadocno
   RETURN r_success,r_docno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_ap_2()
DEFINE l_apca   RECORD LIKE apca_t.*
DEFINE l_desc   LIKE type_t.chr1000
DEFINE ls_js            STRING   
DEFINE lc_param_apca    RECORD
         apcald         LIKE apca_t.apcald,
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca001        LIKE apca_t.apca001,
         apca004        LIKE apca_t.apca004,
         ooef019        LIKE ooef_t.ooef019
                        END RECORD
DEFINE lc_param_info    RECORD
            apca005        LIKE apca_t.apca005,
            apca005_desc   LIKE type_t.chr80,
            apca006        LIKE apca_t.apca006,    #供應商分類
            apca007        LIKE apca_t.apca007,
            apca007_desc   LIKE type_t.chr80,
            apca008        LIKE apca_t.apca008,
            apca008_desc   LIKE type_t.chr80,
            apca009        LIKE apca_t.apca009,
            apca010        LIKE apca_t.apca010,
            apca011        LIKE apca_t.apca011,
            apca011_desc   LIKE type_t.chr80,
            apca012        LIKE apca_t.apca012,
            apca013        LIKE apca_t.apca013,
            apca014        LIKE apca_t.apca014,
            apca014_desc   LIKE type_t.chr80,
            apca015        LIKE apca_t.apca015,
            apca015_desc   LIKE type_t.chr80,
            apca034        LIKE apca_t.apca034,
            apca034_desc   LIKE type_t.chr80,
            apca035        LIKE apca_t.apca035,
            apca035_desc   LIKE type_t.chr80,
            apca036        LIKE apca_t.apca036,
            apca036_desc   LIKE type_t.chr80,
            apca046        LIKE apca_t.apca046,
            apca054        LIKE apca_t.apca054,
            apca054_desc   LIKE type_t.chr80,
            apca055        LIKE apca_t.apca055,
            apca055_desc   LIKE type_t.chr80,
            apca056        LIKE apca_t.apca056,
            apca058        LIKE apca_t.apca058,
            apca058_desc   LIKE type_t.chr80,
            apca060        LIKE apca_t.apca060,
            apca100        LIKE apca_t.apca100,
            apca101        LIKE apca_t.apca101,
            apca121        LIKE apca_t.apca121,
            apca131        LIKE apca_t.apca131
                       END RECORD
   DEFINE lc_param2        RECORD
         type           LIKE type_t.chr1,       #類型
         apca004        LIKE apca_t.apca004,
         sfin2009       LIKE type_t.chr1        #汇率基本    
         END RECORD
   DEFINE l_apga    RECORD LIKE apga_t.*
   DEFINE r_success LIKE type_t.num5
   DEFINE l_apgc    RECORD LIKE apgc_t.*
   DEFINE l_apcb    RECORD LIKE apcb_t.*
   DEFINE l_sql     STRING
   DEFINE l_isam    RECORD LIKE isam_t.*
   DEFINE l_ooef002     LIKE ooef_t.ooef002
   DEFINE l_ooefl006    LIKE ooefl_t.ooefl006
   DEFINE l_pmaal003    LIKE pmaal_t.pmaal003
   DEFINE l_isao001     LIKE isao_t.isao001
   DEFINE l_dummy1      LIKE type_t.num20_6
   DEFINE l_apde        RECORD LIKE apde_t.*
   DEFINE l_pmab055     LIKE pmab_t.pmab055
   DEFINE l_glaa121     LIKE glaa_t.glaa121
   DEFINE l_glaa016     LIKE glaa_t.glaa016
   DEFINE l_glaa020     LIKE glaa_t.glaa020
   DEFINE l_glaa019     LIKE glaa_t.glaa019
   DEFINE l_glaa015     LIKE glaa_t.glaa015
   DEFINE l_glaa001     LIKE glaa_t.glaa001
   DEFINE l_apgd        RECORD LIKE apgd_t.*
   DEFINE r_docno       LIKE apca_t.apcadocno
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   DEFINE l_apcb113sum  LIKE type_t.num20_6
   DEFINE l_apcb114sum  LIKE type_t.num20_6
   DEFINE l_apcb115sum  LIKE type_t.num20_6
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   DEFINE l_oodb004     LIKE oodb_t.oodb004
   DEFINE l_apca013     LIKE apca_t.apca013
   DEFINE l_apca012     LIKE apca_t.apca012
   DEFINE l_oodb011     LIKE oodb_t.oodb011
   DEFINE l_date        DATETIME YEAR TO SECOND
   DEFINE l_count       LIKE type_t.num10     #160824-00049#7
   DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE
   LET r_docno = NULL
   INITIALIZE l_apga.* TO NULL
   SELECT * INTO l_apga.* FROM apga_t WHERE apgaent = g_enterprise AND apgacomp = g_apcacomp AND apgadocno = g_apca_m.apca018
   SELECT * INTO l_apgd.* FROM apgd_t WHERE apgdent = g_enterprise AND apgdcomp = g_apcacomp AND apgddocno = g_apca_m.apca018 AND apgd900 = g_apca_m.apca064
   
   INITIALIZE l_apca.* TO NULL
   LET l_apca.apcaent = g_enterprise
   LET l_apca.apcacomp = l_apgd.apgdcomp
   LET l_apca.apcald = NULL
   SELECT glaald,glaa001,glaa016,glaa020
     INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
     FROM glaa_t
    WHERE glaaent  = g_enterprise
      AND glaacomp = l_apgd.apgdcomp    #160824-00049#7
      AND glaa014  = 'Y'
   LET l_apca.apcadocdt = g_apca_m.apcadocdt
   LET l_apca.apca003   = g_apca_m.apca003
   LET l_apca.apca016   = g_apca_m.apca016
   LET l_apca.apca018   = g_apca_m.apca018
   LET l_apca.apcadocno = g_apca_m.apcadocno
   CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
      RETURNING g_sub_success,l_apca.apcadocno                                            
   IF NOT g_sub_success THEN
      LET r_success = FALSE
      RETURN r_success,r_docno
   END IF
   LET l_apca.apcastus  = 'N' # 狀態碼 
   LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
   LET l_apca.apca001 =  s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
   LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
   LET l_apca.apca004 = l_apgd.apgd004 # 帳款對象編號                        apca004    = 廠商(受益人)apga004   
   CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
   IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
   SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
     FROM pmaa_t
    WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
   LET lc_param_apca.apcald   = l_apca.apcald
   LET lc_param_apca.apcacomp = l_apca.apcacomp
   LET lc_param_apca.apcasite = l_apca.apcasite
   LET lc_param_apca.apcadocdt= l_apca.apcadocdt
   LET lc_param_apca.apca001  = '19' #l_apca.apca001
   LET lc_param_apca.apca004  = l_apca.apca004
   SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = l_apca.apcacomp
   LET ls_js = util.JSON.stringify(lc_param_apca)
   CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
   CALL util.JSON.parse(ls_js,lc_param_info)
   LET l_apca.apca006 = lc_param_info.apca006  
   LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
   LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
   LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
   LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
   LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
   LET l_apca.apca014 = l_apgd.apgd005          # 人員編號           apca014    = apga005
   LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
   SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apca.apca014 
   LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
   LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
   LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
   LET l_apca.apca046 = lc_param_info.apca046       
   LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
   LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
   LET l_apca.apca058 = lc_param_info.apca058
   LET l_apca.apca060 = lc_param_info.apca060
   LET l_apca.apca016 = '32'
   LET l_apca.apca017 = '1'
   LET l_apca.apca018 = l_apgd.apgddocno
   LET l_apca.apca020 = 'N'         # 信用狀付款否 
   LET l_apca.apca026 = 0
   LET l_apca.apca027 = 0
   LET l_apca.apca028 = 0
   LET l_apca.apca029 = 0
   LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
   LET l_apca.apca064 = g_apca_m.apca064
   LET l_apca.apca067 = l_apga.apgadocno
   LET l_apca.apca101 = 1
   LET l_apca.apca103 = 0
   LET l_apca.apca104 = 0
   LET l_apca.apca106 = 0 
   LET l_apca.apca107 = 0
   LET l_apca.apca108 = 0 
   LET l_apca.apca113 = 0
   LET l_apca.apca114 = 0 
   LET l_apca.apca116 = 0
   LEt l_apca.apca117 = 0 
   LET l_apca.apca118 = 0 
   LET lc_param2.apca004 = l_apca.apca004
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
   LET ls_js = util.JSON.stringify(lc_param2)   
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
        RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
   LET l_apca.apca123 = 0
   LET l_apca.apca124 = 0
   LET l_apca.apca126 = 0 
   LET l_apca.apca127 = 0 
   LET l_apca.apca128 = 0
   LET l_apca.apca133 = 0 
   LET l_apca.apca134 = 0 
   LET l_apca.apca136 = 0 
   LET l_apca.apca137 = 0
   LET l_apca.apca138 = 0 
   LET l_apca.apca071 = 0
   LET l_apca.apca072 = 0
   #albireo 160624-----s
   LEt l_apca.apca073 = l_apga.apga001
   LET l_apca.apcaownid = g_user
   LET l_apca.apcaowndp = g_dept
   LET l_apca.apcacrtid = g_user
   LET l_apca.apcacrtdp = g_dept
   LET l_date = cl_get_current()
   LET l_apca.apcacrtdt = l_date
   #albireo 160624-----e
   INSERT INTO apca_t VALUES(l_apca.*)
   
   #apgc產生 apcb xrcd_t
   LET l_sql = "SELECT * FROM apgc_t ",
               " WHERE apgcent = ",g_enterprise," ",
               "   AND apgccomp = '",l_apga.apgacomp,"' ",
               "   AND apgcdocno = '",l_apga.apgadocno,"' ",
               "   AND apgc900 = ? "
   PREPARE sel_apgcp2 FROM l_sql
   DECLARE sel_apgcc2 CURSOR FOR sel_apgcp2
   
   FOREACH sel_apgcc2 USING g_apca_m.apca064 INTO l_apgc.*
      IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
      #r2.產生apcb-----s
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '54'
      LET l_apcb.apcb002 = l_apgc.apgcdocno
      LET l_apcb.apcb003 = l_apgc.apgcseq
      LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = l_apgc.apgc006
      LET l_apcb.apcb021 = l_apgc.apgc004
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
      LET l_apcb.apcb023 = 'N'
      LET l_apcb.apcb027 = l_apgc.apgc008
      LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apgc.apgc100
      LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
      LET l_apcb.apcb102 = l_apgc.apgc101
      LET l_apcb.apcb103 = l_apgc.apgc103
      LET l_apcb.apcb104 = l_apgc.apgc104
      LET l_apcb.apcb105 = l_apgc.apgc105
      LET l_apcb.apcb108 = l_apcb.apcb103
      LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
      LET l_apcb.apcb113 = l_apgc.apgc113
      LET l_apcb.apcb114 = l_apgc.apgc114
      LET l_apcb.apcb115 = l_apgc.apgc115
      LET l_apcb.apcborga = l_apgc.apgcorga
      CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
      IF l_apca013 = 'Y' THEN
         LET l_apcb.apcb105 = l_apcb.apcb105
      ELSE
         LET l_apcb.apcb105 = l_apcb.apcb103
      END IF
      CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
                l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                    l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                    l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                    l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
         LET r_success = FALSE
      END IF
      #r2.產生apcb-----e
      
      #r3.產生直接付款apde-----s
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent  =l_apca.apcaent
      LET l_apde.apdeld =l_apca.apcald
      LET l_apde.apdecomp =l_apca.apcacomp
      LET l_apde.apdeorga =l_apca.apcacomp
      LET l_apde.apdesite =l_apca.apcasite
      LET l_apde.apdedocno =l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      LET l_apde.apde001 = 'aapt560'
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde028 = '0'
      LET l_apde.apde002 = '10'
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
      #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
      LET l_apde.apde109 =  l_apgc.apgc105
      LET l_apde.apde119 =  l_apgc.apgc115
      LET l_apde.apde006 = '10'   
      #銀行存提碼
      LET l_apde.apde011 = l_apgc.apgc015
      #現金變動碼
      LET l_apde.apde012 = l_apgc.apgc016
      LET l_apde.apde013 = ''
      LET l_apde.apde014 = ''
      LET l_apde.apde016 = ''
      LET l_apde.apde100 = l_apgc.apgc100
      LET l_apde.apde101 = l_apgc.apgc101
      LET l_apde.apde039 = l_apga.apga007
      LET l_apde.apde041 = NULL
      SELECT nmabl003 INTO l_apde.apde041
        FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
      LET l_apde.apde032 = l_apca.apcadocdt
      LET l_apde.apde061 = '54'
      #LET l_apde.apde016 = l_apgc.apgc004   #160824-00049#7 mark
      LET l_apde.apde008 = l_apgc.apgc014
      #160824-00049#7-----s
       CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016
      #160824-00049#7-----e
      INSERT INTO apde_t(apdeent,
                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                         apde001,apde009,apde028,apde002,apde015,
                         apde003,apde004,apdeorga,apde006,apde011,
                         apde012,apde013,apde014,apde016,apde017,
                         apde018,apde021,apde032,apde100,apde101,
                         apde039,apde040,apde041,
                         apde008,
                         apde109,apde119,apde061)
             VALUES(l_apde.apdeent,
                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                    l_apde.apde039,l_apde.apde040,l_apde.apde041,
                    l_apde.apde008,
                    l_apde.apde109,l_apde.apde119,l_apde.apde061)
      IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
      #r3.產生直接付款apde-----e
      
      #INSERT isam
      INITIALIZE l_isam.* TO NULL
      LET l_isam.isament = l_apca.apcaent
      LET l_isam.isamdocno = l_apca.apcadocno
      SELECT MAX(isamseq)+1 INTO l_isam.isamseq
        FROM isam_t
       WHERE isament = g_enterprise
         AND isamdocno = l_apca.apcadocno
         AND isam001 = 'aapt560'
      IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
      LET l_isam.isam001 = 'aapt560'
      LET l_isam.isam002 = l_apca.apca004                           
      LET l_isam.isam008 = l_apgc.apgc007                           
      LET l_isam.isam009 = l_apgc.apgc008                           
      LET l_isam.isam010 = l_apgc.apgc009                           
      LET l_isam.isam011 = l_apgc.apgc010                           
      LET l_isam.isam012 = l_apgc.apgc006        
      LET l_isam.isam0121= l_apca.apca013                  
      LET l_isam.isam013 = l_apca.apca012
      LET l_isam.isam014 = l_apgc.apgc100                           
      LET l_isam.isam015 = l_apgc.apgc101                           
      LET l_isam.isam016 = l_ooefl006
      LET l_isam.isam017 = l_ooef002
      CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
                 l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
      LET l_isam.isam023 = l_apgc.apgc103                           
      LET l_isam.isam024 = l_apgc.apgc104                           
      LET l_isam.isam025 = l_apgc.apgc105                           
      LET l_isam.isam026 = l_apgc.apgc113                           
      LET l_isam.isam027 = l_apgc.apgc114                           
      LET l_isam.isam028 = l_apgc.apgc115                           
      LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  

      SELECT isak008,isak009,isak010,isak011,isak012
        INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
             l_isam.isam033,l_isam.isam034
        FROM isak_t
       WHERE isakent = g_enterprise
         AND isak001 = l_apca.apca004
         AND isak002 = lc_param_apca.ooef019
        
      LET l_isam.isam035 = '1'                                 
      LET l_isam.isam036 = '11'                                
      LET l_isam.isam037 = l_apgc.apgc011                           
      LET l_isam.isam050 = l_apca.apcadocno                         
      LET l_isam.isam107    = 0                                 
      LET l_isam.isam108    = 0                                 
      LET l_isam.isam117    = 0                                 
      LET l_isam.isam118    = 0
      IF NOT cl_null(l_isam.isam010)THEN
         INSERT INTO isam_t VALUES(l_isam.*)      
      END IF  
   END FOREACH
   
   #161004-00019#1-----s
   CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
   UPDATE xrcd_t SET xrcd009 = l_xrcd009
    WHERE xrcdent= g_enterprise
      AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
      AND xrcd009 IS NULL
   #161004-00019#1-----e
   
   LET l_pmab055 = NULL
   SELECT pmab055 INTO l_pmab055 FROM pmab_t
    WHERE pmabsite = l_apca.apcacomp
      AND pmab001 = l_apca.apca004
      AND pmabent = g_enterprise
   
   #自備款-----s
   IF l_apga.apga026 = 'Y' THEN   #albireo 160711 add
      LET l_apga.apga104 = NULL
      SELECT (apgh005-apgh004) INTO l_apga.apga104 FROM apgh_t
       WHERE apghent = g_enterprise
         AND apghcomp = l_apga.apgacomp
         AND apghdocno = l_apga.apgadocno
         AND apghseq = 0
         AND apgh001 = l_apgd.apgd900
         AND apgh002 = 'apga104'
      IF cl_null(l_apga.apga104) THEN LET l_apga.apga104 = 0 END IF
      #160824-00049#7-----s
      LET l_apga.apga114 = NULL
      SELECT (apgh005-apgh004) INTO l_apga.apga114 FROM apgh_t
       WHERE apghent = g_enterprise
         AND apghcomp = l_apga.apgacomp
         AND apghdocno = l_apga.apgadocno
         AND apghseq = 0
         AND apgh001 = l_apgd.apgd900
         AND apgh002 = 'apga114'
      IF cl_null(l_apga.apga114) THEN LET l_apga.apga114 = 0 END IF
      #160824-00049#7-----e

      LET l_glaa121 = NULL LET l_glaa016 = NULL
      LET l_glaa020 = NULL LET l_glaa019 = NULL
      LET l_glaa015 = NULL
      SELECT glaa121,glaa016,glaa020 ,
             glaa015,glaa019
        INTO l_glaa121,l_glaa016,l_glaa020,
             l_glaa015,l_glaa019
        FROM glaa_t
       WHERE glaaent = g_enterprise
         AND glaald = l_apca.apcald
      
      
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent   = g_enterprise
      LET l_apde.apdecomp  = l_apca.apcacomp
      LET l_apde.apdeld    = l_apca.apcald
      LET l_apde.apdedocno = l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      #albireo 160624-----s
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      #albireo 160624-----e
      LET l_apde.apdesite  = l_apca.apcasite
      LET l_apde.apdeorga  = l_apca.apcasite
      LET l_apde.apde001   = 'aapt560'
      LET l_apde.apde002   = '23'
      LET l_apde.apde006   = '10'
      LET l_apde.apde008   = l_apga.apga040
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde011 = l_apga.apga036
      LET l_apde.apde012 = l_apga.apga037
      LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
      LET l_apde.apde016 = NULL
      #SELECT glab005 INTO l_apde.apde016 FROM glab_t
      # WHERE glabent = g_enterprise
      #   AND glabld = l_apde.apdeld
      #   AND glab001 = '13'
      #   AND glab002 = l_pmab055
      #   AND glab003 = '8504_31'
      CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
         RETURNING l_apde.apde016   #albireo 160630 add
      LET l_apde.apde017 = l_apga.apga005
      LET l_apde.apde018 = NULL
      SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
       WHERE ooagent = g_enterprise
         AND ooag001 = l_apde.apde017
      #LET l_apde.apde019 =          
      CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
                 RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
      LET l_apde.apde028 = '2'
      LET l_apde.apde032 = l_apga.apga003
      LET l_apde.apde038 = l_apca.apca004
      LET l_apde.apde039 = l_apga.apga007
      SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      LET l_apde.apde100 = l_apga.apga100
      LET l_apde.apde101 = l_apga.apga101
      LET l_apde.apde104 = 0 
      LET l_apde.apde109 = l_apga.apga104
      LET l_apde.apde119 = l_apga.apga114   #160824-00049#7
      #s_curr_round
      CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
      LET lc_param2.apca004 = l_apca.apca004
      LET ls_js = util.JSON.stringify(lc_param2)
      CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
           RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
      #s_curr_round
      LET l_apde.apde101 = l_apga.apga101
      LET l_apde.apde120 = l_apca.apca120
      
      IF l_glaa015 = 'Y' THEN
         LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
         CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
      END IF
      
      LET l_apde.apde130 = l_apca.apca130
      IF l_glaa019 = 'Y' THEN
         LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
         CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
      END IF
      LET l_apde.apde061 = '51'
      IF l_apde.apde109 > 0 THEN
         INSERT INTO apde_t VALUES(l_apde.*)
      END IF
      
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '51'
      LET l_apcb.apcb002 = l_apga.apgadocno
      LET l_apcb.apcb003 = 0
      
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = ''
      #LET l_apcb.apcb021 = l_apgc.apgc004
      SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
       WHERE glabent = g_enterprise
         AND glabld = l_apde.apdeld
         AND glab001 = '15'
         AND glab002 = '3117'
         AND glab003 = '8504_31'
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
      LET l_apcb.apcb023 = 'N'
      #LET l_apcb.apcb027 = l_apgc.apgc008
      #LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apga.apga100   #albireo 160630
      LET l_apcb.apcb101 = l_apga.apga104   #albireo 160624
      LET l_apcb.apcb102 = l_apga.apga101   #albireo 160630
      LET l_apcb.apcb103 = l_apga.apga104
      LET l_apcb.apcb104 = 0
      
      LET l_apcb.apcb105 = l_apga.apga104
      LET l_apcb.apcb108 = l_apga.apga104
      LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
      LET l_apcb.apcb113 = l_apga.apga114
      LET l_apcb.apcb114 = 0
      LET l_apcb.apcb115 = l_apga.apga114
  LET l_apcb.apcborga = l_apca.apcacomp
      LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
      LET l_apcb.apcb124 = 0
      LET l_apcb.apcb125 = l_apcb.apcb125
      LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
      LET l_apcb.apcb134 = 0
      LET l_apcb.apcb135 = l_apcb.apcb135
      IF l_apcb.apcb115 > 0 THEN
         INSERT INTO apcb_t VALUES(l_apcb.*)
         IF SQLCA.SQLCODE THEN
            LET r_success = FALSE
         END IF
      END IF
   END IF
   #自備款-----e
   
   #保證金-----s
   LET l_apga.apga108 = NULL
   SELECT (apgh005-apgh004) INTO l_apga.apga108 FROM apgh_t
    WHERE apghent = g_enterprise
      AND apghcomp = l_apga.apgacomp
      AND apghdocno = l_apga.apgadocno
      AND apghseq = 0
      AND apgh001 = l_apgd.apgd900
      AND apgh002 = 'apga108'
   IF cl_null(l_apga.apga108) THEN LET l_apga.apga108 = 0 END IF
   #160824-00049#7-----s
   LET l_apga.apga118 = NULL
   SELECT (apgh005-apgh004) INTO l_apga.apga118 FROM apgh_t
    WHERE apghent = g_enterprise
      AND apghcomp = l_apga.apgacomp
      AND apghdocno = l_apga.apgadocno
      AND apghseq = 0
      AND apgh001 = l_apgd.apgd900
      AND apgh002 = 'apga118'
   IF cl_null(l_apga.apga118) THEN LET l_apga.apga118 = 0 END IF   
   #160824-00049#7-----e
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
    WHERE apdeent   = l_apde.apdeent
      AND apdeld    = l_apde.apdeld
      AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '23'
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apga.apga034    #albireo 160630
   LET l_apde.apde012 = l_apga.apga035    #albireo 160630
   LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_32'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang   #albireo 160729 add
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apga.apga108   #160824-00049#7 
   LET l_apde.apde119 = l_apga.apga118   #160824-00049#7
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '52'
   IF l_apde.apde109 > 0 THEN
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '52'
   LET l_apcb.apcb002 = l_apga.apgadocno
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
    WHERE glabent = g_enterprise
      AND glabld = l_apde.apdeld
      AND glab001 = '15'
      AND glab002 = '3117'
      AND glab003 = '8504_32'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apga.apga100   #albireo 160630
   LET l_apcb.apcb101 = l_apga.apga108   #160624 albireo
   LET l_apcb.apcb102 = l_apga.apga101   #albireo 160630
   LET l_apcb.apcb103 = l_apga.apga108
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apga.apga108
   LET l_apcb.apcb108 = l_apga.apga108
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apga.apga118
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apga.apga118
  LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   IF l_apcb.apcb115 > 0 THEN
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF
   #保證金-----e
   
   #預付款-----s
   LET l_apga.apga102 = NULL
   SELECT (apgh005-apgh004) INTO l_apga.apga102 FROM apgh_t
    WHERE apghent = g_enterprise
      AND apghcomp = l_apga.apgacomp
      AND apghdocno = l_apga.apgadocno
      AND apghseq = 0
      AND apgh001 = l_apgd.apgd900
      AND apgh002 = 'apga102'
   IF cl_null(l_apga.apga102) THEN LET l_apga.apga102 = 0 END IF
   #160824-00049#7-----s
   LET l_apga.apga112 = NULL
   SELECT (apgh005-apgh004) INTO l_apga.apga112 FROM apgh_t
    WHERE apghent = g_enterprise
      AND apghcomp = l_apga.apgacomp
      AND apghdocno = l_apga.apgadocno
      AND apghseq = 0
      AND apgh001 = l_apgd.apgd900
      AND apgh002 = 'apga112'
   IF cl_null(l_apga.apga112) THEN LET l_apga.apga112 = 0 END IF   
   #160824-00049#7-----e
   
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
    WHERE apdeent   = l_apde.apdeent
      AND apdeld    = l_apde.apdeld
      AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '23'
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apga.apga038    #albireo 160630
   LET l_apde.apde012 = l_apga.apga039    #albireo 160630
   LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_33'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang   #albireo 160729 add
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apga.apga102
   LET l_apde.apde119 = l_apga.apga112   #160824-00049#7
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '53'
   IF l_apde.apde109 > 0 THEN
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '53'
   LET l_apcb.apcb002 = l_apga.apgadocno
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
    WHERE glabent = g_enterprise
      AND glabld = l_apde.apdeld
      AND glab001 = '15'
      AND glab002 = '3117'
      AND glab003 = '8504_33'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apga.apga100   #albireo 160630
   LET l_apcb.apcb101 = l_apga.apga102   #albireo 160624 add
   LET l_apcb.apcb102 = l_apga.apga101   #albireo 160630
   LET l_apcb.apcb103 = l_apga.apga102
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apga.apga102
   LET l_apcb.apcb108 = l_apga.apga102
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apga.apga112
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apga.apga112
  LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   IF l_apcb.apcb113 > 0 THEN
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF
   #預付款-----e
   
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
      
   LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
   SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
     INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld  = l_apca.apcald
      AND apcbdocno = l_apca.apcadocno
   IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
   IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
   IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
   
   UPDATE apca_t SET apca103 = l_apcb113sum,
                     apca104 = l_apcb114sum,
                     apca108 = l_apcb115sum,
                     apca113 = l_apcb113sum,
                     apca114 = l_apcb114sum,
                     apca118 = l_apcb115sum,
                     #160824-00049#7-----s
                     apca107 = l_apcb115sum,
                     apca117 = l_apcb115sum
                     #160824-00049#7-----e
    WHERE apcaent = g_enterprise
      AND apcald  = l_apca.apcald
      AND apcadocno = l_apca.apcadocno

   CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno

   UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
    WHERE apccent = g_enterprise
      AND apccdocno = l_apca.apcadocno
      AND apccld    = l_apca.apcald
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e

   CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
                       RETURNING g_sub_success
   IF NOT g_sub_success THEN
      LET r_success = FALSE
   END IF   
   
   #160824-00049#7-----s
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbdocno = l_apca.apcadocno
      AND apcbld = l_apca.apcald
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   
   IF l_count = 0 THEN
      LET r_success = FALSE
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'agl-00167'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   #160824-00049#7-----e
   
   
   UPDATE apgd_t SET apgd028 = l_apca.apcadocno
    WHERE apgdent = g_enterprise
      AND apgdcomp = l_apca.apcacomp
      AND apgddocno = g_apca_m.apca018
      AND apgd900   = g_apca_m.apca064
   LET r_docno = l_apca.apcadocno
   RETURN r_success,r_docno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_ap_3()
DEFINE l_apca   RECORD LIKE apca_t.*
DEFINE l_desc   LIKE type_t.chr1000
DEFINE ls_js            STRING   
DEFINE lc_param_apca    RECORD
         apcald         LIKE apca_t.apcald,
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca001        LIKE apca_t.apca001,
         apca004        LIKE apca_t.apca004,
         ooef019        LIKE ooef_t.ooef019
                        END RECORD
DEFINE lc_param_info    RECORD
            apca005        LIKE apca_t.apca005,
            apca005_desc   LIKE type_t.chr80,
            apca006        LIKE apca_t.apca006,    #供應商分類
            apca007        LIKE apca_t.apca007,
            apca007_desc   LIKE type_t.chr80,
            apca008        LIKE apca_t.apca008,
            apca008_desc   LIKE type_t.chr80,
            apca009        LIKE apca_t.apca009,
            apca010        LIKE apca_t.apca010,
            apca011        LIKE apca_t.apca011,
            apca011_desc   LIKE type_t.chr80,
            apca012        LIKE apca_t.apca012,
            apca013        LIKE apca_t.apca013,
            apca014        LIKE apca_t.apca014,
            apca014_desc   LIKE type_t.chr80,
            apca015        LIKE apca_t.apca015,
            apca015_desc   LIKE type_t.chr80,
            apca034        LIKE apca_t.apca034,
            apca034_desc   LIKE type_t.chr80,
            apca035        LIKE apca_t.apca035,
            apca035_desc   LIKE type_t.chr80,
            apca036        LIKE apca_t.apca036,
            apca036_desc   LIKE type_t.chr80,
            apca046        LIKE apca_t.apca046,
            apca054        LIKE apca_t.apca054,
            apca054_desc   LIKE type_t.chr80,
            apca055        LIKE apca_t.apca055,
            apca055_desc   LIKE type_t.chr80,
            apca056        LIKE apca_t.apca056,
            apca058        LIKE apca_t.apca058,
            apca058_desc   LIKE type_t.chr80,
            apca060        LIKE apca_t.apca060,
            apca100        LIKE apca_t.apca100,
            apca101        LIKE apca_t.apca101,
            apca121        LIKE apca_t.apca121,
            apca131        LIKE apca_t.apca131
                       END RECORD
   DEFINE lc_param2        RECORD
         type           LIKE type_t.chr1,       #類型
         apca004        LIKE apca_t.apca004,
         sfin2009       LIKE type_t.chr1        #汇率基本    
         END RECORD
   DEFINE l_apga    RECORD LIKE apga_t.*
   DEFINE r_success LIKE type_t.num5
   DEFINE l_apgc    RECORD LIKE apgc_t.*
   DEFINE l_apcb    RECORD LIKE apcb_t.*
   DEFINE l_sql     STRING
   DEFINE l_isam    RECORD LIKE isam_t.*
   DEFINE l_ooef002     LIKE ooef_t.ooef002
   DEFINE l_ooefl006    LIKE ooefl_t.ooefl006
   DEFINE l_pmaal003    LIKE pmaal_t.pmaal003
   DEFINE l_isao001     LIKE isao_t.isao001
   DEFINE l_dummy1      LIKE type_t.num20_6
   DEFINE l_apde        RECORD LIKE apde_t.*
   DEFINE l_pmab055     LIKE pmab_t.pmab055
   DEFINE l_glaa121     LIKE glaa_t.glaa121
   DEFINE l_glaa016     LIKE glaa_t.glaa016
   DEFINE l_glaa020     LIKE glaa_t.glaa020
   DEFINE l_glaa019     LIKE glaa_t.glaa019
   DEFINE l_glaa015     LIKE glaa_t.glaa015
   DEFINE l_glaa001     LIKE glaa_t.glaa001
   DEFINE l_apgi        RECORD LIKE apgi_t.*
   DEFINE r_docno       LIKE apga_t.apgadocno
   DEFINE l_date        DATETIME YEAR TO SECOND
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   DEFINE l_apcb113sum  LIKE type_t.num20_6
   DEFINE l_apcb114sum  LIKE type_t.num20_6
   DEFINE l_apcb115sum  LIKE type_t.num20_6
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   DEFINE l_oodb004     LIKE oodb_t.oodb004
   DEFINE l_apca013     LIKE apca_t.apca013
   DEFINE l_apca012     LIKE apca_t.apca012
   DEFINE l_oodb011     LIKE oodb_t.oodb011
   #160824-00049#7-----s
   #GROUP BY apgc對象
   DEFINE l_apca004     LIKE apca_t.apca004
   #160824-00049#7-----e
   DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE
   LET r_docno = NULL
   INITIALIZE l_apgi.* TO NULL
   SELECT * INTO l_apgi.* FROM apgi_t WHERE apgient = g_enterprise AND apgicomp = g_apcacomp AND apgidocno = g_apca_m.apca018
   INITIALIZE l_apga.* TO NULL
   SELECT * INTO l_apga.* FROM apga_t WHERE apgaent = g_enterprise AND apgacomp = g_apcacomp AND apgadocno = l_apgi.apgi002
   
   #160824-00049#7-----s
   LET l_sql = "SELECT DISTINCT apgc002 FROM apgc_t ",
               " WHERE apgcent = ",g_enterprise," ",
               "   AND apgccomp = '",g_apcacomp,"' ",
               "   AND apgcdocno = '",g_apca_m.apca018,"' ",
               "   AND apgc900 = 0 "
   PREPARE sel_apgcp31 FROM l_sql
   DECLARE sel_apgcc31 CURSOR FOR sel_apgcp31
   FOREACH sel_apgcc31 INTO l_apca004
      IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
      INITIALIZE l_apca.* TO NULL
      LET l_apca.apcaent = g_enterprise
      LET l_apca.apcacomp = l_apga.apgacomp
      LET l_apca.apcald = NULL
      SELECT glaald,glaa001,glaa016,glaa020
        INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
        FROM glaa_t
       WHERE glaaent  = g_enterprise
         AND glaacomp = l_apca.apcacomp
         AND glaa014  = 'Y'
      LET l_apca.apcadocdt = g_apca_m.apcadocdt
      LET l_apca.apca003   = g_apca_m.apca003
      LET l_apca.apca016   = g_apca_m.apca016
      LET l_apca.apca018   = g_apca_m.apca018
      LET l_apca.apcadocno = g_apca_m.apcadocno
      CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
         RETURNING g_sub_success,l_apca.apcadocno                                            
      IF NOT g_sub_success THEN
         LET r_success = FALSE
         RETURN r_success,r_docno
      END IF
      LET l_apca.apcastus  = 'N' # 狀態碼 
      LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
      LET l_apca.apca001 =  s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
      LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
      LET l_apca.apca004 = l_apca004 # 帳款對象編號 廠商(受益人)apga004 
      CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
      IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
      SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
        FROM pmaa_t
       WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
      LET lc_param_apca.apcald   = l_apca.apcald
      LET lc_param_apca.apcacomp = l_apca.apcacomp
      LET lc_param_apca.apcasite = l_apca.apcasite
      LET lc_param_apca.apcadocdt= l_apca.apcadocdt
      LET lc_param_apca.apca001  = '19'   #l_apca.apca001
      LET lc_param_apca.apca004  = l_apca.apca004
      SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_apca.apcacomp
      LET ls_js = util.JSON.stringify(lc_param_apca)
      CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
      CALL util.JSON.parse(ls_js,lc_param_info)
      LET l_apca.apca006 = lc_param_info.apca006  
      LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
      LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
      LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
      LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
      LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
      LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
      LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
      LET l_apca.apca014 = l_apga.apga005          # 人員編號           apca014    = apga005
      LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
      SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
       WHERE ooagent = g_enterprise
         AND ooag001 = l_apca.apca014 
      LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
      LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
      LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
      LET l_apca.apca046 = lc_param_info.apca046       
      LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
      LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
      LET l_apca.apca058 = lc_param_info.apca058
      LET l_apca.apca060 = lc_param_info.apca060
      LET l_apca.apca016 = '33'
      LET l_apca.apca017 = '1'
      LET l_apca.apca018 = l_apgi.apgidocno
      LET l_apca.apca020 = 'N'         # 信用狀付款否 
      LET l_apca.apca026 = 0
      LET l_apca.apca027 = 0
      LET l_apca.apca028 = 0
      LET l_apca.apca029 = 0
      LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
      LET l_apca.apca067 = l_apga.apgadocno
      LET l_apca.apca101 = 1
      LET l_apca.apca103 = 0
      LET l_apca.apca104 = 0
      LET l_apca.apca106 = 0 
      LET l_apca.apca107 = 0
      LET l_apca.apca108 = 0 
      LET l_apca.apca113 = 0
      LET l_apca.apca114 = 0 
      LET l_apca.apca116 = 0
      LEt l_apca.apca117 = 0 
      LET l_apca.apca118 = 0 
      LET lc_param2.apca004 = l_apca.apca004
      CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
      LET ls_js = util.JSON.stringify(lc_param2)   
      CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
           RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
      LET l_apca.apca123 = 0
      LET l_apca.apca124 = 0
      LET l_apca.apca126 = 0 
      LET l_apca.apca127 = 0 
      LET l_apca.apca128 = 0
      LET l_apca.apca133 = 0 
      LET l_apca.apca134 = 0 
      LET l_apca.apca136 = 0 
      LET l_apca.apca137 = 0
      LET l_apca.apca138 = 0 
      LET l_apca.apca071 = 0
      LET l_apca.apca072 = 0
      #albireo 160624-----s
      LEt l_apca.apca073 = l_apga.apga001
      LET l_apca.apcaownid = g_user
      LET l_apca.apcaowndp = g_dept
      LET l_apca.apcacrtid = g_user
      LET l_apca.apcacrtdp = g_dept
      LET l_date = cl_get_current()
      LET l_apca.apcacrtdt = l_date
      #albireo 160624-----e
      INSERT INTO apca_t VALUES(l_apca.*)      

      #apgc產生 apcb xrcd_t
      LET l_sql = "SELECT * FROM apgc_t ",
                  " WHERE apgcent = ",g_enterprise," ",
                  "   AND apgccomp = '",l_apgi.apgicomp,"' ",
                  "   AND apgcdocno = '",l_apgi.apgidocno,"' ",
                  "   AND apgc900 = '0' ",
                  "   AND apgc002 = '",l_apca004,"' "
      PREPARE sel_apgcp32 FROM l_sql
      DECLARE sel_apgcc32 CURSOR FOR sel_apgcp32
      
      FOREACH sel_apgcc32 INTO l_apgc.*
         IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
         #r2.產生apcb-----s
         INITIALIZE l_apcb.* TO NULL
         LET l_apcb.apcbent   = g_enterprise
         LET l_apcb.apcbld    = l_apca.apcald
         LET l_apcb.apcblegl  = l_apca.apcacomp
         LET l_apcb.apcbsite  = l_apca.apcasite
         LET l_apcb.apcbdocno = l_apca.apcadocno
         LET l_apcb.apcbseq   = NULL
         SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
          WHERE apcbent   = g_enterprise
            AND apcbld    = l_apcb.apcbld
            AND apcbdocno = l_apcb.apcbdocno
         IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
         LET l_apcb.apcb001 = '54'
         LET l_apcb.apcb002 = l_apgc.apgcdocno
         LET l_apcb.apcb003 = l_apgc.apgcseq
         LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
         LET l_apcb.apcb006 = ' '
         LET l_apcb.apcb007 = 1
         LET l_apcb.apcb010 = l_apca.apca015
         CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                          RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
         LET l_apcb.apcb020 = l_apgc.apgc006
         LET l_apcb.apcb021 = l_apgc.apgc004
         LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
         LET l_apcb.apcb023 = 'N'
         LET l_apcb.apcb027 = l_apgc.apgc008
         LET l_apcb.apcb028 = l_apgc.apgc009
         LET l_apcb.apcb029 = l_apca.apca035
         LET l_apcb.apcb030 = l_apca.apca008
         LET l_apcb.apcb051 = l_apca.apca014
         LET l_apcb.apcb100 = l_apgc.apgc100
         LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
         LET l_apcb.apcb102 = l_apgc.apgc101
         LET l_apcb.apcb103 = l_apgc.apgc103
         LET l_apcb.apcb104 = l_apgc.apgc104
         LET l_apcb.apcb105 = l_apgc.apgc105
         LET l_apcb.apcb108 = l_apcb.apcb103
         LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
         LET l_apcb.apcb113 = l_apgc.apgc113
         LET l_apcb.apcb114 = l_apgc.apgc114
         LET l_apcb.apcb115 = l_apgc.apgc115
         LET l_apcb.apcborga = l_apgc.apgcorga
         CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
         IF l_apca013 = 'Y' THEN
            LET l_apcb.apcb105 = l_apcb.apcb105
         ELSE
            LET l_apcb.apcb105 = l_apcb.apcb103
         END IF
         CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
                   l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
             RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                       l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                       l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                       l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
         INSERT INTO apcb_t VALUES(l_apcb.*)
         IF SQLCA.SQLCODE THEN
            EXIT FOREACH
            LET r_success = FALSE
         END IF
         #r2.產生apcb-----e
         
         #r3.產生直接付款apde-----s
         INITIALIZE l_apde.* TO NULL
         LET l_apde.apdeent  =l_apca.apcaent
         LET l_apde.apdeld =l_apca.apcald
         LET l_apde.apdecomp =l_apca.apcacomp
         LET l_apde.apdeorga =l_apca.apcacomp
         LET l_apde.apdesite =l_apca.apcasite
         LET l_apde.apdedocno =l_apca.apcadocno
         SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
          WHERE apdeent   = l_apde.apdeent
            AND apdeld    = l_apde.apdeld
            AND apdedocno = l_apde.apdedocno
         IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
         LET l_apde.apdeseq = l_apde.apdeseq + 1
         LET l_apde.apde001 = 'aapt560'
         LET l_apde.apde009 = 'Y'
         LET l_apde.apde028 = '0'
         LET l_apde.apde002 = '10'
         LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
         #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
         LET l_apde.apde109 =  l_apgc.apgc105
         LET l_apde.apde119 =  l_apgc.apgc115
         LET l_apde.apde006 = '10'   
         #銀行存提碼
         LET l_apde.apde011 = l_apgc.apgc015
         #現金變動碼
         LET l_apde.apde012 = l_apgc.apgc016
         LET l_apde.apde013 = ''
         LET l_apde.apde014 = ''
         LET l_apde.apde016 = ''
         LET l_apde.apde100 = l_apgc.apgc100
         LET l_apde.apde101 = l_apgc.apgc101
         LET l_apde.apde039 = l_apga.apga007
         LET l_apde.apde041 = NULL
         SELECT nmabl003 INTO l_apde.apde041
           FROM nmabl_t
          WHERE nmablent = g_enterprise
            AND nmabl001 = l_apde.apde039
            AND nmabl002 = g_dlang
         IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
         LET l_apde.apde032 = l_apca.apcadocdt
         LET l_apde.apde061 = '54'
         LET l_apde.apde016 = l_apgc.apgc004
         LET l_apde.apde008 = l_apgc.apgc014
         #160824-00049#7-----s
         CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
            RETURNING l_apde.apde016
         #160824-00049#7-----e
         INSERT INTO apde_t(apdeent,
                            apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                            apde001,apde009,apde028,apde002,apde015,
                            apde003,apde004,apdeorga,apde006,apde011,
                            apde012,apde013,apde014,apde016,apde017,
                            apde018,apde021,apde032,apde100,apde101,
                            apde039,apde040,apde041,
                            apde008,
                            apde109,apde119,apde061)
                VALUES(l_apde.apdeent,
                       l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                       l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                       l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                       l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                       l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                       l_apde.apde039,l_apde.apde040,l_apde.apde041,
                       l_apde.apde008,
                       l_apde.apde109,l_apde.apde119,l_apde.apde061)
         IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
         #r3.產生直接付款apde-----e
         
         #INSERT isam
         INITIALIZE l_isam.* TO NULL
         LET l_isam.isament = l_apca.apcaent
         LET l_isam.isamdocno = l_apca.apcadocno
         SELECT MAX(isamseq)+1 INTO l_isam.isamseq
           FROM isam_t
          WHERE isament = g_enterprise
            AND isamdocno = l_apca.apcadocno
            AND isam001 = 'aapt560'
         IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
         LET l_isam.isam001 = 'aapt560'
         LET l_isam.isam002 = l_apca.apca004                           
         LET l_isam.isam008 = l_apgc.apgc007                           
         LET l_isam.isam009 = l_apgc.apgc008                           
         LET l_isam.isam010 = l_apgc.apgc009                           
         LET l_isam.isam011 = l_apgc.apgc010                           
         LET l_isam.isam012 = l_apgc.apgc006        
         LET l_isam.isam0121= l_apca.apca013                  
         LET l_isam.isam013 = l_apca.apca012
         LET l_isam.isam014 = l_apgc.apgc100                           
         LET l_isam.isam015 = l_apgc.apgc101                           
         LET l_isam.isam016 = l_ooefl006
         LET l_isam.isam017 = l_ooef002
         CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
                    l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
         LET l_isam.isam023 = l_apgc.apgc103                           
         LET l_isam.isam024 = l_apgc.apgc104                           
         LET l_isam.isam025 = l_apgc.apgc105                           
         LET l_isam.isam026 = l_apgc.apgc113                           
         LET l_isam.isam027 = l_apgc.apgc114                           
         LET l_isam.isam028 = l_apgc.apgc115                           
         LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  
      
         SELECT isak008,isak009,isak010,isak011,isak012
           INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
                l_isam.isam033,l_isam.isam034
           FROM isak_t
          WHERE isakent = g_enterprise
            AND isak001 = l_apca.apca004
            AND isak002 = lc_param_apca.ooef019
           
         LET l_isam.isam035 = '1'                                 
         LET l_isam.isam036 = '11'                                
         LET l_isam.isam037 = l_apgc.apgc011                           
         LET l_isam.isam050 = l_apca.apcadocno                         
         LET l_isam.isam107    = 0                                 
         LET l_isam.isam108    = 0                                 
         LET l_isam.isam117    = 0                                 
         LET l_isam.isam118    = 0
         IF NOT cl_null(l_isam.isam010)THEN
            INSERT INTO isam_t VALUES(l_isam.*)      
         END IF 
      END FOREACH  
      
      #161004-00019#1-----s
      CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
      UPDATE xrcd_t SET xrcd009 = l_xrcd009
       WHERE xrcdent= g_enterprise
         AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
         AND xrcd009 IS NULL
      #161004-00019#1-----e
      LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
      SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
        INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
        FROM apcb_t
       WHERE apcbent = g_enterprise
         AND apcbld  = l_apca.apcald
         AND apcbdocno = l_apca.apcadocno
      IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
      IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
      IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
      
      UPDATE apca_t SET apca103 = l_apcb113sum,
                        apca104 = l_apcb114sum,
                        apca108 = l_apcb115sum,
                        apca113 = l_apcb113sum,
                        apca114 = l_apcb114sum,
                        apca118 = l_apcb115sum,
                        #160824-00049#7-----s
                        apca107 = l_apcb115sum,
                        apca117 = l_apcb115sum
                        #160824-00049#7-----e
       WHERE apcaent = g_enterprise
         AND apcald  = l_apca.apcald
         AND apcadocno = l_apca.apcadocno
      
      CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno
      
      UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
       WHERE apccent = g_enterprise
         AND apccdocno = l_apca.apcadocno
         AND apccld    = l_apca.apcald
      #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
      CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
                          RETURNING g_sub_success
      IF NOT g_sub_success THEN
         LET r_success = FALSE
      END IF   

      UPDATE apgc_t SET apgc012 = l_apca.apcadocno
       WHERE apgcent = g_enterprise
         AND apgccomp = l_apgi.apgicomp
         AND apgcdocno = l_apgi.apgidocno
         AND apgc900 = '0'
         AND apgc002 = l_apca004
   END FOREACH
   
   
   LET r_docno = l_apca.apcadocno
   RETURN r_success,r_docno
   #160824-00049#7-----e
   
   
   ##160824-00049#7 mark-----s
   #INITIALIZE l_apca.* TO NULL
   #LET l_apca.apcaent = g_enterprise
   #LET l_apca.apcacomp = l_apga.apgacomp
   #LET l_apca.apcald = NULL
   #SELECT glaald,glaa001,glaa016,glaa020
   #  INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
   #  FROM glaa_t
   # WHERE glaaent  = g_enterprise
   #   AND glaacomp = l_apca.apcacomp
   #   AND glaa014  = 'Y'
   #LET l_apca.apcadocdt = g_apca_m.apcadocdt
   #LET l_apca.apca003   = g_apca_m.apca003
   #LET l_apca.apca016   = g_apca_m.apca016
   #LET l_apca.apca018   = g_apca_m.apca018
   #LET l_apca.apcadocno = g_apca_m.apcadocno
   #CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
   #   RETURNING g_sub_success,l_apca.apcadocno                                            
   #IF NOT g_sub_success THEN
   #   LET r_success = FALSE
   #   RETURN r_success,r_docno
   #END IF
   #LET l_apca.apcastus  = 'N' # 狀態碼 
   #LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
   #LET l_apca.apca001 =  s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
   #LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
   #LET l_apca.apca004 = l_apga.apga004 # 帳款對象編號                        apca004    = 廠商(受益人)apga004   
   #CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
   #IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
   #SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
   #  FROM pmaa_t
   # WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
   #LET lc_param_apca.apcald   = l_apca.apcald
   #LET lc_param_apca.apcacomp = l_apca.apcacomp
   #LET lc_param_apca.apcasite = l_apca.apcasite
   #LET lc_param_apca.apcadocdt= l_apca.apcadocdt
   #LET lc_param_apca.apca001  = '19'   #l_apca.apca001
   #LET lc_param_apca.apca004  = l_apca.apca004
   #SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
   # WHERE ooefent = g_enterprise
   #   AND ooef001 = l_apca.apcacomp
   #LET ls_js = util.JSON.stringify(lc_param_apca)
   #CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
   #CALL util.JSON.parse(ls_js,lc_param_info)
   #LET l_apca.apca006 = lc_param_info.apca006  
   #LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
   #LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
   #LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   #LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   #LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
   #LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
   #LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
   #LET l_apca.apca014 = l_apga.apga005          # 人員編號           apca014    = apga005
   #LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
   #SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
   # WHERE ooagent = g_enterprise
   #   AND ooag001 = l_apca.apca014 
   #LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
   #LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
   #LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
   #LET l_apca.apca046 = lc_param_info.apca046       
   #LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
   #LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
   #LET l_apca.apca058 = lc_param_info.apca058
   #LET l_apca.apca060 = lc_param_info.apca060
   #LET l_apca.apca016 = '33'
   #LET l_apca.apca017 = '1'
   #LET l_apca.apca018 = l_apgi.apgidocno
   #LET l_apca.apca020 = 'N'         # 信用狀付款否 
   #LET l_apca.apca026 = 0
   #LET l_apca.apca027 = 0
   #LET l_apca.apca028 = 0
   #LET l_apca.apca029 = 0
   #LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
   #LET l_apca.apca067 = l_apga.apgadocno
   #LET l_apca.apca101 = 1
   #LET l_apca.apca103 = 0
   #LET l_apca.apca104 = 0
   #LET l_apca.apca106 = 0 
   #LET l_apca.apca107 = 0
   #LET l_apca.apca108 = 0 
   #LET l_apca.apca113 = 0
   #LET l_apca.apca114 = 0 
   #LET l_apca.apca116 = 0
   #LEt l_apca.apca117 = 0 
   #LET l_apca.apca118 = 0 
   #LET lc_param2.apca004 = l_apca.apca004
   #CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
   #LET ls_js = util.JSON.stringify(lc_param2)   
   #CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
   #     RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
   #LET l_apca.apca123 = 0
   #LET l_apca.apca124 = 0
   #LET l_apca.apca126 = 0 
   #LET l_apca.apca127 = 0 
   #LET l_apca.apca128 = 0
   #LET l_apca.apca133 = 0 
   #LET l_apca.apca134 = 0 
   #LET l_apca.apca136 = 0 
   #LET l_apca.apca137 = 0
   #LET l_apca.apca138 = 0 
   #LET l_apca.apca071 = 0
   #LET l_apca.apca072 = 0
   ##albireo 160624-----s
   #LEt l_apca.apca073 = l_apga.apga001
   #LET l_apca.apcaownid = g_user
   #LET l_apca.apcaowndp = g_dept
   #LET l_apca.apcacrtid = g_user
   #LET l_apca.apcacrtdp = g_dept
   #LET l_date = cl_get_current()
   #LET l_apca.apcacrtdt = l_date
   ##albireo 160624-----e
   #INSERT INTO apca_t VALUES(l_apca.*)
   #
   ##apgc產生 apcb xrcd_t
   #LET l_sql = "SELECT * FROM apgc_t ",
   #            " WHERE apgcent = ",g_enterprise," ",
   #            "   AND apgccomp = '",l_apgi.apgicomp,"' ",
   #            "   AND apgcdocno = '",l_apgi.apgidocno,"' ",
   #            "   AND apgc900 = '0' "
   #PREPARE sel_apgcp3 FROM l_sql
   #DECLARE sel_apgcc3 CURSOR FOR sel_apgcp3
   #
   #FOREACH sel_apgcc3 INTO l_apgc.*
   #   IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
   #   #r2.產生apcb-----s
   #   INITIALIZE l_apcb.* TO NULL
   #   LET l_apcb.apcbent   = g_enterprise
   #   LET l_apcb.apcbld    = l_apca.apcald
   #   LET l_apcb.apcblegl  = l_apca.apcacomp
   #   LET l_apcb.apcbsite  = l_apca.apcasite
   #   LET l_apcb.apcbdocno = l_apca.apcadocno
   #   LET l_apcb.apcbseq   = NULL
   #   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
   #    WHERE apcbent   = g_enterprise
   #      AND apcbld    = l_apcb.apcbld
   #      AND apcbdocno = l_apcb.apcbdocno
   #   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   #   LET l_apcb.apcb001 = '54'
   #   LET l_apcb.apcb002 = l_apgc.apgcdocno
   #   LET l_apcb.apcb003 = l_apgc.apgcseq
   #   LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
   #   LET l_apcb.apcb006 = ' '
   #   LET l_apcb.apcb007 = 1
   #   LET l_apcb.apcb010 = l_apca.apca015
   #   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
   #                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   #   LET l_apcb.apcb020 = l_apgc.apgc006
   #   LET l_apcb.apcb021 = l_apgc.apgc004
   #   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
   #   LET l_apcb.apcb023 = 'N'
   #   LET l_apcb.apcb027 = l_apgc.apgc008
   #   LET l_apcb.apcb028 = l_apgc.apgc009
   #   LET l_apcb.apcb029 = l_apca.apca035
   #   LET l_apcb.apcb030 = l_apca.apca008
   #   LET l_apcb.apcb051 = l_apca.apca014
   #   LET l_apcb.apcb100 = l_apgc.apgc100
   #   LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
   #   LET l_apcb.apcb102 = l_apgc.apgc101
   #   LET l_apcb.apcb103 = l_apgc.apgc103
   #   LET l_apcb.apcb104 = l_apgc.apgc104
   #   LET l_apcb.apcb105 = l_apgc.apgc105
   #   LET l_apcb.apcb108 = l_apcb.apcb103
   #   LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
   #   LET l_apcb.apcb113 = l_apgc.apgc113
   #   LET l_apcb.apcb114 = l_apgc.apgc114
   #   LET l_apcb.apcb115 = l_apgc.apgc115
   #   LET l_apcb.apcborga = l_apgc.apgcorga
   #   CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
   #   IF l_apca013 = 'Y' THEN
   #      LET l_apcb.apcb105 = l_apcb.apcb105
   #   ELSE
   #      LET l_apcb.apcb105 = l_apcb.apcb103
   #   END IF
   #   CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
   #             l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
   #       RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
   #                 l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
   #                 l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
   #                 l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
   #   INSERT INTO apcb_t VALUES(l_apcb.*)
   #   IF SQLCA.SQLCODE THEN
   #      EXIT FOREACH
   #      LET r_success = FALSE
   #   END IF
   #   #r2.產生apcb-----e
   #   
   #   #r3.產生直接付款apde-----s
   #   INITIALIZE l_apde.* TO NULL
   #   LET l_apde.apdeent  =l_apca.apcaent
   #   LET l_apde.apdeld =l_apca.apcald
   #   LET l_apde.apdecomp =l_apca.apcacomp
   #   LET l_apde.apdeorga =l_apca.apcacomp
   #   LET l_apde.apdesite =l_apca.apcasite
   #   LET l_apde.apdedocno =l_apca.apcadocno
   #   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
   #    WHERE apdeent   = l_apde.apdeent
   #      AND apdeld    = l_apde.apdeld
   #      AND apdedocno = l_apde.apdedocno
   #   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   #   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #   LET l_apde.apde001 = 'aapt560'
   #   LET l_apde.apde009 = 'N'
   #   LET l_apde.apde028 = '0'
   #   LET l_apde.apde002 = '10'
   #   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
   #   #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
   #   LET l_apde.apde109 =  l_apgc.apgc105
   #   LET l_apde.apde119 =  l_apgc.apgc115
   #   LET l_apde.apde006 = '10'   
   #   #銀行存提碼
   #   LET l_apde.apde011 = l_apgc.apgc015
   #   #現金變動碼
   #   LET l_apde.apde012 = l_apgc.apgc016
   #   LET l_apde.apde013 = ''
   #   LET l_apde.apde014 = ''
   #   LET l_apde.apde016 = ''
   #   LET l_apde.apde100 = l_apgc.apgc100
   #   LET l_apde.apde101 = l_apgc.apgc101
   #   LET l_apde.apde039 = l_apga.apga007
   #   LET l_apde.apde041 = NULL
   #   SELECT nmabl003 INTO l_apde.apde041
   #     FROM nmabl_t
   #    WHERE nmablent = g_enterprise
   #      AND nmabl001 = l_apde.apde039
   #      AND nmabl002 = g_dlang
   #   IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
   #   LET l_apde.apde032 = l_apca.apcadocdt
   #   LET l_apde.apde061 = '54'
   #   LET l_apde.apde016 = l_apgc.apgc004
   #   LET l_apde.apde008 = l_apgc.apgc014
   #   INSERT INTO apde_t(apdeent,
   #                      apdeld,apdecomp,apdesite,apdedocno,apdeseq,
   #                      apde001,apde009,apde028,apde002,apde015,
   #                      apde003,apde004,apdeorga,apde006,apde011,
   #                      apde012,apde013,apde014,apde016,apde017,
   #                      apde018,apde021,apde032,apde100,apde101,
   #                      apde039,apde040,apde041,
   #                      apde008,
   #                      apde109,apde119,apde061)
   #          VALUES(l_apde.apdeent,
   #                 l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
   #                 l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
   #                 l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
   #                 l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
   #                 l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
   #                 l_apde.apde039,l_apde.apde040,l_apde.apde041,
   #                 l_apde.apde008,
   #                 l_apde.apde109,l_apde.apde119,l_apde.apde061)
   #   IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
   #   #r3.產生直接付款apde-----e
   #   
   #   #INSERT isam
   #   INITIALIZE l_isam.* TO NULL
   #   LET l_isam.isament = l_apca.apcaent
   #   LET l_isam.isamdocno = l_apca.apcadocno
   #   SELECT MAX(isamseq)+1 INTO l_isam.isamseq
   #     FROM isam_t
   #    WHERE isament = g_enterprise
   #      AND isamdocno = l_apca.apcadocno
   #      AND isam001 = 'aapt560'
   #   IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
   #   LET l_isam.isam001 = 'aapt560'
   #   LET l_isam.isam002 = l_apca.apca004                           
   #   LET l_isam.isam008 = l_apgc.apgc007                           
   #   LET l_isam.isam009 = l_apgc.apgc008                           
   #   LET l_isam.isam010 = l_apgc.apgc009                           
   #   LET l_isam.isam011 = l_apgc.apgc010                           
   #   LET l_isam.isam012 = l_apgc.apgc006        
   #   LET l_isam.isam0121= l_apca.apca013                  
   #   LET l_isam.isam013 = l_apca.apca012
   #   LET l_isam.isam014 = l_apgc.apgc100                           
   #   LET l_isam.isam015 = l_apgc.apgc101                           
   #   LET l_isam.isam016 = l_ooefl006
   #   LET l_isam.isam017 = l_ooef002
   #   CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
   #              l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
   #   LET l_isam.isam023 = l_apgc.apgc103                           
   #   LET l_isam.isam024 = l_apgc.apgc104                           
   #   LET l_isam.isam025 = l_apgc.apgc105                           
   #   LET l_isam.isam026 = l_apgc.apgc113                           
   #   LET l_isam.isam027 = l_apgc.apgc114                           
   #   LET l_isam.isam028 = l_apgc.apgc115                           
   #   LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  
   #
   #   SELECT isak008,isak009,isak010,isak011,isak012
   #     INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
   #          l_isam.isam033,l_isam.isam034
   #     FROM isak_t
   #    WHERE isakent = g_enterprise
   #      AND isak001 = l_apca.apca004
   #      AND isak002 = lc_param_apca.ooef019
   #     
   #   LET l_isam.isam035 = '1'                                 
   #   LET l_isam.isam036 = '11'                                
   #   LET l_isam.isam037 = l_apgc.apgc011                           
   #   LET l_isam.isam050 = l_apca.apcadocno                         
   #   LET l_isam.isam107    = 0                                 
   #   LET l_isam.isam108    = 0                                 
   #   LET l_isam.isam117    = 0                                 
   #   LET l_isam.isam118    = 0
   #   IF NOT cl_null(l_isam.isam010)THEN
   #      INSERT INTO isam_t VALUES(l_isam.*)      
   #   END IF 
   #END FOREACH  
   ##albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   #   
   #LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
   #SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
   #  INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
   #  FROM apcb_t
   # WHERE apcbent = g_enterprise
   #   AND apcbld  = l_apca.apcald
   #   AND apcbdocno = l_apca.apcadocno
   #IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
   #IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
   #IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
   #
   #UPDATE apca_t SET apca103 = l_apcb113sum,
   #                  apca104 = l_apcb114sum,
   #                  apca108 = l_apcb115sum,
   #                  apca113 = l_apcb113sum,
   #                  apca114 = l_apcb114sum,
   #                  apca118 = l_apcb115sum
   # WHERE apcaent = g_enterprise
   #   AND apcald  = l_apca.apcald
   #   AND apcadocno = l_apca.apcadocno
   #
   #CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno
   #
   #UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
   # WHERE apccent = g_enterprise
   #   AND apccdocno = l_apca.apcadocno
   #   AND apccld    = l_apca.apcald
   ##albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   #CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
   #                    RETURNING g_sub_success
   #IF NOT g_sub_success THEN
   #   LET r_success = FALSE
   #END IF      
   #
   #UPDATE apgi_t SET apgi019 = l_apca.apcadocno
   # WHERE apgient = g_enterprise
   #   AND apgicomp = l_apca.apcacomp
   #   AND apgidocno = g_apca_m.apca018
   #LET r_docno = l_apca.apcadocno
   #RETURN r_success,r_docno
   #160824-00049#7 mark-----e
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_ap_4()
DEFINE l_apca   RECORD LIKE apca_t.*
DEFINE l_desc   LIKE type_t.chr1000
DEFINE ls_js            STRING   
DEFINE lc_param_apca    RECORD
         apcald         LIKE apca_t.apcald,
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca001        LIKE apca_t.apca001,
         apca004        LIKE apca_t.apca004,
         ooef019        LIKE ooef_t.ooef019
                        END RECORD
DEFINE lc_param_info    RECORD
            apca005        LIKE apca_t.apca005,
            apca005_desc   LIKE type_t.chr80,
            apca006        LIKE apca_t.apca006,    #供應商分類
            apca007        LIKE apca_t.apca007,
            apca007_desc   LIKE type_t.chr80,
            apca008        LIKE apca_t.apca008,
            apca008_desc   LIKE type_t.chr80,
            apca009        LIKE apca_t.apca009,
            apca010        LIKE apca_t.apca010,
            apca011        LIKE apca_t.apca011,
            apca011_desc   LIKE type_t.chr80,
            apca012        LIKE apca_t.apca012,
            apca013        LIKE apca_t.apca013,
            apca014        LIKE apca_t.apca014,
            apca014_desc   LIKE type_t.chr80,
            apca015        LIKE apca_t.apca015,
            apca015_desc   LIKE type_t.chr80,
            apca034        LIKE apca_t.apca034,
            apca034_desc   LIKE type_t.chr80,
            apca035        LIKE apca_t.apca035,
            apca035_desc   LIKE type_t.chr80,
            apca036        LIKE apca_t.apca036,
            apca036_desc   LIKE type_t.chr80,
            apca046        LIKE apca_t.apca046,
            apca054        LIKE apca_t.apca054,
            apca054_desc   LIKE type_t.chr80,
            apca055        LIKE apca_t.apca055,
            apca055_desc   LIKE type_t.chr80,
            apca056        LIKE apca_t.apca056,
            apca058        LIKE apca_t.apca058,
            apca058_desc   LIKE type_t.chr80,
            apca060        LIKE apca_t.apca060,
            apca100        LIKE apca_t.apca100,
            apca101        LIKE apca_t.apca101,
            apca121        LIKE apca_t.apca121,
            apca131        LIKE apca_t.apca131
                       END RECORD
   DEFINE lc_param2        RECORD
         type           LIKE type_t.chr1,       #類型
         apca004        LIKE apca_t.apca004,
         sfin2009       LIKE type_t.chr1        #汇率基本    
         END RECORD
   DEFINE l_apga    RECORD LIKE apga_t.*
   DEFINE r_success LIKE type_t.num5
   DEFINE l_apgc    RECORD LIKE apgc_t.*
   DEFINE l_apcb    RECORD LIKE apcb_t.*
   DEFINE l_sql     STRING
   DEFINE l_isam    RECORD LIKE isam_t.*
   DEFINE l_ooef002     LIKE ooef_t.ooef002
   DEFINE l_ooefl006    LIKE ooefl_t.ooefl006
   DEFINE l_pmaal003    LIKE pmaal_t.pmaal003
   DEFINE l_isao001     LIKE isao_t.isao001
   DEFINE l_dummy1      LIKE type_t.num20_6
   DEFINE l_apde        RECORD LIKE apde_t.*
   DEFINE l_pmab055     LIKE pmab_t.pmab055
   DEFINE l_glaa121     LIKE glaa_t.glaa121
   DEFINE l_glaa016     LIKE glaa_t.glaa016
   DEFINE l_glaa020     LIKE glaa_t.glaa020
   DEFINE l_glaa019     LIKE glaa_t.glaa019
   DEFINE l_glaa015     LIKE glaa_t.glaa015
   DEFINE l_glaa001     LIKE glaa_t.glaa001
   DEFINE l_apgk        RECORD LIKE apgk_t.*
   DEFINE r_docno       LIKE apga_t.apgadocno
   DEFINE l_date        DATETIME YEAR TO SECOND
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   DEFINE l_apcb113sum  LIKE type_t.num20_6
   DEFINE l_apcb114sum  LIKE type_t.num20_6
   DEFINE l_apcb115sum  LIKE type_t.num20_6
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   DEFINE l_oodb004     LIKE oodb_t.oodb004
   DEFINE l_apca013     LIKE apca_t.apca013
   DEFINE l_apca012     LIKE apca_t.apca012
   DEFINE l_oodb011     LIKE oodb_t.oodb011
   DEFINE l_count       LIKE type_t.num10
   DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE
   LET r_docno   = NULL
   INITIALIZE l_apgk.* TO NULL
   SELECT * INTO l_apgk.* FROM apgk_t WHERE apgkent = g_enterprise AND apgkcomp = g_apcacomp AND apgkdocno = g_apca_m.apca018
   INITIALIZE l_apga.* TO NULL
   SELECT * INTO l_apga.* FROM apga_t WHERE apgaent = g_enterprise AND apgacomp = g_apcacomp AND apgadocno = l_apgk.apgk005
   
   INITIALIZE l_apca.* TO NULL
   LET l_apca.apcaent = g_enterprise
   LET l_apca.apcacomp = l_apga.apgacomp
   LET l_apca.apcald = NULL
   SELECT glaald,glaa001,glaa016,glaa020
     INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
     FROM glaa_t
    WHERE glaaent  = g_enterprise
      AND glaacomp = l_apca.apcacomp
      AND glaa014  = 'Y'
   LET l_apca.apcadocdt = g_apca_m.apcadocdt
   LET l_apca.apca003   = g_apca_m.apca003
   LET l_apca.apca016   = g_apca_m.apca016
   LET l_apca.apca018   = g_apca_m.apca018
   LET l_apca.apcadocno = g_apca_m.apcadocno
   CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
      RETURNING g_sub_success,l_apca.apcadocno                                            
   IF NOT g_sub_success THEN
      LET r_success = FALSE
      RETURN r_success,r_docno
   END IF
   LET l_apca.apcastus  = 'N' # 狀態碼 
   LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
   LET l_apca.apca001 =  '31'   #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
   LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
   LET l_apca.apca004 = l_apga.apga004 # 帳款對象編號                        apca004    = 廠商(受益人)apga004   
   CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
   IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
   SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
     FROM pmaa_t
    WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
   LET lc_param_apca.apcald   = l_apca.apcald
   LET lc_param_apca.apcacomp = l_apca.apcacomp
   LET lc_param_apca.apcasite = l_apca.apcasite
   LET lc_param_apca.apcadocdt= l_apca.apcadocdt
   LET lc_param_apca.apca001  = '19' #l_apca.apca001
   LET lc_param_apca.apca004  = l_apca.apca004
   SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = l_apca.apcacomp
   LET ls_js = util.JSON.stringify(lc_param_apca)
   CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
   CALL util.JSON.parse(ls_js,lc_param_info)
   LET l_apca.apca006 = lc_param_info.apca006  
   LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
   LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
   LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
   LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
   LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
   LET l_apca.apca014 = l_apga.apga005          # 人員編號           apca014    = apga005
   LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
   SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apca.apca014 
   LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
   LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
   LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
   LET l_apca.apca046 = lc_param_info.apca046       
   LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
   LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
   LET l_apca.apca058 = lc_param_info.apca058
   LET l_apca.apca060 = lc_param_info.apca060
   LET l_apca.apca016 = '34'
   LET l_apca.apca017 = '1'
   LET l_apca.apca018 = l_apgk.apgkdocno   ##160824-00049#7 modify
   LET l_apca.apca020 = 'N'         # 信用狀付款否 
   LET l_apca.apca026 = 0
   LET l_apca.apca027 = 0
   LET l_apca.apca028 = 0
   LET l_apca.apca029 = 0
   LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
   LET l_apca.apca067 = l_apgk.apgkdocno
   LET l_apca.apca101 = 1
   LET l_apca.apca103 = 0
   LET l_apca.apca104 = 0
   LET l_apca.apca106 = 0 
   LET l_apca.apca107 = 0
   LET l_apca.apca108 = 0 
   LET l_apca.apca113 = 0
   LET l_apca.apca114 = 0 
   LET l_apca.apca116 = 0
   LEt l_apca.apca117 = 0 
   LET l_apca.apca118 = 0 
   LET lc_param2.apca004 = l_apca.apca004
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
   LET ls_js = util.JSON.stringify(lc_param2)   
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
        RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
   LET l_apca.apca123 = 0
   LET l_apca.apca124 = 0
   LET l_apca.apca126 = 0 
   LET l_apca.apca127 = 0 
   LET l_apca.apca128 = 0
   LET l_apca.apca133 = 0 
   LET l_apca.apca134 = 0 
   LET l_apca.apca136 = 0 
   LET l_apca.apca137 = 0
   LET l_apca.apca138 = 0 
   LET l_apca.apca071 = 0
   LET l_apca.apca072 = 0
   #albireo 160624-----s
   LEt l_apca.apca073 = l_apga.apga001
   LET l_apca.apcaownid = g_user
   LET l_apca.apcaowndp = g_dept
   LET l_apca.apcacrtid = g_user
   LET l_apca.apcacrtdp = g_dept
   LET l_date = cl_get_current()
   LET l_apca.apcacrtdt = l_date
   #albireo 160624-----e
   INSERT INTO apca_t VALUES(l_apca.*)
   
   #apgc產生 apcb xrcd_t
   LET l_sql = "SELECT * FROM apgc_t ",
               " WHERE apgcent = ",g_enterprise," ",
               "   AND apgccomp = '",l_apgk.apgkcomp,"' ",
               "   AND apgcdocno = '",l_apgk.apgkdocno,"' ",
               "   AND apgc900 = '0' "
   PREPARE sel_apgcp4 FROM l_sql
   DECLARE sel_apgcc4 CURSOR FOR sel_apgcp4
   
   FOREACH sel_apgcc4 INTO l_apgc.*
      IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
      #r2.產生apcb-----s
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '54'
      LET l_apcb.apcb002 = l_apgc.apgcdocno
      LET l_apcb.apcb003 = l_apgc.apgcseq
      LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = l_apgc.apgc006
      LET l_apcb.apcb021 = l_apgc.apgc004
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
      LET l_apcb.apcb023 = 'N'
      LET l_apcb.apcb027 = l_apgc.apgc008
      LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apgc.apgc100
      LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
      LET l_apcb.apcb102 = l_apgc.apgc101
      LET l_apcb.apcb103 = l_apgc.apgc103
      LET l_apcb.apcb104 = l_apgc.apgc104
      LET l_apcb.apcb105 = l_apgc.apgc105
      LET l_apcb.apcb108 = l_apcb.apcb103
      LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
      LET l_apcb.apcb113 = l_apgc.apgc113
      LET l_apcb.apcb114 = l_apgc.apgc114
      LET l_apcb.apcb115 = l_apgc.apgc115
      LET l_apcb.apcborga = l_apgc.apgcorga
      CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
      IF l_apca013 = 'Y' THEN
         LET l_apcb.apcb105 = l_apcb.apcb105
      ELSE
         LET l_apcb.apcb105 = l_apcb.apcb103
      END IF
      CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
                l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                    l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                    l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                    l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
         LET r_success = FALSE
      END IF
      #r2.產生apcb-----e
      
      #r3.產生直接付款apde-----s
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent  =l_apca.apcaent
      LET l_apde.apdeld =l_apca.apcald
      LET l_apde.apdecomp =l_apca.apcacomp
      LET l_apde.apdeorga =l_apca.apcacomp
      LET l_apde.apdesite =l_apca.apcasite
      LET l_apde.apdedocno =l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      LET l_apde.apde001 = 'aapt560'
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde028 = '0'
      LET l_apde.apde002 = '10'
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
      #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
      LET l_apde.apde109 =  l_apgc.apgc105
      LET l_apde.apde119 =  l_apgc.apgc115
      LET l_apde.apde006 = '10'   
      #銀行存提碼
      LET l_apde.apde011 = l_apgc.apgc015
      #現金變動碼
      LET l_apde.apde012 = l_apgc.apgc016
      LET l_apde.apde013 = ''
      LET l_apde.apde014 = ''
      LET l_apde.apde016 = ''
      LET l_apde.apde100 = l_apgc.apgc100
      LET l_apde.apde101 = l_apgc.apgc101
      LET l_apde.apde039 = l_apga.apga007
      LET l_apde.apde041 = NULL
      SELECT nmabl003 INTO l_apde.apde041
        FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
      LET l_apde.apde032 = l_apca.apcadocdt
      LET l_apde.apde061 = '54'
      #LET l_apde.apde016 = l_apgc.apgc004   #160824-00049#7 mark
      LET l_apde.apde008 = l_apgc.apgc014
      CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
         RETURNING l_apde.apde016   #160824-00049#7 add
      INSERT INTO apde_t(apdeent,
                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                         apde001,apde009,apde028,apde002,apde015,
                         apde003,apde004,apdeorga,apde006,apde011,
                         apde012,apde013,apde014,apde016,apde017,
                         apde018,apde021,apde032,apde100,apde101,
                         apde039,apde040,apde041,
                         apde008,
                         apde109,apde119,apde061)
             VALUES(l_apde.apdeent,
                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                    l_apde.apde039,l_apde.apde040,l_apde.apde041,
                    l_apde.apde008,
                    l_apde.apde109,l_apde.apde119,l_apde.apde061)
      IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
      #r3.產生直接付款apde-----e
      
      #INSERT isam
      INITIALIZE l_isam.* TO NULL
      LET l_isam.isament = l_apca.apcaent
      LET l_isam.isamdocno = l_apca.apcadocno
      SELECT MAX(isamseq)+1 INTO l_isam.isamseq
        FROM isam_t
       WHERE isament = g_enterprise
         AND isamdocno = l_apca.apcadocno
         AND isam001 = 'aapt560'
      IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
      LET l_isam.isam001 = 'aapt560'
      LET l_isam.isam002 = l_apca.apca004                           
      LET l_isam.isam008 = l_apgc.apgc007                           
      LET l_isam.isam009 = l_apgc.apgc008                           
      LET l_isam.isam010 = l_apgc.apgc009                           
      LET l_isam.isam011 = l_apgc.apgc010                           
      LET l_isam.isam012 = l_apgc.apgc006        
      LET l_isam.isam0121= l_apca.apca013                  
      LET l_isam.isam013 = l_apca.apca012
      LET l_isam.isam014 = l_apgc.apgc100                           
      LET l_isam.isam015 = l_apgc.apgc101                           
      LET l_isam.isam016 = l_ooefl006
      LET l_isam.isam017 = l_ooef002
      CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
                 l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
      LET l_isam.isam023 = l_apgc.apgc103                           
      LET l_isam.isam024 = l_apgc.apgc104                           
      LET l_isam.isam025 = l_apgc.apgc105                           
      LET l_isam.isam026 = l_apgc.apgc113                           
      LET l_isam.isam027 = l_apgc.apgc114                           
      LET l_isam.isam028 = l_apgc.apgc115                           
      LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  

      SELECT isak008,isak009,isak010,isak011,isak012
        INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
             l_isam.isam033,l_isam.isam034
        FROM isak_t
       WHERE isakent = g_enterprise
         AND isak001 = l_apca.apca004
         AND isak002 = lc_param_apca.ooef019
        
      LET l_isam.isam035 = '1'                                 
      LET l_isam.isam036 = '11'                                
      LET l_isam.isam037 = l_apgc.apgc011                           
      LET l_isam.isam050 = l_apca.apcadocno                         
      LET l_isam.isam107    = 0                                 
      LET l_isam.isam108    = 0                                 
      LET l_isam.isam117    = 0                                 
      LET l_isam.isam118    = 0
      IF NOT cl_null(l_isam.isam010)THEN
         INSERT INTO isam_t VALUES(l_isam.*)      
      END IF   
   END FOREACH
   
   #161004-00019#1-----s
   CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
   UPDATE xrcd_t SET xrcd009 = l_xrcd009
    WHERE xrcdent= g_enterprise
      AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
      AND xrcd009 IS NULL
   #161004-00019#1-----e
   
   LET l_pmab055 = NULL
   SELECT pmab055 INTO l_pmab055 FROM pmab_t
    WHERE pmabsite = l_apca.apcacomp
      AND pmab001 = l_apca.apca004
      AND pmabent = g_enterprise
   
   #自備款-----s
   LET l_glaa121 = NULL LET l_glaa016 = NULL
   LET l_glaa020 = NULL LET l_glaa019 = NULL
   LET l_glaa015 = NULL
   SELECT glaa121,glaa016,glaa020 ,
          glaa015,glaa019
     INTO l_glaa121,l_glaa016,l_glaa020,
          l_glaa015,l_glaa019
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = l_apca.apcald
   
   
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
    WHERE apdeent   = l_apde.apdeent
      AND apdeld    = l_apde.apdeld
      AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '23'
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apga.apga036
   LET l_apde.apde012 = l_apga.apga037
   LET l_apde.apde014 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_31'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang   #albireo 160729 add
   LET l_apde.apde100 = l_apgk.apgk100
   LET l_apde.apde101 = l_apgk.apgk101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apgk.apgk104
   LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '51'
   IF l_apde.apde109 > 0 THEN
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '51'
   LET l_apcb.apcb002 = l_apgk.apgkdocno   #160824-00049#7
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
    WHERE glabent = g_enterprise
      AND glabld = l_apde.apdeld
      AND glab001 = '15'
      AND glab002 = '3117'
      AND glab003 = '8504_31'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apgk.apgk100   #albireo 160630
   LET l_apcb.apcb101 = l_apgk.apgk104   #albireo 160624 
   LET l_apcb.apcb102 = l_apgk.apgk101   #albireo 160630
   LET l_apcb.apcb103 = l_apgk.apgk104
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apgk.apgk104
   LET l_apcb.apcb108 = l_apgk.apgk104
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apgk.apgk104 * l_apgk.apgk101
   CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apcb.apcb113,2) RETURNING g_sub_success,g_errno,l_apcb.apcb113   #161018-00036#1 add
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apgk.apgk104 * l_apgk.apgk101
   CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apcb.apcb115,2) RETURNING g_sub_success,g_errno,l_apcb.apcb115   #161018-00036#1 add
  LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apcb.apcb123,2) RETURNING g_sub_success,g_errno,l_apcb.apcb123   #161018-00036#1 add
   LET l_apcb.apcb124 = 0
   #LET l_apcb.apcb125 = l_apcb.apcb125   #161018-00036#1 mark
   LET l_apcb.apcb125 = l_apcb.apcb123    #161018-00036#1 add
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   CALL s_curr_round_ld('1',l_apca.apcald,l_apca.apca100,l_apcb.apcb133,2) RETURNING g_sub_success,g_errno,l_apcb.apcb133   #161018-00036#1 add
   LET l_apcb.apcb134 = 0
   #LET l_apcb.apcb135 = l_apcb.apcb135   #161018-00036#1 mark
   LET l_apcb.apcb135 = l_apcb.apcb133    #161018-00036#1 add
   IF l_apcb.apcb115 > 0 THEN
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF
   #自備款-----e
#albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
      
   LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
   SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
     INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld  = l_apca.apcald
      AND apcbdocno = l_apca.apcadocno
   IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
   IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
   IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
   
   UPDATE apca_t SET apca103 = l_apcb113sum,
                     apca104 = l_apcb114sum,
                     apca108 = l_apcb115sum,
                     apca113 = l_apcb113sum,
                     apca114 = l_apcb114sum,
                     apca118 = l_apcb115sum,
                     apca107 = l_apcb115sum,   #160824-00049#7
                     apca117 = l_apcb115sum    #160824-00049#7
    WHERE apcaent = g_enterprise
      AND apcald  = l_apca.apcald
      AND apcadocno = l_apca.apcadocno

   CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno

   UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
    WHERE apccent = g_enterprise
      AND apccdocno = l_apca.apcadocno
      AND apccld    = l_apca.apcald
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
                       RETURNING g_sub_success
   IF NOT g_sub_success THEN
      LET r_success = FALSE
   END IF  
   
   #160824-00049#7-----s
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbdocno = l_apca.apcadocno
      AND apcbld = l_apca.apcald
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   
   IF l_count = 0 THEN
      LET r_success = FALSE
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'agl-00167'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   #160824-00049#7-----e

   UPDATE apgk_t SET apgk015 = l_apca.apcadocno
    WHERE apgkent = g_enterprise
      AND apgkcomp = l_apca.apcacomp
      AND apgkdocno = g_apca_m.apca018
   LET r_docno = l_apca.apcadocno
   RETURN r_success,r_docno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_ap_5()
DEFINE l_apca   RECORD LIKE apca_t.*
DEFINE l_desc   LIKE type_t.chr1000
DEFINE ls_js            STRING   
DEFINE lc_param_apca    RECORD
         apcald         LIKE apca_t.apcald,
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca001        LIKE apca_t.apca001,
         apca004        LIKE apca_t.apca004,
         ooef019        LIKE ooef_t.ooef019
                        END RECORD
DEFINE lc_param_info    RECORD
            apca005        LIKE apca_t.apca005,
            apca005_desc   LIKE type_t.chr80,
            apca006        LIKE apca_t.apca006,    #供應商分類
            apca007        LIKE apca_t.apca007,
            apca007_desc   LIKE type_t.chr80,
            apca008        LIKE apca_t.apca008,
            apca008_desc   LIKE type_t.chr80,
            apca009        LIKE apca_t.apca009,
            apca010        LIKE apca_t.apca010,
            apca011        LIKE apca_t.apca011,
            apca011_desc   LIKE type_t.chr80,
            apca012        LIKE apca_t.apca012,
            apca013        LIKE apca_t.apca013,
            apca014        LIKE apca_t.apca014,
            apca014_desc   LIKE type_t.chr80,
            apca015        LIKE apca_t.apca015,
            apca015_desc   LIKE type_t.chr80,
            apca034        LIKE apca_t.apca034,
            apca034_desc   LIKE type_t.chr80,
            apca035        LIKE apca_t.apca035,
            apca035_desc   LIKE type_t.chr80,
            apca036        LIKE apca_t.apca036,
            apca036_desc   LIKE type_t.chr80,
            apca046        LIKE apca_t.apca046,
            apca054        LIKE apca_t.apca054,
            apca054_desc   LIKE type_t.chr80,
            apca055        LIKE apca_t.apca055,
            apca055_desc   LIKE type_t.chr80,
            apca056        LIKE apca_t.apca056,
            apca058        LIKE apca_t.apca058,
            apca058_desc   LIKE type_t.chr80,
            apca060        LIKE apca_t.apca060,
            apca100        LIKE apca_t.apca100,
            apca101        LIKE apca_t.apca101,
            apca121        LIKE apca_t.apca121,
            apca131        LIKE apca_t.apca131
                       END RECORD
   DEFINE lc_param2        RECORD
         type           LIKE type_t.chr1,       #類型
         apca004        LIKE apca_t.apca004,
         sfin2009       LIKE type_t.chr1        #汇率基本    
         END RECORD
   DEFINE l_apga    RECORD LIKE apga_t.*
   DEFINE r_success LIKE type_t.num5
   DEFINE l_apgc    RECORD LIKE apgc_t.*
   DEFINE l_apcb    RECORD LIKE apcb_t.*
   DEFINE l_sql     STRING
   DEFINE l_isam    RECORD LIKE isam_t.*
   DEFINE l_ooef002     LIKE ooef_t.ooef002
   DEFINE l_ooefl006    LIKE ooefl_t.ooefl006
   DEFINE l_pmaal003    LIKE pmaal_t.pmaal003
   DEFINE l_isao001     LIKE isao_t.isao001
   DEFINE l_dummy1      LIKE type_t.num20_6
   DEFINE l_apde        RECORD LIKE apde_t.*
   DEFINE l_pmab055     LIKE pmab_t.pmab055
   DEFINE l_glaa121     LIKE glaa_t.glaa121
   DEFINE l_glaa016     LIKE glaa_t.glaa016
   DEFINE l_glaa020     LIKE glaa_t.glaa020
   DEFINE l_glaa019     LIKE glaa_t.glaa019
   DEFINE l_glaa015     LIKE glaa_t.glaa015
   DEFINE l_glaa001     LIKE glaa_t.glaa001
   DEFINE r_docno       LIKE apga_t.apgadocno
   DEFINE l_date        DATETIME YEAR TO SECOND
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   DEFINE l_apcb113sum  LIKE type_t.num20_6
   DEFINE l_apcb114sum  LIKE type_t.num20_6
   DEFINE l_apcb115sum  LIKE type_t.num20_6
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   DEFINE l_oodb004     LIKE oodb_t.oodb004
   DEFINE l_apca013     LIKE apca_t.apca013
   DEFINE l_apca012     LIKE apca_t.apca012
   DEFINE l_oodb011     LIKE oodb_t.oodb011
   #albireo 1606301-----s
   DEFINE l_apce        RECORD LIKE apce_t.*
   DEFINE l_sfin2002    LIKE type_t.chr10
   #albireo 1606301-----e
   DEFINE l_apgl        RECORD LIKE apgl_t.*
   DEFINE l_count       LIKE type_t.num10
   DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
   
   WHENEVER ERROR CONTINUE
   
   #補報關行預支待抵沖銷    160622 albireo
   
   LET r_success = TRUE
   LET r_docno   = NULL
   INITIALIZE l_apgl.* TO NULL
   SELECT * INTO l_apgl.* FROM apgl_t WHERE apglent = g_enterprise AND apglcomp = g_apcacomp AND apgldocno = g_apca_m.apca018
   INITIALIZE l_apga.* TO NULL
   SELECT * INTO l_apga.* FROM apga_t WHERE apgaent = g_enterprise AND apgacomp = g_apcacomp AND apgadocno = l_apgl.apgl004
   
   INITIALIZE l_apca.* TO NULL
   LET l_apca.apcaent = g_enterprise
   LET l_apca.apcacomp = l_apga.apgacomp
   LET l_apca.apcald = NULL
   SELECT glaald,glaa001,glaa016,glaa020
     INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
     FROM glaa_t
    WHERE glaaent  = g_enterprise
      AND glaacomp = l_apca.apcacomp
      AND glaa014  = 'Y'
   LET l_apca.apcadocdt = g_apca_m.apcadocdt
   LET l_apca.apca003   = g_apca_m.apca003
   LET l_apca.apca016   = g_apca_m.apca016
   LET l_apca.apca018   = g_apca_m.apca018
   LET l_apca.apcadocno = g_apca_m.apcadocno
   CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
      RETURNING g_sub_success,l_apca.apcadocno                                            
   IF NOT g_sub_success THEN
      LET r_success = FALSE
      RETURN r_success,r_docno
   END IF
   LET l_apca.apcastus  = 'N' # 狀態碼 
   LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
   LET l_apca.apca001 =  '31'    #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
   LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
   LET l_apca.apca004 = l_apgl.apgl006 # 帳款對象編號                        apca004    = 廠商(受益人)apga004   
   CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
   IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
   SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
     FROM pmaa_t
    WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
   LET lc_param_apca.apcald   = l_apca.apcald
   LET lc_param_apca.apcacomp = l_apca.apcacomp
   LET lc_param_apca.apcasite = l_apca.apcasite
   LET lc_param_apca.apcadocdt= l_apca.apcadocdt
   LET lc_param_apca.apca001  = '19'   #l_apca.apca001
   LET lc_param_apca.apca004  = l_apca.apca004
   SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = l_apca.apcacomp
   LET ls_js = util.JSON.stringify(lc_param_apca)
   CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
   CALL util.JSON.parse(ls_js,lc_param_info)
   LET l_apca.apca006 = lc_param_info.apca006  
   LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
   LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
   LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
   LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
   LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
   LET l_apca.apca014 = l_apga.apga005          # 人員編號           apca014    = apga005
   LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
   SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apca.apca014 
   LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
   LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
   LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
   LET l_apca.apca046 = lc_param_info.apca046       
   LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
   LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
   LET l_apca.apca058 = lc_param_info.apca058
   LET l_apca.apca060 = lc_param_info.apca060
   LET l_apca.apca016 = '35'
   LET l_apca.apca017 = '1'
   #LET l_apca.apca018 = l_apga.apgadocno   #160824-00049#7 mark
   LET l_apca.apca020 = 'N'         # 信用狀付款否 
   LET l_apca.apca026 = 0
   LET l_apca.apca027 = 0
   LET l_apca.apca028 = 0
   LET l_apca.apca029 = 0
   LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
   LET l_apca.apca067 = l_apga.apgadocno
   LET l_apca.apca101 = 1
   LET l_apca.apca103 = 0
   LET l_apca.apca104 = 0
   LET l_apca.apca106 = 0 
   LET l_apca.apca107 = 0
   LET l_apca.apca108 = 0 
   LET l_apca.apca113 = 0
   LET l_apca.apca114 = 0 
   LET l_apca.apca116 = 0
   LEt l_apca.apca117 = 0 
   LET l_apca.apca118 = 0 
   LET lc_param2.apca004 = l_apca.apca004
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
   LET ls_js = util.JSON.stringify(lc_param2)   
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
        RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
   LET l_apca.apca123 = 0
   LET l_apca.apca124 = 0
   LET l_apca.apca126 = 0 
   LET l_apca.apca127 = 0 
   LET l_apca.apca128 = 0
   LET l_apca.apca133 = 0 
   LET l_apca.apca134 = 0 
   LET l_apca.apca136 = 0 
   LET l_apca.apca137 = 0
   LET l_apca.apca138 = 0 
   LET l_apca.apca071 = 0
   LET l_apca.apca072 = 0
   #albireo 160624-----s
   LEt l_apca.apca073 = l_apga.apga001
   LET l_apca.apcaownid = g_user
   LET l_apca.apcaowndp = g_dept
   LET l_apca.apcacrtid = g_user
   LET l_apca.apcacrtdp = g_dept
   LET l_date = cl_get_current()
   LET l_apca.apcacrtdt = l_date
   #albireo 160624-----e
   INSERT INTO apca_t VALUES(l_apca.*)
   
   #apgc產生 apcb xrcd_t
   LET l_sql = "SELECT * FROM apgc_t ",
               " WHERE apgcent = ",g_enterprise," ",
               "   AND apgccomp = '",l_apga.apgacomp,"' ",
               "   AND apgcdocno = '",l_apgl.apgldocno,"' ",
               "   AND apgc900 = '0' "
   PREPARE sel_apgcp5 FROM l_sql
   DECLARE sel_apgcc5 CURSOR FOR sel_apgcp5
   
   FOREACH sel_apgcc5 INTO l_apgc.*
      IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
      #r2.產生apcb-----s
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '54'
      LET l_apcb.apcb002 = l_apgc.apgcdocno
      LET l_apcb.apcb003 = l_apgc.apgcseq
      LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = l_apgc.apgc006
      LET l_apcb.apcb021 = l_apgc.apgc004
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
      LET l_apcb.apcb023 = 'N'
      LET l_apcb.apcb027 = l_apgc.apgc008
      LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apgc.apgc100
      LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
      LET l_apcb.apcb102 = l_apgc.apgc101
      LET l_apcb.apcb103 = l_apgc.apgc103
      LET l_apcb.apcb104 = l_apgc.apgc104
      LET l_apcb.apcb105 = l_apgc.apgc105
      LET l_apcb.apcb108 = l_apcb.apcb103
      LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
      LET l_apcb.apcb113 = l_apgc.apgc113
      LET l_apcb.apcb114 = l_apgc.apgc114
      LET l_apcb.apcb115 = l_apgc.apgc115
      LET l_apcb.apcborga = l_apgc.apgcorga
      CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
      IF l_apca013 = 'Y' THEN
         LET l_apcb.apcb105 = l_apcb.apcb105
      ELSE
         LET l_apcb.apcb105 = l_apcb.apcb103
      END IF
      CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
                l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                    l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                    l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                    l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
         LET r_success = FALSE
      END IF
      #r2.產生apcb-----e
      
      #r3.產生直接付款apde-----s
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent  =l_apca.apcaent
      LET l_apde.apdeld =l_apca.apcald
      LET l_apde.apdecomp =l_apca.apcacomp
      LET l_apde.apdeorga =l_apca.apcacomp
      LET l_apde.apdesite =l_apca.apcasite
      LET l_apde.apdedocno =l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      LET l_apde.apde001 = 'aapt560'
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde028 = '0'
      LET l_apde.apde002 = '10'
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
      #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
      LET l_apde.apde109 =  l_apgc.apgc105
      LET l_apde.apde119 =  l_apgc.apgc115
      LET l_apde.apde006 = '10'   
      #銀行存提碼
      LET l_apde.apde011 = l_apgc.apgc015
      #現金變動碼
      LET l_apde.apde012 = l_apgc.apgc016
      LET l_apde.apde013 = ''
      LET l_apde.apde014 = ''
      LET l_apde.apde016 = ''
      LET l_apde.apde100 = l_apgc.apgc100
      LET l_apde.apde101 = l_apgc.apgc101
      LET l_apde.apde039 = l_apga.apga007
      LET l_apde.apde041 = NULL
      SELECT nmabl003 INTO l_apde.apde041
        FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
      LET l_apde.apde032 = l_apca.apcadocdt
      LET l_apde.apde061 = '54'
      #LET l_apde.apde016 = l_apgc.apgc004
      LET l_apde.apde008 = l_apgc.apgc014
      CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
         RETURNING l_apde.apde016   #albireo 160630 add
      INSERT INTO apde_t(apdeent,
                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                         apde001,apde009,apde028,apde002,apde015,
                         apde003,apde004,apdeorga,apde006,apde011,
                         apde012,apde013,apde014,apde016,apde017,
                         apde018,apde021,apde032,apde100,apde101,
                         apde039,apde040,apde041,
                         apde008,
                         apde109,apde119,apde061)
             VALUES(l_apde.apdeent,
                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                    l_apde.apde039,l_apde.apde040,l_apde.apde041,
                    l_apde.apde008,
                    l_apde.apde109,l_apde.apde119,l_apde.apde061)
      IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
      #r3.產生直接付款apde-----e
      
      #INSERT isam
      INITIALIZE l_isam.* TO NULL
      LET l_isam.isament = l_apca.apcaent
      LET l_isam.isamdocno = l_apca.apcadocno
      SELECT MAX(isamseq)+1 INTO l_isam.isamseq
        FROM isam_t
       WHERE isament = g_enterprise
         AND isamdocno = l_apca.apcadocno
         AND isam001 = 'aapt560'
      IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
      LET l_isam.isam001 = 'aapt560'
      LET l_isam.isam002 = l_apca.apca004                           
      LET l_isam.isam008 = l_apgc.apgc007                           
      LET l_isam.isam009 = l_apgc.apgc008                           
      LET l_isam.isam010 = l_apgc.apgc009                           
      LET l_isam.isam011 = l_apgc.apgc010                           
      LET l_isam.isam012 = l_apgc.apgc006        
      LET l_isam.isam0121= l_apca.apca013                  
      LET l_isam.isam013 = l_apca.apca012
      LET l_isam.isam014 = l_apgc.apgc100                           
      LET l_isam.isam015 = l_apgc.apgc101                           
      LET l_isam.isam016 = l_ooefl006
      LET l_isam.isam017 = l_ooef002
      CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
                 l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
      LET l_isam.isam023 = l_apgc.apgc103                           
      LET l_isam.isam024 = l_apgc.apgc104                           
      LET l_isam.isam025 = l_apgc.apgc105                           
      LET l_isam.isam026 = l_apgc.apgc113                           
      LET l_isam.isam027 = l_apgc.apgc114                           
      LET l_isam.isam028 = l_apgc.apgc115                           
      LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  

      SELECT isak008,isak009,isak010,isak011,isak012
        INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
             l_isam.isam033,l_isam.isam034
        FROM isak_t
       WHERE isakent = g_enterprise
         AND isak001 = l_apca.apca004
         AND isak002 = lc_param_apca.ooef019
        
      LET l_isam.isam035 = '1'                                 
      LET l_isam.isam036 = '11'                                
      LET l_isam.isam037 = l_apgc.apgc011                           
      LET l_isam.isam050 = l_apca.apcadocno                         
      LET l_isam.isam107    = 0                                 
      LET l_isam.isam108    = 0                                 
      LET l_isam.isam117    = 0                                 
      LET l_isam.isam118    = 0
      IF NOT cl_null(l_isam.isam010)THEN
         INSERT INTO isam_t VALUES(l_isam.*)      
      END IF 
   END FOREACH
   
   #161004-00019#1-----s
   CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
   UPDATE xrcd_t SET xrcd009 = l_xrcd009
    WHERE xrcdent= g_enterprise
      AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
      AND xrcd009 IS NULL
   #161004-00019#1-----e
   
   #albireo 160630-----s

   #LET l_sql = " SELECT apccld,apccdocno,apccseq,apcc001 FROM apcc_t,apca_t ",
   #            "  WHERE apcaent = apccent ",
   #            "    AND apcald  = apccld ",
   #            "    AND apcadocno = apccdocno ",
   #            "    AND apcastus = 'Y' ",
   #            "    AND apcaent = ",g_enterprise," ",
   #            "    AND apca004 = '",l_apgl.apgl006,"' ",
   #            "    AND apca001 IN ('21','23','25') ",
   #            "    AND apcald = '",l_apca.apcald,"' ",
   #            "    AND (apcc108 - apcc109) > 0 "
   #PREPARE sel_apccp1 FROM l_sql
   #DECLARE sel_apccc1 CURSOR FOR sel_apccp1
   #FOREACH sel_apccc1 INTO l_apccld,l_apccdocno,l_apccseq,l_apcc001
   #   IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
   #   #apce_t
   #   INITIALIZE l_apce.* TO NULL
   #   LET l_apce.apceent = g_enterprise
   #   LET l_apce.apceld  = l_apca.apcald
   #   LET l_apce.apceld = l_apca.apcald
   #   LET l_apce.apcedocno = l_apca.apcadocno            
   #   LET l_apce.apce001 = 'aapt560'
   #
   #   #帶出借貸別(正負值)
   #   LET l_apce.apce015 = s_fin_get_scc_value('8506',l_apce.apce002,'3')              
   #   LET l_apce.apcecomp = l_apca.apcacomp
   #   LET l_apce.apcesite = l_apca.apcasite   
   #   LET l_apce.apceorga = l_apca.apcacomp 
   #   #取得來源組織所屬法人        
   #   LET l_apce.apce027 = 'N'
   #   LET l_apce.apceseq = NULL
   #   SELECT MAX(apceseq)+1 INTO l_apce.apceseq FROM apce_t
   #    WHERE apceent = g_enterprise
   #      AND apcedocno = l_apca.apcadocno
   #   IF cl_null(l_apce.apceseq)THEN LET l_apce.apceseq = 1 END IF
   #   LET l_apce.apce002 = "41"
   #   LET l_apce.apce
   #END FOREACH
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-2002') RETURNING l_sfin2002
   LET l_sql = " apca004 = '",l_apgl.apgl006,"' AND apcastus = 'Y' "
   CALL aapt560_03_ins_apce(l_apca.apcald,l_apca.apcadocno,l_sql,l_sfin2002,'4')   

   #albireo 160630-----e
   
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   
   LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
   SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
     INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld  = l_apca.apcald
      AND apcbdocno = l_apca.apcadocno
   IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
   IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
   IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
   
   UPDATE apca_t SET apca103 = l_apcb113sum,
                     apca104 = l_apcb114sum,
                     apca108 = l_apcb115sum,
                     apca113 = l_apcb113sum,
                     apca114 = l_apcb114sum,
                     apca118 = l_apcb115sum,
                     apca107 = l_apcb115sum,    #160824-00049#7
                     apca117 = l_apcb115sum     #160824-00049#7
    WHERE apcaent = g_enterprise
      AND apcald  = l_apca.apcald
      AND apcadocno = l_apca.apcadocno

   CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno

   UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
    WHERE apccent = g_enterprise
      AND apccdocno = l_apca.apcadocno
      AND apccld    = l_apca.apcald
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
                       RETURNING g_sub_success
   IF NOT g_sub_success THEN
      LET r_success = FALSE
   END IF    

   #160824-00049#7-----s
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbdocno = l_apca.apcadocno
      AND apcbld = l_apca.apcald
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   
   IF l_count = 0 THEN
      LET r_success = FALSE
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'agl-00167'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   #160824-00049#7-----e
   
   UPDATE apgl_t SET apgl030 = l_apca.apcadocno
    WHERE apglent = g_enterprise
      AND apglcomp = l_apca.apcacomp
      AND apgldocno = g_apca_m.apca018
   LET r_docno = l_apca.apcadocno
   RETURN r_success,r_docno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_ap_6()
DEFINE l_apca   RECORD LIKE apca_t.*
DEFINE l_desc   LIKE type_t.chr1000
DEFINE ls_js            STRING   
DEFINE lc_param_apca    RECORD
         apcald         LIKE apca_t.apcald,
         apcacomp       LIKE apca_t.apcacomp,
         apcasite       LIKE apca_t.apcasite,
         apcadocdt      LIKE apca_t.apcadocdt,
         apca001        LIKE apca_t.apca001,
         apca004        LIKE apca_t.apca004,
         ooef019        LIKE ooef_t.ooef019
                        END RECORD
DEFINE lc_param_info    RECORD
            apca005        LIKE apca_t.apca005,
            apca005_desc   LIKE type_t.chr80,
            apca006        LIKE apca_t.apca006,    #供應商分類
            apca007        LIKE apca_t.apca007,
            apca007_desc   LIKE type_t.chr80,
            apca008        LIKE apca_t.apca008,
            apca008_desc   LIKE type_t.chr80,
            apca009        LIKE apca_t.apca009,
            apca010        LIKE apca_t.apca010,
            apca011        LIKE apca_t.apca011,
            apca011_desc   LIKE type_t.chr80,
            apca012        LIKE apca_t.apca012,
            apca013        LIKE apca_t.apca013,
            apca014        LIKE apca_t.apca014,
            apca014_desc   LIKE type_t.chr80,
            apca015        LIKE apca_t.apca015,
            apca015_desc   LIKE type_t.chr80,
            apca034        LIKE apca_t.apca034,
            apca034_desc   LIKE type_t.chr80,
            apca035        LIKE apca_t.apca035,
            apca035_desc   LIKE type_t.chr80,
            apca036        LIKE apca_t.apca036,
            apca036_desc   LIKE type_t.chr80,
            apca046        LIKE apca_t.apca046,
            apca054        LIKE apca_t.apca054,
            apca054_desc   LIKE type_t.chr80,
            apca055        LIKE apca_t.apca055,
            apca055_desc   LIKE type_t.chr80,
            apca056        LIKE apca_t.apca056,
            apca058        LIKE apca_t.apca058,
            apca058_desc   LIKE type_t.chr80,
            apca060        LIKE apca_t.apca060,
            apca100        LIKE apca_t.apca100,
            apca101        LIKE apca_t.apca101,
            apca121        LIKE apca_t.apca121,
            apca131        LIKE apca_t.apca131
                       END RECORD
   DEFINE lc_param2        RECORD
         type           LIKE type_t.chr1,       #類型
         apca004        LIKE apca_t.apca004,
         sfin2009       LIKE type_t.chr1        #汇率基本    
         END RECORD
   DEFINE l_apga    RECORD LIKE apga_t.*
   DEFINE r_success LIKE type_t.num5
   DEFINE l_apgc    RECORD LIKE apgc_t.*
   DEFINE l_apcb    RECORD LIKE apcb_t.*
   DEFINE l_sql     STRING
   DEFINE l_isam    RECORD LIKE isam_t.*
   DEFINE l_ooef002     LIKE ooef_t.ooef002
   DEFINE l_ooefl006    LIKE ooefl_t.ooefl006
   DEFINE l_pmaal003    LIKE pmaal_t.pmaal003
   DEFINE l_isao001     LIKE isao_t.isao001
   DEFINE l_dummy1      LIKE type_t.num20_6
   DEFINE l_apde        RECORD LIKE apde_t.*
   DEFINE l_pmab055     LIKE pmab_t.pmab055
   DEFINE l_glaa121     LIKE glaa_t.glaa121
   DEFINE l_glaa016     LIKE glaa_t.glaa016
   DEFINE l_glaa020     LIKE glaa_t.glaa020
   DEFINE l_glaa019     LIKE glaa_t.glaa019
   DEFINE l_glaa015     LIKE glaa_t.glaa015
   DEFINE l_glaa001     LIKE glaa_t.glaa001
   DEFINE l_apgn        RECORD LIKE apgn_t.*
   DEFINE r_docno       LIKE apga_t.apgadocno
   
   DEFINE l_oodb004     LIKE oodb_t.oodb004
   DEFINE l_apca013     LIKE apca_t.apca013
   DEFINE l_apca012     LIKE apca_t.apca012
   DEFINE l_oodb011     LIKE oodb_t.oodb011
   DEFINE l_date        DATETIME YEAR TO SECOND
   DEFINE l_count       LIKE type_t.num10
#albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
   DEFINE l_apcb113sum  LIKE type_t.num20_6
   DEFINE l_apcb114sum  LIKE type_t.num20_6
   DEFINE l_apcb115sum  LIKE type_t.num20_6
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   #albireo 1606301-----s
   DEFINE l_apce        RECORD LIKE apce_t.*
   DEFINE l_sfin2002    LIKE type_t.chr10
   #albireo 1606301-----e
   DEFINE l_xrcd009     LIKE xrcd_t.xrcd009
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE
   LET r_docno   = NULL
   INITIALIZE l_apgn.* TO NULL
   SELECT * INTO l_apgn.* FROM apgn_t WHERE apgnent = g_enterprise AND apgncomp = g_apcacomp AND apgndocno = g_apca_m.apca018
   INITIALIZE l_apga.* TO NULL
   SELECT * INTO l_apga.* FROM apga_t WHERE apgaent = g_enterprise AND apgacomp = g_apcacomp AND apgadocno = l_apgn.apgn013
   
   INITIALIZE l_apca.* TO NULL
   LET l_apca.apcaent = g_enterprise
   LET l_apca.apcacomp = l_apga.apgacomp
   LET l_apca.apcald = NULL
   SELECT glaald,glaa001,glaa016,glaa020
     INTO l_apca.apcald,l_apca.apca100,l_apca.apca120,l_apca.apca130
     FROM glaa_t
    WHERE glaaent  = g_enterprise
      AND glaacomp = l_apca.apcacomp
      AND glaa014  = 'Y'
   LET l_apca.apcadocdt = g_apca_m.apcadocdt
   LET l_apca.apca003   = g_apca_m.apca003
   LET l_apca.apca016   = g_apca_m.apca016
   LET l_apca.apca018   = g_apca_m.apca018
   LET l_apca.apcadocno = g_apca_m.apcadocno
   CALL s_aooi200_fin_gen_docno(l_apca.apcald,'','',l_apca.apcadocno,l_apca.apcadocdt,'aapt560') 
      RETURNING g_sub_success,l_apca.apcadocno                                            
   IF NOT g_sub_success THEN
      LET r_success = FALSE
      RETURN r_success,r_docno
   END IF
   LET l_apca.apcastus  = 'N' # 狀態碼 
   LET l_apca.apcasite = l_apca.apcacomp   # 帳務中心                            apcasite   = apgccomp                                                    
   LET l_apca.apca001 =  '31'    #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3001')
   LET l_apca.apca003 = g_user # 帳務人員                            apca003    = g_user                                                      
   LET l_apca.apca004 = l_apga.apga004 # 帳款對象編號                        apca004    = 廠商(受益人)apga004   
   CALL s_apmm100_sel_pmac002(l_apca.apca004,'1') RETURNING l_apca.apca005,l_desc
   IF cl_null(l_apca.apca005)THEN LET l_apca.apca005 = l_apca.apca004 END IF
   SELECT pmaa080,pmaa047 INTO l_apca.apca006,l_apca.apca046
     FROM pmaa_t
    WHERE pmaaent = g_enterprise AND pmaa001 = l_apca.apca004
   LET lc_param_apca.apcald   = l_apca.apcald
   LET lc_param_apca.apcacomp = l_apca.apcacomp
   LET lc_param_apca.apcasite = l_apca.apcasite
   LET lc_param_apca.apcadocdt= l_apca.apcadocdt
   LET lc_param_apca.apca001  = '19'    #l_apca.apca001   ##160824-00049#7 modify
   LET lc_param_apca.apca004  = l_apca.apca004
   SELECT ooef019 INTO lc_param_apca.ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = l_apca.apcacomp
   LET ls_js = util.JSON.stringify(lc_param_apca)
   CALL s_aapt300_get_apca004_info(ls_js) RETURNING ls_js
   CALL util.JSON.parse(ls_js,lc_param_info)
   LET l_apca.apca006 = lc_param_info.apca006  
   LET l_apca.apca007 = lc_param_info.apca007   # 帳款類別           apca007    = 廠商慣用條件
   LET l_apca.apca008 = lc_param_info.apca008   # 付款條件編號       apca008    = 取交易對象慣用付款條件
   LET l_apca.apca009 = lc_param_info.apca009   # 應付款日/應扣抵日  apca009    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca010 = lc_param_info.apca010   # 容許票據到期日     apca010    = 不依付款條件推算,開狀日期支付銀行,故=開狀日期
   LET l_apca.apca011 = lc_param_info.apca011   # 稅別               apca011    = 取交易對象慣用稅別,實際稅別在單身呈現
   LET l_apca.apca012 = lc_param_info.apca012   # 稅率               apca012    = 依稅別串 oodb006
   LET l_apca.apca013 = lc_param_info.apca013   # 含稅否             apca013    = 依稅別串 oodb005                   
   LET l_apca.apca014 = l_apga.apga005          # 人員編號           apca014    = apga005
   LET l_apca.apca015 = NULL                    # 部門編號           apca015    = apga005 所屬部門
   SELECT ooag003 INTO l_apca.apca015 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apca.apca014 
   LET l_apca.apca034 = lc_param_info.apca034   # 責任中心                            apca034    = 依 aapt300原則帶出      
   LET l_apca.apca035 = lc_param_info.apca035   # 應付(貸方)科目編號                  apca035    = 依帳款類別帶出           
   LET l_apca.apca036 = lc_param_info.apca036   # 費用(借方)科目編號                  apca036    = 依帳款類別帶出     
   LET l_apca.apca046 = lc_param_info.apca046       
   LET l_apca.apca054 = lc_param_info.apca054   # 多帳期設定                          apca054    = 依付款條件取出 
   LET l_apca.apca055 = lc_param_info.apca055   # 繳款優惠條件                        apca055    = 依付款條件取出 
   LET l_apca.apca058 = lc_param_info.apca058
   LET l_apca.apca060 = lc_param_info.apca060
   LET l_apca.apca016 = '36'
   LET l_apca.apca017 = '1'
   LET l_apca.apca018 = l_apgn.apgndocno
   LET l_apca.apca020 = 'N'         # 信用狀付款否 
   LET l_apca.apca026 = 0
   LET l_apca.apca027 = 0
   LET l_apca.apca028 = 0
   LET l_apca.apca029 = 0
   LET l_apca.apca037 = s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-0030')# 產生傳票否                          apca037    = 取單別參數D-FIN-0030    
   LET l_apca.apca067 = l_apga.apgadocno
   LET l_apca.apca101 = 1
   LET l_apca.apca103 = 0
   LET l_apca.apca104 = 0
   LET l_apca.apca106 = 0 
   LET l_apca.apca107 = 0
   LET l_apca.apca108 = 0 
   LET l_apca.apca113 = 0
   LET l_apca.apca114 = 0 
   LET l_apca.apca116 = 0
   LEt l_apca.apca117 = 0 
   LET l_apca.apca118 = 0 
   LET lc_param2.apca004 = l_apca.apca004
   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-3009') RETURNING lc_param2.sfin2009
   LET ls_js = util.JSON.stringify(lc_param2)   
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apca.apca100,ls_js)
        RETURNING l_apca.apca101,l_apca.apca121,l_apca.apca131
   LET l_apca.apca123 = 0
   LET l_apca.apca124 = 0
   LET l_apca.apca126 = 0 
   LET l_apca.apca127 = 0 
   LET l_apca.apca128 = 0
   LET l_apca.apca133 = 0 
   LET l_apca.apca134 = 0 
   LET l_apca.apca136 = 0 
   LET l_apca.apca137 = 0
   LET l_apca.apca138 = 0 
   LET l_apca.apca071 = 0
   LET l_apca.apca072 = 0
   #160824-00049#7-----s
   LET l_apca.apca073 = l_apga.apga001
   LET l_apca.apcaownid = g_user
   LET l_apca.apcaowndp = g_dept
   LET l_apca.apcacrtid = g_user
   LET l_apca.apcacrtdp = g_dept
   LET l_date = cl_get_current()
   LET l_apca.apcacrtdt = l_date
   #160824-00049#7-----e
   INSERT INTO apca_t VALUES(l_apca.*)
   
   #apgc產生 apcb xrcd_t
   LET l_sql = "SELECT * FROM apgc_t ",
               " WHERE apgcent = ",g_enterprise," ",
               "   AND apgccomp = '",l_apgn.apgncomp,"' ",
               "   AND apgcdocno = '",l_apgn.apgndocno,"' ",
               "   AND apgc900 = '0' "
   PREPARE sel_apgcp6 FROM l_sql
   DECLARE sel_apgcc6 CURSOR FOR sel_apgcp6
   
   FOREACH sel_apgcc6 INTO l_apgc.*
      IF SQLCA.SQLCODE THEN EXIT FOREACH END IF
      #r2.產生apcb-----s
      INITIALIZE l_apcb.* TO NULL
      LET l_apcb.apcbent   = g_enterprise
      LET l_apcb.apcbld    = l_apca.apcald
      LET l_apcb.apcblegl  = l_apca.apcacomp
      LET l_apcb.apcbsite  = l_apca.apcasite
      LET l_apcb.apcbdocno = l_apca.apcadocno
      LET l_apcb.apcbseq   = NULL
      SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
       WHERE apcbent   = g_enterprise
         AND apcbld    = l_apcb.apcbld
         AND apcbdocno = l_apcb.apcbdocno
      IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
      LET l_apcb.apcb001 = '54'
      LET l_apcb.apcb002 = l_apgc.apgcdocno
      LET l_apcb.apcb003 = l_apgc.apgcseq
      LET l_apcb.apcb005 = s_desc_get_acc_desc('3117',l_apgc.apgc001)
      LET l_apcb.apcb006 = ' '
      LET l_apcb.apcb007 = 1
      LET l_apcb.apcb010 = l_apca.apca015
      CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                       RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
      LET l_apcb.apcb020 = l_apgc.apgc006
      LET l_apcb.apcb021 = l_apgc.apgc004
      LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')   #albireo 160624 add
      LET l_apcb.apcb023 = 'N'
      LET l_apcb.apcb027 = l_apgc.apgc008
      LET l_apcb.apcb028 = l_apgc.apgc009
      LET l_apcb.apcb029 = l_apca.apca035
      LET l_apcb.apcb030 = l_apca.apca008
      LET l_apcb.apcb051 = l_apca.apca014
      LET l_apcb.apcb100 = l_apgc.apgc100
      LET l_apcb.apcb101 = l_apgc.apgc105   #albireo 160623 add
      LET l_apcb.apcb102 = l_apgc.apgc101
      LET l_apcb.apcb103 = l_apgc.apgc103
      LET l_apcb.apcb104 = l_apgc.apgc104
      LET l_apcb.apcb105 = l_apgc.apgc105
      LET l_apcb.apcb108 = l_apcb.apcb103
      LET l_apcb.apcb111 = l_apgc.apgc115   #albireo 160623 add
      LET l_apcb.apcb113 = l_apgc.apgc113
      LET l_apcb.apcb114 = l_apgc.apgc114
      LET l_apcb.apcb115 = l_apgc.apgc115
      LET l_apcb.apcborga = l_apgc.apgcorga
      CALL s_tax_chk(l_apca.apcacomp,l_apcb.apcb020) RETURNING g_sub_success,l_oodb004,l_apca013,l_apca012,l_oodb011
      IF l_apca013 = 'Y' THEN
         LET l_apcb.apcb105 = l_apcb.apcb105
      ELSE
         LET l_apcb.apcb105 = l_apcb.apcb103
      END IF
      CALL s_tax_ins(l_apca.apcadocno,l_apcb.apcbseq,'0',l_apcb.apcborga,l_apcb.apcb105,
                l_apcb.apcb020,l_apcb.apcb007,l_apcb.apcb100,l_apcb.apcb102,l_apca.apcald,l_apca.apca121,l_apca.apca131)   #albireo 160630
          RETURNING l_apcb.apcb103,l_apcb.apcb104,l_apcb.apcb105,
                    l_apcb.apcb113,l_apcb.apcb114,l_apcb.apcb115,
                    l_apcb.apcb123,l_apcb.apcb124,l_apcb.apcb125,
                    l_apcb.apcb133,l_apcb.apcb134,l_apcb.apcb135
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
         LET r_success = FALSE
      END IF
      #r2.產生apcb-----e
      
      #r3.產生直接付款apde-----s
      INITIALIZE l_apde.* TO NULL
      LET l_apde.apdeent  =l_apca.apcaent
      LET l_apde.apdeld =l_apca.apcald
      LET l_apde.apdecomp =l_apca.apcacomp
      LET l_apde.apdeorga =l_apca.apcacomp
      LET l_apde.apdesite =l_apca.apcasite
      LET l_apde.apdedocno =l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
      IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
      LET l_apde.apdeseq = l_apde.apdeseq + 1
      LET l_apde.apde001 = 'aapt560'
      LET l_apde.apde009 = 'Y'
      LET l_apde.apde028 = '0'
      LET l_apde.apde002 = '10'
      LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'3')
      #以判斷完匯兌損失/匯兌收益,將金額轉正顯示
      LET l_apde.apde109 =  l_apgc.apgc105
      LET l_apde.apde119 =  l_apgc.apgc115
      LET l_apde.apde006 = '10'   
      #銀行存提碼
      LET l_apde.apde011 = l_apgc.apgc015
      #現金變動碼
      LET l_apde.apde012 = l_apgc.apgc016
      LET l_apde.apde013 = ''
      LET l_apde.apde014 = ''
      LET l_apde.apde016 = ''
      LET l_apde.apde100 = l_apgc.apgc100
      LET l_apde.apde101 = l_apgc.apgc101
      LET l_apde.apde039 = l_apga.apga007
      LET l_apde.apde041 = NULL
      SELECT nmabl003 INTO l_apde.apde041
        FROM nmabl_t
       WHERE nmablent = g_enterprise
         AND nmabl001 = l_apde.apde039
         AND nmabl002 = g_dlang
      IF cl_null(l_apde.apde101) THEN LET l_apde.apde101 = 1 END IF
      LET l_apde.apde032 = l_apca.apcadocdt
      LET l_apde.apde061 = '54'
      #LET l_apde.apde016 = l_apgc.apgc004
      LET l_apde.apde008 = l_apgc.apgc014
      CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
         RETURNING l_apde.apde016   #160824-00049#7
      INSERT INTO apde_t(apdeent,
                         apdeld,apdecomp,apdesite,apdedocno,apdeseq,
                         apde001,apde009,apde028,apde002,apde015,
                         apde003,apde004,apdeorga,apde006,apde011,
                         apde012,apde013,apde014,apde016,apde017,
                         apde018,apde021,apde032,apde100,apde101,
                         apde039,apde040,apde041,
                         apde008,
                         apde109,apde119,apde061)
             VALUES(l_apde.apdeent,
                    l_apde.apdeld,l_apde.apdecomp,l_apde.apdesite,l_apde.apdedocno,l_apde.apdeseq,
                    l_apde.apde001,l_apde.apde009,l_apde.apde028,l_apde.apde002,l_apde.apde015,
                    l_apde.apde003,l_apde.apde004,l_apde.apdeorga,l_apde.apde006,l_apde.apde011,
                    l_apde.apde012,l_apde.apde013,l_apde.apde014,l_apde.apde016,l_apde.apde017,
                    l_apde.apde018,l_apde.apde021,l_apde.apde032,l_apde.apde100,l_apde.apde101,
                    l_apde.apde039,l_apde.apde040,l_apde.apde041,
                    l_apde.apde008,
                    l_apde.apde109,l_apde.apde119,l_apde.apde061)
      IF SQLCA.SQLCODE THEN LET r_success = FALSE EXIT FOREACH END IF
      #r3.產生直接付款apde-----e
      
      #INSERT isam
      INITIALIZE l_isam.* TO NULL
      LET l_isam.isament = l_apca.apcaent
      LET l_isam.isamdocno = l_apca.apcadocno
      SELECT MAX(isamseq)+1 INTO l_isam.isamseq
        FROM isam_t
       WHERE isament = g_enterprise
         AND isamdocno = l_apca.apcadocno
         AND isam001 = 'aapt560'
      IF cl_null(l_isam.isamseq)THEN LET l_isam.isamseq = 1 END IF
      LET l_isam.isam001 = 'aapt560'
      LET l_isam.isam002 = l_apca.apca004                           
      LET l_isam.isam008 = l_apgc.apgc007                           
      LET l_isam.isam009 = l_apgc.apgc008                           
      LET l_isam.isam010 = l_apgc.apgc009                           
      LET l_isam.isam011 = l_apgc.apgc010                           
      LET l_isam.isam012 = l_apgc.apgc006        
      LET l_isam.isam0121= l_apca.apca013                  
      LET l_isam.isam013 = l_apca.apca012
      LET l_isam.isam014 = l_apgc.apgc100                           
      LET l_isam.isam015 = l_apgc.apgc101                           
      LET l_isam.isam016 = l_ooefl006
      LET l_isam.isam017 = l_ooef002
      CALL s_aapp320_buy_info(l_apca.apcacomp)RETURNING l_pmaal003,l_isao001,      
                 l_isam.isam018,l_isam.isam019,l_isam.isam020,l_isam.isam021
      LET l_isam.isam023 = l_apgc.apgc103                           
      LET l_isam.isam024 = l_apgc.apgc104                           
      LET l_isam.isam025 = l_apgc.apgc105                           
      LET l_isam.isam026 = l_apgc.apgc113                           
      LET l_isam.isam027 = l_apgc.apgc114                           
      LET l_isam.isam028 = l_apgc.apgc115                           
      LET l_isam.isam029 = s_desc_get_trading_partner_abbr_desc(l_apca.apca004)  

      SELECT isak008,isak009,isak010,isak011,isak012
        INTO l_isam.isam030,l_isam.isam031,l_isam.isam032,
             l_isam.isam033,l_isam.isam034
        FROM isak_t
       WHERE isakent = g_enterprise
         AND isak001 = l_apca.apca004
         AND isak002 = lc_param_apca.ooef019
        
      LET l_isam.isam035 = '1'                                 
      LET l_isam.isam036 = '11'                                
      LET l_isam.isam037 = l_apgc.apgc011                           
      LET l_isam.isam050 = l_apca.apcadocno                         
      LET l_isam.isam107    = 0                                 
      LET l_isam.isam108    = 0                                 
      LET l_isam.isam117    = 0                                 
      LET l_isam.isam118    = 0
      IF NOT cl_null(l_isam.isam010)THEN
         INSERT INTO isam_t VALUES(l_isam.*)      
      END IF   
   END FOREACH
   
   #161004-00019#1-----s
   CALL s_fin_get_account(l_apca.apcald,'13',l_apca.apca007,'8504_04') RETURNING g_sub_success,l_xrcd009,g_errno
   UPDATE xrcd_t SET xrcd009 = l_xrcd009
    WHERE xrcdent= g_enterprise
      AND xrcdld = l_apca.apcald AND xrcddocno = l_apca.apcadocno
      AND xrcd009 IS NULL
   #161004-00019#1-----e
   
   LET l_pmab055 = NULL
   SELECT pmab055 INTO l_pmab055 FROM pmab_t
    WHERE pmabsite = l_apca.apcacomp
      AND pmab001 = l_apca.apca004
      AND pmabent = g_enterprise
   
   #自備款-----s
   LET l_glaa121 = NULL LET l_glaa016 = NULL
   LET l_glaa020 = NULL LET l_glaa019 = NULL
   LET l_glaa015 = NULL
   SELECT glaa121,glaa016,glaa020 ,
          glaa015,glaa019
     INTO l_glaa121,l_glaa016,l_glaa020,
          l_glaa015,l_glaa019
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = l_apca.apcald

   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
   SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
    WHERE apdeent   = l_apde.apdeent
      AND apdeld    = l_apde.apdeld
      AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '18'   #160824-00049#7
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apgn.apgn006
   LET l_apde.apde012 = l_apgn.apgn007
   LET l_apde.apde014 = ''   #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_34'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang   #albireo 160729 add
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apgn.apgn108
   #LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
   LET l_apde.apde119 = l_apgn.apgn118   #160824-00049#7 add
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '61'
   IF l_apde.apde109 > 0 THEN   #160824-00049#7
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF   #160824-00049#7
    
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '61'   #160824-00049#7
   LET l_apcb.apcb002 = l_apgn.apgndocno   #160824-00049#7
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   #SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '15'
   #   AND glab002 = '3117'
   #   AND glab003 = '8504_34'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apgn.apgn100
   LET l_apcb.apcb101 = l_apgn.apgn108   #albireo 160624
   LET l_apcb.apcb102 = l_apgn.apgn101
   LET l_apcb.apcb103 = l_apgn.apgn108
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apgn.apgn108
   LET l_apcb.apcb108 = l_apgn.apgn108
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apgn.apgn118
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apgn.apgn118
  LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   
   IF l_apcb.apcb115 > 0 THEN   #160824-00049#7
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF   #160824-00049#7
   #自備款-----e
   
   #保證金-----s
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '18'   #160824-00049#7
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apgn.apgn008
   LET l_apde.apde012 = l_apgn.apgn009
   LET l_apde.apde014 = '' #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_37'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang   #albireo 160729 add
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apgn.apgn109
   #LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
   LET l_apde.apde119 = l_apgn.apgn119   #160824-00049#7
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '62'
   IF l_apde.apde109 > 0 THEN   #160824-00049#7
      INSERT INTO apde_t VALUES(l_apde.*)  
   END IF   #160824-00049#7
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '62'   #160824-00049#7
   LET l_apcb.apcb002 = l_apgn.apgndocno   #160824-00049#7
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   #SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '15'
   #   AND glab002 = '3117'
   #   AND glab003 = '8504_37'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apgn.apgn100
   LET l_apcb.apcb101 = l_apgn.apgn109
   LET l_apcb.apcb102 = l_apgn.apgn101
   LET l_apcb.apcb103 = l_apgn.apgn109
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apgn.apgn109
   LET l_apcb.apcb108 = l_apgn.apgn109
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apgn.apgn119
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apgn.apgn119
  LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   
   IF l_apcb.apcb115 > 0 THEN   #160824-00049#7
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF   #160824-00049#7
   #保證金-----e
   
   #預付款-----s
   INITIALIZE l_apde.* TO NULL
   LET l_apde.apdeent   = g_enterprise
   LET l_apde.apdecomp  = l_apca.apcacomp
   LET l_apde.apdeld    = l_apca.apcald
   LET l_apde.apdedocno = l_apca.apcadocno
      SELECT MAX(apdeseq) INTO l_apde.apdeseq FROM apde_t
       WHERE apdeent   = l_apde.apdeent
         AND apdeld    = l_apde.apdeld
         AND apdedocno = l_apde.apdedocno
   #albireo 160624-----s
   IF cl_null(l_apde.apdeseq)THEN LET l_apde.apdeseq = 0 END IF
   LET l_apde.apdeseq = l_apde.apdeseq + 1
   #albireo 160624-----e
   LET l_apde.apdesite  = l_apca.apcasite
   LET l_apde.apdeorga  = l_apca.apcasite
   LET l_apde.apde001   = 'aapt560'
   LET l_apde.apde002   = '18'    #160824-00049#7
   LET l_apde.apde006   = '10'
   LET l_apde.apde008   = l_apga.apga040
   LET l_apde.apde009 = 'Y'
   LET l_apde.apde011 = l_apgn.apgn010
   LET l_apde.apde012 = l_apgn.apgn011
   LET l_apde.apde014 = ''  #s_fin_get_doc_para(l_apca.apcald,l_apca.apcacomp,g_apca_m.apcadocno,'D-FIN-3004') #albireo 160630
   LET l_apde.apde015 = s_fin_get_scc_value('8506',l_apde.apde002,'1')
   LET l_apde.apde016 = NULL
   #SELECT glab005 INTO l_apde.apde016 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '13'
   #   AND glab002 = l_pmab055
   #   AND glab003 = '8504_33'
   CALL s_aapt420_bring_acc_code2(l_apca.apcald,l_apca.apcasite,l_apca.apca004,'10','10',l_apde.apde008)
      RETURNING l_apde.apde016   #albireo 160630 add
   LET l_apde.apde017 = l_apga.apga005
   LET l_apde.apde018 = NULL
   SELECT ooag003 INTO l_apde.apde018 FROM ooag_t
    WHERE ooagent = g_enterprise
      AND ooag001 = l_apde.apde017
   #LET l_apde.apde019 =          
   CALL s_department_get_respon_center(l_apde.apde018,l_apca.apcadocdt)
              RETURNING g_sub_success,g_errno,l_apde.apde019,l_dummy1
   LET l_apde.apde028 = '2'
   LET l_apde.apde032 = l_apga.apga003
   LET l_apde.apde038 = l_apca.apca004
   LET l_apde.apde039 = l_apga.apga007
   SELECT nmabl004 INTO l_apde.apde041 FROM nmabl_t
    WHERE nmablent = g_enterprise
      AND nmabl001 = l_apde.apde039
      AND nmabl002 = g_dlang   #albireo 160729 add
   LET l_apde.apde100 = l_apga.apga100
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde104 = 0 
   LET l_apde.apde109 = l_apgn.apgn102
   LET l_apde.apde119 = l_apde.apde109 * l_apde.apde101
   #s_curr_round
   CALL s_curr_round_ld('1',l_apca.apcald,l_glaa001,l_apde.apde119,2) RETURNING g_sub_success,g_errno,l_apde.apde119
   LET lc_param2.apca004 = l_apca.apca004
   LET ls_js = util.JSON.stringify(lc_param2)
   CALL s_fin_get_curr_rate(l_apca.apcacomp,l_apca.apcald,l_apca.apcadocdt,l_apde.apde100,ls_js)
        RETURNING l_apde.apde101,l_apde.apde121,l_apde.apde131
   #s_curr_round
   LET l_apde.apde101 = l_apga.apga101
   LET l_apde.apde120 = l_apca.apca120
   
   IF l_glaa015 = 'Y' THEN
      LET l_apde.apde129 = l_apde.apde109 * l_apde.apde121
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde120,l_apde.apde129,2) RETURNING g_sub_success,g_errno,l_apde.apde129
   END IF
   
   LET l_apde.apde130 = l_apca.apca130
   IF l_glaa019 = 'Y' THEN
      LET l_apde.apde139 = l_apde.apde109 * l_apde.apde131
      CALL s_curr_round_ld('1',l_apca.apcald,l_apde.apde130,l_apde.apde139,2) RETURNING g_sub_success,g_errno,l_apde.apde139
   END IF
   LET l_apde.apde061 = '63'
   IF l_apde.apde109 > 0 THEN    #160824-00049#7
      INSERT INTO apde_t VALUES(l_apde.*)
   END IF   #160824-00049#7
   
   INITIALIZE l_apcb.* TO NULL
   LET l_apcb.apcbent   = g_enterprise
   LET l_apcb.apcbld    = l_apca.apcald
   LET l_apcb.apcblegl  = l_apca.apcacomp
   LET l_apcb.apcbsite  = l_apca.apcasite
   LET l_apcb.apcbdocno = l_apca.apcadocno
   LET l_apcb.apcbseq   = NULL
   SELECT MAX(apcbseq)+1 INTO l_apcb.apcbseq FROM apcb_t
    WHERE apcbent   = g_enterprise
      AND apcbld    = l_apcb.apcbld
      AND apcbdocno = l_apcb.apcbdocno
   IF cl_null(l_apcb.apcbseq)THEN LET l_apcb.apcbseq = 1 END IF
   LET l_apcb.apcb001 = '63'    #160824-00049#7
   LET l_apcb.apcb002 = l_apgn.apgndocno   #160824-00049#7
   LET l_apcb.apcb003 = 0
   
   LET l_apcb.apcb006 = ' '
   LET l_apcb.apcb007 = 1
   LET l_apcb.apcb010 = l_apca.apca015
   CALL s_department_get_respon_center(l_apcb.apcb010,l_apca.apcadocdt)
                    RETURNING g_sub_success,g_errno,l_apcb.apcb011,l_dummy1
   LET l_apcb.apcb020 = ''
   #LET l_apcb.apcb021 = l_apgc.apgc004
   #SELECT glab005 INTO l_apcb.apcb021 FROM glab_t
   # WHERE glabent = g_enterprise
   #   AND glabld = l_apde.apdeld
   #   AND glab001 = '15'
   #   AND glab002 = '3117'
   #   AND glab003 = '8504_38'
   LET l_apcb.apcb022 = 1 #s_fin_get_scc_value('8540',l_apcb.apcb001,'4')
   LET l_apcb.apcb023 = 'N'
   #LET l_apcb.apcb027 = l_apgc.apgc008
   #LET l_apcb.apcb028 = l_apgc.apgc009
   LET l_apcb.apcb029 = l_apca.apca035
   LET l_apcb.apcb030 = l_apca.apca008
   LET l_apcb.apcb051 = l_apca.apca014
   LET l_apcb.apcb100 = l_apgn.apgn100
   LET l_apcb.apcb102 = l_apgn.apgn101
   LET l_apcb.apcb101 = l_apgn.apgn102
   LET l_apcb.apcb103 = l_apgn.apgn102
   LET l_apcb.apcb104 = 0
   LET l_apcb.apcb105 = l_apgn.apgn102
   LET l_apcb.apcb108 = l_apgn.apgn102
   LET l_apcb.apcb111 = l_apcb.apcb101 * l_apcb.apcb102
   LET l_apcb.apcb113 = l_apgn.apgn112
   LET l_apcb.apcb114 = 0
   LET l_apcb.apcb115 = l_apgn.apgn112
  LET l_apcb.apcborga = l_apca.apcacomp
   LET l_apcb.apcb123 = l_apcb.apcb103 * l_apca.apca121
   LET l_apcb.apcb124 = 0
   LET l_apcb.apcb125 = l_apcb.apcb125
   LET l_apcb.apcb133 = l_apcb.apcb103 * l_apca.apca131
   LET l_apcb.apcb134 = 0
   LET l_apcb.apcb135 = l_apcb.apcb135
   IF l_apcb.apcb113 > 0 THEN   #160824-00049#7
      INSERT INTO apcb_t VALUES(l_apcb.*)
      IF SQLCA.SQLCODE THEN
         LET r_success = FALSE
      END IF
   END IF   #160824-00049#7
   #預付款-----e
   
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----s
      
   LET l_apcb113sum = NULL   LET l_apcb114sum = NULL   LET l_apcb115sum = NULL
   SELECT SUM(apcb113),SUM(apcb114),SUM(apcb115)
     INTO l_apcb113sum,l_apcb114sum,l_apcb115sum
     FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbld  = l_apca.apcald
      AND apcbdocno = l_apca.apcadocno
   IF cl_null(l_apcb113sum)THEN LET l_apcb113sum = 0 END IF
   IF cl_null(l_apcb114sum)THEN LET l_apcb114sum = 0 END IF
   IF cl_null(l_apcb115sum)THEN LET l_apcb115sum = 0 END IF
   
   UPDATE apca_t SET apca103 = l_apcb113sum,
                     apca104 = l_apcb114sum,
                     apca108 = l_apcb115sum,
                     apca113 = l_apcb113sum,
                     apca114 = l_apcb114sum,
                     apca118 = l_apcb115sum
    WHERE apcaent = g_enterprise
      AND apcald  = l_apca.apcald
      AND apcadocno = l_apca.apcadocno

   CALL s_aap_multi_bill_period(l_apca.apcald,l_apca.apcadocno) RETURNING g_sub_success,g_errno

   CALL cl_get_para(g_enterprise,l_apca.apcacomp,'S-FIN-2002') RETURNING l_sfin2002
   LET l_sql = " apca073 = '",l_apca.apca073,"' AND apca001 IN ('21','23','25') AND apcastus = 'Y' "
   CALL aapt560_03_ins_apce(l_apca.apcald,l_apca.apcadocno,l_sql,l_sfin2002,'4')   

   UPDATE apca_t SET apca103 = l_apcb113sum,
                     apca104 = l_apcb114sum,
                     apca108 = l_apcb115sum,
                     apca113 = l_apcb113sum,
                     apca114 = l_apcb114sum,
                     apca118 = l_apcb115sum,
                     apca107 = l_apcb115sum,
                     apca117 = l_apcb115sum
    WHERE apcaent = g_enterprise
      AND apcald  = l_apca.apcald
      AND apcadocno = l_apca.apcadocno


   UPDATE apcc_t SET apcc109 = apcc108 ,apcc119 = apcc118
    WHERE apccent   = g_enterprise
      AND apccdocno = l_apca.apcadocno
      AND apccld    = l_apca.apcald
   #albireo 160627 kris改規格  sum單身總本幣金額後產生apcc並回寫單頭總金額-----e
   
   CALL s_pre_voucher_ins('AP','P10',l_apca.apcald,l_apca.apcadocno,l_apca.apcadocdt,'1')
                       RETURNING g_sub_success
   IF NOT g_sub_success THEN
      LET r_success = FALSE
   END IF
   
   #160824-00049#7-----s
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM apcb_t
    WHERE apcbent = g_enterprise
      AND apcbdocno = l_apca.apcadocno
      AND apcbld = l_apca.apcald
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   
   IF l_count = 0 THEN
      LET r_success = FALSE
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'agl-00167'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   END IF
   #160824-00049#7-----e
   
   UPDATE apgn_t SET apgn003 = l_apca.apcadocno
    WHERE apgnent = g_enterprise
      AND apgncomp = l_apca.apcacomp
      AND apgndocno = g_apca_m.apca018
   LET r_docno = l_apca.apcadocno
   RETURN r_success,r_docno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_apca018_chk()
   DEFINE r_success   LIKE type_t.num5
   DEFINE r_errno     LIKE gzze_t.gzze001
   DEFINE l_stus      LIKE type_t.chr10
   DEFINE l_count     LIKE type_t.num5
   LET r_success = TRUE
   LET r_errno = NULL
   CASE
      WHEN g_apca_m.apca016 = '31'
         LET l_stus = NULL
         SELECT apgastus INTO l_stus FROM apga_t
          WHERE apgaent = g_enterprise
            AND apgacomp = g_apca_m.apcacomp
            AND apgadocno = g_apca_m.apca018
            
         CASE
            WHEN SQLCA.SQLCODE = 100
               LET r_success = FALSE
               LET r_errno  = 'asf-00154'
            WHEN l_stus <> 'Y'
               LET r_success = FALSE
               LET r_errno  = 'aap-00017'
         END CASE
      WHEN g_apca_m.apca016 = '32'
         LET l_stus = NULL
         SELECT apgdstus INTO l_stus FROM apgd_t
          WHERE apgdent = g_enterprise
            AND apgdcomp = g_apca_m.apcacomp
            AND apgddocno = g_apca_m.apca018
            AND apgd900   = g_apca_m.apca064
         CASE
            WHEN SQLCA.SQLCODE = 100
               LET r_success = FALSE
               LET r_errno  = 'asf-00154'
            WHEN l_stus <> 'Y'
               LET r_success = FALSE
               LET r_errno  = 'aap-00017'
         END CASE      
      WHEN g_apca_m.apca016 = '33'
         LET l_stus = NULL
         SELECT apgistus INTO l_stus FROM apgi_t
          WHERE apgient = g_enterprise
            AND apgicomp = g_apca_m.apcacomp
            AND apgidocno = g_apca_m.apca018
         CASE
            WHEN SQLCA.SQLCODE = 100
               LET r_success = FALSE
               LET r_errno  = 'asf-00154'
            WHEN l_stus <> 'Y'
               LET r_success = FALSE
               LET r_errno  = 'aap-00017'
         END CASE            
      WHEN g_apca_m.apca016 = '34'
         LET l_stus = NULL
         SELECT apgkstus INTO l_stus FROM apgk_t
          WHERE apgkent = g_enterprise
            AND apgkcomp = g_apca_m.apcacomp
            AND apgkdocno = g_apca_m.apca018
         CASE
            WHEN SQLCA.SQLCODE = 100
               LET r_success = FALSE
               LET r_errno  = 'asf-00154'
            WHEN l_stus <> 'Y'
               LET r_success = FALSE
               LET r_errno  = 'aap-00017'
         END CASE 
      WHEN g_apca_m.apca016 = '35'
         LET l_stus = NULL
         SELECT apglstus INTO l_stus FROM apgl_t
          WHERE apglent = g_enterprise
            AND apglcomp = g_apca_m.apcacomp
            AND apgldocno = g_apca_m.apca018
         CASE
            WHEN SQLCA.SQLCODE = 100
               LET r_success = FALSE
               LET r_errno  = 'asf-00154'
            WHEN l_stus <> 'Y'
               LET r_success = FALSE
               LET r_errno  = 'aap-00017'
         END CASE       
      WHEN g_apca_m.apca016 = '36'
         LET l_stus = NULL
         SELECT apgnstus INTO l_stus FROM apgn_t
          WHERE apgnent = g_enterprise
            AND apgncomp = g_apca_m.apcacomp
            AND apgndocno = g_apca_m.apca018
         CASE
            WHEN SQLCA.SQLCODE = 100
               LET r_success = FALSE
               LET r_errno  = 'asf-00154'
            WHEN l_stus <> 'Y'
               LET r_success = FALSE
               LET r_errno  = 'aap-00017'
         END CASE    
   END CASE

   IF NOT r_success THEN RETURN r_success,r_errno END IF
   
   IF g_apca_m.apca016 = '32' THEN
      LET l_count = NULL
      SELECT COUNT(*) INTO l_count FROM apca_t
       WHERE apcaent = g_enterprise
         AND apca016 = g_apca_m.apca016
         AND apca018 = g_apca_m.apca018
         AND apca064 = g_apca_m.apca064
         AND apcastus <> 'X'
      IF cl_null(l_count)THEN LET l_count = 0 END IF
      
      IF l_count > 0 THEN
         LET r_success = FALSE
         LET r_errno  = 'afm-00119'
      END IF
   ELSE
      LET l_count = NULL
      SELECT COUNT(*) INTO l_count FROM apca_t
       WHERE apcaent = g_enterprise
         AND apca016 = g_apca_m.apca016
         AND apca018 = g_apca_m.apca018
         AND apcastus <> 'X'
      IF cl_null(l_count)THEN LET l_count = 0 END IF
      
      IF l_count > 0 THEN
         LET r_success = FALSE
         LET r_errno  = 'afm-00119'
      END IF
   END IF
   
   
   RETURN r_success,r_errno
END FUNCTION

################################################################################
# Descriptions...: 描述说明
# Memo...........:
# Usage..........: CALL s_aooi150_ins (传入参数)
#                  RETURNING 回传参数
# Input parameter: 传入参数变量1   传入参数变量说明1
#                : 传入参数变量2   传入参数变量说明2
# Return code....: 回传参数变量1   回传参数变量说明1
#                : 回传参数变量2   回传参数变量说明2
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION aapt560_03_ins_apce(p_ld,p_docno,p_wc,p_sfin2002,p_type)
DEFINE p_ld          LIKE apca_t.apcald      #帳別
DEFINE p_docno       LIKE apcb_t.apcbdocno   #立帳單據
DEFINE p_apca004     LIKE apca_t.apca004     #交易對象
DEFINE p_apca005     LIKE apca_t.apca004     #付款對象
DEFINE p_wc          STRING
DEFINE p_sfin2002    LIKE type_t.chr1        #沖銷參數(S-FIN-2002)
DEFINE p_type        LIKE type_t.chr1        #1.訂單待抵優先 2.帳款對象+付款對象 3.帳款對象
DEFINE l_apcacomp    LIKE apca_t.apcacomp
DEFINE l_apcadocdt   LIKE apca_t.apcadocdt
DEFINE l_apca0041    LIKE apca_t.apca004
DEFINE l_apca0051    LIKE apca_t.apca005
DEFINE l_apca1001    LIKE apca_t.apca100
DEFINE l_apcc109sum  LIKE apcc_t.apcc109     #立帳付款金額(合計
DEFINE l_apce109sum  LIKE apce_t.apce109     #沖帳金額    (合計
DEFINE l_apce109     LIKE apce_t.apce109     #可沖帳金額
DEFINE l_glaa017     LIKE glaa_t.glaa017     #本位幣二 換算基準
DEFINE l_glaa021     LIKE glaa_t.glaa021     #本位幣三 換算基準
DEFINE l_apca001     LIKE apca_t.apca001
DEFINE l_apca014     LIKE apca_t.apca014
DEFINE l_apca015     LIKE apca_t.apca015
DEFINE l_apca033     LIKE apca_t.apca033
DEFINE l_apca034     LIKE apca_t.apca034
DEFINE l_apca035     LIKE apca_t.apca035
DEFINE l_apca059     LIKE apca_t.apca059
DEFINE l_apcccomp    LIKE apcc_t.apcccomp
DEFINE l_apccsite    LIKE apcc_t.apccsite
DEFINE l_apccdocno   LIKE apcc_t.apccdocno
DEFINE l_apccseq     LIKE apcc_t.apccseq
DEFINE l_apcc001     LIKE apcc_t.apcc001
DEFINE l_apcc100     LIKE apcc_t.apcc100
DEFINE l_apcc121     LIKE apcc_t.apcc121
DEFINE l_apcc131     LIKE apcc_t.apcc131
DEFINE l_apcc101     LIKE apcc_t.apcc101
DEFINE l_apcc102     LIKE apcc_t.apcc102
DEFINE l_apcc108     LIKE apcc_t.apcc108
DEFINE l_apcc118     LIKE apcc_t.apcc118
DEFINE l_apcc128     LIKE apcc_t.apcc128
DEFINE l_apcc138     LIKE apcc_t.apcc138
DEFINE l_apcc109     LIKE apcc_t.apcc109
DEFINE l_apcc119     LIKE apcc_t.apcc119
DEFINE l_apcc129     LIKE apcc_t.apcc129
DEFINE l_apcc139     LIKE apcc_t.apcc139
DEFINE l_apce        RECORD LIKE apce_t.*
DEFINE l_sql         STRING
DEFINE l_cnt         LIKE type_t.num5
DEFINE l_apcbseq     LIKE apcb_t.apcbseq
DEFINE l_apcb008     LIKE apcb_t.apcb008
DEFINE l_str         STRING
DEFINE l_glaa001     LIKE glaa_t.glaa001  #140806-00012#12
DEFINE l_glaa016     LIKE glaa_t.glaa016  #140806-00012#12
DEFINE l_glaa020     LIKE glaa_t.glaa020  #140806-00012#12
#150316apo--(s)
DEFINE  l_apcc_left  RECORD
                     apce109    LIKE type_t.num20_6,
                     apce119    LIKE type_t.num20_6,
                     apce129    LIKE type_t.num20_6,
                     apce139    LIKE type_t.num20_6
                     END RECORD
#150316apo--(e)
DEFINE l_sfin3020    LIKE type_t.chr1     #151130-00015#4
DEFINE l_glaacomp    LIKE glaa_t.glaacomp #151130-00015#4
DEFINE l_apca018     LIKE apca_t.apca018  #151130-00015#4
#160705-00035#3-s
DEFINE l_apba103     LIKE apba_t.apba103
DEFINE l_apba113     LIKE apba_t.apba113
#160705-00035#3-e
#160825-00031#1 Add  ---(S)---
DEFINE r_apce_w      RECORD
       apce103       LIKE apce_t.apce103,
       apce104       LIKE apce_t.apce104,
       apce109       LIKE apce_t.apce109,
       apce113       LIKE apce_t.apce113,
       apce114       LIKE apce_t.apce114,
       apce119       LIKE apce_t.apce119,
       apce123       LIKE apce_t.apce123,
       apce124       LIKE apce_t.apce124,
       apce129       LIKE apce_t.apce129,
       apce133       LIKE apce_t.apce133,
       apce134       LIKE apce_t.apce134,
       apce139       LIKE apce_t.apce139
       END RECORD
#DEFINE l_apca011     LIKE apca_t.apca011  #160705-00035#5 mark
DEFINE l_apca012     LIKE apca_t.apca012   #160705-00035#5
#160825-00031#1 Add  ---(S)---



   WHENEVER ERROR CONTINUE
   
   IF cl_null(p_wc) THEN RETURN END IF
   #21:訂金待抵       #對應41:應付款單
   #22:倉退待抵       #對應41:應付款單
   #23:預付待抵       #對應41:應付款單
   #24:沖銷溢付待抵   #對應41:應付款單
   #25:押金待底       #對應42:應付待抵款單
   #29:其他待抵       #對應41:應付款單
   #151130-00015#4--(S)
   SELECT glaacomp INTO l_glaacomp
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald = p_ld
   CALL cl_get_para(g_enterprise,l_glaacomp,'S-FIN-3020') RETURNING l_sfin3020 
   IF cl_null(l_sfin3020) THEN
      LET l_sfin3020 = 'N'
   END IF
   #151130-00015#4--(E)

   #160705-00035#3-s
   #屬於0類則表示aapt110的待底要先沖
   IF p_type = '0' THEN
      LET l_sql = " SELECT DISTINCT apba005 FROM apba_t",
                  "   LEFT JOIN apca_t ON apbaent=apcaent AND apbadocno=apca018",
                  "  WHERE apcaent = '",g_enterprise,"' ",
                  "    AND apcald = '",p_ld,"' ",
                  "    AND apcadocno = '",p_docno,"' ",
                  "    AND apba004 = '27'",
                  "  ORDER BY apba005"
      PREPARE aapt560_sel_apba_p FROM l_sql
      DECLARE aapt560_sel_apba_c CURSOR FOR aapt560_sel_apba_p
      FOREACH aapt560_sel_apba_c INTO l_apcb008
      IF cl_null(l_str)THEN
         LET l_str = l_apcb008 CLIPPED
      ELSE
         LET l_str = l_str CLIPPED,",",l_apcb008 CLIPPED
      END IF
      END FOREACH
      CALL s_fin_get_wc_str(l_str) RETURNING l_str
   END IF
   #屬於1/2類訂單待抵優先,卻未勾選21:訂金待抵者/23:預付待抵/25:押金待底,則不進入此類處理
   IF p_type = '1' OR p_type = '2' THEN
      IF s_chr_get_index_of(p_wc,'21',1) = 0 AND s_chr_get_index_of(p_wc,'23',1) = 0 AND s_chr_get_index_of(p_wc,'25',1) = 0THEN
         RETURN
      END IF
      IF p_type = '1' THEN
         #1類須撈取本張立帳單關聯的採購單號(apcb008)串sql條件
         LET l_sql = " SELECT DISTINCT apcbseq,apcb008 FROM apca_t,apcb_t ",
                     "  WHERE apcaent = apcbent " ,
                     "    AND apcald = apcbld ",
                     "    AND apcadocno = apcbdocno ",
                     "    AND apcaent = '",g_enterprise,"' ",
                     "    AND apcald = '",p_ld,"' ",
                     "    AND apcadocno = '",p_docno,"' ",
                     "  ORDER BY apcbseq "
         PREPARE aapt560_sel_apcb_p FROM l_sql
         DECLARE aapt560_sel_apcb_c CURSOR FOR aapt560_sel_apcb_p
         FOREACH aapt560_sel_apcb_c INTO l_apcbseq,l_apcb008
            IF cl_null(l_str)THEN
               LET l_str = l_apcb008 CLIPPED
            ELSE
               LET l_str = l_str CLIPPED,",",l_apcb008 CLIPPED
            END IF
         END FOREACH
         CALL s_fin_get_wc_str(l_str) RETURNING l_str
      END IF
   END IF
   
   CALL s_ld_sel_glaa(p_ld,'glaa017|glaa021|glaa001|glaa016|glaa020')
       RETURNING  g_sub_success,l_glaa017,l_glaa021,l_glaa001,l_glaa016,l_glaa020
   
   #此次單據
   SELECT apca004,apca005,apca100,apcacomp,apcadocdt
     INTO l_apca0041,l_apca0051,l_apca1001,l_apcacomp,l_apcadocdt
     FROM apca_t
    WHERE apcaent = g_enterprise AND apcald = p_ld
      AND apcadocno = p_docno
   
   #待抵範圍
   LET l_sql = " SELECT apca001,apca014,apca015,apca033,apca034, ",
               "        apca035,apca059,",
               "        apcccomp,apccsite,apccdocno,apccseq,",
               "        apcc001,apcc100,apcc121,apcc131,",  
               "        apcc101,apcc102,",
               "        apcc108,apcc118,apcc128,apcc138  ,",
               "        apcc109,apcc119,apcc129,apcc139  ,",
               "        apca018 ",                            
               "   FROM apca_t,apcc_t ",
               "  WHERE apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno  ",
               "    AND apcaent = ",g_enterprise,"  AND apcald ='",p_ld,"'",
               "    AND apcc108-apcc109 <> 0        AND apca100='",l_apca1001,"'",
               "    AND apcastus = 'Y'"
   CASE p_type
      WHEN '0'   #aapt110的27:其他待抵單
         LET l_sql = l_sql," AND apcadocno IN ",l_str
      WHEN '1'   #1.21:訂單待抵/23:預付待抵/25:押金待抵優先+同採購單
         LET l_sql = l_sql," AND apca001 IN (",p_wc,") AND apca001 IN ('21','23','25')",
                           " AND apcadocno IN ( SELECT apcbdocno FROM apcb_t ",
                           "                     WHERE apcbent = apcaent AND apcbld = apcald ",
                           "                       AND apcb002 IN ",l_str,") "
      WHEN '2'   #2.21:訂單待抵/23:預付待抵/25:押金待抵優先+帳款對象+付款對象
         LET l_sql = l_sql," AND apca004 ='",l_apca0041,"' AND apca005='",l_apca0051,"'",
                           " AND apca001 IN (",p_wc,") AND apca001 IN ('21','23','25') "
      WHEN '3'   #3.帳款對象+付款對象
         LET l_sql = l_sql," AND apca004 ='",l_apca0041,"' AND apca005='",l_apca0051,"'",
                           " AND apca001 IN (",p_wc,") "
      WHEN '4'
         LET l_sql = l_sql," AND apca001 IN ('21','23','25') AND ",p_wc CLIPPED
   END CASE
   LET l_sql = l_sql,"  ORDER BY apcc004,apcadocno,apcc001,apccseq"
   PREPARE aapt560_ins_apce_p FROM l_sql
   DECLARE aapt560_ins_apce_c CURSOR FOR aapt560_ins_apce_p
   FOREACH aapt560_ins_apce_c INTO l_apca001,l_apca014,l_apca015,l_apca033,l_apca034,
                                     l_apca035,l_apca059,
                                     l_apcccomp,l_apccsite,l_apccdocno,l_apccseq,
                                     l_apcc001,l_apcc100,l_apcc121,l_apcc131,
                                     l_apcc101,l_apcc102,
                                     l_apcc108,l_apcc118,l_apcc128,l_apcc138,
                                     l_apcc109,l_apcc119,l_apcc129,l_apcc139,
                                     l_apca018          #151130-00015#4
      
      #未付款的单据审核后生成的待抵单，在没有付款前不允许在进行冲抵。
      SELECT COUNT(apcadocno) INTO l_cnt
        FROM apca_t,apcc_t
       WHERE apcaent = apccent 
         AND apcald = apccld AND apcadocno = apccdocno
         AND apcastus = 'Y'  AND apcc108 - apcc109 > 0
         AND apcaent = g_enterprise
         AND apcald  = p_ld  AND apca019 = l_apccdocno
      IF l_cnt > 0 THEN
         CONTINUE FOREACH
      END IF

      IF l_apca001 = '21' AND l_sfin3020 = 'Y' AND NOT cl_null(l_apca018) THEN
         SELECT COUNT(*) INTO l_cnt
           FROM apcb_t,pmdt_t
          WHERE apcbent = g_enterprise 
            AND apcbld  = p_ld AND apcbdocno = p_docno
            AND apcbent = pmdtent AND apcb001 = '11'  
            AND apcb002 = pmdtdocno AND apcb003 = pmdtseq
            AND pmdt001 IN (SELECT DISTINCT apcb002 FROM apcb_t WHERE apcbent = g_enterprise AND apcbld = p_ld AND apcbdocno = l_apca018 AND apcb001 = '10')
         IF l_cnt = 0 THEN CONTINUE FOREACH END IF
      END IF

      IF p_type = '0' THEN
         #直接撈aapt110的錢進來沖即可
         SELECT apba105,apba115 INTO l_apba103,l_apba113 
           FROM apba_t
           LEFT JOIN apca_t ON apbaent=apcaent AND apbadocno=apca018
          WHERE apcaent = g_enterprise
            AND apcald = p_ld
            AND apcadocno = p_docno
            AND apba005 = l_apccdocno
            AND apba006 = l_apccseq
            AND apba020 = l_apcc001
         IF cl_null(l_apba103) THEN LET l_apba103 = 0 END IF
         IF cl_null(l_apba113) THEN LET l_apba113 = 0 END IF
         IF l_apba103 = 0 THEN CONTINUE FOREACH END IF
      ELSE
         #取得待抵單號+項次+帳期剩餘可沖銷金額
         CALL s_aapt420_apcc_used_num('41',p_ld,p_ld,l_apccdocno,l_apccseq,l_apcc001,p_docno,' ','1')
              RETURNING g_sub_success,g_errno,l_apcc_left.apce109,l_apcc_left.apce119,l_apcc_left.apce129,l_apcc_left.apce139      
         IF l_apcc_left.apce109 = 0 THEN CONTINUE FOREACH END IF
         #判斷是否已存在於同一張應付單據中的直接沖帳檔,若已存在則跳過此筆
         LET l_cnt = 0 
         SELECT COUNT(*) INTO l_cnt FROM apce_t
          WHERE apceent = g_enterprise
            AND apceld = p_ld
            AND apcedocno = p_docno     #本張應付單據
            AND apce003 = l_apccdocno   #沖銷帳款單號
            AND apce004 = l_apccseq     #沖銷帳款項次
         IF l_cnt > 0 THEN
            CONTINUE FOREACH
         END IF
      END IF #160705-00035#3
      
      #防止本次立帳單被超沖check-s
      #立帳單未付金額
      SELECT SUM(apcc108 - apcc109) INTO l_apcc109sum
        FROM apcc_t
       WHERE apccent = g_enterprise
         AND apccld  = p_ld AND apccdocno = p_docno
      #目前直接沖帳金額
      SELECT SUM(apce109) INTO l_apce109sum
        FROM apca_t,apce_t   #150316apo add apca_t
       WHERE apceent = g_enterprise
         AND apceld  = p_ld AND apcedocno = p_docno
         AND apcaent = apceent
         AND apcald  = apceld
         AND apcadocno = apcedocno
         AND apcastus NOT IN ('X')
         AND apce001 <> 'aapt430'  #150212
      IF cl_null(l_apcc109sum) THEN LET l_apcc109sum = 0 END IF
      IF cl_null(l_apce109sum) THEN LET l_apce109sum = 0 END IF
      IF l_apcc109sum <= l_apce109sum THEN
         EXIT FOREACH
      END IF
      #尚可沖帳金額
      LET l_apce109 = l_apcc109sum - l_apce109sum
      IF l_apce109 > l_apcc_left.apce109 THEN
         LET l_apce109 = l_apcc_left.apce109
      END IF
      #防止本次立帳單被超沖check-e
      
      INITIALIZE l_apce.* TO NULL
      LET l_apce.apceent = g_enterprise
      LET l_apce.apcecomp= l_apcccomp
      LET l_apce.apcelegl= ''
      LET l_apce.apcesite= l_apccsite
      LET l_apce.apceld  = p_ld
      LET l_apce.apcedocno=p_docno
      SELECT MAX(apceseq)+1 INTO l_apce.apceseq
        FROM apce_t
       WHERE apceent = g_enterprise AND apceld = p_ld
         AND apcedocno = p_docno
      IF cl_null(l_apce.apceseq) THEN LET l_apce.apceseq = 1 END IF
      LET l_apce.apce001 = 'aapt300'
      IF p_sfin2002 MATCHES '[12]' THEN 
         LET l_apce.apceorga= l_apcccomp
         LET l_apce.apce018 = l_apca015
         LET l_apce.apce019 = l_apca034
         LET l_apce.apce021 = l_apca059
         LET l_apce.apce022 = l_apca033
      ELSE
         SELECT apcborga,apcb002,apcb003,apcb010,apcb011,
                apcb012 ,apcb017,apcb015,apcb016
           INTO l_apce.apceorga,l_apce.apce024,l_apce.apce025,l_apce.apce018,l_apce.apce019,
                l_apce.apce020 ,l_apce.apce021,l_apce.apce022,l_apce.apce023
           FROM apcb_t
          WHERE apcbent  = g_enterprise     AND apcbld = p_ld
            AND apcbdocno= l_apccdocno AND apcbseq= l_apccseq
      END IF
      IF l_apca001 = '25' THEN
         LET l_apce.apce002 = '42'
      ELSE
         LET l_apce.apce002 = '41'
      END IF
      LET l_apce.apce003 = l_apccdocno
      LET l_apce.apce004 = l_apccseq
      LET l_apce.apce005 = l_apcc001
      
      LET l_apce.apce007 = 0
      LET l_apce.apce009 = 'N'
      LET l_apce.apce015 = s_fin_get_scc_value('8506',l_apce.apce002,'3')
      LET l_apce.apce016 = l_apca035
      LET l_apce.apce017 = l_apca014
      #應稅折抵否
      LET l_apce.apce027 = s_aapp131_get_apce027(l_apce.apce003)  #150316apo 
      LET l_apce.apce028 = 'N'
      LET l_apce.apce038 = l_apca0041   #150415apo
      
      LET l_apce.apce100 = l_apcc100
      LET l_apce.apce101 = l_apcc102
      LET l_apce.apce104 = 0
      LET l_apce.apce114 = 0
      LET l_apce.apce121 = l_apcc121
      LET l_apce.apce124 = 0
      LET l_apce.apce131 = l_apcc131
      LET l_apce.apce134 = 0

      IF (l_apcc108 - l_apcc109) > l_apce109 THEN
         LET l_apce.apce109 = l_apce109
         LET l_apce.apce119 = l_apce109 * l_apcc101
         IF l_glaa017 = '1' THEN
            LET l_apce.apce129 = l_apce.apce109 * l_apcc121
         ELSE
            LET l_apce.apce129 = l_apce.apce119 * l_apcc121
         END IF
         IF l_glaa021 = '1' THEN
            LET l_apce.apce139 = l_apce.apce109 * l_apcc131
         ELSE
            LET l_apce.apce139 = l_apce.apce119 * l_apcc131
         END IF
      ELSE
         #如果是aapt110，只有部份沖，就寫入部份沖的錢
         IF p_type = '0' AND (l_apcc108 - l_apcc109) > l_apba103 THEN
            LET l_apce.apce109 = l_apba103
            LET l_apce.apce119 = l_apba113
            LET l_apce.apce129 = l_apba103 * l_apcc121
            LET l_apce.apce139 = l_apba103 * l_apcc131
         ELSE
            LET l_apce.apce109 = l_apcc108 - l_apcc109
            LET l_apce.apce119 = l_apcc118 - l_apcc119
            LET l_apce.apce129 = l_apcc128 - l_apcc129
            LET l_apce.apce139 = l_apcc138 - l_apcc139
         END IF  
      END IF

      CALL s_curr_round_ld('1',p_ld,l_apce.apce100,l_apce.apce109,2) RETURNING g_sub_success,g_errno,l_apce.apce109

      LET l_apca012 = 0 
      SELECT apca012 INTO l_apca012 FROM apca_t WHERE apcaent = g_enterprise 
         AND apcadocno = l_apce.apce003
         AND apcald    = p_ld
      IF cl_null(l_apca012) THEN LET l_apca012 = 0 END IF 
      LET l_apce.apce103 = l_apce.apce109 /  (1 + l_apca012 / 100) 
      CALL s_curr_round_ld('1',p_ld,l_apce.apce100,l_apce.apce103,2) RETURNING g_sub_success,g_errno,l_apce.apce103
      LET l_apce.apce104 = l_apce.apce109 - l_apce.apce103

      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce.apce119,2) RETURNING g_sub_success,g_errno,l_apce.apce119

      LET l_apce.apce113 = l_apce.apce119 /  (1 + l_apca012 / 100) 
      CALL s_curr_round_ld('1',p_ld,l_glaa001,l_apce.apce113,2) RETURNING g_sub_success,g_errno,l_apce.apce113
      LET l_apce.apce114 = l_apce.apce119 - l_apce.apce113
      CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apce.apce129,2) RETURNING g_sub_success,g_errno,l_apce.apce129
      LET l_apce.apce123 = l_apce.apce129 /  (1 + l_apca012 / 100) 
      CALL s_curr_round_ld('1',p_ld,l_glaa016,l_apce.apce123,2) RETURNING g_sub_success,g_errno,l_apce.apce123
      LET l_apce.apce124 = l_apce.apce129 - l_apce.apce123
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apce.apce139,2) RETURNING g_sub_success,g_errno,l_apce.apce139
      LET l_apce.apce133 = l_apce.apce139 /  (1 + l_apca012 / 100) 
      CALL s_curr_round_ld('1',p_ld,l_glaa020,l_apce.apce133,2) RETURNING g_sub_success,g_errno,l_apce.apce133
      LET l_apce.apce134 = l_apce.apce139 - l_apce.apce133
      INSERT INTO apce_t VALUES(l_apce.*)
   END FOREACH

END FUNCTION

 
{</section>}
 
