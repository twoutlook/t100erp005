<add_points prog="aapp910" std_prog="aapp910" erpver="1.0" module="AAP" ver="1" env="s" zone="t10dev" booking="Y">
  <point name="function.aapp910_exec_monthly_estimation" cite_std="N" status="d" ver="1" src="s" new="Y" order="14" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 暫估月結統計作業
# Usage..........: CALL aapp910_exec_monthly_estimation(p_ld,p_strdt,p_enddt,p_yy,p_mm)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_exec_monthly_estimation(p_ld,p_strdt,p_enddt)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE p_yy       LIKE xrec_t.xrec001
DEFINE p_mm       LIKE xrec_t.xrec002
DEFINE l_sql      STRING
DEFINE l_ar       RECORD
         apcaent  LIKE apca_t.apcaent,
         apcald   LIKE apca_t.apcald,
         apca004  LIKE apca_t.apca004,
         apcb004  LIKE apcb_t.apcb004,
         apcb006  LIKE apcb_t.apcb006,
         apcb100  LIKE apcb_t.apcb100,
         apcb007  LIKE apcb_t.apcb007,
         apcb103  LIKE apcb_t.apcb103,
         apcb113  LIKE apcb_t.apcb113
              END RECORD
DEFINE r_success  LIKE type_t.num5

   #先新增 再依條件把資料UPDATE進去
   LET r_success = TRUE
   LET l_sql = " INSERT INTO xrec_t (xrecent,xreccomp,xrecld, ",
               "                     xrec001,xrec002,xrec003,xrec004,xrec005,",
               "                     xrec006,xrec012,xrec100",
               "                     xrec007,xrec008,xrec009,xrec010,xrec011,",
               "                     xrec103,xrec104,xrec105,xrec113,xrec114,xrec115) ",
               "     SELECT DISTINCT apcaent,apcacomp,apcald,",
               "                           ?,      ?,   'AP',    '1',apca004,",
               "                     apcb004,apcb006,apcb100",
               "                           0,      0,      0,      0,      0,",
               "                           0,      0,      0,      0,      0,      0",
               "       FROM apca_t,apcb_t",
               "      WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "        AND apcaent = ?       AND apcald = ? ",
               "        AND ( (apca001 = '01' OR apca001 = '02')  OR apcb023 = 'Y') ",
               "        AND apcadocdt BETWEEN ? AND ?"
   PREPARE exec_estimation_pre FROM l_sql
   EXECUTE exec_estimation_pre USING p_yy,p_mm,g_enterprise,p_ld,p_strdt,p_enddt
     
   #UPDATE (SELECT apcb007,apcb113
   #          FROM apca_t,apcb_t
   #         WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno
   #           AND apcaent = 99 AND apcald ='02'
   #           AND apca001 = '13' )
   #   SET apcb113 = apcb007+apcb113
      UPDATE apca_t SET (apcamodid,apcamoddt) = (g_apca_m.apcamodid,g_apca_m.apcamoddt)
       WHERE apcaent = g_enterprise AND apcald = g_apcald_t
         AND apcadocno = g_apcadocno_t
         
   LET l_sql = " UPDATE xrec_t SET (xrec007,xrec103,xrec113) = (?,?,?) ",
               "  WHERE xrecent = ? AND xrecld  = ? ",
               "    AND xrec001 = ? AND xrec002 = ? AND xrec003 = 'AP' AND xrec004 = '1' AND xrec005 = ? ",
               "    AND xrec006 = ? AND xrec012 = ? AND xrec100 = ?"          
   PREPARE exec_upd_xrec007_pre FROM l_sql       
   
   LET l_sql = " SELECT apcaent,apcald,apca004, apcb004,apcb006,apcb100,",
               "        SUM(apcb007),SUM(apcb103),SUM(apcb113)",
               "   FROM apca_t,apcb_t",
               "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "    AND apcaent = ?       AND apcald = ? ",
               "    AND apca001 = '01'   AND apcb001 = '入庫單'",
               "    AND apcadocdt BETWEEN ? AND ? ",
               "  GROUP BY apcaent,apcald,apca004, apcb004,apcb006,apcb100"
   PREPARE exec_sum_xrec007_pre FROM l_sql
   DECLARE exec_sum_xrec007_cur CURSOR FOR exec_sum_xrec007_pre
   FOREACH exec_sum_xrec007_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_ar.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_sum_xrec007_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
         
      EXECUTE exec_upd_xrec007_pre
        USING l_ar.apcaent,l_ar.apcald ,
                      p_yy,        p_mm,l_ar.apca004,
              l_ar.apcb004,l_ar.apcb006,l_ar.apcb100
         INTO l_ar.apcb007,l_ar.apcb103,l_ar.apcb113
      #update失敗要有錯誤訊息
   END FOREACH
   
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_exec_exchange_rate" cite_std="N" status="d" ver="1" src="s" new="Y" order="13" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 匯率重評價
# Usage..........: CALL aapp910_exec_exchange_rate(p_ld,p_strdt,p_enddt,p_yy,p_mm)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_exec_exchange_rate(p_ld,p_strdt,p_enddt)
DEFINE p_ld        LIKE glaa_t.glaald
DEFINE p_strdt     LIKE type_t.dat
DEFINE p_enddt     LIKE type_t.dat
DEFINE r_success   LIKE type_t.num5
DEFINE l_cnt       LIKE type_t.num5
DEFINE l_apce      RECORD
         apce003   LIKE apce_t.apce003,
         apce004   LIKE apce_t.apce004,
         apce005   LIKE apce_t.apce005,
         apce109   LIKE apce_t.apce109,
         apce119   LIKE apce_t.apce119,
         apce129   LIKE apce_t.apce129,
         apce139   LIKE apce_t.apce139
              END  RECORD
DEFINE l_apcc      RECORD
         apccdocno LIKE apcc_t.apccdocno,
         apccseq   LIKE apcc_t.apccseq,
         apcc108   LIKE apcc_t.apcc108,
         apcc118   LIKE apcc_t.apcc118,
         apcc128   LIKE apcc_t.apcc128,
         apcc138   LIKE apcc_t.apcc138
              END  RECORD
DEFINE l_apcb114   LIKE apcb_t.apcb114
DEFINE l_apcb124   LIKE apcb_t.apcb124
DEFINE l_apcb134   LIKE apcb_t.apcb134

   LET r_success = TRUE

#>>1.處理資料範圍
   #抓apcadocdt < p_enddt / apcc108-apcc109 > 0
   LET l_sql = " INSERT INTO apcc_tmp (apccdocno,apccseq,apcc001,apcc100, ",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139)",
               "                SELECT apccdocno,apccseq,apcc001,apcc100,",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139",
               "                  FROM apca_t,apcc_t",
               "                 WHERE apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno ",
               "                   AND apcaent = ?       AND apcald = ?      AND apcadocdt <= ? ",
               "                   AND (apcc108-apcc109 ) > 0",
   PREPARE exec_ins_tmp_pre FROM l_sql
   EXECUTE exec_ins_tmp_pre USING g_enterprise,p_ld,p_enddt
   
   LET l_sql = " INSERT INTO apcc_tmp (apccdocno,apccseq,apcc001,apcc100 ",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139)",
               "                SELECT apccdocno,apccseq,apcc001,apcc100,",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139",
               "                  FROM apcc_t",
               "                 WHERE apccent = ? AND apccld = ? AND apccdocno = ? ",
               "                   AND apcc001 = ? AND apccseq= ? "
   PREPARE exec_ins_tmp1_pre FROM l_sql
   EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,p_enddt
   
   #由於apcc109是現行最新的金額 若為5月的帳 執行月結可能會是6月初,因此要將6月的apcc109扣除
   #處理付款沖帳
   LET l_sql = " SELECT apce003,apce004,apce005,apce109,apce119,apce129,apce139 ",
               "   FROM apda_t,apce_t ",
               "  WHERE apdaent = apceent   AND apdald = apceld AND apdadocno = apcedocno ",
               "    AND apce003 IS NOT NULL AND apdaent = ?     AND apdald = ? ",
               "    AND apdadocdt > ? "
   PREPARE exec_rate_apce1_pre FROM l_sql
   DECLARE exec_rate_apce1_cur CURSOR FOR exec_rate_apce1_pre
   FOREACH exec_rate_apce1_cur USING g_enterprise,p_ld,p_enddt INTO l_apce.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_rate_apce1_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      IF l_apca.apce005 = 0 THEN #apce005 若為0表示不管特別沖到哪一期
      
        # SELECT count(1) INTO l_cnt FROM apcc_tmp
        #  WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.aapce004
        #    AND apcc001   = l_apce.apce005
        # IF l_cnt = 0 THEN
        #    EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.aapce004,l_apce.apce005
        # END IF
         
      ELSE
         LET l_cnt = 0
         SELECT count(1) INTO l_cnt FROM apcc_tmp
          WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.aapce004
            AND apcc001   = l_apce.apce005
         IF l_cnt = 0 THEN
            EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.aapce004,l_apce.apce005
         END IF
         UPDATE apcc_tmp
            SET apcc109 = apcc109 -l_apce.apcc109
                apcc119 = apcc119 -l_apce.apcc119
                apcc129 = apcc129 -l_apce.apcc129
                apcc139 = apcc139 -l_apce.apcc139
          WHERE apccdocno = l_apce.apce003 AND apccseq = apce004
            AND apcc001   = l_apce.apce005
      END IF
   END FOREACH
   #處理直接沖帳
   LET l_sql = " SELECT apce003,apce004,apce005,apce109,apce119,apce129,apce139 ",
               "   FROM apca_t,apce_t ",
               "  WHERE apcaent = apceent   AND apcald = apceld AND apcadocno = apcedocno ",
               "    AND apce003 IS NOT NULL AND apcaent = ?     AND apcald = ? ",
               "    AND apcadocdt > ? "
   PREPARE exec_rate_apce2_pre FROM l_sql
   DECLARE exec_rate_apce2_cur CURSOR FOR exec_rate_apce2_pre
   FOREACH exec_rate_apce2_cur USING g_enterprise,p_ld,p_enddt INTO l_apce.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_rate_apce1_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      IF l_apca.apce005 = 0 THEN #apce005 若為0表示不管特別沖到哪一期
      
        # SELECT count(1) INTO l_cnt FROM apcc_tmp
        #  WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.aapce004
        #    AND apcc001   = l_apce.apce005
        # IF l_cnt = 0 THEN
        #    EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.aapce004,l_apce.apce005
        # END IF
         
      ELSE
         LET l_cnt = 0
         SELECT count(1) INTO l_cnt FROM apcc_tmp
          WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.aapce004
            AND apcc001   = l_apce.apce005
         IF l_cnt = 0 THEN
            EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.aapce004,l_apce.apce005
         END IF
         UPDATE apcc_tmp
            SET apcc109 = apcc109 -l_apce.apcc109
                apcc119 = apcc119 -l_apce.apcc119
                apcc129 = apcc129 -l_apce.apcc129
                apcc139 = apcc139 -l_apce.apcc139
          WHERE apccdocno = l_apce.apce003 AND apccseq = apce004
            AND apcc001   = l_apce.apce005
      END IF
   END FOREACH
#>>2.寫入xreb
   LET l_sql = "SELECT apcacomp,apca001,apcadocdt,apca004,apcblegl,",
               "       apcb010,apcb011,apcb012,apca014,apca059,",
               "       apcb015,apcb016,apcb029,apcb021,apcb114,",
               "       apcb124,apcb134",
               "  FROM apca_t,apcb_t",
               " WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno",
               "   AND apcbent = ? AND apcbld = ? AND apcbdocno = ? AND apcbseq = ?"
   PREPARE exec_rate_get_apcb_pre FROM l_sql
   
   LET l_sql = "SELECT apccdocno,apccseq,apcc001,apcc100, ",
               "       apcc108-apcc109,apcc118-apcc119,apcc128-apcc129,apcc138-apcc139",
               "  FROM apcc_tmp"
               " ORDER BY apccdocno,apccseq,apcc001"
   PREPARE exec_rate_ins_xreb_pre FROM l_sql
   DECLARE exec_rate_ins_xreb_cur CURSOR FOR exec_rate_ins_xreb_pre
   FOREACH exec_rate_ins_xreb_cur INTO l_apcc.apccdocno,l_apcc.apccseq,l_apcc.apcc001,l_apcc.apcc100,
                                       l_apcc.apcc108  ,l_apcc.apcc118,l_apcc.apcc128,l_apcc.apcc138

      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_rate_ins_xreb_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      INITIALIZE l_xreb.* TO NULL
      LET l_xreb.xrebent = g_enterprise
      LET l_xreb.xrebld  = p_ld
      LET l_xreb.xreb001 = p_yy
      LET l_xreb.xreb002 = p_mm
      LET l_xreb.xreb003 = 'AP'
      LET l_xreb.xreb005 = l_apcc.apccdocno
      LET l_xreb.xreb006 = l_apcc.apccseq
      LET l_xreb.xreb007 = l_apcc.apcc001
      LET l_xreb.xreb013 = ''
      LET l_xreb.xreb014 = ''
      LET l_xreb.xreb100 = l_apcc.apcc100
      LET l_xreb.xreb103 = l_apcc.apcc108
      LET l_xreb.xreb113 = l_apcc.apcc118
      LET l_xreb.xreb123 = l_apcc.apcc128
      LET l_xreb.xreb133 = l_apcc.apcc138
      
        LET l_sql = "SELECT apcacomp,apca001,apcadocdt,apca004,apcblegl,",
               "       apcb010,apcb011,apcb012,apca014,apca059,",
               "       apcb015,apcb016,apcb029,apcb021,apcb114,",
               "       apcb124,apcb134",
               
      EXECUTE exec_rate_get_apcb_pre USING g_enterprise,p_ld,l_xreb.xreb005,l_xreb.xreb006
         INTO l_xreb.xrebcomp,l_xreb.xreb004,l_xreb.xreb008,l_xreb.xreb009,l_xreb.xreb010,
              l_xreb.xreb011,l_xreb.xreb012,l_xreb.xreb015,l_xreb.xreb014,l_xreb.xreb017,
              l_xreb.xreb018,l_xreb.xreb019,l_xreb.xreb020,l_xreb.xreb022,l_apcb114,
              l_apcb124,l_apcb134
      
     #CALL s_fin_get_account('DSCTC','13','8504','8504_21')
#                  RETURNING r_success,r_account,r_errno
      #LET l_xreb.xreb023  s_fin_get_account
      #LET l_xreb.xreb101
      #LET l_xreb.xreb104
      
      #LET l_xreb.xreb114
      #LET l_xreb.xreb115
      #LET l_xreb.xreb116
      #LET l_xreb.xreb117

   END FOREACH


   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_set_ld_info" cite_std="N" status="" ver="1" src="s" new="Y" order="1" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 帳別預設值
# Usage..........: CALL aapp910_set_ld_info(p_ld)
# Input parameter: p_ld    帳別
# Date & Author..: 14/06/12
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_set_ld_info(p_ld)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE l_success  LIKE type_t.num5

   CALL s_ld_sel_glaa(p_ld,'glaacomp|glaa010|glaa011|glaa003')
        RETURNING l_success,g_input.glaacomp,g_input.xref001,g_input.xref002,g_glaa003
   #帳套類型
   #最後關帳日
   SELECT glaa013 INTO g_glaa013
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaald  = p_ld
   CALL aapp910_get_date()
   
   CALL s_fin_get_ld_type(p_ld) RETURNING g_type   
   LET g_input.xrefld_desc   = s_desc_get_ld_desc(g_input.xrefld)
   LET g_input.glaacomp_desc = s_desc_get_department_desc(g_input.glaacomp)
   
   DISPLAY BY NAME g_input.xrefld,g_input.xrefld_desc,g_input.glaacomp,g_input.glaacomp_desc,
                   g_input.xref001,g_input.xref002
                   
   
END FUNCTION]]>
</point>
  <point name="function.aapp910_get_date" cite_std="N" status="" ver="1" src="s" new="Y" order="2" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 取得日期區間
# Usage..........: CALL aapp910_get_date()
# Date & Author..: 14/06/12 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_get_date()
DEFINE l_flag    LIKE type_t.chr1
DEFINE l_tmp_va1 LIKE type_t.num5
DEFINE l_tmp_va2 LIKE type_t.dat
   
   IF cl_null(g_glaa003) OR cl_null(g_input.xref001) OR cl_null(g_input.xref002) THEN RETURN END IF
   #由會計週期檔(glav) 該歸屬期別的最小日期及最大日期
   CALL s_get_accdate(g_glaa003,'',g_input.xref001,g_input.xref002)
        RETURNING l_flag,g_errno,l_tmp_va1,l_tmp_va1,l_tmp_va2,l_tmp_va2,
                  l_tmp_va1,g_input.strdate,g_input.enddate,
                  l_tmp_va1,l_tmp_va2,l_tmp_va2

   DISPLAY BY NAME g_input.strdate,g_input.enddate
END FUNCTION]]>
</point>
  <point name="function.aapp910_chk_item" cite_std="N" status="" ver="1" src="s" new="Y" order="3" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 檢查項目
# Memo...........:
# Usage..........: CALL aapp910_chk_item()
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_chk_item()
DEFINE r_success  LIKE type_t.num5

   LET r_success = TRUE
   IF g_input.strdate < g_glaa013 OR g_input.enddate < g_glaa013 THEN
      RETURN FALSE
   END IF
   #檢核:應立帳卻未立帳之交易單據
   IF g_input.chk1 ='Y' THEN
      CALL aapp910_chk_cre_journal(g_input.xrefld,g_input.strdate,g_input.enddate,g_type) RETURNING r_success
      IF NOT r_success THEN
         RETURN r_success
      END IF
   END IF
   #檢核:帳款單
   IF g_input.chk2 ='Y' THEN
      CALL aapp910_chk_bill(g_input.xrefld,g_input.glaacomp,g_input.strdate,g_input.enddate,g_type) RETURNING r_success
      IF NOT r_success THEN
         RETURN r_success
      END IF
   END IF
   #檢核:單據號碼連續號
   IF g_input.chk3 ='Y' THEN
      CALL aapp910_chk_docno(g_input.xrefld,g_input.glaacomp,g_input.strdate,g_input.enddate) RETURNING r_success
      IF NOT r_success THEN
         RETURN r_success
      END IF
   END IF
   #檢核:已付款項無沖銷對應紀錄者
   IF g_input.chk4 ='Y' THEN
      CALL aapp910_chk_balancing_act(g_input.xrefld,g_input.strdate,g_input.enddate,g_type) RETURNING r_success
      IF NOT r_success THEN
         RETURN r_success
      END IF
   END IF
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_chk_cre_journal" cite_std="N" status="" ver="1" src="s" new="Y" order="4" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 應立帳卻未立帳之交易單據
# Usage..........: CALL aapp910_chk_cre_journal(p_ld,p_strdt,p_enddt,p_type)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_chk_cre_journal(p_ld,p_strdt,p_enddt,p_type)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE p_type     LIKE type_t.chr1
DEFINE l_sql      STRING
DEFINE l_ar       DYNAMIC ARRAY OF RECORD
           feld11 LIKE type_t.chr7, #pmdl_t:採購單
           feld12 LIKE type_t.chr7, 
           feld21 LIKE type_t.chr7, #pmds_t:收貨單
           feld22 LIKE type_t.chr7
              END RECORD
DEFINE l_docno    LIKE pmdl_t.pmdldocno
DEFINE l_slip     LIKE ooba_t.ooba002
DEFINE l_success  LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5

   LET r_success = TRUE
   IF cl_null(p_type) THEN RETURN FALSE END IF
   
   LET l_ar[1].feld11 = 'pmdm008'   LET l_ar[1].feld12 = 'pmdm009'  LET l_ar[1].feld21 = 'pmdt056'  LET l_ar[1].feld22 = 'pmdt024'  #主帳
   LET l_ar[2].feld11 = 'pmdm010'   LET l_ar[2].feld12 = 'pmdm011'  LET l_ar[2].feld21 = 'pmdt027'  LET l_ar[2].feld22 = 'pmdt039'  #帳二
   LET l_ar[3].feld11 = 'pmdm012'   LET l_ar[3].feld12 = 'pmdm013'  LET l_ar[3].feld21 = 'pmdt027'  LET l_ar[3].feld22 = 'pmdt040'  #帳三
   
   #採購單(pmdl_t:採購單單頭/pmdm_t:採購預付)
   LET l_sql = "SELECT DISTINCT pmdldocno ",
               "  FROM pmdl_t,pmdm_t",
               " WHERE pmdlent = pmdment AND pmdldocno = pmdmdocno",
               "   AND pmdlent = ",g_enterprise," AND pmdm003 <= ",p_enddt," AND pmdlstus ='Y'",
               "   AND  (pmdm005  <> ",l_ar[p_type].feld11," OR pmdm006  <> ",l_ar[p_type].feld12,")"
   PREPARE chk_pmdm_pre FROM l_sql
   DECLARE chk_pmdm_cur CURSOR FOR chk_pmdm_pre
   FOREACH chk_pmdm_cur INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk_pmdm_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   
   #入庫單(pmds_t:收貨單頭/pmdt_t收貨單身)
   LET l_sql = "SELECT DISTINCT pmdsdocno",
               "  FROM pmds_t,pmdt_t",
               " WHERE pmdsent = pmdtent AND pmdsdocno = pmdtdocno",
               "   AND pmdsent = ",g_enterprise," AND pmdsdocdt <= ",p_enddt," AND pmdsstus ='S'",
               "   AND ",l_ar[p_type].feld21," <> ",l_ar[p_type].feld22
   PREPARE chk_pmds_pre FROM l_sql
   DECLARE chk_pmds_cur CURSOR FOR chk_pmds_pre
   FOREACH chk_pmds_cur INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk_pmds_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   CALL l_ar.clear()
   RETURN r_success
   
END FUNCTION]]>
</point>
  <point name="function.aapp910_chk_bill" cite_std="N" status="" ver="1" src="s" new="Y" order="5" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 檢核帳款單
# Usage..........: CALL aapp910_chk_bill(p_ld,p_comp,p_strdt,p_enddt,p_type)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_chk_bill(p_ld,p_comp,p_strdt,p_enddt,p_type)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_comp     LIKE glaa_t.glaacomp
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE p_type     LIKE type_t.chr1
DEFINE l_docno    LIKE pmdl_t.pmdldocno
DEFINE l_sql      STRING
DEFINE l_slip     LIKE ooba_t.ooba002
DEFINE l_ar       DYNAMIC ARRAY OF RECORD
           glaald LIKE glaa_t.glaald
              END RECORD
DEFINE i          LIKE type_t.num5
DEFINE l_docno1   LIKE apca_t.apcadocno
DEFINE l_apcastus LIKE apca_t.apcastus
DEFINE l_apca038  LIKE apca_t.apca038
DEFINE l_success  LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5

   LET r_success = TRUE
#>>1.檢核:應確認未確認單據
   ##立帳檔(apca)
   LET l_sql = "SELECT DISTINCT apcadocno ",
               "  FROM apca_t",
               " WHERE apcaent = ? AND apcastus ='N'",
               "   AND apcald  = ? ",
               "   AND apcadocdt BETWEEN ? AND ?"
   PREPARE chk1_apca_pre FROM l_sql
   DECLARE chk1_apca_cur CURSOR FOR chk1_apca_pre
   FOREACH chk1_apca_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk1_apca_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   ##沖帳檔(apda)
   LET l_sql = "SELECT DISTINCT apdadocno ",
               "  FROM apda_t",
               " WHERE apdaent = ? AND apdastus ='N'",
               "   AND apdald  = ? ",
               "   AND apdadocdt BETWEEN ? AND ? "
   PREPARE chk1_apda_pre FROM l_sql
   DECLARE chk1_apda_cur CURSOR FOR chk1_apda_pre
   FOREACH chk1_apda_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk1_apda_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
#>>2.檢核:應轉傳票未轉傳票單據
   ##立帳檔(apca)
   LET l_sql = "SELECT DISTINCT apcadocno ",
               "  FROM apca_t",
               " WHERE apcaent = ? AND apcastus = 'Y' ",
               "   AND apcald  = ? AND apca038 IS NULL",
               "   AND apcadocdt BETWEEN ? AND ?"
   PREPARE chk2_apca_pre FROM l_sql
   DECLARE chk2_apca_cur CURSOR FOR chk2_apca_pre
   FOREACH chk2_apca_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk2_apca_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   ##沖帳檔(apda)
   LET l_sql = "SELECT DISTINCT apdadocno ",
               "  FROM apda_t",
               " WHERE apdaent = ? AND apdastus = 'N' ",
               "   AND apdald  = ? AND apda014 IS NULL",
               "   AND apdadocdt BETWEEN ? AND ?"
   PREPARE chk2_apda_pre FROM l_sql
   DECLARE chk2_apda_cur CURSOR FOR chk2_apda_pre
   FOREACH chk2_apda_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk2_apda_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   
#>>3.檢核:已轉傳票該傳票未確認單據
   ##立帳檔(apca)
   LET l_sql = "SELECT DISTINCT apcadocno ",
               "  FROM apca_t,glap_t",
               " WHERE apcaent = ? AND apcastus = 'Y'",
               "   AND apcald  = ? AND apca038  = glapdocno ",
               "   AND apcadocdt BETWEEN ? AND ? ",
               "   AND glapstus ='N'",
               "   AND apdaent = glapent AND apdald = glapld"
   PREPARE chk3_apca_pre FROM l_sql
   DECLARE chk3_apca_cur CURSOR FOR chk3_apca_pre
   FOREACH chk3_apca_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk3_apca_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   ##沖帳檔(apda)
   LET l_sql = "SELECT DISTINCT apdadocno ",
               "  FROM apda_t,glap_t",
               " WHERE apdaent = ? AND apdastus = 'N'",
               "   AND apdald  = ? AND apda014  = glapdocno ",
               "   AND apdadocdt BETWEEN ? AND ?",
               "   AND glapstus ='N'",
               "   AND apdaent = glapent AND apdald = glapld"
   PREPARE chk3_apda_pre FROM l_sql
   DECLARE chk3_apda_cur CURSOR FOR chk3_apda_pre
   FOREACH chk3_apda_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk3_apda_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
   
#>>4.檢核:次帳套有無隨主帳套產生
   IF p_type MATCHES '[1]' AND NOT cl_null(p_comp) THEN #若為主帳才檢查
      LET l_sql = "SELECT glaald FROM glaa_t ", 
                  " WHERE glaacomp = ? AND glaa023 = '2'"
      PREPARE chk4_glaa_pre FROM l_sql
      DECLARE chk4_glaa_cur CURSOR FOR chk4_glaa_pre
      LET i = 1
      FOREACH chk4_glaa_cur USING p_comp INTO l_ar[i].glaald
         IF SQLCA.sqlcode THEN
            CALL cl_err('foreach:chk4_glaa_cur',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         LET i = i +1
      END FOREACH
      ##立帳檔(apca)
      LET l_sql = "SELECT apcadocno,apcastus,apca038 FORM apca_t",
                  "  FROM apca_t",
                  " WHERE apcaent = ? AND apcald  = ? ",
                  "   AND apcadocdt BETWEEN ? AND ?"
      PREPARE chk4_apca_cnt_pre FROM l_sql
      LET l_sql = "SELECT apcadocno ",
                  "  FROM apca_t",
                  " WHERE apcaent = ? AND apcastus = 'Y' ",
                  "   AND apcald  = ? AND apca038 IS NULL",
                  "   AND apcadocdt BETWEEN ? AND ?"
      PREPARE chk4_apca_pre FROM l_sql
      DECLARE chk4_apca_cur CURSOR FOR chk4_apca_pre
      FOREACH chk4_apca_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
         IF SQLCA.sqlcode THEN
            CALL cl_err('foreach:chk4_apca_cur',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         FOR i = 1 TO l_ar.getLength()
            IF cl_null(l_ar[i].glaald) THEN EXIT FOR END IF
            LET l_docno1   = ''
            LET l_apcastus = ''
            LET l_apca038  = ''
            EXECUTE chk4_apca_cnt_pre USING g_enterprise,l_ar[i].glaald,l_docno,p_strdt,p_enddt INTO l_docno1,l_apcastus,l_apca038
            CASE
                WHEN cl_null(l_docno1)
                     CALL aapp910_set_errmsg(l_ar[i].glaald,l_docno,'')
                WHEN l_apca038 <> 'X' AND cl_null(l_apca038)
                     CALL aapp910_set_errmsg(l_ar[i].glaald,l_docno,'')
            END CASE
         END FOR
      END FOREACH
      ##沖帳檔(apda)
      LET l_sql = "SELECT count(1) FORM apda_t",
                  "  FROM apda_t",
                  " WHERE apdaent = ? AND apdald  = ? ",
                  "   AND apdadocdt BETWEEN ? AND ?"
      PREPARE chk4_apda_cnt_pre FROM l_sql
      LET l_sql = "SELECT apdadocno ",
                  "  FROM apda_t",
                  " WHERE apdaent = ? AND apdastus = 'Y' ",
                  "   AND apdald  = ? AND apda038 IS NULL",
                  "   AND apdadocdt BETWEEN ? AND ?"
      PREPARE chk4_apda_pre FROM l_sql
      DECLARE chk4_apda_cur CURSOR FOR chk4_apda_pre
      FOREACH chk4_apda_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno
         IF SQLCA.sqlcode THEN
            CALL cl_err('foreach:chk4_apda_cur',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         FOR i = 1 TO l_ar.getLength()
            IF cl_null(l_ar[i].glaald) THEN EXIT FOR END IF
            LET l_docno1   = ''
            LET l_apcastus = ''
            LET l_apca038  = ''
            EXECUTE chk4_apda_cnt_pre USING g_enterprise,l_ar[i].glaald,l_docno,p_strdt,p_enddt INTO l_docno1,l_apcastus,l_apca038
            CASE
                WHEN cl_null(l_docno1)
                     CALL aapp910_set_errmsg(l_ar[i].glaald,l_docno,'')
                WHEN l_apca038 <> 'X' AND cl_null(l_apca038)
                     CALL aapp910_set_errmsg(l_ar[i].glaald,l_docno,'')
            END CASE
         END FOR
      END FOREACH
   END IF   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_chk_docno" cite_std="N" status="" ver="1" src="s" new="Y" order="6" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 檢核單據號碼
# Memo...........:
# Usage..........: CALL aapp910_chk_docno(p_ld,p_comp,p_strdt,p_enddt)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_chk_docno(p_ld,p_comp,p_strdt,p_enddt)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE p_comp     LIKE glaa_t.glaacomp
DEFINE l_doc_len  LIKE type_t.num5     #單號總長度
DEFINE l_slip_len LIKE type_t.num5     #單別長度
DEFINE l_oobx007  LIKE oobx_t.oobx007  #所剩流水碼
DEFINE l_slip     LIKE oobx_t.oobx001
DEFINE l_str_no   LIKE type_t.num5
DEFINE l_docno    LIKE apca_t.apcadocno
DEFINE l_docno1   LIKE apca_t.apcadocno
DEFINE l_cnt      LIKE type_t.num5
DEFINE l_flag     LIKE type_t.chr1
DEFINE i,j        LIKE type_t.num5
DEFINE l_max      LIKE type_t.num10
DEFINE l_ar       DYNAMIC ARRAY OF RECORD
        tabnm     LIKE type_t.chr4
              END RECORD
DEFINE l_sql      STRING
DEFINE l_success  LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5
   
   LET r_success = TRUE
   
#>>取得單據流水號總長度(aoos010)
   LET l_doc_len = cl_get_para(g_enterprise,p_comp,'E-COM-0005')
   IF cl_null(l_doc_len) THEN
      CALL cl_err('','sub-00310',0)
      LET r_success =FALSE
      RETURN r_success
   END IF
#>>單別長度
   LET l_slip_len = 0
   LET l_cnt  = cl_get_para(g_enterprise,p_comp,'E-COM-0001')   #單別長度
   IF l_cnt > 0 THEN
      LET l_slip_len = l_slip_len + l_cnt
   END IF
   LET l_cnt  = cl_get_para(g_enterprise,p_comp,'E-COM-0003')   #營運據點長度
   IF l_cnt > 0 THEN
      LET l_slip_len = l_slip_len + l_cnt
   END IF
   LET l_flag = cl_get_para(g_enterprise,p_comp,'E-COM-0002')   #是否有區隔符號
   IF l_flag = 'Y' THEN
      LET l_slip_len = l_slip_len + 1
   END IF
   LET l_flag = cl_get_para(g_enterprise,p_comp,'E-COM-0004')   #是否有區隔符號
   IF l_flag = 'Y' THEN
      LET l_slip_len = l_slip_len + 1
   END IF
   IF l_slip_len = 0 THEN
      LET r_success =FALSE
      RETURN r_success
   END IF
   CALL l_ar.clear()
   LET l_ar[1].tabnm = 'apca' 
   LET l_ar[2].tabnm = 'apda' 
   FOR i = 1 TO l_ar.getLength() 
      #1.取一個完整的單號,才能取單別
      LET l_sql = " SELECT apcadocno",
                  "   FROM apca_t ",
                  "  WHERE apcaent = ? AND apcald = ?",
                  "    AND LENGTH(apcadocno) = ?",
                  "    AND apcadocdt BETWEEN ? AND ?",
                  "    AND apcadocno LIKE ?"
      LET l_sql = cl_replace_str(l_sql,'apca',l_ar[i].tabnm)
      PREPARE apcadocno_pre FROM l_sql
      
      #2.該單別最大流水號
      LET l_sql = " SELECT MAX(substr(apcadocno,?,?))",
                  "   FROM apca_t ",
                  "  WHERE apcaent = ? AND apcald = ?",
                  "    AND LENGTH(apcadocno) = ?",
                  "    AND apcadocdt BETWEEN ? AND ?",
                  "    AND apcadocno LIKE ?"
      LET l_sql = cl_replace_str(l_sql,'apca',l_ar[i].tabnm)
      PREPARE max_pre FROM l_sql
      
      #3.判斷號碼是否存在apca_t
      LET l_sql = " SELECT count(1) ",
                  "   FROM apca_t",
                  "  WHERE apcaent = ? AND apcald = ? ",
                  "    AND LENGTH(apcadocno) = ? ",
                  "    AND to_number(substr(apcadocno,7,4)) = ? ",
                  "   AND apcadocdt BETWEEN ? AND ? ",
                  "    AND apcadocno LIKE ? "
      LET l_sql = cl_replace_str(l_sql,'apca',l_ar[i].tabnm)
      PREPARE apca_t_pre FROM l_sql
   
      #4.有哪些單別要跑
      LET l_sql = " SELECT DISTINCT substr(apcadocno,1,?)",
                   "  FROM apca_t",
                   " WHERE apcaent = ? AND apcald = ?",
                   "   AND apcadocdt BETWEEN ? AND ? "
      LET l_sql = cl_replace_str(l_sql,'apca',l_ar[i].tabnm)
      PREPARE chk_docno_pre FROM l_sql
      
      DECLARE chk_docno_cur CURSOR FOR chk_docno_pre
      FOREACH chk_docno_cur USING l_slip_len,g_enterprise,p_ld,p_strdt,p_enddt INTO l_docno1
         IF SQLCA.sqlcode THEN
            LET r_success = FALSE
            CALL cl_err('foreach:chk_docno_cur',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         
         LET l_docno1 = l_docno1,'%'
         
         #1.取得該單別相關資訊(1.l_slip:單據別/2.l_oobx007:所剩流水號長度
         EXECUTE apcadocno_pre USING g_enterprise,p_ld,l_doc_len,p_strdt,p_enddt,l_docno INTO l_docno
         CALL s_aooi200_get_slip(l_docno) RETURNING l_success,l_slip
        #CALL s_fin_get_oobx004('',p_ld,l_slip) RETURNING l_rec.source
         SELECT oobx007 INTO l_oobx007 FROM oobx_t
          WHERE oobxent = g_enterprise AND oobx001 = l_slip AND oobx002 = 'AAP'
         
         #2.取得目前流水碼已編到的最大位數
         LET i = l_doc_len-l_oobx007+1
         EXECUTE max_pre USING i,l_oobx007,g_enterprise,p_ld,l_doc_len,p_strdt,p_enddt,l_docno INTO l_max
         FOR j = 1 TO l_max
            LET l_cnt = 0 
            EXECUTE apca_t_pre USING g_enterprise,p_ld,l_doc_len,j,p_strdt,p_enddt,l_docno INTO l_cnt
            IF l_cnt = 0 THEN
               #errmsg
            END IF
         END FOR
      END FOREACH
   END FOR
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_chk_balancing_act" cite_std="N" status="" ver="1" src="s" new="Y" order="7" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 已付帳款無沖銷對應紀錄
# Memo...........:
# Usage..........: CALL aapp910_chk_balancing_act(p_ld,p_strdt,p_enddt,p_type)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_chk_balancing_act(p_ld,p_strdt,p_enddt,p_type)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE p_type     LIKE type_t.chr1
DEFINE l_docno    LIKE pmdl_t.pmdldocno
DEFINE l_ar       DYNAMIC ARRAY OF RECORD
           feld11 LIKE type_t.chr7 #nmbb_t:銀存收支明細檔
              END RECORD
DEFINE l_sql      STRING
DEFINE l_slip     LIKE ooba_t.ooba002
DEFINE l_success  LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5

   LET r_success = TRUE
   LET l_ar[1].feld11 = 'nmbb008'
   LET l_ar[2].feld11 = 'nmbb020'
   LET l_ar[3].feld11 = 'nmbb023'

   #nmba_t:銀存收支主檔/nmbb_t:銀存收支明細檔
   LET l_sql = "SELECT DISTINCT nmbadocno ",
               "  FROM nmba_t,nmbb_t",
               " WHERE nmbaent = nmbbent AND ,nmbacomp = nmbbcomp AND nmbadocno = nmbbdocno",
               "   AND nmbaent = ",g_enterprise," AND nmbadocdt <= ",p_enddt," AND nmbb001 = '2' ", #提出
               "   AND (nmbastus = 'A' OR nmbastus ='Y') ",   #A:已審核/Y:己確認
               "   AND nmbb006  <> ",l_ar[p_type].feld11
   PREPARE chk_nmba_pre FROM l_sql
   DECLARE chk_nmba_cur CURSOR FOR chk_nmba_pre
   FOREACH chk_nmba_cur INTO l_docno
      LET r_success = FALSE
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:chk_pmdm_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      CALL aapp910_set_errmsg(p_ld,l_docno,'')
   END FOREACH
  
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_exec_item" cite_std="N" status="u" ver="1" src="s" new="Y" order="8" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 月結項目
# Usage..........: CALL aapp910_exec_item()
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_exec_item()
DEFINE l_cnt      LIKE type_t.num5
DEFINE r_success  LIKE type_t.num5
   LET l_cnt = 0
   SELECT count(*) INTO l_cnt
     FROM xref_t
    WHERE xrefent = g_enterprise    AND xrefcomp = g_input.glaacomp
      AND xrefld  = g_input.xrefld  AND xref001  = g_input.xref001
      AND xref002 = g_input.xref002 AND xref003  = 'AP'
   #寫入月結主檔
   IF l_cnt = 0 THEN
      CALL s_transaction_begin()
      INSERT INTO xref_t(xrefent,xrefcomp,xrefld,xref001,xref002,xref003)
             VALUES (g_enterprise,g_input.glaacomp,g_input.xrefld,g_input.xref001,g_input.xref002,'AP')
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            CALL s_transaction_end('N','0')
            CALL cl_err("xref_t","std-00009",1)
            RETURN FALSE
         WHEN SQLCA.sqlcode         #其他錯誤
            CALL s_transaction_end('N','0')
            CALL cl_err("xref_t",SQLCA.sqlcode,1)  
            RETURN FALSE
      END CASE
      CALL s_transaction_end('Y','0')
   END IF
   
   LET r_success = TRUE
   IF g_input.settle1 ='Y' THEN  #科目月結作業
      CALL s_transaction_begin()
      CALL aapp910_exec_monthly_acct(g_input.xrefld,g_input.strdate,g_input.enddate) RETURNING r_success
      IF NOT r_success THEN
         CALL s_transaction_end('N','0')
         RETURN r_success
      END IF
      CALL s_transaction_end('Y','0')
   END IF
   IF g_input.settle2 ='Y' THEN  #匯率重評價
      #cre_temp_table(推算
      DROP TABLE apcc_tmp
      CREATE TEMP TABLE apcc_tmp(
         apccdocno LIKE apcc_t.apccdocno,
         apccseq   LIKE apcc_t.apccseq,
         apcc001   LIKE apcc_t.apcc001,
         apcc100   LIKE apcc_t.apcc100,
         apcc108   LIKE apcc_t.apcc108,
         apcc118   LIKE apcc_t.apcc118,
         apcc128   LIKE apcc_t.apcc128,
         apcc138   LIKE apcc_t.apcc138,
         apcc109   LIKE apcc_t.apcc109,
         apcc119   LIKE apcc_t.apcc119,
         apcc129   LIKE apcc_t.apcc129,
         apcc139   LIKE apcc_t.apcc139
      )
      CALL s_transaction_begin()
      CALL aapp910_exec_exchange_rate(g_input.xrefld,g_input.strdate,g_input.enddate,g_input.xref001,g_input.xref002) RETURNING r_success
      IF NOT r_success THEN
         CALL s_transaction_end('N','0')
         RETURN r_success
      END IF
      CALL s_transaction_end('Y','0')
   END IF
   IF g_input.settle3 ='Y' THEN  #暫估月結統計
      CALL s_transaction_begin()
      CALL aapp910_exec_monthly_estimation(g_input.xrefld,g_input.strdate,g_input.enddate,g_input.xref001,g_input.xref002) RETURNING r_success
      IF NOT r_success THEN
         CALL s_transaction_end('N','0')
         RETURN r_success
      END IF
      CALL s_transaction_end('Y','0')
   END IF
      
END FUNCTION]]>
</point>
  <point name="function.aapp910_exec_monthly_acct" cite_std="N" status="u" ver="1" src="s" new="Y" order="9" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 科目月結
# Usage..........: CALL aapp910_exec_monthly_acct(p_ld,p_strdt,p_enddt)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_exec_monthly_acct(p_ld,p_strdt,p_enddt)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE l_sql      STRING
DEFINE l_xrea     RECORD
         xreaent  LIKE xrea_t.xreaent,
         xreacomp LIKE xrea_t.xreacomp,
         xreald   LIKE xrea_t.xreald,
         xrea001  LIKE xrea_t.xrea001,
         xrea002  LIKE xrea_t.xrea002,
         xrea003  LIKE xrea_t.xrea003,
         xrea004  LIKE xrea_t.xrea004,
         xrea005  LIKE xrea_t.xrea005,
         xrea006  LIKE xrea_t.xrea006,
         xrea007  LIKE xrea_t.xrea007,
         xrea008  LIKE xrea_t.xrea008
              END RECORD
DEFINE l_xrea_d   RECORD
         xrea009  LIKE xrea_t.xrea009,
         xrea010  LIKE xrea_t.xrea010,
         xrea011  LIKE xrea_t.xrea011,
         xrea012  LIKE xrea_t.xrea012,
         xrea013  LIKE xrea_t.xrea013,
         xrea014  LIKE xrea_t.xrea014,
         xrea015  LIKE xrea_t.xrea015,
         xrea016  LIKE xrea_t.xrea016
              END RECORD
DEFINE l_xrea_c   RECORD
         xrea009  LIKE xrea_t.xrea009,
         xrea010  LIKE xrea_t.xrea010,
         xrea011  LIKE xrea_t.xrea011,
         xrea012  LIKE xrea_t.xrea012,
         xrea013  LIKE xrea_t.xrea013,
         xrea014  LIKE xrea_t.xrea014,
         xrea015  LIKE xrea_t.xrea015,
         xrea016  LIKE xrea_t.xrea016
              END RECORD
DEFINE l_ar       RECORD
         apcadocdt LIKE apca_t.apcadocdt,
         apca001  LIKE apca_t.apca001,
         apcb021  LIKE apcb_t.apcb021,
         apcb029  LIKE apcb_t.apcb029,
         apcb022  LIKE apcb_t.apcb022,
         apce015  LIKE apce_t.apce015,
         apcb103  LIKE apcb_t.apcb103,
         apcb105  LIKE apcb_t.apcb105,
         apcb113  LIKE apcb_t.apcb113,
         apcb115  LIKE apcb_t.apcb115,
         apcb123  LIKE apcb_t.apcb123,
         apcb125  LIKE apcb_t.apcb125,
         apcb133  LIKE apcb_t.apcb133,
         apcb135  LIKE apcb_t.apcb135
              END RECORD
DEFINE l_debit    LIKE type_t.num5  #借方
DEFINE l_credit   LIKE type_t.num5  #貸方
DEFINE r_success  LIKE type_t.num5
   
   LET r_success = TRUE
   
#>>1.立帳(apca)
   LET l_sql = " SELECT apcaent,apcacomp,apcald,'AP',",
               "        apca004,apca057,apca100,apca015,",
               "        apca001,apcadocdt,apcb021,apcb029,apcb022,",
               "        apcb103,apcb105,apcb113,apcb115,",
               "        apcb123,apcb125,apcb133,apcb135 ",
               "   FROM apca_t,apcb_t",
               "  WHERE apcaent = apcbent AND apcaent = ?",
               "    AND apcald  = apcbld  AND apcald  = ?",
               "    AND apcadocno = apcbdocno",
               "    AND apcadocdt BETWEEN ? AND ? "
   PREPARE exec_monthly_pre FROM l_sql
   DECLARE exec_monthly_cur CURSOR FOR exec_monthly_pre
   FOREACH exec_monthly_cur USING g_enterprise,p_ld,p_strdt,p_enddt
      INTO l_xrea.xreaent,l_xrea.xreacomp,l_xrea.xreald ,l_xrea.xrea003,
           l_xrea.xrea005,l_xrea.xrea006 ,l_xrea.xrea007,l_xrea.xrea008,
           l_ar.apca001  ,l_ar.apcadocdt ,l_ar.apcb021  ,l_ar.apcb029  ,l_ar.apcb022,
           l_ar.apcb103  ,l_ar.apcb105   ,l_ar.apcb113  ,l_ar.apcb115,
           l_ar.apcb123  ,l_ar.apcb125   ,l_ar.apcb133  ,l_ar.apcb135
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_monthly_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      LET l_xrea.xrea001 =  YEAR(l_ar.apcadocdt)
      LET l_xrea.xrea002 = MONTH(l_ar.apcadocdt)

      #處理應付科目(debit)
      IF l_ar.apca001 = '01' OR l_ar.apca001[1,1] = '1' THEN
         LET l_debit  =  1
         LET l_credit = -1
      ELSE
         LET l_debit  = -1
         LET l_credit =  1
      END IF
      
      INITIALIZE l_xrea_d.* TO NULL
      LET l_xrea.xrea004   = l_ar.apcb029
      LET l_xrea_d.xrea009 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb103)
      LET l_xrea_d.xrea011 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb113)
      LET l_xrea_d.xrea013 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb123)
      LET l_xrea_d.xrea015 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb133)

      LET l_xrea_d.xrea010 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb103)
      LET l_xrea_d.xrea012 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb113)
      LET l_xrea_d.xrea014 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb123) 
      LET l_xrea_d.xrea016 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb133)
      INSERT INTO xrea_t VALUES(l_xrea.*,l_xrea_d.*)  #會計科目:應付
      
      #處理費用科目(credit)
      LET l_debit  = l_debit * -1
      LET l_credit = l_credit* -1
      
      INITIALIZE l_xrea_c.* TO NULL
      LET l_xrea.xrea004   = l_ar.apcb021
      LET l_xrea_c.xrea009 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb105)
      LET l_xrea_c.xrea011 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb115)
      LET l_xrea_c.xrea013 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb125)
      LET l_xrea_c.xrea015 = aapp910_get_value_apcb(l_ar.apcb022,l_debit ,l_ar.apcb135)
                                                                                  
      LET l_xrea_c.xrea010 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb105)
      LET l_xrea_c.xrea012 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb115)
      LET l_xrea_c.xrea014 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb125) 
      LET l_xrea_c.xrea016 = aapp910_get_value_apcb(l_ar.apcb022,l_credit,l_ar.apcb135)
      INSERT INTO xrea_t VALUES(l_xrea.*,l_xrea_c.*)  #會計科目:費用
   END FOREACH
   
#>>2.稅額(xrcd)
   LET l_sql = " SELECT apcaent,apcacomp,apcald,'AP',",
               "        apca004,apca057,apca100,apca015,",
               "        apca001,apcadocdt,xrcd009,",
               "        xrcd104,xrcd114,xrcd124,xrcd134 ",
               "   FROM apca_t,xrcd_t",
               "  WHERE apcaent = xrcdent AND apcaent =?",
               "    AND apcald  = xrcdld  AND apcald  =?",
               "    AND apcadocno = xrcddocno",
               "    AND apcadocdt BETWEEN ? AND ? "
   PREPARE exec_monthly_xrcd_pre FROM l_sql
   DECLARE exec_monthly_xrcd_cur CURSOR FOR exec_monthly_xrcd_pre
   FOREACH exec_monthly_xrcd_cur USING g_enterprise,p_ld,p_strdt,p_enddt
      INTO l_xrea.xreaent,l_xrea.xreacomp,l_xrea.xreald,l_xrea.xrea003,
           l_xrea.xrea005,l_xrea.xrea006,l_xrea.xrea007,l_xrea.xrea008,
           l_ar.apca001  ,l_ar.apcadocdt,l_xrea.xrea004,
           l_ar.apcb103  ,l_ar.apcb113  ,l_ar.apcb123  ,l_ar.apcb133
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_monthly_xrcd_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      LET l_xrea.xrea001 =  YEAR(l_ar.apcadocdt)
      LET l_xrea.xrea002 = MONTH(l_ar.apcadocdt)
      
      INITIALIZE l_xrea_d.* TO NULL      
      LET l_xrea_d.xrea009 = aapp910_get_value_xrcd('D',l_ar.apca001,l_ar.apcb103)
      LET l_xrea_d.xrea011 = aapp910_get_value_xrcd('D',l_ar.apca001,l_ar.apcb113)
      LET l_xrea_d.xrea013 = aapp910_get_value_xrcd('D',l_ar.apca001,l_ar.apcb123)
      LET l_xrea_d.xrea015 = aapp910_get_value_xrcd('D',l_ar.apca001,l_ar.apcb133)
                                                        
      LET l_xrea_d.xrea010 = aapp910_get_value_xrcd('C',l_ar.apca001,l_ar.apcb103)
      LET l_xrea_d.xrea012 = aapp910_get_value_xrcd('C',l_ar.apca001,l_ar.apcb113)
      LET l_xrea_d.xrea014 = aapp910_get_value_xrcd('C',l_ar.apca001,l_ar.apcb123) 
      LET l_xrea_d.xrea016 = aapp910_get_value_xrcd('C',l_ar.apca001,l_ar.apcb133)
      INSERT INTO xrea_t VALUES(l_xrea.*,l_xrea_d.*)  #會計科目:稅額
   END FOREACH   
   
#>>3.付款沖帳(apda)
   LET l_sql = " SELECT apdaent,apdacomp,apdald,'AP',",
               "        apda004,apda006,apce100,apce018,",
               "        apdadocdt,apce016,apce015",
               "        apce109,apce119,apce129,apce139 ",
               "   FROM apda_t,apce_t",
               "  WHERE apdaent = apceent AND apdaent =?",
               "    AND apdald  = apceld  AND apdald  =?",
               "    AND apdadocno = apcedocno",
               "    AND apdadocdt BETWEEN ? AND ? "
   PREPARE exec_monthly_apce1_pre FROM l_sql
   DECLARE exec_monthly_apce1_cur CURSOR FOR exec_monthly_apce1_pre
   FOREACH exec_monthly_apce1_cur USING g_enterprise,p_ld,p_strdt,p_enddt
      INTO l_xrea.xreaent,l_xrea.xreacomp,l_xrea.xreald,l_xrea.xrea003,
           l_xrea.xrea005,l_xrea.xrea006,l_xrea.xrea007,l_xrea.xrea008,
           l_ar.apcadocdt,l_xrea.xrea004,l_ar.apce015   ,
           l_ar.apcb103  ,l_ar.apcb113  ,l_ar.apcb123  ,l_ar.apcb133
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_monthly_apce1_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      LET l_xrea.xrea001 =  YEAR(l_ar.apcadocdt)
      LET l_xrea.xrea002 = MONTH(l_ar.apcadocdt)
      
      INITIALIZE l_xrea_d.* TO NULL      
      LET l_xrea_d.xrea009 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb103)
      LET l_xrea_d.xrea011 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb113)
      LET l_xrea_d.xrea013 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb123)
      LET l_xrea_d.xrea015 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb133)
                                               
      LET l_xrea_d.xrea010 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb103)
      LET l_xrea_d.xrea012 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb113)
      LET l_xrea_d.xrea014 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb123) 
      LET l_xrea_d.xrea016 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb133)
      INSERT INTO xrea_t VALUES(l_xrea.*,l_xrea_d.*)  #會計科目:付款沖帳
   END FOREACH  
#>>4.直接沖帳(apca>apce)
   LET l_sql = " SELECT apcaent,apcacomp,apcald,'AP',",
               "        apca004,apca006,apce100,apce018,",
               "        apcadocdt,apce016,apce015",
               "        apce109,apce119,apce129,apce139 ",
               "   FROM apca_t,apce_t",
               "  WHERE apcaent = apceent AND apcaent =?",
               "    AND apcald  = apceld  AND apcald  =?",
               "    AND apcadocno = apcedocno",
               "    AND apcadocdt BETWEEN ? AND ? "
   PREPARE exec_monthly_apce2_pre FROM l_sql
   DECLARE exec_monthly_apce2_cur CURSOR FOR exec_monthly_apce2_pre
   FOREACH exec_monthly_apce2_cur USING g_enterprise,p_ld,p_strdt,p_enddt
      INTO l_xrea.xreaent,l_xrea.xreacomp,l_xrea.xreald,l_xrea.xrea003,
           l_xrea.xrea005,l_xrea.xrea006,l_xrea.xrea007,l_xrea.xrea008,
           l_ar.apcadocdt,l_xrea.xrea004,l_ar.apce015   ,
           l_ar.apcb103  ,l_ar.apcb113  ,l_ar.apcb123  ,l_ar.apcb133
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_monthly_apce2_pre',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      LET l_xrea.xrea001 =  YEAR(l_ar.apcadocdt)
      LET l_xrea.xrea002 = MONTH(l_ar.apcadocdt)
      
      INITIALIZE l_xrea_d.* TO NULL      
      LET l_xrea_d.xrea009 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb103)
      LET l_xrea_d.xrea011 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb113)
      LET l_xrea_d.xrea013 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb123)
      LET l_xrea_d.xrea015 = aapp910_get_value_apce('D',l_ar.apce015,l_ar.apcb133)
                                               
      LET l_xrea_d.xrea010 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb103)
      LET l_xrea_d.xrea012 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb113)
      LET l_xrea_d.xrea014 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb123) 
      LET l_xrea_d.xrea016 = aapp910_get_value_apce('C',l_ar.apce015,l_ar.apcb133)
      INSERT INTO xrea_t VALUES(l_xrea.*,l_xrea_d.*)  #會計科目:直接沖帳
   END FOREACH  
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_get_value_apcb" cite_std="N" status="" ver="1" src="s" new="Y" order="10" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 取得apcb105
# Usage..........: CALL aapp910_get_value_apcb(p_apcb022,p_dc,p_apcb105)
#                  RETURNING r_value
# Return code....: r_value   欄位值
# Date & Author..: 14/06/16 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_get_value_apcb(p_apcb022,p_dc,p_apcb105)
DEFINE p_apcb022  LIKE apcb_t.apcb022
DEFINE p_dc       LIKE type_t.num5
DEFINE p_apcb105  LIKE apcb_t.apcb105
DEFINE r_value    LIKE apcb_t.apcb105
   
   WHENEVER ERROR CONTINUE
   LET r_value = 0
   
   IF p_apcb022 = p_dc THEN
      LET r_value = p_apcb105
   END IF
   
   RETURN r_value
END FUNCTION]]>
</point>
  <point name="function.aapp910_get_value_xrcd" cite_std="N" status="" ver="1" src="s" new="Y" order="11" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 取得xrcd104
# Usage..........: CALL aapp910_get_value_xrcd(p_dc,p_apca001,p_xrcd104)
#                  RETURNING r_value
# Date & Author..: 14/06/16 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_get_value_xrcd(p_dc,p_apca001,p_xrcd104)
DEFINE p_dc       LIKE type_t.chr1
DEFINE p_apca001  LIKE apca_t.apca001
DEFINE p_xrcd104  LIKE xrcd_t.xrcd104
DEFINE r_value    LIKE apcb_t.apcb105
   
   WHENEVER ERROR CONTINUE
   LET r_value = 0
   
   CASE p_dc
        WHEN 'D'  #借方
            IF p_apca001 = '01' OR p_apca001[1,1] = '1' THEN
               LET r_value = p_xrcd104
            END IF
        WHEN 'C'  #貸方 
            IF p_apca001 <>'01' OR p_apca001[1,1] <>'1' THEN
               LET r_value = p_xrcd104
            END IF
   END CASE
   
   RETURN r_value
   
END FUNCTION]]>
</point>
  <point name="function.aapp910_get_value_apce" cite_std="N" status="" ver="1" src="s" new="Y" order="12" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 取得APCE的值
# Usage..........: CALL aapp910_get_value_apce(p_dc,p_apce015,p_apce109)
#                  RETURNING r_value
# Date & Author..: 14/06/17 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_get_value_apce(p_dc,p_apce015,p_apce109)
DEFINE p_dc       LIKE type_t.chr1
DEFINE p_apce015  LIKE apce_t.apce015
DEFINE p_apce109  LIKE apce_t.apce109
DEFINE r_value    LIKE apce_t.apce109
   
   WHENEVER ERROR CONTINUE
   LET r_value = 0
   # dedit金額:decode(apce015,'D',apce1x9)
   #credit金額:decode(apce015,'C',apce1x9)
   
   IF p_dc = p_apce015 THEN
      LET r_value = p_apce109
   END IF
   
   RETURN r_value
   
END FUNCTION]]>
</point>
  <point name="function.aapp910_exec_exchange_rate" cite_std="N" status="u" ver="1" src="s" new="Y" order="13" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 匯率重評價
# Usage..........: CALL aapp910_exec_exchange_rate(p_ld,p_strdt,p_enddt,p_yy,p_mm)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_exec_exchange_rate(p_ld,p_strdt,p_enddt,p_yy,p_mm)
DEFINE p_ld           LIKE glaa_t.glaald
DEFINE p_strdt        LIKE type_t.dat
DEFINE p_enddt        LIKE type_t.dat
DEFINE r_success      LIKE type_t.num5
DEFINE l_cnt          LIKE type_t.num5
DEFINE p_yy           LIKE xref_t.xref001
DEFINE p_mm           LIKE xref_t.xref002
DEFINE l_apce         RECORD
         apce003      LIKE apce_t.apce003,
         apce004      LIKE apce_t.apce004,
         apce005      LIKE apce_t.apce005,
         apce109      LIKE apce_t.apce109,
         apce119      LIKE apce_t.apce119,
         apce129      LIKE apce_t.apce129,
         apce139      LIKE apce_t.apce139
                  END RECORD
DEFINE l_apcc         RECORD
         apccdocno    LIKE apcc_t.apccdocno,
         apccseq      LIKE apcc_t.apccseq,
         apcc001      LIKE apcc_t.apcc001,
         apcc100      LIKE apcc_t.apcc100,
         apcc108      LIKE apcc_t.apcc108,
         apcc118      LIKE apcc_t.apcc118,
         apcc128      LIKE apcc_t.apcc128,
         apcc138      LIKE apcc_t.apcc138
                  END RECORD
DEFINE l_xreb         RECORD LIKE xreb_t.*
DEFINE l_apca007      LIKE apca_t.apca007
DEFINE l_apcb104      LIKE apcb_t.apcb104
DEFINE l_apcb114      LIKE apcb_t.apcb114
DEFINE l_apcb124      LIKE apcb_t.apcb124
DEFINE l_apcb134      LIKE apcb_t.apcb134
DEFINE l_apcf104      LIKE apcf_t.apcf104
DEFINE l_apcf114      LIKE apcf_t.apcf114
DEFINE l_apcf124      LIKE apcf_t.apcf124
DEFINE l_apcf134      LIKE apcf_t.apcf134
DEFINE l_glca002      LIKE glca_t.glca002
DEFINE l_glca004      LIKE glca_t.glca004
DEFINE l_glca005      LIKE glca_t.glca005
DEFINE l_xreb115_pre  LIKE xreb_t.xreb115
DEFINE l_xreb125_pre  LIKE xreb_t.xreb125
DEFINE l_xreb135_pre  LIKE xreb_t.xreb135
DEFINE l_success      LIKE type_t.num5
DEFINE l_sql          STRING
   LET r_success = TRUE

#>>1.處理資料範圍
   #抓apcadocdt < p_enddt / apcc108-apcc109 > 0
   LET l_sql = " INSERT INTO apcc_tmp (apccdocno,apccseq,apcc001,apcc100, ",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139)",
               "                SELECT apccdocno,apccseq,apcc001,apcc100,",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139",
               "                  FROM apca_t,apcc_t",
               "                 WHERE apcaent = apccent AND apcald = apccld AND apcadocno = apccdocno ",
               "                   AND apcaent = ?       AND apcald = ?      AND apcadocdt <= ? ",
               "                   AND (apcc108-apcc109 ) > 0"
   PREPARE exec_ins_tmp_pre FROM l_sql
   EXECUTE exec_ins_tmp_pre USING g_enterprise,p_ld,p_enddt
   
   LET l_sql = " INSERT INTO apcc_tmp (apccdocno,apccseq,apcc001,apcc100 ",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139)",
               "                SELECT apccdocno,apccseq,apcc001,apcc100,",
               "                       apcc108,apcc118,apcc128,apcc138,",
               "                       apcc109,apcc119,apcc129,apcc139",
               "                  FROM apcc_t",
               "                 WHERE apccent = ? AND apccld = ? AND apccdocno = ? ",
               "                   AND apcc001 = ? AND apccseq= ? "
   PREPARE exec_ins_tmp1_pre FROM l_sql
   EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,p_enddt
   
   #由於apcc109是現行最新的金額 若為5月的帳 執行月結可能會是6月初,因此要將6月的apcc109扣除
   #處理付款沖帳
   LET l_sql = " SELECT apce003,apce004,apce005,apce109,apce119,apce129,apce139 ",
               "   FROM apda_t,apce_t ",
               "  WHERE apdaent = apceent   AND apdald = apceld AND apdadocno = apcedocno ",
               "    AND apce003 IS NOT NULL AND apdaent = ?     AND apdald = ? ",
               "    AND apdadocdt > ? "
   PREPARE exec_rate_apce1_pre FROM l_sql
   DECLARE exec_rate_apce1_cur CURSOR FOR exec_rate_apce1_pre
   FOREACH exec_rate_apce1_cur USING g_enterprise,p_ld,p_enddt INTO l_apce.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_rate_apce1_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      IF l_apce.apce005 = 0 THEN #apce005 若為0表示不管特別沖到哪一期
      
        # SELECT count(1) INTO l_cnt FROM apcc_tmp
        #  WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.apce004
        #    AND apcc001   = l_apce.apce005
        # IF l_cnt = 0 THEN
        #    EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.apce004,l_apce.apce005
        # END IF
         
      ELSE
         LET l_cnt = 0
         SELECT count(1) INTO l_cnt FROM apcc_tmp
          WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.apce004
            AND apcc001   = l_apce.apce005
         IF l_cnt = 0 THEN
            EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.apce004,l_apce.apce005
         END IF
         UPDATE apcc_tmp
            SET apcc109 = apcc109 -l_apce.apce109,
                apcc119 = apcc119 -l_apce.apce119,
                apcc129 = apcc129 -l_apce.apce129,
                apcc139 = apcc139 -l_apce.apce139
          WHERE apccdocno = l_apce.apce003 AND apccseq = apce004
            AND apcc001   = l_apce.apce005
      END IF
   END FOREACH
   #處理直接沖帳
   LET l_sql = " SELECT apce003,apce004,apce005,apce109,apce119,apce129,apce139 ",
               "   FROM apca_t,apce_t ",
               "  WHERE apcaent = apceent   AND apcald = apceld AND apcadocno = apcedocno ",
               "    AND apce003 IS NOT NULL AND apcaent = ?     AND apcald = ? ",
               "    AND apcadocdt > ? "
   PREPARE exec_rate_apce2_pre FROM l_sql
   DECLARE exec_rate_apce2_cur CURSOR FOR exec_rate_apce2_pre
   FOREACH exec_rate_apce2_cur USING g_enterprise,p_ld,p_enddt INTO l_apce.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_rate_apce1_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      IF l_apce.apce005 = 0 THEN #apce005 若為0表示不管特別沖到哪一期
      
        # SELECT count(1) INTO l_cnt FROM apcc_tmp
        #  WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.apce004
        #    AND apcc001   = l_apce.apce005
        # IF l_cnt = 0 THEN
        #    EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.apce004,l_apce.apce005
        # END IF
         
      ELSE
         LET l_cnt = 0
         SELECT count(1) INTO l_cnt FROM apcc_tmp
          WHERE apccdocno = l_apce.apce003 AND apccseq = l_apce.apce004
            AND apcc001   = l_apce.apce005
         IF l_cnt = 0 THEN
            EXECUTE exec_ins_tmp1_pre USING g_enterprise,p_ld,l_apce.apce003,l_apce.apce004,l_apce.apce005
         END IF
         UPDATE apcc_tmp
            SET apcc109 = apcc109 -l_apce.apce109,
                apcc119 = apcc119 -l_apce.apce119,
                apcc129 = apcc129 -l_apce.apce129,
                apcc139 = apcc139 -l_apce.apce139
          WHERE apccdocno = l_apce.apce003 AND apccseq = apce004
            AND apcc001   = l_apce.apce005
      END IF
   END FOREACH
#>>2.寫入xreb
   #取得agli171設定
   SELECT glca002,glca004,glca005 INTO l_glca002,l_glca004,l_glca005
     FROM glca_t
    WHERE glcaent = g_enterprise AND glcald = p_ld AND glca001 = 'AP'
   IF cl_null(l_glca004) THEN LET l_glca004 = 'N' END IF
   IF cl_null(l_glca005) THEN LET l_glca005 = 'N' END IF
   
   LET l_sql = "SELECT apcacomp,apca001,apcadocdt,apca004,apcblegl,",
               "       apcb010,apcb011,apcb012,apca014,apca059,",
               "       apcb015,apcb016,apcb029,apcb021,apcb104,",
               "       apcb114,apcb124,apcb134,apca007",
               "  FROM apca_t,apcb_t",
               " WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno",
               "   AND apcbent = ? AND apcbld = ? AND apcbdocno = ? AND apcbseq = ?"
   PREPARE exec_rate_get_apcb_pre FROM l_sql
   
   LET l_sql = "SELECT apcf104,apcf114,apcf124,apcf134 ",
               "  FROM apcf_t ",
               " WHERE apcf008 = ? AND apcf009 = ? AND apcf010 = ?"
   PREPARE exec_rate_get_apcf_pre FROM l_sql
   
   LET l_sql = "SELECT apccdocno,apccseq,apcc001,apcc100, ",
               "       apcc108-apcc109,apcc118-apcc119,apcc128-apcc129,apcc138-apcc139",
               "  FROM apcc_tmp",
               " ORDER BY apccdocno,apccseq,apcc001"
   PREPARE exec_rate_ins_xreb_pre FROM l_sql
   DECLARE exec_rate_ins_xreb_cur CURSOR FOR exec_rate_ins_xreb_pre
   FOREACH exec_rate_ins_xreb_cur INTO l_apcc.apccdocno,l_apcc.apccseq,l_apcc.apcc001,l_apcc.apcc100,
                                       l_apcc.apcc108  ,l_apcc.apcc118,l_apcc.apcc128,l_apcc.apcc138

      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_rate_ins_xreb_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      INITIALIZE l_xreb.* TO NULL
      LET l_xreb.xrebent = g_enterprise
      LET l_xreb.xrebld  = p_ld
      LET l_xreb.xreb001 = p_yy
      LET l_xreb.xreb002 = p_mm
      LET l_xreb.xreb003 = 'AP'
      LET l_xreb.xreb005 = l_apcc.apccdocno
      LET l_xreb.xreb006 = l_apcc.apccseq
      LET l_xreb.xreb007 = l_apcc.apcc001
      LET l_xreb.xreb013 = ''
      LET l_xreb.xreb014 = ''
      LET l_xreb.xreb100 = l_apcc.apcc100
      LET l_xreb.xreb103 = l_apcc.apcc108
      LET l_xreb.xreb113 = l_apcc.apcc118
      LET l_xreb.xreb123 = l_apcc.apcc128
      LET l_xreb.xreb133 = l_apcc.apcc138
      
               
      EXECUTE exec_rate_get_apcb_pre USING g_enterprise,p_ld,l_xreb.xreb005,l_xreb.xreb006
         INTO l_xreb.xrebcomp,l_xreb.xreb004,l_xreb.xreb008,l_xreb.xreb009,l_xreb.xreb010,
              l_xreb.xreb011,l_xreb.xreb012,l_xreb.xreb015,l_xreb.xreb014,l_xreb.xreb017,
              l_xreb.xreb018,l_xreb.xreb019,l_xreb.xreb020,l_xreb.xreb022,l_apcb104,
              l_apcb114,l_apcb124,l_apcb134,l_apca007
      
      CALL s_fin_get_account(p_ld,'13',l_apca007,'8304_27')       RETURNING l_success,l_xreb.xreb023,g_errno
      CALL s_fin_get_exchange_rate(p_ld,p_yy,p_mm,l_xreb.xreb100) RETURNING l_xreb.xreb101,l_xreb.xreb121,l_xreb.xreb131
      
      EXECUTE exec_rate_get_apcf_pre USING l_xreb.xreb005,l_xreb.xreb006,l_xreb.xreb002
         INTO l_apcf104,l_apcf114,l_apcf124,l_apcf134
      IF cl_null(l_apcb104) THEN LET l_apcb104 = 0 END IF
      IF cl_null(l_apcb114) THEN LET l_apcb114 = 0 END IF
      IF cl_null(l_apcb124) THEN LET l_apcb124 = 0 END IF
      IF cl_null(l_apcb134) THEN LET l_apcb134 = 0 END IF
      IF cl_null(l_apcf104) THEN LET l_apcf104 = 0 END IF
      IF cl_null(l_apcf114) THEN LET l_apcf114 = 0 END IF
      IF cl_null(l_apcf124) THEN LET l_apcf124 = 0 END IF
      IF cl_null(l_apcf134) THEN LET l_apcf134 = 0 END IF   
   #  LET l_xreb.xreb107 = l_apcb104 - l_apcf104
   #  LET l_xreb.xreb117 = l_apcb114 - l_apcf114
   #  LET l_xreb.xreb127 = l_apcb124 - l_apcf124
   #  LET l_xreb.xreb137 = l_apcb134 - l_apcf134
      
      IF l_xreb.xreb004  MATCHES '[1]' THEN LET l_xreb.xreb021 = 'Y'       END IF
      IF l_xreb.xreb004  MATCHES '[2]' THEN LET l_xreb.xreb021 = l_glca004 END IF
      IF l_xreb.xreb004  MATCHES '[0]' THEN LET l_xreb.xreb021 = l_glca005 END IF
      
      LET l_xreb.xreb114 = l_xreb.xreb103 * l_xreb.xreb101
      LET l_xreb.xreb124 = l_xreb.xreb123 * l_xreb.xreb121
      LET l_xreb.xreb134 = l_xreb.xreb133 * l_xreb.xreb131
      
      IF l_xreb.xreb021 = 'N' THEN
         LET l_xreb.xreb115 = 0
         LET l_xreb.xreb125 = 0
         LET l_xreb.xreb135 = 0
      ELSE
         LET l_xreb.xreb115 = l_xreb.xreb113 - l_xreb.xreb114
         LET l_xreb.xreb125 = l_xreb.xreb123 - l_xreb.xreb124
         LET l_xreb.xreb135 = l_xreb.xreb133 - l_xreb.xreb134
      END IF
      IF l_glca002 = '1' THEN
         SELECT xreb115,xreb125,xreb135
           INTO l_xreb115_pre,l_xreb125_pre,l_xreb135_pre
           FROM xreb_t
          WHERE xrebent = g_enterprise   AND xrebld = p_ld
            AND xreb001 = l_xreb.xreb001 AND xreb002 = l_xreb.xreb002 
            AND xreb005 = l_xreb.xreb005 AND xreb006 = l_xreb.xreb006
            AND xreb007 = l_xreb.xreb007
         IF cl_null(l_xreb115_pre) THEN LET l_xreb115_pre = 0 END IF
         IF cl_null(l_xreb125_pre) THEN LET l_xreb125_pre = 0 END IF
         IF cl_null(l_xreb135_pre) THEN LET l_xreb135_pre = 0 END IF
         LET l_xreb.xreb116 = l_xreb.xreb115 - l_xreb115_pre
         LET l_xreb.xreb126 = l_xreb.xreb125 - l_xreb125_pre
         LET l_xreb.xreb136 = l_xreb.xreb135 - l_xreb135_pre
      ELSE
         LET l_xreb.xreb116 = l_xreb.xreb115
         LET l_xreb.xreb126 = l_xreb.xreb125
         LET l_xreb.xreb136 = l_xreb.xreb135
      END IF
   END FOREACH
  
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_exec_monthly_estimation" cite_std="N" status="u" ver="1" src="s" new="Y" order="14" mark_hard="N">
<![CDATA[
################################################################################
# Descriptions...: 暫估月結統計作業
# Usage..........: CALL aapp910_exec_monthly_estimation(p_ld,p_strdt,p_enddt,p_yy,p_mm)
#                  RETURNING r_success
# Date & Author..: 14/06/13 By Belle
# Modify.........:
################################################################################
PRIVATE FUNCTION aapp910_exec_monthly_estimation(p_ld,p_strdt,p_enddt,p_yy,p_mm)
DEFINE p_ld       LIKE glaa_t.glaald
DEFINE p_strdt    LIKE type_t.dat
DEFINE p_enddt    LIKE type_t.dat
DEFINE p_yy       LIKE xrec_t.xrec001
DEFINE p_mm       LIKE xrec_t.xrec002
DEFINE l_sql      STRING
DEFINE l_ar       RECORD
         apcaent  LIKE apca_t.apcaent,
         apcald   LIKE apca_t.apcald,
         apca004  LIKE apca_t.apca004,
         apcb004  LIKE apcb_t.apcb004,
         apcb006  LIKE apcb_t.apcb006,
         apcb100  LIKE apcb_t.apcb100,
         apcb007  LIKE apcb_t.apcb007,
         apcb103  LIKE apcb_t.apcb103,
         apcb113  LIKE apcb_t.apcb113
              END RECORD
DEFINE l_xreb     RECORD LIKE xreb_t.*
DEFINE r_success  LIKE type_t.num5

   #先新增 再依條件把資料UPDATE進去
   LET r_success = TRUE
   LET l_sql = " INSERT INTO xrec_t (xrecent,xreccomp,xrecld, ",
               "                     xrec001,xrec002,xrec003,xrec004,xrec005,",
               "                     xrec006,xrec012,xrec100",
               "                     xrec007,xrec008,xrec009,xrec010,xrec011,",
               "                     xrec103,xrec104,xrec105,xrec113,xrec114,xrec115) ",
               "     SELECT DISTINCT apcaent,apcacomp,apcald,",
               "                           ?,      ?,   'AP',    '1',apca004,",
               "                     apcb004,apcb006,apcb100",
               "                           0,      0,      0,      0,      0,",
               "                           0,      0,      0,      0,      0,      0",
               "       FROM apca_t,apcb_t",
               "      WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "        AND apcaent = ?       AND apcald = ? ",
               "        AND ( (apca001 = '01' OR apca001 = '02')  OR apcb023 = 'Y') ",
               "        AND apcadocdt BETWEEN ? AND ?"
   PREPARE exec_estimation_pre FROM l_sql
   EXECUTE exec_estimation_pre USING p_yy,p_mm,g_enterprise,p_ld,p_strdt,p_enddt
     
   #UPDATE (SELECT apcb007,apcb113
   #          FROM apca_t,apcb_t
   #         WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno
   #           AND apcaent = 99 AND apcald ='02'
   #           AND apca001 = '13' )
   #   SET apcb113 = apcb007+apcb113
   
#>>1.本期暫估數量
   LET l_sql = " UPDATE xrec_t SET (xrec007,xrec103,xrec113) = (?,?,?) ",
               "  WHERE xrecent = ? AND xrecld  = ? ",
               "    AND xrec001 = ? AND xrec002 = ? AND xrec003 = 'AP' AND xrec004 = '1' AND xrec005 = ? ",
               "    AND xrec006 = ? AND xrec012 = ? AND xrec100 = ?"          
   PREPARE exec_upd_xrec007_pre FROM l_sql       
   
   LET l_sql = " SELECT apcaent,apcald,apca004, apcb004,apcb006,apcb100,",
               "        SUM(apcb007),SUM(apcb103),SUM(apcb113)",
               "   FROM apca_t,apcb_t",
               "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "    AND apcaent = ?       AND apcald = ? ",
               "    AND apcadocdt BETWEEN ? AND ? ",
               "    AND apca001 = '01'    AND apcb001 = 'apmt570'",
               "  GROUP BY apcaent,apcald,apca004, apcb004,apcb006,apcb100"
               
   PREPARE exec_sum_xrec007_pre FROM l_sql
   DECLARE exec_sum_xrec007_cur CURSOR FOR exec_sum_xrec007_pre
   FOREACH exec_sum_xrec007_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_ar.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_sum_xrec007_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
         
      EXECUTE exec_upd_xrec007_pre
        USING l_ar.apcb007,l_ar.apcb103,l_ar.apcb113,
              l_ar.apcaent,l_ar.apcald ,
                      p_yy,        p_mm,l_ar.apca004,
              l_ar.apcb004,l_ar.apcb006,l_ar.apcb100
      #update失敗要有錯誤訊息
      
   END FOREACH
   
#>>2.本期暫估銷退數量
   LET l_sql = " UPDATE xrec_t SET (xrec008,xrec104,xrec114) = (?,?,?) ",
               "  WHERE xrecent = ? AND xrecld  = ? ",
               "    AND xrec001 = ? AND xrec002 = ? AND xrec003 = 'AP' AND xrec004 = '1' AND xrec005 = ? ",
               "    AND xrec006 = ? AND xrec012 = ? AND xrec100 = ?"          
   PREPARE exec_upd_xrec008_pre FROM l_sql       
   
   LET l_sql = " SELECT apcaent,apcald,apca004, apcb004,apcb006,apcb100,",
               "        SUM(apcb007),SUM(apcb103),SUM(apcb113)",
               "   FROM apca_t,apcb_t",
               "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "    AND apcaent = ?       AND apcald = ? ",
               "    AND apcadocdt BETWEEN ? AND ? ",
               "    AND apca001 = '02'    AND (apcb001 = 'apmt560' OR apcb001 = 'apmt580')",
               "  GROUP BY apcaent,apcald,apca004, apcb004,apcb006,apcb100"
   PREPARE exec_sum_xrec008_pre FROM l_sql
   DECLARE exec_sum_xrec008_cur CURSOR FOR exec_sum_xrec008_pre
   FOREACH exec_sum_xrec008_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_ar.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_sum_xrec008_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
         
      EXECUTE exec_upd_xrec008_pre
        USING l_ar.apcb007,l_ar.apcb103,l_ar.apcb113,
              l_ar.apcaent,l_ar.apcald ,
                      p_yy,        p_mm,l_ar.apca004,
              l_ar.apcb004,l_ar.apcb006,l_ar.apcb100
      #update失敗要有錯誤訊息
      
   END FOREACH

#>>3.本期沖暫估銷退數量
   LET l_sql = " UPDATE xrec_t SET (xrec009,xrec105,xrec115) = (?,?,?) ",
               "  WHERE xrecent = ? AND xrecld  = ? ",
               "    AND xrec001 = ? AND xrec002 = ? AND xrec003 = 'AP' AND xrec004 = '1' AND xrec005 = ? ",
               "    AND xrec006 = ? AND xrec012 = ? AND xrec100 = ?"          
   PREPARE exec_upd_xrec009_pre FROM l_sql       
   
   LET l_sql = " SELECT apcaent,apcald,apca004, apcb004,apcb006,apcb100,",
               "        SUM(apcb007),SUM(apcb103),SUM(apcb113)",
               "   FROM apca_t,apcb_t",
               "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "    AND apcaent = ?       AND apcald = ? ",
               "    AND apcadocdt BETWEEN ? AND ? ",
               "    AND apcab023='Y'      AND apcb001 = 'apmt570'",
               "  GROUP BY apcaent,apcald,apca004, apcb004,apcb006,apcb100"
   PREPARE exec_sum_xrec009_pre FROM l_sql
   DECLARE exec_sum_xrec009_cur CURSOR FOR exec_sum_xrec009_pre
   FOREACH exec_sum_xrec009_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_ar.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_sum_xrec009_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
         
      EXECUTE exec_upd_xrec009_pre
        USING l_ar.apcb007,l_ar.apcb103,l_ar.apcb113,
              l_ar.apcaent,l_ar.apcald ,
                      p_yy,        p_mm,l_ar.apca004,
              l_ar.apcb004,l_ar.apcb006,l_ar.apcb100
      #update失敗要有錯誤訊息
      
   END FOREACH

#>>4.本期沖暫估銷退數量
   LET l_sql = " UPDATE xrec_t SET (xrec010,xrec106,xrec116) = (?,?,?) ",
               "  WHERE xrecent = ? AND xrecld  = ? ",
               "    AND xrec001 = ? AND xrec002 = ? AND xrec003 = 'AP' AND xrec004 = '1' AND xrec005 = ? ",
               "    AND xrec006 = ? AND xrec012 = ? AND xrec100 = ?"          
   PREPARE exec_upd_xrec010_pre FROM l_sql       
   
   LET l_sql = " SELECT apcaent,apcald,apca004, apcb004,apcb006,apcb100,",
               "        SUM(apcb007),SUM(apcb103),SUM(apcb113)",
               "   FROM apca_t,apcb_t",
               "  WHERE apcaent = apcbent AND apcald = apcbld AND apcadocno = apcbdocno ",
               "    AND apcaent = ?       AND apcald = ? ",
               "    AND apcadocdt BETWEEN ? AND ? ",
               "    AND apcab023='Y'      AND (apcb001 = 'apmt560' OR apcb001 = 'apmt580')",
               "  GROUP BY apcaent,apcald,apca004, apcb004,apcb006,apcb100"
   PREPARE exec_sum_xrec010_pre FROM l_sql
   DECLARE exec_sum_xrec010_cur CURSOR FOR exec_sum_xrec010_pre
   FOREACH exec_sum_xrec010_cur USING g_enterprise,p_ld,p_strdt,p_enddt INTO l_ar.*
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         CALL cl_err('foreach:exec_sum_xrec010_cur',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
         
      EXECUTE exec_upd_xrec010_pre
        USING l_ar.apcb007,l_ar.apcb103,l_ar.apcb113,
              l_ar.apcaent,l_ar.apcald ,
                      p_yy,        p_mm,l_ar.apca004,
              l_ar.apcb004,l_ar.apcb006,l_ar.apcb100

      #update失敗要有錯誤訊息
      
   END FOREACH
   
   RETURN r_success
END FUNCTION]]>
</point>
  <point name="function.aapp910_set_errmsg" cite_std="N" status="u" ver="1" src="s" new="Y" order="15" mark_hard="N">
<![CDATA[################################################################################
# Descriptions...: 錯誤訊息格式設定
# Usage..........: CALL aapp910_set_errmsg(p_ld,p_docno,p_errcode)
# Date & Author..: 14/06/16 By Belle
################################################################################
PRIVATE FUNCTION aapp910_set_errmsg(p_ld,p_docno,p_errcode)
DEFINE p_ld       LIKE apca_t.apcald
DEFINE p_docno    LIKE apca_t.apcadocno
DEFINE p_errcode  LIKE gzze_t.gzze001
DEFINE l_source   LIKE oobx_t.oobx004
DEFINE l_slip     LIKE ooba_t.ooba002
DEFINE l_success  LIKE type_t.num5

   CALL s_aooi200_get_slip(p_docno)   RETURNING l_success,l_slip
   CALL s_fin_get_oobx004('',p_ld,l_slip) RETURNING l_source
   
END FUNCTION]]>
</point>
  <point name="global.import" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[]]>
</point>
  <point name="global.variable" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[GLOBALS "../../cfg/top_finance.inc"    #財務模組使用
TYPE type_g_input    RECORD
       xrefld        LIKE xref_t.xrefld,
       xrefld_desc   LIKE type_t.chr80,
       glaacomp      LIKE glaa_t.glaacomp,
       glaacomp_desc LIKE type_t.chr80,
       xref001       LIKE xref_t.xref001,
       xref002       LIKE xref_t.xref002,
       strdate       LIKE type_t.chr80,
       enddate       LIKE type_t.chr80,
       settle1       LIKE type_t.chr1,
       settle2       LIKE type_t.chr1,
       settle3       LIKE type_t.chr1,
       chk1          LIKE type_t.chr1,
       chk2          LIKE type_t.chr1,
       chk3          LIKE type_t.chr1,
       chk4          LIKE type_t.chr1
                 END RECORD
DEFINE g_input       type_g_input         #INPUT條件
DEFINE g_glaa003     LIKE glaa_t.glaa003  #會計週期參照表
DEFINE g_glaa013     LIKE glaa_t.glaa013  #最後關帳日
DEFINE g_type        LIKE type_t.chr1     #帳別類型 主帳/輔帳]]>
</point>
  <point name="init.define" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   DEFINE l_array DYNAMIC ARRAY OF RECORD
                  value       STRING,
                  label_tag   STRING,
                  label       STRING
              END RECORD
   DEFINE i       LIKE type_t.num5]]>
</point>
  <point name="init.init" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   CALL l_array.clear()
   FOR i = 2014 TO 2100
      CALL l_array.appendElement()
      LET l_array[l_array.getLength()].value = i
     #LET l_array[l_array.getLength()].label_tag = i
      LET l_array[l_array.getLength()].label = i
   END FOR
   CALL cl_set_combo_detail('xref001',l_array)     #年度
   CALL l_array.clear()
   FOR i = 1 TO 12
      LET l_array[i].value = i
     #LET l_array[i].label_tag = i
      LET l_array[i].label = i
   END FOR
   CALL cl_set_combo_detail('xref002',l_array)     #期別
   CALL l_array.clear()]]>
</point>
  <point name="process.define" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   DEFINE l_success   LIKE type_t.num5]]>
</point>
  <point name="process.pre_process" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[               
   #檢核
   CALL aapp910_chk_item() RETURNING l_success
   IF NOT l_success THEN
      RETURN
   END IF]]>
</point>
  <point name="process.process" cite_std="N" status="u" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   #檢核完成後 才進行月結
   IF l_success THEN
      CALL aapp910_exec_item()
   END IF]]>
</point>
  <point name="ui_dialog.before_dialog" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   #預設值
   CLEAR FORM
   INITIALIZE g_input.* TO NULL
   
   LET g_input.settle1 = 'Y'
   LET g_input.settle2 = 'Y'
   LET g_input.settle3 = 'Y'
   LET g_input.chk1 = 'Y'
   LET g_input.chk2 = 'Y'
   LET g_input.chk3 = 'Y'
   LET g_input.chk4 = 'Y'

   CALL s_fin_ld_carry('',g_user) RETURNING g_success,g_input.xrefld,g_input.glaacomp,g_errno   
   CALL s_fin_ld_chk(g_input.xrefld,g_user)  RETURNING g_success,g_errno
   IF NOT g_success THEN
      LET g_input.xrefld   = ''
      LET g_input.glaacomp = ''
   ELSE
      CALL aapp910_set_ld_info(g_input.xrefld)
   END IF
   DISPLAY BY NAME g_input.settle1,g_input.settle2,g_input.settle3,
                   g_input.chk1,g_input.chk2,g_input.chk3,g_input.chk4]]>
</point>
  <point name="ui_dialog.define" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[   DEFINE l_success LIKE type_t.num5]]>
</point>
  <point name="ui_dialog.more_input" cite_std="N" status="" ver="1" src="s" new="N" order="" mark_hard="N">
<![CDATA[         #INPUT區段
         INPUT g_input.xrefld,g_input.xref001,g_input.xref002,
               g_input.settle1,g_input.settle2,g_input.settle3,
               g_input.chk1,g_input.chk2,g_input.chk3,g_input.chk4
          FROM xrefld,xref001,xref002,
               settle1,settle2,settle3,
               chk1,chk2,chk3,chk4
               ATTRIBUTE(WITHOUT DEFAULTS)
            
            AFTER FIELD xrefld
               IF NOT cl_null(g_input.xrefld) THEN
                  CALL s_fin_ld_chk(g_input.xrefld,g_user)  RETURNING g_success,g_errno
                  IF NOT g_success THEN
                     CALL cl_err("",g_errno,1)
                     LET g_input.xrefld   = ''
                     LET g_input.glaacomp = ''
                  ELSE
                     CALL aapp910_set_ld_info(g_input.xrefld)
                  END IF
               END IF
               
            AFTER FIELD xref001
               IF NOT cl_null(g_input.xref001) THEN
                  IF NOT cl_null(g_input.strdate) AND g_input.strdate < g_glaa013 THEN
                     CALL cl_err(g_input.strdate,"agl-00163",1)
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_input.enddate) AND g_input.enddate < g_glaa013 THEN
                     CALL cl_err(g_input.enddate,"agl-00163",1)
                     NEXT FIELD CURRENT
                  END IF
               END IF
               
            AFTER FIELD xref002
               IF NOT cl_null(g_input.xref002) THEN
                  IF NOT cl_null(g_input.strdate) AND g_input.strdate < g_glaa013 THEN
                     CALL cl_err(g_input.strdate,"agl-00163",1)
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_input.enddate) AND g_input.enddate < g_glaa013 THEN
                     CALL cl_err(g_input.enddate,"agl-00163",1)
                     NEXT FIELD CURRENT
                  END IF
               END IF
               
            ON CHANGE xref001
               IF NOT cl_null(g_input.xref001) THEN
                  CALL aapp910_get_date()
               END IF
            
            ON CHANGE xref002
               IF NOT cl_null(g_input.xref002) THEN
                  CALL aapp910_get_date()
               END IF
            
            ON ACTION controlp INFIELD xrefld
		       	INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
		       	LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_input.xrefld                    #給予default值
               LET g_qryparam.arg1 = g_user                                #人員權限
               LET g_qryparam.arg2 = g_dept                                #部門權限
               CALL q_authorised_ld()                                      #呼叫開窗
               LET g_input.xrefld = g_qryparam.return1                     #將開窗取得的值回傳到變數
               CALL aapp910_set_ld_info(g_input.xrefld)
               NEXT FIELD xrefld                                           #返回原欄位
            
            AFTER INPUT
               #月結選項至少要擇一
               IF NOT g_input.settle1 = 'Y' AND NOT g_input.settle2 = 'Y' AND NOT g_input.settle3 = 'Y' THEN
                  CALL cl_err("","aap-00093",1)
                  CONTINUE DIALOG
               END IF
               
         END INPUT]]>
</point>
  <point name="global.memo" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.parameter" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="global.argv" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.background" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.servicecall" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.before_close" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="main.exit" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.more_construct" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.more_displayarray" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.qbe_select" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.qbeclear" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="ui_dialog.more_action" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="process.exit_dialog" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="transfer.argv.define" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="process.count_progress" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="process.foreground_finish" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <point name="process.background_finish" cite_std="N" status="" ver="" src="s" new="Y">
<![CDATA[]]>
</point>
  <section id="aapp910.description" ver="1" status="" src="s">
<![CDATA[#+ Version..: T100-ERP-1.00.00(SD版次:1,PD版次:1) Build-000059
#+ 
#+ Filename...: aapp910
#+ Description: 應付帳款期末作業
#+ Creator....: 02097(2014/06/12)
#+ Modifier...: 02097(2014/06/13)
#+ Buildtype..: 應用 p01 樣板自動產生
#+ 以上段落由子樣板a00產生
]]>
</section>
  <section id="aapp910.global" ver="1" status="" src="s">
<![CDATA[{<point name="global.memo" />}
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_schedule
#add-point:增加匯入項目
{<point name="global.import" />}
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
GLOBALS "../../cfg/top_schedule.inc"
GLOBALS
   DEFINE gwin_curr2  ui.Window
   DEFINE gfrm_curr2  ui.Form
   DEFINE gi_hiden_asign       LIKE type_t.num5
   DEFINE gi_hiden_exec        LIKE type_t.num5
   DEFINE gi_hiden_spec        LIKE type_t.num5
   DEFINE gi_hiden_exec_end    LIKE type_t.num5
END GLOBALS
 
PRIVATE TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   {<point name="global.parameter"/>}
   #end add-point
        wc               STRING
                     END RECORD
 
DEFINE g_sql             STRING        #組 sql 用
DEFINE g_forupd_sql      STRING        #SELECT ... FOR UPDATE  SQL
DEFINE g_error_show      LIKE type_t.num5
DEFINE g_jobid           STRING
 
#add-point:自定義模組變數(Module Variable)
{<point name="global.variable"/>}
#end add-point
 
#add-point:傳入參數說明
{<point name="global.argv"/>}
#end add-point
]]>
</section>
  <section id="aapp910.init" ver="1" status="" src="s">
<![CDATA[#+ 初始化作業
PRIVATE FUNCTION aapp910_init()
   #add-point:init段define
   {<point name="init.define"/>}
   #end add-point
 
   LET g_error_show = 1
   LET gwin_curr2 = ui.Window.getCurrent()
   LET gfrm_curr2 = gwin_curr2.getForm()
   CALL cl_schedule_import_4fd()
   CALL cl_set_combo_scc("gzpa003","75")
   IF cl_get_para(g_enterprise,"","E-SYS-0005") = "N" THEN
       CALL cl_set_comp_visible("scheduling_page,history_page",FALSE)
   END IF 
   #add-point:畫面資料初始化
   {<point name="init.init" />}
   #end add-point
   
END FUNCTION
]]>
</section>
  <section id="aapp910.main" ver="1" status="" src="s">
<![CDATA[MAIN
   DEFINE ls_js    STRING
   DEFINE lc_param type_parameter  
   #add-point:main段define
   {<point name="main.define"/>}
   #end add-point 
  
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("aap","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
   {<point name="main.background"/>}
   #end add-point
 
   IF g_bgjob = "Y" THEN
      #add-point:Service Call
      {<point name="main.servicecall" />}
      #end add-point
      CALL aapp910_process(ls_js)
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_aapp910 WITH FORM cl_ap_formpath("aap",g_code)
 
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
 
      #程式初始化
      CALL aapp910_init()
 
      #進入選單 Menu (="N")
      CALL aapp910_ui_dialog()
 
      #add-point:畫面關閉前
      {<point name="main.before_close" />}
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_aapp910
   END IF
 
   #add-point:作業離開前
   {<point name="main.exit" />}
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
]]>
</section>
  <section id="aapp910.other_function" ver="1" status="" src="s">
<![CDATA[#add-point:自定義元件(Function)
{<point name="other.function"/>}
#end add-point
]]>
</section>
  <section id="aapp910.process" ver="1" status="" src="s">
<![CDATA[#+ 資料處理
PRIVATE FUNCTION aapp910_process(ls_js)
   DEFINE ls_js       STRING
   DEFINE lc_param    type_parameter
   DEFINE li_stus     LIKE type_t.num5
   DEFINE li_count    LIKE type_t.num10  #progressbar計量
   DEFINE ls_sql      STRING             #主SQL
   #add-point:process段define
   {<point name="process.define"/>}
   #end add-point
 
   CALL util.JSON.parse(ls_js,lc_param)
 
   #add-point:process段前處理
   {<point name="process.pre_process"/>}
   #end add-point
 
   #預先計算progressbar迴圈次數
   IF g_bgjob <> "Y" THEN
      #add-point:process段count_progress
      {<point name="process.count_progress"/>}
      #end add-point
   END IF
 
   #主SQL及相關FOREACH前置處理
#  DECLARE aapp910_process_cs CURSOR FROM ls_sql
#  FOREACH aapp910_process_cs INTO
   #add-point:process段process
   {<point name="process.process"/>}
   #end add-point
#  END FOREACH
 
   IF g_bgjob = "N" THEN
      #前景作業完成處理
      #add-point:process段foreground完成處理
      {<point name="process.foreground_finish"/>}
      #end add-point
      CALL cl_ask_confirm("std-00012") RETURNING li_stus
   ELSE
      #背景作業完成處理
      #add-point:process段background完成處理
      {<point name="process.background_finish"/>}
      #end add-point
   END IF
END FUNCTION
]]>
</section>
  <section id="aapp910.transfer_argv" ver="1" status="" src="s">
<![CDATA[#+ 轉換本地參數至cmdrun參數內,準備進入背景執行
PRIVATE FUNCTION aapp910_transfer_argv(ls_js)
   DEFINE ls_js       STRING
   DEFINE la_cmdrun   RECORD
             prog     STRING,
             param    DYNAMIC ARRAY OF STRING
                  END RECORD
   DEFINE la_param    type_parameter
 
   CALL util.JSON.parse(ls_js,la_param)
 
   LET la_cmdrun.prog = g_prog
   #add-point:transfer.argv段define
   {<point name="transfer.argv.define"/>}
   #end add-point
 
   RETURN util.JSON.stringify( la_cmdrun )
END FUNCTION
]]>
</section>
  <section id="aapp910.ui_dialog" ver="3" status="" src="s">
<![CDATA[#+ 選單功能實際執行處
PRIVATE FUNCTION aapp910_ui_dialog()
   DEFINE li_exit  LIKE type_t.num5    #判別是否為離開作業
   DEFINE li_idx   LIKE type_t.num5
   DEFINE ls_js    STRING
   DEFINE ls_wc    STRING
   DEFINE lc_param type_parameter
   #add-point:ui_dialog段define
   {<point name="ui_dialog.define"/>}
   #end add-point
 
   #add-point:ui_dialog段before dialog
   {<point name="ui_dialog.before_dialog"/>}
   #end add-point
 
   WHILE TRUE
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #add-point:ui_dialog段construct
         {<point name="ui_dialog.more_construct"/>}
         #end add-point
         #add-point:ui_dialog段input
         {<point name="ui_dialog.more_input"/>}
         #end add-point
         #add-point:ui_dialog段自定義display array
         {<point name="ui_dialog.more_displayarray"/>}
         #end add-point
 
         SUBDIALOG lib_cl_schedule.cl_schedule_setting
         SUBDIALOG lib_cl_schedule.cl_schedule_setting_exec_call
         SUBDIALOG lib_cl_schedule.cl_schedule_select_show_history
         SUBDIALOG lib_cl_schedule.cl_schedule_show_history
 
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               LET lc_param.wc = ls_wc
               #取得條件後需要執行項目,應新增於下方adp
               #add-point:ui_dialog段qbe_select後
               {<point name="ui_dialog.qbe_select"/>}
               #end add-point
            END IF
 
         ON ACTION qbe_save
            CALL cl_qbe_save()
 
         ON ACTION batch_execute
            ACCEPT DIALOG
 
         ON ACTION qbeclear         
            CLEAR FORM
            INITIALIZE lc_param.* TO NULL
            #add-point:ui_dialog段qbeclear
            {<point name="ui_dialog.qbeclear"/>}
            #end add-point
 
         ON ACTION history_fill
            CALL cl_schedule_history_fill()
 
         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT DIALOG
         
         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT DIALOG
 
         #add-point:ui_dialog段action
         {<point name="ui_dialog.more_action"/>}
         #end add-point
 
         #主選單用ACTION
         &include "main_menu.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      #add-point:ui_dialog段exit dialog
      {<point name="process.exit_dialog"/>}
      #end add-point
 
      LET ls_js = util.JSON.stringify(lc_param)
 
      IF INT_FLAG THEN
         LET INT_FLAG = FALSE
         EXIT WHILE
      ELSE
         LET g_jobid = cl_schedule_get_jobid(g_prog)
         CASE 
            WHEN g_schedule.gzpa003 = "0"
                 CALL aapp910_process(ls_js)
            WHEN g_schedule.gzpa003 = "1"
                 CALL cl_schedule_update_data(g_jobid)
                 LET ls_js = aapp910_transfer_argv(ls_js)
                 CALL cl_cmdrun(ls_js)
            WHEN g_schedule.gzpa003 = "2"
                 CALL cl_schedule_update_data(g_jobid)
            WHEN g_schedule.gzpa003 = "3"
                 CALL cl_schedule_update_data(g_jobid)
         END CASE    
         LET g_schedule.gzpa003 = "0" #預設一開始 立即於前景執行
         INITIALIZE lc_param.*  TO NULL 
         #欄位初始資訊 
         CALL cl_schedule_init_info("all",g_schedule.gzpa003) 
         LET gi_hiden_asign = FALSE 
         LET gi_hiden_exec = FALSE 
         LET gi_hiden_spec = FALSE 
         LET gi_hiden_exec_end = FALSE 
         CALL cl_schedule_hidden()
      END IF
   END WHILE
 
END FUNCTION
]]>
</section>
</add_points>