#該程式未解開Section, 採用最新樣板產出!
{<section id="aist330.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0006(2016-05-05 14:22:33), PR版次:0006(2016-11-01 15:50:15)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000034
#+ Filename...: aist330
#+ Description: 換開發票作業
#+ Creator....: 03080(2015-06-08 15:36:50)
#+ Modifier...: 03080 -SD/PR- 08171
 
{</section>}
 
{<section id="aist330.global" >}
#應用 t01 樣板自動產生(Version:76)
#add-point:填寫註解說明
#150401-00001#13  150717  By RayHuang statechange段問題修正
#151020-00003#3   160106  By sakura  增加發票最終狀態isat025欄位處理(不顯示在畫面上)
#160216           160216  By albireo 開放發票歷程未稅金額輸入
#160318-00025#40  160422  By pengxin 將重複內容的錯誤訊息置換為公用錯誤訊息(r.v)
#160106-00005#4   160505  By albireo 若發票明細沒有發票號則不產生發票歷程檔,由發票列印產生 
#160818-00017#19  16-08-22 By 08742  删除修改未重新判断状态码
#161006-00005#15  161017  By 08732   組織類型與職能開窗調整
#161017-00005#1   161026  By 08171   法人權限調整
#161005-00003#2   161101  By 08171   新舊值調整
#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"

#end add-point 
 
SCHEMA ds 
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:增加匯入變數檔 name="global.inc"

#end add-point
 
#單頭 type 宣告
PRIVATE type type_g_isbf_m        RECORD
       isbfsite LIKE isbf_t.isbfsite, 
   isbfsite_desc LIKE type_t.chr80, 
   isbfcomp LIKE isbf_t.isbfcomp, 
   isbfcomp_desc LIKE type_t.chr80, 
   isbf001 LIKE isbf_t.isbf001, 
   isbf001_desc LIKE type_t.chr80, 
   isbfdocno LIKE isbf_t.isbfdocno, 
   isbfdocdt LIKE isbf_t.isbfdocdt, 
   isbf002 LIKE isbf_t.isbf002, 
   isbf003 LIKE isbf_t.isbf003, 
   isbf004 LIKE isbf_t.isbf004, 
   isbf005 LIKE isbf_t.isbf005, 
   isbfstus LIKE isbf_t.isbfstus, 
   isbfownid LIKE isbf_t.isbfownid, 
   isbfownid_desc LIKE type_t.chr80, 
   isbfowndp LIKE isbf_t.isbfowndp, 
   isbfowndp_desc LIKE type_t.chr80, 
   isbfcrtid LIKE isbf_t.isbfcrtid, 
   isbfcrtid_desc LIKE type_t.chr80, 
   isbfcrtdp LIKE isbf_t.isbfcrtdp, 
   isbfcrtdp_desc LIKE type_t.chr80, 
   isbfcrtdt LIKE isbf_t.isbfcrtdt, 
   isbfmodid LIKE isbf_t.isbfmodid, 
   isbfmodid_desc LIKE type_t.chr80, 
   isbfmoddt LIKE isbf_t.isbfmoddt, 
   isbfcnfid LIKE isbf_t.isbfcnfid, 
   isbfcnfid_desc LIKE type_t.chr80, 
   isbfcnfdt LIKE isbf_t.isbfcnfdt
       END RECORD
 
#單身 type 宣告
PRIVATE TYPE type_g_isbg_d        RECORD
       isbgseq LIKE isbg_t.isbgseq, 
   isbg001 LIKE isbg_t.isbg001, 
   isbg002 LIKE isbg_t.isbg002, 
   l_isat001 LIKE type_t.chr100, 
   l_isat005 LIKE type_t.chr100, 
   l_isat113 LIKE type_t.num20_6, 
   l_isat023 LIKE type_t.num20_6, 
   l_isat114 LIKE type_t.num20_6, 
   l_isat115 LIKE type_t.num20_6, 
   l_isat007 LIKE type_t.dat, 
   l_isat010 LIKE type_t.chr20, 
   isbg003 LIKE isbg_t.isbg003, 
   isbg004 LIKE isbg_t.isbg004, 
   l_isafdocdt LIKE type_t.dat
       END RECORD
PRIVATE TYPE type_g_isbg2_d RECORD
       isahseq LIKE isah_t.isahseq, 
   isahorga LIKE isah_t.isahorga, 
   isahorga_desc LIKE type_t.chr500, 
   isah003 LIKE isah_t.isah003, 
   isah004 LIKE isah_t.isah004, 
   isah013 LIKE isah_t.isah013, 
   isah005 LIKE isah_t.isah005, 
   isah006 LIKE isah_t.isah006, 
   isah101 LIKE isah_t.isah101, 
   isah103 LIKE isah_t.isah103, 
   isah007 LIKE isah_t.isah007, 
   isah104 LIKE isah_t.isah104, 
   isah105 LIKE isah_t.isah105, 
   isah011 LIKE isah_t.isah011, 
   isah001 LIKE isah_t.isah001, 
   isah002 LIKE isah_t.isah002, 
   isah008 LIKE isah_t.isah008, 
   isah009 LIKE isah_t.isah009, 
   isah010 LIKE isah_t.isah010, 
   isah012 LIKE isah_t.isah012, 
   isah106 LIKE isah_t.isah106, 
   isah113 LIKE isah_t.isah113, 
   isah114 LIKE isah_t.isah114, 
   isah115 LIKE isah_t.isah115, 
   isah116 LIKE isah_t.isah116
       END RECORD
PRIVATE TYPE type_g_isbg3_d RECORD
       isatseq LIKE isat_t.isatseq, 
   isatsite LIKE isat_t.isatsite, 
   isat003 LIKE isat_t.isat003, 
   isat004 LIKE isat_t.isat004, 
   isat006 LIKE isat_t.isat006, 
   isat005 LIKE isat_t.isat005, 
   isat022 LIKE isat_t.isat022, 
   isat113 LIKE isat_t.isat113, 
   isat114 LIKE isat_t.isat114, 
   isat115 LIKE isat_t.isat115, 
   isat103 LIKE isat_t.isat103, 
   isat104 LIKE isat_t.isat104, 
   isat105 LIKE isat_t.isat105, 
   isat007 LIKE isat_t.isat007, 
   isat014 LIKE isat_t.isat014, 
   isat025 LIKE isat_t.isat025, 
   isat106 LIKE isat_t.isat106, 
   isat107 LIKE isat_t.isat107, 
   isat017 LIKE isat_t.isat017, 
   isat001 LIKE isat_t.isat001, 
   isat002 LIKE isat_t.isat002, 
   isat008 DATETIME YEAR TO FRACTION(5), 
   isat009 LIKE isat_t.isat009, 
   isat010 LIKE isat_t.isat010, 
   isat011 LIKE isat_t.isat011, 
   isat012 LIKE isat_t.isat012, 
   isat013 LIKE isat_t.isat013, 
   isat015 LIKE isat_t.isat015, 
   isat016 LIKE isat_t.isat016, 
   isat018 LIKE isat_t.isat018, 
   isat019 LIKE isat_t.isat019, 
   isat020 LIKE isat_t.isat020, 
   isat021 LIKE isat_t.isat021, 
   isat023 LIKE isat_t.isat023, 
   isat024 LIKE isat_t.isat024, 
   isat100 LIKE isat_t.isat100, 
   isat101 LIKE isat_t.isat101, 
   isat201 LIKE isat_t.isat201, 
   isat202 LIKE isat_t.isat202, 
   isat203 LIKE isat_t.isat203, 
   isat204 LIKE isat_t.isat204, 
   isat205 LIKE isat_t.isat205, 
   isat206 LIKE isat_t.isat206, 
   isat207 LIKE isat_t.isat207, 
   isat208 LIKE isat_t.isat208, 
   isat209 LIKE isat_t.isat209, 
   isatdocdt LIKE isat_t.isatdocdt
       END RECORD
 
 
PRIVATE TYPE type_browser RECORD
         b_statepic     LIKE type_t.chr50,
            b_isbfcomp LIKE isbf_t.isbfcomp,
      b_isbfdocno LIKE isbf_t.isbfdocno
       END RECORD
       
#add-point:自定義模組變數(Module Variable) (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="global.variable"
DEFINE g_glaald    LIKE glaa_t.glaald
DEFINE g_wc_isbfsite STRING
DEFINE g_wc_ld       STRING
DEFINE g_wc_comp     STRING
DEFINE g_glaa                RECORD
                             glaacomp  LIKE glaa_t.glaacomp,
                             glaa001   LIKE glaa_t.glaa001,
                             glaa004   LIKE glaa_t.glaa004,
                             glaa015   LIKE glaa_t.glaa015,
                             glaa016   LIKE glaa_t.glaa016,
                             glaa017   LIKE glaa_t.glaa017,
                             glaa019   LIKE glaa_t.glaa019,
                             glaa020   LIKE glaa_t.glaa020,
                             glaa021   LIKE glaa_t.glaa021,
                             glaa024   LIKE glaa_t.glaa024,
                             glaa121   LIKE glaa_t.glaa121
                         END RECORD
DEFINE g_ooef019     LIKE ooef_t.ooef019
DEFINE g_isai        RECORD LIKE isai_t.*
DEFINE g_isat115     LIKE isat_t.isat115     #來源發票含稅總額
DEFINE g_wc_site     STRING #161017-00005#1
#end add-point
       
#模組變數(Module Variables)
DEFINE g_isbf_m          type_g_isbf_m
DEFINE g_isbf_m_t        type_g_isbf_m
DEFINE g_isbf_m_o        type_g_isbf_m
DEFINE g_isbf_m_mask_o   type_g_isbf_m #轉換遮罩前資料
DEFINE g_isbf_m_mask_n   type_g_isbf_m #轉換遮罩後資料
 
   DEFINE g_isbfcomp_t LIKE isbf_t.isbfcomp
DEFINE g_isbfdocno_t LIKE isbf_t.isbfdocno
 
 
DEFINE g_isbg_d          DYNAMIC ARRAY OF type_g_isbg_d
DEFINE g_isbg_d_t        type_g_isbg_d
DEFINE g_isbg_d_o        type_g_isbg_d
DEFINE g_isbg_d_mask_o   DYNAMIC ARRAY OF type_g_isbg_d #轉換遮罩前資料
DEFINE g_isbg_d_mask_n   DYNAMIC ARRAY OF type_g_isbg_d #轉換遮罩後資料
DEFINE g_isbg2_d          DYNAMIC ARRAY OF type_g_isbg2_d
DEFINE g_isbg2_d_t        type_g_isbg2_d
DEFINE g_isbg2_d_o        type_g_isbg2_d
DEFINE g_isbg2_d_mask_o   DYNAMIC ARRAY OF type_g_isbg2_d #轉換遮罩前資料
DEFINE g_isbg2_d_mask_n   DYNAMIC ARRAY OF type_g_isbg2_d #轉換遮罩後資料
DEFINE g_isbg3_d          DYNAMIC ARRAY OF type_g_isbg3_d
DEFINE g_isbg3_d_t        type_g_isbg3_d
DEFINE g_isbg3_d_o        type_g_isbg3_d
DEFINE g_isbg3_d_mask_o   DYNAMIC ARRAY OF type_g_isbg3_d #轉換遮罩前資料
DEFINE g_isbg3_d_mask_n   DYNAMIC ARRAY OF type_g_isbg3_d #轉換遮罩後資料
 
 
DEFINE g_browser         DYNAMIC ARRAY OF type_browser
DEFINE g_browser_f       DYNAMIC ARRAY OF type_browser
 
 
DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc2_table2   STRING
 
DEFINE g_wc2_table3   STRING
 
 
 
DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING
 
DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog
                                                               
DEFINE g_pagestart           LIKE type_t.num10                 
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)
DEFINE g_order               STRING                             #查詢排序欄位
                                                        
DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page
 
DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入
 
DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
#add-point:傳入參數說明(global.argv) name="global.argv"

#end add-point
 
{</section>}
 
{<section id="aist330.main" >}
#應用 a26 樣板自動產生(Version:7)
#+ 作業開始(主程式類型)
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
   
   #end add-point   
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"
   
   #end add-point   
   
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
       
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("ais","")
 
   #add-point:作業初始化 name="main.init"
   
   #end add-point
   
   
 
   #LOCK CURSOR (identifier)
   #add-point:SQL_define name="main.define_sql"
   
   #end add-point
   LET g_forupd_sql = " SELECT isbfsite,'',isbfcomp,'',isbf001,'',isbfdocno,isbfdocdt,isbf002,isbf003, 
       isbf004,isbf005,isbfstus,isbfownid,'',isbfowndp,'',isbfcrtid,'',isbfcrtdp,'',isbfcrtdt,isbfmodid, 
       '',isbfmoddt,isbfcnfid,'',isbfcnfdt", 
                      " FROM isbf_t",
                      " WHERE isbfent= ? AND isbfcomp=? AND isbfdocno=? FOR UPDATE"
   #add-point:SQL_define name="main.after_define_sql"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist330_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
 
   LET g_sql = " SELECT DISTINCT t0.isbfsite,t0.isbfcomp,t0.isbf001,t0.isbfdocno,t0.isbfdocdt,t0.isbf002, 
       t0.isbf003,t0.isbf004,t0.isbf005,t0.isbfstus,t0.isbfownid,t0.isbfowndp,t0.isbfcrtid,t0.isbfcrtdp, 
       t0.isbfcrtdt,t0.isbfmodid,t0.isbfmoddt,t0.isbfcnfid,t0.isbfcnfdt,t1.ooag011 ,t2.ooefl003 ,t3.ooag011 , 
       t4.ooefl003 ,t5.ooag011 ,t6.ooag011",
               " FROM isbf_t t0",
                              " LEFT JOIN ooag_t t1 ON t1.ooagent="||g_enterprise||" AND t1.ooag001=t0.isbfownid  ",
               " LEFT JOIN ooefl_t t2 ON t2.ooeflent="||g_enterprise||" AND t2.ooefl001=t0.isbfowndp AND t2.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t3 ON t3.ooagent="||g_enterprise||" AND t3.ooag001=t0.isbfcrtid  ",
               " LEFT JOIN ooefl_t t4 ON t4.ooeflent="||g_enterprise||" AND t4.ooefl001=t0.isbfcrtdp AND t4.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t5 ON t5.ooagent="||g_enterprise||" AND t5.ooag001=t0.isbfmodid  ",
               " LEFT JOIN ooag_t t6 ON t6.ooagent="||g_enterprise||" AND t6.ooag001=t0.isbfcnfid  ",
 
               " WHERE t0.isbfent = " ||g_enterprise|| " AND t0.isbfcomp = ? AND t0.isbfdocno = ?"
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define name="main.after_refresh_sql"
   
   #end add-point
   PREPARE aist330_master_referesh FROM g_sql
 
    
 
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_aist330 WITH FORM cl_ap_formpath("ais",g_code)
   
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
   
      #程式初始化
      CALL aist330_init()   
 
      #進入選單 Menu (="N")
      CALL aist330_ui_dialog() 
      
      #add-point:畫面關閉前 name="main.before_close"
      
      #end add-point
 
      #畫面關閉
      CLOSE WINDOW w_aist330
      
   END IF 
   
   CLOSE aist330_cl
   
   
 
   #add-point:作業離開前 name="main.exit"
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
 
 
 
{</section>}
 
{<section id="aist330.init" >}
#+ 瀏覽頁簽資料初始化
PRIVATE FUNCTION aist330_init()
   #add-point:init段define(客製用) name="init.define_customerization"
   
   #end add-point    
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"
   
   #end add-point
   
   LET g_bfill       = "Y"
   LET g_detail_idx  = 1 #第一層單身指標
   LET g_detail_idx2 = 1 #第二層單身指標
   
   #各個page指標
   LET g_detail_idx_list[1] = 1 
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
 
   LET g_error_show  = 1
   LET l_ac = 1 #單身指標
      CALL cl_set_combo_scc_part('isbfstus','13','N,Y')
 
   
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #page群組
   LET g_idx_group = om.SaxAttributes.create()
   CALL g_idx_group.addAttribute("'1',","1")
   CALL g_idx_group.addAttribute("'2',","1")
   CALL g_idx_group.addAttribute("'3',","1")
 
 
   #add-point:畫面資料初始化 name="init.init"
   CALL s_fin_create_account_center_tmp()                   #展組織下階成員所需之暫存檔 
   CALL cl_set_combo_scc('isbf003','9748')
   #CALL cl_set_combo_scc('isbf005','9734')
   CALL cl_set_combo_scc('isbg003','9716')
   CALL cl_set_combo_scc('isat014','9716')
   CALL cl_set_combo_scc('isat025','9716')   #151020-00003#3
   CALL cl_set_combo_scc('isat022','9708')
   #CALL cl_set_combo_scc('l_isat001','9734')
   
   #161006-00005#15   add-s
   CALL s_fin_azzi800_sons_query(g_today) #161017-00005#1
   CALL s_fin_account_center_comp_str() RETURNING g_wc_comp
   CALL s_fin_get_wc_str(g_wc_comp) RETURNING g_wc_comp
   CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
   CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
   #161006-00005#15   add-e
   #161017-00005#1--s  add
   CALL s_fin_account_center_sons_str() RETURNING g_wc_site
   CALL s_fin_get_wc_str(g_wc_site) RETURNING g_wc_site
   #161017-00005#1--e  add
   #end add-point
   
   #初始化搜尋條件
   CALL aist330_default_search()
    
END FUNCTION
 
{</section>}
 
{<section id="aist330.ui_dialog" >}
#+ 功能選單
PRIVATE FUNCTION aist330_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point
   DEFINE li_idx     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE lb_first   BOOLEAN
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE la_output  DYNAMIC ARRAY OF STRING   #報表元件鬆耦合使用
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"
   
   #end add-point
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   #因應查詢方案進行處理
   IF g_default THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   ELSE
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF
   
   #action default動作
   #應用 a42 樣板自動產生(Version:3)
   #進入程式時預設執行的動作
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL aist330_insert()
            #add-point:ON ACTION insert name="menu.default.insert"
            
            #END add-point
         END IF
 
      #add-point:action default自訂 name="ui_dialog.action_default"
      
      #end add-point
      OTHERWISE
   END CASE
 
 
 
   
   LET lb_first = TRUE
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"
   
   #end add-point
   
   WHILE TRUE 
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_isbf_m.* TO NULL
         CALL g_isbg_d.clear()
         CALL g_isbg2_d.clear()
         CALL g_isbg3_d.clear()
 
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL aist330_init()
      END IF
   
      CALL lib_cl_dlg.cl_dlg_before_display()
            
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
         #左側瀏覽頁簽
         DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)
            BEFORE ROW
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE
         
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF 
               
               CALL aist330_fetch('') # reload data
               LET l_ac = 1
               CALL aist330_ui_detailshow() #Setting the current row 
         
               CALL aist330_idx_chk()
               #NEXT FIELD isbgseq
         
               ON ACTION qbefield_user   #欄位隱藏設定 
                  LET g_action_choice="qbefield_user"
                  CALL cl_ui_qbefield_user()
         END DISPLAY
    
         DISPLAY ARRAY g_isbg_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist330_idx_chk()
               #確定當下選擇的筆數
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[1] = l_ac
               CALL g_idx_group.addAttribute("'1',",l_ac)
               
               #add-point:page1, before row動作 name="ui_dialog.page1.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_current_page = 1
               #顯示單身筆數
               CALL aist330_idx_chk()
               #add-point:page1自定義行為 name="ui_dialog.page1.before_display"
               
               #end add-point
               
            #自訂ACTION(detail_show,page_1)
            
               
            #add-point:page1自定義行為 name="ui_dialog.page1.action"
            
            #end add-point
               
         END DISPLAY
        
         #第一階單身段落
         DISPLAY ARRAY g_isbg2_d TO s_detail2.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist330_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[2] = l_ac
               CALL g_idx_group.addAttribute("'2',",l_ac)
               
               #add-point:page2, before row動作 name="ui_dialog.body2.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail2")
               LET g_current_page = 2
               #顯示單身筆數
               CALL aist330_idx_chk()
               #add-point:page2自定義行為 name="ui_dialog.body2.before_display"
               
               #end add-point
      
            #自訂ACTION(detail_show,page_2)
            
         
            #add-point:page2自定義行為 name="ui_dialog.body2.action"
            
            #end add-point
         
         END DISPLAY
         #第一階單身段落
         DISPLAY ARRAY g_isbg3_d TO s_detail3.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL aist330_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[3] = l_ac
               CALL g_idx_group.addAttribute("'3',",l_ac)
               
               #add-point:page3, before row動作 name="ui_dialog.body3.before_row"
               
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail3")
               LET g_current_page = 3
               #顯示單身筆數
               CALL aist330_idx_chk()
               #add-point:page3自定義行為 name="ui_dialog.body3.before_display"
               
               #end add-point
      
            #自訂ACTION(detail_show,page_3)
            
         
            #add-point:page3自定義行為 name="ui_dialog.body3.action"
            
            #end add-point
         
         END DISPLAY
 
         
 
         
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         
         #end add-point
         
         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
         SUBDIALOG lib_cl_dlg.cl_dlg_relateapps
      
         BEFORE DIALOG
            #先填充browser資料
            CALL aist330_browser_fill("")
            CALL cl_notice()
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               LET g_current_idx = g_current_row
            END IF
            
            #確保g_current_idx位於正常區間內
            #小於,等於0則指到第1筆
            IF g_current_idx <= 0 THEN
               LET g_current_idx = 1
            END IF
            #超過最大筆數則指到最後1筆
            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF 
            
            LET g_current_sw = TRUE
            LET g_current_row = g_current_idx #目前指標
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL aist330_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL aist330_ui_detailshow() #Setting the current row 
            
            #筆數顯示
            LET g_current_page = 1
            CALL aist330_idx_chk()
            CALL cl_ap_performance_cal()
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            
            #end add-point
 
         #add-point:ui_dialog段more_action name="ui_dialog.more_action"
         
         #end add-point
 
         #狀態碼切換
         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL aist330_statechange()
            #根據資料狀態切換action狀態
            CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
            CALL aist330_set_act_visible()   
            CALL aist330_set_act_no_visible()
            IF NOT (g_isbf_m.isbfcomp IS NULL
              OR g_isbf_m.isbfdocno IS NULL
 
              ) THEN
               #組合條件
               LET g_add_browse = " isbfent = " ||g_enterprise|| " AND",
                                  " isbfcomp = '", g_isbf_m.isbfcomp, "' "
                                  ," AND isbfdocno = '", g_isbf_m.isbfdocno, "' "
 
               #填到對應位置
               CALL aist330_browser_fill("")
            END IF
         
          
         #查詢方案選擇 
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "isbf_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isbg_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isah_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "isat_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
 
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               CALL aist330_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF
         
         #查詢方案選擇
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc2_table2 TO NULL
 
               INITIALIZE g_wc2_table3 TO NULL
 
 
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "isbf_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isbg_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "isah_t" 
                        LET g_wc2_table2 = la_wc[li_idx].wc
 
                     WHEN la_wc[li_idx].tableid = "isat_t" 
                        LET g_wc2_table3 = la_wc[li_idx].wc
 
 
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1)
                  OR NOT cl_null(g_wc2_table2)
 
                  OR NOT cl_null(g_wc2_table3)
 
 
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
                  END IF
 
                  IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
                  END IF
 
 
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL aist330_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "" 
                     LET g_errparam.code   = "-100" 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL aist330_fetch("F")
                  END IF
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()
          
         #應用 a49 樣板自動產生(Version:4)
            #過濾瀏覽頁資料
            ON ACTION filter
               LET g_action_choice = "fetch"
               #add-point:filter action name="ui_dialog.action.filter"
               
               #end add-point
               CALL aist330_filter()
               EXIT DIALOG
 
 
 
         
         ON ACTION first
            LET g_action_choice = "fetch"
            CALL aist330_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist330_idx_chk()
            
         ON ACTION previous
            LET g_action_choice = "fetch"
            CALL aist330_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist330_idx_chk()
            
         ON ACTION jump
            LET g_action_choice = "fetch"
            CALL aist330_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist330_idx_chk()
            
         ON ACTION next
            LET g_action_choice = "fetch"
            CALL aist330_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist330_idx_chk()
            
         ON ACTION last
            LET g_action_choice = "fetch"
            CALL aist330_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL aist330_idx_chk()
          
         #excel匯出功能          
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               #browser
               CALL g_export_node.clear()
               IF g_main_hidden = 1 THEN
                  LET g_export_node[1] = base.typeInfo.create(g_browser)
                  LET g_export_id[1]   = "s_browse"
                  CALL cl_export_to_excel()
               #非browser
               ELSE
                  LET g_export_node[1] = base.typeInfo.create(g_isbg_d)
                  LET g_export_id[1]   = "s_detail1"
                  LET g_export_node[2] = base.typeInfo.create(g_isbg2_d)
                  LET g_export_id[2]   = "s_detail2"
                  LET g_export_node[3] = base.typeInfo.create(g_isbg3_d)
                  LET g_export_id[3]   = "s_detail3"
 
                  #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
                  
                  #END add-point
                  CALL cl_export_to_excel_getpage()
                  CALL cl_export_to_excel()
               END IF
            END IF
        
         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
    
         #主頁摺疊
         ON ACTION mainhidden       
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
               CALL cl_notice()
            END IF
            
         #瀏覽頁折疊
         ON ACTION worksheethidden   
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF
            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD isbgseq
            END IF
       
         #單頭摺疊，可利用hot key "Alt-s"開啟/關閉單頭
         ON ACTION controls     
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF
    
         
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL aist330_modify()
               #add-point:ON ACTION modify name="menu.modify"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL aist330_modify()
               #add-point:ON ACTION modify_detail name="menu.modify_detail"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL aist330_delete()
               #add-point:ON ACTION delete name="menu.delete"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL aist330_insert()
               #add-point:ON ACTION insert name="menu.insert"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL aist330_reproduce()
               #add-point:ON ACTION reproduce name="menu.reproduce"
               
               #END add-point
               
            END IF
 
 
 
 
         #應用 a43 樣板自動產生(Version:4)
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL aist330_query()
               #add-point:ON ACTION query name="menu.query"
               
               #END add-point
               #應用 a59 樣板自動產生(Version:3)  
               CALL g_curr_diag.setCurrentRow("s_detail1",1)
               CALL g_curr_diag.setCurrentRow("s_detail2",1)
               CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
 
 
 
            END IF
 
 
 
 
         
         #應用 a46 樣板自動產生(Version:3)
         #新增相關文件
         ON ACTION related_document
            CALL aist330_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"
               
               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL aist330_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"
            
            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL aist330_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"
            
            #END add-point
            CALL cl_user_overview_follow(g_isbf_m.isbfdocdt)
 
 
 
         
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
    
         #交談指令共用ACTION
         &include "common_action.4gl" 
            CONTINUE DIALOG
      END DIALOG
    
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"
         
         #end add-point
         EXIT WHILE
      END IF
    
   END WHILE    
      
   CALL cl_set_act_visible("accept,cancel", TRUE)
    
END FUNCTION
 
{</section>}
 
{<section id="aist330.browser_fill" >}
#+ 瀏覽頁簽資料填充
PRIVATE FUNCTION aist330_browser_fill(ps_page_action)
   #add-point:browser_fill段define(客製用) name="browser_fill.define_customerization"
   
   #end add-point  
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   #add-point:browser_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="browser_fill.define"
   
   #end add-point    
   
   #add-point:Function前置處理 name="browser_fill.before_browser_fill"
   
   #end add-point
   
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
 
   #add-point:browser_fill,foreach前 name="browser_fill.before_foreach"
   
   #end add-point
   
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件                      
      LET l_sub_sql = " SELECT DISTINCT isbfcomp,isbfdocno ",
                      " FROM isbf_t ",
                      " ",
                      " LEFT JOIN isbg_t ON isbgent = isbfent AND isbfcomp = isbgcomp AND isbfdocno = isbgdocno ", "  ",
                      #add-point:browser_fill段sql(isbg_t1) name="browser_fill.cnt.join.}"
                      
                      #end add-point
                      " LEFT JOIN isah_t ON isahent = isbfent AND isbfcomp = isahcomp AND isbfdocno = isahdocno", "  ",
                      #add-point:browser_fill段sql(isah_t1) name="browser_fill.cnt.join.isah_t1"
                      
                      #end add-point
 
                      " LEFT JOIN isat_t ON isatent = isbfent AND isbfcomp = isatcomp AND isbfdocno = isatdocno", "  ",
                      #add-point:browser_fill段sql(isat_t1) name="browser_fill.cnt.join.isat_t1"
                      
                      #end add-point
 
 
 
                      " ", 
                      " ", 
                      " ",                      
 
                      " ",                      
 
 
 
                      " WHERE isbfent = " ||g_enterprise|| " AND isbgent = " ||g_enterprise|| " AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("isbf_t")
   ELSE
      #單身未輸入搜尋條件
      LET l_sub_sql = " SELECT DISTINCT isbfcomp,isbfdocno ",
                      " FROM isbf_t ", 
                      "  ",
                      "  ",
                      " WHERE isbfent = " ||g_enterprise|| " AND ",l_wc CLIPPED, cl_sql_add_filter("isbf_t")
   END IF
   
   #add-point:browser_fill,cnt wc name="browser_fill.cnt_sqlwc"
   
   #end add-point
   
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   
   #add-point:browser_fill,count前 name="browser_fill.before_count"
   
   #end add-point
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE header_cnt_pre FROM g_sql
      EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
      FREE header_cnt_pre
   END IF
    
   IF g_browser_cnt > g_max_browse THEN
      IF g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_browser_cnt
         LET g_errparam.code   = 9035 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
      LET g_browser_cnt = g_max_browse
   END IF
   
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN
      #清除畫面
      CLEAR FORM                
      INITIALIZE g_isbf_m.* TO NULL
      CALL g_isbg_d.clear()        
      CALL g_isbg2_d.clear() 
      CALL g_isbg3_d.clear() 
 
      #add-point:browser_fill g_add_browse段額外處理 name="browser_fill.add_browse.other"
      
      #end add-point   
      CALL g_browser.clear()
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1" 
      LET g_cnt = g_current_idx
   END IF
 
   #依照t0.isbfcomp,t0.isbfdocno Browser欄位定義(取代原本bs_sql功能)
   #考量到單身可能下條件, 所以此處需join單身所有table
   #DISTINCT是為了避免在join時出現重複的資料(如果不加DISTINCT則須在程式中過濾)
   IF g_wc2 <> " 1=1" THEN
      #單身有輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.isbfstus,t0.isbfcomp,t0.isbfdocno ",
                  " FROM isbf_t t0",
                  "  ",
                  "  LEFT JOIN isbg_t ON isbgent = isbfent AND isbfcomp = isbgcomp AND isbfdocno = isbgdocno ", "  ", 
                  #add-point:browser_fill段sql(isbg_t1) name="browser_fill.join.isbg_t1"
                  
                  #end add-point
                  "  LEFT JOIN isah_t ON isahent = isbfent AND isbfcomp = isahcomp AND isbfdocno = isahdocno", "  ", 
                  #add-point:browser_fill段sql(isah_t1) name="browser_fill.join.isah_t1"
                  
                  #end add-point
 
                  "  LEFT JOIN isat_t ON isatent = isbfent AND isbfcomp = isatcomp AND isbfdocno = isatdocno", "  ", 
                  #add-point:browser_fill段sql(isat_t1) name="browser_fill.join.isat_t1"
                  
                  #end add-point
 
 
 
                  " ", 
                  " ",                      
 
                  " ",                      
 
 
 
                  
                  " WHERE t0.isbfent = " ||g_enterprise|| " AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("isbf_t")
   ELSE
      #單身無輸入搜尋條件   
      LET g_sql = " SELECT DISTINCT t0.isbfstus,t0.isbfcomp,t0.isbfdocno ",
                  " FROM isbf_t t0",
                  "  ",
                  
                  " WHERE t0.isbfent = " ||g_enterprise|| " AND ",l_wc, cl_sql_add_filter("isbf_t")
   END IF
   #add-point:browser_fill,sql wc name="browser_fill.fill_sqlwc"
   
   #end add-point
   LET g_sql = g_sql, " ORDER BY isbfcomp,isbfdocno ",g_order
 
   #add-point:browser_fill,before_prepare name="browser_fill.before_prepare"
   
   #end add-point
        
   #LET g_sql = cl_sql_add_tabid(g_sql,"isbf_t") #WC重組
   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE browse_pre FROM g_sql
      DECLARE browse_cur CURSOR FOR browse_pre
      
      #add-point:browser_fill段open cursor name="browser_fill.open"
      
      #end add-point
      
      FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_isbfcomp,g_browser[g_cnt].b_isbfdocno 
 
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "Foreach:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         #add-point:browser_fill段reference name="browser_fill.reference"
         
         #end add-point
      
         #遮罩相關處理
         CALL aist330_browser_mask()
      
               #應用 a24 樣板自動產生(Version:3)
      #browser顯示圖片
      CASE g_browser[g_cnt].b_statepic
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         
      END CASE
 
 
 
         LET g_cnt = g_cnt + 1
         IF g_cnt > g_max_browse THEN
            EXIT FOREACH
         END IF
         
      END FOREACH
      FREE browse_pre
   END IF
   
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   
   IF cl_null(g_browser[g_cnt].b_isbfcomp) THEN
      CALL g_browser.deleteElement(g_cnt)
   END IF
   
   LET g_header_cnt  = g_browser.getLength()
   LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
 
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
 
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
                  
   
   #add-point:browser_fill段結束前 name="browser_fill.after"
   
   #end add-point   
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.ui_headershow" >}
#+ 單頭資料重新顯示
PRIVATE FUNCTION aist330_ui_headershow()
   #add-point:ui_headershow段define(客製用) name="ui_headershow.define_customerization"
   
   #end add-point  
   #add-point:ui_headershow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_headershow.define"
   
   #end add-point      
   
   #add-point:Function前置處理  name="ui_headershow.pre_function"
   
   #end add-point
   
   LET g_isbf_m.isbfcomp = g_browser[g_current_idx].b_isbfcomp   
   LET g_isbf_m.isbfdocno = g_browser[g_current_idx].b_isbfdocno   
 
   EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
       g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003, 
       g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid, 
       g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid, 
       g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp_desc, 
       g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
   
   CALL aist330_isbf_t_mask()
   CALL aist330_show()
      
END FUNCTION
 
{</section>}
 
{<section id="aist330.ui_detailshow" >}
#+ 單身資料重新顯示
PRIVATE FUNCTION aist330_ui_detailshow()
   #add-point:ui_detailshow段define(客製用) name="ui_detailshow.define_customerization"
   
   #end add-point    
   #add-point:ui_detailshow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_detailshow.define"
   
   #end add-point    
 
   #add-point:Function前置處理 name="ui_detailshow.before"
   
   #end add-point    
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_detail2",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_detail3",g_detail_idx)
 
   END IF
   
   #add-point:ui_detailshow段after name="ui_detailshow.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.ui_browser_refresh" >}
#+ 瀏覽頁簽資料重新顯示
PRIVATE FUNCTION aist330_ui_browser_refresh()
   #add-point:ui_browser_refresh段define(客製用) name="ui_browser_refresh.define_customerization"
   
   #end add-point    
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_browser_refresh.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="ui_browser_refresh.pre_function"
   
   #end add-point
   
   LET g_browser_cnt = g_browser.getLength()
   LET g_header_cnt  = g_browser.getLength()
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_isbfcomp = g_isbf_m.isbfcomp 
         AND g_browser[l_i].b_isbfdocno = g_isbf_m.isbfdocno 
 
         THEN
         CALL g_browser.deleteElement(l_i)
         EXIT FOR
      END IF
   END FOR
   LET g_browser_cnt = g_browser_cnt - 1
   LET g_header_cnt = g_header_cnt - 1
    
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
      CLEAR FORM
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
   
   #add-point:ui_browser_refresh段after name="ui_browser_refresh.after"
   
   #end add-point    
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.construct" >}
#+ QBE資料查詢
PRIVATE FUNCTION aist330_construct()
   #add-point:cs段define(客製用) name="cs.define_customerization"
   
   #end add-point    
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   DEFINE la_wc       DYNAMIC ARRAY OF RECORD
          tableid     STRING,
          wc          STRING
          END RECORD
   DEFINE li_idx      LIKE type_t.num10
   #add-point:cs段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="cs.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="cs.pre_function"
   
   #end add-point
    
   #清除畫面
   CLEAR FORM                
   INITIALIZE g_isbf_m.* TO NULL
   CALL g_isbg_d.clear()        
   CALL g_isbg2_d.clear() 
   CALL g_isbg3_d.clear() 
 
   
   LET g_action_choice = ""
    
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc2_table2 TO NULL
 
   INITIALIZE g_wc2_table3 TO NULL
 
 
    
   LET g_qryparam.state = 'c'
   
   #add-point:cs段開始前 name="cs.before_construct"
   
   #end add-point 
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON isbfsite,isbfcomp,isbf001,isbfdocno,isbfdocdt,isbf002,isbf003,isbf004, 
          isbf005,isbfstus,isbfownid,isbfowndp,isbfcrtid,isbfcrtdp,isbfcrtdt,isbfmodid,isbfmoddt,isbfcnfid, 
          isbfcnfdt
 
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.head.before_construct"
            
            #end add-point 
            
         #公用欄位開窗相關處理
         #應用 a11 樣板自動產生(Version:3)
         #共用欄位查詢處理  
         ##----<<isbfcrtdt>>----
         AFTER FIELD isbfcrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
 
         #----<<isbfmoddt>>----
         AFTER FIELD isbfmoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<isbfcnfdt>>----
         AFTER FIELD isbfcnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<isbfpstdt>>----
 
 
 
            
         #一般欄位開窗相關處理    
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfsite
            #add-point:BEFORE FIELD isbfsite name="construct.b.isbfsite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfsite
            
            #add-point:AFTER FIELD isbfsite name="construct.a.isbfsite"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfsite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfsite
            #add-point:ON ACTION controlp INFIELD isbfsite name="construct.c.isbfsite"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            #CALL q_ooef001()     #161006-00005#15   mark
            CALL q_ooef001_46()   #161006-00005#15   add
            DISPLAY g_qryparam.return1 TO isbfsite
            NEXT FIELD isbfsite
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcomp
            #add-point:BEFORE FIELD isbfcomp name="construct.b.isbfcomp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfcomp
            
            #add-point:AFTER FIELD isbfcomp name="construct.a.isbfcomp"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfcomp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfcomp
            #add-point:ON ACTION controlp INFIELD isbfcomp name="construct.c.isbfcomp"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " ooef003 = 'Y' AND ooef001 IN ",g_wc_comp   #161006-00005#15   add
            CALL q_ooef001()
            DISPLAY g_qryparam.return1 TO isbfcomp
            NEXT FIELD isbfcomp
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf001
            #add-point:BEFORE FIELD isbf001 name="construct.b.isbf001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf001
            
            #add-point:AFTER FIELD isbf001 name="construct.a.isbf001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbf001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf001
            #add-point:ON ACTION controlp INFIELD isbf001 name="construct.c.isbf001"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001_8()
            DISPLAY g_qryparam.return1 TO isbf001  #顯示到畫面上
            NEXT FIELD isbf001
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfdocno
            #add-point:BEFORE FIELD isbfdocno name="construct.b.isbfdocno"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfdocno
            
            #add-point:AFTER FIELD isbfdocno name="construct.a.isbfdocno"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfdocno
            #add-point:ON ACTION controlp INFIELD isbfdocno name="construct.c.isbfdocno"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_isbfdocno()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfdocno  #顯示到畫面上
            NEXT FIELD isbfdocno                    #返回原欄位    
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfdocdt
            #add-point:BEFORE FIELD isbfdocdt name="construct.b.isbfdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfdocdt
            
            #add-point:AFTER FIELD isbfdocdt name="construct.a.isbfdocdt"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfdocdt
            #add-point:ON ACTION controlp INFIELD isbfdocdt name="construct.c.isbfdocdt"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf002
            #add-point:BEFORE FIELD isbf002 name="construct.b.isbf002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf002
            
            #add-point:AFTER FIELD isbf002 name="construct.a.isbf002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbf002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf002
            #add-point:ON ACTION controlp INFIELD isbf002 name="construct.c.isbf002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf003
            #add-point:BEFORE FIELD isbf003 name="construct.b.isbf003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf003
            
            #add-point:AFTER FIELD isbf003 name="construct.a.isbf003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbf003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf003
            #add-point:ON ACTION controlp INFIELD isbf003 name="construct.c.isbf003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf004
            #add-point:BEFORE FIELD isbf004 name="construct.b.isbf004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf004
            
            #add-point:AFTER FIELD isbf004 name="construct.a.isbf004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbf004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf004
            #add-point:ON ACTION controlp INFIELD isbf004 name="construct.c.isbf004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf005
            #add-point:BEFORE FIELD isbf005 name="construct.b.isbf005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf005
            
            #add-point:AFTER FIELD isbf005 name="construct.a.isbf005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbf005
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf005
            #add-point:ON ACTION controlp INFIELD isbf005 name="construct.c.isbf005"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_isac002()                          
            DISPLAY g_qryparam.return1 TO isbf005  
            NEXT FIELD isbf005
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfstus
            #add-point:BEFORE FIELD isbfstus name="construct.b.isbfstus"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfstus
            
            #add-point:AFTER FIELD isbfstus name="construct.a.isbfstus"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfstus
            #add-point:ON ACTION controlp INFIELD isbfstus name="construct.c.isbfstus"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isbfownid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfownid
            #add-point:ON ACTION controlp INFIELD isbfownid name="construct.c.isbfownid"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfownid  #顯示到畫面上
            NEXT FIELD isbfownid                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfownid
            #add-point:BEFORE FIELD isbfownid name="construct.b.isbfownid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfownid
            
            #add-point:AFTER FIELD isbfownid name="construct.a.isbfownid"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfowndp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfowndp
            #add-point:ON ACTION controlp INFIELD isbfowndp name="construct.c.isbfowndp"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfowndp  #顯示到畫面上
            NEXT FIELD isbfowndp                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfowndp
            #add-point:BEFORE FIELD isbfowndp name="construct.b.isbfowndp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfowndp
            
            #add-point:AFTER FIELD isbfowndp name="construct.a.isbfowndp"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfcrtid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfcrtid
            #add-point:ON ACTION controlp INFIELD isbfcrtid name="construct.c.isbfcrtid"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfcrtid  #顯示到畫面上
            NEXT FIELD isbfcrtid                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcrtid
            #add-point:BEFORE FIELD isbfcrtid name="construct.b.isbfcrtid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfcrtid
            
            #add-point:AFTER FIELD isbfcrtid name="construct.a.isbfcrtid"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.isbfcrtdp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfcrtdp
            #add-point:ON ACTION controlp INFIELD isbfcrtdp name="construct.c.isbfcrtdp"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooeg001_9()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfcrtdp  #顯示到畫面上
            NEXT FIELD isbfcrtdp                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcrtdp
            #add-point:BEFORE FIELD isbfcrtdp name="construct.b.isbfcrtdp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfcrtdp
            
            #add-point:AFTER FIELD isbfcrtdp name="construct.a.isbfcrtdp"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcrtdt
            #add-point:BEFORE FIELD isbfcrtdt name="construct.b.isbfcrtdt"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isbfmodid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfmodid
            #add-point:ON ACTION controlp INFIELD isbfmodid name="construct.c.isbfmodid"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfmodid  #顯示到畫面上
            NEXT FIELD isbfmodid                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfmodid
            #add-point:BEFORE FIELD isbfmodid name="construct.b.isbfmodid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfmodid
            
            #add-point:AFTER FIELD isbfmodid name="construct.a.isbfmodid"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfmoddt
            #add-point:BEFORE FIELD isbfmoddt name="construct.b.isbfmoddt"
            
            #END add-point
 
 
         #Ctrlp:construct.c.isbfcnfid
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfcnfid
            #add-point:ON ACTION controlp INFIELD isbfcnfid name="construct.c.isbfcnfid"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isbfcnfid  #顯示到畫面上
            NEXT FIELD isbfcnfid                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcnfid
            #add-point:BEFORE FIELD isbfcnfid name="construct.b.isbfcnfid"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfcnfid
            
            #add-point:AFTER FIELD isbfcnfid name="construct.a.isbfcnfid"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcnfdt
            #add-point:BEFORE FIELD isbfcnfdt name="construct.b.isbfcnfdt"
            
            #END add-point
 
 
 
         
      END CONSTRUCT
 
      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON isbgseq,isbg001,isbg002,isbg003,isbg004
           FROM s_detail1[1].isbgseq,s_detail1[1].isbg001,s_detail1[1].isbg002,s_detail1[1].isbg003, 
               s_detail1[1].isbg004
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body.before_construct"
            
            #end add-point 
            
       #單身公用欄位開窗相關處理
       
         
       #單身一般欄位開窗相關處理
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbgseq
            #add-point:BEFORE FIELD isbgseq name="construct.b.page1.isbgseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbgseq
            
            #add-point:AFTER FIELD isbgseq name="construct.a.page1.isbgseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isbgseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbgseq
            #add-point:ON ACTION controlp INFIELD isbgseq name="construct.c.page1.isbgseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg001
            #add-point:BEFORE FIELD isbg001 name="construct.b.page1.isbg001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg001
            
            #add-point:AFTER FIELD isbg001 name="construct.a.page1.isbg001"
 
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isbg001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg001
            #add-point:ON ACTION controlp INFIELD isbg001 name="construct.c.page1.isbg001"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg002
            #add-point:BEFORE FIELD isbg002 name="construct.b.page1.isbg002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg002
            
            #add-point:AFTER FIELD isbg002 name="construct.a.page1.isbg002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isbg002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg002
            #add-point:ON ACTION controlp INFIELD isbg002 name="construct.c.page1.isbg002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg003
            #add-point:BEFORE FIELD isbg003 name="construct.b.page1.isbg003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg003
            
            #add-point:AFTER FIELD isbg003 name="construct.a.page1.isbg003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isbg003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg003
            #add-point:ON ACTION controlp INFIELD isbg003 name="construct.c.page1.isbg003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg004
            #add-point:BEFORE FIELD isbg004 name="construct.b.page1.isbg004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg004
            
            #add-point:AFTER FIELD isbg004 name="construct.a.page1.isbg004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page1.isbg004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg004
            #add-point:ON ACTION controlp INFIELD isbg004 name="construct.c.page1.isbg004"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
      
      CONSTRUCT g_wc2_table2 ON isahseq,isahorga,isah003,isah004,isah013,isah005,isah006,isah101,isah103, 
          isah007,isah104,isah105,isah011,isah001,isah002,isah008,isah009,isah010,isah012,isah106,isah113, 
          isah114,isah115,isah116
           FROM s_detail2[1].isahseq,s_detail2[1].isahorga,s_detail2[1].isah003,s_detail2[1].isah004, 
               s_detail2[1].isah013,s_detail2[1].isah005,s_detail2[1].isah006,s_detail2[1].isah101,s_detail2[1].isah103, 
               s_detail2[1].isah007,s_detail2[1].isah104,s_detail2[1].isah105,s_detail2[1].isah011,s_detail2[1].isah001, 
               s_detail2[1].isah002,s_detail2[1].isah008,s_detail2[1].isah009,s_detail2[1].isah010,s_detail2[1].isah012, 
               s_detail2[1].isah106,s_detail2[1].isah113,s_detail2[1].isah114,s_detail2[1].isah115,s_detail2[1].isah116 
 
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body2.before_construct"
            
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 2)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahseq
            #add-point:BEFORE FIELD isahseq name="construct.b.page2.isahseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahseq
            
            #add-point:AFTER FIELD isahseq name="construct.a.page2.isahseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isahseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahseq
            #add-point:ON ACTION controlp INFIELD isahseq name="construct.c.page2.isahseq"
            
            #END add-point
 
 
         #Ctrlp:construct.c.page2.isahorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahorga
            #add-point:ON ACTION controlp INFIELD isahorga name="construct.c.page2.isahorga"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            #161017-00005#1 --s add
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = "ooef201 = 'Y'"   
			   IF NOT cl_null(g_wc_site) THEN        
			   LET g_qryparam.where = " ooef001 IN ",g_wc_site,
			                          " AND ",g_qryparam.where CLIPPED 
			   END IF  
            CALL q_ooef001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isahorga  #顯示到畫面上
            NEXT FIELD isahorga                     #返回原欄位
            #161017-00005#1 --e add
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahorga
            #add-point:BEFORE FIELD isahorga name="construct.b.page2.isahorga"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahorga
            
            #add-point:AFTER FIELD isahorga name="construct.a.page2.isahorga"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah003
            #add-point:ON ACTION controlp INFIELD isah003 name="construct.c.page2.isah003"
            #應用 a08 樣板自動產生(Version:2)
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c' 
            LET g_qryparam.reqry = FALSE
            CALL q_imaa001()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isah003  #顯示到畫面上
            NEXT FIELD isah003                     #返回原欄位
    


            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah003
            #add-point:BEFORE FIELD isah003 name="construct.b.page2.isah003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah003
            
            #add-point:AFTER FIELD isah003 name="construct.a.page2.isah003"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah004
            #add-point:BEFORE FIELD isah004 name="construct.b.page2.isah004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah004
            
            #add-point:AFTER FIELD isah004 name="construct.a.page2.isah004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah004
            #add-point:ON ACTION controlp INFIELD isah004 name="construct.c.page2.isah004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah013
            #add-point:BEFORE FIELD isah013 name="construct.b.page2.isah013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah013
            
            #add-point:AFTER FIELD isah013 name="construct.a.page2.isah013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah013
            #add-point:ON ACTION controlp INFIELD isah013 name="construct.c.page2.isah013"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah005
            #add-point:BEFORE FIELD isah005 name="construct.b.page2.isah005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah005
            
            #add-point:AFTER FIELD isah005 name="construct.a.page2.isah005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah005
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah005
            #add-point:ON ACTION controlp INFIELD isah005 name="construct.c.page2.isah005"
           INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()                           #呼叫開窗
            DISPLAY g_qryparam.return1 TO isah005  #顯示到畫面上
            NEXT FIELD isah005        
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah006
            #add-point:BEFORE FIELD isah006 name="construct.b.page2.isah006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah006
            
            #add-point:AFTER FIELD isah006 name="construct.a.page2.isah006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah006
            #add-point:ON ACTION controlp INFIELD isah006 name="construct.c.page2.isah006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah101
            #add-point:BEFORE FIELD isah101 name="construct.b.page2.isah101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah101
            
            #add-point:AFTER FIELD isah101 name="construct.a.page2.isah101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah101
            #add-point:ON ACTION controlp INFIELD isah101 name="construct.c.page2.isah101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah103
            #add-point:BEFORE FIELD isah103 name="construct.b.page2.isah103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah103
            
            #add-point:AFTER FIELD isah103 name="construct.a.page2.isah103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah103
            #add-point:ON ACTION controlp INFIELD isah103 name="construct.c.page2.isah103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah007
            #add-point:BEFORE FIELD isah007 name="construct.b.page2.isah007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah007
            
            #add-point:AFTER FIELD isah007 name="construct.a.page2.isah007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah007
            #add-point:ON ACTION controlp INFIELD isah007 name="construct.c.page2.isah007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah104
            #add-point:BEFORE FIELD isah104 name="construct.b.page2.isah104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah104
            
            #add-point:AFTER FIELD isah104 name="construct.a.page2.isah104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah104
            #add-point:ON ACTION controlp INFIELD isah104 name="construct.c.page2.isah104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah105
            #add-point:BEFORE FIELD isah105 name="construct.b.page2.isah105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah105
            
            #add-point:AFTER FIELD isah105 name="construct.a.page2.isah105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah105
            #add-point:ON ACTION controlp INFIELD isah105 name="construct.c.page2.isah105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah011
            #add-point:BEFORE FIELD isah011 name="construct.b.page2.isah011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah011
            
            #add-point:AFTER FIELD isah011 name="construct.a.page2.isah011"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah011
            #add-point:ON ACTION controlp INFIELD isah011 name="construct.c.page2.isah011"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah001
            #add-point:BEFORE FIELD isah001 name="construct.b.page2.isah001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah001
            
            #add-point:AFTER FIELD isah001 name="construct.a.page2.isah001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah001
            #add-point:ON ACTION controlp INFIELD isah001 name="construct.c.page2.isah001"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah002
            #add-point:BEFORE FIELD isah002 name="construct.b.page2.isah002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah002
            
            #add-point:AFTER FIELD isah002 name="construct.a.page2.isah002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah002
            #add-point:ON ACTION controlp INFIELD isah002 name="construct.c.page2.isah002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah008
            #add-point:BEFORE FIELD isah008 name="construct.b.page2.isah008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah008
            
            #add-point:AFTER FIELD isah008 name="construct.a.page2.isah008"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah008
            #add-point:ON ACTION controlp INFIELD isah008 name="construct.c.page2.isah008"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah009
            #add-point:BEFORE FIELD isah009 name="construct.b.page2.isah009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah009
            
            #add-point:AFTER FIELD isah009 name="construct.a.page2.isah009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah009
            #add-point:ON ACTION controlp INFIELD isah009 name="construct.c.page2.isah009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah010
            #add-point:BEFORE FIELD isah010 name="construct.b.page2.isah010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah010
            
            #add-point:AFTER FIELD isah010 name="construct.a.page2.isah010"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah010
            #add-point:ON ACTION controlp INFIELD isah010 name="construct.c.page2.isah010"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah012
            #add-point:BEFORE FIELD isah012 name="construct.b.page2.isah012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah012
            
            #add-point:AFTER FIELD isah012 name="construct.a.page2.isah012"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah012
            #add-point:ON ACTION controlp INFIELD isah012 name="construct.c.page2.isah012"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah106
            #add-point:BEFORE FIELD isah106 name="construct.b.page2.isah106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah106
            
            #add-point:AFTER FIELD isah106 name="construct.a.page2.isah106"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah106
            #add-point:ON ACTION controlp INFIELD isah106 name="construct.c.page2.isah106"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah113
            #add-point:BEFORE FIELD isah113 name="construct.b.page2.isah113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah113
            
            #add-point:AFTER FIELD isah113 name="construct.a.page2.isah113"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah113
            #add-point:ON ACTION controlp INFIELD isah113 name="construct.c.page2.isah113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah114
            #add-point:BEFORE FIELD isah114 name="construct.b.page2.isah114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah114
            
            #add-point:AFTER FIELD isah114 name="construct.a.page2.isah114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah114
            #add-point:ON ACTION controlp INFIELD isah114 name="construct.c.page2.isah114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah115
            #add-point:BEFORE FIELD isah115 name="construct.b.page2.isah115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah115
            
            #add-point:AFTER FIELD isah115 name="construct.a.page2.isah115"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah115
            #add-point:ON ACTION controlp INFIELD isah115 name="construct.c.page2.isah115"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah116
            #add-point:BEFORE FIELD isah116 name="construct.b.page2.isah116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah116
            
            #add-point:AFTER FIELD isah116 name="construct.a.page2.isah116"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page2.isah116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah116
            #add-point:ON ACTION controlp INFIELD isah116 name="construct.c.page2.isah116"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
      CONSTRUCT g_wc2_table3 ON isatseq,isatsite,isat003,isat004,isat006,isat005,isat022,isat113,isat114, 
          isat115,isat103,isat104,isat105,isat007,isat014,isat106,isat107,isat017,isat001,isat002,isat008, 
          isat009,isat010,isat011,isat012,isat013,isat015,isat016,isat018,isat019,isat020,isat021,isat023, 
          isat024,isat100,isat101,isat201,isat202,isat203,isat204,isat205,isat206,isat207,isat208,isat209, 
          isatdocdt
           FROM s_detail3[1].isatseq,s_detail3[1].isatsite,s_detail3[1].isat003,s_detail3[1].isat004, 
               s_detail3[1].isat006,s_detail3[1].isat005,s_detail3[1].isat022,s_detail3[1].isat113,s_detail3[1].isat114, 
               s_detail3[1].isat115,s_detail3[1].isat103,s_detail3[1].isat104,s_detail3[1].isat105,s_detail3[1].isat007, 
               s_detail3[1].isat014,s_detail3[1].isat106,s_detail3[1].isat107,s_detail3[1].isat017,s_detail3[1].isat001, 
               s_detail3[1].isat002,s_detail3[1].isat008,s_detail3[1].isat009,s_detail3[1].isat010,s_detail3[1].isat011, 
               s_detail3[1].isat012,s_detail3[1].isat013,s_detail3[1].isat015,s_detail3[1].isat016,s_detail3[1].isat018, 
               s_detail3[1].isat019,s_detail3[1].isat020,s_detail3[1].isat021,s_detail3[1].isat023,s_detail3[1].isat024, 
               s_detail3[1].isat100,s_detail3[1].isat101,s_detail3[1].isat201,s_detail3[1].isat202,s_detail3[1].isat203, 
               s_detail3[1].isat204,s_detail3[1].isat205,s_detail3[1].isat206,s_detail3[1].isat207,s_detail3[1].isat208, 
               s_detail3[1].isat209,s_detail3[1].isatdocdt
                      
         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.body3.before_construct"
            
            #end add-point 
            
       #單身公用欄位開窗相關處理(table 3)
       
       
       #單身一般欄位開窗相關處理       
                #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatseq
            #add-point:BEFORE FIELD isatseq name="construct.b.page3.isatseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatseq
            
            #add-point:AFTER FIELD isatseq name="construct.a.page3.isatseq"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isatseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatseq
            #add-point:ON ACTION controlp INFIELD isatseq name="construct.c.page3.isatseq"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatsite
            #add-point:BEFORE FIELD isatsite name="construct.b.page3.isatsite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatsite
            
            #add-point:AFTER FIELD isatsite name="construct.a.page3.isatsite"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isatsite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatsite
            #add-point:ON ACTION controlp INFIELD isatsite name="construct.c.page3.isatsite"
            #161017-00005#1 --s add
            CALL s_fin_account_center_comp_str() RETURNING g_wc_comp
            CALL s_fin_get_wc_str(g_wc_comp) RETURNING g_wc_comp
            CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
            CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE  
            LET g_qryparam.where = "ooef201 = 'Y'"   
			   IF NOT cl_null(g_wc_isbfsite) THEN        
			   LET g_qryparam.where = " ooef001 IN ",g_wc_isbfsite,
			                          " AND ",g_qryparam.where CLIPPED 
			   END IF
            CALL q_ooef001()                                #呼叫開窗

            LET g_isbg3_d[l_ac].isatsite = g_qryparam.return1              
            DISPLAY BY NAME g_isbg3_d[l_ac].isatsite            #
            NEXT FIELD isatsite
            #161017-00005#1 --e add
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat003
            #add-point:BEFORE FIELD isat003 name="construct.b.page3.isat003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat003
            
            #add-point:AFTER FIELD isat003 name="construct.a.page3.isat003"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat003
            #add-point:ON ACTION controlp INFIELD isat003 name="construct.c.page3.isat003"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat004
            #add-point:BEFORE FIELD isat004 name="construct.b.page3.isat004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat004
            
            #add-point:AFTER FIELD isat004 name="construct.a.page3.isat004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat004
            #add-point:ON ACTION controlp INFIELD isat004 name="construct.c.page3.isat004"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat006
            #add-point:BEFORE FIELD isat006 name="construct.b.page3.isat006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat006
            
            #add-point:AFTER FIELD isat006 name="construct.a.page3.isat006"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat006
            #add-point:ON ACTION controlp INFIELD isat006 name="construct.c.page3.isat006"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat005
            #add-point:BEFORE FIELD isat005 name="construct.b.page3.isat005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat005
            
            #add-point:AFTER FIELD isat005 name="construct.a.page3.isat005"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat005
            #add-point:ON ACTION controlp INFIELD isat005 name="construct.c.page3.isat005"
 
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat022
            #add-point:BEFORE FIELD isat022 name="construct.b.page3.isat022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat022
            
            #add-point:AFTER FIELD isat022 name="construct.a.page3.isat022"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat022
            #add-point:ON ACTION controlp INFIELD isat022 name="construct.c.page3.isat022"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat113
            #add-point:BEFORE FIELD isat113 name="construct.b.page3.isat113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat113
            
            #add-point:AFTER FIELD isat113 name="construct.a.page3.isat113"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat113
            #add-point:ON ACTION controlp INFIELD isat113 name="construct.c.page3.isat113"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat114
            #add-point:BEFORE FIELD isat114 name="construct.b.page3.isat114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat114
            
            #add-point:AFTER FIELD isat114 name="construct.a.page3.isat114"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat114
            #add-point:ON ACTION controlp INFIELD isat114 name="construct.c.page3.isat114"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat115
            #add-point:BEFORE FIELD isat115 name="construct.b.page3.isat115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat115
            
            #add-point:AFTER FIELD isat115 name="construct.a.page3.isat115"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat115
            #add-point:ON ACTION controlp INFIELD isat115 name="construct.c.page3.isat115"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat103
            #add-point:BEFORE FIELD isat103 name="construct.b.page3.isat103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat103
            
            #add-point:AFTER FIELD isat103 name="construct.a.page3.isat103"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat103
            #add-point:ON ACTION controlp INFIELD isat103 name="construct.c.page3.isat103"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat104
            #add-point:BEFORE FIELD isat104 name="construct.b.page3.isat104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat104
            
            #add-point:AFTER FIELD isat104 name="construct.a.page3.isat104"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat104
            #add-point:ON ACTION controlp INFIELD isat104 name="construct.c.page3.isat104"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat105
            #add-point:BEFORE FIELD isat105 name="construct.b.page3.isat105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat105
            
            #add-point:AFTER FIELD isat105 name="construct.a.page3.isat105"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat105
            #add-point:ON ACTION controlp INFIELD isat105 name="construct.c.page3.isat105"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat007
            #add-point:BEFORE FIELD isat007 name="construct.b.page3.isat007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat007
            
            #add-point:AFTER FIELD isat007 name="construct.a.page3.isat007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat007
            #add-point:ON ACTION controlp INFIELD isat007 name="construct.c.page3.isat007"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat014
            #add-point:BEFORE FIELD isat014 name="construct.b.page3.isat014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat014
            
            #add-point:AFTER FIELD isat014 name="construct.a.page3.isat014"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat014
            #add-point:ON ACTION controlp INFIELD isat014 name="construct.c.page3.isat014"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat106
            #add-point:BEFORE FIELD isat106 name="construct.b.page3.isat106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat106
            
            #add-point:AFTER FIELD isat106 name="construct.a.page3.isat106"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat106
            #add-point:ON ACTION controlp INFIELD isat106 name="construct.c.page3.isat106"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat107
            #add-point:BEFORE FIELD isat107 name="construct.b.page3.isat107"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat107
            
            #add-point:AFTER FIELD isat107 name="construct.a.page3.isat107"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat107
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat107
            #add-point:ON ACTION controlp INFIELD isat107 name="construct.c.page3.isat107"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat017
            #add-point:BEFORE FIELD isat017 name="construct.b.page3.isat017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat017
            
            #add-point:AFTER FIELD isat017 name="construct.a.page3.isat017"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat017
            #add-point:ON ACTION controlp INFIELD isat017 name="construct.c.page3.isat017"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat001
            #add-point:BEFORE FIELD isat001 name="construct.b.page3.isat001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat001
            
            #add-point:AFTER FIELD isat001 name="construct.a.page3.isat001"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat001
            #add-point:ON ACTION controlp INFIELD isat001 name="construct.c.page3.isat001"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat002
            #add-point:BEFORE FIELD isat002 name="construct.b.page3.isat002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat002
            
            #add-point:AFTER FIELD isat002 name="construct.a.page3.isat002"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat002
            #add-point:ON ACTION controlp INFIELD isat002 name="construct.c.page3.isat002"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat008
            #add-point:BEFORE FIELD isat008 name="construct.b.page3.isat008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat008
            
            #add-point:AFTER FIELD isat008 name="construct.a.page3.isat008"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat008
            #add-point:ON ACTION controlp INFIELD isat008 name="construct.c.page3.isat008"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat009
            #add-point:BEFORE FIELD isat009 name="construct.b.page3.isat009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat009
            
            #add-point:AFTER FIELD isat009 name="construct.a.page3.isat009"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat009
            #add-point:ON ACTION controlp INFIELD isat009 name="construct.c.page3.isat009"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat010
            #add-point:BEFORE FIELD isat010 name="construct.b.page3.isat010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat010
            
            #add-point:AFTER FIELD isat010 name="construct.a.page3.isat010"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat010
            #add-point:ON ACTION controlp INFIELD isat010 name="construct.c.page3.isat010"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat011
            #add-point:BEFORE FIELD isat011 name="construct.b.page3.isat011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat011
            
            #add-point:AFTER FIELD isat011 name="construct.a.page3.isat011"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat011
            #add-point:ON ACTION controlp INFIELD isat011 name="construct.c.page3.isat011"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat012
            #add-point:BEFORE FIELD isat012 name="construct.b.page3.isat012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat012
            
            #add-point:AFTER FIELD isat012 name="construct.a.page3.isat012"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat012
            #add-point:ON ACTION controlp INFIELD isat012 name="construct.c.page3.isat012"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat013
            #add-point:BEFORE FIELD isat013 name="construct.b.page3.isat013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat013
            
            #add-point:AFTER FIELD isat013 name="construct.a.page3.isat013"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat013
            #add-point:ON ACTION controlp INFIELD isat013 name="construct.c.page3.isat013"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat015
            #add-point:BEFORE FIELD isat015 name="construct.b.page3.isat015"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat015
            
            #add-point:AFTER FIELD isat015 name="construct.a.page3.isat015"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat015
            #add-point:ON ACTION controlp INFIELD isat015 name="construct.c.page3.isat015"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat016
            #add-point:BEFORE FIELD isat016 name="construct.b.page3.isat016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat016
            
            #add-point:AFTER FIELD isat016 name="construct.a.page3.isat016"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat016
            #add-point:ON ACTION controlp INFIELD isat016 name="construct.c.page3.isat016"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat018
            #add-point:BEFORE FIELD isat018 name="construct.b.page3.isat018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat018
            
            #add-point:AFTER FIELD isat018 name="construct.a.page3.isat018"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat018
            #add-point:ON ACTION controlp INFIELD isat018 name="construct.c.page3.isat018"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat019
            #add-point:BEFORE FIELD isat019 name="construct.b.page3.isat019"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat019
            
            #add-point:AFTER FIELD isat019 name="construct.a.page3.isat019"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat019
            #add-point:ON ACTION controlp INFIELD isat019 name="construct.c.page3.isat019"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat020
            #add-point:BEFORE FIELD isat020 name="construct.b.page3.isat020"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat020
            
            #add-point:AFTER FIELD isat020 name="construct.a.page3.isat020"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat020
            #add-point:ON ACTION controlp INFIELD isat020 name="construct.c.page3.isat020"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat021
            #add-point:BEFORE FIELD isat021 name="construct.b.page3.isat021"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat021
            
            #add-point:AFTER FIELD isat021 name="construct.a.page3.isat021"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat021
            #add-point:ON ACTION controlp INFIELD isat021 name="construct.c.page3.isat021"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat023
            #add-point:BEFORE FIELD isat023 name="construct.b.page3.isat023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat023
            
            #add-point:AFTER FIELD isat023 name="construct.a.page3.isat023"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat023
            #add-point:ON ACTION controlp INFIELD isat023 name="construct.c.page3.isat023"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat024
            #add-point:BEFORE FIELD isat024 name="construct.b.page3.isat024"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat024
            
            #add-point:AFTER FIELD isat024 name="construct.a.page3.isat024"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat024
            #add-point:ON ACTION controlp INFIELD isat024 name="construct.c.page3.isat024"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat100
            #add-point:BEFORE FIELD isat100 name="construct.b.page3.isat100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat100
            
            #add-point:AFTER FIELD isat100 name="construct.a.page3.isat100"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat100
            #add-point:ON ACTION controlp INFIELD isat100 name="construct.c.page3.isat100"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat101
            #add-point:BEFORE FIELD isat101 name="construct.b.page3.isat101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat101
            
            #add-point:AFTER FIELD isat101 name="construct.a.page3.isat101"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat101
            #add-point:ON ACTION controlp INFIELD isat101 name="construct.c.page3.isat101"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat201
            #add-point:BEFORE FIELD isat201 name="construct.b.page3.isat201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat201
            
            #add-point:AFTER FIELD isat201 name="construct.a.page3.isat201"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat201
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat201
            #add-point:ON ACTION controlp INFIELD isat201 name="construct.c.page3.isat201"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat202
            #add-point:BEFORE FIELD isat202 name="construct.b.page3.isat202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat202
            
            #add-point:AFTER FIELD isat202 name="construct.a.page3.isat202"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat202
            #add-point:ON ACTION controlp INFIELD isat202 name="construct.c.page3.isat202"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat203
            #add-point:BEFORE FIELD isat203 name="construct.b.page3.isat203"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat203
            
            #add-point:AFTER FIELD isat203 name="construct.a.page3.isat203"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat203
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat203
            #add-point:ON ACTION controlp INFIELD isat203 name="construct.c.page3.isat203"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat204
            #add-point:BEFORE FIELD isat204 name="construct.b.page3.isat204"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat204
            
            #add-point:AFTER FIELD isat204 name="construct.a.page3.isat204"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat204
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat204
            #add-point:ON ACTION controlp INFIELD isat204 name="construct.c.page3.isat204"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat205
            #add-point:BEFORE FIELD isat205 name="construct.b.page3.isat205"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat205
            
            #add-point:AFTER FIELD isat205 name="construct.a.page3.isat205"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat205
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat205
            #add-point:ON ACTION controlp INFIELD isat205 name="construct.c.page3.isat205"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat206
            #add-point:BEFORE FIELD isat206 name="construct.b.page3.isat206"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat206
            
            #add-point:AFTER FIELD isat206 name="construct.a.page3.isat206"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat206
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat206
            #add-point:ON ACTION controlp INFIELD isat206 name="construct.c.page3.isat206"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat207
            #add-point:BEFORE FIELD isat207 name="construct.b.page3.isat207"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat207
            
            #add-point:AFTER FIELD isat207 name="construct.a.page3.isat207"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat207
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat207
            #add-point:ON ACTION controlp INFIELD isat207 name="construct.c.page3.isat207"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat208
            #add-point:BEFORE FIELD isat208 name="construct.b.page3.isat208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat208
            
            #add-point:AFTER FIELD isat208 name="construct.a.page3.isat208"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat208
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat208
            #add-point:ON ACTION controlp INFIELD isat208 name="construct.c.page3.isat208"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat209
            #add-point:BEFORE FIELD isat209 name="construct.b.page3.isat209"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat209
            
            #add-point:AFTER FIELD isat209 name="construct.a.page3.isat209"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isat209
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat209
            #add-point:ON ACTION controlp INFIELD isat209 name="construct.c.page3.isat209"
            
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatdocdt
            #add-point:BEFORE FIELD isatdocdt name="construct.b.page3.isatdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatdocdt
            
            #add-point:AFTER FIELD isatdocdt name="construct.a.page3.isatdocdt"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.page3.isatdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatdocdt
            #add-point:ON ACTION controlp INFIELD isatdocdt name="construct.c.page3.isatdocdt"
            
            #END add-point
 
 
   
       
      END CONSTRUCT
 
 
      
 
      
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令) name="cs.add_cs"
      
      #end add-point
 
      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段b_dialog name="cs.b_dialog"
         
         #end add-point  
 
      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
         IF NOT cl_null(ls_wc) THEN
            CALL util.JSON.parse(ls_wc, la_wc)
            INITIALIZE g_wc, g_wc2, g_wc2_table1, g_wc2_extend TO NULL
            INITIALIZE g_wc2_table2 TO NULL
 
            INITIALIZE g_wc2_table3 TO NULL
 
 
            FOR li_idx = 1 TO la_wc.getLength()
               CASE
                  WHEN la_wc[li_idx].tableid = "isbf_t" 
                     LET g_wc = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "isbg_t" 
                     LET g_wc2_table1 = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "isah_t" 
                     LET g_wc2_table2 = la_wc[li_idx].wc
 
                  WHEN la_wc[li_idx].tableid = "isat_t" 
                     LET g_wc2_table3 = la_wc[li_idx].wc
 
 
               END CASE
            END FOR
         END IF
    
      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   IF g_wc2_table2 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
   END IF
 
   IF g_wc2_table3 <> " 1=1" THEN
      LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
   END IF
 
 
 
 
   
   #add-point:cs段結束前 name="cs.after_construct"
   
   #end add-point    
 
   IF INT_FLAG THEN
      RETURN
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.filter" >}
#應用 a50 樣板自動產生(Version:8)
#+ filter過濾功能
PRIVATE FUNCTION aist330_filter()
   #add-point:filter段define name="filter.define_customerization"
   
   #end add-point   
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="filter.pre_function"
   
   #end add-point
   
   #切換畫面
   IF NOT g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF   
 
   LET INT_FLAG = 0
 
   LET g_qryparam.state = 'c'
 
   LET g_wc_filter_t = g_wc_filter.trim()
   LET g_wc_t = g_wc
 
   LET g_wc = cl_replace_str(g_wc, g_wc_filter_t, '')
 
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
      #單頭
      CONSTRUCT g_wc_filter ON isbfcomp,isbfdocno
                          FROM s_browse[1].b_isbfcomp,s_browse[1].b_isbfdocno
 
         BEFORE CONSTRUCT
               DISPLAY aist330_filter_parser('isbfcomp') TO s_browse[1].b_isbfcomp
            DISPLAY aist330_filter_parser('isbfdocno') TO s_browse[1].b_isbfdocno
      
         #add-point:filter段cs_ctrl name="filter.cs_ctrl"
         
         #end add-point
      
      END CONSTRUCT
 
      #add-point:filter段add_cs name="filter.add_cs"
      
      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog name="filter.b_dialog"
         
         #end add-point  
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
      LET g_wc = g_wc , g_wc_filter
   ELSE
      LET g_wc_filter = g_wc_filter_t
      LET g_wc = g_wc_t
   END IF
 
      CALL aist330_filter_show('isbfcomp')
   CALL aist330_filter_show('isbfdocno')
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.filter_parser" >}
#+ filter過濾功能
PRIVATE FUNCTION aist330_filter_parser(ps_field)
   #add-point:filter段define name="filter_parser.define_customerization"
   
   #end add-point    
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter_parser.define"
   
   #end add-point    
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF
 
   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.filter_show" >}
#+ 顯示過濾條件
PRIVATE FUNCTION aist330_filter_show(ps_field)
   DEFINE ps_field         STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.b_", ps_field
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF
 
   #顯示資料組合
   LET ls_condition = aist330_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF
 
   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.query" >}
#+ 資料查詢QBE功能準備
PRIVATE FUNCTION aist330_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point   
   DEFINE ls_wc STRING
   #add-point:query段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF   
   
   LET ls_wc = g_wc
   
   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()       
   CALL g_isbg_d.clear()
   CALL g_isbg2_d.clear()
   CALL g_isbg3_d.clear()
 
   
   #add-point:query段other name="query.other"
   
   #end add-point   
   
   DISPLAY '' TO FORMONLY.idx
   DISPLAY '' TO FORMONLY.cnt
   DISPLAY '' TO FORMONLY.b_index
   DISPLAY '' TO FORMONLY.b_count
   DISPLAY '' TO FORMONLY.h_index
   DISPLAY '' TO FORMONLY.h_count
   
   CALL aist330_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      #LET g_wc = ls_wc
      LET g_wc = " 1=2"
      CALL aist330_browser_fill("")
      CALL aist330_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化 
   LET g_detail_cnt  = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   LET g_detail_idx_list[1] = 1
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
 
   LET g_error_show  = 1
   LET g_wc_filter   = ""
   LET l_ac = 1
   CALL FGL_SET_ARR_CURR(1)
      CALL aist330_filter_show('isbfcomp')
   CALL aist330_filter_show('isbfdocno')
   CALL aist330_browser_fill("F")
         
   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "-100" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
   ELSE
      CALL aist330_fetch("F") 
      #顯示單身筆數
      CALL aist330_idx_chk()
   END IF
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.fetch" >}
#+ 指定PK後抓取單頭其他資料
PRIVATE FUNCTION aist330_fetch(p_flag)
   #add-point:fetch段define(客製用) name="fetch.define_customerization"
   
   #end add-point    
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fetch.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="fetch.pre_function"
   
   #end add-point
   
   IF g_browser_cnt = 0 THEN
      RETURN
   END IF
 
   #清空第二階單身
 
   
   CALL cl_ap_performance_next_start()
   CASE p_flag
      WHEN 'F' 
         LET g_current_idx = 1
      WHEN 'L'  
         LET g_current_idx = g_browser.getLength()              
      WHEN 'P'
         IF g_current_idx > 1 THEN               
            LET g_current_idx = g_current_idx - 1
         END IF 
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF        
      WHEN '/'
         IF (NOT g_no_ask) THEN    
            CALL cl_set_act_visible("accept,cancel", TRUE)    
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0
 
            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl" 
            END PROMPT
 
            CALL cl_set_act_visible("accept,cancel", FALSE)    
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE  
            END IF           
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         LET g_no_ask = FALSE  
   END CASE 
 
   CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引
   
   LET g_current_row = g_current_idx
   LET g_detail_cnt = g_header_cnt                  
   
   #單身總筆數顯示
   IF g_detail_cnt > 0 THEN
      #若單身有資料時, idx至少為1
      IF g_detail_idx <= 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx  
   ELSE
      LET g_detail_idx = 0
      DISPLAY '' TO FORMONLY.idx    
   END IF
   
   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )
 
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #避免超出browser資料筆數上限
   IF g_current_idx > g_browser.getLength() THEN
      LET g_browser_idx = g_browser.getLength()
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_isbf_m.isbfcomp = g_browser[g_current_idx].b_isbfcomp
   LET g_isbf_m.isbfdocno = g_browser[g_current_idx].b_isbfdocno
 
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
       g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003, 
       g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid, 
       g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid, 
       g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp_desc, 
       g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
   
   #遮罩相關處理
   LET g_isbf_m_mask_o.* =  g_isbf_m.*
   CALL aist330_isbf_t_mask()
   LET g_isbf_m_mask_n.* =  g_isbf_m.*
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist330_set_act_visible()   
   CALL aist330_set_act_no_visible()
   
   #add-point:fetch段action控制 name="fetch.action_control"
   
   #end add-point  
   
   
   
   #add-point:fetch結束前 name="fetch.after"
   
   #end add-point
   
   #保存單頭舊值
   LET g_isbf_m_t.* = g_isbf_m.*
   LET g_isbf_m_o.* = g_isbf_m.*
   
   LET g_data_owner = g_isbf_m.isbfownid      
   LET g_data_dept  = g_isbf_m.isbfowndp
   
   #重新顯示   
   CALL aist330_show()
 
   
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.insert" >}
#+ 資料新增
PRIVATE FUNCTION aist330_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"
   
   #end add-point    
   #add-point:insert段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="insert.pre_function"
   
   #end add-point
   
   #清畫面欄位內容
   CLEAR FORM                    
   CALL g_isbg_d.clear()   
   CALL g_isbg2_d.clear()  
   CALL g_isbg3_d.clear()  
 
 
   INITIALIZE g_isbf_m.* TO NULL             #DEFAULT 設定
   
   LET g_isbfcomp_t = NULL
   LET g_isbfdocno_t = NULL
 
   
   LET g_master_insert = FALSE
   
   #add-point:insert段before name="insert.before"
   
   #end add-point    
   
   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_isbf_m.isbfownid = g_user
      LET g_isbf_m.isbfowndp = g_dept
      LET g_isbf_m.isbfcrtid = g_user
      LET g_isbf_m.isbfcrtdp = g_dept 
      LET g_isbf_m.isbfcrtdt = cl_get_current()
      LET g_isbf_m.isbfmodid = g_user
      LET g_isbf_m.isbfmoddt = cl_get_current()
      LET g_isbf_m.isbfstus = 'N'
 
 
 
 
      #append欄位給值
      
     
      #一般欄位給值
      
  
      #add-point:單頭預設值 name="insert.default"
      CALL s_aap_get_default_apcasite('1','','') RETURNING g_sub_success,g_errno,g_isbf_m.isbfsite,g_glaald,g_isbf_m.isbfcomp
      CALL s_ld_sel_glaa(g_glaald,'glaacomp|glaa001|glaa004|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa024|glaa121')
        RETURNING g_sub_success,g_glaa.*
      CALL s_desc_get_department_desc(g_isbf_m.isbfsite) RETURNING g_isbf_m.isbfsite_desc
      LET g_isbf_m.isbf001 = g_user
      LET g_isbf_m.isbfdocdt = g_today
      LET g_isbf_m.isbf002   = g_today
      LET g_ooef019 = NULL
      SELECT ooef019 INTO g_ooef019 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = g_isbf_m.isbfcomp
      
      INITIALIZE g_isai.* TO NULL
      SELECT * INTO g_isai.* FROM isai_t
       WHERE isaient = g_enterprise
         AND isai001 = g_ooef019
      CALL aist330_set_visible()
      CALL aist330_set_no_visible()
      #end add-point 
      
      #保存單頭舊值(用於資料輸入錯誤還原預設值時使用)
      LET g_isbf_m_t.* = g_isbf_m.*
      LET g_isbf_m_o.* = g_isbf_m.*
      
      #顯示狀態(stus)圖片
            #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_isbf_m.isbfstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         
      END CASE
 
 
 
    
      CALL aist330_input("a")
      
      #add-point:單頭輸入後 name="insert.after_insert"
      
      #end add-point
      
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code   = 9001 
         LET g_errparam.popup  = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
      END IF
      
      IF NOT g_master_insert THEN
         DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
         DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
         INITIALIZE g_isbf_m.* TO NULL
         INITIALIZE g_isbg_d TO NULL
         INITIALIZE g_isbg2_d TO NULL
         INITIALIZE g_isbg3_d TO NULL
 
         #add-point:取消新增後 name="insert.cancel"
         
         #end add-point 
         CALL aist330_show()
         RETURN
      END IF
      
      LET INT_FLAG = 0
      #CALL g_isbg_d.clear()
      #CALL g_isbg2_d.clear()
      #CALL g_isbg3_d.clear()
 
 
      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE
        
   END WHILE
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist330_set_act_visible()   
   CALL aist330_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_isbfcomp_t = g_isbf_m.isbfcomp
   LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " isbfent = " ||g_enterprise|| " AND",
                      " isbfcomp = '", g_isbf_m.isbfcomp, "' "
                      ," AND isbfdocno = '", g_isbf_m.isbfdocno, "' "
 
                      
   #add-point:組合新增資料的條件後 name="insert.after.add_browse"
   
   #end add-point
      
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL aist330_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   CLOSE aist330_cl
   
   CALL aist330_idx_chk()
   
   #撈取異動後的資料(主要是帶出reference)
   EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
       g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003, 
       g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid, 
       g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid, 
       g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp_desc, 
       g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
   
   
   #遮罩相關處理
   LET g_isbf_m_mask_o.* =  g_isbf_m.*
   CALL aist330_isbf_t_mask()
   LET g_isbf_m_mask_n.* =  g_isbf_m.*
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfsite_desc,g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc, 
       g_isbf_m.isbf001,g_isbf_m.isbf001_desc,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002, 
       g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfownid_desc, 
       g_isbf_m.isbfowndp,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp, 
       g_isbf_m.isbfcrtdp_desc,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmodid_desc,g_isbf_m.isbfmoddt, 
       g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfid_desc,g_isbf_m.isbfcnfdt
   
   #add-point:新增結束後 name="insert.after"
   
   #end add-point 
   
   LET g_data_owner = g_isbf_m.isbfownid      
   LET g_data_dept  = g_isbf_m.isbfowndp
   
   #功能已完成,通報訊息中心
   CALL aist330_msgcentre_notify('insert')
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.modify" >}
#+ 資料修改
PRIVATE FUNCTION aist330_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"
   
   #end add-point    
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   DEFINE l_wc2_table1          STRING
   DEFINE l_wc2_table2   STRING
 
   DEFINE l_wc2_table3   STRING
 
 
 
   #add-point:modify段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="modify.pre_function"
   
   #end add-point
   
   #保存單頭舊值
   LET g_isbf_m_t.* = g_isbf_m.*
   LET g_isbf_m_o.* = g_isbf_m.*
   
   IF g_isbf_m.isbfcomp IS NULL
   OR g_isbf_m.isbfdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   ERROR ""
  
   LET g_isbfcomp_t = g_isbf_m.isbfcomp
   LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
   CALL s_transaction_begin()
   
   OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aist330_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CLOSE aist330_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
       g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003, 
       g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid, 
       g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid, 
       g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp_desc, 
       g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
   
   #檢查是否允許此動作
   IF NOT aist330_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_isbf_m_mask_o.* =  g_isbf_m.*
   CALL aist330_isbf_t_mask()
   LET g_isbf_m_mask_n.* =  g_isbf_m.*
   
   
   
   #add-point:modify段show之前 name="modify.before_show"
   
   #end add-point  
   
   #LET l_wc2_table1 = g_wc2_table1
   #LET g_wc2_table1 = " 1=1"
   #LET l_wc2_table2 = g_wc2_table2
   #LET l_wc2_table2 = " 1=1"
 
   #LET l_wc2_table3 = g_wc2_table3
   #LET l_wc2_table3 = " 1=1"
 
 
 
   
   CALL aist330_show()
   #add-point:modify段show之後 name="modify.after_show"
   
   #end add-point
   
   #LET g_wc2_table1 = l_wc2_table1
   #LET  g_wc2_table2 = l_wc2_table2 
 
   #LET  g_wc2_table3 = l_wc2_table3 
 
 
 
    
   WHILE TRUE
      LET g_isbfcomp_t = g_isbf_m.isbfcomp
      LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
      
      #寫入修改者/修改日期資訊(單頭)
      LET g_isbf_m.isbfmodid = g_user 
LET g_isbf_m.isbfmoddt = cl_get_current()
LET g_isbf_m.isbfmodid_desc = cl_get_username(g_isbf_m.isbfmodid)
      
      #add-point:modify段修改前 name="modify.before_input"
      
      #end add-point
      
      #欄位更改
      LET g_loc = 'n'
      LET g_update = FALSE
      LET g_master_commit = "N"
      CALL aist330_input("u")
      LET g_loc = 'n'
 
      #add-point:modify段修改後 name="modify.after_input"
      
      #end add-point
      
      IF g_update OR NOT INT_FLAG THEN
         #若有modid跟moddt則進行update
         UPDATE isbf_t SET (isbfmodid,isbfmoddt) = (g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt)
          WHERE isbfent = g_enterprise AND isbfcomp = g_isbfcomp_t
            AND isbfdocno = g_isbfdocno_t
 
      END IF
    
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         #若單頭無commit則還原
         IF g_master_commit = "N" THEN
            LET g_isbf_m.* = g_isbf_m_t.*
            CALL aist330_show()
         END IF
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = '' 
         LET g_errparam.code   = 9001 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
         RETURN
      END IF 
                  
      #若單頭key欄位有變更
      IF g_isbf_m.isbfcomp != g_isbf_m_t.isbfcomp
      OR g_isbf_m.isbfdocno != g_isbf_m_t.isbfdocno
 
      THEN
         CALL s_transaction_begin()
         
         #add-point:單身fk修改前 name="modify.body.b_fk_update"
         
         #end add-point
         
         #更新單身key值
         UPDATE isbg_t SET isbgcomp = g_isbf_m.isbfcomp
                                       ,isbgdocno = g_isbf_m.isbfdocno
 
          WHERE isbgent = g_enterprise AND isbgcomp = g_isbf_m_t.isbfcomp
            AND isbgdocno = g_isbf_m_t.isbfdocno
 
            
         #add-point:單身fk修改中 name="modify.body.m_fk_update"
         
         #end add-point
 
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "isbg_t" 
            #   LET g_errparam.code   = "std-00009" 
            #   LET g_errparam.popup  = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isbg_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #add-point:單身fk修改後 name="modify.body.a_fk_update"
         
         #end add-point
         
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update2"
         
         #end add-point
         
         UPDATE isah_t
            SET isahcomp = g_isbf_m.isbfcomp
               ,isahdocno = g_isbf_m.isbfdocno
 
          WHERE isahent = g_enterprise AND
                isahcomp = g_isbfcomp_t
            AND isahdocno = g_isbfdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update2"
         
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "isah_t" 
            #   LET g_errparam.code   = "std-00009" 
            #   LET g_errparam.popup  = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update2"
         
         #end add-point
 
         #更新單身key值
         #add-point:單身fk修改前 name="modify.body.b_fk_update3"
         
         #end add-point
         
         UPDATE isat_t
            SET isatcomp = g_isbf_m.isbfcomp
               ,isatdocno = g_isbf_m.isbfdocno
 
          WHERE isatent = g_enterprise AND
                isatcomp = g_isbfcomp_t
            AND isatdocno = g_isbfdocno_t
 
         #add-point:單身fk修改中 name="modify.body.m_fk_update3"
         
         #end add-point
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "isat_t" 
            #   LET g_errparam.code   = "std-00009" 
            #   LET g_errparam.popup  = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         #add-point:單身fk修改後 name="modify.body.a_fk_update3"
         
         #end add-point
 
 
         
 
         
         #UPDATE 多語言table key值
         
         
         
 
         CALL s_transaction_end('Y','0')
      END IF
    
      EXIT WHILE
   END WHILE
 
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist330_set_act_visible()   
   CALL aist330_set_act_no_visible()
 
   #組合新增資料的條件
   LET g_add_browse = " isbfent = " ||g_enterprise|| " AND",
                      " isbfcomp = '", g_isbf_m.isbfcomp, "' "
                      ," AND isbfdocno = '", g_isbf_m.isbfdocno, "' "
 
   #填到對應位置
   CALL aist330_browser_fill("")
 
   CLOSE aist330_cl
   
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL aist330_msgcentre_notify('modify')
 
END FUNCTION 
 
{</section>}
 
{<section id="aist330.input" >}
#+ 資料輸入
PRIVATE FUNCTION aist330_input(p_cmd)
   #add-point:input段define(客製用) name="input.define_customerization"
   
   #end add-point  
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num10                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num10                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num10
   DEFINE  l_i                   LIKE type_t.num10
   DEFINE  l_ac_t                LIKE type_t.num10
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num10
   DEFINE  li_reproduce_target   LIKE type_t.num10
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   #add-point:input段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="input.define"
   DEFINE  l_changeb1            LIKE type_t.chr1
   DEFINE  l_changeb2            LIKE type_t.chr1
   DEFINE  l_changeb3            LIKE type_t.chr1
   DEFINE  l_isac003             LIKE isac_t.isac003
   
   #160106-00005#4-----s
   DEFINE l_count2               LIKE type_t.num10 
   DEFINE l_stdat                LIKE type_t.dat   
   #160106-00005#4-----e
   #end add-point  
   
   #add-point:Function前置處理  name="input.pre_function"
   
   #end add-point
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'
   ELSE
      LET l_cmd_t = p_cmd
   END IF   
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfsite_desc,g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc, 
       g_isbf_m.isbf001,g_isbf_m.isbf001_desc,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002, 
       g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfownid_desc, 
       g_isbf_m.isbfowndp,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp, 
       g_isbf_m.isbfcrtdp_desc,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmodid_desc,g_isbf_m.isbfmoddt, 
       g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfid_desc,g_isbf_m.isbfcnfdt
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql name="input.define_sql"
   
   #end add-point 
   LET g_forupd_sql = "SELECT isbgseq,isbg001,isbg002,isbg003,isbg004 FROM isbg_t WHERE isbgent=? AND  
       isbgcomp=? AND isbgdocno=? AND isbgseq=? FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql"
   
   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist330_bcl CURSOR FROM g_forupd_sql
   
   #add-point:input段define_sql name="input.define_sql2"
   
   #end add-point    
   LET g_forupd_sql = "SELECT isahseq,isahorga,isah003,isah004,isah013,isah005,isah006,isah101,isah103, 
       isah007,isah104,isah105,isah011,isah001,isah002,isah008,isah009,isah010,isah012,isah106,isah113, 
       isah114,isah115,isah116 FROM isah_t WHERE isahent=? AND isahcomp=? AND isahdocno=? AND isahseq=?  
       FOR UPDATE"
   #add-point:input段define_sql name="input.after_define_sql2"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist330_bcl2 CURSOR FROM g_forupd_sql
 
   #add-point:input段define_sql name="input.define_sql3"
   
   #end add-point    
   LET g_forupd_sql = "SELECT isatseq,isatsite,isat003,isat004,isat006,isat005,isat022,isat113,isat114, 
       isat115,isat103,isat104,isat105,isat007,isat014,isat025,isat106,isat107,isat017,isat001,isat002, 
       isat008,isat009,isat010,isat011,isat012,isat013,isat015,isat016,isat018,isat019,isat020,isat021, 
       isat023,isat024,isat100,isat101,isat201,isat202,isat203,isat204,isat205,isat206,isat207,isat208, 
       isat209,isatdocdt FROM isat_t WHERE isatent=? AND isatcomp=? AND isatdocno=? AND isatseq=? FOR  
       UPDATE"
   #add-point:input段define_sql name="input.after_define_sql3"
   
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE aist330_bcl3 CURSOR FROM g_forupd_sql
 
 
   
 
 
   #add-point:input段define_sql name="input.other_sql"
   
   #end add-point 
 
   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL aist330_set_entry(p_cmd)
   #add-point:set_entry後 name="input.after_set_entry"
   
   #end add-point
   CALL aist330_set_no_entry(p_cmd)
 
   DISPLAY BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt, 
       g_isbf_m.isbf002,g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus
   
   LET lb_reproduce = FALSE
   LET l_ac_t = 1
   
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
   
   #add-point:資料輸入前 name="input.before_input"
   
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
{</section>}
 
{<section id="aist330.input.head" >}
      #單頭段
      INPUT BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt, 
          g_isbf_m.isbf002,g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus 
         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION(master_input)
         
     
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist330_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE aist330_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            CALL aist330_set_entry(p_cmd)
            #add-point:資料輸入前 name="input.m.before_input"
            
            #end add-point
            CALL aist330_set_no_entry(p_cmd)
    
                  #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfsite
            
            #add-point:AFTER FIELD isbfsite name="input.a.isbfsite"
            LET g_isbf_m.isbfsite_desc = ''
            IF NOT cl_null(g_isbf_m.isbfsite) THEN
              #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isbf_m.isbfsite != g_isbf_m_t.isbfsite OR cl_null(g_isbf_m_t.isbfsite) )) THEN #161005-00003#2 mark
               IF g_isbf_m.isbfsite != g_isbf_m_o.isbfsite OR cl_null(g_isbf_m_o.isbfsite) THEN #161005-00003#2 add
                  #以目前的資料重展結構,避免[帳套]有值時會比對錯誤,在s_fin_account_center_with_ld_chk做勾稽時會依據這個結構做是否有符合的帳套
                  CALL s_fin_account_center_sons_query('3',g_isbf_m.isbfsite,g_isbf_m.isbfdocdt,'1')
                  CALL s_fin_account_center_with_ld_chk(g_isbf_m.isbfsite,'',g_user,'3','N','',g_isbf_m.isbfdocdt) RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                    #LET g_isbf_m.isbfsite = g_isbf_m_t.isbfsite #161005-00003#2 mark
                     LET g_isbf_m.isbfsite = g_isbf_m_o.isbfsite #161005-00003#2 add
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     CALL cl_err()
                     CALL s_fin_orga_get_comp_ld(g_isbf_m.isbfsite) RETURNING g_sub_success,g_errno,g_isbf_m.isbfcomp,g_glaald                     
                     CALL s_ld_sel_glaa(g_glaald,'glaacomp|glaa001|glaa004|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa024|glaa121')
                     RETURNING g_sub_success,g_glaa.*
                     CALL s_desc_get_department_desc(g_isbf_m.isbfsite) RETURNING g_isbf_m.isbfsite_desc #161005-00003#2 add
                     DISPLAY BY NAME g_isbf_m.isbfsite_desc                                              #161005-00003#2 add
                     NEXT FIELD isbfsite
                  END IF
               END IF
               
               CALL s_fin_account_center_sons_query('3',g_isbf_m.isbfsite,g_isbf_m.isbfdocdt,'1')
               CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
               CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
               CALL s_fin_account_center_ld_str() RETURNING g_wc_ld
               CALL s_fin_get_wc_str(g_wc_ld) RETURNING g_wc_ld
               CALL s_fin_account_center_comp_str()RETURNING g_wc_comp
               CALL s_fin_get_wc_str(g_wc_comp) RETURNING g_wc_comp
               #LET g_isbf_m_t.isbfsite = g_isbf_m.isbfsite #161005-00003#2 mark
            END IF
            CALL s_desc_get_department_desc(g_isbf_m.isbfsite) RETURNING g_isbf_m.isbfsite_desc                    
            DISPLAY BY NAME g_isbf_m.isbfsite_desc
            #161017-00005#1 --s add
            CALL s_fin_account_center_sons_query('3',g_isbf_m.isbfsite,g_isbf_m.isbfdocdt,'1')
            CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
            CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
            CALL s_fin_account_center_ld_str() RETURNING g_wc_ld
            CALL s_fin_get_wc_str(g_wc_ld) RETURNING g_wc_ld
            CALL s_fin_account_center_comp_str()RETURNING g_wc_comp
            CALL s_fin_get_wc_str(g_wc_comp) RETURNING g_wc_comp
            #161017-00005#1 --e add
            #LET g_isbf_m_t.isbfsite = g_isbf_m.isbfsite #161005-00003#2 mark
            LET g_isbf_m_o.* = g_isbf_m.* #161005-00003#2 add
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfsite
            #add-point:BEFORE FIELD isbfsite name="input.b.isbfsite"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbfsite
            #add-point:ON CHANGE isbfsite name="input.g.isbfsite"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfcomp
            
            #add-point:AFTER FIELD isbfcomp name="input.a.isbfcomp"
            #應用 a05 樣板自動產生(Version:2)
            LET g_isbf_m.isbfcomp_desc = ' '
            DISPLAY BY NAME g_isbf_m.isbfcomp_desc
            IF NOT cl_null(g_isbf_m.isbfcomp) THEN
              #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isbf_m.isbfcomp != g_isbf_m_t.isbfcomp OR g_isbf_m_t.isbfcomp IS NULL )) THEN #161005-00003#2 mark
               IF g_isbf_m.isbfcomp != g_isbf_m_o.isbfcomp OR cl_null(g_isbf_m_o.isbfcomp) THEN #161005-00003#2 add
                  #aooi100組織基本檢核
                  CALL aist330_ooef001_chk(g_isbf_m.isbfcomp)RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                    #LET g_isbf_m.isbfcomp = g_isbf_m_t.isbfcomp #161005-00003#2 mark
                     LET g_isbf_m.isbfcomp = g_isbf_m_o.isbfcomp #161005-00003#2 add
                    #LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m_t.isbfcomp) #161005-00003#2 mark
                     LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m.isbfcomp)   #161005-00003#2 add
                     DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc
                     NEXT FIELD CURRENT
                  END IF
                  
                  #g_wc_comp有無存在
                  IF NOT cl_null(g_isbf_m.isbfsite)THEN
                     CALL s_fin_account_center_comp_str()RETURNING g_wc_comp
                     CALL s_fin_get_wc_str(g_wc_comp) RETURNING g_wc_comp
                     IF s_chr_get_index_of(g_wc_comp,g_isbf_m.isbfcomp,1) = 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'aap-00034'
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                       #LET g_isbf_m.isbfcomp = g_isbf_m_t.isbfcomp #161005-00003#2 mark
                        LET g_isbf_m.isbfcomp = g_isbf_m_o.isbfcomp #161005-00003#2 add
                       #LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m_t.isbfcomp) #161005-00003#2 mark
                        LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m.isbfcomp)   #161005-00003#2 add
                        DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  
                  LET g_ooef019 = NULL
                  SELECT ooef019 INTO g_ooef019 FROM ooef_t
                   WHERE ooefent = g_enterprise
                     AND ooef001 = g_isbf_m.isbfcomp
                  
                  INITIALIZE g_isai.* TO NULL
                  SELECT * INTO g_isai.* FROM isai_t
                   WHERE isaient = g_enterprise
                     AND isai001 = g_ooef019
                  CALL aist330_set_visible()
                  CALL aist330_set_no_visible()
                  LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m.isbfcomp) #161005-00003#2 add
                  DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc                   #161005-00003#2 add
               END IF
            END IF
           #LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m_t.isbfcomp) #161005-00003#2 mark
            LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m.isbfcomp)   #161005-00003#2 add
            DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc         
            LET g_isbf_m_o.* = g_isbf_m.* #161005-00003#2 add
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfcomp
            #add-point:BEFORE FIELD isbfcomp name="input.b.isbfcomp"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbfcomp
            #add-point:ON CHANGE isbfcomp name="input.g.isbfcomp"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf001
            
            #add-point:AFTER FIELD isbf001 name="input.a.isbf001"
            #帳務人員
            LET g_isbf_m.isbf001_desc = ''
            IF NOT cl_null(g_isbf_m.isbf001) THEN
               IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isbf_m.isbf001 != g_isbf_m_t.isbf001 OR g_isbf_m_t.isbf001 IS NULL )) THEN
                  LET g_errno = ''
                  CALL s_employee_chk(g_isbf_m.isbf001) RETURNING g_sub_success
                  IF NOT g_sub_success THEN
                     LET g_isbf_m.isbf001 = g_isbf_m_t.isbf001
                     CALL s_desc_get_person_desc(g_isbf_m.isbf001) RETURNING g_isbf_m.isbf001_desc
                     DISPLAY BY NAME g_isbf_m.isbf001_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            CALL s_desc_get_person_desc(g_isbf_m.isbf001) RETURNING g_isbf_m.isbf001_desc
            DISPLAY BY NAME g_isbf_m.isbf001_desc   
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf001
            #add-point:BEFORE FIELD isbf001 name="input.b.isbf001"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbf001
            #add-point:ON CHANGE isbf001 name="input.g.isbf001"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfdocno
            #add-point:BEFORE FIELD isbfdocno name="input.b.isbfdocno"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfdocno
            
            #add-point:AFTER FIELD isbfdocno name="input.a.isbfdocno"
            IF NOT cl_null(g_isbf_m.isbfdocno) THEN 
               IF p_cmd = 'a' OR ( p_cmd = 'u' AND (cl_null(g_isbf_m_t.isbfdocno) OR g_isbf_m.isbfdocno != g_isbf_m_t.isbfdocno)) THEN 
                  IF NOT s_aooi200_fin_chk_docno(g_glaald,'','',g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_prog) THEN
                     LET g_isbf_m.isbfdocno = g_isbf_m_t.isbfdocno
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbfdocno
            #add-point:ON CHANGE isbfdocno name="input.g.isbfdocno"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfdocdt
            #add-point:BEFORE FIELD isbfdocdt name="input.b.isbfdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfdocdt
            
            #add-point:AFTER FIELD isbfdocdt name="input.a.isbfdocdt"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbfdocdt
            #add-point:ON CHANGE isbfdocdt name="input.g.isbfdocdt"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf002
            #add-point:BEFORE FIELD isbf002 name="input.b.isbf002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf002
            
            #add-point:AFTER FIELD isbf002 name="input.a.isbf002"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbf002
            #add-point:ON CHANGE isbf002 name="input.g.isbf002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf003
            #add-point:BEFORE FIELD isbf003 name="input.b.isbf003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf003
            
            #add-point:AFTER FIELD isbf003 name="input.a.isbf003"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbf003
            #add-point:ON CHANGE isbf003 name="input.g.isbf003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf004
            #add-point:BEFORE FIELD isbf004 name="input.b.isbf004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf004
            
            #add-point:AFTER FIELD isbf004 name="input.a.isbf004"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbf004
            #add-point:ON CHANGE isbf004 name="input.g.isbf004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbf005
            #add-point:BEFORE FIELD isbf005 name="input.b.isbf005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbf005
            
            #add-point:AFTER FIELD isbf005 name="input.a.isbf005"
            IF NOT cl_null(g_isbf_m.isbf005) THEN  
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL      
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_ooef019
               LET g_chkparam.arg2 = g_isbf_m.isbf005

               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_isac002_2") THEN
                  #檢查成功時後續處理
                  SELECT isac003 INTO l_isac003
                    FROM isac_t
                   WHERE isacent = g_enterprise
                     AND isac001 = g_ooef019
                     AND isac002 = g_isbf_m.isbf005
                  
                  IF l_isac003 <> '2' THEN 
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00157'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     
                     LET g_isbf_m.isbf005 = g_isbf_m_t.isbf005
                     NEXT FIELD CURRENT
                  END IF
                         
               ELSE
                  #檢查失敗時後續處理
                  LET g_isbf_m.isbf005 = g_isbf_m_t.isbf005
                  NEXT FIELD CURRENT
               END IF
            
            END IF 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbf005
            #add-point:ON CHANGE isbf005 name="input.g.isbf005"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbfstus
            #add-point:BEFORE FIELD isbfstus name="input.b.isbfstus"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbfstus
            
            #add-point:AFTER FIELD isbfstus name="input.a.isbfstus"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbfstus
            #add-point:ON CHANGE isbfstus name="input.g.isbfstus"
            
            #END add-point 
 
 
 #欄位檢查
                  #Ctrlp:input.c.isbfsite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfsite
            #add-point:ON ACTION controlp INFIELD isbfsite name="input.c.isbfsite"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbf_m.isbfsite                 
            #CALL q_ooba002_1()   #161006-00005#15   mark
            CALL q_ooef001_46()   #161006-00005#15   add
            LET g_isbf_m.isbfsite = g_qryparam.return1    
            DISPLAY BY NAME g_isbf_m.isbfsite
            CALL s_desc_get_department_desc(g_isbf_m.isbfsite) RETURNING g_isbf_m.isbfsite_desc                    
            DISPLAY BY NAME g_isbf_m.isbfsite_desc
            NEXT FIELD isbfsite
            #END add-point
 
 
         #Ctrlp:input.c.isbfcomp
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfcomp
            #add-point:ON ACTION controlp INFIELD isbfcomp name="input.c.isbfcomp"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbf_m.isbfcomp               
            LET g_qryparam.where = "ooef001 IN ",g_wc_comp,
                                   " AND ooef003 = 'Y'"   #161006-00005#15   add
            #CALL q_ooba002_1()   #161006-00005#15   mark
            CALL q_ooef001()      #161006-00005#15   add
            LET g_isbf_m.isbfcomp = g_qryparam.return1    
            DISPLAY BY NAME g_isbf_m.isbfcomp
            LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m_t.isbfcomp)
            DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc 
            NEXT FIELD isbfcomp
            #END add-point
 
 
         #Ctrlp:input.c.isbf001
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf001
            #add-point:ON ACTION controlp INFIELD isbf001 name="input.c.isbf001"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbf_m.isbf001
            CALL q_ooag001_8()
            LET g_isbf_m.isbf001 = g_qryparam.return1
            CALL s_desc_get_person_desc(g_isbf_m.isbf001) RETURNING g_isbf_m.isbf001_desc
            DISPLAY BY NAME g_isbf_m.isbf001,g_isbf_m.isbf001_desc
            CALL s_desc_get_person_desc(g_isbf_m.isbf001) RETURNING g_isbf_m.isbf001_desc
            DISPLAY BY NAME g_isbf_m.isbf001_desc 
            NEXT FIELD isbf001
            #END add-point
 
 
         #Ctrlp:input.c.isbfdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfdocno
            #add-point:ON ACTION controlp INFIELD isbfdocno name="input.c.isbfdocno"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbf_m.isbfdocno                 
            LET g_qryparam.arg1 = g_glaa.glaa024
            LET g_qryparam.arg2 = g_prog
            CALL q_ooba002_1()
            LET g_isbf_m.isbfdocno = g_qryparam.return1    
            DISPLAY BY NAME g_isbf_m.isbfdocno
            NEXT FIELD isbfdocno                         
            #END add-point
 
 
         #Ctrlp:input.c.isbfdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfdocdt
            #add-point:ON ACTION controlp INFIELD isbfdocdt name="input.c.isbfdocdt"
            
            #END add-point
 
 
         #Ctrlp:input.c.isbf002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf002
            #add-point:ON ACTION controlp INFIELD isbf002 name="input.c.isbf002"
            
            #END add-point
 
 
         #Ctrlp:input.c.isbf003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf003
            #add-point:ON ACTION controlp INFIELD isbf003 name="input.c.isbf003"
            
            #END add-point
 
 
         #Ctrlp:input.c.isbf004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf004
            #add-point:ON ACTION controlp INFIELD isbf004 name="input.c.isbf004"
            
            #END add-point
 
 
         #Ctrlp:input.c.isbf005
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbf005
            #add-point:ON ACTION controlp INFIELD isbf005 name="input.c.isbf005"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbf_m.isbf005
            LET g_qryparam.where = "     isac001 = '",g_ooef019,"'",
                                      " AND isac003 = '2'"
            CALL q_isac002()                                #呼叫開窗
            LET g_isbf_m.isbf005 = g_qryparam.return1              #將開窗取得的值回傳到變數
            DISPLAY g_isbf_m.isbf005 TO isbf005
            NEXT FIELD isbf005
            #END add-point
 
 
         #Ctrlp:input.c.isbfstus
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbfstus
            #add-point:ON ACTION controlp INFIELD isbfstus name="input.c.isbfstus"
            
            #END add-point
 
 
 #欄位開窗
            
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
 
            #CALL cl_err_collect_show()      #錯誤訊息統整顯示
            #CALL cl_showmsg()
            DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
                        
            #add-point:單頭INPUT後 name="input.head.after_input"
            
            #end add-point
                        
            IF p_cmd <> 'u' THEN
    
               CALL s_transaction_begin()
               
               #add-point:單頭新增前 name="input.head.b_insert"
               CALL s_aooi200_fin_gen_docno(g_glaald,'','',g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_prog)
                    RETURNING g_sub_success,g_isbf_m.isbfdocno
               IF NOT g_sub_success THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'apm-00003'
                  LET g_errparam.extend = g_isbf_m.isbfdocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CALL s_transaction_end('N','0')
                  NEXT FIELD isbfdocno
               END IF
               DISPLAY BY NAME g_isbf_m.isbfdocno
               #end add-point
               
               INSERT INTO isbf_t (isbfent,isbfsite,isbfcomp,isbf001,isbfdocno,isbfdocdt,isbf002,isbf003, 
                   isbf004,isbf005,isbfstus,isbfownid,isbfowndp,isbfcrtid,isbfcrtdp,isbfcrtdt,isbfmodid, 
                   isbfmoddt,isbfcnfid,isbfcnfdt)
               VALUES (g_enterprise,g_isbf_m.isbfsite,g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno, 
                   g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005, 
                   g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtdp, 
                   g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfdt)  
 
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "g_isbf_m:",SQLERRMESSAGE 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭新增中 name="input.head.m_insert"
               
               #end add-point
               
               
               
               
               #add-point:單頭新增後 name="input.head.a_insert"
               
               #end add-point
               CALL s_transaction_end('Y','0') 
               
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL aist330_detail_reproduce()
                  #因應特定程式需求, 重新刷新單身資料
                  CALL aist330_b_fill()
                  CALL aist330_b_fill2('0')
               END IF
               
               #add-point:單頭新增後 name="input.head.a_insert2"
               
               #end add-point
               
               LET g_master_insert = TRUE
               
               LET p_cmd = 'u'
            ELSE
               CALL s_transaction_begin()
            
               #add-point:單頭修改前 name="input.head.b_update"
               
               #end add-point
               
               #將遮罩欄位還原
               CALL aist330_isbf_t_mask_restore('restore_mask_o')
               
               UPDATE isbf_t SET (isbfsite,isbfcomp,isbf001,isbfdocno,isbfdocdt,isbf002,isbf003,isbf004, 
                   isbf005,isbfstus,isbfownid,isbfowndp,isbfcrtid,isbfcrtdp,isbfcrtdt,isbfmodid,isbfmoddt, 
                   isbfcnfid,isbfcnfdt) = (g_isbf_m.isbfsite,g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno, 
                   g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005, 
                   g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtdp, 
                   g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfdt) 
 
                WHERE isbfent = g_enterprise AND isbfcomp = g_isbfcomp_t
                  AND isbfdocno = g_isbfdocno_t
 
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "isbf_t:",SQLERRMESSAGE 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭修改中 name="input.head.m_update"
               
               #end add-point
               
               
               
               
               #將遮罩欄位進行遮蔽
               CALL aist330_isbf_t_mask_restore('restore_mask_n')
               
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_isbf_m_t)
               LET g_log2 = util.JSON.stringify(g_isbf_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
               
               #add-point:單頭修改後 name="input.head.a_update"
               
               #end add-point
            END IF
            
            LET g_master_commit = "Y"
            LET g_isbfcomp_t = g_isbf_m.isbfcomp
            LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
            
      END INPUT
   
 
{</section>}
 
{<section id="aist330.input.body" >}
   
      #Page1 預設值產生於此處
      INPUT ARRAY g_isbg_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isbg_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist330_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
            END IF
            LET g_loc = 'm'
            LET g_rec_b = g_isbg_d.getLength()
            #add-point:資料輸入前 name="input.d.before_input"
            LET l_changeb1 = 'N'
            #end add-point
         
         BEFORE ROW
            #add-point:modify段before row2 name="input.body.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_detail_idx_list[1] = l_ac
            LET g_current_page = 1
            
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist330_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE aist330_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isbg_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isbg_d[l_ac].isbgseq IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_isbg_d_t.* = g_isbg_d[l_ac].*  #BACKUP
               LET g_isbg_d_o.* = g_isbg_d[l_ac].*  #BACKUP
               CALL aist330_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body.after_set_entry_b"
               
               #end add-point  
               CALL aist330_set_no_entry_b(l_cmd)
               IF NOT aist330_lock_b("isbg_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist330_bcl INTO g_isbg_d[l_ac].isbgseq,g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002, 
                      g_isbg_d[l_ac].isbg003,g_isbg_d[l_ac].isbg004
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_isbg_d_t.isbgseq,":",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isbg_d_mask_o[l_ac].* =  g_isbg_d[l_ac].*
                  CALL aist330_isbg_t_mask()
                  LET g_isbg_d_mask_n[l_ac].* =  g_isbg_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist330_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body.before_row"
            CALL aist330_source_carry(g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isai.isai002)
               RETURNING g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                         g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                         g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                         g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                         g_isbg_d[l_ac].l_isat023,
                         #160106-00005#4-----s
                         g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                         #160106-00005#4-----e
            DISPLAY BY NAME g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                         g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                         g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                         g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                         g_isbg_d[l_ac].l_isat023,
                         #160106-00005#4-----s
                         g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                         #160106-00005#4-----e
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
        
         BEFORE INSERT  
            
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isbg_d[l_ac].* TO NULL 
            INITIALIZE g_isbg_d_t.* TO NULL 
            INITIALIZE g_isbg_d_o.* TO NULL 
            #公用欄位給值(單身)
            
            #自定義預設值
                  LET g_isbg_d[l_ac].isbgseq = "0"
      LET g_isbg_d[l_ac].l_isat113 = "0"
      LET g_isbg_d[l_ac].l_isat114 = "0"
      LET g_isbg_d[l_ac].l_isat115 = "0"
 
            #add-point:modify段before備份 name="input.body.insert.before_bak"
            IF g_isai.isai002 = '1' THEN
               LET g_isbg_d[l_ac].isbg001 = ' '
            END IF
            
            LET g_isbg_d[l_ac].isbgseq = NULL
            SELECT MAX(isbgseq)+1 INTO g_isbg_d[l_ac].isbgseq 
              FROM isbg_t
             WHERE isbgent = g_enterprise
               AND isbgcomp = g_isbf_m.isbfcomp
               AND isbgdocno = g_isbf_m.isbfdocno
            IF cl_null(g_isbg_d[l_ac].isbgseq)THEN LET g_isbg_d[l_ac].isbgseq = 1 END IF
            
         
            #end add-point
            LET g_isbg_d_t.* = g_isbg_d[l_ac].*     #新輸入資料
            LET g_isbg_d_o.* = g_isbg_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist330_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body.insert.after_set_entry_b"
            
            #end add-point
            CALL aist330_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isbg_d[li_reproduce_target].* = g_isbg_d[li_reproduce].*
 
               LET g_isbg_d[li_reproduce_target].isbgseq = NULL
 
            END IF
            
 
            #add-point:modify段before insert name="input.body.before_insert"
            
            #end add-point  
  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身新增 name="input.body.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM isbg_t 
             WHERE isbgent = g_enterprise AND isbgcomp = g_isbf_m.isbfcomp
               AND isbgdocno = g_isbf_m.isbfdocno
 
               AND isbgseq = g_isbg_d[l_ac].isbgseq
 
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身新增前 name="input.body.b_insert"
               
               #end add-point
            
               #同步新增到同層的table
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isbf_m.isbfcomp
               LET gs_keys[2] = g_isbf_m.isbfdocno
               LET gs_keys[3] = g_isbg_d[g_detail_idx].isbgseq
               CALL aist330_insert_b('isbg_t',gs_keys,"'1'")
                           
               #add-point:單身新增後 name="input.body.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               INITIALIZE g_isbg_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isbg_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist330_b_fill()
               #資料多語言用-增/改
               
               #add-point:input段-after_insert name="input.body.a_insert2"
               LET l_changeb1 = 'Y'
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
              
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身刪除後(=d) name="input.body.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身刪除前 name="input.body.b_delete"
               
               #end add-point 
               
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isbf_m.isbfcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isbf_m.isbfdocno
 
               LET gs_keys[gs_keys.getLength()+1] = g_isbg_d_t.isbgseq
 
            
               #刪除同層單身
               IF NOT aist330_delete_b('isbg_t',gs_keys,"'1'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist330_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist330_key_delete_b(gs_keys,'isbg_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist330_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身刪除中 name="input.body.m_delete"
               LET l_changeb1 = 'Y'
               #end add-point 
               
               CALL s_transaction_end('Y','0')
               CLOSE aist330_bcl
            
               LET g_rec_b = g_rec_b-1
               #add-point:單身刪除後 name="input.body.a_delete"
               
               #end add-point
               LET l_count = g_isbg_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body.after_delete"
               
               #end add-point
            END IF
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isbg_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbgseq
            #add-point:BEFORE FIELD isbgseq name="input.b.page1.isbgseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbgseq
            
            #add-point:AFTER FIELD isbgseq name="input.a.page1.isbgseq"
            #應用 a05 樣板自動產生(Version:2)
            #確認資料無重複
            IF  g_isbf_m.isbfcomp IS NOT NULL AND g_isbf_m.isbfdocno IS NOT NULL AND g_isbg_d[g_detail_idx].isbgseq IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isbf_m.isbfcomp != g_isbfcomp_t OR g_isbf_m.isbfdocno != g_isbfdocno_t OR g_isbg_d[g_detail_idx].isbgseq != g_isbg_d_t.isbgseq)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isbg_t WHERE "||"isbgent = '" ||g_enterprise|| "' AND "||"isbgcomp = '"||g_isbf_m.isbfcomp ||"' AND "|| "isbgdocno = '"||g_isbf_m.isbfdocno ||"' AND "|| "isbgseq = '"||g_isbg_d[g_detail_idx].isbgseq ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbgseq
            #add-point:ON CHANGE isbgseq name="input.g.page1.isbgseq"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg001
            #add-point:BEFORE FIELD isbg001 name="input.b.page1.isbg001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg001
            
            #add-point:AFTER FIELD isbg001 name="input.a.page1.isbg001"
            IF NOT cl_null(g_isbg_d[l_ac].isbg001) THEN
              #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isbg_d[l_ac].isbg001 != g_isbg_d_t.isbg001 OR g_isbg_d_t.isbg001 IS NULL )) THEN #161005-00003#2 mark
               IF g_isbg_d[l_ac].isbg001 != g_isbg_d_o.isbg001 OR cl_null(g_isbg_d_o.isbg001) THEN #161005-00003#2 add
                  IF NOT cl_null(g_isbg_d[l_ac].isbg002)THEN
                     CALL aist330_isbg001_002_chk(g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isbf_m.isbfcomp,g_isai.isai002)RETURNING g_sub_success,g_errno
                    
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                       #LET g_isbg_d[l_ac].isbg001 = g_isbg_d_t.isbg001 #161005-00003#2 mark
                        LET g_isbg_d[l_ac].isbg001 = g_isbg_d_o.isbg001 #161005-00003#2 add
                        DISPLAY BY NAME g_isbg_d[l_ac].isbg001
                        NEXT FIELD CURRENT
                     END IF
                     
#                     #取稅率檢核
#                     CALL aist330_isbg001_002_chk2(l_ac,g_isai.isai002)RETURNING g_sub_success,g_errno
#                     IF NOT g_sub_success THEN
#                        INITIALIZE g_errparam TO NULL
#                        LET g_errparam.code = g_errno
#                        LET g_errparam.extend = ''
#                        LET g_errparam.popup = TRUE
#                        CALL cl_err()
#                        LET g_isbg_d[l_ac].isbg001 = g_isbg_d_t.isbg001
#                        DISPLAY BY NAME g_isbg_d[l_ac].isbg001
#                        NEXT FIELD CURRENT
#                     END IF                     
                     #161005-00003#2 --s add
                     LET g_isbg_d[l_ac].l_isat001   = ''
                     LET g_isbg_d[l_ac].l_isat005   = ''
                     LET g_isbg_d[l_ac].l_isat113   = ''
                     LET g_isbg_d[l_ac].l_isat114   = ''
                     LET g_isbg_d[l_ac].l_isat115   = ''
                     LET g_isbg_d[l_ac].l_isat007   = ''
                     LET g_isbg_d[l_ac].l_isat010   = ''
                     LET g_isbg_d[l_ac].isbg003     = ''
                     LET g_isbg_d[l_ac].l_isat023   = ''
                     LET g_isbg_d[l_ac].isbg004     = ''
                     LET g_isbg_d[l_ac].l_isafdocdt = ''
                     #161005-00003#2 --e add
                     CALL aist330_source_carry(g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isai.isai002)
                        RETURNING g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                                  g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                                  g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                                  g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                                  g_isbg_d[l_ac].l_isat023,
                                  #160106-00005#4-----s
                                  g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                                  #160106-00005#4-----e
                     DISPLAY BY NAME g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                                  g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                                  g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                                  g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                                  g_isbg_d[l_ac].l_isat023,
                                  #160106-00005#4-----s
                                  g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                                  #160106-00005#4-----e
                  END IF
               END IF
            END IF
            LET g_isbg_d_o.* = g_isbg_d[l_ac].* #161005-00003#2 add
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbg001
            #add-point:ON CHANGE isbg001 name="input.g.page1.isbg001"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg002
            #add-point:BEFORE FIELD isbg002 name="input.b.page1.isbg002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg002
            
            #add-point:AFTER FIELD isbg002 name="input.a.page1.isbg002"
            IF NOT cl_null(g_isbg_d[l_ac].isbg002) THEN
              #IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_isbg_d[l_ac].isbg002 != g_isbg_d_t.isbg002 OR g_isbg_d_t.isbg002 IS NULL )) THEN #161005-00003#2 mark
               IF g_isbg_d[l_ac].isbg002 != g_isbg_d_o.isbg002 OR cl_null(g_isbg_d_o.isbg002) THEN  #161005-00003#2 add
                  IF g_isbg_d[l_ac].isbg001 IS NOT NULL THEN
                     CALL aist330_isbg001_002_chk(g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isbf_m.isbfcomp,g_isai.isai002)RETURNING g_sub_success,g_errno
                    
                     IF NOT g_sub_success THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = g_errno
                        LET g_errparam.extend = ''
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                       #LET g_isbg_d[l_ac].isbg002 = g_isbg_d_t.isbg002 #161005-00003#2 mark
                        LET g_isbg_d[l_ac].isbg002 = g_isbg_d_o.isbg002 #161005-00003#2 add
                        DISPLAY BY NAME g_isbg_d[l_ac].isbg002
                        NEXT FIELD CURRENT
                     END IF
                     
#                     #取稅率檢核
#                     CALL aist330_isbg001_002_chk2(l_ac,g_isai.isai002)RETURNING g_sub_success,g_errno
#                     IF NOT g_sub_success THEN
#                        INITIALIZE g_errparam TO NULL
#                        LET g_errparam.code = g_errno
#                        LET g_errparam.extend = ''
#                        LET g_errparam.popup = TRUE
#                        CALL cl_err()
#                        LET g_isbg_d[l_ac].isbg002 = g_isbg_d_t.isbg002
#                        DISPLAY BY NAME g_isbg_d[l_ac].isbg002
#                        NEXT FIELD CURRENT
#                     END IF
                     #161005-00003#2 --s add
                     LET g_isbg_d[l_ac].l_isat001   = ''
                     LET g_isbg_d[l_ac].l_isat005   = ''
                     LET g_isbg_d[l_ac].l_isat113   = ''
                     LET g_isbg_d[l_ac].l_isat114   = ''
                     LET g_isbg_d[l_ac].l_isat115   = ''
                     LET g_isbg_d[l_ac].l_isat007   = ''
                     LET g_isbg_d[l_ac].l_isat010   = ''
                     LET g_isbg_d[l_ac].isbg003     = ''
                     LET g_isbg_d[l_ac].l_isat023   = ''
                     LET g_isbg_d[l_ac].isbg004     = ''
                     LET g_isbg_d[l_ac].l_isafdocdt = ''
                     #161005-00003#2 --e add
                     CALL aist330_source_carry(g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isai.isai002)
                        RETURNING g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                                  g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                                  g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                                  g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                                  g_isbg_d[l_ac].l_isat023,
                                  #160106-00005#4-----s
                                  g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                                  #160106-00005#4-----e
                     DISPLAY BY NAME g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                                  g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                                  g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                                  g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                                  g_isbg_d[l_ac].l_isat023,
                                  #160106-00005#4-----s
                                  g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                                  #160106-00005#4-----e
                  END IF
               END IF
            END IF
            LET g_isbg_d_o.* = g_isbg_d[l_ac].* #161005-00003#2 add
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbg002
            #add-point:ON CHANGE isbg002 name="input.g.page1.isbg002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat001
            #add-point:BEFORE FIELD l_isat001 name="input.b.page1.l_isat001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat001
            
            #add-point:AFTER FIELD l_isat001 name="input.a.page1.l_isat001"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat001
            #add-point:ON CHANGE l_isat001 name="input.g.page1.l_isat001"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat005
            #add-point:BEFORE FIELD l_isat005 name="input.b.page1.l_isat005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat005
            
            #add-point:AFTER FIELD l_isat005 name="input.a.page1.l_isat005"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat005
            #add-point:ON CHANGE l_isat005 name="input.g.page1.l_isat005"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat113
            #add-point:BEFORE FIELD l_isat113 name="input.b.page1.l_isat113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat113
            
            #add-point:AFTER FIELD l_isat113 name="input.a.page1.l_isat113"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat113
            #add-point:ON CHANGE l_isat113 name="input.g.page1.l_isat113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat023
            #add-point:BEFORE FIELD l_isat023 name="input.b.page1.l_isat023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat023
            
            #add-point:AFTER FIELD l_isat023 name="input.a.page1.l_isat023"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat023
            #add-point:ON CHANGE l_isat023 name="input.g.page1.l_isat023"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat114
            #add-point:BEFORE FIELD l_isat114 name="input.b.page1.l_isat114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat114
            
            #add-point:AFTER FIELD l_isat114 name="input.a.page1.l_isat114"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat114
            #add-point:ON CHANGE l_isat114 name="input.g.page1.l_isat114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat115
            #add-point:BEFORE FIELD l_isat115 name="input.b.page1.l_isat115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat115
            
            #add-point:AFTER FIELD l_isat115 name="input.a.page1.l_isat115"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat115
            #add-point:ON CHANGE l_isat115 name="input.g.page1.l_isat115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat007
            #add-point:BEFORE FIELD l_isat007 name="input.b.page1.l_isat007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat007
            
            #add-point:AFTER FIELD l_isat007 name="input.a.page1.l_isat007"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat007
            #add-point:ON CHANGE l_isat007 name="input.g.page1.l_isat007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isat010
            #add-point:BEFORE FIELD l_isat010 name="input.b.page1.l_isat010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isat010
            
            #add-point:AFTER FIELD l_isat010 name="input.a.page1.l_isat010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isat010
            #add-point:ON CHANGE l_isat010 name="input.g.page1.l_isat010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg003
            #add-point:BEFORE FIELD isbg003 name="input.b.page1.isbg003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg003
            
            #add-point:AFTER FIELD isbg003 name="input.a.page1.isbg003"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbg003
            #add-point:ON CHANGE isbg003 name="input.g.page1.isbg003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isbg004
            #add-point:BEFORE FIELD isbg004 name="input.b.page1.isbg004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isbg004
            
            #add-point:AFTER FIELD isbg004 name="input.a.page1.isbg004"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isbg004
            #add-point:ON CHANGE isbg004 name="input.g.page1.isbg004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isafdocdt
            #add-point:BEFORE FIELD l_isafdocdt name="input.b.page1.l_isafdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isafdocdt
            
            #add-point:AFTER FIELD l_isafdocdt name="input.a.page1.l_isafdocdt"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isafdocdt
            #add-point:ON CHANGE l_isafdocdt name="input.g.page1.l_isafdocdt"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page1.isbgseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbgseq
            #add-point:ON ACTION controlp INFIELD isbgseq name="input.c.page1.isbgseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isbg001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg001
            #add-point:ON ACTION controlp INFIELD isbg001 name="input.c.page1.isbg001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isbg002
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg002
            #add-point:ON ACTION controlp INFIELD isbg002 name="input.c.page1.isbg002"
            #160106-00005#4-----s
            LET l_stdat = MDY(1,1,YEAR(g_isbf_m.isbfdocdt))
            #160106-00005#4-----e

            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbg_d[l_ac].isbg002
            LET g_qryparam.where = "isat014 IN ('11') ",
                                   " AND EXISTS (SELECT 1 FROM isaf_t WHERE isafent = isatent AND isafcomp = isatcomp ",
                                   "                AND isafdocno = isatdocno AND isafstus = 'Y' AND isaf056 = '1' ",
                                   "                AND isafdocdt BETWEEN '",l_stdat,"' AND '",g_isbf_m.isbfdocdt,"' ",   #160106-00005#4 add
                                   ") "
                                   
            CALL q_isat004()
            LET g_isbg_d[l_ac].isbg002 = g_qryparam.return1
            DISPLAY BY NAME g_isbg_d[l_ac].isbg002
            NEXT FIELD isbg002
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat001
            #add-point:ON ACTION controlp INFIELD l_isat001 name="input.c.page1.l_isat001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat005
            #add-point:ON ACTION controlp INFIELD l_isat005 name="input.c.page1.l_isat005"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat113
            #add-point:ON ACTION controlp INFIELD l_isat113 name="input.c.page1.l_isat113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat023
            #add-point:ON ACTION controlp INFIELD l_isat023 name="input.c.page1.l_isat023"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat114
            #add-point:ON ACTION controlp INFIELD l_isat114 name="input.c.page1.l_isat114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat115
            #add-point:ON ACTION controlp INFIELD l_isat115 name="input.c.page1.l_isat115"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat007
            #add-point:ON ACTION controlp INFIELD l_isat007 name="input.c.page1.l_isat007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isat010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isat010
            #add-point:ON ACTION controlp INFIELD l_isat010 name="input.c.page1.l_isat010"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isbg003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg003
            #add-point:ON ACTION controlp INFIELD isbg003 name="input.c.page1.isbg003"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.isbg004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isbg004
            #add-point:ON ACTION controlp INFIELD isbg004 name="input.c.page1.isbg004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page1.l_isafdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isafdocdt
            #add-point:ON ACTION controlp INFIELD l_isafdocdt name="input.c.page1.l_isafdocdt"
            
            #END add-point
 
 
 
 
         ON ROW CHANGE
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isbg_d[l_ac].* = g_isbg_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE aist330_bcl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
              
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = g_isbg_d[l_ac].isbgseq 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_isbg_d[l_ac].* = g_isbg_d_t.*
            ELSE
            
               #add-point:單身修改前 name="input.body.b_update"
               
               #end add-point
               
               #寫入修改者/修改日期資訊(單身)
               
      
               #將遮罩欄位還原
               CALL aist330_isbg_t_mask_restore('restore_mask_o')
      
               UPDATE isbg_t SET (isbgcomp,isbgdocno,isbgseq,isbg001,isbg002,isbg003,isbg004) = (g_isbf_m.isbfcomp, 
                   g_isbf_m.isbfdocno,g_isbg_d[l_ac].isbgseq,g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002, 
                   g_isbg_d[l_ac].isbg003,g_isbg_d[l_ac].isbg004)
                WHERE isbgent = g_enterprise AND isbgcomp = g_isbf_m.isbfcomp 
                  AND isbgdocno = g_isbf_m.isbfdocno 
 
                  AND isbgseq = g_isbg_d_t.isbgseq #項次   
 
                  
               #add-point:單身修改中 name="input.body.m_update"
               LET l_changeb1 = 'Y'
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isbg_d[l_ac].* = g_isbg_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isbg_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_isbg_d[l_ac].* = g_isbg_d_t.*  
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isbg_t:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()                   
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isbf_m.isbfcomp
               LET gs_keys_bak[1] = g_isbfcomp_t
               LET gs_keys[2] = g_isbf_m.isbfdocno
               LET gs_keys_bak[2] = g_isbfdocno_t
               LET gs_keys[3] = g_isbg_d[g_detail_idx].isbgseq
               LET gs_keys_bak[3] = g_isbg_d_t.isbgseq
               CALL aist330_update_b('isbg_t',gs_keys,gs_keys_bak,"'1'")
               END CASE
 
               #將遮罩欄位進行遮蔽
               CALL aist330_isbg_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT(g_isbg_d[g_detail_idx].isbgseq = g_isbg_d_t.isbgseq 
 
                  ) THEN
                  LET gs_keys[01] = g_isbf_m.isbfcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isbf_m.isbfdocno
 
                  LET gs_keys[gs_keys.getLength()+1] = g_isbg_d_t.isbgseq
 
                  CALL aist330_key_update_b(gs_keys,'isbg_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isbf_m),util.JSON.stringify(g_isbg_d_t)
               LET g_log2 = util.JSON.stringify(g_isbf_m),util.JSON.stringify(g_isbg_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身修改後 name="input.body.a_update"
               
               #end add-point
 
            END IF
            
         AFTER ROW
            #add-point:單身after_row name="input.body.after_row"
            
            #end add-point
            CALL aist330_unlock_b("isbg_t","'1'")
            CALL s_transaction_end('Y','0')
            #其他table進行unlock
            #add-point:單身after_row2 name="input.body.after_row2"
            
            #end add-point
              
         AFTER INPUT
            #add-point:input段after input  name="input.body.after_input"
            IF l_changeb1 = 'Y' THEN
               CALL aist330_autoins_isah()
            END IF
            #end add-point 
    
         ON ACTION controlo    
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isbg_d[li_reproduce_target].* = g_isbg_d[li_reproduce].*
 
               LET g_isbg_d[li_reproduce_target].isbgseq = NULL
 
            ELSE
               CALL FGL_SET_ARR_CURR(g_isbg_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isbg_d.getLength()+1
            END IF
            
         #ON ACTION cancel
         #   LET INT_FLAG = 1
         #   LET g_detail_idx = 1
         #   EXIT DIALOG 
 
      END INPUT
      
      INPUT ARRAY g_isbg2_d FROM s_detail2.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)
                 
         #自訂ACTION(detail_input,page_2)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body2.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isbg2_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist330_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isbg2_d.getLength()
            #add-point:資料輸入前 name="input.body2.before_input"
            LET l_changeb2 = 'N'
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isbg2_d[l_ac].* TO NULL 
            INITIALIZE g_isbg2_d_t.* TO NULL 
            INITIALIZE g_isbg2_d_o.* TO NULL 
            #公用欄位給值(單身2)
            
            #自定義預設值(單身2)
                  LET g_isbg2_d[l_ac].isah006 = "0"
      LET g_isbg2_d[l_ac].isah101 = "0"
      LET g_isbg2_d[l_ac].isah103 = "0"
      LET g_isbg2_d[l_ac].isah104 = "0"
      LET g_isbg2_d[l_ac].isah105 = "0"
      LET g_isbg2_d[l_ac].isah011 = "0"
      LET g_isbg2_d[l_ac].isah106 = "0"
      LET g_isbg2_d[l_ac].isah113 = "0"
      LET g_isbg2_d[l_ac].isah114 = "0"
      LET g_isbg2_d[l_ac].isah115 = "0"
      LET g_isbg2_d[l_ac].isah116 = "0"
 
            #add-point:modify段before備份 name="input.body2.insert.before_bak"
            
            #end add-point
            LET g_isbg2_d_t.* = g_isbg2_d[l_ac].*     #新輸入資料
            LET g_isbg2_d_o.* = g_isbg2_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist330_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body2.insert.after_set_entry_b"
            
            #end add-point
            CALL aist330_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isbg2_d[li_reproduce_target].* = g_isbg2_d[li_reproduce].*
 
               LET g_isbg2_d[li_reproduce_target].isahseq = NULL
            END IF
            
 
            #add-point:modify段before insert name="input.body2.before_insert"
            IF cl_null(g_isbg2_d[g_detail_idx].isahseq) THEN 
               SELECT MAX(isahseq) + 1 INTO g_isbg2_d[g_detail_idx].isahseq
                 FROM isah_t
                WHERE isahent = g_enterprise
                  AND isahcomp = g_isbf_m.isbfcomp
                  AND isahdocno = g_isbf_m.isbfdocno
                  
               IF cl_null(g_isbg2_d[g_detail_idx].isahseq) THEN 
                  LET g_isbg2_d[g_detail_idx].isahseq = 1
               END IF
            END IF
            LET g_isbg2_d[l_ac].isah010 = 1
            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body2.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[2] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 2
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist330_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE aist330_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isbg2_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isbg2_d[l_ac].isahseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isbg2_d_t.* = g_isbg2_d[l_ac].*  #BACKUP
               LET g_isbg2_d_o.* = g_isbg2_d[l_ac].*  #BACKUP
               CALL aist330_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body2.after_set_entry_b"
               
               #end add-point  
               CALL aist330_set_no_entry_b(l_cmd)
               IF NOT aist330_lock_b("isah_t","'2'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist330_bcl2 INTO g_isbg2_d[l_ac].isahseq,g_isbg2_d[l_ac].isahorga,g_isbg2_d[l_ac].isah003, 
                      g_isbg2_d[l_ac].isah004,g_isbg2_d[l_ac].isah013,g_isbg2_d[l_ac].isah005,g_isbg2_d[l_ac].isah006, 
                      g_isbg2_d[l_ac].isah101,g_isbg2_d[l_ac].isah103,g_isbg2_d[l_ac].isah007,g_isbg2_d[l_ac].isah104, 
                      g_isbg2_d[l_ac].isah105,g_isbg2_d[l_ac].isah011,g_isbg2_d[l_ac].isah001,g_isbg2_d[l_ac].isah002, 
                      g_isbg2_d[l_ac].isah008,g_isbg2_d[l_ac].isah009,g_isbg2_d[l_ac].isah010,g_isbg2_d[l_ac].isah012, 
                      g_isbg2_d[l_ac].isah106,g_isbg2_d[l_ac].isah113,g_isbg2_d[l_ac].isah114,g_isbg2_d[l_ac].isah115, 
                      g_isbg2_d[l_ac].isah116
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isbg2_d_mask_o[l_ac].* =  g_isbg2_d[l_ac].*
                  CALL aist330_isah_t_mask()
                  LET g_isbg2_d_mask_n[l_ac].* =  g_isbg2_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist330_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body2.before_row"
            
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body2.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body2.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身2刪除前 name="input.body2.b_delete"
               
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isbf_m.isbfcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isbf_m.isbfdocno
               LET gs_keys[gs_keys.getLength()+1] = g_isbg2_d_t.isahseq
            
               #刪除同層單身
               IF NOT aist330_delete_b('isah_t',gs_keys,"'2'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist330_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist330_key_delete_b(gs_keys,'isah_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist330_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身2刪除中 name="input.body2.m_delete"
               LET l_changeb2 = 'Y'
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE aist330_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身2刪除後 name="input.body2.a_delete"
               
               #end add-point
               LET l_count = g_isbg_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body2.after_delete"
               
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isbg2_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身2新增前 name="input.body2.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM isah_t 
             WHERE isahent = g_enterprise AND isahcomp = g_isbf_m.isbfcomp
               AND isahdocno = g_isbf_m.isbfdocno
               AND isahseq = g_isbg2_d[l_ac].isahseq
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身2新增前 name="input.body2.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isbf_m.isbfcomp
               LET gs_keys[2] = g_isbf_m.isbfdocno
               LET gs_keys[3] = g_isbg2_d[g_detail_idx].isahseq
               CALL aist330_insert_b('isah_t',gs_keys,"'2'")
                           
               #add-point:單身新增後2 name="input.body2.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_isbg_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist330_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body2.after_insert"
               LET l_changeb2 = 'Y'
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isbg2_d[l_ac].* = g_isbg2_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE aist330_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_isbg2_d[l_ac].* = g_isbg2_d_t.*
            ELSE
               #add-point:單身page2修改前 name="input.body2.b_update"
               LET g_isbg2_d[l_ac].isah113 = g_isbg2_d[l_ac].isah103
               LET g_isbg2_d[l_ac].isah114 = g_isbg2_d[l_ac].isah104
               LET g_isbg2_d[l_ac].isah115 = g_isbg2_d[l_ac].isah105
               #end add-point
               
               #寫入修改者/修改日期資訊(單身2)
               
               
               #將遮罩欄位還原
               CALL aist330_isah_t_mask_restore('restore_mask_o')
                              
               UPDATE isah_t SET (isahcomp,isahdocno,isahseq,isahorga,isah003,isah004,isah013,isah005, 
                   isah006,isah101,isah103,isah007,isah104,isah105,isah011,isah001,isah002,isah008,isah009, 
                   isah010,isah012,isah106,isah113,isah114,isah115,isah116) = (g_isbf_m.isbfcomp,g_isbf_m.isbfdocno, 
                   g_isbg2_d[l_ac].isahseq,g_isbg2_d[l_ac].isahorga,g_isbg2_d[l_ac].isah003,g_isbg2_d[l_ac].isah004, 
                   g_isbg2_d[l_ac].isah013,g_isbg2_d[l_ac].isah005,g_isbg2_d[l_ac].isah006,g_isbg2_d[l_ac].isah101, 
                   g_isbg2_d[l_ac].isah103,g_isbg2_d[l_ac].isah007,g_isbg2_d[l_ac].isah104,g_isbg2_d[l_ac].isah105, 
                   g_isbg2_d[l_ac].isah011,g_isbg2_d[l_ac].isah001,g_isbg2_d[l_ac].isah002,g_isbg2_d[l_ac].isah008, 
                   g_isbg2_d[l_ac].isah009,g_isbg2_d[l_ac].isah010,g_isbg2_d[l_ac].isah012,g_isbg2_d[l_ac].isah106, 
                   g_isbg2_d[l_ac].isah113,g_isbg2_d[l_ac].isah114,g_isbg2_d[l_ac].isah115,g_isbg2_d[l_ac].isah116)  
                   #自訂欄位頁簽
                WHERE isahent = g_enterprise AND isahcomp = g_isbf_m.isbfcomp
                  AND isahdocno = g_isbf_m.isbfdocno
                  AND isahseq = g_isbg2_d_t.isahseq #項次 
                  
               #add-point:單身page2修改中 name="input.body2.m_update"
               LET l_changeb2 = 'Y'
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isbg2_d[l_ac].* = g_isbg2_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isah_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_isbg2_d[l_ac].* = g_isbg2_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isbf_m.isbfcomp
               LET gs_keys_bak[1] = g_isbfcomp_t
               LET gs_keys[2] = g_isbf_m.isbfdocno
               LET gs_keys_bak[2] = g_isbfdocno_t
               LET gs_keys[3] = g_isbg2_d[g_detail_idx].isahseq
               LET gs_keys_bak[3] = g_isbg2_d_t.isahseq
               CALL aist330_update_b('isah_t',gs_keys,gs_keys_bak,"'2'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aist330_isah_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_isbg2_d[g_detail_idx].isahseq = g_isbg2_d_t.isahseq 
                  ) THEN
                  LET gs_keys[01] = g_isbf_m.isbfcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isbf_m.isbfdocno
                  LET gs_keys[gs_keys.getLength()+1] = g_isbg2_d_t.isahseq
                  CALL aist330_key_update_b(gs_keys,'isah_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isbf_m),util.JSON.stringify(g_isbg2_d_t)
               LET g_log2 = util.JSON.stringify(g_isbf_m),util.JSON.stringify(g_isbg2_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page2修改後 name="input.body2.a_update"
               
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahseq
            #add-point:BEFORE FIELD isahseq name="input.b.page2.isahseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahseq
            
            #add-point:AFTER FIELD isahseq name="input.a.page2.isahseq"
            #應用 a05 樣板自動產生(Version:2)

            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isahseq
            #add-point:ON CHANGE isahseq name="input.g.page2.isahseq"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isahorga
            
            #add-point:AFTER FIELD isahorga name="input.a.page2.isahorga"
            IF NOT cl_null(g_isbg2_d[l_ac].isahorga)THEN
               IF cl_null(g_isbg2_d_t.isahorga) OR (g_isbg2_d[l_ac].isahorga <> g_isbg2_d_t.isahorga)THEN
                  
                  
                  
                  SELECT ooef001 FROM ooef_t
                   WHERE ooefent = g_enterprise
                     AND ooef001 IN (SELECT ooef001 FROM s_fin_tmp1)   
                     AND ooef001 = g_isbg2_d[l_ac].isahorga
                     
                  IF SQLCA.SQLCODE = 100 THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = 'aap-00034'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isbg2_d[l_ac].isahorga = g_isbg2_d_t.isahorga
                     DISPLAY BY NAME g_isbg2_d[l_ac].isahorga  
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_isbg2_d[l_ac].isahorga
                     CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_isbg2_d[l_ac].isahorga_desc = '', g_rtn_fields[1] , ''
                     DISPLAY BY NAME g_isbg2_d[l_ac].isahorga_desc
                     NEXT FIELD isahorga
                  END IF
                  #161006-00005#15  add--s
                  CALL s_fin_apcborga_chk(g_isbf_m.isbfsite,g_isbf_m.isbfcomp,g_isbg2_d[l_ac].isahorga,today,'3')
                       RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isbg2_d[l_ac].isahorga = g_isbg2_d_t.isahorga
                     DISPLAY BY NAME g_isbg2_d[l_ac].isahorga  
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_isbg2_d[l_ac].isahorga
                     CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_isbg2_d[l_ac].isahorga_desc = '', g_rtn_fields[1] , ''
                     DISPLAY BY NAME g_isbg2_d[l_ac].isahorga_desc
                     NEXT FIELD CURRENT
                  END IF 
                  
                  LET l_count = NULL
                  SELECT count(1) INTO l_count 
                    FROM s_fin_tmp1
                   WHERE ooef001 = g_isbg2_d[l_ac].isahorga
                     AND ooef201 = 'Y'
                     
                  IF cl_null(l_count) THEN LET l_count = 0 END IF  
                     
                  IF l_count = 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'ais-00342'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isbg2_d[l_ac].isahorga = g_isbg2_d_t.isahorga
                     DISPLAY BY NAME g_isbg2_d[l_ac].isahorga  
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_isbg2_d[l_ac].isahorga
                     CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_isbg2_d[l_ac].isahorga_desc = '', g_rtn_fields[1] , ''
                     DISPLAY BY NAME g_isbg2_d[l_ac].isahorga_desc
                     NEXT FIELD CURRENT
                  END IF
                  #161006-00005#15  add--e
               END IF
            END IF

            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_isbg2_d[l_ac].isahorga
            CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_isbg2_d[l_ac].isahorga_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_isbg2_d[l_ac].isahorga_desc


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isahorga
            #add-point:BEFORE FIELD isahorga name="input.b.page2.isahorga"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isahorga
            #add-point:ON CHANGE isahorga name="input.g.page2.isahorga"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah003
            #add-point:BEFORE FIELD isah003 name="input.b.page2.isah003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah003
            
            #add-point:AFTER FIELD isah003 name="input.a.page2.isah003"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah003
            #add-point:ON CHANGE isah003 name="input.g.page2.isah003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah004
            #add-point:BEFORE FIELD isah004 name="input.b.page2.isah004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah004
            
            #add-point:AFTER FIELD isah004 name="input.a.page2.isah004"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah004
            #add-point:ON CHANGE isah004 name="input.g.page2.isah004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah013
            #add-point:BEFORE FIELD isah013 name="input.b.page2.isah013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah013
            
            #add-point:AFTER FIELD isah013 name="input.a.page2.isah013"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah013
            #add-point:ON CHANGE isah013 name="input.g.page2.isah013"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah005
            #add-point:BEFORE FIELD isah005 name="input.b.page2.isah005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah005
            
            #add-point:AFTER FIELD isah005 name="input.a.page2.isah005"
            IF NOT cl_null(g_isbg2_d[l_ac].isah005) THEN 
            #此段落由子樣板a19產生
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               
               #設定g_chkparam.*的參數
               LET g_chkparam.arg1 = g_isbg2_d[l_ac].isah005
               #160318-00025#40  2016/04/22  by pengxin  add(S)
               LET g_errshow = TRUE #是否開窗 
               LET g_chkparam.err_str[1] = "aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
               #160318-00025#40  2016/04/22  by pengxin  add(E)
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_ooca001") THEN
               ELSE
                  #檢查失敗時後續處理
                  LET g_isbg2_d[l_ac].isah005 = g_isbg2_d_t.isah005
                  DISPLAY BY NAME g_isbg2_d[l_ac].isah005
                  NEXT FIELD CURRENT
               END IF
            

            END IF 
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah005
            #add-point:ON CHANGE isah005 name="input.g.page2.isah005"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah006
            #add-point:BEFORE FIELD isah006 name="input.b.page2.isah006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah006
            
            #add-point:AFTER FIELD isah006 name="input.a.page2.isah006"
            #發票數量
            IF NOT cl_null(g_isbg2_d[l_ac].isah006)THEN
               IF g_isbg2_d_o.isah006 <> g_isbg2_d[l_ac].isah006 OR cl_null(g_isbg2_d_o.isah006) THEN
                  IF NOT cl_null(g_isbg2_d[l_ac].isah101)THEN
                     #數量*單價=未稅
                     LET g_isbg2_d[l_ac].isah103 = g_isbg2_d[l_ac].isah101 * g_isbg2_d[l_ac].isah006 
                     #需要取位
                     #依照帳套本幣取位
                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah103,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah103
                     END IF
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah103
                     LET g_isbg2_d_o.isah103 = g_isbg2_d[l_ac].isah103
                  END IF
                  
                  #未稅+稅額 = 含稅
                  IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
                     END IF                  
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104
                     IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN
                        LET g_isbg2_d[l_ac].isah105 = g_isbg2_d[l_ac].isah103 + g_isbg2_d[l_ac].isah104
                        DISPLAY BY NAME g_isbg2_d[l_ac].isah105
                        LET g_isbg2_d_o.isah105 = g_isbg2_d[l_ac].isah105
                     END IF
                  END IF
               END IF
            END IF
            LET g_isbg2_d_o.isah006 = g_isbg2_d[l_ac].isah006
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah006
            #add-point:ON CHANGE isah006 name="input.g.page2.isah006"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah101
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_isbg2_d[l_ac].isah101,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD isah101
            END IF 
 
 
 
            #add-point:AFTER FIELD isah101 name="input.a.page2.isah101"
            #發票單價
            IF NOT cl_null(g_isbg2_d[l_ac].isah101)THEN
               IF g_isbg2_d_o.isah101 <> g_isbg2_d[l_ac].isah101 OR cl_null(g_isbg2_d_o.isah101) THEN
                  IF NOT cl_null(g_isbg2_d[l_ac].isah006)THEN
                     #數量*單價=未稅
                     LET g_isbg2_d[l_ac].isah103 = g_isbg2_d[l_ac].isah101 * g_isbg2_d[l_ac].isah006 
                     #需要取位
                     #依照帳套本幣取位
                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah103,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah103
                     END IF
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah103
                     LET g_isbg2_d_o.isah103 = g_isbg2_d[l_ac].isah103
                  END IF
                  
                  #未稅+稅額 = 含稅
                  IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
                     END IF                  
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104
                     IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN
                        LET g_isbg2_d[l_ac].isah105 = g_isbg2_d[l_ac].isah103 + g_isbg2_d[l_ac].isah104
                        DISPLAY BY NAME g_isbg2_d[l_ac].isah105
                        LET g_isbg2_d_o.isah105 = g_isbg2_d[l_ac].isah105
                     END IF
                  END IF
               END IF
            END IF
            LET g_isbg2_d_o.isah101 = g_isbg2_d[l_ac].isah101
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah101
            #add-point:BEFORE FIELD isah101 name="input.b.page2.isah101"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah101
            #add-point:ON CHANGE isah101 name="input.g.page2.isah101"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah103
            #應用 a15 樣板自動產生(Version:3)
            #確認欄位值在特定區間內
            IF NOT cl_ap_chk_range(g_isbg2_d[l_ac].isah103,"0.000","0","","","azz-00079",1) THEN
               NEXT FIELD isah103
            END IF 
 
 
 
            #add-point:AFTER FIELD isah103 name="input.a.page2.isah103"
            #發票未稅
            IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN
               IF g_isbg2_d_o.isah103 <> g_isbg2_d[l_ac].isah103 OR cl_null(g_isbg2_d_o.isah103) THEN
                  
                  #未稅+稅額 = 含稅
                  IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
                     END IF                  
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104
                     IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN
                        LET g_isbg2_d[l_ac].isah105 = g_isbg2_d[l_ac].isah103 + g_isbg2_d[l_ac].isah104
                        DISPLAY BY NAME g_isbg2_d[l_ac].isah105
                        LET g_isbg2_d_o.isah105 = g_isbg2_d[l_ac].isah105
                     END IF
                  END IF
               END IF
            END IF
            LET g_isbg2_d_o.isah103 = g_isbg2_d[l_ac].isah103


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah103
            #add-point:BEFORE FIELD isah103 name="input.b.page2.isah103"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah103
            #add-point:ON CHANGE isah103 name="input.g.page2.isah103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah007
            #add-point:BEFORE FIELD isah007 name="input.b.page2.isah007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah007
            
            #add-point:AFTER FIELD isah007 name="input.a.page2.isah007"
            #發票稅率
            IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
               IF g_isbg2_d_o.isah007 <> g_isbg2_d[l_ac].isah007 OR cl_null(g_isbg2_d_o.isah007) THEN
                  
                  #未稅+稅額 = 含稅
                  IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN
                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
                     END IF                  
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104
                     IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN
                        LET g_isbg2_d[l_ac].isah105 = g_isbg2_d[l_ac].isah103 + g_isbg2_d[l_ac].isah104
                        DISPLAY BY NAME g_isbg2_d[l_ac].isah105
                        LET g_isbg2_d_o.isah105 = g_isbg2_d[l_ac].isah105
                     END IF
                  END IF
               END IF
            END IF
            LET g_isbg2_d_o.isah007 = g_isbg2_d[l_ac].isah007
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah007
            #add-point:ON CHANGE isah007 name="input.g.page2.isah007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah104
            #add-point:BEFORE FIELD isah104 name="input.b.page2.isah104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah104
            
            #add-point:AFTER FIELD isah104 name="input.a.page2.isah104"
            #發票稅額
            IF NOT cl_null(g_isbg2_d[l_ac].isah104)THEN
               IF g_isbg2_d_o.isah104 <> g_isbg2_d[l_ac].isah104 OR cl_null(g_isbg2_d_o.isah104) THEN
                  
                  #未稅+稅額 = 含稅
                  IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN                              
                     LET g_isbg2_d[l_ac].isah105 = g_isbg2_d[l_ac].isah103 + g_isbg2_d[l_ac].isah104
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah105 
                     LET g_isbg2_d_o.isah105 = g_isbg2_d[l_ac].isah105
                  END IF
               END IF
            END IF
            LET g_isbg2_d_o.isah104 = g_isbg2_d[l_ac].isah104
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah104
            #add-point:ON CHANGE isah104 name="input.g.page2.isah104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah105
            #add-point:BEFORE FIELD isah105 name="input.b.page2.isah105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah105
            
            #add-point:AFTER FIELD isah105 name="input.a.page2.isah105"
            #發票含稅
            IF NOT cl_null(g_isbg2_d[l_ac].isah105)THEN
               IF g_isbg2_d_o.isah105 <> g_isbg2_d[l_ac].isah105 OR cl_null(g_isbg2_d_o.isah105) THEN
                  
                  #未稅+稅額 = 含稅
                  IF NOT cl_null(g_isbg2_d[l_ac].isah103)THEN                              
                     LET g_isbg2_d[l_ac].isah103 = g_isbg2_d[l_ac].isah105 - g_isbg2_d[l_ac].isah103
                     DISPLAY BY NAME g_isbg2_d[l_ac].isah103  
                     LET g_isbg2_d_o.isah103 = g_isbg2_d[l_ac].isah103                     
                  END IF
               END IF
            END IF
            LET g_isbg2_d_o.isah105 = g_isbg2_d[l_ac].isah105
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah105
            #add-point:ON CHANGE isah105 name="input.g.page2.isah105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah011
            #add-point:BEFORE FIELD isah011 name="input.b.page2.isah011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah011
            
            #add-point:AFTER FIELD isah011 name="input.a.page2.isah011"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah011
            #add-point:ON CHANGE isah011 name="input.g.page2.isah011"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah001
            #add-point:BEFORE FIELD isah001 name="input.b.page2.isah001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah001
            
            #add-point:AFTER FIELD isah001 name="input.a.page2.isah001"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah001
            #add-point:ON CHANGE isah001 name="input.g.page2.isah001"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah002
            #add-point:BEFORE FIELD isah002 name="input.b.page2.isah002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah002
            
            #add-point:AFTER FIELD isah002 name="input.a.page2.isah002"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah002
            #add-point:ON CHANGE isah002 name="input.g.page2.isah002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah008
            #add-point:BEFORE FIELD isah008 name="input.b.page2.isah008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah008
            
            #add-point:AFTER FIELD isah008 name="input.a.page2.isah008"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah008
            #add-point:ON CHANGE isah008 name="input.g.page2.isah008"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah009
            #add-point:BEFORE FIELD isah009 name="input.b.page2.isah009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah009
            
            #add-point:AFTER FIELD isah009 name="input.a.page2.isah009"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah009
            #add-point:ON CHANGE isah009 name="input.g.page2.isah009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah010
            #add-point:BEFORE FIELD isah010 name="input.b.page2.isah010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah010
            
            #add-point:AFTER FIELD isah010 name="input.a.page2.isah010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah010
            #add-point:ON CHANGE isah010 name="input.g.page2.isah010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah012
            #add-point:BEFORE FIELD isah012 name="input.b.page2.isah012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah012
            
            #add-point:AFTER FIELD isah012 name="input.a.page2.isah012"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah012
            #add-point:ON CHANGE isah012 name="input.g.page2.isah012"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah106
            #add-point:BEFORE FIELD isah106 name="input.b.page2.isah106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah106
            
            #add-point:AFTER FIELD isah106 name="input.a.page2.isah106"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah106
            #add-point:ON CHANGE isah106 name="input.g.page2.isah106"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah113
            #add-point:BEFORE FIELD isah113 name="input.b.page2.isah113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah113
            
            #add-point:AFTER FIELD isah113 name="input.a.page2.isah113"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah113
            #add-point:ON CHANGE isah113 name="input.g.page2.isah113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah114
            #add-point:BEFORE FIELD isah114 name="input.b.page2.isah114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah114
            
            #add-point:AFTER FIELD isah114 name="input.a.page2.isah114"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah114
            #add-point:ON CHANGE isah114 name="input.g.page2.isah114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah115
            #add-point:BEFORE FIELD isah115 name="input.b.page2.isah115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah115
            
            #add-point:AFTER FIELD isah115 name="input.a.page2.isah115"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah115
            #add-point:ON CHANGE isah115 name="input.g.page2.isah115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isah116
            #add-point:BEFORE FIELD isah116 name="input.b.page2.isah116"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isah116
            
            #add-point:AFTER FIELD isah116 name="input.a.page2.isah116"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isah116
            #add-point:ON CHANGE isah116 name="input.g.page2.isah116"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page2.isahseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahseq
            #add-point:ON ACTION controlp INFIELD isahseq name="input.c.page2.isahseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isahorga
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isahorga
            #add-point:ON ACTION controlp INFIELD isahorga name="input.c.page2.isahorga"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            #161017-00005#1 add --s
            CALL s_fin_account_center_sons_query('3',g_isbf_m.isbfsite,g_isbf_m.isbfdocdt,'1')
            CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
            CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
            #161017-00005#1 add --e 
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isbg2_d[l_ac].isahorga             #給予default
            LET g_qryparam.where = " ooef001 IN ",g_wc_isbfsite CLIPPED,
                                   " AND ooef201 = 'Y'",   #161006-00005#15   add
                                   " AND ooef017 ='",g_isbf_m.isbfcomp,"' " #161017-00005#1 add
            CALL q_ooef001()                                #呼叫開窗

            LET g_isbg2_d[l_ac].isahorga = g_qryparam.return1              
            DISPLAY g_isbg2_d[l_ac].isahorga TO isahorga              #
            NEXT FIELD isahorga                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.isah003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah003
            #add-point:ON ACTION controlp INFIELD isah003 name="input.c.page2.isah003"
            #應用 a07 樣板自動產生(Version:2)   
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isbg2_d[l_ac].isah003             #給予default值
            LET g_qryparam.default2 = "" #g_isbg2_d[l_ac].imaal003 #品名
            LET g_qryparam.default3 = "" #g_isbg2_d[l_ac].imaal004 #規格
            #給予arg
            LET g_qryparam.arg1 = "" #


            CALL q_imaa001()                                #呼叫開窗

            LET g_isbg2_d[l_ac].isah003 = g_qryparam.return1              
            #LET g_isbg2_d[l_ac].imaal003 = g_qryparam.return2 
            #LET g_isbg2_d[l_ac].imaal004 = g_qryparam.return3 
            DISPLAY g_isbg2_d[l_ac].isah003 TO isah003              #
            #DISPLAY g_isbg2_d[l_ac].imaal003 TO imaal003 #品名
            #DISPLAY g_isbg2_d[l_ac].imaal004 TO imaal004 #規格
            NEXT FIELD isah003                          #返回原欄位


            #END add-point
 
 
         #Ctrlp:input.c.page2.isah004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah004
            #add-point:ON ACTION controlp INFIELD isah004 name="input.c.page2.isah004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah013
            #add-point:ON ACTION controlp INFIELD isah013 name="input.c.page2.isah013"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah005
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah005
            #add-point:ON ACTION controlp INFIELD isah005 name="input.c.page2.isah005"
		      INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_isbg2_d[l_ac].isah005
            #給予arg
            CALL q_ooca001_1()                                #呼叫開
            LET g_isbg2_d[l_ac].isah005 = g_qryparam.return1              #將開窗取得的值回傳到變數
            DISPLAY BY NAME g_isbg2_d[l_ac].isah005            #顯示到畫面上
            NEXT FIELD isah005      
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah006
            #add-point:ON ACTION controlp INFIELD isah006 name="input.c.page2.isah006"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah101
            #add-point:ON ACTION controlp INFIELD isah101 name="input.c.page2.isah101"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah103
            #add-point:ON ACTION controlp INFIELD isah103 name="input.c.page2.isah103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah007
            #add-point:ON ACTION controlp INFIELD isah007 name="input.c.page2.isah007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah104
            #add-point:ON ACTION controlp INFIELD isah104 name="input.c.page2.isah104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah105
            #add-point:ON ACTION controlp INFIELD isah105 name="input.c.page2.isah105"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah011
            #add-point:ON ACTION controlp INFIELD isah011 name="input.c.page2.isah011"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah001
            #add-point:ON ACTION controlp INFIELD isah001 name="input.c.page2.isah001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah002
            #add-point:ON ACTION controlp INFIELD isah002 name="input.c.page2.isah002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah008
            #add-point:ON ACTION controlp INFIELD isah008 name="input.c.page2.isah008"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah009
            #add-point:ON ACTION controlp INFIELD isah009 name="input.c.page2.isah009"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah010
            #add-point:ON ACTION controlp INFIELD isah010 name="input.c.page2.isah010"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah012
            #add-point:ON ACTION controlp INFIELD isah012 name="input.c.page2.isah012"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah106
            #add-point:ON ACTION controlp INFIELD isah106 name="input.c.page2.isah106"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah113
            #add-point:ON ACTION controlp INFIELD isah113 name="input.c.page2.isah113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah114
            #add-point:ON ACTION controlp INFIELD isah114 name="input.c.page2.isah114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah115
            #add-point:ON ACTION controlp INFIELD isah115 name="input.c.page2.isah115"
            
            #END add-point
 
 
         #Ctrlp:input.c.page2.isah116
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isah116
            #add-point:ON ACTION controlp INFIELD isah116 name="input.c.page2.isah116"
            
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page2 after_row name="input.body2.after_row"
            
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isbg2_d[l_ac].* = g_isbg2_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE aist330_bcl2
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist330_unlock_b("isah_t","'2'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page2 after_row2 name="input.body2.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body2.after_input"
            IF l_changeb2 = 'Y' THEN
               LET l_count = NULL
               SELECT COUNT(*) INTO l_count FROM isat_t
                WHERE isatent = g_enterprise
                  AND isatcomp = g_isbf_m.isbfcomp
                  AND isatdocno = g_isbf_m.isbfdocno
               IF cl_null(l_count)THEN LET l_count = 0 END IF
               
               #160106-00005#4-----s
               LET l_count2 = NULL
               SELECT COUNT(*) INTO l_count2 FROM isah_t
                WHERE isahent = g_enterprise
                  AND isahcomp = g_isbf_m.isbfcomp
                  AND isahdocno = g_isbf_m.isbfdocno
                  AND isah002   IS NULL
               IF cl_null(l_count2)THEN LET l_count2 = 0 END IF
               
                
               #160106-00005#4-----e
               IF l_count = 0 AND l_count2 = 0 THEN   #160106-00005#4 add l_count2
                  CALL aist330_autoins_isat(g_isbf_m.isbfcomp,g_isbf_m.isbfdocno,'1')
               END IF
            END IF
            LET l_changeb2 = 'N'
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isbg2_d[li_reproduce_target].* = g_isbg2_d[li_reproduce].*
 
               LET g_isbg2_d[li_reproduce_target].isahseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_isbg2_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isbg2_d.getLength()+1
            END IF
            
      END INPUT
      INPUT ARRAY g_isbg3_d FROM s_detail3.*
         ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                 INSERT ROW = l_allow_insert, #此頁面insert功能由產生器控制, 手動之設定無效! 
 
                 DELETE ROW = l_allow_delete,
                 APPEND ROW = l_allow_insert)
                 
         #自訂ACTION(detail_input,page_3)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body3.before_input2"
            
            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_isbg3_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL aist330_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'd' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
            END IF
            LET g_loc = 'd'
            LET g_rec_b = g_isbg3_d.getLength()
            #add-point:資料輸入前 name="input.body3.before_input"
            LET l_changeb3 = 'N'
            #end add-point
            
         BEFORE INSERT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            INITIALIZE g_isbg3_d[l_ac].* TO NULL 
            INITIALIZE g_isbg3_d_t.* TO NULL 
            INITIALIZE g_isbg3_d_o.* TO NULL 
            #公用欄位給值(單身3)
            
            #自定義預設值(單身3)
                  LET g_isbg3_d[l_ac].isat113 = "0"
      LET g_isbg3_d[l_ac].isat114 = "0"
      LET g_isbg3_d[l_ac].isat115 = "0"
      LET g_isbg3_d[l_ac].isat103 = "0"
      LET g_isbg3_d[l_ac].isat104 = "0"
      LET g_isbg3_d[l_ac].isat105 = "0"
      LET g_isbg3_d[l_ac].isat106 = "0"
      LET g_isbg3_d[l_ac].isat107 = "0"
      LET g_isbg3_d[l_ac].isat201 = "0"
      LET g_isbg3_d[l_ac].isat202 = "0"
      LET g_isbg3_d[l_ac].isat203 = "0"
 
            #add-point:modify段before備份 name="input.body3.insert.before_bak"
            LET g_isbg3_d[l_ac].isat003 = " "   #151020-00003#3
            LET g_isbg3_d[l_ac].isat025 = '11'  #albireo 160408
            #end add-point
            LET g_isbg3_d_t.* = g_isbg3_d[l_ac].*     #新輸入資料
            LET g_isbg3_d_o.* = g_isbg3_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            CALL aist330_set_entry_b(l_cmd)
            #add-point:modify段after_set_entry_b name="input.body3.insert.after_set_entry_b"
            
            #end add-point
            CALL aist330_set_no_entry_b(l_cmd)
            IF lb_reproduce THEN
               LET lb_reproduce = FALSE
               LET g_isbg3_d[li_reproduce_target].* = g_isbg3_d[li_reproduce].*
 
               LET g_isbg3_d[li_reproduce_target].isatseq = NULL
            END IF
            
 
            #add-point:modify段before insert name="input.body3.before_insert"
            IF cl_null(g_isbg3_d[g_detail_idx].isatseq) THEN 
               SELECT MAX(isatseq) INTO g_isbg3_d[g_detail_idx].isatseq
                 FROM isat_t
                WHERE isatent = g_enterprise
                  AND isatcomp = g_isbf_m.isbfcomp  
                  AND isatdocno = g_isbf_m.isbfdocno
                  
               IF cl_null(g_isbg3_d[g_detail_idx].isatseq) THEN 
                  LET g_isbg3_d[g_detail_idx].isatseq = 1
               ELSE
                  LET g_isbg3_d[g_detail_idx].isatseq = g_isbg3_d[g_detail_idx].isatseq + 1
               END IF
            END IF
            
#            IF g_isaf_m.isaf056 = '1' THEN 
               LET g_isbg3_d[g_detail_idx].isat014 = '11'
               LET g_isbg3_d[g_detail_idx].isat025 = '11'   #151020-00003#3
#            ELSE
#               LET g_isag4_d[g_detail_idx].isat014 = '21'
#            END IF 
            LET g_isbg3_d[g_detail_idx].isat017 = g_today
#            IF g_detail_idx = 1 THEN
#               LET g_isbg3_d[g_detail_idx].isat103 = g_isaf_m.isaf103
#               LET g_isbg3_d[g_detail_idx].isat104 = g_isaf_m.isaf104
#               LET g_isbg3_d[g_detail_idx].isat105 = g_isaf_m.isaf105
#            END IF

            LET g_isbg3_d[g_detail_idx].isat001 = g_isbf_m.isbf005
            LET g_isbg3_d[g_detail_idx].isat002 = 'N'
            LET g_isbg3_d[g_detail_idx].isat005 = ''
            SELECT isac008  INTO g_isbg3_d[g_detail_idx].isat005
             FROM isac_t
            WHERE isacent = g_enterprise
              AND isac001 = g_ooef019
              AND isac002 =  g_isbf_m.isbf005
            LET g_isbg3_d[g_detail_idx].isat006 = ''
            LET g_isbg3_d[g_detail_idx].isat008 = ''
            LET g_isbg3_d[g_detail_idx].isat009 = ''
            LET g_isbg3_d[g_detail_idx].isat010 = ''
            LET g_isbg3_d[g_detail_idx].isat011 = ''
            LET g_isbg3_d[g_detail_idx].isat012 = g_isbf_m.isbf004
            LET g_isbg3_d[g_detail_idx].isat013 = ''
            LET g_isbg3_d[g_detail_idx].isat015 = ''
            LET g_isbg3_d[g_detail_idx].isat016 = ''
            LET g_isbg3_d[g_detail_idx].isat018 = ''
            LET g_isbg3_d[g_detail_idx].isat019 = ''
            LET g_isbg3_d[g_detail_idx].isat020 = ''
            LET g_isbg3_d[g_detail_idx].isat021 = 0
            LET g_isbg3_d[g_detail_idx].isat022 = ''
            LET g_isbg3_d[g_detail_idx].isat023 = 5
            LET g_isbg3_d[g_detail_idx].isat024 = ''
            LET g_isbg3_d[g_detail_idx].isat100 = g_glaa.glaa001
            LET g_isbg3_d[g_detail_idx].isat101 = 1
            LET g_isbg3_d[g_detail_idx].isat204 = ''
            LET g_isbg3_d[g_detail_idx].isat205 = ''
            LET g_isbg3_d[g_detail_idx].isat206 = ''
            LET g_isbg3_d[g_detail_idx].isat207 = ''
            LET g_isbg3_d[g_detail_idx].isat208 = ''
            LET g_isbg3_d[g_detail_idx].isat209 = ''
            LET g_isbg3_d[g_detail_idx].isatdocdt = g_isbf_m.isbfdocdt
#            LET g_isbg3_d[g_detail_idx].isat026 = ''
#            LET g_isbg3_d[g_detail_idx].isat027 = ''
#            LET g_isbg3_d[g_detail_idx].isat028= ''
#            LET g_isbg3_d[g_detail_idx].isat029 = ''
            #end add-point  
 
         BEFORE ROW     
            #add-point:modify段before row2 name="input.body3.before_row2"
            
            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[3] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 3
              
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN aist330_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE aist330_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_isbg3_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_isbg3_d[l_ac].isatseq IS NOT NULL
            THEN 
               LET l_cmd='u'
               LET g_isbg3_d_t.* = g_isbg3_d[l_ac].*  #BACKUP
               LET g_isbg3_d_o.* = g_isbg3_d[l_ac].*  #BACKUP
               CALL aist330_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body3.after_set_entry_b"
               
               #end add-point  
               CALL aist330_set_no_entry_b(l_cmd)
               IF NOT aist330_lock_b("isat_t","'3'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH aist330_bcl3 INTO g_isbg3_d[l_ac].isatseq,g_isbg3_d[l_ac].isatsite,g_isbg3_d[l_ac].isat003, 
                      g_isbg3_d[l_ac].isat004,g_isbg3_d[l_ac].isat006,g_isbg3_d[l_ac].isat005,g_isbg3_d[l_ac].isat022, 
                      g_isbg3_d[l_ac].isat113,g_isbg3_d[l_ac].isat114,g_isbg3_d[l_ac].isat115,g_isbg3_d[l_ac].isat103, 
                      g_isbg3_d[l_ac].isat104,g_isbg3_d[l_ac].isat105,g_isbg3_d[l_ac].isat007,g_isbg3_d[l_ac].isat014, 
                      g_isbg3_d[l_ac].isat025,g_isbg3_d[l_ac].isat106,g_isbg3_d[l_ac].isat107,g_isbg3_d[l_ac].isat017, 
                      g_isbg3_d[l_ac].isat001,g_isbg3_d[l_ac].isat002,g_isbg3_d[l_ac].isat008,g_isbg3_d[l_ac].isat009, 
                      g_isbg3_d[l_ac].isat010,g_isbg3_d[l_ac].isat011,g_isbg3_d[l_ac].isat012,g_isbg3_d[l_ac].isat013, 
                      g_isbg3_d[l_ac].isat015,g_isbg3_d[l_ac].isat016,g_isbg3_d[l_ac].isat018,g_isbg3_d[l_ac].isat019, 
                      g_isbg3_d[l_ac].isat020,g_isbg3_d[l_ac].isat021,g_isbg3_d[l_ac].isat023,g_isbg3_d[l_ac].isat024, 
                      g_isbg3_d[l_ac].isat100,g_isbg3_d[l_ac].isat101,g_isbg3_d[l_ac].isat201,g_isbg3_d[l_ac].isat202, 
                      g_isbg3_d[l_ac].isat203,g_isbg3_d[l_ac].isat204,g_isbg3_d[l_ac].isat205,g_isbg3_d[l_ac].isat206, 
                      g_isbg3_d[l_ac].isat207,g_isbg3_d[l_ac].isat208,g_isbg3_d[l_ac].isat209,g_isbg3_d[l_ac].isatdocdt 
 
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = SQLERRMESSAGE  
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  LET g_isbg3_d_mask_o[l_ac].* =  g_isbg3_d[l_ac].*
                  CALL aist330_isat_t_mask()
                  LET g_isbg3_d_mask_n[l_ac].* =  g_isbg3_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL aist330_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body3.before_row"
            
            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
            
         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               LET l_cmd='d'
               #add-point:單身AFTER DELETE (=d) name="input.body3.after_delete_d"
               
               #end add-point
            ELSE
               #add-point:單身刪除前 name="input.body3.b_delete_ask"
               
               #end add-point 
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "" 
                  LET g_errparam.code   = -263 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               #add-point:單身3刪除前 name="input.body3.b_delete"
               
               #end add-point    
                  
               #取得該筆資料key值
               INITIALIZE gs_keys TO NULL
               LET gs_keys[01] = g_isbf_m.isbfcomp
               LET gs_keys[gs_keys.getLength()+1] = g_isbf_m.isbfdocno
               LET gs_keys[gs_keys.getLength()+1] = g_isbg3_d_t.isatseq
            
               #刪除同層單身
               IF NOT aist330_delete_b('isat_t',gs_keys,"'3'") THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist330_bcl
                  CANCEL DELETE
               END IF
    
               #刪除下層單身
               IF NOT aist330_key_delete_b(gs_keys,'isat_t') THEN
                  CALL s_transaction_end('N','0')
                  CLOSE aist330_bcl
                  CANCEL DELETE
               END IF
               
               #刪除多語言
               
 
               
               #add-point:單身3刪除中 name="input.body3.m_delete"
               LET l_changeb3 = 'Y'
               #end add-point    
               
               CALL s_transaction_end('Y','0')
               CLOSE aist330_bcl
 
               LET g_rec_b = g_rec_b-1
               #add-point:單身3刪除後 name="input.body3.a_delete"
               
               #end add-point
               LET l_count = g_isbg_d.getLength()
               
               #add-point:單身刪除後(<>d) name="input.body3.after_delete"
               
               #end add-point
            END IF 
 
         AFTER DELETE
            #如果是最後一筆
            IF l_ac = (g_isbg3_d.getLength() + 1) THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
            END IF
 
         AFTER INSERT    
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CALL cl_err()
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
               
            #add-point:單身3新增前 name="input.body3.b_a_insert"
            
            #end add-point
               
            LET l_count = 1  
            SELECT COUNT(1) INTO l_count FROM isat_t 
             WHERE isatent = g_enterprise AND isatcomp = g_isbf_m.isbfcomp
               AND isatdocno = g_isbf_m.isbfdocno
               AND isatseq = g_isbg3_d[l_ac].isatseq
                
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN 
               #add-point:單身3新增前 name="input.body3.b_insert"
               
               #end add-point
            
                              INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isbf_m.isbfcomp
               LET gs_keys[2] = g_isbf_m.isbfdocno
               LET gs_keys[3] = g_isbg3_d[g_detail_idx].isatseq
               CALL aist330_insert_b('isat_t',gs_keys,"'3'")
                           
               #add-point:單身新增後3 name="input.body3.a_insert"
               
               #end add-point
            ELSE    
               INITIALIZE g_isbg_d[l_ac].* TO NULL
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = 'INSERT' 
               LET g_errparam.code   = "std-00006" 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')
               CALL cl_err()
               CANCEL INSERT
            END IF
 
            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL s_transaction_end('N','0')                    
               CALL cl_err()
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL aist330_b_fill()
               #資料多語言用-增/改
               
               #add-point:單身新增後 name="input.body3.after_insert"
               LET l_changeb3 = 'Y'
               #end add-point
               CALL s_transaction_end('Y','0')
               #ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF
            
         ON ROW CHANGE 
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               LET g_isbg3_d[l_ac].* = g_isbg3_d_t.*
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE aist330_bcl3
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = -263 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               LET g_isbg3_d[l_ac].* = g_isbg3_d_t.*
            ELSE
               #add-point:單身page3修改前 name="input.body3.b_update"
               
               #end add-point
               
               #寫入修改者/修改日期資訊(單身3)
               
               
               #將遮罩欄位還原
               CALL aist330_isat_t_mask_restore('restore_mask_o')
                              
               UPDATE isat_t SET (isatcomp,isatdocno,isatseq,isatsite,isat003,isat004,isat006,isat005, 
                   isat022,isat113,isat114,isat115,isat103,isat104,isat105,isat007,isat014,isat025,isat106, 
                   isat107,isat017,isat001,isat002,isat008,isat009,isat010,isat011,isat012,isat013,isat015, 
                   isat016,isat018,isat019,isat020,isat021,isat023,isat024,isat100,isat101,isat201,isat202, 
                   isat203,isat204,isat205,isat206,isat207,isat208,isat209,isatdocdt) = (g_isbf_m.isbfcomp, 
                   g_isbf_m.isbfdocno,g_isbg3_d[l_ac].isatseq,g_isbg3_d[l_ac].isatsite,g_isbg3_d[l_ac].isat003, 
                   g_isbg3_d[l_ac].isat004,g_isbg3_d[l_ac].isat006,g_isbg3_d[l_ac].isat005,g_isbg3_d[l_ac].isat022, 
                   g_isbg3_d[l_ac].isat113,g_isbg3_d[l_ac].isat114,g_isbg3_d[l_ac].isat115,g_isbg3_d[l_ac].isat103, 
                   g_isbg3_d[l_ac].isat104,g_isbg3_d[l_ac].isat105,g_isbg3_d[l_ac].isat007,g_isbg3_d[l_ac].isat014, 
                   g_isbg3_d[l_ac].isat025,g_isbg3_d[l_ac].isat106,g_isbg3_d[l_ac].isat107,g_isbg3_d[l_ac].isat017, 
                   g_isbg3_d[l_ac].isat001,g_isbg3_d[l_ac].isat002,g_isbg3_d[l_ac].isat008,g_isbg3_d[l_ac].isat009, 
                   g_isbg3_d[l_ac].isat010,g_isbg3_d[l_ac].isat011,g_isbg3_d[l_ac].isat012,g_isbg3_d[l_ac].isat013, 
                   g_isbg3_d[l_ac].isat015,g_isbg3_d[l_ac].isat016,g_isbg3_d[l_ac].isat018,g_isbg3_d[l_ac].isat019, 
                   g_isbg3_d[l_ac].isat020,g_isbg3_d[l_ac].isat021,g_isbg3_d[l_ac].isat023,g_isbg3_d[l_ac].isat024, 
                   g_isbg3_d[l_ac].isat100,g_isbg3_d[l_ac].isat101,g_isbg3_d[l_ac].isat201,g_isbg3_d[l_ac].isat202, 
                   g_isbg3_d[l_ac].isat203,g_isbg3_d[l_ac].isat204,g_isbg3_d[l_ac].isat205,g_isbg3_d[l_ac].isat206, 
                   g_isbg3_d[l_ac].isat207,g_isbg3_d[l_ac].isat208,g_isbg3_d[l_ac].isat209,g_isbg3_d[l_ac].isatdocdt)  
                   #自訂欄位頁簽
                WHERE isatent = g_enterprise AND isatcomp = g_isbf_m.isbfcomp
                  AND isatdocno = g_isbf_m.isbfdocno
                  AND isatseq = g_isbg3_d_t.isatseq #項次 
                  
               #add-point:單身page3修改中 name="input.body3.m_update"
               LET l_changeb3 = 'Y'
               #end add-point
                  
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     LET g_isbg3_d[l_ac].* = g_isbg3_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isat_t" 
                     LET g_errparam.code   = "std-00009" 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  WHEN SQLCA.sqlcode #其他錯誤
                     LET g_isbg3_d[l_ac].* = g_isbg3_d_t.*
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     
                  OTHERWISE
                     #資料多語言用-增/改
                     
                                    INITIALIZE gs_keys TO NULL 
               LET gs_keys[1] = g_isbf_m.isbfcomp
               LET gs_keys_bak[1] = g_isbfcomp_t
               LET gs_keys[2] = g_isbf_m.isbfdocno
               LET gs_keys_bak[2] = g_isbfdocno_t
               LET gs_keys[3] = g_isbg3_d[g_detail_idx].isatseq
               LET gs_keys_bak[3] = g_isbg3_d_t.isatseq
               CALL aist330_update_b('isat_t',gs_keys,gs_keys_bak,"'3'")
               END CASE
               
               #將遮罩欄位進行遮蔽
               CALL aist330_isat_t_mask_restore('restore_mask_n')
               
               #判斷key是否有改變
               INITIALIZE gs_keys TO NULL
               IF NOT (g_isbg3_d[g_detail_idx].isatseq = g_isbg3_d_t.isatseq 
                  ) THEN
                  LET gs_keys[01] = g_isbf_m.isbfcomp
                  LET gs_keys[gs_keys.getLength()+1] = g_isbf_m.isbfdocno
                  LET gs_keys[gs_keys.getLength()+1] = g_isbg3_d_t.isatseq
                  CALL aist330_key_update_b(gs_keys,'isat_t')
               END IF
               
               #修改歷程記錄(單身修改)
               LET g_log1 = util.JSON.stringify(g_isbf_m),util.JSON.stringify(g_isbg3_d_t)
               LET g_log2 = util.JSON.stringify(g_isbf_m),util.JSON.stringify(g_isbg3_d[l_ac])
               IF NOT cl_log_modified_record_d(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               END IF
               
               #add-point:單身page3修改後 name="input.body3.a_update"
               
               #end add-point
            END IF
         
                  #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatseq
            #add-point:BEFORE FIELD isatseq name="input.b.page3.isatseq"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatseq
            
            #add-point:AFTER FIELD isatseq name="input.a.page3.isatseq"
            #應用 a05 樣板自動產生(Version:2)
            #確認資料無重複
            IF  g_isbf_m.isbfcomp IS NOT NULL AND g_isbf_m.isbfdocno IS NOT NULL AND g_isbg3_d[g_detail_idx].isatseq IS NOT NULL AND g_isbg3_d[g_detail_idx].isat003 IS NOT NULL AND g_isbg3_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isbf_m.isbfcomp != g_isbfcomp_t OR g_isbf_m.isbfdocno != g_isbfdocno_t OR g_isbg3_d[g_detail_idx].isatseq != g_isbg3_d_t.isatseq OR g_isbg3_d[g_detail_idx].isat003 != g_isbg3_d_t.isat003 OR g_isbg3_d[g_detail_idx].isat004 != g_isbg3_d_t.isat004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isbf_m.isbfcomp ||"' AND "|| "isatseq = '"||g_isbf_m.isbfdocno ||"' AND "|| "isat003 = '"||g_isbg3_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isbg3_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isatseq
            #add-point:ON CHANGE isatseq name="input.g.page3.isatseq"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatsite
            #add-point:BEFORE FIELD isatsite name="input.b.page3.isatsite"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatsite
            
            #add-point:AFTER FIELD isatsite name="input.a.page3.isatsite"
            IF NOT cl_null(g_isbg3_d[l_ac].isatsite)THEN
               IF cl_null(g_isbg3_d_t.isatsite) OR (g_isbg3_d[l_ac].isatsite <> g_isbg3_d_t.isatsite)THEN
                  

                  SELECT ooef001 FROM ooef_t
                   WHERE ooefent = g_enterprise
                     AND ooef001 IN (SELECT ooef001 FROM s_fin_tmp1)
                     AND ooef001 = g_isbg3_d[l_ac].isatsite
                  IF SQLCA.SQLCODE = 100 THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = 'aap-00034'
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isbg3_d[l_ac].isatsite = g_isbg3_d_t.isatsite
                     DISPLAY BY NAME g_isbg3_d[l_ac].isatsite  
                  END IF
                  #161006-00005#15  add--s
                  CALL s_fin_apcborga_chk(g_isbf_m.isbfsite,g_isbf_m.isbfcomp,g_isbg3_d[l_ac].isatsite,today,'3') 
                       RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_isbg3_d[l_ac].isatsite = g_isbg3_d_t.isatsite
                     DISPLAY BY NAME g_isbg3_d[l_ac].isatsite  
                     NEXT FIELD CURRENT
                  END IF
                  #161006-00005#15  add--e
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isatsite
            #add-point:ON CHANGE isatsite name="input.g.page3.isatsite"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat003
            #add-point:BEFORE FIELD isat003 name="input.b.page3.isat003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat003
            
            #add-point:AFTER FIELD isat003 name="input.a.page3.isat003"
            #應用 a05 樣板自動產生(Version:2)
            #確認資料無重複
            IF  g_isbf_m.isbfcomp IS NOT NULL AND g_isbf_m.isbfdocno IS NOT NULL AND g_isbg3_d[g_detail_idx].isatseq IS NOT NULL AND g_isbg3_d[g_detail_idx].isat003 IS NOT NULL AND g_isbg3_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isbf_m.isbfcomp != g_isbfcomp_t OR g_isbf_m.isbfdocno != g_isbfdocno_t OR g_isbg3_d[g_detail_idx].isatseq != g_isbg3_d_t.isatseq OR g_isbg3_d[g_detail_idx].isat003 != g_isbg3_d_t.isat003 OR g_isbg3_d[g_detail_idx].isat004 != g_isbg3_d_t.isat004)) THEN 
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isbf_m.isbfcomp ||"' AND "|| "isatseq = '"||g_isbf_m.isbfdocno ||"' AND "|| "isat003 = '"||g_isbg3_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isbg3_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN 
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat003
            #add-point:ON CHANGE isat003 name="input.g.page3.isat003"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat004
            #add-point:BEFORE FIELD isat004 name="input.b.page3.isat004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat004
            
            #add-point:AFTER FIELD isat004 name="input.a.page3.isat004"
            #應用 a05 樣板自動產生(Version:2)
            #確認資料無重複
            IF  g_isbf_m.isbfcomp IS NOT NULL AND g_isbf_m.isbfdocno IS NOT NULL AND g_isbg3_d[g_detail_idx].isatseq IS NOT NULL AND g_isbg3_d[g_detail_idx].isat003 IS NOT NULL AND g_isbg3_d[g_detail_idx].isat004 IS NOT NULL THEN 
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_isbf_m.isbfcomp != g_isbfcomp_t OR g_isbf_m.isbfdocno != g_isbfdocno_t OR g_isbg3_d[g_detail_idx].isatseq != g_isbg3_d_t.isatseq OR g_isbg3_d[g_detail_idx].isat003 != g_isbg3_d_t.isat003 OR g_isbg3_d[g_detail_idx].isat004 != g_isbg3_d_t.isat004)) THEN 
                 #IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isbf_m.isbfcomp ||"' AND "|| "isatseq = '"||g_isbf_m.isbfdocno ||"' AND "|| "isat003 = '"||g_isbg3_d[g_detail_idx].isatseq ||"' AND "|| "isat004 = '"||g_isbg3_d[g_detail_idx].isat003 ||"'",'std-00004',0) THEN    #151020-00003#3 mark
                  IF NOT ap_chk_notDup("","SELECT COUNT(*) FROM isat_t WHERE "||"isatent = '" ||g_enterprise|| "' AND "||"isatcomp = '"||g_isbf_m.isbfcomp ||"' AND "|| "isatseq = '"||g_isbg3_d[g_detail_idx].isatseq ||"' AND "|| "isat003 = '"||g_isbg3_d[g_detail_idx].isat003 ||"' AND "|| "isat004 = '"||g_isbg3_d[g_detail_idx].isat004 ||"'",'std-00004',0) THEN     #151020-00003#3 add
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF


            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat004
            #add-point:ON CHANGE isat004 name="input.g.page3.isat004"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat006
            #add-point:BEFORE FIELD isat006 name="input.b.page3.isat006"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat006
            
            #add-point:AFTER FIELD isat006 name="input.a.page3.isat006"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat006
            #add-point:ON CHANGE isat006 name="input.g.page3.isat006"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat005
            #add-point:BEFORE FIELD isat005 name="input.b.page3.isat005"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat005
            
            #add-point:AFTER FIELD isat005 name="input.a.page3.isat005"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat005
            #add-point:ON CHANGE isat005 name="input.g.page3.isat005"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat022
            #add-point:BEFORE FIELD isat022 name="input.b.page3.isat022"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat022
            
            #add-point:AFTER FIELD isat022 name="input.a.page3.isat022"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat022
            #add-point:ON CHANGE isat022 name="input.g.page3.isat022"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat113
            #add-point:BEFORE FIELD isat113 name="input.b.page3.isat113"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat113
            
            #add-point:AFTER FIELD isat113 name="input.a.page3.isat113"
            #發票未稅
            IF NOT cl_null(g_isbg3_d[l_ac].isat113)THEN
               IF g_isbg3_d_o.isat113 <> g_isbg3_d[l_ac].isat113 OR cl_null(g_isbg3_d_o.isat113) THEN
                  CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah113,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah113
                  IF g_isbg3_d[l_ac].isat115 < g_isbg3_d[l_ac].isat113 THEN
                     LET g_isbg3_d[l_ac].isat115 = g_isbg3_d[l_ac].isat113
                  END IF
                   
                  IF NOT cl_null(g_isbg3_d[l_ac].isat115)THEN
                     LET g_isbg3_d[l_ac].isat114 = g_isbg3_d[l_ac].isat115 - g_isbg3_d[l_ac].isat113
                     DISPLAY BY NAME g_isbg3_d[l_ac].isat114
                     LET g_isbg3_d_o.isat114 = g_isbg3_d[l_ac].isat114
                  END IF                   
               END IF
            END IF
            LET g_isbg3_d_o.isat113 = g_isbg3_d[l_ac].isat113
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat113
            #add-point:ON CHANGE isat113 name="input.g.page3.isat113"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat114
            #add-point:BEFORE FIELD isat114 name="input.b.page3.isat114"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat114
            
            #add-point:AFTER FIELD isat114 name="input.a.page3.isat114"
            IF NOT cl_null(g_isbg3_d[l_ac].isat114)THEN
               IF g_isbg3_d_o.isat114 <> g_isbg3_d[l_ac].isat114 OR cl_null(g_isbg3_d_o.isat114) THEN
                  CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah114,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah114

                  IF NOT cl_null(g_isbg3_d[l_ac].isat113)THEN
                     LET g_isbg3_d[l_ac].isat115 = g_isbg3_d[l_ac].isat113 + g_isbg3_d[l_ac].isat114
                     DISPLAY BY NAME g_isbg3_d[l_ac].isat115
                     LET g_isbg3_d_o.isat115 = g_isbg3_d[l_ac].isat115
                  END IF
               END IF
            END IF
            LET g_isbg3_d_o.isat114 = g_isbg3_d[l_ac].isat114
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat114
            #add-point:ON CHANGE isat114 name="input.g.page3.isat114"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat115
            #add-point:BEFORE FIELD isat115 name="input.b.page3.isat115"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat115
            
            #add-point:AFTER FIELD isat115 name="input.a.page3.isat115"
            
            IF NOT cl_null(g_isbg3_d[l_ac].isat115)THEN
               IF g_isbg3_d_o.isat115 <> g_isbg3_d[l_ac].isat115 OR cl_null(g_isbg3_d_o.isat115) THEN
                  CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah115,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah115
                  IF g_isbg3_d[l_ac].isat115 < g_isbg3_d[l_ac].isat113 THEN
                     LET g_isbg3_d[l_ac].isat113 = g_isbg3_d[l_ac].isat115
                  END IF                    
                  
                  IF NOT cl_null(g_isbg3_d[l_ac].isat113)THEN
                     LET g_isbg3_d[l_ac].isat114 = g_isbg3_d[l_ac].isat115 - g_isbg3_d[l_ac].isat113
                     DISPLAY BY NAME g_isbg3_d[l_ac].isat113
                     LET g_isbg3_d_o.isat113 = g_isbg3_d[l_ac].isat113
                  END IF
                  
               END IF
            END IF
            LET g_isbg3_d_o.isat115 = g_isbg3_d[l_ac].isat115
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat115
            #add-point:ON CHANGE isat115 name="input.g.page3.isat115"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat103
            #add-point:BEFORE FIELD isat103 name="input.b.page3.isat103"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat103
            
            #add-point:AFTER FIELD isat103 name="input.a.page3.isat103"
            #發票未稅
            IF NOT cl_null(g_isbg3_d[l_ac].isat103)THEN
               IF g_isbg3_d_o.isat103 <> g_isbg3_d[l_ac].isat103 OR cl_null(g_isbg3_d_o.isat103) THEN
                  
                  #未稅+稅額 = 含稅
#                  IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
#                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
#                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
#                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
#                     END IF                  
#                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104

                     IF g_isbg3_d[l_ac].isat105 < g_isbg3_d[l_ac].isat103 THEN
                        LET g_isbg3_d[l_ac].isat105 = g_isbg3_d[l_ac].isat103
                     END IF
                      
                     IF NOT cl_null(g_isbg3_d[l_ac].isat105)THEN
                        LET g_isbg3_d[l_ac].isat104 = g_isbg3_d[l_ac].isat105 - g_isbg3_d[l_ac].isat103
                        DISPLAY BY NAME g_isbg3_d[l_ac].isat104
                        LET g_isbg3_d_o.isat104 = g_isbg3_d[l_ac].isat104
                     END IF
#                 END IF
               END IF
            END IF
            LET g_isbg3_d_o.isat103 = g_isbg3_d[l_ac].isat103
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat103
            #add-point:ON CHANGE isat103 name="input.g.page3.isat103"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat104
            #add-point:BEFORE FIELD isat104 name="input.b.page3.isat104"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat104
            
            #add-point:AFTER FIELD isat104 name="input.a.page3.isat104"
            #發票未稅
            IF NOT cl_null(g_isbg3_d[l_ac].isat104)THEN
               IF g_isbg3_d_o.isat104 <> g_isbg3_d[l_ac].isat104 OR cl_null(g_isbg3_d_o.isat104) THEN
                  
                  #未稅+稅額 = 含稅
#                  IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
#                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
#                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
#                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
#                     END IF                  
#                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104
                     IF NOT cl_null(g_isbg3_d[l_ac].isat103)THEN
                        LET g_isbg3_d[l_ac].isat105 = g_isbg3_d[l_ac].isat103 + g_isbg3_d[l_ac].isat104
                        DISPLAY BY NAME g_isbg3_d[l_ac].isat105
                        LET g_isbg3_d_o.isat105 = g_isbg3_d[l_ac].isat105
                     END IF
#                 END IF
               END IF
            END IF
            LET g_isbg3_d_o.isat104 = g_isbg3_d[l_ac].isat104
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat104
            #add-point:ON CHANGE isat104 name="input.g.page3.isat104"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat105
            #add-point:BEFORE FIELD isat105 name="input.b.page3.isat105"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat105
            
            #add-point:AFTER FIELD isat105 name="input.a.page3.isat105"
            #發票未稅
            IF NOT cl_null(g_isbg3_d[l_ac].isat105)THEN
               IF g_isbg3_d_o.isat105 <> g_isbg3_d[l_ac].isat105 OR cl_null(g_isbg3_d_o.isat105) THEN
                  
                  #未稅+稅額 = 含稅
#                  IF NOT cl_null(g_isbg2_d[l_ac].isah007)THEN
#                     LET g_isbg2_d[l_ac].isah104 = g_isbg2_d[l_ac].isah103 * (g_isbg2_d[l_ac].isah007 / 100)
#                     IF NOT cl_null(g_glaald) AND NOT cl_null(g_glaa.glaa001)THEN
#                        CALL s_curr_round_ld('1',g_glaald,g_glaa.glaa001,g_isbg2_d[l_ac].isah104,2) RETURNING g_sub_success,g_errno,g_isbg2_d[l_ac].isah104
#                     END IF                  
#                     DISPLAY BY NAME g_isbg2_d[l_ac].isah104

                     IF g_isbg3_d[l_ac].isat105 < g_isbg3_d[l_ac].isat103 THEN
                        LET g_isbg3_d[l_ac].isat103 = g_isbg3_d[l_ac].isat105
                     END IF                    
                     
                     IF NOT cl_null(g_isbg3_d[l_ac].isat103)THEN
                        LET g_isbg3_d[l_ac].isat104 = g_isbg3_d[l_ac].isat105 - g_isbg3_d[l_ac].isat103
                        DISPLAY BY NAME g_isbg3_d[l_ac].isat103
                        LET g_isbg3_d_o.isat103 = g_isbg3_d[l_ac].isat103
                     END IF
#                 END IF
               END IF
            END IF
            LET g_isbg3_d_o.isat105 = g_isbg3_d[l_ac].isat105
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat105
            #add-point:ON CHANGE isat105 name="input.g.page3.isat105"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat007
            #add-point:BEFORE FIELD isat007 name="input.b.page3.isat007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat007
            
            #add-point:AFTER FIELD isat007 name="input.a.page3.isat007"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat007
            #add-point:ON CHANGE isat007 name="input.g.page3.isat007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat014
            #add-point:BEFORE FIELD isat014 name="input.b.page3.isat014"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat014
            
            #add-point:AFTER FIELD isat014 name="input.a.page3.isat014"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat014
            #add-point:ON CHANGE isat014 name="input.g.page3.isat014"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat106
            #add-point:BEFORE FIELD isat106 name="input.b.page3.isat106"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat106
            
            #add-point:AFTER FIELD isat106 name="input.a.page3.isat106"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat106
            #add-point:ON CHANGE isat106 name="input.g.page3.isat106"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat107
            #add-point:BEFORE FIELD isat107 name="input.b.page3.isat107"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat107
            
            #add-point:AFTER FIELD isat107 name="input.a.page3.isat107"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat107
            #add-point:ON CHANGE isat107 name="input.g.page3.isat107"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat017
            #add-point:BEFORE FIELD isat017 name="input.b.page3.isat017"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat017
            
            #add-point:AFTER FIELD isat017 name="input.a.page3.isat017"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat017
            #add-point:ON CHANGE isat017 name="input.g.page3.isat017"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat001
            #add-point:BEFORE FIELD isat001 name="input.b.page3.isat001"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat001
            
            #add-point:AFTER FIELD isat001 name="input.a.page3.isat001"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat001
            #add-point:ON CHANGE isat001 name="input.g.page3.isat001"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat002
            #add-point:BEFORE FIELD isat002 name="input.b.page3.isat002"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat002
            
            #add-point:AFTER FIELD isat002 name="input.a.page3.isat002"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat002
            #add-point:ON CHANGE isat002 name="input.g.page3.isat002"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat008
            #add-point:BEFORE FIELD isat008 name="input.b.page3.isat008"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat008
            
            #add-point:AFTER FIELD isat008 name="input.a.page3.isat008"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat008
            #add-point:ON CHANGE isat008 name="input.g.page3.isat008"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat009
            #add-point:BEFORE FIELD isat009 name="input.b.page3.isat009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat009
            
            #add-point:AFTER FIELD isat009 name="input.a.page3.isat009"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat009
            #add-point:ON CHANGE isat009 name="input.g.page3.isat009"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat010
            #add-point:BEFORE FIELD isat010 name="input.b.page3.isat010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat010
            
            #add-point:AFTER FIELD isat010 name="input.a.page3.isat010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat010
            #add-point:ON CHANGE isat010 name="input.g.page3.isat010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat011
            #add-point:BEFORE FIELD isat011 name="input.b.page3.isat011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat011
            
            #add-point:AFTER FIELD isat011 name="input.a.page3.isat011"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat011
            #add-point:ON CHANGE isat011 name="input.g.page3.isat011"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat012
            #add-point:BEFORE FIELD isat012 name="input.b.page3.isat012"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat012
            
            #add-point:AFTER FIELD isat012 name="input.a.page3.isat012"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat012
            #add-point:ON CHANGE isat012 name="input.g.page3.isat012"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat013
            #add-point:BEFORE FIELD isat013 name="input.b.page3.isat013"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat013
            
            #add-point:AFTER FIELD isat013 name="input.a.page3.isat013"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat013
            #add-point:ON CHANGE isat013 name="input.g.page3.isat013"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat015
            #add-point:BEFORE FIELD isat015 name="input.b.page3.isat015"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat015
            
            #add-point:AFTER FIELD isat015 name="input.a.page3.isat015"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat015
            #add-point:ON CHANGE isat015 name="input.g.page3.isat015"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat016
            #add-point:BEFORE FIELD isat016 name="input.b.page3.isat016"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat016
            
            #add-point:AFTER FIELD isat016 name="input.a.page3.isat016"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat016
            #add-point:ON CHANGE isat016 name="input.g.page3.isat016"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat018
            #add-point:BEFORE FIELD isat018 name="input.b.page3.isat018"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat018
            
            #add-point:AFTER FIELD isat018 name="input.a.page3.isat018"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat018
            #add-point:ON CHANGE isat018 name="input.g.page3.isat018"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat019
            #add-point:BEFORE FIELD isat019 name="input.b.page3.isat019"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat019
            
            #add-point:AFTER FIELD isat019 name="input.a.page3.isat019"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat019
            #add-point:ON CHANGE isat019 name="input.g.page3.isat019"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat020
            #add-point:BEFORE FIELD isat020 name="input.b.page3.isat020"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat020
            
            #add-point:AFTER FIELD isat020 name="input.a.page3.isat020"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat020
            #add-point:ON CHANGE isat020 name="input.g.page3.isat020"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat021
            #add-point:BEFORE FIELD isat021 name="input.b.page3.isat021"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat021
            
            #add-point:AFTER FIELD isat021 name="input.a.page3.isat021"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat021
            #add-point:ON CHANGE isat021 name="input.g.page3.isat021"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat023
            #add-point:BEFORE FIELD isat023 name="input.b.page3.isat023"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat023
            
            #add-point:AFTER FIELD isat023 name="input.a.page3.isat023"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat023
            #add-point:ON CHANGE isat023 name="input.g.page3.isat023"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat024
            #add-point:BEFORE FIELD isat024 name="input.b.page3.isat024"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat024
            
            #add-point:AFTER FIELD isat024 name="input.a.page3.isat024"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat024
            #add-point:ON CHANGE isat024 name="input.g.page3.isat024"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat100
            #add-point:BEFORE FIELD isat100 name="input.b.page3.isat100"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat100
            
            #add-point:AFTER FIELD isat100 name="input.a.page3.isat100"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat100
            #add-point:ON CHANGE isat100 name="input.g.page3.isat100"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat101
            #add-point:BEFORE FIELD isat101 name="input.b.page3.isat101"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat101
            
            #add-point:AFTER FIELD isat101 name="input.a.page3.isat101"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat101
            #add-point:ON CHANGE isat101 name="input.g.page3.isat101"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat201
            #add-point:BEFORE FIELD isat201 name="input.b.page3.isat201"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat201
            
            #add-point:AFTER FIELD isat201 name="input.a.page3.isat201"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat201
            #add-point:ON CHANGE isat201 name="input.g.page3.isat201"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat202
            #add-point:BEFORE FIELD isat202 name="input.b.page3.isat202"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat202
            
            #add-point:AFTER FIELD isat202 name="input.a.page3.isat202"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat202
            #add-point:ON CHANGE isat202 name="input.g.page3.isat202"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat203
            #add-point:BEFORE FIELD isat203 name="input.b.page3.isat203"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat203
            
            #add-point:AFTER FIELD isat203 name="input.a.page3.isat203"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat203
            #add-point:ON CHANGE isat203 name="input.g.page3.isat203"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat204
            #add-point:BEFORE FIELD isat204 name="input.b.page3.isat204"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat204
            
            #add-point:AFTER FIELD isat204 name="input.a.page3.isat204"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat204
            #add-point:ON CHANGE isat204 name="input.g.page3.isat204"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat205
            #add-point:BEFORE FIELD isat205 name="input.b.page3.isat205"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat205
            
            #add-point:AFTER FIELD isat205 name="input.a.page3.isat205"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat205
            #add-point:ON CHANGE isat205 name="input.g.page3.isat205"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat206
            #add-point:BEFORE FIELD isat206 name="input.b.page3.isat206"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat206
            
            #add-point:AFTER FIELD isat206 name="input.a.page3.isat206"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat206
            #add-point:ON CHANGE isat206 name="input.g.page3.isat206"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat207
            #add-point:BEFORE FIELD isat207 name="input.b.page3.isat207"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat207
            
            #add-point:AFTER FIELD isat207 name="input.a.page3.isat207"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat207
            #add-point:ON CHANGE isat207 name="input.g.page3.isat207"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat208
            #add-point:BEFORE FIELD isat208 name="input.b.page3.isat208"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat208
            
            #add-point:AFTER FIELD isat208 name="input.a.page3.isat208"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat208
            #add-point:ON CHANGE isat208 name="input.g.page3.isat208"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isat209
            #add-point:BEFORE FIELD isat209 name="input.b.page3.isat209"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isat209
            
            #add-point:AFTER FIELD isat209 name="input.a.page3.isat209"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isat209
            #add-point:ON CHANGE isat209 name="input.g.page3.isat209"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD isatdocdt
            #add-point:BEFORE FIELD isatdocdt name="input.b.page3.isatdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD isatdocdt
            
            #add-point:AFTER FIELD isatdocdt name="input.a.page3.isatdocdt"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE isatdocdt
            #add-point:ON CHANGE isatdocdt name="input.g.page3.isatdocdt"
            
            #END add-point 
 
 
 
                  #Ctrlp:input.c.page3.isatseq
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatseq
            #add-point:ON ACTION controlp INFIELD isatseq name="input.c.page3.isatseq"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isatsite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatsite
            #add-point:ON ACTION controlp INFIELD isatsite name="input.c.page3.isatsite"
            #161017-00005#1 add --s
            CALL s_fin_account_center_sons_query('3',g_isbf_m.isbfsite,g_isbf_m.isbfdocdt,'1')
            CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
            CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
            #161017-00005#1 add --e 
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE

            LET g_qryparam.default1 = g_isbg3_d[l_ac].isatsite             #給予default
            LET g_qryparam.where = " ooef001 IN ",g_wc_isbfsite CLIPPED,
                                   " AND ooef201 = 'Y'",   #161006-00005#15   add  #161017-00005#1 add","
                                   " AND ooef017 ='",g_isbf_m.isbfcomp,"' " #161017-00005#1 add
            CALL q_ooef001()                                #呼叫開窗

            LET g_isbg3_d[l_ac].isatsite = g_qryparam.return1              
            DISPLAY BY NAME g_isbg3_d[l_ac].isatsite            #
            NEXT FIELD isatsite   
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat003
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat003
            #add-point:ON ACTION controlp INFIELD isat003 name="input.c.page3.isat003"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat004
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat004
            #add-point:ON ACTION controlp INFIELD isat004 name="input.c.page3.isat004"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat006
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat006
            #add-point:ON ACTION controlp INFIELD isat006 name="input.c.page3.isat006"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat005
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat005
            #add-point:ON ACTION controlp INFIELD isat005 name="input.c.page3.isat005"
     
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat022
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat022
            #add-point:ON ACTION controlp INFIELD isat022 name="input.c.page3.isat022"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat113
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat113
            #add-point:ON ACTION controlp INFIELD isat113 name="input.c.page3.isat113"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat114
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat114
            #add-point:ON ACTION controlp INFIELD isat114 name="input.c.page3.isat114"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat115
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat115
            #add-point:ON ACTION controlp INFIELD isat115 name="input.c.page3.isat115"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat103
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat103
            #add-point:ON ACTION controlp INFIELD isat103 name="input.c.page3.isat103"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat104
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat104
            #add-point:ON ACTION controlp INFIELD isat104 name="input.c.page3.isat104"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat105
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat105
            #add-point:ON ACTION controlp INFIELD isat105 name="input.c.page3.isat105"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat007
            #add-point:ON ACTION controlp INFIELD isat007 name="input.c.page3.isat007"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat014
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat014
            #add-point:ON ACTION controlp INFIELD isat014 name="input.c.page3.isat014"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat106
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat106
            #add-point:ON ACTION controlp INFIELD isat106 name="input.c.page3.isat106"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat107
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat107
            #add-point:ON ACTION controlp INFIELD isat107 name="input.c.page3.isat107"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat017
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat017
            #add-point:ON ACTION controlp INFIELD isat017 name="input.c.page3.isat017"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat001
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat001
            #add-point:ON ACTION controlp INFIELD isat001 name="input.c.page3.isat001"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat002
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat002
            #add-point:ON ACTION controlp INFIELD isat002 name="input.c.page3.isat002"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat008
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat008
            #add-point:ON ACTION controlp INFIELD isat008 name="input.c.page3.isat008"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat009
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat009
            #add-point:ON ACTION controlp INFIELD isat009 name="input.c.page3.isat009"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat010
            #add-point:ON ACTION controlp INFIELD isat010 name="input.c.page3.isat010"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat011
            #add-point:ON ACTION controlp INFIELD isat011 name="input.c.page3.isat011"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat012
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat012
            #add-point:ON ACTION controlp INFIELD isat012 name="input.c.page3.isat012"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat013
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat013
            #add-point:ON ACTION controlp INFIELD isat013 name="input.c.page3.isat013"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat015
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat015
            #add-point:ON ACTION controlp INFIELD isat015 name="input.c.page3.isat015"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat016
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat016
            #add-point:ON ACTION controlp INFIELD isat016 name="input.c.page3.isat016"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat018
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat018
            #add-point:ON ACTION controlp INFIELD isat018 name="input.c.page3.isat018"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat019
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat019
            #add-point:ON ACTION controlp INFIELD isat019 name="input.c.page3.isat019"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat020
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat020
            #add-point:ON ACTION controlp INFIELD isat020 name="input.c.page3.isat020"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat021
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat021
            #add-point:ON ACTION controlp INFIELD isat021 name="input.c.page3.isat021"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat023
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat023
            #add-point:ON ACTION controlp INFIELD isat023 name="input.c.page3.isat023"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat024
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat024
            #add-point:ON ACTION controlp INFIELD isat024 name="input.c.page3.isat024"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat100
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat100
            #add-point:ON ACTION controlp INFIELD isat100 name="input.c.page3.isat100"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat101
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat101
            #add-point:ON ACTION controlp INFIELD isat101 name="input.c.page3.isat101"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat201
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat201
            #add-point:ON ACTION controlp INFIELD isat201 name="input.c.page3.isat201"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat202
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat202
            #add-point:ON ACTION controlp INFIELD isat202 name="input.c.page3.isat202"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat203
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat203
            #add-point:ON ACTION controlp INFIELD isat203 name="input.c.page3.isat203"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat204
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat204
            #add-point:ON ACTION controlp INFIELD isat204 name="input.c.page3.isat204"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat205
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat205
            #add-point:ON ACTION controlp INFIELD isat205 name="input.c.page3.isat205"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat206
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat206
            #add-point:ON ACTION controlp INFIELD isat206 name="input.c.page3.isat206"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat207
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat207
            #add-point:ON ACTION controlp INFIELD isat207 name="input.c.page3.isat207"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat208
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat208
            #add-point:ON ACTION controlp INFIELD isat208 name="input.c.page3.isat208"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isat209
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isat209
            #add-point:ON ACTION controlp INFIELD isat209 name="input.c.page3.isat209"
            
            #END add-point
 
 
         #Ctrlp:input.c.page3.isatdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD isatdocdt
            #add-point:ON ACTION controlp INFIELD isatdocdt name="input.c.page3.isatdocdt"
            
            #END add-point
 
 
 
 
         AFTER ROW
            #add-point:單身page3 after_row name="input.body3.after_row"
            
            #end add-point
            LET l_ac = ARR_CURR()
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               IF l_cmd = 'u' THEN
                  LET g_isbg3_d[l_ac].* = g_isbg3_d_t.*
               END IF
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = '' 
               LET g_errparam.code   = 9001 
               LET g_errparam.popup  = FALSE 
               CLOSE aist330_bcl3
               CALL s_transaction_end('N','0')
               CALL cl_err()
               EXIT DIALOG 
            END IF
            
            #其他table進行unlock
            
            CALL aist330_unlock_b("isat_t","'3'")
            CALL s_transaction_end('Y','0')
            #add-point:單身page3 after_row2 name="input.body3.after_row2"
            
            #end add-point
 
         AFTER INPUT
            #add-point:input段after input  name="input.body3.after_input"
            IF l_changeb3 = 'Y' THEN
               CALL aist330_autoupd_isah()
            END IF
            LET l_changeb3 = 'N'
            #end add-point   
    
         ON ACTION controlo
            IF l_insert THEN
               LET li_reproduce = l_ac_t
               LET li_reproduce_target = l_ac
               LET g_isbg3_d[li_reproduce_target].* = g_isbg3_d[li_reproduce].*
 
               LET g_isbg3_d[li_reproduce_target].isatseq = NULL
            ELSE
               CALL FGL_SET_ARR_CURR(g_isbg3_d.getLength()+1)
               LET lb_reproduce = TRUE
               LET li_reproduce = l_ac
               LET li_reproduce_target = g_isbg3_d.getLength()+1
            END IF
            
      END INPUT
 
      
 
 
 
 
{</section>}
 
{<section id="aist330.input.other" >}
      
      #add-point:自定義input name="input.more_input"
      
      #end add-point
    
      BEFORE DIALOG 
         #CALL cl_err_collect_init()    
         #add-point:input段before dialog name="input.before_dialog"
         
         #end add-point    
         #重新導回資料到正確位置上
         CALL DIALOG.setCurrentRow("s_detail1",g_idx_group.getValue("'1',"))      
         CALL DIALOG.setCurrentRow("s_detail2",g_idx_group.getValue("'2',"))
         CALL DIALOG.setCurrentRow("s_detail3",g_idx_group.getValue("'3',"))
 
         #新增時強制從單頭開始填
         IF p_cmd = 'a' THEN
            #add-point:input段next_field name="input.next_field"
            
            #end add-point  
            NEXT FIELD isbfcomp
         ELSE
            CASE g_aw
               WHEN "s_detail1"
                  NEXT FIELD isbgseq
               WHEN "s_detail2"
                  NEXT FIELD isahseq
               WHEN "s_detail3"
                  NEXT FIELD isatseq
 
               #add-point:input段modify_detail  name="input.modify_detail.other"
               
               #end add-point  
            END CASE
         END IF
      
      AFTER DIALOG
         #add-point:input段after_dialog name="input.after_dialog"
         
         #end add-point    
         
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)
 
      ON ACTION controlr
         CALL cl_show_req_fields()
 
      ON ACTION controls
         IF g_header_hidden THEN
            CALL gfrm_curr.setElementHidden("vb_master",0)
            CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
            LET g_header_hidden = 0     #visible
         ELSE
            CALL gfrm_curr.setElementHidden("vb_master",1)
            CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
            LET g_header_hidden = 1     #hidden     
         END IF
 
      ON ACTION accept
         #add-point:input段accept  name="input.accept"
         
         #end add-point    
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄)
         #add-point:input段cancel name="input.cancel"
         
         #end add-point  
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         #add-point:input段close name="input.close"
         
         #end add-point  
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         #add-point:input段exit name="input.exit"
         
         #end add-point
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   #add-point:input段after input  name="input.after_input"
   
   #end add-point    
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.show" >}
#+ 單頭資料重新顯示及單身資料重抓
PRIVATE FUNCTION aist330_show()
   #add-point:show段define(客製用) name="show.define_customerization"
   
   #end add-point  
   DEFINE l_ac_t    LIKE type_t.num10
   #add-point:show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show.define"
   
   #end add-point  
   
   #add-point:Function前置處理 name="show.before"
   
   #end add-point
   
   
   
   IF g_bfill = "Y" THEN
      CALL aist330_b_fill() #單身填充
      CALL aist330_b_fill2('0') #單身填充
   END IF
     
   #帶出公用欄位reference值
   #應用 a12 樣板自動產生(Version:4)
 
 
 
   
   #顯示followup圖示
   #應用 a48 樣板自動產生(Version:3)
   CALL aist330_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
  
 
 
 
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:show段reference name="show.head.reference"
   LET g_glaald = NULL
   SELECT glaald INTO g_glaald FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaacomp = g_isbf_m.isbfcomp
      AND glaa014 = 'Y'
   CALL s_ld_sel_glaa(g_glaald,'glaacomp|glaa001|glaa004|glaa015|glaa016|glaa017|glaa019|glaa020|glaa021|glaa024|glaa121')
        RETURNING g_sub_success,g_glaa.*
   LET g_ooef019 = NULL
   SELECT ooef019 INTO g_ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_isbf_m.isbfcomp
   INITIALIZE g_isai.* TO NULL
   SELECT * INTO g_isai.* FROM isai_t
    WHERE isaient = g_enterprise
      AND isai001 = g_ooef019
   CALL aist330_set_visible()
   CALL aist330_set_no_visible()
   CALL s_desc_get_person_desc(g_isbf_m.isbf001) RETURNING g_isbf_m.isbf001_desc
   DISPLAY BY NAME g_isbf_m.isbf001_desc 
   LET g_isbf_m.isbfcomp_desc = s_desc_get_department_desc(g_isbf_m_t.isbfcomp)
   DISPLAY BY NAME g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc 
   CALL s_desc_get_department_desc(g_isbf_m.isbfsite) RETURNING g_isbf_m.isbfsite_desc                    
   DISPLAY BY NAME g_isbf_m.isbfsite_desc
   CALL s_fin_account_center_sons_query('3',g_isbf_m.isbfsite,g_isbf_m.isbfdocdt,'1')
   CALL s_fin_account_center_sons_str() RETURNING g_wc_isbfsite
   CALL s_fin_get_wc_str(g_wc_isbfsite) RETURNING g_wc_isbfsite
   CALL s_fin_account_center_ld_str() RETURNING g_wc_ld
   CALL s_fin_get_wc_str(g_wc_ld) RETURNING g_wc_ld
   CALL s_fin_account_center_comp_str()RETURNING g_wc_comp
   CALL s_fin_get_wc_str(g_wc_comp) RETURNING g_wc_comp
   #end add-point
   
   #遮罩相關處理
   LET g_isbf_m_mask_o.* =  g_isbf_m.*
   CALL aist330_isbf_t_mask()
   LET g_isbf_m_mask_n.* =  g_isbf_m.*
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfsite_desc,g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc, 
       g_isbf_m.isbf001,g_isbf_m.isbf001_desc,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002, 
       g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfownid_desc, 
       g_isbf_m.isbfowndp,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp, 
       g_isbf_m.isbfcrtdp_desc,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmodid_desc,g_isbf_m.isbfmoddt, 
       g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfid_desc,g_isbf_m.isbfcnfdt
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_isbf_m.isbfstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         
      END CASE
 
 
 
   
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_isbg_d.getLength()
      #add-point:show段單身reference name="show.body.reference"
      
      #end add-point
   END FOR
   
   FOR l_ac = 1 TO g_isbg2_d.getLength()
      #add-point:show段單身reference name="show.body2.reference"
      
      #end add-point
   END FOR
   FOR l_ac = 1 TO g_isbg3_d.getLength()
      #add-point:show段單身reference name="show.body3.reference"
      
      #end add-point
   END FOR
 
   
    
   
   #add-point:show段other name="show.other"
   
   #end add-point  
   
   LET l_ac = l_ac_t
   
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()     
 
   CALL aist330_detail_show()
 
   #add-point:show段之後 name="show.after"
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.detail_show" >}
#+ 第二階單身reference
PRIVATE FUNCTION aist330_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point  
   #add-point:detail_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
   
   #end add-point  
   
   #add-point:Function前置處理 name="detail_show.before"
   
   #end add-point
   
   #add-point:detail_show段之後 name="detail_show.after"
   
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.reproduce" >}
#+ 資料複製
PRIVATE FUNCTION aist330_reproduce()
   #add-point:reproduce段define(客製用) name="reproduce.define_customerization"
   
   #end add-point   
   DEFINE l_newno     LIKE isbf_t.isbfcomp 
   DEFINE l_oldno     LIKE isbf_t.isbfcomp 
   DEFINE l_newno02     LIKE isbf_t.isbfdocno 
   DEFINE l_oldno02     LIKE isbf_t.isbfdocno 
 
   DEFINE l_master    RECORD LIKE isbf_t.* #此變數樣板目前無使用
   DEFINE l_detail    RECORD LIKE isbg_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE isah_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE isat_t.* #此變數樣板目前無使用
 
 
 
   DEFINE l_cnt       LIKE type_t.num10
   #add-point:reproduce段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="reproduce.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="reproduce.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET g_master_insert = FALSE
   
   IF g_isbf_m.isbfcomp IS NULL
   OR g_isbf_m.isbfdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
    
   LET g_isbfcomp_t = g_isbf_m.isbfcomp
   LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
    
   LET g_isbf_m.isbfcomp = ""
   LET g_isbf_m.isbfdocno = ""
 
 
   CALL cl_set_head_visible("","YES")
 
   #公用欄位給予預設值
   #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_isbf_m.isbfownid = g_user
      LET g_isbf_m.isbfowndp = g_dept
      LET g_isbf_m.isbfcrtid = g_user
      LET g_isbf_m.isbfcrtdp = g_dept 
      LET g_isbf_m.isbfcrtdt = cl_get_current()
      LET g_isbf_m.isbfmodid = g_user
      LET g_isbf_m.isbfmoddt = cl_get_current()
      LET g_isbf_m.isbfstus = 'N'
 
 
 
   
   CALL s_transaction_begin()
   
   #add-point:複製輸入前 name="reproduce.head.b_input"
   
   #end add-point
   
   #顯示狀態(stus)圖片
         #應用 a21 樣板自動產生(Version:3)
	  #根據當下狀態碼顯示圖片
      CASE g_isbf_m.isbfstus 
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         
      END CASE
 
 
 
   
   #清空key欄位的desc
      LET g_isbf_m.isbfcomp_desc = ''
   DISPLAY BY NAME g_isbf_m.isbfcomp_desc
 
   
   CALL aist330_input("r")
   
   IF INT_FLAG AND NOT g_master_insert THEN
      LET INT_FLAG = 0
      DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
      DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
      LET INT_FLAG = 0
      INITIALIZE g_isbf_m.* TO NULL
      INITIALIZE g_isbg_d TO NULL
      INITIALIZE g_isbg2_d TO NULL
      INITIALIZE g_isbg3_d TO NULL
 
      #add-point:複製取消後 name="reproduce.cancel"
      
      #end add-point
      CALL aist330_show()
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = '' 
      LET g_errparam.code   = 9001 
      LET g_errparam.popup  = FALSE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
   
   #根據資料狀態切換action狀態
   CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce", TRUE)
   CALL aist330_set_act_visible()   
   CALL aist330_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_isbfcomp_t = g_isbf_m.isbfcomp
   LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
   
   #組合新增資料的條件
   LET g_add_browse = " isbfent = " ||g_enterprise|| " AND",
                      " isbfcomp = '", g_isbf_m.isbfcomp, "' "
                      ," AND isbfdocno = '", g_isbf_m.isbfdocno, "' "
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL aist330_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   #add-point:完成複製段落後 name="reproduce.after_reproduce"
   
   #end add-point
   
   CALL aist330_idx_chk()
   
   LET g_data_owner = g_isbf_m.isbfownid      
   LET g_data_dept  = g_isbf_m.isbfowndp
   
   #功能已完成,通報訊息中心
   CALL aist330_msgcentre_notify('reproduce')
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.detail_reproduce" >}
#+ 單身自動複製
PRIVATE FUNCTION aist330_detail_reproduce()
   #add-point:delete段define(客製用) name="detail_reproduce.define_customerization"
   
   #end add-point    
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE isbg_t.* #此變數樣板目前無使用
   DEFINE l_detail2    RECORD LIKE isah_t.* #此變數樣板目前無使用
 
   DEFINE l_detail3    RECORD LIKE isat_t.* #此變數樣板目前無使用
 
 
 
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_reproduce.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="detail_reproduce.pre_function"
   
   #end add-point
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE aist330_detail
   
   #add-point:單身複製前1 name="detail_reproduce.body.table1.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM isbg_t
    WHERE isbgent = g_enterprise AND isbgcomp = g_isbfcomp_t
     AND isbgdocno = g_isbfdocno_t
 
    INTO TEMP aist330_detail
 
   #將key修正為調整後   
   UPDATE aist330_detail 
      #更新key欄位
      SET isbgcomp = g_isbf_m.isbfcomp
          , isbgdocno = g_isbf_m.isbfdocno
 
      #更新共用欄位
      
 
   #add-point:單身修改前 name="detail_reproduce.body.table1.b_update"
   
   #end add-point                                       
  
   #將資料塞回原table   
   INSERT INTO isbg_t SELECT * FROM aist330_detail
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "reproduce:",SQLERRMESSAGE 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #add-point:單身複製中1 name="detail_reproduce.body.table1.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist330_detail
   
   #add-point:單身複製後1 name="detail_reproduce.body.table1.a_insert"
   
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table2.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM isah_t 
    WHERE isahent = g_enterprise AND isahcomp = g_isbfcomp_t
      AND isahdocno = g_isbfdocno_t   
 
    INTO TEMP aist330_detail
 
   #將key修正為調整後   
   UPDATE aist330_detail SET isahcomp = g_isbf_m.isbfcomp
                                       , isahdocno = g_isbf_m.isbfdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table2.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO isah_t SELECT * FROM aist330_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table2.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist330_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table2.a_insert"
   
   #end add-point
 
   #add-point:單身複製前 name="detail_reproduce.body.table3.b_insert"
   
   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM isat_t 
    WHERE isatent = g_enterprise AND isatcomp = g_isbfcomp_t
      AND isatdocno = g_isbfdocno_t   
 
    INTO TEMP aist330_detail
 
   #將key修正為調整後   
   UPDATE aist330_detail SET isatcomp = g_isbf_m.isbfcomp
                                       , isatdocno = g_isbf_m.isbfdocno
 
  
   #add-point:單身修改前 name="detail_reproduce.body.table3.b_update"
   
   #end add-point    
 
   #將資料塞回原table   
   INSERT INTO isat_t SELECT * FROM aist330_detail
   
   #add-point:單身複製中 name="detail_reproduce.body.table3.m_insert"
   
   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE aist330_detail
   
   #add-point:單身複製後 name="detail_reproduce.body.table3.a_insert"
   
   #end add-point
 
 
   
 
   
   #多語言複製段落
   
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_isbfcomp_t = g_isbf_m.isbfcomp
   LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.delete" >}
#+ 資料刪除
PRIVATE FUNCTION aist330_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"
   
   #end add-point     
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="delete.pre_function"
   
   #end add-point
   
   IF g_isbf_m.isbfcomp IS NULL
   OR g_isbf_m.isbfdocno IS NULL
 
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
   
   
   
   CALL s_transaction_begin()
 
   OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
   IF STATUS THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aist330_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CLOSE aist330_cl
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN
   END IF
 
   #顯示最新的資料
   EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
       g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003, 
       g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid, 
       g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid, 
       g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp_desc, 
       g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
   
   
   #檢查是否允許此動作
   IF NOT aist330_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #遮罩相關處理
   LET g_isbf_m_mask_o.* =  g_isbf_m.*
   CALL aist330_isbf_t_mask()
   LET g_isbf_m_mask_n.* =  g_isbf_m.*
   
   CALL aist330_show()
   
   #add-point:delete段before ask name="delete.before_ask"
   
   #end add-point 
 
   IF cl_ask_del_master() THEN              #確認一下
   
      #add-point:單頭刪除前 name="delete.head.b_delete"
      
      #end add-point   
      
      #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL aist330_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"
      
      #end add-point   
      CALL cl_doc_remove()  
 
 
 
  
  
      #資料備份
      LET g_isbfcomp_t = g_isbf_m.isbfcomp
      LET g_isbfdocno_t = g_isbf_m.isbfdocno
 
 
      DELETE FROM isbf_t
       WHERE isbfent = g_enterprise AND isbfcomp = g_isbf_m.isbfcomp
         AND isbfdocno = g_isbf_m.isbfdocno
 
       
      #add-point:單頭刪除中 name="delete.head.m_delete"
      
      #end add-point
       
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_isbf_m.isbfcomp,":",SQLERRMESSAGE  
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF
      
      #add-point:單頭刪除後 name="delete.head.a_delete"
      IF NOT s_aooi200_fin_del_docno(g_glaald,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #end add-point
  
      #add-point:單身刪除前 name="delete.body.b_delete"
      
      #end add-point
      
      DELETE FROM isbg_t
       WHERE isbgent = g_enterprise AND isbgcomp = g_isbf_m.isbfcomp
         AND isbgdocno = g_isbf_m.isbfdocno
 
 
      #add-point:單身刪除中 name="delete.body.m_delete"
      
      #end add-point
         
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isbg_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF    
 
      #add-point:單身刪除後 name="delete.body.a_delete"
      
      #end add-point
      
            
                                                               
      #add-point:單身刪除前 name="delete.body.b_delete2"
      
      #end add-point
      DELETE FROM isah_t
       WHERE isahent = g_enterprise AND
             isahcomp = g_isbf_m.isbfcomp AND isahdocno = g_isbf_m.isbfdocno
      #add-point:單身刪除中 name="delete.body.m_delete2"
      
      #end add-point
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete2"
      
      #end add-point
 
      #add-point:單身刪除前 name="delete.body.b_delete3"
      
      #end add-point
      DELETE FROM isat_t
       WHERE isatent = g_enterprise AND
             isatcomp = g_isbf_m.isbfcomp AND isatdocno = g_isbf_m.isbfdocno
      #add-point:單身刪除中 name="delete.body.m_delete3"
      
      #end add-point
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL s_transaction_end('N','0')
         CALL cl_err()
         RETURN
      END IF      
 
      #add-point:單身刪除後 name="delete.body.a_delete3"
      
      #end add-point
 
 
 
 
      
      #修改歷程記錄(刪除)
      IF NOT cl_log_modified_record('','') THEN 
         CLOSE aist330_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
             
      CLEAR FORM
      CALL g_isbg_d.clear() 
      CALL g_isbg2_d.clear()       
      CALL g_isbg3_d.clear()       
 
     
      CALL aist330_ui_browser_refresh()  
      #CALL aist330_ui_headershow()  
      #CALL aist330_ui_detailshow()
 
      #add-point:多語言刪除 name="delete.lang.before_delete"
      
      #end add-point
      
      #單頭多語言刪除
      
      
      #單身多語言刪除
      
      
      
 
   
      #add-point:多語言刪除 name="delete.lang.delete"
      
      #end add-point
      
      IF g_browser_cnt > 0 THEN 
         #CALL aist330_browser_fill("")
         CALL aist330_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
         DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
      ELSE
         CLEAR FORM
      END IF
      
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
 
   CLOSE aist330_cl
 
   #功能已完成,通報訊息中心
   CALL aist330_msgcentre_notify('delete')
    
END FUNCTION
 
{</section>}
 
{<section id="aist330.b_fill" >}
#+ 單身陣列填充
PRIVATE FUNCTION aist330_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"
   
   #end add-point     
   DEFINE p_wc2      STRING
   DEFINE li_idx     LIKE type_t.num10
   #add-point:b_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="b_fill.pre_function"
   
   #end add-point
   
   #清空第一階單身
   CALL g_isbg_d.clear()
   CALL g_isbg2_d.clear()
   CALL g_isbg3_d.clear()
 
 
   #add-point:b_fill段sql_before name="b_fill.sql_before"
   LET g_isat115 = 0
   #end add-point
   
   #判斷是否填充
   IF aist330_fill_chk(1) THEN
      #切換上下筆時不重組SQL
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
      #add-point:b_fill段long_sql_if name="b_fill.long_sql_if"
      
      #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT isbgseq,isbg001,isbg002,isbg003,isbg004  FROM isbg_t",   
                     " INNER JOIN isbf_t ON isbfent = " ||g_enterprise|| " AND isbfcomp = isbgcomp ",
                     " AND isbfdocno = isbgdocno ",
 
                     #"",
                     
                     "",
                     #下層單身所需的join條件
 
                     
                     " WHERE isbgent=? AND isbgcomp=? AND isbgdocno=?"
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段sql_before name="b_fill.body.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isbg_t.isbgseq"
         
         #add-point:單身填充控制 name="b_fill.sql"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist330_pb FROM g_sql
         DECLARE b_fill_cs CURSOR FOR aist330_pb
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
      OPEN b_fill_cs USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
                                               
      FOREACH b_fill_cs INTO g_isbg_d[l_ac].isbgseq,g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isbg_d[l_ac].isbg003, 
          g_isbg_d[l_ac].isbg004
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
         LET g_ooef019 = NULL
         SELECT ooef019 INTO g_ooef019 FROM ooef_t
          WHERE ooefent = g_enterprise
            AND ooef001 = g_isbf_m.isbfcomp
         INITIALIZE g_isai.* TO NULL
         SELECT * INTO g_isai.* FROM isai_t
          WHERE isaient = g_enterprise
            AND isai001 = g_ooef019
         CALL aist330_source_carry(g_isbg_d[l_ac].isbg001,g_isbg_d[l_ac].isbg002,g_isai.isai002)
            RETURNING g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                      g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                      g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                      g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                      g_isbg_d[l_ac].l_isat023,
                      #160106-00005#4-----s
                      g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                      #160106-00005#4-----e
         DISPLAY BY NAME g_isbg_d[l_ac].l_isat001,g_isbg_d[l_ac].l_isat005,
                      g_isbg_d[l_ac].l_isat113,g_isbg_d[l_ac].l_isat114,
                      g_isbg_d[l_ac].l_isat115,g_isbg_d[l_ac].l_isat007,
                      g_isbg_d[l_ac].l_isat010,g_isbg_d[l_ac].isbg003,
                      g_isbg_d[l_ac].l_isat023,
                      #160106-00005#4-----s
                      g_isbg_d[l_ac].isbg004,g_isbg_d[l_ac].l_isafdocdt
                      #160106-00005#4-----e
         LET g_isat115 = g_isat115 + g_isbg_d[l_ac].l_isat115
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = l_ac
               LET g_errparam.code   = 9035 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
    
   #判斷是否填充
   IF aist330_fill_chk(2) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body2.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT isahseq,isahorga,isah003,isah004,isah013,isah005,isah006,isah101, 
             isah103,isah007,isah104,isah105,isah011,isah001,isah002,isah008,isah009,isah010,isah012, 
             isah106,isah113,isah114,isah115,isah116 ,t1.ooefl003 FROM isah_t",   
                     " INNER JOIN  isbf_t ON isbfent = " ||g_enterprise|| " AND isbfcomp = isahcomp ",
                     " AND isbfdocno = isahdocno ",
 
                     "",
                     
                                    " LEFT JOIN ooefl_t t1 ON t1.ooeflent="||g_enterprise||" AND t1.ooefl001=isahorga AND t1.ooefl002='"||g_dlang||"' ",
 
                     " WHERE isahent=? AND isahcomp=? AND isahdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body2.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table2) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table2 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isah_t.isahseq"
         
         #add-point:單身填充控制 name="b_fill.sql2"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist330_pb2 FROM g_sql
         DECLARE b_fill_cs2 CURSOR FOR aist330_pb2
      END IF
    
      LET l_ac = 1
      
      OPEN b_fill_cs2 USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
                                               
      FOREACH b_fill_cs2 INTO g_isbg2_d[l_ac].isahseq,g_isbg2_d[l_ac].isahorga,g_isbg2_d[l_ac].isah003, 
          g_isbg2_d[l_ac].isah004,g_isbg2_d[l_ac].isah013,g_isbg2_d[l_ac].isah005,g_isbg2_d[l_ac].isah006, 
          g_isbg2_d[l_ac].isah101,g_isbg2_d[l_ac].isah103,g_isbg2_d[l_ac].isah007,g_isbg2_d[l_ac].isah104, 
          g_isbg2_d[l_ac].isah105,g_isbg2_d[l_ac].isah011,g_isbg2_d[l_ac].isah001,g_isbg2_d[l_ac].isah002, 
          g_isbg2_d[l_ac].isah008,g_isbg2_d[l_ac].isah009,g_isbg2_d[l_ac].isah010,g_isbg2_d[l_ac].isah012, 
          g_isbg2_d[l_ac].isah106,g_isbg2_d[l_ac].isah113,g_isbg2_d[l_ac].isah114,g_isbg2_d[l_ac].isah115, 
          g_isbg2_d[l_ac].isah116,g_isbg2_d[l_ac].isahorga_desc
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill2.fill"
         
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
   #判斷是否填充
   IF aist330_fill_chk(3) THEN
      IF (g_action_choice = "query" OR cl_null(g_action_choice))
         #add-point:b_fill段long_sql_if name="b_fill.body3.long_sql_if"
         
         #end add-point
      THEN
         LET g_sql = "SELECT  DISTINCT isatseq,isatsite,isat003,isat004,isat006,isat005,isat022,isat113, 
             isat114,isat115,isat103,isat104,isat105,isat007,isat014,isat025,isat106,isat107,isat017, 
             isat001,isat002,isat008,isat009,isat010,isat011,isat012,isat013,isat015,isat016,isat018, 
             isat019,isat020,isat021,isat023,isat024,isat100,isat101,isat201,isat202,isat203,isat204, 
             isat205,isat206,isat207,isat208,isat209,isatdocdt  FROM isat_t",   
                     " INNER JOIN  isbf_t ON isbfent = " ||g_enterprise|| " AND isbfcomp = isatcomp ",
                     " AND isbfdocno = isatdocno ",
 
                     "",
                     
                     
                     " WHERE isatent=? AND isatcomp=? AND isatdocno=?"   
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段fill_sql name="b_fill.body3.fill_sql"
         
         #end add-point
         IF NOT cl_null(g_wc2_table3) THEN
            LET g_sql = g_sql CLIPPED," AND ",g_wc2_table3 CLIPPED
         END IF
         
         #子單身的WC
         
         
         LET g_sql = g_sql, " ORDER BY isat_t.isatseq"
         
         #add-point:單身填充控制 name="b_fill.sql3"
         
         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE aist330_pb3 FROM g_sql
         DECLARE b_fill_cs3 CURSOR FOR aist330_pb3
      END IF
    
      LET l_ac = 1
      
      OPEN b_fill_cs3 USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
                                               
      FOREACH b_fill_cs3 INTO g_isbg3_d[l_ac].isatseq,g_isbg3_d[l_ac].isatsite,g_isbg3_d[l_ac].isat003, 
          g_isbg3_d[l_ac].isat004,g_isbg3_d[l_ac].isat006,g_isbg3_d[l_ac].isat005,g_isbg3_d[l_ac].isat022, 
          g_isbg3_d[l_ac].isat113,g_isbg3_d[l_ac].isat114,g_isbg3_d[l_ac].isat115,g_isbg3_d[l_ac].isat103, 
          g_isbg3_d[l_ac].isat104,g_isbg3_d[l_ac].isat105,g_isbg3_d[l_ac].isat007,g_isbg3_d[l_ac].isat014, 
          g_isbg3_d[l_ac].isat025,g_isbg3_d[l_ac].isat106,g_isbg3_d[l_ac].isat107,g_isbg3_d[l_ac].isat017, 
          g_isbg3_d[l_ac].isat001,g_isbg3_d[l_ac].isat002,g_isbg3_d[l_ac].isat008,g_isbg3_d[l_ac].isat009, 
          g_isbg3_d[l_ac].isat010,g_isbg3_d[l_ac].isat011,g_isbg3_d[l_ac].isat012,g_isbg3_d[l_ac].isat013, 
          g_isbg3_d[l_ac].isat015,g_isbg3_d[l_ac].isat016,g_isbg3_d[l_ac].isat018,g_isbg3_d[l_ac].isat019, 
          g_isbg3_d[l_ac].isat020,g_isbg3_d[l_ac].isat021,g_isbg3_d[l_ac].isat023,g_isbg3_d[l_ac].isat024, 
          g_isbg3_d[l_ac].isat100,g_isbg3_d[l_ac].isat101,g_isbg3_d[l_ac].isat201,g_isbg3_d[l_ac].isat202, 
          g_isbg3_d[l_ac].isat203,g_isbg3_d[l_ac].isat204,g_isbg3_d[l_ac].isat205,g_isbg3_d[l_ac].isat206, 
          g_isbg3_d[l_ac].isat207,g_isbg3_d[l_ac].isat208,g_isbg3_d[l_ac].isat209,g_isbg3_d[l_ac].isatdocdt 
 
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill3.fill"
         
         #end add-point
      
         LET l_ac = l_ac + 1
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
         
      END FOREACH
   END IF
 
 
   
   #add-point:browser_fill段其他table處理 name="browser_fill.other_fill"
   
   #end add-point
   
   CALL g_isbg_d.deleteElement(g_isbg_d.getLength())
   CALL g_isbg2_d.deleteElement(g_isbg2_d.getLength())
   CALL g_isbg3_d.deleteElement(g_isbg3_d.getLength())
 
   
 
   LET l_ac = g_cnt
   LET g_cnt = 0  
   
   FREE aist330_pb
   FREE aist330_pb2
 
   FREE aist330_pb3
 
 
   
   LET li_idx = l_ac
   
   #遮罩相關處理
   FOR l_ac = 1 TO g_isbg_d.getLength()
      LET g_isbg_d_mask_o[l_ac].* =  g_isbg_d[l_ac].*
      CALL aist330_isbg_t_mask()
      LET g_isbg_d_mask_n[l_ac].* =  g_isbg_d[l_ac].*
   END FOR
   
   LET g_isbg2_d_mask_o.* =  g_isbg2_d.*
   FOR l_ac = 1 TO g_isbg2_d.getLength()
      LET g_isbg2_d_mask_o[l_ac].* =  g_isbg2_d[l_ac].*
      CALL aist330_isah_t_mask()
      LET g_isbg2_d_mask_n[l_ac].* =  g_isbg2_d[l_ac].*
   END FOR
   LET g_isbg3_d_mask_o.* =  g_isbg3_d.*
   FOR l_ac = 1 TO g_isbg3_d.getLength()
      LET g_isbg3_d_mask_o[l_ac].* =  g_isbg3_d[l_ac].*
      CALL aist330_isat_t_mask()
      LET g_isbg3_d_mask_n[l_ac].* =  g_isbg3_d[l_ac].*
   END FOR
 
   
   LET l_ac = li_idx
   
   CALL cl_ap_performance_next_end()
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.delete_b" >}
#+ 刪除單身後其他table連動
PRIVATE FUNCTION aist330_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="delete_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete"
      
      #end add-point    
      DELETE FROM isbg_t
       WHERE isbgent = g_enterprise AND
         isbgcomp = ps_keys_bak[1] AND isbgdocno = ps_keys_bak[2] AND isbgseq = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete"
      
      #end add-point    
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = ":",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_isbg_d.deleteElement(li_idx) 
      END IF 
 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete2"
      
      #end add-point    
      DELETE FROM isah_t
       WHERE isahent = g_enterprise AND
             isahcomp = ps_keys_bak[1] AND isahdocno = ps_keys_bak[2] AND isahseq = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete2"
      
      #end add-point    
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_isbg2_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete2"
      
      #end add-point    
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete3"
      
      #end add-point    
      DELETE FROM isat_t
       WHERE isatent = g_enterprise AND
             isatcomp = ps_keys_bak[1] AND isatdocno = ps_keys_bak[2] AND isatseq = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete3"
      
      #end add-point    
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_isbg3_d.deleteElement(li_idx) 
      END IF 
 
      #add-point:delete_b段刪除後 name="delete_b.a_delete3"
      
      #end add-point    
   END IF
 
 
   
 
   
   #add-point:delete_b段other name="delete_b.other"
   
   #end add-point  
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.insert_b" >}
#+ 新增單身後其他table連動
PRIVATE FUNCTION aist330_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"
   
   #end add-point     
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:insert_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="insert_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert"
      
      #end add-point 
      INSERT INTO isbg_t
                  (isbgent,
                   isbgcomp,isbgdocno,
                   isbgseq
                   ,isbg001,isbg002,isbg003,isbg004) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_isbg_d[g_detail_idx].isbg001,g_isbg_d[g_detail_idx].isbg002,g_isbg_d[g_detail_idx].isbg003, 
                       g_isbg_d[g_detail_idx].isbg004)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert"
      
      #end add-point 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isbg_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_isbg_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert"
      
      #end add-point 
   END IF
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert2"
      LET g_isbg2_d[g_detail_idx].isah113 = g_isbg2_d[g_detail_idx].isah103
      LET g_isbg2_d[g_detail_idx].isah114 = g_isbg2_d[g_detail_idx].isah104
      LET g_isbg2_d[g_detail_idx].isah115 = g_isbg2_d[g_detail_idx].isah105
      #end add-point 
      INSERT INTO isah_t
                  (isahent,
                   isahcomp,isahdocno,
                   isahseq
                   ,isahorga,isah003,isah004,isah013,isah005,isah006,isah101,isah103,isah007,isah104,isah105,isah011,isah001,isah002,isah008,isah009,isah010,isah012,isah106,isah113,isah114,isah115,isah116) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_isbg2_d[g_detail_idx].isahorga,g_isbg2_d[g_detail_idx].isah003,g_isbg2_d[g_detail_idx].isah004, 
                       g_isbg2_d[g_detail_idx].isah013,g_isbg2_d[g_detail_idx].isah005,g_isbg2_d[g_detail_idx].isah006, 
                       g_isbg2_d[g_detail_idx].isah101,g_isbg2_d[g_detail_idx].isah103,g_isbg2_d[g_detail_idx].isah007, 
                       g_isbg2_d[g_detail_idx].isah104,g_isbg2_d[g_detail_idx].isah105,g_isbg2_d[g_detail_idx].isah011, 
                       g_isbg2_d[g_detail_idx].isah001,g_isbg2_d[g_detail_idx].isah002,g_isbg2_d[g_detail_idx].isah008, 
                       g_isbg2_d[g_detail_idx].isah009,g_isbg2_d[g_detail_idx].isah010,g_isbg2_d[g_detail_idx].isah012, 
                       g_isbg2_d[g_detail_idx].isah106,g_isbg2_d[g_detail_idx].isah113,g_isbg2_d[g_detail_idx].isah114, 
                       g_isbg2_d[g_detail_idx].isah115,g_isbg2_d[g_detail_idx].isah116)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert2"
      
      #end add-point
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'2'" THEN 
         CALL g_isbg2_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert2"
      
      #end add-point
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert3"
      LET g_isbg3_d[g_detail_idx].isat103 =  g_isbg3_d[g_detail_idx].isat113
      LET g_isbg3_d[g_detail_idx].isat104 =  g_isbg3_d[g_detail_idx].isat114
      LET g_isbg3_d[g_detail_idx].isat105 =  g_isbg3_d[g_detail_idx].isat115
      LET g_isbg3_d[g_detail_idx].isat100 = g_glaa.glaa001
      #end add-point 
      INSERT INTO isat_t
                  (isatent,
                   isatcomp,isatdocno,
                   isatseq
                   ,isatsite,isat003,isat004,isat006,isat005,isat022,isat113,isat114,isat115,isat103,isat104,isat105,isat007,isat014,isat025,isat106,isat107,isat017,isat001,isat002,isat008,isat009,isat010,isat011,isat012,isat013,isat015,isat016,isat018,isat019,isat020,isat021,isat023,isat024,isat100,isat101,isat201,isat202,isat203,isat204,isat205,isat206,isat207,isat208,isat209,isatdocdt) 
            VALUES(g_enterprise,
                   ps_keys[1],ps_keys[2],ps_keys[3]
                   ,g_isbg3_d[g_detail_idx].isatsite,g_isbg3_d[g_detail_idx].isat003,g_isbg3_d[g_detail_idx].isat004, 
                       g_isbg3_d[g_detail_idx].isat006,g_isbg3_d[g_detail_idx].isat005,g_isbg3_d[g_detail_idx].isat022, 
                       g_isbg3_d[g_detail_idx].isat113,g_isbg3_d[g_detail_idx].isat114,g_isbg3_d[g_detail_idx].isat115, 
                       g_isbg3_d[g_detail_idx].isat103,g_isbg3_d[g_detail_idx].isat104,g_isbg3_d[g_detail_idx].isat105, 
                       g_isbg3_d[g_detail_idx].isat007,g_isbg3_d[g_detail_idx].isat014,g_isbg3_d[g_detail_idx].isat025, 
                       g_isbg3_d[g_detail_idx].isat106,g_isbg3_d[g_detail_idx].isat107,g_isbg3_d[g_detail_idx].isat017, 
                       g_isbg3_d[g_detail_idx].isat001,g_isbg3_d[g_detail_idx].isat002,g_isbg3_d[g_detail_idx].isat008, 
                       g_isbg3_d[g_detail_idx].isat009,g_isbg3_d[g_detail_idx].isat010,g_isbg3_d[g_detail_idx].isat011, 
                       g_isbg3_d[g_detail_idx].isat012,g_isbg3_d[g_detail_idx].isat013,g_isbg3_d[g_detail_idx].isat015, 
                       g_isbg3_d[g_detail_idx].isat016,g_isbg3_d[g_detail_idx].isat018,g_isbg3_d[g_detail_idx].isat019, 
                       g_isbg3_d[g_detail_idx].isat020,g_isbg3_d[g_detail_idx].isat021,g_isbg3_d[g_detail_idx].isat023, 
                       g_isbg3_d[g_detail_idx].isat024,g_isbg3_d[g_detail_idx].isat100,g_isbg3_d[g_detail_idx].isat101, 
                       g_isbg3_d[g_detail_idx].isat201,g_isbg3_d[g_detail_idx].isat202,g_isbg3_d[g_detail_idx].isat203, 
                       g_isbg3_d[g_detail_idx].isat204,g_isbg3_d[g_detail_idx].isat205,g_isbg3_d[g_detail_idx].isat206, 
                       g_isbg3_d[g_detail_idx].isat207,g_isbg3_d[g_detail_idx].isat208,g_isbg3_d[g_detail_idx].isat209, 
                       g_isbg3_d[g_detail_idx].isatdocdt)
      #add-point:insert_b段資料新增中 name="insert_b.m_insert3"
      
      #end add-point
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'3'" THEN 
         CALL g_isbg3_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert3"
      
      #end add-point
   END IF
 
 
   
 
   
   #add-point:insert_b段other name="insert_b.other"
   
   #end add-point     
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.update_b" >}
#+ 修改單身後其他table連動
PRIVATE FUNCTION aist330_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"
   
   #end add-point   
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="update_b.pre_function"
   
   #end add-point
   
   LET g_update = TRUE   
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "isbg_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update"
      
      #end add-point 
      
      #將遮罩欄位還原
      CALL aist330_isbg_t_mask_restore('restore_mask_o')
               
      UPDATE isbg_t 
         SET (isbgcomp,isbgdocno,
              isbgseq
              ,isbg001,isbg002,isbg003,isbg004) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_isbg_d[g_detail_idx].isbg001,g_isbg_d[g_detail_idx].isbg002,g_isbg_d[g_detail_idx].isbg003, 
                  g_isbg_d[g_detail_idx].isbg004) 
         WHERE isbgent = g_enterprise AND isbgcomp = ps_keys_bak[1] AND isbgdocno = ps_keys_bak[2] AND isbgseq = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update"
      
      #end add-point   
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isbg_t" 
            LET g_errparam.code   = "std-00009" 
            LET g_errparam.popup  = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.sqlcode #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isbg_t:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
 
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist330_isbg_t_mask_restore('restore_mask_n')
               
      #add-point:update_b段修改後 name="update_b.after_update"
      
      #end add-point  
   END IF
   
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
   
   
   LET ls_group = "'2',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "isah_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update2"
      LET g_isbg2_d[g_detail_idx].isah113 = g_isbg2_d[g_detail_idx].isah103
      LET g_isbg2_d[g_detail_idx].isah114 = g_isbg2_d[g_detail_idx].isah104
      LET g_isbg2_d[g_detail_idx].isah115 = g_isbg2_d[g_detail_idx].isah105
      #end add-point  
      
      #將遮罩欄位還原
      CALL aist330_isah_t_mask_restore('restore_mask_o')
               
      UPDATE isah_t 
         SET (isahcomp,isahdocno,
              isahseq
              ,isahorga,isah003,isah004,isah013,isah005,isah006,isah101,isah103,isah007,isah104,isah105,isah011,isah001,isah002,isah008,isah009,isah010,isah012,isah106,isah113,isah114,isah115,isah116) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_isbg2_d[g_detail_idx].isahorga,g_isbg2_d[g_detail_idx].isah003,g_isbg2_d[g_detail_idx].isah004, 
                  g_isbg2_d[g_detail_idx].isah013,g_isbg2_d[g_detail_idx].isah005,g_isbg2_d[g_detail_idx].isah006, 
                  g_isbg2_d[g_detail_idx].isah101,g_isbg2_d[g_detail_idx].isah103,g_isbg2_d[g_detail_idx].isah007, 
                  g_isbg2_d[g_detail_idx].isah104,g_isbg2_d[g_detail_idx].isah105,g_isbg2_d[g_detail_idx].isah011, 
                  g_isbg2_d[g_detail_idx].isah001,g_isbg2_d[g_detail_idx].isah002,g_isbg2_d[g_detail_idx].isah008, 
                  g_isbg2_d[g_detail_idx].isah009,g_isbg2_d[g_detail_idx].isah010,g_isbg2_d[g_detail_idx].isah012, 
                  g_isbg2_d[g_detail_idx].isah106,g_isbg2_d[g_detail_idx].isah113,g_isbg2_d[g_detail_idx].isah114, 
                  g_isbg2_d[g_detail_idx].isah115,g_isbg2_d[g_detail_idx].isah116) 
         WHERE isahent = g_enterprise AND isahcomp = ps_keys_bak[1] AND isahdocno = ps_keys_bak[2] AND isahseq = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update2"
      
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isah_t" 
            LET g_errparam.code   = "std-00009" 
            LET g_errparam.popup  = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.sqlcode #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isah_t:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist330_isah_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update2"
      
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
   LET ls_group = "'3',"
   #判斷是否是同一群組的table
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "isat_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update3"
      LET g_isbg3_d[g_detail_idx].isat103 =  g_isbg3_d[g_detail_idx].isat113
      LET g_isbg3_d[g_detail_idx].isat104 =  g_isbg3_d[g_detail_idx].isat114
      LET g_isbg3_d[g_detail_idx].isat105 =  g_isbg3_d[g_detail_idx].isat115
      #end add-point  
      
      #將遮罩欄位還原
      CALL aist330_isat_t_mask_restore('restore_mask_o')
               
      UPDATE isat_t 
         SET (isatcomp,isatdocno,
              isatseq
              ,isatsite,isat003,isat004,isat006,isat005,isat022,isat113,isat114,isat115,isat103,isat104,isat105,isat007,isat014,isat025,isat106,isat107,isat017,isat001,isat002,isat008,isat009,isat010,isat011,isat012,isat013,isat015,isat016,isat018,isat019,isat020,isat021,isat023,isat024,isat100,isat101,isat201,isat202,isat203,isat204,isat205,isat206,isat207,isat208,isat209,isatdocdt) 
              = 
             (ps_keys[1],ps_keys[2],ps_keys[3]
              ,g_isbg3_d[g_detail_idx].isatsite,g_isbg3_d[g_detail_idx].isat003,g_isbg3_d[g_detail_idx].isat004, 
                  g_isbg3_d[g_detail_idx].isat006,g_isbg3_d[g_detail_idx].isat005,g_isbg3_d[g_detail_idx].isat022, 
                  g_isbg3_d[g_detail_idx].isat113,g_isbg3_d[g_detail_idx].isat114,g_isbg3_d[g_detail_idx].isat115, 
                  g_isbg3_d[g_detail_idx].isat103,g_isbg3_d[g_detail_idx].isat104,g_isbg3_d[g_detail_idx].isat105, 
                  g_isbg3_d[g_detail_idx].isat007,g_isbg3_d[g_detail_idx].isat014,g_isbg3_d[g_detail_idx].isat025, 
                  g_isbg3_d[g_detail_idx].isat106,g_isbg3_d[g_detail_idx].isat107,g_isbg3_d[g_detail_idx].isat017, 
                  g_isbg3_d[g_detail_idx].isat001,g_isbg3_d[g_detail_idx].isat002,g_isbg3_d[g_detail_idx].isat008, 
                  g_isbg3_d[g_detail_idx].isat009,g_isbg3_d[g_detail_idx].isat010,g_isbg3_d[g_detail_idx].isat011, 
                  g_isbg3_d[g_detail_idx].isat012,g_isbg3_d[g_detail_idx].isat013,g_isbg3_d[g_detail_idx].isat015, 
                  g_isbg3_d[g_detail_idx].isat016,g_isbg3_d[g_detail_idx].isat018,g_isbg3_d[g_detail_idx].isat019, 
                  g_isbg3_d[g_detail_idx].isat020,g_isbg3_d[g_detail_idx].isat021,g_isbg3_d[g_detail_idx].isat023, 
                  g_isbg3_d[g_detail_idx].isat024,g_isbg3_d[g_detail_idx].isat100,g_isbg3_d[g_detail_idx].isat101, 
                  g_isbg3_d[g_detail_idx].isat201,g_isbg3_d[g_detail_idx].isat202,g_isbg3_d[g_detail_idx].isat203, 
                  g_isbg3_d[g_detail_idx].isat204,g_isbg3_d[g_detail_idx].isat205,g_isbg3_d[g_detail_idx].isat206, 
                  g_isbg3_d[g_detail_idx].isat207,g_isbg3_d[g_detail_idx].isat208,g_isbg3_d[g_detail_idx].isat209, 
                  g_isbg3_d[g_detail_idx].isatdocdt) 
         WHERE isatent = g_enterprise AND isatcomp = ps_keys_bak[1] AND isatdocno = ps_keys_bak[2] AND isatseq = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update3"
      
      #end add-point  
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isat_t" 
            LET g_errparam.code   = "std-00009" 
            LET g_errparam.popup  = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         WHEN SQLCA.sqlcode #其他錯誤
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "isat_t:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL s_transaction_end('N','0')
            CALL cl_err()
            
         OTHERWISE
          
      END CASE
      
      #將遮罩欄位進行遮蔽
      CALL aist330_isat_t_mask_restore('restore_mask_n')
 
      #add-point:update_b段修改後 name="update_b.after_update3"
      
      #end add-point  
   END IF
 
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      
   END IF
 
 
   
 
   
   #add-point:update_b段other name="update_b.other"
   
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.key_update_b" >}
#+ 上層單身key欄位變動後, 連帶修正下層單身key欄位
PRIVATE FUNCTION aist330_key_update_b(ps_keys_bak,ps_table)
   #add-point:update_b段define(客製用) name="key_update_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_key       DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_update_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_update_b.pre_function"
   
   #end add-point
   
 
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.key_delete_b" >}
#+ 上層單身刪除後, 連帶刪除下層單身key欄位
PRIVATE FUNCTION aist330_key_delete_b(ps_keys_bak,ps_table)
   #add-point:delete_b段define(客製用) name="key_delete_b.define_customerization"
   
   #end add-point
   DEFINE ps_keys_bak       DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_table          STRING
   DEFINE l_field_keys      DYNAMIC ARRAY OF STRING
   DEFINE l_var_keys_bak    DYNAMIC ARRAY OF STRING
   DEFINE l_new_key         DYNAMIC ARRAY OF STRING
   DEFINE l_old_key         DYNAMIC ARRAY OF STRING
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="key_delete_b.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="key_delete_b.pre_function"
   
   #end add-point
   
 
   
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.lock_b" >}
#+ 連動lock其他單身table資料
PRIVATE FUNCTION aist330_lock_b(ps_table,ps_page)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"
   
   #end add-point   
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"
   
   #end add-point   
   
   #add-point:Function前置處理  name="lock_b.pre_function"
   
   #end add-point
    
   #先刷新資料
   #CALL aist330_b_fill()
   
   #鎖定整組table
   #LET ls_group = "'1',"
   #僅鎖定自身table
   LET ls_group = "isbg_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN aist330_bcl USING g_enterprise,
                                       g_isbf_m.isbfcomp,g_isbf_m.isbfdocno,g_isbg_d[g_detail_idx].isbgseq  
                                               
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist330_bcl:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
                                    
   #鎖定整組table
   #LET ls_group = "'2',"
   #僅鎖定自身table
   LET ls_group = "isah_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist330_bcl2 USING g_enterprise,
                                             g_isbf_m.isbfcomp,g_isbf_m.isbfdocno,g_isbg2_d[g_detail_idx].isahseq 
 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist330_bcl2:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
   #鎖定整組table
   #LET ls_group = "'3',"
   #僅鎖定自身table
   LET ls_group = "isat_t"
   IF ls_group.getIndexOf(ps_table,1) THEN
   
      OPEN aist330_bcl3 USING g_enterprise,
                                             g_isbf_m.isbfcomp,g_isbf_m.isbfdocno,g_isbg3_d[g_detail_idx].isatseq 
 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "aist330_bcl3:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
 
 
   
 
   
   #add-point:lock_b段other name="lock_b.other"
   
   #end add-point  
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.unlock_b" >}
#+ 連動unlock其他單身table資料
PRIVATE FUNCTION aist330_unlock_b(ps_table,ps_page)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"
   
   #end add-point  
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"
   
   #end add-point  
   
   #add-point:Function前置處理  name="unlock_b.pre_function"
   
   #end add-point
    
   LET ls_group = "'1',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist330_bcl
   END IF
   
   LET ls_group = "'2',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist330_bcl2
   END IF
 
   LET ls_group = "'3',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE aist330_bcl3
   END IF
 
 
   
 
 
   #add-point:unlock_b段other name="unlock_b.other"
   
   #end add-point  
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_entry" >}
#+ 單頭欄位開啟設定
PRIVATE FUNCTION aist330_set_entry(p_cmd)
   #add-point:set_entry段define(客製用) name="set_entry.define_customerization"
   
   #end add-point       
   DEFINE p_cmd   LIKE type_t.chr1  
   #add-point:set_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry.define"
   
   #end add-point       
   
   #add-point:Function前置處理  name="set_entry.pre_function"
   
   #end add-point
   
   CALL cl_set_comp_entry("isbfdocno",TRUE)
   
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("isbfcomp,isbfdocno",TRUE)
      CALL cl_set_comp_entry("isbfdocdt",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry段欄位控制 name="set_entry.field_control"
      
      #end add-point  
   END IF
   
   #add-point:set_entry段欄位控制後 name="set_entry.after_control"
   
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_no_entry" >}
#+ 單頭欄位關閉設定
PRIVATE FUNCTION aist330_set_no_entry(p_cmd)
   #add-point:set_no_entry段define(客製用) name="set_no_entry.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="set_no_entry.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("isbfcomp,isbfdocno",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry段欄位控制 name="set_no_entry.field_control"
      
      #end add-point 
   END IF 
   
   IF p_cmd = 'u' THEN  #docno,ld欄位確認是絕對關閉
      CALL cl_set_comp_entry("isbfdocno",FALSE)
   END IF 
 
   IF p_cmd = 'u' THEN  #docdt欄位依照設定關閉(FALSE則為設定不同意修正)
      IF NOT cl_chk_update_docdt() THEN
         CALL cl_set_comp_entry("isbfdocdt",FALSE)
      END IF
   END IF 
   
   #add-point:set_no_entry段欄位控制後 name="set_no_entry.after_control"
   
   #end add-point 
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_entry_b" >}
#+ 單身欄位開啟設定
PRIVATE FUNCTION aist330_set_entry_b(p_cmd)
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"
   
   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="set_entry_b.pre_function"
   
   #end add-point
    
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("",TRUE)
      #add-point:set_entry段欄位控制 name="set_entry_b.field_control"
      
      #end add-point  
   END IF
   
   #add-point:set_entry_b段 name="set_entry_b.set_entry_b"
   
   #end add-point  
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_no_entry_b" >}
#+ 單身欄位關閉設定
PRIVATE FUNCTION aist330_set_no_entry_b(p_cmd)
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"
   
   #end add-point    
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_no_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   
   #end add-point    
   
   #add-point:Function前置處理  name="set_no_entry_b.pre_function"
   
   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"
      
      #end add-point 
   END IF 
   
   #add-point:set_no_entry_b段 name="set_no_entry_b.set_no_entry_b"
   
   #end add-point     
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_act_visible" >}
#+ 單頭權限開啟
PRIVATE FUNCTION aist330_set_act_visible()
   #add-point:set_act_visible段define(客製用) name="set_act_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible.define"
   
   #end add-point   
   #add-point:set_act_visible段 name="set_act_visible.set_act_visible"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_act_no_visible" >}
#+ 單頭權限關閉
PRIVATE FUNCTION aist330_set_act_no_visible()
   #add-point:set_act_no_visible段define(客製用) name="set_act_no_visible.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible.define"
   
   #end add-point   
   #add-point:set_act_no_visible段 name="set_act_no_visible.set_act_no_visible"
   #應用 a63 樣板自動產生(Version:1)
   IF g_isbf_m.isbfstus NOT MATCHES "[NDR]" THEN   # N未確認/D抽單/R已拒絕允許修改
      CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)
   END IF


   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_act_visible_b" >}
#+ 單身權限開啟
PRIVATE FUNCTION aist330_set_act_visible_b()
   #add-point:set_act_visible_b段define(客製用) name="set_act_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible_b.define"
   
   #end add-point   
   #add-point:set_act_visible_b段 name="set_act_visible_b.set_act_visible_b"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist330.set_act_no_visible_b" >}
#+ 單身權限關閉
PRIVATE FUNCTION aist330_set_act_no_visible_b()
   #add-point:set_act_no_visible_b段define(客製用) name="set_act_no_visible_b.define_customerization"
   
   #end add-point   
   #add-point:set_act_no_visible_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible_b.define"
   
   #end add-point   
   #add-point:set_act_no_visible_b段 name="set_act_no_visible_b.set_act_no_visible_b"
   
   #end add-point   
END FUNCTION
 
{</section>}
 
{<section id="aist330.default_search" >}
#+ 外部參數搜尋
PRIVATE FUNCTION aist330_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"
   
   #end add-point  
   DEFINE li_idx     LIKE type_t.num10
   DEFINE li_cnt     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
   
   #end add-point  
   
   #add-point:Function前置處理 name="default_search.before"
   
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   IF NOT cl_null(g_argv[01]) THEN
      LET ls_wc = ls_wc, " isbfcomp = '", g_argv[01], "' AND "
   END IF
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " isbfdocno = '", g_argv[02], "' AND "
   END IF
 
   
   #add-point:default_search段after sql name="default_search.after_sql"
   
   #end add-point  
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      #若無外部參數則預設為1=2
      LET g_default = FALSE
      
      #預設查詢條件
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc2_table2 TO NULL
 
         INITIALIZE g_wc2_table3 TO NULL
 
 
         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "isbf_t" 
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "isbg_t" 
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "isah_t" 
                  LET g_wc2_table2 = la_wc[li_idx].wc
 
               WHEN la_wc[li_idx].tableid = "isat_t" 
                  LET g_wc2_table3 = la_wc[li_idx].wc
 
 
               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
            OR NOT cl_null(g_wc2_table2)
 
            OR NOT cl_null(g_wc2_table3)
 
 
            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc2_table2 <> " 1=1" AND NOT cl_null(g_wc2_table2) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table2
            END IF
 
            IF g_wc2_table3 <> " 1=1" AND NOT cl_null(g_wc2_table3) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_table3
            END IF
 
 
            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF
         
            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
    
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
   END IF
   
   #add-point:default_search段結束前 name="default_search.after"
   
   #end add-point  
 
   IF g_wc.getIndexOf(" 1=2", 1) THEN
      LET g_default = TRUE
   END IF
 
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.state_change" >}
   #應用 a09 樣板自動產生(Version:17)
#+ 確認碼變更 
PRIVATE FUNCTION aist330_statechange()
   #add-point:statechange段define(客製用) name="statechange.define_customerization"
   
   #end add-point  
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="statechange.define"
   DEFINE l_count  LIKE type_t.num10
   DEFINE l_count2 LIKE type_t.num10     #160106-00005#4 add
   #end add-point  
   
   #add-point:Function前置處理 name="statechange.before"
   
   #end add-point  
   
   ERROR ""     #清空畫面右下側ERROR區塊
 
   IF g_isbf_m.isbfcomp IS NULL
      OR g_isbf_m.isbfdocno IS NULL
   THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      RETURN
   END IF
 
   CALL s_transaction_begin()
   
   OPEN aist330_cl USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
   IF STATUS THEN
      CLOSE aist330_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "OPEN aist330_cl:" 
      LET g_errparam.code   = STATUS 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
       g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002,g_isbf_m.isbf003, 
       g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp,g_isbf_m.isbfcrtid, 
       g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt,g_isbf_m.isbfcnfid, 
       g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp_desc, 
       g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
   
 
   #檢查是否允許此動作
   IF NOT aist330_action_chk() THEN
      CLOSE aist330_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   #將資料顯示到畫面上
   DISPLAY BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfsite_desc,g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc, 
       g_isbf_m.isbf001,g_isbf_m.isbf001_desc,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002, 
       g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfownid_desc, 
       g_isbf_m.isbfowndp,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp, 
       g_isbf_m.isbfcrtdp_desc,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmodid_desc,g_isbf_m.isbfmoddt, 
       g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfid_desc,g_isbf_m.isbfcnfdt
 
   CASE g_isbf_m.isbfstus
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      
   END CASE
 
   #add-point:資料刷新後 name="statechange.after_refresh"
   
   #end add-point
 
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_isbf_m.isbfstus
            
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "Y"
               HIDE OPTION "confirmed"
         END CASE
     
      #add-point:menu前 name="statechange.before_menu"
      CALL cl_set_act_visible("signing,withdraw",FALSE)
      CALL cl_set_act_visible("unconfirmed,invalid,confirmed",TRUE)
      CALL cl_set_act_visible("closed",FALSE)
     
      CASE g_isbf_m.isbfstus
         WHEN "N"  
            CALL cl_set_act_visible("unconfirmed,hold",FALSE)
            #需提交至BPM時，則顯示「提交」功能並隱藏「確認」功能
            IF cl_bpm_chk() THEN
                CALL cl_set_act_visible("signing",TRUE)
                CALL cl_set_act_visible("confirmed",FALSE)
            END IF

         WHEN "R"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed",FALSE)

         WHEN "D"   #保留修改的功能(如作廢)，隱藏其他應用功能(如: 確認、未確認、留置、過帳…)
            CALL cl_set_act_visible("confirmed,unconfirmed",FALSE)

         WHEN "X"
            CALL cl_set_act_visible("unconfirmed,invalid,confirmed,hold",FALSE)
            CALL s_transaction_end('N','0')        #150401-00001#13
            RETURN

         WHEN "Y"
            CALL cl_set_act_visible("invalid,confirmed",FALSE)

         WHEN "W" #只能顯示抽單;其餘應用功能皆隱藏
            CALL cl_set_act_visible("withdraw",TRUE)  
             CALL cl_set_act_visible("unconfirmed,invalid,confirmed",FALSE)

         WHEN "A"  #只能顯示確認; 其餘應用功能皆隱藏
            CALL cl_set_act_visible("confirmed ",TRUE)  
            CALL cl_set_act_visible("unconfirmed,invalid",FALSE)
      END CASE
      #end add-point
      
      
	  
      ON ACTION unconfirmed
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制 name="statechange.unconfirmed"
            
            #end add-point
         END IF
         EXIT MENU
      ON ACTION confirmed
         IF cl_auth_chk_act("confirmed") THEN
            LET lc_state = "Y"
            #add-point:action控制 name="statechange.confirmed"
            
            #end add-point
         END IF
         EXIT MENU
 
      #add-point:stus控制 name="statechange.more_control"
      
      #end add-point
      
   END MENU
   
   #確認被選取的狀態碼在清單中
   IF (lc_state <> "N" 
      AND lc_state <> "Y"
      ) OR 
      g_isbf_m.isbfstus = lc_state OR cl_null(lc_state) THEN
      CLOSE aist330_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #add-point:stus修改前 name="statechange.b_update"
   CALL s_aist330_prepare_declare()
   #確認
   IF lc_state = 'Y' THEN
      IF g_isbf_m.isbfstus = 'N' THEN
         CALL cl_err_collect_init()
         CALL s_aist330_conf_chk(g_isbf_m.isbfcomp,g_isbf_m.isbfdocno,g_isat115) RETURNING g_sub_success
         IF NOT g_sub_success THEN
            CALL s_transaction_end('N','0')           #150401-00001#13
            CALL cl_err_collect_show()
            RETURN
         ELSE
            IF NOT cl_ask_confirm('aim-00108') THEN   #是否執行確認？
               CALL s_transaction_end('N','0')        #150401-00001#13
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_transaction_begin()
               CALL s_aist330_conf_upd(g_isbf_m.isbfcomp,g_isbf_m.isbfdocno) RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  CALL s_transaction_end('N','0')
                  CALL cl_err_collect_show()
                  RETURN
               ELSE
                  #if  若發票歷程檔為空白時
                  #由發票明細帶入
                  LET l_count = NULL
                  SELECT COUNT(*) INTO l_count FROM isat_t
                   WHERE isatent = g_enterprise
                     AND isatcomp = g_isbf_m.isbfcomp
                     AND isatdocno = g_isbf_m.isbfdocno
                  IF cl_null(l_count)THEN LET l_count = 0 END IF

                  #160106-00005#4-----s
                  LET l_count2 = NULL
                  SELECT COUNT(*) INTO l_count2 FROM isah_t
                   WHERE isahent = g_enterprise
                     AND isahcomp = g_isbf_m.isbfcomp
                     AND isahdocno = g_isbf_m.isbfdocno
                     AND isah002   IS NULL
                  IF cl_null(l_count2)THEN LET l_count2 = 0 END IF
                  #160106-00005#4-----e

                  IF l_count = 0 AND l_count2 = 0 THEN   #160106-00005#4 add
                     CALL aist330_autoins_isat(g_isbf_m.isbfcomp,g_isbf_m.isbfdocno,'1')
                  END IF
                  CALL s_transaction_end('Y','0')
                  CALL cl_err_collect_show()
               END IF
            END IF
         END IF
      END IF
   END IF
   #取消確認
   IF lc_state = 'N' THEN
      CALL cl_err_collect_init()
      CALL s_aist330_unconf_chk(g_isbf_m.isbfcomp,g_isbf_m.isbfdocno) RETURNING g_sub_success
      IF NOT g_sub_success THEN
         CALL s_transaction_end('N','0')           #150401-00001#13
         CALL cl_err_collect_show()
         RETURN
      ELSE
         IF NOT cl_ask_confirm('aim-00110') THEN   #是否執行取消確認？
            CALL s_transaction_end('N','0')        #150401-00001#13
            CALL cl_err_collect_show()
            RETURN
         ELSE
            CALL s_transaction_begin()
            CALL s_aist330_unconf_upd(g_isbf_m.isbfcomp,g_isbf_m.isbfdocno) RETURNING g_sub_success
            IF NOT g_sub_success THEN
               CALL s_transaction_end('N','0')
               CALL cl_err_collect_show()
               RETURN
            ELSE
               CALL s_transaction_end('Y','0')
               CALL cl_err_collect_show()
            END IF
         END IF
      END IF
   END IF
   #end add-point
   
   LET g_isbf_m.isbfmodid = g_user
   LET g_isbf_m.isbfmoddt = cl_get_current()
   LET g_isbf_m.isbfstus = lc_state
   
   #異動狀態碼欄位/修改人/修改日期
   UPDATE isbf_t 
      SET (isbfstus,isbfmodid,isbfmoddt) 
        = (g_isbf_m.isbfstus,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt)     
    WHERE isbfent = g_enterprise AND isbfcomp = g_isbf_m.isbfcomp
      AND isbfdocno = g_isbf_m.isbfdocno
    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
   ELSE
      CASE lc_state
         WHEN "N"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
         WHEN "Y"
            CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
         
      END CASE
    
      #撈取異動後的資料
      EXECUTE aist330_master_referesh USING g_isbf_m.isbfcomp,g_isbf_m.isbfdocno INTO g_isbf_m.isbfsite, 
          g_isbf_m.isbfcomp,g_isbf_m.isbf001,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002, 
          g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfowndp, 
          g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtdp,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmoddt, 
          g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfdt,g_isbf_m.isbfownid_desc,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid_desc, 
          g_isbf_m.isbfcrtdp_desc,g_isbf_m.isbfmodid_desc,g_isbf_m.isbfcnfid_desc
      
      #將資料顯示到畫面上
      DISPLAY BY NAME g_isbf_m.isbfsite,g_isbf_m.isbfsite_desc,g_isbf_m.isbfcomp,g_isbf_m.isbfcomp_desc, 
          g_isbf_m.isbf001,g_isbf_m.isbf001_desc,g_isbf_m.isbfdocno,g_isbf_m.isbfdocdt,g_isbf_m.isbf002, 
          g_isbf_m.isbf003,g_isbf_m.isbf004,g_isbf_m.isbf005,g_isbf_m.isbfstus,g_isbf_m.isbfownid,g_isbf_m.isbfownid_desc, 
          g_isbf_m.isbfowndp,g_isbf_m.isbfowndp_desc,g_isbf_m.isbfcrtid,g_isbf_m.isbfcrtid_desc,g_isbf_m.isbfcrtdp, 
          g_isbf_m.isbfcrtdp_desc,g_isbf_m.isbfcrtdt,g_isbf_m.isbfmodid,g_isbf_m.isbfmodid_desc,g_isbf_m.isbfmoddt, 
          g_isbf_m.isbfcnfid,g_isbf_m.isbfcnfid_desc,g_isbf_m.isbfcnfdt
   END IF
 
   #add-point:stus修改後 name="statechange.a_update"
   
   #end add-point
 
   #add-point:statechange段結束前 name="statechange.after"
   
   #end add-point  
 
   CLOSE aist330_cl
   CALL s_transaction_end('Y','0')
 
   #功能已完成,通報訊息中心
   CALL aist330_msgcentre_notify('statechange:'||lc_state)
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aist330.idx_chk" >}
#+ 顯示正確的單身資料筆數
PRIVATE FUNCTION aist330_idx_chk()
   #add-point:idx_chk段define(客製用) name="idx_chk.define_customerization"
   
   #end add-point  
   #add-point:idx_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="idx_chk.define"
   
   #end add-point  
   
   #add-point:Function前置處理  name="idx_chk.pre_function"
   
   #end add-point
   
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_isbg_d.getLength() THEN
         LET g_detail_idx = g_isbg_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isbg_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isbg_d.getLength() TO FORMONLY.cnt
   END IF
   
   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail2")
      IF g_detail_idx > g_isbg2_d.getLength() THEN
         LET g_detail_idx = g_isbg2_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isbg2_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isbg2_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail3")
      IF g_detail_idx > g_isbg3_d.getLength() THEN
         LET g_detail_idx = g_isbg3_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_isbg3_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_isbg3_d.getLength() TO FORMONLY.cnt
   END IF
 
   
   #add-point:idx_chk段other name="idx_chk.other"
   
   #end add-point  
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.b_fill2" >}
#+ 單身陣列填充2
PRIVATE FUNCTION aist330_b_fill2(pi_idx)
   #add-point:b_fill2段define(客製用) name="b_fill2.define_customerization"
   
   #end add-point
   DEFINE pi_idx                 LIKE type_t.num10
   DEFINE li_ac                  LIKE type_t.num10
   DEFINE li_detail_idx_tmp      LIKE type_t.num10
   DEFINE ls_chk                 LIKE type_t.chr1
   #add-point:b_fill2段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill2.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="b_fill2.pre_function"
   
   #end add-point
   
   LET li_ac = l_ac 
   
   IF g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   LET li_detail_idx_tmp = g_detail_idx
   
 
      
 
      
   #add-point:單身填充後 name="b_fill2.after_fill"
   
   #end add-point
    
   LET l_ac = li_ac
   
   CALL aist330_detail_show()
   
   LET g_detail_idx = li_detail_idx_tmp
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.fill_chk" >}
#+ 單身填充確認
PRIVATE FUNCTION aist330_fill_chk(ps_idx)
   #add-point:fill_chk段define(客製用) name="fill_chk.define_customerization"
   
   #end add-point
   DEFINE ps_idx        LIKE type_t.chr10
   #add-point:fill_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fill_chk.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="fill_chk.before_chk"
   
   #end add-point
   
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
 
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND 
      (cl_null(g_wc2_table2) OR g_wc2_table2.trim() = '1=1')  AND 
      (cl_null(g_wc2_table3) OR g_wc2_table3.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"
      
      #end add-point
      RETURN TRUE
   END IF
   
   #add-point:fill_chk段after_chk name="fill_chk.after_chk"
   
   #end add-point
   
   RETURN TRUE
 
END FUNCTION
 
{</section>}
 
{<section id="aist330.status_show" >}
PRIVATE FUNCTION aist330_status_show()
   #add-point:status_show段define(客製用) name="status_show.define_customerization"
   
   #end add-point
   #add-point:status_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="status_show.define"
   
   #end add-point
   
   #add-point:status_show段status_show name="status_show.status_show"
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="aist330.mask_functions" >}
&include "erp/ais/aist330_mask.4gl"
 
{</section>}
 
{<section id="aist330.signature" >}
   
 
{</section>}
 
{<section id="aist330.set_pk_array" >}
   #應用 a51 樣板自動產生(Version:8)
#+ 給予pk_array內容
PRIVATE FUNCTION aist330_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point  
   
   #若l_ac<=0代表沒有資料
   IF l_ac <= 0 THEN
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_isbf_m.isbfcomp
   LET g_pk_array[1].column = 'isbfcomp'
   LET g_pk_array[2].values = g_isbf_m.isbfdocno
   LET g_pk_array[2].column = 'isbfdocno'
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point  
   
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aist330.other_dialog" readonly="Y" >}
   
 
{</section>}
 
{<section id="aist330.msgcentre_notify" >}
#應用 a66 樣板自動產生(Version:6)
PRIVATE FUNCTION aist330_msgcentre_notify(lc_state)
   #add-point:msgcentre_notify段define name="msgcentre_notify.define_customerization"
   
   #end add-point   
   DEFINE lc_state LIKE type_t.chr80
   #add-point:msgcentre_notify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="msgcentre_notify.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="msgcentre_notify.pre_function"
   
   #end add-point
   
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = lc_state
 
   #PK資料填寫
   CALL aist330_set_pk_array()
   #單頭資料填寫
   LET g_msgparam.data[1] = util.JSON.stringify(g_isbf_m)
 
   #add-point:msgcentre其他通知 name="msgcentre_notify.process"
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
 
 
 
{</section>}
 
{<section id="aist330.action_chk" >}
#+ 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
PRIVATE FUNCTION aist330_action_chk()
   #add-point:action_chk段define(客製用) name="action_chk.define_customerization"
   
   #end add-point
   #add-point:action_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="action_chk.define"
   
   #end add-point
   
   #add-point:action_chk段action_chk name="action_chk.action_chk"
   #160818-00017#19 add-S
   SELECT isbfstus  INTO g_isbf_m.isbfstus
     FROM isbf_t
    WHERE isbfent = g_enterprise
      AND isbfdocno = g_isbf_m.isbfdocno
      AND isbfcomp = g_isbf_m.isbfcomp      

  IF(g_action_choice="modify" OR g_action_choice="delete" OR g_action_choice="modify_detail")  THEN
     LET g_errno = NULL
     CASE g_isbf_m.isbfstus
        WHEN 'W'
           LET g_errno = 'sub-00180'
        WHEN 'X'
           LET g_errno = 'sub-00229'
        WHEN 'Y'
           LET g_errno = 'sub-00178'
        WHEN 'S'
           LET g_errno = 'sub-00230'
     END CASE

     IF NOT cl_null(g_errno) THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = g_errno
        LET g_errparam.extend = g_isbf_m.isbfdocno
        LET g_errparam.popup = TRUE
        CALL cl_err()
        LET g_errno = NULL
        CALL aist330_set_act_visible()
        CALL aist330_set_act_no_visible()
        CALL aist330_show()
        RETURN FALSE
     END IF
   END IF
   #160818-00017#19 add-E
   #end add-point
      
   RETURN TRUE
   
END FUNCTION
 
{</section>}
 
{<section id="aist330.other_function" readonly="Y" >}

PRIVATE FUNCTION aist330_ooef001_chk(p_ooef001)
   DEFINE p_ooef001   LIKE ooef_t.ooef001
   DEFINE r_success   LIKE type_t.num5
   DEFINE l_stus      LIKE type_t.chr1
   DEFINE r_errno     LIKE gzze_t.gzze001
   
   LET r_success = TRUE
   LET r_errno  = ''
   LET l_stus = NULL
   SELECT ooefstus FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = p_ooef001
      
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET r_errno  = 'aoo-00094'
         LET r_success = FALSE
      WHEN l_stus <> 'Y'
         LET r_errno = 'axc-00105'
         LET r_success = FALSE
   END CASE
   
   
   RETURN r_success,r_errno
END FUNCTION

PRIVATE FUNCTION aist330_set_visible()
   CALL cl_set_comp_visible('isbg001,isat003,isah001',TRUE)
END FUNCTION

PRIVATE FUNCTION aist330_set_no_visible()
   IF g_isai.isai002 = '1' THEN 
      CALL cl_set_comp_visible('isbg001,isat003,isah001',FALSE)
   END IF
END FUNCTION

################################################################################
# Descriptions...: 發票號碼檢核(isat)
# Memo...........:
# Date & Author..: 150610 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aist330_isbg001_002_chk(p_isbg001,p_isbg002,p_comp,p_isai002)
   DEFINE p_isbg001   LIKE isbg_t.isbg001
   DEFINE p_isbg002   LIKE isbg_t.isbg002
   DEFINE p_comp      LIKE ooef_t.ooef001
   DEFINE r_success   LIKE type_t.num5
   DEFINE r_errno     LIKE gzze_t.gzze001
   DEFINE l_comp      LIKE ooef_t.ooef001
   DEFINE l_isat014   LIKE isat_t.isat014
   DEFINE p_isai002   LIKE isai_t.isai002
   DEFINE l_isat106   LIKE isat_t.isat106
   DEFINE l_sql       STRING
   
   LET r_success = TRUE
   LET r_errno  =''
   
   LET l_comp = NULL   LET l_isat014 = NULL
   LET l_isat106 = NULL
   
   IF p_isai002 = '1' THEN
      SELECT isatcomp ,isat014, isat106
        INTO l_comp ,l_isat014,l_isat106
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat004 = p_isbg002 
         AND isat014 = '11'
   ELSE
      SELECT isatcomp ,isat014,isat106
        INTO l_comp ,l_isat014,l_isat106
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat003 = p_isbg001
         AND isat004 = p_isbg002
         AND isat014 = '11'
   END IF
   IF cl_null(l_isat106)THEN LET l_isat106 = 0 END IF

   CASE
      WHEN SQLCA.SQLCODE = 100
         LET r_errno = 'axr-00207'
         LET r_success = FALSE
      WHEN l_comp <> p_comp
         LET r_errno = 'ais-00219'
         LET r_success = FALSE
      WHEN l_isat106 > 0 
         LET r_errno = 'ais-00171'
         LET r_success = FALSE
   END CASE
   
   RETURN r_success,r_errno
END FUNCTION

################################################################################
# Descriptions...: 來源發票歷程檔抓值
# Memo...........:
# Date & Author..: 15/06/10 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aist330_source_carry(p_isbg001,p_isbg002,p_isai002)
   DEFINE p_isbg001   LIKE isbg_t.isbg001
   DEFINE p_isbg002   LIKE isbg_t.isbg002
   DEFINE p_isai002   LIKE isai_t.isai002
   DEFINE r_isat      RECORD
                      isat001   LIKE isat_t.isat001,
                      isat005   LIKE isat_t.isat005,
                      isat113   LIKE isat_t.isat113,
                      isat114   LIKE isat_t.isat114,
                      isat115   LIKE isat_t.isat115,
                      isat007   LIKE isat_t.isat007,
                      isat010   LIKE isat_t.isat010,
                      isat014   LIKE isat_t.isat014,
                      isat023   LIKE isat_t.isat023,
                      #160106-00005#4-----s
                      isatdocno LIKE isat_t.isatdocno,
                      isatdocdt LIKE isat_t.isatdocdt
                      #160106-00005#4-----e
                      END RECORD
   DEFINE l_stdat     LIKE type_t.dat                #160106-00005#4

   LET l_stdat = MDY(1,1,YEAR(g_isbf_m.isbfdocdt))   #160106-00005#4
   IF p_isai002 = '1' THEN
      INITIALIZE r_isat.* TO NULL
      SELECT isat001,isat005,isat113,isat114,isat115,
             isat007,isat010,isat014,isat023,
             isatdocno,isatdocdt     #160106-00005#4 add
        INTO r_isat.*
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat004 = p_isbg002
         #160106-00005#4-----s
         AND EXISTS (SELECT 1 FROM isaf_t WHERE isafent = isatent AND isafcomp = isatcomp 
                        AND isafdocno = isatdocno AND isafstus = 'Y' AND isaf056 = '1' 
                        AND isafdocdt BETWEEN l_stdat AND g_isbf_m.isbfdocdt
                     )
         #160106-00005#4-----e
   ELSE
      INITIALIZE r_isat.* TO NULL
      SELECT isat001,isat005,isat113,isat114,isat115,
             isat007,isat010,isat014,isat023,
             isatdocno,isatdocdt    #160106-00005#4 add
        INTO r_isat.*
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat003 = p_isbg001
         AND isat004 = p_isbg002
         #160106-00005#4-----s
         AND EXISTS (SELECT 1 FROM isaf_t WHERE isafent = isatent AND isafcomp = isatcomp 
                        AND isafdocno = isatdocno AND isafstus = 'Y' AND isaf056 = '1' 
                        AND isafdocdt BETWEEN l_stdat AND g_isbf_m.isbfdocdt
                     )
         #160106-00005#4-----e
   END IF
      
   RETURN r_isat.*
END FUNCTION

################################################################################
# Descriptions...: 依isbg重新產生發票明細
# Memo...........:
# Date & Author..: 150611 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aist330_autoins_isah()
   DEFINE l_sql   STRING
   DEFINE l_isbg  RECORD LIKE isbg_t.*
   DEFINE l_isah  RECORD LIKE isah_t.*
   LET l_sql = "SELECT * FROM isbg_t ",
               " WHERE isbgent = ? ",
               "   AND isbgcomp = ? ",
               "   AND isbgdocno = ? "
   PREPARE sel_isbgp1 FROM l_sql
   DECLARE sel_isbgc1 CURSOR FOR sel_isbgp1
   
   
   LET g_ooef019 = NULL
   SELECT ooef019 INTO g_ooef019 FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = g_isbf_m.isbfcomp
   INITIALIZE g_isai.* TO NULL
   SELECT * INTO g_isai.* FROM isai_t
    WHERE isaient = g_enterprise
      AND isai001 = g_ooef019
      
   DELETE FROM isah_t
    WHERE isahent = g_enterprise
      AND isahcomp = g_isbf_m.isbfcomp
      AND isahdocno = g_isbf_m.isbfdocno
      
      
   FOREACH sel_isbgc1 USING g_enterprise,g_isbf_m.isbfcomp,g_isbf_m.isbfdocno
                      INTO l_isbg.*
      IF SQLCA.SQLCODE THEN
         EXIT FOREACH
      END IF
      IF g_isai.isai002 = '1' THEN
         #法人發票號碼發票代碼
         INITIALIZE l_isah.* TO NULL
         LET l_sql = "  SELECT * FROM isah_t ",
                     "   WHERE isahent = ",g_enterprise," ",
                     "     AND isahcomp = '",g_isbf_m.isbfcomp,"' ",
                     "     AND isah002  = '",l_isbg.isbg002,"' "
      ELSE
         LET l_sql = "  SELECT * FROM isah_t ",
                     "   WHERE isahent = ",g_enterprise," ",
                     "     AND isahcomp = '",g_isbf_m.isbfcomp,"' ",
                     "     AND isah002  = '",l_isbg.isbg002,"' ",
                     "     AND isah001  = '",l_isbg.isbg001,"' "
      END IF
      PREPARE sel_isahp1 FROM l_sql
      DECLARE sel_isahc1 CURSOR FOR sel_isahp1
      FOREACH sel_isahc1 INTO l_isah.*
         IF SQLCA.SQLCODE THEN
            EXIT FOREACH
         END IF    

         LET l_isah.isahdocno = g_isbf_m.isbfdocno
         LET l_isah.isah001 = ''
         LET l_isah.isah002 = ''
         LET l_isah.isahseq = NULL
         SELECT MAX(isahseq)+1 INTO l_isah.isahseq FROM isah_t
          WHERE isahent = g_enterprise
            AND isahcomp = g_isbf_m.isbfcomp
            AND isahdocno = g_isbf_m.isbfdocno
         IF cl_null(l_isah.isahseq)THEN
            LET l_isah.isahseq = 1
         END IF
         
         INSERT INTO isah_t VALUES(l_isah.*)
         IF SQLCA.SQLCODE THEN
            INITIALIZE g_errparam.* TO NULL
            LET g_errparam.code = SQLCA.SQLCODE
            LET g_errparam.extend = ''
            LET g_errparam.popup = TRUE
            CALL cl_err()
         END IF
         
      END FOREACH
   END FOREACH
   
END FUNCTION

################################################################################
# Descriptions...: 產生發票歷程檔
# Memo...........:
# Usage..........: 
# Date & Author..: 150611 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aist330_autoins_isat(p_comp,p_docno,p_type)
   DEFINE p_comp   LIKE ooef_t.ooef001
   DEFINE p_docno  LIKE isbf_t.isbfdocno
   DEFINE p_type   LIKE type_t.chr1
   DEFINE p_array DYNAMIC array of record
                  chr    LIKE type_t.chr1000,
                  dat    LIKE type_t.dat
                  END record
   DEFINE p_wc    STRING
  # DEFINE l_isaf  RECORD LIKE isaf_t.*  

   DEFINE l_isah001    LIKE isah_t.isah001
   DEFINE l_isah002    LIKE isah_t.isah002
   DEFINE l_isah103    LIKE isah_t.isah103
   DEFINE l_isah104    LIKE isah_t.isah104
   DEFINE l_isah105    LIKE isah_t.isah105
   DEFINE l_isat       RECORD LIKE isat_t.*
   DEFINE r_success    LIKE type_t.num5
   DEFINE l_sql        STRING
   DEFINE l_ooef019    LIKE ooef_t.ooef019
   DEFINE l_isai004    LIKE isai_t.isai004
   DEFINE l_isai008    LIKE isai_t.isai008
   DEFINE l_isbf       RECORD LIKE isbf_t.*
   DEFINE l_isao001    LIKE isao_t.isao001
   DEFINE l_isao002    LIKE isao_t.isao002
   DEFINE l_isao003    LIKE isao_t.isao003
   DEFINE l_isao004    LIKE isao_t.isao004
   DEFINE l_isao005    LIKE isao_t.isao005
   DEFINE l_ooef002    LIKE ooef_t.ooef002
   DEFINE l_glaa001    LIKE glaa_t.glaa001
   
   WHENEVER ERROR CONTINUE
   
   LET r_success = TRUE 
   #p_array
   #1  isafdocno
   #2  isafcomp
   
#   INITIALIZE l_isaf.* TO NULL
#   SELECT * INTO l_isaf.* FROM isaf_t
#    WHERE isafent   = g_enterprise
#      AND isafcomp  = p_array[2].chr
#      AND isafdocno = p_array[1].chr

   INITIALIZE l_isbf.* TO NULL
   SELECT * INTO l_isbf.* FROM isbf_t
    WHERE isbfent = g_enterprise
      AND isbfcomp = p_comp
      AND isbfdocno = p_docno
 
   SELECT ooef019 
     INTO l_ooef019
     FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = l_isbf.isbfcomp
      AND ooefstus = 'Y'

   SELECT isai004,isai008
     INTO l_isai004,l_isai008
     FROM isai_t 
    WHERE isaient = g_enterprise
      AND isai001 = l_ooef019
      
   LET l_glaa001 = NULL
   SELECT glaa001 INTO l_glaa001
     FROM glaa_t
    WHERE glaaent = g_enterprise
      AND glaacomp = l_isbf.isbfcomp
      AND glaa014 = 'Y'
 
   DELETE FROM isat_t
    WHERE isatent = g_enterprise
      AND isatcomp = l_isbf.isbfcomp
      AND isatdocno = l_isbf.isbfdocno
   
   #IF l_isai008 = 'TW' THEN #AND l_isaf.isaf056 = '2' THEN 
   #   LET l_sql = "SELECT isah008,isah009,isah103,isah104,isah105",
   #               "  FROM isah_t ",
   #               " WHERE isahent = '",g_enterprise,"'",
   #               "   AND isahcomp = '",l_isbf.isbfcomp,"'",
   #               "   AND isahdocno = '",l_isbf.isbfdocno,"'",
   #               " ORDER BY isah002"
   #ELSE
      LET l_sql = "SELECT isah001,isah002,SUM(isah103*isah010),SUM(isah104*isah010),SUM(isah105*isah010)",
                  "  FROM isah_t ",
                  " WHERE isahent = '",g_enterprise,"'",
                  "   AND isahcomp = '",l_isbf.isbfcomp,"'",
                  "   AND isahdocno = '",l_isbf.isbfdocno,"'",
                  " GROUP BY isah001,isah002 ",
                  " ORDER BY isah002"
   #END IF
               
   PREPARE isat_pre FROM l_sql
   DECLARE isat_cus CURSOR FOR isat_pre
   
   FOREACH isat_cus INTO l_isah001,l_isah002,l_isah103,l_isah104,l_isah105
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE 
         EXIT FOREACH
      END IF 
      
      IF cl_null(l_isah001) THEN 
         LET l_isah001 = ' '
      END IF
      
      IF cl_null(l_isah002) THEN 
         CONTINUE FOREACH
      END IF
      
      LET l_isat.isatent   = g_enterprise
      LET l_isat.isatcomp  = l_isbf.isbfcomp
      LET l_isat.isatsite  = l_isbf.isbfsite
      LET l_isat.isatdocno = l_isbf.isbfdocno 
#      SELECT MAX(isatseq) + 1 INTO l_isat.isatseq FROM isat_t 
#        WHERE isatent = g_enterprise 
#          AND isatcomp = l_isbf.isbfcomp  
#          AND isatdocno = l_isbf.isbfdocno
#      IF cl_null(l_isat.isatseq) THEN 
#         LET l_isat.isatseq = 1
#      END IF
      LET l_isat.isat001 = l_isbf.isbf005
      LET l_isat.isat002 = 'N'
      LET l_isat.isat003 = l_isah001
      LET l_isat.isat004 = l_isah002
      
      SELECT MAX(isatseq) + 1 INTO l_isat.isatseq FROM isat_t
        WHERE isatent = g_enterprise
          AND isat003 = l_isat.isat003
          AND isat004 = l_isat.isat004
      IF cl_null(l_isat.isatseq) THEN
         LET l_isat.isatseq = 1
      END IF
      
      #isat005	   = 由發票類型 isbf005  串aisi030 發票聯數 isac008      #  發票聯數
      SELECT isac008 INTO l_isat.isat005 FROM isac_t
       WHERE isacent = g_enterprise
         AND isac001 = l_ooef019
         AND isac002 = l_isbf.isbf005
      LET l_isat.isat006 = ''
      LET l_isat.isat007 = l_isbf.isbf002
      LET l_isat.isat008 = ''
      # isat009 #由 isbf004 串客戶全名pmaal003     #  發票客戶全名
      LET l_isat.isat009 = s_desc_get_trading_partner_full_desc(l_isbf.isbf004)
      LET l_isat.isat010 = l_isbf.isbf004
      LET l_isat.isat011 = ''
      #LET l_isat.isat012 = #營運據點串申報單位帶出統編               #  銷方稅務編號
      SELECT ooef002 INTO l_ooef002
        FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = g_isbf.isbfcomp
      
      SELECT isao001,isao002,isao003,isao004,isao005
        INTO l_isao001,l_isao002,l_isao003,l_isao004,l_isao005
        FROM isao_t
       WHERE isaoent = g_enterprise
         AND isaosite = l_isbf.isbfcomp
         AND isaostus = 'Y'
         
      IF l_isai008 = 'TW' THEN
         LET l_isat.isat012 = l_ooef002
      ELSE
         LET l_isat.isat012 = l_isao001
      END IF   
      LET l_isat.isat013 = ''
      LET l_isat.isat014 = '11' 
      LET l_isat.isat015 = l_isbf.isbf003
      LET l_isat.isat016 = '' 
      LET l_isat.isat017 = g_today
      LET l_isat.isat018 = g_time
      LET l_isat.isat019 = l_isbf.isbf001
      LET l_isat.isat020 = ''	
      LET l_isat.isat021 = 0
      LET l_isat.isat022 = '1' 
      LET l_isat.isat023 = 5
      LET l_isat.isat025 = '11'  #albireo 160408 add
      LET l_isat.isat100 = l_glaa001 #法人主帳套幣別
      LET l_isat.isat101 = 1
      LET l_isat.isat103 = l_isah103         
      LET l_isat.isat104 = l_isah104      
      LET l_isat.isat105 = l_isah105     
      LET l_isat.isat106 = 0
      LET l_isat.isat107 = 0
      LET l_isat.isat113 = l_isat.isat103 
      LET l_isat.isat114 = l_isat.isat104 
      LET l_isat.isat115 = l_isat.isat105 
      
      IF l_isai004 = '1' THEN 
         IF l_isat.isat103 < 0 THEN 
            LET l_isat.isat103 = l_isat.isat103 * -1
         END IF
         IF l_isat.isat104 < 0 THEN 
            LET l_isat.isat104 = l_isat.isat104 * -1
         END IF
         IF l_isat.isat105 < 0 THEN 
            LET l_isat.isat105 = l_isat.isat105 * -1
         END IF
         IF l_isat.isat113 < 0 THEN 
            LET l_isat.isat113 = l_isat.isat113 * -1
         END IF
         IF l_isat.isat114 < 0 THEN 
            LET l_isat.isat114 = l_isat.isat114 * -1
         END IF
         IF l_isat.isat115 < 0 THEN 
            LET l_isat.isat115 = l_isat.isat115 * -1
         END IF
      END IF
      
      IF l_isat.isat022 = '1' THEN 
         LET l_isat.isat201 = l_isat.isat105
      ELSE
         LET l_isat.isat201 = 0
      END IF
      
      IF l_isat.isat022 = '2' THEN 
         LET l_isat.isat202 = l_isat.isat105
      ELSE
         LET l_isat.isat202 = 0
      END IF
      
      IF l_isat.isat022 = '3' THEN 
         LET l_isat.isat203 = l_isat.isat105
      ELSE
         LET l_isat.isat203 = 0
      END IF
      LET l_isat.isat204 = ''
      LET l_isat.isat205 = ''
      LET l_isat.isat206 = ''
      LET l_isat.isat207 = ''
      LET l_isat.isat208 = ''
      LET l_isat.isat209 = ''
      
      INSERT INTO isat_t VALUES(l_isat.*)
      
      IF SQLCA.SQLcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "isat_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
  
         LET r_success = FALSE
      END IF
   END FOREACH 
   
  # RETURN r_success  
   
END FUNCTION

################################################################################
# Descriptions...: 回寫發票號碼
# Memo...........:
# Date & Author..: 150612 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aist330_autoupd_isah()
 DEFINE  l_n                   LIKE type_t.num5
   DEFINE  l_isaf010             LIKE isaf_t.isaf010
   DEFINE  l_isaf011             LIKE isaf_t.isaf011
   DEFINE  l_success             LIKE type_t.num5
   
   SELECT COUNT(*) INTO l_n 
     FROM isat_t 
    WHERE isatent = g_enterprise
      AND isatcomp = g_isbf_m.isbfcomp
      AND isatdocno = g_isbf_m.isbfdocno
      
   IF l_n = 0 THEN 
      RETURN
   END IF
   
   SELECT COUNT(DISTINCT isat003) INTO l_n 
     FROM isat_t 
    WHERE isatent = g_enterprise
      AND isatcomp = g_isaf_m.isbfcomp
      AND isatdocno = g_isaf_m.isbfdocno

   IF l_n > 1 THEN 
      LET l_isaf010 = 'MULTI'
   ELSE
      SELECT DISTINCT isat003 INTO l_isaf010
        FROM isat_t 
       WHERE isatent = g_enterprise
         AND isatcomp = g_isbf_m.isbfcomp
         AND isatdocno = g_isbf_m.isbfdocno
   END IF
   
   SELECT COUNT(DISTINCT isat004) INTO l_n 
     FROM isat_t 
    WHERE isatent = g_enterprise
      AND isatcomp = g_isbf_m.isbfcomp
      AND isatdocno = g_isbf_m.isbfdocno

   IF l_n > 1 THEN 
      LET l_isaf011 = 'MULTI'
   ELSE
      SELECT isat004 INTO l_isaf011
        FROM isat_t 
       WHERE isatent = g_enterprise
         AND isatcomp = g_isbf_m.isbfcomp
         AND isatdocno = g_isbf_m.isbfdocno
   END IF
   
   #开启事务
   CALL s_transaction_begin()
   LET l_success = TRUE
   
   UPDATE isaf_t SET isaf010 = l_isaf010,
                     isaf011 = l_isaf011
    WHERE isafent = g_enterprise
      AND isafcomp = g_isbf_m.isbfcomp
      AND isafdocno = g_isbf_m.isbfdocno
      
   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "UPDATE isaf_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
  
      LET l_success = FALSE                         
   END IF 

   UPDATE isah_t SET isah001 = l_isaf010,
                     isah002 = l_isaf011
    WHERE isahent = g_enterprise
      AND isahcomp = g_isbf_m.isbfcomp
      AND isahdocno = g_isbf_m.isbfdocno
      
   IF SQLCA.SQLcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = "UPDATE isah_t"
      LET g_errparam.popup = TRUE
      CALL cl_err()
  
      LET l_success = FALSE                           
   END IF 
   
   IF l_success = TRUE THEN 
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF
END FUNCTION

################################################################################
# Descriptions...: 檢核單身不可存在有不同稅率的單身
# Memo...........:
# Date & Author..: 150618 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aist330_isbg001_002_chk2(p_ac,p_isai002)
   DEFINE p_ac   LIKE type_t.num10
   DEFINE p_isai002 LIKE isai_t.isai002
   DEFINE r_success LIKE type_t.num5
   DEFINE r_errno   LIKE gzze_t.gzze001
   DEFINE l_sql     STRING
   DEFINE l_count   LIKE type_t.num10
   
   LET r_success = TRUE
   LET r_errno = ''
   
   #依發票號碼重取稅率
   IF p_isai002 = '1' THEN
      LET g_isbg_d[p_ac].l_isat023 = NULL
      SELECT isat023
        INTO g_isbg_d[p_ac].l_isat023
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat004 = g_isbg_d[p_ac].isbg002
   ELSE
      LET g_isbg_d[p_ac].l_isat023 = NULL
      SELECT isat023
        INTO g_isbg_d[p_ac].l_isat023
        FROM isat_t
       WHERE isatent = g_enterprise
         AND isat003 = g_isbg_d[p_ac].isbg001
         AND isat004 = g_isbg_d[p_ac].isbg002
   END IF
   
   LET l_sql = "SELECT COUNT(isat023) FROM isat_t ",
               " WHERE isatent = ",g_enterprise," ",
               "   AND isat023 <> ",g_isbg_d[p_ac].l_isat023," "
   IF p_isai002 = '1' THEN
      LET l_sql = l_sql CLIPPED,
                  " AND isat004 IN (",
                  "                 SELECT isbg002 FROM isbg_t ",
                  "                  WHERE isbgent = ",g_enterprise," ",
                  "                    AND isbgcomp = '",g_isbf_m.isbfcomp,"' ",
                  "                    AND isbgdocno = '",g_isbf_m.isbfdocno,"' ",
                  "                    AND isbgseq <> ",g_isbg_d[p_ac].isbgseq," ",
                  ")"
   ELSE
      LET l_sql = l_sql CLIPPED,
                  " AND (isat003,isat004) IN (",
                  "                 SELECT isbg001,isbg002 FROM isbg_t ",
                  "                  WHERE isbgent = ",g_enterprise," ",
                  "                    AND isbgcomp = '",g_isbf_m.isbfcomp,"' ",
                  "                    AND isbgdocno = '",g_isbf_m.isbfdocno,"' ",
                  "                    AND isbgseq <> ",g_isbg_d[p_ac].isbgseq," ",
                  ")"
   END IF            
   PREPARE sel_bg001002chk2p FROM l_sql
   EXECUTE sel_bg001002chk2p INTO l_count
   
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   IF l_count > 0 THEN
      LET r_success = FALSE
      LET r_errno = 'ais-00221'
   END IF
   
   RETURN r_success,r_errno
END FUNCTION

 
{</section>}
 
