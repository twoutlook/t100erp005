#該程式未解開Section, 採用最新樣板產出!
{<section id="aisp320.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0016(2016-09-20 11:32:41), PR版次:0016(2016-10-26 14:35:01)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000165
#+ Filename...: aisp320
#+ Description: 出貨單批次發票開立作業
#+ Creator....: 03080(2015-06-03 15:16:40)
#+ Modifier...: 04152 -SD/PR- 04152
 
{</section>}
 
{<section id="aisp320.global" >}
#應用 p01 樣板自動產生(Version:18)
#add-point:填寫註解說明
#150624-00005#4   150629 By Jessy     處理排程相關程式
#150730-00006#1   150730 By albireo   帳務中心,帳套加入直接開程式時的預設值;稅務編號取值原則加上區域功能
#150803                  By albireo   清空帳務中心時  全欄位清空
#150904-00006#3   150907 By albireo   增加商用發票號碼邏輯
#150918-00001#7   150922 By albireo   1.有來源單時銷退發票類型改取aisi030新欄位 發票類型對應的折單類型;
#                                     2.出貨外銷抓對應的IV塞入isat
#                                     3.銷退外銷走xmdl單身發票號碼去產生isat
#150930-00010#1   150930 By albireo   回寫出貨發票號碼一律用isat最大號的發票號碼
#151012-00014#7   151014 By Jessy     帶入日/月平均匯率預設值，依aoos020(S-FIN-2009)設定
#151022-00017#2   151023 By Jessy     轉發票之匯率依畫面條件取得
#151021           151021 By albireo   isaf052 給定原單site(除內銷出貨)
#151123-00013#7   151127 By albireo   開窗邏輯增加出貨簽收流程
#151207-00018#2   151208 By albireo   出貨簽收邏輯變更
#151209-00019#2   151218 By albireo   由出貨單產生至 aist310時, isaf028統一編號,應該捉取aooi100的 ooef002
#151231-00010#3   160115 By albireo   增加交易對象控制組
#160120-00009#1   160130 By albireo   原兩條件(組織及簿號)都輸入才做控卡(因為必輸)  現在改成無輸入組織就進簿號提示先輸入組織並跳回組織
#160413-00034#1   160414 By albireo   160413-00033#1  問題相同;增加檢核加入作業別
#160318-00025#41  160425 By pengxin   將重複內容的錯誤訊息置換為公用錯誤訊息(r.v)
#160517-00005#1   160519 By albireo   針對使用回收號發票修改
#160601無單        160601 By albireo   kris:發票簿都不分作業都可取得
#160426-00013#3   160530 By Reanna    增加訂金發票流程
#160606無單       160606 By albireo   指定單號連續開發票時,問題修正
#160707-00023#1   160908 By Reanna    1.依據彙總條件拆單產生 2.版面調整 3.QBE增加條件
#160802-00007#1   160926 By 01727     一次性交易對象識別碼(pmaa004=2)功能應用
#161012-00026#2   161019 By albireo   匯率設定預設值改1.依原單
#161006-00005#33  161026 By Reanna    帳務中心(xrcasite)開窗改用q_ooef001_46()
#end add-point
#add-point:填寫註解說明(客製用)

#end add-point
 
IMPORT os
IMPORT util
IMPORT FGL lib_cl_schedule
#add-point:增加匯入項目

#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
GLOBALS "../../cfg/top_schedule.inc"
GLOBALS
   DEFINE gwin_curr2  ui.Window
   DEFINE gfrm_curr2  ui.Form
   DEFINE gi_hiden_asign       LIKE type_t.num5
   DEFINE gi_hiden_exec        LIKE type_t.num5
   DEFINE gi_hiden_spec        LIKE type_t.num5
   DEFINE gi_hiden_exec_end    LIKE type_t.num5
   DEFINE g_chk_jobid          LIKE type_t.num5
END GLOBALS
 
PRIVATE TYPE type_parameter RECORD
   #add-point:自定背景執行須傳遞的參數(Module Variable)
   #150624-00005#4-----s
   l_xrcasite    LIKE type_t.chr10,
   l_xrcald      LIKE type_t.chr5,
   l_xrcacomp    LIKE type_t.chr10,
   l_xmdk015     LIKE type_t.chr2,
   l_curr_type   LIKE type_t.chr500,
   l_slip1       LIKE type_t.chr500,
   l_docdt       LIKE type_t.dat,
   l_toaistype   LIKE type_t.chr10,
   l_site        LIKE type_t.chr10,
   l_book        LIKE type_t.chr500,
   l_dat_memo    LIKE type_t.dat,
   l_isaf010     LIKE type_t.chr20,
   l_limit_memo  LIKE type_t.num20_6,
   l_isaf011     LIKE type_t.chr20,
   l_toaxrtype   LIKE type_t.chr100,
   l_slip2       LIKE type_t.chr500,
   l_slip3       LIKE type_t.chr500,   #160707-00023#1
   l_xrca063     LIKE type_t.chr20,
   l_xrca007     LIKE type_t.chr20,
   #150624-00005#4-----e
   #160707-00023#1 add ------
   l_xmdk042     LIKE type_t.chr1,
   l_group_type  LIKE type_t.chr1,
   l_chk1        LIKE type_t.chr1,
   l_chk2        LIKE type_t.chr1,
   #160707-00023#1 add end---
   #end add-point
        wc               STRING
                     END RECORD
 
DEFINE g_sql             STRING        #組 sql 用
DEFINE g_forupd_sql      STRING        #SELECT ... FOR UPDATE  SQL
DEFINE g_error_show      LIKE type_t.num5
DEFINE g_jobid           STRING
DEFINE g_wc              STRING
 
PRIVATE TYPE type_master RECORD
       l_xrcasite LIKE type_t.chr10, 
   l_xrcasite_desc LIKE type_t.chr80, 
   l_xmdk042 LIKE type_t.chr10, 
   l_group_type LIKE type_t.chr500, 
   l_xrcacomp LIKE type_t.chr10, 
   l_xrcald LIKE type_t.chr5, 
   l_xrcald_desc LIKE type_t.chr80, 
   l_chk1 LIKE type_t.chr500, 
   l_chk2 LIKE type_t.chr500, 
   l_toaxrtype LIKE type_t.chr100, 
   l_xmdk015 LIKE type_t.chr2, 
   l_xmdk015_desc LIKE type_t.chr80, 
   l_curr_type LIKE type_t.chr500, 
   l_slip1 LIKE type_t.chr500, 
   l_slip1_desc LIKE type_t.chr80, 
   l_docdt LIKE type_t.dat, 
   l_toaistype LIKE type_t.chr10, 
   l_slip2 LIKE type_t.chr500, 
   l_slip2_desc LIKE type_t.chr80, 
   l_slip3 LIKE type_t.chr500, 
   l_slip3_desc LIKE type_t.chr80, 
   l_xrca007 LIKE type_t.chr10, 
   l_xrca007_desc LIKE type_t.chr80, 
   l_xrca063 LIKE type_t.chr20, 
   l_site LIKE type_t.chr10, 
   l_site_desc LIKE type_t.chr80, 
   l_book LIKE type_t.chr500, 
   l_dat_memo LIKE type_t.dat, 
   l_isaf010 LIKE type_t.chr20, 
   l_limit_memo LIKE type_t.num20_6, 
   l_isae007 LIKE type_t.chr20, 
   l_isaf011 LIKE type_t.chr20, 
   xmdkdocno LIKE type_t.chr20, 
   xmdk007 LIKE type_t.chr10, 
   xmdk009 LIKE type_t.chr10, 
   xmdkdocdt LIKE type_t.dat, 
   xmdk004 LIKE type_t.chr10, 
   xmdk003 LIKE type_t.chr20, 
   stagenow LIKE type_t.chr80,
       wc               STRING
       END RECORD
 
#模組變數(Module Variables)
DEFINE g_master type_master
 
#add-point:自定義模組變數(Module Variable)
DEFINE g_glaald   LIKE glaa_t.glaald
DEFINE g_ooef019  LIKE ooef_t.ooef019
DEFINE g_xmdk000  LIKE xmdk_t.xmdk000

DEFINE g_xmdk    RECORD
                 xmdk015   LIKE xmdk_t.xmdk015,
                 xmdk017   LIKE xmdk_t.xmdk017,
                 xmdksite  LIKE xmdk_t.xmdksite,
                 xmdk001   LIKE xmdk_t.xmdk001,
                 xmdk000   LIKE xmdk_t.xmdk000,
                 xmdk008   LIKE xmdk_t.xmdk008   #albireo 150826 add
                 END RECORD
DEFINE g_isao    RECORD
                 isao014   LIKE isao_t.isao014,
                 isao015   LIKE isao_t.isao015,
                 isao016   LIKE isao_t.isao016
                 END RECORD
DEFINE g_isai    RECORD  LIKE isai_t.*
DEFINE g_isaq    RECORD  LIKE isaq_t.*
DEFINE g_isac    RECORD  LIKE isac_t.*
DEFINE g_master_o type_master
DEFINE g_wc_xrcasite         STRING                   #帳務組織條件
DEFINE g_wc_xrcald           STRING

#150918-00001#7-----s
DEFINE g_xmdkdocno           LIKE xmdk_t.xmdkdocno    #隨貨附發票時外部呼叫時的出貨單號
#150918-00001#7-----e
DEFINE g_sql_ctrl            STRING                   #160707-00023#1
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable)

#end add-point
 
#add-point:傳入參數說明

#end add-point
 
{</section>}
 
{<section id="aisp320.main" >}
MAIN
   #add-point:main段define (客製用)
   
   #end add-point 
   DEFINE ls_js    STRING
   DEFINE lc_param type_parameter  
   #add-point:main段define 
   
   #end add-point 
  
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
 
   #add-point:初始化前定義
   
   #end add-point
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("ais","")
 
   #add-point:定義背景狀態與整理進入需用參數ls_js
 
   #end add-point
 
   #背景(Y) 或半背景(T) 時不做主畫面開窗
   IF g_bgjob = "Y" OR g_bgjob = "T" THEN
      #排程參數由01開始，若不是1開始，表示有保留參數
      LET ls_js = g_argv[01]
     #CALL util.JSON.parse(ls_js,g_master)   #p類主要使用l_param,此處不解析
      #add-point:Service Call
      CALL s_fin_create_account_center_tmp()                   #展組織下階成員所需之暫存檔
      CALL s_voucher_cre_ar_tmp_table() RETURNING g_sub_success
      CALL s_aooi390_cre_tmp_table() RETURNING g_sub_success      
      #end add-point
      CALL aisp320_process(ls_js)
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_aisp320 WITH FORM cl_ap_formpath("ais",g_code)
 
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
 
      #程式初始化
      CALL aisp320_init()
 
      #進入選單 Menu (="N")
      CALL aisp320_ui_dialog()
 
      #add-point:畫面關閉前
      
      #end add-point
      #畫面關閉
      CLOSE WINDOW w_aisp320
   END IF
 
   #add-point:作業離開前
   
   #end add-point
 
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
 
{</section>}
 
{<section id="aisp320.init" >}
#+ 初始化作業
PRIVATE FUNCTION aisp320_init()
 
   #add-point:init段define (客製用)
   
   #end add-point
   #add-point:ui_dialog段define 
   
   #end add-point
 
   LET g_error_show = 1
   LET gwin_curr2 = ui.Window.getCurrent()
   LET gfrm_curr2 = gwin_curr2.getForm()
   CALL cl_schedule_import_4fd()
   CALL cl_set_combo_scc("gzpa003","75")
   IF cl_get_para(g_enterprise,"","E-SYS-0005") = "N" THEN
       CALL cl_set_comp_visible("scheduling_page,history_page",FALSE)
   END IF 
   #add-point:畫面資料初始化
   CALL cl_set_combo_scc('l_toaistype','9731')
   CALL cl_set_combo_scc('l_curr_type','9951')
   CALL cl_set_combo_scc('l_toaxrtype','9960')
   CALL s_fin_create_account_center_tmp()                   #展組織下階成員所需之暫存檔
   CALL s_voucher_cre_ar_tmp_table() RETURNING g_sub_success
   CALL s_aooi390_cre_tmp_table() RETURNING g_sub_success
   
   #160707-00023#1 -s
   CALL cl_set_combo_scc('l_xmdk042','2085')                  #內外銷
   CALL cl_set_combo_scc_part('l_group_type','8327','0,2,3')  #彙總條件
   LET g_sql_ctrl = NULL
   CALL s_control_get_customer_sql('2',g_site,g_user,g_dept,'') RETURNING g_sub_success,g_sql_ctrl
   #160707-00023#1 -e
   #end add-point
   
END FUNCTION
 
{</section>}
 
{<section id="aisp320.ui_dialog" >}
#+ 選單功能實際執行處
PRIVATE FUNCTION aisp320_ui_dialog()
 
   #add-point:ui_dialog段define (客製用)
   
   #end add-point
   DEFINE li_exit  LIKE type_t.num5    #判別是否為離開作業
   DEFINE li_idx   LIKE type_t.num10
   DEFINE ls_js    STRING
   DEFINE ls_wc    STRING
   DEFINE l_dialog ui.DIALOG
   DEFINE lc_param type_parameter
   #add-point:ui_dialog段define 
   DEFINE l_glaa024     LIKE glaa_t.glaa024
   DEFINE l_comp        LIKE ooef_t.ooef001
   DEFINE l_isae007     LIKE isae_t.isae007
   DEFINE l_isae008     LIKE isae_t.isae008
   DEFINE l_isae012     LIKE isae_t.isae012
   DEFINE l_prog        LIKE type_t.chr20
   DEFINE l_oofg_return DYNAMIC ARRAY OF RECORD
             oofg019       LIKE oofg_t.oofg019,   #field
             oofg020       LIKE oofg_t.oofg020    #value
                        END RECORD
   DEFINE l_count       LIKE type_t.num10
   DEFINE l_tran        RECORD
             wc            STRING
                        END RECORD
   DEFINE l_ctl_where   STRING                #151231-00010#3
   DEFINE l_isah002do   LIKE isah_t.isah002   #160517-00005#1
   #end add-point
   
   #add-point:ui_dialog段before dialog
   CALL aisp320_qbeclear()
   #end add-point
 
   WHILE TRUE
      #add-point:ui_dialog段before dialog2
      
      #end add-point
 
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
         #應用 a57 樣板自動產生(Version:3)
         INPUT BY NAME g_master.l_xrcasite,g_master.l_xmdk042,g_master.l_group_type,g_master.l_xrcacomp, 
             g_master.l_xrcald,g_master.l_chk1,g_master.l_chk2,g_master.l_toaxrtype,g_master.l_xmdk015, 
             g_master.l_curr_type,g_master.l_slip1,g_master.l_docdt,g_master.l_toaistype,g_master.l_slip2, 
             g_master.l_slip3,g_master.l_xrca007,g_master.l_xrca063,g_master.l_site,g_master.l_book, 
             g_master.l_dat_memo,g_master.l_isaf010,g_master.l_limit_memo,g_master.l_isae007,g_master.l_isaf011  
 
            ATTRIBUTE(WITHOUT DEFAULTS)
            
            #自訂ACTION(master_input)
            
         
            BEFORE INPUT
               #add-point:資料輸入前 name="input.m.before_input"
               
               #end add-point
         
                     #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xrcasite
            
            #add-point:AFTER FIELD l_xrcasite name="input.a.l_xrcasite"

            #albireo 150713-----s
            IF NOT cl_null(g_master.l_xrcasite)THEN
               IF (g_master.l_xrcasite <> g_master_o.l_xrcasite) OR (g_master_o.l_xrcasite IS NULL) THEN
                  CALL s_fin_account_center_sons_query('3',g_master.l_xrcasite,g_today,'1')          
                  CALL s_fin_account_center_with_ld_chk(g_master.l_xrcasite,'',g_user,'3','N','',g_today) RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_master.l_xrcasite = g_master_o.l_xrcasite
                     CALL s_desc_get_department_desc(g_master.l_xrcasite) RETURNING g_master.l_xrcasite_desc
                     DISPLAY BY NAME g_master.l_xrcasite,g_master.l_xrcasite_desc
                     NEXT FIELD l_xrcasite
                  END IF
                  
                  CALL s_fin_orga_get_comp_ld(g_master.l_xrcasite) RETURNING g_sub_success,g_errno,g_master.l_xrcacomp,g_master.l_xrcald
                  SELECT ooef019 INTO g_ooef019 FROM ooef_t
                   WHERE ooefent =g_enterprise
                     AND ooef001 = g_master.l_xrcacomp
                  
                  LET g_master.l_site = ''
                  LET g_master.l_book = ''
                  #albireo 150803-----s
                  LET g_master.l_site_desc = ''
                  DISPLAY BY NAME g_master.l_site_desc
                  LET g_master.l_slip1 = ''
                  LET g_master.l_slip1_desc = ''
                  LET g_master.l_slip2 = ''
                  LET g_master.l_slip2_desc = ''
                  LET g_master.l_xmdk015 = ''
                  LET g_master.l_xmdk015_desc = ''
                  DISPLAY BY NAME g_master.l_slip1,g_master.l_slip1_desc,
                                  g_master.l_slip2,g_master.l_slip2_desc,
                                  g_master.l_xmdk015,g_master.l_xmdk015_desc
                  DISPLAY '' TO xmdkdocno
                  #albireo 150803-----e
                  
                  DISPLAY BY NAME g_master.l_site,g_master.l_book
                  LET g_master.l_xrcald_desc = s_desc_get_ld_desc(g_master.l_xrcald)
                  LET g_master.l_xrcasite_desc = s_desc_get_department_desc(g_master.l_xrcasite)
                  DISPLAY BY NAME g_master.l_xrcald_desc,g_master.l_xrcasite_desc
                  
                  CALL s_fin_account_center_sons_str() RETURNING g_wc_xrcasite
                  CALL s_fin_get_wc_str(g_wc_xrcasite) RETURNING g_wc_xrcasite
                  CALL s_fin_account_center_ld_str() RETURNING g_wc_xrcald
                  CALL s_fin_get_wc_str(g_wc_xrcald) RETURNING g_wc_xrcald
                  
                  INITIALIZE g_isai.* TO NULL
                  SELECT * INTO g_isai.* FROM isai_t
                   WHERE isaient = g_enterprise
                     AND isai001 = g_ooef019

                  #albireo 150817-----s
                  IF NOT cl_null(g_master.l_toaxrtype)THEN
                     INITIALIZE g_isao.* TO NULL
                     SELECT isao014,isao015,isao016 
                       INTO g_isao.*
                       FROM isao_t
                      WHERE isaoent = g_enterprise
                        AND isaosite = g_master.l_xrcasite 
                     IF g_master.l_toaxrtype = '2' THEN
                        #折讓
                        LET g_master.l_slip1 = g_isao.isao015
                     ELSE
                        #出貨
                        LET g_master.l_slip1 = g_isao.isao014
                     END IF
                     CALL s_aooi200_fin_get_slip_desc(g_master.l_slip1) RETURNING g_master.l_slip1_desc
                     DISPLAY BY NAME g_master.l_slip1,g_master.l_slip1_desc
                     
                  END IF
                  #albireo 150817-----e
               END IF
            END IF
            LET g_master_o.l_xrcasite = g_master.l_xrcasite
            CALL s_desc_get_department_desc(g_master.l_xrcasite) RETURNING g_master.l_xrcasite_desc
            DISPLAY BY NAME g_master.l_xrcasite_desc
            #albireo 150713-----e
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xrcasite
            #add-point:BEFORE FIELD l_xrcasite name="input.b.l_xrcasite"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xrcasite
            #add-point:ON CHANGE l_xrcasite name="input.g.l_xrcasite"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xmdk042
            #add-point:BEFORE FIELD l_xmdk042 name="input.b.l_xmdk042"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xmdk042
            
            #add-point:AFTER FIELD l_xmdk042 name="input.a.l_xmdk042"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xmdk042
            #add-point:ON CHANGE l_xmdk042 name="input.g.l_xmdk042"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_group_type
            #add-point:BEFORE FIELD l_group_type name="input.b.l_group_type"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_group_type
            
            #add-point:AFTER FIELD l_group_type name="input.a.l_group_type"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_group_type
            #add-point:ON CHANGE l_group_type name="input.g.l_group_type"
            #160707-00023#1 add ------
            CALL cl_set_comp_entry("l_slip2,l_slip3",TRUE)
            IF g_master.l_toaxrtype = '1' AND g_master.l_group_type = '0' THEN
               CALL cl_set_comp_entry("l_slip3",FALSE)
               LET g_master.l_slip3 = ''
               LET g_master.l_slip3_desc = ''
               DISPLAY BY NAME g_master.l_slip3,g_master.l_slip3_desc
            END IF
            IF g_master.l_toaxrtype = '2' THEN
               CALL cl_set_comp_entry("l_slip2",FALSE)
               LET g_master.l_slip2 = ''
               LET g_master.l_slip2_desc = ''
               DISPLAY BY NAME g_master.l_slip2,g_master.l_slip2_desc
            END IF
            #160707-00023#1 add end---
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xrcacomp
            #add-point:BEFORE FIELD l_xrcacomp name="input.b.l_xrcacomp"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xrcacomp
            
            #add-point:AFTER FIELD l_xrcacomp name="input.a.l_xrcacomp"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xrcacomp
            #add-point:ON CHANGE l_xrcacomp name="input.g.l_xrcacomp"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xrcald
            
            #add-point:AFTER FIELD l_xrcald name="input.a.l_xrcald"


            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xrcald
            #add-point:BEFORE FIELD l_xrcald name="input.b.l_xrcald"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xrcald
            #add-point:ON CHANGE l_xrcald name="input.g.l_xrcald"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_chk1
            #add-point:BEFORE FIELD l_chk1 name="input.b.l_chk1"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_chk1
            
            #add-point:AFTER FIELD l_chk1 name="input.a.l_chk1"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_chk1
            #add-point:ON CHANGE l_chk1 name="input.g.l_chk1"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_chk2
            #add-point:BEFORE FIELD l_chk2 name="input.b.l_chk2"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_chk2
            
            #add-point:AFTER FIELD l_chk2 name="input.a.l_chk2"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_chk2
            #add-point:ON CHANGE l_chk2 name="input.g.l_chk2"
            #160707-00023#1 -s
            CALL cl_set_comp_visible('group_toaxr',TRUE)
            IF g_master.l_chk2 = 'N' THEN
               CALL cl_set_comp_visible('group_toaxr',FALSE)
            END IF
            #160707-00023#1 -s
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_toaxrtype
            #add-point:BEFORE FIELD l_toaxrtype name="input.b.l_toaxrtype"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_toaxrtype
            
            #add-point:AFTER FIELD l_toaxrtype name="input.a.l_toaxrtype"
           
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_toaxrtype
            #add-point:ON CHANGE l_toaxrtype name="input.g.l_toaxrtype"
            #160707-00023#1 mark ------
            #LET g_master.l_slip2 = ''
            #LET g_master.l_slip2_desc = ''
            #DISPLAY BY NAME g_master.l_slip2,g_master.l_slip2_desc
            #160707-00023#1 mark end---
            #160707-00023#1 add ------
            CALL cl_set_comp_entry("l_slip2,l_slip3",TRUE)
            IF g_master.l_toaxrtype = '1' AND g_master.l_group_type = '0' THEN
               CALL cl_set_comp_entry("l_slip3",FALSE)
               LET g_master.l_slip3 = ''
               LET g_master.l_slip3_desc = ''
               DISPLAY BY NAME g_master.l_slip3,g_master.l_slip3_desc
            END IF
            IF g_master.l_toaxrtype = '2' THEN
               CALL cl_set_comp_entry("l_slip2",FALSE)
               LET g_master.l_slip2 = ''
               LET g_master.l_slip2_desc = ''
               DISPLAY BY NAME g_master.l_slip2,g_master.l_slip2_desc
            END IF
            #160707-00023#1 add end---
            #albireo 150817-----s
            IF NOT cl_null(g_master.l_toaxrtype)THEN
               INITIALIZE g_isao.* TO NULL
               SELECT isao014,isao015,isao016 
                 INTO g_isao.*
                 FROM isao_t
                WHERE isaoent = g_enterprise
                  AND isaosite = g_master.l_xrcasite 
               IF g_master.l_toaxrtype = '2' THEN
                  #折讓
                  LET g_master.l_slip1 = g_isao.isao015
               ELSE
                  #出貨
                  LET g_master.l_slip1 = g_isao.isao014
               END IF
               CALL s_aooi200_fin_get_slip_desc(g_master.l_slip1) RETURNING g_master.l_slip1_desc
               DISPLAY BY NAME g_master.l_slip1,g_master.l_slip1_desc
               
            END IF
            #albireo 150817-----e
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xmdk015
            
            #add-point:AFTER FIELD l_xmdk015 name="input.a.l_xmdk015"
            LET g_master.l_xmdk015_desc = ''
            DISPLAY BY NAME g_master.l_xmdk015_desc
            IF NOT cl_null(g_master.l_xmdk015)THEN
               IF (g_master.l_xmdk015 <> g_master_o.l_xmdk015) OR (g_master_o.l_xmdk015 IS NULL) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_ooef019
                  LET g_chkparam.arg2 = g_master.l_xmdk015
                  IF NOT cl_chk_exist("v_isac002_2") THEN
                     LET g_master.l_xmdk015 = g_xmdk.xmdk015
                     INITIALIZE g_isaq.* TO NULL
                     SELECT * INTO g_isaq.* FROM isaq_t
                      WHERE isaqent = g_enterprise
                       #AND isaqsite = g_master.l_site       #160707-00023#1 mark
                        AND isaqsite = g_master.l_xrcasite   #160707-00023#1
                        AND isaq001 = g_master.l_xmdk015
                     CALL s_desc_get_invoice_type_desc(g_master.l_xrcald,g_master.l_xmdk015)RETURNING g_master.l_xmdk015_desc
                     DISPLAY BY NAME g_master.l_xmdk015_desc
                     CALL aisp320_visible()
                     NEXT FIELD l_xmdk015
                  END IF
               END IF
            END IF
            LET g_master_o.l_xmdk015 = g_master.l_xmdk015
            
            INITIALIZE g_isaq.* TO NULL
            SELECT * INTO g_isaq.* FROM isaq_t
             WHERE isaqent = g_enterprise
              #AND isaqsite = g_master.l_site       #160707-00023#1 mark
               AND isaqsite = g_master.l_xrcasite   #160707-00023#1
               AND isaq001 = g_master.l_xmdk015
               
            INITIALIZE g_isac.* TO NULL
            SELECT * INTO g_isac.*
              FROM isac_t
             WHERE isacent = g_enterprise
               AND isac001 = g_ooef019
               AND isac002 = g_master.l_xmdk015
            CALL s_desc_get_invoice_type_desc(g_master.l_xrcald,g_master.l_xmdk015)RETURNING g_master.l_xmdk015_desc
            DISPLAY BY NAME g_master.l_xmdk015_desc
            CALL aisp320_visible()
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xmdk015
            #add-point:BEFORE FIELD l_xmdk015 name="input.b.l_xmdk015"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xmdk015
            #add-point:ON CHANGE l_xmdk015 name="input.g.l_xmdk015"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_curr_type
            #add-point:BEFORE FIELD l_curr_type name="input.b.l_curr_type"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_curr_type
            
            #add-point:AFTER FIELD l_curr_type name="input.a.l_curr_type"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_curr_type
            #add-point:ON CHANGE l_curr_type name="input.g.l_curr_type"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_slip1
            
            #add-point:AFTER FIELD l_slip1 name="input.a.l_slip1"
            IF NOT cl_null(g_master.l_slip1)THEN
               IF (g_master.l_slip1 <> g_master_o.l_slip1) OR (g_master_o.l_slip1 IS NULL) THEN
                  CALL s_aooi200_fin_chk_slip(g_master.l_xrcald,'',g_master.l_slip1,'aist310') 
                     RETURNING g_sub_success
                  IF NOT g_sub_success THEN
                     NEXT FIELD l_slip1
                  END IF
               END IF
            END IF
            LET g_master_o.l_slip1 = g_master.l_slip1
            CALL s_aooi200_fin_get_slip_desc(g_master.l_slip1) RETURNING g_master.l_slip1_desc
            DISPLAY BY NAME g_master.l_slip1_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_slip1
            #add-point:BEFORE FIELD l_slip1 name="input.b.l_slip1"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_slip1
            #add-point:ON CHANGE l_slip1 name="input.g.l_slip1"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_docdt
            #add-point:BEFORE FIELD l_docdt name="input.b.l_docdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_docdt
            
            #add-point:AFTER FIELD l_docdt name="input.a.l_docdt"
            IF NOT cl_null(g_master.l_docdt)THEN
               IF (g_master.l_docdt <> g_master_o.l_docdt) OR (g_master_o.l_docdt IS NULL) THEN
                  CALL aisp320_site_with_book_chk(g_master.l_site,g_master.l_book,g_master.l_docdt,g_master.l_xmdk015)
                    RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     LET g_master.l_docdt = NULL
                     DISPLAY BY NAME g_master.l_docdt
                     CALL cl_err()
                     NEXT FIELD l_docdt
                  END IF
               END IF
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_docdt
            #add-point:ON CHANGE l_docdt name="input.g.l_docdt"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_toaistype
            #add-point:BEFORE FIELD l_toaistype name="input.b.l_toaistype"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_toaistype
            
            #add-point:AFTER FIELD l_toaistype name="input.a.l_toaistype"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_toaistype
            #add-point:ON CHANGE l_toaistype name="input.g.l_toaistype"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_slip2
            
            #add-point:AFTER FIELD l_slip2 name="input.a.l_slip2"
            IF NOT cl_null(g_master.l_slip2)THEN
               #160707-00023#1 mark ------
               #IF g_master.l_toaxrtype = '2' THEN
               #   LET l_prog = 'axrt340'
               #ELSE
               #   LET l_prog = 'axrt300'
               #END IF
               #CALL s_aooi200_fin_chk_slip(g_master.l_xrcald,'',g_master.l_slip2,l_prog) 
               #   RETURNING g_sub_success
               #160707-00023#1 mark end---
               #160707-00023#1 -s
               CALL s_aooi200_fin_chk_slip(g_master.l_xrcald,'',g_master.l_slip2,'axrt300') 
                  RETURNING g_sub_success
               #160707-00023#1 -e
               IF NOT g_sub_success THEN
                  NEXT FIELD l_slip2
               END IF
            END IF
            CALL s_aooi200_fin_get_slip_desc(g_master.l_slip2) RETURNING g_master.l_slip2_desc
            DISPLAY BY NAME g_master.l_slip2_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_slip2
            #add-point:BEFORE FIELD l_slip2 name="input.b.l_slip2"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_slip2
            #add-point:ON CHANGE l_slip2 name="input.g.l_slip2"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_slip3
            
            #add-point:AFTER FIELD l_slip3 name="input.a.l_slip3"
            #160707-00023#1 -s
            IF NOT cl_null(g_master.l_slip3)THEN
               CALL s_aooi200_fin_chk_slip(g_master.l_xrcald,'',g_master.l_slip3,'axrt340') 
                  RETURNING g_sub_success
               IF NOT g_sub_success THEN
                  NEXT FIELD l_slip3
               END IF
            END IF
            CALL s_aooi200_fin_get_slip_desc(g_master.l_slip3) RETURNING g_master.l_slip3_desc
            DISPLAY BY NAME g_master.l_slip3_desc
            #160707-00023#1 -e
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_slip3
            #add-point:BEFORE FIELD l_slip3 name="input.b.l_slip3"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_slip3
            #add-point:ON CHANGE l_slip3 name="input.g.l_slip3"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xrca007
            
            #add-point:AFTER FIELD l_xrca007 name="input.a.l_xrca007"
            #albireo 150826-----s          
            IF NOT cl_null(g_master.l_xrca007)THEN
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_master.l_xrca007
               #160318-00025#41  2016/04/25  by pengxin  add(S)
               LET g_errshow = TRUE #是否開窗 
               LET g_chkparam.err_str[1] = "aoo-00200:sub-01302|axri012|",cl_get_progname("axri012",g_lang,"2"),"|:EXEPROGaxri012"
               #160318-00025#41  2016/04/25  by pengxin  add(E)
               IF NOT cl_chk_exist("v_oocq002_3111") THEN
                  LET g_master.l_xrca007 = g_master_o.l_xrca007 
                  CALL s_desc_get_acc_desc('3111',g_master.l_xrca007) RETURNING g_master.l_xrca007_desc
                  DISPLAY BY NAME g_master.l_xrca007_desc
                  NEXT FIELD CURRENT
               END IF
            END IF
            LET g_master_o.l_xrca007 = g_master.l_xrca007
            CALL s_desc_get_acc_desc('3111',g_master.l_xrca007) RETURNING g_master.l_xrca007_desc
            DISPLAY BY NAME g_master.l_xrca007_desc
            #albireo 150826-----e
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xrca007
            #add-point:BEFORE FIELD l_xrca007 name="input.b.l_xrca007"
            
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xrca007
            #add-point:ON CHANGE l_xrca007 name="input.g.l_xrca007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_xrca063
            #add-point:BEFORE FIELD l_xrca063 name="input.b.l_xrca063"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_xrca063
            
            #add-point:AFTER FIELD l_xrca063 name="input.a.l_xrca063"
            IF NOT cl_null(g_master.l_xrca063)THEN
               IF NOT s_aooi390_chk('14',g_master.l_xrca063) THEN
                  LET g_master.l_xrca063 = g_master_o.l_xrca063
                  DISPLAY BY NAME g_master.l_xrca063
                  NEXT FIELD CURRENT
               END IF
            END IF
            LET g_master_o.l_xrca063 = g_master.l_xrca063
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_xrca063
            #add-point:ON CHANGE l_xrca063 name="input.g.l_xrca063"
            
            #END add-point 
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_site
            
            #add-point:AFTER FIELD l_site name="input.a.l_site"
            LET g_master.l_site_desc = NULL
            DISPLAY BY NAME g_master.l_site_desc
            IF NOT cl_null(g_master.l_site)THEN
               IF (g_master.l_site <> g_master_o.l_site) OR (g_master_o.l_site) THEN
                  CALL aisp320_ooef001_chk(g_master.l_site)
                     RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     LET g_master.l_site = NULL
                     DISPLAY BY NAME g_master.l_site
                     CALL cl_err()
                     NEXT FIELD l_site
                  END IF                             
                  
                  CALL aisp320_site_with_book_chk(g_master.l_site,g_master.l_book,g_master.l_docdt,g_master.l_xmdk015)
                    RETURNING g_sub_success,g_errno
                  IF NOT g_sub_success THEN
                     INITIALIZE g_errparam.* TO NULL
                     LET g_errparam.code = g_errno
                     LET g_errparam.extend = ''
                     LET g_errparam.popup = TRUE
                     LET g_master.l_site = NULL
                     DISPLAY BY NAME g_master.l_site
                     CALL cl_err()
                     NEXT FIELD l_site
                  END IF
               END IF
            END IF       

            LET g_master_o.l_site = g_master.l_site
            SELECT isae014,isae007,isae008,isae012
               INTO g_master.l_dat_memo,l_isae007,l_isae008,l_isae012
               FROM isae_t           
              WHERE isaeent = g_enterprise
                AND isaesite = g_master.l_site
                AND isae001  = g_master.l_book
                AND isae002 <= g_master.l_docdt
                AND isae003 >= g_master.l_docdt
             
             IF g_isai.isai002 = '1' THEN 
                LET g_master.l_isaf010 = l_isae007
             END IF
              
             IF g_isai.isai002 = '2' THEN 
                LET g_master.l_isaf010 = l_isae008
             END IF
             
            LET g_master.l_isae007 = l_isae007     #160517-00005#1
            DISPLAY BY NAME g_master.l_isae007     #160517-00005#1
             
            LET g_master.l_isaf011 = l_isae012
            CALL s_desc_get_department_desc(g_master.l_site)RETURNING g_master.l_site_desc
            DISPLAY BY NAME g_master.l_site_desc
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_site
            #add-point:BEFORE FIELD l_site name="input.b.l_site"
            #160120-00009-----s
            CALL aisp320_book_exist(g_master.l_docdt,g_master.l_xmdk015)
              RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD l_xmdk015
            END IF
            #160120-00009-----e
            #END add-point
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_site
            #add-point:ON CHANGE l_site name="input.g.l_site"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_book
            #add-point:BEFORE FIELD l_book name="input.b.l_book"
            #160120-00009-----s
            IF cl_null(g_master.l_site) THEN
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = 'ais-00283'
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD l_site
            END IF
            
            
            CALL aisp320_book_exist(g_master.l_docdt,g_master.l_xmdk015)
              RETURNING g_sub_success,g_errno
            IF NOT g_sub_success THEN
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = g_errno
               LET g_errparam.extend = ''
               LET g_errparam.popup = TRUE
               CALL cl_err()
               NEXT FIELD l_xmdk015
            END IF
            #160120-00009-----e
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_book
            
            #add-point:AFTER FIELD l_book name="input.a.l_book"
            IF NOT cl_null(g_master.l_book)THEN
               CALL aisp320_site_with_book_chk(g_master.l_site,g_master.l_book,g_master.l_docdt,g_master.l_xmdk015)
                 RETURNING g_sub_success,g_errno
               IF NOT g_sub_success THEN
                  INITIALIZE g_errparam.* TO NULL
                  LET g_errparam.code = g_errno
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  LET g_master.l_book = NULL
                  DISPLAY BY NAME g_master.l_book
                  CALL cl_err()
                  NEXT FIELD l_book
               END IF
            END IF
            SELECT isae014,isae007,isae008,isae012,isae020
               INTO g_master.l_dat_memo,l_isae007,l_isae008,l_isae012,g_master.l_limit_memo
               FROM isae_t           
              WHERE isaeent = g_enterprise
                AND isaesite = g_master.l_site
                AND isae001  = g_master.l_book
                AND isae002 <= g_master.l_docdt
                AND isae003 >= g_master.l_docdt
             
             IF g_isai.isai002 = '1' THEN 
                LET g_master.l_isaf010 = l_isae007
             END IF
              
             IF g_isai.isai002 = '2' THEN 
                LET g_master.l_isaf010 = l_isae008
             END IF
             
             IF cl_null(g_master.l_limit_memo)THEN
                LET g_master.l_limit_memo = 0
             END IF
             
            LET g_master.l_isaf011 = l_isae012
            DISPLAY BY NAME g_master.l_isaf011,g_master.l_isaf010,g_master.l_limit_memo,
                            g_master.l_dat_memo
                            
            LET g_master.l_isae007 = l_isae007     #160517-00005#1
            DISPLAY BY NAME g_master.l_isae007     #160517-00005#1
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_book
            #add-point:ON CHANGE l_book name="input.g.l_book"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_dat_memo
            #add-point:BEFORE FIELD l_dat_memo name="input.b.l_dat_memo"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_dat_memo
            
            #add-point:AFTER FIELD l_dat_memo name="input.a.l_dat_memo"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_dat_memo
            #add-point:ON CHANGE l_dat_memo name="input.g.l_dat_memo"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isaf010
            #add-point:BEFORE FIELD l_isaf010 name="input.b.l_isaf010"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isaf010
            
            #add-point:AFTER FIELD l_isaf010 name="input.a.l_isaf010"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isaf010
            #add-point:ON CHANGE l_isaf010 name="input.g.l_isaf010"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_limit_memo
            #add-point:BEFORE FIELD l_limit_memo name="input.b.l_limit_memo"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_limit_memo
            
            #add-point:AFTER FIELD l_limit_memo name="input.a.l_limit_memo"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_limit_memo
            #add-point:ON CHANGE l_limit_memo name="input.g.l_limit_memo"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isae007
            #add-point:BEFORE FIELD l_isae007 name="input.b.l_isae007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isae007
            
            #add-point:AFTER FIELD l_isae007 name="input.a.l_isae007"
            
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isae007
            #add-point:ON CHANGE l_isae007 name="input.g.l_isae007"
            
            #END add-point 
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD l_isaf011
            #add-point:BEFORE FIELD l_isaf011 name="input.b.l_isaf011"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD l_isaf011
            
            #add-point:AFTER FIELD l_isaf011 name="input.a.l_isaf011"
            IF NOT cl_null(g_master.l_isaf011)THEN
               LET l_count = NULL
               SELECT COUNT(*) INTO l_count FROM isae_t          
                WHERE isaeent = g_enterprise
                  AND isaesite = g_master.l_site
                  AND isae001  = g_master.l_book
                  AND isae002 <= g_master.l_docdt
                  AND isae003 >= g_master.l_docdt
                  AND isae009 <= g_master.l_isaf011
                  AND isae010 >= g_master.l_isaf011
               IF cl_null(l_count)THEN LET l_count = 0 END IF
               IF l_count = 0 THEN
                  INITIALIZE g_errparam.* TO NULL
                  LET g_errparam.code = 'ais-00236'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_master.l_isaf011 = l_isae012
                  NEXT FIELD l_isaf011
               END IF
            
               #160517-00005#1 mark 因回收號已可小於下次列印號-----s
               
               #IF g_master.l_isaf011 < l_isae012 THEN
               #   #IF NOT cl_ask_confirm('ais-00218') THEN    #發票序時序號 因此可大於等於下次列印號碼
               #   LET g_master.l_isaf011 = l_isae012
               #   NEXT FIELD l_isaf011
#              #    END IF
               #END IF
               #160517-00005#1  因回收號已可小於下次列印號 mark-----e
               
               #160517-00005#1-----s
               #檢核發票是否產生過了
               IF g_isai.isai008 = 'TW' THEN
                 IF NOT cl_null(g_master.l_isae007)THEN
                    LET l_isah002do = g_master.l_isae007 CLIPPED,g_master.l_isaf011 CLIPPED
                 END IF    
               END IF    

               LET l_count = NULL
               IF g_isai.isai008 = 'TW' THEN
                
                  SELECT COUNT(*) INTO l_count FROM isat_t
                   WHERE isatent = g_enterprise
                     AND isat004 = l_isah002do
                     AND isat001 = g_master.l_xmdk015
                     AND to_char(isat007,'yyyy') = to_char(g_master.l_docdt,'yyyy')
                     AND isat025 = '11'
                  IF cl_null(l_count)THEN LET l_count = 0 END IF
               ELSE
                
                  SELECT COUNT(*) INTO l_count FROM isat_t
                   WHERE isatent = g_enterprise
                     AND isat004 = l_isah002do
                     AND isat001 = g_master.l_xmdk015
                     AND isat003 = g_master.l_isaf010
                     AND to_char(isat007,'yyyy') = to_char(g_master.l_docdt,'yyyy')
                     AND isat025 = '11'
                  IF cl_null(l_count)THEN LET l_count = 0 END IF
               END IF   
               IF l_count > 0 THEN
                  INITIALIZE g_errparam.* TO NULL
                  LET g_errparam.code = 'ais-00201'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  LET g_master.l_isaf011 = l_isae012
                  NEXT FIELD l_isaf011
               END IF  
               #160517-00005#1-----e
            END IF
            #END add-point
            
 
 
         #應用 a04 樣板自動產生(Version:3)
         ON CHANGE l_isaf011
            #add-point:ON CHANGE l_isaf011 name="input.g.l_isaf011"
            
            #END add-point 
 
 
 
                     #Ctrlp:input.c.l_xrcasite
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xrcasite
            #add-point:ON ACTION controlp INFIELD l_xrcasite name="input.c.l_xrcasite"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_xrcasite
            #LET g_qryparam.where = " ooef204 = 'Y' "  #161006-00005#28 mark
            #CALL q_ooef001()                          #161006-00005#28 mark
            CALL q_ooef001_46()                        #161006-00005#28
            LET g_master.l_xrcasite = g_qryparam.return1
            DISPLAY BY NAME g_master.l_xrcasite
            NEXT FIELD l_xrcasite
            #END add-point
 
 
         #Ctrlp:input.c.l_xmdk042
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xmdk042
            #add-point:ON ACTION controlp INFIELD l_xmdk042 name="input.c.l_xmdk042"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_group_type
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_group_type
            #add-point:ON ACTION controlp INFIELD l_group_type name="input.c.l_group_type"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_xrcacomp
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xrcacomp
            #add-point:ON ACTION controlp INFIELD l_xrcacomp name="input.c.l_xrcacomp"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_xrcald
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xrcald
            #add-point:ON ACTION controlp INFIELD l_xrcald name="input.c.l_xrcald"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_xrcald
            LET g_qryparam.arg1 = g_user                                 #人員權限
            LET g_qryparam.arg2 = g_dept                                 #部門權限
            #LET g_qryparam.where = " glaald IN ",g_wc_apcald
            LET g_qryparam.where = " glaacomp = '",l_comp,"' "
            CALL q_authorised_ld()
            LET g_master.l_xrcald = g_qryparam.return1
            CALL s_desc_get_ld_desc(g_master.l_xrcald) RETURNING g_master.l_xrcald_desc
            DISPLAY BY NAME g_master.l_xrcald_desc,g_master.l_xrcald
            NEXT FIELD l_xrcald
            #END add-point
 
 
         #Ctrlp:input.c.l_chk1
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_chk1
            #add-point:ON ACTION controlp INFIELD l_chk1 name="input.c.l_chk1"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_chk2
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_chk2
            #add-point:ON ACTION controlp INFIELD l_chk2 name="input.c.l_chk2"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_toaxrtype
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_toaxrtype
            #add-point:ON ACTION controlp INFIELD l_toaxrtype name="input.c.l_toaxrtype"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_xmdk015
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xmdk015
            #add-point:ON ACTION controlp INFIELD l_xmdk015 name="input.c.l_xmdk015"
            
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_xmdk015             #給予default值
            IF g_master.l_toaxrtype = '1' THEN
               LET g_qryparam.where = "     isac001 = '",g_ooef019,"'",
                                      " AND isac003 = '2'"
            ELSE
               IF g_isai.isai006 = 'N' THEN
                  LET g_qryparam.where = "     isac001 = '",g_ooef019,"'",
                                         " AND isac003 = '4'"
               ELSE
                  LET g_qryparam.where = "     isac001 = '",g_ooef019,"'",
                                         " AND (isac003 = '2' OR isac003 = '4')"
               END IF
            END IF
            CALL q_isac002()                                #呼叫開窗
            LET  g_master.l_xmdk015  = g_qryparam.return1              #將開窗取得的值回傳到變數
            DISPLAY BY NAME  g_master.l_xmdk015               #顯示到畫面上
            NEXT FIELD l_xmdk015                          #返回原欄位
            #END add-point
 
 
         #Ctrlp:input.c.l_curr_type
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_curr_type
            #add-point:ON ACTION controlp INFIELD l_curr_type name="input.c.l_curr_type"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_slip1
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_slip1
            #add-point:ON ACTION controlp INFIELD l_slip1 name="input.c.l_slip1"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_slip1
            CALL s_fin_orga_get_comp_ld(g_site) RETURNING g_sub_success,g_errno,l_comp,g_glaald
            LET l_glaa024 = ''
            SELECT glaa024 INTO l_glaa024 FROM glaa_t
             WHERE glaaent = g_enterprise
               AND glaald = g_glaald
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = "aist310"
            CALL q_ooba002_1()
            LET g_master.l_slip1 = g_qryparam.return1
            DISPLAY BY NAME g_master.l_slip1
            NEXT FIELD l_slip1
            #END add-point
 
 
         #Ctrlp:input.c.l_docdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_docdt
            #add-point:ON ACTION controlp INFIELD l_docdt name="input.c.l_docdt"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_toaistype
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_toaistype
            #add-point:ON ACTION controlp INFIELD l_toaistype name="input.c.l_toaistype"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_slip2
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_slip2
            #add-point:ON ACTION controlp INFIELD l_slip2 name="input.c.l_slip2"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_slip2
            SELECT glaa024 INTO l_glaa024 FROM glaa_t
             WHERE glaaent = g_enterprise
               AND glaald = g_master.l_xrcald
            LET g_qryparam.arg1 = l_glaa024
            #160707-00023#1 mark ------
            #IF g_master.l_toaxrtype = '1' THEN
            #   LET g_qryparam.arg2 = 'axrt300'
            #ELSE
            #   LET g_qryparam.arg2 = 'axrt340'
            #END IF
            #160707-00023#1 mark end---
            LET g_qryparam.arg2 = 'axrt300'   #160707-00023#1
            CALL q_ooba002_1()
            LET g_master.l_slip2 = g_qryparam.return1
            DISPLAY BY NAME g_master.l_slip2
            NEXT FIELD l_slip2
            #END add-point
 
 
         #Ctrlp:input.c.l_slip3
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_slip3
            #add-point:ON ACTION controlp INFIELD l_slip3 name="input.c.l_slip3"
            #160707-00023#1-s
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_slip3
            SELECT glaa024 INTO l_glaa024 FROM glaa_t
             WHERE glaaent = g_enterprise
               AND glaald = g_master.l_xrcald
            LET g_qryparam.arg1 = l_glaa024
            LET g_qryparam.arg2 = 'axrt340'
            CALL q_ooba002_1()
            LET g_master.l_slip3 = g_qryparam.return1
            DISPLAY BY NAME g_master.l_slip3
            NEXT FIELD l_slip3
            #160707-00023#1-e
            #END add-point
 
 
         #Ctrlp:input.c.l_xrca007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xrca007
            #add-point:ON ACTION controlp INFIELD l_xrca007 name="input.c.l_xrca007"
            #albireo 150826-----s
            #開窗i段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_xrca007 
            LET g_qryparam.arg1 = "3111" 
            CALL q_oocq002()             
            LET g_master.l_xrca007 = g_qryparam.return1
            CALL s_desc_get_acc_desc('3211',g_master.l_xrca007) RETURNING g_master.l_xrca007_desc
            DISPLAY BY NAME g_master.l_xrca007_desc
            NEXT FIELD l_xrca007                   
            #albireo 150826-----e
            #END add-point
 
 
         #Ctrlp:input.c.l_xrca063
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_xrca063
            #add-point:ON ACTION controlp INFIELD l_xrca063 name="input.c.l_xrca063"
            CALL s_aooi390_gen('14') RETURNING g_sub_success,g_master.l_xrca063,l_oofg_return   
            DISPLAY BY NAME g_master.l_xrca063
            NEXT FIELD l_xrca063
            #END add-point
 
 
         #Ctrlp:input.c.l_site
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_site
            #add-point:ON ACTION controlp INFIELD l_site name="input.c.l_site"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_site            #給予default值
            LET g_qryparam.default2 = g_master.l_book
            SELECT ooef019 INTO g_ooef019 FROM ooef_t
             WHERE ooefent = g_enterprise
               AND ooef001 = g_master.l_site
               
            SELECT ooef017 INTO l_comp FROM ooef_t
             WHERE ooefent = g_enterprise
               AND ooef001 = g_master.l_site
              
            IF g_isai.isai002 = '1' THEN
               LET l_prog = 'aisi055'
            ELSE
               LET l_prog = 'aisi050'
            END IF
            LET g_qryparam.where = #"   isaesite IN ('",g_master.l_site,"','",l_comp,"' ) ",   #albireo 150803 mark
                                   " isaesite IN ",g_wc_xrcasite," ",   #albireo 150803 add
                                   "   AND isae002 <= '",g_master.l_docdt,"'",
                                   "   AND isae003 >= '",g_master.l_docdt,"'",
                                   "   AND isac001 = '",g_ooef019,"'"  #, albireo 160601 mark
                                   #"   AND isae019 = '",l_prog,"' "   #albireo 160601 mark
                                   #"   AND isae012 IS NOT NULL "   #SD建議可選到跟發票簿看到的相同但在欄位控卡提示錯誤
                                                                    #因此可選到發票號碼已經用完的發票簿號
                                   
            #IF g_xmdk.xmdk000 = '6' AND g_isai.isai006 = 'Y' THEN   #151123-00013#7
            #IF (g_xmdk.xmdk000 = '6' OR g_xmdk.xmdk000 = '5') AND g_isai.isai006 = 'Y' THEN   #151123-00013#7
            IF g_xmdk.xmdk000 = '6' AND g_isai.isai006 = 'Y' THEN    #151207-00018#2
            ELSE
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      "   AND isae004  = '",g_master.l_xmdk015,"'"
            END IF
                                   
            CALL q_isaesite_3()                                        #呼叫開窗
            LET g_master.l_site  = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_master.l_book  = g_qryparam.return2
            DISPLAY BY NAME g_master.l_site,g_master.l_book             #顯示到畫面上
            NEXT FIELD l_site
            #END add-point
 
 
         #Ctrlp:input.c.l_book
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_book
            #add-point:ON ACTION controlp INFIELD l_book name="input.c.l_book"
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_master.l_site            #給予default值
            LET g_qryparam.default2 = g_master.l_book
            SELECT ooef019 INTO g_ooef019 FROM ooef_t
             WHERE ooefent = g_enterprise
               AND ooef001 = g_master.l_site
               
            SELECT ooef017 INTO l_comp FROM ooef_t
             WHERE ooefent = g_enterprise
               AND ooef001 = g_master.l_site
            IF g_isai.isai002 = '1' THEN
               LET l_prog = 'aisi055'
            ELSE
               LET l_prog = 'aisi050'
            END IF
            LET g_qryparam.where = #"   isaesite IN ('",g_master.l_site,"','",l_comp,"' ) ",   #albireo 150803 mark
                                   " isaesite IN ",g_wc_xrcasite," ",   #albireo 150803 add
                                   "   AND isae002 <= '",g_master.l_docdt,"'",
                                   "   AND isae003 >= '",g_master.l_docdt,"'",
                                   "   AND isac001 = '",g_ooef019,"'"   #,   albireo 160601 mark
                                   #"   AND isae019 = '",l_prog,"' "    #albireo 160601 mark
                                   #"   AND isae012 IS NOT NULL "   #SD建議可選到跟發票簿看到的相同但在欄位控卡提示錯誤
                                                                    #因此可選到發票號碼已經用完的發票簿號
                                   
            #IF g_xmdk.xmdk000 = '6' AND g_isai.isai006 = 'Y' THEN     #151123-00013#7
            #IF (g_xmdk.xmdk000 = '6' OR g_xmdk.xmdk000 = '5') AND g_isai.isai006 = 'Y' THEN    #151123-00013#7 
            IF g_xmdk.xmdk000 = '6' AND g_isai.isai006 = 'Y' THEN     #151207-00018#2
            ELSE
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      "   AND isae004  = '",g_master.l_xmdk015,"'"
            END IF

            CALL q_isaesite_3()                                        #呼叫開窗
            LET g_master.l_site  = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_master.l_book  = g_qryparam.return2
            DISPLAY BY NAME g_master.l_site,g_master.l_book             #顯示到畫面上
            NEXT FIELD l_book
            #END add-point
 
 
         #Ctrlp:input.c.l_dat_memo
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_dat_memo
            #add-point:ON ACTION controlp INFIELD l_dat_memo name="input.c.l_dat_memo"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_isaf010
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isaf010
            #add-point:ON ACTION controlp INFIELD l_isaf010 name="input.c.l_isaf010"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_limit_memo
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_limit_memo
            #add-point:ON ACTION controlp INFIELD l_limit_memo name="input.c.l_limit_memo"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_isae007
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isae007
            #add-point:ON ACTION controlp INFIELD l_isae007 name="input.c.l_isae007"
            
            #END add-point
 
 
         #Ctrlp:input.c.l_isaf011
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD l_isaf011
            #add-point:ON ACTION controlp INFIELD l_isaf011 name="input.c.l_isaf011"
            
            #END add-point
 
 
 
               
            AFTER INPUT
               #add-point:資料輸入後 name="input.m.after_input"
               
               #end add-point
               
            #add-point:其他管控(on row change, etc...) name="input.other"
            
            #end add-point
         END INPUT
 
 
 
         
         #應用 a58 樣板自動產生(Version:3)
         CONSTRUCT BY NAME g_master.wc ON xmdkdocno,xmdk007,xmdk009,xmdkdocdt,xmdk004,xmdk003
            BEFORE CONSTRUCT
               #add-point:cs段before_construct name="cs.head.before_construct"
               
               #end add-point 
         
            #公用欄位開窗相關處理
            
               
            #一般欄位開窗相關處理    
                     #Ctrlp:construct.c.xmdkdocno
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdkdocno
            #add-point:ON ACTION controlp INFIELD xmdkdocno name="construct.c.xmdkdocno"
            #來源單號-開窗c段
            #151231-00010#3-----s
            CALL s_control_get_customer_sql('2',g_master.l_xrcacomp,g_user,g_dept,'') RETURNING g_sub_success,l_ctl_where
            #151231-00010#3-----e
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = #"xmdkstus = 'S' ",
                                   " 1=1 ",   #151123-00013#7
                                   " AND xmdksite IN ",g_wc_xrcasite,
                                   " AND xmdksite IN(SELECT ooef001 FROM ooef_t WHERE ooefent = ",g_enterprise,
                                                     " AND ooef017 = '",g_master.l_xrcacomp,"')",
                                   " AND xmdk001 <= '",g_master.l_docdt,"'",
                                   " AND xmdl087 = 'Y'",
                                   " AND (xmdl022 - xmdl047) > 0",
                                   " AND xmdk015 = '",g_master.l_xmdk015,"'",  #發票類型 #160707-00023#1
                                   " AND xmdk042 = '",g_master.l_xmdk042,"'",  #內外銷   #160707-00023#1
                                   #151231-00010#3-----s 
                                   " AND EXISTS (SELECT 1 FROM pmaa_t,pmab_t ",
                                                " WHERE pmab001 = pmaa001 AND pmabent = pmaaent ",
                                                "   AND pmaaent = ",g_enterprise," AND ",l_ctl_where,
                                                "   AND pmabsite = '",g_master.l_xrcacomp,"'",
                                                "   AND pmaaent = xmdkent",
                                                "   AND pmaa001 = xmdk007 )"                                   #151231-00010#3-----e
            #160707-00023#1 mark ------
            #IF g_master.l_toaxrtype = '1' THEN
            #   #藍字發票
            #   LET g_qryparam.where = g_qryparam.where CLIPPED,
            #                          #" AND xmdk000 <> '6' "
            #                          " AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1') OR (xmdk000 = '4' AND xmdkstus = 'Y' and xmdk002  ='3'))"   #151123-00013#7
            #   
            #ELSE
            #   #紅字發票
            #   LET g_qryparam.where = g_qryparam.where CLIPPED,
            #                          #" AND xmdk000 = '6' ",
            #                          #" AND ((xmdk006 = '6' AND xmdkstus = 'S' AND xmdk002  ='1') OR (xmdk005 = '5' AND xmdkstus = 'Y' AND xmdk002  ='3')) "   #151123-00013#7
            #                          " AND (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5' ) "   #151207-00018#2
            #END IF
            #160707-00023#1 mark end---
            #160707-00023#1 add ------
            CASE
               WHEN g_master.l_toaxrtype = '1' AND g_master.l_group_type MATCHES '[23]'
                  LET g_qryparam.where = g_qryparam.where CLIPPED,
                                         " AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1')",
                                         "      OR (xmdk000 = '4' AND xmdkstus = 'Y' and xmdk002  ='3')",
                                         "      OR (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5'))"
               WHEN g_master.l_toaxrtype = '1' AND g_master.l_group_type = '0'
                  #藍字發票
               LET g_qryparam.where = g_qryparam.where CLIPPED,
                                      " AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1') OR (xmdk000 = '4' AND xmdkstus = 'Y' and xmdk002  ='3'))"
               WHEN g_master.l_toaxrtype = '2'
                  #紅字發票
                  LET g_qryparam.where = g_qryparam.where CLIPPED,
                                         " AND (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5')" 
            END CASE
            #160707-00023#1 add end---
            LET g_qryparam.arg1 = '1'
            CALL q_xmdkdocno_16()
            DISPLAY g_qryparam.return1 TO xmdkdocno
            NEXT FIELD xmdkdocno
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdkdocno
            #add-point:BEFORE FIELD xmdkdocno name="construct.b.xmdkdocno"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdkdocno
            
            #add-point:AFTER FIELD xmdkdocno name="construct.a.xmdkdocno"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.xmdk007
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdk007
            #add-point:ON ACTION controlp INFIELD xmdk007 name="construct.c.xmdk007"
            #160707-00023#1 -s
            #客戶編號
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            IF NOT cl_null(g_sql_ctrl) AND NOT g_sql_ctrl = ' 1=1'  THEN
               LET g_qryparam.where = g_sql_ctrl
            END IF
            IF cl_null(g_qryparam.where) THEN
               LET g_qryparam.where =" (pmaa002 ='2' OR pmaa002='3')"
            ELSE
               LET g_qryparam.where =" (pmaa002 ='2' OR pmaa002='3') AND ",g_qryparam.where
            END IF
            CALL q_pmaa001()
            DISPLAY g_qryparam.return1 TO xmdk007
            NEXT FIELD xmdk007
            #160707-00023#1 -e
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdk007
            #add-point:BEFORE FIELD xmdk007 name="construct.b.xmdk007"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdk007
            
            #add-point:AFTER FIELD xmdk007 name="construct.a.xmdk007"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.xmdk009
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdk009
            #add-point:ON ACTION controlp INFIELD xmdk009 name="construct.c.xmdk009"
            #160707-00023#1 -s
            #收貨客戶
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            IF NOT cl_null(g_sql_ctrl) AND NOT g_sql_ctrl = ' 1=1'  THEN
               LET g_qryparam.where = g_sql_ctrl
            END IF
            IF cl_null(g_qryparam.where) THEN
               LET g_qryparam.where =" (pmaa002 ='2' OR pmaa002='3')"
            ELSE
               LET g_qryparam.where =" (pmaa002 ='2' OR pmaa002='3') AND ",g_qryparam.where
            END IF
            CALL q_pmaa001()
            DISPLAY g_qryparam.return1 TO xmdk009
            NEXT FIELD xmdk009
            #160707-00023#1 -e
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdk009
            #add-point:BEFORE FIELD xmdk009 name="construct.b.xmdk009"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdk009
            
            #add-point:AFTER FIELD xmdk009 name="construct.a.xmdk009"
            
            #END add-point
            
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdkdocdt
            #add-point:BEFORE FIELD xmdkdocdt name="construct.b.xmdkdocdt"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdkdocdt
            
            #add-point:AFTER FIELD xmdkdocdt name="construct.a.xmdkdocdt"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.xmdkdocdt
#         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdkdocdt
            #add-point:ON ACTION controlp INFIELD xmdkdocdt name="construct.c.xmdkdocdt"
            
            #END add-point
 
 
         #Ctrlp:construct.c.xmdk004
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdk004
            #add-point:ON ACTION controlp INFIELD xmdk004 name="construct.c.xmdk004"
            #160707-00023#1 -s
            #業務部門
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " ooeg009 = '",g_master.l_xrcacomp,"'"
            CALL q_ooeg001()
            DISPLAY g_qryparam.return1 TO xmdk004
            NEXT FIELD xmdk004
            #160707-00023#1 -e
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdk004
            #add-point:BEFORE FIELD xmdk004 name="construct.b.xmdk004"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdk004
            
            #add-point:AFTER FIELD xmdk004 name="construct.a.xmdk004"
            
            #END add-point
            
 
 
         #Ctrlp:construct.c.xmdk003
         #應用 a03 樣板自動產生(Version:3)
         ON ACTION controlp INFIELD xmdk003
            #add-point:ON ACTION controlp INFIELD xmdk003 name="construct.c.xmdk003"
            #160707-00023#1 -s
            #業務人員
            #開窗c段
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " ooag004 ='",g_master.l_xrcasite,"'"
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO xmdk003
            NEXT FIELD xmdk003
            #160707-00023#1 -e
            #END add-point
 
 
         #應用 a01 樣板自動產生(Version:2)
         BEFORE FIELD xmdk003
            #add-point:BEFORE FIELD xmdk003 name="construct.b.xmdk003"
            
            #END add-point
 
 
         #應用 a02 樣板自動產生(Version:2)
         AFTER FIELD xmdk003
            
            #add-point:AFTER FIELD xmdk003 name="construct.a.xmdk003"
            
            #END add-point
            
 
 
 
            
            #add-point:其他管控 name="cs.other"
            
            #end add-point
            
         END CONSTRUCT
 
 
 
      
         #add-point:ui_dialog段construct
         
         #end add-point
         #add-point:ui_dialog段input
         
         #end add-point
         #add-point:ui_dialog段自定義display array
         
         #end add-point
 
         SUBDIALOG lib_cl_schedule.cl_schedule_setting
         SUBDIALOG lib_cl_schedule.cl_schedule_setting_exec_call
         SUBDIALOG lib_cl_schedule.cl_schedule_select_show_history
         SUBDIALOG lib_cl_schedule.cl_schedule_show_history
 
         BEFORE DIALOG
            LET l_dialog = ui.DIALOG.getCurrent()
            CALL aisp320_get_buffer(l_dialog)
            #add-point:ui_dialog段before dialog
            
            #end add-point
 
         ON ACTION batch_execute
            LET g_action_choice = "batch_execute"
            ACCEPT DIALOG
 
         #add-point:ui_dialog段before_qbeclear
         
         #end add-point
 
         ON ACTION qbeclear         
            CLEAR FORM
            INITIALIZE g_master.* TO NULL   #畫面變數清空
            INITIALIZE lc_param.* TO NULL   #傳遞參數變數清空
            #add-point:ui_dialog段qbeclear
            CALL aisp320_qbeclear()
            #end add-point
 
         ON ACTION history_fill
            CALL cl_schedule_history_fill()
 
         ON ACTION close
            LET INT_FLAG = TRUE
            EXIT DIALOG
         
         ON ACTION exit
            LET INT_FLAG = TRUE
            EXIT DIALOG
 
         #add-point:ui_dialog段action
         
         #end add-point
 
         #主選單用ACTION
         &include "main_menu_exit_dialog.4gl"
         &include "relating_action.4gl"
         #交談指令共用ACTION
         &include "common_action.4gl"
            CONTINUE DIALOG
      END DIALOG
 
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM   
         INITIALIZE g_master.* TO NULL
         LET g_wc  = ' 1=2'
         LET g_action_choice = ""
         CALL aisp320_init()
         CONTINUE WHILE
      END IF
 
      #檢查批次設定是否有錯(或未設定完成)
      IF NOT cl_schedule_exec_check() THEN
         CONTINUE WHILE
      END IF
      
      LET lc_param.wc = g_master.wc    #把畫面上的wc傳遞到參數變數
      #請在下方的add-point內進行把畫面的輸入資料(g_master)轉換到傳遞參數變數(lc_param)的動作
      #add-point:ui_dialog段exit dialog
      #150624-00005#4-----s
      #LET lc_param.l_xmdkdocno   = g_master.l_xmdkdocno
      LET lc_param.l_xmdk015     = g_master.l_xmdk015
      #LET lc_param.l_xmdk017     = g_master.l_xmdk017
      LET lc_param.l_slip1       = g_master.l_slip1
      LET lc_param.l_docdt       = g_master.l_docdt
      LET lc_param.l_toaistype   = g_master.l_toaistype
      LET lc_param.l_site        = g_master.l_site
      LET lc_param.l_book        = g_master.l_book
      LET lc_param.l_dat_memo    = g_master.l_dat_memo
      LET lc_param.l_isaf010     = g_master.l_isaf010
      LET lc_param.l_limit_memo  = g_master.l_limit_memo
      LET lc_param.l_isaf011     = g_master.l_isaf011
      LET lc_param.l_xrcald      = g_master.l_xrcald
      LET lc_param.l_slip2       = g_master.l_slip2
      LET lc_param.l_slip3       = g_master.l_slip3       #160707-00023#1
      LET lc_param.l_xrca063     = g_master.l_xrca063
      LET lc_param.l_xrcasite    = g_master.l_xrcasite
      LET lc_param.l_xrcacomp    = g_master.l_xrcacomp
      LET lc_param.l_curr_type   = g_master.l_curr_type
      LET lc_param.l_toaxrtype   = g_master.l_toaxrtype
      LET lc_param.l_xrca007     = g_master.l_xrca007     #albireo 150826 add
      #160707-00023#1 add ------
      LET lc_param.l_xmdk042     = g_master.l_xmdk042
      LET lc_param.l_group_type  = g_master.l_group_type
      LET lc_param.l_chk1        = g_master.l_chk1
      LET lc_param.l_chk2        = g_master.l_chk2
      #160707-00023#1 add end---
      #150624-00005#4-----e
      CALL util.JSON.parse(g_argv[1],l_tran)
      IF NOT cl_null(l_tran.wc)THEN
         
         LET lc_param.wc = lc_param.wc CLIPPED," AND ",l_tran.wc CLIPPED
         
      END IF
      #end add-point
 
      LET ls_js = util.JSON.stringify(lc_param)  #r類使用g_master/p類使用lc_param
 
      IF INT_FLAG THEN
         LET INT_FLAG = FALSE
         EXIT WHILE
      ELSE
         IF g_chk_jobid THEN 
            LET g_jobid = g_schedule.gzpa001
         ELSE 
            LET g_jobid = cl_schedule_get_jobid(g_prog)
         END IF 
 
         #依照指定模式執行報表列印
         CASE 
            WHEN g_schedule.gzpa003 = "0"
                 CALL aisp320_process(ls_js)
 
            WHEN g_schedule.gzpa003 = "1"
                 LET ls_js = aisp320_transfer_argv(ls_js)
                 CALL cl_cmdrun(ls_js)
 
            WHEN g_schedule.gzpa003 = "2"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
 
            WHEN g_schedule.gzpa003 = "3"
                 CALL cl_schedule_update_data(g_jobid,ls_js)
         END CASE  
 
         IF g_schedule.gzpa003 = "2" OR g_schedule.gzpa003 = "3" THEN 
            CALL cl_ask_confirm3("std-00014","") #設定完成
         END IF    
         LET g_schedule.gzpa003 = "0" #預設一開始 立即於前景執行
 
         #add-point:ui_dialog段after schedule
         
         #end add-point
 
         #欄位初始資訊 
         CALL cl_schedule_init_info("all",g_schedule.gzpa003) 
         LET gi_hiden_asign = FALSE 
         LET gi_hiden_exec = FALSE 
         LET gi_hiden_spec = FALSE 
         LET gi_hiden_exec_end = FALSE 
         CALL cl_schedule_hidden()
      END IF
   END WHILE
 
END FUNCTION
 
{</section>}
 
{<section id="aisp320.transfer_argv" >}
#+ 轉換本地參數至cmdrun參數內,準備進入背景執行
PRIVATE FUNCTION aisp320_transfer_argv(ls_js)
 
   #add-point:transfer_agrv段define (客製用)
   
   #end add-point
   DEFINE ls_js       STRING
   DEFINE la_cmdrun   RECORD
             prog       STRING,
             actionid   STRING,
             background LIKE type_t.chr1,
             param      DYNAMIC ARRAY OF STRING
                  END RECORD
   DEFINE la_param    type_parameter
   #add-point:transfer_agrv段define 
   
   #end add-point
 
   LET la_cmdrun.prog = g_prog
   LET la_cmdrun.background = "Y"
   LET la_cmdrun.param[1] = ls_js
 
   #add-point:transfer.argv段程式內容
   
   #end add-point
 
   RETURN util.JSON.stringify( la_cmdrun )
END FUNCTION
 
{</section>}
 
{<section id="aisp320.process" >}
#+ 資料處理   (r類使用g_master為主處理/p類使用l_param為主)
PRIVATE FUNCTION aisp320_process(ls_js)
 
   #add-point:process段define (客製用)
   
   #end add-point
   DEFINE ls_js         STRING
   DEFINE lc_param      type_parameter
   DEFINE li_stus       LIKE type_t.num5
   DEFINE li_count      LIKE type_t.num10  #progressbar計量
   DEFINE ls_sql        STRING             #主SQL
   DEFINE li_p01_status LIKE type_t.num5
   #add-point:process段define 
DEFINE l_isaf        RECORD LIKE isaf_t.*      #對帳單頭
DEFINE l_xmdk        RECORD LIKE xmdk_t.*      #
DEFINE r_success     LIKE type_t.num5
DEFINE l_wc          STRING
DEFINE l_array       DYNAMIC ARRAY OF RECORD
          chr           LIKE type_t.chr1000,
          dat           LIKE type_t.dat
                     END RECORD
DEFINE l_pmaa003     LIKE pmaa_t.pmaa003   #150730-00006#1 add
#DEFINE l_isaf011 LIKE isaf_t.isaf011      #albireo 150813
#cmdrun axrp132-----s
DEFINE la_param      RECORD
          prog          STRING,
          actionid      STRING,
          background    LIKE type_t.chr1,
          param         DYNAMIC ARRAY OF STRING
                     END RECORD
DEFINE tran_master   RECORD
          xrcasite      LIKE xrca_t.xrcasite,
          xrcasite_desc LIKE type_t.chr80,
          xrcald        LIKE xrca_t.xrcald,
          xrcald_desc   LIKE type_t.chr80,
          b_style       LIKE type_t.chr500,
          l_isaf001     LIKE type_t.chr500,     #160426-00013#3
          xrcadocno     LIKE xrca_t.xrcadocno,
          xrca007       LIKE xrca_t.xrca007,
          xrcadocdt     LIKE xrca_t.xrcadocdt,
          b_check1      LIKE type_t.chr500,
          b_check4      LIKE type_t.chr500,
          b_check2      LIKE type_t.chr500,
          b_check5      LIKE type_t.chr500,
          b_check3      LIKE type_t.chr500,
          b_check6      LIKE type_t.chr500,
          b_comb1       LIKE type_t.chr500,
          b_comb2       LIKE type_t.chr500,
          isafdocno     LIKE isaf_t.isafdocno,
          fflabel_desc  LIKE type_t.chr80,
          isaf002       LIKE isaf_t.isaf002,
          isaf010       LIKE isaf_t.isaf010,
          isaf003       LIKE isaf_t.isaf003,
          isaf011       LIKE isaf_t.isaf011,
          isaf055       LIKE isaf_t.isaf055,
          isaf014       LIKE isaf_t.isaf014,
          isaf004       LIKE isaf_t.isaf004,
          isaf016       LIKE isaf_t.isaf016,
          isaf057       LIKE isaf_t.isaf057,
          stagenow      LIKE type_t.chr80,
          wc            STRING
                     END RECORD
DEFINE l_tran        STRING
DEFINE ls_js2        STRING
DEFINE l_comp        LIKE ooef_t.ooef001 #150624-00005#4
#cmdrun axrp132-----e
DEFINE l_sql         STRING
DEFINE l_xmdkdocno   LIKE xmdk_t.xmdkdocno
DEFINE l_strno       LIKE type_t.chr80
DEFINE l_endno       LIKE type_t.chr80
DEFINE l_strno1      LIKE isaf_t.isafdocno
DEFINE l_endno1      LIKE isaf_t.isafdocno
DEFINE l_strno2      LIKE xrca_t.xrcadocno
DEFINE l_endno2      LIKE xrca_t.xrcadocno
DEFINE l_doais       LIKE type_t.num5
DEFINE l_doaxr       LIKE type_t.num5
DEFINE l_xrca063     LIKE xrca_t.xrca063
DEFINE l_isae007     LIKE isae_t.isae007
DEFINE l_isaf011     LIKE isaf_t.isaf011   #發票號碼
##150918-00001#7-----s
DEFINE l_isatsum     LIKE type_t.num20_6
DEFINE l_isafsum     LIKE type_t.num20_6
DEFINE l_count       LIKE type_t.num10
#150918-00001#7------e
#151022-00017#2--s
DEFINE l_sfin2009    LIKE type_t.chr1
DEFINE lc_param_rate RECORD
          type          LIKE type_t.chr1,       #類型
          apca004       LIKE apca_t.apca004,    #交易對象
          sfin2009      LIKE type_t.chr1        #匯率類型
                     END RECORD
DEFINE l_desc        LIKE type_t.chr10
#151022-00017#2--e
#151231-00010#3-----s
DEFINE l_ctl_where   STRING
#151231-00010#3-----e
#albireo 160606-----s
DEFINE l_isat004     LIKE isat_t.isat004
DEFINE l_isatcnt     LIKE type_t.num10
#albireo 160606-----e
#160707-00023#1 add ------
DEFINE l_field1      STRING
DEFINE l_field2      STRING
DEFINE l_field3      STRING
DEFINE l_xmdk007     LIKE xmdk_t.xmdk007
DEFINE l_xmdk009     LIKE xmdk_t.xmdk009
DEFINE l_xmdk010     LIKE xmdk_t.xmdk010
DEFINE l_xmdk012     LIKE xmdk_t.xmdk012
DEFINE l_xmdk016     LIKE xmdk_t.xmdk016
DEFINE l_xmdksite    LIKE xmdk_t.xmdksite
DEFINE l_type        LIKE type_t.chr5
DEFINE l_group       LIKE type_t.chr500
DEFINE l_oodbl004    LIKE oodbl_t.oodbl004  #稅率說明
DEFINE l_oodb011     LIKE oodb_t.oodb011    #稅別應用
#160707-00023#1 add ------
   #end add-point
 
  #INITIALIZE lc_param TO NULL           #p類不可以清空
   CALL util.JSON.parse(ls_js,lc_param)  #r類作業被t類呼叫時使用, p類主要解開參數處
   LET li_p01_status = 1
 
  #IF lc_param.wc IS NOT NULL THEN
  #   LET g_bgjob = "T"       #特殊情況,此為t類作業鬆耦合串入報表主程式使用
  #END IF
 
   #add-point:process段前處理
   #JSON解開的變數內容給到g_master中
   #150624-00005#4-----s
   ##將傳遞參數變數傳回給畫面上的變數
   #IF g_bgjob = "Y" OR g_bgjob = "T" THEN
   #   LET g_master.wc            = lc_param.wc
   #   #LET g_master.l_xmdkdocno  = lc_param.l_xmdkdocno
   #   LET g_master.l_xmdk015     = lc_param.l_xmdk015
   #   #LET g_master.l_xmdk017    = lc_param.l_xmdk017
   #   LET g_master.l_slip1       = lc_param.l_slip1
   #   LET g_master.l_docdt       = lc_param.l_docdt
   #   LET g_master.l_toaistype   = lc_param.l_toaistype
   #   LET g_master.l_site        = lc_param.l_site
   #   LET g_master.l_book        = lc_param.l_book
   #   LET g_master.l_dat_memo    = lc_param.l_dat_memo
   #   LET g_master.l_isaf010     = lc_param.l_isaf010
   #   LET g_master.l_limit_memo  = lc_param.l_limit_memo
   #   LET g_master.l_isaf011     = lc_param.l_isaf011
   #   LET g_master.l_xrcald      = lc_param.l_xrcald
   #   LET g_master.l_slip2       = lc_param.l_slip2
   #   LET g_master.l_xrca063     = lc_param.l_xrca063
   #END IF
   #150624-00005#4-----e
   #end add-point
 
   #預先計算progressbar迴圈次數
   IF g_bgjob <> "Y" THEN
      #add-point:process段count_progress
      
      #end add-point
   END IF
 
   #主SQL及相關FOREACH前置處理
#  DECLARE aisp320_process_cs CURSOR FROM ls_sql
#  FOREACH aisp320_process_cs INTO
   #add-point:process段process
   #帳務中心預設的範圍等值
   CALL s_fin_orga_get_comp_ld(lc_param.l_xrcasite) RETURNING g_sub_success,g_errno,lc_param.l_xrcacomp,lc_param.l_xrcald
   SELECT ooef019 INTO g_ooef019 FROM ooef_t
    WHERE ooefent =g_enterprise
      AND ooef001 = lc_param.l_xrcacomp
   CALL s_fin_account_center_sons_query('3',lc_param.l_xrcasite,g_today,'1')
   CALL s_fin_account_center_sons_str() RETURNING g_wc_xrcasite
   CALL s_fin_get_wc_str(g_wc_xrcasite) RETURNING g_wc_xrcasite
   CALL s_fin_account_center_ld_str() RETURNING g_wc_xrcald
   CALL s_fin_get_wc_str(g_wc_xrcald) RETURNING g_wc_xrcald
   CALL s_control_get_customer_sql('2',lc_param.l_xrcacomp,g_user,g_dept,'') RETURNING g_sub_success,l_ctl_where  #151231-00010#3

   #160707-00023#1 mark ------
   #LET l_sql = "SELECT DISTINCT xmdkdocno FROM xmdk_t,xmdl_t",
   #            " WHERE xmdkent = xmdlent AND xmdkdocno = xmdldocno",
   #            " AND xmdkent = ",g_enterprise,
   #           #" AND xmdkstus = 'S' ",     #151123-00013#7 mark
   #            " AND xmdk001 <= '",lc_param.l_docdt,"'",
   #            " AND ",lc_param.wc CLIPPED,
   #            " AND xmdksite IN ",g_wc_xrcasite,
   #            " AND xmdksite IN( SELECT ooef001 FROM ooef_t WHERE ooefent = ",g_enterprise,
   #            "                     AND ooef017 = '",lc_param.l_xrcacomp,"')",
   #            " AND xmdl087 = 'Y' ",
   #            " AND (xmdl022-xmdl047) > 0",
   #            #151231-00010#3-----s
   #            " AND EXISTS (SELECT 1 FROM pmaa_t,pmab_t",
   #            "              WHERE pmab001 = pmaa001 AND pmabent = pmaaent",
   #            "                AND pmaaent = ",g_enterprise," AND ",l_ctl_where,
   #            "                AND pmabsite = '",lc_param.l_xrcacomp,"'",
   #            "                AND pmaaent = xmdkent",
   #            "                AND pmaa001 = xmdk007)"
   #            #151231-00010#3-----e
   #           #" AND (xmdl022 - xmdl038 - xmdl053) > 0 "   #150730 albireo mark  SA認為這部分應讓axrp132去判斷就行了
   #160707-00023#1 mark end---
   
   #160707-00023#1 add ------
   #彙總group by條件組合處：
   #1.依照彙總條件
   CASE
      WHEN lc_param.l_group_type = '0'  #0:出貨單
         LET l_field1 = ",xmdkdocno"
      WHEN lc_param.l_group_type = '2'  #2:業務人員
         LET l_field1 = ",xmdk003"
      WHEN lc_param.l_group_type = '3'  #3:業務部門
         LET l_field1 = ",xmdk004"
   END CASE
   #2.是否依來源營運據點拆單
   IF lc_param.l_chk1 = "Y" THEN
      LET l_field2 = ",xmdksite"
   ELSE
      LET l_field2 = ",''"
   END IF
   #3.匯率選擇是1:依原單匯率
   IF lc_param.l_curr_type = '1' THEN
      LET l_field3 = ",xmdk017"
   ELSE
      LET l_field3 = ",''"
   END IF
   
   LET l_sql = "SELECT '1',xmdk007,xmdk008,xmdk009,xmdk010,",
               "       xmdk012,xmdk016,xmdk047,",    #160802-00007#1 Add xmdk047
               "       SUM(xmdk051),SUM(xmdk052),SUM(xmdk053)",
               l_field1,l_field2,l_field3,
               " FROM xmdk_t,xmdl_t",
               " WHERE xmdkent = xmdlent AND xmdkdocno = xmdldocno",
               " AND xmdkent = ",g_enterprise,
               " AND xmdk001 <= '",lc_param.l_docdt,"'",
               " AND xmdksite IN ",g_wc_xrcasite,
               " AND xmdksite IN( SELECT ooef001 FROM ooef_t WHERE ooefent = ",g_enterprise,
               "                     AND ooef017 = '",lc_param.l_xrcacomp,"')",
               " AND xmdl087 = 'Y' ",
               " AND (xmdl022-xmdl047) > 0",
               " AND xmdk042 = '",lc_param.l_xmdk042,"'",  #內外銷
               " AND (xmdk084 <> '2'  OR xmdk084 IS NULL)",
               " AND EXISTS (SELECT 1 FROM pmaa_t,pmab_t",
               "              WHERE pmab001 = pmaa001 AND pmabent = pmaaent",
               "                AND pmaaent = ",g_enterprise," AND ",l_ctl_where,
               "                AND pmabsite = '",lc_param.l_xrcacomp,"'",
               "                AND pmaaent = xmdkent",
               "                AND pmaa001 = xmdk007)",
               " AND ",lc_param.wc CLIPPED
   #160707-00023#1 add end---
   
   #IF lc_param.l_toaxrtype = '1' THEN
   #   LET l_sql = l_sql CLIPPED," AND xmdk000 <> '6' "
   #ELSE
   #   LET l_sql = l_sql CLIPPED," AND xmdk000 = '6' "
   #END IF
   #160707-00023#1 mark ------
   ##151123-00013#7-----s
   #IF g_master.l_toaxrtype = '1' THEN
   #   #藍字發票
   #   LET l_sql = l_sql CLIPPED," AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1')  OR  (xmdk000 = '4' AND xmdkstus = 'Y' AND xmdk002  ='3'))"   #151123-00013#7
   #ELSE
   #   #紅字發票
   #   LET l_sql = l_sql CLIPPED,#" AND ((xmdk006 = '6' AND xmdkstus = 'S' AND xmdk002  ='1') OR (xmdk005 = '5' AND xmdkstus = 'Y' AND xmdk002  ='3')) "   #151123-00013#7
   #                              " AND (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5' ) "   #151207-00018#2
   #END IF
   ##151123-00013#7-----e
   #160707-00023#1 mark end---
   #160707-00023#1 add ------
   CASE
      WHEN lc_param.l_toaxrtype = '1' AND lc_param.l_group_type MATCHES '[23]'
         LET l_sql = l_sql CLIPPED," AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1')",
                                   "      OR (xmdk000 = '4' AND xmdkstus = 'Y' and xmdk002  ='3')",
                                   "      OR (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5'))"
      WHEN lc_param.l_toaxrtype = '1' AND lc_param.l_group_type = '0'
         #藍字發票
         LET l_sql = l_sql CLIPPED," AND ((xmdk000 IN ('1','2','3') AND xmdkstus = 'S' AND xmdk002  ='1') ",
                                   "      OR (xmdk000 = '4' AND xmdkstus = 'Y' and xmdk002  ='3'))"
      WHEN lc_param.l_toaxrtype = '2'
         #紅字發票
         LET l_sql = l_sql CLIPPED," AND (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5')" 
   END CASE
   LET l_sql = l_sql CLIPPED," GROUP BY xmdk007,xmdk008,xmdk009,xmdk010,xmdk012,",
                             "          xmdk016,xmdk047",    #160802-00007#1 Add xmdk047
                             l_field1,l_field2,l_field3,
                             #當銷退單折讓單開立方式(xmdk084)為2:須開立發票扣抵證明單時，獨立產生資料
                             " UNION ",
                             "SELECT '2',xmdk007,xmdk008,xmdk009,xmdk010,",
                             "       xmdk012,xmdk016,xmdk047,",    #160802-00007#1 Add xmdk047
                             "       SUM(xmdk051),SUM(xmdk052),SUM(xmdk053),xmdkdocno",
                             l_field2,l_field3,
                             " FROM xmdk_t,xmdl_t",
                             " WHERE xmdkent = xmdlent AND xmdkdocno = xmdldocno",
                             " AND xmdkent = ",g_enterprise,
                             " AND xmdk001 <= '",lc_param.l_docdt,"'",
                             " AND xmdksite IN ",g_wc_xrcasite,
                             " AND xmdksite IN( SELECT ooef001 FROM ooef_t WHERE ooefent = ",g_enterprise,
                             "                     AND ooef017 = '",lc_param.l_xrcacomp,"')",
                             " AND xmdl087 = 'Y' ",
                             " AND (xmdl022-xmdl047) > 0",
                             " AND xmdk042 = '",lc_param.l_xmdk042,"'",  #內外銷
                             " AND xmdk084 = '2'",
                             " AND EXISTS (SELECT 1 FROM pmaa_t,pmab_t",
                             "              WHERE pmab001 = pmaa001 AND pmabent = pmaaent",
                             "                AND pmaaent = ",g_enterprise," AND ",l_ctl_where,
                             "                AND pmabsite = '",lc_param.l_xrcacomp,"'",
                             "                AND pmaaent = xmdkent",
                             "                AND pmaa001 = xmdk007)",
                             " AND ",lc_param.wc CLIPPED,
                             " AND (xmdk000 = '6' AND xmdkstus = 'S' AND xmdk082 <> '5')",
                             " GROUP BY xmdk007,xmdk008,xmdk009,xmdk010,xmdk012,xmdk047,",    #160802-00007#1 Add xmdk047
                             "          xmdk016,xmdkdocno",
                             l_field2,l_field3
   #160707-00023#1 add end---
   PREPARE aisp320_mainp1 FROM l_sql
   DECLARE aisp320_mainc1 CURSOR WITH HOLD FOR aisp320_mainp1
   
   LET l_strno1 = NULL   LET l_endno1 = NULL
   LET l_strno2 = NULL   LET l_endno2 = NULL
   LET l_doaxr = 0       LET l_doais = 0
   
   #整帳批序號
   IF NOT cl_null(lc_param.l_xrca063)THEN
      CALL s_transaction_begin()
      CALL s_aooi390_get_auto_no('14',lc_param.l_xrca063) RETURNING g_sub_success,l_xrca063
      CALL s_aooi390_oofi_upd('14',l_xrca063) RETURNING g_sub_success
      CALL s_transaction_end('Y','0')
   END IF
   
   CALL cl_err_collect_init()
   #FOREACH aisp320_mainc1 INTO l_xmdkdocno  #160707-00023#1 mark
   #160707-00023#1 add ------
   FOREACH aisp320_mainc1 INTO l_type,l_xmdk.xmdk007,l_xmdk.xmdk008,l_xmdk.xmdk009,l_xmdk.xmdk010,
                               l_xmdk.xmdk012,l_xmdk.xmdk016,l_xmdk.xmdk047,l_xmdk.xmdk051,l_xmdk.xmdk052,l_xmdk.xmdk053,   #160802-00007#1 Add xmdk047
                               l_group,l_xmdksite,l_xmdk.xmdk017
   #160707-00023#1 add end---
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = SQLCA.SQLCODE
         LET g_errparam.extend = 'FOREACH:aisp320_mainc1'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      
      LET r_success = TRUE
      
      #160707-00023#1 mark ------
      #INITIALIZE l_xmdk.* TO NULL
      #SELECT * INTO l_xmdk.* FROM xmdk_t
      # WHERE xmdkent = g_enterprise
      #   AND xmdkdocno = l_xmdkdocno    #alberr
      #160707-00023#1 mark end---
      
      #160707-00023#1 add ------
      INITIALIZE l_isaf.* TO NULL
      #依照彙總條件先給值
      CASE
         WHEN lc_param.l_group_type = '0' OR l_type = '2' #0:出貨單/銷退單(2:須開立發票扣抵證明單)
            LET l_xmdkdocno = l_group
            INITIALIZE l_xmdk.* TO NULL
            SELECT * INTO l_xmdk.* FROM xmdk_t
             WHERE xmdkent = g_enterprise
               AND xmdkdocno = l_xmdkdocno
            IF lc_param.l_xmdk042 = '1' THEN #1:內銷
               LET l_isaf.isafdocdt = l_xmdk.xmdk001
            ELSE
               LET l_isaf.isafdocdt = l_xmdk.xmdk032
               LET l_isaf.isaf014 = l_xmdk.xmdk032
            END IF
         WHEN lc_param.l_group_type = '2'  #2:業務人員
            LET l_xmdk.xmdk003 = l_group
            SELECT pmab109 INTO l_xmdk.xmdk004
              FROM pmab_t
             WHERE pmabent = g_enterprise
               AND pmabsite = lc_param.l_xrcasite
               AND pmab001 = l_xmdk.xmdk007
            IF cl_null(l_xmdk.xmdk004) THEN LET l_xmdk.xmdk004 = g_dept END IF
            LET l_xmdk.xmdk202 = l_xmdk.xmdk008 #發票客戶(比照aist310新增給法)
            LET l_isaf.isafdocdt = lc_param.l_docdt
            LET l_isaf.isaf014   = lc_param.l_docdt
         WHEN lc_param.l_group_type = '3'  #3:業務部門
            SELECT pmab081 INTO l_xmdk.xmdk003
              FROM pmab_t
             WHERE pmabent = g_enterprise
               AND pmabsite = lc_param.l_xrcasite
               AND pmab001 = l_xmdk.xmdk007
            IF cl_null(l_xmdk.xmdk004) THEN LET l_xmdk.xmdk004 = g_user END IF
            LET l_xmdk.xmdk004 = l_group
            LET l_xmdk.xmdk202 = l_xmdk.xmdk008 #發票客戶(比照aist310新增給法)
            LET l_isaf.isafdocdt = lc_param.l_docdt
            LET l_isaf.isaf014   = lc_param.l_docdt
      END CASE
      #160707-00023#1 add end---
      
      CALL s_transaction_begin() 
      
      #INITIALIZE l_isaf.* TO NULL              #160707-00023#1 mark
      LET l_isaf.isafent = g_enterprise
      #LET l_isaf.isafsite = l_xmdk.xmdksite    #160707-00023#1 mark
      LET l_isaf.isafsite = lc_param.l_xrcasite #160707-00023#1
      CALL s_fin_orga_get_comp_ld(l_isaf.isafsite) RETURNING g_sub_success,g_errno,l_isaf.isafcomp,g_glaald
      
      LET g_ooef019 = NULL
      SELECT ooef019 INTO g_ooef019
        FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_isaf.isafcomp
      LET l_isaf.isafdocno = lc_param.l_slip1
     #LET l_isaf.isafdocdt = lc_param.l_docdt  #albireo 150810 modify  # g_today>lc_param.l_docdt #160707-00023#1 mark
      
      #auto asigh no
      #160707-00023#1 add ------
      IF l_type = '2' THEN #折讓
         #取aisi090設定的常用單別
         SELECT isao015 INTO l_isaf.isafdocno
           FROM isao_t
          WHERE isaoent = g_enterprise
            AND isaosite = lc_param.l_xrcasite
      END IF
      #160707-00023#1 add end---
      CALL s_aooi200_fin_gen_docno(g_glaald,'','',l_isaf.isafdocno,l_isaf.isafdocdt,'aist310')
         RETURNING g_sub_success,l_isaf.isafdocno
      IF NOT g_sub_success THEN
         LET r_success = FALSE
      END IF
      LET l_isaf.isaf002   = l_xmdk.xmdk202     #發票客戶
      LET l_isaf.isaf003   = l_xmdk.xmdk008     #帳款客戶
      LET l_isaf.isaf004   = l_xmdk.xmdk004     #業務組織
      LET l_isaf.isaf005   = g_user
      #開票人員串ooag003
      SELECT ooag003 INTO l_isaf.isaf006 FROM ooag_t
       WHERE ooagent = g_enterprise
         AND ooag001 = l_isaf.isaf005
      LET l_isaf.isaf008   = lc_param.l_xmdk015 #發票類型
      #LET l_isaf.isaf009   = #從發票簿抓 預設N
      #LET l_isaf.isaf010   = #發票代碼後面呼叫展算回寫
      #LET l_isaf.isaf011   = #發票號碼
      #LET l_isaf.isaf014   = lc_param.l_docdt  #160707-00023#1 mark
      LET l_isaf.isaf016   = l_xmdk.xmdk012     #稅別
      LET l_isaf.isaf017   = l_xmdk.xmdk014     #含稅否
      LET l_isaf.isaf018   = l_xmdk.xmdk013     #稅率
      #160707-00023#1 add ------
      IF cl_null(l_isaf.isaf017) OR cl_null(l_isaf.isaf018) THEN
         CALL s_tax_chk(lc_param.l_xrcasite,l_xmdk.xmdk012)
              RETURNING g_sub_success,l_oodbl004,l_isaf.isaf017,l_isaf.isaf018,l_oodb011
      END IF
      #160707-00023#1 add end---
      
      SELECT isak008,isak009,isak010,isak011,isak012
        INTO l_isaf.isaf022,l_isaf.isaf023,l_isaf.isaf024,l_isaf.isaf025,l_isaf.isaf026
        FROM isak_t
       WHERE isakent = g_enterprise
         AND isak001 = l_isaf.isaf002
         AND isak002 = g_ooef019
         AND isakstus = 'Y'
      
      #150730-00006#1-----s
      #稅務編號處理(isaf022)
      #國別為台灣的處理
      IF g_isai.isai008 = 'TW' THEN
         #isaf022 用pmaa003
         LET l_pmaa003 = NULL
         SELECT pmaa003 INTO l_pmaa003
           FROM pmaa_t
          WHERE pmaaent = g_enterprise
            AND pmaa001 = l_isaf.isaf002
            AND pmaastus = 'Y'
         LET l_isaf.isaf022 = l_pmaa003
      ELSE
         #isaf022 用isak008(aisi020)
      END IF
      #150730-00006#1-----e
      
      #lc_param.l_site得開票部門對外全稱 ooefl005
      SELECT ooefl004 INTO l_isaf.isaf027 FROM ooefl_t
       WHERE ooeflent = g_enterprise
         AND ooefl001 = l_isaf.isafcomp
         AND ooefl002 = g_dlang
      
      #151209-00019#2-----s
      #SELECT isao001,isao002,isao003,isao004,isao005
      #  INTO l_isaf.isaf028,l_isaf.isaf029,l_isaf.isaf030,l_isaf.isaf031,l_isaf.isaf032
      #  FROM isao_t
      # WHERE isaoent = g_enterprise
      #   AND isaosite = l_isaf.isafcomp
      #   AND isaostus = 'Y'
      SELECT isao002,isao003,isao004,isao005
        INTO l_isaf.isaf029,l_isaf.isaf030,l_isaf.isaf031,l_isaf.isaf032
        FROM isao_t
       WHERE isaoent = g_enterprise
         AND isaosite = l_isaf.isafcomp
         AND isaostus = 'Y'
      SELECT ooef002 INTO l_isaf.isaf028
        FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_isaf.isafcomp
      #151209-00019#2-----e
      LET l_isaf.isaf039 = g_today
      LET l_isaf.isaf040 = cl_get_time()
      LET l_isaf.isaf041 = g_user
      LET l_isaf.isaf044   = 0 
      SELECT ooef002 INTO l_isaf.isaf046 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = l_isaf.isafcomp
      LET l_isaf.isaf050   = 0
      LET l_isaf.isaf051   = lc_param.l_book
      LET l_isaf.isaf052   = lc_param.l_site
      #albireo 151021-----s
      #內銷銷退  外銷出貨銷退
      #不會啟用發票簿  所以site要抓原單site
      IF cl_null(l_isaf.isaf052)THEN
        #LET l_isaf.isaf052 = l_xmdk.xmdksite     #160707-00023#1 mark
         LET l_isaf.isaf052 = lc_param.l_xrcasite #160707-00023#1
      END IF
      #albireo 151021-----e
      
      #LET l_isaf.isaf053   #發票聯別  用發票類型串
      #LET l_isaf.isaf054   #課稅別    用發票類型串
      LET l_isaf.isaf055   = l_xmdk.xmdk008  #收款客戶
      
      #IF l_xmdk.xmdk000 = '6' THEN                          #151123-00013#7 mark
      #IF l_xmdk.xmdk000 = '6' OR l_xmdk.xmdk000 = '5' THEN  #151123-00013#7
      #IF l_xmdk.xmdk000 = '6' THEN         #151207-00018#2  #160707-00023#1 mark
      IF lc_param.l_toaxrtype = '2' OR l_type = '2' THEN    #160707-00023#1
         LET l_isaf.isaf056 = '2'  #出貨單1藍字發票 銷退單2紅字發票
         LET l_isaf.isaf001   = '4'
      ELSE
         LET l_isaf.isaf056 = '1'
         LET l_isaf.isaf001   = '1'
      END IF
      
      LET l_isaf.isaf057   = l_xmdk.xmdk003  #業務人員
      LET l_isaf.isaf058   = l_xmdk.xmdk010  #收款條件
      
      SELECT oodb008 INTO l_isaf.isaf054
        FROM oodb_t
       WHERE oodbent = g_enterprise
         AND oodb001 = g_ooef019
         AND oodb002 = l_isaf.isaf016
      #發票簿預設值
      LET l_isae007 = NULL
      SELECT isae005,isae008,isae012,isae007
        INTO l_isaf.isaf009,l_isaf.isaf010,l_isaf011,l_isae007
        FROM isae_t
       WHERE isaeent = g_enterprise
         AND isaecomp = l_isaf.isafcomp
         AND isaesite = l_isaf.isaf052
         AND isae001 = l_isaf.isaf051
         AND isae002 <= l_isaf.isaf014 AND isae003 >= l_isaf.isaf014
         AND isae004 = l_isaf.isaf008
      #albireo 160122-----s
      IF cl_null(lc_param.l_isaf011)THEN
         LET lc_param.l_isaf011 = l_isaf011
      END IF 
      
      #albireo 160606-----s
      LET l_isat004 = g_master.l_isae007 CLIPPED,lc_param.l_isaf011
      LET l_isatcnt = NULL
      SELECT COUNT(*) INTO l_isatcnt FROM isat_t
       WHERE isatent = g_enterprise
         AND isat004 = l_isat004
         AND isat025 = '11'
      IF cl_null(l_isatcnt)THEN LET l_isatcnt = 0 END IF
      IF l_isatcnt > 0 THEN
         LET lc_param.l_isaf011 = l_isaf011
      END IF
      #albireo 160606-----e
      
      LET l_isaf.isaf011 = lc_param.l_isaf011
      #albireo 160122-----e

      #媒申格式
      SELECT isac004,isac008 INTO l_isaf.isaf019,l_isaf.isaf053
        FROM isac_t
       WHERE isacent = g_enterprise
         AND isac001 = g_ooef019
         AND isac002 = l_isaf.isaf008
      
      #發票客戶帶出交易對象全名
      SELECT pmaal004 INTO l_isaf.isaf021
        FROM pmaal_t
       WHERE pmaalent = g_enterprise
         AND pmaal001 = l_isaf.isaf002
         AND pmaal002 = g_dlang
      
      #150904-00006#3-----s
      LET l_isaf.isaf066 = ''
      
      #IF l_xmdk.xmdk042 = '2' THEN    #160707-00023#1 mark
      IF lc_param.l_xmdk042 = '2' THEN #160707-00023#1
         #取出貨單對應invoice
         SELECT UNIQUE xmdodocno INTO l_isaf.isaf066 FROM xmdp_t ,xmdo_t
          WHERE xmdoent = g_enterprise
            AND xmdoent = xmdpent
            AND xmdodocno = xmdpdocno
            AND xmdp001   = l_xmdk.xmdkdocno
            AND xmdo004 ='2' #出貨單
            AND xmdostus = 'Y'
            
         IF cl_null(l_isaf.isaf066)THEN
            #取不到取出貨通知單對應invoice
            SELECT UNIQUE xmdodocno INTO l_isaf.isaf066 FROM xmdp_t ,xmdo_t
             WHERE xmdoent = g_enterprise
               AND xmdoent = xmdpent AND xmdodocno = xmdpdocno
               AND xmdp001 IN (SELECT DISTINCT xmdl001 FROM xmdl_t WHERE xmdlent = g_enterprise AND xmdldocno = l_xmdk.xmdkdocno)
               AND xmdo004 ='1' #出通單
               AND xmdostus = 'Y'
         END IF
      END IF
      #150904-00006#3-----e
      
      LET l_isaf.isaf100   = l_xmdk.xmdk016   #幣別
      LET l_isaf.isaf101   = l_xmdk.xmdk017   #匯率
      #151022-00017#2--s
      IF lc_param.l_curr_type MATCHES '[23]' THEN
         LET l_isaf.isaf101 = ''
         LET lc_param_rate.type = '1'
         LET lc_param_rate.apca004 = l_xmdk.xmdk008
         LET lc_param_rate.sfin2009 = lc_param.l_curr_type
         LET ls_js = util.JSON.stringify(lc_param_rate)
         CALL s_fin_get_curr_rate(lc_param.l_xrcacomp,lc_param.l_xrcald,lc_param.l_docdt,l_xmdk.xmdk016,ls_js)
              RETURNING l_isaf.isaf101,l_desc,l_desc
      END IF
      #151022-00017#2--e
      LET l_isaf.isaf103   = l_xmdk.xmdk051  #發票原幣未稅金額
      LET l_isaf.isaf104   = l_xmdk.xmdk053  #發票原幣稅額
      LET l_isaf.isaf105   = l_xmdk.xmdk052  #發票原幣含稅金額
      LET l_isaf.isaf106   = 0 
      LET l_isaf.isaf107   = 0
      LET l_isaf.isaf108   = 0
      LET l_isaf.isaf113   = 0 
      LET l_isaf.isaf114   = 0
      LET l_isaf.isaf115   = 0
      LET l_isaf.isaf116   = 0
      LET l_isaf.isaf117   = 0
      LET l_isaf.isaf118   = 0
      LET l_isaf.isaf119   = 0
                                 #if  isaf054課稅別= '1' then
                                 #    應稅類金額= isaf105
                                 #    零稅類金額= 0
                                 #    免稅類金額= 0
                                 #end if
      LET l_isaf.isaf120   = 0
                                 #= if  isaf054課稅別 = '2' then
                                 #   應稅類金額= 0
                                 #   零稅類金額= isaf105
                                 #   免稅類金額= 0
                                 # end if
      LET l_isaf.isaf121   = 0
                                 #= if isaf054課稅別 = '3' then
                                 #     應稅類金額= 0
                                 #     零稅類金額= 0
                                 #     免稅類金額= isaf105
                                 # end if
      LET l_isaf.isaf122   = 0
      LET l_isaf.isaf123   = 0
      LET l_isaf.isaf124   = 0
      #產生單頭
      
      #狀態碼及modifydt等
      LET l_isaf.isafownid = g_user
      LET l_isaf.isafowndp = g_dept
      LET l_isaf.isafcrtid = g_user
      LET l_isaf.isafcrtdp = g_dept
      LET l_isaf.isafcrtdt = cl_get_current()
      LET l_isaf.isafmodid = g_user
      LET l_isaf.isafmoddt = cl_get_current()
      LET l_isaf.isafstus  = 'N'
      LET l_isaf.isaf205   = 'N'
      LET l_isaf.isaf067   = l_xmdk.xmdk047   #160802-00007#1 Add
      
      INSERT INTO isaf_t VALUES(l_isaf.*)
      IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
         LET r_success = FALSE
      END IF
      
      
      
      
      #產生來源明細單身
      #LET l_wc = " xmdkdocno ='",l_xmdkdocno,"' " #160707-00023#1 mark
      #160707-00023#1 add ------
      CASE
         WHEN lc_param.l_group_type = '0' OR l_type = '2'  #0:出貨單/銷退單(2:須開立發票扣抵證明單)
            LET l_wc = " xmdkdocno = '",l_xmdkdocno,"'"
         WHEN lc_param.l_group_type = '2'  #2:業務人員
            LET l_wc = " (xmdk084 <> '2'  OR xmdk084 IS NULL)",
                       " AND xmdk007 = '",l_xmdk.xmdk007,"' AND xmdk008 = '",l_xmdk.xmdk008,"'",
                       " AND xmdk009 = '",l_xmdk.xmdk009,"' AND xmdk010 = '",l_xmdk.xmdk010,"'",
                       " AND xmdk012 = '",l_xmdk.xmdk012,"' AND xmdk016 = '",l_xmdk.xmdk016,"'",
                       " AND xmdk003 = '",l_xmdk.xmdk003,"'"
         WHEN lc_param.l_group_type = '3'  #3:業務部門
            LET l_wc = " (xmdk084 <> '2'  OR xmdk084 IS NULL)",
                       " AND xmdk007 = '",l_xmdk.xmdk007,"' AND xmdk008 = '",l_xmdk.xmdk008,"'",
                       " AND xmdk009 = '",l_xmdk.xmdk009,"' AND xmdk010 = '",l_xmdk.xmdk010,"'",
                       " AND xmdk012 = '",l_xmdk.xmdk012,"' AND xmdk016 = '",l_xmdk.xmdk016,"'",
                       " AND xmdk004 = '",l_xmdk.xmdk004,"'"
      END CASE
      #2.是否依來源營運據點拆單
      IF lc_param.l_chk1 = "Y" THEN
         LET l_wc = l_wc," AND xmdksite = '",lc_param.l_xrcasite,"'"
      END IF
      #3.匯率選擇是1:依原單匯率
      IF lc_param.l_curr_type = '1' THEN
         LET l_wc = l_wc," AND xmdk017 = '",l_xmdk.xmdk017,"'"
      END IF
      #160707-00023#1 add end---
      CALL l_array.clear()
      LET l_array[1].chr = l_isaf.isafdocno
      LET l_array[2].chr = l_isaf.isafcomp
      CALL s_aisp320_ins_isag(l_wc,l_array)RETURNING g_sub_success
      IF NOT g_sub_success THEN
         LET r_success = FALSE
      END IF
      
      
      
      
      
      #160426-00013#3-s
      #若該出貨單有訂金發票，則須依參數來決定產生aist310是27or29
      LET l_wc = ' 1=1 '
      CALL l_array.clear()
      LET l_array[1].chr = l_xmdk.xmdkdocno
      LET l_array[2].chr = l_isaf.isafdocno
      LET l_array[3].chr = l_isaf.isafcomp
      CALL s_aisp320_ins_isag_2729(l_wc,l_array) RETURNING g_sub_success
      IF NOT g_sub_success THEN
         LET r_success = FALSE
      ELSE
         CALL l_array.clear()
         LET l_array[1].chr = l_isaf.isafdocno
         LET l_array[2].chr = l_isaf.isafcomp
      END IF
      #160426-00013#3-e
      
      
      
      
      
      #產生發票明細 AND 歷程
      LET l_wc = ' 1=1'
      CALL l_array.clear()
      LET l_array[1].chr = l_isaf.isafdocno
      LET l_array[2].chr = l_isaf.isafcomp
      LET l_array[3].chr = lc_param.l_toaistype
      LET l_array[4].chr = lc_param.l_limit_memo
      LET l_array[5].chr = lc_param.l_book
      LET l_array[6].chr = lc_param.l_site
      LET l_array[7].chr = lc_param.l_isaf010
      LET l_array[8].chr = lc_param.l_isaf011
      CALL s_aisp320_ins_isah(l_wc,l_array)RETURNING g_sub_success
      IF NOT g_sub_success THEN
         LET r_success = FALSE
      END IF
      
      
      
      
      
      #150918-00001#7-----s
      #IF NOT l_xmdk.xmdk000 = '6' AND l_xmdk.xmdk042 = '2' THEN   ##151123-00013#7
      #IF NOT (l_xmdk.xmdk000 = '6' OR l_xmdk.xmdk000 = '5') AND l_xmdk.xmdk042 = '2' THEN   #151123-00013#7
      IF NOT l_xmdk.xmdk000 = '6' AND l_xmdk.xmdk042 = '2' THEN    #151123-00013#7
         #外銷出貨   #isat用iv產生
         CALL l_array.clear()
         LET l_array[1].chr = l_isaf.isafdocno
         LET l_array[2].chr = l_isaf.isafcomp
         LET l_array[3].chr = l_xmdk.xmdkdocno
         CALL s_aisp320_ins_isat2(l_array)RETURNING g_sub_success
         IF NOT g_sub_success THEN
            LET r_success = FALSE
         END IF
         LET l_count = NULL
         SELECT COUNT(*) INTO l_count FROM isat_t
          WHERE isatent = g_enterprise
            AND isatcomp = l_isaf.isafcomp
            AND isatdocno = l_isaf.isafdocno
         IF cl_null(l_count)THEN LET l_count = 0 END IF
         
         IF r_success AND l_count > 0 THEN
            #檢查外銷出貨單原幣總額跟invoice原幣總額是否相同
            LET l_isatsum = NULL
            SELECT SUM(isat105) INTO l_isatsum FROM isat_t
             WHERE isatent = g_enterprise
               AND isatdocno = l_isaf.isafdocno
               AND isatcomp  = l_isaf.isafcomp
            IF cl_null(l_isatsum)THEN LET l_isatsum = 0 END IF
           
            LET l_isafsum = NULL
            SELECT isaf105 INTO l_isafsum FROM isaf_t
             WHERE isafent = g_enterprise
               AND isafcomp = l_isaf.isafcomp
               AND isafdocno = l_isaf.isafdocno
            IF cl_null(l_isafsum)THEN LET l_isafsum = 0 END IF
            
            IF l_isatsum <> l_isafsum THEN
               INITIALIZE g_errparam.* TO NULL
               LET g_errparam.code = 'ais-00242'
               LET g_errparam.extend = 'xmdkdocno =',l_xmdk.xmdkdocno
               LET g_errparam.popup = TRUE
               CALL cl_err()
               LET r_success = FALSE
            END IF
         END IF
      END IF
      #150918-00001#7-----e
      
      
      
      #確認
      CALL s_aisp320_conf_upd(l_isaf.isafcomp,l_isaf.isafdocno)RETURNING g_sub_success
      IF NOT g_sub_success THEN
         LET r_success = FALSE
      END IF
 
      IF r_success THEN
         #albireo 150813-----s
         #產生aist310成功會有發票號碼 把發票號碼回寫來源單
         #150930-00010#1-----s
         #LET l_isaf011 = NULL
         #SELECT isaf011 INTO l_isaf011
         #  FROM isaf_t
         # WHERE isafent = g_enterprise
         #   AND isafcomp = l_isaf.isafcomp
         #   AND isafdocno = l_isaf.isafdocno
         LET l_isaf011 = NULL
         SELECT MAX(isat004) INTO l_isaf011 FROM isat_t
          WHERE isatent = g_enterprise
            AND isatcomp = l_isaf.isafcomp
            AND isatdocno = l_isaf.isafdocno
         #150930-00010#1-----e
          
         UPDATE xmdk_t SET xmdk037 = l_isaf011
          WHERE xmdkent = g_enterprise
            AND xmdkdocno = l_xmdkdocno
         #albireo 150813-----e
         CALL s_transaction_end('Y',0)
         #INITIALIZE g_errparam TO NULL
         #LET g_errparam.code = 'asf-00251'
         #LET g_errparam.replace[1] = l_isaf.isafdocno
         #LET g_errparam.replace[2] = l_isaf.isafdocno
         #LET g_errparam.extend = ''
         #LET g_errparam.popup = TRUE
         #CALL cl_err()
         #CALL s_transaction_end('Y',0)   #150126-00012#1 mark
         IF cl_null(l_strno1) THEN
            LET l_strno1 = l_isaf.isafdocno
         END IF
         LET l_endno1 = l_isaf.isafdocno
         LET l_doais = l_doais + 1
         
         #拋axrp132-----s
         IF lc_param.l_chk2 = "Y" THEN  #160707-00023#1
            INITIALIZE tran_master.* TO NULL
            LET tran_master.xrcasite = lc_param.l_xrcasite
            LET tran_master.b_check1 = 'N'
            LET tran_master.b_check2 = 'N'
            LET tran_master.b_check3 = 'N'
            LET tran_master.b_check4 = 'N'
            LET tran_master.b_check5 = 'N'
            LET tran_master.b_check6 = 'N'
            LET tran_master.xrcald = lc_param.l_xrcald
            #IF l_xmdk.xmdk000 = '6' THEN
            #IF (l_xmdk.xmdk000 = '6' OR l_xmdk.xmdk000 = '5') THEN   #151123-00013#7
            IF l_xmdk.xmdk000 = '6' THEN   #151123-00013#7
               #LET tran_master.b_style  = 'axrt340'        #160426-00013#3 mark
               LET tran_master.l_isaf001  = '4'             #160426-00013#3
               LET tran_master.xrcadocno = lc_param.l_slip3 #160707-00023#1
            ELSE
               #LET tran_master.b_style  = 'axrt300'        #160426-00013#3 mark
               LET tran_master.l_isaf001  = '1'             #160426-00013#3
               LET tran_master.xrcadocno = lc_param.l_slip2 #160707-00023#1
            END IF
            #LET tran_master.xrcadocno = lc_param.l_slip2 #160707-00023#1 mark
            LET tran_master.xrcadocdt = lc_param.l_docdt
            LET tran_master.b_comb2 = '1'
            LET tran_master.b_comb1 = lc_param.l_curr_type
            LET tran_master.wc  = " isafdocno = '",l_isaf.isafdocno,"' "
            LET tran_master.xrca007 = lc_param.l_xrca007    #albireo 150826 add
            
            LET l_tran = util.JSON.stringify(tran_master) 
            INITIALIZE la_param.* TO NULL
            LET la_param.prog = 'axrp132'
            LET la_param.param[1] = l_tran
            LET la_param.background = 'Y'
            LET ls_js2 = util.JSON.stringify(la_param)
            CALL cl_cmdrun_wait(ls_js2)
            
            #取成功號
            LET l_strno = NULL
            SELECT xrcadocno INTO l_strno FROM xrca_t
             WHERE xrcaent = g_enterprise
               AND xrcald  = lc_param.l_xrcald
               AND xrca018 = l_isaf.isafdocno
            IF NOT cl_null(l_strno)THEN
               IF cl_null(l_strno2)THEN 
                  LET l_strno2 = l_strno
               END IF
               LET l_endno2 = l_strno
               #回寫整帳批序號
               IF NOT cl_null(l_xrca063)THEN
                  UPDATE xrca_t SET xrca063 = l_xrca063
                   WHERE xrcaent = g_enterprise
                     AND xrcadocno = l_strno
               END IF
               LET l_doaxr = l_doaxr + 1
            END IF
         END IF  #160707-00023#1
         #拋axrp132-----e
         
      ELSE
         CALL s_transaction_end('N',0)
         #INITIALIZE g_errparam TO NULL
         #LET g_errparam.code = 'aap-00187'   #單據產生失敗
         #LET g_errparam.extend = ''
         #LET g_errparam.popup = TRUE
         #CALL cl_err()
      END IF
   END FOREACH
   
   #IF (l_doaxr + l_doais = 0) THEN #160707-00023#1 mark
   IF l_doais = 0 THEN              #160707-00023#1
      INITIALIZE g_errparam.* TO NULL
      LET g_errparam.code = 'aap-00313'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
   ELSE
      IF l_doais > 0 THEN
         #顯示成功的對帳單
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'aap-00379'
         LET g_errparam.replace[1] = l_strno1
         LET g_errparam.replace[2] = l_endno1
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
      
      IF l_doaxr > 0 THEN
         #顯示成功的帳務單
         INITIALIZE g_errparam.* TO NULL
         LET g_errparam.code = 'aap-00380'
         LET g_errparam.replace[1] = l_strno2
         LET g_errparam.replace[2] = l_endno2
         LET g_errparam.extend = ''
         LET g_errparam.popup = TRUE
         CALL cl_err()
      END IF
   END IF
   CALL cl_err_collect_show()
   #end add-point
#  END FOREACH
 
   IF g_bgjob = "N" THEN
      #前景作業完成處理
      #add-point:process段foreground完成處理
      
      #end add-point
      CALL cl_ask_confirm3("std-00012","")
   ELSE
      #背景作業完成處理
      #add-point:process段background完成處理
      
      #end add-point
      CALL cl_schedule_exec_call(li_p01_status)
   END IF
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL aisp320_msgcentre_notify()
 
END FUNCTION
 
{</section>}
 
{<section id="aisp320.get_buffer" >}
PRIVATE FUNCTION aisp320_get_buffer(p_dialog)
 
   #add-point:process段define (客製用)
   
   #end add-point
   DEFINE p_dialog   ui.DIALOG
   #add-point:process段define
   
   #end add-point
 
   
   LET g_master.l_xrcasite = p_dialog.getFieldBuffer('l_xrcasite')
   LET g_master.l_xmdk042 = p_dialog.getFieldBuffer('l_xmdk042')
   LET g_master.l_group_type = p_dialog.getFieldBuffer('l_group_type')
   LET g_master.l_xrcacomp = p_dialog.getFieldBuffer('l_xrcacomp')
   LET g_master.l_xrcald = p_dialog.getFieldBuffer('l_xrcald')
   LET g_master.l_chk1 = p_dialog.getFieldBuffer('l_chk1')
   LET g_master.l_chk2 = p_dialog.getFieldBuffer('l_chk2')
   LET g_master.l_toaxrtype = p_dialog.getFieldBuffer('l_toaxrtype')
   LET g_master.l_xmdk015 = p_dialog.getFieldBuffer('l_xmdk015')
   LET g_master.l_curr_type = p_dialog.getFieldBuffer('l_curr_type')
   LET g_master.l_slip1 = p_dialog.getFieldBuffer('l_slip1')
   LET g_master.l_docdt = p_dialog.getFieldBuffer('l_docdt')
   LET g_master.l_toaistype = p_dialog.getFieldBuffer('l_toaistype')
   LET g_master.l_slip2 = p_dialog.getFieldBuffer('l_slip2')
   LET g_master.l_slip3 = p_dialog.getFieldBuffer('l_slip3')
   LET g_master.l_xrca007 = p_dialog.getFieldBuffer('l_xrca007')
   LET g_master.l_xrca063 = p_dialog.getFieldBuffer('l_xrca063')
   LET g_master.l_site = p_dialog.getFieldBuffer('l_site')
   LET g_master.l_book = p_dialog.getFieldBuffer('l_book')
   LET g_master.l_dat_memo = p_dialog.getFieldBuffer('l_dat_memo')
   LET g_master.l_isaf010 = p_dialog.getFieldBuffer('l_isaf010')
   LET g_master.l_limit_memo = p_dialog.getFieldBuffer('l_limit_memo')
   LET g_master.l_isae007 = p_dialog.getFieldBuffer('l_isae007')
   LET g_master.l_isaf011 = p_dialog.getFieldBuffer('l_isaf011')
 
   CALL cl_schedule_get_buffer(p_dialog)
 
   #add-point:get_buffer段其他欄位處理
   
   #end add-point
END FUNCTION
 
{</section>}
 
{<section id="aisp320.msgcentre_notify" >}
PRIVATE FUNCTION aisp320_msgcentre_notify()
 
   #add-point:process段define (客製用)
   
   #end add-point
   DEFINE lc_state LIKE type_t.chr5
   #add-point:process段define
   
   #end add-point
 
   INITIALIZE g_msgparam TO NULL
 
   #action-id與狀態填寫
   LET g_msgparam.state = "process"
 
   #add-point:msgcentre其他通知
   
   #end add-point
 
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()
 
END FUNCTION
 
{</section>}
 
{<section id="aisp320.other_function" readonly="Y" >}
#add-point:自定義元件(Function)

PRIVATE FUNCTION aisp320_qbeclear()
   DEFINE l_comp  LIKE ooef_t.ooef001
   DEFINE l_tran  RECORD
                  wc  STRING
                  END RECORD
   DEFINE l_sql   STRING
   DEFINE l_xmdkdocno LIKE xmdk_t.xmdkdocno
   DEFINE l_count LIKE type_t.num10
   DEFINE ls_js   STRING
   DEFINE l_sfin2009  LIKE type_t.chr1 #151012-00014#7
   
   
   INITIALIZE g_master.* TO NULL
   INITIALIZE g_xmdk.* TO NULL
   INITIALIZE g_isao.* TO NULL
   
   LET g_master.l_docdt = g_today
   LET g_master.l_toaistype = '1'
   LET g_master.l_curr_type = '1'
   LET g_master.l_toaxrtype = '1'
   
   #160707-00023#1 -s
   CALL cl_set_comp_entry("l_slip3",FALSE)
   LET g_master.l_xmdk042 = '1'     #內外銷
   LET g_master.l_group_type = '0'  #彙總條件
   LET g_master.l_chk1 = 'N'        #是否依來源營運據點拆單
   LET g_master.l_chk2 = 'N'        #是否一併產生應收帳款
   CALL cl_set_comp_visible('group_toaxr',FALSE)
   #160707-00023#1 -e
   
   #150730-00006#1-----s
   #albireo 150803-----s
   LET ls_js = g_argv[01]
   CALL util.JSON.parse(ls_js,l_tran)
   LET l_sql = "SELECT DISTINCT xmdkdocno FROM xmdk_t ",
               " WHERE ",l_tran.wc CLIPPED
   PREPARE sel_xmdkp1 FROM l_sql
   
   LET l_sql = "SELECT COUNT(*) FROM (",l_sql,") "
   PREPARE sel_xmdkp2 FROM l_sql
   
   LET l_count = NULL
   EXECUTE sel_xmdkp2 INTO l_count
   CALL cl_set_comp_visible('group_qbe',TRUE)
   CALL cl_set_comp_entry('l_xrcasite,l_toaxrtype',TRUE)
   IF l_count > 0 THEN
      LET l_xmdkdocno = NULL
      EXECUTE sel_xmdkp1 INTO l_xmdkdocno
      
      LET g_xmdkdocno = l_xmdkdocno   #150918-00001#7 add  
      CALL aisp320_xmdtdocno_def(l_xmdkdocno)
      CALL cl_set_comp_visible('group_qbe',FALSE)
      CALL cl_set_comp_entry('l_xrcasite,l_toaxrtype',FALSE)
   ELSE
      LET g_master.l_xrcasite = g_site
   END IF
   #albireo 150803-----e

   CALL s_fin_orga_get_comp_ld(g_master.l_xrcasite) RETURNING g_sub_success,g_errno,g_master.l_xrcacomp,g_master.l_xrcald
   SELECT ooef019 INTO g_ooef019 FROM ooef_t
    WHERE ooefent =g_enterprise
      AND ooef001 = g_master.l_xrcacomp
   
   LET g_master.l_site = ''
   LET g_master.l_book = ''
   DISPLAY BY NAME g_master.l_site,g_master.l_book
   LET g_master.l_xrcald_desc = s_desc_get_ld_desc(g_master.l_xrcald)
   LET g_master.l_xrcasite_desc = s_desc_get_department_desc(g_master.l_xrcasite)
   DISPLAY BY NAME g_master.l_xrcald_desc,g_master.l_xrcasite_desc,
                   g_master.l_xrcald
   CALL s_fin_account_center_sons_query('3',g_master.l_xrcasite,g_today,'1') 
   CALL s_fin_account_center_sons_str() RETURNING g_wc_xrcasite
   CALL s_fin_get_wc_str(g_wc_xrcasite) RETURNING g_wc_xrcasite
   CALL s_fin_account_center_ld_str() RETURNING g_wc_xrcald
   CALL s_fin_get_wc_str(g_wc_xrcald) RETURNING g_wc_xrcald
   
   INITIALIZE g_isai.* TO NULL
   SELECT * INTO g_isai.* FROM isai_t
    WHERE isaient = g_enterprise
      AND isai001 = g_ooef019
   #150730-00006#1-----e
   
   #161012-00026#2 mark-----s
   ##151012-00014#7-----s
   ##依畫面上帳套所屬法人取S-FIN-2009預設匯率選項
   #CALL cl_get_para(g_enterprise,g_master.l_xrcacomp,'S-FIN-2009') RETURNING l_sfin2009
   #CASE l_sfin2009
   #     WHEN '1'  #依立帳日匯率(aooi160)
   #        LET g_master.l_curr_type = '2'
   #     WHEN '2'  #依立帳日月平均匯率(aooi170)
   #        LET g_master.l_curr_type = '3'
   #END CASE
   ##151012-00014#7-----e
   #161012-00026#2 mark-----e
   
   DISPLAY BY NAME g_master.l_docdt,g_master.l_toaistype,
                   g_master.l_site,
                   g_master.l_xrcald,
                   g_master.l_curr_type
   
   LET g_master_o.* = g_master.*
END FUNCTION

################################################################################
# Descriptions...: 出貨單號預設資料
# Memo...........:
# Usage..........: 
# Date & Author..: 150608 By albireo
# Modify.........:
################################################################################
PRIVATE FUNCTION aisp320_xmdtdocno_def(p_xmdkdocno)
   DEFINE l_prog   LIKE type_t.chr20
   DEFINE l_slip3  LIKE type_t.chr20
   DEFINE p_xmdkdocno  LIKE xmdk_t.xmdkdocno
   #albireo 150826-----s
   DEFINE l_comp   LIKE ooef_t.ooef001
   DEFINE l_ooef004    LIKE ooef_t.ooef004
   DEFINE l_cnt        LIKE type_t.num10
   #albireo 150826-----e
 
   
                    
   INITIALIZE g_xmdk.* TO NULL
   SELECT xmdk015,xmdk017,xmdksite,xmdk001,xmdk000,
          xmdk008   #albireo 150826 add
     INTO g_xmdk.*
     FROM xmdk_t
    WHERE xmdkent = g_enterprise
      AND xmdkdocno = p_xmdkdocno   #albireo 150803
   
   LET l_comp = NULL  #albireo 150826 add
   SELECT glaald,ooef019 ,
          glaacomp #albireo 150826 add
     INTO g_master.l_xrcald,g_ooef019,
          l_comp   #albireo 150826 add
     FROM glaa_t,ooef_t
    WHERE ooefent = glaaent 
      AND ooef017 = glaacomp
      AND glaaent = g_enterprise
      AND ooef001 = g_xmdk.xmdksite
   
   #150918-00001#7-----s
   #IF g_xmdk.xmdk000 = '6' THEN
   #IF (g_xmdk.xmdk000 = '6' OR g_xmdk.xmdk000 = '5') THEN    #151123-00013#7 
   IF g_xmdk.xmdk000 = '6' THEN   #151207-00018#2 add
      #銷退要用原單發票類型去推折單類型
      LET g_master.l_xmdk015 = NULL
      SELECT isac009 INTO g_master.l_xmdk015
        FROM isac_t
       WHERE isacent = g_enterprise
         AND isac001 = g_ooef019
         AND isac002 = g_xmdk.xmdk015
   ELSE
      LET g_master.l_xmdk015 = g_xmdk.xmdk015
   END IF
   #150918-00001#7-----e
   
   #LET g_master.l_site    = g_xmdk.xmdksite
   LET g_master.l_xrcasite = g_xmdk.xmdksite
   #LET g_master.l_xmdk017 = g_xmdk.xmdk017
   LET g_master.l_docdt   = g_xmdk.xmdk001
   
   INITIALIZE g_isao.* TO NULL
   SELECT isao014,isao015,isao016 
     INTO g_isao.*
     FROM isao_t
    WHERE isaoent = g_enterprise
      AND isaosite = g_xmdk.xmdksite
      

   #IF g_xmdk.xmdk000 = '6' THEN
   #IF (g_xmdk.xmdk000 = '6' OR g_xmdk.xmdk000 = '5') THEN   #151123-00013#7
   IF g_xmdk.xmdk000 = '6' THEN   #151207-00018#2 add   
      #折讓
      LET g_master.l_slip1 = g_isao.isao015
      LET l_prog = 'axrt340'
      LET g_master.l_toaxrtype = '2'
   ELSE
      #出貨
      LET g_master.l_slip1 = g_isao.isao014
      LEt l_prog = 'axrt300'
      LET g_master.l_toaxrtype = '1'
   END IF
   

      
   CALL s_desc_get_invoice_type_desc(g_master.l_xrcald,g_master.l_xmdk015)RETURNING g_master.l_xmdk015_desc
   
   CALL s_aooi200_fin_get_slip_desc(g_master.l_slip1) RETURNING g_master.l_slip1_desc
   CALL s_desc_get_department_desc(g_master.l_site)RETURNING g_master.l_site_desc
   CALL s_desc_get_ld_desc(g_master.l_xrcald)RETURNING g_master.l_xrcald_desc
   
   #albireo 150813-----s
   #檢核預帶的單別
   CALL cl_err_collect_init()
   CALL s_aooi200_fin_chk_docno(g_master.l_xrcald,'','',g_master.l_slip1,g_master.l_docdt,'aist310')
      RETURNING g_sub_success
   CALL cl_err_collect_init()
   CALL cl_err_collect_show()
   
   IF NOT g_sub_success THEN
      LET g_master.l_slip1 = ''
   END IF
   #albireo 150813-----e
   DISPLAY BY NAME g_master.l_xmdk015,
                   #g_master.l_xmdk017,
                   g_master.l_docdt,
                   g_master.l_slip1,g_master.l_slip1_desc,g_master.l_xmdk015_desc,
                   g_master.l_xrcald_desc,g_master.l_xrcald,
                   g_master.l_site,g_master.l_site_desc
   CALL s_aooi200_get_slip(p_xmdkdocno)RETURNING g_sub_success,l_slip3   #alberr
#   CALL s_aooi210_get_doc(g_xmdk.xmdksite,'','2',l_slip3,l_prog,'Y')
#      RETURNING g_sub_success,g_master.l_slip2

   #albireo 150823-----s
   CALL s_aooi100_sel_ooef004(g_xmdk.xmdksite) RETURNING g_sub_success,l_ooef004
   CALL s_aooi210_set_chk(l_slip3,l_prog,l_ooef004,l_ooef004,'1')RETURNING l_cnt

   IF l_cnt > 0 THEN
      CALL s_aooi210_get_doc(g_xmdk.xmdksite,'','2',l_slip3,l_prog,'Y')  
         RETURNING g_sub_success,g_master.l_slip2
   END IF
   #albireo 150823-----e  
   CALL s_aooi200_fin_get_slip_desc(g_master.l_slip2) RETURNING g_master.l_slip2_desc
   DISPLAY BY NAME g_master.l_slip2_desc,g_master.l_slip2
   
   INITIALIZE g_isai.* TO NULL
   SELECT * INTO g_isai.* FROM isai_t
    WHERE isaient = g_enterprise
      AND isai001 = g_ooef019
      
   INITIALIZE g_isaq.* TO NULL
   SELECT * INTO g_isaq.* FROM isaq_t
    WHERE isaqent = g_enterprise
     #AND isaqsite = g_master.l_site       #160707-00023#1 mark
      AND isaqsite = g_master.l_xrcasite   #160707-00023#1
      AND isaq001 = g_master.l_xmdk015
      
   INITIALIZE g_isac.* TO NULL
   SELECT * INTO g_isac.*
     FROM isac_t
    WHERE isacent = g_enterprise
      AND isac001 = g_ooef019
      AND isac002 = g_master.l_xmdk015
   CALL aisp320_visible()
   
   #albireo 150826-----s
   

   #albireo 150825-----s
   
   CALL s_apmm101_sel_pmab(l_comp,g_xmdk.xmdk008,'pmab105') RETURNING g_sub_success,g_errno,g_master.l_xrca007
   CALL s_desc_get_acc_desc('3111',g_master.l_xrca007) RETURNING g_master.l_xrca007_desc
   DISPLAY BY NAME g_master.l_xrca007_desc,g_master.l_xrca007
   #albireo 150826-----e
   
   LET g_master_o.* = g_master.*
END FUNCTION

PRIVATE FUNCTION aisp320_site_with_book_chk(p_site,p_book,p_dat,p_type)
   DEFINE p_site   LIKE ooef_t.ooef001
   DEFINE p_book   LIKE isae_t.isae001
   DEFINE p_dat    LIKE type_t.dat
   DEFINE r_success LIKE type_t.num5
   DEFINE r_errno   LIKE gzze_t.gzze001
   DEFINE l_count   LIKE type_t.num10
   DEFINE l_ooef017 LIKE ooef_t.ooef017
   DEFINE p_type    LIKE xmdk_t.xmdk015
   DEFINE l_isae012 LIKE isae_t.isae012
   DEFINE l_prog    LIKE type_t.chr20   #160413-00033#1
   
   #160413-00033#1-----e
   IF g_isai.isai002 = '1' THEN
      LET l_prog = 'aisi055'
   ELSE
      LET l_prog = 'aisi050'
   END IF
   #160413-00033#1-----e
   
   LET r_success = TRUE
   LET r_errno  =''
   
   IF NOT cl_null(p_site) 
      AND NOT cl_null(p_book)
      AND NOT cl_null(p_dat)
      AND NOT cl_null(p_type)THEN
      LET l_ooef017 = NULL
      SELECT ooef017 INTO l_ooef017 FROM ooef_t
       WHERE ooefent = g_enterprise
         AND ooef001 = p_site
      
      LET l_count = NULL
      SELECT COUNT(*) INTO l_count FROM isae_t
       WHERE isaeent = g_enterprise
         AND isaesite IN (p_site,l_ooef017) 
         AND isae001  = p_book
         AND isae002 <= p_dat
         AND isae003 >= p_dat
         AND isae004 = p_type
      IF cl_null(l_count)THEN LET l_count = 0 END IF
      IF l_count = 0 THEN
         LET r_errno ='ais-00144'
         LET r_success = FALSE
         RETURN r_success,r_errno
      END IF
      
      #160413-00033#1-----s
      LET l_count = NULL
      SELECT COUNT(*) INTO l_count FROM isae_t
       WHERE isaeent = g_enterprise
         AND isaesite IN (p_site,l_ooef017) 
         AND isae001  = p_book
         AND isae002 <= p_dat
         AND isae003 >= p_dat
         AND isae004 = p_type
         #AND isae019 = l_prog   #albireo 160601 mark
      IF cl_null(l_count)THEN LET l_count = 0 END IF
      IF l_count = 0 THEN
         IF g_isai.isai002 = '1' THEN
            LET r_errno ='ais-00278'
            LET r_success = FALSE
            RETURN r_success,r_errno
         ELSE
            LET r_errno ='ais-00030'
            LET r_success = FALSE
            RETURN r_success,r_errno
         END IF
      END IF
      #160413-00033#1-----e
      
     SELECT isae012
       INTO l_isae012
       FROM isae_t           
      WHERE isaeent = g_enterprise
        AND isaesite IN (p_site,l_ooef017) 
        AND isae001  = p_book
        AND isae002 <= p_dat
        AND isae003 >= p_dat
        AND isae004 = p_type
        
      IF cl_null(l_isae012)THEN
         LET r_errno = 'ais-00234'
         LET r_success = FALSE
         RETURN r_success,r_errno
      END IF
   END IF
   
   RETURN r_success,r_errno
END FUNCTION

PRIVATE FUNCTION aisp320_visible()
DEFINE l_xmdk042   LIKE xmdk_t.xmdk042  #150918-00001#7
   
   CALL cl_set_comp_visible('l_isaf010',TRUE)
   CALL cl_set_comp_visible('l_isae007',TRUE)      #160517-00005#1
   IF g_isai.isai002 = '1' THEN
      CALL cl_set_comp_visible('l_isaf010',FALSE)
   ELSE
      CALL cl_set_comp_visible('l_isae007',FALSE)  #160517-00005#1
   END IF
   CALL cl_set_comp_visible('group_book',TRUE)
   IF g_isac.isac003 = '4' THEN  #發票類型為銷項折單
      IF g_isai.isai006 = 'N' THEN   #紅字發票與藍字發票共用發票簿
         CALL cl_set_comp_visible('group_book',FALSE)
      END IF
   END IF
   
   #160707-00023#1 -s
   #發票簿條件依據 aisi090 isaq005=1:列印時回寫>>隱藏/2:產生時回寫>>顯示
   IF g_isaq.isaq005 = '1' THEN
      CALL cl_set_comp_visible('group_book',FALSE)
   END IF
   #160707-00023#1 -e
   
   #150918-00001#7-----s
   #外銷就不開發票簿了
   #因此次修改都改用iv no
   IF NOT cl_null(g_xmdkdocno)THEN
      LET l_xmdk042 = NULL
      SELECT xmdk042 INTO l_xmdk042 
        FROM xmdk_t
       WHERE xmdkent = g_enterprise
         AND xmdkdocno = g_xmdkdocno
         
      IF l_xmdk042 = '2' THEN
         CALL cl_set_comp_visible('group_book',FALSE)
      END IF
   END IF
   #150918-00001#7-----e
   
END FUNCTION

PRIVATE FUNCTION aisp320_ooef001_chk(p_ooef001)
   DEFINE p_ooef001   LIKE ooef_t.ooef001
   DEFINE r_success   LIKE type_t.num5
   DEFINE l_stus      LIKE type_t.chr1
   DEFINE r_errno     LIKE gzze_t.gzze001
   
   LET r_success = TRUE
   LET r_errno  = ''
   LET l_stus = NULL
   SELECT ooefstus FROM ooef_t
    WHERE ooefent = g_enterprise
      AND ooef001 = p_ooef001
      
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET r_errno  = 'aoo-00094'
         LET r_success = FALSE
      WHEN l_stus <> 'Y'
         LET r_errno = 'axc-00105'
         LET r_success = FALSE
   END CASE
   
   
   RETURN r_success,r_errno
END FUNCTION

PRIVATE FUNCTION aisp320_book_exist(p_dat,p_type)
 DEFINE p_site   LIKE ooef_t.ooef001
   DEFINE p_book   LIKE isae_t.isae001
   DEFINE p_dat    LIKE type_t.dat
   DEFINE r_success LIKE type_t.num5
   DEFINE r_errno   LIKE gzze_t.gzze001
   DEFINE l_count   LIKE type_t.num10
   DEFINE l_ooef017 LIKE ooef_t.ooef017
   DEFINE p_type    LIKE xmdk_t.xmdk015
   DEFINE l_isae012 LIKE isae_t.isae012
   
   LET r_success = TRUE
   LET r_errno  =''
         
   LET l_count = NULL
   SELECT COUNT(*) INTO l_count FROM isae_t
    WHERE isaeent = g_enterprise
      AND isae002 <= p_dat
      AND isae003 >= p_dat
      AND isae004 = p_type
   IF cl_null(l_count)THEN LET l_count = 0 END IF
   IF l_count = 0 THEN
      LET r_errno ='ais-00284'
      LET r_success = FALSE
      RETURN r_success,r_errno
   END IF
   
   RETURN r_success,r_errno
END FUNCTION

#end add-point
 
{</section>}
 
